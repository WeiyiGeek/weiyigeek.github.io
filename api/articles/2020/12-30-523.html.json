{"title":"3.Jenkins进阶之流水线pipeline基础使用实践","slug":"系统运维/自动化运维/CI-CD/Jenkins/3.Jenkins进阶之流水线pipeline基础使用实践","date":"2020-12-30T04:34:30.000Z","updated":"2023-01-31T02:29:10.467Z","url":"2020/12-30-523.html","path":"api/articles/2020/12-30-523.html.json","covers":["https://img.weiyigeek.top/2021/1/20210114164915.png","https://img.weiyigeek.top/2021/1/20210114172611.png","https://img.weiyigeek.top/2021/1/20210114172823.png","https://img.weiyigeek.top/2021/1/20210126145342.png","https://img.weiyigeek.top/2021/1/20210201223057.png","https://img.weiyigeek.top/2021/1/20210201093540.png","https://img.weiyigeek.top/2021/1/20210201230027.png","https://img.weiyigeek.top/2021/1/20210201230427.png","https://img.weiyigeek.top/2021/1/20210201230632.png","https://img.weiyigeek.top/2021/1/20210127155243.png","https://img.weiyigeek.top/2021/1/20210127160603.png","https://img.weiyigeek.top/2021/1/20210127162312.png","https://img.weiyigeek.top/2021/1/20210127164940.png","https://img.weiyigeek.top/2021/1/20210202104449.png","https://img.weiyigeek.top/2021/1/20210202112342.png","https://img.weiyigeek.top/2021/1/20210202141801.png","https://img.weiyigeek.top/2021/1/20210126151854.png","https://img.weiyigeek.top/2021/1/20210127163900.png","https://img.weiyigeek.top/2021/1/20210331134808.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x01-基础实践\"><a href=\"#0x01-基础实践\" class=\"headerlink\" title=\"0x01 基础实践\"></a>0x01 基础实践</h2><h3 id=\"1-Maven-构建之-Pipeline-Script\"><a href=\"#1-Maven-构建之-Pipeline-Script\" class=\"headerlink\" title=\"(1) Maven 构建之 Pipeline Script\"></a>(1) Maven 构建之 Pipeline Script</h3><p>描述:此处重新不在累述新建流水线任务（<code>maven-pipeline-helloword</code>）而是直接进行配置测试等关键项;<br>流程:<code>代码拉取 -&gt; 代码检测 -&gt; 代码构建 -&gt; 代码部署 -&gt; 消息通知</code></p>\n<p>Step 1. Dashboard -&gt; maven-pipeline-helloword -&gt; 流水线项目配置 (名称|丢弃旧的构建|参数化构建过程(Git/名称))<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Git 参数</span></span><br><span class=\"line\">名称: git_tags</span><br><span class=\"line\">描述: Project_Release</span><br><span class=\"line\">参数类型: 标签</span><br><span class=\"line\">默认值: origin/master</span><br><span class=\"line\">排序方式: DESCENDING SMART</span><br><span class=\"line\">----------------------------</span><br><span class=\"line\"><span class=\"comment\"># 选项 参数</span></span><br><span class=\"line\">名称: deploy_option</span><br><span class=\"line\">选项：</span><br><span class=\"line\">deploy</span><br><span class=\"line\">rollback</span><br><span class=\"line\">redeploy</span><br><span class=\"line\">描述: 部署&amp;回退&amp;重部署</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li><p>Step 2.流水线 Pipeline script 编写</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent any</span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage (<span class=\"string\">\"代码获取\"</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">       checkout([<span class=\"string\">$class:</span> <span class=\"string\">'GitSCM'</span>, <span class=\"string\">branches:</span> [[<span class=\"string\">name:</span> <span class=\"string\">'$&#123;git_tags&#125;'</span>]], <span class=\"string\">doGenerateSubmoduleConfigurations:</span> <span class=\"literal\">false</span>, <span class=\"string\">extensions:</span> [], <span class=\"string\">submoduleCfg:</span> [], <span class=\"string\">userRemoteConfigs:</span> [[<span class=\"string\">credentialsId:</span> <span class=\"string\">'b4c8b4e9-2777-44a1-a1ed-e9dc21d37f4f'</span>, <span class=\"string\">url:</span> <span class=\"string\">'git@gitlab.weiyigeek.top:ci-cd/java-maven.git'</span>]]])</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage (<span class=\"string\">\"代码质检\"</span>) &#123;</span><br><span class=\"line\">     steps &#123;</span><br><span class=\"line\">       sh <span class=\"string\">label:</span> <span class=\"string\">'sonar'</span>, <span class=\"string\">returnStatus:</span> <span class=\"literal\">true</span>, <span class=\"string\">script:</span> <span class=\"string\">'''/usr/local/bin/sonar-scanner -Dsonar.projectName=$&#123;JOB_NAME&#125; -Dsonar.projectKey=Hello-World -Dsonar.sources=.'''</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage (<span class=\"string\">\"项目构建\"</span>) &#123;</span><br><span class=\"line\">     steps &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 此处实际上不用执行cd命令</span></span><br><span class=\"line\">      sh <span class=\"string\">label:</span> <span class=\"string\">'build'</span>, <span class=\"string\">script:</span> <span class=\"string\">'cd /var/lib/jenkins/workspace/maven-pipeline-helloword/ &amp;&amp; /usr/local/maven/bin/mvn clean package -Dmaven.test.skip=true '</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage (<span class=\"string\">\"项目部署\"</span>) &#123;</span><br><span class=\"line\">     steps &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 脚本为前面一章的部署脚本(两种方式)</span></span><br><span class=\"line\">      sh <span class=\"string\">label:</span> <span class=\"string\">'deploy'</span>, <span class=\"string\">script:</span> <span class=\"string\">'/tmp/script/maven-jenkins-ci-script.sh'</span></span><br><span class=\"line\">      <span class=\"comment\">// sh \"/tmp/script/maven-jenkins-ci-script.sh\"</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 消息通知: POST阶段当所有任务执行后触发</span></span><br><span class=\"line\">  post &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 企业微信</span></span><br><span class=\"line\">    always &#123;</span><br><span class=\"line\">      qyWechatNotification <span class=\"string\">aboutSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">failNotify:</span> <span class=\"literal\">true</span>, <span class=\"string\">failSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">mentionedId:</span> <span class=\"string\">'ALL'</span>, <span class=\"string\">mentionedMobile:</span> <span class=\"string\">''</span>, <span class=\"string\">startBuild:</span> <span class=\"literal\">true</span>, <span class=\"string\">successSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">unstableSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">webhookUrl:</span> <span class=\"string\">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c222f3fc-f645-440a-ad24-0ce8d9626fa0'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 钉钉</span></span><br><span class=\"line\">    success &#123;</span><br><span class=\"line\">      <span class=\"comment\">//当此Pipeline成功时打印消息（注意此处的robot为您在Jenkins全局配置中设置钉钉的id值）</span></span><br><span class=\"line\">      echo <span class=\"string\">'success'</span></span><br><span class=\"line\">      dingtalk (</span><br><span class=\"line\"><span class=\"symbol\">          robot:</span> <span class=\"string\">'weiyigeek-1000'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          type:</span> <span class=\"string\">'LINK'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          title:</span> <span class=\"string\">'Jenkins 持续集成 - 任务名称 $&#123;JOB_NAME&#125;'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          text:</span> [</span><br><span class=\"line\">              <span class=\"string\">'项目构建成功'</span>,</span><br><span class=\"line\">              <span class=\"string\">'Pipeline 流水线测试'</span></span><br><span class=\"line\">          ],</span><br><span class=\"line\"><span class=\"symbol\">          messageUrl:</span> <span class=\"string\">'http://www.weiyigeek.top'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          picUrl:</span> <span class=\"string\">'https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=2319834554,1372531032&amp;fm=26&amp;gp=0.jpg'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          atAll:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.Pipeline maven-pipeline-helloword 进行选项参数构建 (Build with Parameters）-&gt; 部署 v1.8 版本</p>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210114164915.png\" alt=\"WeiyiGeek.参数构建\" title=\"\" class=\"\">\n                <p>WeiyiGeek.参数构建</p>\n            </figure>\n<p><br></p>\n<ul>\n<li>Step 4.查看部署结果与信息通知</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210114172611.png\" alt=\"WeiyiGeek.Kubernets部署结果与消息通知\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Kubernets部署结果与消息通知</p>\n            </figure>\n<p><br></p>\n<h3 id=\"2-Maven-构建之-Pipeline-Script-from-SCM\"><a href=\"#2-Maven-构建之-Pipeline-Script-from-SCM\" class=\"headerlink\" title=\"(2) Maven 构建之 Pipeline Script from SCM\"></a>(2) Maven 构建之 Pipeline Script from SCM</h3><p>描述: 我也可以将上面流水线的脚本放在我们的代码项目之中,在流水线拉取项目时候便会自动按照项目中的<code>Jenkinsfile</code>文件内容进行执行对于操作</p>\n<ul>\n<li>Step 1.修改项目首页文件以及在项目根添加Jenkinsfile文件(内容将取消第一阶段的代码拉取),例如:<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># (1) E:\\EclipseProject\\hello-world\\src\\main\\webapp\\index.jsp</span><br><span class=\"line\">&lt;h1&gt;Maven - Hello World - v1.10 - Pipeline script for SCM&lt;/h1&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"># (2) 项目信息</span><br><span class=\"line\"><span class=\"regexp\">/e/</span>EclipseProject/hello-world (master)</span><br><span class=\"line\">$ ls</span><br><span class=\"line\">Jenkinsfile  pom.xml  src<span class=\"regexp\">/  target/</span></span><br><span class=\"line\"></span><br><span class=\"line\"># (3) Jenkinsfile ： 注意内容将取消第一阶段的代码拉取</span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent any</span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage (<span class=\"string\">\"代码质检\"</span>) &#123;</span><br><span class=\"line\">     steps &#123;</span><br><span class=\"line\">       sh <span class=\"string\">label:</span> <span class=\"string\">'sonar'</span>, <span class=\"string\">returnStatus:</span> <span class=\"literal\">true</span>, <span class=\"string\">script:</span> <span class=\"string\">'''/usr/local/bin/sonar-scanner -Dsonar.projectName=$&#123;JOB_NAME&#125; -Dsonar.projectKey=Hello-World -Dsonar.sources=.'''</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage (<span class=\"string\">\"项目构建\"</span>) &#123;</span><br><span class=\"line\">     steps &#123;</span><br><span class=\"line\">      sh <span class=\"string\">label:</span> <span class=\"string\">'build'</span>, <span class=\"string\">script:</span> <span class=\"string\">'cd /var/lib/jenkins/workspace/maven-pipeline-helloword/ &amp;&amp; /usr/local/maven/bin/mvn clean package -Dmaven.test.skip=true '</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage (<span class=\"string\">\"项目部署\"</span>) &#123;</span><br><span class=\"line\">     steps &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 脚本为前面一章的部署脚本</span></span><br><span class=\"line\">      sh <span class=\"string\">label:</span> <span class=\"string\">'deploy'</span>, <span class=\"string\">script:</span> <span class=\"string\">'/tmp/script/maven-jenkins-ci-script.sh'</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 消息通知: POST阶段当所有任务执行后触发</span></span><br><span class=\"line\">  post &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 企业微信</span></span><br><span class=\"line\">    always &#123;</span><br><span class=\"line\">      qyWechatNotification <span class=\"string\">aboutSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">failNotify:</span> <span class=\"literal\">true</span>, <span class=\"string\">failSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">mentionedId:</span> <span class=\"string\">'ALL'</span>, <span class=\"string\">mentionedMobile:</span> <span class=\"string\">''</span>, <span class=\"string\">startBuild:</span> <span class=\"literal\">true</span>, <span class=\"string\">successSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">unstableSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">webhookUrl:</span> <span class=\"string\">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c222f3fc-f645-440a-ad24-0ce8d9626fa0'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 钉钉</span></span><br><span class=\"line\">    success &#123;</span><br><span class=\"line\">      <span class=\"comment\">//当此Pipeline成功时打印消息 （注意此处的robot为您在Jenkins全局配置中设置钉钉的id值）</span></span><br><span class=\"line\">      echo <span class=\"string\">'success'</span></span><br><span class=\"line\">      dingtalk (</span><br><span class=\"line\"><span class=\"symbol\">          robot:</span> <span class=\"string\">'weiyigeek-1000'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          type:</span> <span class=\"string\">'LINK'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          title:</span> <span class=\"string\">'Jenkins 持续集成 - 任务名称 $&#123;JOB_NAME&#125;'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          text:</span> [</span><br><span class=\"line\">              <span class=\"string\">'项目构建成功'</span>,</span><br><span class=\"line\">              <span class=\"string\">'Pipeline 流水线测试'</span></span><br><span class=\"line\">          ],</span><br><span class=\"line\"><span class=\"symbol\">          messageUrl:</span> <span class=\"string\">'http://www.weiyigeek.top'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          picUrl:</span> <span class=\"string\">'https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=2319834554,1372531032&amp;fm=26&amp;gp=0.jpg'</span>,</span><br><span class=\"line\"><span class=\"symbol\">          atAll:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li><p>Step 2.上传修改的项目到Gitlab内部私有仓库中</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git add .</span><br><span class=\"line\">$ git commit -m <span class=\"string\">\"v1.10 pipeline script for SCM\"</span></span><br><span class=\"line\"><span class=\"comment\"># [master 3f9b6e8] v1.10 pipeline</span></span><br><span class=\"line\"><span class=\"comment\">#  2 files changed, 26 insertions(+), 1 deletion(-)</span></span><br><span class=\"line\"><span class=\"comment\">#  create mode 100644 Jenkinsfile</span></span><br><span class=\"line\">$ git push</span><br><span class=\"line\"><span class=\"comment\"># To http://gitlab.weiyigeek.top/ci-cd/java-maven.git</span></span><br><span class=\"line\"><span class=\"comment\">#    0f50b10..3f9b6e8  master -&gt; master</span></span><br><span class=\"line\">$ git tag -a <span class=\"string\">\"v1.10\"</span> -m <span class=\"string\">\"v1.10 Pipelinescript for SCM \"</span></span><br><span class=\"line\">$ git push origin v1.10</span><br><span class=\"line\"><span class=\"comment\"># To http://gitlab.weiyigeek.top/ci-cd/java-maven.git</span></span><br><span class=\"line\"><span class=\"comment\">#  * [new tag]         v1.10 -&gt; v1.10</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.任务项目流水线设置 -&gt; 选择 Pipeline script from SCM -&gt; git -&gt; 输入 Repository URL 和 Credentials -&gt; 指定分支 <code>Branches to build</code> (以及Jenkinsfile 拉取的文件名实现自动构建集成)</p>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210114172823.png\" alt=\"WeiyiGeek.Pipeline script from SCM\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Pipeline script from SCM</p>\n            </figure>\n<ul>\n<li>Step 4.项目构建参数输入 -&gt; v1.10 | deploy -&gt; 进行构建 -&gt; 查看流水线</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210126145342.png\" alt=\"WeiyiGeek.PIPE 流水线\" title=\"\" class=\"\">\n                <p>WeiyiGeek.PIPE 流水线</p>\n            </figure>\n<ul>\n<li>Step 5.查看部署结果<code>http://10.10.107.202:30089/</code>结果正常;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Maven - Hello World - v1.10 - Pipeline script <span class=\"keyword\">for</span> SCM</span><br><span class=\"line\"></span><br><span class=\"line\">访问时间: Tue Jan 26 2021 14:54:35 GMT+0800 (中国标准时间)</span><br><span class=\"line\"></span><br><span class=\"line\">Server : Apache Tomcat/8.5.61 | 10.244.1.217</span><br><span class=\"line\"></span><br><span class=\"line\">Client : 10.244.0.0 | 10.244.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">Document_Root : /usr/<span class=\"built_in\">local</span>/tomcat/webapps/ROOT/</span><br><span class=\"line\"></span><br><span class=\"line\">URL : 10.10.107.202/index.jsp</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"3-Jenkins-pipeline-之-邮件-Email-发信管理\"><a href=\"#3-Jenkins-pipeline-之-邮件-Email-发信管理\" class=\"headerlink\" title=\"(3) Jenkins pipeline 之 邮件(Email)发信管理\"></a>(3) Jenkins pipeline 之 邮件(Email)发信管理</h3><p>描述: 如果利用 Freestyle 的原生Job我们可以很好的进行Job邮件发信，而在与 Jenkins 流水线中需要<code>Extended E-mail Notification</code>的方式进行实现(此处只是简单说明建议采用钉钉或者企业微信的方式更加及时方便);</p>\n<p>下面提供两种格式进行参考:</p>\n<ul>\n<li>(1) Scripted Pipeline<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node (<span class=\"string\">\"master\"</span>)&#123;</span><br><span class=\"line\">    parameters &#123;string(<span class=\"string\">name:</span><span class=\"string\">'Jenkins'</span>,<span class=\"string\">defaultValue:</span><span class=\"string\">'Hello'</span>,<span class=\"string\">description:</span><span class=\"string\">'How should I greet the world'</span>)&#125;</span><br><span class=\"line\">    echo  <span class=\"string\">\"$&#123;params.nane&#125; 你好!\"</span></span><br><span class=\"line\">    <span class=\"comment\">// gitlab 流水线通知</span></span><br><span class=\"line\">    gitlabCommitStatus &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">'第1步拉代码'</span>)&#123;</span><br><span class=\"line\">            echo <span class=\"string\">\"拉代码\"</span></span><br><span class=\"line\">            git <span class=\"string\">credentialsId:</span> <span class=\"string\">'03fd8295-c536-4871-9794-1c37394676e0'</span>, <span class=\"string\">url:</span> <span class=\"string\">'git@gitlab.weiyigeek.top:weiyigeek/ops.git'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'第2步编译'</span>)&#123;</span><br><span class=\"line\">            echo <span class=\"string\">\"编译\"</span></span><br><span class=\"line\">           <span class=\"comment\">// sh \"source /etc/profile &amp;&amp; /usr/local/maven/bin/mvn clean compile\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'第3步打包'</span>)&#123;</span><br><span class=\"line\">            echo <span class=\"string\">\"打包,有一个mail模块是系统级别的,需要sudo\"</span></span><br><span class=\"line\">            <span class=\"comment\">// sh \"sudo /usr/local/maven/bin/mvn package\"</span></span><br><span class=\"line\">            <span class=\"comment\">// echo \"完成后 修改一下权限，否则下一次麻烦\"</span></span><br><span class=\"line\">            <span class=\"comment\">// sh \"sudo chown -R  jenkins: .\"</span></span><br><span class=\"line\">            <span class=\"comment\">// sh \"find -name '*SNAPSHOT.jar' \"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'第四步单元测试'</span>)&#123;</span><br><span class=\"line\">            echo <span class=\"string\">\"单元测试\"</span></span><br><span class=\"line\">            <span class=\"comment\">//sh \"sudo /usr/local/maven/bin/mvn test\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">\"放到下载服务器上\"</span>)&#123;</span><br><span class=\"line\">            echo <span class=\"string\">\"发送文件\"</span></span><br><span class=\"line\">          <span class=\"comment\">//  sh \"sudo cp ./account-email/target/account-email-1.0.0-SNAPSHOT.jar /home/admin/webserver/html/download &amp;&amp; sudo chown  -R admin: /home/admin/webserver/html/download\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">\"发送邮件\"</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">def</span> git_url = <span class=\"string\">'git@gitlab.weiyigeek.top:weiyigeek/ops.git'</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> branch = <span class=\"string\">'dev'</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> username = <span class=\"string\">'Jenkins'</span></span><br><span class=\"line\">            echo <span class=\"string\">\"Hello Mr.$&#123;username&#125;\"</span></span><br><span class=\"line\">            echo <span class=\"string\">\"GIT路径: $&#123;git_url&#125;\"</span></span><br><span class=\"line\">  </span><br><span class=\"line\">            echo <span class=\"string\">\"发送邮件\"</span></span><br><span class=\"line\">            emailext <span class=\"string\">body:</span> <span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">            &lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;html&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;head&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;meta charset=\"UTF-8\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;title&gt;$&#123;ENV, var=\"JOB_NAME\"&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志&lt;/title&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;body leftmargin=\"8\" marginwidth=\"0\" topmargin=\"8\" marginheight=\"4\" offset=\"0\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;(本邮件由程序自动下发，请勿回复！)&lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;h2&gt;&lt;font color=\"#FF0000\"&gt;构建结果 - $&#123;BUILD_STATUS&#125;&lt;/font&gt;&lt;/h2&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;&lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;b&gt;&lt;font color=\"#0B610B\"&gt;构建信息&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;&lt;a href=\"$&#123;PROJECT_URL&#125;\"&gt;$&#123;PROJECT_URL&#125;&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;项目名称：$&#123;PROJECT_NAME&#125;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;GIT路径：&lt;a href=\"git@gitlab.weiyigeek.top:weiyigeek/ops.git\"&gt;git@gitlab.weiyigeek.top:weiyigeek/ops.git&lt;/a&gt;&lt;/li&gt;   </span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;GIT分支： master&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;构建编号：$&#123;BUILD_NUMBER&#125;&lt;/li&gt;                    </span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;触发原因：$&#123;CAUSE&#125;&lt;/li&gt;   </span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;构建日志：&lt;a href=\"$&#123;BUILD_URL&#125;console\"&gt;$&#123;BUILD_URL&#125;console&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;/ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;b&gt;&lt;font color=\"#0B610B\"&gt;变更信息:&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                           &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;上次构建成功后变化 :  $&#123;CHANGES_SINCE_LAST_SUCCESS&#125;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">             &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;上次构建不稳定后变化 :  $&#123;CHANGES_SINCE_LAST_UNSTABLE&#125;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;历史变更记录 : &lt;a href=\"$&#123;PROJECT_URL&#125;changes\"&gt;$&#123;PROJECT_URL&#125;changes&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                                &lt;li&gt;变更集:$&#123;JELLY_SCRIPT,template=\"html\"&#125;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;!--</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;b&gt;&lt;font color=\"#0B610B\"&gt;Failed Test Results&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;pre style=\"font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif\"&gt;$&#123;FAILED_TESTS&#125;&lt;/pre&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    </span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;b&gt;&lt;font color=\"#0B610B\"&gt;构建日志 (最后 100行):&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;!-- &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;Test Logs (if test has ran): &lt;a</span></span><br><span class=\"line\"><span class=\"string\">                            href=\"$&#123;PROJECT_URL&#125;ws/TestResult/archive_logs/Log-Build-$&#123;BUILD_NUMBER&#125;.zip\"&gt;$&#123;PROJECT_URL&#125;/ws/TestResult/archive_logs/Log-Build-$&#123;BUILD_NUMBER&#125;.zip&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt; --&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;!--</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;textarea cols=\"80\" rows=\"30\" readonly=\"readonly\" style=\"font-family: Courier New\"&gt;$&#123;BUILD_LOG, maxLines=100,escapeHtml=true&#125;&lt;/textarea&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/tr&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">             </span></span><br><span class=\"line\"><span class=\"string\">                &lt;/table&gt;</span></span><br><span class=\"line\"><span class=\"string\">             </span></span><br><span class=\"line\"><span class=\"string\">             </span></span><br><span class=\"line\"><span class=\"string\">            &lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/html&gt;</span></span><br><span class=\"line\"><span class=\"string\">    \"\"\"</span>, <span class=\"string\">subject:</span> <span class=\"string\">'$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!'</span>, <span class=\"string\">to:</span> <span class=\"string\">'master@weiyigeek.top'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>(2) Declarative Pipeline<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">  agent&#123;label <span class=\"string\">'master'</span>&#125;</span><br><span class=\"line\">  environment &#123;</span><br><span class=\"line\">    git_url = <span class=\"string\">'git@gitlab.weiyigeek.top:weiyigeek/ops.git'</span></span><br><span class=\"line\">    git_key = <span class=\"string\">'03fd8295-c536-4871-9794-1c37394676e0'</span></span><br><span class=\"line\">    git_branch = <span class=\"string\">'master'</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage(<span class=\"string\">'下载代码'</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        git <span class=\"string\">branch:</span> <span class=\"string\">\"$&#123;git_branch&#125;\"</span>,<span class=\"string\">credentialsId:</span> <span class=\"string\">\"$&#123;git_key&#125;\"</span>, <span class=\"string\">url:</span> <span class=\"string\">\"$&#123;env.git_url&#125;\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">  post &#123; </span><br><span class=\"line\">    <span class=\"comment\">//always部分 pipeline运行结果为任何状态都运行</span></span><br><span class=\"line\">    always&#123;</span><br><span class=\"line\">      script&#123;</span><br><span class=\"line\">        emailext <span class=\"string\">body:</span> </span><br><span class=\"line\">          <span class=\"string\">'''  &lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"string\">          &lt;html&gt;</span></span><br><span class=\"line\"><span class=\"string\">          &lt;head&gt;</span></span><br><span class=\"line\"><span class=\"string\">          &lt;meta charset=\"UTF-8\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">          &lt;title&gt;$&#123;ENV, var=\"JOB_NAME\"&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志&lt;/title&gt;</span></span><br><span class=\"line\"><span class=\"string\">          &lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">          &lt;body leftmargin=\"8\" marginwidth=\"0\" topmargin=\"8\" marginheight=\"4\" offset=\"0\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">              &lt;table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" style=\"font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;(本邮件由程序自动下发，请勿回复！)&lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;h2&gt;&lt;font color=\"#FF0000\"&gt;构建结果 - $&#123;BUILD_STATUS&#125;&lt;/font&gt;&lt;/h2&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;&lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;b&gt;&lt;font color=\"#0B610B\"&gt;构建信息&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;&lt;a href=\"$&#123;PROJECT_URL&#125;\"&gt;$&#123;PROJECT_URL&#125;&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;项目名称：$&#123;PROJECT_NAME&#125;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;GIT路径：&lt;a href=\"git@gitlab.weiyigeek.top:weiyigeek/ops.git\"&gt;git@gitlab.weiyigeek.top:weiyigeek/ops.git&lt;/a&gt;&lt;/li&gt;   </span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;GIT分支： master&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;构建编号：$&#123;BUILD_NUMBER&#125;&lt;/li&gt;                    </span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;触发原因：$&#123;CAUSE&#125;&lt;/li&gt;   </span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;构建日志：&lt;a href=\"$&#123;BUILD_URL&#125;console\"&gt;$&#123;BUILD_URL&#125;console&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;/ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;b&gt;&lt;font color=\"#0B610B\"&gt;变更信息:&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;上次构建成功后变化 :  $&#123;CHANGES_SINCE_LAST_SUCCESS&#125;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;上次构建不稳定后变化 :  $&#123;CHANGES_SINCE_LAST_UNSTABLE&#125;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;历史变更记录 : &lt;a href=\"$&#123;PROJECT_URL&#125;changes\"&gt;$&#123;PROJECT_URL&#125;changes&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;ul&gt;</span></span><br><span class=\"line\"><span class=\"string\">                              &lt;li&gt;变更集:$&#123;JELLY_SCRIPT,template=\"html\"&#125;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;/ul&gt;    </span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;!--</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;b&gt;&lt;font color=\"#0B610B\"&gt;Failed Test Results&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;pre style=\"font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif\"&gt;$FAILED_TESTS&lt;/pre&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  </span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;b&gt;&lt;font color=\"#0B610B\"&gt;构建日志 (最后 100行):&lt;/font&gt;&lt;/b&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;!-- &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;Test Logs (if test has ran): &lt;a</span></span><br><span class=\"line\"><span class=\"string\">                          href=\"$&#123;PROJECT_URL&#125;ws/TestResult/archive_logs/Log-Build-$&#123;BUILD_NUMBER&#125;.zip\"&gt;$&#123;PROJECT_URL&#125;/ws/TestResult/archive_logs/Log-Build-$&#123;BUILD_NUMBER&#125;.zip&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;br /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt; --&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;!--</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;tr&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                          &lt;textarea cols=\"80\" rows=\"30\" readonly=\"readonly\" style=\"font-family: Courier New\"&gt;$&#123;BUILD_LOG, maxLines=100,escapeHtml=true&#125;&lt;/textarea&gt;</span></span><br><span class=\"line\"><span class=\"string\">                      &lt;/td&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;/tr&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"string\">                  &lt;hr size=\"2\" width=\"100%\" align=\"center\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">            </span></span><br><span class=\"line\"><span class=\"string\">              &lt;/table&gt;</span></span><br><span class=\"line\"><span class=\"string\">            </span></span><br><span class=\"line\"><span class=\"string\">            </span></span><br><span class=\"line\"><span class=\"string\">          &lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"string\">          &lt;/html&gt;</span></span><br><span class=\"line\"><span class=\"string\">'''</span>, </span><br><span class=\"line\"><span class=\"symbol\">              subject:</span> <span class=\"string\">'$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!'</span>, <span class=\"string\">to:</span> <span class=\"string\">'master@weiyigeek.top'</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          success &#123;</span><br><span class=\"line\">              <span class=\"comment\">//当此Pipeline成功时打印消息</span></span><br><span class=\"line\">              echo <span class=\"string\">'success'</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          failure &#123;</span><br><span class=\"line\">              <span class=\"comment\">//当此Pipeline失败时打印消息</span></span><br><span class=\"line\">              echo <span class=\"string\">'failure'</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          unstable &#123;</span><br><span class=\"line\">              <span class=\"comment\">//当此Pipeline 为不稳定时打印消息</span></span><br><span class=\"line\">              echo <span class=\"string\">'unstable'</span>     </span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          aborted &#123;</span><br><span class=\"line\">              <span class=\"comment\">//当此Pipeline 终止时打印消息</span></span><br><span class=\"line\">              echo <span class=\"string\">'aborted'</span>  </span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          changed &#123;</span><br><span class=\"line\">              <span class=\"comment\">//当pipeline的状态与上一次build状态不同时打印消息</span></span><br><span class=\"line\">              echo <span class=\"string\">'changed'</span>          </span><br><span class=\"line\">          &#125; </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x02-进阶实践\"><a href=\"#0x02-进阶实践\" class=\"headerlink\" title=\"0x02 进阶实践\"></a>0x02 进阶实践</h2><h3 id=\"1-Sonarqube-代码质量检测之-Pipeline-Script-from-SCM\"><a href=\"#1-Sonarqube-代码质量检测之-Pipeline-Script-from-SCM\" class=\"headerlink\" title=\"(1) Sonarqube 代码质量检测之 Pipeline Script from SCM\"></a>(1) Sonarqube 代码质量检测之 Pipeline Script from SCM</h3><p><strong>实验需求: 拉取代码并指定Tag、采用sonarqube进行代码质量检测并进行构建</strong></p>\n<p>Tips : sonarQube 是sonarQube扫描插件工具, 该工具除了前面直接下载二进制执行文件到Jenkins种(登陆jenkins页面–&gt;系统管理–&gt;全局工具配置)进行配置； 还可以通过自动化构建工具安装，不管是maven项目还是gradle项目都提供了安装sonarQube扫描工具的插件。；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plugins &#123;</span><br><span class=\"line\">  id <span class=\"string\">\"org.sonarqube\"</span> version <span class=\"string\">\"2.7\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><strong>实验流程:</strong></p>\n<ul>\n<li>Step 0.按照前面的流程在Jenkins中下载并配置好<code>SonarQube</code>并且在SonarQube中进行URL设置<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关键项:</span></span><br><span class=\"line\"><span class=\"comment\"># (1) Sonarqube 通用配置项</span></span><br><span class=\"line\">Server base URL : http://sonar.weiyigeek.top:9000/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) Dashboard -&gt; 全局配置 -&gt; SonarQube servers </span></span><br><span class=\"line\"><span class=\"comment\"># 环境变量允许将SonarQube服务器配置注入构建环境变量</span></span><br><span class=\"line\">Server URL : http://sonar.weiyigeek.top:9000</span><br><span class=\"line\">Server authentication token : 可以参照下面的Step2步骤</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210201223057.png\" alt=\"WeiyiGeek.Jenkins && Sonarqube\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Jenkins && Sonarqube</p>\n            </figure>\n<ul>\n<li><p>Step 1.并生成项目标识符名称(<code>somarqube-test</code>)并获取令牌<code>somarqube-test: 4354fc222bee3c2bad2d812b087dabab943a7ab0</code></p>\n</li>\n<li><p>Step 2.将该Token添加到Jenkins凭据之中<code>Dashboard -&gt; 凭据 -&gt; 系统 -&gt; 全局凭据 (unrestricted)</code>选择Secret类型文本 -&gt; Secret(输入上面的Token) -&gt; 描述:somarqube-test-api;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Secret text\t6810ea0d-e76a-40cf-9373-5040ed6b5456\tsomarqube-test-api\tSecret text\tsomarqube-test-api</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210201093540.png\" alt=\"WeiyiGeek.somarqube-test-api\" title=\"\" class=\"\">\n                <p>WeiyiGeek.somarqube-test-api</p>\n            </figure>\n<ul>\n<li>Step 3.创建一个流水线项目<code>somarqube-test-pipeline</code> -&gt; 编写Pipeline Script脚本如下(非常值得注意涵盖的知识较多)</li>\n</ul>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent any</span><br><span class=\"line\">  <span class=\"comment\">/* 该块中的变量将写入到Linux环境变量之中作为全局变量，在shell可通过变量名访问，而在script pipeline脚本中通过env.变量名称访问. */</span></span><br><span class=\"line\">  environment &#123;</span><br><span class=\"line\">    GITLAB_URL = <span class=\"string\">'git@gitlab.weiyigeek.top:ci-cd/java-maven.git'</span></span><br><span class=\"line\">    <span class=\"comment\">// 代码质量检测项目名称</span></span><br><span class=\"line\">    SONARQUBE_PROJECTKEY = <span class=\"string\">'somarqube-test'</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 代码质量检测反馈超时时间</span></span><br><span class=\"line\">    SONARQUBE_TIMEOUT = <span class=\"string\">'10'</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 版本号</span></span><br><span class=\"line\">    <span class=\"comment\">//RELEASE_VERSION=\"v1.1\"</span></span><br><span class=\"line\">    <span class=\"comment\">// 默认操作方式</span></span><br><span class=\"line\">    <span class=\"comment\">//PREJECT_OPERATION=\"deploy\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* 全局参数, 在shell可通过变量名访问，而在script pipeline脚本中通过params.参数名称访问.  */</span></span><br><span class=\"line\">  parameters &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Jenkins -&gt; 原生 Build With Parameters 支持 (BuleOcean不支持gitParameter) </span></span><br><span class=\"line\">  <span class=\"comment\">//   gitParameter name: 'RELEASE_VERSION', </span></span><br><span class=\"line\">  <span class=\"comment\">//                    type: 'PT_BRANCH_TAG',</span></span><br><span class=\"line\">  <span class=\"comment\">//                    branchFilter: 'origin/(.*)',</span></span><br><span class=\"line\">  <span class=\"comment\">//                    defaultValue: 'master',</span></span><br><span class=\"line\">  <span class=\"comment\">//                    selectedValue: 'DEFAULT',</span></span><br><span class=\"line\">  <span class=\"comment\">//                    sortMode: 'DESCENDING_SMART',</span></span><br><span class=\"line\">  <span class=\"comment\">// \t\t\t\t description: 'Message: 请选择部署的Tags版本?'</span></span><br><span class=\"line\">    choice(<span class=\"string\">name:</span> <span class=\"string\">'SONARQUBE'</span>, <span class=\"string\">choices:</span> [<span class=\"string\">'False'</span>,<span class=\"string\">'True'</span>],<span class=\"string\">description:</span> <span class=\"string\">'Message: 是否进行代码质量检测?'</span>)\t</span><br><span class=\"line\">    string(<span class=\"string\">name:</span> <span class=\"string\">'RELEASE_VERSION'</span>, <span class=\"string\">defaultValue:</span> <span class=\"string\">\"\"</span>, <span class=\"string\">description:</span> <span class=\"string\">'Message: 请选择部署的Tags版本?'</span>)</span><br><span class=\"line\">    choice(<span class=\"string\">name:</span> <span class=\"string\">'PREJECT_OPERATION'</span>, <span class=\"string\">choices:</span> [<span class=\"string\">'deploy'</span>, <span class=\"string\">'rollback'</span>, <span class=\"string\">'redeploy'</span>], <span class=\"string\">description:</span> <span class=\"string\">'Message: 选择项目操作方式?'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage (<span class=\"string\">'代码拉取'</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">//注意: 此处得input不能包含在steps中并且只有局部stage块中可用调用，调用方式 $&#123;RELEASE_VERSION&#125; $&#123;PREJECT_OPERATION&#125; </span></span><br><span class=\"line\">      <span class=\"comment\">// input &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">//   message \"Title : $&#123;JOB_NAME&#125; 项目构建参数\"</span></span><br><span class=\"line\">      <span class=\"comment\">//   ok \"完成提交\"</span></span><br><span class=\"line\">      <span class=\"comment\">//   parameters &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">//     string(name: 'RELEASE_VERSION', defaultValue: '', description: 'Message: 请选择部署的Tags版本?')</span></span><br><span class=\"line\">      <span class=\"comment\">//     choice(name: 'PREJECT_OPERATION', choices: ['deploy', 'rollback', 'redeploy'], description: 'Message: 选择项目操作方式?')</span></span><br><span class=\"line\">      <span class=\"comment\">//   &#125;</span></span><br><span class=\"line\">      <span class=\"comment\">// &#125;</span></span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        <span class=\"comment\">// (1) git项目拉取</span></span><br><span class=\"line\">        git <span class=\"string\">branch:</span> <span class=\"string\">\"$&#123;params.RELEASE_VERSION&#125;\"</span>, <span class=\"string\">credentialsId:</span> <span class=\"string\">'b4c8b4e9-2777-44a1-a1ed-e9dc21d37f4f'</span>, <span class=\"string\">url:</span> <span class=\"string\">\"$&#123;env.GITLAB_URL&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// (2) 超时时间设置 5 分钟</span></span><br><span class=\"line\">        timeout(<span class=\"string\">time:</span> <span class=\"number\">1</span>, <span class=\"string\">unit:</span> <span class=\"string\">'MINUTES'</span>) &#123;</span><br><span class=\"line\">          script &#123;</span><br><span class=\"line\">              <span class=\"comment\">// (3) 存储可用版本</span></span><br><span class=\"line\">              <span class=\"keyword\">def</span> RELEASE=sh <span class=\"string\">label:</span> <span class=\"string\">'release'</span>,<span class=\"string\">returnStdout:</span> <span class=\"literal\">true</span>, <span class=\"string\">script:</span> <span class=\"string\">\"\"\"\\</span></span><br><span class=\"line\"><span class=\"string\">              git tag -l --column | tr -d ' '  &gt; tag ;</span></span><br><span class=\"line\"><span class=\"string\">              export a=\"\\$(sed \"s#v#, v#g\" tag)'\";</span></span><br><span class=\"line\"><span class=\"string\">              echo [\\$&#123;a#,*&#125;]</span></span><br><span class=\"line\"><span class=\"string\">              \"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"comment\">// 由于此处是groovy的变量此处得input通过script块包含只有局部stage块中可用调用(故此处不采用)</span></span><br><span class=\"line\">              <span class=\"comment\">// (4) 定义操作变量(RELEASE_VERSION 与 PREJECT_OPERATION) 注意此处无法影响shell中的变量</span></span><br><span class=\"line\">              <span class=\"comment\">//def RELEASE_VERSION=input message: \"$&#123;JOB_NAME&#125; 项目版本:\\n $&#123;RELEASE&#125;\", ok: '完成提交', parameters: [ string(name: 'RELEASE_VERSION', description: 'Message: 请选择部署的Tags版本?')];</span></span><br><span class=\"line\">              <span class=\"comment\">//def PREJECT_OPERATION=input message: \"$&#123;JOB_NAME&#125; 项目构建参数\", ok: '完成提交', parameters: [choice(name: 'PREJECT_OPERATION', choices: ['deploy', 'rollback', 'redeploy'], description: 'Message: 选择项目操作方式?')];</span></span><br><span class=\"line\">           </span><br><span class=\"line\">              <span class=\"comment\">// (5) 输出变量与操作</span></span><br><span class=\"line\">              <span class=\"comment\">// 例如: RELEASE_VERSION: v1.11 , PREJECT_OPERATION: redeploy. SONARQUBE: True</span></span><br><span class=\"line\">              echo <span class=\"string\">\"RELEASE_VERSION: $&#123;RELEASE_VERSION&#125; , PREJECT_OPERATION: $&#123;PREJECT_OPERATION&#125;. SONARQUBE: $&#123;params.SONARQUBE&#125;\"</span></span><br><span class=\"line\">        </span><br><span class=\"line\">              <span class=\"comment\">// (6) 切换分支版本(其实上面有了branch: \"$&#123;params.RELEASE_VERSION&#125;\"此处显得多余)</span></span><br><span class=\"line\">              sh <span class=\"string\">label:</span> <span class=\"string\">'checkout_version'</span>, <span class=\"string\">script:</span> <span class=\"string\">'[ -n \"$&#123;RELEASE_VERSION&#125;\" ] &amp;&amp;  git checkout $&#123;RELEASE_VERSION&#125; || &#123; echo -e \"切换至指定的tag的版本 tag：$&#123;RELEASE_VERSION&#125; 不存在或为空，请检查输入的tag!\" &amp;&amp; exit 1; &#125;'</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">    stage (<span class=\"string\">'代码检测'</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// (7) 判断是否进行代码质量检测</span></span><br><span class=\"line\">      when &#123;</span><br><span class=\"line\">        <span class=\"comment\">// expression &#123; return params.SONARQUBE == \"True\" &#125;</span></span><br><span class=\"line\">        anyOf &#123;</span><br><span class=\"line\">          environment <span class=\"string\">name:</span> <span class=\"string\">'SONARQUBE'</span>, <span class=\"string\">value:</span> <span class=\"string\">'True'</span></span><br><span class=\"line\">          environment <span class=\"string\">name:</span> <span class=\"string\">'PREJECT_OPERATION'</span>, <span class=\"string\">value:</span> <span class=\"string\">'deploy'</span></span><br><span class=\"line\">          environment <span class=\"string\">name:</span> <span class=\"string\">'PREJECT_OPERATION'</span>, <span class=\"string\">value:</span> <span class=\"string\">'redeploy'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        script &#123;</span><br><span class=\"line\">        <span class=\"comment\">// (8) Tool 后的名称一定是对应全局工具配置中sonar扫描器的名字进行代码质量检测</span></span><br><span class=\"line\">        <span class=\"keyword\">def</span> sonarqubeScanner = tool <span class=\"string\">'sonarqubescanner'</span>;</span><br><span class=\"line\">        withSonarQubeEnv(<span class=\"string\">credentialsId:</span> <span class=\"string\">'6810ea0d-e76a-40cf-9373-5040ed6b5456'</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 注意:可以将sonarQube的属性定义在这里，也可以定义在项目文件中然后在这里引用配置文件</span></span><br><span class=\"line\">          sh <span class=\"string\">\"$&#123;sonarqubeScanner&#125;/bin/sonar-scanner \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.projectName=$&#123;JOB_NAME&#125; \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.projectKey=$&#123;SONARQUBE_PROJECTKEY&#125; \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.projectVersion=$&#123;RELEASE_VERSION&#125; \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.sourceEncoding=utf8  \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.sources=.  \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.language=java  \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.java.binaries=.\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// (9) 暂停10s等待sonarqube扫描反馈</span></span><br><span class=\"line\">        sh <span class=\"string\">\"sleep $&#123;SONARQUBE_TIMEOUT&#125;\"</span></span><br><span class=\"line\">        <span class=\"comment\">// 方式1</span></span><br><span class=\"line\">        <span class=\"comment\">// timeout(1) &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//     def qg = waitForQualityGate() </span></span><br><span class=\"line\">        <span class=\"comment\">//     if (qg.status != 'OK') &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//         error \"未通过Sonarqube的代码质量阈检查，请及时修改！failure: $&#123;qg.status&#125;\"</span></span><br><span class=\"line\">        <span class=\"comment\">//     &#125; else &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//         echo \"successful\"</span></span><br><span class=\"line\">        <span class=\"comment\">//     &#125;</span></span><br><span class=\"line\">        <span class=\"comment\">// &#125; </span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 方式2</span></span><br><span class=\"line\">        timeout(<span class=\"string\">time:</span> <span class=\"number\">1</span>, <span class=\"string\">unit:</span> <span class=\"string\">'MINUTES'</span>) &#123;</span><br><span class=\"line\">            waitForQualityGate <span class=\"string\">abortPipeline:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// (10) 项目构建打包处理</span></span><br><span class=\"line\">    stage (<span class=\"string\">\"项目构建\"</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">       sh <span class=\"string\">label:</span> <span class=\"string\">'build'</span>, <span class=\"string\">script:</span> <span class=\"string\">'/usr/local/maven/bin/mvn clean package -Dmaven.test.skip=true '</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// (11) 进行开发测试部署</span></span><br><span class=\"line\">    stage (<span class=\"string\">\"开发测试部署\"</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        echo <span class=\"string\">\"后续添加......\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// (12) 全部阶段完成后执行进行工作空间的清理以及消息通知;</span></span><br><span class=\"line\">  post &#123;</span><br><span class=\"line\">    always &#123;</span><br><span class=\"line\">        echo <span class=\"string\">'One way or another, I have finished'</span></span><br><span class=\"line\">        deleteDir() <span class=\"comment\">/* clean up our workspace */</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    success &#123;</span><br><span class=\"line\">        echo <span class=\"string\">'I succeeeded!'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    unstable &#123;</span><br><span class=\"line\">        echo <span class=\"string\">'I am unstable :/'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    failure &#123;</span><br><span class=\"line\">        echo <span class=\"string\">'I failed :('</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    changed &#123;</span><br><span class=\"line\">        echo <span class=\"string\">'Things were different before...'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Step 4.项目运行以及代码拉取结果反馈<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># git@gitlab.weiyigeek.top:ci-cd/java-maven.git— Print Message &lt;1s</span></span><br><span class=\"line\"><span class=\"comment\"># Git  4s</span></span><br><span class=\"line\"><span class=\"comment\"># 查看可用标签</span></span><br><span class=\"line\"><span class=\"comment\"># git tag -l --column | tr -d ' ' &gt; tag ; export a=\"$(sed \"s#v#, v#g\" tag)'\"; echo [$&#123;a#,*&#125;] — release&lt;1s</span></span><br><span class=\"line\"><span class=\"comment\"># RELEASE_VERSION: v1.11 , PREJECT_OPERATION: deploy. SONARQUBE: True— Print Message &lt;1s</span></span><br><span class=\"line\"><span class=\"comment\"># [ -n \"$&#123;RELEASE_VERSION&#125;\" ] &amp;&amp; git checkout $&#123;RELEASE_VERSION&#125; || &#123; echo -e \"切换至指定的tag的版本 tag：$&#123;RELEASE_VERSION&#125; 不存在或为空，请检查输入的tag!\" &amp;&amp; exit 1; &#125;— checkout_version  &lt;1s</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210201230027.png\" alt=\"WeiyiGeek.项目运行以及代码拉取\" title=\"\" class=\"\">\n                <p>WeiyiGeek.项目运行以及代码拉取</p>\n            </figure>\n<ul>\n<li>Step 5.代码检测阶段查看(重点), SonarQube analysis api 接口URL(<code>http://sonar.weiyigeek.top:9000/api/ce/task?id=AXdd7NO4mUDNtrevcJJD</code>)<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># sonarqubescanner— Use a tool from a predefined Tool Installation &lt;1s</span></span><br><span class=\"line\"><span class=\"comment\"># /usr/local/sonar//bin/sonar-scanner -Dsonar.projectName=somarqube-test-pipeline -Dsonar.projectKey=somarqube-test -Dsonar.projectVersion=v1.11 -Dsonar.sourceEncoding=utf8 -Dsonar.sources=. -Dsonar.language=java -Dsonar.java.binaries=.— Shell Script7s</span></span><br><span class=\"line\"><span class=\"comment\"># sleep 10 — Shell Script10s</span></span><br><span class=\"line\"><span class=\"comment\"># true— Wait for SonarQube analysis to be completed and return quality gate status  &lt;1s</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210201230427.png\" alt=\"WeiyiGeek.代码检测阶段查\" title=\"\" class=\"\">\n                <p>WeiyiGeek.代码检测阶段查</p>\n            </figure>\n<ul>\n<li>Step 6.综合效果</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210201230632.png\" alt=\"WeiyiGeek.最终效果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.最终效果</p>\n            </figure>\n<p><br></p>\n<h3 id=\"2-Gitlab-自动触发构建之-Pipeline-Script-from-SCM\"><a href=\"#2-Gitlab-自动触发构建之-Pipeline-Script-from-SCM\" class=\"headerlink\" title=\"(2) Gitlab 自动触发构建之 Pipeline Script from SCM\"></a>(2) Gitlab 自动触发构建之 Pipeline Script from SCM</h3><p><strong>实验需求：Gitlab 上传自动触发Jenkins构建并通过BlueOcan进行控制构建, 以及与 Gitlab 流水线状态同步</strong></p>\n<p><strong>实验流程:</strong></p>\n<ul>\n<li>Step 1.此处假设您已安装配置Gitlab Authentication plugin、GitLab Plugin这两个插件</li>\n<li>Step 2.到 Gitlab私有仓库中进行生成项目<code>API Access Token</code> -&gt; 用户设置 -&gt; 访问令牌 -&gt; 输入您的应用程序的名称 -&gt; 选择相应到期时间 -&gt; 范围: <code>授予对API的完全读/写访问权，包括所有组和项目、容器注册表和包注册表</code> -&gt; 然后创建个人访问令牌;</li>\n<li><p>Step 3.得到api Token(kWL_9Fw_nvbxTkpDb9X6)后在Jenkins中添加全局凭据 -&gt; Dashboard -&gt; 凭据 -&gt; 系统 -&gt; 全局凭据 (unrestricted) -&gt; 选择凭据类型为<code>Gitlab API Token</code> -&gt; 然后确定即可 -&gt; 他会自动生成一个类似于UUID的一个字符串</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Value</span></span><br><span class=\"line\">f49076a8-11e4-4351-a88a-143cfab6555b\tGitLab API token (gitlab_admin_api)\tGitLab API token\tgitlab_admin</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210127155243.png\" alt=\"WeiyiGeek.Gitlab-API-Token\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Gitlab-API-Token</p>\n            </figure>\n</li>\n<li><p>Step 4.或者直接在全局配置的 Gitlab -&gt; Enable authentication for ‘/project’ end-point -&gt; 应用保存；</p>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210127160603.png\" alt=\"WeiyiGeek.Gitlab-Token-配置\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Gitlab-Token-配置</p>\n            </figure>\n<ul>\n<li>Step 5.在Dashboard -&gt; Gitlab-Pipeline Job 中 -&gt; 构建触发器  -&gt; 勾选<code>Build when a change is pushed to GitLab.</code> -&gt; 重新生成打开的合并请求为<code>On push to source branch</code> -&gt; Comment (regex) for triggering a build 可以在提交<code>Jenkins build</code>字符串进行触发构建编译;</li>\n</ul>\n<ul>\n<li>Step 6.Jenkins 生成 Api Token -&gt; 面板 _&gt; 用户设置 -&gt; API Token 生成 (APl令牌提供了一种进行经过身份验证的CLI或REST API调用的方法。注意每六个月需要重新生成一次） <code>11112e147020668570e571fa438439cc60</code><br>Tips: 每次重新启动Jenkins时，未使用的遗留令牌的创建日期将被重置，这意味着日期可能不准确。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210127162312.png\" alt=\"WeiyiGeek.Jenkins-API-Token\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Jenkins-API-Token</p>\n            </figure>\n<ul>\n<li>Step 7.在Gitlab -&gt; java-maven 项目 -&gt; 设置 -&gt; WebHooks -&gt; 地址为是前面Build when a change is pushed to GitLab. GitLab webhook URL中的地址 <code>http://jenkins.weiyigeek.top:8080/project/Gitlab-Pipeline</code>-&gt; 输入 <code>Secret Token</code> -&gt; 选择<code>Push events Trigger</code> -&gt; add Webhook -&gt; 最后进行选择push events测试 -&gt; Hook executed successfully: HTTP 200<ul>\n<li>注意事项:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#补充说明</span></span><br><span class=\"line\">Gitlab Project -&gt; helloworld -&gt; Webhook设置 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Gitlab 设置</span></span><br><span class=\"line\">URL ：Jenkins Job</span><br><span class=\"line\">Secret Token</span><br><span class=\"line\">Trigger</span><br><span class=\"line\">  Push events  : This URL will be triggered by a push to the repository  (每次提交都将触发-如不需要则不要勾选即可)</span><br><span class=\"line\">  Tag push events : This URL will be triggered when a new tag is pushed to the repository  (非常建议设置tag后才会触发) - 一般开启该事件选项后不建议开启Push evnts</span><br><span class=\"line\">  Comments : This URL will be triggered when someone adds a comment (评论触发)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 成功 &gt; 控制台输出 #32</span></span><br><span class=\"line\"><span class=\"comment\"># 2021-2-23 上午11:38 CST</span></span><br><span class=\"line\"><span class=\"comment\"># Started by GitLab push by Gitlab WeiyiGeek</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210127164940.png\" alt=\"WeiyiGeek.GitLab webhook URL\" title=\"\" class=\"\">\n                <p>WeiyiGeek.GitLab webhook URL</p>\n            </figure>\n<p>Tips : 此处需要设置允许来自钩子和服务的对本地网络的请求。<br>Tips : 注意请根据您的Jenkins站点启用SSL(建议内网也需要注意的)</p>\n<ul>\n<li>Step 8.此处先使用<code>Pipeine Script</code>脚本然后应用保存然后上传v1.11版本到Gitlab，查看是否自动触发Build;</li>\n</ul>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent any</span><br><span class=\"line\">  <span class=\"comment\">// 全局选项</span></span><br><span class=\"line\">  options &#123;</span><br><span class=\"line\">    gitLabConnection(<span class=\"string\">'Private-Gitlab'</span>)</span><br><span class=\"line\">    gitlabBuilds(<span class=\"string\">builds:</span> [<span class=\"string\">'代码拉取'</span>, <span class=\"string\">'代码检测'</span>, <span class=\"string\">'项目构建'</span>,<span class=\"string\">'测试部署'</span>,<span class=\"string\">'成品归档'</span>])</span><br><span class=\"line\">    timeout</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  environment &#123;</span><br><span class=\"line\">    GITLAB_URL = <span class=\"string\">'git@gitlab.weiyigeek.top:ci-cd/java-maven.git'</span></span><br><span class=\"line\">    <span class=\"comment\">// 代码质量检测项目名称</span></span><br><span class=\"line\">    SONARQUBE_PROJECTKEY = <span class=\"string\">'Hello-World'</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 代码质量检测反馈超时时间</span></span><br><span class=\"line\">    SONARQUBE_TIMEOUT = <span class=\"string\">'10'</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 版本号</span></span><br><span class=\"line\">    <span class=\"comment\">//RELEASE_VERSION=\"v1.1\"</span></span><br><span class=\"line\">    <span class=\"comment\">// 默认操作方式</span></span><br><span class=\"line\">    <span class=\"comment\">//PREJECT_OPERATION=\"deploy\"</span></span><br><span class=\"line\">    <span class=\"comment\">// 企业微信WebHookURL</span></span><br><span class=\"line\">    QYWX_WEBHOOK = <span class=\"string\">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c222f3fc-f645-440a-ad24-0ce8d9626fa0'</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* 全局参数, 在shell可通过变量名访问，而在script pipeline脚本中通过params.参数名称访问.  */</span></span><br><span class=\"line\">  parameters &#123;</span><br><span class=\"line\">    string(<span class=\"string\">name:</span> <span class=\"string\">'RELEASE_VERSION'</span>, <span class=\"string\">defaultValue:</span> <span class=\"string\">\"master\"</span>, <span class=\"string\">description:</span> <span class=\"string\">'Message: 请选择部署的Tags版本?'</span>,<span class=\"string\">trim:</span> <span class=\"string\">'True'</span>)</span><br><span class=\"line\">    choice(<span class=\"string\">name:</span> <span class=\"string\">'PREJECT_OPERATION'</span>, <span class=\"string\">choices:</span> [<span class=\"string\">'deploy'</span>, <span class=\"string\">'rollback'</span>, <span class=\"string\">'redeploy'</span>], <span class=\"string\">description:</span> <span class=\"string\">'Message: 选择项目操作方式?'</span>)</span><br><span class=\"line\">    choice(<span class=\"string\">name:</span> <span class=\"string\">'SONARQUBE'</span>, <span class=\"string\">choices:</span> [<span class=\"string\">'False'</span>,<span class=\"string\">'True'</span>],<span class=\"string\">description:</span> <span class=\"string\">'Message: 是否进行代码质量检测?'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   triggers &#123;</span><br><span class=\"line\">        gitlab(<span class=\"string\">triggerOnPush:</span> <span class=\"literal\">true</span>, <span class=\"string\">triggerOnMergeRequest:</span> <span class=\"literal\">true</span>, <span class=\"string\">branchFilterType:</span> <span class=\"string\">'All'</span>)</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\"></span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage (<span class=\"string\">'代码拉取'</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        <span class=\"comment\">// (1) git项目拉取</span></span><br><span class=\"line\">        echo <span class=\"string\">\"$&#123;env.GITLAB_URL&#125; -- $&#123;params.RELEASE_VERSION&#125;\"</span></span><br><span class=\"line\">        <span class=\"comment\">// (2) 超时时间设置 5 分钟</span></span><br><span class=\"line\">        timeout(<span class=\"string\">time:</span> <span class=\"number\">1</span>, <span class=\"string\">unit:</span> <span class=\"string\">'MINUTES'</span>) &#123;</span><br><span class=\"line\">          script &#123;</span><br><span class=\"line\">              <span class=\"keyword\">try</span> &#123; </span><br><span class=\"line\">                          echo <span class=\"string\">\"$&#123;env.GITLAB_URL&#125; -- $&#123;params.RELEASE_VERSION&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// 方式1: git branch: 'v1.11', credentialsId: '43287e62-ce5b-489a-9c11-cedf38e16e92', url: \"$&#123;env.GITLAB_URL&#125;\"</span></span><br><span class=\"line\">                <span class=\"comment\">// 方式2:</span></span><br><span class=\"line\">                checkout([<span class=\"string\">$class:</span> <span class=\"string\">'GitSCM'</span>, <span class=\"string\">branches:</span> [[<span class=\"string\">name:</span> <span class=\"string\">\"$&#123;params.RELEASE_VERSION&#125;\"</span>]], <span class=\"string\">doGenerateSubmoduleConfigurations:</span> <span class=\"literal\">false</span>, <span class=\"string\">extensions:</span> [], <span class=\"string\">submoduleCfg:</span> [], <span class=\"string\">userRemoteConfigs:</span> [[<span class=\"string\">credentialsId:</span> <span class=\"string\">'b4c8b4e9-2777-44a1-a1ed-e9dc21d37f4f'</span>, <span class=\"string\">url:</span> <span class=\"string\">\"$&#123;env.GITLAB_URL&#125;\"</span>]]])</span><br><span class=\"line\">                updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码拉取'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">              &#125; <span class=\"keyword\">catch</span>(Exception err) &#123;</span><br><span class=\"line\">                updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码拉取'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">                <span class=\"comment\">// 显示错误信息但还是会进行下一阶段操作</span></span><br><span class=\"line\">                echo err.toString()    <span class=\"comment\">/* hudson.AbortException: Couldn't find any revision to build. Verify the repository and branch configuration for this job. */</span></span><br><span class=\"line\">                unstable <span class=\"string\">'拉取代码失败'</span></span><br><span class=\"line\">                <span class=\"comment\">// 构建停止</span></span><br><span class=\"line\">                error <span class=\"string\">\"[-Error] : 代码拉取失败\\n [-Msg] : $&#123;err.getMessage()&#125; \"</span></span><br><span class=\"line\"></span><br><span class=\"line\">              &#125; </span><br><span class=\"line\">              <span class=\"comment\">// (3) 存储可用版本</span></span><br><span class=\"line\">              <span class=\"keyword\">def</span> RELEASE=sh <span class=\"string\">label:</span> <span class=\"string\">'release'</span>,<span class=\"string\">returnStdout:</span> <span class=\"literal\">true</span>, <span class=\"string\">script:</span> <span class=\"string\">\"\"\"\\</span></span><br><span class=\"line\"><span class=\"string\">              git tag -l --column | tr -d ' '  &gt; tag ;</span></span><br><span class=\"line\"><span class=\"string\">              export a=\"\\$(sed \"s#v#, v#g\" tag)'\";</span></span><br><span class=\"line\"><span class=\"string\">              echo [\\$&#123;a#,*&#125;]</span></span><br><span class=\"line\"><span class=\"string\">              \"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"comment\">// (4) 输出变量与操作</span></span><br><span class=\"line\">              <span class=\"comment\">// 例如: RELEASE_VERSION: v1.11 , PREJECT_OPERATION: redeploy. SONARQUBE: True</span></span><br><span class=\"line\">              echo <span class=\"string\">\"RELEASE_VERSION: $&#123;params.RELEASE_VERSION&#125; , PREJECT_OPERATION: $&#123;params.PREJECT_OPERATION&#125;. SONARQUBE: $&#123;params.SONARQUBE&#125;\"</span></span><br><span class=\"line\">        </span><br><span class=\"line\">              <span class=\"comment\">// (5) 切换数据库版本</span></span><br><span class=\"line\">              <span class=\"comment\">//sh label: 'checkout_version', script: '[ -n \"$&#123;RELEASE_VERSION&#125;\" ] &amp;&amp;  git checkout $&#123;RELEASE_VERSION&#125; || &#123; echo -e \"切换至指定的tag的版本 tag：$&#123;RELEASE_VERSION&#125; 不存在或为空，请检查输入的tag!\" &amp;&amp; exit 1; &#125;'</span></span><br><span class=\"line\">              sh <span class=\"string\">\"git branch\"</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">    stage (<span class=\"string\">'代码检测'</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// (6) 判断是否进行代码质量检测</span></span><br><span class=\"line\">      when &#123;</span><br><span class=\"line\">        expression &#123; <span class=\"keyword\">return</span> params.PREJECT_OPERATION != <span class=\"string\">\"rollback\"</span> &#125;</span><br><span class=\"line\">        anyOf &#123;</span><br><span class=\"line\">          environment <span class=\"string\">name:</span> <span class=\"string\">'SONARQUBE'</span>, <span class=\"string\">value:</span> <span class=\"string\">'True'</span></span><br><span class=\"line\">          environment <span class=\"string\">name:</span> <span class=\"string\">'PREJECT_OPERATION'</span>, <span class=\"string\">value:</span> <span class=\"string\">'deploy'</span></span><br><span class=\"line\">          environment <span class=\"string\">name:</span> <span class=\"string\">'PREJECT_OPERATION'</span>, <span class=\"string\">value:</span> <span class=\"string\">'redeploy'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        script &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">        <span class=\"comment\">// (7) Tool 后的名称一定是对应全局工具配置中sonar扫描器的名字进行代码质量检测</span></span><br><span class=\"line\">        <span class=\"keyword\">def</span> sonarqubeScanner = tool <span class=\"string\">'sonarqubescanner'</span>;</span><br><span class=\"line\">        withSonarQubeEnv(<span class=\"string\">credentialsId:</span> <span class=\"string\">'6810ea0d-e76a-40cf-9373-5040ed6b5456'</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 注意:可以将sonarQube的属性定义在这里，也可以定义在项目文件中然后在这里引用配置文件</span></span><br><span class=\"line\">          sh <span class=\"string\">\"$&#123;sonarqubeScanner&#125;/bin/sonar-scanner \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.projectName=$&#123;JOB_NAME&#125; \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.projectKey=$&#123;SONARQUBE_PROJECTKEY&#125; \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.projectVersion=$&#123;RELEASE_VERSION&#125; \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.sourceEncoding=utf8  \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.sources=.  \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.language=java  \"</span> + </span><br><span class=\"line\">                <span class=\"string\">\"-Dsonar.java.binaries=.\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// (8) 暂停10s等待sonarqube扫描反馈</span></span><br><span class=\"line\">        sleep <span class=\"string\">time:</span> <span class=\"string\">\"$&#123;env.SONARQUBE_TIMEOUT&#125;\"</span>, <span class=\"string\">unit:</span> <span class=\"string\">'NANOSECONDS'</span></span><br><span class=\"line\">        sh <span class=\"string\">\"sleep $&#123;SONARQUBE_TIMEOUT&#125;\"</span></span><br><span class=\"line\">        <span class=\"comment\">// 方式1</span></span><br><span class=\"line\">        <span class=\"comment\">// timeout(1) &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//     def qg = waitForQualityGate() </span></span><br><span class=\"line\">        <span class=\"comment\">//     if (qg.status != 'OK') &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//         error \"未通过Sonarqube的代码质量阈检查，请及时修改！failure: $&#123;qg.status&#125;\"</span></span><br><span class=\"line\">        <span class=\"comment\">//     &#125; else &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//         echo \"successful\"</span></span><br><span class=\"line\">        <span class=\"comment\">//     &#125;</span></span><br><span class=\"line\">        <span class=\"comment\">// &#125; </span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 方式2</span></span><br><span class=\"line\">        timeout(<span class=\"string\">time:</span> <span class=\"number\">1</span>, <span class=\"string\">unit:</span> <span class=\"string\">'MINUTES'</span>) &#123;</span><br><span class=\"line\">          waitForQualityGate <span class=\"string\">abortPipeline:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码检测'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span>(Exception err) &#123;</span><br><span class=\"line\">           updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码检测'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">            <span class=\"comment\">// 显示错误信息但还是会进行下一阶段操作</span></span><br><span class=\"line\">            unstable <span class=\"string\">'代码检测失败'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// (10) 项目构建打包处理</span></span><br><span class=\"line\">    stage (<span class=\"string\">\"项目构建\"</span>) &#123;</span><br><span class=\"line\">         when &#123;</span><br><span class=\"line\">         expression &#123; <span class=\"keyword\">return</span> params.PREJECT_OPERATION != <span class=\"string\">\"rollback\"</span> &#125;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">           gitlabCommitStatus(<span class=\"string\">connection:</span> gitLabConnection(<span class=\"string\">'Private-Gitlab'</span>),<span class=\"string\">name:</span> <span class=\"string\">\"项目构建\"</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">script:</span> <span class=\"string\">'/usr/local/maven/bin/mvn clean package -Dmaven.test.skip=true'</span></span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           </span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// (11) 进行开发测试部署</span></span><br><span class=\"line\">    stage (<span class=\"string\">\"测试部署\"</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        script &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                sh <span class=\"string\">label:</span> <span class=\"string\">'deploy'</span>, <span class=\"string\">script:</span> <span class=\"string\">'/tmp/script/jenkins-pipeline-gitlab-k8s.sh'</span></span><br><span class=\"line\">                updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'测试部署'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">            &#125;<span class=\"keyword\">catch</span>(Exception err) &#123;</span><br><span class=\"line\">                echo err.toString()    <span class=\"comment\">/* hudson.AbortException: Couldn't find any revision to build. Verify the repository and branch configuration for this job. */</span></span><br><span class=\"line\">                unstable <span class=\"string\">'部署失败'</span></span><br><span class=\"line\">                updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'测试部署'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// 构建停止</span></span><br><span class=\"line\">                error <span class=\"string\">\"[-Error] : 测试部署失败\\n [-Msg] : $&#123;err.getMessage()&#125; \"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    stage(<span class=\"string\">'成品归档'</span>) &#123;</span><br><span class=\"line\">    steps &#123;</span><br><span class=\"line\">       script &#123;</span><br><span class=\"line\">         <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            archiveArtifacts <span class=\"string\">artifacts:</span> <span class=\"string\">\"target/*.war\"</span>,<span class=\"string\">fingerprint:</span> <span class=\"literal\">true</span>, <span class=\"string\">followSymlinks:</span> <span class=\"literal\">false</span>, <span class=\"string\">onlyIfSuccessful:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'成品归档'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">         &#125; <span class=\"keyword\">catch</span> (Exception err) &#123;</span><br><span class=\"line\">            updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'成品归档'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">            echo err.toString()    <span class=\"comment\">/* hudson.AbortException: Couldn't find any revision to build. Verify the repository and branch configuration for this job. */</span></span><br><span class=\"line\">        </span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// (12) POST阶段当所有任务执行后触发进行工作空间的清理以及消息通知;</span></span><br><span class=\"line\">  post &#123;</span><br><span class=\"line\">    always &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'One way or another, I have finished'</span></span><br><span class=\"line\">      qyWechatNotification <span class=\"string\">aboutSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">failNotify:</span> <span class=\"literal\">true</span>, <span class=\"string\">failSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">mentionedMobile:</span> <span class=\"string\">''</span>, <span class=\"string\">startBuild:</span> <span class=\"literal\">true</span>, <span class=\"string\">successSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">unstableSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">webhookUrl:</span> <span class=\"string\">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c222f3fc-f645-440a-ad24-0ce8d9626fa0'</span></span><br><span class=\"line\">      deleteDir()  <span class=\"comment\">/* clean up our workspace */</span></span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    success &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'I succeeeded!'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    unstable &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'I am unstable - 不稳定 :/'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    failure &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'I failed :('</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    changed &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'Things were different before - 以前的情况不一样...'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>/tmp/script/jenkins-pipeline-gitlab-k8s.sh<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># Description: Jenkins CI &amp; Kubernetes &amp; Gitlab -&gt; Deploy or Rollback or Redeploy Java Maven Project</span></span><br><span class=\"line\">DATE=$(date +%Y%m%d-%H%M%S)</span><br><span class=\"line\">WAR_PATH=<span class=\"string\">\"/nfs/data4/war\"</span></span><br><span class=\"line\">WEBROOT_PATH=<span class=\"string\">\"/nfs/data4/webapps\"</span></span><br><span class=\"line\">WEB_DIR=<span class=\"string\">\"<span class=\"variable\">$&#123;JOB_NAME&#125;</span>-<span class=\"variable\">$&#123;DATE&#125;</span>-<span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span>\"</span></span><br><span class=\"line\">WAR_DIR=<span class=\"string\">\" <span class=\"variable\">$&#123;WAR_PATH&#125;</span>/<span class=\"variable\">$&#123;WEB_DIR&#125;</span>\"</span></span><br><span class=\"line\">WAR_NAME=<span class=\"string\">\"<span class=\"variable\">$&#123;WEB_DIR&#125;</span>.war\"</span></span><br><span class=\"line\">K8S_MATER=<span class=\"string\">\"WeiyiGeek@10.10.107.202\"</span></span><br><span class=\"line\">K8S_MATER_PORT=<span class=\"string\">\"20211\"</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span>  --------------- <span class=\"variable\">$&#123;PREJECT_OPERATION&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">deploy</span></span> () &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 1.上传Maven打包的war包到master之中</span></span><br><span class=\"line\">  scp -P <span class=\"variable\">$&#123;K8S_MATER_PORT&#125;</span> <span class=\"variable\">$&#123;WORKSPACE&#125;</span>/target/*.war WeiyiGeek@10.10.107.202:<span class=\"variable\">$&#123;WAR_PATH&#125;</span>/<span class=\"variable\">$&#123;WAR_NAME&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 2.解压&amp;软链接</span></span><br><span class=\"line\">  ssh -p <span class=\"variable\">$&#123;K8S_MATER_PORT&#125;</span> <span class=\"variable\">$&#123;K8S_MATER&#125;</span> <span class=\"string\">\"unzip <span class=\"variable\">$&#123;WAR_PATH&#125;</span>/<span class=\"variable\">$&#123;WAR_NAME&#125;</span> -d <span class=\"variable\">$&#123;WAR_DIR&#125;</span> &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">                                         rm -rf <span class=\"variable\">$&#123;WEBROOT_PATH&#125;</span> &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">                                         ln -s <span class=\"variable\">$&#123;WAR_PATH&#125;</span>/<span class=\"variable\">$&#123;WEB_DIR&#125;</span> <span class=\"variable\">$&#123;WEBROOT_PATH&#125;</span> &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">                                         kubectl delete pod -l app=java-maven\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 回退</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">rollback</span></span> () &#123;</span><br><span class=\"line\">  History_Version=$(ssh -p <span class=\"variable\">$&#123;K8S_MATER_PORT&#125;</span> <span class=\"variable\">$&#123;K8S_MATER&#125;</span> <span class=\"string\">\"find <span class=\"variable\">$&#123;WAR_PATH&#125;</span> -maxdepth 1 -type d -name <span class=\"variable\">$&#123;JOB_NAME&#125;</span>-*-<span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span>\"</span>)</span><br><span class=\"line\">  ssh -p <span class=\"variable\">$&#123;K8S_MATER_PORT&#125;</span> <span class=\"variable\">$&#123;K8S_MATER&#125;</span> <span class=\"string\">\"rm -rf <span class=\"variable\">$&#123;WEBROOT_PATH&#125;</span> &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">                                         ln -s <span class=\"variable\">$&#123;History_Version&#125;</span> <span class=\"variable\">$&#123;WEBROOT_PATH&#125;</span> &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">                                         kubectl delete pod -l app=java-maven\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重部署</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">redeploy</span></span> () &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 如果是以前部署过则删除以前部署的项目目录(包括多个文件夹)否则重新部署;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"v<span class=\"variable\">$&#123;GIT_COMMIT&#125;</span>\"</span> = <span class=\"string\">\"v<span class=\"variable\">$&#123;GIT_PREVIOUS_SUCCESSFUL_COMMIT&#125;</span>\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> -e <span class=\"string\">\"曾经部署过 <span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span> 版本，现在正在重新部署!\"</span></span><br><span class=\"line\">    $(ssh -p <span class=\"variable\">$&#123;K8S_MATER_PORT&#125;</span> <span class=\"variable\">$&#123;K8S_MATER&#125;</span> <span class=\"string\">\"find <span class=\"variable\">$&#123;WAR_PATH&#125;</span> -d -maxdepth 1 -type d -name <span class=\"variable\">$&#123;JOB_NAME&#125;</span>-*-<span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span> &amp;&amp; find <span class=\"variable\">$&#123;WAR_PATH&#125;</span> -d -maxdepth 1 -type f -name <span class=\"variable\">$&#123;JOB_NAME&#125;</span>-*-<span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span>.war\"</span>)</span><br><span class=\"line\">    <span class=\"comment\"># ssh -p $&#123;K8S_MATER_PORT&#125; $&#123;K8S_MATER&#125; \"rm -rf $&#123;History_Version&#125;\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"comment\"># 物理如何都要重新部署</span></span><br><span class=\"line\">  deploy</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署 &amp; 回退 入口(坑-==两边没有空格)</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;PREJECT_OPERATION&#125;</span>\"</span> = <span class=\"string\">\"deploy\"</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"comment\"># 坑 (防止字符串为空)</span></span><br><span class=\"line\"><span class=\"comment\">#  if [[ \"v$&#123;GIT_COMMIT&#125;\" = \"v$&#123;GIT_PREVIOUS_SUCCESSFUL_COMMIT&#125;\" ]];then</span></span><br><span class=\"line\"> <span class=\"comment\">#   echo -e \"您已经部署过 $&#123;RELEASE_VERSION&#125; 版本\"</span></span><br><span class=\"line\"> <span class=\"comment\">#   exit 1</span></span><br><span class=\"line\"> <span class=\"comment\"># else</span></span><br><span class=\"line\">    deploy</span><br><span class=\"line\"> <span class=\"comment\"># fi</span></span><br><span class=\"line\"><span class=\"keyword\">elif</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;PREJECT_OPERATION&#125;</span>\"</span> = <span class=\"string\">\"rollback\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">  rollback</span><br><span class=\"line\"><span class=\"keyword\">elif</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;PREJECT_OPERATION&#125;</span>\"</span> = <span class=\"string\">\"redeploy\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">  redeploy</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"无任何操作！停止执行脚本\"</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 127</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<ul>\n<li>Step 9.功能分析之Git与Gitlab拉取指定分支并切换分支<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#在“源代码管理”部分中：</span></span><br><span class=\"line\">1. 单击Git</span><br><span class=\"line\"></span><br><span class=\"line\">2. 输入您的存储库URL，例如git@your.gitlab.server:gitlab_group/gitlab_project.git</span><br><span class=\"line\"> <span class=\"comment\">#在高级设置，设置名称，以origin和的Refspec到+refs/heads/*:refs/remotes/origin/* +refs/merge-requests/*/head:refs/remotes/origin/merge-requests/*</span></span><br><span class=\"line\"></span><br><span class=\"line\">3. 在“分支说明符”中输入：</span><br><span class=\"line\"><span class=\"comment\"># 对于单存储库工作流： origin/$&#123;gitlabSourceBranch&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># 对于分叉的存储库工作流： merge-requests/$&#123;gitlabMergeRequestIid&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">4.在其他行为中：</span><br><span class=\"line\"><span class=\"comment\"># 点击添加下拉按钮</span></span><br><span class=\"line\"><span class=\"comment\"># 从下拉列表中选择合并，然后再构建</span></span><br><span class=\"line\"><span class=\"comment\"># 将存储库名称设置为origin</span></span><br><span class=\"line\"><span class=\"comment\"># 将“分支”设置为合并为$&#123;gitlabTargetBranch&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 补充:标签时构建</span></span><br><span class=\"line\">(1) 在GitLab Webhook配置中，添加“标签推送事件”</span><br><span class=\"line\">(2) 在“源代码管理”下的作业配置中：</span><br><span class=\"line\">  1.选择“高级...”并添加“ `+refs/tags/*:refs/remotes/origin/tags/*` ”作为参考规格</span><br><span class=\"line\">  2.您还可以使用“分支说明符”来指定需要构建的标签（例如“ refs / tags / $ &#123;TAGNAME&#125;”示例）</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>简单示例:<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 方式1.</span></span><br><span class=\"line\">git <span class=\"string\">branch:</span> <span class=\"string\">\"$&#123;params.RELEASE_VERSION&#125;\"</span>, <span class=\"string\">credentialsId:</span> <span class=\"string\">'b4c8b4e9-2777-44a1-a1ed-e9dc21d37f4f'</span>, <span class=\"string\">url:</span> <span class=\"string\">\"$&#123;env.GITLAB_URL&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\">// git branch: 'v1.11', credentialsId: '43287e62-ce5b-489a-9c11-cedf38e16e92', url: 'git@gitlab.weiyigeek.top:ci-cd/java-maven.git'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//方式2.</span></span><br><span class=\"line\">checkout([<span class=\"string\">$class:</span> <span class=\"string\">'GitSCM'</span>, <span class=\"string\">branches:</span> [[<span class=\"string\">name:</span> <span class=\"string\">\"origin/$&#123;params.RELEASE_VERSION&#125;\"</span>]], <span class=\"string\">doGenerateSubmoduleConfigurations:</span> <span class=\"literal\">false</span>, <span class=\"string\">extensions:</span> [], <span class=\"string\">submoduleCfg:</span> [], <span class=\"string\">userRemoteConfigs:</span> [[<span class=\"string\">credentialsId:</span> <span class=\"string\">'b4c8b4e9-2777-44a1-a1ed-e9dc21d37f4f'</span>, <span class=\"string\">url:</span> <span class=\"string\">'$&#123;env.GITLAB_URL&#125;'</span>]]])</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>Step 9.功能分析之 Jenkins 同步到 Gitlab 流水线之中,并且从Gitlab中可以直接进入Jenkins Job页面查看构建情况;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法参考: 包含在 steps 块之中</span></span><br><span class=\"line\">gitlabCommitStatus(connection: gitLabConnection(<span class=\"string\">'Private-Gitlab'</span>), name: <span class=\"string\">'$&#123;JOB_NAME&#125;'</span>) &#123;</span><br><span class=\"line\">  sh label: <span class=\"string\">'build'</span>, script: <span class=\"string\">'/usr/local/maven/bin/mvn clean package -Dmaven.test.skip=true'</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210202104449.png\" alt=\"WeiyiGeek.jenkins与Gitlab流水线\" title=\"\" class=\"\">\n                <p>WeiyiGeek.jenkins与Gitlab流水线</p>\n            </figure>\n<ul>\n<li>Step 10.功能分析之 Jenkins 中成品进行归档, 注意其路径为相对路径及其您生成的项目打包文件格式文件和Gitlab Relase 发布<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 成品归档当前路径为 $&#123;WORKSPACE&#125; 变量路径；</span></span><br><span class=\"line\">archiveArtifacts artifacts: <span class=\"string\">'target/*.jar'</span>, fingerprint: <span class=\"literal\">true</span>, followSymlinks: <span class=\"literal\">false</span>, onlyIfSuccessful: <span class=\"literal\">true</span> <span class=\"comment\"># 对于war项目则'target/*war'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 获取归档成品的URL(注意为了后续不丢失建议采用专门的服务器进行存储或者在jenkins将此次Job编译进行完整留存)</span></span><br><span class=\"line\">http://jenkins.weiyigeek.top:8080/job/Gitlab-Pipeline/187/artifact/target/hello-world.war</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 项目 -&gt; 发布 (Release) -&gt; 新建发布 -&gt; 编写相关资源 -&gt; 发布资源</span></span><br><span class=\"line\"><span class=\"comment\"># 推荐格式: https://host/namespace/project/releases/:release/downloads/:filepath</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210202112342.png\" alt=\"WeiyiGeek.Jenkins归档与Release发布\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Jenkins归档与Release发布</p>\n            </figure>\n<p>Tips : Gitlab 项目 Release 自动发布 GitLab CI 工具: <code>https://gitlab.com/gitlab-org/release-cli/-/blob/master/docs/index.md#usage</code> 后面有时间再扩充;</p>\n<ul>\n<li>Step 11.同样访问我们的K8s部署的Pod查看是否部署成功URL: <code>http://10.10.107.202:30089/</code>;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Maven - Hello World - v1.13 - Declarative Pipeline <span class=\"built_in\">jobs</span> <span class=\"keyword\">for</span> Gitlab WebHook Trigger</span><br><span class=\"line\"></span><br><span class=\"line\">访问时间: Tue Feb 02 2021 14:15:24 GMT+0800 (中国标准时间)</span><br><span class=\"line\"></span><br><span class=\"line\">Server : Apache Tomcat/8.5.61 | 10.244.0.245</span><br><span class=\"line\"></span><br><span class=\"line\">Client : 10.244.0.1 | 10.244.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">Document_Root : /usr/<span class=\"built_in\">local</span>/tomcat/webapps/ROOT/</span><br><span class=\"line\"></span><br><span class=\"line\">URL : 10.10.107.202/index.jsp</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210202141801.png\" alt=\"WeiyiGeek.Jenkins & gitlab 自动触发\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Jenkins & gitlab 自动触发</p>\n            </figure>\n<hr>\n<h2 id=\"0x03-入坑与出坑\"><a href=\"#0x03-入坑与出坑\" class=\"headerlink\" title=\"0x03 入坑与出坑\"></a>0x03 入坑与出坑</h2><p><strong>问题1.在BlueOcean中流水线使用的输入类型不支持。请使用 <a href=\"\"><code>经典 Jenkins</code></a> 参数化构建。</strong><br>问题原因: 在BlueOcean中不支持选择下拉而只支持文本参数;<br>文本参数: </p>\n<ul>\n<li>git_tags 默认值 描述信息</li>\n<li>deploy_option 默认值（deploy 、rollback、redeploy） 描述信息（部署&amp;回退&amp;重部署）</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210126151854.png\" alt=\"WeiyiGeek.BlueOcean输入\" title=\"\" class=\"\">\n                <p>WeiyiGeek.BlueOcean输入</p>\n            </figure>\n<p><br/></p>\n<p><strong>问题2.添加Webhook测试时显示Hook execution failed: URL ‘<a href=\"http://jenkins.weiyigeek.top:8080/project/Gitlab-Pipeline&#39;\" target=\"_blank\" rel=\"noopener\">http://jenkins.weiyigeek.top:8080/project/Gitlab-Pipeline&#39;</a> is blocked: Requests to the local network are not allowed</strong><br>错误信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Hook execution failed: URL <span class=\"string\">'http://jenkins.weiyigeek.top:8080/project/Gitlab-Pipeline'</span> is blocked: Requests to the <span class=\"built_in\">local</span> network are not allowed</span><br></pre></td></tr></table></figure><br>解决办法: 允许来自钩子和服务的对本地网络的请求。<br>操作流程: 管理中心 -&gt; 设置 -&gt; 网络 -&gt; 勾选 <code>允许Webhook和服务对本地网络的请求</code> -&gt; 然后输入 钩子和服务可以访问的本地IP地址和域名。</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210127163900.png\" alt=\"WeiyiGeek.外发请求设置\" title=\"\" class=\"\">\n                <p>WeiyiGeek.外发请求设置</p>\n            </figure>\n<p><br/></p>\n<p><strong>问题3.Jenkinsfile 编写过程中遇到的情况以及解决办法</strong></p>\n<ul>\n<li><p>1.字符串插值处理</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#设置环境变量</span></span><br><span class=\"line\">environment &#123;</span><br><span class=\"line\">  STATIC_VAR = <span class=\"string\">\"静态变量\"</span></span><br><span class=\"line\">  def dynamic_var = <span class=\"string\">\"\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可选的步骤参数</span></span><br><span class=\"line\">parameters &#123;</span><br><span class=\"line\">  string(name: <span class=\"string\">'RELEASE_VERSION'</span>, defaultValue: <span class=\"string\">\"master\"</span>, description: <span class=\"string\">'Message: 请选择部署的Tags版本?'</span>, trim: <span class=\"string\">'True'</span>)</span><br><span class=\"line\">  choice(name: <span class=\"string\">'PREJECT_OPERATION'</span>, choices: [<span class=\"string\">'deploy'</span>, <span class=\"string\">'rollback'</span>, <span class=\"string\">'redeploy'</span>], description: <span class=\"string\">'Message: 选择项目操作方式?'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#使用环境变量</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;env.STATIC_VAR&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;params.PREJECT_OPERATION&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#动态设置环境变量</span></span><br><span class=\"line\">dynamic_var = <span class=\"string\">\"动态设置环境变量\"</span></span><br><span class=\"line\">println(dynamic_var)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.凭据处理</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// # Secret 文本，带密码的用户名，Secret 文件</span></span><br><span class=\"line\">withCredentials([string(<span class=\"string\">credentialsId:</span> <span class=\"string\">'ce228573-ad3d-40e8-a3bf-b9de510080db'</span>, <span class=\"string\">variable:</span> <span class=\"string\">'GITLAB_TOKEN'</span>)]) &#123;</span><br><span class=\"line\">  echo GITLAB_TOKEN  # println(GITLAB_TOKEN)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// # ssh私钥密钥凭据类型</span></span><br><span class=\"line\"><span class=\"comment\">// # SSH User Private Key / Public</span></span><br><span class=\"line\">$ cat id_ed25519.pub | base64 -w <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\">// c3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSUIinfozVnFFbyt1NmZXNExZeWN1bk9QKzBubnE3cWNJd3lBWXVtNUp1Qi8gbWFzdGVyQHdlaXlpZ2Vlay50b3AK</span></span><br><span class=\"line\">echo <span class=\"string\">\"c3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSUIinfozVnFFbyt1NmZXNExZeWN1bk9QKzBubnE3cWNJd3lBWXVtNUp1Qi8gbWFzdGVyQHdlaXlpZ2Vlay50b3AK\"</span> | base64 -d</span><br><span class=\"line\"><span class=\"comment\">// ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB3a0sVqEo+u6fW4LYycunOP+0nnq7qcIwyAYum5JuB/ master@weiyigeek.top</span></span><br><span class=\"line\"></span><br><span class=\"line\">script &#123;</span><br><span class=\"line\">  withCredentials([</span><br><span class=\"line\">      sshUserPrivateKey(<span class=\"string\">credentialsId:</span> <span class=\"string\">'1d4e61cb-5d59-4da8-813b-a5fb345770c9'</span>, <span class=\"string\">keyFileVariable:</span> <span class=\"string\">'keyFile'</span>, <span class=\"string\">passphraseVariable:</span> <span class=\"string\">'pass'</span>, <span class=\"string\">usernameVariable:</span> <span class=\"string\">'user'</span>),</span><br><span class=\"line\">      string(<span class=\"string\">credentialsId:</span> <span class=\"string\">'79a78423-e539-4b1f-a872-f0cf1dd3f9fa'</span>, <span class=\"string\">variable:</span> <span class=\"string\">'keyPub'</span>)</span><br><span class=\"line\">  ]) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// SSH User Private Key</span></span><br><span class=\"line\">    writeFile <span class=\"string\">file:</span> <span class=\"string\">'private.key'</span>, <span class=\"string\">text:</span> keyFile</span><br><span class=\"line\">    sh <span class=\"string\">\"cp \\$(cat private.key) ~/.ssh/id_ed25519\"</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// SSH User Public</span></span><br><span class=\"line\">    writeFile <span class=\"string\">file:</span> <span class=\"string\">'private.pub'</span>, <span class=\"string\">text:</span> keyPub</span><br><span class=\"line\">    sh <span class=\"string\">\"echo \\$(cat private.pub) | base64 -d &gt; ~/.ssh/id_ed25519.pub\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//其他方式</span></span><br><span class=\"line\">    <span class=\"comment\">//sh \"curl -s http://192.168.12.107:8080/id_ed25519.pub -o ~/.ssh/id_ed25519.pub\"</span></span><br><span class=\"line\">  &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// # Certificate</span></span><br><span class=\"line\">withCredentials([certificate(<span class=\"string\">aliasVariable:</span> <span class=\"string\">'aliase'</span>, <span class=\"string\">credentialsId:</span> <span class=\"string\">'6795a628-97a9-4a18-8dcc-1c913e6901d4'</span>, <span class=\"string\">keystoreVariable:</span> <span class=\"string\">'private'</span>, <span class=\"string\">passwordVariable:</span> <span class=\"string\">'pass'</span>)]) &#123;</span><br><span class=\"line\">  # // some block</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210331134808.png\" alt=\"WeiyiGeek.SSH密钥与公钥处理\" title=\"\" class=\"\">\n                <p>WeiyiGeek.SSH密钥与公钥处理</p>\n            </figure>\n<ul>\n<li>3.额外处理<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 处理故障</span></span><br><span class=\"line\">try &#123;</span><br><span class=\"line\">  sh script: <span class=\"string\">\"./test.sh\"</span></span><br><span class=\"line\">  timeout(time: 1, unit: <span class=\"string\">'MINUTES'</span>) &#123;</span><br><span class=\"line\">    waitForQualityGate abortPipeline: <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  updateGitlabCommitStatus name: <span class=\"string\">'代码检测'</span>, state: <span class=\"string\">'success'</span></span><br><span class=\"line\">&#125; catch(Exception err) &#123;</span><br><span class=\"line\">  updateGitlabCommitStatus name: <span class=\"string\">'代码检测'</span>, state: <span class=\"string\">'failed'</span></span><br><span class=\"line\">  unstable <span class=\"string\">'代码检测失败'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用多个代理</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 高级脚本式流水线</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 并行执行</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"DevOps","path":"api/categories/DevOps.json"},{"name":"CI-CD","path":"api/categories/CI-CD.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"}]}