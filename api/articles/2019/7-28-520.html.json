{"title":"Ansible自动化运维工具实践","slug":"系统运维/自动化运维/Ansible/Ansible自动化运维工具企业实践","date":"2019-07-28T06:34:30.000Z","updated":"2022-05-25T01:39:20.551Z","url":"2019/7-28-520.html","path":"api/articles/2019/7-28-520.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x01-在-kubernetes-集群机器中的运维应用\"><a href=\"#0x01-在-kubernetes-集群机器中的运维应用\" class=\"headerlink\" title=\"0x01 在 kubernetes 集群机器中的运维应用\"></a>0x01 在 kubernetes 集群机器中的运维应用</h2><p><em>Q:什么是ansible？</em><br>答：它是一个Linux系统上的”自动化运维工具”，类似一个”配置管理工具”; </p>\n<p>Step 1.只在其中一台 Master 节点安装 Ansbile 批量运维工具(<code>正常情况下应该有独立的主机来进行管理</code>)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1)安装&amp;配置:</span></span><br><span class=\"line\">sudo apt update &amp;&amp; sudo apt install ansible</span><br><span class=\"line\">ansible --version</span><br><span class=\"line\"><span class=\"comment\"># ansible 2.9.6</span></span><br><span class=\"line\"><span class=\"comment\">#   config file = /etc/ansible/ansible.cfg</span></span><br><span class=\"line\"><span class=\"comment\">#   configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']</span></span><br><span class=\"line\"><span class=\"comment\">#   ansible python module location = /usr/lib/python3/dist-packages/ansible</span></span><br><span class=\"line\"><span class=\"comment\">#   executable location = /usr/bin/ansible</span></span><br><span class=\"line\"><span class=\"comment\">#   python version = 3.8.5 (default, Jul 28 2020, 12:59:40) [GCC 9.3.0]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># /etc/ansible/hosts</span></span><br><span class=\"line\"><span class=\"comment\"># /etc/ansible/ansible.cfg</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 2.选择该Master节点作为ssh 密钥登陆其它主机的入口(注意:<code>在正式环境中建议单独建立一台ssh公密钥认证主机，并且一定要保护好该密钥</code>)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.避免首次登录sshd服务时候需要输入yes，此时我们可以将主节点其中一台主机的ssh_config配置中的StrictHostKeyChecking修改为no</span></span><br><span class=\"line\">sed -i <span class=\"string\">'s/^#   StrictHostKeyChecking ask/StrictHostKeyChecking no/g'</span> /etc/ssh/ssh_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.Master 节点公密钥生成(此处为了简单未设置密钥密码)</span></span><br><span class=\"line\">ssh-keygen -t ed25519 -C <span class=\"string\">\"weiyigeek-IT\"</span></span><br><span class=\"line\"><span class=\"comment\"># Generating public/private ed25519 key pair.</span></span><br><span class=\"line\">ls /root/.ssh/</span><br><span class=\"line\">authorized_keys  id_ed25519  id_ed25519.pub</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.用上面生成的公钥和密钥进行配置公钥登录(建议修改默认的22端口)</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ip <span class=\"keyword\">in</span> &#123;223..226&#125;;<span class=\"keyword\">do</span> </span><br><span class=\"line\">ssh-copy-id -p 20211 -i ~/.ssh/id_ed25519.pub weiyigeek@weiyigeek-<span class=\"variable\">$&#123;ip&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"comment\"># **************WARNING**************</span></span><br><span class=\"line\"><span class=\"comment\"># Authorized only. All activity will be monitored and reported.</span></span><br><span class=\"line\"><span class=\"comment\"># id_ed25519                                    100%  464   307.9KB/s   00:00    </span></span><br><span class=\"line\"><span class=\"comment\"># id_ed25519.pub                                100%  102   150.8KB/s   00:00</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 3.主机资源清单配置<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tee -a /etc/ansible/hosts &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># Dev &amp; Test Kubernetes</span></span><br><span class=\"line\">[dtmaster]</span><br><span class=\"line\">weiyigeek-107 ansible_host=127.0.0.1</span><br><span class=\"line\">weiyigeek-108 ansible_host=192.168.1.108</span><br><span class=\"line\">weiyigeek-109 ansible_host=192.168.1.109</span><br><span class=\"line\"></span><br><span class=\"line\">[dtnode]</span><br><span class=\"line\">weiyigeek-223 ansible_host=192.168.1.223</span><br><span class=\"line\">weiyigeek-224 ansible_host=192.168.1.224</span><br><span class=\"line\">weiyigeek-225 ansible_host=192.168.1.225</span><br><span class=\"line\">weiyigeek-226 ansible_host=192.168.1.226</span><br><span class=\"line\"></span><br><span class=\"line\">[dtk8s:children]</span><br><span class=\"line\">dtmaster</span><br><span class=\"line\">dtnode</span><br><span class=\"line\"></span><br><span class=\"line\">[dtk8s:vars]</span><br><span class=\"line\">ansible_port=20211</span><br><span class=\"line\">ansible_user=weiyigeek</span><br><span class=\"line\"><span class=\"comment\"># 在使用 sudo 命令时不需要输入密码</span></span><br><span class=\"line\">ansible_become=<span class=\"literal\">true</span></span><br><span class=\"line\">ansible_become_method=sudo</span><br><span class=\"line\">ansible_become_pass=<span class=\"string\">'weiyigeek123456.'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[all:vars]</span><br><span class=\"line\">ansible_python_interpreter=/usr/bin/python3</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 4.结果验证：收到”pong”主机回复后，这意味着您已准备好在该服务器上运行Ansible命令和剧本。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible all -m ping</span><br><span class=\"line\"><span class=\"comment\"># weiyigeek-224 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"changed\": false,</span></span><br><span class=\"line\"><span class=\"comment\">#     \"ping\": \"pong\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># weiyigeek-109 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"changed\": false,</span></span><br><span class=\"line\"><span class=\"comment\">#     \"ping\": \"pong\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># weiyigeek-107 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"changed\": false,</span></span><br><span class=\"line\"><span class=\"comment\">#     \"ping\": \"pong\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># weiyigeek-108 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"changed\": false,</span></span><br><span class=\"line\"><span class=\"comment\">#     \"ping\": \"pong\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># weiyigeek-223 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"changed\": false,</span></span><br><span class=\"line\"><span class=\"comment\">#     \"ping\": \"pong\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># weiyigeek-225 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"changed\": false,</span></span><br><span class=\"line\"><span class=\"comment\">#     \"ping\": \"pong\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># weiyigeek-226 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"changed\": false,</span></span><br><span class=\"line\"><span class=\"comment\">#     \"ping\": \"pong\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 5.命令执行测试<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 命令执行</span></span><br><span class=\"line\">&gt; ansible all -a <span class=\"string\">\"whoami\"</span>                <span class=\"comment\"># 缺省 -m shell</span></span><br><span class=\"line\">&gt; ansible all -m shell -a <span class=\"string\">\"whoami\"</span>         <span class=\"comment\"># 支持 管道符</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-224 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># root</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-223 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># root</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-107 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># root</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-109 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># root</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-108 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># root</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-225 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># root</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-226 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 软件更新查看 （在配置文件中配置了ansible_become则支持该sudo命令）</span></span><br><span class=\"line\">&gt; ansible -a <span class=\"string\">\"sudo apt list --upgradable\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 6.K8s工作节点环境验证 ( environment verify )<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.节点之中不可以有重复的主机名、MAC 地址或 product_uuid </span></span><br><span class=\"line\"><span class=\"comment\"># IP 地址</span></span><br><span class=\"line\">&gt; ansible dtk8s -a <span class=\"string\">\"ifconfig -a\"</span> | egrep <span class=\"string\">\"inet 192.168\"</span> -C 1</span><br><span class=\"line\">  <span class=\"comment\"># ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet 192.168.1.107  netmask 255.255.255.0  broadcast 192.168.1.255</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet6 fe80::250:56ff:fe8a:e8db  prefixlen 64  scopeid 0x20&lt;link&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># --</span></span><br><span class=\"line\">  <span class=\"comment\"># ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet 192.168.1.108  netmask 255.255.255.0  broadcast 192.168.1.255</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet6 fe80::250:56ff:fe8a:ca7d  prefixlen 64  scopeid 0x20&lt;link&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># --</span></span><br><span class=\"line\">  <span class=\"comment\"># ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet 192.168.1.109  netmask 255.255.255.0  broadcast 192.168.1.255</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet6 fe80::250:56ff:fe8a:c363  prefixlen 64  scopeid 0x20&lt;link&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># --</span></span><br><span class=\"line\">  <span class=\"comment\"># eno1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet 192.168.1.223  netmask 255.255.255.0  broadcast 192.168.1.255</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet6 fe80::7a2b:cbff:fe2e:9d16  prefixlen 64  scopeid 0x20&lt;link&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># --</span></span><br><span class=\"line\">  <span class=\"comment\"># eno1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet 192.168.1.224  netmask 255.255.255.0  broadcast 192.168.1.255</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet6 fe80::d6ae:52ff:fed2:b8ef  prefixlen 64  scopeid 0x20&lt;link&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># --</span></span><br><span class=\"line\">  <span class=\"comment\"># eno1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet 192.168.1.225  netmask 255.255.255.0  broadcast 192.168.1.255</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet6 fe80::862b:2bff:fe5c:8781  prefixlen 64  scopeid 0x20&lt;link&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># --</span></span><br><span class=\"line\">  <span class=\"comment\"># eno1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet 192.168.1.226  netmask 255.255.255.0  broadcast 192.168.1.255</span></span><br><span class=\"line\">  <span class=\"comment\">#         inet6 fe80::d6ae:52ff:fe82:8aa  prefixlen 64  scopeid 0x20&lt;link&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.主机名称及其UUID</span></span><br><span class=\"line\">&gt; ansible dtk8s -a <span class=\"string\">\"sudo cat /sys/class/dmi/id/product_uuid\"</span></span><br><span class=\"line\">  <span class=\"comment\"># [WARNING]: Consider using 'become', 'become_method', and 'become_user' rather than running sudo</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-224 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># 4c4c4544-0034-3710-8036-c2c04f473032</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-109 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># 33ce0a42-267a-701a-86ab-fede021587c3</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-108 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># f4240a42-e010-e17a-b8c7-ed047755351c</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-107 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># a9200a42-9a5c-3c64-3ad6-d7debcb0d793</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-223 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># 4c4c4544-0052-4810-8042-c8c04f353358</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-225 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># 4c4c4544-004e-4c10-8052-c7c04f5a3258</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek-226 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># 4c4c4544-004c-3110-8050-b5c04f443358</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.内核版本验证</span></span><br><span class=\"line\"><span class=\"comment\"># PS: 3.10.x 内核存在一些 Bugs导致运行的 Docker、Kubernetes 不稳定建议采用4.18 &gt;= 以上的内核版本</span></span><br><span class=\"line\">~$ ansible dtk8s -m shell -a <span class=\"string\">\"uname -r\"</span></span><br><span class=\"line\">weiyigeek-224 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">5.4.0-42-generic</span><br><span class=\"line\">weiyigeek-107 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">5.4.0-60-generic</span><br><span class=\"line\">weiyigeek-108 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">5.4.0-60-generic</span><br><span class=\"line\">weiyigeek-109 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">5.4.0-60-generic</span><br><span class=\"line\">weiyigeek-223 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">5.4.0-42-generic</span><br><span class=\"line\">weiyigeek-226 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">5.4.0-42-generic</span><br><span class=\"line\">weiyigeek-225 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">5.4.0-42-generic</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 7.Ansible 主机中文件拷贝到组里主机的指定目录包括初始化机器的init.sh脚本以及hosts文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 初始化以及依赖包下载</span></span><br><span class=\"line\">ansible dtnode -m copy -a <span class=\"string\">'src=~/init.sh dest=~/'</span></span><br><span class=\"line\">ansible dtnode -m shell -a <span class=\"string\">\"chmod a+x ./init.sh &amp;&amp; sudo ./init.sh\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机 hosts 绑定</span></span><br><span class=\"line\">ansible k8s -m copy -a <span class=\"string\">'src=~/hosts dest=/etc/hosts'</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 8.拷贝导出的k8s集群的镜像到master、worker工作节点并导入到本地仓库中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible dtnode -m copy -a <span class=\"string\">'src=~/v1.19.6.tar dest=/home/weiyigeek/'</span></span><br><span class=\"line\">~$ ansible dtnode -m shell -a <span class=\"string\">\"docker load -i /home/weiyigeek/v1.19.6.tar\"</span></span><br><span class=\"line\">weiyigeek-226 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">....</span><br><span class=\"line\">weiyigeek-225 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">....</span><br><span class=\"line\">weiyigeek-224 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">.....</span><br><span class=\"line\">weiyigeek-223 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">Loaded image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.19.6</span><br><span class=\"line\">Loaded image: calico/node:v3.17.1</span><br><span class=\"line\">Loaded image: registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.13-0</span><br><span class=\"line\">Loaded image: calico/cni:v3.17.1</span><br><span class=\"line\">Loaded image: calico/kube-controllers:v3.17.1</span><br><span class=\"line\">Loaded image: registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.7.0</span><br><span class=\"line\">Loaded image: registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2</span><br><span class=\"line\">Loaded image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.19.6</span><br><span class=\"line\">Loaded image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.19.6</span><br><span class=\"line\">Loaded image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.19.6</span><br><span class=\"line\">Loaded image: calico/pod2daemon-flexvol:v3.17.1</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 9.将master与负载机器加入到k8s集群之中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master-salve</span></span><br><span class=\"line\">ansible dtmaster -m shell -a <span class=\"string\">\"sudo kubeadm join weiyigeek-lb-vip.k8s:16443 --token 20w21w.httpweiyigeektop --discovery-token-ca-cert-hash sha256:7ea900ef214c98aef6d7daf1380320d0a43f666f2d4b6b7469077bd51790118e  --control-plane --certificate-key 8327482265975b7a60f3549222f1093353ecaa148a3404cd10c605d4111566fc\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># worker</span></span><br><span class=\"line\">ansible dtnode -m shell -a <span class=\"string\">\"sudo kubeadm join weiyigeek-lb-vip.k8s:16443 --token 20w21w.httpweiyigeektop --discovery-token-ca-cert-hash sha256:7ea900ef214c98aef6d7daf1380320d0a43f666f2d4b6b7469077bd51790118e\"</span></span><br><span class=\"line\">weiyigeek-226 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">.... 同下</span><br><span class=\"line\">weiyigeek-223 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">.... 同下</span><br><span class=\"line\">weiyigeek-224 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">.... 同下</span><br><span class=\"line\">weiyigeek-225 | CHANGED | rc=0 &gt;&gt;</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the cluster...</span><br><span class=\"line\">[preflight] FYI: You can look at this config file with <span class=\"string\">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">\"/var/lib/kubelet/config.yaml\"</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">\"/var/lib/kubelet/kubeadm-flags.env\"</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This node has joined the cluster:    # 表示成功加入到集群</span></span><br><span class=\"line\">Run <span class=\"string\">'kubectl get nodes'</span> on the control-plane to see this node join the cluster.</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 10.查看集群node节点信息<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ kubectl get nodes -o wide</span><br><span class=\"line\">NAME       STATUS   ROLES    AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">weiyigeek-107   Ready    master   8h    v1.19.6   192.168.1.107   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class=\"line\">weiyigeek-108   Ready    master   8h    v1.19.6   192.168.1.108   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class=\"line\">weiyigeek-109   Ready    master   8h    v1.19.6   192.168.1.109   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class=\"line\">weiyigeek-223   Ready    &lt;none&gt;   29s   v1.19.6   192.168.1.223   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-42-generic   docker://19.3.14</span><br><span class=\"line\">weiyigeek-224   Ready    &lt;none&gt;   29s   v1.19.6   192.168.1.224   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-42-generic   docker://19.3.14</span><br><span class=\"line\">weiyigeek-225   Ready    &lt;none&gt;   29s   v1.19.6   192.168.1.225   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-42-generic   docker://19.3.14</span><br><span class=\"line\">weiyigeek-226   Ready    &lt;none&gt;   30s   v1.19.6   192.168.1.226   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-42-generic   docker://19.3.14</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"自动化运维","path":"api/categories/自动化运维.json"},{"name":"运维基础","path":"api/categories/运维基础.json"}],"tags":[{"name":"Ansible","path":"api/tags/Ansible.json"}]}