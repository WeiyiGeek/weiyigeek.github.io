{"title":"DNS域名解析服务基础概念与Bind9安装","slug":"系统运维/Application/DNS/DNS域名服务基础概念与Bind9安装","date":"2019-01-22T08:37:27.000Z","updated":"2022-05-21T02:48:49.010Z","url":"2019/1-22-511.html","path":"api/articles/2019/1-22-511.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201130091418.png","https://images2018.cnblogs.com/blog/907596/201805/907596-20180509132341629-2020080614.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201130091951.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201130092128.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210321001638.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126195739.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126200907.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126201511.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126203315.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126204449.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126205654.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127172628.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127210705.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127211543.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127213023.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127213447.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127215232.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127215827.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127220607.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127222517.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127222947.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127223306.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127223951.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><h3 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h3><p><strong>Q: 什么是DNS(Domain Name System)?</strong></p>\n<blockquote>\n<p>A: DNS即域名名称系统(<code>也称域名解析服务器</code>), 它使用层次结构的命名系统<code>将域名和IP地址相互映射</code>形成一个分布式数据库系统, 能够使人更方便的访问互联网<br>DNS 是互联网的基础设施类的服务、这是一种协议、协议最后是要实现的、协议实现的软件很多( 例如 Bind、CoreDNS)</p>\n</blockquote>\n<p>Tips: DNS 命名用于 Internet 等 TCP/IP 网络中，通过用户友好的名称查找计算机和服务。当用户在应用程序中输入 DNS 名称时，该服务可以将此名称解析为与之相关的其他信息，如 IP 地址。</p>\n<p>Tips: DNS 采用C/S架构服务器端主要工作在UDP协议端口53，当然也可以在TCP协议端口53之上。<br>Tips: 应用程序通常将 DNS 解析委派给操作系统的 DNS Resolver 来执行，程序员对它几乎无感知。</p>\n<p><br/></p>\n<p><strong>Q：什么是域名(Domain Name)？</strong></p>\n<blockquote>\n<p>A：是一串用点分割的字符，是互联网某台或者某组计算机的名称，使用者更好方便访问网页，而不需去记住一长串的IP地址字符，例如 <code>http://www.weiyigeek.top/ --&gt; IP地址</code>；</p>\n</blockquote>\n<p>使用域名好处总结:</p>\n<ul>\n<li>1.方便人类记忆</li>\n<li>2.更换机器IP地址后不需要改变硬编码在应用的域名，只需要更改解析即可。</li>\n<li>2.便于实现负载均衡，例如一个域名可以对应多个IP。</li>\n<li>3.便于实现虚拟主机名进行访问同一个地址的多个应用，例如Nginx的代理。</li>\n</ul>\n<p>Tips: 域名的购买与使用流程(此处忽略了我大天朝的特殊国情-<code>备案</code>)：</p>\n<ul>\n<li>1.你在某域名提供商处购买了一个域名 weiyigeek.top</li>\n<li>2.域名提供商向 .top 对应的顶级域名服务器中插入一条以上的 NS 记录，指向它自己的次级 DNS 服务器，如 dns25.hichina.com.</li>\n<li>3.阿里云会向 TLD 中插入几条 NS 记录，指向阿里云的次级 DNS 服务器（如 alidns.com - 223.6.6.6）。</li>\n<li>4.你在该域名提供商的 DNS 管理界面中添加 A 记录，值为你的服务器 IP。</li>\n<li>5.OK 现在 ping 一下 weiyigeek.top，就会发现它已经解析到你自己的服务器了。</li>\n</ul>\n<p>Tips: 了解各种域名状态的含义，有助于明白域名安全情况、不能正常使用的原因等，以便及时采取相应措施。</p>\n<ul>\n<li><p>1.新注册的域名可能出现以下状态：</p>\n<ul>\n<li>.addPeriod : 注册局设置域名新注册期（域名新注册 5 天内会出现的状态，不影响域名使用，5 天后自动解除 - 添加句点）。</li>\n<li>·ok : 普通状态（可正常使用。没有需要立即进行的操作，也没有设置任何保护措施。有其他状态时，OK 状态不显示，但并不代表不正常。</li>\n</ul>\n</li>\n<li><p>2.出于对域名注册信息的保护，域名在进行某些安全锁定后，会出现以下状态：</p>\n<ul>\n<li>·clientDeleteProhibited     注册商设置禁止删除（保护域名的一种状态，域名不能被删除）。</li>\n<li>.serverDeleteProhibited     注册局设置禁止删除（保护域名的一种状态，域名不能被删除）。</li>\n<li>·clientUpdateProhibited     注册商设置禁止更新（域名信息，包括注册人/管理联系人/技术联系人/付费联系人/DNS 等不能被修改，但可设置或修改解析记录）。</li>\n<li>·serverUpdateProhibited     注册局设置禁止更新（域名信息，包括注册人/管理联系人/技术联系人/付费联系人/DNS 等不能被修改，但可设置或修改解析记录）。</li>\n<li>·clientTransferProhibited     注册商设置禁止转移（保护域名的一种状态，域名不能转移注册商）。</li>\n<li>·serverTransferProhibited     注册局设置禁止转移（保护域名的一种状态，域名不能转移注册商。有的域名新注册及转移注册商 60 天内会被注册局设置成该状态，60 天后自动解除；有的则为域名涉及仲裁或诉讼案被注册局设置，仲裁或诉讼案结束会被解除）。</li>\n</ul>\n</li>\n<li><p>3.其他禁止解析、禁止续费的状态：</p>\n<ul>\n<li>·pendingVerification     注册信息审核期（该域名注册后未进行实名审核，需尽早在域名付费后 5 天内提交资料审核，5 天后仍未实名审核的，将进入 ServerHold 状态）。</li>\n<li>·clientHold     注册商设置暂停解析（处于该状态域名解析暂停，需联系注册商解除该状态）。</li>\n<li>·serverHold     注册局设置暂停解析（处于该状态域名解析暂停，.cn 国内中英文域名注册成功后未通过实名审核时多出现该种状态，需在域名有效期内完成实名审核后解除）。</li>\n<li>·inactive     非激活状态（注册时未填写域名 DNS，不能进行解析，需在注册商处设置域名 DNS）。</li>\n<li>·clientRenewProhibited     注册商或注册局设置禁止续费（域名不能续费，处于该状态通常表示该域名处于仲裁或法院争议期，需联系注册商确认原因）。</li>\n<li>.serverRenewProhibited</li>\n<li>·pendingTransfer     注册局设置转移过程中（域名正在转移注册商过程中）。</li>\n<li>·redemptionPeriod     注册局设置赎回期（域名处于赎回期，可联系注册商高价赎回）。</li>\n<li>·pendingDelete     注册局设置待删除/赎回期（对于国际域名，该状态表示域名已过赎回期等待被删除，删除后开放重新注册；对于国内域名，该状态表示域名处于赎回期，可联系注册商高价赎回）。</li>\n</ul>\n</li>\n</ul>\n<p>Tips: 当前每一级域名长度的限制是63个字符，域名总长度则不能超过253个字符。</p>\n<p><br/></p>\n<p><strong>Q: 什么是FQDN?</strong></p>\n<blockquote>\n<p>A: FQDN( <code>Fully Qualified Domain Name</code>) 完全限定域名，它是使用DNS的树状层级结构的完全路径域名来表示一个准确位置对应的主机。</p>\n</blockquote>\n<p>例如域名大致分类:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">组织域：.com、.org、.mil、.gov、.edu、.net、</span><br><span class=\"line\">国家域：.cn、.hk、.tw、.us、.jp、.ir、.uk</span><br><span class=\"line\">反向域：.<span class=\"keyword\">in</span>-addr.arpa</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201130091418.png\" alt=\"WeiyiGeek.域名树状结构图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.域名树状结构图</p>\n            </figure>\n<p>Tips : DNS提供<code>正向解析(FQDN--&gt;IP)</code>和<code>反向解析(IP--&gt;FQDN)</code>的功能。</p>\n<p><br/></p>\n<p><strong>Q: 什么是名称解析?</strong></p>\n<blockquote>\n<p>A: 所谓名称解析的过程就是某个应用程序<code>基于某个搜索引擎在指定的数据库中查询、而后查询到某些对应的键以后与之对应的键导出来的过程</code>。<br>简单的说: 它可以将一个域名(URL)解析到对应的IP地址上，从而能访问该IP地址下机器提供的相关应用, 所以几乎每个Internet连接都以DNS查找开始。<br>例如，多数用户喜欢使用友好的名称(如 debian.linuxsir.org)来查找计算机，如网络上的邮件服务器或 Web 服务器。友好名称更容易了解和记住。但是计算机使用数字地址在网络上进行通讯。为更容易地使用网络资源，DNS 等命名系统提供了一种方法，将计算机或服务的用户友好名称映射为数字地址。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 域名对应IP查看</span></span><br><span class=\"line\">C:\\Users\\WeiyiGeek&gt;ping www.weiyigeek.top</span><br><span class=\"line\">正在 Ping www.weiyigeek.top [104.31.80.144] 具有 32 字节的数据:</span><br><span class=\"line\">来自 104.31.80.144 的回复: 字节=32 时间=229ms TTL=50</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"基础术语\"><a href=\"#基础术语\" class=\"headerlink\" title=\"基础术语\"></a>基础术语</h3><ul>\n<li><p>主DNS服务器(master)：就是一台存储着原始资料的DNS服务器。</p>\n</li>\n<li><p>从DNS服务器(slave)：使用自动更新方式从主DNS服务器同步数据的DNS服务器也叫(辅助DNS服务器)。</p>\n</li>\n<li><p>缓存服务器(cache)：不负责本地解析，采用递归方式转发客户机查询请求，并返回结果给客户机的DNS服务器。同时缓存查询回来的结果，也叫递归服务器。</p>\n</li>\n<li><p>转发器(forward)：这台DNS发现非本机负责的查询请求时，不再向根域发起请求，而是直接转发给指定的一台或者多台服务器。自身并不缓存查询结果。</p>\n</li>\n<li><p>hint : 根DNS internet服务器集。</p>\n</li>\n<li><p>递归查询: 以上客户机和本地DNS服务器直接的查询方式</p>\n</li>\n<li><p>迭代查询: 本地DNS服务器多次请求重复查询的方式</p>\n</li>\n<li><p>WHOIS: 即域名数据库查询, 一个域名的所有者可以通过查询WHOIS数据库而被找到；对于大多数根域名服务器基本的WHOIS由ICANN维护，而WHOIS的细节则由控制那个域的域注册机构维护。对于240多个国家代码顶级域名(ccTLDs)，通常由该域名权威注册机构负责维护WHOIS, 例如:</p>\n<ul>\n<li>中国互联网络信息中心(China Internet Network Information Center)负责 .CN 域名的WHOIS维护</li>\n<li>香港互联网注册管理有限公司(Hong Kong Internet Registration Corporation Limited) 负责 .HK 域名的WHOIS维护</li>\n<li>台湾网络信息中心 (Taiwan Network Information Center) 负责 .TW 域名的WHOIS维护。</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>域名分层结构(四层):<ul>\n<li>1.根域（Root Zone）:所有域名的根。根域名服务器负责解析顶级域名，给出顶级域名的 DNS 服务器地址。它的域名是 “” 空字符串。而它的全限定域名（FQDN）是 . ，因为 FQDN 总是以 . 结尾。<br>Tips : 全球有13组DNS根服务器、11台在美国、一组在挪威、一组在日本、DNS服务重兵把守、他的安全性有多重要、一旦被攻击全球都互联网中断、可想而知。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 查看全球13个根节点的服务</span></span><br><span class=\"line\">$ dig -t NS .</span><br><span class=\"line\"><span class=\"comment\"># ;; OPT PSEUDOSECTION:</span></span><br><span class=\"line\"><span class=\"comment\"># ; EDNS: version: 0, flags:; udp: 65494</span></span><br><span class=\"line\"><span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\"><span class=\"comment\"># ;.                              IN      NS</span></span><br><span class=\"line\"><span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      d.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      h.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      c.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      k.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      g.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      l.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      m.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      j.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      f.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      e.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      a.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      b.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       2483    IN      NS      i.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># ;; Query time: 4 msec</span></span><br></pre></td></tr></table></figure></li>\n<li>2.顶级域（<code>Top Level Domains, TLD</code>）：.com .cn 等国际、国家级的域名, 顶级域名服务器<code>负责解析次级域名</code>，给出次级域名的 DNS 服务器地址, 每个顶级域名都对应各自的服务器，它们之间是完全独立的。例如 .cn 的域名解析仅由 .cn 顶级域名服务器提供。</li>\n<li>3.次级域（Second Level Domains）: 个人/企业能够买到的域名，比如 baidu.com, 每个次级域名都有一到多个权威 DNS 服务器，这些 DNS 服务器会以 NS 记录的形式保存在对应的顶级域名（TLD）服务器中。权威域名服务器则负责给出最终的解析结果：<code>ip 地址(A 记录 )，另一个域名（CNAME 记录）、另一个 DNS 服务器（NS 记录）</code>等。</li>\n<li>4.子域（Sub Domians）: *.baidu.com 统统都是 baidu.com 的子域。每一个子域都可以有自己独立的权威 DNS 服务器，这通过在子域中添加 NS 记录实现。</li>\n</ul>\n</li>\n</ul>\n<p>Tips: 目前国际 DNS 系统中已有上千个 TLD，包括中文「.我爱你」甚至藏文域名，详细列表参见 IANA TLD 数据库(<a href=\"http://www.iana.org/domains/root/db\" target=\"_blank\" rel=\"noopener\">http://www.iana.org/domains/root/db</a>) , 除了国际可用的 TLD 还有一类<code>类似「内网 IP 地址」的“私有 TLD”</code>，最常见的比如 <code>xxx.local xxx.lan</code>，被广泛用在集群通信中。</p>\n<ul>\n<li><p>公共 DNS 服务器：缓存了大量的 DNS 记录，有效地降低了上游 DNS 服务器的压力，也加快了网络上的 DNS 查询速度。例如Google 的 8.8.8.8，腾讯 的 114.114.114.114, 阿里 的 233.6.6.6。</p>\n</li>\n<li><p>DNS 泛解析通配符 <em> : DNS 记录允许使用通配符 </em>，并且该通配符可匹配任意级数的子域！！！比如 *.example.com 就可以匹配所有的一二三四级域名等等，但是无法匹配 example.com 本身！</p>\n</li>\n<li><p>TTL (<code>Time To Live</code>): 上面讲了公共 DNS 服务器通过缓存技术，降低了上游 DNS 服务器的压力，也加快了网络上的 DNS 查询速度。可缓存总得有个过期时间吧！为了精确地控制 DNS 记录的过期时间，每条 DNS 记录都要求自定义设置一个时间属性——TTL，单位为秒。任何一条 DNS 缓存，在超过过期时间后都必须丢弃！另外在没超时的时候，DNS 缓存也可以被主动或者被动地刷新。</p>\n</li>\n<li><p>本地 DNS 服务器：它只在当前局域网内有效，企业常用一般通过 DHCP 或者手动配置的方式，使内网的服务器都默认使用局域网 DNS 服务器进行解析，该服务器可以只解析自己的私有 DNS 域，而将其他 DNS 域的解析 forward 到公网 DNS 解析器去。</p>\n</li>\n<li>私有 DNS 域：它会覆盖掉公网的同名域(如果公网上有这个域的话)，它也可以使用公网不存在的 TLD，比如 xxx.local xxx.lan 等，例如 vmware vcenter 就默认使用 <code>vsphere.local</code> 作为它的 sso (单点登录)系统的域名。kubernetes 默认使用 <code>svc.cluster.local</code>作为集群内部域名。</li>\n</ul>\n<p><br></p>\n<h3 id=\"记录类型\"><a href=\"#记录类型\" class=\"headerlink\" title=\"记录类型\"></a>记录类型</h3><p><strong>Q: 什么是RR(Resource Record)资源记录?</strong></p>\n<blockquote>\n<p>答: DNS层级结构中不管是节点还是叶子节点都是资源，对这些资源中的某一个的标识使用一定格式的多字段的一条记录来表示，该条记录就是资源记录RR。<code>RR的标准记录在RFC 1034中</code>。</p>\n</blockquote>\n<p>(1) RR(Resource Record)的组成说明:</p>\n<ul>\n<li>owner name : 所属名称</li>\n<li>TTL ： 缓存RR的秒数(Time-to-live)到达此数后强制刷新</li>\n<li>CLASS : 表示一个协议或者一族协议(常用IN表示Internet)</li>\n<li>TYPE : RR 类型</li>\n<li>RDATA : 记录数据</li>\n</ul>\n<p>(2) RR中<code>IN类(CLASS)</code>常见解析记录类型(type):</p>\n<ul>\n<li>SOA ：区域授权起始记录，区域文件第一条记录，而且一个区域文件只能有一条;</li>\n<li>NS ：名称服务器解析记录,就是一个Bind Server,这个Server不能提供这个域名的解析服务，直接返回NS记录，用户用这条记录请求权威的解析Bind Server,返回解析地址</li>\n<li>MX ：邮件服务器解析记录, 配合A记录进行</li>\n<li>A ：由域名解析出对应的IPv4地址就叫A记录，属于最基本的记录</li>\n<li>AAAA : IPV6(A记录)可以理解成新一代的 A 记录。以后会用的越来越多的。</li>\n<li>PTR ：逆向解析记录(解析IP为域名)基本上只在设置邮件服务器时才会用到，例如<code>18.12.168.192.in-addr.arpa name = www.weiyigeek.top.</code></li>\n<li>CNAME ：别名记录(Canonical name) 记录域名与另一个域名的对应关系由别的域名提供A记录的解析，主要用于给域名起别名</li>\n<li>TXT : 文本记录主要用于验证域名所属权以及证书申请校验时使用。</li>\n<li>SRV : SRV 记录用于提供服务发现，看名字也能知道它和 SERVICE 有关。主要用于企业域控(AD)、微服务发现（Kubernetes）等</li>\n</ul>\n<p><br></p>\n<p><strong>例如 SOA 记录格式解析</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$TTL</span> 生存周期(单位s)</span><br><span class=\"line\">@ 记录TLL IN SOA MNAME RNAME (</span><br><span class=\"line\">  SERIAL;</span><br><span class=\"line\">  REFRESH;</span><br><span class=\"line\">  RETRY;</span><br><span class=\"line\">  EXPIRE;</span><br><span class=\"line\">  MINIMUM;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># SOA的RDATA格式说明</span></span><br><span class=\"line\">  * MNAME : 授权主机DQDN或者当前区域的名称</span><br><span class=\"line\">  * RNAME : 邮箱地址采用@用.替代</span><br><span class=\"line\">  * SERIAL : 区域传送使用的版本号格式是yyyymmddnn</span><br><span class=\"line\">  * REFRESH : 从服务器去同步主服务器时间建个</span><br><span class=\"line\">  * RETRY : 刷新失败重试时间间隔</span><br><span class=\"line\">  * EXPIRE : 从服务器过期时长</span><br><span class=\"line\">  * TTL : 消极的缓存TTL即否宕答案过期时常</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># SOA 记录 @ 取代在/etc/named.conf中指定的域名其中中的数字分别为：序列号、刷新、重试、过期、生存期</span></span><br><span class=\"line\">  * 序列号：序列号用于DNS数据库文件的版本控制,每当数据被改变,这个序列号就应该被增加</span><br><span class=\"line\">  * 刷新：从服务器向主服务器查询最新数据的间隔周期。每一次检查时从服务器的数据是否需要更改,则根据序列号来判别</span><br><span class=\"line\">  * 重试：一旦从服务器尝试连接主服务器失败,下一次查询主服务器的延迟时间</span><br><span class=\"line\">  * 过期：如果从服务器无法连通主服务器,则在经过此时间后,宣告其数据过期</span><br><span class=\"line\">  * 生存期：服务器回答 <span class=\"string\">'无此域名'</span> 的间隔时间</span><br><span class=\"line\">  * 数字的默认单位为秒,否则：D= 日、H= 小时、W= 周、M= 分钟</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例1: 百度的SOA解析</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$TTL</span> 7200    ;<span class=\"comment\"># 生存周期(单位s)</span></span><br><span class=\"line\">@ 579  IN  SOA  dns.baidu.com. sa.baidu.com.  (    </span><br><span class=\"line\">  2021041915   ; serial number    </span><br><span class=\"line\">  3600          ; refresh 3600s    </span><br><span class=\"line\">  1200          ; retry 1200s    </span><br><span class=\"line\">  86400         ; expire 1d    </span><br><span class=\"line\">  360           ; min TTL 6m</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">primary name server = vip3.alidns.com</span><br><span class=\"line\">responsible mail addr = hostmaster.hichina.com</span><br><span class=\"line\">serial  = 2021041915</span><br><span class=\"line\">refresh = 3600 (1 hour)</span><br><span class=\"line\">retry   = 1200 (20 mins)</span><br><span class=\"line\">expire  = 86400 (1 day)</span><br><span class=\"line\">default TTL = 360 (6 mins)</span><br></pre></td></tr></table></figure></p>\n<p><strong>常用指令说明：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) $TTL 可以在SOA之前使用该指令，给出TTL秒数的32位整数值。</span></span><br><span class=\"line\"><span class=\"comment\"># (2) $ORIGIN 设定域名它必须出现在任何一行省略书写的RR记录前。当一个区域文件第一次被读取时隐含这个命令的值为 &lt;zone_name&gt;.(必须是跟着一个半角句号)，如果不设置它就必须在区域文件中书写FQDN。</span></span><br><span class=\"line\">* 例如: <span class=\"variable\">$ORIGIN</span> kernel.org.</span><br><span class=\"line\">* www CNAME web-server  &lt;等同于&gt; www.kernel.org. CNAME web-server.kernel.org.</span><br><span class=\"line\"><span class=\"comment\"># (3) @符号等价于$ORIGIN。</span></span><br></pre></td></tr></table></figure></p>\n<p>示例2: NS/MX/CNAME/A/PTR各个RDATA格式<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.7 NS的RDATA格式</span></span><br><span class=\"line\"><span class=\"comment\"># NSDName：DNS的FQDN</span></span><br><span class=\"line\">baidu.com. 64899 IN NS ns2.baidu.com.</span><br><span class=\"line\">baidu.com. 64899 IN NS ns4.baidu.com.</span><br><span class=\"line\">baidu.com. 64899 IN NS dns.baidu.com.</span><br><span class=\"line\">baidu.com. 64899 IN NS ns7.baidu.com.</span><br><span class=\"line\">baidu.com. 64899 IN NS ns3.baidu.com.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.8 MX的RDATA格式</span></span><br><span class=\"line\"><span class=\"comment\"># PREFERENCE：优先级，越小越高</span></span><br><span class=\"line\"><span class=\"comment\"># EXCHANGE：邮件服务器FQDN</span></span><br><span class=\"line\">baidu.com. 7200 IN MX 20 jpmx.baidu.com.</span><br><span class=\"line\">baidu.com. 7200 IN MX 20 mx50.baidu.com.</span><br><span class=\"line\">baidu.com. 7200 IN MX 10 mx.n.shifen.com.</span><br><span class=\"line\">baidu.com. 7200 IN MX 20 mx1.baidu.com.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.9 CNAME的RDATA格式</span></span><br><span class=\"line\"><span class=\"comment\"># CNAME：权威名称，FQDN</span></span><br><span class=\"line\">www.baidu.com. 1154 IN CNAME www.a.shifen.com.</span><br><span class=\"line\">www.a.shifen.com 是正式名称，而 www.baidu.com 是别名</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.0 A的RDATA格式</span></span><br><span class=\"line\"><span class=\"comment\"># ADDRESS：IPV4地址</span></span><br><span class=\"line\">www.baidu.com. 1154 IN CNAME www.a.shifen.com.</span><br><span class=\"line\">www.a.shifen.com. 36 IN A 111.13.100.92</span><br><span class=\"line\">www.a.shifen.com. 36 IN A 111.13.100.91</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.1 PTR的RDATA格式（注意地址是反着来的此处为域名对应的地址192.168.100.7）</span></span><br><span class=\"line\">7.100.in-addr.arpa. IN PTR www.example.com.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.2 SRV的固定格式: 优先级 权重 端口 目标地址</span></span><br><span class=\"line\">0 5 5060 sipserver.example.com</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x01-DNS服务介绍\"><a href=\"#0x01-DNS服务介绍\" class=\"headerlink\" title=\"0x01 DNS服务介绍\"></a>0x01 DNS服务介绍</h2><h3 id=\"原理流程\"><a href=\"#原理流程\" class=\"headerlink\" title=\"原理流程\"></a>原理流程</h3><p>描述: DNS服务器采用分布式数据结构保存着海量的名称，那么用户如何快速的在互联网上访问哪台服务器或者哪些服务器就能找到待解析的数据呢？</p>\n<p><strong>DNS常规解析请求流程:</strong></p>\n<p>描述: 客户机发起对<code>www.kernel.org</code>的解析请求流程如下:</p>\n<ul>\n<li>1) 客户机首先查看查找本地hosts文件，如果有则返回，否则进行下一步</li>\n<li>2) 客户机查看本地缓存，是否存在本条目的缓存，如果有则直接返回，不再向外发出请求，否则进行下一步，转发。</li>\n<li>3) 将请求转发本地DNS服务器。</li>\n<li>4) 查看域名是否本地解析，是则本地解析返回，否则进行下一步。</li>\n<li>5) 本地DNS服务器首先在缓存中查找，有则返回，无则进行下一步。</li>\n<li>6) 向全球某一个根域服务器发起DNS请求，根域返回org域的地址列表。</li>\n<li>7) 使用某一个org域的IP地址，发起DNS请求，org域返回kernel域服务器地址列表。</li>\n<li>8) 使用某一个kernel域IP地址，发起DNS请求，kernel域返回<a href=\"http://www.kernel.org主机的IP地址，本地DNS服务收到后，返回给客户机。\" target=\"_blank\" rel=\"noopener\">www.kernel.org主机的IP地址，本地DNS服务收到后，返回给客户机。</a></li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://images2018.cnblogs.com/blog/907596/201805/907596-20180509132341629-2020080614.png\" alt=\"WeiyiGeek.DNS访问\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS访问</p>\n            </figure>\n<p><strong>DNS域名解析查询方式分类</strong></p>\n<ul>\n<li><p>1.递归查询: 以上客户机和本地DNS服务器直接查询的方式(<code>直接返回查询到的地址给客户机</code>)，称为递归查询。</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201130091951.png\" alt=\"WeiyiGeek.递归方式查询\" title=\"\" class=\"\">\n                <p>WeiyiGeek.递归方式查询</p>\n            </figure>\n</li>\n<li><p>2.迭代查询: 本地DNS服务器多次请求重复查询的方式，称为迭代查询。</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201130092128.png\" alt=\"WeiyiGeek.迭代方式查询\" title=\"\" class=\"\">\n                <p>WeiyiGeek.迭代方式查询</p>\n            </figure>\n</li>\n</ul>\n<p><br/></p>\n<p>Tips: 总之 DNS 查询进程分两部分进行：</p>\n<ul>\n<li><p>1.名称查询从客户端计算机开始，并传输至解析程序即 DNS 客户端服务程序进行解析。</p>\n</li>\n<li><p>2.不能在本地解析查询时，可根据需要查询 DNS 服务器来解析名称。</p>\n</li>\n</ul>\n<p><br/></p>\n<h3 id=\"实验目标\"><a href=\"#实验目标\" class=\"headerlink\" title=\"实验目标\"></a>实验目标</h3><p>描述: 企业内部Linux系统下智能DNS服务搭建系列分为四部：</p>\n<ul>\n<li>1) Bind9服务篇: Bind服务基础安装与DNS解析记录及其简单使用；</li>\n<li>2) Bind9负载均衡篇 : DNS的递归迭代查询和子域授权, DNS转发的实现过程和配置以及DNS主从域传输</li>\n<li>3) Bind9智能DNS篇 : 介绍了DNS的区域传输数据加密及相关配置；</li>\n<li>4) Bind9企业内部DNS搭建实践篇</li>\n</ul>\n<hr>\n<h2 id=\"0x02-DNS服务之Bind9\"><a href=\"#0x02-DNS服务之Bind9\" class=\"headerlink\" title=\"0x02 DNS服务之Bind9\"></a>0x02 DNS服务之Bind9</h2><h3 id=\"Bind9-基础介绍\"><a href=\"#Bind9-基础介绍\" class=\"headerlink\" title=\"Bind9 基础介绍\"></a>Bind9 基础介绍</h3><p>Bind9 项目官网: <a href=\"https://www.isc.org/bind/\" target=\"_blank\" rel=\"noopener\">https://www.isc.org/bind/</a></p>\n<p><strong>Q: 什么是Bind9?</strong></p>\n<blockquote>\n<p>答: 1984年，加州大学伯克利分校的几个学生完成了Unix名称服务的实现，起名叫做<code>Berkeley Internet Name Domain(BIND)</code>，目前，它是互联网上使用最为广泛的DNS服务软件。<br>BIND9 是开源的、多功能、经典的、完整的名称服务器软件； BIND9 已发展成为一个非常灵活，功能齐全的DNS系统。其根据MPL 2.0许可获得许可, 用户可以自由地向BIND 9添加功能;</p>\n</blockquote>\n<p><br></p>\n<p><strong>Q: 为什么要使用BIND 9?</strong></p>\n<blockquote>\n<p>答:无论您的应用程序是什么，BIND 9可能都具有必需的功能。作为第一个最古老最常用的解决方案，与其他任何系统相比，已经有更多熟悉BIND 9的网络工程师。<br>从发布(由DNSSEC签名)的DNS根区域和许多顶级域到发布具有许多小区域的非常大的区域文件的主机提供商，以及具有内部(私有)和外部区域的企业的所有应用程序，BIND均可成功用于所有应用程序中到具有大型解析器场的服务提供商。</p>\n</blockquote>\n<p><br></p>\n<p><strong>Q: Bind9 软件包包括以下三个部分?</strong></p>\n<blockquote>\n<p>1.DNS服务器: 它是一个叫做named的程序代表<code>name daemon</code>的简写, 它根据DNS协议标准的规定响应收到的查询, 默认Bind的配置文件为<code>/etc/named.conf</code>，在每一次named启动与挂起时都会被读取。。 　　<br>2.DNS解析库(resolver library) : 一个解析器等于一个程序,通过发送请求到合适的服务器并且对服务器的响应做出合适的回应, 来解析对一个域名的查询。一个解析库是程序组件的集合可以在开发其它程序时使用,为这些程序提供域名解析的功能。<br>3.软件测试工具 : 例如 dig、host 等DNS测试软件;</p>\n</blockquote>\n<p><strong>Q: Bind9 版本说明?</strong></p>\n<blockquote>\n<p>BIND 的当前代码库为 BIND9 ，当前Current-Stable为9.16.9；<br>BIND 稳定版，开发版，扩展支持(ESV)和订阅(支持的预览版标记为-S)。</p>\n</blockquote>\n<p>Tips: bind服务需要开放的端口和说明（<code>安装配置时注意防火墙放行</code>）:</p>\n<ul>\n<li>UDP 53 port 用于常规解析;</li>\n<li>TCP 53 port 用于bind同步数据等作用;</li>\n<li>TCP 953 port 用于IPv6解析;</li>\n</ul>\n<p><br/></p>\n<h3 id=\"Bind9-安装方式\"><a href=\"#Bind9-安装方式\" class=\"headerlink\" title=\"Bind9 安装方式\"></a>Bind9 安装方式</h3><p>描述: 安装Bind服务软件的几种方式说明<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 包管理工具</span></span><br><span class=\"line\">- Redhat 家族</span><br><span class=\"line\">  yum install -y <span class=\"built_in\">bind</span> <span class=\"built_in\">bind</span>-chroot</span><br><span class=\"line\">  rpm -qa | grep <span class=\"built_in\">bind</span>   <span class=\"comment\"># 查看被安装的Rpm包</span></span><br><span class=\"line\">  rpm -ql <span class=\"built_in\">bind</span> | more   <span class=\"comment\"># 本地的文件路径</span></span><br><span class=\"line\"></span><br><span class=\"line\">-  Ubuntu 家族</span><br><span class=\"line\">  apt-get install bind9 bind9utils bind9-doc -y</span><br><span class=\"line\">  dpkg --list | grep <span class=\"string\">\"bind9\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ii  bind9-dnsutils                       1:9.16.1-0ubuntu2.4               amd64        Clients provided with BIND 9</span></span><br><span class=\"line\">  <span class=\"comment\"># ii  bind9-host                           1:9.16.1-0ubuntu2.4               amd64        DNS Lookup Utility</span></span><br><span class=\"line\">  <span class=\"comment\"># ii  bind9-libs:amd64                     1:9.16.1-0ubuntu2.4               amd64        Shared Libraries used by BIND 9</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 采用光盘安装</span></span><br><span class=\"line\">vim  /etc/yum.repos.d/base.repo              </span><br><span class=\"line\">[RHEL6]      </span><br><span class=\"line\">name= base</span><br><span class=\"line\">baseurl=file:///mnt/cdrom        </span><br><span class=\"line\">enabled=1                  </span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 编译安装</span></span><br><span class=\"line\">https://downloads.isc.org/isc/bind9/9.16.9/<span class=\"built_in\">bind</span>-9.16.9.tar.xz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 容器安装</span></span><br><span class=\"line\">官方镜像: https://hub.docker.com/r/internetsystemsconsortium/bind9</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tips : 但是在生产环境中您很可能会有其他限制，包括：</p>\n<ul>\n<li>已经安装并正在运行BIND版本-在准备好之前，您不希望覆盖它。</li>\n<li>在升级后出现意外情况时，通常希望保留选择切换回以前版本的选项。</li>\n<li>您可能需要在另一台计算机上构建BIND，因为您的生产环境未安装编译器。</li>\n<li>您可能正在集中构建BIND，以将其分发到许多分散的生产机器。</li>\n</ul>\n<p>Tips : 编译安装 bind9 有一个麻烦之处(<code>一般情况下及其不推荐</code>), 所有的配置文件都得自己去建立比如/var/named/这个目录、编译安装时连这个目录都不会存在、得自己去创建这个目录、里面的各种配置文件、区域文件、像根的、甚至连<br>service启动脚本都没、所以不到万不得以最好别去编译它，所以建议采用操作系统中软件管理包进行自动安装;</p>\n<p><br/></p>\n<h4 id=\"Ubuntu-安装\"><a href=\"#Ubuntu-安装\" class=\"headerlink\" title=\"Ubuntu 安装\"></a>Ubuntu 安装</h4><p><strong>安装环境:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Description: Ubuntu 20.04.1 LTS</span><br><span class=\"line\">Linux ubuntu 5.4.0-26-generic 30-Ubuntu SMP Mon Apr 20 16:58:30 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><br>安装帮助: <a href=\"https://kb.isc.org/docs/aa-00768\" target=\"_blank\" rel=\"noopener\">https://kb.isc.org/docs/aa-00768</a></p>\n<p><br/></p>\n<h5 id=\"1-源码编译安装\"><a href=\"#1-源码编译安装\" class=\"headerlink\" title=\"1) 源码编译安装\"></a>1) 源码编译安装</h5><ul>\n<li><p>Step 1.默认绑定构建和安装</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1)默认情况下，BIND将安装在/usr/local中，并将文件放置在它的子目录中:</span></span><br><span class=\"line\"><span class=\"comment\"># sbin -已命名以及与BIND相关的所有系统管理工具，例如rndc，dnssec-keygen，named-checkconf等。</span></span><br><span class=\"line\"><span class=\"comment\"># bin - 非管理员用户的工具-您将在此处找到dig，host和nsupdate</span></span><br><span class=\"line\"><span class=\"comment\"># lib - 目标代码库</span></span><br><span class=\"line\"><span class=\"comment\"># Share -(以及各种子目录)BIND的手册页</span></span><br><span class=\"line\"><span class=\"comment\"># Include - C头文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2)在不更改默认目录的情况下编译的BIND将期望使用以下目录(相对于/)</span></span><br><span class=\"line\">/etc - 配置文件(例如`named.conf，rndc.conf`)</span><br><span class=\"line\">/var/run - 由named创建和使用的运行时文件</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 2.bind源码下载和编译</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 下载与解压： http://www.isc.org/downloads/bind/</span></span><br><span class=\"line\">wget https://downloads.isc.org/isc/bind9/9.16.9/<span class=\"built_in\">bind</span>-9.16.9.tar.xz</span><br><span class=\"line\">sudo tar -xvf <span class=\"built_in\">bind</span>-9.16.9.tar.xz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\">sudo mkdir /etc/<span class=\"built_in\">bind</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2)源码编译两个附加选项(--enable-threads和--with-openssl)以启用多线程并启用OpenSSL。(如果要使用DNSSEC，则需要OpenSSL)</span></span><br><span class=\"line\">apt install -y gcc make pkg-config python3-pip libuv1 libuv1-dev libssl-dev libcap-dev libxml2-dev</span><br><span class=\"line\">mkdir -vp /usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span> &amp;&amp; <span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>-9.16.9</span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span> --sysconfdir=/etc/<span class=\"built_in\">bind</span> --localstatedir=/var --with-openssl --with-libxml2 <span class=\"comment\"># --enable-threads 实际版本中它是默认即configure没有该选项</span></span><br><span class=\"line\"><span class=\"comment\"># Configured paths:</span></span><br><span class=\"line\"><span class=\"comment\">#     prefix: /usr/local/bind</span></span><br><span class=\"line\"><span class=\"comment\">#     sysconfdir: /etc/bind</span></span><br><span class=\"line\"><span class=\"comment\">#     localstatedir: /var</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) make 执行构建</span></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>-9.16.9<span class=\"comment\"># make &amp;&amp; make install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 版本验证</span></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span><span class=\"comment\"># ls &amp; ls bin/</span></span><br><span class=\"line\"><span class=\"comment\"># bin  include  lib  sbin  share</span></span><br><span class=\"line\"><span class=\"comment\"># arpaname  delv  dig  host  mdig  named-rrchecker  nslookup  nsupdate</span></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span><span class=\"comment\"># named -v</span></span><br><span class=\"line\">  <span class=\"comment\"># BIND 9.16.9 (Stable Release) &lt;id:b3f41b7&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5 )dns 解析软件相关软连接</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> /usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>/sbin/*; <span class=\"keyword\">do</span> ln -f -s <span class=\"variable\">$i</span> /usr/<span class=\"built_in\">local</span>/sbin; <span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> /usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>/bin/*; <span class=\"keyword\">do</span> ln -f -s <span class=\"variable\">$i</span> /usr/<span class=\"built_in\">local</span>/bin; <span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.运行Bind用户以及组创建</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 选项 -r 系统不会创建家目录</span></span><br><span class=\"line\">sudo groupadd -g 53 -r named &amp;&amp; sudo useradd -g named -r named</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.Bind软件相关的目录以及文件的配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 创建named的工作目录、然后创建named.ca这个文件</span></span><br><span class=\"line\">mkdir -vp /var/named/private/</span><br><span class=\"line\">dig -t NS . @223.6.6.6 &gt; /var/named/named.ca    <span class=\"comment\"># 13台根服务器</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 编译安装默认配置文件与--sysconfdir参数有关, 为了便于管理我们统一设置在/etc/bind/目录下</span></span><br><span class=\"line\">sudo mkdir -vp /etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 我们以weiyigeek.top和一个网段为例编写配置文件</span></span><br><span class=\"line\">vim /etc/<span class=\"built_in\">bind</span>/named.conf</span><br><span class=\"line\">cat &gt; /etc/<span class=\"built_in\">bind</span>/named.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># - 全局配置</span></span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 监听地址设置,默认是any表示允许所有网段的主机(可以改成自己所在的内网网段)</span></span><br><span class=\"line\">  listen-on port 53 &#123; any; &#125;;        </span><br><span class=\"line\">  listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class=\"line\">  <span class=\"comment\"># 定义named的固定工作路径</span></span><br><span class=\"line\">  directory <span class=\"string\">\"/var/named\"</span>; </span><br><span class=\"line\">  dump-file       <span class=\"string\">\"/var/named/data/cache_dump.db\"</span>;</span><br><span class=\"line\">  statistics-file <span class=\"string\">\"/var/named/data/named_stats.txt\"</span>;</span><br><span class=\"line\">  memstatistics-file <span class=\"string\">\"/var/named/data/named_mem_stats.txt\"</span>;</span><br><span class=\"line\">  <span class=\"comment\"># 开启递归</span></span><br><span class=\"line\">  recursion yes;  </span><br><span class=\"line\">  <span class=\"comment\"># 下面这两行配置很重要，该配置后当客户端采用我们自己配置的内网DNS的NS服务器后，当访问别的网站内网NS解析不了的就转发给8.8.8.8的DS服务器解析，保证能正常上网。</span></span><br><span class=\"line\">  forward first;                  </span><br><span class=\"line\">  forwarders &#123;223.5.5.5;223.6.6.6;&#125;;</span><br><span class=\"line\">  <span class=\"comment\"># 表示接收所有网段请求</span></span><br><span class=\"line\">  allow-query &#123; any; &#125;;   </span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># - 日志记录</span></span><br><span class=\"line\">logging &#123;                           </span><br><span class=\"line\">  channel default_debug &#123;</span><br><span class=\"line\">    file <span class=\"string\">\"data/named.run\"</span>;</span><br><span class=\"line\">    severity dynamic;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 根域设置</span></span><br><span class=\"line\">zone <span class=\"string\">\".\"</span>  &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> hint;      </span><br><span class=\"line\">  file <span class=\"string\">\"named.ca\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 正向解析的区域: 定义一个统一的域名后缀(IN 可被忽略)</span></span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.top\"</span>  &#123;     </span><br><span class=\"line\">  <span class=\"comment\"># 类型属于master、属于自己的                  </span></span><br><span class=\"line\">  <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">  <span class=\"comment\"># 指定正向解析的文件  </span></span><br><span class=\"line\">  file <span class=\"string\">\"private/weiyigeek.top.zone\"</span>;</span><br><span class=\"line\">  <span class=\"comment\"># 允许192.168.12.1/24网段(从DNS服务器)传送 </span></span><br><span class=\"line\">  allow-transfer &#123;192.168.12/24;&#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 反向解析的区域</span></span><br><span class=\"line\">zone <span class=\"string\">\"12.168.192.in-addr.arpa\"</span> &#123; </span><br><span class=\"line\">  <span class=\"built_in\">type</span> master; </span><br><span class=\"line\">  file <span class=\"string\">\"private/192.168.12.zone\"</span>; </span><br><span class=\"line\">  allow-transfer &#123;192.168.12/24;&#125;;  <span class=\"comment\"># 指定正向解析的文件</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">- PS : 如果上述是多个网段的反向解析这里就需要定义多个反向解析区域。</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 4.将您的二进制文件作为递归服务器进行测试以及运行后台守护程序</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) 创建默认的rndc.key文件(它将由named和rndc用来代替named.conf或rndc.conf中的任何特定控件配置)</span></span><br><span class=\"line\">sudo rndc-confgen -a  </span><br><span class=\"line\"><span class=\"comment\"># wrote key file \"/etc/bind/rndc.key\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2) 启动命名的守护程序</span></span><br><span class=\"line\">sudo named -u named -c /etc/named/named.conf  <span class=\"comment\"># PS 如果以非root用户运行请指定-u选项</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3) 检查named是否按预期运行；检查日志文件，如果没有，请纠正任何问题：</span></span><br><span class=\"line\">sudo ps -ef|grep named</span><br><span class=\"line\"><span class=\"comment\"># /named      113839       1  0 21:35 ?        00:00:00 named</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4) 查看状态</span></span><br><span class=\"line\">sudo rndc status</span><br><span class=\"line\">  <span class=\"comment\"># version: BIND 9.16.9 (Stable Release) &lt;id:b3f41b7&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># running on ubuntu: Linux x86_64 5.4.0-26-generic #30-Ubuntu SMP Mon Apr 20 16:58:30 UTC 2020</span></span><br><span class=\"line\">  <span class=\"comment\"># boot time: Sat, 28 Nov 2020 13:35:13 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># last configured: Sat, 28 Nov 2020 13:35:14 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># configuration file: /etc/named.conf</span></span><br><span class=\"line\">  <span class=\"comment\"># CPUs found: 4</span></span><br><span class=\"line\">  <span class=\"comment\"># worker threads: 4</span></span><br><span class=\"line\">  <span class=\"comment\"># UDP listeners per interface: 4</span></span><br><span class=\"line\">  <span class=\"comment\"># number of zones: 100 (99 automatic)</span></span><br><span class=\"line\">  <span class=\"comment\"># debug level: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># xfers running: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># xfers deferred: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># soa queries in progress: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># query logging is OFF</span></span><br><span class=\"line\">  <span class=\"comment\"># recursive clients: 0/900/1000</span></span><br><span class=\"line\">  <span class=\"comment\"># tcp clients: 0/150</span></span><br><span class=\"line\">  <span class=\"comment\"># TCP high-water: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># server is up and running</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 5.权威解析配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch /var/named/private/&#123;192.168.12.zone, weiyigeek.top.zone&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; /var/named/private/weiyigeek.top.zone &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 1D </span><br><span class=\"line\">@ IN SOA ns.weiyigeek.top. root.weiyigeek.top. (              </span><br><span class=\"line\">                        20200711           </span><br><span class=\"line\">                        7200                         </span><br><span class=\"line\">                        6000                          </span><br><span class=\"line\">                        604800                          </span><br><span class=\"line\">                        86400)    </span><br><span class=\"line\">@ IN NS lns.weiyigeek.top.</span><br><span class=\"line\">@ IN NS ens.weiyigeek.top.</span><br><span class=\"line\">lns IN A 192.168.12.253</span><br><span class=\"line\">ens IN A 223.6.6.6</span><br><span class=\"line\">self IN A 192.168.12.215</span><br><span class=\"line\">blog IN A 192.168.12.216</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"comment\"># 1 // 定义宏，通用变量，单位为秒(S)、小时(H)，天数(D)</span></span><br><span class=\"line\"><span class=\"comment\"># 2 //  此处一般是写NS域名，邮件域名，或root.weiyigeek.top.</span></span><br><span class=\"line\"><span class=\"comment\"># 2 // 序列号 当主DNS修改解析文件时，必须要修改这个序列号，然后重启named服务后，从DNS才能正常同步过去！(这个参数很重要，要特别注意！！)</span></span><br><span class=\"line\"><span class=\"comment\"># 2 // 刷新时间</span></span><br><span class=\"line\"><span class=\"comment\"># 2 // 失败重试时间</span></span><br><span class=\"line\"><span class=\"comment\"># 2 // 过期时间</span></span><br><span class=\"line\"><span class=\"comment\"># 2 // 否定答案时间</span></span><br><span class=\"line\">cat &gt; /var/named/private/192.168.12.zone  &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 1D</span><br><span class=\"line\">@ IN SOA ns.weiyigeek.top. root.weiyigeek.top. (              </span><br><span class=\"line\">                        20200712           </span><br><span class=\"line\">                        2H                         </span><br><span class=\"line\">                        6000                          </span><br><span class=\"line\">                        604800                          </span><br><span class=\"line\">                        86400)</span><br><span class=\"line\">@ IN NS lns.weiyigeek.top.</span><br><span class=\"line\">253 IN PTR lns.weiyigeek.top.</span><br><span class=\"line\">215 IN PTR self.weiyigeek.top.</span><br><span class=\"line\">216 IN PTR blog.weiyigeek.top.</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>PS : 对于主DNS的正反向解析文件中的序列号，每当做一次修改后，必须要同时修改这个序列号，这样才能触发主从同步机制！然后重启named服务，从DNS服务器那边才能同步过去，否则不能完成主从同步！</p>\n<ul>\n<li><p>Step 6.修改DNS相关配置文件的属主属组和权限</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chown -R named.named /usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>/ /etc/<span class=\"built_in\">bind</span>/ /var/named/ /var/run/named/</span><br><span class=\"line\">chown named.named /etc/<span class=\"built_in\">bind</span>/rndc.key</span><br><span class=\"line\">chmod -R 755 /var/named/</span><br><span class=\"line\">chmod 640 /etc/<span class=\"built_in\">bind</span>/named.conf /etc/<span class=\"built_in\">bind</span>/rndc.key</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 7.检查主配置文件和区域数据文件有没有语法错误</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 主配置文件验证</span></span><br><span class=\"line\">root@ubuntu-253:~$ /usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>/sbin/named-checkconf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 区域数据文件验证</span></span><br><span class=\"line\">root@ubuntu-253:/var/named/private<span class=\"comment\"># /usr/local/bind/sbin/named-checkzone weiyigeek.top weiyigeek.top.zone</span></span><br><span class=\"line\">  <span class=\"comment\"># zone weiyigeek.top/IN: loaded serial 20200711</span></span><br><span class=\"line\">  <span class=\"comment\"># OK</span></span><br><span class=\"line\">root@ubuntu-253:/var/named/private<span class=\"comment\"># /usr/local/bind/sbin/named-checkzone 12.168.192.in-addr.arpa 192.168.12.zone</span></span><br><span class=\"line\">  <span class=\"comment\"># zone 12.168.192.in-addr.arpa/IN: loaded serial 20200711</span></span><br><span class=\"line\">  <span class=\"comment\"># OK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 使用默认选项测试您的二进制文件 named 启动错误信息查看(Debug)</span></span><br><span class=\"line\">named -u named -g</span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.008 found 4 CPUs, using 4 worker threads</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.008 using 4 UDP listeners per interface</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.012 using up to 21000 sockets</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.012 loading configuration from '/etc/named.conf'</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.012 reading built-in trust anchors from file '/etc/bind.keys'</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.012 using default UDP/IPv4 port range: [32768, 60999]</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.012 using default UDP/IPv6 port range: [32768, 60999]</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.016 listening on IPv4 interface lo, 127.0.0.1#53</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.016 listening on IPv4 interface ens160, 192.168.1.254#53</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.016 listening on IPv4 interface docker0, 172.17.0.1#53</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.016 IPv6 socket API is incomplete; explicitly binding to each IPv6 address separately</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.016 listening on IPv6 interface ens160, fe80::250:56ff:fe8a:cf24%2#53</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.020 generating session key for dynamic DNS</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.020 sizing zone task pool based on 0 zones</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.020 none:98: 'max-cache-size 90%' - setting to 7165MB (out of 7961MB)</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.040 obtaining root key for view _default from '/etc/bind.keys'</span></span><br><span class=\"line\">  <span class=\"comment\"># 28-Nov-2020 21:30:44.040 set up managed keys zone for view _default, file 'managed-keys.bind'</span></span><br><span class=\"line\">  .....</span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.576 none:98: 'max-cache-size 90%' - setting to 7165MB (out of 7961MB)</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.592 configuring command channel from '/etc/bind/rndc.key'</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.592 command channel listening on 127.0.0.1#953</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.592 configuring command channel from '/etc/bind/rndc.key'</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.592 couldn't add command channel ::1#953: address not available</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.592 not using config file logging statement for logging due to -g option</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.604 managed-keys-zone: loaded serial 9</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.612 zone 12.168.192.in-addr.arpa/IN: loaded serial 20200711</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.612 zone weiyigeek.top/IN: loaded serial 20200711</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.612 all zones loaded</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.612 running</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.612 zone weiyigeek.top/IN: sending notifies (serial 20200711)</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.612 zone 12.168.192.in-addr.arpa/IN: sending notifies (serial 20200711)</span></span><br><span class=\"line\">  <span class=\"comment\"># 30-Nov-2020 21:48:53.668 managed-keys-zone: No DNSKEY RRSIGs found for '.': success</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>Step 8.最后检查守护程序是否正在响应：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 打开一个新的Shell终端进行验证</span></span><br><span class=\"line\">dig @127.0.0.1 . NS</span><br><span class=\"line\"><span class=\"comment\"># 您的名称服务器发送查询，要求它查询具有权威性的NS记录(根名称服务器)列表</span></span><br><span class=\"line\"><span class=\"comment\"># ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 27</span></span><br><span class=\"line\"><span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      g.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      h.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      l.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      j.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      k.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      b.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      m.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      f.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      d.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      c.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      e.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      i.root-servers.net.</span></span><br><span class=\"line\"><span class=\"comment\"># .                       518252  IN      NS      a.root-servers.net.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 解析验证</span></span><br><span class=\"line\">$ sudo vim /etc/resolv.conf <span class=\"comment\"># 首先设置本机DNS服务器指向</span></span><br><span class=\"line\">  <span class=\"comment\"># nameserver 192.168.12.253</span></span><br><span class=\"line\">  <span class=\"comment\"># options edns0 trust-ad</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ dig -t A www.weiyigeek.top @192.168.12.253</span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 # 由于没添加解析则回答为0</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; OPT PSEUDOSECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ; EDNS: version: 0, flags:; udp: 1232</span></span><br><span class=\"line\">  <span class=\"comment\"># ; COOKIE: caef08a6d576a202010000005fc4fc7251641b78e122c9b0 (good)</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;www.weiyigeek.top.             IN      A</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; AUTHORITY SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.top.          86400   IN      SOA     ns.weiyigeek.top. root.weiyigeek.top. 20200711 7200 6000 604800 86400</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; Query time: 0 msec</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; SERVER: 192.168.12.253#53(192.168.12.253)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 正向解析</span></span><br><span class=\"line\">$ dig -t A blog.weiyigeek.top @192.168.12.253</span><br><span class=\"line\">  <span class=\"comment\"># ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 4139</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 # 存在对应的解析目录</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;blog.weiyigeek.top.            IN      A</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># blog.weiyigeek.top.     86400   IN      A       192.168.12.216</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 反向解析</span></span><br><span class=\"line\">root@ubuntu-253:~$ nslookup</span><br><span class=\"line\">  <span class=\"comment\"># &gt; 192.168.12.253</span></span><br><span class=\"line\">  <span class=\"comment\"># 253.12.168.192.in-addr.arpa     name = lns.weiyigeek.top.</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt; 192.168.12.215</span></span><br><span class=\"line\">  <span class=\"comment\"># 215.12.168.192.in-addr.arpa     name = self.weiyigeek.top.</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h5 id=\"2-APT仓库安装\"><a href=\"#2-APT仓库安装\" class=\"headerlink\" title=\"2) APT仓库安装\"></a>2) APT仓库安装</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 卸载多余软件例如 snap 服务</span></span><br><span class=\"line\">sudo systemctl stop snapd snapd.socket <span class=\"comment\">#停止snapd相关的进程服务</span></span><br><span class=\"line\">sudo apt autoremove --purge -y snapd</span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo rm -rf ~/snap /snap /var/snap /var/lib/snapd  /var/cache/snapd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 软件源设置与系统更新</span></span><br><span class=\"line\">sudo cp /etc/apt/sources.list&#123;,.bak&#125;</span><br><span class=\"line\">sudo tee /etc/apt/sources.list &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\">#阿里云Mirrors - Ubuntu</span></span><br><span class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class=\"line\">deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class=\"line\"></span><br><span class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class=\"line\">deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class=\"line\"></span><br><span class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class=\"line\">deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class=\"line\"></span><br><span class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class=\"line\">deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class=\"line\"></span><br><span class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class=\"line\">deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo apt autoclean &amp;&amp; sudo apt update</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 判断时间与时区</span></span><br><span class=\"line\">~$ date</span><br><span class=\"line\">Sat 20 Mar 2021 11:35:19 PM CST</span><br><span class=\"line\">~$ timedatectl status</span><br><span class=\"line\">               Local time: Sat 2021-03-20 23:35:00 CST</span><br><span class=\"line\">           Universal time: Sat 2021-03-20 15:35:00 UTC</span><br><span class=\"line\">                 RTC time: Sat 2021-03-20 15:35:00</span><br><span class=\"line\">                Time zone: Asia/Shanghai (CST, +0800)</span><br><span class=\"line\">System clock synchronized: yes</span><br><span class=\"line\">              NTP service: n/a</span><br><span class=\"line\">          RTC <span class=\"keyword\">in</span> <span class=\"built_in\">local</span> TZ: no</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 在DNS服务器上安装 bind9</span></span><br><span class=\"line\">apt install bind9</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 安装成功后目录结构查看主要是配置文件存放目录以及内部域名解析为对应IP的文件</span></span><br><span class=\"line\">~$ tree /etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">/etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">├── bind.keys</span><br><span class=\"line\">├── db.0</span><br><span class=\"line\">├── db.127</span><br><span class=\"line\">├── db.255</span><br><span class=\"line\">├── db.empty</span><br><span class=\"line\">├── db.local</span><br><span class=\"line\">├── named.conf                 <span class=\"comment\"># named 主配置文件入口</span></span><br><span class=\"line\">├── named.conf.default-zones   <span class=\"comment\"># - named 本地默认域</span></span><br><span class=\"line\">├── named.conf.local           <span class=\"comment\"># - named 自定义域名(我们内网创建的域名解析相应的配置在此处)</span></span><br><span class=\"line\">├── named.conf.options         <span class=\"comment\"># - named 全局配置段</span></span><br><span class=\"line\">├── rndc.key</span><br><span class=\"line\">└── zones.rfc1918</span><br><span class=\"line\"></span><br><span class=\"line\">$ tree /var/cache/<span class=\"built_in\">bind</span>/        <span class=\"comment\"># 自定义的正向解析域名以及反向解析的内容文件(你可以将其类比于存储了IP与域名对应的数据库表)</span></span><br><span class=\"line\">/var/cache/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">├── db.12.168.192</span><br><span class=\"line\">├── db.168.192</span><br><span class=\"line\">├── db.weiyigeek.cn</span><br><span class=\"line\">├── db.weiyigeek.top</span><br><span class=\"line\">├── managed-keys.bind</span><br><span class=\"line\">└── managed-keys.bind.jnl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (6) 启动服务查看状态</span></span><br><span class=\"line\">$ sudo systemctl start named</span><br><span class=\"line\">$ sudo systemctl status named</span><br><span class=\"line\">  <span class=\"comment\"># ● named.service - BIND Domain Name Server</span></span><br><span class=\"line\">  <span class=\"comment\">#     Loaded: loaded (/lib/systemd/system/named.service; enabled; vendor preset: enabled)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Active: active (running) since Sat 2021-03-20 20:41:03 CST; 3h 4min ago</span></span><br><span class=\"line\">  <span class=\"comment\">#       Docs: man:named(8)</span></span><br><span class=\"line\">  <span class=\"comment\">#   Main PID: 838 (named)</span></span><br><span class=\"line\">  <span class=\"comment\">#       Tasks: 26 (limit: 9448)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Memory: 82.1M</span></span><br><span class=\"line\">  <span class=\"comment\">#     CGroup: /system.slice/named.service</span></span><br><span class=\"line\">  <span class=\"comment\">#             └─838 /usr/sbin/named -f -u bind</span></span><br></pre></td></tr></table></figure>\n<p>Tips : 至此安装告一段落后面企业内部DNS服务搭建时再进行详细讲解；</p>\n<p><br></p>\n<p><strong>(3) 脚本附录</strong><br>systemd 服务:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 与此 unit 的解释、执行服务相依性有关</span></span><br><span class=\"line\">cat &gt; /etc/systemd/system/named.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=bind9 DNS monitor maneger</span><br><span class=\"line\">Documentation=https://www.isc.org/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">WorkingDirectory=/etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>/sbin/named -u named -c /etc/<span class=\"built_in\">bind</span>/named.conf</span><br><span class=\"line\">ExecStop=/bin/<span class=\"built_in\">kill</span> -INT <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">ExecReload=/bin/<span class=\"built_in\">kill</span> -HUP <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">KillMode=process</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">Alias=named.service</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>描述:因为是一个服务、所以我们要为他提供一个服务脚本、以后可以利用脚本启动、编辑<code>/etc/init.d/bindnamed</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># Ubuntu 20.04 TLS</span></span><br><span class=\"line\"><span class=\"comment\"># description: named daemon</span></span><br><span class=\"line\"><span class=\"comment\"># chkconfig: - 25 88  </span></span><br><span class=\"line\"></span><br><span class=\"line\">namedFile=<span class=\"string\">\"/usr/local/bind/sbin/named\"</span></span><br><span class=\"line\">pidFile=<span class=\"string\">\"/var/run/named/named.pid\"</span></span><br><span class=\"line\">lockFile=<span class=\"string\">\"/var/lock/subsys/named\"</span></span><br><span class=\"line\">confFile=<span class=\"string\">\"/etc/bind/named.conf\"</span></span><br><span class=\"line\">pid=$(pidof <span class=\"variable\">$&#123;namedFile&#125;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 启动</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">start</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ -e <span class=\"variable\">$lockFile</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">\"named is already running...\"</span></span><br><span class=\"line\">      <span class=\"built_in\">exit</span> 0</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -n <span class=\"string\">\"Starting named:\"</span></span><br><span class=\"line\">  <span class=\"variable\">$&#123;namedFile&#125;</span> -u named -c <span class=\"string\">\"<span class=\"variable\">$&#123;confFile&#125;</span>\"</span></span><br><span class=\"line\">  RETVAL=$?</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\" Pid = <span class=\"variable\">$(pidof named)</span>\"</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$RETVAL</span> -eq 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    touch <span class=\"variable\">$lockFile</span> <span class=\"variable\">$lockFile</span></span><br><span class=\"line\">    <span class=\"built_in\">return</span> <span class=\"variable\">$RETVAL</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    rm -f <span class=\"variable\">$lockFile</span> <span class=\"variable\">$pidFile</span></span><br><span class=\"line\">    <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 停止</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">stop</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ ! -e <span class=\"variable\">$lockFile</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"named is stopped.\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -n <span class=\"string\">\"Stopping named:\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 使用脚本实现killproc的功能</span></span><br><span class=\"line\">  <span class=\"comment\"># ps - | grep named | &#123;</span></span><br><span class=\"line\">  <span class=\"comment\"># while read pid tty time cmd;</span></span><br><span class=\"line\">  <span class=\"comment\">#   do</span></span><br><span class=\"line\">  <span class=\"comment\">#     echo -n \"Killing $cmd with PID = $pid\"</span></span><br><span class=\"line\">  <span class=\"comment\">#     kill -INT $pid</span></span><br><span class=\"line\">  <span class=\"comment\">#   done</span></span><br><span class=\"line\">  <span class=\"comment\"># &#125;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$pid</span>\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">kill</span> -INT <span class=\"variable\">$pid</span></span><br><span class=\"line\">    RETVAL=$?</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$RETVAL</span> -eq 0 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    rm -f <span class=\"variable\">$lockFile</span> <span class=\"variable\">$pidFile</span></span><br><span class=\"line\">    <span class=\"built_in\">return</span> 0</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"Cannot stop named.\"</span></span><br><span class=\"line\">    <span class=\"built_in\">return</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 重启 </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">restart</span></span>() &#123;</span><br><span class=\"line\">  stop</span><br><span class=\"line\">  sleep 2</span><br><span class=\"line\">  start</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 重载</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">reload</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -n <span class=\"string\">\"Reloading named: \"</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$pid</span>\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">kill</span> -HUP <span class=\"variable\">$pid</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  RETVAL=$?</span><br><span class=\"line\">  <span class=\"built_in\">echo</span></span><br><span class=\"line\">  <span class=\"built_in\">return</span> <span class=\"variable\">$RETVAL</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">status</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$pid</span>\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> -n <span class=\"string\">\"named is running...(<span class=\"variable\">$pid</span>) \"</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> -n <span class=\"string\">\"named is stopped...\"</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">usage</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"Usage: named &#123;start|stop|restart|status|reload&#125;\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"variable\">$1</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">  start)</span><br><span class=\"line\">    start ;;</span><br><span class=\"line\">  stop)</span><br><span class=\"line\">    stop ;;</span><br><span class=\"line\">  restart)</span><br><span class=\"line\">    restart ;;</span><br><span class=\"line\">  status)</span><br><span class=\"line\">    status ;;</span><br><span class=\"line\">  reload)</span><br><span class=\"line\">    reload ;;</span><br><span class=\"line\">  *)</span><br><span class=\"line\">    usage</span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 4 ;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br></pre></td></tr></table></figure></p>\n<p>操作流程:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 755 /etc/init.d/named</span><br><span class=\"line\">chkconfig named on &amp;&amp; chkconfig --list named</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>(3) 入坑解决</strong></p>\n<ul>\n<li>问题1.error: Python &gt;= 2.7 or &gt;= 3.2 and the PLY package are required for dnssec-keymgr and other Python-based tools.<br>错误信息:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure: error: Python &gt;= 2.7 or &gt;= 3.2 and the PLY package are required <span class=\"keyword\">for</span> dnssec-keymgr and other Python-based tools. PLY may be available from your OS package manager as python-ply or python3-ply; it can also be installed via pip. To build without Python/PLY, use --without-python.</span><br><span class=\"line\">配置:错误:Python &gt;= 2.7或&gt;= 3.2和PLY包是需要的dnssec-keymgr和其他基于Python的工具。PLY可以从你的OS包管理器作为pythonply或python3 PLY可用;也可以通过pip进行安装。如果不使用Python/PLY进行构建，请使用——不使用Python。</span><br></pre></td></tr></table></figure>\n解决办法: <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install python3-pip</span><br><span class=\"line\">pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple ply</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p>问题2.error: OpenSSL/LibreSSL not found<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">checking whether compiling and linking against OpenSSL works... no</span><br><span class=\"line\">configure: error: <span class=\"keyword\">in</span> <span class=\"string\">'/usr/local/bind-9.16.9'</span>:</span><br><span class=\"line\">configure: error: OpenSSL/LibreSSL not found</span><br></pre></td></tr></table></figure></p>\n<p>解决办法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#是OpenSSL 加密库(lib), 这个库需要openssl-devel包 ,在ubuntu中就是 libssl-dev </span></span><br><span class=\"line\"><span class=\"comment\">#RedHat Fedora 平台 </span></span><br><span class=\"line\">yum -y install openssl-devel </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Debian ,ubunu 平台 </span></span><br><span class=\"line\">apt-get install libssl-dev</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>问题3.启动DNS由于权限问题导致监听错误<code>isc_file_isplainfile &#39;data/named.run&#39; failed: permission denied</code></p>\n<ul>\n<li>错误信息:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">30-Nov-2020 21:41:25.073 checking logging configuration failed: permission denied</span><br><span class=\"line\">30-Nov-2020 21:41:25.089 loading configuration: permission denied</span><br><span class=\"line\">30-Nov-2020 21:41:25.089 exiting (due to fatal error)</span><br></pre></td></tr></table></figure></li>\n<li>解决办法:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chown named.named /etc/<span class=\"built_in\">bind</span>/rndc.key</span><br><span class=\"line\">chown -R named.named /var/named/data</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h4 id=\"CentOS-安装\"><a href=\"#CentOS-安装\" class=\"headerlink\" title=\"CentOS 安装\"></a>CentOS 安装</h4><p><strong>环境安装说明：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">bind</span>版本: <span class=\"built_in\">bind</span>-9.10.5-P3.tar.gz <span class=\"comment\"># http://www.isc.org/downloads/bind/</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>安装流程:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 时间同步以及检查一下安装环境所需要的开发包组、确保所依赖的开发包组</span></span><br><span class=\"line\">ntpdate ntp1.aliyun.com</span><br><span class=\"line\">yum -y groupinstall <span class=\"string\">\"Development Tools\"</span> &amp;&amp;  yum -y groupinstall <span class=\"string\">\"Server Platform Development\"</span></span><br><span class=\"line\">yum grouplist  <span class=\"comment\"># 查看一下、最主要两项：Development tools和Server Platform Development</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 解压并编译</span></span><br><span class=\"line\">tar -zvxf <span class=\"built_in\">bind</span>-9.10.5-P3.tar.gz &amp;&amp; <span class=\"built_in\">cd</span> <span class=\"built_in\">bind</span>-9.10.5-P3</span><br><span class=\"line\">./configure --prefix=/data/bind9 --sysconfdir=/etc/named --<span class=\"built_in\">enable</span>-threads --<span class=\"built_in\">enable</span>-epoll --with-openssl --<span class=\"built_in\">disable</span>-chroot</span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"comment\"># --prefix=/data/bind9：指定编译存放的路径</span></span><br><span class=\"line\"><span class=\"comment\"># --with-openssl ： openssl的支持</span></span><br><span class=\"line\"><span class=\"comment\"># --sysconfdir=/etc/named：指定配置文件存放路径</span></span><br><span class=\"line\"><span class=\"comment\"># --enable-threads：启用了多线程的功能</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 相关用户及其组的创建(-r选项系统用户不会给他创建家目录的)</span></span><br><span class=\"line\">groupadd -g 53 -r named</span><br><span class=\"line\">useradd -g named -r named</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 创建对应的配置目录以及文件</span></span><br><span class=\"line\">mkdir -vp /etc/named/ &amp;&amp; touch /etc/bind.conf</span><br><span class=\"line\">mkdir -vp /var/named</span><br><span class=\"line\"><span class=\"comment\"># 关键一定要保证能解析，否则无法forward转发那些NS(223.5.5.5或者8.8.8.8等)的解析，比如最后无法ping通www.baidu.com</span></span><br><span class=\"line\">dig -t NS . @8.8.8.8 &gt; /var/named/named.ca</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 配置文件编辑</span></span><br><span class=\"line\">vim /etc/named/named.conf</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>基于系统软件管理包进行安装使用</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 安装完BIND后系统会多一个用户named</span></span><br><span class=\"line\">yum -y install <span class=\"built_in\">bind</span>*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 启动DNS服务</span></span><br><span class=\"line\">systemctl start named.service &amp;&amp; systemctl <span class=\"built_in\">enable</span> named.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 验证服务是否正常</span></span><br><span class=\"line\">systemctl status named.service</span><br><span class=\"line\">netstat -an|grep :53</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 防火墙开放TCP和UDP的53号端口：</span></span><br><span class=\"line\">iptables -I INPUT -p tcp --dport 53 -j ACCEPT</span><br><span class=\"line\">iptables -I INPUT -p udp --dport 53 -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 配置全局文件或者区域文件</span></span><br><span class=\"line\">/etc/named.rfc1912.zones</span><br><span class=\"line\">cp -p /var/named/named.localhost /var/named/cise.weiyigeek.top.zone</span><br><span class=\"line\">/var/named/198.168.192.in-addr.arpa.zone</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (6) 在Linux下的DNS客户端的设置及测试配置/etc/resolv.conf文件。</span></span><br><span class=\"line\">domain cise.weiyigeek.top</span><br><span class=\"line\">search cise.weiyigeek.top</span><br><span class=\"line\">nameserver 192.168.10.154</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"Docker-容器\"><a href=\"#Docker-容器\" class=\"headerlink\" title=\"Docker 容器\"></a>Docker 容器</h4><p>基础环境准备:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.更新系统</span></span><br><span class=\"line\">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.安装docker</span></span><br><span class=\"line\">curl -sSL https://get.daocloud.io/docker | sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.配置Docker使用国内镜像</span></span><br><span class=\"line\">sudo vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"registry-mirrors\"</span>: [</span><br><span class=\"line\">    <span class=\"string\">\"https://hub-mirror.c.163.com\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"https://mirror.baidubce.com\"</span></span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.重启一下docker服务并检查是否配置成功</span></span><br><span class=\"line\">sudo systemctl restart docker</span><br><span class=\"line\">sudo docker info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.容器安装DNS时建议系统的systemd-resolved服务（我没有关闭所以可能不会有影响）</span></span><br><span class=\"line\"><span class=\"comment\"># Ubuntu 20.04中默认启用的systemd-resolved服务会占用udp53端口, 如果导致bind服务无法正常启动所以要先禁用掉这个服务</span></span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">disable</span> systemd-resolved</span><br><span class=\"line\">sudo systemctl stop systemd-resolved</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6.禁用服务后还需要手动修改/etc/resolv.conf指定互联网DNS服务地址</span></span><br><span class=\"line\">sudo vim /etc/resolv.conf</span><br><span class=\"line\"><span class=\"comment\"># 修改下面行</span></span><br><span class=\"line\">nameserver 114.114.114.114</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<ul>\n<li><strong>方式1:internetsystemsconsortium/bind9:9.16</strong><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 权威DNS服务器在这里，您实际上需要在/etc/bind/name.conf和区域等中提供所需的配置(例如，这不是魔法，您必须配置它)。</span></span><br><span class=\"line\">docker run \\</span><br><span class=\"line\">  --name=bind9 \\</span><br><span class=\"line\">  --restart=always \\</span><br><span class=\"line\">  --publish 53:53/udp \\</span><br><span class=\"line\">  --publish 53:53/tcp \\</span><br><span class=\"line\">  --publish 127.0.0.1:953:953/tcp \\</span><br><span class=\"line\">  --volume /etc/<span class=\"built_in\">bind</span> \\</span><br><span class=\"line\">  --volume /var/cache/<span class=\"built_in\">bind</span> \\</span><br><span class=\"line\">  --volume /var/lib/<span class=\"built_in\">bind</span> \\</span><br><span class=\"line\">  --volume /var/<span class=\"built_in\">log</span> \\</span><br><span class=\"line\">  internetsystemsconsortium/bind9:9.16</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 配置说明</span></span><br><span class=\"line\">Recursive DNS server     <span class=\"comment\"># 递归DNS服务器不需要任何配置。</span></span><br><span class=\"line\">Authoritative DNS server <span class=\"comment\"># 权威DNS服务器配置</span></span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">        directory <span class=\"string\">\"/var/cache/bind\"</span>;</span><br><span class=\"line\">        listen-on &#123; 127.0.0.1; &#125;;</span><br><span class=\"line\">        listen-on-v6 &#123; ::1; &#125;;</span><br><span class=\"line\">        allow-recursion &#123;</span><br><span class=\"line\">                none;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        allow-transfer &#123;</span><br><span class=\"line\">                none;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        allow-update &#123;</span><br><span class=\"line\">                none;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"example.com.\"</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">type</span> primary;</span><br><span class=\"line\">        file <span class=\"string\">\"/var/lib/bind/db.example.com\"</span>;</span><br><span class=\"line\">        notify explicit;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<ul>\n<li>方式2: UI DNS 管理界面<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 镜像拉取</span></span><br><span class=\"line\">sudo docker pull sameersbn/<span class=\"built_in\">bind</span>:latest</span><br><span class=\"line\"><span class=\"comment\"># ----内网环境导入----</span></span><br><span class=\"line\"><span class=\"comment\"># 导出镜像为本地压缩包</span></span><br><span class=\"line\">sudo docker save -o bind.tar sameersbn/<span class=\"built_in\">bind</span>:latest</span><br><span class=\"line\"><span class=\"comment\"># 内网服务器可以导入上面的压缩包</span></span><br><span class=\"line\">sudo docker load -i bind.tar</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看镜像信息</span></span><br><span class=\"line\">docker images --all</span><br><span class=\"line\">  <span class=\"comment\"># REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span></span><br><span class=\"line\">  <span class=\"comment\"># sameersbn/bind      latest              55516ab380dc        6 months ago        343MB</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 数据持久化目录创建</span></span><br><span class=\"line\">mkdir -vp /app/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">  <span class=\"comment\"># mkdir: created directory '/app'</span></span><br><span class=\"line\">  <span class=\"comment\"># mkdir: created directory '/app/bind/'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 服务启动</span></span><br><span class=\"line\">sudo docker run --name=<span class=\"string\">'bind'</span> -d -p 53:53/udp -p 10000:10000/tcp -e WEBMIN_ENABLED=<span class=\"literal\">true</span> -v ~/<span class=\"built_in\">bind</span>:/app/<span class=\"built_in\">bind</span>/ sameersbn/<span class=\"built_in\">bind</span>:latest</span><br><span class=\"line\">8348e2e7af96c2cbfcd9cab36c8651407cd91f94caf9195251269654e4eae045</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 分别检查bind服务的udp53端口和webmin管理服务的tcp10000端口是否正常启用</span></span><br><span class=\"line\">~$ ss -lnutp | grep -E <span class=\"string\">\":53|:10000\"</span></span><br><span class=\"line\"><span class=\"comment\"># udp   UNCONN 0      0                          127.0.0.53%lo:53         0.0.0.0:*     #       systemd-resolved服务                      </span></span><br><span class=\"line\">udp   UNCONN 0      0                             172.17.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                         192.168.12.253:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                              127.0.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                             172.17.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                             172.17.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                             172.17.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                         192.168.12.253:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                         192.168.12.253:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                         192.168.12.253:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                              127.0.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                              127.0.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                              127.0.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0                                      *:53               *:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0      [fe80::250:56ff:fe8a:cf24]%ens160:53            [::]:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0      [fe80::250:56ff:fe8a:cf24]%ens160:53            [::]:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0      [fe80::250:56ff:fe8a:cf24]%ens160:53            [::]:*                                        </span><br><span class=\"line\">udp   UNCONN 0      0      [fe80::250:56ff:fe8a:cf24]%ens160:53            [::]:*                                        </span><br><span class=\"line\"><span class=\"comment\"># tcp   LISTEN 0      4096                       127.0.0.53%lo:53         0.0.0.0:*     #       systemd-resolved服务                             </span></span><br><span class=\"line\">tcp   LISTEN 0      10                            172.17.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">tcp   LISTEN 0      10                        192.168.12.253:53         0.0.0.0:*                                        </span><br><span class=\"line\">tcp   LISTEN 0      10                             127.0.0.1:53         0.0.0.0:*                                        </span><br><span class=\"line\">tcp   LISTEN 0      4096                                   *:10000            *:*                                        </span><br><span class=\"line\">tcp   LISTEN 0      10     [fe80::250:56ff:fe8a:cf24]%ens160:53            [::]:*  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此种方式已不能正常使用（已弃用）</span></span><br><span class=\"line\"><span class=\"comment\"># docker network create -d macvlan --subnet=10.0.10.0/24 --gateway=10.0.10.1 -o parent=ens160 appnet</span></span><br><span class=\"line\"><span class=\"comment\"># 其中enp0s3 就是目前宿主机IP对应的网络，接下来我们创建一个macvlan网络：</span></span><br><span class=\"line\"><span class=\"comment\"># -d 驱动， 这里使用macvlan</span></span><br><span class=\"line\"><span class=\"comment\"># --subnet，指定子网</span></span><br><span class=\"line\"><span class=\"comment\"># --gateway，指定网关</span></span><br><span class=\"line\"><span class=\"comment\"># parent，这里指定宿主机网卡名称</span></span><br><span class=\"line\"><span class=\"comment\"># appnet，这是新创建的docker网络名称</span></span><br><span class=\"line\"><span class=\"comment\"># docker network inspect appnet</span></span><br><span class=\"line\"><span class=\"comment\"># docker run -dit --hostname bind --net=appnet --ip=10.0.10.1 --name bind --restart=always --volume /app/bind:/data sameersbn/bind:latest</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>WEB管理使用浏览器访问下面地址进行远程管理:<code>https://服务器IP:10000</code>, 默认登陆账号root,密码password</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210321001638.png\" alt=\"WeiyiGeek.Webmin\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Webmin</p>\n            </figure>\n<p>Tips: 小型企业中此种方式管理方便十分推荐。</p>\n<hr>\n<h2 id=\"0x03-Bind-配置解析\"><a href=\"#0x03-Bind-配置解析\" class=\"headerlink\" title=\"0x03 Bind 配置解析\"></a>0x03 Bind 配置解析</h2><p>Bind9 官方语法参考: <a href=\"https://bind9.readthedocs.io/en/v9_16_13/reference.html?highlight=allow-query-cache#\" target=\"_blank\" rel=\"noopener\">https://bind9.readthedocs.io/en/v9_16_13/reference.html?highlight=allow-query-cache#</a></p>\n<h3 id=\"1-配置文件目录\"><a href=\"#1-配置文件目录\" class=\"headerlink\" title=\"1) 配置文件目录\"></a>1) 配置文件目录</h3><p><strong>Q: Bind9 相关文件信息说明?</strong></p>\n<ul>\n<li>相关路径：/var/named/ 或者 /var/cache/named</li>\n<li>配置文件：/var/named/chroot/etc/named.conf 与 /etc/named.conf 或者 /etc/bind/named.conf</li>\n<li>后台进程：named</li>\n<li>控制脚本: <code>/etc/rc.d/init.d/named</code> 或者 <code>/etc/init.d/named</code></li>\n<li>使用端口：53 (tcp,udp)</li>\n</ul>\n<p>PS : 上述路径与Named编译选项、以及安装方式操作 系统有直接关联;</p>\n<p>帮助文档:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>/share/man<span class=\"comment\"># cp -r * /usr/local/share/man/</span></span><br><span class=\"line\">cp: -r not specified; omitting directory <span class=\"string\">'man1'</span></span><br><span class=\"line\">cp: -r not specified; omitting directory <span class=\"string\">'man5'</span></span><br><span class=\"line\">cp: -r not specified; omitting directory <span class=\"string\">'man8'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># named 运行 </span></span><br><span class=\"line\">man named</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># named 配置文件</span></span><br><span class=\"line\">man named.conf</span><br></pre></td></tr></table></figure></p>\n<p>Tips : Bind9 安装后其目录有一定的差异与安装方式以及操作系统有非常大的关系。例如Ubuntu安装的bind9:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree /etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">/etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">├── bind.keys</span><br><span class=\"line\">├── db.0</span><br><span class=\"line\">├── db.127</span><br><span class=\"line\">├── db.255</span><br><span class=\"line\">├── db.empty</span><br><span class=\"line\">├── db.local</span><br><span class=\"line\">├── named.conf  <span class=\"comment\"># 主配置文件</span></span><br><span class=\"line\">├── named.conf.default-zones</span><br><span class=\"line\">├── named.conf.local</span><br><span class=\"line\">├── named.conf.options</span><br><span class=\"line\">├── rndc.key</span><br><span class=\"line\">└── zones.rfc1918</span><br><span class=\"line\"></span><br><span class=\"line\">$ cat /etc/<span class=\"built_in\">bind</span>/named.conf</span><br><span class=\"line\">// This is the primary configuration file <span class=\"keyword\">for</span> the BIND DNS server named.</span><br><span class=\"line\">//</span><br><span class=\"line\">// Please <span class=\"built_in\">read</span> /usr/share/doc/bind9/README.Debian.gz <span class=\"keyword\">for</span> information on the</span><br><span class=\"line\">// structure of BIND configuration files <span class=\"keyword\">in</span> Debian, *BEFORE* you customize</span><br><span class=\"line\">// this configuration file.</span><br><span class=\"line\">//</span><br><span class=\"line\">// If you are just adding zones, please <span class=\"keyword\">do</span> that <span class=\"keyword\">in</span> /etc/<span class=\"built_in\">bind</span>/named.conf.local</span><br><span class=\"line\"></span><br><span class=\"line\">include <span class=\"string\">\"/etc/bind/named.conf.options\"</span>;</span><br><span class=\"line\">include <span class=\"string\">\"/etc/bind/named.conf.local\"</span>;</span><br><span class=\"line\">include <span class=\"string\">\"/etc/bind/named.conf.default-zones\"</span>;</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"2-配置选项\"><a href=\"#2-配置选项\" class=\"headerlink\" title=\"2) 配置选项\"></a>2) 配置选项</h3><p><strong>Syntax 语法说明:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 严格注意语法书写(其格式非常严格)</span></span><br><span class=\"line\"><span class=\"comment\"># (2) 解析记录(例如A、CNAME包括但不限于)都是不允许折行书写</span></span><br><span class=\"line\"><span class=\"comment\"># (3) 单行记录开头不准许空格或者tab开头 </span></span><br><span class=\"line\"><span class=\"comment\"># (4) 字符说明</span></span><br><span class=\"line\">  <span class=\"comment\"># // 表示注销掉系统默认配置的zone信息所有行</span></span><br><span class=\"line\">  <span class=\"comment\"># ;  表示注释</span></span><br><span class=\"line\">  <span class=\"comment\"># @  表示当前域名它是DNS记录中的保留字</span></span><br><span class=\"line\">  <span class=\"comment\"># $  表示定义变量</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>Tips: named.conf 默认选项值及参数一览<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>-9.16.9<span class=\"comment\"># bin/tests/cfg_test --named --grammar | more</span></span><br><span class=\"line\"><span class=\"comment\"># options &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#         answer-cookie &lt;boolean&gt;;</span></span><br><span class=\"line\"><span class=\"comment\">#         automatic-interface-scan &lt;boolean&gt;;</span></span><br><span class=\"line\"><span class=\"comment\">#         avoid-v4-udp-ports &#123; &lt;portrange&gt;; ... &#125;;</span></span><br><span class=\"line\"><span class=\"comment\">#         avoid-v6-udp-ports &#123; &lt;portrange&gt;; ... &#125;;</span></span><br><span class=\"line\"><span class=\"comment\">#         bindkeys-file &lt;quoted_string&gt;;</span></span><br><span class=\"line\"><span class=\"comment\">#         blackhole &#123; &lt;address_match_element&gt;; ... &#125;;</span></span><br><span class=\"line\"><span class=\"comment\">#         cookie-algorithm ( aes | siphash24 );</span></span><br><span class=\"line\"><span class=\"comment\">#         cookie-secret &lt;string&gt;; // may occur multiple times</span></span><br><span class=\"line\"><span class=\"comment\">#         coresize ( default | unlimited | &lt;sizeval&gt; );</span></span><br><span class=\"line\"><span class=\"comment\"># ....</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 例如: dnssec-validation 验证</span></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/<span class=\"built_in\">bind</span>-9.16.9/bin/tests/cfg_test --named --grammar |  grep <span class=\"string\">\"dnssec-validation\"</span></span><br><span class=\"line\">  dnssec-validation ( yes | no | auto );</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tips : 在 /etc/named.conf 配置文件中包括 <code>options(全局参数)、zone(区域定义)、access control lists(访问控制列表)、Key(rndc 安全加解密钥)、logging(日志记录)等主要选项</code></p>\n<p><strong>访问限制常用字句语句说明: 格式子句  语句  说明</strong></p>\n<ul>\n<li>allow-query  options,zone  指定哪主机或网络可以查询本服务器或区，默认的是允许所有主机进行查询。 </li>\n<li>allow-transfer  options,zone  指定哪些主机允许和本地服务器进行域传输（定允许复制zone数据的主机-主从必备），默认值是允许和所有主机进行域传输。 </li>\n<li>allow-recursion  options  指定哪些主机可以进行递归查询。如果没有设定，缺省是允许所有主机进行递归查询的。注意禁止一台主机的递归查询，并不能阻止这台主机查询已经存在于服务器缓存中的数据。</li>\n<li>allow-update  zone  指定哪些主机允许为主域名服务器提交动态 DNS 更新。默认为拒绝任何主机进行更新。</li>\n<li>blackhole  options  指定不接收来自哪些主机的查询请求和地址解析。默认值是 none 。</li>\n</ul>\n<p><br></p>\n<p><strong>日志的常用字句语句说明: 术语  含义</strong></p>\n<ul>\n<li>channel（通道）  日志输出方式，如：syslog、文本文件、标准错误输出或 /dev/null </li>\n<li>category（类别）  日志的消息类别，如：查询消息或动态更新消息等 </li>\n<li>module（模块）  产生消息的来源模块名称 </li>\n<li>facility（设备）  syslog 设备名 </li>\n<li>severity（严重性）  消息的严重性等级 </li>\n</ul>\n<p><br></p>\n<p><strong>配置参数:</strong></p>\n<ul>\n<li>1.ACL(访问控制) : 访问控制列表（ACL）就是一个被命名的地址匹配列表, 使用访问控制列表可以使配置简单而清晰，一次定义之后可以在多处使用，不会使配置文件因为大量的 IP 地址而变得混乱。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Tips : acl 是 named.conf 中的顶级语句，不能将其嵌入其他的语句。并且定义访问控制列表的 acl 语句应该位于 options 语句之前。</span></span><br><span class=\"line\"><span class=\"comment\"># Tips : 为了便于维护管理员定义的访问控制列表，可以将所有定义 acl 的语句存放在单独的文件 /etc/bind/named.conf.acls 中。可以在主配置文件 /etc/bind/named.conf 中如下语句 include \"/etc/bind/named.conf.options\" 之前添加如下的配置行include \"/etc/bind/named.conf.acls\";</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># acl 语句语法</span></span><br><span class=\"line\">acl <span class=\"string\">\"acl_name\"</span> &#123;</span><br><span class=\"line\">  address_match_list;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># acl 使用基础示例</span></span><br><span class=\"line\">acl <span class=\"string\">\"acl_name\"</span> &#123;</span><br><span class=\"line\">  localhosts;</span><br><span class=\"line\">  10.0.0.0/8;</span><br><span class=\"line\">  172.16.0.0/12;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 阈值参数: 默认预定义了 4 个名称的地址匹配列表</span></span><br><span class=\"line\">  * any : 所有主机</span><br><span class=\"line\">  * localhost : 本机</span><br><span class=\"line\">  * localnets : 本地网络上的所有主机</span><br><span class=\"line\">  * none : 不匹配任何主机</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li><p>2.options(全局参数)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.ACL使用举例限制查询</span></span><br><span class=\"line\"><span class=\"comment\"># - 假如要限制只有 202.0.0.0/8 和 221.0.0.0/8 查询本地服务器的所有区信息需在 options 语句里使用 allow-query 子句</span></span><br><span class=\"line\">allow-query &#123; 202.0.0.0/8; 221.0.0.0/8; &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 使用定义的 acl_name 限制允许查询的主机列表</span></span><br><span class=\"line\">allow-query &#123; aqlist; &#125;;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.zone(区域定义)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zone <span class=\"string\">\"example.com\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">  file <span class=\"string\">\"example.com.hosts\"</span>;</span><br><span class=\"line\">  <span class=\"comment\"># 1.ACL使用举例限制查询</span></span><br><span class=\"line\">  <span class=\"comment\"># 假如要限制只有 221.3.131.5 和 221.3.131.6 可以从本地服务器传输 “example.com” 的区信息 在 zone 语句里使用 allow-transfer 子句</span></span><br><span class=\"line\">  allow-transfer &#123; 221.3.131.5; 221.3.131.6; &#125;;</span><br><span class=\"line\">  <span class=\"comment\"># 使用定义的 acl_name 限制允许进行域传输的主机列表</span></span><br><span class=\"line\">  allow-transfer &#123; aqlist; &#125;;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4.Key (rndc 安全加解密钥)</p>\n</li>\n<li><p>5.View (分离内外服务器配置) : 许多站点希望 DNS 对于内网访问和外网（Internet）访问看起来不一样，这种类型的配置称为”<code>分离 DNS （Split DNS）</code>“; 对内网用户公开整个区的所有主机而对 Internet 用户只公开几台主机，如 www 服务器等对内外用户指定不同的 RR，或对内网用户提供更多的 RR可以在内网使用 RFC 1918 中定义的私有地址</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># view 语句语法</span></span><br><span class=\"line\">view view_name &#123;</span><br><span class=\"line\">  match-clients &#123; address_match_list &#125;; <span class=\"comment\"># 它用于指定谁能看到本 view</span></span><br><span class=\"line\">  [ view_option; ...]</span><br><span class=\"line\">  zone_statement; ...</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 简单示例</span></span><br><span class=\"line\">view <span class=\"string\">\"internal\"</span> &#123;</span><br><span class=\"line\">   match-clients &#123; our-nets; &#125;;           ; 匹配内网客户的访问</span><br><span class=\"line\">   recursion yes;                         ; 对内网客户允许执行递归查询</span><br><span class=\"line\">   zone <span class=\"string\">\"example.com\"</span> &#123;                   ; 定义内网客户可见的区声明</span><br><span class=\"line\">      <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">      file <span class=\"string\">\"example.com.hosts.internal\"</span>;</span><br><span class=\"line\">   &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">view <span class=\"string\">\"external\"</span> &#123;</span><br><span class=\"line\">   match-clients &#123; any; &#125;;                 ; 匹配 Internet 客户的访问</span><br><span class=\"line\">   recursion no;                           ; 对 Internet 客户不允许执行递归查询</span><br><span class=\"line\">   zone <span class=\"string\">\"example.com\"</span> &#123;                    ; 定义 Internet 客户可见的区声明</span><br><span class=\"line\">      <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">      file <span class=\"string\">\"example.com.hosts.external\"</span>;</span><br><span class=\"line\">   &#125;;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>6.logging (日志记录) : 在默认情况下BIND9 把日志消息写到 <code>/var/log/messages</code> 文件中，而这些日志消息是非常少的，主要就是启动，关闭的日志记录和一些严重错误的消息；而将调试日志信息写入 BIND 服务器工作目录中的 <code>named.run</code> 文件。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法</span></span><br><span class=\"line\">logging &#123;</span><br><span class=\"line\">    channel channel_name &#123;                // 定义通道</span><br><span class=\"line\">      file log_file [versions number | unlimited] [size sizespec];  | null; | stderr;  </span><br><span class=\"line\">      <span class=\"comment\"># * file : 输出到纯文本文件</span></span><br><span class=\"line\">      <span class=\"comment\"># * log_file 指定一个文件名</span></span><br><span class=\"line\">      <span class=\"comment\"># * version 指定允许同时存在多少个版本的该文件，比如指定 3 个版本（version 3），就会保存 query.log、query.log0、query.log1 和query.log2。</span></span><br><span class=\"line\">      <span class=\"comment\"># * size 指定文件大小的上限，如果只设定了size 而没有设定 version，当文件达到指定的文件大小上限时，服务器停止写入该文件。如果设定了version，服务器会进行循环，如把 log_file 变成 log_file.log1，log_file.log1 变成 log_file.log2 等，然后建立一个新的 log_file.log 进行写入。</span></span><br><span class=\"line\">      </span><br><span class=\"line\">      syslog optional_facility;  <span class=\"comment\"># 输出到 syslog，</span></span><br><span class=\"line\">      <span class=\"comment\"># optional_facility 是 syslog 的设备名可选值</span></span><br><span class=\"line\">      <span class=\"comment\"># * daemon</span></span><br><span class=\"line\">      <span class=\"comment\"># * local0 到 local7</span></span><br><span class=\"line\">      <span class=\"comment\"># * null ：输出到空设备</span></span><br><span class=\"line\">      <span class=\"comment\"># * stderr ：输出到标准错误输出，默认为屏幕</span></span><br><span class=\"line\">     </span><br><span class=\"line\">     </span><br><span class=\"line\">      severity log_severity;           // 定义消息严重性 &amp;  定义输出方式</span><br><span class=\"line\">      <span class=\"comment\"># * log_severity 的取值为（按照严重性递减的顺序）：</span></span><br><span class=\"line\">      <span class=\"comment\"># * critical</span></span><br><span class=\"line\">      <span class=\"comment\"># * error</span></span><br><span class=\"line\">      <span class=\"comment\"># * warning</span></span><br><span class=\"line\">      <span class=\"comment\"># * notice</span></span><br><span class=\"line\">      <span class=\"comment\"># * info</span></span><br><span class=\"line\">      <span class=\"comment\"># * debug [ level ]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"built_in\">print</span>-time boolean;]            // 是否在消息中添加时间前缀，仅用于 file 日志</span><br><span class=\"line\">      [<span class=\"built_in\">print</span>-severity boolean;]        // 是否在消息中添加消息严重性前缀</span><br><span class=\"line\">      [<span class=\"built_in\">print</span>-category boolean;]        // 是否在消息中添加消息类别名前缀</span><br><span class=\"line\">   &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">   category category_name &#123;              // 定义类别</span><br><span class=\"line\">        channel_name;</span><br><span class=\"line\">        ......</span><br><span class=\"line\">   &#125;;</span><br><span class=\"line\">  <span class=\"comment\"># category 语句是指定哪一种类别的信息使用哪个或者哪几个已经定义了的通道输出。</span></span><br><span class=\"line\">  <span class=\"comment\"># 类别  说明 </span></span><br><span class=\"line\">  <span class=\"comment\"># client  处理客户端请求。 </span></span><br><span class=\"line\">  <span class=\"comment\"># config  配置文件分析和处理。 </span></span><br><span class=\"line\">  <span class=\"comment\"># database 同BIND内部数据库相关的消息，用来存储区数据和缓存记录。 </span></span><br><span class=\"line\">  <span class=\"comment\"># default  匹配所有未明确指定通道的类别。 </span></span><br><span class=\"line\">  <span class=\"comment\"># dnssec  处理 DNSSEC 签名的响应。 </span></span><br><span class=\"line\">  <span class=\"comment\"># general  包括所有未明确分类的 BIND 消息。 </span></span><br><span class=\"line\">  <span class=\"comment\"># lame-servers 发现错误授权，即残缺服务器。 </span></span><br><span class=\"line\">  <span class=\"comment\"># network  网络操作。 </span></span><br><span class=\"line\">  <span class=\"comment\"># notify  区更新通知消息。 </span></span><br><span class=\"line\">  <span class=\"comment\"># queries 查询日志 </span></span><br><span class=\"line\">  <span class=\"comment\"># resolver 名字解析，包括对来自解析器的递归查询信息。 </span></span><br><span class=\"line\">  <span class=\"comment\"># security 批准/非批准的请求。 </span></span><br><span class=\"line\">  <span class=\"comment\"># update  动态更新事件。 </span></span><br><span class=\"line\">  <span class=\"comment\"># xfer-in  从远程名字服务器到本地名字服务器的区传送。 </span></span><br><span class=\"line\">  <span class=\"comment\"># xfer-out 从本地名字服务器到远程名字服务器的区传送。 </span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例1.BIND 9 预制了如下四个默认通道</span></span><br><span class=\"line\">channel <span class=\"string\">\"default_syslog\"</span> &#123;</span><br><span class=\"line\"> syslog daemon;     // 发送给 syslog 的 daemon 设备</span><br><span class=\"line\"> severity info;     // 只发送此 info 及其更高优先级的信息</span><br><span class=\"line\">&#125;;   </span><br><span class=\"line\">channel <span class=\"string\">\"default_debug\"</span> &#123; // 只有当服务器的 debug 级别非 0 时，才产生输出。</span><br><span class=\"line\"> file <span class=\"string\">\"named.run\"</span>; // 写入工作目录下的 named.run 文件</span><br><span class=\"line\"> severity dynamic; // 按照服务器当前的debug 级别记录日志</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">channel <span class=\"string\">\"default_stderr\"</span> &#123;</span><br><span class=\"line\">        stderr;           // 写到stderr</span><br><span class=\"line\">        severity info;    // 只发送此 info 及其更高优先级的信息</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">channel <span class=\"string\">\"null\"</span> &#123;</span><br><span class=\"line\">        null;             // 丢弃所有发到此通道的信息</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例2.Bind9 默认配置</span></span><br><span class=\"line\">logging &#123;</span><br><span class=\"line\">  ; <span class=\"comment\"># 通道1</span></span><br><span class=\"line\">  channel default_debug &#123;</span><br><span class=\"line\">    file <span class=\"string\">\"data/named.run\"</span>;</span><br><span class=\"line\">    severity dynamic;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  ; <span class=\"comment\"># 通道2</span></span><br><span class=\"line\">  channel query_log &#123;</span><br><span class=\"line\">      file <span class=\"string\">\"data/query.log.\"</span> versions 5 size 50m;</span><br><span class=\"line\">      <span class=\"built_in\">print</span>-time yes;</span><br><span class=\"line\">      severity info;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  category queries &#123; query_log;&#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例3.例如要记录查询消息可以在 named.conf 中添加如下配置：</span></span><br><span class=\"line\">logging &#123;</span><br><span class=\"line\">  channel query_log &#123;</span><br><span class=\"line\">      file <span class=\"string\">\"query.log\"</span> versions 3 size 20m;</span><br><span class=\"line\">      severity info;</span><br><span class=\"line\">      <span class=\"built_in\">print</span>-time yes;</span><br><span class=\"line\">      <span class=\"built_in\">print</span>-category yes;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  category queries &#123;</span><br><span class=\"line\">      query_log;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Tips : 它会在工作目录（directory 语句所指定的目录，Ubuntu 为 `/var/cache/<span class=\"built_in\">bind</span>` ）下创建 query.log 文件，并把运行过程产生的 queries 消息写如到此文件中。</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p><strong>常用参数</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* forwarders：指定其上级域名服务器</span><br><span class=\"line\">* allow-query：指定允许向其提交请求的客户</span><br><span class=\"line\">* allow-transfer：指定允许传输</span><br></pre></td></tr></table></figure><br><br></p>\n<p>主配置文件 /etc/named.conf 解析说明<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 访问限制，防止欺骗和拒绝服务攻击</span></span><br><span class=\"line\"><span class=\"comment\"># 为了防止欺骗和拒绝服务攻击，对于 Internet 上的每个 DNS 服务器至少应该有一个假地址的 ACL 和一个本地地址的 ACL。</span></span><br><span class=\"line\"><span class=\"comment\"># Tips : 是企业自建的DNS对外网子公司提供DNS解析的场景</span></span><br><span class=\"line\"><span class=\"comment\"># // 创建一个名称为 \"bogusnets\" 的 ACL 来阻止经常用于欺骗性攻击的（RFC1918）地址空间</span></span><br><span class=\"line\">acl bogusnets &#123;</span><br><span class=\"line\">    0.0.0.0/8;</span><br><span class=\"line\">    1.0.0.0/8;</span><br><span class=\"line\">    2.0.0.0/8;</span><br><span class=\"line\">    169.254.0.0/16;</span><br><span class=\"line\">    192.0.2.0/24;</span><br><span class=\"line\">    224.0.0.0/3;</span><br><span class=\"line\">    10.0.0.0/8;</span><br><span class=\"line\">    172.16.0.0/12;</span><br><span class=\"line\">    192.168.0.0/16;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"comment\"># //创建一个名称为 \"our-nets\" 的 ACL，并将其配置为实际本网的 IP 地址段。</span></span><br><span class=\"line\">acl our-nets &#123;    <span class=\"comment\"># 用您的网络地址替换下面的地址列表</span></span><br><span class=\"line\">    x.x.x.x/24;</span><br><span class=\"line\">    x.x.x.x/21;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 全局配置</span></span><br><span class=\"line\"><span class=\"comment\"># * options 整个Bind使用的全局选项</span></span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">  listen-on port 53 &#123; 127.0.0.1; &#125;;  <span class=\"comment\"># 监听端口,修改成自己的IP地址,如果有多个IP,就写多个,也可以写any,每行要以；结束。</span></span><br><span class=\"line\">  listen-on-v6 port 53 &#123; any; &#125;;</span><br><span class=\"line\">  directory   <span class=\"string\">\"/var/named\"</span>;          <span class=\"comment\"># 指定zone file的存放位置，/var/named 是相对目录它在chroot环境下/var/named 目录下。</span></span><br><span class=\"line\">  dump-file <span class=\"string\">\"/var/named/data/cache_dump.db\"</span>;</span><br><span class=\"line\">  statistics-file <span class=\"string\">\"/var/named/data/named_stats.txt\"</span>;</span><br><span class=\"line\">  memstatistics-file <span class=\"string\">\"/var/named/data/named_mem_stats.txt\"</span>;</span><br><span class=\"line\">  allow-query  &#123; localhost;our-nets; &#125;;     <span class=\"comment\"># 允许查询任何client查询此处改成 any</span></span><br><span class=\"line\">  allow-recursion &#123; localhost;our-nets; &#125;;  </span><br><span class=\"line\">  blackhole &#123; bogusnets; &#125;;   <span class=\"comment\"># 不接收来自哪些主机的查询请求和地址解析 默认是none</span></span><br><span class=\"line\">  recursion yes;</span><br><span class=\"line\">  forward only;                        <span class=\"comment\"># only | first</span></span><br><span class=\"line\">  forwarders &#123; 223.6.6.6;223.5.5.5; &#125;  <span class=\"comment\"># 指定其上级域名服务器</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 日志配置</span></span><br><span class=\"line\"><span class=\"comment\"># - 日志记录</span></span><br><span class=\"line\">logging &#123;</span><br><span class=\"line\">  channel default_debug &#123;</span><br><span class=\"line\">    file <span class=\"string\">\"data/named.run\"</span>;</span><br><span class=\"line\">    severity dynamic;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"> channel query_log &#123;</span><br><span class=\"line\">    file <span class=\"string\">\"data/query.log.\"</span> versions 5 size 50m;</span><br><span class=\"line\">    <span class=\"built_in\">print</span>-time yes;</span><br><span class=\"line\">    severity info;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  category queries &#123; query_log;&#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 区域配置</span></span><br><span class=\"line\"><span class=\"comment\"># zone 语句作用是定义DNS 区域,在此语句中可定义DNS 区域选项</span></span><br><span class=\"line\"><span class=\"comment\"># zone区域设置,第一步,设置根区域当DNS服务器处理递归查询时,如果本地区域文件不能进行查询的解析,就会转到根DNS服务器查询,所以在主配置文件named.conf文件中还要定义根区域。 (默认即可)</span></span><br><span class=\"line\"><span class=\"comment\"># 使用根服务器的知识来启动服务器</span></span><br><span class=\"line\">zone <span class=\"string\">\".\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> hint;   <span class=\"comment\"># 根的类型是hint</span></span><br><span class=\"line\">  file <span class=\"string\">\"/usr/share/dns/root.hints\"</span>; <span class=\"comment\"># 根区域文件</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 正向解析配置常规配置</span></span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.top\"</span> IN &#123;</span><br><span class=\"line\">  tyep master;</span><br><span class=\"line\">  file <span class=\"string\">\"weiyigeek.top.zone\"</span></span><br><span class=\"line\">  allow-update &#123;</span><br><span class=\"line\">    none;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将范例及其源文件属性一起复制到正向解析文件</span></span><br><span class=\"line\">cp -p /var/named/named.localhost /var/named/weiyigeek.top.zone</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># /var/named/weiyigeek.top.zone</span></span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 1D</span><br><span class=\"line\">@ IN SOA dns.weiyigeek.top (</span><br><span class=\"line\">  0   ; serial - 序列号 </span><br><span class=\"line\">  1D  ; refresh - 刷新</span><br><span class=\"line\">  1H  ; retry  - 重试</span><br><span class=\"line\">  1W  ; expire - 过期</span><br><span class=\"line\">  3H) ; minimum - 最小值</span><br><span class=\"line\"></span><br><span class=\"line\">@ IN NS dns.weiyigeek.com.</span><br><span class=\"line\">dns IN A 192.168.1.2</span><br><span class=\"line\">www IN A 192.168.1.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关键字说明:</span></span><br><span class=\"line\">TTL : 存活时间</span><br><span class=\"line\">NS ：设置域名服务器的域名name server</span><br><span class=\"line\">IN 是internet记录</span><br><span class=\"line\">SOA 记录 @ 取代在/etc/named.conf中指定的域名其中中的数字分别为：序列号、刷新、重试、过期、生存期</span><br><span class=\"line\">  * 序列号：序列号用于DNS数据库文件的版本控制,每当数据被改变,这个序列号就应该被增加</span><br><span class=\"line\">  * 刷新：从服务器向主服务器查询最新数据的间隔周期。每一次检查时从服务器的数据是否需要更改,则根据序列号来判别</span><br><span class=\"line\">  * 重试：一旦从服务器尝试连接主服务器失败,下一次查询主服务器的延迟时间</span><br><span class=\"line\">  * 过期：如果从服务器无法连通主服务器,则在经过此时间后,宣告其数据过期</span><br><span class=\"line\">  * 生存期：服务器回答 <span class=\"string\">'无此域名'</span> 的间隔时间</span><br><span class=\"line\">  * 数字的默认单位为秒,否则：D= 日、H= 小时、W= 周、M= 分钟</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"3-基础配置示例\"><a href=\"#3-基础配置示例\" class=\"headerlink\" title=\"3) 基础配置示例\"></a>3) 基础配置示例</h3><h4 id=\"示例1-采用Bind建立一个A记录DNS服务器\"><a href=\"#示例1-采用Bind建立一个A记录DNS服务器\" class=\"headerlink\" title=\"示例1.采用Bind建立一个A记录DNS服务器\"></a>示例1.采用Bind建立一个A记录DNS服务器</h4><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126195739.png\" alt=\"WeiyiGeek.示例1需求一览\" title=\"\" class=\"\">\n                <p>WeiyiGeek.示例1需求一览</p>\n            </figure>\n<p>配置示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 全局配置文件</span></span><br><span class=\"line\">$ vim /etc/named.conf </span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">    directory <span class=\"string\">\"/var/named\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"imooc.com\"</span> IN &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"imooc.com.zone\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定的 zone 区域文件配置</span></span><br><span class=\"line\">$ vim /var/named/imooc.com.zone</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 7200</span><br><span class=\"line\">imooc.com. IN SOA imooc.com. jeson.imooc.com. (222 1H 15M 1W 1D)      <span class=\"comment\"># 注意邮箱的@的符用.代替,@在这里表示所有域名起始记录的解析. # 主从里面的同步参数 (222 1H 15M 1W 1D)</span></span><br><span class=\"line\">imooc.com. IN NS dns1.imooc.com.                                      <span class=\"comment\"># 内部的DNS域名解析器</span></span><br><span class=\"line\">dns1.imooc.com. IN A 192.168.205.131                                  <span class=\"comment\"># 在A记录中的二级域可以忽略不写,直接dns1</span></span><br><span class=\"line\">www.imooc.com. IN A 2.2.2.2                                           <span class=\"comment\"># authority section 权威部分</span></span><br></pre></td></tr></table></figure></p>\n<p>补充：重启服务如有报错请使用以下命令查看<code>tail -f /var/log/messages</code><br>PS : 访问测试软件 <code>dig 或者 nslookup</code></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126200907.png\" alt=\"WeiyiGeek.A记录效果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.A记录效果</p>\n            </figure>\n<p><br></p>\n<h4 id=\"示例2-采用Bind建立一个CNAME记录DNS服务器\"><a href=\"#示例2-采用Bind建立一个CNAME记录DNS服务器\" class=\"headerlink\" title=\"示例2.采用Bind建立一个CNAME记录DNS服务器\"></a>示例2.采用Bind建立一个CNAME记录DNS服务器</h4><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126201511.png\" alt=\"WeiyiGeek.示例2需求一览\" title=\"\" class=\"\">\n                <p>WeiyiGeek.示例2需求一览</p>\n            </figure>\n<p>配置示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># named.conf 配置</span></span><br><span class=\"line\">zone <span class=\"string\">\"iaskjob.com\"</span>&#123;</span><br><span class=\"line\">     <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">     file <span class=\"string\">\"iaskjob.com.zone\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改上面/var/named/imooc.com.zone文件将www的A记录IP地址替换成imooc的IP地址;</span></span><br><span class=\"line\">www.imooc.com. IN A 119.28.48.218</span><br><span class=\"line\"></span><br><span class=\"line\">$ vim /var/named/iaskjob.com.zone</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 7200</span><br><span class=\"line\">iaskjob.com. IN SOA isakjob.com. iaskjob.163.com. (4012100 1H 15M 1W 1D)</span><br><span class=\"line\">iaskjob.com. IN NS dns1.iaskjob.com.</span><br><span class=\"line\">dns1.iaskjob.com. IN A 192.168.199.202      <span class=\"comment\"># DNS 服务器地址</span></span><br><span class=\"line\">imooc.iaskjob.com. IN CNAME www.imooc.com.  <span class=\"comment\"># CNAME 别名记录</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126203315.png\" alt=\"WeiyiGeek.CNAME记录效果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.CNAME记录效果</p>\n            </figure>\n<p><br></p>\n<h4 id=\"示例3-采用Bind建立一个正向-反向解析DNS服务器\"><a href=\"#示例3-采用Bind建立一个正向-反向解析DNS服务器\" class=\"headerlink\" title=\"示例3.采用Bind建立一个正向/反向解析DNS服务器\"></a>示例3.采用Bind建立一个<code>正向/反向解析</code>DNS服务器</h4><p><strong>Q: 什么是正向与反向解析?</strong></p>\n<blockquote>\n<p>正向解析 : 即通过域名查找IP ，例如 A记录<br>反向解析 : 即通过IP查询对应的域名 ，例如 PTR 记录</p>\n</blockquote>\n<p><strong>正向解析(与上面的A记录配置差异不大)</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># named.conf</span></span><br><span class=\"line\">zone <span class=\"string\">\"imooc.com\"</span> IN &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">  file <span class=\"string\">\"imooc.com.zone\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># imooc.com.zone</span></span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 7200</span><br><span class=\"line\">imooc.com. IN SOA imooc.com. jeson.imooc.com. ( 222 1H 15M 1W 1D <span class=\"comment\"># jeson.imooc.com.其实为邮箱地址:jeson@imooc.com.</span></span><br><span class=\"line\">imooc.com. IN NS dns1.imooc.com.</span><br><span class=\"line\">dns1.imooc.com. IN A 172.16.102.14</span><br><span class=\"line\">@ IN MX 10 mail                <span class=\"comment\"># 邮箱mx解析,总是需要A记录的配合  10为优先级</span></span><br><span class=\"line\">mail IN A 172.16.102.14        <span class=\"comment\"># 内网地址为DNS服务主机的地址</span></span><br></pre></td></tr></table></figure></p>\n<p>测试：<code>dig @172.16.102.14 mail.imooc.com</code></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126204449.png\" alt=\"WeiyiGeek.正向解析\" title=\"\" class=\"\">\n                <p>WeiyiGeek.正向解析</p>\n            </figure>\n<p><br/></p>\n<p><strong>反向解析(重点)</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zone <span class=\"string\">\"102.16.172.in-addr.arpa\"</span> IN &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"102.16.172.zone\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># /var/named/102.16.172.zone</span></span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 3600</span><br><span class=\"line\"><span class=\"comment\">#  SOA起始记录解析,@代172.16.102这个段的主机</span></span><br><span class=\"line\">@ IN SOA 102.16.172.in-addr.arpa iaskjob.163.com. ( 2016012200 1H 15M 1W 1D ) </span><br><span class=\"line\">@ IN NS dns1.imooc.com.</span><br><span class=\"line\">14 IN PTR dns1.imooc.com.   <span class=\"comment\"># 表示 102.16.172.14 指向 dns.imooc.com</span></span><br><span class=\"line\">116 IN PTR mail.imooc.com.  <span class=\"comment\"># 表示 102.16.172.116 指向 mail.imooc.com</span></span><br></pre></td></tr></table></figure></p>\n<p>测试: <code>dig -x (反向解析使用) 172.16.102.116(在102.x这个段的主机) @172.16.102.14 (DNS服务主机)</code></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126205654.png\" alt=\"WeiyiGeek.反向解析\" title=\"\" class=\"\">\n                <p>WeiyiGeek.反向解析</p>\n            </figure>\n<p><br></p>\n<p>总结:</p>\n<ul>\n<li>(1) 逆向解析域<code>in-addr.arpa</code>的书写格式而反向解析<code>常常用于邮件服务的域名解析</code>;</li>\n<li>(2) 需要非常注意zone解析内容文件的权限必须要named用户可读取的;</li>\n</ul>\n<p><br></p>\n<h4 id=\"示例4-DNS递归迭代查询\"><a href=\"#示例4-DNS递归迭代查询\" class=\"headerlink\" title=\"示例4.DNS递归迭代查询\"></a>示例4.DNS递归迭代查询</h4><p>描述: 对于客户端来说发起一次请求、而服务端发起多次请求，示意图如下;</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127172628.png\" alt=\"WeiyiGeek.DNS递归迭代查询\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS递归迭代查询</p>\n            </figure>\n<p><strong>关键参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- recursion : yes | no : 是否允许递归请求;</span><br><span class=\"line\">- allow-recursion : &#123; address_match_list &#125; | any | none : 允许递归请求范围;</span><br><span class=\"line\">- recursive-clients : number : 客户端执行递归请求数量</span><br></pre></td></tr></table></figure></p>\n<p><strong>关键配置:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">options &#123;</span><br><span class=\"line\">  directory <span class=\"string\">\"/var/named\"</span>;</span><br><span class=\"line\">  recursion yes;</span><br><span class=\"line\">  recursive-clients 1024;</span><br><span class=\"line\">  allow-recursion any;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>Tips: 测试关闭递归查询<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim /etc/named.conf </span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">  directory <span class=\"string\">\"/var/named\"</span>;</span><br><span class=\"line\">  recursion no;   <span class=\"comment\"># recursion 参数 yes 启用 / no 不启用</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 进行查询并没能查询得到并且显示</span></span><br><span class=\"line\"><span class=\"comment\"># ;; WARNING: recursion requested but not available</span></span><br><span class=\"line\">dig @192.168.12.22 www.weiyigeek.top</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<ul>\n<li>基础示例5.DNS子域授权<br>描述: NS记录常常用于DNS子域授权以及迭代查询，示例图如下所示；</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127210705.png\" alt=\"WeiyiGeek.DNS子域\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS子域</p>\n            </figure>\n<p>例如: A服务负责(imooc.com)域名解析，授权B服务器子域(test.imooc.com)的域名解析，而S记录到子域的DNS服务器上,在用A记录指向DNS服务器IP;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">A服务器 : 父域   30.96.8.232</span><br><span class=\"line\">B服务器 : 子域   30.96.8.233</span><br></pre></td></tr></table></figure></p>\n<p>实践方式:<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#- 将test.imooc指向B服务器</span></span><br><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">vim</span> <span class=\"string\">imooc.com.zone</span></span><br><span class=\"line\"><span class=\"string\">test.imooc.com.</span> <span class=\"string\">IN</span> <span class=\"string\">NS</span> <span class=\"string\">ns1.test</span></span><br><span class=\"line\"><span class=\"string\">ns1.test</span> <span class=\"string\">IN</span> <span class=\"string\">A</span> <span class=\"number\">30.96</span><span class=\"number\">.8</span><span class=\"number\">.233</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 在子域B服务器上进行设置 named.conf 以及 test.imooc.com.zone</span></span><br><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">vim</span> <span class=\"string\">named.conf</span></span><br><span class=\"line\"><span class=\"string\">options</span> <span class=\"string\">&#123;</span></span><br><span class=\"line\">  <span class=\"string\">directory</span> <span class=\"string\">\"/var/named\"</span><span class=\"string\">;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">zone</span> <span class=\"string\">\"test.imooc.com\"</span> <span class=\"string\">&#123;</span></span><br><span class=\"line\">  <span class=\"string\">type</span> <span class=\"string\">master;</span></span><br><span class=\"line\">  <span class=\"string\">file</span> <span class=\"string\">\"test.imooc.com.zone\"</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">vim</span> <span class=\"string\">test.imooc.com.zone</span></span><br><span class=\"line\"><span class=\"string\">$TTL</span> <span class=\"number\">7200</span></span><br><span class=\"line\"><span class=\"string\">@</span> <span class=\"string\">IN</span> <span class=\"string\">SOA</span> <span class=\"string\">test.imooc.com.</span> <span class=\"string\">(1001</span> <span class=\"number\">1</span><span class=\"string\">H</span> <span class=\"number\">15</span><span class=\"string\">M</span> <span class=\"number\">1</span><span class=\"string\">W</span> <span class=\"number\">1</span><span class=\"string\">D)</span> </span><br><span class=\"line\"><span class=\"string\">@</span> <span class=\"string\">IN</span> <span class=\"string\">NS</span> <span class=\"string\">dns1</span></span><br><span class=\"line\"><span class=\"string\">dns1</span> <span class=\"string\">IN</span> <span class=\"string\">A</span> <span class=\"number\">30.96</span><span class=\"number\">.8</span><span class=\"number\">.233</span></span><br><span class=\"line\"><span class=\"string\">www</span> <span class=\"string\">IN</span> <span class=\"string\">A</span> <span class=\"number\">119.254</span><span class=\"number\">.210</span><span class=\"number\">.200</span></span><br></pre></td></tr></table></figure></p>\n<p>在B服务器子域上进行dig查询:<code>dig @30.96.8.233 www.test.imooc.com</code>, 此处已将授权给了B服务器的子域;</p>\n<p>PS : 但是imooc.com并没有授权所以还是父域的设置.</p>\n<p><br></p>\n<ul>\n<li>基础示例6.DNS 转发<br>描述: 通过DNS转发可以将负责某一个域的解析转发到另外一台DNS服务器上然后由其负责该域的权威解析,其示意图如下;<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127211543.png\" alt=\"WeiyiGeek.DNS转发示例图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS转发示例图</p>\n            </figure>\n</li>\n</ul>\n<p>关键参数解析:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">forwarders : &#123;address_list&#125;; : 转发的服务器列表</span><br><span class=\"line\">forwarder only : 只有目的服务器权限解析</span><br><span class=\"line\">forwarder first : 优先转发查询</span><br></pre></td></tr></table></figure></p>\n<p>DNS转发配置示例说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">master:10.156.11.232  <span class=\"comment\">#负责DNS某一个域进行转发</span></span><br><span class=\"line\">slave:10.156.11.233   <span class=\"comment\">#负责某一个域的权威解析</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 配置Slave这台服务器的权威解析, 更改 named.conf 和 iaskjob.com.zone</span></span><br><span class=\"line\">zone <span class=\"string\">\"askjob.com\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">  file <span class=\"string\">\"iaskjob.com.zone\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 7200</span><br><span class=\"line\">@ IN SOA iaskjob.com (222 1H 15M 1W 1D)</span><br><span class=\"line\">  IN NS dns</span><br><span class=\"line\">dns IN A 30.96.8.233</span><br><span class=\"line\">www IN A 5.5.5.5</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 配置Master这台服务器的DNS转发, 同样需要更改named.conf和iask job.com. zone</span></span><br><span class=\"line\">options&#123;</span><br><span class=\"line\">    directory <span class=\"string\">\"/var/named\"</span>;</span><br><span class=\"line\">    <span class=\"comment\"># forwarders &#123;对应的IP;&#125;;     #这个是对应全局的</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"iaskjob.com\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> forward;                <span class=\"comment\"># 转发 对应局部</span></span><br><span class=\"line\">    forwarders &#123;30.98.8.233;&#125;;   <span class=\"comment\"># 这个对应的是转发到哪一个DNS域转发器(forwarder的复数)</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127213023.png\" alt=\"WeiyiGeek.DNS转发-SLAVE服务器返回\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS转发-SLAVE服务器返回</p>\n            </figure>\n<p>PS : 如果要使用DNS域转发必须是<code>Bind 9</code>以后的版本;<br>PS : 如果要实现DNS转发生效的话, 必须将递归查询设置为NO (<code>Recursion No</code>)</p>\n<hr>\n<h3 id=\"4-进阶配置示例\"><a href=\"#4-进阶配置示例\" class=\"headerlink\" title=\"4) 进阶配置示例\"></a>4) 进阶配置示例</h3><h4 id=\"实例1-DNS主从区域传输介绍与配置\"><a href=\"#实例1-DNS主从区域传输介绍与配置\" class=\"headerlink\" title=\"实例1.DNS主从区域传输介绍与配置\"></a>实例1.DNS主从区域传输介绍与配置</h4><p>描述: 主服务器和从服务器介绍，从服务器即使从主服务器接收到其区域数据的副本，也仍然可以从本地存储的区域数据权威地回答查询，而无需递归。从服务器是它们所从属区域的权威服务器。</p>\n<p>在DNS中的区域分为<code>正向区域与反向区域</code>，而区域传输又分为<code>全量区域传输AXFR 和 增量区域传输IXFR</code></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127213447.png\" alt=\"WeiyiGeek.DNS主从同步原理\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS主从同步原理</p>\n            </figure>\n<p><strong>Q: DNS主从同步配置相关注意问题？</strong></p>\n<blockquote>\n<p>1.确保防火墙规则开放(建议关闭)<br>2.确保目录权限(系统默认named用户)<br>3.确保主从服务器时钟一致<br>4.搭建完毕后如若修改了主服务器域配置其Serail number 必须递增;</p>\n</blockquote>\n<p><strong>配置流程</strong></p>\n<ul>\n<li>Step 1.Master / Slave 服务器配置<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Master</span></span><br><span class=\"line\">zone <span class=\"string\">\"imooc.com\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> master;                <span class=\"comment\"># 关键点 </span></span><br><span class=\"line\">  notify yes;                 <span class=\"comment\"># 关键点 vt.通告，通知；公布</span></span><br><span class=\"line\">  also-notify &#123;30.96.8.233&#125;;  <span class=\"comment\"># 关键点 从DNS服务器IP</span></span><br><span class=\"line\">  file <span class=\"string\">\"imooc.com.zone\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Slave</span></span><br><span class=\"line\">zone <span class=\"string\">\"imooc.com\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> slave;                <span class=\"comment\"># 关键点</span></span><br><span class=\"line\">  also-notify &#123;30.96.8.232&#125;;  <span class=\"comment\"># 关键点 主DNS服务器IP</span></span><br><span class=\"line\">  file <span class=\"string\">\"slaves/imooc.com.zone\"</span> <span class=\"comment\">#  /var/named/slaves/imooc.com.zone</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : 修改zone后需要对<code>serial number</code>进行递增相加,来给从DNS服务器表示我们修改过zone从而进行同步.</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127215232.png\" alt=\"WeiyiGeek.主从同步配置\" title=\"\" class=\"\">\n                <p>WeiyiGeek.主从同步配置</p>\n            </figure>\n<p><br/></p>\n<h4 id=\"实例2-DNS区域传输限制\"><a href=\"#实例2-DNS区域传输限制\" class=\"headerlink\" title=\"实例2.DNS区域传输限制\"></a>实例2.DNS区域传输限制</h4><p><strong>Q: 为什么需要做区域限制传输?</strong></p>\n<blockquote>\n<p>答: 为了服务器的安全以及保护应用信息的敏感性;</p>\n</blockquote>\n<p>Q: DNS传送域漏洞的原理及其测试结果?<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ dig @127.0.0.1 www.imooc.com axfr       <span class=\"comment\"># 全量区域的数据传输</span></span><br><span class=\"line\">$ dig @127.0.0.1 www.imooc.com ixfr       <span class=\"comment\"># 增量区域的数据传输</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127215827.png\" alt=\"WeiyiGeek.DNS传送域漏洞\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS传送域漏洞</p>\n            </figure></p>\n<p>Q: 如何控制区域传输控制的方式?</p>\n<blockquote>\n<p>方式1.基于主机的访问控制 (常用)<br>方式2.事物签名(稍微复杂一点)</p>\n</blockquote>\n<p><br/></p>\n<p><strong>(1)DNS区域传输限制基于主机访问控制实现</strong><br>就是一句话指定主机访问<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zone <span class=\"string\">\"weiyigeek.top\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">  nofity yes;</span><br><span class=\"line\">  also-notify &#123; 30.96.8.233; &#125;;    <span class=\"comment\"># 从 DNS</span></span><br><span class=\"line\">  allow-transfer &#123; 30.96.8.233; &#125;  <span class=\"comment\"># 允许DNS与传输的机器IP地址列表</span></span><br><span class=\"line\">  file <span class=\"string\">\"imooc.com.zone\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>(2)DNS区域传输限制基于DNS加密传输</strong><br>描述:我们复习一下信息加密机DES(对称加密-RSA)、IDEA(非对称加密-DES);</p>\n<ul>\n<li><p>1.DES : 文件加密和解密使用相关的密钥,其优点是简单、快捷;</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127220607.png\" alt=\"WeiyiGeek.DES\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DES</p>\n            </figure>\n</li>\n<li><p>2.IDEA : 非对称加密其密钥报考公钥与私钥，其安全性较 DES 方式高(例如A方已经获取B方的公钥并采用其加密，到了B方其采用私钥解密);</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127222517.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n<p><strong>Q: DNS 事物签名加密分类?</strong></p>\n<ul>\n<li>TSIG：对称加密 <code>allow-transfer {key keyfile}</code> 事务签名的key</li>\n<li>SIG0：非对称加密 (IBM提出)</li>\n</ul>\n<p><em>1)配置TSIG对称加密流程</em></p>\n<ul>\n<li><p>Step 1.先在Master上进行公密匙的生成</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法</span></span><br><span class=\"line\">$ dnssec-keyge n<span class=\"_\">-a</span> HMAC-MD5 (加密方式) -b 128 (加密位数) -n HOST/ZONE (基于主机和域的方式) jeson.key (公密匙文件名) </span><br><span class=\"line\"><span class=\"comment\"># .key 为公匙</span></span><br><span class=\"line\"><span class=\"comment\"># .private 为密匙</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127222947.png\" alt=\"WeiyiGeek.dnssec-keyge\" title=\"\" class=\"\">\n                <p>WeiyiGeek.dnssec-keyge</p>\n            </figure>\n</li>\n<li><p>Step 2.添加内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim /var/named/chroot/etc/jeson-key</span><br><span class=\"line\"><span class=\"comment\"># Add Body(添加内容):</span></span><br><span class=\"line\">key <span class=\"string\">\"jeson-key\"</span> &#123;</span><br><span class=\"line\">     Algorithm HMAC-MD5;</span><br><span class=\"line\">     secret [Dnssec-keygen生成的公匙]  <span class=\"comment\"># 3Mc/XT........7IzYg==</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>step 3.修改named.conf文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include <span class=\"string\">\"/var/named/chroot/etc/jeson-key\"</span>;   <span class=\"comment\"># 注意文件名</span></span><br><span class=\"line\">zone <span class=\"string\">\"imooc.com\"</span> IN &#123;</span><br><span class=\"line\">        <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">        notify yes;</span><br><span class=\"line\">        also-notify &#123;172.16.102.16;&#125;;</span><br><span class=\"line\">        allow-transfer &#123; key <span class=\"string\">\"jeson-key\"</span>;&#125;;</span><br><span class=\"line\">        file <span class=\"string\">\"imooc.com.zone\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>此时MASTER设置完成；</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127223306.png\" alt=\"WeiyiGeek.Master-DNS\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Master-DNS</p>\n            </figure>\n</li>\n<li><p>Step 4.在Slave上进行密匙的配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ scp jeson-key (/var/named/chroot/etc/的文件) root@slave:`<span class=\"built_in\">pwd</span>`   <span class=\"comment\">#将公匙传入 SLAVE服务器中 `pwd` == /var/named/chroot/etc/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置 Named.conf</span></span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">  directory <span class=\"string\">\"/var/named\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">include <span class=\"string\">\"/var/named/chroot/etc/jeson-key\"</span>;   <span class=\"comment\"># 注意文件名</span></span><br><span class=\"line\">server 30.96.8.232 &#123;                         <span class=\"comment\"># 主DNS服务器</span></span><br><span class=\"line\">  keys &#123;<span class=\"string\">\"jeson-key\"</span>&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.com\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">  file <span class=\"string\">\"weiyigeek.com.zone\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"imooc.com\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> slave;</span><br><span class=\"line\">  masters &#123;30.96.8.232;&#125;;</span><br><span class=\"line\">  file <span class=\"string\">\"slaves/imooc.com.zone\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 5.验证搭建然后在Slave服务上看看新增加的wec域名的A记录，</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Oct 30 13:15:59 localhost named[4860]: client 172.16.102.16<span class=\"comment\">#52942: transfer of 'imooc.com/IN': AXFR-style IXFR started: TSIG jeson-key</span></span><br><span class=\"line\">Oct 30 13:15:59 localhost named[4860]: client 172.16.102.16<span class=\"comment\">#52942: transfer of 'imooc.com/IN': AXFR-style IXFR ended</span></span><br><span class=\"line\">Oct 30 13:15:59 localhost named[4860]: client 172.16.102.16<span class=\"comment\">#54395: received notify for zone 'imooc.com': TSIG 'jeson-key'</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201127223951.png\" alt=\"WeiyiGeek.执行效果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.执行效果</p>\n            </figure>\n<p><br/></p>\n<h4 id=\"实例3-DNS部分二级域名解析\"><a href=\"#实例3-DNS部分二级域名解析\" class=\"headerlink\" title=\"实例3.DNS部分二级域名解析\"></a>实例3.DNS部分二级域名解析</h4><p>实验目的: 实现部分二级域名的解析而非全域;</p>\n<p>例如针对于 vcsa.weiyigeek.top 的解析：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 主配置 named.conf 文件:</span></span><br><span class=\"line\">zone <span class=\"string\">\"vcsa.weiyigeek.top\"</span> &#123;</span><br><span class=\"line\">   <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">   file <span class=\"string\">\"private/vcsa.weiyigeek.top.zone\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 区域空间: </span></span><br><span class=\"line\">$ cat /var/named/private/vcsa.weiyigeek.top.zone</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 7200</span><br><span class=\"line\">@ IN SOA ns.weiyigeek.top. root.weiyigeek.top. (</span><br><span class=\"line\">                                         20201201</span><br><span class=\"line\">                                         3600</span><br><span class=\"line\">                                         1200</span><br><span class=\"line\">                                         84600</span><br><span class=\"line\">                                         1200</span><br><span class=\"line\">                                        )</span><br><span class=\"line\">@ IN NS ns</span><br><span class=\"line\">ns IN A 192.168.12.253</span><br><span class=\"line\">@ 640 IN A 192.168.12.251</span><br><span class=\"line\">t 641 IN A 192.168.12.250</span><br><span class=\"line\">v 642 IN CNAME vcsa.weiyigeek.top.</span><br></pre></td></tr></table></figure></p>\n<p>验证配置与启动：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-253:~<span class=\"comment\"># named-checkzone vcsa.weiyigeek.top /var/named/private/vcsa.weiyigeek.top.zone</span></span><br><span class=\"line\">  <span class=\"comment\"># zone vcsa.weiyigeek.top/IN: loaded serial 20201201</span></span><br><span class=\"line\">  <span class=\"comment\"># OK</span></span><br><span class=\"line\">root@ubuntu-253:~<span class=\"comment\"># named-checkconf</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Debug 启动信息查看</span></span><br><span class=\"line\">$ named -u named -g </span><br><span class=\"line\">  <span class=\"comment\"># 01-Dec-2020 15:50:17.862 zone weiyigeek.top/IN: sending notifies (serial 20200711)</span></span><br><span class=\"line\">  <span class=\"comment\"># 01-Dec-2020 15:50:17.862 zone vcsa.weiyigeek.top/IN: sending notifies (serial 20201201)</span></span><br><span class=\"line\">  <span class=\"comment\"># 01-Dec-2020 15:50:17.862 zone 12.168.192.in-addr.arpa/IN: sending notifies (serial 20200712)</span></span><br></pre></td></tr></table></figure></p>\n<p>测试结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 子域名 NS 记录查看</span></span><br><span class=\"line\">$ dig ns vcsa.weiyigeek.top @192.168.12.253</span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># vcsa.weiyigeek.top.       7200    IN      NS      ns.vcsa.weiyigeek.top.</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ADDITIONAL SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ns.vcsa.weiyigeek.top.    7200    IN      A       192.168.12.253</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 子域名 A 记录查看</span></span><br><span class=\"line\">$ dig vcsa.weiyigeek.top @192.168.12.253</span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># vcsa.weiyigeek.top.       577     IN      A       192.168.12.251</span></span><br><span class=\"line\">$ dig t.vcsa.weiyigeek.top @192.168.12.253</span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># t.vcsa.weiyigeek.top.     641     IN      A       192.168.12.250</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 子域名 CNAME 记录查看</span></span><br><span class=\"line\">$ dig v.vcsa.weiyigeek.top @192.168.12.253</span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># v.vcsa.weiyigeek.top.     642     IN      CNAME   vcsa.weiyigeek.top.</span></span><br><span class=\"line\">  <span class=\"comment\"># vcsa.weiyigeek.top.       640     IN      A       192.168.12.251</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 其他子域名不影响访问 </span></span><br><span class=\"line\">$ dig s.weiyigeek.top @192.168.12.253</span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># s.weiyigeek.top.          282     IN      A       21.129.126.213</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x04-DNS服务命令\"><a href=\"#0x04-DNS服务命令\" class=\"headerlink\" title=\"0x04 DNS服务命令\"></a>0x04 DNS服务命令</h2><h3 id=\"named-命令\"><a href=\"#named-命令\" class=\"headerlink\" title=\"named 命令\"></a>named 命令</h3><p>描述: named 是一个域名系统(DNS)服务器，ISC的BIND 9发行版的一部分。同时 named 可执行文件也是互联网域名服务器服务端配置命令。</p>\n<p>有关DNS的更多信息，请参见<code>RFC 1033、RFC 1034</code>和<code>RFC 1035</code>;</p>\n<p><strong>Syntax &amp; Options</strong>:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法</span></span><br><span class=\"line\">named  [ [-4] | [-6] ] [-c config-file] [-d debug-level] [-D string] [-E engine-name] [-f] [-g] [-L logfile] [-M option] [-m flag] [-n <span class=\"comment\">#cpus] [-p port] [-s] [-S #max-socks] [-t directory] [-U #listeners] [-u user] [-v] [-V] [-X lock-file] [-x cache-file]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 选项</span></span><br><span class=\"line\">-4  <span class=\"comment\"># 即使主机能够使用IPv6，也只能使用IPv4。-4和-6互斥。</span></span><br><span class=\"line\">-6  <span class=\"comment\"># 即使主机能够使用IPv4，也只能使用IPv6。-4和-6互斥。</span></span><br><span class=\"line\">-c config-file <span class=\"comment\"># 指定named.conf配置文件路径，如果不指定则默认为/etc/named.conf</span></span><br><span class=\"line\">-d debug-level <span class=\"comment\"># 将守护进程的调试级别设置为调试级别。随着调试级别的增加，已命名的调试跟踪会变得更加冗长。</span></span><br><span class=\"line\">-D string <span class=\"comment\"># 指定用于标识流程清单中named实例的字符串。不检查字符串的内容。</span></span><br><span class=\"line\">-E engine-name <span class=\"comment\"># 适用时，指定用于加密操作的硬件，如用于签名的安全密钥存储区。当使用OpenSSL PKCS#11支持构建BIND时，默认为字符串“pkcs11”，它标识可以驱动加密加速器的OpenSSL引擎或</span></span><br><span class=\"line\">-f <span class=\"comment\"># 在前台运行服务器(例如，不要守护进程)。</span></span><br><span class=\"line\">-g <span class=\"comment\"># 在前台运行服务器并强制将所有日志记录到stderr。</span></span><br><span class=\"line\">-L logfile <span class=\"comment\"># 默认情况下日志文件，而不是系统日志。</span></span><br><span class=\"line\">-M option <span class=\"comment\"># external(支持系统提供的内存分配功能规划设计) , fill(内存块将在分配或释放时被标记值填充，以帮助调试内存问题)</span></span><br><span class=\"line\">-m flag  <span class=\"comment\"># 可能的标志有使用量、跟踪、记录、大小和mctx。</span></span><br><span class=\"line\">-n cpus  <span class=\"comment\"># 如果没有指定，named将尝试确定当前的CPU数量，并为每个CPU创建一个线程。如果无法确定cpu的数量，将创建一个工作线程。</span></span><br><span class=\"line\">-p port <span class=\"comment\"># 监听端口默认53</span></span><br><span class=\"line\">-s <span class=\"comment\"># 在退出时将内存使用统计信息写入stdout。</span></span><br><span class=\"line\">-S <span class=\"comment\"># max-socks #(使用时需要注意)在使用默认配置选项构建的系统上，默认值是21000，在使用“configure——with-tuning=small”构建的系统上，默认值是4096。</span></span><br><span class=\"line\">-t directory  <span class=\"comment\"># Chroot到目录后处理命令行参数，但在阅读配置文件之前。</span></span><br><span class=\"line\">-U <span class=\"comment\">#listeners # 如果未指定，则named将根据检测到的数目计算默认值CPU</span></span><br><span class=\"line\">-u user <span class=\"comment\"># 在完成特权操作(例如创建监听特权端口的套接字)后，将Setuid设置为用户。</span></span><br><span class=\"line\">-v  <span class=\"comment\"># Report the version number and exit.</span></span><br><span class=\"line\">-V  <span class=\"comment\"># Report the version number and build options, and exit.</span></span><br><span class=\"line\">-X lock-file <span class=\"comment\"># 有助于防止重复命名的实例同时运行。使用此选项(将覆盖name .conf中的锁文件选项。如果设置为none锁定文件检查将被禁用。</span></span><br><span class=\"line\">-x cache-file <span class=\"comment\">#将数据从缓存文件加载到默认视图的缓存中。(不建议使用此选项)</span></span><br><span class=\"line\">          </span><br><span class=\"line\"><span class=\"comment\"># SIGNALS 信号 (向服务器发送任何其他信号的结果是未定义的。)</span></span><br><span class=\"line\">SIGHUP Force a reload of the server.</span><br><span class=\"line\">SIGINT, SIGTERM  Shut down the server.</span><br></pre></td></tr></table></figure></p>\n<p>依赖配置文件:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/named.conf          <span class=\"comment\"># The default configuration file.</span></span><br><span class=\"line\">/var/run/named/named.pid <span class=\"comment\"># The default process-id file.</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"named-checkconf-命令\"><a href=\"#named-checkconf-命令\" class=\"headerlink\" title=\"named-checkconf 命令\"></a>named-checkconf 命令</h3><p>描述 : named-checkconf - named 配置文件语法检查工具即检查配置文件是否有语法错误</p>\n<p>Tips : named-checkconf检查命名配置文件的语法，而不是语义。解析文件并检查语法错误，以及它包含的所有文件。如果未指定文件，则输入<code>/etc/named.conf</code>默认为读取。</p>\n<p><strong>语法参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">named-checkconf [-chjlvz] [-p [-x ]] [-t directory] &#123;filename&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">OPTIONS</span><br><span class=\"line\">  -h <span class=\"comment\">#Print the usage summary and exit.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -j <span class=\"comment\"># When loading a zonefile read the journal if it exists.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -l <span class=\"comment\"># List all the configured zones. Each line of output contains the zone name, class (e.g. IN), view, and type</span></span><br><span class=\"line\">      (e.g. master or slave).</span><br><span class=\"line\"></span><br><span class=\"line\">  -c <span class=\"comment\"># Check \"core\" configuration only. This suppresses the loading of plugin modules, and causes all parameters to plugin statements to be ignored.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -i <span class=\"comment\"># Ignore warnings on deprecated options.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -p <span class=\"comment\"># Print out the named.conf and included files in canonical form if no errors were detected. See also the -x option.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -t directory  <span class=\"comment\">#Chroot to directory so that include directives in the configuration file are processed as if run by a  similarly chrooted named.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -v <span class=\"comment\"># Print the version of the named-checkconf program and exit.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -x <span class=\"comment\"># When printing the configuration files in canonical form, obscure shared secrets by replacing them with strings of question marks ('?'). This allows the contents of named.conf and related files to be shared — for example, when submitting bug reports — without compromising private data. This option cannot be used without -p.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  -z <span class=\"comment\"># Perform a test load of all master zones found in named.conf.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  filename <span class=\"comment\">#The name of the configuration file to be checked. If not specified, it defaults to /etc/named.conf.</span></span><br></pre></td></tr></table></figure></p>\n<p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 常规测试named.conf进行配置</span></span><br><span class=\"line\">/etc/<span class=\"built_in\">bind</span>$ named-checkconf  /etc/<span class=\"built_in\">bind</span>/named.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 对named.conf中找到的所有主区域执行测试负载。</span></span><br><span class=\"line\">$ named-checkconf -z  /etc/<span class=\"built_in\">bind</span>/named.conf</span><br><span class=\"line\">  <span class=\"comment\"># zone weiyigeek.cn/IN: loaded serial 3</span></span><br><span class=\"line\">  <span class=\"comment\"># zone weiyigeek.top/IN: loaded serial 2</span></span><br><span class=\"line\">  <span class=\"comment\"># zone 168.192.in-addr.arpa/IN: loaded serial 4</span></span><br><span class=\"line\">  <span class=\"comment\"># zone 12.168.192.in-addr.arpa/IN: loaded serial 1</span></span><br><span class=\"line\">  <span class=\"comment\"># zone localhost/IN: loaded serial 2</span></span><br><span class=\"line\">  <span class=\"comment\"># zone 127.in-addr.arpa/IN: loaded serial 1</span></span><br><span class=\"line\">  <span class=\"comment\"># zone 0.in-addr.arpa/IN: loaded serial 1</span></span><br><span class=\"line\">  <span class=\"comment\"># zone 255.in-addr.arpa/IN: loaded serial 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) named以及包含文件配置文件无错误则输出所有配置参数项</span></span><br><span class=\"line\">$ named-checkconf -p</span><br><span class=\"line\">acl <span class=\"string\">\"trusted\"</span> &#123;</span><br><span class=\"line\">  <span class=\"string\">\"localhost\"</span>;</span><br><span class=\"line\">  10.0.0.0/8;</span><br><span class=\"line\">  192.168.0.0/16;</span><br><span class=\"line\">  172.16.0.0/16;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">  directory <span class=\"string\">\"/var/cache/bind\"</span>;</span><br><span class=\"line\">  listen-on-v6 &#123;</span><br><span class=\"line\">          <span class=\"string\">\"any\"</span>;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  allow-query-cache &#123;</span><br><span class=\"line\">          <span class=\"string\">\"any\"</span>;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  auth-nxdomain no;</span><br><span class=\"line\">  dnssec-validation no;</span><br><span class=\"line\">  allow-query &#123;</span><br><span class=\"line\">          <span class=\"string\">\"any\"</span>;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  forwarders &#123;</span><br><span class=\"line\">          223.6.6.6;</span><br><span class=\"line\">          223.5.5.5;</span><br><span class=\"line\">          114.114.114.114;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.cn\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"db.weiyigeek.cn\"</span>;</span><br><span class=\"line\">    allow-transfer &#123;</span><br><span class=\"line\">     trusted;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.top\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"db.weiyigeek.top\"</span>;</span><br><span class=\"line\">    allow-transfer &#123;</span><br><span class=\"line\">      trusted;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"db.168.192\"</span>;</span><br><span class=\"line\">    allow-transfer &#123;</span><br><span class=\"line\">      trusted;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"12.168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"db.12.168.192\"</span>;</span><br><span class=\"line\">    allow-transfer &#123;</span><br><span class=\"line\">       trusted;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\".\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> hint;</span><br><span class=\"line\">    file <span class=\"string\">\"/usr/share/dns/root.hints\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"localhost\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"/etc/bind/db.local\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"127.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"/etc/bind/db.127\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"0.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"/etc/bind/db.0\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"255.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"/etc/bind/db.255\"</span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"named-checkzone-命令\"><a href=\"#named-checkzone-命令\" class=\"headerlink\" title=\"named-checkzone 命令\"></a>named-checkzone 命令</h3><h3 id=\"named-compilezone-命令\"><a href=\"#named-compilezone-命令\" class=\"headerlink\" title=\"named-compilezone 命令\"></a>named-compilezone 命令</h3><p>描述: <code>named-checkzone, named-compilezone</code> - zone文件有效性检查或转换工具</p>\n<ul>\n<li>named-checkzone 检查区域文件的语法和完整性。它执行与named相同的检查<br>加载区。这使得named-checkzone在将区域文件配置为名称之前检查它们非常有用<br>服务器。</li>\n<li>named-compilezone 与前者类似，但它总是将区域内容转储到指定的文件中指定的格式。此外，它在默认情况下应用更严格的检查级别，因为转储输出将为作为一个实际的区域文件，由named加载。手动指定时，检查级别必须至少与指定的配置文件中指定的一样严格。</li>\n</ul>\n<p><br/></p>\n<p><strong>语法参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法</span></span><br><span class=\"line\">named-checkzone [-d] [-h] [-j] [-q] [-v] [-c class] [-f format] [-F format] [-J filename] [-i mode] [-k mode]</span><br><span class=\"line\">                [-m mode] [-M mode] [-n mode] [-l ttl] [-L serial] [-o filename] [-r mode] [-s style]</span><br><span class=\"line\">                [-S mode] [-t directory] [-T mode] [-w directory] [-D] [-W mode] &#123;zonename&#125; &#123;filename&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">named-compilezone [-d] [-j] [-q] [-v] [-c class] [-C mode] [-f format] [-F format] [-J filename] [-i mode]</span><br><span class=\"line\">                  [-k mode] [-m mode] [-n mode] [-l ttl] [-L serial] [-r mode] [-s style] [-t directory]</span><br><span class=\"line\">                  [-T mode] [-w directory] [-D] [-W mode] &#123;-o filename&#125; &#123;zonename&#125; &#123;filename&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数</span></span><br><span class=\"line\">OPTIONS</span><br><span class=\"line\">       -d</span><br><span class=\"line\">           Enable debugging.</span><br><span class=\"line\"></span><br><span class=\"line\">       -h</span><br><span class=\"line\">           Print the usage summary and <span class=\"built_in\">exit</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -q</span><br><span class=\"line\">           Quiet mode - <span class=\"built_in\">exit</span> code only.</span><br><span class=\"line\"></span><br><span class=\"line\">       -v</span><br><span class=\"line\">           Print the version of the named-checkzone program and <span class=\"built_in\">exit</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -j</span><br><span class=\"line\">           When loading a zone file, <span class=\"built_in\">read</span> the journal <span class=\"keyword\">if</span> it exists. The journal file name is assumed to be the zonefile name appended with the string .jnl.</span><br><span class=\"line\"></span><br><span class=\"line\">       -J filename</span><br><span class=\"line\">           When loading the zone file <span class=\"built_in\">read</span> the journal from the given file, <span class=\"keyword\">if</span> it exists. (Implies -j.)</span><br><span class=\"line\"></span><br><span class=\"line\">       -c class</span><br><span class=\"line\">           Specify the class of the zone. If not specified, <span class=\"string\">\"IN\"</span> is assumed.</span><br><span class=\"line\"></span><br><span class=\"line\">       -i mode</span><br><span class=\"line\">           Perform post-load zone integrity checks. Possible modes are <span class=\"string\">\"full\"</span> (default), <span class=\"string\">\"full-sibling\"</span>, <span class=\"string\">\"local\"</span>,</span><br><span class=\"line\">           <span class=\"string\">\"local-sibling\"</span> and <span class=\"string\">\"none\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">           Mode <span class=\"string\">\"full\"</span> checks that MX records refer to A or AAAA record (both <span class=\"keyword\">in</span>-zone and out-of-zone hostnames).</span><br><span class=\"line\">           Mode <span class=\"string\">\"local\"</span> only checks MX records <span class=\"built_in\">which</span> refer to <span class=\"keyword\">in</span>-zone hostnames.</span><br><span class=\"line\"></span><br><span class=\"line\">           Mode <span class=\"string\">\"full\"</span> checks that SRV records refer to A or AAAA record (both <span class=\"keyword\">in</span>-zone and out-of-zone hostnames).</span><br><span class=\"line\">           Mode <span class=\"string\">\"local\"</span> only checks SRV records <span class=\"built_in\">which</span> refer to <span class=\"keyword\">in</span>-zone hostnames.</span><br><span class=\"line\"></span><br><span class=\"line\">           Mode <span class=\"string\">\"full\"</span> checks that delegation NS records refer to A or AAAA record (both <span class=\"keyword\">in</span>-zone and out-of-zone</span><br><span class=\"line\">           hostnames). It also checks that glue address records <span class=\"keyword\">in</span> the zone match those advertised by the child. Mode</span><br><span class=\"line\">           <span class=\"string\">\"local\"</span> only checks NS records <span class=\"built_in\">which</span> refer to <span class=\"keyword\">in</span>-zone hostnames or that some required glue exists, that is</span><br><span class=\"line\">           when the nameserver is <span class=\"keyword\">in</span> a child zone.</span><br><span class=\"line\"></span><br><span class=\"line\">           Mode <span class=\"string\">\"full-sibling\"</span> and <span class=\"string\">\"local-sibling\"</span> <span class=\"built_in\">disable</span> sibling glue checks but are otherwise the same as <span class=\"string\">\"full\"</span></span><br><span class=\"line\">           and <span class=\"string\">\"local\"</span> respectively.</span><br><span class=\"line\"></span><br><span class=\"line\">           Mode <span class=\"string\">\"none\"</span> disables the checks.</span><br><span class=\"line\"></span><br><span class=\"line\">       -f format</span><br><span class=\"line\">           Specify the format of the zone file. Possible formats are <span class=\"string\">\"text\"</span> (default), <span class=\"string\">\"raw\"</span>, and <span class=\"string\">\"map\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -F format</span><br><span class=\"line\">           Specify the format of the output file specified. For named-checkzone, this does not cause any effects</span><br><span class=\"line\">           unless it dumps the zone contents.</span><br><span class=\"line\"></span><br><span class=\"line\">           Possible formats are <span class=\"string\">\"text\"</span> (default), <span class=\"built_in\">which</span> is the standard textual representation of the zone, and</span><br><span class=\"line\">           <span class=\"string\">\"map\"</span>, <span class=\"string\">\"raw\"</span>, and <span class=\"string\">\"raw=N\"</span>, <span class=\"built_in\">which</span> store the zone <span class=\"keyword\">in</span> a binary format <span class=\"keyword\">for</span> rapid loading by named.  <span class=\"string\">\"raw=N\"</span></span><br><span class=\"line\">           specifies the format version of the raw zone file: <span class=\"keyword\">if</span> N is 0, the raw file can be <span class=\"built_in\">read</span> by any version of</span><br><span class=\"line\">           named; <span class=\"keyword\">if</span> N is 1, the file can be <span class=\"built_in\">read</span> by release 9.9.0 or higher; the default is 1.</span><br><span class=\"line\">        -l ttl</span><br><span class=\"line\">           Sets a maximum permissible TTL <span class=\"keyword\">for</span> the input file. Any record with a TTL higher than this value will cause</span><br><span class=\"line\">           the zone to be rejected. This is similar to using the max-zone-ttl option <span class=\"keyword\">in</span> named.conf.</span><br><span class=\"line\"></span><br><span class=\"line\">       -L serial</span><br><span class=\"line\">           When compiling a zone to <span class=\"string\">\"raw\"</span> or <span class=\"string\">\"map\"</span> format, <span class=\"built_in\">set</span> the <span class=\"string\">\"source serial\"</span> value <span class=\"keyword\">in</span> the header to the</span><br><span class=\"line\">           specified serial number. (This is expected to be used primarily <span class=\"keyword\">for</span> testing purposes.)</span><br><span class=\"line\"></span><br><span class=\"line\">       -m mode</span><br><span class=\"line\">           Specify whether MX records should be checked to see <span class=\"keyword\">if</span> they are addresses. Possible modes are <span class=\"string\">\"fail\"</span>,</span><br><span class=\"line\">           <span class=\"string\">\"warn\"</span> (default) and <span class=\"string\">\"ignore\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -M mode</span><br><span class=\"line\">           Check <span class=\"keyword\">if</span> a MX record refers to a CNAME. Possible modes are <span class=\"string\">\"fail\"</span>, <span class=\"string\">\"warn\"</span> (default) and <span class=\"string\">\"ignore\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -n mode</span><br><span class=\"line\">           Specify whether NS records should be checked to see <span class=\"keyword\">if</span> they are addresses. Possible modes are <span class=\"string\">\"fail\"</span></span><br><span class=\"line\">           (default <span class=\"keyword\">for</span> named-compilezone), <span class=\"string\">\"warn\"</span> (default <span class=\"keyword\">for</span> named-checkzone) and <span class=\"string\">\"ignore\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -o filename</span><br><span class=\"line\">           Write zone output to filename. If filename is - <span class=\"keyword\">then</span> write to standard out. This is mandatory <span class=\"keyword\">for</span></span><br><span class=\"line\">           named-compilezone.</span><br><span class=\"line\"></span><br><span class=\"line\">       -r mode</span><br><span class=\"line\">           Check <span class=\"keyword\">for</span> records that are treated as different by DNSSEC but are semantically equal <span class=\"keyword\">in</span> plain DNS. Possible modes are <span class=\"string\">\"fail\"</span>, <span class=\"string\">\"warn\"</span> (default) and <span class=\"string\">\"ignore\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -s style</span><br><span class=\"line\">           Specify the style of the dumped zone file. Possible styles are <span class=\"string\">\"full\"</span> (default) and <span class=\"string\">\"relative\"</span>. The full</span><br><span class=\"line\">           format is most suitable <span class=\"keyword\">for</span> processing automatically by a separate script. On the other hand, the relative</span><br><span class=\"line\">           format is more human-readable and is thus suitable <span class=\"keyword\">for</span> editing by hand. For named-checkzone this does not</span><br><span class=\"line\">           cause any effects unless it dumps the zone contents. It also does not have any meaning <span class=\"keyword\">if</span> the output</span><br><span class=\"line\">           format is not text.</span><br><span class=\"line\"></span><br><span class=\"line\">       -S mode</span><br><span class=\"line\">           Check <span class=\"keyword\">if</span> a SRV record refers to a CNAME. Possible modes are <span class=\"string\">\"fail\"</span>, <span class=\"string\">\"warn\"</span> (default) and <span class=\"string\">\"ignore\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -t directory</span><br><span class=\"line\">           Chroot to directory so that include directives <span class=\"keyword\">in</span> the configuration file are processed as <span class=\"keyword\">if</span> run by a</span><br><span class=\"line\">           similarly chrooted named.</span><br><span class=\"line\"></span><br><span class=\"line\">       -T mode</span><br><span class=\"line\">           Check <span class=\"keyword\">if</span> Sender Policy Framework (SPF) records exist and issues a warning <span class=\"keyword\">if</span> an SPF-formatted TXT record</span><br><span class=\"line\">           is not also present. Possible modes are <span class=\"string\">\"warn\"</span> (default), <span class=\"string\">\"ignore\"</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">       -w directory</span><br><span class=\"line\">           <span class=\"built_in\">chdir</span> to directory so that relative filenames <span class=\"keyword\">in</span> master file <span class=\"variable\">$INCLUDE</span> directives work. This is similar to</span><br><span class=\"line\">           the directory clause <span class=\"keyword\">in</span> named.conf.</span><br><span class=\"line\"></span><br><span class=\"line\">       -D</span><br><span class=\"line\">           Dump zone file <span class=\"keyword\">in</span> canonical format. This is always enabled <span class=\"keyword\">for</span> named-compilezone.</span><br><span class=\"line\"></span><br><span class=\"line\">       -W mode</span><br><span class=\"line\">           Specify whether to check <span class=\"keyword\">for</span> non-terminal wildcards. Non-terminal wildcards are almost always the result</span><br><span class=\"line\">           of a failure to understand the wildcard matching algorithm (RFC 1034). Possible modes are <span class=\"string\">\"warn\"</span> (default)</span><br><span class=\"line\">           and <span class=\"string\">\"ignore\"</span>.</span><br></pre></td></tr></table></figure></p>\n<p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 对区域文件/var/cache/bind/db.weiyigeek.top进行有效性检查和转换。</span></span><br><span class=\"line\">~<span class=\"comment\"># named-checkzone db.weiyigeek.top /var/cache/bind/db.weiyigeek.top</span></span><br><span class=\"line\">zone db.weiyigeek.top/IN: loaded serial 2</span><br><span class=\"line\">OK</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) named-compilezone 编译 zone 会对 zone 文件做一个备份</span></span><br><span class=\"line\">$ named-compilezone -o test.zone db.12.168.192 /var/cache/<span class=\"built_in\">bind</span>/db.12.168.192</span><br><span class=\"line\">  <span class=\"comment\"># zone db.12.168.192/IN: loaded serial 1</span></span><br><span class=\"line\">  <span class=\"comment\"># dump zone to test.zone...done</span></span><br><span class=\"line\">  <span class=\"comment\"># OK</span></span><br><span class=\"line\">$ /var/cache/<span class=\"built_in\">bind</span><span class=\"comment\"># cat test.zone</span></span><br><span class=\"line\">  <span class=\"comment\"># db.12.168.192.                                604800 IN SOA     weiyigeek.top. admin.weiyigeek.top. 1 604800 86400 2419200 604800</span></span><br><span class=\"line\">  <span class=\"comment\"># db.12.168.192.                                604800 IN NS      ns1.weiyigeek.top.</span></span><br><span class=\"line\">  <span class=\"comment\"># db.12.168.192.                                604800 IN NS      ns2.weiyigeek.top.</span></span><br><span class=\"line\">  <span class=\"comment\"># 13.db.12.168.192.                             604800 IN PTR     s.weiyigeek.top.</span></span><br><span class=\"line\">  <span class=\"comment\"># 18.db.12.168.192.                             604800 IN PTR     www.weiyigeek.top.</span></span><br><span class=\"line\">  <span class=\"comment\"># 254.db.12.168.192.                            604800 IN PTR     ns1.weiyigeek.top.</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"tsig-keygen-命令\"><a href=\"#tsig-keygen-命令\" class=\"headerlink\" title=\"tsig-keygen 命令\"></a>tsig-keygen 命令</h3><p>描述: ddns-confgen - TSIG密钥生成工具, TSIG -keygen 和 ddns-confgen 是用于生成用于TSIG签名的密钥的实用程序的调用方法。例如，生成的密钥可以用于保护对区域的动态DNS更新，或者用于rndc命令通道。</p>\n<ul>\n<li>使用tsig-keygen命令时，可以在命令行中指定一个域名作为生成密钥的名称。如果未指定名称，则缺省值为“tsig-key”。</li>\n<li>当使用ddns-confgen命令时，可以使用-k参数指定密钥名，默认为ddns-key。生成的密钥附带配置文本和指令，可以与nsupdate一起使用，并在设置动态DNS时进行命名，包括一个示例update-policy语句。(此用法类似于用于设置命令通道安全性的rndc-confgen命令。)</li>\n</ul>\n<p>Tips : named本身可以配置一个本地DDNS key来使用nsupdate -l; 当一个区域被配置为update-policy local;时，它会这样做。ddns-confgen只在需要更详细的配置时才需要,例如如果要从远程系统使用nsupdate。</p>\n<p><strong>语法参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tsig-keygen [-a algorithm] [-h] [-r randomfile] [name]</span><br><span class=\"line\">ddns-confgen [-a algorithm] [-h] [-k keyname] [-q] [-r randomfile] [-s name] [-z zone]</span><br><span class=\"line\"></span><br><span class=\"line\">-a algorithm</span><br><span class=\"line\">  This option specifies the algorithm to use <span class=\"keyword\">for</span> the TSIG key. Available choices are: hmac-md5, hmac-sha1, hmac-sha224, hmac-sha256, hmac-sha384, and hmac-sha512. The default is hmac-sha256. Options are <span class=\"keyword\">case</span>-insensitive, and the “hmac-” prefix may be omitted.</span><br><span class=\"line\">-h</span><br><span class=\"line\">  This option prints a short summary of options and arguments.</span><br><span class=\"line\">-k keyname</span><br><span class=\"line\">  This option specifies the key name of the DDNS authentication key. The default is ddns-key when neither the -s nor -z option is specified; otherwise, the default is ddns-key as a separate label followed by the argument of the option, e.g., ddns-key.example.com. The key name must have the format of a valid domain name, consisting of letters, digits, hyphens, and periods.</span><br><span class=\"line\">-q (ddns-confgen only)</span><br><span class=\"line\">  This option enables quiet mode, <span class=\"built_in\">which</span> prints only the key, with no explanatory text or usage examples. This is essentially identical to tsig-keygen.</span><br><span class=\"line\">-s name (ddns-confgen only)</span><br><span class=\"line\">  This option generates a configuration example to allow dynamic updates of a single hostname. The example named.conf text shows how to <span class=\"built_in\">set</span> an update policy <span class=\"keyword\">for</span> the specified name using the “name” nametype. The default key name is ddns-key.name. Note that the “self” nametype cannot be used, since the name to be updated may differ from the key name. This option cannot be used with the -z option.</span><br><span class=\"line\">-z zone (ddns-confgen only)</span><br><span class=\"line\">  This option generates a configuration example to allow dynamic updates of a zone. The example named.conf text shows how to <span class=\"built_in\">set</span> an update policy <span class=\"keyword\">for</span> the specified zone using the “zonesub” nametype, allowing updates to all subdomain names within that zone. This option cannot be used with the -s option.</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"DNS","path":"api/categories/DNS.json"},{"name":"域名解析","path":"api/categories/域名解析.json"}],"tags":[{"name":"Bind","path":"api/tags/Bind.json"}]}