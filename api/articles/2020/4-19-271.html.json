{"title":"1.基于GitLab代码仓库的持续集成基础配置和使用","slug":"系统运维/自动化运维/CI-CD/GitLab-CI/1.基于GitLab代码仓库的持续集成基础配置和使用","date":"2020-04-19T12:35:30.000Z","updated":"2023-01-31T02:29:10.467Z","url":"2020/4-19-271.html","path":"api/articles/2020/4-19-271.html.json","covers":["https://img.weiyigeek.top/2020/1/20200416171549.png","https://img.weiyigeek.top/2020/1/20200416173843.png","https://img.weiyigeek.top/2020/1/20200418115631.png","https://img.weiyigeek.top/2020/1/20200418121148.png","https://img.weiyigeek.top/2020/1/20200418122704.png","https://img.weiyigeek.top/2020/1/20200418122734.png","https://img.weiyigeek.top/2020/1/20200418124128.png","https://img.weiyigeek.top/2022/5/20220606161747.png","https://img.weiyigeek.top/2022/5/20220606163104.png","https://img.weiyigeek.top/2022/5/20220607135645.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><h3 id=\"CI-CD介绍\"><a href=\"#CI-CD介绍\" class=\"headerlink\" title=\"CI/CD介绍\"></a>CI/CD介绍</h3><p><strong>Q：我们常说的CI/CD是什么?</strong></p>\n<ul>\n<li>CI 为 Continuous Integration 的缩写持续集成，可以理解为代码变动提交后，自动执行代码编译、代码打包、代码测试的这么一个流程。</li>\n<li>CD 对应多个英文名称：<code>Continuous Deployment（持续部署）</code> 和 <code>Continuous Delivery（持续交付）</code>。可以理解为通过上一步的操作将生成部署包按照配置文件流程进行部署启动;</li>\n</ul>\n<p><strong>Q: 什么是持续部署、交付?他有何作用?</strong><br>答: 先说说持续部署对于一个成熟的 CI/CD 的流程而言，代码变更经过编译、打包、测试之后的下一步就是部署环节。而持续交付一般是指，研发尽快地向客户交付，比如尽快实现功能上线，通过设计完善的 CI/CD 流程，一般可以实现持续交付的目标。</p>\n<p>PS：持续集成可以通过自动运行测试来帮助检测代码缺陷，而持续部署可以帮助您向生产环境交付代码, 对于前面提到的「持续」，可以理解为每完成一个完整的部分，就向下一个环节交付。</p>\n<p><br></p>\n<p><strong>参考来源</strong><br>官方文档: <a href=\"https://docs.gitlab.com/\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/</a></p>\n<hr>\n<h2 id=\"0x01-GitLab-CI-持续集成\"><a href=\"#0x01-GitLab-CI-持续集成\" class=\"headerlink\" title=\"0x01 GitLab-CI 持续集成\"></a>0x01 GitLab-CI 持续集成</h2><h4 id=\"1-1-基础介绍\"><a href=\"#1-1-基础介绍\" class=\"headerlink\" title=\"1.1 基础介绍\"></a>1.1 基础介绍</h4><p><strong>Q:什么是GitLab-CI?</strong></p>\n<blockquote>\n<p>A: GitLab-CI是Gitlab官方提供的持续集成服务(<code>GitLab8.0以后的版本是默认集成了GitLab-CI并默认启用的</code>)，它需要gitlab中配置注册runner，然后在仓库的根目录下新建.gitlab-ci.yml文件编写命令，并且在仓库的每次提交合并中将会触发构建；PS:当然还有其它的持续集成系统同样可以配合GitLab使用比如Jenkins主要针对于Java环境的项目,这里就不多说了;</p>\n</blockquote>\n<p><br/></p>\n<p><strong>Q:什么是GitLab-Runner?</strong></p>\n<blockquote>\n<p>A: Runner是一个执行任务的进程。您可以根据需要配置任意数量的Runner, 它可以放在不同的用户、服务器，甚至本地机器上。<br>简单的说 GitLab-Runner 就是一个用来执行软件集成脚本的, 一般地GitLab-Runner是配合GitLab-CI进行使用的,GitLab里面的每一个工程都会定义一个属于这个工程的软件集成脚本，用来自动化地完成一些软件集成工作。<code>当这个工程的仓库代码发生变动时，比如有人push了代码GitLab就会将这个变动通知GitLab-CI</code>,此时GitLab-CI会找出与这个工程相关联的Runner，并通知这些Runner把代码更新到本地并执行预定义好的执行脚本。</p>\n</blockquote>\n<p><br/></p>\n<p>示例: Runner就像一个个的工人，而GitLab-CI就是这些工人的一个管理中心，所有工人都要在GitLab-CI里面登记注册，并且表明自己是为哪个工程服务的。<code>所以当相应的工程发生变化时 GitLab-CI就会通知相应的工人执行软件集成脚本的动作</code>，如下图所示：</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416171549.png\" alt=\"WeiyiGeek.GitLab-CI与Runner关系图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.GitLab-CI与Runner关系图</p>\n            </figure>\n<p><strong>Q:GitLab-Runner分类两种类型说明?</strong></p>\n<blockquote>\n<p>两种类型指的是<code>Shared Runner（共享型）和Specific Runner（指定型）</code>。</p>\n<ul>\n<li>Shared Runner：是所有工程都能够用的并且只有系统管理员能够创建Shared Runner。</li>\n<li>Specific Runner：这只能为指定的工程服务。拥有该工程访问权限的人都能够为该工程创建Shared Runner。</li>\n</ul>\n</blockquote>\n<p><br/></p>\n<p><strong>Q:GitLab-Runner的几种状态说明?</strong></p>\n<ul>\n<li>shared - Runner 将运行所有未指定的项目的作业</li>\n<li>group - Runner 将运行群组中所有未指定项目的作业</li>\n<li>specific - Runner 将运行指定项目的作业 (常用)</li>\n<li>locked - 无法将 Runner 分配给其他项目</li>\n<li>paused - Runner 不会接受新的作业</li>\n</ul>\n<p><br></p>\n<h4 id=\"1-2-安装配置\"><a href=\"#1-2-安装配置\" class=\"headerlink\" title=\"1.2 安装配置\"></a>1.2 安装配置</h4><p>描述: GitLab-Runner安装配置此处有两种下载安装方式(宿主机或者容器中安装)，这是由于考虑到国内的网络访问国外地址确实太慢而且容易下载失败，所以通常我们都是在国内的一些镜像源厂商处进行下载以及设置操作系统的更新源;</p>\n<p>安装参考: <a href=\"https://docs.gitlab.com/runner/install/\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/runner/install/</a></p>\n<p><strong>环境说明:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GitLab 服务器: 192.168.1.250 = gitlab.weiyigeek.top</span><br><span class=\"line\">Gitlab-Runner 服务器: 192.168.1.3</span><br></pre></td></tr></table></figure></p>\n<p><strong>Runner 安装配置流程:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#方式1: GitLab官方安装脚本</span></span><br><span class=\"line\">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash</span><br><span class=\"line\">yum install -y gitlab-ci-multi-runner</span><br><span class=\"line\">gitlab-ci-multi-runner register</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#方式2:清华大学镜像站源进行安装Gitlab-Runner</span></span><br><span class=\"line\">cat &gt; /etc/yum.repos.d/gitlab-runner.repo &lt;&lt;END</span><br><span class=\"line\">[gitlab-runner]</span><br><span class=\"line\">name=gitlab-runner</span><br><span class=\"line\">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-runner/yum/el7</span><br><span class=\"line\">repo_gpgcheck=0</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgkey=https://packages.gitlab.com/gpg.key</span><br><span class=\"line\">END</span><br><span class=\"line\">sudo yum makecache</span><br><span class=\"line\">sudo yum list gitlab-runner --showduplicates <span class=\"comment\">#查看可安装版本</span></span><br><span class=\"line\">sudo yum install gitlab-runner -y</span><br><span class=\"line\"><span class=\"comment\"># 此处您可以安装指定版本 其中 12.3.5 即为指定的版本号</span></span><br><span class=\"line\"><span class=\"comment\"># yum install gitlab-runner-12.3.5-1.x86_64 -y</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>向GitLab-CI注册Runner流程如下:</strong></p>\n<ul>\n<li>Step1.由于向GitLab-CI注册一个Runner需要两样东西<code>GitLab-CI的url和注册token</code>所以我们首先需要在GitLab平台上得到该属性(<code>管理中心-&gt;概览-&gt;Runner-&gt;手动设置SharedRunner</code>);</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.安装GitLab Runner</span><br><span class=\"line\">2.在 Runner 设置时指定以下 URL： http://gitlab.weiyigeek.top/</span><br><span class=\"line\">3.在安装过程中使用以下注册令牌： qupxfdPtuzCckymoSCUu</span><br><span class=\"line\">4.启动 Runner!</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Step2.在Gitlab-Runner 服务器中进行执行;</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@Gitlab-Runner ~]<span class=\"variable\">$gitlab</span>-runner register</span><br><span class=\"line\">Runtime platform    arch=amd64 os=linux pid=20709 revision=4c96e5ad version=12.9.0</span><br><span class=\"line\">Running <span class=\"keyword\">in</span> system-mode.</span><br><span class=\"line\">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):</span><br><span class=\"line\">http://gitlab.weiyigeek.top/   <span class=\"comment\">#Gitlab地址</span></span><br><span class=\"line\">Please enter the gitlab-ci token <span class=\"keyword\">for</span> this runner:</span><br><span class=\"line\">qupxfdPtuzCckymoSCUu           <span class=\"comment\">#gitlab-ci令牌</span></span><br><span class=\"line\">Please enter the gitlab-ci description <span class=\"keyword\">for</span> this runner:</span><br><span class=\"line\">[initiator]: TestRunner       <span class=\"comment\">#Runner 描述</span></span><br><span class=\"line\">Please enter the gitlab-ci tags <span class=\"keyword\">for</span> this runner (comma separated):</span><br><span class=\"line\">TestRunner   <span class=\"comment\">#Runner 标签</span></span><br><span class=\"line\">Registering runner... succeeded  runner=qupxfdPt <span class=\"comment\">#表示注册成功</span></span><br><span class=\"line\">Please enter the executor: parallels, custom, docker, docker-ssh, docker+machine, docker-ssh+machine, kubernetes, shell, ssh, virtualbox:</span><br><span class=\"line\">shell <span class=\"comment\">#执行方式</span></span><br><span class=\"line\">Runner registered successfully. Feel free to start it, but <span class=\"keyword\">if</span> it<span class=\"string\">'s running already the config should be automatically reloaded!</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>Step3.注册完成之后GitLab-CI就会多出一条Runner记录，注意Type值有两种:<code>shared 所有仓库都可以使用 / specific 只有指定的仓库可以使用</code> , 而type的类型由执行gitlab-runner register命令填入的token决定；</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416173843.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>补充:不错当然您也可以在 <code>/etc/gitlab-runner/config.toml</code> 来注册相应类型的 Runner<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$nano</span> /etc/gitlab-runner/config.toml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 限制了整个GitLab Runner能并发处理job的数量</span></span><br><span class=\"line\">concurrent = 1</span><br><span class=\"line\">check_interval = 0</span><br><span class=\"line\"></span><br><span class=\"line\">[session_server]</span><br><span class=\"line\">  session_timeout = 1800</span><br><span class=\"line\"></span><br><span class=\"line\">[[runners]]</span><br><span class=\"line\">  name = <span class=\"string\">\"TestRunner\"</span></span><br><span class=\"line\">  url = <span class=\"string\">\"http://gitlab.weiyigeek.top/\"</span></span><br><span class=\"line\">  <span class=\"comment\">#注册生成的Runner 令牌</span></span><br><span class=\"line\">  token = <span class=\"string\">\"5UmJ5uECw5k6H_phzeiW\"</span></span><br><span class=\"line\">  executor = <span class=\"string\">\"shell\"</span></span><br><span class=\"line\">  [runners.custom_build_dir]</span><br><span class=\"line\">  [runners.cache]</span><br><span class=\"line\">    [runners.cache.s3]</span><br><span class=\"line\">    [runners.cache.gcs]</span><br><span class=\"line\"></span><br><span class=\"line\">[[runners]]</span><br><span class=\"line\">  name = <span class=\"string\">\"DockerRunner\"</span></span><br><span class=\"line\">  url = <span class=\"string\">\"http://gitlab.weiyigeek.top/\"</span></span><br><span class=\"line\">  token = <span class=\"string\">\"HrpstQA6eezWv5-9m5-d\"</span></span><br><span class=\"line\">  executor = <span class=\"string\">\"docker\"</span></span><br><span class=\"line\">  [runners.custom_build_dir]</span><br><span class=\"line\">  [runners.cache]</span><br><span class=\"line\">    [runners.cache.s3]</span><br><span class=\"line\">    [runners.cache.gcs]</span><br><span class=\"line\">  [runners.docker]</span><br><span class=\"line\">    <span class=\"comment\"># 在这里需要添加上 harbor 的地址，才能允许 pull 私有 registry 的镜像</span></span><br><span class=\"line\">    allowed_images = [<span class=\"string\">\"192.168.1.1/*:*\"</span>]</span><br><span class=\"line\">    tls_verify = <span class=\"literal\">false</span></span><br><span class=\"line\">    image = <span class=\"string\">\"alpine-node:latest\"</span></span><br><span class=\"line\">    privileged = <span class=\"literal\">false</span></span><br><span class=\"line\">    disable_entrypoint_overwrite = <span class=\"literal\">false</span></span><br><span class=\"line\">    oom_kill_disable = <span class=\"literal\">false</span></span><br><span class=\"line\">    disable_cache = <span class=\"literal\">false</span></span><br><span class=\"line\">    volumes = [<span class=\"string\">\"/cache\"</span>]</span><br><span class=\"line\">    shm_size = 0</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>注意事项:</strong></p>\n<ul>\n<li>特别注意<code>concurrent</code>与<strong>worker</strong>数量无任何关系，所有<strong>worker</strong>的工作是受GitLab Runner控制的，如果<code>concurrent</code>值为1并且有一个worker已经在工作了，那么即使其他worker达到了可以工作的条件也只能“pending”。</li>\n</ul>\n<p><br></p>\n<h4 id=\"1-3-命令参数\"><a href=\"#1-3-命令参数\" class=\"headerlink\" title=\"1.3 命令参数\"></a>1.3 命令参数</h4><p>描述: 安装 Gitlab Runner 后有两个命令gitlab-ci-multi-runner和gitlab-runner，前者用于注册多个Runner而后者构建一个单实例runner；</p>\n<p>gitlab-runner 命令参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 1.注册runner 会以引导的方式询问相关参数的设置-交互式</span></span><br><span class=\"line\">$ gitlab-runner register</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 2.查看已经注册的runner</span></span><br><span class=\"line\">$ gitlab-runner list</span><br><span class=\"line\">Runtime platform            arch=amd64 os=linux pid=81864 revision=4c96e5ad version=12.9.0</span><br><span class=\"line\">Listing configured runners    ConfigFile=/home/gitlab-runner/.gitlab-runner/config.toml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.删除gitlab-runner相关配置</span></span><br><span class=\"line\">sudo gitlab-runner uninstall</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.安装并设置--user(例如设置为root)</span></span><br><span class=\"line\">sudo gitlab-runner install --working-directory /home/gitlab-runner --user root </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.临时采用root权限运行runner(坑多，在Gitlab-CI中由于采用的gitlab-runner用户常常操作文件时候提醒权限不足)</span></span><br><span class=\"line\">sudo gitlab-runner run</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#6.将GitLab Runner安装为系统服务：</span></span><br><span class=\"line\">sudo gitlab-runner install -n <span class=\"string\">\"&lt;service-name&gt;\"</span> -u &lt;user-name&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#7.启动服务</span></span><br><span class=\"line\">sudo gitlab-runner start -n <span class=\"string\">\"&lt;service-name&gt;\"</span></span><br></pre></td></tr></table></figure></p>\n<p>GitLab Runner Commands 命令使用参考:<a href=\"https://docs.gitlab.com/runner/commands/README.html\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/runner/commands/README.html</a></p>\n<p><br></p>\n<h4 id=\"1-4-基础使用\"><a href=\"#1-4-基础使用\" class=\"headerlink\" title=\"1.4 基础使用\"></a>1.4 基础使用</h4><p>描述:假设我们在SecOpsDev项目中进行使用Gitlab-CI/CD，并且已经注册了Runner，<code>管理中心-&gt;Runner-&gt;查看Runner标签</code>:此处为TestRunner，然后点击编辑进行指派SecOpsDev项目;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200418115631.png\" alt=\"WeiyiGeek.runnertags\" title=\"\" class=\"\">\n                <p>WeiyiGeek.runnertags</p>\n            </figure>\n<p>（1）此时我们再在我们的SecOpsDev项目中建立一个.gitlab-ci.yaml文件，并且编写好后建议对其进行检测测试<code>NewProject -&gt; SecOpsDev -&gt; CI Lint</code>，示例如下:<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Path: secopsdev/.gitlab-ci.yml</span></span><br><span class=\"line\"><span class=\"comment\">#使用.gitlab-ci.yml配置你的项目,注意下面Tags是必须要指定的否则CI报错找不到Runner;</span></span><br><span class=\"line\"><span class=\"attr\">stages:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"><span class=\"comment\">#每次</span></span><br><span class=\"line\"><span class=\"attr\">before_script:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">echo</span> <span class=\"string\">\"#Before script section\"</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">WeiyiGeek.txt</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">echo</span> <span class=\"string\">\"For example you might run an update here or install a build dependency\"</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">echo</span> <span class=\"string\">\"Or perhaps you might print out some debugging details\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">after_script:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">echo</span> <span class=\"string\">\"#After script section\"</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">WeiyiGeek.txt</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">echo</span> <span class=\"string\">\"For example you might do some cleanup here\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">test1:</span></span><br><span class=\"line\"><span class=\"attr\">  stage:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">  script:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"(1) Do a test here - 正在进行代码测试 阶段1 \"</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"For example run a test suite\"</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">TestRunner</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"attr\">test2:</span></span><br><span class=\"line\"><span class=\"attr\">  stage:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">  script:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"(2) Do another parallel test here - 正在进行代码测试 阶段2 并行测试 \"</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"For example run a lint test\"</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">TestRunner</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"attr\">build:</span></span><br><span class=\"line\"><span class=\"attr\">  stage:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  script:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"(3) Building the app - 正在对项目进行编译 \"</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">TestRunner</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"attr\">deploy:</span></span><br><span class=\"line\"><span class=\"attr\">  stage:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"><span class=\"attr\">  script:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"(4) Deploy to staging server :\"</span> <span class=\"string\">$url</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"(4) Deploy to staging server :\"</span> <span class=\"string\">$(env)</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">staging</span></span><br><span class=\"line\"><span class=\"attr\">    url:</span> <span class=\"attr\">https://staging.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">  only:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">TestRunner</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200418121148.png\" alt=\"WeiyiGeek.gitlab-ci.yaml\" title=\"\" class=\"\">\n                <p>WeiyiGeek.gitlab-ci.yaml</p>\n            </figure>\n<p>（2）之后我们会在项目中的 <code>CI-CD -&gt; 流水线 | 作业</code> 进行查看执行结果;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200418122704.png\" alt=\"WeiyiGeek.流水线\" title=\"\" class=\"\">\n                <p>WeiyiGeek.流水线</p>\n            </figure>\n<p>（3）Gitlab-CI执行详情结果:</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200418122734.png\" alt=\"WeiyiGeek.作业详情\" title=\"\" class=\"\">\n                <p>WeiyiGeek.作业详情</p>\n            </figure>\n<p>（4）除此之外我们还可对CI/CD环境变量进行设置，并且运行到Runner环境中,设置路径如下: <code>NewProject -&gt; SecOpsDev -&gt; CI/CD 设置 -&gt; Expand (展开)</code>，然后重新执行deploy阶段在作业进行查看显示如下图所示;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200418124128.png\" alt=\"WeiyiGeek.环境变量\" title=\"\" class=\"\">\n                <p>WeiyiGeek.环境变量</p>\n            </figure>\n<p>（5）拉取的code会在Gitlab-Runner主机中,安装以下路径进行存放<code>/home/gitlab-runner/builds/5UmJ5uEC/0/newproject/secopsdev/.git/</code></p>\n<p>补充说明:</p>\n<ul>\n<li>GitLab CI有三个默认阶段：<code>1构建(build)、2测试(test)、3部署(deploy)</code>，我们将有一篇文章进行详细讲解。</li>\n<li>Runner可以分布在不同的主机上，同一个主机上也可以有多个Runner。</li>\n</ul>\n<p><br></p>\n<h4 id=\"1-5-Executor\"><a href=\"#1-5-Executor\" class=\"headerlink\" title=\"1.5 Executor\"></a>1.5 Executor</h4><p>下面我们来谈谈一个非常重要的话题<code>Executor</code>,上面我们在向gitlab-ci注册runner需要我们输入Executor;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Please enter the executor: parallels, custom, docker, docker-ssh, docker+machine, docker-ssh+machine, kubernetes, shell, ssh, virtualbox:</span><br></pre></td></tr></table></figure></p>\n<p><strong>Shell Executor</strong><br>描述:以宿主机（此处为Centos7系统）作为Runner(版本:12.9.0)的所有jobs的执行器。<br>Runner将会从远程仓库pull你的工程，工程的目录为：<code>&lt;working-directory&gt;/builds/&lt;short-token&gt;/&lt;concurrent-id&gt;/&lt;namespace&gt;/&lt;project-name&gt;</code>,如果你使用了cache，那么cache将会存在<code>&lt;working-directory&gt;/cache/&lt;namespace&gt;/&lt;project-name&gt;</code>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Repo</span></span><br><span class=\"line\">/home/gitlab-runner/builds/5UmJ5uEC/0/WeiyiGeek/blog</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Cache</span></span><br><span class=\"line\">/home/gitlab-runner/cache/WeiyiGeek/blog</span><br></pre></td></tr></table></figure></p>\n<p>参考:<a href=\"https://docs.gitlab.com/runner/executors/shell.html\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/runner/executors/shell.html</a></p>\n<p><br/></p>\n<p><strong>Docker Executor</strong><br>描述:所有jobs的执行环境为指定的docker image所生成的container，每个job都会生成一个container并且在job结束后立即销毁。</p>\n<ul>\n<li><p><a href=\"https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.gitlab.com%2Frunner%2Fexecutors%2Fdocker.html%23the-builds-and-cache-storage\" target=\"_blank\" rel=\"noopener\">- build和cache的存储</a></p>\n<p>Docker executor默认将所有的builds存储在<code>/builds//</code>（这里的路径是container里的路径，Runner配置文件<code>config.toml</code>里的<code>build_dir</code>字段可以重新指明build的目录，默认对应于宿主机的目录是在宿主机的docker volume下：<code>/var/lib/docker/volumes//_data/</code>），默认将所有的caches存储在container里的<code>/cache</code>目录（<code>config.toml</code>里的<code>cache_dir</code>字段可以重新指明cache的目录），注意<code>build_dir</code>和<code>cache_dir</code>指向的均是container里的目录，要想将container里的数据持久化，需要用到<code>volumes</code>字段，这个字段的使用和docker volume的使用是类似的，只需在<code>config.toml</code>的<code>[runner.docker]</code>部分添加<code>volumes = [&quot;/cache&quot;, &quot;:rw&quot;]</code>即可实现container里<code>/cache</code>目录数据的永久保存以及将host目录挂载到相应的container目录并具有读写的功能。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[runners.custom_build_dir]</span></span><br><span class=\"line\">  <span class=\"string\">[runners.cache]</span></span><br><span class=\"line\">    <span class=\"string\">[runners.cache.s3]</span></span><br><span class=\"line\">    <span class=\"string\">[runners.cache.gcs]</span></span><br><span class=\"line\">  <span class=\"string\">[runners.docker]</span></span><br><span class=\"line\">    <span class=\"comment\"># 在这里需要添加上 harbor 的地址，才能允许 pull 私有 registry 的镜像</span></span><br><span class=\"line\">    <span class=\"string\">allowed_images</span> <span class=\"string\">=</span> <span class=\"string\">[\"192.168.1.1/*:*\"]</span></span><br><span class=\"line\">    <span class=\"string\">tls_verify</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"string\">image</span> <span class=\"string\">=</span> <span class=\"string\">\"alpine-node:latest\"</span></span><br><span class=\"line\">    <span class=\"string\">privileged</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"string\">disable_entrypoint_overwrite</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"string\">oom_kill_disable</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"string\">disable_cache</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"string\">volumes</span> <span class=\"string\">=</span> <span class=\"string\">[\"/cache\"]</span></span><br><span class=\"line\">    <span class=\"string\">shm_size</span> <span class=\"string\">=</span> <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li><p><a href=\"https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.gitlab.com%2Frunner%2Fexecutors%2Fdocker.html%23how-pull-policies-work\" target=\"_blank\" rel=\"noopener\">Pull policies</a></p>\n<p>当你使用<code>docker</code> 或 <code>docker+machine</code> executors时，你可以通过设置<code>pull_policy</code>来决定Runner如何pull docker image。<code>pull_policy</code>有三种值：<br> <code>always</code> —— Runner始终从远程pull docker image。<br> <code>if-not-present</code> —— Runner会首先检查本地是否有该image，如果有则用本地的，如果没有则从远程拉取。<br> <code>never</code> —— Runner始终使用本地的image。</p>\n</li>\n</ul>\n<ul>\n<li><p><a href=\"https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.gitlab.com%2Frunner%2Fconfiguration%2Fadvanced-configuration.html%23helper-image\" target=\"_blank\" rel=\"noopener\">Helper image</a></p>\n<p>  当你使用<code>docker</code>, <code>docker+machine</code> 或 <code>kubernetes</code>作为executor时，GitLab Runner将会使用特定的container来处理Git、artifacts 和cache 操作。通过在宿主机中键入以下命令：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo docker images</span><br><span class=\"line\">REPOSITORY                          TAG</span><br><span class=\"line\">gitlab&#x2F;gitlab-runner-helper     x86_64-3afdaba6</span><br><span class=\"line\">gitlab&#x2F;gitlab-runner-helper     x86_64-cf91d5e1</span><br></pre></td></tr></table></figure>\n<p>当然，你也可以通过配置<code>config.toml</code>里的<code>helper_image</code>字段来让Runner使用你自己定制化的helper image。</p>\n</li>\n</ul>\n<p><em>Q：如何在job所对应的container里使用git clone命令？</em></p>\n<p>答: 如果你想在job运行期间clone某些代码（如shell或python的脚本），首先要确保你的宿主机有权限clone代码，然后你就可以将你的secret挂载到container里</p>\n<p>例如，你是通过ssh的方式克隆代码，并且你的ssh目录为<code>home//.ssh</code>，你就可以在<code>config.toml</code>文件里添加如下配置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">volumes &#x3D; [&quot;&#x2F;home&#x2F;x1twbm&#x2F;.ssh:&#x2F;root&#x2F;.ssh:ro&quot;]</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"1-6-缓存使用\"><a href=\"#1-6-缓存使用\" class=\"headerlink\" title=\"1.6 缓存使用\"></a>1.6 缓存使用</h4><p>该章节主要针对于Gitlab CI/CD 中的 Cache 两种机制进行学习和说明；</p>\n<ul>\n<li>cache</li>\n<li>artifacts</li>\n</ul>\n<p><em>Q：为何要使用 Cache？它有什么目的?</em><br>A:在GitLab CI/CD 中在 pipeline 中的一些 job 可能会产生一些结果文件，<code>Cache 机制的引入就是为了加快 job 执行的时间</code>。Cache 在使用时制定一系列的文件或者文件目录，使得其在不同的 job 之间被缓存下来。这样当某一个 job 需要依赖于之前步骤产生的一些文件结果，Cache 就帮助我们在上一个 job 将产生的结果缓存下来并且在当前的 job 进行使用。</p>\n<p><br></p>\n<p><strong>（1）Cache</strong><br>描述：首先 cache 的定义范围可以全局定义即<code>所有的 job 都会采用这个全局定义的 cache 设置</code>, 当然每个 <code>job 内也可以定义自己特有的 cache 来覆盖全局的配置</code>。<br>Cache 在使用上主要的配置有以下几种：</p>\n<ul>\n<li>paths: 指定需要被缓存的文件路径(项目相对路径)</li>\n<li>key: 在cache中不同 job 定义了不同的 key 时， 每个 job 都会有一个独立的 cache，不同的 key 下的缓存也不会相互影响,当 cache:key 结合 GitLab CI/CD 中预定义的参数可以有不同的效果,当 key 没有被特别定义的时候，默认为 default，所有没定义 key 的 cache 使用的是同一份 cache，会随着 job 的执行一直被覆盖；</li>\n<li>policy: 如果有 cache 的配置此时每个 job 会在开始执行前将对应路径的文件下载下来，并在任务结束前重新上传，不管文件是否有变化都会如此操作(<code>默认的配置 cache:policy为 pull-push 策略</code>)；但是如果我们已经知道某个 job 只是使用的其他 job 改变的文件，自身并无改变对应路径的文件，那么就不需要进行文件上传操作采用pull 策略即可，这样做的好处<code>减少了不必要的操作，在一定程度上节约了时间</code>。</li>\n</ul>\n<p><em>Q:如何进行 cache 继承？</em><br>答:如果在使用中有 job 大部分配置跟全局配置是一样的，但是部分不同，就可以采用继承的方式，而不必全部重写实际上类似于别名一样进行函数调用一样，首先需在cahe全局缓存中设置<code>&amp;global_cache</code>,然后再job中进行调用击即可<code>&lt;&lt;: *global_cache</code>;</p>\n<p>Q:如何禁用某个Job的Cache操作？<br>答:如果整个 pipeline 配置全局的 cache，意味着每个 job 在没有特殊配置的情况下会使用全局的配置。但是如果某某个 job 并不使用到 cache，包括缓存文件的上传和下载，那么可以进行如下配置对整个 job 的 cache 禁用,再job中配置<code>cache: {}</code>即不会收到全局缓存的影响：</p>\n<p>Cache在runner中缓存的物理路径:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/home/gitlab-runner/cache/gitlab用户/项目名称/cache.zip</span><br><span class=\"line\">/home/gitlab-runner/cache/WeiyiGeek/blog/cache.zip</span><br></pre></td></tr></table></figure></p>\n<p><em>参数说明:</em><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#全局缓存 global_cache</span></span><br><span class=\"line\"><span class=\"attr\">cache:</span> <span class=\"meta\">&amp;global_cache</span></span><br><span class=\"line\"><span class=\"attr\">  key:</span> <span class=\"string\">$&#123;CI_JOB_NAME&#125;</span> <span class=\"comment\">#结合 GitLab CI/CD 中预定义的参数有不同的效果</span></span><br><span class=\"line\">  <span class=\"comment\"># 缓存 node_modules/目录 下次构建不会删除</span></span><br><span class=\"line\"><span class=\"attr\">  paths:</span>  </span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">node_modules/</span></span><br><span class=\"line\"><span class=\"attr\">  policy:</span> <span class=\"string\">pull-push</span> <span class=\"comment\">#默认对缓存文件进行拉取与更新</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#局部缓存 local_cache</span></span><br><span class=\"line\"><span class=\"attr\">local_cache:</span></span><br><span class=\"line\"><span class=\"attr\">  stage:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  cache:</span>   <span class=\"comment\">#如果在 job 内部也定义了 cache 配置，全局的配置就会被覆盖</span></span><br><span class=\"line\"><span class=\"attr\">    key:</span> <span class=\"string\">$&#123;CI_JOB_NAME&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    policy:</span> <span class=\"string\">pull</span>  <span class=\"comment\">#使用了pull 策略不会在 job 结束后进行文件的上传操作</span></span><br><span class=\"line\"><span class=\"attr\">    paths:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">node_modules/</span> </span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">binaries/*.apk</span>  <span class=\"comment\">#在binaries 目录下以 .apk 结尾的所有文件以及 .config 文件会被缓存下来。</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">#Cache 的继承</span></span><br><span class=\"line\"><span class=\"attr\">inherit_cache:</span></span><br><span class=\"line\"><span class=\"attr\"> cache:</span></span><br><span class=\"line\">    <span class=\"comment\"># 继承全局配置</span></span><br><span class=\"line\">    <span class=\"string\">&lt;&lt;:</span> <span class=\"meta\">*global_cache</span></span><br><span class=\"line\">    <span class=\"comment\"># 仅覆盖 cache:policy 的配置</span></span><br><span class=\"line\"><span class=\"attr\">    policy:</span> <span class=\"string\">pull</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Cache 的禁用</span></span><br><span class=\"line\"><span class=\"string\">disable_cache</span></span><br><span class=\"line\"><span class=\"attr\">  cache:</span> <span class=\"string\">&#123;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>分布式 Cache 在 GitLab CI/CD 中，我们所使用的 runner 是以 docker 的形式运行不同的任务。普通的 cache 机制，其 cache 均存储在本地，所有如果两个 job 实际运行的位置是在不用宿主机上，其相互之间的缓存是无法共享的。</p>\n<p>为了实现分布式 Cache，需要在配置 GitLab Runner 的 config.toml 的 <code>[runners.cache]</code>进行如下配置：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[[runners]]</span></span><br><span class=\"line\">  <span class=\"string\">limit</span> <span class=\"string\">=</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"string\">executor</span> <span class=\"string\">=</span> <span class=\"string\">\"docker\"</span></span><br><span class=\"line\">  <span class=\"string\">[runners.cache]</span></span><br><span class=\"line\">    <span class=\"string\">Type</span> <span class=\"string\">=</span> <span class=\"string\">\"s3\"</span></span><br><span class=\"line\">    <span class=\"string\">Path</span> <span class=\"string\">=</span> <span class=\"string\">\"path/to/prefix\"</span></span><br><span class=\"line\">    <span class=\"string\">Shared</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"string\">[runners.cache.s3]</span></span><br><span class=\"line\">      <span class=\"string\">ServerAddress</span> <span class=\"string\">=</span> <span class=\"string\">\"s3.example.com\"</span></span><br><span class=\"line\">      <span class=\"string\">AccessKey</span> <span class=\"string\">=</span> <span class=\"string\">\"access-key\"</span></span><br><span class=\"line\">      <span class=\"string\">SecretKey</span> <span class=\"string\">=</span> <span class=\"string\">\"secret-key\"</span></span><br><span class=\"line\">      <span class=\"string\">BucketName</span> <span class=\"string\">=</span> <span class=\"string\">\"runner\"</span></span><br><span class=\"line\">      <span class=\"string\">Insecure</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure><br>在以上的配置中，对应的 cache 的存储路径如下：<code>http(s)://&lt;ServerAddress&gt;/&lt;BucketName&gt;/&lt;Path&gt;/project/&lt;id&gt;/&lt;cache-key&gt;</code>,在配置，对应的存储 cache 服务器需要满足 s3 协议，当然也可以<a href=\"https://docs.gitlab.com/runner/install/registry_and_cache_servers.html#install-your-own-cache-server\" target=\"_blank\" rel=\"noopener\">自建 cache 服务器</a></p>\n<p>Cache 小实践：<br>(1).gitlab-ci.yml 配置以下配置中 <code>job1 和 job3 使用了全局的 cache 配置，job2 独立定义了 cache 配置使用了 pull 策略</code>。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">stages:</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span> <span class=\"string\">test1</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span> <span class=\"string\">test2</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span> <span class=\"string\">test3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">cache:</span></span><br><span class=\"line\"><span class=\"attr\">   key:</span> <span class=\"string\">\"$CI_COMMIT_REF_SLUG\"</span></span><br><span class=\"line\"><span class=\"attr\">   paths:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">job1:</span></span><br><span class=\"line\"><span class=\"attr\">   stage:</span> <span class=\"string\">test1</span></span><br><span class=\"line\"><span class=\"attr\">   script:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">cat</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">echo</span> <span class=\"string\">\"aaaaaaaaaa\"</span> <span class=\"string\">&gt; Test.txt</span></span><br><span class=\"line\"><span class=\"string\">     - cat Test.txt</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">   tags:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">base-runner</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">job2:</span></span><br><span class=\"line\"><span class=\"attr\">   stage:</span> <span class=\"string\">test2</span></span><br><span class=\"line\"><span class=\"attr\">   cache:</span></span><br><span class=\"line\"><span class=\"attr\">     key:</span> <span class=\"string\">\"$CI_COMMIT_REF_SLUG\"</span></span><br><span class=\"line\"><span class=\"attr\">     paths:</span></span><br><span class=\"line\"><span class=\"bullet\">       -</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"attr\">     policy:</span> <span class=\"string\">pull</span>  <span class=\"comment\">#关注点</span></span><br><span class=\"line\"><span class=\"attr\">   script:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">cat</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">echo</span> <span class=\"string\">\"bbbbbbbbbbb\"</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">cat</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"attr\">   tags:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">base-runner</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">job3:</span></span><br><span class=\"line\"><span class=\"attr\">   stage:</span> <span class=\"string\">test3</span></span><br><span class=\"line\"><span class=\"attr\">   script:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">ls</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">cat</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">echo</span> <span class=\"string\">\"cccccccc\"</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">cat</span> <span class=\"string\">Test.txt</span></span><br><span class=\"line\"><span class=\"attr\">   tags:</span></span><br><span class=\"line\"><span class=\"bullet\">     -</span> <span class=\"string\">base-runner</span></span><br></pre></td></tr></table></figure></p>\n<p>(2) 执行结果<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#job1 结果</span></span><br><span class=\"line\">Checking cache <span class=\"keyword\">for</span> <span class=\"built_in\">test</span>-wer-1...</span><br><span class=\"line\"><span class=\"comment\">#首次检查缓存未存在进行创建缓存</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"aaaaaaaaaa\"</span> &gt; Test.txt</span><br><span class=\"line\">$ cat Test.txt</span><br><span class=\"line\">aaaaaaaaaa</span><br><span class=\"line\">Creating cache <span class=\"built_in\">test</span>-wer-1...</span><br><span class=\"line\">Test.txt: found 1 matching files                                  </span><br><span class=\"line\">Uploading cache.zip to http://192.168.12.139:9000/runner/cache-path/project/1242/<span class=\"built_in\">test</span>-wer-1   <span class=\"comment\">#上传 cache 路径</span></span><br><span class=\"line\">Created cache</span><br><span class=\"line\">Job succeeded</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#job2 结果</span></span><br><span class=\"line\">Checking cache <span class=\"keyword\">for</span> <span class=\"built_in\">test</span>-wer-1...</span><br><span class=\"line\">cache.zip is up to date  <span class=\"comment\">#缓存进行了下载              </span></span><br><span class=\"line\">Successfully extracted cache</span><br><span class=\"line\">$ cat Test.txt</span><br><span class=\"line\">aaaaaaaaaa</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"bbbbbbbbbb\"</span> &gt;&gt; Test.txt</span><br><span class=\"line\">$ cat Test.txt</span><br><span class=\"line\">aaaaaaaaaa</span><br><span class=\"line\">bbb</span><br><span class=\"line\">Not uploading cache <span class=\"built_in\">test</span>-wer-1 due to policy <span class=\"comment\"># pull策略不上传缓存</span></span><br><span class=\"line\">Job succeeded</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#job3 结果</span></span><br><span class=\"line\">Checking cache <span class=\"keyword\">for</span> <span class=\"built_in\">test</span>-wer-1...</span><br><span class=\"line\">cache.zip is up to date                            </span><br><span class=\"line\">Successfully extracted cache</span><br><span class=\"line\">$ cat Test.txt</span><br><span class=\"line\">aaaaaaaaaa</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"ccccccccc\"</span> &gt;&gt; Test.txt</span><br><span class=\"line\">$ cat Test.txt</span><br><span class=\"line\">aaaaaaaaaa</span><br><span class=\"line\">ccccccccc</span><br><span class=\"line\">Creating cache <span class=\"built_in\">test</span>-wer-1...</span><br><span class=\"line\">Test.txt: found 1 matching files                </span><br><span class=\"line\">22.txt: found 1 matching files                     </span><br><span class=\"line\">Uploading cache.zip to http://192.168.12.139:9000/runner/cache-path/project/1242/<span class=\"built_in\">test</span>-wer-1  <span class=\"comment\">#上传 cache 路径</span></span><br><span class=\"line\">Created cache</span><br><span class=\"line\">Job succeeded</span><br></pre></td></tr></table></figure><br>总结:</p>\n<ul>\n<li>job2 获取到缓存文件 Test.txt 的文件内容是 job1 执行后的结果，说明 job1 和 job2 之间实现了缓存共享</li>\n<li>job3 获取到缓存文件 Test.txt 的文件与 job1 执行后内容一致而非 job2，这是因为 job2 执行后的结果没有进行上传</li>\n<li>特别注意的是 job1 在执行任务前获取到的 Test.txt 的文件与 job3 执行完的结果一致，这是因为这个 pipeline 我运行了多次，job1 获取的缓存是上一次 pipeline 中 job3 的执行后的缓存结果。说明 cache 在不同次 pipeline 之间也实现了共享</li>\n</ul>\n<hr>\n<h2 id=\"0x02-GitLab-Runner-补充\"><a href=\"#0x02-GitLab-Runner-补充\" class=\"headerlink\" title=\"0x02 GitLab Runner 补充\"></a>0x02 GitLab Runner 补充</h2><h3 id=\"1-Kubernetes-环境中安装-Runner\"><a href=\"#1-Kubernetes-环境中安装-Runner\" class=\"headerlink\" title=\"1.Kubernetes 环境中安装 Runner\"></a>1.Kubernetes 环境中安装 Runner</h3><p>描述: 除开在宿主机以及Docker中运行Runner我们还可以将其运行在Kubernetes集群之中，下面将使用 Helm 图表方式将GitLab Runner 实例部署到 Kubernetes 集群。</p>\n<p><strong>环境要求</strong></p>\n<ul>\n<li>Kubernetes 环境 (V1.23.x)</li>\n<li>kubectl 客户端工具</li>\n<li>Helm 客户端工具 (此处为Helm 3.x版本)</li>\n</ul>\n<p><strong>使用 Helm Chart 快速安装 GitLab Runner</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.添加 GitLab Helm 存储库并更新索引</span></span><br><span class=\"line\">helm repo add gitlab https://charts.gitlab.io</span><br><span class=\"line\">helm repo update</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.查看 gitlab-runner 版本以及其 Helm values</span></span><br><span class=\"line\">helm search repo gitlab-runner           <span class=\"comment\"># 最新版本</span></span><br><span class=\"line\">helm search repo -l gitlab/gitlab-runner <span class=\"comment\"># 所有版本</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                    CHART VERSION   APP VERSION     DESCRIPTION</span></span><br><span class=\"line\">  <span class=\"comment\"># gitlab/gitlab-runner    0.41.0          15.0.0          GitLab Runner</span></span><br><span class=\"line\">helm show values gitlab/gitlab-runner --version 0.41.0 &gt; gitlab-runner.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.按照需要修改该图表的配置</span></span><br><span class=\"line\"><span class=\"comment\"># https://docs.gitlab.com/runner/install/kubernetes.html#configuring-gitlab-runner-using-the-helm-chart</span></span><br><span class=\"line\">$ egrep -v <span class=\"string\">\"^$|^#|^[[:space:]]+#\"</span> gitlab-runner.yaml</span><br><span class=\"line\">imagePullPolicy: IfNotPresent</span><br><span class=\"line\"><span class=\"comment\"># 关键点.私有仓库认证票据</span></span><br><span class=\"line\">imagePullSecrets:</span><br><span class=\"line\">- name: <span class=\"string\">\"harbor-cloud-secret\"</span></span><br><span class=\"line\"><span class=\"comment\"># 关键点.私有仓库地址</span></span><br><span class=\"line\">gitlabUrl: http://gitlab.weiyigeek.top</span><br><span class=\"line\"><span class=\"comment\"># 关键点.私有仓库runner注册Token</span></span><br><span class=\"line\">runnerRegistrationToken: <span class=\"string\">\"gu8nqhPNZXJ8xZxotTPr\"</span></span><br><span class=\"line\">terminationGracePeriodSeconds: 3600</span><br><span class=\"line\">concurrent: 10</span><br><span class=\"line\">checkInterval: 30</span><br><span class=\"line\">logLevel: error</span><br><span class=\"line\">sessionServer:</span><br><span class=\"line\">  enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">rbac:</span><br><span class=\"line\">  <span class=\"comment\"># 关键点.建议设置为true启用rbac</span></span><br><span class=\"line\">  create: <span class=\"literal\">true</span></span><br><span class=\"line\">  rules: []</span><br><span class=\"line\">  clusterWideAccess: <span class=\"literal\">false</span></span><br><span class=\"line\">  podSecurityPolicy:</span><br><span class=\"line\">    enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">    resourceNames:</span><br><span class=\"line\">    - gitlab-runner</span><br><span class=\"line\">metrics:</span><br><span class=\"line\">  enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">  portName: metrics</span><br><span class=\"line\">  port: 9252</span><br><span class=\"line\">  serviceMonitor:</span><br><span class=\"line\">    enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">service:</span><br><span class=\"line\">  enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\">runners:</span><br><span class=\"line\">  config: |</span><br><span class=\"line\">    [[runners]]</span><br><span class=\"line\">      [runners.kubernetes]</span><br><span class=\"line\">        namespace = <span class=\"string\">\"&#123;&#123;.Release.Namespace&#125;&#125;\"</span></span><br><span class=\"line\">        image = <span class=\"string\">\"ubuntu:20.04\"</span></span><br><span class=\"line\">  cache: &#123;&#125;</span><br><span class=\"line\">  builds: &#123;&#125;</span><br><span class=\"line\">  services: &#123;&#125;</span><br><span class=\"line\">  helpers: &#123;&#125;</span><br><span class=\"line\">  nodeSelector: &#123;&#125;</span><br><span class=\"line\">securityContext:</span><br><span class=\"line\">  runAsUser: 100</span><br><span class=\"line\">  fsGroup: 65533</span><br><span class=\"line\">resources: &#123;&#125;</span><br><span class=\"line\">affinity: &#123;&#125;</span><br><span class=\"line\"><span class=\"comment\"># 修改点.此处指定节点运行</span></span><br><span class=\"line\">nodeSelector:</span><br><span class=\"line\">  kubernetes.io/hostname: weiyigeek-226</span><br><span class=\"line\">tolerations: []</span><br><span class=\"line\">hostAliases: []</span><br><span class=\"line\">podAnnotations: &#123;&#125;</span><br><span class=\"line\">podLabels: &#123;&#125;</span><br><span class=\"line\">secrets: []</span><br><span class=\"line\">configMaps: &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.如果是需要钱私有仓库中的镜像，需要首先创建一个 docker-registry 类型的 Secret 。</span></span><br><span class=\"line\">kubectl create secret docker-registry harbor-cloud-secret \\</span><br><span class=\"line\">--docker-server=harbor-cloud \\</span><br><span class=\"line\">--docker-username=weiyigeek \\</span><br><span class=\"line\">--docker-password=WWW.weiyigeek.top \\</span><br><span class=\"line\">--namespace=devops</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.安装 GitLab Runner 到K8S集群</span></span><br><span class=\"line\"><span class=\"comment\"># For Helm 3</span></span><br><span class=\"line\"><span class=\"comment\"># $ helm install --namespace &lt;NAMESPACE&gt; gitlab-runner -f &lt;CONFIG_VALUES_FILE&gt; gitlab/gitlab-runner</span></span><br><span class=\"line\">  <span class=\"comment\"># * &lt;NAMESPACE&gt; 是要在其中安装 GitLab Runner 的 Kubernetes 命名空间。</span></span><br><span class=\"line\">  <span class=\"comment\"># * &lt;CONFIG_VALUES_FILE&gt; 是包含自定义配置的值文件的路径。</span></span><br><span class=\"line\">$ helm install --namespace devops gitlab-runner --version 0.41.0  -f ./gitlab-runner.yaml gitlab/gitlab-runner</span><br><span class=\"line\">  <span class=\"comment\"># NAME: gitlab-runner</span></span><br><span class=\"line\">  <span class=\"comment\"># LAST DEPLOYED: Mon Jun  6 16:01:00 2022</span></span><br><span class=\"line\">  <span class=\"comment\"># NAMESPACE: devops</span></span><br><span class=\"line\">  <span class=\"comment\"># STATUS: deployed</span></span><br><span class=\"line\">  <span class=\"comment\"># REVISION: 1</span></span><br><span class=\"line\">  <span class=\"comment\"># TEST SUITE: None</span></span><br><span class=\"line\">  <span class=\"comment\"># NOTES:</span></span><br><span class=\"line\">  <span class=\"comment\"># Your GitLab Runner should now be registered against the GitLab instance reachable at: \"http://gitlab.weiyigeek.top\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Runner namespace \"devops\" was found in runners.config template.</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ helm upgrade --namespace devops gitlab-runner --version 0.41.0  -f ./gitlab-runner.yaml gitlab/gitlab-runner</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6.验证安装状态</span></span><br><span class=\"line\">kubectl get pod -n devops -l app=gitlab-runner</span><br><span class=\"line\">  <span class=\"comment\"># NAME                             READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># gitlab-runner-6685dc55bd-86l2h   1/1     Running   0          15m</span></span><br></pre></td></tr></table></figure></p>\n<p>在完成上述操作之后我们便可在<code>管理中心-&gt;Runner</code>中查看到注册的<code>gitlab-runner-6685dc55bd-86l2h</code>了, 如下图所示。<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220606161747.png\" alt=\"WeiyiGeek.gitlab-runner注册成功\" title=\"\" class=\"\">\n                <p>WeiyiGeek.gitlab-runner注册成功</p>\n            </figure></p>\n<p>此时你会发现其处于不适用状态，即Git项目中的流水线无法使用该注册Runner，我们需要手动进行指定Git项目进行调用该Runner（即Runner将运行指定项目的作业），并且为其设置devtest标签。</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220606163104.png\" alt=\"WeiyiGeek.Runner运行指定项目的作业\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Runner运行指定项目的作业</p>\n            </figure>\n<p><br/></p>\n<p>最后验证该runner是否能运行指定流水线的作业, 温馨提示为了能在runner流水线中拉取该项目代码, 你需要将提交用户加入到项目成员中(<code>此处演示项目为root用户其权限为Guest</code>)，否则会报没有权限拉取项目的错误。</p>\n<p>步骤01.首先在项目根目录中创建<code>.gitlab-ci.yml</code>文件,假设其内容如下:<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># .gitlab-ci.yml</span></span><br><span class=\"line\"><span class=\"attr\">stages:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">default:</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"attr\">alpine:3.16</span></span><br><span class=\"line\"><span class=\"attr\">  before_script:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">uname</span> <span class=\"bullet\">-a</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">id</span> </span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"WeiyiGeek\"</span> <span class=\"string\">&gt; user.logs &amp;&amp; date -R &gt;&gt; user.logs</span></span><br><span class=\"line\"><span class=\"string\">   </span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">Test:</span></span><br><span class=\"line\"><span class=\"attr\">  stage:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">  script:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"bullet\">-e</span> <span class=\"string\">\"# Test Stage\"</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">echo</span> <span class=\"string\">\"https://www.weiyigeek.top\"</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">cat</span> <span class=\"string\">user.logs</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">devtest</span></span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 注意流水线脚本中的tags值需要与runner标签值进行对应, 这样做的好处是可以在不同的runner环境中执行指定阶段的流水线脚本。</p>\n<p><br/></p>\n<p>步骤 02.默认提交后将会触发CICD, 此时我们可返回K8S Master的shell终端进行查看流水线是否正常运行, 当然也可以通过项目流水线进行查看。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Runner为流水线作业生成的 runner-ijlvfrnc-project-75-concurrent-0rl7cg 工作Pod</span></span><br><span class=\"line\">~$ kubectl get pod -n devops -o wide</span><br><span class=\"line\">NAME                                           READY   STATUS            RESTARTS         AGE     IP              NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">gitlab-runner-85bbdc5954-zmddx                 1/1     Running           0                20h     10.66.182.214   </span><br><span class=\"line\">runner-ijlvfrnc-project-75-concurrent-0rl7cg   0/2     PodInitializing   0                3s      10.66.182.235</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220607135645.png\" alt=\"WeiyiGeek.测试Runner进行流水线工作结果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.测试Runner进行流水线工作结果</p>\n            </figure>\n<p>温馨提示: 如果未在上述<code>gitlab-runner.yaml</code>图表配置文件中设置<code>image: gitlab/gitlab-runner</code>将默认采用指定版本对应的<code>gitlab-runner</code>镜像,所以此处镜像为<code>image: gitlab/gitlab-runner:alpine-v15.0.0</code>。</p>\n<hr>\n<h2 id=\"0x0n-入坑出坑\"><a href=\"#0x0n-入坑出坑\" class=\"headerlink\" title=\"0x0n 入坑出坑\"></a>0x0n 入坑出坑</h2><p><strong>问题1.向Gitlab-CI进行注册Runner时候提示<code>Failed to register this runner. Perhaps you are having network problems</code></strong><br>问题关键字:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Registering runner... failed runner=qRGh2M86 status=500 Internal Server Error</span><br><span class=\"line\">PANIC: Failed to register this runner. Perhaps you are having network problems</span><br></pre></td></tr></table></figure><br>原因:因为 Gitlab 默认禁止了私有网段 IP 里的 API 请求，需要手动开启才行。<br>解决办法: 修改 gitlab 默认网络设置 或者 白名单以允许来自钩子和服务的对本地网络的请求(<code>线上环境推荐</code>)。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#此处以第一种方式为列</span></span><br><span class=\"line\">使用 root 用户从 web 端登录到 gitlab 管理中心 http://<span class=\"variable\">$&#123;ip&#125;</span>/admin 。管理中心 --&gt; 设置 --&gt; 网络 –&gt; 外发请求</span><br><span class=\"line\"><span class=\"comment\">#设置如下</span></span><br><span class=\"line\">* 勾选 允许Webhook和服务对本地网络的请求</span><br><span class=\"line\">* 勾选 允许系统钩子向本地网络发送的请求</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>补充 <code>[2020年4月17日 22:53:44]</code> 时间:<blockquote>\n<p>如果点击 <code>保存修改</code> 之后就跳转到 Gitlab 500 错误的页面。<br>尝试在管理中心修改其他设置保存时，也会出现 500 的情况。<br>在安装 gitlab 的机器上查看一下日志。运行 gitlab-ctl tail 查看实时的日志。<br>此时等到日志输出减慢的时候我们多按几下回车，然后就立即去点击 保存修改 按钮，这样就能捕捉到此刻的错误日志。</p>\n</blockquote>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">==&gt; /var/<span class=\"built_in\">log</span>/gitlab/gitlab-rails/production.log &lt;==</span><br><span class=\"line\">Started PATCH <span class=\"string\">\"/admin/application_settings/network\"</span> <span class=\"keyword\">for</span> 10.0.30.2 at 2020-03-10 11:08:20 +0000</span><br><span class=\"line\">Processing by Admin::ApplicationSettingsController<span class=\"comment\">#network as HTML</span></span><br><span class=\"line\">Parameters: &#123;<span class=\"string\">\"utf8\"</span>=&gt;<span class=\"string\">\"✓\"</span>, <span class=\"string\">\"authenticity_token\"</span>=&gt;<span class=\"string\">\"[FILTERED]\"</span>, <span class=\"string\">\"application_setting\"</span>=&gt;</span><br><span class=\"line\">&#123;<span class=\"string\">\"allow_local_requests_from_web_hooks_and_services\"</span>=&gt;<span class=\"string\">\"[FILTERED]\"</span>,</span><br><span class=\"line\"><span class=\"string\">\"allow_local_requests_from_system_hooks\"</span>=&gt;<span class=\"string\">\"[FILTERED]\"</span>, <span class=\"string\">\"outbound_local_requests_whitelist_raw\"</span>=&gt;<span class=\"string\">\"\"</span>,</span><br><span class=\"line\"><span class=\"string\">\"dns_rebinding_protection_enabled\"</span>=&gt;<span class=\"string\">\"1\"</span>&#125;&#125;</span><br><span class=\"line\">Completed 500 Internal Server Error <span class=\"keyword\">in</span> 40ms (ActiveRecord: 14.5ms | Elasticsearch: 0.0ms)</span><br><span class=\"line\">OpenSSL::Cipher::CipherError ():</span><br><span class=\"line\">lib/gitlab/crypto_helper.rb:27:<span class=\"keyword\">in</span> `aes256_gcm_decrypt<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">==&gt; /var/log/gitlab/gitlab-rails/production_json.log &lt;==</span></span><br><span class=\"line\"><span class=\"string\">&#123;\"method\":\"PATCH\",\"path\":\"/admin/application_settings/network\",\"format\":\"html\",\"controller\":\"Admin::</span></span><br><span class=\"line\"><span class=\"string\">ApplicationSettingsController\",\"action\":\"network\",\"status\":500,\"error\":\"OpenSSL::Cipher::CipherError</span></span><br><span class=\"line\"><span class=\"string\">: \",\"duration\":40.08,\"view\":0.0,\"db\":14.47,\"time\":\"2020-03-10T11:08:20.061Z\",\"params\":</span></span><br><span class=\"line\"><span class=\"string\">[&#123;\"key\":\"utf8\",\"value\":\"✓\"&#125;,&#123;\"key\":\"_method\",\"value\":\"patch\"&#125;,&#123;\"key\":\"authenticity_token\",\"value\":\"</span></span><br><span class=\"line\"><span class=\"string\">[FILTERED]\"&#125;,&#123;\"key\":\"application_setting\",\"value\":</span></span><br><span class=\"line\"><span class=\"string\">&#123;\"allow_local_requests_from_web_hooks_and_services\":\"</span></span><br><span class=\"line\"><span class=\"string\">[FILTERED]\",\"allow_local_requests_from_system_hooks\":\"</span></span><br><span class=\"line\"><span class=\"string\">[FILTERED]\",\"outbound_local_requests_whitelist_raw\":\"\",\"dns_rebinding_protection_enabled\":\"1\"&#125;&#125;],\"re</span></span><br><span class=\"line\"><span class=\"string\">mote_ip\":\"10.0.30.2\",\"user_id\":1,\"username\":\"root\",\"ua\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64)</span></span><br><span class=\"line\"><span class=\"string\">AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.87</span></span><br><span class=\"line\"><span class=\"string\">Safari/537.36\",\"queue_duration\":2.55,\"correlation_id\":\"9rvflpksdj2\"&#125;</span></span><br></pre></td></tr></table></figure>\n<p>错误关键信息: <code>OpenSSL::Cipher::CipherError ():</code><br>错误原因: 应该是重新安装 Gitlab 之后的加密信息不对所致 或者 由于迁移导入项目后，没有导入原来的加密信息 /etc/gitlab/gitlab-secrets.json ， 但是原来的加密信息文件我已经找不到了，后面发现可以直接重置就行了;<br>解决办法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#命令行输入 gitlab-rails console ，然后输入ApplicationSetting.current reset_runners_registration_token! 即可，这样在保存修改的时候就不会再报 500的问题了。</span></span><br><span class=\"line\">╭─root@gitlab ~</span><br><span class=\"line\">╰─<span class=\"comment\"># gitlab-rails console</span></span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">GitLab: 12.3.5 (2417d5becc7)</span><br><span class=\"line\">GitLab Shell: 10.0.0</span><br><span class=\"line\">PostgreSQL: 10.9</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">Loading production environment (Rails 5.2.3)</span><br><span class=\"line\">irb(main):001:0&gt; ApplicationSetting.current.reset_runners_registration_token!</span><br><span class=\"line\">=&gt; <span class=\"literal\">true</span></span><br><span class=\"line\">irb(main):002:0&gt; <span class=\"built_in\">exit</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<ul>\n<li>补充 <code>[2020年3月14日 21:31:04]</code> 时间:<br>报错信息：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Registering runner... failed runner=xxxxxxx status=couldn<span class=\"string\">'t execute POST against https://x.x.x.x/api/v4/runners: Post https://x.x.x.x/api/v4/runners: x509: cannot validate certificate for x.x.x.x because it doesn'</span>t contain any IP SANs</span><br></pre></td></tr></table></figure>\n原因：gitlab使用自签名证书时，注册时需要使用对应的ca根证书验证。<br>解决方案：注册时也需要使用<code>&quot;--tls-ca-file&quot;</code>参数，指定自签名的ca根证书。</li>\n</ul>\n<p><br></p>\n<p><strong>问题2.项目进行运行Gitlab-CI流水线上的时候报错:此作业被卡住，因为没有任何该项目指定标签的 runner 在线`</strong><br>原因:由于我们再写用.gitlab-ci.yml配置时候未在各个阶段下加入指定的Runner标签;<br>解决办法1:<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">build:</span></span><br><span class=\"line\"><span class=\"attr\">  stage:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  script:</span> <span class=\"string\">echo</span> <span class=\"string\">\"Building the app\"</span></span><br><span class=\"line\">  <span class=\"comment\">#告诉 Runner 我们应用哪个标签</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">TestRunner</span></span><br></pre></td></tr></table></figure><br>解决方法2：运行未标记的作业进行<code>勾选</code>指示此runner是否可以选择无标记的作业，此时gitlab-ci.yaml将可以不用设置tags标签;</p>\n<ul>\n<li>补充 <code>[2020年3月14日 21:31:04]</code> 时间:<br>报错信息：<code>Post https://x.x.x.x/api/v4/runners: x509: certificate signed by unknown authority</code><br>原因：注册runner时，如果设置了”–tag-list”，则”–run-untagged”默认为”false”，同时间.gitlab-ci.yml中的job未指定tag触发此报错。<br>解决方案：注册时，”–run-untagged”参数设置为”true”；或者在已注册的runner中修改勾选<code>&quot; Indicates whether this runner can pick jobs without tags&quot;</code>或者.gitlab-ci.yml中的job指定tag。</li>\n</ul>\n<p><br></p>\n<p><strong>问题3.Runner采用docker作为executor时，无法build docker image 提示dial unix /var/run/docker.sock: connect: permission denied</strong><br>原因：gitlab-runner账号权限不足，不能访问/var/run/docker.sock。<br>解决方案：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.将gitlab-runner用户加入docker组</span></span><br><span class=\"line\"><span class=\"variable\">$usermod</span> -aG docker gitlab-runner</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.gitlab-runner加入的组出现docker即没问题</span></span><br><span class=\"line\"><span class=\"variable\">$groups</span> gitlab-runner</span><br><span class=\"line\">gitlab-runner : gitlab-runner docker</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>问题4.Peer’s Certificate issuer is not recognized.</strong><br>报错信息：<code>fatal: unable to access &#39;https://gitlab-ci-token:xxxxxxxxxxxxxxxxxxxx@gitlab.x.com/root/cmop.git/&#39;: Peer&#39;s Certificate issuer is not recognized.</code><br>原因：gitlab-runner拉取代码时，使用https协议访问gitlab，需要验证。<br>解决方案：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#因runner运行时的执行者是gitlab-runner账户，需要在gitlab-runner账号下设置访问https类网站时，免验证</span></span><br><span class=\"line\">[root@gitlab-runner ~]<span class=\"comment\"># su - gitlab-runner</span></span><br><span class=\"line\">[gitlab-runner@gitlab-runner ~]$ git config --global http.<span class=\"string\">\"sslVerify\"</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\">#查看</span></span><br><span class=\"line\">[gitlab-runner@gitlab-runner ~]$ cat /home/gitlab-runner/.gitconfig </span><br><span class=\"line\">[http]</span><br><span class=\"line\">  sslVerify = <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>问题5. Couldn’t resolve host ‘gitlab.x.com’, 出现Runner无法连接网络的问题</strong><br>报错信息：<code>fatal: unable to access &#39;https://gitlab-ci-token:xxxxxxxxxxxxxxxxxxxx@gitlab.cmop.chinamcloud.com/root/cmop.git/&#39;: Couldn&#39;t resolve host &#39;gitlab.x.com&#39;</code><br>原因：executor = “docker”时，执行环境是1个容器，由于验证用的gitlab域名不能被dns解析，导致无法连接。<br>解决方案：</p>\n<ul>\n<li>在注册时使用”–docker-volumes /etc/hosts:/etc/hosts”，将运行gitlab-runner服务主机的hosts文件映射到执行容器内；</li>\n<li>注册时还可使用参数”–clone-url <a href=\"https://x.x.x.x&quot;，ip地址覆盖域名，执行容器使用ip地址直接访问gitlab。参考：https://docs.gitlab.com/runner/configuration/advanced-configuration.html#how-clone_url-works\">https://x.x.x.x&quot;，ip地址覆盖域名，执行容器使用ip地址直接访问gitlab。参考：https://docs.gitlab.com/runner/configuration/advanced-configuration.html#how-clone_url-works</a></li>\n<li>如果是在docker executor runner出现则需要在Runner的配置文件<code>config.toml</code>里增加<code>dns = [&quot;***.***.***.***&quot;]</code>，dns的值你可以通过在宿主机上运行<code>nmcli dev show</code>来获得</li>\n<li>PS：使用ip覆盖域名时，可能会带来其他问题，如果使用的是自签名的证书，需要明确ip地址是否也被自签名的ca机构认证。</li>\n</ul>\n<p><br/></p>\n<p><strong>问题6.当我的Runner采用docker作为executor时，无法build docker image</strong></p>\n<ul>\n<li>信息错误：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cannot connect to the Docker daemon at unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock. Is the docker daemon running?</span><br><span class=\"line\">time&#x3D;&quot;2020-04-17T11:12:33Z&quot; level&#x3D;error msg&#x3D;&quot;failed to dial gRPC: cannot connect to the Docker daemon. Is &#39;docker daemon&#39; running on this host?: dial unix</span><br></pre></td></tr></table></figure>\n<p>解决办法: 这是个<code>dind(docker in docker)</code>问题你可以将本地的docker socket绑定到container里来解决这个问题，具体方法是将<code>volumes = [&quot;/var/run/docker.sock:/var/run/docker.sock&quot;]</code>配置到<code>config.toml</code>文件里。</p>\n<p><br/></p>\n<p><strong>问题7.Gitlab-Runner 运行流水线时报<code>ERROR: Job failed (system failure): prepare environment: setting up scripts configMap: generating scripts config map: configmaps is forbidden: User</code>错误</strong></p>\n<ul>\n<li>问题消息:</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Running with gitlab-runner 15.0.0 (febb2a09)</span><br><span class=\"line\">  on gitlab-runner-6685dc55bd-86l2h H9xf-29K</span><br><span class=\"line\">Preparing the <span class=\"string\">\"kubernetes\"</span> executor</span><br><span class=\"line\">00:00</span><br><span class=\"line\">Using Kubernetes namespace: devops</span><br><span class=\"line\">Using Kubernetes executor with image alpine:3.16 ...</span><br><span class=\"line\">Using attach strategy to execute scripts...</span><br><span class=\"line\">Preparing environment</span><br><span class=\"line\">00:00</span><br><span class=\"line\">ERROR: Error cleaning up configmap: resource name may not be empty</span><br><span class=\"line\">ERROR: Job failed (system failure): prepare environment: setting up scripts configMap: generating scripts config map: configmaps is forbidden: User <span class=\"string\">\"system:serviceaccount:devops:default\"</span> cannot create resource <span class=\"string\">\"configmaps\"</span> <span class=\"keyword\">in</span> API group <span class=\"string\">\"\"</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">\"devops\"</span>. Check https://docs.gitlab.com/runner/shells/index.html<span class=\"comment\">#shell-profile-loading for more information</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>解决办法: 指定拥有相应权限的serviceaccount用户, 或者在helm搭建gitlab-runner时指定启动rbac.create为ture。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 方式1 ##</span></span><br><span class=\"line\"><span class=\"comment\"># 更改gitlab-runner图表配置文件指定启用rbac支持。</span></span><br><span class=\"line\"><span class=\"comment\">## For RBAC support:</span></span><br><span class=\"line\">rbac:</span><br><span class=\"line\">  create: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 方式2 ##</span></span><br><span class=\"line\"><span class=\"comment\"># 1.在devops名称空间中创建一个serviceaccount名为gitlab-runner并为该服务用户绑定admin角色(生产环境中建议指定最小资源操作权限)</span></span><br><span class=\"line\">kubectl create serviceaccount gitlab-runner --namespace devops</span><br><span class=\"line\">kubectl create clusterrolebinding gitlab-runner --clusterrole=admin --serviceaccount=devops:gitlab-runner</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.更改图表配置文件指定serviceAccountName为gitlab-runner</span></span><br><span class=\"line\"><span class=\"comment\">## For RBAC support:</span></span><br><span class=\"line\">rbac:</span><br><span class=\"line\">  create: <span class=\"literal\">false</span></span><br><span class=\"line\">  serviceAccountName: gitlab-runner</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.更新部署 gitlab-runner </span></span><br><span class=\"line\">helm upgrade --namespace devops gitlab-runner --version 0.41.0  -f ./gitlab-runner.yaml gitlab/gitlab-runner</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>问题8.使用Gitlab-runner执行devops项目的CICD流水线作业时报<code>fatal: unable to access &#39;[Gitlab项目的git地址]&#39;: The requested URL returned error: 403</code>错误解决</strong></p>\n<ul>\n<li>错误信息: </li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Getting <span class=\"built_in\">source</span> from Git repository</span><br><span class=\"line\">00:01</span><br><span class=\"line\">Fetching changes with git depth <span class=\"built_in\">set</span> to 50...</span><br><span class=\"line\">Initialized empty Git repository <span class=\"keyword\">in</span> /builds/WeiyiGeek/devops/.git/</span><br><span class=\"line\">Created fresh repository.</span><br><span class=\"line\">remote: You are not allowed to download code from this project.</span><br><span class=\"line\">fatal: unable to access <span class=\"string\">'http://gitlab.weiyigeek.top/WeiyiGeek/devops.git/'</span>: The requested URL returned error: 403</span><br><span class=\"line\">ERROR: Job failed: <span class=\"built_in\">command</span> terminated with <span class=\"built_in\">exit</span> code 1</span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>问题原因: 由于项目是私有权限而非public权限, 而有加之执行更改的项目的用户为root并为加入到devops项目成员中。</p>\n</li>\n<li><p>解决办法: 一是将该项目改为public公共项目(针对一些非私密的项目), 二是在私有项目添加指定触发成员(此种方式常用)，例如此处我们将devops用户加入到devops项目中并赋予最小的Guest权限即可，然后在运行流水线作业即可。</p>\n</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"持续集成与交互","path":"api/categories/持续集成与交互.json"}],"tags":[{"name":"gitlab","path":"api/tags/gitlab.json"}]}