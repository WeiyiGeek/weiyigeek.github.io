{"title":"Redis内存数据库环境快速搭建部署","slug":"系统运维/快速部署/Redis","date":"2022-04-24T02:30:30.000Z","updated":"2022-09-20T09:10:31.300Z","url":"2022/4-24-653.html","path":"api/articles/2022/4-24-653.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"Docker-快速部署单实例-redis-数据库\"><a href=\"#Docker-快速部署单实例-redis-数据库\" class=\"headerlink\" title=\"Docker 快速部署单实例 redis 数据库\"></a>Docker 快速部署单实例 redis 数据库</h2><p><strong>Shell 命令示例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -vp /app/redis/data</span><br><span class=\"line\">tee /app/redis/redis.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># Author: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\"># blog: https://blog.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\"># 绑定任意接口、服务端口、后台运行。</span></span><br><span class=\"line\"><span class=\"built_in\">bind</span> 0.0.0.0</span><br><span class=\"line\">port 6379</span><br><span class=\"line\"><span class=\"comment\"># 容器里必须设置为no</span></span><br><span class=\"line\">daemonize no</span><br><span class=\"line\">supervised auto</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># redis服务pid进程文件名</span></span><br><span class=\"line\">pidfile <span class=\"string\">\"/var/run/redis.pid\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭保护模式，并配置使用密码访问</span></span><br><span class=\"line\">protected-mode no</span><br><span class=\"line\">requirepass <span class=\"string\">\"123456\"</span></span><br><span class=\"line\"><span class=\"comment\"># echo -e \"weiyigeek\"|sha256sum </span></span><br><span class=\"line\"><span class=\"comment\"># requirepass 097575a79efcd7ea7b1efa2bcda78a4fc7cbd0820736b2f2708e72c3d21f8b61</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 数据文件保存路径，rdb/AOF文件也保存在这里</span></span><br><span class=\"line\">dir <span class=\"string\">\"/data\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日志文件记录文件(notice / verbose)</span></span><br><span class=\"line\"><span class=\"comment\"># logfile \"/logs/redis.log\"</span></span><br><span class=\"line\"><span class=\"comment\"># loglevel verbose  </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 最大客户端连接数</span></span><br><span class=\"line\">maxclients 10000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 客户端连接空闲多久后断开连接，单位秒，0表示禁用</span></span><br><span class=\"line\">timeout 60</span><br><span class=\"line\">tcp-keepalive 60 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Redis 数据持久化(rdb/aof)配置</span></span><br><span class=\"line\"><span class=\"comment\"># RDB 文件名</span></span><br><span class=\"line\">dbfilename <span class=\"string\">\"dump.rdb\"</span></span><br><span class=\"line\"><span class=\"comment\"># 数据自动保存脚本条件例如300s中有10key发生变化</span></span><br><span class=\"line\">save 300 10</span><br><span class=\"line\">save 60 10000</span><br><span class=\"line\"><span class=\"comment\"># 对RDB文件进行压缩，建议以（磁盘）空间换（CPU）时间。</span></span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\"><span class=\"comment\"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span></span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\"><span class=\"comment\"># RDB自动触发策略是否启用，默认为yes</span></span><br><span class=\"line\">rdb-save-incremental-fsync yes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># AOF开启</span></span><br><span class=\"line\">appendonly yes</span><br><span class=\"line\"><span class=\"comment\"># AOF文件名</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\"><span class=\"comment\"># 可选值 always， everysec，no，建议设置为everysec</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Redis风险命令重命名</span></span><br><span class=\"line\"><span class=\"comment\"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class=\"line\">rename-command FLUSHDB b840fc02d524045429941cc15f59e41cb7be6c53</span><br><span class=\"line\">rename-command FLUSHALL b840fc02d524045429941cc15f59e41cb7be6c54</span><br><span class=\"line\">rename-command EVAL b840fc02d524045429941cc15f59e41cb7be6c55</span><br><span class=\"line\">rename-command DEBUG b840fc02d524045429941cc15f59e41cb7be6c56</span><br><span class=\"line\"><span class=\"comment\"># rename-command SHUTDOWN SHUTDOWN</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># docker 环境</span></span><br><span class=\"line\">$ docker run -d -p 6379:6379 \\</span><br><span class=\"line\"> -v /app/redis/redis.conf:/etc/redis/redis.conf \\</span><br><span class=\"line\"> -v /app/redis/data:/data \\</span><br><span class=\"line\">  --name redis-server redis:6.2.6-alpine3.15 redis-server /etc/redis/redis.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># nerdctl + containerd 环境</span></span><br><span class=\"line\">$ nerdctl run -d -p 6379:6379 \\</span><br><span class=\"line\"> -v /app/redis/redis.conf:/etc/redis/redis.conf \\</span><br><span class=\"line\"> -v /app/redis/data:/data \\</span><br><span class=\"line\"> --name redis-server redis:6.2.6-alpine3.15 redis-server /etc/redis/redis.conf</span><br><span class=\"line\">5e854a58087ae1bba5a661b2941474560cbecc37f54c7f4e7a28afbaed6aebf0</span><br></pre></td></tr></table></figure></p>\n<p><strong>执行结果:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看容器是否运行</span></span><br><span class=\"line\">$ docker ps</span><br><span class=\"line\">CONTAINER ID   IMAGE                          COMMAND                  CREATED          STATUS          PORTS                    NAMES</span><br><span class=\"line\">2919b8a9478a   redis:6.2.6-alpine3.15         <span class=\"string\">\"docker-entrypoint.s…\"</span>   20 seconds ago   Up 19 seconds   0.0.0.0:6379-&gt;6379/tcp   redis-server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 连接redis数据库是否正常</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it redis-server redis-cli -a 123456 ping</span><br><span class=\"line\">Warning: Using a password with <span class=\"string\">'-a'</span> or <span class=\"string\">'-u'</span> option on the <span class=\"built_in\">command</span> line interface may not be safe.</span><br><span class=\"line\">PONG</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h2 id=\"Kubernetes-快速部署单实例-redis-数据库\"><a href=\"#Kubernetes-快速部署单实例-redis-数据库\" class=\"headerlink\" title=\"Kubernetes 快速部署单实例 redis 数据库\"></a>Kubernetes 快速部署单实例 redis 数据库</h2><p>步骤01.创建configMap 资源清单配置Redis.conf (此处还是采用上述 /app/redis/redis.conf )<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap -n database redis-single-conf --from-file=/app/redis/redis.conf</span><br><span class=\"line\">kubectl get configmap -n database redis-single-conf</span><br><span class=\"line\"><span class=\"comment\"># NAME                DATA   AGE</span></span><br><span class=\"line\"><span class=\"comment\"># redis-single-conf   1      30s</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤02.StatefulSet 与 SVC 资源清单:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee redis-single-server.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: StatefulSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: __APPNAME__</span><br><span class=\"line\">  namespace: __APPNAMESPACE__</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    description: redis-single</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  serviceName: __APPNAME__</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: __APPNAME__</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: __APPNAME__</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: redis</span><br><span class=\"line\">        image: redis:6.2.6-alpine3.15</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 6379</span><br><span class=\"line\">          name: server</span><br><span class=\"line\">        <span class=\"built_in\">command</span>: [ <span class=\"string\">\"redis-server\"</span>, <span class=\"string\">\"/conf/redis.conf\"</span>]</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        <span class=\"comment\"># 从configmap获取的配置文件，挂载到指定文件中【https://blog.weiyigeek.top】.</span></span><br><span class=\"line\">        - name: conf</span><br><span class=\"line\">          mountPath: /conf/redis.conf</span><br><span class=\"line\">          subPath: redis.conf</span><br><span class=\"line\">        - name: data</span><br><span class=\"line\">          mountPath: /data</span><br><span class=\"line\">        <span class=\"comment\"># - name: logs</span></span><br><span class=\"line\">        <span class=\"comment\">#   mountPath: /logs</span></span><br><span class=\"line\">        <span class=\"comment\"># 时区设置</span></span><br><span class=\"line\">        - name: timezone</span><br><span class=\"line\">          mountPath: /etc/localtime              </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: conf</span><br><span class=\"line\">        <span class=\"comment\"># 配置文件采用configMap</span></span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: redis-single-conf</span><br><span class=\"line\">          defaultMode: 0755</span><br><span class=\"line\">        <span class=\"comment\"># 日志采用hostPath卷</span></span><br><span class=\"line\">      - name: logs</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          <span class=\"built_in\">type</span>: DirectoryOrCreate </span><br><span class=\"line\">          path: /nfsdisk-31/datastore/redis/demo1/logs</span><br><span class=\"line\">        <span class=\"comment\"># 时区定义</span></span><br><span class=\"line\">      - name: timezone                             </span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class=\"line\">  volumeClaimTemplates:</span><br><span class=\"line\">  - metadata:</span><br><span class=\"line\">      name: data</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      accessModes: [ <span class=\"string\">\"ReadWriteOnce\"</span> ]</span><br><span class=\"line\">      storageClassName: <span class=\"string\">\"__STORAGECLASSNAME__\"</span></span><br><span class=\"line\">      resources:</span><br><span class=\"line\">        requests:</span><br><span class=\"line\">          storage: 2Gi</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: __APPNAME__</span><br><span class=\"line\">  namespace: __APPNAMESPACE__</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 6379</span><br><span class=\"line\">    targetPort: 6379</span><br><span class=\"line\">    name: tcp</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: __APPNAME__</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意 替换 storageClassName</span></span><br><span class=\"line\">sed -i -e <span class=\"string\">'s/__APPNAME__/redis-single/g'</span> -e <span class=\"string\">'s/__APPNAMESPACE__/database/g'</span> -e <span class=\"string\">'s/__STORAGECLASSNAME__/managed-nfs-storage/'</span> redis-single-server.yaml</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 03.部署资源清单到Kubernetes集群<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f redis-single-server.yaml</span><br><span class=\"line\"><span class=\"comment\"># statefulset.apps/redis-single created</span></span><br><span class=\"line\"><span class=\"comment\"># service/redis-single created</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 04.验证部署应用资源<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n database -l app=redis-single</span><br><span class=\"line\">  <span class=\"comment\"># NAME             READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-single-0   1/1     Running   0          16m</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get svc -n database redis-single</span><br><span class=\"line\">  <span class=\"comment\"># NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-single   ClusterIP   11.19.196.169   &lt;none&gt;        6379/TCP   15m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 连接到redis数据库</span></span><br><span class=\"line\">$ telnet 11.19.196.169 6379</span><br><span class=\"line\">  <span class=\"comment\"># Trying 11.19.196.169...</span></span><br><span class=\"line\">  <span class=\"comment\"># Connected to 11.19.196.169.</span></span><br><span class=\"line\">  <span class=\"comment\"># Escape character is '^]'.</span></span><br><span class=\"line\">  <span class=\"comment\"># auth 123456</span></span><br><span class=\"line\">  <span class=\"comment\"># +OK</span></span><br><span class=\"line\">  <span class=\"comment\"># ping</span></span><br><span class=\"line\">  <span class=\"comment\"># +PONG</span></span><br><span class=\"line\">  <span class=\"comment\"># info</span></span><br><span class=\"line\">  <span class=\"comment\"># $4241</span></span><br><span class=\"line\">  <span class=\"comment\"># # Server</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_version:6.2.6</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_git_sha1:00000000</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_git_dirty:0</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_build_id:63421500bb103677</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_mode:standalone</span></span><br><span class=\"line\">  <span class=\"comment\"># os:Linux 4.20.13-1.el7.elrepo.x86_64 x86_64</span></span><br><span class=\"line\">  <span class=\"comment\"># arch_bits:64</span></span><br><span class=\"line\">  <span class=\"comment\"># multiplexing_api:epoll</span></span><br><span class=\"line\">  <span class=\"comment\"># atomicvar_api:atomic-builtin</span></span><br><span class=\"line\">  <span class=\"comment\"># gcc_version:10.3.1</span></span><br><span class=\"line\">  <span class=\"comment\"># process_id:1</span></span><br><span class=\"line\">  <span class=\"comment\"># process_supervised:no</span></span><br><span class=\"line\">  <span class=\"comment\"># run_id:677b6d0188b564670f26ce47154b70c8aa6c3f04</span></span><br><span class=\"line\">  <span class=\"comment\"># tcp_port:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># server_time_usec:1650962303340701</span></span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 集群中的其它应用，我们可以通过svc的地址或者集群dns域名(<code>redis-single.database</code>-推荐)来访问该pod。</p>\n<p><br/></p>\n<h2 id=\"Kubernetes-快速部署-RedisInsight-工具\"><a href=\"#Kubernetes-快速部署-RedisInsight-工具\" class=\"headerlink\" title=\"Kubernetes 快速部署 RedisInsight 工具\"></a>Kubernetes 快速部署 RedisInsight 工具</h2><p>参考地址：<a href=\"https://docs.redis.com/latest/ri/installing/install-k8s/\" target=\"_blank\" rel=\"noopener\">https://docs.redis.com/latest/ri/installing/install-k8s/</a></p>\n<p>步骤 01.集群中快速 redisinsight 部署资源清单。<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">redisinsight-1.13.0.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># RedisInsight service with name 'redisinsight-service'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redisinsight-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">8001</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redisinsight</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># RedisInsight deployment with name 'redisinsight'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redisinsight</span>   <span class=\"comment\"># deployment name</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redisinsight</span>  <span class=\"comment\"># deployment label</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span>          <span class=\"comment\"># a single replica pod</span></span><br><span class=\"line\"><span class=\"attr\">  strategy:</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">redisinsight</span> <span class=\"comment\"># which pods is the deployment managing, as defined by the pod template</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span>             <span class=\"comment\"># pod template</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">redisinsight</span> <span class=\"comment\"># label for pod/s</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">          emptyDir:</span> <span class=\"string\">&#123;&#125;</span>    <span class=\"comment\"># node-ephemeral volume https://kubernetes.io/docs/concepts/storage/volumes/#emptydir</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span>  <span class=\"string\">redisinsight</span>                  <span class=\"comment\"># Container name (DNS_LABEL, unique)</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">redislabs/redisinsight:1.13.0</span> <span class=\"comment\"># Hub Image</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span>        <span class=\"comment\"># Pull Policy</span></span><br><span class=\"line\"><span class=\"attr\">          env:</span> </span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">RIHOST</span></span><br><span class=\"line\"><span class=\"attr\">            value:</span> <span class=\"string\">\"0.0.0.0\"</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">RIPORT</span></span><br><span class=\"line\"><span class=\"attr\">            value:</span> <span class=\"string\">\"8001\"</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">db</span> </span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">/db</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">          - containerPort:</span> <span class=\"number\">8001</span>        <span class=\"comment\"># exposed container port and protocol</span></span><br><span class=\"line\"><span class=\"attr\">            protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          livenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">           httpGet:</span></span><br><span class=\"line\">              <span class=\"string\">path</span> <span class=\"string\">:</span> <span class=\"string\">/healthcheck/</span>     <span class=\"comment\"># exposed RI endpoint for healthcheck</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span> <span class=\"number\">8001</span>               <span class=\"comment\"># exposed container port</span></span><br><span class=\"line\"><span class=\"attr\">           initialDelaySeconds:</span> <span class=\"number\">5</span>      <span class=\"comment\"># number of seconds to wait after the container starts to perform liveness probe</span></span><br><span class=\"line\"><span class=\"attr\">           periodSeconds:</span> <span class=\"number\">5</span>            <span class=\"comment\"># period in seconds after which liveness probe is performed</span></span><br><span class=\"line\"><span class=\"attr\">           failureThreshold:</span> <span class=\"number\">1</span>         <span class=\"comment\"># number of liveness probe failures after which container restarts</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 02.部署命令<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create ns dev</span><br><span class=\"line\">kubectl apply -f redisinsight-1.13.0.yaml</span><br></pre></td></tr></table></figure></p>\n<p>步骤 03.验证服务(你可按照需求使用nodeport或者ingress进行暴露端口)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pod -n dev</span><br><span class=\"line\">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">redisinsight-5c4f954694-jc5cd   1/1     Running   0          95s</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl -n dev port-forward deployment/redisinsight --address 0.0.0.0 30081:8001</span><br><span class=\"line\">Forwarding from 0.0.0.0:30081 -&gt; 8001</span><br><span class=\"line\">Handling connection <span class=\"keyword\">for</span> 30081</span><br><span class=\"line\">Handling connection <span class=\"keyword\">for</span> 30081</span><br><span class=\"line\">Handling connection <span class=\"keyword\">for</span> 30081</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"部署运维","path":"api/categories/部署运维.json"},{"name":"环境快速搭建","path":"api/categories/环境快速搭建.json"}],"tags":[{"name":"Redis","path":"api/tags/Redis.json"}]}