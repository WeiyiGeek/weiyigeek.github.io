{"title":"Linux安全运维加公配置","slug":"网安防御/Linux安全与防御/加固防御/Linux安全加固配置","date":"2019-04-13T06:36:30.000Z","updated":"2022-03-29T05:39:02.682Z","url":"2019/4-13-431.html","path":"api/articles/2019/4-13-431.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190814125609.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190510165410.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h4><p>描述：Linux系统加固往往是下面几个方面入手,配置完成后将大大的提升机器的安全性，同时满足等保合规的要求;</p>\n<p>系统加固分类:</p>\n<ul>\n<li><p>用户加固管理</p>\n<ul>\n<li>用户权限</li>\n<li>口令增强</li>\n</ul>\n</li>\n<li><p>日志加固管理</p>\n</li>\n</ul>\n<ul>\n<li>业务隔离</li>\n<li>服务安全</li>\n</ul>\n<hr>\n<h4 id=\"0x01-用户加固管理\"><a href=\"#0x01-用户加固管理\" class=\"headerlink\" title=\"0x01 用户加固管理\"></a>0x01 用户加固管理</h4><h5 id=\"1-用户与权限加固\"><a href=\"#1-用户与权限加固\" class=\"headerlink\" title=\"1.用户与权限加固\"></a>1.用户与权限加固</h5><p><strong>1.1) 用户与系统文件权限</strong><br>描述:主要针对于用户默认权限以及文件目录创建的缺省权限;</p>\n<p>PS:用户的umask安全配置将umask修改为022权限掩码即用户所获得的<code>文件权限为644 (666-022)，目录权限为755 (777-022)</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 用户的umask安全配置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 修改<span class=\"built_in\">umask</span>为022  \\*\\*\\*\\* </span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*umask\\s+\\w+.*$\"</span> /etc/profile &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*umask\\s+\\w+.*$/umask 022/\"</span> /etc/profile || <span class=\"built_in\">echo</span> <span class=\"string\">\"umask 022\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*umask\\s+\\w+.*$\"</span> /etc/csh.login &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*umask\\s+\\w+.*$/umask 022/\"</span> /etc/csh.login || <span class=\"built_in\">echo</span> <span class=\"string\">\"umask 022\"</span> &gt;&gt;/etc/csh.login</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*umask\\s+\\w+.*$\"</span> /etc/csh.cshrc &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*umask\\s+\\w+.*$/umask 022/\"</span> /etc/csh.cshrc || <span class=\"built_in\">echo</span> <span class=\"string\">\"umask 022\"</span> &gt;&gt; /etc/csh.cshrc</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*umask\\s+\\w+.*$\"</span> /etc/bashrc &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*umask\\s+\\w+.*$/umask 022/\"</span> /etc/bashrc || <span class=\"built_in\">echo</span> <span class=\"string\">\"umask 022\"</span> &gt;&gt; /etc/bashrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用户目录缺省访问权限设置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 设置用户目录默认权限为022</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*(umask|UMASK)\\s+\\w+.*$\"</span> /etc/login.defs &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*(umask|UMASK)\\s+\\w+.*$/UMASK 022/\"</span> /etc/login.defs || <span class=\"built_in\">echo</span> <span class=\"string\">\"UMASK 022\"</span> &gt;&gt; /etc/login.defs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重要目录和文件的权限设置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 设置重要目录和文件的权限</span><br><span class=\"line\">chmod 755 /etc; chmod 750 /etc/rc.d/init.d; chmod 777 /tmp; chmod 700 /etc/inetd.conf&amp;&gt;/dev/null 2&amp;&gt;/dev/null; chmod 755 /etc/passwd; chmod 755 /etc/shadow; chmod 644 /etc/group; chmod 755 /etc/security; chmod 644 /etc/services; chmod 750 /etc/rc*.d</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>CentOS禁止普通用户su到root相关权限涉及到两个文件:</p>\n<ul>\n<li>/etc/pam.d/su</li>\n<li>/etc/login.defs<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#禁止普通用户su到root,配置如下：</span></span><br><span class=\"line\"><span class=\"comment\">#去除/etc/pam.d/su文件中如下行的注释，保存退出即可(即时生效)：</span></span><br><span class=\"line\"><span class=\"comment\">#auth           required        pam_wheel.so use_uid</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#禁止普通用户su到root，但是希望指定的普通用户可以su到root</span></span><br><span class=\"line\">在/etc/login.defs文件中加入如下配置项,保持退出(即时生效)：</span><br><span class=\"line\">SU_WHEEL_ONLY yes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#将需要su到root用户的用户名添加至wheel组中，我们以admin为例：</span></span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># usermod -G wheel admin</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190814125609.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n<p><br></p>\n<p><strong>1.2) 用户账号加固</strong><br>描述:锁定与设备运行、维护等工作无关的账号，如果不需要登录系统shell应该<code>/sbin/nologin</code>并且将该账号进行锁定登陆;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 锁定与设备运行、维护等工作无关的账号</span></span><br><span class=\"line\">passwd -l adm&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l daemon&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l bin&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l sys&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l lp&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l uucp&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l nuucp&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l smmsplp&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l mail&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l operator&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l games&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l gopher&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l ftp&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l nobody&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l nobody4&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l noaccess&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l listen&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l webservd&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l rpm&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l dbus&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l avahi&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l mailnull&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l nscd&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l vcsa&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l rpc&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l rpcuser&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l nfs&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l sshd&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l pcap&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l ntp&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l haldaemon&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l distcache&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l webalizer&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l squid&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l xfs&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l gdm&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l sabayon&amp;&gt;/dev/null 2&amp;&gt;/dev/null; passwd -l named&amp;&gt;/dev/null 2&amp;&gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 核验配置减少系统无用账号降低风险</span></span><br><span class=\"line\">$ nano /etc/passwd  </span><br><span class=\"line\">root:x:0:0:root:/root:/bin/bash</span><br><span class=\"line\">bin:x:1:1:bin:/bin:/sbin/nologin</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190510165410.png\" alt=\"WeiyiGeek.passwd\" title=\"\" class=\"\">\n                <p>WeiyiGeek.passwd</p>\n            </figure></p>\n<p>用户超时限制:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 登录超时设置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 设置登录超时时间为10分钟</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*(export|)\\s*TMOUT\\S\\w+.*$\"</span> /etc/profile &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*(export|)\\s*TMOUT.\\S\\w+.*$/export TMOUT=600/\"</span> /etc/profile || <span class=\"built_in\">echo</span> <span class=\"string\">\"export TMOUT=600\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*.*ClientAliveInterval\\s\\w+.*$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*.*ClientAliveInterval\\s\\w+.*$/ClientAliveInterval 600/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"ClientAliveInterval 600 \"</span> &gt;&gt; /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure></p>\n<p>用户访问限制:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#所有 /etc/ssh/user_deny_list 里面的用户被拒绝ssh登录, 启用 PAM-Authentication  </span></span><br><span class=\"line\">vim /etc/pam.d/sshd </span><br><span class=\"line\">auth required /usr/lib64/security/pam_listfile.so item=user sense=deny file=/etc/ssh/user_deny_list onerr=succeed</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"2-用户认证密码策略调整\"><a href=\"#2-用户认证密码策略调整\" class=\"headerlink\" title=\"2.用户认证密码策略调整\"></a>2.用户认证密码策略调整</h5><p>描述:设置用户登陆口令的复杂度以及长度限制,以及登录session失效时间;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 小写字母、数字、特殊字、大写字母，登陆尝试三次返回错误信息，可自行修改</span></span><br><span class=\"line\">vi /etc/pam.d/system-auth</span><br><span class=\"line\">password  requisite pam_cracklib.so retry=5 difok=3 minlen=12 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1   <span class=\"comment\">#至少12位包含一位大写字母，一位小写字母和一位数字以及一位特殊字符</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改system-auth</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*password\\s*(requisite|required)\\s*pam_cracklib.so.*$\"</span> /etc/pam.d/system-auth  &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*password\\s*(requisite|required)\\s*pam_cracklib.so.*$/\\password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=12 dcredit=-1 ocredit=-1 lcredit=-1/\"</span> /etc/pam.d/system-auth || <span class=\"built_in\">echo</span> <span class=\"string\">\"password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=12 dcredit=-1 ocredit=-1 lcredit=-1\"</span> &gt;&gt; /etc/pam.d/system-auth</span><br><span class=\"line\"><span class=\"comment\"># 修改password-auth</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*password\\s*(requisite|required)\\s*pam_cracklib.so.*$\"</span> /etc/pam.d/password-auth &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*password\\s*(requisite|required)\\s*pam_cracklib.so.*$/\\password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=12 dcredit=-1 ocredit=-1 lcredit=-1/\"</span> /etc/pam.d/password-auth || <span class=\"built_in\">echo</span> <span class=\"string\">\"password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=12 dcredit=-1 ocredit=-1 lcredit=-1\"</span> &gt;&gt; /etc/pam.d/password-auth</span><br><span class=\"line\"><span class=\"comment\"># 修改login.defs</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*PASS_MIN_LEN\\s+\\S*(\\s*#.*)?\\s*$\"</span> /etc/login.defs &amp;&amp; sed -ri <span class=\"string\">\"s/^(\\s*)PASS_MIN_LEN\\s+\\S*(\\s*#.*)?\\s*$/\\PASS_MIN_LEN    12/\"</span> /etc/login.defs || <span class=\"built_in\">echo</span> <span class=\"string\">\"PASS_MIN_LEN    12\"</span> &gt;&gt; /etc/login.defs</span><br></pre></td></tr></table></figure><br>口令的生存周期:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方法1:</span></span><br><span class=\"line\">$ vi /etc/login.defs 修改配置文件</span><br><span class=\"line\"><span class=\"comment\">#$ chage -m 0 -M 30 -E 2018-11-01 -W 7 &lt;用户名&gt;   #改变用户的到期时间</span></span><br><span class=\"line\"><span class=\"comment\">#-------------------------------------------------------------------</span></span><br><span class=\"line\">PASS_MAX_DAYS   180        <span class=\"comment\">#新建用户的密码最长使用天数</span></span><br><span class=\"line\">PASS_MIN_DAYS   14          <span class=\"comment\">#新建用户的密码最短使用天数</span></span><br><span class=\"line\">PASS_WARN_AGE   14          <span class=\"comment\">#新建用户的密码到期提前提醒天数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方法2:</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 口令生成周期最小14天最大180天预警14前天 \\*\\*\\*\\*</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*PASS_MAX_DAYS\\s+\\S*(\\s*#.*)?\\s*$\"</span> /etc/login.defs &amp;&amp; sed -ri <span class=\"string\">\"s/^(\\s*)PASS_MAX_DAYS\\s+\\S*(\\s*#.*)?\\s*$/\\PASS_MAX_DAYS   180/\"</span> /etc/login.defs || <span class=\"built_in\">echo</span> <span class=\"string\">\"PASS_MAX_DAYS   180\"</span> &gt;&gt; /etc/login.defs</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*PASS_MIN_DAYS\\s+\\S*(\\s*#.*)?\\s*$\"</span> /etc/login.defs &amp;&amp; sed -ri <span class=\"string\">\"s/^(\\s*)PASS_MIN_DAYS\\s+\\S*(\\s*#.*)?\\s*$/\\PASS_MIN_DAYS   14/\"</span> /etc/login.defs || <span class=\"built_in\">echo</span> <span class=\"string\">\"PASS_MIN_DAYS   14\"</span> &gt;&gt; /etc/login.defs</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*PASS_WARN_AGE\\s+\\S*(\\s*#.*)?\\s*$\"</span> /etc/login.defs &amp;&amp; sed -ri <span class=\"string\">\"s/^(\\s*)PASS_WARN_AGE\\s+\\S*(\\s*#.*)?\\s*$/\\PASS_WARN_AGE   14/\"</span> /etc/login.defs || <span class=\"built_in\">echo</span> <span class=\"string\">\"PASS_WARN_AGE   14\"</span> &gt;&gt; /etc/login.defs</span><br></pre></td></tr></table></figure></p>\n<p>密码重复使用次数限制:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 手动创建/etc/security/opasswd，解决首次登录修改密码时提示\"passwd: Authentication token manipulation error\"</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 记住3次已使用的密码 \\*\\*\\*\\*</span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ ! -f <span class=\"string\">\"/etc/security/opasswd\"</span> || <span class=\"string\">\"<span class=\"variable\">$(ls -l /etc/security/opasswd | egrep -c '\\-rw\\-\\-\\-\\-\\-\\-\\-')</span>\"</span> != <span class=\"string\">\"1\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">  mv /etc/security/opasswd /etc/security/opasswd.old &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">  touch /etc/security/opasswd</span><br><span class=\"line\">  chown root:root /etc/security/opasswd</span><br><span class=\"line\">  chmod +600 /etc/security/opasswd</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改system-auth</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*password\\s*sufficient\\s*pam_unix.so.*$\"</span> /etc/pam.d/system-auth &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*password\\s*sufficient\\s*pam_unix.so.*$/\\password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok remember=3/\"</span> /etc/pam.d/system-auth || <span class=\"built_in\">echo</span> <span class=\"string\">\"password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok remember=3\"</span> &gt;&gt; /etc/pam.d/system-auth</span><br><span class=\"line\"><span class=\"comment\"># 修改password-auth</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*password\\s*sufficient\\s*pam_unix.so.*$\"</span> /etc/pam.d/password-auth &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*password\\s*sufficient\\s*pam_unix.so.*$/\\password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok remember=3/\"</span> /etc/pam.d/password-auth || <span class=\"built_in\">echo</span> <span class=\"string\">\"password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok remember=3\"</span> &gt;&gt; /etc/pam.d/password-auth</span><br></pre></td></tr></table></figure></p>\n<p>用户认证失败次数限制:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置文件 /etc/pam.d/sshd /etc/pam.d/login /etc/pam.d/system-auth /etc/pam.d/password-auth</span></span><br><span class=\"line\">auth required pam_tally.so onerr=fail deny=10 unlock_time=300      <span class=\"comment\">#设置连续输错10次密码，帐号锁定5分钟，</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 连续登录失败5次锁定帐号5分钟 \\*\\*\\*\\*</span><br><span class=\"line\">sed -ri <span class=\"string\">\"/^\\s*auth\\s+required\\s+pam_tally2.so\\s+.+(\\s*#.*)?\\s*$/d\"</span> /etc/pam.d/sshd /etc/pam.d/login /etc/pam.d/system-auth /etc/pam.d/password-auth</span><br><span class=\"line\">sed -ri <span class=\"string\">'1a auth       required     pam_tally2.so deny=5 unlock_time=300 even_deny_root root_unlock_time=30'</span> /etc/pam.d/sshd /etc/pam.d/login /etc/pam.d/system-auth /etc/pam.d/password-auth</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*account\\s+required\\s+pam_tally2.so\\s*(\\s*#.*)?\\s*$\"</span> /etc/pam.d/sshd || sed -ri <span class=\"string\">'/^password\\s+.+(\\s*#.*)?\\s*$/i\\account    required     pam_tally2.so'</span> /etc/pam.d/sshd</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*account\\s+required\\s+pam_tally2.so\\s*(\\s*#.*)?\\s*$\"</span> /etc/pam.d/login || sed -ri <span class=\"string\">'/^password\\s+.+(\\s*#.*)?\\s*$/i\\account    required     pam_tally2.so'</span> /etc/pam.d/login</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*account\\s+required\\s+pam_tally2.so\\s*(\\s*#.*)?\\s*$\"</span> /etc/pam.d/system-auth || sed -ri <span class=\"string\">'/^account\\s+required\\s+pam_permit.so\\s*(\\s*#.*)?\\s*$/a\\account     required      pam_tally2.so'</span> /etc/pam.d/system-auth</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*account\\s+required\\s+pam_tally2.so\\s*(\\s*#.*)?\\s*$\"</span> /etc/pam.d/password-auth || sed -ri <span class=\"string\">'/^account\\s+required\\s+pam_permit.so\\s*(\\s*#.*)?\\s*$/a\\account     required      pam_tally2.so'</span> /etc/pam.d/password-auth</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x02-日志加固管理\"><a href=\"#0x02-日志加固管理\" class=\"headerlink\" title=\"0x02 日志加固管理\"></a>0x02 日志加固管理</h4><h5 id=\"1-日志审计记录\"><a href=\"#1-日志审计记录\" class=\"headerlink\" title=\"1.日志审计记录\"></a>1.日志审计记录</h5><p>描述：在反弹shell的时候使用了bash-i时,如果系统配置了/etc/bash.bashrc、~/.bashrc记录执行记录，应该可以记录到bash -i的执行记录（交互式会话会读取bashrc配置并执行）</p>\n<p>基础操作:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1.防止/var/log中的日志被删除</span></span><br><span class=\"line\">chattr -R +a /var/<span class=\"built_in\">log</span></span><br><span class=\"line\">lsattr -a /var/<span class=\"built_in\">log</span></span><br><span class=\"line\">-----a---------- /var/<span class=\"built_in\">log</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2.记录su命令使用情况</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*authpriv\\.\\*\\s+.+$\"</span> /etc/rsyslog.conf &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*authpriv\\.\\*\\s+.+$/authpriv.*                                              \\/var\\/log\\/secure/\"</span> /etc/rsyslog.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"authpriv.*                                              /var/log/secure\"</span> &gt;&gt; /etc/rsyslog.conf</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例3.记录安全事件日志</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 配置安全事件日志审计</span><br><span class=\"line\">touch /var/<span class=\"built_in\">log</span>/adm&amp;&gt;/dev/null; chmod 755 /var/<span class=\"built_in\">log</span>/adm</span><br><span class=\"line\">semanage fcontext -a -t security_t <span class=\"string\">'/var/log/adm'</span></span><br><span class=\"line\">restorecon -v <span class=\"string\">'/var/log/adm'</span>&amp;&gt;/dev/null</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*\\*\\.err;kern.debug;daemon.notice\\s+.+$\"</span> /etc/rsyslog.conf &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*\\*\\.err;kern.debug;daemon.notice\\s+.+$/*.err;kern.debug;daemon.notice           \\/var\\/adm\\/messages/\"</span> /etc/rsyslog.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"*.err;kern.debug;daemon.notice           /var/log/adm\"</span> &gt;&gt; /etc/rsyslog.conf</span><br></pre></td></tr></table></figure></p>\n<p>历史命令设置:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Centos7 /etc/profile</span></span><br><span class=\"line\"><span class=\"comment\">#比如登陆过系统的用户、IP地址、操作命令以及操作时间--对应可以通过在/etc/profile里面加入以下代码实现</span></span><br><span class=\"line\"><span class=\"comment\">#47:HISTTIMEFORMAT=\"%F %T who -u am i 2&gt;/dev/null| awk '&#123;print $NF&#125;'|sed -e 's/[()]//g' whoami\"</span></span><br><span class=\"line\"><span class=\"comment\">#400  2019-08-02 16:57:46 192.168.1.88 root # history</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 设置保留历史命令的条数为30并加上时间戳</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*HISTSIZE\\s*\\W+[0-9].+$\"</span> /etc/profile &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*HISTSIZE\\W+[0-9].+$/HISTSIZE=30/\"</span> /etc/profile || <span class=\"built_in\">echo</span> <span class=\"string\">\"HISTSIZE=30\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*HISTTIMEFORMAT\\s*\\S+.+$\"</span> /etc/profile &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*HISTTIMEFORMAT\\s*\\S+.+$/HISTTIMEFORMAT='%F %T | '/\"</span> /etc/profile || <span class=\"built_in\">echo</span> <span class=\"string\">\"HISTTIMEFORMAT='%F %T | '\"</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*export\\s*HISTTIMEFORMAT.*$\"</span> /etc/profile || <span class=\"built_in\">echo</span> <span class=\"string\">\"export HISTTIMEFORMAT\"</span> &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure></p>\n<p>其他日志审计记录：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Centos7 Shell登陆记录</span></span><br><span class=\"line\"><span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$(date)</span> - <span class=\"variable\">$&#123;SSH_CONNECTION&#125;</span> - <span class=\"variable\">$&#123;USER&#125;</span>\"</span> &gt;&gt; /tmp/login.txt</span><br><span class=\"line\"><span class=\"comment\"># 测试bash -i反弹shell</span></span><br><span class=\"line\">ssh -T root@10.10.107.222 /bin/bash -i</span><br><span class=\"line\">Fri Aug  2 16:54:48 CST 2019 - 192.168.1.88 55321 10.10.107.222 22 - root</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x03-系统加固\"><a href=\"#0x03-系统加固\" class=\"headerlink\" title=\"0x03 系统加固\"></a>0x03 系统加固</h4><h5 id=\"1-系统文件配置相关\"><a href=\"#1-系统文件配置相关\" class=\"headerlink\" title=\"1.系统文件配置相关\"></a>1.系统文件配置相关</h5><p>删除潜在威胁文件:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find / -maxdepth 3 -name hosts.equiv | xargs rm -rf</span><br><span class=\"line\">find / -maxdepth 3 -name .netrc | xargs rm -rf</span><br><span class=\"line\">find / -maxdepth 3 -name .rhosts | xargs rm -rf</span><br></pre></td></tr></table></figure></p>\n<p>禁用ctrl+alt+del组合键:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 禁用ctrl+alt+del组合键，Redhat 6.X：</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 禁用ctrl+alt+del组合键</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*exec\\s+/sbin/shutdown\\s+.+$\"</span> /etc/init/control-alt-delete.conf &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*exec\\s+\\/sbin\\/shutdown\\s+.+$/exec \\/usr\\/bin\\/logger \\-p authpriv.notice \\-t init 'Ctrl-Alt-Del was pressed and ignored'/\"</span> /etc/init/control-alt-delete.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"exec /usr/bin/logger -p authpriv.notice -t init 'Ctrl-Alt-Del was pressed and ignored' \"</span> &gt;&gt; /etc/init/control-alt-delete.conf</span><br><span class=\"line\"><span class=\"comment\"># 禁用ctrl+alt+del组合键，Redhat 7.X：</span></span><br><span class=\"line\">mv /usr/lib/systemd/system/ctrl-alt-del.target /usr/lib/systemd/system/ctrl-alt-del.target.bat&amp;&gt;/dev/null 2&amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></p>\n<p>配置自动屏幕锁定（适用于具备图形界面的设备）:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 对于有图形界面的系统配置10分钟屏幕锁定</span><br><span class=\"line\">gconftool-2 &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"string\">\"$?\"</span> == 0 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">  gconftool-2 --direct \\</span><br><span class=\"line\">  --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory \\</span><br><span class=\"line\">  --<span class=\"built_in\">type</span> bool \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> /apps/gnome-screensaver/idle_activation_enabled <span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> /apps/gnome-screensaver/lock_enabled <span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --<span class=\"built_in\">type</span> int \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> /apps/gnome-screensaver/idle_delay 10 \\</span><br><span class=\"line\">  --<span class=\"built_in\">type</span> string \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> /apps/gnome-screensaver/mode blank-only</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"2-系统服务\"><a href=\"#2-系统服务\" class=\"headerlink\" title=\"2.系统服务\"></a>2.系统服务</h5><p>限制不必要的服务:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">disable</span> rsh&amp;&gt;/dev/null 2&amp;&gt;/dev/null;systemctl <span class=\"built_in\">disable</span> talk&amp;&gt;/dev/null 2&amp;&gt;/dev/null;systemctl <span class=\"built_in\">disable</span> telnet&amp;&gt;/dev/null 2&amp;&gt;/dev/null;systemctl <span class=\"built_in\">disable</span> tftp&amp;&gt;/dev/null 2&amp;&gt;/dev/null;systemctl <span class=\"built_in\">disable</span> rsync&amp;&gt;/dev/null 2&amp;&gt;/dev/null;systemctl <span class=\"built_in\">disable</span> xinetd&amp;&gt;/dev/null 2&amp;&gt;/dev/null;systemctl <span class=\"built_in\">disable</span> nfs&amp;&gt;/dev/null 2&amp;&gt;/dev/null;systemctl <span class=\"built_in\">disable</span> nfslock&amp;&gt;/dev/null 2&amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x04-服务应用加固\"><a href=\"#0x04-服务应用加固\" class=\"headerlink\" title=\"0x04 服务应用加固\"></a>0x04 服务应用加固</h4><h5 id=\"1-Ssh服务相关\"><a href=\"#1-Ssh服务相关\" class=\"headerlink\" title=\"1.Ssh服务相关\"></a>1.Ssh服务相关</h5><p>描述:openssh 目前的默认配置文件相比以前虽然要安全的多，但还是有必要对生产系统中的 ssh 服务器进行基线检查。<br><em>等保视角下的SSH 加固之旅：</em></p>\n<ul>\n<li><p>1）身份鉴别:</p>\n<ul>\n<li>首推公钥认证方式,通过ansible批量更新或者通过堡垒机的定时任务实现对管理的服务器上的公钥进行批量更新</li>\n<li>严禁选择基于密码的、基于主机的认证方式，有条件的可以接入 Kerberos 认证;</li>\n<li>基于权限最小化原则，限制不同用户使用不同角色的账户</li>\n<li>选择安全的ssh-key生成算法生成的key<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh key 常见算法及安全性</span><br><span class=\"line\">DSA 已被证明不安全，且从OpenSSH Server 7 之后便不再支持</span><br><span class=\"line\">RSA RSA算法产生的私钥的安全性依赖于密钥的长度，如果密钥的长度小于3072，则不够安全，比如常见的2048 位的ssh key 是不够安全的，1024位直接被标记为不安全</span><br><span class=\"line\">ECDSA：这个算法产生的密钥安全性依赖于当前机器产生的随机数的强度</span><br><span class=\"line\">Ed25519： 目前最为推荐的ssh key 生成算法，安全性最好！</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>2）访问控制</p>\n<ul>\n<li>网络层的访问控制：禁止端口转发</li>\n<li>限制指定的IP才能连接：除了在防火墙上做规则限制，还可以通过TCP Wrapper 和sshd_config的配置命令</li>\n</ul>\n</li>\n<li><p>3）审计</p>\n<ul>\n<li>实现等保的审计要求：选择加入堡垒机或者将ssh 登录日志、bash 操作日志集中转发之SOC或者内部日志平台（比如通过syslog方式）</li>\n</ul>\n</li>\n<li><p>4）入侵防范</p>\n<ul>\n<li>及时更新openssh server及其依赖的openssl库的补丁</li>\n<li>建议关注：openssh 官方安全通告：<a href=\"https://www.openbsd.org/security.html\" target=\"_blank\" rel=\"noopener\">https://www.openbsd.org/security.html</a></li>\n</ul>\n</li>\n</ul>\n<p>文件说明：/root/.ssh/known_hosts 保存相关服务器的签名</p>\n<p>(1)SSH 配置文件：/etc/ssh/ssh_config<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Port 2222</span><br><span class=\"line\">Protocol 2                  <span class=\"comment\">#使用ssh 协议2</span></span><br><span class=\"line\">PermitRootLogin no           <span class=\"comment\">#禁止Root登录</span></span><br><span class=\"line\">PermitEmptyPasswords no      <span class=\"comment\">#禁止空密码登录</span></span><br><span class=\"line\"></span><br><span class=\"line\">StrictModes yes            <span class=\"comment\"># 当使用者的 host key 改变之后，Server 就不接受联机，可以抵挡部分的木马程序！</span></span><br><span class=\"line\">MaxAuthTries 5              <span class=\"comment\">#认证尝试次数</span></span><br><span class=\"line\">MaxSessions 6               <span class=\"comment\">#最大会话数</span></span><br><span class=\"line\">IgnoreRhosts yes            <span class=\"comment\">#关闭禁用用户的 .rhosts 文件  ~/.ssh/.rhosts 来做为认证 </span></span><br><span class=\"line\">LoginGraceTime 120         <span class=\"comment\">#无动作断线时间（seconds）</span></span><br><span class=\"line\">HashKnownHosts yes          <span class=\"comment\">#把主机名hash记录</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置 Idle Log Out Timeout 间隔</span></span><br><span class=\"line\">ClientAliveInterval 300</span><br><span class=\"line\">ClientAliveCountMax 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#禁止或者允许某个用户通过ssh登录</span></span><br><span class=\"line\">AllowUsers 用户名</span><br><span class=\"line\">AllowGroups 组名</span><br><span class=\"line\">DenyUsers 用户名  </span><br><span class=\"line\">DenyGroups 组名</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭密码认证，启用公钥认证：</span></span><br><span class=\"line\">PubkeyAuthentication yes</span><br><span class=\"line\">PasswordAuthentication no   <span class=\"comment\">#不建议使用密码认证 建议设置为no</span></span><br><span class=\"line\">HostbasedAuthentication no  <span class=\"comment\">#不建议使用机认证  建议设置为no</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#禁止端口转发</span></span><br><span class=\"line\">AllowAgentForwarding no </span><br><span class=\"line\">AllowTcpForwarding no <span class=\"comment\">#通过禁止TCP端口转发，可以禁止SSH 远程端口和本地端口转发功能，也可以禁止SSH 远程隧道的建立</span></span><br><span class=\"line\">X11Forwarding no   <span class=\"comment\">#如果没用 X11 转发的情况</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br>(2) 限制IP登录SSH<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#只允许某个IP登录，拒绝其他所有IP：</span></span><br><span class=\"line\">在 /etc/hosts.allow 写 : sshd: 1.2.3.4</span><br><span class=\"line\">在 /etc/hosts.deny 写 :  sshd: ALL</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#防火墙配置</span></span><br><span class=\"line\">iptables -A INPUT -s 1.2.3.4 -p tcp --dport 22 -j ACCEPT</span><br><span class=\"line\">iptables -A INPUT -s 堡垒机IP -p tcp --dport 22 -j ACCEPT <span class=\"comment\">#限制只允许堡垒机的IP连接</span></span><br><span class=\"line\">iptables -A INPUT -p tcp --dport 22 -j DROP</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#其他加固脚本描述：防止ssh被恶意ip爆破，进行设置Hosts.deny加入恶意的IP地址进行阻断。</span></span><br><span class=\"line\"><span class=\"comment\">#==========开始复制==========</span></span><br><span class=\"line\">ldd `<span class=\"built_in\">which</span> sshd` | grep libwrap <span class=\"comment\"># 确认sshd是否支持TCP Wrapper，输出类似:libwrap.so.0 =&gt; /lib/libwrap.so.0 (0x00bd1000)</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/bin/</span><br><span class=\"line\">wget antivirus.neu.edu.cn/ssh/soft/fetch_neusshbl.sh</span><br><span class=\"line\">chmod +x fetch_neusshbl.sh</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /etc/cron.hourly/</span><br><span class=\"line\">ln -s /usr/<span class=\"built_in\">local</span>/bin/fetch_neusshbl.sh .</span><br><span class=\"line\">./fetch_neusshbl.sh</span><br><span class=\"line\"><span class=\"comment\">#=========结束复制==========</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>(3) 限制指定账户不能SSH只能SFTP在指定目录<br>比如以限制sftpgroup 组的用户都只能在自己的家目录sftp 上传下载，不能ssh连接获取shell为例<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.新建一个sftpgroup，以组为单位进行限制</span></span><br><span class=\"line\">groupadd sftpgroup</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.新建一个账户sftpuser，加入sftpgroup</span></span><br><span class=\"line\">useradd -d /home/sftpuser -s /usr/sbin/nologin -M -N -gsftpgroup sftpuser  <span class=\"comment\">#使其无法获取交互式shell,不创建用户的主目录,不创建同名的组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.配置账号账户以公钥方式认证</span></span><br><span class=\"line\">mkdir -p /home/sftpuser/.ssh</span><br><span class=\"line\">cat xxx.pub &gt;/home/sftpuser/.ssh/authorized_keys</span><br><span class=\"line\">chmod -R 700 /home/sftpuser/.ssh/</span><br><span class=\"line\">chown -R sftpuser:sftpgroup /home/sftpuser/.ssh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4. 配置sshd_config</span></span><br><span class=\"line\">Subsystem sftp internal-sftp</span><br><span class=\"line\">Match group sftpgroup  <span class=\"comment\">#Match指令主要用于条件匹配</span></span><br><span class=\"line\">ChrootDirectory %h     <span class=\"comment\">#限制sftp的活动目录在其Home 目录</span></span><br><span class=\"line\">X11Forwarding no       <span class=\"comment\">#禁止X11转发</span></span><br><span class=\"line\">AllowTcpForwarding no  <span class=\"comment\">#禁止tcp转发</span></span><br><span class=\"line\">ForceCommand internal-sftp  <span class=\"comment\">#如果去掉ssh连接时候提示/usr/bin/nologin no such file or directory</span></span><br></pre></td></tr></table></figure></p>\n<p><em>Subsystem sftp /usr/lib/openssh/sftp-server 更为 internal-sftp，这两者有什么区别呢？</em></p>\n<ul>\n<li>简单的说默认sftp进程由单独的二进制文件：/usr/lib/openssh/sftp-server启动（外部）</li>\n<li>internal-sftp 则无需外部二进制文件额外启动一个进程整合在sshd进程内了（内部）</li>\n<li>internal-sftp相较于 /usr/lib/openssh/sftp-server 优点在于：<ul>\n<li>性能好无需额外进程了</li>\n<li>安全性好无需用户登录shell，且可使用ChrootDirectory 限制sftp行为活动的目录；</li>\n<li>sftp-server 的存在主要是向后兼容。</li>\n</ul>\n</li>\n</ul>\n<p><em>ForceCommand internal-sftp 是什么意思？</em><br>答:防止用户执行他们自己自定义的命令限制用户命令执行上下文为sftp（可以理解为用户的’shell’就是sftp 那个上下文环境）, 即用户除了能执行sftp中允许的命令外，其他命令啥也执行不了<br>PS:采用sftp软件登录：<code>sftp -i 密匙path sftpuser@ip</code> 则进入交换式;</p>\n<p>ssh服务应用加固:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># SSH登录前警告Banner</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 设置ssh登录前警告Banner</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"**************WARNING**************\"</span> &gt;&gt; /etc/issue;<span class=\"built_in\">echo</span> <span class=\"string\">\"Authorized only. All activity will be monitored and reported.\"</span> &gt;&gt; /etc/issue</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*(banner|Banner)\\s+\\W+.*$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*(banner|Banner)\\s+\\W+.*$/Banner \\/etc\\/issue/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"Banner /etc/issue\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># SSH登录后Banner</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 设置ssh登录后Banner</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"**************WARNING**************\"</span> &gt;&gt; /etc/motd;<span class=\"built_in\">echo</span> <span class=\"string\">\"Login success. All activity will be monitored and reported.\"</span> &gt;&gt; /etc/motd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 禁止root远程登录（暂不配置）</span></span><br><span class=\"line\">:&lt;&lt;!</span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 禁止root远程SSH登录</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*PermitRootLogin\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*PermitRootLogin\\s+.+$/PermitRootLogin no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"PermitRootLogin no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">!</span><br><span class=\"line\"><span class=\"comment\"># SSH 安全配置</span></span><br><span class=\"line\"><span class=\"comment\"># 严格模式</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*StrictModes\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*StrictModes\\s+.+$/StrictModes yes/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"StrictModes yes\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"><span class=\"comment\"># 缺省端口改变成为62222，重启服务需要 setenforce 0 临时关闭Selinux</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*Port\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*Port\\s+.+$/Port 62222/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"Port 62222\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"><span class=\"comment\"># 禁用端口转发</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*X11Forwarding\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*X11Forwarding\\s+.+$/X11Forwarding no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"X11Forwarding no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*AllowTcpForwarding\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*AllowTcpForwarding\\s+.+$/AllowTcpForwarding no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"AllowTcpForwarding no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*AllowAgentForwarding\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*AllowAgentForwarding\\s+.+$/AllowAgentForwarding no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"AllowAgentForwarding no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"><span class=\"comment\"># CentOS7 (缺省IgnoreRhosts yes) 关闭禁用用户的 .rhosts 文件  ~/.ssh/.rhosts 来做为认证</span></span><br><span class=\"line\"><span class=\"comment\"># egrep -q \"^(#)?\\s*IgnoreRhosts\\s+.+$\" /etc/ssh/sshd_config &amp;&amp; sed -ri \"s/^(#)?\\s*IgnoreRhosts\\s+.+$/IgnoreRhosts yes/\" /etc/ssh/sshd_config || echo \"IgnoreRhosts yes\" &gt;&gt; /etc/ssh/sshd_config</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"2-Ftp服务相关\"><a href=\"#2-Ftp服务相关\" class=\"headerlink\" title=\"2.Ftp服务相关\"></a>2.Ftp服务相关</h5><p>FTP Banner 设置:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* FTP Banner 设置</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*ftpd_banner\\s*\\W+.+$/s/^/#/\"</span> /etc/vsftpd/vsftpd.conf &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"ftpd_banner='Authorized only. All activity will be monitored and reported.'\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br></pre></td></tr></table></figure></p>\n<p>禁止匿名用户登录FTP<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 禁止匿名用户登录FTP</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*anonymous_enable\\s*\\W+.+$/s/^/#/\"</span> /etc/vsftpd/vsftpd.conf &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"anonymous_enable=NO\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br></pre></td></tr></table></figure></p>\n<p>禁止root用户登录FTP<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 禁止root用户登录FTP</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"root\"</span> &gt;&gt; /etc/vsftpd/ftpusers</span><br></pre></td></tr></table></figure></p>\n<p>限制FTP用户上传的文件所具有的权限<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 限制FTP用户上传的文件所具有的权限</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*write_enable\\s*\\W+.+$/s/^/#/\"</span> /etc/vsftpd/vsftpd.conf &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"write_enable=NO\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*ls_recurse_enable\\s*\\W+.+$/s/^/#/\"</span> /etc/vsftpd/vsftpd.conf &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"ls_recurse_enable=NO\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*anon_umask\\s*\\W+.+$/s/^/#/\"</span> /etc/vsftpd/vsftpd.conf &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"anon_umask=077\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*local_umask\\s*\\W+.+$/s/^/#/\"</span> /etc/vsftpd/vsftpd.conf &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"local_umask=022\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br></pre></td></tr></table></figure></p>\n<p>限制FTP用户登录后能访问的目录<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 限制FTP用户登录后能访问的目录</span><br><span class=\"line\">systemctl list-unit-files|grep vsftpd &gt; /dev/null &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*chroot_local_user\\s*\\W+.+$/s/^/#/\"</span> /etc/vsftpd/vsftpd.conf &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"chroot_local_user=NO\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"3-Telnet服务相关\"><a href=\"#3-Telnet服务相关\" class=\"headerlink\" title=\"3.Telnet服务相关\"></a>3.Telnet服务相关</h5><p>配置禁用telnet服务<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*telnet\\s+\\d*.+$\"</span> /etc/services &amp;&amp; sed -ri <span class=\"string\">\"/^\\s*telnet\\s+\\d*.+$/s/^/# /\"</span> /etc/services</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"4-Snmp服务相关\"><a href=\"#4-Snmp服务相关\" class=\"headerlink\" title=\"4.Snmp服务相关\"></a>4.Snmp服务相关</h5><p>修改SNMP默认团体字:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> \\*\\*\\*\\* 修改SNMP默认团体字</span><br><span class=\"line\">cat &gt; /etc/snmp/snmpd.conf &lt;&lt;EOF</span><br><span class=\"line\">com2sec name  default    <span class=\"variable\">$password</span>   </span><br><span class=\"line\">group   ****Grp         v1           ****Sec</span><br><span class=\"line\">group   ****Grp         v2c          ****Sec</span><br><span class=\"line\">view    systemview      included        .1                      80</span><br><span class=\"line\">view    systemview      included        .1.3.6.1.2.1.1</span><br><span class=\"line\">view    systemview      included        .1.3.6.1.2.1.25.1.1</span><br><span class=\"line\">view    ****View        included        .1.3.6.1.4.1.2021.80</span><br><span class=\"line\">access  ****Grp         <span class=\"string\">\"\"</span>      any       noauth    exact  systemview none none</span><br><span class=\"line\">access  ****Grp         <span class=\"string\">\"\"</span>      any       noauth    exact  ****View   none none</span><br><span class=\"line\">dontLogTCPWrappersConnects yes</span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#exec mq_ttt /home/107_mq.sh</span></span><br><span class=\"line\"><span class=\"comment\">#exec core_timebargain_ttt /home/105_core_timebargain.sh</span></span><br><span class=\"line\"><span class=\"comment\">#exec core_espot_ttt /home/101_core_espot.sh</span></span><br><span class=\"line\"><span class=\"comment\">#exec core_conditionPlugin_ttt /home/103_core_conditionPlugin.sh</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">trapcommunity <span class=\"variable\">$password</span></span><br><span class=\"line\">authtrapenable 1</span><br><span class=\"line\">trap2sink IP</span><br><span class=\"line\">agentSecName ****Sec</span><br><span class=\"line\">rouser ****Sec</span><br><span class=\"line\">defaultMonitors yes</span><br><span class=\"line\">linkUpDownNotifications yes</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>二、Centos7检查的项目如下：<br>0x01 初始设置</p>\n<p>1.1 文件系统配置：</p>\n<p>将/tmp挂载至一个单独的分区</p>\n<p>挂载时指定noexec,nosuid：不允许运行可执行文件</p>\n<p>1.2 安全启动设置：</p>\n<p>设置bootloader的配置文件的权限为600</p>\n<p>设置bootloader的密码：进入引导界面需输入密码</p>\n<p>为单用户启动认证机制</p>\n<p>1.3 强制访问控制：</p>\n<p>安装SELinux</p>\n<p>设置SELinux的状态为enforcing</p>\n<p>设置SELinux的policy为targeted<br>0x02 服务配置</p>\n<p>2.1 时间同步设置：</p>\n<p>开启时间同步服务</p>\n<p>使用ntp或chrony来统一服务器的时间</p>\n<p>不安装X-windows系统：即不使用可视化界面<br>0x03 网络配置</p>\n<p>3.1 hosts设置：</p>\n<p>配置/etc/hosts.allow与/etc/hosts.deny文件</p>\n<p>配置/etc/hosts.allow与/etc/hosts.deny文件的权限为0644</p>\n<p>配置/etc/hosts.allow与/etc/hosts.deny文件的属主为root</p>\n<p>3.2 防火墙配置</p>\n<p>安装iptables</p>\n<p>设置各个Chain的默认策略为drop<br>0x04 审计设置</p>\n<p>安装并使用auditd</p>\n<p>配置记录审计日志的文件大小：8M</p>\n<p>配置记录审计日志的文件个数：5</p>\n<p>单个审计日志文件大小达到设定的值时触发的动作为：keep_logs/rotate</p>\n<p>磁盘空间满后触发的动作为：rotate</p>\n<p>auditd需配置的一些规则：</p>\n<p> 规则：审计更改日期和时间的操作<br> 规则：审计更改用户/组信息的操作<br> 规则：审计更改系统网络环境的操作<br> 规则：审计更改系统强制访问控制的操作<br> 规则：审计登入登出系统的事件<br> 规则：审计企图改变文件权限的操作<br> 规则：审计未授权情况下企图访问文件未成功的事件<br> 规则：审计使用提权命令的操作<br> 规则：审计删除文件的操作？？？？<br> 规则：审计sudoers文件的变更<br> 规则：审计sudoers日志文件的变更？？？？<br> 规则：审计日志文件audit.log不能被改变</p>\n<p>0x05 日志设置</p>\n<p>安装并启用`rsyslog｀<br>0x06 认证授权</p>\n<p>6.1 配置cron:</p>\n<p>开启cron服务</p>\n<p>配置 /etc/crontab,/etc/cron.hourly,/etc/cron.daily,/etc/cron.weekly,/etc/cron.monthly,//etc/cron.d文件的权限为0700</p>\n<p>设置cron.allow：只允许特定的用户可以使用cron</p>\n<p>6.2 配置SSH：</p>\n<p>配置/etc/ssh/sshd_config文件的权限为0600</p>\n<p>关闭X11Forwarding</p>\n<p>设置最大认证尝试次数：4</p>\n<p>开启IgnoreRhosts：不启用基于主机的认证</p>\n<p>关闭HostbasedAuthentication: 关闭基于主机的认证</p>\n<p>禁止使用root直接登录：PermitRootLogin no</p>\n<p>禁止使用空密码登录：PermitEmptyPasswords no</p>\n<p>禁止用户环境：PermitUserEnvironment no</p>\n<p>设置使用的MAC算法:</p>\n<p> <a href=\"mailto:hmac-sha2-512-etm@openssh.com\">hmac-sha2-512-etm@openssh.com</a>,<a href=\"mailto:hmac-sha2-256-etm@openssh.com\">hmac-sha2-256-etm@openssh.com</a>,<a href=\"mailto:umac-128etm@openssh.com\">umac-128etm@openssh.com</a>,hmac-sha2-512,hmac-sha2-256,<a href=\"mailto:umac-128@openssh.com\">umac-128@openssh.com</a>,<a href=\"mailto:curve25519sha256@libssh.org\">curve25519sha256@libssh.org</a>,diffie-hellman-group-exchange-sha256 </p>\n<p>设置空闲超时时间:180秒ClientAliveInterval 180</p>\n<p>设置一次登录花费时间：120秒LoginGraceTime 120</p>\n<p>6.3 配置PAM：</p>\n<p>密码长度最少位数：12</p>\n<p>密码中最少字符类型数：3</p>\n<p>配置密码锁定：？？？？</p>\n<p>配置密码重用限制：不使用最近5次的密码</p>\n<p>配置密码hash算法：SHA512</p>\n<p>6.5 用户账户和环境设置：</p>\n<p>密码有效时间：90天</p>\n<p>密码更改最短间隔：7天</p>\n<p>密码过期警告：7天</p>\n<p>自动禁用特定时间内没有活动的账号：365天</p>\n<p>配置系统账号的无法登录</p>\n<p>配置root账号默认群组的GID为0</p>\n<p>配置umask的默认值为027？？？</p>\n<p>配置shell超时关闭会话时间：180</p>\n<p>配置可以使用su命令的用户<br>0x07 系统维护</p>\n<p>7.1 重要文件权限：</p>\n<p> /etc/passwd 0644 uid 0 gid 0<br> /etc/shadow 0000 uid 0 gid 0<br> /etc/group 0644 uid 0 gid 0<br> /etc/gshadow 0000 uid 0 gid 0<br> /etc/passwd- 0644 uid 0 gid 0<br> /etc/shadow- 0000 uid 0 gid 0<br> /etc/group- 0644 uid 0 gid 0<br> /etc/gshadow- 0000 uid 0 gid 0</p>\n<pre><code>审计设置了SUID可执行文件的完整性 前面\n\n审计设置了SGID的可执行文件的完整性\n</code></pre><p>7.2 用户和组设置：</p>\n<p>不允许密码为空的账号</p>\n<p>只允许root账号的UID为0</p>\n<p>设置path环境变量中的目录只有owner可写，group及other都没有w的权限</p>\n<p>设置所有用户都有家目录</p>\n<p>设置所有用户家目录的权限为0750</p>\n<p>设置所有用户家目录的owner都为其自身</p>\n<p>设置用户家目录内以.开头的文件，只有owner可写，group及other都没有w的权限</p>\n<p>确保没有.netrc,.rhosts,.forward文件</p>\n<p>确保所有在/etc/passwd中的组都在/etc/group</p>\n<p>确保每个用户的UID都不同</p>\n<p>确保每个组的GID都不同</p>\n<p>确保用户名唯一</p>\n<p>确保组名唯一</p>\n<p>*本文作者：jerrybird，转载请注明来自FreeBuf.COM</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Linux","path":"api/categories/Linux.json"},{"name":"Security","path":"api/categories/Security.json"}],"tags":[{"name":"安全配置","path":"api/tags/安全配置.json"}]}