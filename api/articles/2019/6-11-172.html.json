{"title":"tcpdump快速入门与基础","slug":"系统运维/Linux/常用命令/网络查看类命令/tcpdump快速入门与基础","date":"2019-06-11T11:35:30.000Z","updated":"2023-01-31T02:29:09.175Z","url":"2019/6-11-172.html","path":"api/articles/2019/6-11-172.html.json","covers":["https://img.weiyigeek.top/2019/20190611110611.png","https://img.weiyigeek.top/2019/20190611110402.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-快速入门\"><a href=\"#0x00-快速入门\" class=\"headerlink\" title=\"0x00 快速入门\"></a>0x00 快速入门</h4><p>描述:tcpdump 命令是一款sniffer工具，它可以打印所有经过网络接口的数据包的头信息，也可以使用-w选项 test.pcap 将数据包保存到文件中，方便wireshark以后分析，同时它也是一个学习网络通信协议必备;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基础语法与选项</span></span><br><span class=\"line\"> tcpdump [-aAbdDefhHIJKlLnNOpqStuUvxX<span class=\"comment\">#] [ -B size ] [ -c count ]</span></span><br><span class=\"line\">                [ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]</span><br><span class=\"line\">                [ -i interface ] [ -j tstamptype ] [ -M secret ] [ --number ]</span><br><span class=\"line\">                [ -Q|-P <span class=\"keyword\">in</span>|out|inout ]</span><br><span class=\"line\">                [ -r file ] [ -s snaplen ] [ --time-stamp-precision precision ]</span><br><span class=\"line\">                [ --immediate-mode ] [ -T <span class=\"built_in\">type</span> ] [ --version ] [ -V file ]</span><br><span class=\"line\">                [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ]</span><br><span class=\"line\">                [ -Z user ] [ expression ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#参数</span></span><br><span class=\"line\">-a：尝试将网络和广播地址转换成名称；</span><br><span class=\"line\">-c&lt;数据包数目&gt;：收到指定的数据包数目后，就停止进行倾倒操作；</span><br><span class=\"line\">-d：把编译过的数据包编码转换成可阅读的格式，并倾倒到标准输出；</span><br><span class=\"line\">-dd：把编译过的数据包编码转换成C语言的格式，并倾倒到标准输出；</span><br><span class=\"line\">-ddd：把编译过的数据包编码转换成十进制数字的格式，并倾倒到标准输出；</span><br><span class=\"line\">-e：在每列倾倒资料上显示连接层级的文件头；</span><br><span class=\"line\">-f：用数字显示网际网络地址；</span><br><span class=\"line\">-F&lt;表达文件&gt;：指定内含表达方式的文件；</span><br><span class=\"line\">-i&lt;网络接口&gt;：使用指定的网络截面送出数据包；</span><br><span class=\"line\">-l：使用标准输出列的缓冲区；</span><br><span class=\"line\">-n：不把主机的网络地址转换成名字；</span><br><span class=\"line\">-N：不列出域名；</span><br><span class=\"line\">-O：不将数据包编码最佳化；</span><br><span class=\"line\">-p：不让网络界面进入混杂模式；</span><br><span class=\"line\">-q ：快速输出，仅列出少数的传输协议信息；</span><br><span class=\"line\">-r&lt;数据包文件&gt;：从指定的文件读取数据包数据；</span><br><span class=\"line\">-s&lt;数据包大小&gt;：设置每个数据包的大小；</span><br><span class=\"line\">-S：用绝对而非相对数值列出TCP关联数；</span><br><span class=\"line\">-t：在每列倾倒资料上不显示时间戳记；</span><br><span class=\"line\">-tt： 在每列倾倒资料上显示未经格式化的时间戳记；</span><br><span class=\"line\">-T&lt;数据包类型&gt;：强制将表达方式所指定的数据包转译成设置的数据包类型；</span><br><span class=\"line\">-v：详细显示指令执行过程；</span><br><span class=\"line\">-vv：更详细显示指令执行过程；</span><br><span class=\"line\">-x：用十六进制字码列出数据包资料；</span><br><span class=\"line\">-w&lt;数据包文件&gt;：把数据包数据写入指定的文件。</span><br><span class=\"line\"></span><br><span class=\"line\">1）第一种是关于类型的关键字：</span><br><span class=\"line\">主要包括：host，net，port   <span class=\"comment\">#如果没有指定类型，缺省的类型是host.</span></span><br><span class=\"line\">例如：host 210.27.48.2，指明 210.27.48.2是一台主机，net 202.0.0.0 指明 202.0.0.0是一个网络地址，port 23 指明端口号是23。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2）第二种是确定传输方向的关键字：</span><br><span class=\"line\">主要包括：src(源地址), dst(目的地址),dst or src, dst and src     <span class=\"comment\">#这些关键字指明了传输的方向</span></span><br><span class=\"line\">例如：src 210.27.48.2 ,指明ip包中源地址是210.27.48.2 , dst net 202.0.0.0 指明目的网络地址是202.0.0.0 ，如果没有指明方向关键字，则缺省是src or dst关键字。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3）第三种是协议的关键字：</span><br><span class=\"line\">主要包括：fddi,ip,arp,rarp,tcp,udp <span class=\"comment\"># 类型</span></span><br><span class=\"line\">Fddi指明是在FDDI(分布式光纤数据接口网络)上的特定 的网络协议，实际上它是<span class=\"string\">\"ether\"</span>的别名，fddi和ether具有类似的源地址和目的地址，所以可以将fddi协议包当作ether的包进行处理和分析。其他的几个关键字就是指明了监听的包的协议内容，如果没有指定任何协议，则tcpdump将会监听所有协议的信息包。</span><br><span class=\"line\">补充类型：gateway, broadcast,less,greater</span><br><span class=\"line\"></span><br><span class=\"line\">4）还有三种逻辑运算，</span><br><span class=\"line\">取非运算是 <span class=\"string\">'not '</span> <span class=\"string\">'! '</span>, </span><br><span class=\"line\">与运算是<span class=\"string\">'and'</span>,<span class=\"string\">'&amp;&amp;'</span></span><br><span class=\"line\">或运算 是<span class=\"string\">'or'</span> ,<span class=\"string\">'||'</span>,</span><br></pre></td></tr></table></figure>\n<p>实际案例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例0. 直接启动tcpdump将监视第一个网络接口上所有流过的数据包</span></span><br><span class=\"line\">tcpdump</span><br><span class=\"line\">tcpdump -i lo <span class=\"comment\">#抓取回环网口的包 ICMP-&gt;64bit数据</span></span><br><span class=\"line\"><span class=\"comment\"># ping 127.0.0.1 -c 3</span></span><br><span class=\"line\"><span class=\"comment\"># PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span></span><br><span class=\"line\"><span class=\"comment\"># 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.018 ms</span></span><br><span class=\"line\"><span class=\"comment\"># 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.047 ms</span></span><br><span class=\"line\"></span><br><span class=\"line\">10:46:14.721374 IP localhost &gt; localhost: ICMP <span class=\"built_in\">echo</span> request, id 6085, seq 1, length 64</span><br><span class=\"line\">10:46:14.721379 IP localhost &gt; localhost: ICMP <span class=\"built_in\">echo</span> reply, id 6085, seq 1, length 64</span><br><span class=\"line\">10:46:15.721181 IP localhost &gt; localhost: ICMP <span class=\"built_in\">echo</span> request, id 6085, seq 2, length 64</span><br><span class=\"line\">10:46:15.721189 IP localhost &gt; localhost: ICMP <span class=\"built_in\">echo</span> reply, id 6085, seq 2, length 64</span><br><span class=\"line\">10:46:16.721137 IP localhost &gt; localhost: ICMP <span class=\"built_in\">echo</span> request, id 6085, seq 3, length 64</span><br><span class=\"line\">10:46:16.721145 IP localhost &gt; localhost: ICMP <span class=\"built_in\">echo</span> reply, id 6085, seq 3, length 64</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例1.指定网卡与端口抓包病并写入文件</span></span><br><span class=\"line\">tcpdump -i eth0 -nnX port 21  <span class=\"comment\">#指定端口抓包</span></span><br><span class=\"line\">tcpdump -i eth0 -nnX port 21 -c 12 -vv -w test.pcap  <span class=\"comment\">#写入到test.pcap文件</span></span><br><span class=\"line\">tcpdump tcp port 23 host 210.27.48.1 <span class=\"comment\"># 监视指定主机和端口的数据包,接收或发出的telnet包</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2.读取之前产生的 tcpdump 文件</span></span><br><span class=\"line\">$ tcpdump -r packets_file.pcap</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例3.要获取整个网络的数据包</span></span><br><span class=\"line\">tcpdump -i ens192 net 10.10.107.0/24</span><br><span class=\"line\"><span class=\"comment\"># 10:53:24.804535 IP 10.20.172.108.51147 &gt; localhost.localdomain.ssh: Flags [.], ack 1872256, win 16425, length 0</span></span><br><span class=\"line\"><span class=\"comment\"># 10:53:24.804537 IP localhost.localdomain.ssh &gt; 10.20.172.108.51147: Flags [P.], seq 1872256:1872384, ack 3505, win 343, length 128</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例4.根据IP地址查看报文,不管是作为源地址还是目的地址</span></span><br><span class=\"line\">$ tcpdump host 192.168.1.100</span><br><span class=\"line\">$ tcpdump -i eth0 src host hostname <span class=\"comment\">#只对机器名为hostname的主机的通信数据包进行监视，主机名可以是本地主机，也可以是网络上的任何一台计算机。</span></span><br><span class=\"line\"><span class=\"comment\">#要指定 IP 地址是源地址或是目的地址则使用：</span></span><br><span class=\"line\">$ tcpdump src 192.168.1.100</span><br><span class=\"line\">$ tcpdump dst 192.168.1.100</span><br><span class=\"line\">tcpdump -i ens192 src 10.20.172.108 -vv -nnX <span class=\"comment\">#十六进制展示</span></span><br><span class=\"line\"><span class=\"comment\"># tcpdump: listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># 10:56:00.410729 IP (tos 0x0, ttl 127, id 29668, offset 0, flags [DF], proto TCP (6), length 40)</span></span><br><span class=\"line\"><span class=\"comment\">#     10.20.172.108.51147 &gt; localhost.localdomain.ssh: Flags [.], cksum 0x097b (correct), seq 362959904, ack 1096206029, win 16425, length 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例5.指定协议查询</span></span><br><span class=\"line\">tcpdump arp -i ens192 -vv -nnX</span><br><span class=\"line\"><span class=\"comment\"># tcpdump: listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># 11:07:37.543934 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 10.10.107.222 tell 192.168.3.1, length 46</span></span><br><span class=\"line\"><span class=\"comment\">#         0x0000:  0001 0800 0604 0001 d4a1 48a4 5e07 c0a8  ..........H.^...</span></span><br><span class=\"line\"><span class=\"comment\">#         0x0010:  0301 0000 0000 0000 0a0a 6bde 0000 0000  ..........k.....</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例7.关键字可以组合起来构成强大的组合条件</span></span><br><span class=\"line\">tcpdump host helios and \\( hot or ace \\)  <span class=\"comment\"># 打印helios 与 hot 或者与 ace 之间通信的数据包</span></span><br><span class=\"line\">tcpdump host 210.27.48.1 and \\ (210.27.48.2 or 210.27.48.3 \\)  <span class=\"comment\">#截获主机210.27.48.1 和主机210.27.48.2 或210.27.48.3的通信</span></span><br><span class=\"line\">tcpdump ip host ace and not helios   <span class=\"comment\"># 打印ace与任何其他主机之间通信的IP 数据包, 但不包括与helios之间的数据包.</span></span><br><span class=\"line\">tcpdump ip host 210.27.48.1 and ! 210.27.48.2   <span class=\"comment\">#获取主机210.27.48.1除了和主机210.27.48.2之外所有主机通信的ip包</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例8.指定端口范围的数据包</span></span><br><span class=\"line\">$ tcpdump tcp portrange 22-125 -nnX -i ens192 <span class=\"comment\">#要捕获某个端口或一个范围的数据包</span></span><br><span class=\"line\">$ tcpdump udp portrange 22-125 -nnX -i ens192 <span class=\"comment\">#要捕获某个端口或一个范围的数据包</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1 packet captured   ==  捕获的封包数量</span></span><br><span class=\"line\"><span class=\"comment\"># 29 packets received by filter  ==   被过滤过的总封包个数</span></span><br><span class=\"line\"><span class=\"comment\"># 137 packets dropped by kernel   ==   被核心所丟棄的封包</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例9.检查监视通过指定网关的数据，以及到指定端口的TCP或UDP数据包：</span></span><br><span class=\"line\">tcpdump -i eth0 gateway Gatewayname</span><br><span class=\"line\">tcpdump -i eth0 host hostname and port 80</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例10.高级网络</span></span><br><span class=\"line\"><span class=\"comment\"># 注意：表达式被单引号括起来了，这可以防止shell对其中的括号进行错误解析</span></span><br><span class=\"line\">tcpdump net ucb-ether <span class=\"comment\"># 打印本地主机与Berkeley网络上的主机之间的所有通信数据包</span></span><br><span class=\"line\">tcpdump <span class=\"string\">'gateway snup and (port ftp or ftp-data)'</span>  <span class=\"comment\"># 打印所有通过网关snup的ftp数据包</span></span><br><span class=\"line\">tcpdump ip and not net localnet <span class=\"comment\"># 打印所有源地址或目标地址是本地主机的IP数据包</span></span><br><span class=\"line\"><span class=\"comment\">#如果本地网络通过网关连到了另一网络，则另一网络并不能算作本地网络。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例11：如果使用 VMkernel 接口 vmk0 和位于 10.11.12.13 的 NTP 服务器：</span></span><br><span class=\"line\">tcpdump-uw -c 5 -n -i network_interface host ntp_server_ip_address and port 123</span><br><span class=\"line\">tcpdump-uw -c 5 -n -i vmk0 host 10.11.12.13 and port 123</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190611110611.png\" alt=\"WeiyiGeek.示例5\" title=\"\" class=\"\">\n                <p>WeiyiGeek.示例5</p>\n            </figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190611110402.png\" alt=\"WeiyiGeek.案例7\" title=\"\" class=\"\">\n                <p>WeiyiGeek.案例7</p>\n            </figure>","comments":true,"excerpt":"[TOC]","categories":[{"name":"Linux命令","path":"api/categories/Linux命令.json"}],"tags":[{"name":"网络命令","path":"api/tags/网络命令.json"}]}