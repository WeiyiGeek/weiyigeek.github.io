{"title":"21-kubernetes进阶之kubeadm方式安装高可用k8s集群","slug":"虚拟云容/云容器/Kubernetes/21-kubernetes进阶之kubeadm方式安装高可用k8s集群-cost","date":"2022-06-07T06:36:30.000Z","updated":"2023-02-01T09:38:02.338Z","url":"2022/6-7-664.html","path":"api/articles/2022/6-7-664.html.json","covers":["https://img.weiyigeek.top/2022/5/20220621153045.png","https://img.weiyigeek.top/2022/5/20220621221035.png","https://img.weiyigeek.top/2022/5/20220621221934.png","https://img.weiyigeek.top/2022/5/20220621222257.png","https://img.weiyigeek.top/2022/5/20220621223144.png","https://img.weiyigeek.top/2022/5/20220622103937.png","https://img.weiyigeek.top/2022/5/20220622104018.png","https://img.weiyigeek.top/2022/5/20220622162349.png","https://img.weiyigeek.top/2022/5/20220622144018.png","https://img.weiyigeek.top/2022/5/20220622165638.png","https://img.weiyigeek.top/2022/1/20220309090428.png","https://img.weiyigeek.top/2022/5/20220624150133.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>描述: 在我博客以及前面的文章之中讲解Kubernetes相关集群环境的搭建说明, 随着K8S及其相关组件的迭代, 与读者当前接触的版本有所不同，在上一章中我们一起实践了【使用二进制方式进行安装部署高可用的K8S集群V1.23.6】(<a href=\"https://blog.weiyigeek.top/2022/5-7-654.html\">https://blog.weiyigeek.top/2022/5-7-654.html</a>) , 所以本章将实践使用kubeadm方式部署搭建高可用的kubernetes集群V1.23.7，此处仍然按照ubuntu 20.04系统以及haproxy、keepalive、containerd、etcd、kubeadm、kubectl 等相关工具插件【最新或者稳定的版本】进行实践，这里不再对k8s等相关基础知识做介绍，如有新入门的童鞋，请访问如下【博客文章】(<a href=\"https://blog.weiyigeek.top/tags/k8s/\">https://blog.weiyigeek.top/tags/k8s/</a>) 或者【B站专栏】(<a href=\"https://www.bilibili.com/read/readlist/rl520875?spm_id_from=333.999.0.0\" target=\"_blank\" rel=\"noopener\">https://www.bilibili.com/read/readlist/rl520875?spm_id_from=333.999.0.0</a>) 按照顺序学习。</p>\n<p><strong>Kubernetes 简述</strong><br>Kubernetes (后续简称k8s)是 Google(2014年6月) 开源的一个容器编排引擎，使用Go语言开发，它支持自动化部署、大规模可伸缩、以及云平台中多个主机上的容器化应用进行管理。其目标是让部署容器化的应用更加简单并且高效，提供了资源调度、部署管理、服务发现、扩容缩容、状态 监控、维护等一整套功能, 努力成为跨主机集群的自动化部署、自动化扩展以及运行应用程序容器的平台，它支持一些列CNCF毕业项目，包括 Containerd、calico 等 。</p>\n<p><strong>扩展文章:</strong><br>1.使用二进制方式部署v1.23.6的K8S集群实践(上)【 <a href=\"https://mp.weixin.qq.com/s/sYpHENyehAnGOQQakYzhUA\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/sYpHENyehAnGOQQakYzhUA</a> 】<br>2.使用二进制方式部署v1.23.6的K8S集群实践(下)【 <a href=\"https://mp.weixin.qq.com/s/-ksiNJG6v4q47ez7_H3uYQ\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/-ksiNJG6v4q47ez7_H3uYQ</a> 】</p>\n<p><strong>原文地址</strong>: <a href=\"https://blog.weiyigeek.top/2022/6-7-664.html\">21-kubernetes进阶之kubeadm方式安装高可用k8s集群</a></p>\n<hr>\n<h2 id=\"0x01-环境准备\"><a href=\"#0x01-环境准备\" class=\"headerlink\" title=\"0x01 环境准备\"></a>0x01 环境准备</h2><h3 id=\"主机规划\"><a href=\"#主机规划\" class=\"headerlink\" title=\"主机规划\"></a>主机规划</h3><p>温馨提示: 同样此处使用的是 Ubuntu 20.04 操作系统, 该系统已做安全加固和内核优化符合等保2.0要求【SecOpsDev/Ubuntu-InitializeSecurity.sh at master · WeiyiGeek/SecOpsDev (github.com)】, 如你的Linux未进行相应配置环境可能与读者有些许差异, 如需要进行(windows server、Ubuntu、CentOS)安全加固请参照如下加固脚本进行加固, 请大家疯狂的 star 。</p>\n<p>加固脚本地址:【 <a href=\"https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh\" target=\"_blank\" rel=\"noopener\">https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh</a> 】</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">主机地址</th>\n<th style=\"text-align:center\">主机名称</th>\n<th style=\"text-align:center\">主机配置</th>\n<th style=\"text-align:center\">主机角色</th>\n<th style=\"text-align:center\">软件组件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">10.20.176.212</td>\n<td style=\"text-align:center\">devtest-master-212</td>\n<td style=\"text-align:center\">8C/16G</td>\n<td style=\"text-align:center\">控制节点</td>\n<td style=\"text-align:center\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.20.176.213</td>\n<td style=\"text-align:center\">devtest-master-213</td>\n<td style=\"text-align:center\">8C/16G</td>\n<td style=\"text-align:center\">控制节点</td>\n<td style=\"text-align:center\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.20.176.214</td>\n<td style=\"text-align:center\">devtest-master-214</td>\n<td style=\"text-align:center\">8C/32G</td>\n<td style=\"text-align:center\">控制节点</td>\n<td style=\"text-align:center\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.20.176.215</td>\n<td style=\"text-align:center\">devtest-work-215</td>\n<td style=\"text-align:center\">8C/16G</td>\n<td style=\"text-align:center\">工作节点</td>\n<td style=\"text-align:center\"></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.20.176.211</td>\n<td style=\"text-align:center\">slbvip.k8s.devtest</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">虚拟VIP</td>\n<td style=\"text-align:center\">虚拟网卡地址</td>\n</tr>\n</tbody>\n</table>\n<p><br/></p>\n<h3 id=\"软件版本\"><a href=\"#软件版本\" class=\"headerlink\" title=\"软件版本\"></a>软件版本</h3><p><strong>操作系统</strong></p>\n<ul>\n<li>Ubuntu 20.04 LTS - 5.4.0-92-generic</li>\n</ul>\n<p><strong>高可用软件</strong></p>\n<ul>\n<li>ipvsadm - 1:1.31-1</li>\n<li>haproxy - 2.0.13-2</li>\n<li>keepalived - 1:2.0.19-2</li>\n</ul>\n<p><strong>ETCD数据库</strong></p>\n<ul>\n<li>etcd - v3.5.4</li>\n</ul>\n<p><strong>容器运行时</strong></p>\n<ul>\n<li>containerd.io - 1.6.6</li>\n</ul>\n<p><strong>Kubernetes</strong></p>\n<ul>\n<li>kubeadm - v1.23.7</li>\n<li>kube-apiserver - v1.23.7</li>\n<li>kube-controller-manager - v1.23.7</li>\n<li>kubectl - v1.23.7</li>\n<li>kubelet - v1.23.7</li>\n<li>kube-proxy - v1.23.7</li>\n<li>kube-scheduler - v1.23.7</li>\n</ul>\n<p><strong>网络插件&amp;辅助软件</strong></p>\n<ul>\n<li>calico - v3.22</li>\n<li>coredns - v1.9.1</li>\n<li>kubernetes-dashboard - v2.5.1</li>\n<li>k9s - v0.25.18</li>\n</ul>\n<p><br/></p>\n<h3 id=\"网络规划\"><a href=\"#网络规划\" class=\"headerlink\" title=\"网络规划\"></a>网络规划</h3><table>\n<thead>\n<tr>\n<th>子网 Subnet</th>\n<th>网段</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>nodeSubnet</td>\n<td>10.20.176.0/24</td>\n<td>宿主机节点子网</td>\n</tr>\n<tr>\n<td>ServiceSubnet</td>\n<td>10.96.0.0/16</td>\n<td>SVC 子网</td>\n</tr>\n<tr>\n<td>PodSubnet</td>\n<td>10.66.0.0/16</td>\n<td>POD 子网</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2 id=\"0x02-安装部署\"><a href=\"#0x02-安装部署\" class=\"headerlink\" title=\"0x02 安装部署\"></a>0x02 安装部署</h2><h3 id=\"1-准备基础主机环境配置\"><a href=\"#1-准备基础主机环境配置\" class=\"headerlink\" title=\"1.准备基础主机环境配置\"></a>1.准备基础主机环境配置</h3><p>步骤 01.【所有主机】主机名设置按照上述主机规划进行设置。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 例如, 在10.20.176.212主机中运行。</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname devtest-master-212</span><br><span class=\"line\"><span class=\"comment\"># 例如, 在10.20.176.213主机中运行。</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname devtest-master-213</span><br><span class=\"line\"><span class=\"comment\"># 例如, 在10.20.176.214主机中运行。</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname devtest-master-214</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 例如, 在10.10.107.215主机中运行。</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname devtest-work-215</span><br></pre></td></tr></table></figure><br><br/></p>\n<p>步骤 02.【所有主机】将规划中的主机名称与IP地址进行硬解析。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tee -a /etc/hosts &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">10.20.176.211 slbvip.k8s.devtest</span><br><span class=\"line\">10.20.176.212 devtest-master-212</span><br><span class=\"line\">10.20.176.213 devtest-master-213</span><br><span class=\"line\">10.20.176.214 devtest-master-214</span><br><span class=\"line\">10.20.176.215 devtest-work-215</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure><br><br/></p>\n<p>步骤 03.验证每个节点上IP、MAC 地址和 product_uuid 的唯一性,保证其能相互正常通信<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用命令 ip link 或 ifconfig -a 来获取网络接口的 MAC 地址</span></span><br><span class=\"line\">ifconfig -a</span><br><span class=\"line\"><span class=\"comment\"># 使用命令 查看 product_uuid 校验</span></span><br><span class=\"line\">sudo cat /sys/class/dmi/id/product_uuid</span><br></pre></td></tr></table></figure><br><br/></p>\n<p>步骤 04.【所有主机】系统时间同步与时区设置<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">date -R</span><br><span class=\"line\">sudo ntpdate ntp.aliyun.com</span><br><span class=\"line\">sudo timedatectl <span class=\"built_in\">set</span>-timezone Asia/Shanghai</span><br><span class=\"line\"><span class=\"comment\"># 或者</span></span><br><span class=\"line\"><span class=\"comment\"># sudo dpkg-reconfigure tzdata</span></span><br><span class=\"line\">sudo timedatectl <span class=\"built_in\">set</span>-local-rtc 0</span><br><span class=\"line\">timedatectl</span><br></pre></td></tr></table></figure></p>\n<p>步骤 05.【所有主机】禁用系统交换分区<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">swapoff -a &amp;&amp; sed -i <span class=\"string\">'s|^/swap.img|#/swap.ing|g'</span> /etc/fstab</span><br><span class=\"line\"><span class=\"comment\"># 验证交换分区是否被禁用</span></span><br><span class=\"line\">free | grep <span class=\"string\">\"Swap:\"</span></span><br></pre></td></tr></table></figure></p>\n<p><em>补充:关闭或者开启Swap对于Kubernetes的影响</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">首先，基于安全性（如在官方文档中承诺的 Secret 只会在内存中读写，不会落盘）、利于保证节点同步一致性等原因，从 1.8 版开始，Kubernetes 就在它的文档中明确声明了它默认不支持Swap 分区，在未关闭 Swap 分区的机器中，集群将直接无法启动。关闭 Swap 的命令为：</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 还是先备份一下</span></span><br><span class=\"line\">$ yes | sudo cp /etc/fstab /etc/fstab_bak</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进行修改</span></span><br><span class=\"line\">$ sudo cat /etc/fstab_bak | grep -v swap &gt; /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可选操作</span></span><br><span class=\"line\">当然，在服务器上使用的话，关闭 Swap 影响还是很大的，如果服务器除了 Kubernetes 还有其他用途的话（除非实在太穷，否则建议不要这样混用；一定要混用的话，宁可把其他服务搬到 Kubernetes 上）。关闭 Swap 有可能会对其他服务产生不良的影响，这时需要修改每个节点的 kubelet 配置，去掉必须关闭 Swap 的默认限制，具体操作为：</span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"KUBELET_EXTRA_ARGS=--fail-swap-on=false\"</span> &gt;&gt; /etc/sysconfig/kubelet</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 06.【所有主机】系统内核参数调整<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 禁用 swap 分区</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?vm.swappiness.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?vm.swappiness.*|vm.swappiness = 0|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"vm.swappiness = 0\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\"><span class=\"comment\"># 允许转发</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv4.ip_forward.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv4.ip_forward.*|net.ipv4.ip_forward = 1|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_forward = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 允许 iptables 检查桥接流量</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-iptables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-iptables.*|net.bridge.bridge-nf-call-iptables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-iptables = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-ip6tables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-ip6tables.*|net.bridge.bridge-nf-call-ip6tables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-ip6tables = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure><br><br/></p>\n<p>步骤 07.【所有主机】禁用系统防火墙<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ufw <span class=\"built_in\">disable</span> &amp;&amp; systemctl <span class=\"built_in\">disable</span> ufw &amp;&amp; systemctl stop ufw</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h3 id=\"2-负载均衡管理ipvsadm工具安装与内核加载\"><a href=\"#2-负载均衡管理ipvsadm工具安装与内核加载\" class=\"headerlink\" title=\"2.负载均衡管理ipvsadm工具安装与内核加载\"></a>2.负载均衡管理ipvsadm工具安装与内核加载</h3><p>步骤 01.安装ipvs模块以及负载均衡相关依赖。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看可用版本</span></span><br><span class=\"line\">sudo apt-cache madison ipvsadm</span><br><span class=\"line\">  <span class=\"comment\"># ipvsadm |   1:1.31-1 | http://mirrors.aliyun.com/ubuntu focal/main amd64 Packages</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装</span></span><br><span class=\"line\">sudo apt -y install ipvsadm ipset sysstat conntrack</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 锁定版本 </span></span><br><span class=\"line\">apt-mark hold ipvsadm</span><br><span class=\"line\">  <span class=\"comment\"># ipvsadm set on hold.</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 02.将模块加载到内核中(开机自动设置-需要重启机器生效)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /etc/modules-load.d/k8s-.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># netfilter</span></span><br><span class=\"line\">br_netfilter</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># containerd</span></span><br><span class=\"line\">overlay</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># nf_conntrack</span></span><br><span class=\"line\">nf_conntrack</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ipvs</span></span><br><span class=\"line\">ip_vs</span><br><span class=\"line\">ip_vs_lc</span><br><span class=\"line\">ip_vs_lblc</span><br><span class=\"line\">ip_vs_lblcr</span><br><span class=\"line\">ip_vs_rr</span><br><span class=\"line\">ip_vs_wrr</span><br><span class=\"line\">ip_vs_sh</span><br><span class=\"line\">ip_vs_dh</span><br><span class=\"line\">ip_vs_fo</span><br><span class=\"line\">ip_vs_nq</span><br><span class=\"line\">ip_vs_sed</span><br><span class=\"line\">ip_vs_ftp</span><br><span class=\"line\">ip_tables</span><br><span class=\"line\">ip_set</span><br><span class=\"line\">ipt_set</span><br><span class=\"line\">ipt_rpfilter</span><br><span class=\"line\">ipt_REJECT</span><br><span class=\"line\">ipip</span><br><span class=\"line\">xt_set</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 03.手动加载模块到Linux内核中。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -vp /etc/modules.d/</span><br><span class=\"line\">tee /etc/modules.d/k8s-ipvs.modules &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># netfilter 模块 允许 iptables 检查桥接流量</span></span><br><span class=\"line\">modprobe -- br_netfilter</span><br><span class=\"line\"><span class=\"comment\"># containerd</span></span><br><span class=\"line\">modprobe -- overlay</span><br><span class=\"line\"><span class=\"comment\"># nf_conntrack</span></span><br><span class=\"line\">modprobe -- nf_conntrack</span><br><span class=\"line\"><span class=\"comment\"># ipvs</span></span><br><span class=\"line\">modprobe -- ip_vs</span><br><span class=\"line\">modprobe -- ip_vs_lc</span><br><span class=\"line\">modprobe -- ip_vs_lblc</span><br><span class=\"line\">modprobe -- ip_vs_lblcr</span><br><span class=\"line\">modprobe -- ip_vs_rr</span><br><span class=\"line\">modprobe -- ip_vs_wrr</span><br><span class=\"line\">modprobe -- ip_vs_sh</span><br><span class=\"line\">modprobe -- ip_vs_dh</span><br><span class=\"line\">modprobe -- ip_vs_fo</span><br><span class=\"line\">modprobe -- ip_vs_nq</span><br><span class=\"line\">modprobe -- ip_vs_sed</span><br><span class=\"line\">modprobe -- ip_vs_ftp</span><br><span class=\"line\">modprobe -- ip_tables</span><br><span class=\"line\">modprobe -- ip_set</span><br><span class=\"line\">modprobe -- ipt_set</span><br><span class=\"line\">modprobe -- ipt_rpfilter</span><br><span class=\"line\">modprobe -- ipt_REJECT</span><br><span class=\"line\">modprobe -- ipip</span><br><span class=\"line\">modprobe -- xt_set</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 权限设置、并加载到系统之中</span></span><br><span class=\"line\">chmod 755 /etc/modules.d/k8s-ipvs.modules &amp;&amp; bash /etc/modules.d/k8s-ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class=\"line\">  <span class=\"comment\"># ip_vs_sh               16384  0</span></span><br><span class=\"line\">  <span class=\"comment\"># ip_vs_wrr              16384  0</span></span><br><span class=\"line\">  <span class=\"comment\"># ip_vs_rr               16384  0</span></span><br><span class=\"line\">  <span class=\"comment\"># ip_vs                 155648  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span></span><br><span class=\"line\">  <span class=\"comment\"># nf_conntrack          139264  1 ip_vs</span></span><br><span class=\"line\">  <span class=\"comment\"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span></span><br><span class=\"line\">  <span class=\"comment\"># nf_defrag_ipv4         16384  1 nf_conntrack</span></span><br><span class=\"line\">  <span class=\"comment\"># libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span></span><br><span class=\"line\"></span><br><span class=\"line\">sysctl --system</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 在 kernel 4.19 版本及以上将使用 nf_conntrack 模块, 则在 4.18 版本以下则需使用nf_conntrack_ipv4 模块。</p>\n<hr>\n<h3 id=\"3-高可用HAProxy与Keepalived软件安装配置\"><a href=\"#3-高可用HAProxy与Keepalived软件安装配置\" class=\"headerlink\" title=\"3.高可用HAProxy与Keepalived软件安装配置\"></a>3.高可用HAProxy与Keepalived软件安装配置</h3><p>描述: 由于是测试学习环境, 此处我未专门准备两台HA服务器, 而是直接采用master节点机器，如果是正式环境建议独立出来。</p>\n<p>步骤 01.【Master节点机器】安装下载 haproxy (HA代理健康检测) 与 keepalived (虚拟路由协议-主从)。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看可用版本</span></span><br><span class=\"line\">sudo apt-cache madison haproxy keepalived</span><br><span class=\"line\">  <span class=\"comment\">#  haproxy | 2.0.13-2ubuntu0.5 | http://mirrors.aliyun.com/ubuntu focal-security/main amd64 Packages</span></span><br><span class=\"line\">  <span class=\"comment\"># keepalived | 1:2.0.19-2ubuntu0.2 | http://mirrors.aliyun.com/ubuntu focal-updates/main amd64 Packages</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装</span></span><br><span class=\"line\">sudo apt -y install haproxy keepalived</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 锁定版本 </span></span><br><span class=\"line\">apt-mark hold haproxy keepalived</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 02.【Master节点机器】进行 HAProxy 配置，其配置目录为 <code>/etc/haproxy/</code>，所有节点配置是一致的。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo cp /etc/haproxy/haproxy.cfg&#123;,.bak&#125;</span><br><span class=\"line\">tee /etc/haproxy/haproxy.cfg&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">global</span><br><span class=\"line\">  user haproxy</span><br><span class=\"line\">  group haproxy</span><br><span class=\"line\">  maxconn 2000</span><br><span class=\"line\">  daemon</span><br><span class=\"line\">  <span class=\"built_in\">log</span> /dev/<span class=\"built_in\">log</span> local0</span><br><span class=\"line\">  <span class=\"built_in\">log</span> /dev/<span class=\"built_in\">log</span> local1 err</span><br><span class=\"line\">  chroot /var/lib/haproxy</span><br><span class=\"line\">  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br><span class=\"line\">  stats timeout 30s</span><br><span class=\"line\">  <span class=\"comment\"># Default SSL material locations</span></span><br><span class=\"line\">  ca-base /etc/ssl/certs</span><br><span class=\"line\">  crt-base /etc/ssl/private</span><br><span class=\"line\">  <span class=\"comment\"># See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.0.3&amp;config=intermediate</span></span><br><span class=\"line\">  ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><br><span class=\"line\">  ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256</span><br><span class=\"line\">  ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span><br><span class=\"line\"></span><br><span class=\"line\">defaults</span><br><span class=\"line\">  <span class=\"built_in\">log</span>     global</span><br><span class=\"line\">  mode    http</span><br><span class=\"line\">  option  httplog</span><br><span class=\"line\">  option  dontlognull</span><br><span class=\"line\">  timeout connect 5000</span><br><span class=\"line\">  timeout client  50000</span><br><span class=\"line\">  timeout server  50000</span><br><span class=\"line\">  timeout http-request 15s</span><br><span class=\"line\">  timeout http-keep-alive 15s</span><br><span class=\"line\">  <span class=\"comment\"># errorfile 400 /etc/haproxy/errors/400.http</span></span><br><span class=\"line\">  <span class=\"comment\"># errorfile 403 /etc/haproxy/errors/403.http</span></span><br><span class=\"line\">  <span class=\"comment\"># errorfile 408 /etc/haproxy/errors/408.http</span></span><br><span class=\"line\">  <span class=\"comment\"># errorfile 500 /etc/haproxy/errors/500.http</span></span><br><span class=\"line\">  <span class=\"comment\"># errorfile 502 /etc/haproxy/errors/502.http</span></span><br><span class=\"line\">  <span class=\"comment\"># errorfile 503 /etc/haproxy/errors/503.http</span></span><br><span class=\"line\">  <span class=\"comment\"># errorfile 504 /etc/haproxy/errors/504.http</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意: 管理HAproxy (可选)</span></span><br><span class=\"line\"><span class=\"comment\"># frontend monitor-in</span></span><br><span class=\"line\"><span class=\"comment\">#   bind *:33305</span></span><br><span class=\"line\"><span class=\"comment\">#   mode http</span></span><br><span class=\"line\"><span class=\"comment\">#   option httplog</span></span><br><span class=\"line\"><span class=\"comment\">#   monitor-uri /monitor</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意: 基于四层代理, 1644 3为VIP的 ApiServer 控制平面端口, 由于是与master节点在一起所以不能使用6443端口.</span></span><br><span class=\"line\">frontend k8s-master</span><br><span class=\"line\">  <span class=\"built_in\">bind</span> 0.0.0.0:16443</span><br><span class=\"line\">  <span class=\"built_in\">bind</span> 127.0.0.1:16443</span><br><span class=\"line\">  mode tcp</span><br><span class=\"line\">  option tcplog</span><br><span class=\"line\">  tcp-request inspect-delay 5s</span><br><span class=\"line\">  default_backend k8s-master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意: Master 节点的默认 Apiserver 是6443端口</span></span><br><span class=\"line\">backend k8s-master</span><br><span class=\"line\">  mode tcp</span><br><span class=\"line\">  option tcplog</span><br><span class=\"line\">  option tcp-check</span><br><span class=\"line\">  balance roundrobin</span><br><span class=\"line\">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class=\"line\">  server devtest-master-212 10.20.176.212:6443 check</span><br><span class=\"line\">  server devtest-master-213 10.20.176.213:6443 check</span><br><span class=\"line\">  server devtest-master-214 10.20.176.214:6443 check</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure><br><br/></p>\n<p>步骤 03.【Master节点机器】进行 KeepAlived 相关配置 ，其配置目录为 <code>/etc/haproxy/</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建配置目录，分别在各个master节点执行。</span></span><br><span class=\"line\">mkdir -vp /etc/keepalived</span><br><span class=\"line\"><span class=\"comment\"># __ROLE__ 角色: MASTER 或者 BACKUP</span></span><br><span class=\"line\"><span class=\"comment\"># __NETINTERFACE__ 宿主机物理网卡名称 例如我的ens32</span></span><br><span class=\"line\"><span class=\"comment\"># __IP__ 宿主机物理IP地址</span></span><br><span class=\"line\"><span class=\"comment\"># __VIP__ 虚拟VIP地址</span></span><br><span class=\"line\">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">! Configuration File <span class=\"keyword\">for</span> keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">  router_id LVS_DEVEL</span><br><span class=\"line\">script_user root</span><br><span class=\"line\">  enable_script_security</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">vrrp_script chk_apiserver &#123;</span><br><span class=\"line\">  script <span class=\"string\">\"/etc/keepalived/check_apiserver.sh\"</span></span><br><span class=\"line\">  interval 5</span><br><span class=\"line\">  weight -5</span><br><span class=\"line\">  fall 2  </span><br><span class=\"line\">  rise 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">  state __ROLE__</span><br><span class=\"line\">  interface __NETINTERFACE__</span><br><span class=\"line\">  mcast_src_ip __IP__</span><br><span class=\"line\">  virtual_router_id 51</span><br><span class=\"line\">  priority 101</span><br><span class=\"line\">  advert_int 2</span><br><span class=\"line\">  authentication &#123;</span><br><span class=\"line\">    auth_type PASS</span><br><span class=\"line\">    auth_pass K8SHA_KA_AUTH</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  virtual_ipaddress &#123;</span><br><span class=\"line\">    __VIP__</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\"># HA 健康检查</span></span><br><span class=\"line\">  <span class=\"comment\"># track_script &#123;</span></span><br><span class=\"line\">  <span class=\"comment\">#   chk_apiserver</span></span><br><span class=\"line\">  <span class=\"comment\"># &#125;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此处将 devtest-master-212 配置为 Master (devtest-master-212 主机上执行)</span></span><br><span class=\"line\"><span class=\"comment\"># devtest-master-212 10.20.176.212 =&gt; MASTER</span></span><br><span class=\"line\">sed -i -e <span class=\"string\">'s#__ROLE__#MASTER#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__NETINTERFACE__#ens32#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__IP__#10.20.176.212#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__VIP__#10.20.176.211#g'</span> /etc/keepalived/keepalived.conf </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># devtest-master-213 10.20.176.213 =&gt; BACKUP  (devtest-master-213 主机上执行)</span></span><br><span class=\"line\">sed -i -e <span class=\"string\">'s#__ROLE__#BACKUP#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__NETINTERFACE__#ens32#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__IP__#10.20.176.213#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__VIP__#10.20.176.211#g'</span> /etc/keepalived/keepalived.conf </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># devtest-master-214 10.20.176.214 =&gt; BACKUP  (devtest-master-214 主机上执行)</span></span><br><span class=\"line\">sed -i -e <span class=\"string\">'s#__ROLE__#BACKUP#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__NETINTERFACE__#ens32#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__IP__#10.20.176.214#g'</span> \\</span><br><span class=\"line\">  -e <span class=\"string\">'s#__VIP__#10.20.176.211#g'</span> /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 注意上述的健康检查是关闭注释了的，你需要将K8S集群建立完成后再开启。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">track_script &#123;</span><br><span class=\"line\">  chk_apiserver</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 04.【Master节点机器】进行配置 KeepAlived 健康检查文件。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tee /etc/keepalived/check_apiserver.sh &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">err=0</span><br><span class=\"line\"><span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> $(seq 1 3)</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">  check_code=$(pgrep haproxy)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"variable\">$check_code</span> == <span class=\"string\">\"\"</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    err=$(expr <span class=\"variable\">$err</span> + 1)</span><br><span class=\"line\">    sleep 1</span><br><span class=\"line\">    <span class=\"built_in\">continue</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    err=0</span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$err</span> != <span class=\"string\">\"0\"</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"systemctl stop keepalived\"</span></span><br><span class=\"line\">  /usr/bin/systemctl stop keepalived</span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 0</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo chmod +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 05.【Master节点机器】启动 haproxy 、keepalived 相关服务及测试VIP漂移。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 重载 Systemd 设置 haproxy 、keepalived 开机自启以及立即启动</span></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> --now haproxy &amp;&amp; sudo systemctl <span class=\"built_in\">enable</span> --now keepalived</span><br><span class=\"line\">  <span class=\"comment\"># Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.</span></span><br><span class=\"line\">  <span class=\"comment\"># Executing: /lib/systemd/systemd-sysv-install enable haproxy</span></span><br><span class=\"line\">  <span class=\"comment\"># Synchronizing state of keepalived.service with SysV service script with /lib/systemd/systemd-sysv-install.</span></span><br><span class=\"line\">  <span class=\"comment\"># Executing: /lib/systemd/systemd-sysv-install enable keepalived</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在 devtest-master-212 主机中发现vip地址在其主机上。</span></span><br><span class=\"line\">root@devtest-master-212:~$ ip addr</span><br><span class=\"line\">  <span class=\"comment\"># 2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span></span><br><span class=\"line\">  <span class=\"comment\">#   link/ether 00:50:56:8a:57:69 brd ff:ff:ff:ff:ff:ff</span></span><br><span class=\"line\">  <span class=\"comment\">#   inet 10.20.176.212/24 brd 10.20.176.255 scope global ens32</span></span><br><span class=\"line\">  <span class=\"comment\">#       valid_lft forever preferred_lft forever</span></span><br><span class=\"line\">  <span class=\"comment\">#   inet 10.20.176.211/24 scope global ens32</span></span><br><span class=\"line\">  <span class=\"comment\">#       valid_lft forever preferred_lft forever</span></span><br><span class=\"line\">  <span class=\"comment\">#   inet6 fe80::250:56ff:fe8a:5769/64 scope link</span></span><br><span class=\"line\">  <span class=\"comment\">#       valid_lft forever preferred_lft forever</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 其它两台Master主机上通信验证。</span></span><br><span class=\"line\">root@devtest-master-213:~$ ping 10.20.176.211</span><br><span class=\"line\">  <span class=\"comment\"># PING 10.20.176.211 (10.20.176.211) 56(84) bytes of data.</span></span><br><span class=\"line\">  <span class=\"comment\"># 64 bytes from 10.20.176.211: icmp_seq=1 ttl=64 time=0.161 ms</span></span><br><span class=\"line\">root@devtest-master-214:~$ ping 10.20.176.211</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220621153045.png\" alt=\"WeiyiGeek. KeepAlived-地址存活验证\" title=\"\" class=\"\">\n                <p>WeiyiGeek. KeepAlived-地址存活验证</p>\n            </figure></p>\n<p>然后我们可以手动验证VIP漂移,我们将该服务器上keepalived停止掉。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@devtest-master-212:~$ pgrep haproxy</span><br><span class=\"line\">  <span class=\"comment\"># 6120</span></span><br><span class=\"line\">  <span class=\"comment\"># 6121</span></span><br><span class=\"line\">root@devtest-master-212:~$ /usr/bin/systemctl stop keepalived</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时,发现VIP已经飘到devtest-master-212主机中</span></span><br><span class=\"line\">root@devtest-master-215:~$ ip addr show ens32</span><br><span class=\"line\">  <span class=\"comment\"># 2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span></span><br><span class=\"line\">  <span class=\"comment\">#     link/ether 00:0c:29:93:28:61 brd ff:ff:ff:ff:ff:ff</span></span><br><span class=\"line\">  <span class=\"comment\">#     inet10.20.176.215/24 brd 10.10.107.255 scope global ens32</span></span><br><span class=\"line\">  <span class=\"comment\">#       valid_lft forever preferred_lft forever</span></span><br><span class=\"line\">  <span class=\"comment\">#     inet 10.20.176.211/32 scope global ens32</span></span><br><span class=\"line\">  <span class=\"comment\">#       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure></p>\n<p>至此，HAProxy 与 Keepalived 配置就告一段落了。</p>\n<hr>\n<h3 id=\"4-容器运行时containerd-io安装配置\"><a href=\"#4-容器运行时containerd-io安装配置\" class=\"headerlink\" title=\"4.容器运行时containerd.io安装配置\"></a>4.容器运行时containerd.io安装配置</h3><p>步骤 01.分别在master与work节点上安装containerd。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.卸载旧版本 </span></span><br><span class=\"line\">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.更新apt包索引并安装包以允许apt在HTTPS上使用存储库</span></span><br><span class=\"line\">sudo apt-get install -y \\</span><br><span class=\"line\">  apt-transport-https \\</span><br><span class=\"line\">  ca-certificates \\</span><br><span class=\"line\">  curl \\</span><br><span class=\"line\">  gnupg-agent \\</span><br><span class=\"line\">  software-properties-common</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.添加Docker官方GPG密钥 # -fsSL</span></span><br><span class=\"line\">curl https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.通过搜索指纹的最后8个字符进行密钥验证</span></span><br><span class=\"line\">sudo apt-key fingerprint 0EBFCD88</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.设置稳定存储库</span></span><br><span class=\"line\">sudo add-apt-repository \\</span><br><span class=\"line\">  <span class=\"string\">\"deb [arch=amd64] https://download.docker.com/linux/ubuntu \\</span></span><br><span class=\"line\"><span class=\"string\">  <span class=\"variable\">$(lsb_release -cs)</span> \\</span></span><br><span class=\"line\"><span class=\"string\">  stable\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6.安装特定版本在repo中列出可用的版本</span></span><br><span class=\"line\">sudo apt-cache madison containerd.io</span><br><span class=\"line\">  <span class=\"comment\"># containerd.io |    1.6.6-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class=\"line\">  <span class=\"comment\"># containerd.io |    1.6.4-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class=\"line\">  <span class=\"comment\"># containerd.io |   1.5.11-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7.使用第二列中的版本字符串安装特定的版本，例如: 1.6.6-1</span></span><br><span class=\"line\">sudo apt-get install containerd.io=1.6.6-1</span><br><span class=\"line\"><span class=\"comment\"># 离线安装: apt install -y ./containerd.io_1.6.6-1_amd64.deb</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>步骤 02.下载安装后在【所有节点】进行containerd 配置，此处将创建并修改 config.toml 文件.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 为 containerd 生成默认配置</span></span><br><span class=\"line\">mkdir -vp /etc/containerd</span><br><span class=\"line\">containerd config default &gt;/etc/containerd/config.toml</span><br><span class=\"line\">ls /etc/containerd/config.toml</span><br><span class=\"line\">  <span class=\"comment\"># /etc/containerd/config.toml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pause 镜像源</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g\"</span>  /etc/containerd/config.toml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 SystemdCgroup</span></span><br><span class=\"line\">sed -i <span class=\"string\">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># docker.io mirror</span></span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors]/a\\ \\ \\ \\ \\ \\ \\ \\ [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]'</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors.\"docker.io\"]/a\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ endpoint = [\"https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com\",\"https://xlx9erfu.mirror.aliyuncs.com\",\"https://docker.mirrors.ustc.edu.cn\"]'</span> /etc/containerd/config.toml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># gcr.io mirror</span></span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors]/a\\ \\ \\ \\ \\ \\ \\ \\ [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"gcr.io\"]'</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors.\"gcr.io\"]/a\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ endpoint = [\"https://gcr.mirrors.ustc.edu.cn\"]'</span> /etc/containerd/config.toml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io mirror</span></span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors]/a\\ \\ \\ \\ \\ \\ \\ \\ [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]'</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors.\"k8s.gcr.io\"]/a\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ endpoint = [\"https://gcr.mirrors.ustc.edu.cn/google-containers/\",\"https://registry.cn-hangzhou.aliyuncs.com/google_containers/\"]'</span> /etc/containerd/config.toml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># quay.io mirror</span></span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors]/a\\ \\ \\ \\ \\ \\ \\ \\ [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay.io\"]'</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">'/registry.mirrors.\"quay.io\"]/a\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ endpoint = [\"https://quay.mirrors.ustc.edu.cn\"]'</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>步骤 03.修改配置后【所有节点】重载containerd服务并查看相关服务及其版本。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置重载与服务重启</span></span><br><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl restart containerd.service</span><br><span class=\"line\">systemctl status -l containerd.service</span><br><span class=\"line\">  <span class=\"comment\"># ● containerd.service - containerd container runtime</span></span><br><span class=\"line\">  <span class=\"comment\">#    Loaded: loaded (/lib/systemd/system/containerd.service; enabled; vendor preset: enabled)</span></span><br><span class=\"line\">  <span class=\"comment\">#    Active: active (running) since Thu 2022-06-16 05:22:50 UTC; 5 days ago</span></span><br><span class=\"line\">  <span class=\"comment\">#      Docs: https://containerd.io</span></span><br><span class=\"line\">  <span class=\"comment\">#  Main PID: 790 (containerd)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Tasks: 51</span></span><br><span class=\"line\">  <span class=\"comment\">#    Memory: 76.3M</span></span><br><span class=\"line\">  <span class=\"comment\">#    CGroup: /system.slice/containerd.service</span></span><br><span class=\"line\">  <span class=\"comment\">#            ├─ 790 /usr/bin/containerd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 客户端版本查看</span></span><br><span class=\"line\">root@devtest-master-212:/var/cache/apt/archives<span class=\"comment\"># ctr version</span></span><br><span class=\"line\"><span class=\"comment\"># Client:</span></span><br><span class=\"line\"><span class=\"comment\">#   Version:  1.6.6</span></span><br><span class=\"line\"><span class=\"comment\">#   Revision: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span></span><br><span class=\"line\"><span class=\"comment\">#   Go version: go1.17.11</span></span><br><span class=\"line\"><span class=\"comment\"># Server:</span></span><br><span class=\"line\"><span class=\"comment\">#   Version:  1.6.6</span></span><br><span class=\"line\"><span class=\"comment\">#   Revision: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span></span><br><span class=\"line\"><span class=\"comment\">#   UUID: 71a28bbb-6ed6-408d-a873-e394d48b35d8</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@devtest-master-212:/var/cache/apt/archives<span class=\"comment\"># runc -v</span></span><br><span class=\"line\">  <span class=\"comment\"># runc version 1.1.2</span></span><br><span class=\"line\">  <span class=\"comment\"># commit: v1.1.2-0-ga916309</span></span><br><span class=\"line\">  <span class=\"comment\"># spec: 1.0.2-dev</span></span><br><span class=\"line\">  <span class=\"comment\"># go: go1.17.11</span></span><br><span class=\"line\">  <span class=\"comment\"># libseccomp: 2.5.1</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h3 id=\"5-安装源配置与初始化集群配置准备\"><a href=\"#5-安装源配置与初始化集群配置准备\" class=\"headerlink\" title=\"5.安装源配置与初始化集群配置准备\"></a>5.安装源配置与初始化集群配置准备</h3><p>步骤 01.【所有节点】Kubernetes 安装源配置及其kubelet、kubeadm、kubectl工具下载安装<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) gpg 签名下载导入</span></span><br><span class=\"line\">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) Kubernetes 安装源</span></span><br><span class=\"line\">cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list </span><br><span class=\"line\">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class=\"line\">EOF</span><br><span class=\"line\">apt update</span><br><span class=\"line\"><span class=\"comment\"># 其它方式:</span></span><br><span class=\"line\"><span class=\"comment\"># (2) 设置稳定存储库</span></span><br><span class=\"line\"><span class=\"comment\"># sudo add-apt-repository \"deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) K8S可用版本,此处可以看见最新的是 1.24.1 , 由于博主实践的K8S是为开发测试环境所搭建，则此处选择 1.23.7 版本。</span></span><br><span class=\"line\">apt-cache madison kubelet | more</span><br><span class=\"line\">  kubelet |  1.24.1-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages</span><br><span class=\"line\">  kubelet |  1.24.0-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages</span><br><span class=\"line\">  kubelet |  1.23.7-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 下载安装指定版本的kubelet、kubeadm、kubectl</span></span><br><span class=\"line\">K8S_VERSION=<span class=\"string\">\"1.23.7-00\"</span></span><br><span class=\"line\">sudo apt install kubelet=<span class=\"variable\">$&#123;K8S_VERSION&#125;</span> kubeadm=<span class=\"variable\">$&#123;K8S_VERSION&#125;</span> kubectl=<span class=\"variable\">$&#123;K8S_VERSION&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 02.【所有节点】重载systemd守护进程并将 kubelet 设置成开机启动<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart containerd.service</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>步骤 03.【devtest-master-212】为了节约拉取实践我们可以在某一台master节点上先拉取所K8S集群所需要的镜像。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 列出所需镜像</span></span><br><span class=\"line\">kubeadm config images list --kubernetes-version=1.23.7</span><br><span class=\"line\">  <span class=\"comment\"># k8s.gcr.io/kube-apiserver:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># k8s.gcr.io/kube-controller-manager:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># k8s.gcr.io/kube-scheduler:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># k8s.gcr.io/kube-proxy:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># k8s.gcr.io/pause:3.6</span></span><br><span class=\"line\">  <span class=\"comment\"># k8s.gcr.io/etcd:3.5.1-0</span></span><br><span class=\"line\">  <span class=\"comment\"># k8s.gcr.io/coredns/coredns:v1.8.6</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用阿里提供的镜像源进行拉取v1.23.7版本依赖的相关镜像</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> $(kubeadm config images list --kubernetes-version=1.23.7 --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers -v 5);<span class=\"keyword\">do</span></span><br><span class=\"line\">  ctr -n k8s.io images pull <span class=\"variable\">$&#123;i&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">  <span class=\"comment\"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span></span><br><span class=\"line\">  <span class=\"comment\"># registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0</span></span><br><span class=\"line\">  <span class=\"comment\"># registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从 container.io 中的镜像导出本地</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> images <span class=\"keyword\">in</span> $(ctr -n k8s.io i ls name~=registry.cn-hangzhou.aliyuncs.com/google_containers -q);<span class=\"keyword\">do</span></span><br><span class=\"line\">  temp_name=<span class=\"variable\">$&#123;images##*/&#125;</span> </span><br><span class=\"line\">  tar_name=$(<span class=\"built_in\">echo</span> <span class=\"variable\">$temp_name</span> |  tr <span class=\"string\">':'</span> <span class=\"string\">'_'</span>)</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"export <span class=\"variable\">$&#123;images&#125;</span> &gt;&gt; <span class=\"variable\">$tar_name</span>.tar\"</span></span><br><span class=\"line\">  ctr -n k8s.io images <span class=\"built_in\">export</span> <span class=\"variable\">$&#123;tar_name&#125;</span>.tar <span class=\"variable\">$&#123;images&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从本地导入镜像到 container.io 中</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> tarfile <span class=\"keyword\">in</span> $(ls);<span class=\"keyword\">do</span></span><br><span class=\"line\">    $ ctr images import --base-name foo/bar foobar.tar</span><br><span class=\"line\">  ctr -n k8s.io images <span class=\"built_in\">export</span> <span class=\"variable\">$&#123;tar_name&#125;</span>.tar <span class=\"variable\">$&#123;images&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>步骤 04.导入到各个节点后我们可以通过如下命令查看导入的镜像列表信息。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1</span></span><br><span class=\"line\">ctr -n k8s.io i ls name~=registry.cn-hangzhou.aliyuncs.com/google_container</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2</span></span><br><span class=\"line\">crictl images | grep <span class=\"string\">\"registry.cn-hangzhou.aliyuncs.com/google\"</span></span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64               3.0                 99e59f495ffaa       314kB</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   v1.8.6              a4ca41631cc7a       13.6MB</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.5.1-0             25f8c7f3da61c       98.9MB</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.23.7             03c169f383d97       32.6MB</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.23.7             e34d4a6252edd       30.2MB</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.23.7             b1aa05aa5100e       39.3MB</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.23.7             ed0ccfa052ab4       15.1MB</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.6                 6270bb605e12e       302kB</span><br></pre></td></tr></table></figure>\n<hr>\n<h3 id=\"6-使用kubeadm安装部署K8S集群\"><a href=\"#6-使用kubeadm安装部署K8S集群\" class=\"headerlink\" title=\"6.使用kubeadm安装部署K8S集群\"></a>6.使用kubeadm安装部署K8S集群</h3><p>步骤 01.【devtest-master-212 节点】生成K8S初始化yaml配置文件，并根据实际情况进行编辑。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubeadm config <span class=\"built_in\">print</span> init-defaults &gt; kubeadm-init-default.yaml</span><br><span class=\"line\">$ vim kubeadm-init-default.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此处为v1.23.x 适用的集群初始化配置清单</span></span><br><span class=\"line\">tee kubeadm-init-cluster.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class=\"line\">bootstrapTokens:</span><br><span class=\"line\">- groups:</span><br><span class=\"line\">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class=\"line\">  token: devtes.httpweiyigeektop</span><br><span class=\"line\">  ttl: 24h0m0s</span><br><span class=\"line\">  usages:</span><br><span class=\"line\">  - signing</span><br><span class=\"line\">  - authentication</span><br><span class=\"line\">kind: InitConfiguration</span><br><span class=\"line\">localAPIEndpoint:</span><br><span class=\"line\">  advertiseAddress: 10.20.176.212   <span class=\"comment\"># 关键点: 当前节点地址</span></span><br><span class=\"line\">  bindPort: 6443                    <span class=\"comment\"># 关键点: API端口默认即可</span></span><br><span class=\"line\">nodeRegistration:</span><br><span class=\"line\">  criSocket: /run/containerd/containerd.sock  <span class=\"comment\"># 关键点: 指定containerd为运行时</span></span><br><span class=\"line\">  imagePullPolicy: IfNotPresent</span><br><span class=\"line\">  name: devtest-master-212          <span class=\"comment\"># 关键点: 当前节点名称</span></span><br><span class=\"line\">  taints:</span><br><span class=\"line\">  - effect: NoSchedule</span><br><span class=\"line\">    key: node-role.kubernetes.io/master</span><br><span class=\"line\">---</span><br><span class=\"line\">apiServer:</span><br><span class=\"line\">  certSANs:                         <span class=\"comment\"># 关键点: 证书中心包含的SANs列表一般包含VIP与各节点的主机名称</span></span><br><span class=\"line\">  - slbvip.k8s.devtest</span><br><span class=\"line\">  - localhost</span><br><span class=\"line\">  - devtest-master-212</span><br><span class=\"line\">  - devtest-master-213</span><br><span class=\"line\">  - devtest-master-214</span><br><span class=\"line\">  - 10.20.176.211</span><br><span class=\"line\">  - 10.20.176.212</span><br><span class=\"line\">  - 10.20.176.213</span><br><span class=\"line\">  - 10.20.176.214</span><br><span class=\"line\">  - 10.66.66.2</span><br><span class=\"line\">  timeoutForControlPlane: 4m0s</span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class=\"line\">certificatesDir: /etc/kubernetes/pki</span><br><span class=\"line\">clusterName: kubernetes</span><br><span class=\"line\">controllerManager: &#123;&#125;</span><br><span class=\"line\">dns:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: CoreDNS</span><br><span class=\"line\">etcd:</span><br><span class=\"line\">  <span class=\"built_in\">local</span>:</span><br><span class=\"line\">    dataDir: /var/lib/etcd</span><br><span class=\"line\">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class=\"comment\"># 关键点: 集群所需镜像仓库源加快拉取</span></span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">kubernetesVersion: v1.23.7                      <span class=\"comment\"># 关键点: K8S集群版本此处与我们提前下载的镜像版本必须一致否则将会重新拉取指定K8S集群所需镜像。</span></span><br><span class=\"line\">controlPlaneEndpoint: slbvip.k8s.devtest:16443  <span class=\"comment\"># 关键点: 高可用VIP地址的域名与haproxy代理端口。</span></span><br><span class=\"line\">networking:</span><br><span class=\"line\">  dnsDomain: cluster.test                       <span class=\"comment\"># 关键点: 集群dns根域默认cluster.local</span></span><br><span class=\"line\">  serviceSubnet: 10.96.0.0/12                   <span class=\"comment\"># 关键点: services 服务子网段</span></span><br><span class=\"line\">  podSubnet: 10.66.0.0/16                       <span class=\"comment\"># 关键点: pod 服务子网段</span></span><br><span class=\"line\">scheduler: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class=\"line\">kind: KubeProxyConfiguration</span><br><span class=\"line\">mode: ipvs                                      <span class=\"comment\"># 关键点: 启用IPVS支持</span></span><br><span class=\"line\">ipvs:</span><br><span class=\"line\">  excludeCIDRs:</span><br><span class=\"line\">  - 10.66.66.2/32                               <span class=\"comment\"># 关键点: 排出指定IP</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 02.【devtest-master-212 节点】准备好初始化yaml清单后, 通过 kubeadm init 命令进行集群的初始化，并将日志输入到kubeadm-init.log。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm init --config=kubeadm-init-cluster.yaml --v=5 | tee kubeadm-init.log</span><br><span class=\"line\"><span class=\"comment\"># --config 指定yaml配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># --v 指定日志等级 debug</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当执行后出现如下提示表明节点初始化安装成功，可以按照指定提示进行执行。</span></span><br><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"><span class=\"comment\"># To start using your cluster, you need to run the following as a regular user:</span></span><br><span class=\"line\">  mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Alternatively, if you are the root user, you can run:</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># You should now deploy a pod network to the cluster.</span></span><br><span class=\"line\">Run <span class=\"string\">\"kubectl apply -f [podnetwork].yaml\"</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 【控制节点加入命令】</span></span><br><span class=\"line\"><span class=\"comment\"># You can now join any number of control-plane nodes by copying certificate authorities and service account keys on each node and then running the following as root:</span></span><br><span class=\"line\">  kubeadm join slbvip.k8s.devtest:16443 --token devtes.httpweiyigeektop \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22 \\</span><br><span class=\"line\">        --control-plane</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 【工作节点加入命令】</span></span><br><span class=\"line\"><span class=\"comment\"># Then you can join any number of worker nodes by running the following on each as root:</span></span><br><span class=\"line\">kubeadm join slbvip.k8s.devtest:16443 --token devtes.httpweiyigeektop \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 03.将【devtest-master-212】节点中<code>/etc/kubernetes/</code>目录中的如下文件进行复制打包，并通过http协议将其分享给其它机器进行下载<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将ca证书拷贝到指定目录</span></span><br><span class=\"line\">mkdir -vp /tmp/pki/etcd &amp;&amp; cp /etc/kubernetes/pki/ca.* /etc/kubernetes/pki/sa.* /etc/kubernetes/pki/front-proxy-ca.* /tmp/pki</span><br><span class=\"line\">cp /etc/kubernetes/pki/etcd/ca.* /tmp/pki/etcd/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 压缩依赖依赖的ca证书目录</span></span><br><span class=\"line\">tar -zcvf pki.tar.gz pki/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 python 搭建一个临时 http 服务</span></span><br><span class=\"line\">python3 -m http.server 8080</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在其它【节点】进入到/tmp/执行如下命令进行下载</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /tmp/ &amp;&amp; wget 10.20.176.212:8080/pki.tar.gz</span><br><span class=\"line\">tar -zxvf /tmp/pki.tar.gz -C /etc/kubernetes/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看解压后的复制到/etc/kubernetes/目录中的文件相关结构。</span></span><br><span class=\"line\">tree /etc/kubernetes/</span><br><span class=\"line\">/etc/kubernetes/</span><br><span class=\"line\">└── pki</span><br><span class=\"line\">    ├── ca.crt</span><br><span class=\"line\">    ├── ca.key</span><br><span class=\"line\">    ├── etcd</span><br><span class=\"line\">    │   ├── ca.crt</span><br><span class=\"line\">    │   └── ca.key</span><br><span class=\"line\">    ├── front-proxy-ca.crt</span><br><span class=\"line\">    ├── front-proxy-ca.key</span><br><span class=\"line\">    ├── sa.key</span><br><span class=\"line\">    └── sa.pub</span><br><span class=\"line\">2 directories, 8 files</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>步骤 04.在其余【master】节点中执行如下 kubeadm join 命令添加新的 Master 节点到K8S集群控制面板中, 加入成功后如下图所示:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm join slbvip.k8s.devtest:16443 \\</span><br><span class=\"line\">--control-plane \\</span><br><span class=\"line\">--token devtes.httpweiyigeektop \\</span><br><span class=\"line\">--discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22 \\</span><br><span class=\"line\">--cri-socket /run/containerd/containerd.sock</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220621221035.png\" alt=\"WeiyiGeek.master-join\" title=\"\" class=\"\">\n                <p>WeiyiGeek.master-join</p>\n            </figure>\n<p>温馨提示: 在<code>v1.23.x</code>如果要使用containerd运行时必须<code>--cri-socket</code>指定其运行时socket。</p>\n<p><br></p>\n<p>步骤 05.在其余【work】节点中执行如下 kubeadm join 命令添加新的 Work 节点到K8S集群中, 加入成功后如下图所示:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm join slbvip.k8s.devtest:16443 \\</span><br><span class=\"line\">  --token devtes.httpweiyigeektop \\</span><br><span class=\"line\">  --discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22 \\</span><br><span class=\"line\">  --cri-socket /run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220621221934.png\" alt=\"WeiyiGeek.work-join\" title=\"\" class=\"\">\n                <p>WeiyiGeek.work-join</p>\n            </figure>\n<p><br></p>\n<p>步骤 06.全部加入到集群后我们可以通过如下命令进行查看添加的节点以及其节点角色设置，最终执行结果如下图所示。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群节点查看</span></span><br><span class=\"line\">root@devtest-master-212:~$ kubectl get node</span><br><span class=\"line\">  <span class=\"comment\"># NAME                 STATUS   ROLES                  AGE     VERSION</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-master-212   Ready    control-plane,master   15m     v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-master-213   Ready    control-plane,master   5m19s   v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-master-214   Ready    control-plane,master   2m7s    v1.23.7</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-work-215     Ready    &lt;none&gt;                 14m     v1.23.7</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 集群节点角色设置，此处将devtest-work-215节点的ROLES设置为 work。</span></span><br><span class=\"line\">root@devtest-master-212:~$ kubectl label node devtest-work-215 node-role.kubernetes.io/work=</span><br><span class=\"line\">  <span class=\"comment\"># node/devtest-work-215 labeled</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220621222257.png\" alt=\"WeiyiGeek.cluster-roles\" title=\"\" class=\"\">\n                <p>WeiyiGeek.cluster-roles</p>\n            </figure>\n<p><br></p>\n<p>步骤 07.查看集群信息、集群组件、以及集群中所有Pod进行查看, 执行结果如下<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@devtest-master-212:~<span class=\"comment\"># kubectl cluster-info</span></span><br><span class=\"line\">  Kubernetes control plane is running at https://slbvip.k8s.devtest:16443</span><br><span class=\"line\">  CoreDNS is running at https://slbvip.k8s.devtest:16443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class=\"line\">  To further debug and diagnose cluster problems, use <span class=\"string\">'kubectl cluster-info dump'</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">root@devtest-master-212:~<span class=\"comment\"># kubectl get cs</span></span><br><span class=\"line\">  Warning: v1 ComponentStatus is deprecated <span class=\"keyword\">in</span> v1.19+</span><br><span class=\"line\">  NAME                 STATUS    MESSAGE                         ERROR</span><br><span class=\"line\">  scheduler            Healthy   ok</span><br><span class=\"line\">  controller-manager   Healthy   ok</span><br><span class=\"line\">  etcd-0               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>,<span class=\"string\">\"reason\"</span>:<span class=\"string\">\"\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">root@devtest-master-212:~<span class=\"comment\"># kubectl get pod -A</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220621223144.png\" alt=\"WeiyiGeek.cluster-info\" title=\"\" class=\"\">\n                <p>WeiyiGeek.cluster-info</p>\n            </figure>\n<p><br></p>\n<p>步骤 08.开启所有【master】中keepalived的健康检查,并重启keepalived.service服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/keepalived/keepalived.conf</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"comment\"># 开启 HA 健康检查，例如</span></span><br><span class=\"line\">  track_script &#123;</span><br><span class=\"line\">    chk_apiserver</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">systemctl restart keepalived.service</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>步骤 09.然后我们为kubectl添加命令自动补齐不全功能，执行如下代码即可。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install -y bash-completion</span><br><span class=\"line\"><span class=\"built_in\">source</span> /usr/share/bash-completion/bash_completion</span><br><span class=\"line\"><span class=\"built_in\">source</span> &lt;(kubectl completion bash)</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"source &lt;(kubectl completion bash)\"</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>步骤 10.最后我们可以部署一个nginx的Pod验证集群环境, 并通过curl进行访问，但是此时你会发现只有在【devtest-work-215】主机上才能访问该nginx，而其它节点访问时会报<code>Connection timed out</code>, 其原因可看下面的温馨提示。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl run nginx --image nginx:latest --port=80</span><br><span class=\"line\">  pod/nginx created</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pod -o wide</span><br><span class=\"line\">  NAME    READY   STATUS    RESTARTS   AGE   IP          NODE               NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">  nginx   1/1     Running   0          68s   10.22.0.5   devtest-work-215   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">curl -I http://10.22.0.5</span><br><span class=\"line\">  curl: (28) Failed to connect to 10.22.0.5 port 80: Connection timed out</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 这是由于我们没有为集群配置网络插件，而常用的网络插件是flannel、calico（<code>下面将会以此为例</code>）以及当下cilium。</p>\n<p><br/></p>\n<p>步骤 11.特别注意此处为了能在后续演示中将Pod应用调度到Master节点上,此时我们需要分别去除控制节点的污点。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl taint node devtest-master-212 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class=\"line\">  <span class=\"comment\"># node/devtest-master-212 untainted</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl taint node devtest-master-213 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class=\"line\">  <span class=\"comment\"># node/devtest-master-213 untainted</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl taint node devtest-master-214 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class=\"line\">  <span class=\"comment\"># node/devtest-master-214 untainted</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<hr>\n<h3 id=\"7-部署配置-Calico-网络插件\"><a href=\"#7-部署配置-Calico-网络插件\" class=\"headerlink\" title=\"7.部署配置 Calico 网络插件\"></a>7.部署配置 Calico 网络插件</h3><p>描述: 在节点加入到集群时有时你会发现其节点状态为 NotReady, 以及前面部署Pod无法被其它节点机器进行代理转发访问，所以部署calico插件可以让Pod与集群正常通信。</p>\n<p>步骤 01.在【devtest-master-212】节点上拉取最新版本的 calico 当前最新版本为 v3.22, 官方项目地址 (<a href=\"https://github.com/projectcalico/calico\" target=\"_blank\" rel=\"noopener\">https://github.com/projectcalico/calico</a>)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拉取 calico 部署清单</span></span><br><span class=\"line\">wget https://docs.projectcalico.org/v3.22/manifests/calico.yaml</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 02.修改 calico.yaml 文件的中如下 K/V, 即 Pod 获取IP地址的地址池, 从网络规划中我们设置为 <code>10.66.0.0/16</code>, 注意默认情况下如下字段是注释的且默认地址池为<code>192.168.0.0/16</code>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim calico.yaml</span><br><span class=\"line\"><span class=\"comment\"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span></span><br><span class=\"line\"><span class=\"comment\"># chosen from this range. Changing this value after installation will have</span></span><br><span class=\"line\"><span class=\"comment\"># no effect. This should fall within `--cluster-cidr`.</span></span><br><span class=\"line\">- name: CALICO_IPV4POOL_CIDR</span><br><span class=\"line\">  value: <span class=\"string\">\"10.66.0.0/16\"</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220622103937.png\" alt=\"WeiyiGeek.CALICO_IPV4POOL_CIDR\" title=\"\" class=\"\">\n                <p>WeiyiGeek.CALICO_IPV4POOL_CIDR</p>\n            </figure>\n<p><br/></p>\n<p>步骤 03.执行 kubectl apply 命令部署 calico 到集群之中。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f calico.yaml</span><br><span class=\"line\">  <span class=\"comment\"># configmap/calico-config created</span></span><br><span class=\"line\">  <span class=\"comment\"># ....</span></span><br><span class=\"line\">  <span class=\"comment\"># poddisruptionbudget.policy/calico-kube-controllers created</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 04.查看calico网络插件在各节点上部署结果,状态为Running表示部署成功。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n kube-system -o wide| head -n 6</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                         READY   STATUS    RESTARTS        AGE     IP              NODE                 NOMINATED NODE   READINESS GATES</span></span><br><span class=\"line\">  <span class=\"comment\"># calico-kube-controllers-6b77fff45-w29rq      1/1     Running   0               8m5s    10.66.35.65     devtest-master-214   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># calico-node-7gxdc                            1/1     Running   0               8m5s    10.20.176.213   devtest-master-213   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># calico-node-tsk6w                            1/1     Running   0               8m5s    10.20.176.212   devtest-master-212   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># calico-node-vnkhg                            1/1     Running   0               8m5s    10.20.176.215   devtest-work-215     &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># calico-node-xh2dw                            1/1     Running   0               8m5s    10.20.176.214   devtest-master-214   &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220622104018.png\" alt=\"WeiyiGeek.calico-部署情况\" title=\"\" class=\"\">\n                <p>WeiyiGeek.calico-部署情况</p>\n            </figure>\n<p><br/></p>\n<p>步骤 05.此时删除 nginx 的 Pod 再重新创建一个Pod应用，并在非【devtest-work-215 】节点上进行访问测试</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@devtest-master-212:/opt/init/k8s<span class=\"comment\"># kubectl run nginx --image=nginx:latest --port=80</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/nginx created</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@devtest-master-212:/opt/init/k8s<span class=\"comment\"># kubectl get pod nginx</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME    READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx   1/1     Running   0          10s</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@devtest-master-212:/opt/init/k8s<span class=\"comment\"># kubectl get pod nginx -o wide</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME    READY   STATUS    RESTARTS   AGE   IP   NODE   NOMINATED NODE       READINESS GATES</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx   1/1     Running   0          13s   10.66.53.66   devtest-work-215   &lt;none&gt;   &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@devtest-master-212:/opt/init/k8s<span class=\"comment\"># curl -I 10.66.53.66</span></span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 200 OK</span></span><br><span class=\"line\">  <span class=\"comment\"># Server: nginx/1.21.5</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Wed, 15 Jun 2022 11:39:48 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 615</span></span><br><span class=\"line\">  <span class=\"comment\"># Last-Modified: Tue, 28 Dec 2021 15:28:38 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># ETag: \"61cb2d26-267\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Accept-Ranges: bytes</span></span><br></pre></td></tr></table></figure>\n<p>至此，高可用的K8S集群部署完毕，在下节中将实践演示在集群中安装 Metrics Server 、kubernetes-dashboard、nfs-provisioner、ingress 等安装实践。</p>\n<hr>\n<h2 id=\"0x03-集群辅助插件部署\"><a href=\"#0x03-集群辅助插件部署\" class=\"headerlink\" title=\"0x03 集群辅助插件部署\"></a>0x03 集群辅助插件部署</h2><h3 id=\"1-集群中基于nfs的provisioner的动态持卷环境部署\"><a href=\"#1-集群中基于nfs的provisioner的动态持卷环境部署\" class=\"headerlink\" title=\"1.集群中基于nfs的provisioner的动态持卷环境部署\"></a>1.集群中基于nfs的provisioner的动态持卷环境部署</h3><p>描述: 在K8S集群中我们常常会使用动态持久卷对应用数据进行持久化保存，例如应用配置、依赖插件、应用数据以及应用访问日志等，所以动态持久卷的重要性不言而喻，此小节将讲解如何搭建以及nfs存储服务以及使用<code>kubernetes-sigs</code>提供的[nfs-subdir-external-provisioner] (<a href=\"https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner)项目针对已存在的\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner)项目针对已存在的</a> nfs 服务器进行 provisioner 部署。</p>\n<p><br></p>\n<p><strong>Q: 什么是nfs-subdir-external-provisioner?</strong></p>\n<blockquote>\n<p>NFS subdir external provisioner 是一个自动配置器，它使用您现有的和已配置的 NFS 服务器来支持通过  Persistent Volume Claims 动态配置 Kubernetes Persistent Volumes。<br>持久卷配置为  \\${namespace}-\\${pvcName}-\\${pvName}。</p>\n</blockquote>\n<p>温馨提示：在进行此环境搭建时，请注意您必须已经有配置好的 NFS 服务器，为了保持与早期部署文件的向后兼容性，NFS Client Provisioner 的命名在部署 YAML 中保留为 nfs-storage-provisioner。</p>\n<p>项目地址: <a href=\"https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></p>\n<p><br></p>\n<p>步骤 01.我在一台Ubuntu 20.04主机上配置 NFS 存储服务器(IP地址为10.20.176.102)，如果你已有存储服务器提供的NFS服务器则可以略过此步骤，其它操作系统安装部署请看出我的这篇博客文章[NFS网络文件系统基础配置与使用] (<a href=\"https://blog.weiyigeek.top/2019/5-16-104.html\">https://blog.weiyigeek.top/2019/5-16-104.html</a>)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Step1.Install Required Packages（Server）</span></span><br><span class=\"line\">$ apt-get update</span><br><span class=\"line\">$ apt-get install nfs-kernel-server rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Step2.Configure NFS Server</span></span><br><span class=\"line\"><span class=\"comment\"># [根据需求配置] 设置允许连接的ip, Example Allow 192.168.1.0/24 to be Accessed on Network</span></span><br><span class=\"line\">$ nano /etc/hosts.allow</span><br><span class=\"line\">portmap: 192.168.1.0/24   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [根据需求配置] idmapd 配置, 此处配置端口为40000</span></span><br><span class=\"line\">$ nano /etc/default/nfs-common</span><br><span class=\"line\">NEED_IDMAPD=YES  </span><br><span class=\"line\">STATDOPTS=<span class=\"string\">\"--port 40000\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [根据需求配置] 内核服务配置,此处mountd服务端口为40001</span></span><br><span class=\"line\">$ nano /etc/default/nfs-kernel-server</span><br><span class=\"line\">RPCMOUNTDOPTS=<span class=\"string\">\"--manage-gids --port 40001\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># NFS 服务器共享路径配置</span></span><br><span class=\"line\">$ nano /etc/exports</span><br><span class=\"line\"><span class=\"comment\"># Example for NFSv2 and NFSv3:</span></span><br><span class=\"line\"><span class=\"comment\"># /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)</span></span><br><span class=\"line\"><span class=\"comment\"># Example for NFSv4:</span></span><br><span class=\"line\"><span class=\"comment\"># /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)</span></span><br><span class=\"line\"><span class=\"comment\"># /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)</span></span><br><span class=\"line\">/app/storage/nfs *(rw,sync,no_root_squash,no_subtree_check)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Step3.创建NFS配置需要共享的目录</span></span><br><span class=\"line\">mkdir -vp /app/storage/nfs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Step4.自启动RPC服务于nfs共享服务</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind nfs-server.service</span><br><span class=\"line\">systemctl start rpcbind nfs-server.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Step5.更新nfs配置文件 (nano /etc/exports)</span></span><br><span class=\"line\">  exportfs -a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Step6.Ubuntu防火墙规则配置 （PS: 通过rpcinfo命令可以查看 NFS 相关的端口）</span></span><br><span class=\"line\">ufw allow 111,2049,40000,40001/tcp</span><br><span class=\"line\">ufw reload</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>步骤 02.【所有节点】在客户端尝试挂载搭建的NFS服务器，并分别在节点机器挂载到<code>/storage/nfs</code>目录中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看 NFS 挂载目录</span></span><br><span class=\"line\">showmount -e 127.0.0.1</span><br><span class=\"line\">  <span class=\"comment\"># Export list for 127.0.0.1:</span></span><br><span class=\"line\">  <span class=\"comment\"># /app/storage/nfs *</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 挂载 NFS 服务器到指定节点目录的/storage/nfs目录</span></span><br><span class=\"line\">mkdir -vp /storage/nfs</span><br><span class=\"line\"><span class=\"comment\"># 临时挂载</span></span><br><span class=\"line\">mount -t nfs 10.20.176.102:/app/storage/nfs /storage/nfs</span><br><span class=\"line\"><span class=\"comment\"># 永久挂载将挂载配置写入到/etc/fstab中</span></span><br><span class=\"line\">tee -a /etc/fstab &lt;&lt;<span class=\"string\">\"EOF\"</span></span><br><span class=\"line\">10.20.176.102:/app/storage/nfs /storage/nfs nfs defaults 0 0</span><br><span class=\"line\">EOF</span><br><span class=\"line\">mount -a </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看挂载信息</span></span><br><span class=\"line\">$ mount -l</span><br><span class=\"line\">$ df -Th | grep <span class=\"string\">\"/storage/nfs\"</span></span><br><span class=\"line\">10.20.176.102:/app/storage/nfs nfs4   97G   11G   82G  12% /storage/nfs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果不使用了则可执行如下命令进行卸载挂载点</span></span><br><span class=\"line\">umount /storage/nfs</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220622162349.png\" alt=\"WeiyiGeek.挂载NFS服务到各个节点\" title=\"\" class=\"\">\n                <p>WeiyiGeek.挂载NFS服务到各个节点</p>\n            </figure>\n<p><br></p>\n<p>步骤 03.helm3 部署工具快速安装</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># helm3 安装</span></span><br><span class=\"line\">$ wget https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz &amp;&amp; tar -zxf helm-v3.9.0-linux-amd64.tar.gz</span><br><span class=\"line\">$ tar -zxf helm-v3.9.0-linux-amd64.tar.gz</span><br><span class=\"line\">$ cp linux-amd64/helm /usr/<span class=\"built_in\">local</span>/bin/helm3</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>步骤 04.在Github中下载nfs-subdir-external-provisioner的release压缩包或者使用helm3指定仓库进行安装。</p>\n<ul>\n<li><p>方式1.release 压缩包</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/releases/download/nfs-subdir-external-provisioner-4.0.16/nfs-subdir-external-provisioner-4.0.16.tgz</span><br><span class=\"line\">$ tar -zxvf nfs-subdir-external-provisioner-4.0.16.tgz</span><br><span class=\"line\"><span class=\"comment\"># 按照指定需求编辑如下values值</span></span><br><span class=\"line\">$ egrep -v <span class=\"string\">'^$|#'</span> values.yaml</span><br><span class=\"line\">replicaCount: 1</span><br><span class=\"line\">strategyType: Recreate</span><br><span class=\"line\">image:</span><br><span class=\"line\">  repository: registry.cn-hangzhou.aliyuncs.com/weiyigeek/nfs-subdir-external-provisioner</span><br><span class=\"line\">  tag: v4.0.2</span><br><span class=\"line\">  pullPolicy: IfNotPresent</span><br><span class=\"line\">imagePullSecrets: []</span><br><span class=\"line\">nfs:</span><br><span class=\"line\">  server: 10.20.176.102</span><br><span class=\"line\">  path: /app/storage/nfs</span><br><span class=\"line\">  mountOptions:</span><br><span class=\"line\">  volumeName: nfs-subdir-external-provisioner-root</span><br><span class=\"line\">  reclaimPolicy: Retain</span><br><span class=\"line\">storageClass:</span><br><span class=\"line\">  create: <span class=\"literal\">true</span></span><br><span class=\"line\">  provisionerName: cluster.local/nfs-storage-subdir-provisioner</span><br><span class=\"line\">  defaultClass: <span class=\"literal\">false</span></span><br><span class=\"line\">  name: nfs-storage</span><br><span class=\"line\">  allowVolumeExpansion: <span class=\"literal\">true</span></span><br><span class=\"line\">  reclaimPolicy: Delete</span><br><span class=\"line\">  archiveOnDelete: <span class=\"literal\">true</span></span><br><span class=\"line\">  onDelete:</span><br><span class=\"line\">  pathPattern:</span><br><span class=\"line\">  accessModes: ReadWriteOnce</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">leaderElection:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">rbac:</span><br><span class=\"line\">  create: <span class=\"literal\">true</span></span><br><span class=\"line\">podSecurityPolicy:</span><br><span class=\"line\">  enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">podAnnotations: &#123;&#125;</span><br><span class=\"line\">podSecurityContext: &#123;&#125;</span><br><span class=\"line\">securityContext: &#123;&#125;</span><br><span class=\"line\">serviceAccount:</span><br><span class=\"line\">  create: <span class=\"literal\">true</span></span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  name:</span><br><span class=\"line\">resources: &#123;&#125;</span><br><span class=\"line\">nodeSelector: &#123;&#125;</span><br><span class=\"line\">tolerations: []</span><br><span class=\"line\">affinity: &#123;&#125;</span><br><span class=\"line\">labels: &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定下载解压目录进行chat图表安装</span></span><br><span class=\"line\">$ helm3 install nfs-storage nfs-subdir-external-provisioner/</span><br><span class=\"line\">  NAME: nfs-storage</span><br><span class=\"line\">  LAST DEPLOYED: Mon Jun 20 15:41:50 2022</span><br><span class=\"line\">  NAMESPACE: default</span><br><span class=\"line\">  STATUS: deployed</span><br><span class=\"line\">  REVISION: 1</span><br><span class=\"line\">  TEST SUITE: None</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>方式2.helm3指定仓库</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br><span class=\"line\">$ helm nfs-storage nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> nfs.server=10.20.176.102 \\</span><br><span class=\"line\">  --<span class=\"built_in\">set</span> nfs.path=/app/storage/nfs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新</span></span><br><span class=\"line\">$ helm3 upgrade nfs-storage nfs-subdir-external-provisioner/</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>温馨提示: 由于nfs-subdir-external-provisioner镜像是k8s.gcr.io域名下国内可能无法拉取，此处我已经拉取到阿里云镜像仓库中<code>registry.cn-hangzhou.aliyuncs.com/weiyigeek/nfs-subdir-external-provisioner:v4.0.2</code>，如果你需要自行拉取请参考此篇<a href=\"https://blog.weiyigeek.top/2022/6-1-663.html\">使用Aliyun容器镜像服务对海外镜像仓库中镜像进行拉取构建</a> ()</p>\n<p><br></p>\n<p>步骤 05.查看部署的nfs-storage动态持久卷以及其pod状态<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ helm3 list</span><br><span class=\"line\">  NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                    APP VERSION</span><br><span class=\"line\">  nfs-storage     default         1               2022-06-20 15:41:50.960642233 +0800 CST deployed        nfs-subdir-external-provisioner-4.0.16   4.0.2</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get storageclasses.storage.k8s.io</span><br><span class=\"line\">  NAME          PROVISIONER                                    RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class=\"line\">  nfs-storage   cluster.local/nfs-storage-subdir-provisioner   Delete          Immediate           <span class=\"literal\">true</span>                   17s</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get pod</span><br><span class=\"line\">  NAME                                                           READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">  nfs-storage-nfs-subdir-external-provisioner-77f4d85f74-kljck   1/1     Running   0          33s</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>步骤 06.如想卸载helm3安装的nfs-storage动态卷执行如下命令即可。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ helm3 uninstall nfs-storage</span><br><span class=\"line\">release <span class=\"string\">\"nfs-storage\"</span> uninstalled</span><br></pre></td></tr></table></figure></p>\n<p>至此，基于NFS的provisioner 动态持久卷的安装部署到此结束。</p>\n<p>温馨提示: 如果需要部署多个nfs持久卷, 则我们需要更改values.yaml中如下字段，并使用不同的名称。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># values.yaml</span></span><br><span class=\"line\">nfs:</span><br><span class=\"line\">  server: 10.20.176.102</span><br><span class=\"line\">  path: /app/storage/nfs/pvc/<span class=\"built_in\">local</span></span><br><span class=\"line\">  volumeName: nfs-subdir-external-provisioner-local</span><br><span class=\"line\">  ....</span><br><span class=\"line\">storageClass:</span><br><span class=\"line\">  ....</span><br><span class=\"line\">  provisionerName: cluster.local/nfs-local-subdir-provision  <span class=\"comment\"># 关键点(提供者不能一样)</span></span><br><span class=\"line\">  name: nfs-local</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 例如,此处创建两个nfs动态卷即nfs-local与nfs-dev。</span></span><br><span class=\"line\">helm3 install nfs-local nfs-subdir-external-provisioner/</span><br><span class=\"line\">helm3 install nfs-dev nfs-subdir-external-provisioner-dev/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># helm 部署结果查看</span></span><br><span class=\"line\">helm3 list</span><br><span class=\"line\">  <span class=\"comment\"># NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION</span></span><br><span class=\"line\">  <span class=\"comment\"># nfs-dev         default         1               2022-07-14 11:27:33.997601363 +0800 CST deployed        nfs-subdir-external-provisioner-4.0.16  4.0.2</span></span><br><span class=\"line\">  <span class=\"comment\"># nfs-local       default         1               2022-07-14 11:28:02.49579496 +0800 CST  deployed        nfs-subdir-external-provisioner-4.0.16  4.0.2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># storageclasses 查看</span></span><br><span class=\"line\">kubectl get storageclasses.storage.k8s.io</span><br><span class=\"line\">  <span class=\"comment\"># NAME                PROVISIONER                                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># nfs-dev (default)   cluster.local/nfs-dev-subdir-provisioner     Delete          Immediate           true                   4m36s</span></span><br><span class=\"line\">  <span class=\"comment\"># nfs-local           cluster.local/nfs-local-subdir-provisioner   Delete          Immediate           true                   4m8s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># nfs-subdir-external-provisioner pod 查看</span></span><br><span class=\"line\">kubectl get pod</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                                         READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h      1/1     Running   0          5m4s</span></span><br><span class=\"line\">  <span class=\"comment\"># nfs-local-nfs-subdir-external-provisioner-6f97d44bb8-424tk   1/1     Running   0          4m36s</span></span><br></pre></td></tr></table></figure></p>\n<p>正常情况下显示出的日志信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl logs -f nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h</span><br><span class=\"line\">  <span class=\"comment\"># I0714 03:27:35.390909       1 leaderelection.go:242] attempting to acquire leader lease  default/cluster.local-nfs-dev-subdir-provisioner...</span></span><br><span class=\"line\">  <span class=\"comment\"># I0714 03:27:35.400777       1 leaderelection.go:252] successfully acquired lease default/cluster.local-nfs-dev-subdir-provisioner</span></span><br><span class=\"line\">  <span class=\"comment\"># I0714 03:27:35.400856       1 event.go:278] Event(v1.ObjectReference&#123;Kind:\"Endpoints\", Namespace:\"default\", Name:\"cluster.local-nfs-dev-subdir-provisioner\", UID:\"34019115-d09e-433d-85d6-c254c5492ce5\", APIVersion:\"v1\", ResourceVersion:\"5510886\", FieldPath:\"\"&#125;): type: 'Normal' reason: 'LeaderElection' nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h_b0aaa93a-f7fc-4931-b0cf-e04f42cefd9a became leader</span></span><br><span class=\"line\">  <span class=\"comment\"># I0714 03:27:35.400943       1 controller.go:820] Starting provisioner controller cluster.local/nfs-dev-subdir-provisioner_nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h_b0aaa93a-f7fc-4931-b0cf-e04f42cefd9a!</span></span><br><span class=\"line\">  <span class=\"comment\"># I0714 03:27:35.501130       1 controller.go:869] Started provisioner controller cluster.local/nfs-dev-subdir-provisioner_nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h_b0aaa93a-f7fc-4931-b0cf-e04f42cefd9a!</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n<h3 id=\"2-集群中安装metrics-server获取客户端资源监控指标\"><a href=\"#2-集群中安装metrics-server获取客户端资源监控指标\" class=\"headerlink\" title=\"2.集群中安装metrics-server获取客户端资源监控指标\"></a>2.集群中安装metrics-server获取客户端资源监控指标</h3><p>描述: 通常在集群安装完成后,我们需要对其设置网络、持久卷存储等插件, 除此之外我们还需安装metrics-server以便于获取Node与Pod相关资源消耗等信息，否则你在执行<code>kubectl top</code>命令时会提示<code>error: Metrics API not available</code>, 所以本小节将针对Metrics-server的安装进行讲解。</p>\n<p>项目地址: <a href=\"https://github.com/kubernetes-sigs/metrics-server\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes-sigs/metrics-server</a></p>\n<p><strong>Q: 什么是metrics-server?</strong></p>\n<blockquote>\n<p>Metrics Server 是 Kubernetes 内置自动缩放管道的可扩展、高效的容器资源指标来源。<br>Metrics Server 从 Kubelets 收集资源指标，并通过 Metrics API 在 Kubernetes apiserver 中公开它们，供 Horizontal Pod Autoscaler 和 Vertical Pod Autoscaler 使用。  </p>\n</blockquote>\n<blockquote>\n<p>简单的说: Metrics Server 是集群解析监控数据的聚合器,安装后用户可以通过标准的API（/apis/metrics.k8s.io）来访问监控数据，此处值得注意的是Metrics-Server并非kube-apiserver的一部分,而是通过Aggregator这种插件机制,在独立部署的情况下同kube-apiserver一起统一对外服务的，当进行api请求时kube-aggregator统一接口会分析访问api具体的类型，帮我们负载到具体的api上。</p>\n</blockquote>\n<p>温馨提示: 我们可以通过 <code>kubectl top</code> 命令来访问 Metrics API 获取资源监控相关数据。</p>\n<p>温馨提示: 注意 Metrics API 只可以查询当前度量数据,并不保存历史数据。</p>\n<p><br/></p>\n<p><strong>安装使用</strong></p>\n<p>步骤 01.Metrics Server 可以直接从 YAML 清单安装，也可以通过官方 Helm 图表安装。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 下载 YAML 清单</span></span><br><span class=\"line\">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml</span><br><span class=\"line\">root@devtest-master-212:/opt/init/k8s<span class=\"comment\"># ls</span></span><br><span class=\"line\">  calico.yaml   kubeadm-init-cluster.yaml  kubeadm-init.log  metrics-server.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 提前下载相应的镜像加快部署</span></span><br><span class=\"line\">grep <span class=\"string\">\"image:\"</span> metrics-server.yaml</span><br><span class=\"line\">  <span class=\"comment\"># image: k8s.gcr.io/metrics-server/metrics-server:v0.6.1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 由于其镜像国内无法访问此处我们采用阿里云k8s.gcr.io镜像源</span></span><br><span class=\"line\">sed -i <span class=\"string\">'s#k8s.gcr.io/metrics-server#registry.cn-hangzhou.aliyuncs.com/google_containers#g'</span> metrics-server.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 部署资源清单</span></span><br><span class=\"line\">kubectl apply -f metrics-server.yaml</span><br><span class=\"line\">  <span class=\"comment\"># serviceaccount/metrics-server created</span></span><br><span class=\"line\">  ......</span><br><span class=\"line\">  <span class=\"comment\"># apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 02.不论是在二进制方式或kubeadm方式安装k8s集群, 都在部署 metrics-server 资源清单后 Pod 状态为 0/1 并报出<code>annot validate certificate for 10.10.107.223 because it doesn&#39;t contain any IP SANs</code>错误问题解决。</p>\n<ul>\n<li>错误信息:</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl describe pod -n kube-system metrics-server-6ffc8966f5-cf2qh</span><br><span class=\"line\"><span class=\"comment\"># Warning  Unhealthy  8s (x17 over 2m27s)  kubelet  Readiness probe failed: HTTP probe failed with statuscode: 500</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl logs -f --tail 50 -n kube-system metrics-server-6ffc8966f5-cf2qh</span><br><span class=\"line\"><span class=\"comment\"># E0520 11:13:17.379944       1 scraper.go:140] \"Failed to scrape node\" err=\"Get \\\"https://10.10.107.226:10250/metrics/resource\\\": x509: cannot validate certificate for 10.10.107.226 because it doesn't contain any IP SANs\" node=\"node-1\"</span></span><br><span class=\"line\"><span class=\"comment\"># E0520 11:13:17.382948       1 scraper.go:140] \"Failed to scrape node\" err=\"Get \\\"https://10.10.107.223:10250/metrics/resource\\\": x509: cannot validate certificate for 10.10.107.223 because it doesn't contain any IP SANs\" node=\"master-223\"</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>问题原因: 由于 metrics-server 未获得TLS Bootstrap 签发证书的导致访问各节点资源时报错。</p>\n</li>\n<li><p>解决办法: 启用 TLS BootStrap 证书签发</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.分别在 Master 与 Node 节点中启用TLS BootStrap 证书签发，在 kubelet 的 yaml 配置中追加入如下K/V.</span></span><br><span class=\"line\"><span class=\"comment\"># 方式1.Kubeadm 搭建的集群</span></span><br><span class=\"line\">$ vim /var/lib/kubelet/config.yaml</span><br><span class=\"line\">...</span><br><span class=\"line\">serverTLSBootstrap: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.二进制搭建的集群(注意此路径根据你的kubelet.service进行配置), 此处我们定义的路径为 /etc/kubernetes/cfg/kubelet-config.yaml </span></span><br><span class=\"line\"><span class=\"comment\"># /var/lib/kubelet/config.yaml</span></span><br><span class=\"line\">$ tee -a /etc/kubernetes/cfg/kubelet-config.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">serverTLSBootstrap: <span class=\"literal\">true</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># kubeadm 安装方式可以使用如下</span></span><br><span class=\"line\">tee -a /var/lib/kubelet/config.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">serverTLSBootstrap: <span class=\"literal\">true</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.最后分别重启各个节点kubelet服务即可</span></span><br><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl restart kubelet.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查看节点的证书签发请求</span></span><br><span class=\"line\">kubectl get csr</span><br><span class=\"line\">  <span class=\"comment\"># NAME        AGE   SIGNERNAME                      REQUESTOR                        REQUESTEDDURATION   CONDITION</span></span><br><span class=\"line\">  <span class=\"comment\"># csr-6w6xp   7s    kubernetes.io/kubelet-serving   system:node:devtest-master-212   &lt;none&gt;              Pending</span></span><br><span class=\"line\">  <span class=\"comment\"># csr-bpqzl   5s    kubernetes.io/kubelet-serving   system:node:devtest-master-213   &lt;none&gt;              Pending</span></span><br><span class=\"line\">  <span class=\"comment\"># csr-gtksm   3s    kubernetes.io/kubelet-serving   system:node:devtest-work-215     &lt;none&gt;              Pending</span></span><br><span class=\"line\">  <span class=\"comment\"># csr-vzfs7   4s    kubernetes.io/kubelet-serving   system:node:devtest-master-214   &lt;none&gt;              Pending</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.同意签发所有节点的CSR请求 </span></span><br><span class=\"line\">kubectl certificate approve $(kubectl get csr | grep -v NAME | grep <span class=\"string\">\"Pending\"</span>  | cut -d <span class=\"string\">\" \"</span> -f 1)</span><br><span class=\"line\">  <span class=\"comment\"># certificatesigningrequest.certificates.k8s.io/csr-6w6xp approved</span></span><br><span class=\"line\">  <span class=\"comment\"># certificatesigningrequest.certificates.k8s.io/csr-bpqzl approved</span></span><br><span class=\"line\">  <span class=\"comment\"># certificatesigningrequest.certificates.k8s.io/csr-gtksm approved</span></span><br><span class=\"line\">  <span class=\"comment\"># certificatesigningrequest.certificates.k8s.io/csr-vzfs7 approved</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220622144018.png\" alt=\"WeiyiGeek.证书签发请求\" title=\"\" class=\"\">\n                <p>WeiyiGeek.证书签发请求</p>\n            </figure>\n<p><br/></p>\n<p>步骤 03.Metrics Server 默认是安装在kube-system名称空间下，我们可以查看其deployment、Pod运行以及SVC情况。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.部署清单状态查看</span></span><br><span class=\"line\">kubectl get deploy,pod,svc -n kube-system -l k8s-app=metrics-server</span><br><span class=\"line\">  <span class=\"comment\"># NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># deployment.apps/metrics-server   1/1     1            1           5h37m</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                  READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/metrics-server-6ffc8966f5-c4jvn   1/1     Running   0          14m</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># service/metrics-server   ClusterIP   10.111.197.94   &lt;none&gt;        443/TCP   5h37m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.注册到K8S集群中的 metrics.k8s.io API 查看</span></span><br><span class=\"line\">kubectl get apiservices.apiregistration.k8s.io  | grep <span class=\"string\">\"metrics\"</span></span><br><span class=\"line\">  <span class=\"comment\"># v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        14h</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 04.查看各个节点以及Pod的资源指标（CPU/MEM）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl top node</span><br><span class=\"line\">  <span class=\"comment\"># NAME                 CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-master-212   219m         2%     2793Mi          17%</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-master-213   211m         2%     2417Mi          15%</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-master-214   203m         1%     2467Mi          7%</span></span><br><span class=\"line\">  <span class=\"comment\"># devtest-work-215     90m          1%     1601Mi          10%</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 默认名称空间中Pod的资源信息</span></span><br><span class=\"line\">$ kubectl top pod</span><br><span class=\"line\">  <span class=\"comment\"># NAME    CPU(cores)   MEMORY(bytes)</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx   0m           10Mi</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"3-集群管理原生UI工具kubernetes-dashboard安装部署\"><a href=\"#3-集群管理原生UI工具kubernetes-dashboard安装部署\" class=\"headerlink\" title=\"3.集群管理原生UI工具kubernetes-dashboard安装部署\"></a>3.集群管理原生UI工具kubernetes-dashboard安装部署</h3><p>描述:Kubernetes Dashboard是Kubernetes集群的通用、基于web的UI。它允许用户管理集群中运行的应用程序并对其进行故障排除，以及管理集群本身。</p>\n<p>项目地址: <a href=\"https://github.com/kubernetes/dashboard/\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/dashboard/</a></p>\n<p>步骤 01.从Github中拉取dashboard部署资源清单，当前最新版本v2.6.0 【2022年6月22日 16:46:37】<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载资源清单并部署 dashboard </span></span><br><span class=\"line\">$ wget -L https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml -O dashboard.yaml</span><br><span class=\"line\">$ kubectl apply -f dashboard.yaml</span><br><span class=\"line\">$ grep <span class=\"string\">\"image:\"</span> dashboard.yaml</span><br><span class=\"line\">  <span class=\"comment\"># image: kubernetesui/dashboard:v2.6.0</span></span><br><span class=\"line\">  <span class=\"comment\"># image: kubernetesui/metrics-scraper:v1.0.8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者一条命令搞定部署</span></span><br><span class=\"line\">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml</span><br><span class=\"line\">  <span class=\"comment\"># serviceaccount/kubernetes-dashboard created</span></span><br><span class=\"line\">  ......</span><br><span class=\"line\">  <span class=\"comment\"># deployment.apps/dashboard-metrics-scraper created</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 02.使用kubectl get命令查看部署的dashboard相关资源是否正常。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pod,svc -n kubernetes-dashboard</span><br><span class=\"line\">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">dashboard-metrics-scraper-6f669b9c9b-vfmzp   1/1     Running   0          73m</span><br><span class=\"line\">kubernetes-dashboard-67b9478795-2gwmm        1/1     Running   0          73m</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class=\"line\">service/dashboard-metrics-scraper   ClusterIP   10.106.168.38    &lt;none&gt;        8000/TCP   73m</span><br><span class=\"line\">service/kubernetes-dashboard        ClusterIP   10.106.191.197   &lt;none&gt;        443/TCP    73m</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑 service/kubernetes-dashboard 服务将端口通过nodePort方式进行暴露为30443。</span></span><br><span class=\"line\">$ kubectl edit svc -n kubernetes-dashboard kubernetes-dashboard</span><br><span class=\"line\"><span class=\"comment\"># service/kubernetes-dashboard edited</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">.....</span><br><span class=\"line\">spec:</span><br><span class=\"line\">.....</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 443</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 8443</span><br><span class=\"line\">    nodePort: 31443  <span class=\"comment\"># 新增</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort     <span class=\"comment\"># 修改</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>步骤 03.默认仪表板部署包含运行所需的最小RBAC权限集，而要想使用dashboard操作集群中的资源，通常我们还需要自定义创建kubernetes-dashboard管理员角色。<br>权限控制参考地址: <a href=\"https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建后最小权限的Token(只能操作kubernetes-dashboard名称空间下的资源)</span></span><br><span class=\"line\">kubectl get sa -n kubernetes-dashboard kubernetes-dashboard</span><br><span class=\"line\">kubectl describe secrets -n kubernetes-dashboard kubernetes-dashboard-token-jhdpb | grep <span class=\"string\">'^token:'</span>|awk <span class=\"string\">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure>\n<p>Kubernetes Dashboard 支持几种不同的用户身份验证方式：</p>\n<ul>\n<li>Authorization header</li>\n<li>Bearer Token (默认)</li>\n<li>Username/password</li>\n<li>Kubeconfig file  (默认)</li>\n</ul>\n<p>温馨提示: 此处使用Bearer Token方式, 为了方便演示我们向 Dashboard 的服务帐户授予管理员权限 (Admin privileges), 而在生产环境中通常不建议如此操作, 而是指定一个或者多个名称空间下的资源进行操作。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee rbac-dashboard-admin.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dashboard-admin</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dashboard-admin</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: cluster-admin</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: dashboard-admin</span><br><span class=\"line\">    namespace: kubernetes-dashboard</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f rbac-dashboard-admin.yaml</span><br><span class=\"line\">  <span class=\"comment\"># serviceaccount/dashboard-admin created</span></span><br><span class=\"line\">  <span class=\"comment\"># clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者 两条命令搞定</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl create serviceaccount -n devtest devtest-ns-admin</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl create clusterrolebinding devtest-ns-admin --clusterrole=admin --serviceaccount=devtest:devtest-ns-admin</span></span><br></pre></td></tr></table></figure>\n<p>步骤 04.获取 sa 创建的 dashboard-admin 用户的 secrets 名称并获取认证 token ，用于上述搭建的dashboard 认证使用。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get sa -n kubernetes-dashboard dashboard-admin -o yaml | grep <span class=\"string\">\"\\- name\"</span> | awk <span class=\"string\">'&#123;print $3&#125;'</span></span><br><span class=\"line\">  <span class=\"comment\"># dashboard-admin-token-crh7v</span></span><br><span class=\"line\">kubectl describe secrets -n kubernetes-dashboard dashboard-admin-token-crh7v | grep <span class=\"string\">\"^token:\"</span> | awk <span class=\"string\">'&#123;print $2&#125;'</span></span><br><span class=\"line\">  <span class=\"comment\">#  获取到认证Token</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 05.利用上述 Token 进行登陆Kubernetes-dashboard的UI,其地址为node节点加上31443,例如此处<code>https://10.20.176.212:31443/#/workloads?namespace=default</code>。</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220622165638.png\" alt=\"WeiyiGeek.Kubernetes-dashboard\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Kubernetes-dashboard</p>\n            </figure>\n<hr>\n<h3 id=\"4-集群管理K9S客户端工具安装使用\"><a href=\"#4-集群管理K9S客户端工具安装使用\" class=\"headerlink\" title=\"4.集群管理K9S客户端工具安装使用\"></a>4.集群管理K9S客户端工具安装使用</h3><p>描述: k9s 是用于管理 Kubernetes 集群的 CLI, K9s 提供了一个终端 UI 来与您的 Kubernetes 集群进行交互。通过封装 kubectl 功能 k9s 持续监视 Kubernetes 的变化并提供后续命令来与您观察到的资源进行交互，直白的说就是k9s可以让开发者快速查看并解决运行 Kubernetes 时的日常问题。<br>官网地址: <a href=\"https://k9scli.io/\" target=\"_blank\" rel=\"noopener\">https://k9scli.io/</a><br>参考地址: <a href=\"https://github.com/derailed/k9s\" target=\"_blank\" rel=\"noopener\">https://github.com/derailed/k9s</a></p>\n<p>此处,以安装二进制包为例进行实践。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1. 利用 wget 命令 -c 短点续传和 -b 后台下载</span></span><br><span class=\"line\">wget -b -c https://github.com/derailed/k9s/releases/download/v0.25.18/k9s_Linux_x86_64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.解压并删除多余文件</span></span><br><span class=\"line\">tar -zxf k9s_linux_x86_64.tar.gz</span><br><span class=\"line\">rm  k9s_linux_x86_64.tar.gz  LICENSE  README.md</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.拷贝 kubernetes 控制配置文件到加目录中</span></span><br><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"><span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.直接运行即可，如果你对vim操作比较熟悉，那么恭喜你了你很快能上手k9s.</span></span><br><span class=\"line\">/stroage/nfs<span class=\"comment\"># ./k9s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.退出k9s指令</span></span><br><span class=\"line\">:quit</span><br></pre></td></tr></table></figure></p>\n<p>更多使用技巧请参考: [K9s之K8s集群管理工具实践尝试] (<a href=\"https://blog.weiyigeek.top/2022/1-1-582.html\">https://blog.weiyigeek.top/2022/1-1-582.html</a>)</p>\n<hr>\n<h3 id=\"5-集群服务Service七层负载均衡ingress环境搭建部署\"><a href=\"#5-集群服务Service七层负载均衡ingress环境搭建部署\" class=\"headerlink\" title=\"5.集群服务Service七层负载均衡ingress环境搭建部署\"></a>5.集群服务Service七层负载均衡ingress环境搭建部署</h3><p><strong>Q: 什么是Ingress?</strong><br>A: Ingress 是管理对集群中服务的提供外部访问的 API 对象,Ingress 控制器负责实现 Ingress，通常使用负载均衡器，但它也可以配置边缘路由器或其他前端来帮助处理流量，它可以将来自集群外部的 HTTP 和 HTTPS 路由转发到集群内部的 Service 中。</p>\n<p>Ingress 只是一个统称，其由 Ingress 和 Ingress Controller 两部分组成。</p>\n<ul>\n<li>Ingress 用作将原来需要手动配置的规则抽象成一个 Ingress 对象，使用 YAML 格式的文件来创建和管理。</li>\n<li>Ingress Controller 用作通过与 Kubernetes API 交互，动态的去感知集群中 Ingress 规则变化。</li>\n</ul>\n<p>使用 Ingress 控制器可以轻松实现外部URL访问集群内部服务、负载均衡、代理转发、支持配置SSL/TLS并提供基于名称的虚拟主机，值得注意的是 Ingress 不会暴露任意端口或协议，通过使用 <code>Service.Type=NodePort</code> 或 <code>Service.Type=LoadBalancer</code>类型的服务向向 Internet 公开 HTTP 和 HTTPS 的访问服务</p>\n<p><strong>Q: 常用 Ingress 控制器有那些?</strong><br>其中ingress controller目前主要有两种基于nginx服务的ingress controller (四层或者七层)和基于traefik的ingress controller(目前支持http和https协议)，其它更多适用于Kubernetes的ingress控制器可以参考地址[<a href=\"https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/#%E5%85%B6%E4%BB%96%E6%8E%A7%E5%88%B6%E5%99%A8]\" target=\"_blank\" rel=\"noopener\">https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/#%E5%85%B6%E4%BB%96%E6%8E%A7%E5%88%B6%E5%99%A8]</a></p>\n<ul>\n<li>ingress-Nginx : 用于 <a href=\"https://github.com/kubernetes/ingress-nginx\" target=\"_blank\" rel=\"noopener\">Nginx Kubernetes Ingress</a> 控制器能够与 NGINX Web 服务器（作为代理）一起使用 (推荐)</li>\n<li>ingress-Traefik ：由 <a href=\"https://doc.traefik.io/traefik/providers/kubernetes-ingress/\" target=\"_blank\" rel=\"noopener\">Traefik Kubernetes Ingress</a> 提供程序是一个用于 Traefik 代理的Ingress控制器。</li>\n<li>ingress-istio : <a href=\"https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/\" target=\"_blank\" rel=\"noopener\">Istio Ingress</a> 是一个基于Istio的Ingress控制器。</li>\n</ul>\n<p>温馨提示: 理想情况下所有 Ingress 控制器都应符合参考规范。实际上各种 Ingress 控制器的操作略有不同,请参考相应Ingress的控制器官方文档。</p>\n<p>如下图所示的一个简单的示例，客户端请求访问外部URL地址, Ingress 将其所有流量发送到一个Service中, 后端 Pod 提供服务端响应通过路由进行返回给客户端。</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/1/20220309090428.png\" alt=\"WeiyiGeek.Ingress\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Ingress</p>\n            </figure>\n<p>温馨提示: 基于nginx服务的ingress controller根据不同的开发公司，又分为k8s社区的ingres-nginx和nginx公司的nginx-ingress，在此根据github上的活跃度和关注人数，我们选择的是k8s社区的ingres-nginx。</p>\n<ul>\n<li>k8s社区提供的ingress，github地址如下：<a href=\"https://github.com/kubernetes/ingress-nginx\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/ingress-nginx</a></li>\n<li>nginx社区提供的ingress，github地址如下：<a href=\"https://github.com/nginxinc/kubernetes-ingress\" target=\"_blank\" rel=\"noopener\">https://github.com/nginxinc/kubernetes-ingress</a></li>\n</ul>\n<p><br></p>\n<p><strong>Q: K8S社区提供 Ingress 规则有哪些?</strong></p>\n<ul>\n<li>host : 虚拟主机名称, 主机名通配符主机可以是精确匹配（例如”foo.bar.com”）或通配符（例如“ *.foo.com”）</li>\n<li>paths : URL访问路径。</li>\n<li>pathType : Ingress 中的每个路径都需要有对应的路径类型（Path Type）</li>\n<li>backend : 是 Service 文档中所述的服务和端口名称的组合与规则的 host 和 path 匹配的对 Ingress 的 HTTP（和 HTTPS ）请求将发送到列出的 backend, 一般情况可以单独为路径设置Backend以及未匹配的url默认访问的后端defaultBackend。</li>\n</ul>\n<p>Ingress 中的每个路径都需要有对应的路径类型（Path Type），未明确设置 pathType 的路径无法通过合法性检查，当前支持的路径类型有三种：</p>\n<ul>\n<li>Exact：精确匹配 URL 路径，且区分大小写。</li>\n<li>Prefix：基于以<code>/</code>分隔的URL路径前缀匹配, 且区分大小写，并且对路径中的元素逐个完成。</li>\n<li>ImplementationSpecific：此路径类型匹配方法取决于 IngressClass, 具体实现可以将其作为单独的 pathType 处理或者与 Prefix 、 Exact 类型作相同处理。</li>\n</ul>\n<p>说明： 如果路径的最后一个元素是请求路径中最后一个元素的子字符串，则不会匹配 （例如：/foo/bar 匹配 /foo/bar/baz, 但不匹配 /foo/barbaz）。</p>\n<p>温馨提示: defaultBackend 通常在 Ingress 控制器中配置，以服务与规范中的路径不匹配的任何请求。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">&gt; test.yaml &lt;&lt; 'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">test-ingress</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  defaultBackend:</span></span><br><span class=\"line\"><span class=\"attr\">    service:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span></span><br><span class=\"line\"><span class=\"attr\">        number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"bullet\">-f</span></span><br></pre></td></tr></table></figure><br>注意, 入口控制器和负载平衡器可能需要一两分钟才能分配 IP 地址。 在此之前，你通常会看到地址字段的值被设定为<code>&lt;pending&gt;</code>。</p>\n<p>温馨提示: ingress控制器资源清单在v1.19以及之后版本集群中写法如下<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;-EOF | kubectl apply -f -</span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: foo.bar.com</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    <span class=\"comment\">#URL重定向。</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/rewrite-target: /<span class=\"variable\">$1</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - host: foo.bar.com</span><br><span class=\"line\">    http:</span><br><span class=\"line\">      paths:</span><br><span class=\"line\">    <span class=\"comment\"># 在Ingress Controller的版本≥0.22.0之后，path中需要使用正则表达式定义路径，并在rewrite-target中结合捕获组一起使用。</span></span><br><span class=\"line\">      - path: /svc(/|$)(.*)</span><br><span class=\"line\">        backend:</span><br><span class=\"line\">          service: </span><br><span class=\"line\">            name: web1-service</span><br><span class=\"line\">            port: </span><br><span class=\"line\">              number: 80</span><br><span class=\"line\">        pathType: ImplementationSpecific</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>Q: Nginx Ingress Controller与K8S集群版本对应关系</strong><br>参考地址: <a href=\"https://github.com/kubernetes/ingress-nginx#support-versions-table\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/ingress-nginx#support-versions-table</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Support Versions table</span><br><span class=\"line\">Ingress-NGINX version \tk8s supported version \tAlpine Version \tNginx Version</span><br><span class=\"line\">v1.2.1 \t1.23, 1.22, 1.21, 1.20, 1.19 \t3.14.6 \t1.19.10†</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>快速安装配置</strong><br>环境依赖说明: <code>Chart version 4.x.x and above: Kubernetes v1.19+</code></p>\n<p>步骤 01.如果您有 Helm，则可以使用以下命令部署入口控制器：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm3 repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class=\"line\">helm3 repo update</span><br><span class=\"line\">helm3 search repo ingress-nginx -l</span><br><span class=\"line\">  <span class=\"comment\"># NAME                            CHART VERSION   APP VERSION     DESCRIPTION</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx/ingress-nginx     4.1.4           1.2.1           Ingress controller for Kubernetes using NGINX a...</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx/ingress-nginx     4.1.3           1.2.1           Ingress controller for Kubernetes using NGINX a...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ingress-nginx Chart 模板参数配置</span></span><br><span class=\"line\">helm3 show values --version 4.1.4 ingress-nginx/ingress-nginx &gt; values.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  values.yaml 配置修改完毕后安装 ingress-nginx</span></span><br><span class=\"line\">helm3 install ingress-nginx -f values.yaml --version 4.1.4 ingress-nginx/ingress-nginx  --namespace ingress-nginx --create-namespace --debug</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>温馨提示: 上面在不需进行可用参数配置时可采用一条命令搞定(注意提前拉取相关镜像)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm3 upgrade --install ingress-nginx ingress-nginx \\</span><br><span class=\"line\">  --repo https://kubernetes.github.io/ingress-nginx \\</span><br><span class=\"line\">  --namespace ingress-nginx --create-namespace</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 使用如下更新helm图表部署的应用以更新修改为国内镜像源。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ crictl pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.2.1</span><br><span class=\"line\">$ crictl pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1</span><br><span class=\"line\"></span><br><span class=\"line\">helm3 upgrade ingress-nginx --namespace ingress-nginx --version 4.1.4 -f values.yaml ingress-nginx/ingress-nginx --debug</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 02.查看ingress-nginx的部署情况，一些 pod 应该在 ingress-nginx 命名空间中启动：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm3 list -n ingress-nginx</span><br><span class=\"line\">  <span class=\"comment\"># NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                  APP VERSION</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx   ingress-nginx   1               2022-06-24 13:12:36.692931823 +0800 CST deployed        ingress-nginx-4.1.4    1.2.1</span></span><br><span class=\"line\">helm3 <span class=\"built_in\">history</span> ingress-nginx  -n ingress-nginx</span><br><span class=\"line\">  <span class=\"comment\"># REVISION        UPDATED                         STATUS          CHART                   APP VERSION     DESCRIPTION</span></span><br><span class=\"line\">  <span class=\"comment\"># 1               Fri Jun 24 13:20:49 2022        deployed        ingress-nginx-4.1.4     1.2.1           Install complete</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 等待 Pod 应用部署为正常</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">wait</span> --namespace ingress-nginx \\</span><br><span class=\"line\">  --<span class=\"keyword\">for</span>=condition=ready pod \\</span><br><span class=\"line\">  --selector=app.kubernetes.io/component=controller \\</span><br><span class=\"line\">  --timeout=120s</span><br><span class=\"line\">  <span class=\"comment\"># pod/ingress-nginx-controller-7cfd586878-fkdb5 condition met</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 ingress-nginx 的 Pod 与 SVC </span></span><br><span class=\"line\">kubectl get pod,svc -n ingress-nginx</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                               READY   STATUS      RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/ingress-ingress-nginx-admission-create-pjm6x   0/1     Completed   0          7m47s</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/ingress-nginx-controller-7cfd586878-fkdb5      1/1     Running     0          18m</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># service/ingress-nginx-controller             NodePort    10.107.81.40     &lt;none&gt;        80:30080/TCP,443:30443/TCP   18m</span></span><br><span class=\"line\">  <span class=\"comment\"># service/ingress-nginx-controller-admission   ClusterIP   10.106.154.244   &lt;none&gt;        443/TCP                      18m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 ingress 的 ingressclasses 名称后续才能使用。</span></span><br><span class=\"line\">kubectl get ingressclasses.networking.k8s.io</span><br><span class=\"line\">  NAME    CONTROLLER             PARAMETERS   AGE</span><br><span class=\"line\">  nginx   k8s.io/ingress-nginx   &lt;none&gt;       19m</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 03.针对搭建的 ingress-nginx 服务验证, 此处访问应该是NGINX标准404错误页面,因为</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Get the application URL by running these commands:</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HTTP_NODE_PORT=30080</span><br><span class=\"line\"><span class=\"built_in\">export</span> HTTPS_NODE_PORT=30443</span><br><span class=\"line\"><span class=\"built_in\">export</span> NODE_IP=$(kubectl --namespace ingress-nginx get nodes -o jsonpath=<span class=\"string\">\"&#123;.items[0].status.addresses[1].address&#125;\"</span>)</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"Visit http://<span class=\"variable\">$NODE_IP</span>:<span class=\"variable\">$HTTP_NODE_PORT</span> to access your application via HTTP.\"</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"Visit https://<span class=\"variable\">$NODE_IP</span>:<span class=\"variable\">$HTTPS_NODE_PORT</span> to access your application via HTTPS.\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 尝试访问 ingress - nginx</span></span><br><span class=\"line\">$ curl -I --insecure http://devtest-master-212:30080</span><br><span class=\"line\">$ curl -I --insecure https://devtest-master-212:30443</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/2 404</span></span><br><span class=\"line\">  <span class=\"comment\"># date: Fri, 24 Jun 2022 07:07:12 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># content-type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># content-length: 146</span></span><br><span class=\"line\">  <span class=\"comment\"># strict-transport-security: max-age=15724800; includeSubDomains</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 04.优化ingress Pod内核参数以及扩容Pod到每个节点之上, 更多优化可以参考 [<a href=\"https://blog.weiyigeek.top/2020/5-28-588.html#0x07-Kubernetes%E4%B8%ADingress-nginx%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE]\">https://blog.weiyigeek.top/2020/5-28-588.html#0x07-Kubernetes%E4%B8%ADingress-nginx%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE]</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 编辑 ingress-nginx-controller资源清单添加一个 initContainers 进行内核参数初始化</span></span><br><span class=\"line\">$ kubectl edit deployments.apps -n ingress-nginx ingress-nginx-controller</span><br><span class=\"line\">....</span><br><span class=\"line\">  initContainers:</span><br><span class=\"line\">  - <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - sh</span><br><span class=\"line\">    - -c</span><br><span class=\"line\">    - |</span><br><span class=\"line\">      mount -o remount rw /proc/sys</span><br><span class=\"line\">      sysctl -w net.core.somaxconn=65535</span><br><span class=\"line\">      sysctl -w net.ipv4.tcp_tw_reuse=1</span><br><span class=\"line\">      sysctl -w net.ipv4.ip_local_port_range=<span class=\"string\">\"1024 65535\"</span></span><br><span class=\"line\">      sysctl -w fs.file-max=1048576</span><br><span class=\"line\">      sysctl -w fs.inotify.max_user_instances=16384</span><br><span class=\"line\">      sysctl -w fs.inotify.max_user_watches=524288</span><br><span class=\"line\">      sysctl -w fs.inotify.max_queued_events=16384</span><br><span class=\"line\">    image: alpine:3.10</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    name: sysctl</span><br><span class=\"line\">    resources: &#123;&#125;</span><br><span class=\"line\">    securityContext:</span><br><span class=\"line\">      privileged: <span class=\"literal\">true</span></span><br><span class=\"line\">    terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">    terminationMessagePolicy: File</span><br><span class=\"line\">....</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 扩容 ingress-nginx-controller 副本为节点数量 (注意此处已去除master节点污点)</span></span><br><span class=\"line\">kubectl scale deployment --replicas=4 -n ingress-nginx ingress-nginx-controller</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 ingress-controller 的Pod</span></span><br><span class=\"line\">kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o wide</span><br><span class=\"line\">  NAME                                        READY   STATUS    RESTARTS   AGE     IP              NODE                 NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">  ingress-nginx-controller-7f8cd9c4fc-6lqgw   1/1     Running   0          5m33s   10.66.55.65     devtest-master-213   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">  ingress-nginx-controller-7f8cd9c4fc-8svfj   1/1     Running   0          3m16s   10.66.53.79     devtest-work-215     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">  ingress-nginx-controller-7f8cd9c4fc-g75fz   1/1     Running   0          6m40s   10.66.237.129   devtest-master-212   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">  ingress-nginx-controller-7f8cd9c4fc-jl5qg   1/1     Running   0          5m33s   10.66.35.67     devtest-master-214   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220624150133.png\" alt=\"WeiyiGeek.ingress-initContainers\" title=\"\" class=\"\">\n                <p>WeiyiGeek.ingress-initContainers</p>\n            </figure>\n<p><br/></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"k8s","path":"api/tags/k8s.json"}]}