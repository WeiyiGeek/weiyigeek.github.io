<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 3-Kubernetes入门之Ubuntu安装部署集群|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="k8s">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                学习之路
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>3-Kubernetes入门之Ubuntu安装部署集群</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">3-Kubernetes入门之Ubuntu安装部署集群</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-04-27T10:37:47.000Z" itemprop="datePublished" class="page-time">
  2020-04-27
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-虚拟云容/云容器/Kubernetes/3-Kubernetes入门之Ubuntu安装部署集群"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">3-Kubernetes入门之Ubuntu安装部署集群</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-04-27 18:37:47" datetime="2020-04-27T10:37:47.000Z"  itemprop="datePublished">2020-04-27</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[toc]</p>
<h2 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h2><p>描述: 为了更好的学习kubernetes以及对照其在不同操作系统之下使用的性能以及差异进行学习扩容，下面将使用Ubuntu进行K8s集群的安装；</p>
<p>说明: 在上一章之中我们采用 <code>CentOS7 + KUbernetes 1.18.x</code>版本进行了安装演示，本章将使用<code>Ubuntu 20.04 + Kubernetes 1.19.x版本 + IPVS + Ansible</code>等组合工具进行安装演示;</p>
<p>PS : 虽然K8s 1.20版本宣布将在1.24版本之后将不再维护dockershim，意味着K8s将不直接支持Docker，不过大家不必过于担心。</p>
<ul>
<li>一是在1.24版本之前我们仍然可以使用Docker，</li>
<li>二是dockershim肯定会有人接盘，我们同样可以使用Docker，当前【2022年4月18日 09:46:03】现已可以使用containerd替代ockershim</li>
<li>三是docker制作的镜像仍然可以在其他Runtime环境中使用，所以大家不必过于恐慌。</li>
</ul>
<p>Tips : 经过测试发现本文方法在 docker(19.03.15 - 19.x) 以及 kubernetes(v1.19.10) 构建集群是没有任何问题的。</p>
<hr>
<h2 id="0x01-基础环境准备"><a href="#0x01-基础环境准备" class="headerlink" title="0x01 基础环境准备"></a>0x01 基础环境准备</h2><p>描述: 有了<code>2-Kubernetes入门之CentOS安装部署集群.md</code>的基础进行对照在Ubuntu下安装K8s的不同</p>
<h3 id="1-环境说明"><a href="#1-环境说明" class="headerlink" title="1.环境说明"></a>1.环境说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此处是在VMware进行实际的</span></span><br><span class="line">Ubuntu 20.04 TLS =&gt; 5.4.0-56-generic <span class="comment"># 多台 Ubuntu 20.04 TLS 物理机或者虚拟机(安装流程请自行百度)此处已做基础安全加固(脚本参考)</span></span><br><span class="line">kubernetes 1.19.6</span><br><span class="line">  - kubectl 1.19.6</span><br><span class="line">  - kubeadm 1.19.6</span><br><span class="line">  - kubelet 1.19.6</span><br><span class="line">Docker: 19.03.14</span><br><span class="line"><span class="comment"># Master 节点中一台机器安装</span></span><br><span class="line">Ansible 2.9.6 </span><br><span class="line"><span class="comment"># 假设您所有节点都以做安全加固(SSH端口修改为20211)</span></span><br></pre></td></tr></table></figure>
<p>主机说明:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master</span></span><br><span class="line">weiyigek-107 </span><br><span class="line">weiyigek-108</span><br><span class="line">weiyigek-109</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker</span></span><br><span class="line">weiyigek-223</span><br><span class="line">weiyigek-224</span><br><span class="line">weiyigek-225</span><br><span class="line">weiyigek-226</span><br></pre></td></tr></table></figure></p>
<p>K8s 安装环境基础要求:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 每台机器 2 GB 或更多的 RAM (如果少于这个数字将会影响您应用的运行内存)</span><br><span class="line">* 每台机器 2 CPU 核或更多</span><br><span class="line">* 集群中的所有机器的网络彼此均能相互连接(公网和内网都可以)</span><br><span class="line">* 保证机器主机名/网卡UUID和IP地址以及Mac地址唯一</span><br></pre></td></tr></table></figure></p>
<p>PS : 注意Master与Node在一致的情况下进行下列安装(我们已做过安全加固)可能安装过程中，读者实践部署的时候有一定的出入(一般是依赖的软件未安装);</p>
<p><br></p>
<h3 id="2-环境操作"><a href="#2-环境操作" class="headerlink" title="2.环境操作"></a>2.环境操作</h3><p>Tips 注意: 所有主机都需要按照以下操作流程</p>
<ul>
<li><p>Step 1.各Master与工作节点的机器名称及其设置;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># *- IP 地址修改 -* &amp; *- 主机 名称修改 -*</span></span><br><span class="line">mkdir ~/init/</span><br><span class="line">tee ~/init/network.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">CURRENT_IP=$(hostname -I | cut -f 1 -d <span class="string">" "</span>)</span><br><span class="line">GATEWAY=$(hostname -I | cut -f 1,2,3 -d <span class="string">"."</span>)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> -lt 3 ]];<span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> IP Gateway Hostname"</span></span><br><span class="line">  <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"IP:<span class="variable">$&#123;1&#125;</span> # GATEWAY:<span class="variable">$&#123;2&#125;</span> # HOSTNAME:<span class="variable">$&#123;3&#125;</span>"</span></span><br><span class="line">sudo sed -i <span class="string">"s#<span class="variable">$&#123;CURRENT_IP&#125;</span>#<span class="variable">$&#123;1&#125;</span>#g"</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">sudo sed -i <span class="string">"s#<span class="variable">$&#123;GATEWAY&#125;</span>.1#<span class="variable">$&#123;2&#125;</span>#g"</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">sudo hostnamectl <span class="built_in">set</span>-hostname <span class="variable">$&#123;3&#125;</span> </span><br><span class="line">sudo netplan apply</span><br><span class="line">EOF</span><br><span class="line">chmod +x ~/init/network.sh </span><br><span class="line">sudo ~/init/network.sh 192.168.1.107 192.168.1.1 weiyigeek-107</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.安装依赖软件以及关闭停用不需要使用的软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 卸载系统中自带的 snapd 软件 </span></span><br><span class="line"><span class="comment"># sudo systemctl stop snapd snapd.socket </span></span><br><span class="line"><span class="comment"># sudo apt autoremove --purge -y snapd </span></span><br><span class="line"><span class="comment"># sudo apt install -y linux-modules-extra-5.4.0-52-generic linux-headers-5.4.0-52</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 关闭自启和停止不用的软件  (Ubuntu server 20.04 最小安装不存在)</span></span><br><span class="line"><span class="comment"># sudo systemctl stop postfix</span></span><br><span class="line"><span class="comment"># sudo systemctl disable postfix</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 3.各Master与工作节点的机器系统时间的同步与时区设置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置系统时区为中国/上海</span></span><br><span class="line">sudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai</span><br><span class="line">sudo bash -c <span class="string">"echo 'Asia/Shanghai' &gt; /etc/timezone"</span></span><br><span class="line">sudo ntpdate ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将当前的 UTC 时间写入硬件时钟</span></span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-local-rtc 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启依赖于系统时间的服务</span></span><br><span class="line">sudo systemctl restart rsyslog.service cron.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统时间</span></span><br><span class="line">date -R</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 4.虚拟内存swap分区关闭<br>Q: 什么安装K8s需要关闭SWAP虚拟内存?<blockquote>
<p>答: 由于Kubeadm在进行K8s安装init初始化时候会检测系统中是否存在swap如果存在会在安装时候有一个警告，尽管您可以利用ingore来忽略它但是确实对性能有一定的影响；<br>例如有可能我们创建的Pod运行在虚拟内存上面与运行在物理内存中Pod不管是RW效率都比较低;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a &amp;&amp; sudo sed -i <span class="string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab &amp;&amp; free  <span class="comment"># CentOS</span></span><br><span class="line">sudo swapoff -a &amp;&amp; sudo sed -i <span class="string">'s/^\/swap.img\(.*\)$/#\/swap.img \1/g'</span> /etc/fstab &amp;&amp; free  <span class="comment">#Ubuntu</span></span><br><span class="line"><span class="comment"># 不同点: Ubuntu 没有 CentOS 中的 selinux 所以无需关闭</span></span><br><span class="line"><span class="comment"># setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config </span></span><br><span class="line"><span class="comment"># root@weiyigeek-107:~# free</span></span><br><span class="line"><span class="comment">#               total        used        free      shared  buff/cache   available</span></span><br><span class="line"><span class="comment"># Mem:        8151900      223192     7684708         880      244000     7674408</span></span><br><span class="line"><span class="comment"># Swap:       4194300           0     4194300</span></span><br><span class="line"><span class="comment"># root@weiyigeek-107:~# swapoff -a &amp;&amp; sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span></span><br><span class="line"><span class="comment"># root@weiyigeek-107:~# free</span></span><br><span class="line"><span class="comment">#               total        used        free      shared  buff/cache   available</span></span><br><span class="line"><span class="comment"># Mem:        8151900      223312     7684356         880      244232     7674256</span></span><br><span class="line"><span class="comment"># Swap:             0           0           0</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 5.为了能在 kube-proxy 开启并使用 ipvs 我们需要加载以下模块(所有节点执行);<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 安装 ipvs 以及 负载均衡相关依赖</span></span><br><span class="line">sudo apt -y install ipvsadm ipset sysstat conntrack </span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) ipvs 内核模块手动加载（所有节点配置）</span></span><br><span class="line">mkdir ~/k8s-init/</span><br><span class="line">tee ~/k8s-init/ipvs.modules &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_lc</span><br><span class="line">modprobe -- ip_vs_lblc</span><br><span class="line">modprobe -- ip_vs_lblcr</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- ip_vs_dh</span><br><span class="line">modprobe -- ip_vs_fo</span><br><span class="line">modprobe -- ip_vs_nq</span><br><span class="line">modprobe -- ip_vs_sed</span><br><span class="line">modprobe -- ip_vs_ftp</span><br><span class="line">modprobe -- ip_tables</span><br><span class="line">modprobe -- ip_set</span><br><span class="line">modprobe -- ipt_set</span><br><span class="line">modprobe -- ipt_rpfilter</span><br><span class="line">modprobe -- ipt_REJECT</span><br><span class="line">modprobe -- ipip</span><br><span class="line">modprobe -- xt_set</span><br><span class="line">modprobe -- br_netfilter</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 加载内核配置（临时|永久）注意管理员执行</span></span><br><span class="line">chmod 755 ~/k8s-init/ipvs.modules &amp;&amp; sudo bash ~/k8s-init/ipvs.modules</span><br><span class="line">sudo cp ~/k8s-init/ipvs.modules /etc/profile.d/ipvs.modules.sh</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line"><span class="comment"># ip_vs_ftp              16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_sed              16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_nq               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_fo               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_dh               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_sh               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_wrr              16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_rr               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_lblcr            16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_lblc             16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_lc               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs                 155648  22 ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp</span></span><br><span class="line"><span class="comment"># nf_nat                 40960  3 iptable_nat,xt_MASQUERADE,ip_vs_ftp</span></span><br><span class="line"><span class="comment"># nf_conntrack          139264  5 xt_conntrack,nf_nat,nf_conntrack_netlink,xt_MASQUERADE,ip_vs</span></span><br><span class="line"><span class="comment"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span></span><br><span class="line"><span class="comment"># libcrc32c              16384  5 nf_conntrack,nf_nat,btrfs,raid456,ip_vs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 下面的方式 Ubuntu 不能正确执行）</span></span><br><span class="line"><span class="comment"># ls /etc/modules-load.d/</span></span><br><span class="line"><span class="comment"># sudo systemctl enable --now systemd-modules-load.service</span></span><br><span class="line"></span><br><span class="line">PS : kube-proxy 是开启使用IPVS的前提条件必须正常安装;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 6.集群各主机节点内核Kernel参数的调整( Kubernetes 安装前的必须进行该内核参数优化&amp;配置)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.Kernel 参数调整</span></span><br><span class="line">mkdir ~/k8s-init/</span><br><span class="line">cat &gt; ~/k8s-init/kubernetes-sysctl.conf &lt;&lt;EOF</span><br><span class="line"><span class="comment"># iptables 网桥模式开启</span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用 ipv6 协议</span></span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用ipv4转发</span></span><br><span class="line">net.ipv4.ip_forward=1 </span><br><span class="line"><span class="comment"># net.ipv4.tcp_tw_recycle=0 #Ubuntu 没有参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span></span><br><span class="line">vm.swappiness=0</span><br><span class="line"><span class="comment"># 不检查物理内存是否够用</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line"><span class="comment"># 不启 OOM</span></span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件系统通知数(根据内存大小和空间大小配置)</span></span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件件打开句柄数</span></span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcp keepalive 相关参数配置</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line"><span class="comment"># net.ipv4.ip_conntrack_max = 65536 # Ubuntu 没有参数</span></span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">EOF</span><br><span class="line">sudo cp ~/k8s-init/kubernetes-sysctl.conf  /etc/sysctl.d/99-kubernetes.conf</span><br><span class="line">sudo sysctl -p /etc/sysctl.d/99-kubernetes.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.nftables 模式切换</span></span><br><span class="line"><span class="comment"># 在 Linux 中 nftables 当前可以作为内核 iptables 子系统的替代品,该工具可以充当兼容性层其行为类似于 iptables 但实际上是在配置 nftables。</span></span><br><span class="line">$ apt list | grep <span class="string">"nftables/focal"</span></span><br><span class="line"><span class="comment"># nftables/focal 0.9.3-2 amd64</span></span><br><span class="line"><span class="comment"># python3-nftables/focal 0.9.3-2 amd64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables 旧模式切换 (nftables 后端与当前的 kubeadm 软件包不兼容, 它会导致重复防火墙规则并破坏 kube-proxy, 所则需要把 iptables 工具切换到“旧版”模式来避免这些问题)</span></span><br><span class="line">sudo update-alternatives --<span class="built_in">set</span> iptables /usr/sbin/iptables-legacy</span><br><span class="line">sudo update-alternatives --<span class="built_in">set</span> ip6tables /usr/sbin/ip6tables-legacy</span><br><span class="line"><span class="comment"># sudo update-alternatives --set arptables /usr/sbin/arptables-legacy  # PS: # Ubuntu 20.04 TLS 无该模块</span></span><br><span class="line"><span class="comment"># sudo update-alternatives --set ebtables /usr/sbin/ebtables-legacy    # PS: # Ubuntu 20.04 TLS 无该模块</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 7.主机名称设置与hosts文件添加<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机名称 以及 其他节点node主机绑定</span></span><br><span class="line"><span class="comment"># hostnamectl set-hostname weiyigeek-107</span></span><br><span class="line">sudo tee -a /etc/hosts &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># dev &amp; test  - master</span></span><br><span class="line">192.168.1.107 weiyigeek-107</span><br><span class="line">192.168.1.108 weiyigeek-108</span><br><span class="line">192.168.1.109 weiyigeek-109</span><br><span class="line"></span><br><span class="line"><span class="comment"># dev &amp; test  - work</span></span><br><span class="line">192.168.1.223 weiyigeek-223</span><br><span class="line">192.168.1.224 weiyigeek-224</span><br><span class="line">192.168.1.225 weiyigeek-225</span><br><span class="line">192.168.1.226 weiyigeek-226</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes-vip (如果不是高可用集群，该IP为Master01的IP)</span></span><br><span class="line">192.168.1.110 weiyigeek-lb-vip.k8s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 8.设置 rsyslogd 和 systemd journald 记录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -pv /var/<span class="built_in">log</span>/journal/ /etc/systemd/journald.conf.d/</span><br><span class="line">sudo tee /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Journal]</span><br><span class="line"><span class="comment"># 持久化保存到磁盘</span></span><br><span class="line">Storage=persistent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩历史日志</span></span><br><span class="line">Compress=yes</span><br><span class="line"></span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最大占用空间 10G</span></span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单日志文件最大 100M</span></span><br><span class="line">SystemMaxFileSize=100M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志保存时间 2 周</span></span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不将日志转发到syslog</span></span><br><span class="line">ForwardToSyslog=no</span><br><span class="line">EOF</span><br><span class="line">cp /etc/systemd/journald.conf.d/99-prophet.conf ~/k8s-init/journald-99-prophet.conf</span><br><span class="line">sudo systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 9.在各个主机中安装 docker软件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.卸载旧版本 </span></span><br><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.更新apt包索引并安装包以允许apt在HTTPS上使用存储库</span></span><br><span class="line">sudo apt-get install -y \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates \</span><br><span class="line">  curl \</span><br><span class="line">  gnupg-agent \</span><br><span class="line">  software-properties-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.添加Docker官方GPG密钥 # -fsSL</span></span><br><span class="line">curl https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.通过搜索指纹的最后8个字符进行密钥验证</span></span><br><span class="line">sudo apt-key fingerprint 0EBFCD88</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.设置稳定存储库</span></span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">  <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">  stable"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.Install Docker Engine 默认最新版本</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line">sudo apt-get install -y docker-ce=5:19.03.15~3-0~ubuntu-focal docker-ce-cli=5:19.03.15~3-0~ubuntu-focal containerd.io</span><br><span class="line"><span class="comment"># 7.安装特定版本的Docker引擎，请在repo中列出可用的版本</span></span><br><span class="line"><span class="comment"># $apt-cache madison docker-ce</span></span><br><span class="line"><span class="comment"># docker-ce | 5:20.10.2~3-0~ubuntu-focal | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># docker-ce | 5:18.09.1~3-0~ubuntu-xenial | https://download.docker.com/linux/ubuntu  xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># 使用第二列中的版本字符串安装特定的版本，例如:5:18.09.1~3-0~ubuntu-xenial。</span></span><br><span class="line"><span class="comment"># $sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#8.将当前用户加入docker用户组然后重新登陆当前用户使得低权限用户</span></span><br><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker</span><br><span class="line">sudo gpasswd -a weiyigeek docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#9.加速器建立</span></span><br><span class="line">mkdir -vp /etc/docker/</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://xlx9erfu.mirror.aliyuncs.com"</span>],</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"live-restore"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"dns"</span>: [<span class="string">"192.168.12.254"</span>],</span><br><span class="line">  <span class="string">"insecure-registries"</span>: [<span class="string">"harbor.weiyigeek.top"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># PS : 私有仓库配置 insecure_registries</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.自启与启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now docker </span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.退出登陆生效</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 10.先在 <code>WeiyiGeek-107</code> 机器中下载 kubernetes 集群相关的软件包并准备安装;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) gpg 签名下载导入</span></span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># (2) Kubernetes 安装源</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list </span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 软件包索引更新以及只下载依赖包不安装kubernetes(注意此处建议采用指定版本下载 )</span></span><br><span class="line">apt-cache madison kubelet kubeadm kubectl <span class="comment"># 查看可用的 kubernetes 版本 最新 1.20.1</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt -d install kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line">kubelet --version</span><br><span class="line"><span class="comment"># Kubernetes v1.20.1</span></span><br><span class="line">kubeadm version</span><br><span class="line"><span class="comment"># kubeadm version: &amp;version.Info&#123;Major:"1", Minor:"20", GitVersion:"v1.20.1", GitCommit:"c4d752765b3bbac2237bf87cf0b1c2e307844666", GitTreeState:"clean", BuildDate:"2020-12-18T12:07:13Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line">kubectl version</span><br><span class="line"><span class="comment"># Client Version: version.Info&#123;Major:"1", Minor:"20", GitVersion:"v1.20.1", GitCommit:"c4d752765b3bbac2237bf87cf0b1c2e307844666", GitTreeState:"clean", BuildDate:"2020-12-18T12:09:25Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以指定版本下载(ls /var/cache/apt/archives/  # 缓存目录) </span></span><br><span class="line"><span class="comment"># sudo apt -d install kubelet=1.19.10-00  kubeadm=1.19.10-00 kubectl=1.19.10-00</span></span><br><span class="line"><span class="comment"># 如果只是下载deb相关包以供离线安装可以使用以下方式安装</span></span><br><span class="line">sudo dpkg -i k8s-1.19.3/*.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) systemd 守护进程重启</span></span><br><span class="line">sudo systemctl daemon-reload  </span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) Kubelet是以POD的方式运行在容器之中，所以需要设置开机自启</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now kubelet.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 重启 docker</span></span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 11.关机此时克隆此Master机器为两台新的虚拟机机器;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 按照上面的清单设置主机名称以及IP地址</span></span><br><span class="line">./network.sh 192.168.1.108 192.168.1.1 weiyigeek-108</span><br><span class="line">./network.sh 192.168.1.109 192.168.1.1 weiyigeek-109</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h2 id="0x02-单实例K8s集群部署-v1-20-1"><a href="#0x02-单实例K8s集群部署-v1-20-1" class="headerlink" title="0x02 单实例K8s集群部署(v1.20.1)"></a>0x02 单实例K8s集群部署(v1.20.1)</h2><h3 id="1-Master-节点初始化"><a href="#1-Master-节点初始化" class="headerlink" title="1.Master 节点初始化"></a>1.Master 节点初始化</h3><ul>
<li>Step 1.单实例 Master 节点初始化以及集群资源清单配置(注意在前面的环境之下)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 在 WeiyiGeek-107 Master 节点上运行 `kubeadm config print init-defaults` 查看初始化参数</span></span><br><span class="line"><span class="comment"># 方式1.简单命令</span></span><br><span class="line">kubeadm init --kubernetes-version=1.20.1 --apiserver-advertise-address=192.168.1.201 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.2.0.0/16 --pod-network-cidr=10.3.0.0/16</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式2.yaml方式由于此处没做高可以用则APISERVER指向集群的Master节点即weiyigeek-107机器</span></span><br><span class="line">K8SVERSION=1.20.1</span><br><span class="line">k8SIMAGEREP=<span class="string">"registry.cn-hangzhou.aliyuncs.com/google_containers"</span></span><br><span class="line">APISERVER_IP=192.168.1.107</span><br><span class="line">APISERVER_NAME=weiyigeek.k8s</span><br><span class="line">APISERVER_PORT=6443</span><br><span class="line">SERVICE_SUBNET=10.244.0.0/16  <span class="comment"># Flannel 网络插件默认网段</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意点Token的格式</span></span><br><span class="line">cat &lt;&lt;EOF &gt; ~/k8s-init/kubeadm-init-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: 123456.httpweiyigeektop</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line"><span class="comment"># API Server 地址与端口</span></span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: <span class="variable">$&#123;APISERVER_IP&#125;</span></span><br><span class="line">  bindPort: <span class="variable">$&#123;APISERVER_PORT&#125;</span></span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: ubuntu</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: <span class="variable">$&#123;k8SIMAGEREP&#125;</span></span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v<span class="variable">$&#123;K8SVERSION&#125;</span></span><br><span class="line">controlPlaneEndpoint: <span class="string">"<span class="variable">$&#123;APISERVER_NAME&#125;</span>:<span class="variable">$&#123;APISERVER_PORT&#125;</span>"</span></span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: <span class="variable">$&#123;SERVICE_SUBNET&#125;</span></span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1    </span><br><span class="line">kind: KubeProxyConfiguration    </span><br><span class="line">featureGates:      </span><br><span class="line">  SupportIPVSProxyMode: <span class="literal">true</span>    </span><br><span class="line">mode: ipvs</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>k8s 集群创建初始命令:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init --upload-certs --config=/home/weiyigeek/k8s-init/kubeadm-init-config.yaml -v 5 | tee kubeadm_init.log</span><br><span class="line"><span class="comment"># W1104 21:29:36.119447  198575 configset.go:348] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span></span><br><span class="line"><span class="comment"># [init] Using Kubernetes version: v1.20.1</span></span><br><span class="line"><span class="comment"># [preflight] Running pre-flight checks</span></span><br><span class="line"><span class="comment"># [preflight] Pulling images required for setting up a Kubernetes cluster</span></span><br><span class="line"><span class="comment"># [preflight] This might take a minute or two, depending on the speed of your internet connection</span></span><br><span class="line"><span class="comment"># [preflight] You can also perform this action in beforehand using 'kubeadm config images pull'</span></span><br><span class="line"><span class="comment"># [certs] Using certificateDir folder "/etc/kubernetes/pki"</span></span><br><span class="line"><span class="comment"># .....</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace</span></span><br><span class="line"><span class="comment"># [kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: CoreDNS</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Your Kubernetes control-plane has initialized successfully!  # 表示控制化平面初始化成功</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="2-集群管理"><a href="#2-集群管理" class="headerlink" title="2.集群管理"></a>2.集群管理</h3><p>描述: 集群管理配置控制平面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 要开始使用集群，您需要以普通用户的身份运行在 Master 节点 执行以下命令:</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">grep <span class="string">"KUBECONFIG"</span> ~/.profile || <span class="built_in">echo</span> <span class="string">"export KUBECONFIG=~/.kube/config"</span> &gt;&gt; ~/.profile</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="3-集群网络插件安装"><a href="#3-集群网络插件安装" class="headerlink" title="3.集群网络插件安装"></a>3.集群网络插件安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署集群 pod 网络可以选择 flannel </span></span><br><span class="line"><span class="comment"># Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span></span><br><span class="line"><span class="comment">#   https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"><span class="comment"># 例如 安装 flannel 网络插件</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">podsecuritypolicy.policy/psp.flannel.unprivileged created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.apps/kube-flannel-ds created</span><br></pre></td></tr></table></figure>
<p><br/></p>
<h3 id="4-工作节点加入"><a href="#4-工作节点加入" class="headerlink" title="4.工作节点加入"></a>4.工作节点加入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 你现在可以以root身份加入任意数量的控制平面节点，在每个节点上运行以下命令:</span></span><br><span class="line">  kubeadm join weiyigeek.k8s:6443 --token 123456.httpweiyigeektop \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:95e1bb846a09a4523be6c1ee6d3860eec1dcfdd16200efec5177ff25a1de49a6 \</span><br><span class="line">    --control-plane --certificate-key e05180fc473a8b89e4616412dac61b95cf02808fe1a27f9f72c2be921acc63f8</span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted <span class="keyword">in</span> two hours; If necessary, you can use</span><br><span class="line"><span class="string">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 你可以加入任意数量的worker节点，在每个worker节点上以root用户运行如下命令:</span></span><br><span class="line">sudo kubeadm join weiyigeek.k8s:6443 --token 123456.httpweiyigeektop --discovery-token-ca-cert-hash sha256:95e1bb846a09a4523be6c1ee6d3860eec1dcfdd16200efec5177ff25a1de49a6</span><br><span class="line">[sudo] password <span class="keyword">for</span> weiyigeek:</span><br><span class="line">[preflight] Reading configuration from the cluster...</span><br><span class="line">[preflight] FYI: You can look at this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">"/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap...</span><br><span class="line"></span><br><span class="line"><span class="comment"># This node has joined the cluster:  # 表示该节点已经加入到集群中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<h3 id="4-Token-失效重生成"><a href="#4-Token-失效重生成" class="headerlink" title="4.Token 失效重生成"></a>4.Token 失效重生成</h3><ul>
<li>Step 1.如果超过24小时 token 失效需要重新生成<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) Token 生成</span></span><br><span class="line">kubeadm token create</span><br><span class="line"><span class="comment"># 2q41vx.w73xe9nrlqdujawu     ##此处是新token</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 获取CA（证书）公钥哈希值</span></span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="string">'s/^ .* //'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) kubernetes 证书目录</span></span><br><span class="line">$ ls /etc/kubernetes/pki</span><br><span class="line">apiserver.crt              apiserver-etcd-client.key  apiserver-kubelet-client.crt  ca.crt  etcd                front-proxy-ca.key      front-proxy-client.key  sa.pub</span><br><span class="line">apiserver-etcd-client.crt  apiserver.key              apiserver-kubelet-client.key  ca.key  front-proxy-ca.crt  front-proxy-client.crt  sa.key</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h3 id="5-节点重置"><a href="#5-节点重置" class="headerlink" title="5.节点重置"></a>5.节点重置</h3><ul>
<li>Step 1.当 Kuberneters 集群需要清理重构建需或者节点脱离集群时可以按照以下操作进行:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - Master 工作负载移除指定集群 例如删除 weiyigeek-223 weiyigeek-222 工作节点</span></span><br><span class="line">kubectl cordon weiyigeek-223 weiyigeek-222 </span><br><span class="line">kubectl delete node weiyigeek-223 weiyigeek-222 </span><br><span class="line"><span class="comment"># 采用 ipvs 进行负载的时候需要清理`ipvsadm --clear`</span></span><br><span class="line">sudo kubeadm reset</span><br><span class="line">sudo rm -rf /etc/cni/net.d/*</span><br><span class="line">sudo rm -rf /etc/kubernetes/pki/*</span><br><span class="line">sudo rm -rf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># - Node 工作节点移除k8s集群</span></span><br><span class="line">sudo kubeadm reset</span><br><span class="line">sudo rm -rf /etc/cni/net.d/*</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<p><em>补充说明</em>: 如果是在单master节点设置使用 calico 为 k8s 的CNI网络插件时<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">K8SVERSION=1.20.1</span><br><span class="line">APISERVER_IP=192.168.1.107</span><br><span class="line">APISERVER_NAME=k8s.weiyigeek.top</span><br><span class="line">APISERVER_PORT=6443</span><br><span class="line">SERVICE_SUBNET=10.99.0.0/16</span><br><span class="line">POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;APISERVER_IP&#125;</span> <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化配置(建议各个组件的版本与k8s的版本一致)</span></span><br><span class="line">rm -f ./kubeadm-config.yaml</span><br><span class="line">cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v<span class="variable">$&#123;K8SVERSION&#125;</span></span><br><span class="line">imageRepository: mirrorgcrio</span><br><span class="line"><span class="comment">#imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="comment">#imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="comment">#imageRepository: gcr.azk8s.cn/google_containers</span></span><br><span class="line">controlPlaneEndpoint: <span class="string">"<span class="variable">$&#123;APISERVER_NAME&#125;</span>:<span class="variable">$&#123;APISERVER_PORT&#125;</span>"</span></span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: <span class="string">"<span class="variable">$&#123;SERVICE_SUBNET&#125;</span>"</span></span><br><span class="line">  podSubnet: <span class="string">"<span class="variable">$&#123;POD_SUBNET&#125;</span>"</span></span><br><span class="line">  dnsDomain: <span class="string">"cluster.local"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeadm init 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span></span><br><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x03-高可用K8s集群部署-v1-19-6"><a href="#0x03-高可用K8s集群部署-v1-19-6" class="headerlink" title="0x03 高可用K8s集群部署(v1.19.6)"></a>0x03 高可用K8s集群部署(v1.19.6)</h2><h3 id="Step-1-高可用组件安装所有Master节点通过apt安装HAProxy和KeepAlived"><a href="#Step-1-高可用组件安装所有Master节点通过apt安装HAProxy和KeepAlived" class="headerlink" title="Step 1.高可用组件安装所有Master节点通过apt安装HAProxy和KeepAlived"></a>Step 1.高可用组件安装所有Master节点通过apt安装HAProxy和KeepAlived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PS: 此时只下载不安装(方便传到没有网络的master节点上)</span></span><br><span class="line">sudo apt -d install keepalived haproxy</span><br><span class="line"><span class="comment"># ~/k8s-init$ scp -P 20211 /home/weiyigeek/k8s-init/High-Availability/* weiyigeek@192.168.1.108:~/k8s-init/</span></span><br><span class="line"><span class="comment"># ~/k8s-init$ scp -P 20211 /home/weiyigeek/k8s-init/High-Availability/* weiyigeek@192.168.1.109:~/k8s-init/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 dpkg 命令 安装 上一步下载的 deb包</span></span><br><span class="line">/var/cache/apt/archives$ dpkg -i *.deb</span><br><span class="line"><span class="comment"># ~/k8s-init$ ssh -p20211 weiyigeek@192.168.1.108 "sudo -S dpkg -i ~/k8s-init/*.deb"</span></span><br><span class="line"><span class="comment"># ~/k8s-init$ ssh -p20211 weiyigeek@192.168.1.109 "sudo -S dpkg -i ~/k8s-init/*.deb"</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-2-所有Master节点配置HAProxy"><a href="#Step-2-所有Master节点配置HAProxy" class="headerlink" title="Step 2.所有Master节点配置HAProxy"></a>Step 2.所有Master节点配置HAProxy</h3><p>PS : 详细配置参考HAProxy文档，所有Master节点的HAProxy配置相同<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu haproxy 配置文件目录</span></span><br><span class="line"><span class="variable">$ls</span> /etc/haproxy/</span><br><span class="line">errors/      haproxy.cfg</span><br><span class="line"></span><br><span class="line"><span class="variable">$sudo</span> vim /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span>    local0</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span>    local1 notice</span><br><span class="line">  chroot /var/lib/haproxy</span><br><span class="line">  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br><span class="line">  stats timeout 30s</span><br><span class="line">  user haproxy</span><br><span class="line">  group haproxy</span><br><span class="line">  daemon</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default SSL material locations</span></span><br><span class="line">  ca-base /etc/ssl/certs</span><br><span class="line">  crt-base /etc/ssl/private</span><br><span class="line"></span><br><span class="line">  <span class="comment"># See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.0.3&amp;config=intermediate</span></span><br><span class="line">  ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><br><span class="line">  ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256</span><br><span class="line">  ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  <span class="built_in">log</span>     global</span><br><span class="line">  mode    http</span><br><span class="line">  option  httplog</span><br><span class="line">  option  dontlognull</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  errorfile 400 /etc/haproxy/errors/400.http</span><br><span class="line">  errorfile 403 /etc/haproxy/errors/403.http</span><br><span class="line">  errorfile 408 /etc/haproxy/errors/408.http</span><br><span class="line">  errorfile 500 /etc/haproxy/errors/500.http</span><br><span class="line">  errorfile 502 /etc/haproxy/errors/502.http</span><br><span class="line">  errorfile 503 /etc/haproxy/errors/503.http</span><br><span class="line">  errorfile 504 /etc/haproxy/errors/504.http</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意: 16443 为VIP的Apiserver-控制平面端口</span></span><br><span class="line">frontend k8s-master</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:16443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:16443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意: Master 节点的默认apiserver是6443端口</span></span><br><span class="line">backend k8s-master</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server weiyigeek-107 192.168.1.107:6443  check</span><br><span class="line">  server weiyigeek-108 192.168.1.108:6443  check</span><br><span class="line">  server weiyigeek-109 192.168.1.109:6443  check</span><br></pre></td></tr></table></figure></p>
<p>所有Master节点配置KeepAlived，配置不一样，<code>注意区分注意每个节点的IP和网卡（interface参数）</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /etc/keepalived</span><br><span class="line"><span class="comment"># weiyigeek-107 Master 1</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.1.107</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#    track_script &#123;</span></span><br><span class="line"><span class="comment">#       chk_apiserver</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># weiyigeek-108 Master 2 =&gt; Backup</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.1.108</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#    track_script &#123;</span></span><br><span class="line"><span class="comment">#       chk_apiserver</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># weiyigeek-108 Master 3 =&gt; Backup</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.1.109</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#    track_script &#123;</span></span><br><span class="line"><span class="comment">#       chk_apiserver</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="Step-3-配置KeepAlived健康检查文件"><a href="#Step-3-配置KeepAlived健康检查文件" class="headerlink" title="Step 3.配置KeepAlived健康检查文件"></a>Step 3.配置KeepAlived健康检查文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo tee /etc/keepalived/check_apiserver.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(seq 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  check_code=$(pgrep haproxy)</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line">    err=$(expr <span class="variable">$err</span> + 1)</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    err=0</span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">"0"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"systemctl stop keepalived"</span></span><br><span class="line">  /usr/bin/systemctl stop keepalived</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line">sudo chmod +x /etc/keepalived/check_apiserver.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份高可用相关配置文件</span></span><br><span class="line">mkdir ~/k8s-init/haproxy &amp;&amp; cp /etc/haproxy/haproxy.cfg ~/k8s-init/haproxy </span><br><span class="line">mkdir ~/k8s-init/keepalived &amp;&amp; cp /etc/keepalived/keepalived.conf /etc/keepalived/check_apiserver.sh ~/k8s-init/keepalived</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-4-启动haproxy和keepalived以及测试VIP"><a href="#Step-4-启动haproxy和keepalived以及测试VIP" class="headerlink" title="Step 4.启动haproxy和keepalived以及测试VIP"></a>Step 4.启动haproxy和keepalived以及测试VIP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自启动并立即启动</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now haproxy</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># VIP 漂移测试</span></span><br><span class="line">~$ ps aux | grep <span class="string">"haproxy"</span></span><br><span class="line">root         892  0.0  0.1  15600  9236 ?        Ss   10:39   0:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -S /run/haproxy-master.sock</span><br><span class="line">haproxy      893  0.0  0.0 531724  3480 ?        Sl   10:39   0:02 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -S /run/haproxy-master.sock</span><br><span class="line"></span><br><span class="line">weiyigeek-107:$ ip addr</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:8a:e8:db brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.107/24 brd 192.168.1.255 scope global ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.110/32 scope global ens160  <span class="comment"># 可以看见该VIP在weiyigeek-107</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">weiyigeek-107:~$ systemctl stop keepalived.service  <span class="comment"># 现在 weiyigeek-107 停止 keepalived.service</span></span><br><span class="line">weiyigeek-107:~$ ip addr | grep <span class="string">"192.168.1.110"</span>    <span class="comment"># 此时会发现 weiyigeek-107 已经不存在该VIP了</span></span><br><span class="line">weiyigeek-107:~$ ssh -p20211 weiyigeek@192.168.1.109 <span class="string">"ip addr | grep '192.168.1.110'"</span> <span class="comment"># 会发现漂移到weiyigeek-109的master节点的机器上</span></span><br><span class="line">  inet 192.168.1.110/32 scope global ens160</span><br><span class="line">weiyigeek-107:~$ ping 192.168.1.110               <span class="comment"># ping 通信正常</span></span><br><span class="line"><span class="comment"># PING 192.168.1.110 (192.168.1.110) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from 192.168.1.110: icmp_seq=1 ttl=64 time=0.218 ms</span></span><br></pre></td></tr></table></figure>
<p>PS : 至此基于Haproxy与keepalive实现的高可用已经OK了;</p>
<p><br></p>
<h3 id="Step-5-集群安装其它指定版本"><a href="#Step-5-集群安装其它指定版本" class="headerlink" title="Step 5.集群安装其它指定版本"></a>Step 5.集群安装其它指定版本</h3><p>PS : 在基础环境的安装中我们采用了 <code>docker 1.20.x 以及 kubernetes 1.20.x</code>考虑到 k8s 在 1.23.x 版本之后将会丢弃docker而使用其它的CRI-O, 此处为了集群环境的稳定性将原本docker以及kubernetes版本删除，分别安装1.19.x版本;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 停止服务</span></span><br><span class="line">sudo systemctl stop docker.service kubelet.service docker.socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) docker 容器卸载 &amp;&amp; K8s 卸载</span></span><br><span class="line">sudo apt-get remove docker-ce docker-ce-cli containerd.io kubectl kubeadm kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 查看 docker 以及 k8s 版本</span></span><br><span class="line">sudo apt-cache madison docker-ce docker-ce-cli kubelet</span><br><span class="line"><span class="comment"># sudo apt-get -d install docker-ce=5:19.03.14~3-0~ubuntu-focal docker-ce-cli=5:19.03.14~3-0~ubuntu-focal containerd.io  # Download complete and in download only mode</span></span><br><span class="line"><span class="comment"># sudo dpkg -i /var/cache/apt/archives/*.deb</span></span><br><span class="line">sudo apt-get install docker-ce=5:19.03.14~3-0~ubuntu-focal docker-ce-cli=5:19.03.14~3-0~ubuntu-focal containerd.io -y</span><br><span class="line">sudo apt install kubelet=1.19.6-00 kubeadm=1.19.6-00 kubectl=1.19.6-00 -y</span><br><span class="line">$ kubeadm version</span><br><span class="line"><span class="comment"># kubeadm version: &amp;version.Info&#123;Major:"1", Minor:"19", GitVersion:"v1.19.6", GitCommit:"1e11e4a2108024935ecfcb2912226cedeafd99df", GitTreeState:"clean", BuildDate:"2020-10-14T12:47:53Z", GoVersion:"go1.15.2", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line">$ kubelet --version</span><br><span class="line"><span class="comment"># Kubernetes v1.19.6</span></span><br><span class="line">$ kubectl version</span><br><span class="line"><span class="comment"># Client Version: version.Info&#123;Major:"1", Minor:"19", GitVersion:"v1.19.6", GitCommit:"1e11e4a2108024935ecfcb2912226cedeafd99df", GitTreeState:"clean", BuildDate:"2020-10-14T12:50:19Z", GoVersion:"go1.15.2", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 自启并启动服务</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now docker </span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line">sudo systemctl restart docker kubelet</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="Step-6-集群初始化的yaml文件"><a href="#Step-6-集群初始化的yaml文件" class="headerlink" title="Step 6.集群初始化的yaml文件"></a>Step 6.集群初始化的yaml文件</h3><p>描述: kubeadm 可以打印出初始化以及节点加入的配置模板;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 初始化</span></span><br><span class="line">$ kubeadm config <span class="built_in">print</span> init-defaults</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 1.2.3.4</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: ubuntu</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.19.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 节点加入</span></span><br><span class="line">$ kubeadm config <span class="built_in">print</span> join-defaults</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">caCertPath: /etc/kubernetes/pki/ca.crt</span><br><span class="line">discovery:</span><br><span class="line">  bootstrapToken:</span><br><span class="line">    apiServerEndpoint: kube-apiserver:6443</span><br><span class="line">    token: abcdef.0123456789abcdef</span><br><span class="line">    unsafeSkipCAVerification: <span class="literal">true</span></span><br><span class="line">  timeout: 5m0s</span><br><span class="line">  tlsBootstrapToken: abcdef.0123456789abcdef</span><br><span class="line">kind: JoinConfiguration</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: ubuntu</span><br><span class="line">  taints: null</span><br></pre></td></tr></table></figure></p>
<p>K8s 集群初始化配置文件(<code>~/k8s-init/kubeadm-init-config.yaml</code>)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 注意 : Token的格式以及Pod子网的网段 (Calico)和ipvs的支持</span></span><br><span class="line">K8SVERSION=1.19.6</span><br><span class="line">k8SIMAGEREP=<span class="string">"registry.cn-hangzhou.aliyuncs.com/google_containers"</span></span><br><span class="line">APISERVER_NAME=weiyigeek-lb-vip.k8s</span><br><span class="line">APISERVER_IP=192.168.1.110</span><br><span class="line">APISERVER_PORT=16443</span><br><span class="line">LOCALAPIVERVER_NAME=weiyigeek-107</span><br><span class="line">LOCALAPISERVER_IP=192.168.1.107</span><br><span class="line">LOCALAPISERVER_PORT=6443</span><br><span class="line">SERVICE_SUBNET=172.16.0.0/16</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; ~/k8s-init/kubeadm-init-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: 20w21w.httpweiyigeektop</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: <span class="variable">$&#123;LOCALAPISERVER_IP&#125;</span></span><br><span class="line">  bindPort: <span class="variable">$&#123;LOCALAPISERVER_PORT&#125;</span></span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: <span class="variable">$&#123;LOCALAPIVERVER_NAME&#125;</span></span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - <span class="variable">$&#123;APISERVER_IP&#125;</span></span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: <span class="variable">$&#123;k8SIMAGEREP&#125;</span></span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v<span class="variable">$&#123;K8SVERSION&#125;</span></span><br><span class="line">controlPlaneEndpoint: <span class="variable">$&#123;APISERVER_NAME&#125;</span>:<span class="variable">$&#123;APISERVER_PORT&#125;</span></span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: <span class="variable">$&#123;SERVICE_SUBNET&#125;</span></span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1    </span><br><span class="line">kind: KubeProxyConfiguration    </span><br><span class="line">featureGates:      </span><br><span class="line">  SupportIPVSProxyMode: <span class="literal">true</span>    </span><br><span class="line">mode: ipvs</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 初始化Master节点控制平面以及Worker加入的参数生成(# 根据您服务器网速的情况，您需要等候 3 - 10 分钟建议采用下面备注中的操作)</span></span><br><span class="line">sudo kubeadm init --config=/home/weiyigeek/k8s-init/kubeadm-init-config.yaml --upload-certs | tee kubeadm_init.log</span><br><span class="line"><span class="comment"># [certs] Using certificateDir folder "/etc/kubernetes/pki"</span></span><br><span class="line"><span class="comment"># [certs] Generating "ca" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "apiserver" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] apiserver serving cert is signed for DNS names [weiyigeek-107 weiyigeek-lb-vip.k8s kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.1.107 192.168.1.110]</span></span><br><span class="line"><span class="comment"># [certs] Generating "apiserver-kubelet-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "front-proxy-ca" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "front-proxy-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/ca" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/server" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] etcd/server serving cert is signed for DNS names [weiyigeek-107 localhost] and IPs [192.168.1.107 127.0.0.1 ::1]</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/peer" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] etcd/peer serving cert is signed for DNS names [weiyigeek-107 localhost] and IPs [192.168.1.107 127.0.0.1 ::1]</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/healthcheck-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "apiserver-etcd-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "sa" key and public key</span></span><br><span class="line"><span class="comment"># [kubeconfig] Using kubeconfig folder "/etc/kubernetes"</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "admin.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "kubelet.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "controller-manager.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "scheduler.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line"><span class="comment"># [kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"</span></span><br><span class="line"><span class="comment"># [kubelet-start] Starting the kubelet</span></span><br><span class="line"><span class="comment"># [control-plane] Using manifest folder "/etc/kubernetes/manifests"</span></span><br><span class="line"><span class="comment"># [control-plane] Creating static Pod manifest for "kube-apiserver"</span></span><br><span class="line"><span class="comment"># [control-plane] Creating static Pod manifest for "kube-controller-manager"</span></span><br><span class="line"><span class="comment"># [control-plane] Creating static Pod manifest for "kube-scheduler"</span></span><br><span class="line"><span class="comment"># [etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"</span></span><br><span class="line"><span class="comment"># [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s</span></span><br><span class="line"><span class="comment"># [apiclient] All control plane components are healthy after 21.750931 seconds</span></span><br><span class="line"><span class="comment"># [upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace</span></span><br><span class="line"><span class="comment"># [kubelet] Creating a ConfigMap "kubelet-config-1.19" in namespace kube-system with the configuration for the kubelets in the cluster</span></span><br><span class="line"><span class="comment"># [upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace</span></span><br><span class="line"><span class="comment"># [upload-certs] Using certificate key:</span></span><br><span class="line"><span class="comment"># bb5b2f0b287d35e179ef4efawwww9f61a38f62343a9b06fc143e3b</span></span><br><span class="line"><span class="comment"># [mark-control-plane] Marking the node weiyigeek-107 as control-plane by adding the label "node-role.kubernetes.io/master=''"</span></span><br><span class="line"><span class="comment"># [mark-control-plane] Marking the node weiyigeek-107 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Using token: 2021wq.httpweiyigeektop</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace</span></span><br><span class="line"><span class="comment"># [kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: CoreDNS</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: kube-proxy</span></span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br></pre></td></tr></table></figure></p>
<p>PS : 将该yaml文件复制到其他master节点，之后所有Master节点提前下载镜像，可以节省初始化时间：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1.配置文件上传到其他master节点</span></span><br><span class="line">scp -P 20211 /home/weiyigeek/k8s-init/kubeadm-init-config.yaml weiyigeek@192.168.1.108:~/k8s-init/kubeadm-init-config.yaml</span><br><span class="line">kubeadm config images pull --config /home/weiyigeek/k8s-init/kubeadm-init-config.yaml</span><br><span class="line"><span class="comment"># W0111 11:24:15.905316    5481 configset.go:348] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.13-0</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.7.0</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="Step-7-Kubernetes-集群访问配置"><a href="#Step-7-Kubernetes-集群访问配置" class="headerlink" title="Step 7.Kubernetes 集群访问配置"></a>Step 7.Kubernetes 集群访问配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 普通用户对集群访问配置文件设置</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 自动运行设置 KUBECONFIG 环境以及k8s命令自动补齐</span></span><br><span class="line">grep <span class="string">"export KUBECONFIG"</span> ~/.profile | <span class="built_in">echo</span> <span class="string">"export KUBECONFIG=<span class="variable">$HOME</span>/.kube/config"</span> &gt;&gt; ~/.profile</span><br><span class="line">tee -a ~/.profile &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"><span class="built_in">source</span> &lt;(kubeadm completion bash)</span><br><span class="line"><span class="comment"># source &lt;(kubelet completion bash)</span></span><br><span class="line"><span class="comment"># source &lt;(helm completion bash)</span></span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">source</span> ~/.profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 查看节点状态和kube-system命名空间内Pod状态</span></span><br><span class="line">~$ kubectl get node</span><br><span class="line"><span class="comment"># NAME       STATUS     ROLES    AGE   VERSION</span></span><br><span class="line"><span class="comment"># weiyigeek-107   NotReady   master   45m   v1.19.6   # 此处NotReady 是由于我们的calico网络插件未配置好</span></span><br><span class="line">~$ kubectl get pod -n kube-system</span><br><span class="line"><span class="comment"># NAME                               READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># coredns-6c76c8bb89-6cl4d           0/1     Pending   0          45m</span></span><br><span class="line"><span class="comment"># coredns-6c76c8bb89-xzkms           0/1     Pending   0          45m</span></span><br><span class="line"><span class="comment"># etcd-weiyigeek-107                      1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-apiserver-weiyigeek-107            1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-controller-manager-weiyigeek-107   1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-proxy-l7bp6                   1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-scheduler-weiyigeek-107            1/1     Running   0          45m</span></span><br></pre></td></tr></table></figure>
<p>PS : 当没有安装第三方的 <code>flannel或者calico网络插件</code> 时候，通过kubectl get node 查看到节点状态是 NotReady ，当安装完成扁平化网络插件后, 如果没有其它意外则显示Ready</p>
<p><br></p>
<h3 id="Step-8-现在应该将pod网络部署到集群-此处选用calico网络插件而非使用flannel插件"><a href="#Step-8-现在应该将pod网络部署到集群-此处选用calico网络插件而非使用flannel插件" class="headerlink" title="Step 8.现在应该将pod网络部署到集群,此处选用calico网络插件而非使用flannel插件"></a>Step 8.现在应该将pod网络部署到集群,此处选用calico网络插件而非使用flannel插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span></span><br><span class="line"><span class="comment"># https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 calico 网络插件(此处安装最新的v3.17.1版本不采用kuboard脚本)</span></span><br><span class="line"><span class="comment"># 参考文档 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span></span><br><span class="line"><span class="comment"># wget https://kuboard.cn/install-script/calico/calico-3.13.1.yaml</span></span><br><span class="line"><span class="comment"># kubectl apply -f calico-3.13.1.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) Install Calico with Kubernetes API datastore, 50 nodes or less</span></span><br><span class="line"><span class="comment"># curl https://docs.projectcalico.org/manifests/calico.yaml -O</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) Install Calico with etcd datastore (使用etcd数据存储安装Calico) </span></span><br><span class="line">curl https://docs.projectcalico.org/manifests/calico-etcd.yaml -O</span><br><span class="line"></span><br><span class="line"><span class="comment"># calico-etcd 网络与etc集群连接修改(此处指定pod子网地址)</span></span><br><span class="line">ETCD_CA=`cat /etc/kubernetes/pki/etcd/ca.crt | base64 | tr -d <span class="string">'\n'</span>`</span><br><span class="line">ETCD_CERT=`cat /etc/kubernetes/pki/etcd/server.crt | base64 | tr -d <span class="string">'\n'</span>`</span><br><span class="line">ETCD_KEY=`sudo cat /etc/kubernetes/pki/etcd/server.key | base64 | tr -d <span class="string">'\n'</span>`</span><br><span class="line">POD_SUBNET=`sudo cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= <span class="string">'&#123;print $NF&#125;'</span>`</span><br><span class="line">sed -i <span class="string">"s@# etcd-key: null@etcd-key: <span class="variable">$&#123;ETCD_KEY&#125;</span>@g; s@# etcd-cert: null@etcd-cert: <span class="variable">$&#123;ETCD_CERT&#125;</span>@g; s@# etcd-ca: null@etcd-ca: <span class="variable">$&#123;ETCD_CA&#125;</span>@g"</span> calico-etcd.yaml</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s#etcd_ca: ""#etcd_ca: "/calico-secrets/etcd-ca"#g; s#etcd_cert: ""#etcd_cert: "/calico-secrets/etcd-cert"#g; s#etcd_key: "" #etcd_key: "/calico-secrets/etcd-key" #g'</span> calico-etcd.yaml</span><br><span class="line">sed -i <span class="string">'s#etcd_endpoints: "http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;"#etcd_endpoints: "https://192.168.12.107:2379,https://192.168.12.108:2379,https://192.168.12.109:2379"#g'</span> calico-etcd.yaml</span><br><span class="line">sed -i <span class="string">'s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: "192.168.0.0/16"@  value: '</span><span class="string">"<span class="variable">$&#123;POD_SUBNET&#125;</span>"</span><span class="string">'@g'</span> calico-etcd.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 部署到集群中</span></span><br><span class="line">kubectl apply -f calico-etcd.yaml</span><br><span class="line"><span class="comment"># secret/calico-etcd-secrets created</span></span><br><span class="line"><span class="comment"># configmap/calico-config created</span></span><br><span class="line"><span class="comment"># clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># clusterrole.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="comment"># daemonset.apps/calico-node created</span></span><br><span class="line"><span class="comment"># serviceaccount/calico-node created</span></span><br><span class="line"><span class="comment"># deployment.apps/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># serviceaccount/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># poddisruptionbudget.policy/calico-kube-controllers created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 只在 master 节点执行</span></span><br><span class="line"><span class="comment"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"---等待容器组构建完成---"</span> &amp;&amp; sleep 180</span><br><span class="line">kubectl get nodes -o wide       <span class="comment"># 查看 master 节点初始化结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) 各节点网卡地址已经未设置的POD子网地址</span></span><br><span class="line">~$ route</span><br><span class="line"><span class="comment"># Kernel IP routing table</span></span><br><span class="line"><span class="comment"># Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span></span><br><span class="line"><span class="comment"># default         _gateway        0.0.0.0         UG    0      0        0 ens160</span></span><br><span class="line"><span class="comment"># default         _gateway        0.0.0.0         UG    0      0        0 ens160</span></span><br><span class="line"><span class="comment"># 172.16.0.192    0.0.0.0         255.255.255.192 U     0      0        0 *</span></span><br><span class="line"><span class="comment"># 172.16.0.193    0.0.0.0         255.255.255.255 UH    0      0        0 calib6c39f0a1d5</span></span><br><span class="line"><span class="comment"># 172.16.0.194    0.0.0.0         255.255.255.255 UH    0      0        0 calic77cbbaf4da</span></span><br><span class="line"><span class="comment"># 172.16.24.192   weiyigeek-223        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.100.64   weiyigeek-224        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.135.192  weiyigeek-108        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.182.192  weiyigeek-226        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.183.64   weiyigeek-225        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.243.64   weiyigeek-109        255.255.255.192 UG    0      0        0 tunl0</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-9-高可用Master初始化，将其他master节点加入集群控制平面"><a href="#Step-9-高可用Master初始化，将其他master节点加入集群控制平面" class="headerlink" title="Step 9.高可用Master初始化，将其他master节点加入集群控制平面"></a>Step 9.高可用Master初始化，将其他master节点加入集群控制平面</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm join weiyigeek-lb-vip.k8s:16443 --token 20w21w.httpweiyigeektop \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:7ea900ef214c98aef6d7daf1380320d0a43f666f2d4b6b7469077bd51790118e \</span><br><span class="line">  --control-plane --certificate-key 8327482265975b7a60f3549222f1093353ecaa148a3404cd10c605d4111566fc</span><br><span class="line"></span><br><span class="line">PS : 作为安全措施，上传的证书将在两小时内被删除; 如果需要您可以使用下面的命令重新加载证书。</span><br><span class="line"><span class="string">"kubeadm init phase upload-certs --upload-certs"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Token </span></span><br><span class="line">~/k8s-init$ kubectl get secret</span><br><span class="line">  <span class="comment"># NAME                  TYPE                                  DATA   AGE</span></span><br><span class="line">  <span class="comment"># default-token-xzcbz   kubernetes.io/service-account-token   3      17m</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-10-工作节点或者负载加入到集群中"><a href="#Step-10-工作节点或者负载加入到集群中" class="headerlink" title="Step 10.工作节点或者负载加入到集群中"></a>Step 10.工作节点或者负载加入到集群中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 为了便于工作节点快速接入到集群中，我们先把master中的镜像导入到工作节点</span></span><br><span class="line">docker save -o v1.19.6.tar $(docker images | grep -v TAG | cut -d <span class="string">' '</span> -f1)  <span class="comment"># 导出</span></span><br><span class="line">docker load -i v1.19.6.tar   <span class="comment"># 加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 然后你可以加入任意数量的worker节点，在每个worker节点上以root用户运行如下命令:</span></span><br><span class="line">sudo kubeadm join weiyigeek-lb-vip.k8s:16443 --token 20w21w.httpweiyigeektop \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:7ea900ef214c98aef6d7daf1380320d0a43f666f2d4b6b7469077bd51790118e</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-11-集群状态查看-amp-镜像查看"><a href="#Step-11-集群状态查看-amp-镜像查看" class="headerlink" title="Step 11.集群状态查看 &amp; 镜像查看"></a>Step 11.集群状态查看 &amp; 镜像查看</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) Master 集群状态</span></span><br><span class="line">weiyigeek-107:~$ kubectl get node -o wide</span><br><span class="line">NAME       STATUS   ROLES    AGE    VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class="line">weiyigeek-107   Ready    master   25m    v1.19.6   192.168.1.107   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class="line">weiyigeek-108   Ready    master   15m    v1.19.6   192.168.1.108   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class="line">weiyigeek-109   Ready    master   100s   v1.19.6   192.168.1.109   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) K8s 集群 SVC 信息查看</span></span><br><span class="line">~$ kubectl get svc -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   32m   &lt;none&gt;</span><br><span class="line">~$ kubectl get svc -o wide -n kube-system</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE   SELECTOR</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   31m   k8s-app=kube-dns</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 为了可以节省资源将其余两台Master节点关闭污点</span></span><br><span class="line">kubectl taint node weiyigeek-108 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class="line">kubectl taint node weiyigeek-109 node-role.kubernetes.io/master=:NoSchedule-</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="0x04-高可用集群使用初体验"><a href="#0x04-高可用集群使用初体验" class="headerlink" title="0x04 高可用集群使用初体验"></a>0x04 高可用集群使用初体验</h2><p>描述: 简单对nginx应用从镜像打包到部署到k8s集群中使用流程进行演示</p>
<ul>
<li>Step 1.编写dockerfile和相关脚本<br>$ cat dockerfile<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx</span><br><span class="line">LABEL maintainer=<span class="string">"Nginx Test Demo , Authorr: weiyigeek, Version: 2.2"</span></span><br><span class="line">ENV PATH /usr/<span class="built_in">local</span>/nginx/sbin:<span class="variable">$PATH</span></span><br><span class="line">ENV IMAGE_VERSION 2.2</span><br><span class="line">COPY ./host.sh /</span><br><span class="line">RUN chmod a+x /host.sh</span><br><span class="line">ENTRYPOINT [<span class="string">"/host.sh"</span>]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>$ cat host.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hostname: <span class="variable">$HOSTNAME</span>"</span> &gt; /usr/share/nginx/html/host.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Image Version: <span class="variable">$IMAGE_VERSION</span>"</span> &gt;&gt; /usr/share/nginx/html/host.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx Version: <span class="variable">$NGINX_VERSION</span>"</span> &gt;&gt; /usr/share/nginx/html/host.html</span><br><span class="line">sh -c <span class="string">"nginx -g 'daemon off;'"</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>Step 2.镜像构建 &amp; 上传到私有得Harbor仓库:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2 .</span><br><span class="line">$ docker images | grep <span class="string">"v2.2"</span></span><br><span class="line">  <span class="comment"># harbor.weiyigeek.top/test/nginx                                  v2.2                b8a212b2bc88        10 hours ago        133MB</span></span><br><span class="line">$ docker push harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2</span><br><span class="line">  <span class="comment"># The push refers to repository [harbor.weiyigeek.top/test/nginx]</span></span><br><span class="line">  <span class="comment"># v2.2: digest: sha256:4c49fc25d52e5331146699ff605561f59fb326505074c0474a3ce4898f0fcb02 size: 1776</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 3.部署镜像 &amp; 查看:</li>
</ul>
<p><strong>方式1</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1.不推荐(配置标签以及标签选择需要添加参数，比较麻烦)</span></span><br><span class="line">$ kubectl run nginx-deployment --image=harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2 --port=80</span><br><span class="line">  <span class="comment"># pod/nginx-deployment created</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">  <span class="comment"># NAME               READY   STATUS    RESTARTS   AGE    IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment   1/1     Running   0          108s   10.244.1.2   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用podSubnet进行查看</span></span><br><span class="line">weiyigeek@ubuntu:~$ curl http://10.244.1.2/host.html</span><br><span class="line">  <span class="comment"># Hostname: nginx-deployment</span></span><br><span class="line">  <span class="comment"># Image Version: 2.2</span></span><br><span class="line">  <span class="comment"># Nginx Version: 1.19.4</span></span><br></pre></td></tr></table></figure></p>
<p><strong>方式2</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; nginx-deployment.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion: apps/v1	<span class="comment">#与k8s集群版本有关，使用 kubectl api-versions 即可查看当前集群支持的版本</span></span><br><span class="line">kind: Deployment   	<span class="comment">#该配置的类型，我们使用的是 Deployment</span></span><br><span class="line">metadata:	          <span class="comment">#译名为元数据，即 Deployment 的一些基本属性和信息</span></span><br><span class="line">  name: nginx-deployment	<span class="comment">#Deployment 的名称</span></span><br><span class="line">  namespace: default </span><br><span class="line">  labels:	      <span class="comment">#标签可以灵活定位一个或多个资源，其中key和value均可自定义，可以定义多组，目前不需要理解</span></span><br><span class="line">    app: nginx	<span class="comment">#为该Deployment设置key为app，value为nginx的标签</span></span><br><span class="line">spec:	          <span class="comment">#这是关于该Deployment的描述，可以理解为你期待该Deployment在k8s中如何使用</span></span><br><span class="line">  replicas: 1  	<span class="comment">#使用该Deployment创建一个应用程序实例</span></span><br><span class="line">  selector:	    <span class="comment">#标签选择器，与上面的标签共同作用，目前不需要理解</span></span><br><span class="line">    matchLabels: <span class="comment">#选择包含标签app:nginx的资源</span></span><br><span class="line">      app: nginx</span><br><span class="line">  template:	     <span class="comment">#这是选择或创建的Pod的模板</span></span><br><span class="line">    metadata:	   <span class="comment">#Pod的元数据</span></span><br><span class="line">      labels:    <span class="comment">#Pod的标签，上面的selector即选择包含标签app:nginx的Pod</span></span><br><span class="line">        app: nginx</span><br><span class="line">    spec:	        <span class="comment">#期望Pod实现的功能(即在pod中部署)</span></span><br><span class="line">      containers:	<span class="comment">#生成container，与docker中的container是同一种</span></span><br><span class="line">      - name: nginx	<span class="comment">#container的名称</span></span><br><span class="line">        image: harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2 	<span class="comment">#使用镜像nginx最新版本创建container，该container默认80端口可访问</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">  <span class="comment"># deployment.apps/nginx-deployment created</span></span><br><span class="line"></span><br><span class="line">$ kubectl get deployment</span><br><span class="line">  <span class="comment"># NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line">  <span class="comment"># nginx-deployment   1/1     1            1           87s</span></span><br><span class="line">  <span class="comment"># weiyigeek@ubuntu:~/nginx$ kubectl get pod</span></span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-flmsf   1/1     Running   0          92s</span></span><br><span class="line">  <span class="comment"># weiyigeek@ubuntu:~/nginx$ kubectl get pod -o wide</span></span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-flmsf   1/1     Running   0          99s   10.244.1.4   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">~/nginx$ curl http://10.244.1.4/host.html</span><br><span class="line">  <span class="comment"># Hostname: nginx-deployment-7f5d9779c6-flmsf</span></span><br><span class="line">  <span class="comment"># Image Version: 2.2</span></span><br><span class="line">  <span class="comment"># Nginx Version: 1.19.4</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>Step 4.Pod 副本 &amp; 收缩 &amp; 端口映射</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod nginx-deployment-7f5d9779c6-flmsf</span><br><span class="line">  <span class="comment"># pod "nginx-deployment-7f5d9779c6-flmsf" deleted</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-hhl7k   1/1     Running   0          60s   10.244.1.5   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">$ kubectl scale --replicas=3 deployment/nginx-deployment</span><br><span class="line">  <span class="comment"># deployment.apps/nginx-deployment scaled</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE    IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-dr5h8   1/1     Running   0          4s     10.244.1.7   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-hhl7k   1/1     Running   0          109s   10.244.1.5   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-sk2f4   1/1     Running   0          4s     10.244.1.6   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">$ kubectl edit svc nginx-deployment  <span class="comment"># 第一章中有介绍 SVC，不知道回去看一哈</span></span><br><span class="line">$ kubectl expose -f nginx-controller.yaml --port=80 --target-port=8000 --protocol=TCP --<span class="built_in">type</span>=NodePort --node-port=31855  <span class="comment"># 后续验证</span></span><br><span class="line">$ kubectl expose svc nginx-deployment --port=80 --target-port=8000 --protocol=TCP --<span class="built_in">type</span>=NodePort</span><br><span class="line">  <span class="comment"># type: NodePort</span></span><br><span class="line">$ kubectl get svc</span><br><span class="line">  <span class="comment"># NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)           AGE</span></span><br><span class="line">  <span class="comment"># kubernetes         ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP           2d22h</span></span><br><span class="line">  <span class="comment"># nginx-deployment   NodePort    10.99.90.247   &lt;none&gt;        30000:31855/TCP   39h</span></span><br><span class="line"></span><br><span class="line">$ sudo netstat -anpt | grep <span class="string">"31855"</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:31855           0.0.0.0:*               LISTEN      1931726/kube-proxy</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.IPVS 负载均衡和rr轮询机制查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ipvsadm -Ln</span><br><span class="line">  # IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">  # Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  #   -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">  # TCP  10.10.107.202:31855 rr</span><br><span class="line">  #   -&gt; 10.244.1.5:80                Masq    1      0          1</span><br><span class="line">  #   -&gt; 10.244.1.6:80                Masq    1      1          1</span><br><span class="line">  #   -&gt; 10.244.1.7:80                Masq    1      0          1</span><br><span class="line">  # TCP  10.96.0.1:443 rr</span><br><span class="line">  #   -&gt; 10.10.107.202:6443           Masq    1      3          0</span><br><span class="line">  # TCP  10.96.0.10:53 rr</span><br><span class="line">  #   -&gt; 10.244.0.4:53                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.0.5:53                Masq    1      0          0</span><br><span class="line">  # TCP  10.96.0.10:9153 rr</span><br><span class="line">  #   -&gt; 10.244.0.4:9153              Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.0.5:9153              Masq    1      0          0</span><br><span class="line">  # TCP  10.99.90.247:30000 rr</span><br><span class="line">  #   -&gt; 10.244.1.5:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.6:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.7:80                Masq    1      0          0</span><br><span class="line">  # TCP  127.0.0.1:31855 rr</span><br><span class="line">  #   -&gt; 10.244.1.5:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.6:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.7:80                Masq    1      0          0</span><br><span class="line"></span><br><span class="line"># 基于RR轮训负载</span><br><span class="line">Hostname: nginx-deployment-7f5d9779c6-dr5h8 Image Version: 2.2 Nginx Version: 1.19.4 </span><br><span class="line">Hostname: nginx-deployment-7f5d9779c6-sk2f4 Image Version: 2.2 Nginx Version: 1.19.4 </span><br><span class="line">Hostname: nginx-deployment-7f5d9779c6-hhl7k Image Version: 2.2 Nginx Version: 1.19.4</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=3-Kubernetes入门之Ubuntu安装部署集群 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201107003214.png" target="_blank" title="WeiyiGeek.rr轮休机制" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201107003214.png" alt="WeiyiGeek.rr轮休机制" title="" class=""></a>
                <p>WeiyiGeek.rr轮休机制</p>
            </figure>

        </div>
        <!-- Google 广告 -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-06-15T03:03:27.124Z" itemprop="dateUpdated">2022-06-15 11:03:27</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/虚拟云容/云容器/Kubernetes/3-Kubernetes入门之Ubuntu安装部署集群.md" target="_blank" rel="noopener noreferrer">_posts/虚拟云容/云容器/Kubernetes/3-Kubernetes入门之Ubuntu安装部署集群.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2020/4-27-470.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/4-27-470.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=《3-Kubernetes入门之Ubuntu安装部署集群》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=《3-Kubernetes入门之Ubuntu安装部署集群》 — WeiyiGeek Blog&source=WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《3-Kubernetes入门之Ubuntu安装部署集群》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/4-27-470.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/4-28-203.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Ubuntu-20.04-LTS(桌面与服务器)版基础配置</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/4-27-530.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">11-Kubernetes进阶之原理架构学习及操作配置</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-基础环境准备"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 基础环境准备</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-环境说明"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.环境说明</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-环境操作"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.环境操作</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-单实例K8s集群部署-v1-20-1"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 单实例K8s集群部署(v1.20.1)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Master-节点初始化"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.Master 节点初始化</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-集群管理"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.集群管理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-集群网络插件安装"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.集群网络插件安装</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-工作节点加入"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.工作节点加入</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-Token-失效重生成"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">4.Token 失效重生成</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-节点重置"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">5.节点重置</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-高可用K8s集群部署-v1-19-6"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 高可用K8s集群部署(v1.19.6)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-1-高可用组件安装所有Master节点通过apt安装HAProxy和KeepAlived"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Step 1.高可用组件安装所有Master节点通过apt安装HAProxy和KeepAlived</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-2-所有Master节点配置HAProxy"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">Step 2.所有Master节点配置HAProxy</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-3-配置KeepAlived健康检查文件"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Step 3.配置KeepAlived健康检查文件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-4-启动haproxy和keepalived以及测试VIP"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">Step 4.启动haproxy和keepalived以及测试VIP</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-5-集群安装其它指定版本"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">Step 5.集群安装其它指定版本</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-6-集群初始化的yaml文件"><span class="post-toc-number">4.6.</span> <span class="post-toc-text">Step 6.集群初始化的yaml文件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-7-Kubernetes-集群访问配置"><span class="post-toc-number">4.7.</span> <span class="post-toc-text">Step 7.Kubernetes 集群访问配置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-8-现在应该将pod网络部署到集群-此处选用calico网络插件而非使用flannel插件"><span class="post-toc-number">4.8.</span> <span class="post-toc-text">Step 8.现在应该将pod网络部署到集群,此处选用calico网络插件而非使用flannel插件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-9-高可用Master初始化，将其他master节点加入集群控制平面"><span class="post-toc-number">4.9.</span> <span class="post-toc-text">Step 9.高可用Master初始化，将其他master节点加入集群控制平面</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-10-工作节点或者负载加入到集群中"><span class="post-toc-number">4.10.</span> <span class="post-toc-text">Step 10.工作节点或者负载加入到集群中</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-11-集群状态查看-amp-镜像查看"><span class="post-toc-number">4.11.</span> <span class="post-toc-text">Step 11.集群状态查看 &amp; 镜像查看</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-高可用集群使用初体验"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 高可用集群使用初体验</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- 微信公众号关注/文章版权复制 -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好看友,欢迎关注博主微信公众号哟! ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】即可关闭继续浏览文章.<br>  <b style="color:red;"> 温馨提示: 未解锁的用户不能粘贴复制文章内容哟!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">博主Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">博主Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">墨天轮</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">西瓜视频</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=《3-Kubernetes入门之Ubuntu安装部署集群》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=《3-Kubernetes入门之Ubuntu安装部署集群》 — WeiyiGeek Blog&source=WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《3-Kubernetes入门之Ubuntu安装部署集群》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/4-27-470.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKUlEQVR42u3aQXLjMAwEwPz/09rrVm1FmQFtZ0U2TyonFtk6wBCAr694XX+t5K/XP+u7b+W7vGBhYGA8lnHdrnyD5FsJ6f5xfHsSDAyMAxj5re8fQfKA7ndp2RgYGBgtIznW/Z0xMDAw1hlFuha8oP5awMXAwHggIwmds3RwpTz3lndxDAyMBzLyqvvnr9/S38DAwHgU4yrXZ/qG9akwMDC2ZuQBbpbMrYxu1MMfGBgYRzKS19TZQfMCXP4JBgbGrow2HcwL923Rv2121hkuBgbGYxl52jfbYL1hWfwYYGBgbMpItmnHL5JSWh6aozNgYGBszZgV+tsxrzy5zJFLTU0MDIxHMdqgOQOvNwN++BYGBsYBjOSIbWszL6Lln0dVQwwMjO0Ys6Tt/tZt0vmCeiEGBsYxjBaW8FYKbe2gGAYGxq6MtjHZstsC3LD9iYGBcQxj1irIRzFmexW/DBgYGFszZhllfvSVkbLobBgYGFsz8nRtpRDWltjaEQ0MDIxzGMMwVxbdZsE6ehAYGBgHMJICWf76OivV5dcYGBgnM/Km4yyMDgcm2pdYDAyMjRhXuVYYbZAtWqoYGBhbM141IpZfJ0eZ3Q0DA2NvxqxAlrcKZtX7PD3FwMA4h5EHvvUG5GxA7QckBgYGRtk8aANui49mRjAwMDDKQlgyxtH+z4cCLgYGxn/DaJsBeSl/Jby+pdyGgYHxQMbKpMbKy+dKkW7YyMTAwHge4w/LxdE/xIKo6QAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// 站点运行时间
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "天" + RunHours + "时" + RunMinutes + "分" + RunSeconds + "秒";
  document.getElementById(id).innerHTML = "网站已在风雨中勉勉强强运行了【" + RunTime + "】";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>