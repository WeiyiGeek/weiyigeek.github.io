{"title":"n0.Docker容器安装运行所遇异常解决","slug":"虚拟云容/云容器/Docker/n0.Docker安装运行所遇异常解决","date":"2019-06-05T11:36:30.000Z","updated":"2023-01-31T02:29:10.643Z","url":"2019/6-5-464.html","path":"api/articles/2019/6-5-464.html.json","covers":["https://img.weiyigeek.top/2020/1/20200522172323.png","https://img.weiyigeek.top/2020/1/20200618092627.png","https://img.weiyigeek.top/2020/1/20200702100012.png","https://img.weiyigeek.top/2020/1/20200119225043.png","https://img.weiyigeek.top/2020/1/20200324151810.png","https://img.weiyigeek.top/2021/5/20210604214310.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-Docker-目录与路径\"><a href=\"#0x00-Docker-目录与路径\" class=\"headerlink\" title=\"0x00 Docker 目录与路径\"></a>0x00 Docker 目录与路径</h4><p><strong>CentOS7:默认的Docker安装目录以及配置文件</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Systemctl 启动项参数</span></span><br><span class=\"line\">/etc/systemd/system/docker.service</span><br><span class=\"line\">/usr/lib/systemd/system/docker.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Docker 元数据目录</span></span><br><span class=\"line\">/var/lib/docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Docker Deamon启动项</span></span><br><span class=\"line\">/etc/sysconfig/docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Docker daemon.json 参数</span></span><br><span class=\"line\">/etc/docker/daemon.json</span><br><span class=\"line\">/root/.docker/config.json</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Ubuntu:snap安装的Docker</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 全局配置</span></span><br><span class=\"line\">/var/snap/docker</span><br><span class=\"line\">/var/snap/docker/current/  <span class=\"comment\"># docker 启动配置</span></span><br><span class=\"line\">config/ etc/  run/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用户配置</span></span><br><span class=\"line\">/root/snap/docker</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x01-常规基础配置\"><a href=\"#0x01-常规基础配置\" class=\"headerlink\" title=\"0x01 常规基础配置\"></a>0x01 常规基础配置</h4><p><strong>.Docker日志设置定期清理</strong><br>1) 设置容器为3个日志文件容，分别是<code>id+.json、id+1.json、id+2.json</code>,但是此时只对新建的容器有效；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/docker/daemon.json &lt;&lt; <span class=\"string\">'EOF'</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"string\">\"registry-mirrors\"</span>: [</span><br><span class=\"line\"><span class=\"string\">\"https://kfwkfulq.mirror.aliyuncs.com\"</span>,</span><br><span class=\"line\"><span class=\"string\">\"https://2lqq34jg.mirror.aliyuncs.com\"</span>,</span><br><span class=\"line\"><span class=\"string\">\"https://pee6w651.mirror.aliyuncs.com\"</span>,</span><br><span class=\"line\"><span class=\"string\">\"https://registry.docker-cn.com\"</span>,</span><br><span class=\"line\"><span class=\"string\">\"http://hub-mirror.c.163.com\"</span></span><br><span class=\"line\">],</span><br><span class=\"line\">  <span class=\"string\">\"dns\"</span>: [<span class=\"string\">\"114.114.114.114\"</span>,<span class=\"string\">\"8.8.4.4\"</span>],</span><br><span class=\"line\">  <span class=\"string\">\"log-driver\"</span>:<span class=\"string\">\"json-file\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"log-opts\"</span>:&#123; <span class=\"string\">\"max-size\"</span> :<span class=\"string\">\"100m\"</span>,<span class=\"string\">\"max-file\"</span>:<span class=\"string\">\"1\"</span>&#125;,</span><br><span class=\"line\">  <span class=\"string\">\"ipv6\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">\"fixed-cidr-v6\"</span>: <span class=\"string\">\"2001:db8:1::/64\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl restart docker</span><br></pre></td></tr></table></figure></p>\n<p>2) 清理已存在的容器日志(全部容器)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#容器日志一般存放在/var/lib/docker下面</span></span><br><span class=\"line\">ls -lh $(find /var/lib/docker/containers/ -name *-json.log)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#方法1：</span></span><br><span class=\"line\">find /var/lib/docker/containers/ -name *-json.log -<span class=\"built_in\">exec</span> truncate -s 0 &#123;&#125; \\;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#方法2：(已经停止的容器)</span></span><br><span class=\"line\">find /var/lib/docker/containers/ -name *-json.log -<span class=\"built_in\">exec</span> cat /dev/null &gt; &#123;&#125; \\;</span><br></pre></td></tr></table></figure></p>\n<p>如果docker容器正在运行，那么使用rm -rf 方式删除日志后，通过df -h会发现磁盘空间并没有释放;</p>\n<p>原因：在Linux或者Unix系统中，通过rm或者文件管理器删除文件将会从文件系统的目录结构上解除链接(unlink).然而如果文件是被打开的（有一个进程正在使用），那么进程将仍然可以读取该文件，磁盘空间也一直被占用</p>\n<h5 id=\"1-如何进行-Docker-默认存储位置修改\"><a href=\"#1-如何进行-Docker-默认存储位置修改\" class=\"headerlink\" title=\"1.如何进行 Docker 默认存储位置修改?\"></a>1.如何进行 Docker 默认存储位置修改?</h5><p>描述:默认情况下Docker的存放位置为 <code>/var/lib/docker</code> , 具体的位置可以通过<code>sudo docker info | grep &quot;Docker Root Dir&quot;</code>查看。</p>\n<p>方式1:通过软连接来实现，启动Docker时发现存储目录依旧是<code>/var/lib/docker</code>但是实际上是存储在数据盘的(容量变化)。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop docker</span><br><span class=\"line\"><span class=\"comment\">#方式1.软连接</span></span><br><span class=\"line\">mv /var/lib/docker /disk/docker</span><br><span class=\"line\">ln -s /disk/docker /var/lib/docker  <span class=\"comment\">#目标 软连接</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#方式2.打包docker目录 </span></span><br><span class=\"line\">sudo tar -czvf /usr/docker.tar.gz docker/</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /disk/ &amp;&amp; sudo tar -xzvf docker.tar.gz</span><br></pre></td></tr></table></figure></p>\n<p>方式2:改镜像和容器的存放路径即我们需要修改配置文件指定启动参数即可，指定镜像和容器存放路径的参数是<code>--graph=/var/lib/docker</code>,由于在docker.service中加载下面到环境变量中，最后一张图即可明了(可将下面几种方式看作一种)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(1)注意:发行版本的异同,修改后重启即可</span></span><br><span class=\"line\">Ubuntu: /etc/default/docker</span><br><span class=\"line\">OPTIONS=<span class=\"string\">'--graph=\"/disk/docker\" -H fd://'</span>  <span class=\"comment\"># 或者DOCKER_OPTS=\"-g /disk/docker\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">CentOS6: /etc/sysconfig/docker</span><br><span class=\"line\">OPTIONS=<span class=\"string\">'--graph=\"/disk/docker\" --selinux-enabled -H fd://'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(2) 配置文件位置(不推荐此种方式)</span></span><br><span class=\"line\"><span class=\"comment\">#/usr/lib/docker-storage-setup/docker-storage-setup或者/etc/sysconfig/docker-storage-setup、/etc/sysconfig/docker-storage</span></span><br><span class=\"line\">DOCKER_STORAGE_OPTIONS=--graph=<span class=\"string\">\"要保存的路径\"</span></span><br><span class=\"line\"><span class=\"comment\">#限制性默认值，例如100GB最大存储空间。</span></span><br><span class=\"line\">DATA_SIZE=800GB <span class=\"comment\">#更改docker默认存储大小</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实际上都是依托于下述文件的加载我们可以直接在ExecStart启动中指定docker挂的存储位置所以看作一种修改方式）;</span></span><br><span class=\"line\">CentOS7: /usr/lib/systemd/system/docker.service  </span><br><span class=\"line\">EnviromentFile=-/etc/sysconfig/docker</span><br><span class=\"line\">Environment=GRAPH=/disk/docker</span><br><span class=\"line\">ExecStart=/usr/bin/dockerd --graph=/disk/docker <span class=\"variable\">$GRAPH</span> <span class=\"variable\">$OPTIONS</span> </span><br><span class=\"line\">systemctl daemon-reload           <span class=\"comment\"># reload配置文件  </span></span><br><span class=\"line\">systemctl restart docker.service  <span class=\"comment\"># 重启docker</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200522172323.png\" alt=\"WeiyiGeek.docker\" title=\"\" class=\"\">\n                <p>WeiyiGeek.docker</p>\n            </figure></p>\n<p>方式4:如果docker是1.12或以上的版本可以修改（或新建）<code>/etc/docker/daemon.json</code>文件<br>该方式的优点修改后会立即生效，不需重启docker服务。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/docker/daemon.json </span><br><span class=\"line\">&#123;<span class=\"string\">\"registry-mirrors\"</span>: [<span class=\"string\">\"http://7e61f7f9.m.daocloud.io\"</span>],<span class=\"string\">\"graph\"</span>: <span class=\"string\">\"/disk/docker\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"2-如果进行容器日志文件的分割\"><a href=\"#2-如果进行容器日志文件的分割\" class=\"headerlink\" title=\"2.如果进行容器日志文件的分割?\"></a>2.如果进行容器日志文件的分割?</h5><p>描述:除了docker image 时间长了会占用大量磁盘空间外，容器在运行时大量写日志也是个很头疼的问题，而且在没有任何监控预警的情况下业务随时都会宕掉(至少我遇到过1次)。</p>\n<p>默认情况下(JSON File logging drive )，Docker捕获所有容器的标准输出(和标准错误)，并使用JSON格式将其写入文件中,对于应用的标准输出(stdout)日志，Docker Daemon 在运行这个容器时就会创建一个协程(goroutine)，负责标准输出日志。<br>由于此 goroutine 绑定了<code>整个容器内所有进程的标准输出文件描述</code>符，因此容器内应用的所有标准输出日志都会被 goroutine 接收并写入与此容器—对应的日志文件中,即日志文件位于<code>/var/lib/docker/containers/&lt;container_id&gt;/文件名为-json.log</code></p>\n<p>Docker 则通过 docker logs 命令向用户提供日志接口,其实现原理的本质均基于与容器一一对应的-json.log,(<code>kubectl logs类似</code>)<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200618092627.png\" alt=\"WeiyiGeek.goroutine\" title=\"\" class=\"\">\n                <p>WeiyiGeek.goroutine</p>\n            </figure></p>\n<p>针对日志文件过大的几种解决办法:</p>\n<ul>\n<li>堵: 限定一个容器最多使用多少磁盘空间;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#docker的storage-driver是overlay2时，限制单个容器可占用的磁盘空间</span></span><br><span class=\"line\">- 1.xfs，linux 文件系统 CentOS 7开始，预设的文件系统由原来的EXT4变成了XFS文件系统</span><br><span class=\"line\">- 2.pquot(project quotas )SystemXFS支持按用户、组和项目设置磁盘配额。项目磁盘配额允许您限制单个目录层次结构上的磁盘空间数量。</span><br><span class=\"line\"><span class=\"comment\"># mount 时 指定文件系统类型，使用-o enbale project quotas</span></span><br><span class=\"line\">mount –o prjquota /dev/xvdb1 /xfs</span><br><span class=\"line\"><span class=\"comment\"># 限定 project=test 的 /data 目录 soft limit=5M hard limit=6M</span></span><br><span class=\"line\">xfs_quota –x –c <span class=\"string\">'limit –p bsoft=5m bhard=6m test'</span> /data</span><br></pre></td></tr></table></figure></li>\n<li>疏: 以特定用户运行项目，该容器内用户只可以访问特定的文件夹，比如/logs，然后将容器/logs 映射到物理机上，定时清理;</li>\n<li>监控: 时监控磁盘，异常时报警;执行<code>docker system df -v</code>可以列出每个容器占用的 磁盘空间，当期大小超过一定阈值时，可以根据container id（想办法将container id 与应用信息关联起来）将其删除<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(1)Images space usage:</span><br><span class=\"line\">REPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE                SHARED SIZE         UNIQUE SIZE         CONTAINERS</span><br><span class=\"line\">onlyoffice/documentserver   latest              d06214a03e27        2 months ago        2.145GB             0B                  2.145GB             1</span><br><span class=\"line\"></span><br><span class=\"line\">(2)Containers space usage:</span><br><span class=\"line\">CONTAINER ID        IMAGE                       COMMAND                  LOCAL VOLUMES       SIZE                CREATED             STATUS                NAMES</span><br><span class=\"line\">d415211e52da        onlyoffice/documentserver   <span class=\"string\">\"/bin/sh -c /app/ds/…\"</span>   6                   986MB               4 weeks ago         Up 3 days             onlyoffice</span><br><span class=\"line\"></span><br><span class=\"line\">(4)Local Volumes space usage:</span><br><span class=\"line\">VOLUME NAME                                                        LINKS               SIZE</span><br><span class=\"line\">a4974599165f539b98fd57fc53ccc073a7e8cdf4cd36cbc5e349fb8d4f6a1325   0                   2.51MB</span><br><span class=\"line\"></span><br><span class=\"line\">(5)Build cache usage: 0B</span><br><span class=\"line\">CACHE ID            CACHE TYPE          SIZE                CREATED             LAST USED           USAGE               SHARED</span><br></pre></td></tr></table></figure></li>\n<li>日志由日志采集工具收集，不在磁盘上停留;</li>\n</ul>\n<p>实操解决:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1.清空停止的容器以及卷包括日志/容器/网络/镜像(以释放空间-尽量在缺订需要的容器)</span></span><br><span class=\"line\">docker system prune -af</span><br><span class=\"line\"><span class=\"comment\"># Deleted Containers:</span></span><br><span class=\"line\"><span class=\"comment\"># 9c8a4f60ad62cee63c7d5b48041e29363ee4f839aedb2cec9a76df3e6ccda2e8</span></span><br><span class=\"line\"><span class=\"comment\"># 2d5cca572c06e11a6a2005cd46d154b71bad151610ce074424a32850aedb2b39</span></span><br><span class=\"line\"><span class=\"comment\"># 8c78c868d29285afeb00eb617d0a8e3280b6da2f69bf8dd42e04a8e334d3ae22</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Deleted Networks:</span></span><br><span class=\"line\"><span class=\"comment\"># blog_default</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Deleted Images:</span></span><br><span class=\"line\"><span class=\"comment\"># untagged: snipe/snipe-it:latest</span></span><br><span class=\"line\"><span class=\"comment\"># untagged: snipe/snipe-it@sha256:7a61e8a407490b9e99c758a18ba814c10fe55f1465e036bfd1ee5445537c7661</span></span><br><span class=\"line\"><span class=\"comment\"># Total reclaimed space: 1.096GB</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2./etc/docker/daemon.json 经创建了的容器该选项的修改【重启daemon】是无法生效的,只对新建立的容器有效;</span></span><br><span class=\"line\"><span class=\"string\">\"log-driver\"</span>:<span class=\"string\">\"json-file\"</span>,</span><br><span class=\"line\"><span class=\"string\">\"log-opts\"</span>: &#123;<span class=\"string\">\"max-size\"</span>:<span class=\"string\">\"500m\"</span>, <span class=\"string\">\"max-file\"</span>:<span class=\"string\">\"3\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">docker inspect -f <span class=\"string\">'&#123;&#123;.HostConfig.LogConfig&#125;&#125;'</span> test1</span><br><span class=\"line\"><span class=\"comment\"># &#123;json-file map[max-file:10 max-size:2m]&#125;</span></span><br><span class=\"line\">more /var/lib/docker/containers/25d2d645bfc9e6530039d6aac890f69dd9af33f8f966adc2d7287b74964678e3/25d2d645bfc9e6530039d6aac890f69dd9af33f8f966adc2d7287b74964678e3-json.log</span><br><span class=\"line\"><span class=\"comment\"># &#123;\"log\":\"Mem: 3164836K used, 696576K free, 45448K shrd, 2104K buff, 1633504K cached\\n\",\"stream\":\"stdout\",\"time\":\"2020-06-18T03:34:33.738111441Z\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"log\":\"CPU:   0% usr   0% sys   0% nic 100% idle   0% io   0% irq   0% sirq\\n\",\"stream\":\"stdout\",\"time\":\"2020-06-18T03:34:33.73833528Z\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"log\":\"Load average: 0.16 0.20 0.19 1/639 5\\n\",\"stream\":\"stdout\",\"time\":\"2020-06-18T03:34:33.738342617Z\"&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例3.将每个容器可以使用的磁盘空间设置为1G：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"data-root\"</span>: <span class=\"string\">\"/data/docker\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-driver\"</span>: <span class=\"string\">\"overlay2\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-opts\"</span>: [</span><br><span class=\"line\">  <span class=\"string\">\"overlay2.override_kernel_check=true\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"overlay2.size=1G\"</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例4.清理日志文件</span></span><br><span class=\"line\"><span class=\"comment\"># 通过rm -rf或者文件管理器删除文件，将会从文件系统的目录结构上解除链接（unlink）前提是容器是停止的状态，否则如果该文件被进程占用，磁盘空间也一直被占用。</span></span><br><span class=\"line\">cat /dev/null &gt;/var/lib/docker/containers/&lt;container_id&gt;/containerid-json.log</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"3-如何配置Docker-Deamon能被Docker-Client远程链接\"><a href=\"#3-如何配置Docker-Deamon能被Docker-Client远程链接\" class=\"headerlink\" title=\"3.如何配置Docker Deamon能被Docker Client远程链接?\"></a>3.如何配置Docker Deamon能被Docker Client远程链接?</h5><p>答: 我们需要在docker.service配置文件中进行更改dockerd的启动参数中添加<code>-H tcp://0.0.0.0:2375</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改启动参数</span></span><br><span class=\"line\">nano /usr/lib/systemd/system/docker.service</span><br><span class=\"line\">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重载守护进程与重启docker</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看监听情况</span></span><br><span class=\"line\">netstat -tlnp</span><br><span class=\"line\"><span class=\"comment\"># Active Internet connections (only servers)</span></span><br><span class=\"line\"><span class=\"comment\"># Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span></span><br><span class=\"line\"><span class=\"comment\"># tcp6       0      0 :::2375                 :::*                    LISTEN      11389/dockerd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 简单验证远程访问</span></span><br><span class=\"line\">curl http://127.0.0.1:2375/containers/json | jq</span><br><span class=\"line\">[</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Id\"</span>: <span class=\"string\">\"25d2d645bfc9e6530039d6aac890f69dd9af33f8f966adc2d7287b74964678e3\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Names\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"/test1\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"test1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"ImageID\"</span>: <span class=\"string\">\"sha256:5ec0e2b89f7aadb6178c17b3db73aba2e209f9556a436562de7f32b077b776bd\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Command\"</span>: <span class=\"string\">\"top -b -d 2\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Created\"</span>: 1592451272,</span><br><span class=\"line\">    <span class=\"string\">\"Ports\"</span>: [],</span><br><span class=\"line\">    <span class=\"string\">\"Labels\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"Author\"</span>: <span class=\"string\">\"WeiyiGeek\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"Description\"</span>: <span class=\"string\">\"Test Dockerfile\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"State\"</span>: <span class=\"string\">\"running\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Status\"</span>: <span class=\"string\">\"Up 35 minutes\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"HostConfig\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"NetworkMode\"</span>: <span class=\"string\">\"default\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"NetworkSettings\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"Networks\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"bridge\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"IPAMConfig\"</span>: null,</span><br><span class=\"line\">          <span class=\"string\">\"Links\"</span>: null,</span><br><span class=\"line\">          <span class=\"string\">\"Aliases\"</span>: null,</span><br><span class=\"line\">          <span class=\"string\">\"NetworkID\"</span>: <span class=\"string\">\"257f6a8500710d76efba6a1c9be8c0f10b4308afb481baf1e9ba77cf98f596bd\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"EndpointID\"</span>: <span class=\"string\">\"ac4518815359da7b8182167dfeeec728c0ea51accd1736719005f1596797e944\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"Gateway\"</span>: <span class=\"string\">\"172.17.0.1\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"IPAddress\"</span>: <span class=\"string\">\"172.17.0.2\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"IPPrefixLen\"</span>: 16,</span><br><span class=\"line\">          <span class=\"string\">\"IPv6Gateway\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"GlobalIPv6Address\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"GlobalIPv6PrefixLen\"</span>: 0,</span><br><span class=\"line\">          <span class=\"string\">\"MacAddress\"</span>: <span class=\"string\">\"02:42:ac:11:00:02\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"DriverOpts\"</span>: null</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"Mounts\"</span>: []</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200702100012.png\" alt=\"WeiyiGeek.Dockerd-TCP\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Dockerd-TCP</p>\n            </figure></p>\n<p><br></p>\n<h5 id=\"4-修改正在运行的容器其映射端口\"><a href=\"#4-修改正在运行的容器其映射端口\" class=\"headerlink\" title=\"4.修改正在运行的容器其映射端口?\"></a>4.修改正在运行的容器其映射端口?</h5><p>描述:正在运行的容器修改其映射端口的方式推荐方式2与方式3，端口修改；</p>\n<ul>\n<li>方式1:停止并删除该容器然后新建立一个全新容器(<code>最简单方案,在测试环境中常常使用一下</code>)</li>\n<li>方式2:利用<code>docker commit</code>新构镜像把一个容器的文件改动和配置信息commit到一个新的镜像，然后用这个新的镜像重起一个容器，该方法的优点是该方式不会对宿主机上的其它容器有任何影响;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stop container01</span><br><span class=\"line\">docker commit container01 new_image:tag</span><br><span class=\"line\">docker run --name container02 -p 80:80 new_image:tag</span><br></pre></td></tr></table></figure></li>\n<li>方式3:修改容器配置文件然后重启docker服务即可<ul>\n<li>优点:是<code>没有副作用，操作简单</code>。</li>\n<li>缺点:是需要停止容器以及重启docker服务，如果在同一个宿主机上运行着多个容器服务的话，就会影响其他容器服务。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$nano</span> /var/lib/docker/containers/d415211e52da6ca66aeee3c81b38be609ffac59522b06e0ff9fa253e29fa441a/hostconfig.json</span><br><span class=\"line\"><span class=\"comment\">#将需要映射的端口，按照以下json格式进行设置</span></span><br><span class=\"line\"><span class=\"string\">\"PortBindings\"</span>:&#123;</span><br><span class=\"line\">  <span class=\"string\">\"443/tcp\"</span>:[&#123;<span class=\"string\">\"HostIp\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"HostPort\"</span>:<span class=\"string\">\"9000\"</span>&#125;],</span><br><span class=\"line\">  <span class=\"string\">\"80/tcp\"</span>:[&#123;<span class=\"string\">\"HostIp\"</span>:<span class=\"string\">\"\"</span>,<span class=\"string\">\"HostPort\"</span>:<span class=\"string\">\"9001\"</span>&#125;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$ docker stop onlyoffice</span><br><span class=\"line\">$ systemctl restart docker &amp;&amp; docker start onlyoffice</span><br><span class=\"line\">$ docker ps</span><br><span class=\"line\">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                             PORTS                                                 NAMES</span><br><span class=\"line\">d415211e52da        onlyoffice/documentserver   <span class=\"string\">\"/bin/sh -c /app/ds/…\"</span>   43 minutes ago      Up 14 seconds                      0.0.0.0:9001-&gt;80/tcp, 0.0.0.0:9000-&gt;443/tcp           onlyoffice</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<h5 id=\"5-本地的镜像文件都存放在哪里？\"><a href=\"#5-本地的镜像文件都存放在哪里？\" class=\"headerlink\" title=\"5.本地的镜像文件都存放在哪里？\"></a>5.本地的镜像文件都存放在哪里？</h5><p>答：与 Docker 相关的本地资源默认存放在 /var/lib/docker/ 目录下，默认以 overlay2 文件系统为例<br>其中 container 目录存放容器信息，graph 目录存放镜像信息，aufs 目录下存放具体的镜像层文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ll</span> /var/lib/docker/image/overlay2/distribution/diffid-by-digest/sha256/</span><br><span class=\"line\">总用量 16</span><br><span class=\"line\">-rw-r--r-- 1 root root 71 6月   4 15:15 3c78d525c5d6e0101e4f53d5e4ee827c838b9d346f44e40db49c66638040d980</span><br><span class=\"line\">-rw-r--r-- 1 root root 71 6月   4 15:15 44559339aea968e196d4930b3d79068926964f415c0fccd3e1b197a5dd928ee7</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"6-如何给容器指定一个固定-IP-地址，而不是每次重启容器-IP-地址都会变？\"><a href=\"#6-如何给容器指定一个固定-IP-地址，而不是每次重启容器-IP-地址都会变？\" class=\"headerlink\" title=\"6.如何给容器指定一个固定 IP 地址，而不是每次重启容器 IP 地址都会变？_\"></a>6.如何给容器指定一个固定 IP 地址，而不是每次重启容器 IP 地址都会变？_</h5><p>答：自定义建立网络设置固定的子网以及容器固定IP<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker network create -d bridge --subnet 172.25.0.0/16 my-net</span><br><span class=\"line\">$ docker run --network=my-net --ip=172.25.3.3 -itd --name=my-container busybox</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"7-修改已创建的镜像或者正在运行的容器中存储挂载的路径\"><a href=\"#7-修改已创建的镜像或者正在运行的容器中存储挂载的路径\" class=\"headerlink\" title=\"7.修改已创建的镜像或者正在运行的容器中存储挂载的路径?\"></a>7.修改已创建的镜像或者正在运行的容器中存储挂载的路径?</h5><p>描述:修改已经创建的镜像或者正在运行的容器中的新挂载的路径相关操作流程;<br>流程如下:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.停止docker容器和服务</span></span><br><span class=\"line\">sudo docker stop $(docker ps -a | awk <span class=\"string\">'&#123; print $1&#125;'</span> | tail -n +2)</span><br><span class=\"line\">sudo service docker stop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.备份容器配置文件 </span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /var/lib/docker/containers/de9c6501cdd3</span><br><span class=\"line\">cp hostconfig.json&#123;,.bak&#125;</span><br><span class=\"line\">cp config.v2.json&#123;,.bak&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.修改hostconfig的冒号前的配置路径 </span></span><br><span class=\"line\">cat -n hostconfig.json | grep -C 5 <span class=\"string\">\"Binds\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.修改config的Source的配置路径 </span></span><br><span class=\"line\">cat config.v2.json</span><br><span class=\"line\"><span class=\"string\">\"MountPoints\"</span>: &#123;</span><br><span class=\"line\">  <span class=\"string\">\"/etc/mysql/my.cnf\"</span>: &#123;</span><br><span class=\"line\">  <span class=\"string\">\"Source\"</span>: <span class=\"string\">\"/home/server/mysql/conf/my.cnf\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"Destination\"</span>: <span class=\"string\">\"/etc/mysql/my.cnf\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"RW\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">\"Name\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"Driver\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"Relabel\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"Propagation\"</span>: <span class=\"string\">\"rprivate\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"Named\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"ID\"</span>: <span class=\"string\">\"\"</span></span><br><span class=\"line\">&#125;,....</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#5.然后启动docker服务即可</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"8-如何进入-Docker-容器的网络命名空间\"><a href=\"#8-如何进入-Docker-容器的网络命名空间\" class=\"headerlink\" title=\"8.如何进入 Docker 容器的网络命名空间?\"></a>8.如何进入 Docker 容器的网络命名空间?</h5><p>描述:Docker 在创建容器后删除了宿主主机上 /var/run/netns 目录中的相关的网络命名空间文件。<br>因此，在宿主主机上是无法看到或访问容器的网络命名空间的。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#以下操作可以查看并设置网络命名空间</span></span><br><span class=\"line\">$ docker inspect --format=<span class=\"string\">'&#123;&#123;. State.Pid&#125;&#125; '</span> <span class=\"variable\">$container_id</span>  <span class=\"comment\">#获取容器进程ID</span></span><br><span class=\"line\">1234</span><br><span class=\"line\">$ sudo ln -s /proc/1234/ns/net /var/run/netns/ <span class=\"comment\">#在proc目录下把对应的网络命名空间文件链接到 /var/run/netns 目录。</span></span><br><span class=\"line\"><span class=\"comment\">#然后，在宿主主机上就可以看到容器的网络命名空间信息。例如**</span></span><br><span class=\"line\">$ sudo ip netns show</span><br><span class=\"line\">1234</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置操作容器的命名空间</span></span><br><span class=\"line\">$ sudo ip netns <span class=\"built_in\">exec</span> 1234 ifconfig eth0 172.17.0.100/16</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"9-如何重置-Docker-本地数据？\"><a href=\"#9-如何重置-Docker-本地数据？\" class=\"headerlink\" title=\"9.如何重置 Docker 本地数据？\"></a>9.如何重置 Docker 本地数据？</h5><p>$ <code>sudo rm -rf /var/lib/docker</code>  #注意本操作会移除所有的 Docker 本地数据，包括镜像和容器等。</p>\n<hr>\n<h4 id=\"0x02-入坑出坑\"><a href=\"#0x02-入坑出坑\" class=\"headerlink\" title=\"0x02 入坑出坑\"></a>0x02 入坑出坑</h4><p><strong>报错问题0:requires containerd.io &gt;= 1.2.2-3, but none of the providers can be installed</strong><br>环境:CentOS 8 1911(Core)<br>错误问题:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package docker-ce-3:18.09.9-3.el7.x86_64 requires containerd.io &gt;= 1.2.2-3, but none of the providers can be installed</span><br><span class=\"line\">  - conflicting requests</span><br><span class=\"line\">  - package containerd.io-1.2.10-3.2.el7.x86_64 is excluded</span><br><span class=\"line\">  - package containerd.io-1.2.13-3.1.el7.x86_64 is excluded</span><br><span class=\"line\">  - package containerd.io-1.2.2-3.3.el7.x86_64 is excluded</span><br><span class=\"line\">  - package containerd.io-1.2.2-3.el7.x86_64 is excluded</span><br><span class=\"line\">  - package containerd.io-1.2.4-3.1.el7.x86_64 is excluded</span><br><span class=\"line\">  - package containerd.io-1.2.5-3.1.el7.x86_64 is excluded</span><br><span class=\"line\">  - package containerd.io-1.2.6-3.3.el7.x86_64 is excluded</span><br><span class=\"line\">(尝试添加 <span class=\"string\">'--skip-broken'</span> 来跳过无法安装的软件包 或 <span class=\"string\">'--nobest'</span> 来不只使用最佳选择的软件包)</span><br></pre></td></tr></table></figure></p>\n<p>解决方法: </p>\n<ul>\n<li>1）要么就降低docker 的版本</li>\n<li>2）如果不想降低docker 版本，那么就更新 containerd.io 的版本<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y wget</span><br><span class=\"line\">wget https://download.docker.com/linux/centos/7/x86_64/edge/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm</span><br><span class=\"line\">yum install -y containerd.io-1.2.6-3.3.el7.x86_64.rpm</span><br><span class=\"line\">yum install docker-ce docker-ce-cli</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p><strong>报错问题1:Error running DeviceCreate (createSnapDevice) dm_task_run failed</strong><br>错误信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker:Error running DeviceCreate (createSnapDevice) dm_task_run failed</span><br></pre></td></tr></table></figure><br>解决办法: 重新构建资源池元数据即可,<a href=\"https://stackoverflow.com/questions/30719896/docker-dm-task-run-failed-error\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/30719896/docker-dm-task-run-failed-error</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#不同安装路径可能不同</span></span><br><span class=\"line\">service docker stop</span><br><span class=\"line\">thin_check /var/lib/docker/devicemapper/devicemapper/metadata</span><br><span class=\"line\">thin_check --clear-needs-check-flag /var/lib/docker/devicemapper/devicemapper/metadata</span><br><span class=\"line\">service docker start</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>报错问题2:Error response from daemon: devmapper: Error mounting: invalid argument</strong><br>错误信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker start e7e</span><br><span class=\"line\">Error response from daemon: devmapper: Error mounting <span class=\"string\">'/dev/mapper/docker-253:4-11534337-ee772425c4996ca581e5c234806adf41aede9424a83ce1402596105a9f66434d'</span> on <span class=\"string\">'/export/docker/devicemapper/mnt/ee772425c4996ca581e5c234806adf41aede9424a83ce1402596105a9f66434d'</span>: invalid argument</span><br></pre></td></tr></table></figure><br>错误原因:因为selinux enable的时候，创建了该容器。而后修改了/etc/selinux/config 修改成selinux为disabled。<br>物理机重启后selinux处于关闭状态，则原先在selinux enable时候创建的容器就会无法启动报出这种错误。<br>修复方法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">主要有两种：</span><br><span class=\"line\">1.可以将selinux重新置为<span class=\"built_in\">enable</span>然后重启物理机即可修复。</span><br><span class=\"line\">2.修改容器的配置，比如我的容器的配置是/var/lib/docker/containers/e7ef71494940ba293be4b3f74198bf34835c35537810053b051d9a6c33adbd32/config.v2.json文件。将其中的<span class=\"string\">\"MountLabel\"</span>: <span class=\"string\">\"system_u:object_r:svirt_sandbox_file_t:s0:c12,c257\"</span>, <span class=\"string\">\"ProcessLabel\"</span>: <span class=\"string\">\"system_u:system_r:svirt_lxc_net_t:s0:c12,c257\"</span>重修修改为<span class=\"string\">\"MountLabel\"</span>: <span class=\"string\">\"\"</span>, <span class=\"string\">\"ProcessLabel\"</span>: <span class=\"string\">\"\"</span>，然后重新启动docker daemon，容器即可修复。</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>报错问题3: Error response from daemon: devmapper: Thin Pool has 155398 free data blocks which is less than minimum required 163840 free data blocks.</strong><br>错误信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/bin/docker-current: Error response from daemon: devmapper: Thin Pool has 155398 free data blocks <span class=\"built_in\">which</span> is less than minimum required 163840 free data blocks. Create more free space <span class=\"keyword\">in</span> thin pool or use dm.min_free_space option to change behavior</span><br></pre></td></tr></table></figure><br>解决办法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker rm $(sudo docker ps -q -f status=exited)</span><br><span class=\"line\">sudo docker volume rm $(sudo docker volume ls -qf dangling=<span class=\"literal\">true</span>)</span><br><span class=\"line\">sudo docker rmi $(sudo docker images --filter <span class=\"string\">\"dangling=true\"</span> -q --no-trunc)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>报错问题4:[graphdriver] prior storage driver \\”devicemapper\\” failed: devmapper: Base Device UUID and Filesystem verification failed: devmapper: Current Base Device</strong><br>运行环境: CentOS 7.3.1611 , Docker Version 1.12.6-16.el7.centis.x86_64 , API 1.24;<br>报错信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Docker 启动报错</span></span><br><span class=\"line\">docker.service - Docker Application Container Engine</span><br><span class=\"line\">   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)</span><br><span class=\"line\">  Drop-In: /usr/lib/systemd/system/docker.service.d</span><br><span class=\"line\">           └─flannel.conf</span><br><span class=\"line\">  Process: 5226 ExecStart=/usr/bin/dockerd-current --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current --default-runtime=docker-runc --<span class=\"built_in\">exec</span>-opt native.cgroupdriver=systemd --userland-proxy-path=/usr/libexec/docker/docker-proxy-current <span class=\"variable\">$OPTIONS</span> <span class=\"variable\">$DOCKER_STORAGE_OPTIONS</span> <span class=\"variable\">$DOCKER_NETWORK_OPTIONS</span> <span class=\"variable\">$ADD_REGISTRY</span> <span class=\"variable\">$BLOCK_REGISTRY</span> <span class=\"variable\">$INSECURE_REGISTRY</span> (code=exited, status=1/FAILURE)</span><br><span class=\"line\"> Main PID: 5226 (code=exited, status=1/FAILURE)</span><br><span class=\"line\"><span class=\"comment\">#错误关键点</span></span><br><span class=\"line\">dockerd-current[5226]: time=<span class=\"string\">\"...\"</span> level=info msg=<span class=\"string\">\"libcontainerd: new containerd process, pid: 5238\"</span></span><br><span class=\"line\">dockerd-current[5226]: time=<span class=\"string\">\"...\"</span> level=warning msg=<span class=\"string\">\"devmapper: Usage of loopback devices is strongly discouraged for production use. Please use `--storage-opt dm.thinpooldev` or use `man docker` to refer to dm.thinpooldev section.\"</span></span><br><span class=\"line\">node-198 dockerd-current[5226]: time=<span class=\"string\">\"2020-01-18T17:00:27.872191345+08:00\"</span> level=error msg=<span class=\"string\">\"[graphdriver] prior storage driver \\\"devicemapper\\\" failed: devmapper: Base Device UUID and Filesystem verification failed: devmapper: Current Base Device UUID:59df6192-df22-4d88-9e90-02755e7e3242 does not match with stored UUID:24907e3f-5114-4948-91ea-c1a4e92854ef. Possibly using a different thin pool than last invocation\"</span></span><br><span class=\"line\">node-198 dockerd-current[5226]: time=<span class=\"string\">\"2020-01-18T17:00:27.872410561+08:00\"</span> level=fatal msg=<span class=\"string\">\"Error starting daemon: error initializing graphdriver: devmapper: Base Device UUID and Filesystem verification failed: devmapper: Current Base Device UUID:59df6192-df22-4d88-9e90-02755e7e3242 does not match with stored UUID:24907e3f-5114-4948-91ea-c1a4e92854ef. Possibly using a different thin pool than last invocation\"</span></span><br></pre></td></tr></table></figure><br>错误原因:由于存放Docker的Metadata磁盘是挂载上来的,在某次关机的时候存储异常关闭在解决后机器挂载上远程的NFS磁盘,在挂载后磁盘的UUID发生变化，导致通过loopback的方式不能连接到Docker的DeviceMapper的存储池;<br>解决方法:查看实际的loop0的uuid并且修改deviceset-metadata中的UUID<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#查看系统磁盘UUID</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> -alh /dev/disk/by-uuid</span><br><span class=\"line\"><span class=\"variable\">$blkid</span></span><br><span class=\"line\"><span class=\"comment\">#59df6192-df22-4d88-9e90-02755e7e3242</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常规路径</span></span><br><span class=\"line\">/var/lib/docker/devicemapper/metadata/deviceset-metadata</span><br><span class=\"line\"><span class=\"comment\">#自定义的路径</span></span><br><span class=\"line\">/disk/docker/devicemapper/metadata/deviceset-metadata</span><br><span class=\"line\"><span class=\"comment\">#内容设置</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"next_device_id\"</span>:1,<span class=\"string\">\"BaseDeviceUUID\"</span>:<span class=\"string\">\"59df6192-df22-4d88-9e90-02755e7e3242\"</span>,<span class=\"string\">\"BaseDeviceFilesystem\"</span>:<span class=\"string\">\"xfs\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>注意事项:</p>\n<ul>\n<li>目前docker支持的存储驱动类型有<code>aufs/Device mapper/btrfs/overlayfs和zfs</code>并且都采用写时复制（CoW）的技术，但是在CentOS上默认不支持aufs;</li>\n<li>注意:Docker使用的Devicemapper存储驱动的默认模式是loopback的方式，但是它的性能和稳定性都不太好；</li>\n<li>注意:默认它是loop-lvm模式采用空闲文件来构建存储池，建议在生产环境中使用direct-lvm模式;</li>\n</ul>\n<p><br></p>\n<p><strong>报错信息5:Usage of loopback devices is strongly discouraged for production use</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#docker info 或者在启动时候可以看见</span></span><br><span class=\"line\">WARNING: Usage of loopback devices is strongly discouraged <span class=\"keyword\">for</span> production use</span><br></pre></td></tr></table></figure><br>报错原因:用loopback的方式运行docker是强烈不建议的;<br>解决方法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#方式1:在Docker启动项里添加DOCKER_STORAGE_OPTIONS(不推荐,仅仅是忽略警告)</span></span><br><span class=\"line\">DOCKER_STORAGE_OPTIONS=<span class=\"string\">\"--storage-opt dm.no_warn_on_loop_devices=true\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#方式2：在docker daemon启动时，加入device mapper的元数据存储和docker的镜像数据存储选择独立的块设备即可，lvm或者独立磁盘分区都可以</span></span><br><span class=\"line\">--storage-opt dm.datadev=/dev/xxxx  --storage-opt dm.metadatadev=/dev/xxx</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200119225043.png\" alt=\"WeiyiGeek.解决方法\" title=\"\" class=\"\">\n                <p>WeiyiGeek.解决方法</p>\n            </figure></p>\n<p><br></p>\n<p><strong>报错信息6:Docker Deamon服务Socket/TCP无法连接</strong></p>\n<ul>\n<li>(1) 报错信息:ERROR: Couldn’t connect to Docker daemon at http+docker://localunixsocket - is it running?<br>报错原因:由于Docker的守护进程未启动导致本地的UNIX.sock不能成功连接;</li>\n<li>(2) 报错信息:Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock<br>报错原因:由于Docker Deamon启动权限是ROOT用户，而在非root用户下进行连接Docker Server 通信而产生错误;<br>解决方式:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.启动/停止docker：</span></span><br><span class=\"line\">启动             systemctl start docker</span><br><span class=\"line\">守护进程重启      sudo systemctl daemon-reload</span><br><span class=\"line\">重启docker服务    systemctl restart  docker</span><br><span class=\"line\">重启docker服务    sudo service docker restart</span><br><span class=\"line\">关闭docker        service docker stop   </span><br><span class=\"line\">关闭docker        systemctl stop docker</span><br><span class=\"line\"><span class=\"comment\">#2.将当前用户加入docker用户组，然后重新登陆当前用户</span></span><br><span class=\"line\">sudo gpasswd -a <span class=\"variable\">$&#123;USER&#125;</span> docker</span><br><span class=\"line\"><span class=\"comment\">#3.采用高权限用户运行docker</span></span><br><span class=\"line\">sudo systemctl start docker</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>异常信息7:指定容器连接到当前连接以及networks关键字自定义网络,应用任然无法进行相互互联</strong><br>问题:利用Docker-compose部署多个容器时候已设置将指定容器连接到当前连接以及networks关键字自定义网络,应用任然无法进行相互互联;<br>原因:firewalld 的没有信任 docker 的 ip 地址<br>解决方法:将所有 docker 的 ip 添加都白名单即可。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$firewall</span>-cmd  --zone=trusted --add-source=172.17.0.1/16 --permanent</span><br><span class=\"line\">success</span><br><span class=\"line\"><span class=\"variable\">$firewall</span>-cmd  --zone=trusted --add-source=172.20.0.1/16 --permanent</span><br><span class=\"line\">success</span><br><span class=\"line\"><span class=\"variable\">$firewall</span>-cmd --reload</span><br><span class=\"line\">success</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200324151810.png\" alt=\"WeiyiGeek.容器互联\" title=\"\" class=\"\">\n                <p>WeiyiGeek.容器互联</p>\n            </figure>\n<p><br/></p>\n<p><strong>异常信息8: pull images x509 certificate has expired or is not yet valid</strong><br>描述:设置了docker拉取镜像mirro源，拉取下载镜像时候提示证书验证失败;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$sudo</span> docker pull onlyoffice/documentserver</span><br><span class=\"line\">Using default tag: latest</span><br><span class=\"line\">Error response from daemon: Get https://registry-1.docker.io/v2/: x509: certificate has expired or is not yet valid</span><br></pre></td></tr></table></figure><br>错误原因:一般都是本地系统时间错误导致报错证书过期，所以先查看本地系统时间<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$date</span></span><br><span class=\"line\">2019年 05月 19日 星期日 07:57:54 CST</span><br></pre></td></tr></table></figure><br>解决办法:将时间同步至当前时间即可解决:<code>ntpdate cn.pool.ntp.org</code>;</p>\n<p><br/></p>\n<p><strong>异常信息9.执行docker info出现如下警告WARNING: bridge-nf-call-iptables is disabled</strong><br>问题描述:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARNING: bridge-nf-call-iptables is disabled</span><br><span class=\"line\">WARNING: bridge-nf-call-ip6tables is disabled</span><br></pre></td></tr></table></figure><br>解决方法: 配置 iptables 来查看桥接网络流量<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/sysctl.conf&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sysctl -p</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>异常信息10.构建容器镜像提示错误信息standard_init_linux.go:211: exec user process caused “no such file or directory”</strong><br>问题复原:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$docker</span>-compose up</span><br><span class=\"line\">Starting blog ... <span class=\"keyword\">done</span></span><br><span class=\"line\">Attaching to blog</span><br><span class=\"line\">blog    | standard_init_linux.go:211: <span class=\"built_in\">exec</span> user process caused <span class=\"string\">\"no such file or directory\"</span></span><br><span class=\"line\">blog exited with code 1</span><br></pre></td></tr></table></figure><br>问题原因: </p>\n<ul>\n<li>1.docker-compose.yaml 或者 DockerFile 格式不是 <code>unix (/n)</code> 而是 <code>dos (/r/n)</code> 导致的<br>解决办法:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1</span></span><br><span class=\"line\">dos2unix docker-compose.yaml &amp;&amp; dos2unix DockerFile</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p><strong>异常信息11.Error response from daemon: driver failed programming external connectivity on endpoint loving_bassi (37b4c399f676cf46e35fd26b2298ad81aac87739d8aee416f449e36c6cb22503)</strong><br>问题信息:docker: Error response from daemon: driver failed programming external connectivity on endpoint loving_bassi (37b4c399f676cf46e35fd26b2298ad81aac87739d8aee416f449e36c6cb22503):  (iptables failed: iptables –wait -t nat -A DOCKER -p tcp -d 0/0 –dport 90 -j DNAT –to-destination 172.17.0.2:80 ! -i docker0: iptables: No chain/target/match by that name.<br>问题原因: 在 iptables 中的docker0网卡中没有这样的链、目标、规则匹配，即是docker服务启动时定义的自定义链DOCKER由于某种原因被清掉;<br>解决办法: 重启docker服务及可重新生成自定义链DOCKER然后再启动容器;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pkill docker</span></span><br><span class=\"line\"><span class=\"comment\"># iptables -t nat -F</span></span><br><span class=\"line\"><span class=\"comment\"># ifconfig docker0 down</span></span><br><span class=\"line\"><span class=\"comment\"># brctl delbr docker0</span></span><br><span class=\"line\"><span class=\"comment\"># service docker restart</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>异常信息12.使用 docker port 命令映射容器的端口时，系统报错“Error: No public port ‘80’ published for xxx”</strong><br>问题原因:创建镜像时 Dockerfile 要通过 EXPOSE 指定正确的开放端口。<br>解决办法:容器启动时指定 <code>PublishAllPort = true</code>。</p>\n<p><br></p>\n<p><strong>异常信息13.使用内存和 swap 限制启动容器时候报警告：”WARNING: Your kernel does not support cgroup swap limit. WARNING: Your kernel does not support swap limit capabilities. Limitation discarded.”？</strong><br>问题原因:因为系统默认没有开启对内存和 swap 使用的统计功能，引入该功能会带来性能的下降。要开启该功能，可以采取如下操作;<br>解决办法:</p>\n<ul>\n<li>编辑 <code>/etc/default/grub</code> 文件（Ubuntu 系统为例），配置 <code>GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;</code></li>\n<li>更新 grub：<code>$ sudo update-grub</code> 重启系统即可。</li>\n</ul>\n<p><br></p>\n<p><strong>异常信息14.docker警告WARING:No swap limit support</strong><br>问题描述:Linux操作系统下docker内存限制中的警告<code>WARNING: No swap limit support</code>,大概意思就是不支持swap内存的限制；<br>解决办法:已在Ubuntu 20.04 TLS 下测试<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.编辑/etc/default/grub文件。</span></span><br><span class=\"line\">vim /etc/default/grub</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.找到GRUB_CMDLINE_LINUX=配置项，并追加“cgroup_enable=memory swapaccount=1”。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.保存文件并执行一下命令：</span></span><br><span class=\"line\">sudo update-grub</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.重启服务器</span></span><br><span class=\"line\">reboot</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>异常信息15.Docker 无法启动提示 Job docker.service/start failed with result ‘dependency’. 错误信息</strong><br>错误信息: 通过<code>journalctl -xe</code>查看详细错误<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- Unit containerd.service has begun starting up.</span><br><span class=\"line\">6月 04 21:27:33 WeiyiGeek-101 containerd[8304]: containerd: Near line 58 (last key parsed <span class=\"string\">'plugins.io.containerd.grpc.v1.cri.sandbox_image'</span>): Key <span class=\"string\">'plugins.io.containerd.grpc.v1.cri.sandbox_image'</span> has already been defined.  <span class=\"comment\"># 关键点</span></span><br><span class=\"line\">6月 04 21:27:33 WeiyiGeek-101 systemd[1]: containerd.service: main process exited, code=exited, status=1/FAILURE</span><br><span class=\"line\">6月 04 21:27:33 WeiyiGeek-101 systemd[1]: Failed to start containerd container runtime.</span><br><span class=\"line\">6月 04 21:27:33 WeiyiGeek-101 systemd[1]: Dependency failed <span class=\"keyword\">for</span> Docker Application Container Engine.</span><br><span class=\"line\">6月 04 21:27:33 WeiyiGeek-101 systemd[1]: Job docker.service/start failed with result <span class=\"string\">'dependency'</span>.</span><br><span class=\"line\">6月 04 21:27:33 WeiyiGeek-101 systemd[1]: Unit containerd.service entered failed state.</span><br><span class=\"line\">6月 04 21:27:33 WeiyiGeek-101 systemd[1]: containerd.service failed.</span><br></pre></td></tr></table></figure><br>问题原因: 由于 <code>Key &#39;plugins.io.containerd.grpc.v1.cri.sandbox_image&#39; has already been defined.</code> 重复定义导致的.<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210604214310.png\" alt=\"WeiyiGeek.sandbox_image\" title=\"\" class=\"\">\n                <p>WeiyiGeek.sandbox_image</p>\n            </figure><br>解决办法: <code>vim /etc/containerd/config.toml</code> 删除重复的 <code>sandbox_image</code> 项并重启 docker 即可。</p>\n<p><br></p>\n<p><strong>异常信息16.docker 报 chown socket at step GROUP: No such process导致启动失败</strong></p>\n<ul>\n<li>错误信息: <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ journalctl -xn</span><br><span class=\"line\">-- Unit docker.socket has begun starting up.</span><br><span class=\"line\">Dec 30 13:25:23 ITX systemd[1868]: Failed to chown socket at step GROUP: No such process</span><br><span class=\"line\">Dec 30 13:25:23 ITX systemd[1]: docker.socket control process exited, code=exited status=216</span><br><span class=\"line\">Dec 30 13:25:23 ITX systemd[1]: Failed to listen on Docker Socket <span class=\"keyword\">for</span> the API.</span><br><span class=\"line\">-- Subject: Unit docker.socket has failed</span><br><span class=\"line\">-- Defined-By: systemd</span><br><span class=\"line\">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class=\"line\">--</span><br><span class=\"line\">-- Unit docker.socket has failed.</span><br><span class=\"line\">--</span><br></pre></td></tr></table></figure></li>\n<li>解决办法:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方法1.添加 docker 用户组 ( 如果`/etc/group`用统一配置管理的话记得在源group文件中添加docker组信息 )</span><br><span class=\"line\">groupadd docker</span><br><span class=\"line\"></span><br><span class=\"line\">方法2.修改`/usr/lib/systemd/system/docker.socket`文件：</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Docker Socket <span class=\"keyword\">for</span> the API</span><br><span class=\"line\">PartOf=docker.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Socket]</span><br><span class=\"line\">ListenStream=/var/run/docker.sock</span><br><span class=\"line\">SocketMode=0660</span><br><span class=\"line\">SocketUser=root</span><br><span class=\"line\">SocketGroup=docker    <span class=\"comment\"># 改成 SocketGroup=root 或其他存在的组</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=sockets.target</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><strong>异常信息17: Error in deleting repository in a private registry V2 #1573;</strong></p>\n<ul>\n<li>问题原因:在启动registry时候没有启用REGISTRY_STORAGE_DELETE_ENABLED=true环境变量;<br>ISSUE: <a href=\"https://github.com/docker/distribution/issues/1573\" target=\"_blank\" rel=\"noopener\">https://github.com/docker/distribution/issues/1573</a></li>\n<li>解决办法: 启动docker registry 加入环境变量 <code>-e &quot;REGISTRY_STORAGE_DELETE_ENABLED=true&quot;</code></li>\n</ul>\n<hr>\n<h4 id=\"0x03-面试问题\"><a href=\"#0x03-面试问题\" class=\"headerlink\" title=\"0x03 面试问题\"></a>0x03 面试问题</h4><h5 id=\"面试问答1-仓库（Repository）、注册服务器（Registry）、注册索引（Index）-有何关系？\"><a href=\"#面试问答1-仓库（Repository）、注册服务器（Registry）、注册索引（Index）-有何关系？\" class=\"headerlink\" title=\"面试问答1.仓库（Repository）、注册服务器（Registry）、注册索引（Index） 有何关系？\"></a>面试问答1.仓库（Repository）、注册服务器（Registry）、注册索引（Index） 有何关系？</h5><ul>\n<li>仓库是存放一组关联镜像的集合，比如同一个应用的不同版本的镜像。</li>\n<li>注册服务器是存放实际的镜像文件的地方。</li>\n<li>注册索引则负责维护用户的账号、权限、搜索、标签等的管理。<br>因此，注册服务器利用注册索引来实现认证等管理。</li>\n</ul>\n<p><br></p>\n<h5 id=\"面试问答2-如何临时退出一个正在交互的容器的终端，而不终止它？\"><a href=\"#面试问答2-如何临时退出一个正在交互的容器的终端，而不终止它？\" class=\"headerlink\" title=\"面试问答2.如何临时退出一个正在交互的容器的终端，而不终止它？\"></a>面试问答2.如何临时退出一个正在交互的容器的终端，而不终止它？</h5><p>答：按 <code>Ctrl-p Ctrl-q</code>，如果按 Ctrl-c 往往会让容器内应用进程终止，进而会终止容器。</p>\n<p><br></p>\n<h5 id=\"面试问答3-Dockerfile中-ADD-与-COPY-的区别\"><a href=\"#面试问答3-Dockerfile中-ADD-与-COPY-的区别\" class=\"headerlink\" title=\"面试问答3.Dockerfile中 ADD 与 COPY 的区别?\"></a>面试问答3.Dockerfile中 ADD 与 COPY 的区别?</h5><blockquote>\n<p>答: 使用 ADD 指令时如果拷贝的源文件是个 tar 包,则在构建容器时会帮我们把 tar 包解开到指定目录，而<code>使用 copy 指令则不会解压 tar 包</code>;<br>另外一个区别是ADD指令既可以添加一个构建上下文环境中的文件也可以是个URL，而COPY则只能添加构建上下文中的文件;</p>\n</blockquote>\n<p><br></p>\n<h5 id=\"面试问答4-Dockerfile中-CMD-与-ENTRYPOINT-的区别\"><a href=\"#面试问答4-Dockerfile中-CMD-与-ENTRYPOINT-的区别\" class=\"headerlink\" title=\"面试问答4.Dockerfile中 CMD 与 ENTRYPOINT 的区别?\"></a>面试问答4.Dockerfile中 CMD 与 ENTRYPOINT 的区别?</h5><blockquote>\n<p>答: 使用场景的区别CMD指令是在容器启动后默认执行的命令和参数((如果定义多个CMD只有最后一个执行))，而ENTRYPOINT是用于应用运行前的准备工作(让容器以应用程序或服务形式运行);<br>注意:在Dockerfile至少需要设置一条CMD或者ENTRYPOINT指令;</p>\n</blockquote>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"Docker","path":"api/tags/Docker.json"}]}