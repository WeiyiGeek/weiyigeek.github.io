{"title":"Tomcat安全加固与性能优化","slug":"系统运维/Application/Web/WebApp/Tomcat/2.Tomcat安全加固与性能优化","date":"2019-09-02T05:34:30.000Z","updated":"2022-03-29T05:39:06.308Z","url":"2019/9-2-128.html","path":"api/articles/2019/9-2-128.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210808173518.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910173634.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190912120722.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911225341.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190912125211.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910165436.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910165521.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911223833.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911112942.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911102958.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911111305.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<center><br><br><strong>修订控制页</strong><br><br>版本 |修订日期 |修订人 |修订摘要<br>—|—|—|—<br>1.0| 2019年9月10日 09点00分 |WeiyiGeek |初稿<br><br></center>\n\n<hr>\n\n<h4 id=\"1-引言\"><a href=\"#1-引言\" class=\"headerlink\" title=\"1.引言\"></a>1.引言</h4><h5 id=\"1-1-目的\"><a href=\"#1-1-目的\" class=\"headerlink\" title=\"1.1 目的\"></a>1.1 目的</h5><p>为了更好的指导部署Tomcat应用容器,保证服务的安全稳定高性能的运行,需要对其进行加固和优化;<br>本次进行Tomcat容器调优加固主要从以下几个部分：</p>\n<ul>\n<li>内核参数优化</li>\n<li>性能参数优化</li>\n<li>安全加固配置</li>\n</ul>\n<h5 id=\"1-2-目标范围\"><a href=\"#1-2-目标范围\" class=\"headerlink\" title=\"1.2 目标范围\"></a>1.2 目标范围</h5><p>本文档仅供内部使用，禁止外传，帮助研发人员，运维人员对系统长期稳定的运行提供技术文档参考。</p>\n<h5 id=\"1-3-读者对象\"><a href=\"#1-3-读者对象\" class=\"headerlink\" title=\"1.3 读者对象\"></a>1.3 读者对象</h5><p>1) 项目经理<br>2) 开发人员<br>3) 测试人员<br>4) 运维人员<br>5) 相关领导</p>\n<hr>\n\n<h4 id=\"2-参考说明\"><a href=\"#2-参考说明\" class=\"headerlink\" title=\"2.参考说明\"></a>2.参考说明</h4><h5 id=\"2-1-帮助参考\"><a href=\"#2-1-帮助参考\" class=\"headerlink\" title=\"2.1 帮助参考\"></a>2.1 帮助参考</h5><p>Apache Tomcat是美国Apache软件基金会的一款轻量级Web应用服务器，该程序实现了对Servlet和JSP的支持。<br>目前是Apache开源软件组织的一个软件项目它的官网 ：<a href=\"http://tomcat.apache.org\" target=\"_blank\" rel=\"noopener\">http://tomcat.apache.org</a> , 在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试 JSP 程序的首选,默认端口8080。</p>\n<p>Tomcat8配置帮助文档: <a href=\"http://tomcat.apache.org/tomcat-8.0-doc/config/\" target=\"_blank\" rel=\"noopener\">http://tomcat.apache.org/tomcat-8.0-doc/config/</a><br>Security Manage: <a href=\"http://tomcat.apache.org/tomcat-8.0-doc/security-manager-howto.html\" target=\"_blank\" rel=\"noopener\">http://tomcat.apache.org/tomcat-8.0-doc/security-manager-howto.html</a></p>\n<p><br></p>\n<p>Tomcat初始目录结构<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/<span class=\"built_in\">local</span>/tomcat <span class=\"comment\">#主目录即安装的目录</span></span><br><span class=\"line\">├── bin   <span class=\"comment\">#存放启动和关闭Tomcat的脚本文件</span></span><br><span class=\"line\">├── conf  <span class=\"comment\">#存放Tomcat服务器的各种配置文件(后面单介绍)</span></span><br><span class=\"line\">├── lib   <span class=\"comment\">#存放tomcat服务器支撑的jar包</span></span><br><span class=\"line\">├── logs  <span class=\"comment\">#存放Tomcat的日志文件</span></span><br><span class=\"line\">├── temp  <span class=\"comment\">#存放Tomcat运行时产生的临时文件</span></span><br><span class=\"line\">├── webapps <span class=\"comment\">#web应用虽在目录，即供外界访问的web资源的存放目录,就是Web发布目录</span></span><br><span class=\"line\">│   ├── docs <span class=\"comment\">#帮助文档目录</span></span><br><span class=\"line\">│   ├── examples <span class=\"comment\">#Servlet and JSP Examples案例目录</span></span><br><span class=\"line\">│   ├── host-manager <span class=\"comment\">#主机管理目录</span></span><br><span class=\"line\">│   ├── manager  <span class=\"comment\">#应用程序管理目录</span></span><br><span class=\"line\">│   └── ROOT  <span class=\"comment\">#应用程序放置地址</span></span><br><span class=\"line\">└── work <span class=\"comment\">#Tomcat的工作目录,存放jsp编译后产生的class文件</span></span><br></pre></td></tr></table></figure><br><br></p>\n<p>Tomcat全局配置目录结构:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master conf]<span class=\"comment\"># tree</span></span><br><span class=\"line\">├── catalina.policy <span class=\"comment\">#权限控制配置文件</span></span><br><span class=\"line\">├── catalina.properties <span class=\"comment\">#Tomcat属性配置文件</span></span><br><span class=\"line\">├── context.xml  <span class=\"comment\">#上下文配置文件（selinux）</span></span><br><span class=\"line\">├── jaspic-providers.xml</span><br><span class=\"line\">├── jaspic-providers.xsd</span><br><span class=\"line\">├── logging.properties <span class=\"comment\">#日志log相关配置文件</span></span><br><span class=\"line\">├── server.xml  <span class=\"comment\">#主配置文件(如修改监听端口,开启关闭额外的服务,设置网站根目录，虚拟主机，开启https等功能)</span></span><br><span class=\"line\">├── tomcat-users.xml <span class=\"comment\">#manager-gui管理用户配置文件（Tomcat安装后生成的管理界面，该文件可开启访问）</span></span><br><span class=\"line\">├── tomcat-users.xsd</span><br><span class=\"line\">└── web.xml <span class=\"comment\">#Tomcat的servlet，servlet-mapping，filter，MIME等相关配置</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tomcat的JavaWeb应用的组成结构:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mail--- <span class=\"comment\">#-Web应用所在目录</span></span><br><span class=\"line\">  |---- <span class=\"comment\">#html、jsp、css、js等文件，根目录下的文件外界可以直接访问</span></span><br><span class=\"line\">  |---- <span class=\"comment\">#WEB-INF目录 (应用配置文件存放)</span></span><br><span class=\"line\">    |---------classes目录 <span class=\"comment\">#(java类)</span></span><br><span class=\"line\">    |---------lib目录  <span class=\"comment\">#(java类运行所需的jar包)</span></span><br><span class=\"line\">    |---------conf目录 <span class=\"comment\">#(数据库以及其他配置文件存放目录)</span></span><br><span class=\"line\">    |---------web.xml  <span class=\"comment\">#(web应用的配置文件)</span></span><br><span class=\"line\"><span class=\"comment\">#注意:WEB-INF 这个目录下的文件外界无法直接访问，由web服务器负责调用</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tomcat默认开发的端口介绍:</p>\n<ul>\n<li>8005:用于SHUTDOWN指令来关闭Tomcat时使用;</li>\n<li>8009:用于Apache连接Tomcat时候专用端口采用AJP协议;</li>\n<li>8080:用于HTTP协议远程访问端口即Web页面访问端口;</li>\n</ul>\n<hr>\n\n<h4 id=\"3-内核优化\"><a href=\"#3-内核优化\" class=\"headerlink\" title=\"3.内核优化\"></a>3.内核优化</h4><p>需要进行调整的内核参数<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/core/netdev_max_backlog</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：1000</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：网卡设备将请求放入队列的长度</span></span><br><span class=\"line\">net.core.netdev_max_backlog = 32768</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/core/somaxconn</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：128</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：已经成功建立连接的套接字将要进入队列的长度</span></span><br><span class=\"line\">net.core.somaxconn = 32768</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/core/rmem_default</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：212992</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：默认的TCP数据接收窗口大小（字节）</span></span><br><span class=\"line\">net.core.rmem_default = 8388608</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/core/wmem_default</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：212992</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：默认的TCP数据发送窗口大小（字节）</span></span><br><span class=\"line\">net.core.wmem_default = 8388608</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/core/rmem_max</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：212992</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：最大的TCP数据接收窗口大小（字节）</span></span><br><span class=\"line\">net.core.rmem_max = 16777216</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/core/wmem_max</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：212992</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：最大的TCP数据发送窗口大小（字节）</span></span><br><span class=\"line\">net.core.wmem_max = 16777216</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/ip_local_port_range</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：32768   61000</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：可用端口的范围</span></span><br><span class=\"line\">net.ipv4.ip_local_port_range = 1024  65535</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/route/gc_timeout</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值 300</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：路由缓存刷新频率，当一个路由失败后多长时间跳到另一个路由</span></span><br><span class=\"line\">net.ipv4.route.gc_timeout = 100</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_fin_timeout</span></span><br><span class=\"line\"><span class=\"comment\"># 默认 60</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间</span></span><br><span class=\"line\">net.ipv4.tcp_fin_timeout = 30 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_keepalive_time </span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：7200</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：间隔多久发送1次keepalive探测包</span></span><br><span class=\"line\">net.ipv4.tcp_keepalive_time = 1200  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_timestamps </span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：1</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：TCP时间戳，时间戳必须要开启，否则下面的 TIME_WAIT 重用和快速回收无效</span></span><br><span class=\"line\">net.ipv4.tcp_timestamps = 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_tw_recycle</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：0</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</span></span><br><span class=\"line\">net.ipv4.tcp_tw_recycle = 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">######################## cat /proc/sys/net/ipv4/tcp_tw_reuse</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：0</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：针对 TIME-WAIT，做为客户端可以启用（例如，作为nginx-proxy前端代理，要访问后端的服务）</span></span><br><span class=\"line\">net.ipv4.tcp_tw_reuse = 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_syn_retries</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值 2</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：在内核放弃建立连接之前发送SYN包的数量。</span></span><br><span class=\"line\">net.ipv4.tcp_syn_retries = 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_synack_retries</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值 2</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：为了打开对端的连接，内核需要发送一个SYN并附带一个回应前面一个SYN的ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK包的数量。</span></span><br><span class=\"line\">net.ipv4.tcp_synack_retries = 1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_mem</span></span><br><span class=\"line\"><span class=\"comment\">#确定 TCP 栈应该如何反映内存使用；每个值的单位都是内存页（通常是 4KB）。</span></span><br><span class=\"line\"><span class=\"comment\">#第一个值是内存使用的下限。</span></span><br><span class=\"line\"><span class=\"comment\">#第二个值是内存压力模式开始对缓冲区使用应用压力的上限。</span></span><br><span class=\"line\"><span class=\"comment\">#第三个值是内存上限。在这个层次上可以将报文丢弃，从而减少对内存的使用。对于较大的 BDP 可以增大这些值（但是要记住，其单位是内存页，而不是字节）。</span></span><br><span class=\"line\">net.ipv4.tcp_mem = 94500000    915000000   927000000</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_max_orphans</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值 16384</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单 的DoS攻击，你绝对不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。</span></span><br><span class=\"line\">net.ipv4.tcp_max_orphans = 3276800</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cat /proc/sys/net/ipv4/tcp_max_syn_backlog</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值：128</span></span><br><span class=\"line\"><span class=\"comment\"># 作用：增大SYN队列的长度，容纳更多连接</span></span><br><span class=\"line\">net.ipv4.tcp_max_syn_backlog = 65535</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"comment\">#执行使内核参数生效</span></span><br><span class=\"line\">sysctl -p</span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h4 id=\"4-性能优化\"><a href=\"#4-性能优化\" class=\"headerlink\" title=\"4.性能优化\"></a>4.性能优化</h4><p>描述: 由于Tomcat的运行依赖于JVM，从虚拟机的角度我们把Tomcat的调整分为<code>外部环境调优</code>和<code>自身调优</code>两类来描述。</p>\n<h5 id=\"4-1-外部调优\"><a href=\"#4-1-外部调优\" class=\"headerlink\" title=\"4.1 外部调优\"></a>4.1 外部调优</h5><p>主要调整Tomcat运行环境的操作系统参数和运行Tomcat的java虚拟机参数。</p>\n<p><em>(1)JAVA虚拟机性能优化</em><br>Tomcat需要依赖Java虚拟机运行,根据客户选用的主机的操作系统选择对应的JDK的版本建议使用最新的版本。<br>Tomcat的使用内存配置实质上是JVM的内存配置编辑 <code>catalina.[sh / bat]</code> 配置文件,注意这里区分Windows和Linux;</p>\n<p>jvm 优化是我们要去<code>调配置、调代码</code>，需要充分利用JVM底层的内容进行设置, 注意整个<code>堆heap</code>大小 = <code>年轻代大小 + 年老代大小 + 持久代大小</code> 之和。</p>\n<ul>\n<li>(1) 尽可能将对象预留在新生代，减少老年代GC的次数（通常老年回收起来比较慢）</li>\n<li>(2) 实际工作中，通常将堆的初始值和最大值设置相等，这样可以减少程序运行时进行的垃圾回收次数和空间扩展，从而提高程序性能。此值可以设置与-Xmx相同，以避免每次垃圾回收完成后JVM重新分配内存。</li>\n<li>(3) 年轻代:刚创建完对象放到里面去不用时等待jvm移除（可根据创建时间）。</li>\n<li>(4) 年老代:当空间不够时则将创建最早的对象挪过去。当又需要用到这个对象时，又将其挪入年轻但，挪来挪去影响效率。</li>\n</ul>\n<p><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210808173518.png\" alt=\"WeiyiGeek.JVM 内存结构图\"></p>\n<p>JVM调优之设置Java虚拟机运行生产环境参数配置:</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>描述</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>-server | Server 模式启动应用慢但是极大程度提高运行性能，特别是在稳定期过后。<br>-client | Cliet  模式启动应用快。</p>\n<p><br></p>\n<table>\n<thead>\n<tr>\n<th>内存调优</th>\n<th>描述说明</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>-Xms2g | 堆的<code>初始可用</code>内存大小，单位 m、g 。如 <code>-Xms2g</code><br>-Xmx2g | 堆的<code>最大可用</code>内存大小，单位 m、g 。如 <code>-Xmx2g</code> (<code>设置与Xms相同的内存大小 , 为减少程序运行时进行的垃圾回收次数和空间扩展</code>)<br>-Xmn256m | 设置年轻代内存大小，单位 m、g 。 如 <code>-Xmn256m</code> (<code>此值对系统性能影响较大，推荐配置为整个堆的 3/8 或 1/4，一般在增大年轻代内存后，也会将会减小年老代大小。</code>)<br>-Xss128k | 设置每个线程的栈Stack大小，单位 m、g 。如 <code>-Xss128k</code> (<code>越大我们能递归调用的方法数量越多，但是空间越大创建时间越长</code>)。 <br/> 每个线程栈大小为1M以前每个线程栈大小为256K, 更具应用的线程所需内存大小进行调整, 在相同物理内存下，减小这个值能生成更多的线程。 <br/> 但是操作系统对一个进程内的线程数还是有限制的不能无限生成，经验值在3000~5000左右可以在Linux内核中进行配置。<br>-XX:NewRatio=4 | 设置年轻代(<code>包括Eden和两个Survivor区</code>)与年老代的比值(<code>除去持久代</code>)。如<code>此时则年轻代与年老代所占比值为1:4, 年轻代占整个堆栈的 1/5</code>。<br>-XX:SurvivorRatio=4 | 设置年轻代中Eden区与Survivor区的大小比值。如<code>Eden区与两个Survivor区的比值为4:2, 一个Survivor区占整个年轻代的1/6</code>。<br>-XX:PermSize=16m | 设置持久代大小为16m, 持久代一般固定的内存大小为64m。 (<code>越大加载的类阅越多</code>) | support was removed in 8.0<br>-XX:MaxPermSize=16m | 设置最大持久代大小为16m, 默认是物理内存的1/4最大1024m。| support was removed in 8.0<br>-XX:MaxTenuringThreshold=0 | 设置垃圾最大年龄存活。<br/> 如果设置为0的话则年轻代对象不经过Survivor区，直接进入年老代, 对于年老代比较多的应用可以提高效率。 <br/> 如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概论。</p>\n<p><br></p>\n<p><strong>垃圾回收策略调优</strong></p>\n<p>描述: 我们都知道Java虚拟机都有默认的垃圾回收机制，但是不同的垃圾回收机制的效率是不同的，正是因为这点我们才经常对Java虚拟机的垃圾回收策略进行相应的调整。</p>\n<p>Tips : Java虚拟机的垃圾回收策略一般分为<code>串行收集器、并行收集器和并发收集器</code>。</p>\n<table>\n<thead>\n<tr>\n<th>垃圾回收策略之<code>串行收集器</code>调优</th>\n<th>描述说明</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>-XX:+UseSerialGc | 代表垃圾回收策略为串行收集器，即在整个扫描和复制过程采用单线程的方式来进行，适用于单CPU、新生代空间较小及对暂停时间要求不是非常高的应用上，是client级别默认的GC方式，主要在JDK1.5之前的垃圾回收方式。 | |</p>\n<table>\n<thead>\n<tr>\n<th>垃圾回收策略之<code>并行收集器</code>调优</th>\n<th>描述说明</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>-XX:+UseParallelGC | 代表垃圾回收策略为并行收集器<code>(吞吐量优先)</code>，即在整个扫描和复制过程采用多线程的方式来进行，适用于多CPU、对暂停时间要求较短的应用上，是server级别默认采用的GC方式。此配置仅对年轻代有效。该配置只能让年轻代使用并发收集，而年老代仍旧使用串行收集。| |<br>-XX:ParallelGCThreads=4 | 配置并行收集器(Gc)的线程数，即：同时多少个线程一起进行垃圾回收。此值最好配置与处理器数目相等。 | |<br>-XX:+UseParallelGCThreads=8 | 并行收集器线程数同时有多少个线程进行垃圾回收一般与CPU数量相等 | support was removed in 8.0<br>-XX:+UseParallelOldGC | 配置年老代垃圾收集方式为并行收集, JDK6.0支持对年老代并行收集。| |<br>-XX:MaxGCPauseMillis=100 | 设置每次年轻代垃圾回收的最长时间，如果无法满足此时间，JVM会自动调整年轻代大小，以满足此值。| |<br>-XX:+UseAdaptiveSizePolicy | 设置此选项后，并行收集器会自动选择年轻代区大小和相应的Survivor区比例，以达到目标系统规定的最低相应时间或者收集频率等，此值建议使用并行收集器时一直打开。 | |</p>\n<table>\n<thead>\n<tr>\n<th>垃圾回收策略之<code>并发收集器</code>调优</th>\n<th>描述说明</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>-XX:+UseConcMarkSweepGC | 代表垃圾回收策略为并发收集器 |</p>\n<table>\n<thead>\n<tr>\n<th>垃圾回收策略之其它策略</th>\n<th>描述说明</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>-XX:PrintGC |    每次触发GC的时候打印相关日志 |  |<br>-XX:+PrintGCDetails    | 更详细的GC日志 | |<br>-XX:+HeapDumpOnOutOfMemoryError| 堆异常报错输出 | |<br>-XX:HeapDumpPath=path    | 设置在dump heap时将文件dump到哪里。默认是当前目录下 java_pidpid.hprof这样形式的文件。| |<br>-XX:+UseCMSCompactAtFullCollection | 开启内存空间压缩和整理，防止过多内存碎片 | tomcat 8.0 报警告<br>Headless=true | windows系统可不用设置,适用于Linux系统与图形操作有关，如生成验证码含义是当前的是无显示器的服务器，应用中如果获取系统显示有关的参数会抛出异常 ||<br>-Dfile.encoding=UTF-8    |设置字符集避免日志中出现乱码 | |<br>-Dsun.jnu.encoding=UTF-8    |    设置字符集避免日志中出现乱码 ||<br>-Duser.timezone=GMT+08    |时区设置 ||</p>\n<p><br></p>\n<p>Tomcat 默认可以使用的内存为128MB，在较大型的应用项目中内存是不够的所以需要调大，一般设置<code>初始化内存为256MB，可以使用的最大内存为512MB</code>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Linux#</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /usr/<span class=\"built_in\">local</span>/tomcat8/bin/catalina.sh</span><br><span class=\"line\"><span class=\"comment\">#在OS specific support. $var _must_ be set to either true or false.110行下面添加</span></span><br><span class=\"line\">JAVA_OPTS=<span class=\"string\">\"-server </span></span><br><span class=\"line\"><span class=\"string\">-Xms1024m </span></span><br><span class=\"line\"><span class=\"string\">-Xmx1024m </span></span><br><span class=\"line\"><span class=\"string\">-Xmn256m</span></span><br><span class=\"line\"><span class=\"string\">-XX:NewRatio=4</span></span><br><span class=\"line\"><span class=\"string\">-XX:SurvivorRatio=4</span></span><br><span class=\"line\"><span class=\"string\">-XX:+UseParallelGC</span></span><br><span class=\"line\"><span class=\"string\">-XX:ParallelGCThreads=4</span></span><br><span class=\"line\"><span class=\"string\">-XX:+UseParallelOldGC </span></span><br><span class=\"line\"><span class=\"string\">-XX:+UseParallelOldGC</span></span><br><span class=\"line\"><span class=\"string\">\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Windows#</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /usr/<span class=\"built_in\">local</span>/tomcat8/bin/catalina.bat</span><br><span class=\"line\"><span class=\"comment\">#在/bin目录下的catalina.bat可以直接通过Tomcat设置JVM内存参数</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> <span class=\"string\">\"JAVA_OPTS=%JAVA_OPT% -server -Xms2048m -Xmx2048m -XX:PermSize=256m -XX:MaxPermSize=512m -Djava.awt.headless=true\"</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910173634.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><em>注意事项:</em></p>\n<ul>\n<li>java 8开始<code>PermSize被MetaspaceSize代替</code>，MetaspaceSize共享heap不会再有java.lang.OutOfMemoryError：PermGen space可以不设置</li>\n<li>java8 开始已经移除<code>MaxPermSize/UseParallelGCThreads=8</code></li>\n<li>Java 提供的垃圾回收机制虚拟机的堆大小决定了虚拟机花费在收集垃圾上的时间和频度并且收集垃圾可以接受的速度与应用有关<ul>\n<li>如果堆(heap)的空间很大，那么完全垃圾收集（FULL GC）就会很慢，但是频度会降低。</li>\n<li>如果在客户系统中把堆的大小和内存的需要一致，完全收集就很快，但是会更加频繁。</li>\n<li><code>推荐把-Xms设置为应用所需的最小值，这样会产生高效的垃圾回收</code>。</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<p><em>(2)Tomcat与web服务器整合</em><br>描述: 虽然tomcat也可以作web服务器但其处理静态html的速度比不上Nginx服务,并且为了更好的进行设置负载均衡,还是得和Nginx进行联用;</p>\n<p>因此我们可以把 Nginx 和 Tomcat 集成起来, 将html与jsp的功能部分进行明确分工, 让tomcat只处理jsp部分，或者也可以由其它的由 apache, IIS 等这些 web服务器处理，由此大大节省了tomcat有限的工作线程。</p>\n<p><br></p>\n<h5 id=\"4-2-自身调优\"><a href=\"#4-2-自身调优\" class=\"headerlink\" title=\"4.2 自身调优\"></a>4.2 自身调优</h5><p><em>(1)Connector元素属性优化</em><br>禁用DNS查询</p>\n<ul>\n<li>描述: 消除DNS查询对性能的影响我们可以关闭DNS查询</li>\n<li>优化: <code>enableLookups=&quot;false&quot;</code></li>\n<li>结果: 节省了网络带宽、查询时间和内存，而且更小的流量会使日志数据也会变得更少，显而易见也节省了硬盘空间</li>\n</ul>\n<p>调整线程数(需要根据压力测试进行调整)</p>\n<ul>\n<li>描述: 可通过应用程序的连接器（Connector）进行性能控制的参数是创建的处理请求的线程数。在Java中线程是程序运行时的路径，是在一个程序中与其它控制线程无关的、能够独立运行的代码段。但是应防止流量不可控制（或者恶意的服务攻击），从而导致超出了虚拟机使用内存的大小；web server允许的最大连接数还受制于操作系统的内核参数设置，通常Windows是2000个左右，Linux是1000个左右。</li>\n<li>优化: 修改 <code>minProcessors</code> 和<code>maxProcessors</code> 的值来控制线程数</li>\n<li>结果: 它们共享相同的地址空间。多线程帮助程序员写出CPU最大利用率的高效程序，使空闲时间保持最低，从而接受更多的请求。</li>\n</ul>\n<p>NIO 配置</p>\n<ul>\n<li>描述:NIO （No-blocking I/O）从JDK 1.4起，NIO API作为一个基于缓冲区，并能提供非阻塞I/O操作的API被引入[LD6];TOMCAT可以支持高并发的企业级应用,配置良好的tomcat都会使用APR(Apache Portable Runtime),APR是Apache HTTP Server2.x的核心，它是高度可移植的本地库，它使用高性能的UXIN I/O操作，低性能的java io操作。</li>\n<li>优化: <code>protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</code></li>\n<li>结果: NIO使用单线程(单个CPU)或者只使用少量的多线程(多CPU)来接受Socket，而由线程池来处理堵塞在pipe或者队列里的请求。只要OS可以接受TCP的连接，web服务器就可以处理该请求。大大提高了web服务器的可伸缩性。</li>\n</ul>\n<p>ARP配置(推荐方式-但是需要安装额外的包)：</p>\n<ul>\n<li>描述: Tomcat APR 模式也是 Tomcat 在高并发下的首选运行模式</li>\n<li>优化: <code>protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</code></li>\n<li>结果: 调用 httpd 核心链接库来读取或文件传输，从而提高 tomcat 对静态文件的处理性能</li>\n</ul>\n<p><br></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">Connector 属性</th>\n<th>说明</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"></td>\n</tr>\n</tbody>\n</table>\n<p>port|Tomcat启动监听端口| Default 8080 |<br>protocol|Tomcat的3种运行状态协议| Default bio HTTP/1.1|<br>acceptCount|监听端口队列最大数，满了之后客户请求会被拒绝（不能小于maxSpareThreads）| Default 100，建议设置1000|<br>maxThreads|当前可以同时处理的最大用户访问数最大连接数配置（并发能力）| Default 200 ，建议设置1000|<br>minSpareThreads| Tomcat初始化时创建的socket线程数，线程的最小运行数目 | Default 10 ，建议设置1000|<br>maxSpareThreads| Tomcat连接器的最大空闲socket线程数,一旦创建的线程超过这个值将会关闭socket| 建议设置1000|<br>minProcessors| 服务器创建时的最小处理线程数 | 建议设置 100|<br>maxProcessors| 服务器同时最大处理线程数 | 建议设置 1000|<br>enableLookups | 支持域名解析可把ip地址解析为主机名 | 建议设置false 关闭DNS反向查询|<br>compression | 是否打开压缩功能 | on|<br>compressionMinSize | 压缩的最小字节 | 2048|<br>compressableMimeType | 压缩的MImeType类型 | text/html,text/xml,text/javascript,text/css,text/plain|<br>connectionTimeout | 代表连接超时时间，单位为毫秒 | 默认值为60000。通常情况下设置为30000|<br>disableUploadTimeout | 标志允许servlet在一个servlet执行的时候，使用一个不同的更长的连接超时。| 建议设为false|<br>keepAliveTimeout|长连接超时时间 |常常设置-1永不过期|<br>URIEncoding|URL统一编码|utf-8|<br>redirectPort|在需要基于安全通道的场合，把客户请求转发到基于SSL的redirectPort端口|8443|<br>prestartminSpareThreads |  在 Tomcat 初始化的时候就初始化 minSpareThreads 的<br>maxQueueSize | 最大的等待队列数，超过则拒绝请求 |</p>\n<p><br></p>\n<p>描述: 在tomcat中每一个用户请求都是一个线程，所以可以使用线程池提高性能。 修改server.xml文件：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim ./conf/server.xml</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">!‐‐</span> 将注释打开（注释没打开的情况下默认<span class=\"attr\">10</span>个线程，最小<span class=\"attr\">10</span>，最大<span class=\"attr\">200</span>）‐‐&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Executor</span> <span class=\"attr\">name</span>=<span class=\"string\">\"tomcatThreadPool\"</span> <span class=\"attr\">namePrefix</span>=<span class=\"string\">\"catalina‐exec‐\"</span> </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">maxThreads</span>=<span class=\"string\">\"500\"</span> <span class=\"attr\">minSpareThreads</span>=<span class=\"string\">\"50\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">prestartminSpareThreads</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">maxQueueSize</span>=<span class=\"string\">\"100\"</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">#默认<span class=\"attr\">BIO</span>/建议采用<span class=\"attr\">NIO</span>或者<span class=\"attr\">arp</span>提高并发处理能力</span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">protocol</span>=<span class=\"string\">\"HTTP/1.1\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">#网络连接超时，单位：毫秒。设置为<span class=\"attr\">0</span>表示永不超时(不推荐))</span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"30000\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">maxHttpHeaderSize</span>=<span class=\"string\">\"32768\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">#当前可以同时处理的最大用户访问数最大连接数配置（并发能力）</span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">maxThreads</span>=<span class=\"string\">\"1000\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">#<span class=\"attr\">Tomcat</span>初始化时创建的线程数。最小空闲线程连接数用于优化线程池</span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">minSpareThreads</span>=<span class=\"string\">\"100\"</span> </span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">#一旦创建的线程超过这个值，<span class=\"attr\">Tomcat</span>就会关闭不再需要的<span class=\"attr\">socket</span>线程。</span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">maxSpareThreads</span>=<span class=\"string\">\"1000\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">acceptorThreadCount</span>=<span class=\"string\">\"2\"</span> </span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">#当所有的线程以分配，仍然允许连接进来，但是出于等待状态的用户数。</span></span><br><span class=\"line\"><span class=\"tag\">#等待线程数+工作线程数=<span class=\"string\">总的可最大连接数,超过这个数的请求将不予处理。</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">acceptCount</span>=<span class=\"string\">\"2000\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">minProcessors</span>=<span class=\"string\">\"100\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">maxProcessors</span>=<span class=\"string\">\"2000\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">#为了消除<span class=\"attr\">DNS</span>查询对性能的影响我们可以关闭<span class=\"attr\">DNS</span>查询，关闭该功能在一定程度上提高了<span class=\"attr\">Tomcat</span>服务器的性能;</span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">enableLookups</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">maxKeepAliveRequests</span>=<span class=\"string\">\"-1\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">keepAliveTimeout</span>=<span class=\"string\">\"-1\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">disableUploadTimeout</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">connectionUploadTimeout</span>=<span class=\"string\">\"150000\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">useSendfile</span>=<span class=\"string\">\"false\"</span> </span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">#<span class=\"attr\">Tomcat</span> 压缩配置，建议在前端 <span class=\"attr\">nginx</span> 上开启压缩。<span class=\"attr\">Tomcat</span> 作为应用服务器本身就很繁忙了。</span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">compression</span>=<span class=\"string\">\"on\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">compressionMinSize</span>=<span class=\"string\">\"2048\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">compressableMimeType</span>=<span class=\"string\">\"text/html,text/xml,application/javascript,application/json,text/javascript,text/css,text/plain,image/gif,image/png\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">URIEncoding</span>=<span class=\"string\">\"UTF-8\"</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><em>(2)采用用arp模式进行高并发选择</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.下载编译apr依赖</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/src/</span><br><span class=\"line\">wget http://mirrors.tuna.tsinghua.edu.cn/apache/apr/apr-1.7.0.tar.gz</span><br><span class=\"line\">wget http://mirrors.tuna.tsinghua.edu.cn/apache/apr/apr-util-1.6.1.tar.gz</span><br><span class=\"line\">tar xf apr-1.7.0.tar.gz &amp;&amp; tar xf apr-util-1.6.1.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> apr-1.7.0</span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/apr</span><br><span class=\"line\">make -j 2 &amp;&amp; make install </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> apr-util-1.6.1</span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/apr-util --with-apr=/usr/<span class=\"built_in\">local</span>/apr/</span><br><span class=\"line\">make -j2 &amp;&amp; make install</span><br><span class=\"line\"></span><br><span class=\"line\">cp <span class=\"string\">\"/opt/tomcat/apache-tomcat-8.5.45/bin/tomcat-native.tar.gz\"</span> .</span><br><span class=\"line\">tar xf tomcat-native.tar.gz &amp;&amp; <span class=\"built_in\">cd</span> tomcat-native-1.2.23-src/native/</span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/apr --with-java-home=/opt/tomcat/jdk8/</span><br><span class=\"line\">make -j 2 &amp;&amp; make install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加apr path</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"export LD_LIBRARY_PATH=/usr/local/apr/lib\"</span> &gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure></p>\n<p>配置arp模式:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/tomcat/conf/</span><br><span class=\"line\">$ vim server.xml</span><br><span class=\"line\">&lt;Connector port=<span class=\"string\">\"8080\"</span> protocol=<span class=\"string\">\"org.apache.coyote.http11.Http11AprProtocol\"</span></span><br><span class=\"line\">               connectionTimeout=<span class=\"string\">\"20000\"</span></span><br><span class=\"line\">               redirectPort=<span class=\"string\">\"8443\"</span> /&gt;</span><br><span class=\"line\"><span class=\"comment\">#注意如果SSLEngine设置off会导致报错</span></span><br><span class=\"line\">&lt;Listener className=<span class=\"string\">\"org.apache.catalina.core.AprLifecycleListener\"</span> SSLEngine=<span class=\"string\">\"on\"</span> /&gt;</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190912120722.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>成功后查看启动日志:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$cat</span> /opt/tomcat/apache-tomcat-8.5.45/logs/catalina.out</span><br><span class=\"line\">12-Sep-2019 12:37:47.381 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class=\"string\">\"http-apr-10.10.107.222-8080\"</span>]</span><br><span class=\"line\">12-Sep-2019 12:37:47.417 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class=\"string\">\"https-openssl-apr-443\"</span>]</span><br><span class=\"line\">12-Sep-2019 12:37:47.419 INFO [main] org.apache.catalina.startup.Catalina.start Server startup <span class=\"keyword\">in</span> 891 ms</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><em>(3)启用外部连接池</em><br>描述:执行器（线程池）在tomcat中每一个用户请求都是一个线程，所以可以使用线程池提高性能。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#去掉下面两个元素注释并修改maxThreads：</span></span><br><span class=\"line\">&lt;Executor name=<span class=\"string\">\"tomcatThreadPool\"</span> namePrefix=<span class=\"string\">\"catalina-exec-\"</span></span><br><span class=\"line\">maxThreads=<span class=\"string\">\"300\"</span> minSpareThreads=<span class=\"string\">\"4\"</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;Connector executor=<span class=\"string\">\"tomcatThreadPool\"</span></span><br><span class=\"line\">port=<span class=\"string\">\"8080\"</span> protocol=<span class=\"string\">\"org.apache.coyote.http11.Http11NioProtocol\"</span></span><br><span class=\"line\">maxThreads=<span class=\"string\">\"1000\"</span></span><br><span class=\"line\">minSpareThreads=<span class=\"string\">\"100\"</span></span><br><span class=\"line\">maxSpareThreads=<span class=\"string\">\"200\"</span></span><br><span class=\"line\">acceptCount=<span class=\"string\">\"1000\"</span></span><br><span class=\"line\">disableUploadTimeout=<span class=\"string\">\"true\"</span></span><br><span class=\"line\">connectionTimeout=<span class=\"string\">\"30000\"</span></span><br><span class=\"line\">URIEncoding=<span class=\"string\">\"UTF-8\"</span></span><br><span class=\"line\">enableLookups=<span class=\"string\">\"false\"</span></span><br><span class=\"line\">compression=<span class=\"string\">\"on\"</span></span><br><span class=\"line\">compressionMinSize=<span class=\"string\">\"2048\"</span></span><br><span class=\"line\">compressableMimeType=<span class=\"string\">\"text/html,text/xml,text/javascript,text/css,text/plain,image/gif,image/jpg,image/png\"</span></span><br><span class=\"line\">redirectPort=<span class=\"string\">\"8443\"</span> /&gt;</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911225341.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<p><em>(4)禁用自动检测更新加载</em><br>Context元素reloadable属性会监视在 web-inf/classes 和 web-inf/lib 目录下class文件的改动，如果监测到有class文件被更新的，服务器会自动重新加载web应用。 </p>\n<ul>\n<li>在开发和调试阶段,将其改为true但是一般像Eclipse等开发环境都会默认改为true</li>\n<li>在正式发布阶段，应将其该为false可以降低Tomcat的运行负荷，提高Tomcat的运行性能<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> conf/server.xml</span><br><span class=\"line\"><span class=\"comment\">#在&lt;/Host&gt;之前加入类似以下内容：（重启生效）</span></span><br><span class=\"line\">&lt;context path=<span class=\"string\">\"/bbs\"</span> docbase=<span class=\"string\">\"bbs\"</span>  reloadable=<span class=\"string\">\"false\"</span>/&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p><em>(5)增大随机数熵池</em><br>描述:当你执行了 ./startup.sh 或者 ./catalina.sh start 后等待时间过长能要几分钟才能正常提供服务。<br>原因：在apache-tomcat 官方文档：如何让 tomcat 启动更快里面提到了一些启动时的优化项，其中一项是关于随机数生成时，采用的<code>&quot;熵源&quot;(entropy source)的策略</code>。</p>\n<p>使用伪随机函数生成器:</p>\n<ul>\n<li>通过修改 Tomcat 启动文件 -Djava.security.egd=file:/dev/urandom</li>\n<li>通过修改 JRE 中的 java.security 文件 securerandom.source=file:/dev/urand</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JAVA_OPTS=<span class=\"string\">\"-server -Xms1024m -Xmx2048m -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=80 -XX:-PrintGC -XX:-PrintGCDetails -XX:-PrintGCTimeStamps  -Djava.security.egd=file:/dev/urandom\"</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190912125211.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>增大/dev/random的熵池（推荐）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装熵池服务 rngd</span></span><br><span class=\"line\"><span class=\"variable\">$yum</span> -y install rng-tools</span><br><span class=\"line\"><span class=\"variable\">$systemctl</span> start rngd</span><br><span class=\"line\"><span class=\"variable\">$systemctl</span> <span class=\"built_in\">enable</span> rngd</span><br></pre></td></tr></table></figure><br>启动服务后观察 <code>cat/proc/sys/kernel/random/entropy_avail</code> 基本在三千左右。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$cat</span> /proc/sys/kernel/random/entropy_avail</span><br><span class=\"line\">3311</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"5-安全加固\"><a href=\"#5-安全加固\" class=\"headerlink\" title=\"5.安全加固\"></a>5.安全加固</h4><p>描述:加固依然分为身份鉴别、访问控制、安全审计、资源控制和入侵防范5个方面;<br>大部分加固基于xml配置文件进行修改，也应根据实际需求制定方案。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#寻找配置文件目录</span></span><br><span class=\"line\">find /-name *tomcat*</span><br><span class=\"line\"><span class=\"comment\">#配置文件目录存放目录</span></span><br><span class=\"line\"><span class=\"variable\">$&#123;tomcat_home&#125;</span>/conf/...</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"5-1-身份鉴别\"><a href=\"#5-1-身份鉴别\" class=\"headerlink\" title=\"5.1 身份鉴别\"></a>5.1 身份鉴别</h5><p><em>0.口令复杂度,不同用户不同账号</em><br>描述:口令要求：长度至少8位，并包括数字、小写字母、大写字母和特殊符号4类中至少3类。<br>修改tomcat配置文件/conf/tomcat-users.xml配置文件，要求usr1密码必须满足复杂度要求。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;user username=<span class=\"string\">\"Tomcat1\"</span> password=<span class=\"string\">\"12345qwe\"</span> roles=<span class=\"string\">\"manager-gui\"</span>&gt;</span><br><span class=\"line\">&lt;user username=<span class=\"string\">\"Tomcat2\"</span> password=<span class=\"string\">\"12345qwe\"</span> roles=<span class=\"string\">\"admin-gui\"</span>&gt;</span><br></pre></td></tr></table></figure><br><br></p>\n<p><em>1.安全配置manager登录页面并且删除多余账号</em><br>描述:Tomcat的主要管理界面被称为Manager应用程序</p>\n<ul>\n<li>如果不使用manager来管理部署应用,建议修改tomcat配置文件/conf/tomcat-users.xml配置文件来禁用或者删除manager文件夹</li>\n<li>如果使用该功能我们需要进行配置口令以及强密码包括访问控制,删除与工作无关的帐号以及应用。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.配置强密码登录manager后面</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> tomcat_user.xml</span><br><span class=\"line\">&lt;?xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"UTF-8\"</span>?&gt;</span><br><span class=\"line\">&lt;tomcat-users xmlns=<span class=\"string\">\"http://tomcat.apache.org/xml\"</span></span><br><span class=\"line\">              xmlns:xsi=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span></span><br><span class=\"line\">              xsi:schemaLocation=<span class=\"string\">\"http://tomcat.apache.org/xml tomcat-users.xsd\"</span></span><br><span class=\"line\">              version=<span class=\"string\">\"1.0\"</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#角色如下并且要记得只赋予最小权限：</span></span><br><span class=\"line\"><span class=\"comment\"># manager-gui：可以访问web界面</span></span><br><span class=\"line\"><span class=\"comment\"># manager-status：只可以访问“Server Status”页面</span></span><br><span class=\"line\"><span class=\"comment\"># manager-script：可以脚本文本界面和“Server Status”页面</span></span><br><span class=\"line\"><span class=\"comment\"># manager-jmx：可以访问JMX代理界面和“Server Status”页面</span></span><br><span class=\"line\">  &lt;role rolename=<span class=\"string\">\"manager-gui\"</span>/&gt;</span><br><span class=\"line\">  <span class=\"comment\">#host-manager页面</span></span><br><span class=\"line\">  &lt;role rolename=<span class=\"string\">\"admin-gui\"</span>/&gt;</span><br><span class=\"line\">  &lt;!--密码复杂度需要满足等保要求--&gt;</span><br><span class=\"line\">  &lt;user username=<span class=\"string\">\"admin\"</span> password=<span class=\"string\">\"@weiyigeek@\"</span> roles=<span class=\"string\">\"manager-gui,admin-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;/tomcat-users&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.访问控制设定(其实默认只能本机访问)</span></span><br><span class=\"line\">$/opt/tomcat/apache-tomcat-8.5.45/webapps/manager/META-INF/</span><br><span class=\"line\"><span class=\"comment\">#采用正则添加匹配</span></span><br><span class=\"line\">&lt;Valve className=<span class=\"string\">\"org.apache.catalina.valves.RemoteAddrValve\"</span> allow=<span class=\"string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1\"</span> /&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910165436.png\" alt=\"WeiyiGeek\" title=\"\" class=\"\">\n                <p>WeiyiGeek</p>\n            </figure>\n<p><br></p>\n<p><em>2.Tomcat虚拟主机管理器安全配置并且删除多余账号</em><br>描述:与manager管理一样如果使用的话进需要进行安全配置</p>\n<ul>\n<li>不使用的话建议删除webapps应用目录下的host-manager</li>\n<li>使用需要进行安全配置<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#登录密码配置</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> conf/tomcat-users.xml</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">\"admin-gui\"</span>/&gt;</span><br><span class=\"line\">&lt;user username=<span class=\"string\">\"tomcat\"</span> password=<span class=\"string\">\"s3cret\"</span> roles=<span class=\"string\">\"admin-gui\"</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#访问配置(其实默认只能本机访问)</span></span><br><span class=\"line\">&lt;Valve className=<span class=\"string\">\"org.apache.catalina.valves.RemoteAddrValve\"</span> allow=<span class=\"string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1|10\\.\\d+\\.\\d+\\.\\d+\"</span> /&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910165521.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<p><em>3.非root启动服务</em><br>描述:建议使用专用用户 tomcat 或者 nobody 用户来启动 Tomcat，为了防止 Tomcat 被植入 web shell 程序后，可以修改项目文件。<br>因此我们要将 Tomcat 和项目的属<code>主做分离</code>(常常使upload目录可以有上传权限,但是不能有执行的权限))))),他也无法创建和编辑项目文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ps</span> -ef | grep tomcat|grep -v <span class=\"string\">\"grep\"</span></span><br><span class=\"line\">tomcat   13243     1  0 10:27 pts/0    00:00:02 /opt/tomcat/jdk8/jre/bin/java -Djava.util.logging.config.file=/opt/tomcat//apache-tomcat-8.5.45/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -server -Xms1024m -Xmx2048m -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=80 -XX:-PrintGC -XX:-PrintGCDetails -XX:-PrintGCTimeStamps -Xloggc:../logs/gc.log -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /opt/tomcat//apache-tomcat-8.5.45/bin/bootstrap.jar:/opt/tomcat//apache-tomcat-8.5.45/bin/tomcat-juli.jar -Dcatalina.base=/opt/tomcat//apache-tomcat-8.5.45 -Dcatalina.home=/opt/tomcat//apache-tomcat-8.5.45 -Djava.io.tmpdir=/opt/tomcat//apache-tomcat-8.5.45/temp org.apache.catalina.startup.Bootstrap start</span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h5 id=\"5-2-安全审计\"><a href=\"#5-2-安全审计\" class=\"headerlink\" title=\"5.2 安全审计\"></a>5.2 安全审计</h5><p><em>0.增加记录日志功能</em><br>描述:Tomcat的日志文件存放于logs文件夹，里面包含了多种类型的日志，主要分为两类：</p>\n<ul>\n<li>一是运行中的日志，它主要记录运行的一些信息，尤其是一些异常错误日志信息。</li>\n<li>二是访问日志信息，它记录的访问的时间，IP，访问的资料等相关信息。</li>\n</ul>\n<p>各个日志文件的作用:</p>\n<ul>\n<li>localhost.2019-09-10.log：程序异常没有被捕获的时候抛出的地方</li>\n<li>catalina.2019-09-10.log：程序的输出，tomcat的运行日志</li>\n<li>manager.2019-09-10.log：manager项目专有的</li>\n<li>host-manager.2019-09-10.log：manager项目专有的</li>\n<li>localhost_access_log.2019-09-10.txt：访问日志记录</li>\n</ul>\n<p>编辑tomcat配置文件server.xml配置文件将以下内容的注释标记:<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- Access log processes all example.</span></span><br><span class=\"line\"><span class=\"comment\">            Documentation at: /docs/config/valve.html</span></span><br><span class=\"line\"><span class=\"comment\">            <span class=\"doctag\">Note:</span> The pattern used is equivalent to using pattern=\"common\" --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">\"org.apache.catalina.valves.AccessLogValve\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">directory</span>=<span class=\"string\">\"logs\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">prefix</span>=<span class=\"string\">\"localhost_access_log\"</span> <span class=\"attr\">suffix</span>=<span class=\"string\">\".txt\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">pattern</span>=<span class=\"string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- </span></span><br><span class=\"line\"><span class=\"comment\">  每个字段的含义为</span></span><br><span class=\"line\"><span class=\"comment\">192.168.228.1 - - [29/Sep/2017:11:26:10 +0800] \"GET / HTTP/1.1\" 200 11418</span></span><br><span class=\"line\"><span class=\"comment\">%h：远程主机名或IP地址：192.168.228.1</span></span><br><span class=\"line\"><span class=\"comment\">%l：远程用户名，始终为“-”</span></span><br><span class=\"line\"><span class=\"comment\">%u：已验证的远程用户，如果没有则为“-”</span></span><br><span class=\"line\"><span class=\"comment\">%t：访问日期和时间：[29/Sep/2017:11:26:10 +0800]</span></span><br><span class=\"line\"><span class=\"comment\">%r：http请求中的第一行：GET / HTTP/1.1</span></span><br><span class=\"line\"><span class=\"comment\">%s：http状态码：200</span></span><br><span class=\"line\"><span class=\"comment\">%b：发送的字节数：11418</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure><br>属性解释:</p>\n<ul>\n<li>Directory:日志文件放置的目录，在tomcat下面有个logs文件夹，那里面是专门放置日志文件的，也可以修改为其他路径；</li>\n<li>Prefix:这个是日志文件的名称前缀，日志名称为localhost_access_log.2008-10-22.txt，前面的前缀就是这个localhost_access_log。</li>\n<li>Suffix: 文件后缀名。</li>\n<li>Pattern:common方式时，将记录访问源IP、本地服务器IP、记录日志服务器IP、访问方式、发送字节数、本地接收端口、访问URL地址等相关信息在日志文件中。</li>\n<li>resolveHosts:值为true时，tomcat会将这个服务器IP地址通过DNS转换为主机名，如果是false，就直接写服务器IP地址。</li>\n</ul>\n<p>Tomcat的运行日志有以下7个级别：</p>\n<blockquote>\n<p>SEVERE &gt; WARNING &gt; INFO &gt; CONFIG &gt; FINE &gt; FINER &gt; FINEST </p>\n</blockquote>\n<hr>\n\n<h5 id=\"5-3-资源控制\"><a href=\"#5-3-资源控制\" class=\"headerlink\" title=\"5.3 资源控制\"></a>5.3 资源控制</h5><p><em>0.移除默认应用程序</em><br>描述:Tomcat可能自带一些默认的web应用程序。如果不是一定需要，必须将它们移除。<br>移除${tomcat_home}/webapps中所有的默认的web应用程序有：<code>ROOT、Documentation、Examples、Host Manager和Manager</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#果不是一定需要，必须将它们移除。</span></span><br><span class=\"line\">rm -rf /opt/tomcat/apache-tomcat-8.5.45/webapps/*</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><em>1.错误页面重定向</em><br>描述:编辑tomcat配置文件/conf/web.xml文件,在最后</web-app>一行之前加入以下内容,然后需要重新启动tomcat服务;<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 配置实现了将404未找到jsp网页的错误导向noFile.htm页面,还可以添加其多的错误代码导向页面，如403，500 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">error-code</span>&gt;</span>404<span class=\"tag\">&lt;/<span class=\"name\">error-code</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/noFile.htm<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!--配置实现了当jsp网页出现java.lang.NullPointerException导常时，转向error.jsp错误页面 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">exception-type</span>&gt;</span>java.lang.NullPointerException<span class=\"tag\">&lt;/<span class=\"name\">exception-type</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/error.jsp<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure><br>当出现NullPointerException异常时tomcat会把网页导入到error.jsp，且会打印出出错信息。<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;%@ pageerrorPage=<span class=\"string\">\"/error.jsp\"</span> %&gt;</span><br><span class=\"line\">典型的error.jsp错误页面的程序写法如下:</span><br><span class=\"line\">&lt;%@ pagecontentType=<span class=\"string\">\"text/html;charset=GB2312\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ pageisErrorPage=<span class=\"string\">\"true\"</span>%&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">  &lt;title&gt;错误页面&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;body&gt;出错了：&lt;/p&gt;错误信息:&lt;%= exception.getMessage() %&gt;</span><br><span class=\"line\">&lt;br&gt;</span><br><span class=\"line\">Stack Trace is :</span><br><span class=\"line\">  &lt;pre&gt;</span><br><span class=\"line\">    &lt;font color=<span class=\"string\">\"red\"</span>&gt;&lt;%</span><br><span class=\"line\">    java.io.CharArrayWritercw = <span class=\"keyword\">new</span> java.io.CharArrayWriter();</span><br><span class=\"line\">    java.io.PrintWriterpw = <span class=\"keyword\">new</span> java.io.PrintWriter(cw,<span class=\"keyword\">true</span>);</span><br><span class=\"line\">    exception.printStackTrace(pw);</span><br><span class=\"line\">    out.println(cw.toString());</span><br><span class=\"line\">    %&gt;</span><br><span class=\"line\">    &lt;/font&gt;</span><br><span class=\"line\">  &lt;/pre&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\n<p>补充事项:</p>\n<ul>\n<li>如果Manager应用程序没被移除，必须手动将位于 <code>CATALINA_HOME/webapps/manager/WEB-INF/jsp/</code> 的错误页面里的Tomcat版本信息移除。</li>\n</ul>\n<p><br></p>\n<p><em>3.限制访问Tomcat文件夹</em></p>\n<p>描述：Tomcat文件夹只能由tomcat用户本身访问，尤其是对于目录<code>${tomcat_home}/conf /和${tomcat_home}/webapps</code><br>当不需要通过应用程序服务器自动部署时，标准配置就是将所有Tomcat文件的所有者设置为root，并且所属群组设置为Tomcat,然后用chmod 740仅允许root用户编辑文件并允许Tomcat用户读取文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(注意点)例外是临时和工作目录的所有者应该是Tomcat用户而不是root用户。</span></span><br><span class=\"line\">whown root:tomcat /opt/tomcat</span><br><span class=\"line\">chmod 740 <span class=\"variable\">$&#123;tomcat_home&#125;</span>/conf</span><br><span class=\"line\">chmod 740 <span class=\"variable\">$&#123;tomcat_home&#125;</span>/webapps</span><br></pre></td></tr></table></figure><br><br/></p>\n<p><em>4.会话超时</em><br>描述:所有的web应用程序的会话超时必须设置为20分钟可通过编辑 CATALINA_HOME/conf/web.xml 文件并做以下配置来实现：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- Tomcat8默认的超时时间是半个小时 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">session-config</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">session-timeout</span>&gt;</span>20<span class=\"tag\">&lt;/<span class=\"name\">session-timeout</span>&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h5 id=\"4-4-访问控制\"><a href=\"#4-4-访问控制\" class=\"headerlink\" title=\"4.4 访问控制\"></a>4.4 访问控制</h5><p>描述: Tomcat提供了防止恶意攻击或禁止某些机器访问的设置，限制手段来防止恶意的服务攻击;<br>可以让你过滤来自请求的主机或IP地址，并允许或拒绝哪些主机/IP。与之类似的在Apache的httpd文件里有对每个目录的允许/拒绝指定。</p>\n<p><em>1.Context.xml访问控制设置</em><br>Tomcat提供了两个参数供你配置：RemoteHostValve 和RemoteAddrValve。<br>例如: 你可以把Admin Web application设置成只允许本地访问设置如下：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;Context path=<span class=\"string\">\"/path/to/secret_files\"</span> &gt;</span><br><span class=\"line\"><span class=\"comment\">#如果没有给出允许主机的指定，那么与拒绝主机匹配的主机就会被拒绝，除此之外的都是允许的</span></span><br><span class=\"line\">  &lt;Valve className=<span class=\"string\">\"org.apache.catalina.valves.RemoteAddrValve\"</span></span><br><span class=\"line\">         allow=<span class=\"string\">\"10.0.172.109\"</span> deny=<span class=\"string\">\"\"</span> /&gt;</span><br><span class=\"line\">&lt;/Context&gt;</span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h5 id=\"5-5-入侵防范\"><a href=\"#5-5-入侵防范\" class=\"headerlink\" title=\"5.5 入侵防范\"></a>5.5 入侵防范</h5><p><em>0.防止缓慢的http拒绝服务攻击与限制监听网络接口</em><br>描述:不要让连接器（connector）监听服务器上所有可用的网络接口和IP地址，而要让连接器监听指定的网络接口和IP地址采用address属性,防止应用程序意外地运行在某个开放的网络接口上。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#将默认值20000改成10000即可单位ms注意需要根据实际需求更改</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> conf/server.xml</span><br><span class=\"line\">&lt;Connector port=<span class=\"string\">\"8080\"</span> protocol=<span class=\"string\">\"HTTP/1.1\"</span> </span><br><span class=\"line\">connectionTimeout=<span class=\"string\">\"10000\"</span> </span><br><span class=\"line\">redirectPort=<span class=\"string\">\"8443\"</span> address=<span class=\"string\">\"127.0.0.1\"</span> /&gt;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><em>1.禁用tomcat的AJP协议（8.5.51之前的版本默认开启后续则禁用）</em><br>描述:AJP（Apache JServer Protocol）AJPv13协议是面向包的。<br>WEB服务器和Servlet容器通过TCP连接来交互, 为了节省SOCKET创建的昂贵代价，WEB服务器会尝试维护一个永久TCP连接到servlet容器，并且在多个请求和响应周期过程会重用连接。</p>\n<p>实际上我们一般使用Nginx+Tomcat架构所以用不着Ajp协议可以将其禁用。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  编辑server.xml进行注释配置</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> conf/server.xml</span><br><span class=\"line\">&lt;!-- &lt;Connector port=<span class=\"string\">\"8009\"</span> protocol=<span class=\"string\">\"AJP/1.3\"</span> redirectPort=<span class=\"string\">\"8443\"</span> /&gt; --&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911223833.png\" alt=\"WeiyiGeek.ajp\" title=\"\" class=\"\">\n                <p>WeiyiGeek.ajp</p>\n            </figure>\n<p>Tips : 禁用ajp后可以看节省了多少内存以及查询某个pid占用的内存。</p>\n<p><br></p>\n<p><em>2.禁用非法HTTP请求方法</em><br>描述:readonly参数默认是true即不允许delete和put操作<br>编辑web.xml文件查看org.apache.catalina.servlets.DefaultServlet是否存在如下配置<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$vim conf/web.xml</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>readonly<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br></p>\n<p><em>3.禁止目录列出</em></p>\n<p>描述:设置DefaultServlet的listings为false<br>这不仅仅是因为允许显示目录列表被认为是不安全的，而且还因为生成具有数千个文件的目录列表会消耗大量的CPU资源，相当于被DDoS攻击。<br>注意：Tomcat8默认是false并且更改后需要重新启动tomcat服务;<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$vim conf/web.xml</span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 同样也是在下面进行添加--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>listings<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br></p>\n<p><em>4.防止恶意关闭服务</em><br>描述:编辑tomcat配置文件conf/server.xml配置文件，shutdown的值为复杂的字符串：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#随机生成密码</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /dev/urandom | tr -dc <span class=\"string\">'_a-zA-Z0-9'</span> | head -c 12</span><br><span class=\"line\">r02BPRnHyq89</span><br><span class=\"line\"><span class=\"comment\">#配置如下:将默认的SHUTDOWN变成r02BPRnHyq89</span></span><br><span class=\"line\">&lt;Serverport=<span class=\"string\">\"8005\"</span> shutdown=<span class=\"string\">\"r02BPRnHyq89\"</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#如果不需要该功能，必须要将其停用，设置如下：</span></span><br><span class=\"line\">&lt;Server  port=<span class=\"string\">\"-1\"</span> shutdown=<span class=\"string\">\"SHUTDOWN\"</span>&gt; <span class=\"comment\">#本地管理脚本可将服务器关闭，即使在关闭端口被禁用的情况下。</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><em>5.修改Banner掩盖真实信息</em><br>描述:修改以掩饰真实版本信息防止攻击者以版本的漏洞进行攻击,影响错误页面和响应头;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##(1)修改/lib/catalina.jar中org/apache/catalina/util/Serverinfo.properties问津中的以下参数 (推荐方式)</span></span><br><span class=\"line\"><span class=\"variable\">$unzip</span> catalina.jar</span><br><span class=\"line\"><span class=\"variable\">$vim</span> catalina/org/apache/catalina/util/Serverinfo.properties</span><br><span class=\"line\">server.info=Nginx</span><br><span class=\"line\">server.number=0.0.0.0</span><br><span class=\"line\">server.built=Apr 2 2017 07:25:00 UTC</span><br><span class=\"line\"><span class=\"comment\">#将修改后的信息压缩回jar包</span></span><br><span class=\"line\">jar uvf catalina.jar org/apache/catalina/util/ServerInfo.properties</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911112942.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(2)修改web.xml中国Connector链接器</span></span><br><span class=\"line\">&lt;Connector port=<span class=\"string\">\"8080\"</span> protocol=<span class=\"string\">\"HTTP/1.1\"</span>  </span><br><span class=\"line\">  connectionTimeout=<span class=\"string\">\"20000\"</span> </span><br><span class=\"line\">  redirectPort=<span class=\"string\">\"8443\"</span>  </span><br><span class=\"line\">  URIEncoding=<span class=\"string\">\"UTF-8\"</span> </span><br><span class=\"line\">  useBodyEncodingForURI=<span class=\"string\">\"true\"</span> </span><br><span class=\"line\">  server=<span class=\"string\">\"Microsoft-IIS/6.5\"</span>/&gt;  <span class=\"comment\">#关键点</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911102958.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<p><em>6.关闭自动部署</em><br>描述:Tomcat允许在Tomcat运行时自动部署应用程序。为了防止被植入木马等恶意程序，因此我们要关闭自动部署。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> server.xml</span><br><span class=\"line\"><span class=\"comment\">#将unpackWARs与autoDeploy的true值改成false;</span></span><br><span class=\"line\">&lt;Host name=<span class=\"string\">\"localhost\"</span>  appBase=<span class=\"string\">\"webapps\"</span> unpackWARs=<span class=\"string\">\"false\"</span> autoDeploy=<span class=\"string\">\"false\"</span>&gt;</span><br></pre></td></tr></table></figure><br>补充:在托管环境中Web应用程序可能不受信任，也可以设置<code>deployXML属性为false来忽略context.xml</code>以防给该web应用程序提高权限。</p>\n<p><br></p>\n<p><em>7.配置HTTPS加密协议</em><br>描述:采用HTTPS协议加密可以防止中间人攻击,以及数据的拦截和修改的验证导致攻击无效;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(1)用JDK自带的keytool工具生成一个证书,默认三个月的有效期;</span></span><br><span class=\"line\"><span class=\"variable\">$JAVA_HOME</span>/bin/keytool -genkey -<span class=\"built_in\">alias</span> tomcat -keyalg RSA -keystore /tmp/keystore</span><br><span class=\"line\">Enter keystore password:</span><br><span class=\"line\">Re-enter new password:</span><br><span class=\"line\">What is your first and last name?</span><br><span class=\"line\">  [Unknown]:  Tomcat</span><br><span class=\"line\">What is the name of your organizational unit?</span><br><span class=\"line\">  [Unknown]:  CQ</span><br><span class=\"line\">What is the name of your organization?</span><br><span class=\"line\">  [Unknown]:  CQ</span><br><span class=\"line\">What is the name of your City or Locality?</span><br><span class=\"line\">  [Unknown]:  BEIJING</span><br><span class=\"line\">What is the name of your State or Province?</span><br><span class=\"line\">  [Unknown]:  XIZHIMEN</span><br><span class=\"line\">What is the two-letter country code <span class=\"keyword\">for</span> this unit?</span><br><span class=\"line\">  [Unknown]:  408119</span><br><span class=\"line\">Is CN=Tomcat, OU=CQ, O=CQ, L=BEIJING, ST=XIZHIMEN, C=408119 correct?</span><br><span class=\"line\">  [no]:  Y</span><br><span class=\"line\"></span><br><span class=\"line\">Enter key password <span class=\"keyword\">for</span> &lt;tomcat&gt;</span><br><span class=\"line\">        (RETURN <span class=\"keyword\">if</span> same as keystore password):</span><br><span class=\"line\">Re-enter new password:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(2)修改tomcat安装目录下/conf/server.xml配置文件，更改为使用HTTPS方式，增加如下行：</span></span><br><span class=\"line\">&lt;Connector classname=<span class=\"string\">\"org.apache.catalina.http.HttpConnector\"</span></span><br><span class=\"line\">      port=<span class=\"string\">\"443\"</span> protocol=<span class=\"string\">\"HTTP/1.1\"</span>  minProcessors=<span class=\"string\">\"5\"</span></span><br><span class=\"line\">      SSLEnabled=<span class=\"string\">\"true\"</span></span><br><span class=\"line\">      maxprocessors=<span class=\"string\">\"100\"</span></span><br><span class=\"line\">      enableLookups=<span class=\"string\">\"true\"</span> acceptCount=<span class=\"string\">\"10\"</span>  debug=<span class=\"string\">\"0\"</span></span><br><span class=\"line\">      scheme=<span class=\"string\">\"https\"</span></span><br><span class=\"line\">      Factory_classname=<span class=\"string\">\"org.apache.catalina.SSLServerSocketFactory\"</span></span><br><span class=\"line\">      secure=<span class=\"string\">\"true\"</span></span><br><span class=\"line\">      clientAuth=<span class=\"string\">\"false\"</span></span><br><span class=\"line\">      keystoreFile=<span class=\"string\">\"/tmp/keystore\"</span></span><br><span class=\"line\">      keystorePass=<span class=\"string\">\"weiyigeek\"</span></span><br><span class=\"line\">      sslProtocol=<span class=\"string\">\"TLS\"</span> /&gt;</span><br><span class=\"line\"><span class=\"comment\">#SSL Connector来指定可用的SSL加密方式：  </span></span><br><span class=\"line\">ciphers=<span class=\"string\">\"SSL_RSA_WITH_RC4_128_SHA, TLS_RSA_WITH_AES_128_CBC_SHA,  TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA,  SSL_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA,  SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA\"</span></span><br></pre></td></tr></table></figure><br>也可以通过 <a href=\"https://10.10.107.222/manager/html/sslConnectorCerts\" target=\"_blank\" rel=\"noopener\">https://10.10.107.222/manager/html/sslConnectorCerts</a> 查看证书情况</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911111305.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>补充:为了使托管在Tomcat上的所有web应用程序强制使用HTTPS，必须在每个 CATALINA_HOME/webapps/$WEBAPP/WEB-INF/web.xml 文件里每个security-constraint标签关闭（</security-constraint>标签）之前包含以下内容：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;user-data-constraint&gt; </span><br><span class=\"line\">    &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;  </span><br><span class=\"line\">&lt;user-data-constraint&gt;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><em>8.HttpOnly标记</em><br>描述:对会话cookie自动启用HttpOnly的cookie标记，查看配置以确保该选项为被禁用。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#要启用HttpOnly设置使之全局应用于所有应用程序：</span></span><br><span class=\"line\">&lt;Context useHttpOnly=<span class=\"string\">'true'</span>&gt;</span><br><span class=\"line\">...</span><br><span class=\"line\">&lt;Context&gt;</span><br></pre></td></tr></table></figure><br>补充:如果应用程序需要通过JavaScript访问HttpOnly cookie，可以在METAINF/context.xml中一个单独的Context中定义一个异常。</p>\n<p><br></p>\n<p><em>9.CSRF防护(根据实际情况添加)</em><br>描述:为保护应用程序必须启用Tomcat的跨站请求伪造防护。Tomcat8~9提供了基本的CSRF防护。可以在 CATALINA_BASE/conf/web.xml 中配置一个全局过滤器。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#该过滤器可以被每个使用 WEB-INF/web.xml 文件的应用程序覆盖。</span></span><br><span class=\"line\">&lt;filter-mapping&gt; </span><br><span class=\"line\">  &lt;filter-name&gt;CSRFPreventionFilter&lt;/filter-name&gt;  </span><br><span class=\"line\">  &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  </span><br><span class=\"line\">&lt;/filter-mapping&gt;</span><br></pre></td></tr></table></figure><br>补充:使用CSRF防护可能会影响程序功能，必须要牢记这一点，尤其是在应用程序大量使用异步请求的情况下。</p>\n<hr>\n\n<h5 id=\"5-6-默认设置\"><a href=\"#5-6-默认设置\" class=\"headerlink\" title=\"5.6 默认设置\"></a>5.6 默认设置</h5><p>描述:以下是常规的默认配置并且默认情况下这些设置被认为是安全的,如有在项目中进行更改的建议进行整改和调整;</p>\n<p><em>1.server.xml中默认安全配置</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> <span class=\"variable\">$CATALINA_HOME</span>/conf/server.xml</span><br><span class=\"line\">&lt;Connector</span><br><span class=\"line\">  <span class=\"comment\">#1.设置为空或者false</span></span><br><span class=\"line\">  allowTrace=<span class=\"string\">\"false\"</span> </span><br><span class=\"line\">/&gt;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><em>2.context.xml中默认安全配置</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> <span class=\"variable\">$CATALINA_HOME</span>/conf/server.xml</span><br><span class=\"line\">&lt;Context </span><br><span class=\"line\"><span class=\"comment\">#1.将privileged属性设置为false，除非像Manager应用程序那样需要权限：</span></span><br><span class=\"line\">privileged=<span class=\"string\">\"false\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.确保crossContext值为空或被设为false,</span></span><br><span class=\"line\"><span class=\"comment\">#crossContext值为true可能会导致允许恶意应用程序向受限应用程序发送请求。</span></span><br><span class=\"line\">crossContext=<span class=\"string\">\"false\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.确保allowLinking值为空或被设为false。</span></span><br><span class=\"line\"><span class=\"comment\">#allowLinking值为true可能会导致目录遍历和源代码泄露漏洞的产生。</span></span><br><span class=\"line\">allowLinking=<span class=\"string\">\"false\"</span></span><br><span class=\"line\">/&gt;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><em>3.Tomcat启动参数</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.当RECYCLE_FACADES选项设置为true时，Tomcat会回收请求间会话外观（session facade）,将导致请求间的信息泄漏</span></span><br><span class=\"line\"><span class=\"comment\">#默认情况下，此参数未被设置(确保使用的启动脚本不包含以下内容)</span></span><br><span class=\"line\">Dorg.apache.catalina.connector.RECYCLE_FACADES = <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.允许在Tomcat上指定不同的路径分隔符，可能会允许攻击者访问应用程序，该行为本该被代理程序（比如mod_proxy）阻止</span></span><br><span class=\"line\"><span class=\"comment\">#默认情况下，此参数未被设置(确保使用的启动脚本不包含以下内容)</span></span><br><span class=\"line\">Dorg.apache.catalina.connector.CoyoteAdapter.ALLOW_BACKSLASH = FALSE</span><br><span class=\"line\">Dorg.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH = FALSE</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.允许自定义header状态消息，使攻击者也能够插header。</span></span><br><span class=\"line\"><span class=\"comment\">#可能会导致XSS漏洞的产生。默认情况下此参数未被设置。</span></span><br><span class=\"line\">Dorg.apache.coyote.USE_CUSTOM_STATUS_MSG_IN_HEADER = <span class=\"literal\">false</span></span><br><span class=\"line\">Dorg.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH= FALSE</span><br><span class=\"line\">Dorg.apache.coyote.USE_CUSTOM_STATUS_MSG_IN_HEADER = <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h5 id=\"5-7-可选操作\"><a href=\"#5-7-可选操作\" class=\"headerlink\" title=\"5.7 可选操作\"></a>5.7 可选操作</h5><p><em>1.Java SecurityManager</em><br>描述:可用Java  SecurityManager限制单个应用程序的功能。</p>\n<ul>\n<li>$CATALINA_HOME/conf/catalina.policy 文件包含了Java  SecurityManager使用的安全策略的配置</li>\n<li>一旦配置了catalina.policy 文件，便可以使用SecurityManager和–security选项启Tomcat。</li>\n</ul>\n<p>注意事项:</p>\n<ul>\n<li>因为基本上所有的权限类型（比如访问单个文件和目录或Java包）都应该根据每个应用程序进行单独配置，所以这会大大增加操作成本。另外，限制过于严格的策略文件会影响应用程序的功能。</li>\n</ul>\n<p><br></p>\n<p><em>2.访问Java包控制</em><br>描述:Tomcat可限制对某些Java包的访问。如果检测到受限制的包被访问，将抛出安全异常。<br>对Java包做访问限制，打开 $CATALINA_BASE/conf/catalina.properties 文件并添加不允许访问的包至package.access列表。</p>\n<p>分析Java import可以列出哪些应用程序需要哪些包。在Unix系统上，可以使用以下例子来实现：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep –R import <span class=\"variable\">$&#123;tomcat_home&#125;</span>/webapps/WEBAPP</span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h4 id=\"6-附录说明\"><a href=\"#6-附录说明\" class=\"headerlink\" title=\"6.附录说明\"></a>6.附录说明</h4><p><strong>(1) 生产配置实例</strong><br>描述 <code>server.xml</code> 配置文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@tomcat1 ~]# vim /usr/local/tomcat8/conf/server.xml</span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 修改Connector元素 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">executor</span>=<span class=\"string\">\"tomcatThreadPool\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">port</span>=<span class=\"string\">\"8080\"</span> </span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">protocol</span>=<span class=\"string\">\"org.apache.coyote.http11.Http11NioProtocol\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">address</span>=<span class=\"string\">\"127.0.0.1\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">acceptCount</span>=<span class=\"string\">\"1000\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">\"20000\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">compression</span>=<span class=\"string\">\"on\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">compressionMinSize</span>=<span class=\"string\">\"2048\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">compressableMimeType</span>=<span class=\"string\">\"text/html,text/xml,text/javascript,text/css,text/plain,image/gif,image/jpg,image/png\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">disableUploadTimeout</span>=<span class=\"string\">\"true\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">enableLookups</span>=<span class=\"string\">\"false\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">maxThreads</span>=<span class=\"string\">\"1000\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">minSpareThreads</span>=<span class=\"string\">\"100\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">maxSpareThreads</span>=<span class=\"string\">\"200\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">maxKeepAliveRequests</span>=<span class=\"string\">\"1\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  </span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">redirectPort</span>=<span class=\"string\">\"8443\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">server</span>=<span class=\"string\">\"SecWAF/1.9\"</span></span></span><br><span class=\"line\"><span class=\"tag\"></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">URIEncoding</span>=<span class=\"string\">\"UTF-8\"</span></span></span><br><span class=\"line\"><span class=\"tag\">  /&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- </span></span><br><span class=\"line\"><span class=\"comment\"># 参数说明：</span></span><br><span class=\"line\"><span class=\"comment\">  protocol : 协议调整工作模式为Nio (org.apache.coyote.http11.Http11Nio)</span></span><br><span class=\"line\"><span class=\"comment\">  port : 绑定监听端口</span></span><br><span class=\"line\"><span class=\"comment\">  redirectPort ：重定向端口</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">  address : 绑定监听地址</span></span><br><span class=\"line\"><span class=\"comment\">  acceptCount ：当同时连接的人数达到`maxThreads`参数设置的值时其还可以接收排队的连接数量，超过这个连接的则直接返回拒绝连接。在实际应用中如果想加大Tomcat的并发数，应该同时加大 acceptCount 和 maxThreads 的值。</span></span><br><span class=\"line\"><span class=\"comment\">  </span></span><br><span class=\"line\"><span class=\"comment\">  connectionTimeout : 连接超时时间单位毫秒,0代表不限制。</span></span><br><span class=\"line\"><span class=\"comment\">  compression ：启用压缩功能。</span></span><br><span class=\"line\"><span class=\"comment\">  compressionMinSize ：最小压缩大小单位Byte。</span></span><br><span class=\"line\"><span class=\"comment\">  compressableMimeType ：压缩的文件类型。</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">  disableUploadTimeout：禁用上传超时时间</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">  enableLookups ：是否开启域名反查,一般设置为false来提高处理能力。</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">  maxThreads ：设置当前Tomcat的最大并发数,默认配置的最大请求数是150个,即同时能支持150个并发。</span></span><br><span class=\"line\"><span class=\"comment\">  minSpareThreads ：最小空闲线程数，设置当前Tomcat初始化时创建的线程数，默认值为25。</span></span><br><span class=\"line\"><span class=\"comment\">  maxSpareThreads ：最大空闲线程数，如果超过这个值会关闭无用的线程。</span></span><br><span class=\"line\"><span class=\"comment\">  maxKeepAliveRequests : 最大保持活动请求数,并且以必须设置tomcat的超时时间`connectionTimeout`,避免tomcat产生大量的TIME_WAIT连接。</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">  server : 设置server字段响应头;</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">  URIEncoding ：URI地址编码使用UTF-8</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"优化参考\"><a href=\"#优化参考\" class=\"headerlink\" title=\"优化参考:\"></a>优化参考:</h3><p><a href=\"https://www.jianshu.com/p/d64b5909ec1b\" target=\"_blank\" rel=\"noopener\">https://www.jianshu.com/p/d64b5909ec1b</a><br><a href=\"https://www.cnblogs.com/yechanglv/p/6941821.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/yechanglv/p/6941821.html</a></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"SystemOperation","path":"api/categories/SystemOperation.json"}],"tags":[{"name":"Tomcat","path":"api/tags/Tomcat.json"}]}