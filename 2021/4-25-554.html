<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ |WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Prometheus">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                å­¦ä¹ ä¹‹è·¯
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="/img/video-account.jpg" target="_blank" >
                <i class="icon icon-lg icon-video-camera"></i>
                è§†é¢‘å·
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ </span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ </h1>
        <h5 class="subtitle">
            
                <time datetime="2021-04-25T09:37:47.000Z" itemprop="datePublished" class="page-time">
  2021-04-25
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/">monitor</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/">kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/OperationTools/">OperationTools</a></li></ul></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap" style="display: none;">
  <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Prometheus/4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ "
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ </h1>
        <div class="post-meta">
            <time class="post-time" title="2021-04-25 17:37:47" datetime="2021-04-25T09:37:47.000Z"  itemprop="datePublished">2021-04-25</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/">monitor</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/">kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/OperationTools/">OperationTools</a></li></ul></li></ul></li></ul>



            

            


            
        </div>
        <span class="post-href" style="display: none;">|</span> 
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-PromQL-ä»‹ç»"><a href="#0x00-PromQL-ä»‹ç»" class="headerlink" title="0x00 PromQL ä»‹ç»"></a>0x00 PromQL ä»‹ç»</h2><h3 id="1-åŸºç¡€ç®€è¿°"><a href="#1-åŸºç¡€ç®€è¿°" class="headerlink" title="1.åŸºç¡€ç®€è¿°"></a>1.åŸºç¡€ç®€è¿°</h3><p><strong>Q: ä»€ä¹ˆæ˜¯PromQL?</strong></p>
<blockquote>
<p>ç­”: PromQL <code>(Prometheus Query Language)</code> å‡½æ•°å¼æŸ¥è¯¢è¯­è¨€ æ˜¯ Prometheus è‡ªå·±å¼€å‘çš„æ•°æ®æŸ¥è¯¢ DSL è¯­è¨€ï¼Œå¯ä»¥è®©ç”¨æˆ·å®æ—¶é€‰æ‹©å’Œèšåˆæ—¶é—´åºåˆ—æ•°æ®ã€‚</p>
</blockquote>
<p>å®ƒç±»ä¼¼äº SQL çš„è¯­è¨€ï¼Œä½†æ˜¯PromQLè¡¨ç°åŠ›éå¸¸ä¸°å¯Œï¼Œå¹¶ä¸”å†…ç½®å‡½æ•°å¾ˆå¤šï¼Œåœ¨æ—¥å¸¸æ•°æ®å¯è§†åŒ–ä»¥åŠ rule å‘Šè­¦ä¸­éƒ½ä¼šä½¿ç”¨åˆ°å®ƒã€‚</p>
<p>Tips: æˆ‘ä»¬æŠŠæ¯ä¸ªæŸ¥è¯¢å¯¹è±¡å¾—åå­—å«åš<code>Metrics</code>åº¦é‡å€¼ã€‚</p>
<p>Tips: æ ‡ç­¾æ˜¯PromQLçš„å…³é”®éƒ¨åˆ†ï¼Œä¸ä»…å¯ä»¥ä½¿ç”¨å®ƒä»¬è¿›è¡Œä»»æ„èšåˆï¼Œè¿˜å¯ä»¥å°†ä¸åŒçš„æŒ‡æ ‡è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥å¯¹å…¶è¿›è¡Œç®—æœ¯è¿ç®—ã€‚</p>
<p><strong>Q: å¦‚æœè¿›è¡ŒPrometheusé‡‡é›†çš„æ•°æ®æŸ¥è¯¢?</strong></p>
<blockquote>
<p>ç­”: åœ¨<code>Prometheus Server</code>çš„åå°é‡Œé¢è¾“å…¥æŒ‡æ ‡åç§°(ä¼šè‡ªåŠ¨è¡¥é½), å¦‚æœ€è¿‘ä¸€ä¸ªæ—¶é—´é—´éš”(é‡‡é›†å‘¨æœŸ)ä¸‹çš„å€¼<code>prometheus_prometheus_http_requests_total</code>;</p>
</blockquote>
<p><strong>Q: å¦‚ä½•ä½¿ç”¨ PromQL è¯­å¥é€šè¿‡å†…ç½®è¡¨è¾¾å¼æµè§ˆå™¨è¿›è¡ŒæŸ¥è¯¢?</strong></p>
<ul>
<li>(1) ä½¿ç”¨<code>Prometheus</code>çš„å†…ç½®è¡¨è¾¾å¼æµè§ˆå™¨ï¼Œåˆ©ç”¨PromQLè¯­å¥è¿›è¡ŒæŸ¥è¯¢æˆ‘ä»¬ç›‘æ§çš„æŒ‡æ ‡ã€‚</li>
</ul>
<p>ä¾‹å¦‚: Prometheus æœåŠ¡å™¨å·²æœåŠ¡çš„<code>/metrics</code>è¯·æ±‚çš„æ€»æ•°æŒ‡æ ‡: <code>promhttp_metric_handler_requests_total</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯·æ±‚`/metrics`è¿”å›`code=200`ä¸ºæ¡ä»¶è¿›è¡ŒæŸ¥è¯¢</span></span><br><span class="line">promhttp_metric_handler_requests_total&#123;code=<span class="string">"200"</span>&#125;</span><br><span class="line">  <span class="comment">// promhttp_metric_handler_requests_total&#123;code="200", instance="aiserver", job="Prod"&#125; 80619</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—è¿”å›çš„è¯·æ±‚ä¸º200çš„æ€»æ•°æŒ‡æ ‡æ—¶é—´åºåˆ—æ€»æ•°</span></span><br><span class="line">count(promhttp_metric_handler_requests_total&#123;code=<span class="string">"200"</span>&#125;)  <span class="comment">// &#123;&#125; 34</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>(2) ä½¿ç”¨<code>Graph</code>é€‰é¡¹å¡ï¼Œå±•ç¤ºæŸ¥è¯¢åˆ°çš„æ•°æ®<br>ä¾‹å¦‚ï¼Œè¾“å…¥ä»¥ä¸‹è¡¨è¾¾å¼æ¥ç»˜åˆ¶åœ¨è‡ªæˆ‘æŠ“å–çš„Prometheusä¸­å‘ç”Ÿçš„è¿”å›çŠ¶æ€ä»£ç <code>200</code>çš„æ¯ç§’HTTPè¯·æ±‚ç‡ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rate(promhttp_metric_handler_requests_total&#123;code=<span class="string">"200"</span>,job=<span class="string">"LocalServer"</span>&#125;[5m])</span><br><span class="line">  <span class="comment"># &#123;code="200", instance="localhost:9090", job="LocalServer"&#125; 	0.016666666666666666</span></span><br></pre></td></tr></table></figure>
æ‚¨å¯ä»¥å°è¯•å›¾å½¢èŒƒå›´å‚æ•°å’Œå…¶ä»–è®¾ç½®ã€‚</li>
</ul>
<p><a rel=4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹  href="https://img.weiyigeek.top/2021/5/20210819215356.png" target="_blank" title="WeiyiGeek.Graph" data-fancybox="images"><img src="https://img.weiyigeek.top/2021/5/20210819215356.png" alt="WeiyiGeek.Graph"></a></p>
<p><br></p>
<h3 id="2-åŸºç¡€æ ‡å‡†"><a href="#2-åŸºç¡€æ ‡å‡†" class="headerlink" title="2.åŸºç¡€æ ‡å‡†"></a>2.åŸºç¡€æ ‡å‡†</h3><p><strong>2.1 æ—¶é—´å•ä½:</strong><br>æè¿°: Prometheus ä¸­çš„æŒç»­æ—¶é—´è¢«ç”¨äº <code>PromQL</code> å’Œ<code>é…ç½®æ–‡ä»¶</code>ä¸­ï¼Œå®ƒæ”¯æŒçš„å•ä½å¦‚ä¸‹:</p>
<table>
<thead>
<tr>
<th>å•ä½</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>ms</td>
<td>æ¯«ç§’</td>
</tr>
<tr>
<td>s</td>
<td>ç§’, ç­‰äº 1000 ms</td>
</tr>
<tr>
<td>m</td>
<td>åˆ†é’Ÿ, ç­‰äº 60 s</td>
</tr>
<tr>
<td>h</td>
<td>å°æ—¶, ç­‰äº 60 min</td>
</tr>
<tr>
<td>d</td>
<td>å¤©, ç­‰äº 24h</td>
</tr>
<tr>
<td>w</td>
<td>å‘¨, ç­‰äº 7d</td>
</tr>
<tr>
<td>y</td>
<td>å¹´, ç­‰äº 365d</td>
</tr>
</tbody>
</table>
<p>ä»¥ä¸‹æ˜¯ä¸€äº›æœ‰æ•ˆæŒç»­æ—¶é—´çš„ç¤ºä¾‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span>h</span><br><span class="line"><span class="number">1</span>h30m</span><br><span class="line"><span class="number">5</span>m</span><br><span class="line"><span class="number">10s</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ•´æ•°å¸¦ä¸€ä¸ªå•ä½ï¼Œä¾‹å¦‚<code>90m</code>æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œ<code>1h30m</code>å’Œ<code>1.5h</code>ä¸æ˜¯æœ‰æ•ˆçš„ã€‚<br>Tips : å¹¶ä¸”é—°å¹´å’Œé—°ç§’éƒ½æ˜¯è¢«å¿½ç•¥çš„ï¼Œ1y æ€»æ˜¯ (<code>60 * 60 * 24 * 365s</code>)</p>
<p><br></p>
<p><strong>2.2 æ–‡å­—</strong><br>(1) å­—ç¬¦ä¸²æ–‡å­—: å­—ç¬¦ä¸²å¯ä»¥åœ¨å•å¼•å·ã€åŒå¼•å·æˆ–åå¼•å·ä¸­æŒ‡å®šä¸ºæ–‡å­—ã€‚<br>PromQL éµå¾ªä¸Goç›¸åŒçš„è½¬ä¹‰è§„åˆ™ã€‚åœ¨å•å¼•å·æˆ–åŒå¼•å·ä¸­ï¼Œåæ–œæ å¼€å§‹ä¸€ä¸ªè½¬ä¹‰åºåˆ—ï¼Œåé¢å¯ä»¥è·Ÿ<code>a, b, f, n, r, t,væˆ–\</code>ã€‚å¯ä»¥ä½¿ç”¨å…«è¿›åˆ¶ (<code>\nnn</code>) æˆ–åå…­è¿›åˆ¶ (<code>\xnn,\unnnnå’Œ\Unnnnnnnn</code>)æä¾›ç‰¹å®šå­—ç¬¦ã€‚</p>
<p>Tips : éå¸¸æ³¨æ„çš„æ˜¯ä¸ Go ä¸åŒï¼ŒPrometheus ä¸ä¼šä¸¢å¼ƒåå¼•å·å†…çš„æ¢è¡Œç¬¦(<code>åå¼•å·å†…ä¸å¤„ç†è½¬ä¹‰</code>)ã€‚</p>
<p>ä¾‹å­:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"this is a string"</span></span><br><span class="line"><span class="string">'these are unescaped: \n \\ \t'</span></span><br><span class="line"><span class="string">`these are not unescaped: \n ' " \t`</span></span><br></pre></td></tr></table></figure></p>
<p>(2) æµ®åŠ¨æ–‡å­—: æ ‡é‡æµ®ç‚¹å€¼å¯ä»¥æŒ‰ä»¥ä¸‹æ ¼å¼å†™æˆæ–‡å­—æ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼ˆä»…åŒ…å«ç©ºæ ¼ä»¥æé«˜å¯è¯»æ€§ï¼‰ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-+]?(</span><br><span class="line">  [0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?</span><br><span class="line">  | 0[xX][0-9a-fA-F]+</span><br><span class="line">  | [nN][aA][nN]</span><br><span class="line">  | [iI][nN][fF]</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>ä¾‹å­ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">23</span><br><span class="line">-2.43</span><br><span class="line">3.4e-9</span><br><span class="line">0x8f</span><br><span class="line">-Inf</span><br><span class="line">NaN</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="3-æ•°æ®ç±»å‹"><a href="#3-æ•°æ®ç±»å‹" class="headerlink" title="3.æ•°æ®ç±»å‹"></a>3.æ•°æ®ç±»å‹</h3><p>æè¿°: åœ¨ Prometheus çš„è¡¨è¾¾å¼è¯­è¨€ä¸­ï¼Œè¡¨è¾¾å¼æˆ–å­è¡¨è¾¾å¼å¯ä»¥è®¡ç®—ä¸ºä»¥ä¸‹å››ç§ç±»å‹ä¹‹ä¸€ï¼š</p>
<h4 id="ç¬æ—¶æ•°æ®-Instant-vector"><a href="#ç¬æ—¶æ•°æ®-Instant-vector" class="headerlink" title="ç¬æ—¶æ•°æ® (Instant vector)"></a>ç¬æ—¶æ•°æ® (Instant vector)</h4><p><code>å³æ—¶æ—¶å‘é‡é€‰æ‹©å™¨</code>: æŸ¥è¯¢è¯„ä¼°æ—¶é—´ä¹‹å‰è¿”å›æœ€è¿‘æ ·æœ¬çš„ç¬æ—¶å‘é‡ï¼Œå³é›¶ä¸ªæˆ–è€…å¤šä¸ªæ—¶é—´åºåˆ—çš„åˆ—è¡¨ï¼Œ<code>æ¯ä¸ªæ—¶é—´åºåˆ—åŒ…å«ä¸€ä¸ªæ ·æœ¬ï¼Œæ‰€æœ‰æ—¶é—´åºåˆ—éƒ½å…±äº«ç›¸åŒçš„æ—¶é—´æˆ³</code>ã€‚å¹¶ä¸”å½“ä½ ä½¿ç”¨ç¬æ—¶å‘é‡é€‰æ‹©å™¨æ—¶ï¼Œä¸ä¼šè¿”å›å·²è¿‡æ—¶çš„æ—¶é—´åºåˆ—ã€‚</p>
<p><strong>ç¤ºä¾‹è¯´æ˜:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) åŒ…å«ä¸€ç»„æ—¶åºï¼Œæ¯ä¸ªæ—¶åºåªæœ‰ä¸€ä¸ªç‚¹ï¼Œä¾‹å¦‚ï¼š`prometheus_prometheus_http_requests_total`</span></span><br><span class="line">node_timex_status[2m]</span><br><span class="line">  <span class="comment"># node_timex_status&#123;instance="aiserver", job="Prod"&#125; 8193 @1629298587.604</span></span><br></pre></td></tr></table></figure></p>
<p>Tips: ä¾‹å¦‚è¿”å›å³æ—¶å‘é‡çš„è¡¨è¾¾å¼æ˜¯å”¯ä¸€å¯ä»¥ç›´æ¥ç»˜åˆ¶çš„ç±»å‹ã€‚</p>
<p><br/></p>
<h4 id="åŒºé—´æ•°æ®-Range-vector"><a href="#åŒºé—´æ•°æ®-Range-vector" class="headerlink" title="åŒºé—´æ•°æ® (Range vector)"></a>åŒºé—´æ•°æ® (Range vector)</h4><p><code>èŒƒå›´å‘é‡é€‰æ‹©å™¨</code>: ä¸æ¯ä¸ªæ—¶é—´åºåˆ—è¿”å›ä¸€ä¸ªæ ·æœ¬çš„ç¬æ—¶å‘é‡é€‰æ‹©å™¨ä¸åŒï¼ŒèŒƒå›´é€‰æ‹©å™¨ä¸ºæ¯ä¸ªæ—¶é—´åºåˆ—è¿”å›å¤šä¸ªæ ·æœ¬ï¼ˆ<code>åŒ…å«ä¸€ç»„æ—¶åºï¼Œæ¯ä¸ªæ—¶åºæœ‰å¤šä¸ªç‚¹</code>ï¼‰å³(åŒ…å«æ¯ä¸ªæ—¶é—´åºåˆ—éšæ—¶é—´å˜åŒ–çš„æ•°æ®ç‚¹èŒƒå›´)ï¼Œå¹¶ä¸”èŒƒå›´å‘é‡æ€»æ˜¯ä¸<code>rateã€avg_over_time</code>å‡½æ•°è”åˆä½¿ç”¨ã€‚</p>
<p><strong>ç¤ºä¾‹è¯´æ˜:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ä¸ºå‡†æŒ‰ç…§åˆ†é’Ÿç²’åº¦è¿”å›ä¸é€‰æ‹©å™¨åŒ¹é…çš„æ‰€æœ‰æ—¶é—´åºåˆ—</span></span><br><span class="line">process_cpu_seconds_total&#123;instance=<span class="string">"aiserver"</span>&#125;[1m]</span><br><span class="line"></span><br><span class="line">                                                                              54969.1 @1629292827.605</span><br><span class="line">                                                                              54969.3 @1629292837.605</span><br><span class="line">process_cpu_seconds_total&#123;instance=<span class="string">"aiserver"</span>, job=<span class="string">"Prod"</span>&#125; 	                  54969.1 @1629292847.605</span><br><span class="line">                                                                              54969.2 @1629292857.605</span><br><span class="line">                                                                              54969.2 @1629292867.605</span><br><span class="line">                                                                              54969.1 @1629292877.605</span><br></pre></td></tr></table></figure></p>
<p>Tips : ä¸Šè¿°ç¤ºä¾‹ç»“æœä¸­æ¯ä¸ªæ—¶é—´åºåˆ—çš„æ ·æœ¬æ°å¥½ç›¸å·®10sï¼Œè¿™ä¸Prometheusé…ç½®çš„æŠ“å–æ—¶é—´ç›¸å…³ä¸€è‡´ï¼Œä½†ä¸¤ä¸ªæ—¶é—´åºåˆ—æ—¶é—´æˆ³ä¸ä¼šç›¸äº’å¯¹é½ã€‚</p>
<p><br/></p>
<h4 id="çº¯é‡æ•°æ®-Scalar"><a href="#çº¯é‡æ•°æ®-Scalar" class="headerlink" title="çº¯é‡æ•°æ® (Scalar)"></a>çº¯é‡æ•°æ® (Scalar)</h4><p><code>æ ‡é‡</code>: çº¯é‡åªæœ‰ä¸€ä¸ªæ•°å­—ï¼Œæ²¡æœ‰æ—¶åºï¼Œä¾‹å¦‚ï¼š<code>count(prometheus_prometheus_http_requests_total)</code>æ‰§è¡Œç»“æœä¸º:<code>{} 20</code></p>
<p><strong>ç¤ºä¾‹è¯´æ˜:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) çº¯é‡åªæœ‰ä¸€ä¸ªæ•°å­—ï¼Œæ²¡æœ‰æ—¶åº</span></span><br><span class="line">prometheus_prometheus_http_requests_total&#123;code=<span class="string">"200"</span>,&#125;</span><br><span class="line">  <span class="comment"># prometheus_prometheus_http_requests_total&#123;code="200", handler="/metrics", instance="localhost:9090", job="LocalServer"&#125;  82016</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : åœ¨é‡‡ç”¨Graphè¿›è¡Œå±•ç¤ºæ—¶ï¼ŒæŸ¥è¯¢çš„è¡¨è¾¾å¼ç±»å‹â€range vectorâ€æ˜¯æ— æ•ˆå¯å¯¼è‡´æ‰§è¡ŒæŸ¥è¯¢æ—¶å‡ºé”™ï¼Œå¿…é¡»æ˜¯æ ‡é‡æˆ–å³æ—¶å‘é‡ã€‚</p>
<h4 id="å­—ç¬¦ä¸²æ•°æ®-String"><a href="#å­—ç¬¦ä¸²æ•°æ®-String" class="headerlink" title="å­—ç¬¦ä¸²æ•°æ® (String)"></a>å­—ç¬¦ä¸²æ•°æ® (String)</h4><p>æè¿°: ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²å€¼ï¼›ç›®å‰æœªä½¿ç”¨ã€‚</p>
<p><br></p>
<h3 id="4-é€‰æ‹©å™¨-Selector"><a href="#4-é€‰æ‹©å™¨-Selector" class="headerlink" title="4.é€‰æ‹©å™¨ - (Selector)"></a>4.é€‰æ‹©å™¨ - (<code>Selector</code>)</h3><p>æè¿°ï¼šåœ¨ Prometheus æµè§ˆå™¨è¡¨è¾¾å¼ä¸­é€‰æ‹©å™¨éå¸¸é‡è¦ï¼Œå®ƒå¯ä»¥ç¼©å°æˆ‘ä»¬æŸ¥è¯¢æˆ–è€…è¦å¤„ç†çš„æ—¶é—´åºåˆ—èŒƒå›´ã€‚é€šè¿‡åœ¨èŠ±æ‹¬å· ( {}) ä¸­é™„åŠ é€—å·åˆ†éš”çš„æ ‡ç­¾åŒ¹é…å™¨åˆ—è¡¨æ¥è¿›ä¸€æ­¥è¿‡æ»¤è¿™äº›æ—¶é—´åºåˆ—ã€‚</p>
<p>ä¾‹å¦‚: job=â€nodeâ€ è¢«ç§°ä¸ºåŒ¹é…å™¨ï¼Œå¹¶ä¸”ä½ å¯ä»¥åœ¨ä¸€ä¸ªé€‰æ‹©å™¨åˆ©ç”¨å¤šä¸ªåŒ¹é…å™¨ä¸²åœ¨ä¸€èµ·ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go_info&#123;BusinessType=<span class="string">"jszg"</span>,env=<span class="string">"prod"</span>&#125;</span><br><span class="line">  <span class="comment"># go_info&#123;BusinessType="jszg", instance="192.168.1.69:9100", job="Win", version="go1.15.6"&#125; 1</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="5-åŒ¹é…å™¨-Matcher"><a href="#5-åŒ¹é…å™¨-Matcher" class="headerlink" title="5.åŒ¹é…å™¨ - (Matcher)"></a>5.åŒ¹é…å™¨ - (<code>Matcher</code>)</h3><p>æè¿°: å¸¸ç”¨çš„åŒ¹é…å™¨è§£æè¯´æ˜ã€‚</p>
<p><code>=</code> (ç­‰å¼åŒ¹é…å™¨) : æœ€æ˜¯å¸¸ç”¨çš„åŒ¹é…å™¨ï¼Œé€šè¿‡æ­¤æ“ä½œï¼Œä½ å¯ä»¥æŒ‡å®šè¿”å›çš„æ—¶é—´ç³»åˆ—åŒ…å«ä¸€ä¸ªå…·æœ‰ç‰¹å®šå€¼çš„æ ‡ç­¾ã€‚</p>
<ul>
<li>ä¾‹å¦‚: <code>job=&quot;node&quot;</code>ä½œä¸ºä¸€ä¸ªç©ºå€¼æ ‡ç­¾å’Œæ²¡æœ‰è¯¥æ ‡ç­¾ä¸€æ ·, ä½ å¯ä»¥ä½¿ç”¨ <code>foo=&quot;&quot;</code> æ¥æŒ‡å®š <code>foo</code> æ ‡ç­¾ä¸å­˜åœ¨çš„æŒ‡æ ‡ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (1) æŸ¥è¯¢æ ‡ç­¾ instance ä¸º aiserver ä»¥åŠ ä¸å­˜åœ¨ env æ ‡ç­¾çš„ go_info çš„ç›®æ ‡ go_info æŒ‡æ ‡é¡¹ã€‚</span></span><br><span class="line">go_info&#123;env=<span class="string">""</span>,instance=<span class="string">"aiserver"</span>&#125;</span><br><span class="line">  <span class="comment">// go_info&#123;instance="aiserver", job="K8S-Prod", version="go1.15.8"&#125;	1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>!=</code>(å¦å®šçš„ç­‰å¼åŒ¹é…å™¨) : é€šè¿‡æ­¤æ“ä½œï¼Œä½ å¯ä»¥æŒ‡å®šè¿”å›çš„æ—¶é—´ç³»åˆ—æ²¡æœ‰åŒ…å«ç‰¹å®šå€¼çš„æ ‡ç­¾ã€‚</p>
<ul>
<li>ä¾‹å¦‚: <code>job != &quot;node&quot;</code><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (1) æŸ¥è¯¢æ ‡ç­¾ BusinessType ä¸º zk ä»¥åŠ version ä¸ç­‰äº go1.15.8 çš„ç›®æ ‡ go_info æŒ‡æ ‡é¡¹ã€‚</span></span><br><span class="line">go_info&#123;version!=<span class="string">"go1.15.8"</span>,BusinessType=<span class="string">"zk"</span>&#125;</span><br><span class="line">  <span class="comment">// go_info&#123;env="prod", instance="192.168.10.67:9100", job="K8S-Prod", version="go1.15.6"&#125; 1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>=~</code>(æ­£åˆ™è¡¨ç¤ºå¼åŒ¹é…å™¨) : é€šè¿‡æ­¤æ“ä½œï¼Œå®ƒå¯ä»¥å®šæ ‡ç­¾çš„å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼ç›¸åŒ¹é…ã€‚è¡¨è¾¾å¼è¯­æ³•å¯ä»¥åœ¨ç™¾åº¦ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<ul>
<li>ä¾‹å¦‚: <code>job =~ &quot;n.*&quot;</code><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (1) æŸ¥è¯¢æ ‡ç­¾ instance åŒ¹é…çš„ "ai.*" æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„ç›®æ ‡ go_info æŒ‡æ ‡é¡¹ã€‚</span></span><br><span class="line">go_info&#123;instance=~<span class="string">"ai.*"</span>&#125;</span><br><span class="line">  <span class="comment">// go_info&#123;instance="aiserver", job="K8S-Prod", version="go1.15.8"&#125; 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// (2) æ³¨æ„ç‚¹ï¼Œå‘é‡é€‰æ‹©å™¨å¿…é¡»æŒ‡å®šä¸€ä¸ªåç§°æˆ–è‡³å°‘ä¸€ä¸ªä¸ç©ºå­—ç¬¦ä¸²ä¸åŒ¹é…çš„æ ‡ç­¾åŒ¹é…å™¨ã€‚</span></span><br><span class="line">&#123;job=~<span class="string">".*"</span>&#125; # Bad!</span><br><span class="line"><span class="comment">// ç›¸åï¼Œè¿™äº›è¡¨è¾¾å¼æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªä¸åŒ¹é…ç©ºæ ‡ç­¾å€¼çš„é€‰æ‹©å™¨ã€‚</span></span><br><span class="line">&#123;job=~<span class="string">".+"</span>&#125;              # Good!</span><br><span class="line">&#123;job=~<span class="string">".*"</span>,method=<span class="string">"get"</span>&#125; # Good!</span><br><span class="line"></span><br><span class="line"><span class="comment">// (3) ä¾‹å¦‚ï¼Œæ ‡ç­¾åŒ¹é…å™¨ä¹Ÿå¯ä»¥é€šè¿‡ä¸å†…éƒ¨__name__æ ‡ç­¾åŒ¹é…æ¥åº”ç”¨äºåº¦é‡åç§°, è¡¨è¾¾å¼ prometheus_http_requests_total ç­‰æ•ˆäº &#123;__name__="prometheus_http_requests_total"&#125;ã€‚</span></span><br><span class="line">&#123;__name__=~<span class="string">"job:.*"</span>&#125;  <span class="comment">// é€‰æ‹©åç§°ä»¥jobå¼€å¤´çš„æ‰€æœ‰æŒ‡æ ‡</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>!~</code>(æ­£åˆ™è¡¨ç¤ºå¼ååŒ¹é…å™¨) : é€šè¿‡æ­¤æ“ä½œ, å®ƒå¯ä»¥å®šæ ‡ç­¾çš„å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼ä¸ç›¸åŒ¹é…ã€‚</p>
<ul>
<li>ä¾‹å¦‚: <code>job !~ &quot;n.*&quot;</code><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (1) æŸ¥è¯¢æ ‡ç­¾ env ä¸åŒ¹é…çš„ "p.*" ä¸ºå€¼çš„ç›®æ ‡ go_info æŒ‡æ ‡é¡¹ã€‚</span></span><br><span class="line">go_info&#123;env!~<span class="string">"p.*"</span>,instance=<span class="string">"aiserver"</span>&#125;</span><br><span class="line">  <span class="comment">// go_info&#123;instance="aiserver", job="K8S-Prod", version="go1.15.8"&#125; 1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : Prometheus ä¸­çš„æ‰€æœ‰æ­£åˆ™è¡¨è¾¾å¼éƒ½ä½¿ç”¨RE2 è¯­æ³•ï¼ˆ<a href="https://github.com/google/re2/wiki/Syntaxï¼‰ã€‚" target="_blank" rel="noopener">https://github.com/google/re2/wiki/Syntaxï¼‰ã€‚</a></p>
<p><br/></p>
<p><strong>ç¤ºä¾‹æ¼”ç¤º:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) åœ¨é€‰æ‹©å™¨ä¸­ä½¿ç”¨å…·æœ‰ç›¸åŒæ ‡ç­¾åç§°çš„å¤šä¸ªåŒ¹é…å™¨ï¼ŒæŸ¥æ‰¾ job ä¸º Linux, æ ‡ç­¾ device ä¸ä¸º `tmpfs|shm`, æ ‡ç­¾ mountpoint ä¸º / æ ¹çš„æ‰€ä»¥æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ã€‚</span></span><br><span class="line">node_filesystem_size_bytes&#123;job=~<span class="string">"L.*"</span>, device!~<span class="string">"tmpfs|shm"</span>,mountpoint=~<span class="string">"/$"</span>&#125; / 1024^3</span><br><span class="line">  <span class="comment"># &#123; device="/dev/mapper/ubuntu--vg-lv--0", fstype="ext4", instance="192.168.1.12:9100", job="Linux", mountpoint="/"&#125; 	96.94237518310547</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) åœ¨é€‰æ‹©å™¨ä¸­è‡³å°‘ä¸€ä¸ªåŒ¹é…å™¨çš„å€¼ä¸èƒ½ä¸ç©ºå­—ç¬¦ä¸²ç›¸åŒ¹é…ã€‚å¦‚ &#123;foo="", foo!=""&#125; å’Œ &#123;foo =~ ".*"&#125; å°†è¿”å›é”™è¯¯ï¼Œè€Œ&#123;foo="", bar="x"&#125; æˆ– &#123;foo=~".+"&#125; æ˜¯æ­£å¸¸çš„ã€‚</span></span><br><span class="line">node_filesystem_size_bytes&#123;job=~<span class="string">"Linux"</span>, mountpoint=~<span class="string">"/$"</span>&#125; / 1024^3</span><br><span class="line">  <span class="comment"># &#123; device="/dev/mapper/ubuntu--vg-lv--0", fstype="ext4", instance="192.168.1.12:9100", job="Linux", mountpoint="/"&#125;   96.94237518310547</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) æ­¤é€‰æ‹©æ‰€æœ‰prometheus_http_requests_totalçš„æ—¶é—´åºåˆ—stagingï¼Œ testingä»¥åŠdevelopmentç¯å¢ƒå’ŒHTTPé™¤å¼€GETçš„å…¶ä»–æ–¹æ³•ã€‚</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="6-åç§»ä¿®æ”¹å™¨-Offset"><a href="#6-åç§»ä¿®æ”¹å™¨-Offset" class="headerlink" title="6.åç§»ä¿®æ”¹å™¨ - (Offset)"></a>6.åç§»ä¿®æ”¹å™¨ - (<code>Offset</code>)</h3><p>æè¿°: è¯¥ä¿®é¥°ç¬¦å¯ä»¥é€‚ç”¨äºä»»æ„ç±»å‹çš„å‘é‡é€‰æ‹©å™¨ï¼Œå®ƒå¯ä»¥è®©ä½ è·å–æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ï¼Œå¹¶åœ¨æ¯ä¸ªé€‰æ‹©å™¨çš„å½“å‰åŸºç¡€ä¸Šå°†å…¶å›é€€åˆ°è¿‡å»çš„è¿™ä¸ªæ—¶é—´ä¸Š, å³å¯ä»¥æ”¹å˜æ—¶é—´ä¸ºæŸ¥è¯¢ä¸­çš„ä¸ªåˆ«æ—¶åˆ»å’ŒèŒƒå›´çŸ¢é‡åç§»ã€‚ã€‚</p>
<p>Tips: è¯·æ³¨æ„ <code>offset ä¿®é¥°ç¬¦</code>æ€»æ˜¯éœ€è¦ç«‹å³è·Ÿéšé€‰æ‹©å™¨</p>
<p><strong>ç¤ºä¾‹æ¼”ç¤º:</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡¨è¾¾å¼è¿”å› prometheus_http_requests_totalè¿‡å» 5 åˆ†é’Ÿç›¸å¯¹äºå½“å‰æŸ¥è¯¢è¯„ä¼°æ—¶é—´çš„å€¼ï¼š</span></span><br><span class="line">prometheus_http_requests_total offset <span class="number">5</span>m</span><br><span class="line">sum(prometheus_http_requests_total&#123;method=<span class="string">"GET"</span>&#125; offset <span class="number">5</span>m) <span class="comment">// GOOD.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥è¯¢ localhost:9090 æ‰§è¡Œçš„å†…å­˜ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">process_resident_memory_bytes&#123;instance=<span class="string">"localhost:9090"</span>&#125;  <span class="comment">// 731750400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥è¯¢ localhost:9090 æ‰§è¡Œæ—¶é—´å‰ä¸€ä¸ªå°æ—¶çš„å†…å­˜ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">process_resident_memory_bytes&#123;instance=<span class="string">"localhost:9090"</span>&#125; offset <span class="number">1</span>h <span class="comment">// 748228608</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼ŒåŒæ ·é€‚ç”¨äºèŒƒå›´å‘é‡, æŸ¥è¯¢åœ¨è¿‡å»çš„1hå†…å¯¼å‡ºå™¨æš´éœ²ä½¿ç”¨çš„cpuå˜åŒ–è¯·æ±‚ï¼ˆé€‚ç”¨äºèŒƒå›´å˜é‡ï¼‰</span></span><br><span class="line">rate(process_cpu_seconds_total&#123;instance=<span class="string">"localhost:9090"</span>&#125;[<span class="number">5</span>m]) </span><br><span class="line">- </span><br><span class="line">rate(process_cpu_seconds_total&#123;instance=<span class="string">"localhost:9090"</span>&#125;[<span class="number">5</span>m] offset <span class="number">1</span>h)  <span class="comment">// 	-0.006089652962922479</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="7-ä¿®é¥°ç¬¦"><a href="#7-ä¿®é¥°ç¬¦" class="headerlink" title="7.ä¿®é¥°ç¬¦ - @"></a>7.ä¿®é¥°ç¬¦ - <code>@</code></h3><p>æè¿°: æ‰€è¿°@æ”¹æ€§å‰‚å…è®¸æ”¹å˜è¯„ä»·æ—¶é—´ä¸ºæŸ¥è¯¢ä¸­çš„ä¸ªåˆ«æ—¶åˆ»å’ŒèŒƒå›´çš„è½½ä½“ã€‚æä¾›ç»™@ä¿®é¥°ç¬¦çš„æ—¶é—´æ˜¯ä¸€ä¸ª unix æ—¶é—´æˆ³å¹¶ç”¨æµ®ç‚¹æ–‡å­—æè¿°ã€‚</p>
<p>Tips : è¯·æ³¨æ„ï¼Œ@ä¿®é¥°ç¬¦æ€»æ˜¯éœ€è¦ç«‹å³è·Ÿéšé€‰æ‹©å™¨ã€‚<br>Tips : é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨æ­¤ä¿®é¥°ç¬¦, æ­¤åŠŸèƒ½é€šè¿‡è®¾ç½® <code>--enable-feature=promql-at-modifier</code> æ ‡å¿—å¯ç”¨ã€‚</p>
<p><br></p>
<p><strong>ç¤ºä¾‹æ¼”ç¤º:</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡¨è¾¾å¼è¿”å› prometheus_prometheus_http_requests_totalçš„å€¼ 2021-01-04T07:40:00+00:00ï¼š</span></span><br><span class="line">prometheus_prometheus_http_requests_total&#123;handler=<span class="string">"/metrics"</span>&#125; @ <span class="number">1609746000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼Œ@ä¿®é¥°ç¬¦æ€»æ˜¯éœ€è¦ç«‹å³è·Ÿéšé€‰æ‹©å™¨</span></span><br><span class="line">sum(prometheus_prometheus_http_requests_total&#123;handler=<span class="string">"/metrics"</span>&#125; @ <span class="number">1609746000</span>) <span class="comment">// GOOD.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼Œé€‚ç”¨äºèŒƒå›´å‘é‡ï¼Œå°†è¿”å›5åˆ†é’Ÿçš„é€Ÿåº¦ prometheus_prometheus_http_requests_total æ›¾åœ¨2021-01-04T07:40:00+00:00ï¼š</span></span><br><span class="line">rate(prometheus_prometheus_http_requests_total&#123;handler=<span class="string">"/metrics"</span>&#125;[<span class="number">5</span>m] @ <span class="number">1609746000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼Œ@ä¿®é¥°ç¬¦ä¸offsetä¿®æ”¹å™¨ä¸€èµ·ä½¿ç”¨ï¼Œå…¶ä¸­åç§»æ˜¯ç›¸å¯¹äº @ ä¿®æ”¹å™¨æ—¶é—´åº”ç”¨çš„ï¼Œè€Œä¸ç®¡å“ªä¸ªä¿®æ”¹å™¨é¦–å…ˆè¢«å†™å…¥</span></span><br><span class="line"># offset after @</span><br><span class="line">prometheus_prometheus_http_requests_total @ <span class="number">1609746000</span> offset <span class="number">5</span>m</span><br><span class="line"># offset before @</span><br><span class="line">prometheus_prometheus_http_requests_total offset <span class="number">5</span>m @ <span class="number">1609746000</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : <code>start()</code> å¹¶ä¸” <code>end()</code> è¿˜å¯ä»¥ç”¨ä½œå€¼@ä¿®æ­£ä¸ºç‰¹æ®Šå€¼, </p>
<ul>
<li>å¯¹äºå³æ—¶æŸ¥è¯¢ï¼Œstart() ä¸ end() éƒ½æœ‰çš„è¯„ä¼°æ—¶é—´ã€‚</li>
<li>å¯¹äºèŒƒå›´æŸ¥è¯¢, å®ƒä»¬åˆ†åˆ«è§£æä¸ºèŒƒå›´æŸ¥è¯¢çš„å¼€å§‹å’Œç»“æŸï¼Œå¹¶åœ¨æ‰€æœ‰æ­¥éª¤ä¸­ä¿æŒä¸å˜ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prometheus_prometheus_http_requests_total @ start()</span><br><span class="line">rate(prometheus_prometheus_http_requests_total[5m] @ end())</span><br></pre></td></tr></table></figure>
method:prometheus_prometheus_http_requests_total:rate5m{method=â€getâ€} </li>
</ul>
<p><br/></p>
<h3 id="8-å­æŸ¥è¯¢"><a href="#8-å­æŸ¥è¯¢" class="headerlink" title="8.å­æŸ¥è¯¢"></a>8.å­æŸ¥è¯¢</h3><p>æè¿°: å­æŸ¥è¯¢å…è®¸æ‚¨å¯¹ç»™å®šçš„èŒƒå›´å’Œåˆ†è¾¨ç‡è¿è¡Œå³æ—¶æŸ¥è¯¢ã€‚</p>
<p>Tips : å­æŸ¥è¯¢çš„ç»“æœæ˜¯ä¸€ä¸ªèŒƒå›´å‘é‡</p>
<p>æ ¼å¼å®šä¹‰:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;resolution&gt;æ˜¯å¯é€‰çš„ã€‚é»˜è®¤ä¸ºå…¨å±€è¯„ä¼°åŒºé—´ã€‚</span></span><br><span class="line">&lt;instant_query&gt; <span class="string">'['</span> &lt;<span class="keyword">range</span>&gt; <span class="string">':'</span> [&lt;resolution&gt;] <span class="string">']'</span> [ @ &lt;float_literal&gt; ] [ offset &lt;duration&gt; ]</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="9-æŸ¥è¯¢ç±»å‹"><a href="#9-æŸ¥è¯¢ç±»å‹" class="headerlink" title="9.æŸ¥è¯¢ç±»å‹"></a>9.æŸ¥è¯¢ç±»å‹</h3><h4 id="Counter-ç±»å‹"><a href="#Counter-ç±»å‹" class="headerlink" title="Counter ç±»å‹"></a>Counter ç±»å‹</h4><p>æè¿°: å®ƒæ˜¯ä½¿ç”¨æœ€é¢‘ç¹çš„æ•°æ®ç±»å‹ï¼Œå…¶è®°å½•çš„æ˜¯äº‹ä»¶çš„æ•°é‡æˆ–è€…å¤§å°ï¼Œé€šå¸¸ç”¨æ¥è·Ÿè¸ªæŸä¸ªç‰¹å®šä»£ç è·¯å¾„è¢«æ‰§è¡Œçš„é¢‘ç‡ï¼Œæ­¤ç±»å‹å…¶æ ¹æœ¬çš„çš„æ„ä¹‰æ˜¯è®¡æ•°å™¨éšç€æ—¶é—´çš„æ¨ç§»è€Œå¢åŠ çš„é€Ÿåº¦ã€‚</p>
<p>Tips : å¯¹äºPromQLè€Œè¨€å¿…é¡»ç¡®ä¿Counterå˜é‡æ˜¯é€’å¢çš„ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½ä¿è¯rateæˆ–è€…å…¶å®ƒå‡½æ•°ä¸ä¼šæŠŠcounterçš„å‡å°‘è¯¯å½“åšåº”ç”¨é‡å¯åCounterç½®é›¶æ“ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) è®¡ç®—æ¯ç§’æ¥æ”¶çš„ç½‘ç»œæµé‡</span></span><br><span class="line">rate(node_network_receive_bytes_total&#123;job=<span class="string">"Linux"</span>&#125;[5m])</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) [5m]è¡¨ç¤ºå¹³å‡5minæ•°æ®çš„æ¯”ç‡å…¶è¿”å›å€¼å°†è¿‡å»5minçš„æ¯ç§’å¹³å‡å€¼ã€‚</span></span><br><span class="line">sum without(device)(rate(node_network_receive_bytes_total&#123;job=<span class="string">"Linux"</span>&#125;[5m]))</span><br><span class="line">  <span class="comment"># &#123; instance="192.168.1.12:9100", job="Linux"&#125;  575.2595748148149</span></span><br></pre></td></tr></table></figure>
<p>Tips : æ ‡ç­¾æ²¡æœ‰é¡ºåºæˆ–å±‚æ¬¡ç»“æ„ï¼Œå…è®¸ä½ å¯ä»¥æ ¹æ®éœ€æ±‚èšåˆå°½å¯èƒ½å¤šçš„æ ‡ç­¾ã€‚</p>
<p><br/></p>
<h4 id="Gauge-ç±»å‹"><a href="#Gauge-ç±»å‹" class="headerlink" title="Gauge ç±»å‹"></a>Gauge ç±»å‹</h4><p>æè¿°: å­˜å‚¨çš„æ˜¯å½“å‰çŠ¶æ€çš„å¿«ç…§ï¼Œå…¶å…³å¿ƒçš„æ˜¯æ•°å€¼æœ¬èº«ï¼Œå› æ­¤æ­¤ç±»å‹çš„æ•°æ®ç±»å‹çš„å€¼å¯å‡å¯é™ã€‚ä¾‹å¦‚: ä½¿ç”¨Gaugeæ•°æ®ç±»å‹çš„ä¾‹å­åŒ…æ‹¬é˜Ÿåˆ—ä¸­å…ƒç´ ä¸ªæ•°ã€ç¼“å­˜çš„å†…å­˜ä½¿ç”¨ç‡ï¼Œæ´»è·ƒçš„çº¿ç¨‹æ•°ï¼Œæœ€åä¸€åˆ†é’Ÿæ—¶é—´é‡Œæ²¡ç§’çš„å¹³å‡è¯·æ±‚æ•°ã€‚</p>
<p>Tips : Gauge æä¾›ä¸‰ç§ä¸»è¦çš„æ–¹æ³•ä¾›ä½ ä½¿ç”¨<code>inc(å¢åŠ )ã€dec(å‡å°‘)æˆ–è€…setæ–¹æ³•</code>ï¼Œå¹¶ä¸”å¯ä»¥å°†è´Ÿå€¼ä¼ é€’ç»™Gaugeç±»å‹çš„incæ–¹æ³•ã€‚</p>
<ul>
<li><p>æŸ¥è¯¢è®¡ç®—æ¯å°è®¡ç®—æœºä¸Šæ–‡ä»¶ç³»ç»Ÿçš„æ€»å¤§å°ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sum without(device,fstype,mountpoint)(node_filesystem_size_bytes&#123;job=<span class="string">"weiyigeek-Linux"</span>&#125;) / 1024^3</span><br><span class="line">  <span class="comment"># &#123;env="prod",instance="192.168.1.12:9100", job="weiyigeek-Linux"&#125; 201.34028244018555</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥è¯¢æ¯å°æœºå™¨ä¸Šæœ€å¤§çš„æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">max without(device,fstype,mountpoint)(node_filesystem_size_bytes&#123;job=<span class="string">"weiyigeek-Linux"</span>&#125;) / 1024^3</span><br><span class="line"></span><br><span class="line">  <span class="comment"># &#123;env="prod", instance="192.168.1.12:9100", job="weiyigeek-Linux"&#125; 	100</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥è¯¢æ¯å°æœºå™¨ä¸ŠæŒ‚è½½ç‚¹å¹³å‡çš„æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">avg without(device,fstype,mountpoint)(node_filesystem_size_bytes&#123;job=<span class="string">"weiyigeek-Linux"</span>&#125;) / 1024^3</span><br><span class="line"></span><br><span class="line">  <span class="comment"># &#123;env="prod", instance="192.168.1.12:9100", job="weiyigeek-Linux"&#125; 18.303662040016867</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h4 id="Summary-ç±»å‹"><a href="#Summary-ç±»å‹" class="headerlink" title="Summary ç±»å‹"></a>Summary ç±»å‹</h4><p>æè¿°: è¯¥æ•°æ®ç±»å‹æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯observeå¯ä»¥é€šè¿‡è¯¥æ–¹æ³•ä¼ é€’äº‹ä»¶çš„å¤§å°<code>(æ³¨æ„å¿…é¡»æ˜¯éè´Ÿæ•°)</code>å³è·Ÿè¸ªå»¶è¿Ÿã€‚</p>
<p>Tips: è¯¥ç±»å‹ä¹Ÿå¯èƒ½åŒ…æ‹¬äº†åˆ†ä¸ºæ•°,æ­¤å¤–å°±CPUä½¿ç”¨ç‡è€Œè¨€ï¼Œå®¢æˆ·ç«¯åˆ†ä½æ•°ä¸å…¶å®ƒæµ‹æ§ç›¸æ¯”æ˜¯ä»£ä»·æ˜‚è´µçš„(æ…¢ä¸€ç™¾å€ä¹Ÿä¸ç½•è§)ã€‚</p>
<p>ä¾‹å¦‚: åˆ©ç”¨ prometheus_http_response_size_bytes_count æŒ‡æ ‡ å¯ä»¥ è·Ÿè¸ªAPIè¯·æ±‚çš„æ•°é‡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) æŸ¥è¯¢å¹¶è¿”å›æä¾›æ¯ç§’çš„æ€»è¯·æ±‚æ•°</span></span><br><span class="line">sum without(handler)(rate(prometheus_http_response_size_bytes_count[5m]))</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="LocalServer"&#125; 0.015740740740740743</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2)æŸ¥è¯¢å¹¶è¿”å›æ¯ä¸ªHandlerè¿”å›çš„å­—èŠ‚æ•°</span></span><br><span class="line">sum without(handler)(rate(prometheus_http_response_size_bytes_sum[5m]))</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="LocalServer"&#125; 156.97563272222223</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) ä½ å°†_sum é™¤ä»¥ _count(åœ¨æ‰§è¡Œrateå)æ¥è·å¾—ä¸€æ®µæ—¶é—´å†…çš„å¹³å‡å€¼ï¼Œä¾‹å¦‚ä¸‹é¢è¿‡å» 5min çš„å¹³å‡å“åº”å¤§å°ä¸ºå€¼ã€‚</span></span><br><span class="line">sum without(handler)(rate(prometheus_http_response_size_bytes_sum[5m]))</span><br><span class="line">/ </span><br><span class="line">sum without(handler)(rate(prometheus_http_response_size_bytes_count[5m]))</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="LocalServer"&#125; 13236</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) å¦‚æœè¦è·å¾—ä¸€ä¸ªä»»åŠ¡çš„æ‰€æœ‰å®ä¾‹å¹³å‡å“åº”å­—èŠ‚å¤§å°</span></span><br><span class="line">sum without(instance) (</span><br><span class="line">  sum without(handler)(rate(prometheus_http_response_size_bytes_sum[5m]))</span><br><span class="line">)</span><br><span class="line">/ </span><br><span class="line">sum without(instance) (</span><br><span class="line">  sum without(handler)(rate(prometheus_http_response_size_bytes_count[5m]))</span><br><span class="line">)</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="LocalServer"&#125; 13236</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<h4 id="Histogram-ç±»å‹"><a href="#Histogram-ç±»å‹" class="headerlink" title="Histogram ç±»å‹"></a>Histogram ç±»å‹</h4><p>æè¿°: è¯¥ç±»å‹æŒ‡æ ‡å…è®¸ä½ è·Ÿè¸ªäº‹ä»¶å¤§å°çš„åˆ†å¸ƒï¼ˆ<code>æä¾›å¹³å‡å»¶è¿Ÿæ•°æ®</code>ï¼‰ï¼Œå…è®¸ä½ ç”¨å®ƒä»¬æ¥è®¡ç®—åˆ†ä½æ•°ï¼Œåˆ†ä½æ•°å¯ä»¥å‘Šè¯‰ä½ ä½äºæŸä¸ªå€¼çš„äº‹ä»¶ä¸ªæ•°ï¼Œä¾‹å¦‚: <code>0.95åˆ†ä½æ•°ä¸º300ms</code>åˆ™ä»£è¡¨95%çš„è¯·æ±‚è€—æ—¶å°äº300msã€‚</p>
<p>Tips : åˆ†ä½æ•°å’Œç™¾åˆ†ä½æˆ‘ä»¬è¯´çš„95%æ˜¯0.95åˆ†ä½æ•°ï¼Œç”±äºæ›´å–œæ¬¢åŸºæœ¬å•ä½æ‰€ä»¥é€šå¸¸ä½¿ç”¨åˆ†ä½æ•°ï¼Œè€Œåœ¨æ¯”ä¾‹çš„æ—¶å€™ä¼˜å…ˆä½¿ç”¨ç™¾åˆ†ä½ã€‚</p>
<p>Tips : Histogram ç±»å‹æ˜¯æœ‰æ ‡ç­¾çš„ã€‚</p>
<p><strong>æ¡¶(Buckets)è¯´æ˜</strong><br>æè¿°: é»˜è®¤çš„æ¶µç›–ä»1ms~10sèŒƒå›´å†…çš„å»¶è¿Ÿï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰æŒ‡æ ‡çš„æ—¶å€™è¦†ç›–ä»–ä»¬å¹¶æä¾›è‡ªå·±çš„æ¡¶ã€‚å»ºè®®ä¿æŒåœ¨10ä¸ªå·¦å³æ‰èƒ½ä¿è¯è¶³å¤Ÿçš„å‡†ç¡®ç‡ï¼Œè¯¥æ•°å­—çœ‹èµ·æ¥å¾ˆå°çš„æ•°å­—ï¼Œä½†æ˜¯å­˜å‚¨æ¡¶æ˜¯éœ€è¦æˆæœ¬ï¼Œå¹¶ä¸”æ¯ä¸ªæ¡¶éƒ½æ˜¯ä¸€ä¸ªé¢å¤–çš„æ—¶åºå­˜å‚¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨äºè·Ÿè¸ªæ—¶åºæ•°æ®åº“å‹ç¼©æ‰€éœ€çš„ç§’æ•° : prometheus_tsdb_compaction_duration_seconds</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) åœ¨0.90åˆ†ä½æ•°å°†ç”¨äºè·Ÿè¸ªæ—¶åºæ•°æ®åº“å‹ç¼©æ‰€éœ€çš„ç§’æ•°, è¡¨æ˜å‹ç¼©çš„ç¬¬90ä¸ªç™¾åˆ†ä½å»¶çº¦ä¸º 3.2sã€‚</span></span><br><span class="line">histogram_quantile(</span><br><span class="line">  0.90,</span><br><span class="line">  sum without(instance)(rate(prometheus_tsdb_compaction_duration_seconds_bucket[1d]))</span><br><span class="line">)</span><br><span class="line">  <span class="comment"># &#123;job="LocalServer"&#125; 3.2 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) è®¡ç®—äº‹ä»¶å¹³å‡å¤§å°ä¾‹å¦‚å‹ç¼©å¹³å‡æŒç»­æ—¶é—´ã€‚</span></span><br><span class="line">sum without(instance)(rate(prometheus_tsdb_compaction_duration_seconds_sum[1d])) </span><br><span class="line">/ </span><br><span class="line">sum without(instance)(rate(prometheus_tsdb_compaction_duration_seconds_count[1d]))</span><br><span class="line">  <span class="comment"># &#123;job="LocalServer"&#125; 2.317425352000015</span></span><br></pre></td></tr></table></figure>
<p>Tips : é€šå¸¸ä½¿ç”¨<code>5~10 min</code>çš„é—´éš”æ¥è¿›è¡Œç›´æ–¹å›¾ <code>rate</code> å‡½æ•°è®¡ç®—ï¼Œæ‰€æœ‰æ¡¶ä¸­çš„æ—¶é—´åºåˆ—å°†æ ¹æ®ä»»ä½•æ ‡ç­¾è¿›è¡Œç»“åˆï¼Œå¹¶ä¸”rateèŒƒå›´è¶Šé•¿ï¼Œå°±ä¼šæœ‰æ›´å¤šçš„æ•°æ®æ ·æœ¬éœ€è¦å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è­¦æƒ•ä½¿ç”¨<code>å°æ—¶(hour)</code>æˆ–è€…<code>å¤©æ•°(Days)</code>èŒƒå›´çš„PromQLè¡¨è¾¾å¼, å› æ­¤å®ƒä»¬çš„è®¡ç®—æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚</p>
<p><br/></p>
<h3 id="10-APIæŸ¥è¯¢æŒ‡æ ‡æ•°æ®"><a href="#10-APIæŸ¥è¯¢æŒ‡æ ‡æ•°æ®" class="headerlink" title="10.APIæŸ¥è¯¢æŒ‡æ ‡æ•°æ®"></a>10.APIæŸ¥è¯¢æŒ‡æ ‡æ•°æ®</h3><p>æè¿°: Prometheus æä¾›äº†è®¸å¤šHTTP API, å®ƒä»¬å…è®¸ä½ è¾“å…¥PromQLè¯­å¥ï¼Œå¹¶è¿”å›æ•°æ®ä½¿å¾—å¯ä»¥ç”¨åœ¨ä»ªè¡¨æ¿å·¥å…·æˆ–è‡ªå®šä¹‰æŠ¥å‘Šè„šæœ¬ä¸­ã€‚</p>
<h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><p>æè¿°: åœ¨ç»™å®šçš„æ—¶é—´æ‰§è¡ŒPromQLè¡¨è¾¾å¼å¹¶è¿”å›ç»“æœï¼Œæ³¨æ„å…¶æ”¯æŒå¸¦å…¥æ ‡ç­¾è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤çš„ã€‚</p>
<p><strong>ç¤ºä¾‹1ï¼šä½¿ç”¨å½“å‰æ—¶é—´è¿›è¡ŒæŒ‡æ ‡æŸ¥è¯¢</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.0.0.107:30090/api/v1/query?query=go_info&#123;job=<span class="string">"Server"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#// è¿”å›ç»“æœ:</span></span><br><span class="line">&#123;<span class="string">"status"</span>:<span class="string">"success"</span>,<span class="string">"data"</span>:&#123;<span class="string">"resultType"</span>:<span class="string">"vector"</span>,<span class="string">"result"</span>:[&#123;<span class="string">"metric"</span>:&#123;<span class="string">"__name__"</span>:<span class="string">"go_info"</span>,<span class="string">"instance"</span>:<span class="string">"localhost:9090"</span>,<span class="string">"job"</span>:<span class="string">"Server"</span>,<span class="string">"version"</span>:<span class="string">"go1.16.2"</span>&#125;,<span class="string">"value"</span>:[1629539549.827,<span class="string">"1"</span>]&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#// ç»“æœè¯´æ˜:</span></span><br><span class="line">status å­—æ®µ : success (æŸ¥è¯¢æœ‰æ•ˆ) | error (æŸ¥è¯¢æœ‰è¯¯)ã€‚</span><br><span class="line">resultType å­—æ®µ : ç»“æœç±»å‹æ˜¯ä¸€ä¸ªæ˜¯ä¸ªç¬æ—¶å‘é‡ã€‚</span><br><span class="line">metric å­—æ®µ : å­˜æ”¾è¯¥æŒ‡æ ‡çš„ç›¸å…³å…³è”æ ‡ç­¾ã€‚</span><br><span class="line">value å­—æ®µ : ç¬¬ä¸€ä¸ªå€¼ä¸ºæ ·æœ¬æ—¶é—´æˆ³ï¼Œç¬¬äºŒä¸ªä¸ºå…¶å€¼</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>ç¤ºä¾‹2:æŒ‡å®šæ—¶é—´è¿›è¡ŒæŸ¥è¯¢æŒ‡æ ‡</strong><br>æè¿°: æˆ‘ä»¬å¯ä»¥ä¼ å…¥Unixæ ¼å¼çš„æ—¶é—´æˆ–è€…<code>RFC 3339</code>æ ‡å‡†çš„æ—¶é—´<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.0.0.107:30090/api/v1/query?query=node_memory_Active_bytes&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;&amp;time=1629539549  <span class="comment"># 2021-08-21 17:52:29</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›ç»“æœ:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"status"</span>: <span class="string">"success"</span>,</span><br><span class="line">  <span class="string">"data"</span>: &#123;</span><br><span class="line">    <span class="string">"resultType"</span>: <span class="string">"vector"</span>,</span><br><span class="line">    <span class="string">"result"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"metric"</span>: &#123;</span><br><span class="line">          <span class="string">"__name__"</span>: <span class="string">"node_memory_Active_bytes"</span>,</span><br><span class="line">          <span class="string">"env"</span>: <span class="string">"prod"</span>,</span><br><span class="line">          <span class="string">"instance"</span>: <span class="string">"10.0.0.107:9100"</span>,</span><br><span class="line">          <span class="string">"job"</span>: <span class="string">"linux_exporter"</span>,</span><br><span class="line">          <span class="string">"nodeType"</span>: <span class="string">"master"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"value"</span>: [</span><br><span class="line">          1629539549,</span><br><span class="line">          <span class="string">"5097132032"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>ç¤ºä¾‹3: æ”¯æŒèŒƒå›´å‘é‡è¿›è¡ŒæŸ¥è¯¢ï¼ˆä½†ä¸€èˆ¬éƒ½é‡‡ç”¨query_range è€Œé queryï¼‰</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.0.0.107:30090/api/v1/query?query=prometheus_http_requests_total&#123;handler=<span class="string">"/metrics"</span>,instance=<span class="string">"localhost:9090"</span>&#125;[5m]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›ç»“æœ:</span></span><br><span class="line">&#123;<span class="string">"status"</span>:<span class="string">"success"</span>,<span class="string">"data"</span>:&#123;<span class="string">"resultType"</span>:<span class="string">"matrix"</span>,<span class="string">"result"</span>:[&#123;<span class="string">"metric"</span>:&#123;<span class="string">"__name__"</span>:<span class="string">"prometheus_http_requests_total"</span>,<span class="string">"code"</span>:<span class="string">"200"</span>,<span class="string">"handler"</span>:<span class="string">"/metrics"</span>,<span class="string">"instance"</span>:<span class="string">"localhost:9090"</span>,<span class="string">"job"</span>:<span class="string">"Server"</span>&#125;,<span class="string">"values"</span>:[[1629540385.147,<span class="string">"8"</span>],[1629540505.147,<span class="string">"9"</span>]]&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>ç¤ºä¾‹4.åˆ©ç”¨æ ‡é‡è¿›è¡ŒæŸ¥è¯¢ï¼Œå…¶æ²¡æœ‰æ ‡ç­¾åªæ˜¯æ•°å­—</strong><br>æè¿°: ä¸ {} ä¸åŒï¼Œåè€…æ˜¯ä¸€ä¸ªæ²¡æ ‡ç­¾çš„æ—¶é—´åºåˆ—æ ‡è¯†ç¬¦ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.0.0.107:30090/api/v1/query?query=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œç»“æœ</span></span><br><span class="line">&#123;<span class="string">"status"</span>:<span class="string">"success"</span>,<span class="string">"data"</span>:&#123;<span class="string">"resultType"</span>:<span class="string">"scalar"</span>,<span class="string">"result"</span>:[1629540849.286,<span class="string">"1"</span>]&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="Query-range"><a href="#Query-range" class="headerlink" title="Query_range"></a>Query_range</h4><p>æè¿°: ä¸»è¦é‡‡ç”¨å…¶apiè¿›è¡ŒæŸ¥è¯¢æŸ¥è¯¢å¹¶è¿”å›èŒƒå›´å‘é‡çš„æŒ‡æ ‡ç»“æœï¼Œå…¶é™¤äº†æŸ¥è¯¢æŒ‡æ ‡å‚æ•°å¤–ï¼Œè¿˜æœ‰æä¾›startã€endã€stepå‚æ•°ã€‚</p>
<p>Tips : å°†æ¥è‡ªä¸åŒæ‰§è¡Œçš„æ‰€æœ‰ç¬æ—¶å‘é‡ç»„åˆæˆèŒƒå›´å‘é‡å¹¶è¿”å›ã€‚</p>
<p>ä¾‹å¦‚: æŸ¥è¯¢å‰15åˆ†é’Ÿå†…è¯·æ±‚prometheusçš„/metricæ¬¡æ•°ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start [2021-08-21 18:00:00 ==&gt; 1629540000]</span></span><br><span class="line"><span class="comment"># end [2021-08-21 18:15:00 ==&gt; 1629540900]</span></span><br><span class="line"><span class="comment"># step 60</span></span><br><span class="line"></span><br><span class="line">curl http://10.0.0.107:30090/api/v1/query?query=prometheus_http_requests_total&#123;handler=%22/metrics%22,instance=%22localhost:9090%22&#125;[5m]&amp;start=1629540000&amp;end=1629541800&amp;step=60</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"status"</span>: <span class="string">"success"</span>,</span><br><span class="line">  <span class="string">"data"</span>: &#123;</span><br><span class="line">    <span class="string">"resultType"</span>: <span class="string">"matrix"</span>,</span><br><span class="line">    <span class="string">"result"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"metric"</span>: &#123;</span><br><span class="line">          <span class="string">"__name__"</span>: <span class="string">"prometheus_http_requests_total"</span>,</span><br><span class="line">          <span class="string">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">          <span class="string">"handler"</span>: <span class="string">"/metrics"</span>,</span><br><span class="line">          <span class="string">"instance"</span>: <span class="string">"localhost:9090"</span>,</span><br><span class="line">          <span class="string">"job"</span>: <span class="string">"Server"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"values"</span>: [</span><br><span class="line">          [1629541465.147,<span class="string">"17"</span>],</span><br><span class="line">          [1629541585.147,<span class="string">"18"</span>]</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x01-è¡¨è¾¾å¼è¯­è¨€è¿ç®—ç¬¦"><a href="#0x01-è¡¨è¾¾å¼è¯­è¨€è¿ç®—ç¬¦" class="headerlink" title="0x01 è¡¨è¾¾å¼è¯­è¨€è¿ç®—ç¬¦"></a>0x01 è¡¨è¾¾å¼è¯­è¨€è¿ç®—ç¬¦</h2><p>æè¿°: Prometheus æ”¯æŒè®¸å¤šäºŒå…ƒå’Œèšåˆè¿ç®—ç¬¦ã€‚</p>
<p><br/></p>
<h3 id="1-äºŒå…ƒè¿ç®—ç¬¦"><a href="#1-äºŒå…ƒè¿ç®—ç¬¦" class="headerlink" title="1.äºŒå…ƒè¿ç®—ç¬¦"></a>1.äºŒå…ƒè¿ç®—ç¬¦</h3><p>æè¿°: Prometheus çš„æŸ¥è¯¢è¯­è¨€æ”¯æŒåŸºæœ¬çš„é€»è¾‘å’Œç®—æœ¯è¿ç®—ç¬¦ã€‚å¯¹äºä¸¤ä¸ªç¬æ—¶å‘é‡ä¹‹é—´çš„æ“ä½œï¼Œå¯ä»¥ä¿®æ”¹åŒ¹é…è¡Œä¸ºã€‚</p>
<ul>
<li><strong>1.1 äºŒå…ƒç®—æœ¯è¿ç®—ç¬¦</strong><br>æè¿°: äºŒå…ƒç®—æœ¯è¿ç®—ç¬¦å®šä¹‰åœ¨<code>æ ‡é‡/æ ‡é‡</code>ã€<code>å‘é‡/æ ‡é‡</code>å’Œ<code>å‘é‡/å‘é‡</code>å€¼å¯¹ä¹‹é—´ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ï¼Œ-ï¼Œ*ï¼Œ/ï¼Œ%ï¼ˆæ¨¡æ•°ï¼‰ï¼Œ^ï¼ˆå¹‚/å¹‚ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®€å•ç¤ºä¾‹:</span></span><br><span class="line">5 % 1.5  <span class="comment"># ==&gt; scalar	0.5</span></span><br><span class="line">5 ^ 2    <span class="comment"># ==&gt; scalar	25</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : æè¿°: æ ‡é‡æ˜¯æ²¡æœ‰ç»´åº¦çš„å•ä¸ªæ•°å­—ï¼Œæ˜¯é™¤äº†ç¬æ—¶ä¸èŒƒå›´å‘é‡ä¹‹å¤–ï¼Œè¢«ç§°ä¸ºæ ‡é‡ç±»å‹çš„å€¼ã€‚<br>ä¾‹å¦‚, 0 æ˜¯æ ‡é‡å®ƒçš„å€¼ä¸ºé›¶ã€‚<br>ä¾‹å¦‚, {} 0 æ˜¯åŒ…å«å•ä¸ªæ ·æœ¬ä¸”æ²¡æœ‰æ ‡ç­¾ä¸”å€¼ä¸ºé›¶çš„ç¬æ—¶å‘é‡ã€‚</p>
<p><br></p>
<ul>
<li><strong>1.2 æ¯”è¾ƒäºŒå…ƒè¿ç®—ç¬¦</strong><br>æè¿°:åœ¨PromQLä¸­æ¯”è¾ƒè¿ç®—ç¬¦æ˜¯è¿‡æ»¤çš„<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¯”è¾ƒåˆ¤æ–­</span></span><br><span class="line">==ï¼Œ!=ï¼Œ&gt;ï¼Œ&lt;ï¼Œ&gt;=ï¼Œ&lt;=, </span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­£åˆ™åŒ¹é… ä»¥åŠ æ­£åˆ™ä¸åŒ¹é… çš„æƒ…å†µä¸‹</span></span><br><span class="line">=~ , !~ </span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®€å•ç¤ºä¾‹:</span></span><br><span class="line"><span class="comment"># 1.æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤§äº10çš„æ—¶é—´åºåˆ—</span></span><br><span class="line">process_open_fds &gt; 10 </span><br><span class="line">10 &lt; process_open_fds  <span class="comment"># å½“æ¯”è¾ƒæ ‡é‡å’Œç¬æ—¶å‘é‡æ—¶ï¼Œå“ªä¸ªåœ¨é‚£ä¸€ä¾§å¹¶ä¸é‡è¦ã€‚</span></span><br><span class="line">  <span class="comment"># process_open_fds&#123;instance="localhost:9090", job="Server"&#125;	49</span></span><br><span class="line">  <span class="comment"># process_open_fds&#123;app_kubernetes_io_name="kube-state-metrics", app_kubernetes_io_version="2.0.0", instance="172.16.182.233:8081", job="k8s-endpoint-discover", kubernetes_namespace="monitor", service_name="kube-state-metrics"&#125; 11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤§äº10ä¸”å°äº48çš„æ—¶é—´åºåˆ—</span></span><br><span class="line">10 &lt; process_open_fds  &lt; 48 </span><br><span class="line">process_open_fds  &lt; 48 &gt; 10</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li><strong>1.3 Bool ä¿®é¥°ç¬¦</strong><br>æè¿°: è¿‡æ»¤ä¸»è¦ç”¨äºå‘Šè­¦è§„åˆ™ï¼Œè€Œboolæ˜¯è¿›è¡Œæ¯”è¾ƒçš„ä¸€äº›æ–¹æ³•è€Œä¸æ˜¯è¿‡æ»¤ã€‚</li>
</ul>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.è¯¥ä¿®é¥°ç¬¦æ˜¯æ¯”è¾ƒæ ‡é‡çš„å”¯ä¸€æ–¹æ³•</span></span><br><span class="line"><span class="comment"># 1024 &gt;= 42  ä¼šæŠ¥å¦‚ä¸‹: Error executing query: invalid parameter "query": 1:6: parse error: comparisons between scalars must use BOOL modifier é”™è¯¯</span></span><br><span class="line">1024 &gt;= bool 42   <span class="comment"># scalar	1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.è·å¾—æ‰“å¼€åä¸ªä»¥ä¸Šæ–‡ä»¶æè¿°ç¬¦çš„æ¯ä¸ªä»»åŠ¡çš„è¿›ç¨‹æ•°</span></span><br><span class="line">sort_desc(sum without(instance)(process_open_fds &gt;= bool 10))</span><br><span class="line">  <span class="comment"># &#123;job="Server"&#125; 	1       # è¯¥ job ä¸»æœºæ»¡è¶³</span></span><br><span class="line">  <span class="comment"># &#123;job="linux_exporter"&#125;	0     # è¯¥ job ä¸»æœºæ— æ»¡è¶³</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æŸ¥æ‰¾å…·æœ‰å››ä¸ªä»¥ä¸Šçš„ç£ç›˜è®¾å¤‡è®¡ç®—æœºçš„æ¯”ä¾‹</span></span><br><span class="line">avg without(instance)(count without(device)(node_disk_io_now) &gt; bool 4)</span><br><span class="line">  <span class="comment"># &#123;job="linux_exporter"&#125;	0</span></span><br><span class="line">  <span class="comment"># &#123;job="linux_exporter", nodeType="work"&#125; 	0.6666666666666667</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li><strong>1.4 é€»è¾‘äºŒå…ƒè¿ç®—ç¬¦</strong><br>æè¿°: é€»è¾‘/é›†åˆäºŒå…ƒè¿ç®—ç¬¦ä»…åœ¨å³æ—¶å‘é‡ä¹‹é—´å®šä¹‰<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">and , or, unless </span><br><span class="line"></span><br><span class="line">- or æ“ä½œç¬¦ï¼šæ¯ç»„å·¦ä¾§çš„ç»„å¦‚éƒ½æœ‰æ ·æœ¬åˆ™è¿”å›ä»–ä»¬ï¼Œå¦åˆ™è¿”å›å³ä¾§ç»„ä¸­çš„æ ·æœ¬ã€‚</span><br><span class="line">- unless æ“ä½œç¬¦ï¼šæ ¹æ®å³å’Œå·¦æ“ä½œæ•°ä¸­æ˜¯å¦ä¸ºç©ºè¿›è¡Œåˆ¤æ–­ï¼Œé™¤éå³ä¾§æœ‰æˆå‘˜ï¼Œå¦åˆ™unlessè¿ç®—ç¬¦è¿”å›å·¦ä¾§ç»„ã€‚</span><br><span class="line">- and æ“ä½œç¬¦: ä¸unlessç›¸åï¼Œä»…å½“åŒ¹é…çš„å³ä¾§æœ‰æ ·æœ¬æ—¶ï¼Œå®ƒæ‰ä»å·¦ä¾§æ“ä½œç¬¦è¿”å›ä¸€ä¸ªç»„ï¼Œå¦åˆ™ä»–ä¸è¿”å›è¯¥åŒ¹é…çš„æ ·æœ¬ã€‚ä½ å¯å°†å…¶è§†ä¸º<span class="keyword">if</span>è¿ç®—ç¬¦ã€‚</span><br><span class="line"><span class="comment"># è¯´æ˜:</span></span><br><span class="line">vector1 unless vector2 : äº§ç”Ÿä¸€ä¸ªå‘é‡ï¼Œè¯¥å‘é‡ vector1 ä¸åŒ¹é… vector2 å®Œå…¨åŒ¹é…æ ‡ç­¾é›†çš„å…ƒç´ ç»„æˆã€‚</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># or æ“ä½œç¬¦ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># 1.æ¯ç»„å·¦ä¾§çš„ç»„éƒ½æœ‰æ ·æœ¬ç„¶åè¿”å›ä»–ä»¬ï¼Œå¦åˆ™è¿”å›å³ä¾§ç»„ä¸­çš„æ ·æœ¬ã€‚</span></span><br><span class="line">node_hwmon_temp_celsius or ignoring(label) (node_hwmon_sensor_label * 0 + 1)</span><br><span class="line">  <span class="comment"># node_hwmon_temp_celsius&#123;chip="platform_coretemp_0", instance="10.0.0.223:9100", job="linux_exporter", sensor="temp10"&#125; 30</span></span><br><span class="line">node_hwmon_temp_celsius * ignoring(label) group_left(label) (node_hwmon_sensor_celsius  or ignoring(lable)(node_hwmon_temp_celsius * 0 + 1))</span><br><span class="line">  <span class="comment"># &#123;chip="platform_coretemp_0", instance="10.0.0.223:9100", job="linux_exporter",sensor="temp10"&#125; 	28</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.å°†ä¸¤è€…çš„æŒ‡æ ‡éƒ½è¾“å‡ºï¼Œä½†é’ˆå¯¹äºupæŒ‡æ ‡çš„å€¼å…¨éƒ¨è®¾ç½®ä¸º0</span></span><br><span class="line">node_uname_info or up&#123;job=<span class="string">"Server"</span>&#125; * 0</span><br><span class="line">  <span class="comment"># node_uname_info&#123; instance="10.0.0.225:9100", job="linux_exporter", machine="x86_64", nodename="weiyigeek-255", release="5.4.0-42-generic", sysname="Linux", version="#46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020"&#125; 	1</span></span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># unless æ“ä½œç¬¦ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># 1.é™¤äº†ä½¿ç”¨å°‘äº100MBé©»ç•™å†…å­˜è¿›ç¨‹å¤–çš„å…¶ä»–è¿›ç¨‹å¹³å‡CPUä½¿ç”¨ç‡ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¡¨è¾¾å¼ã€‚</span></span><br><span class="line">rate(process_cpu_seconds_total[5m]) unless process_resident_memory_bytes &lt; 1024^2 * 100</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125; 	0.0016149975000000613</span></span><br><span class="line"><span class="comment"># 2.ç”¨äºå‘ç°ç›®æ ‡ä¸­ç¼ºå°‘çš„æŒ‡æ ‡ã€‚</span></span><br><span class="line">up&#123;instance=<span class="string">"localhost:9090"</span>&#125; == 1 unless node_custom</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.åŠæ—¶ç»„çš„å³æ“ä½œæ•°æœ‰å¤šä¸ªæ ·æœ¬ï¼Œunlessä¹Ÿå¯ä»¥åœ¨å¤šå¯¹å¤šåŒ¹é…ä¸­ä½¿ç”¨ã€‚</span></span><br><span class="line">up == 1 unless on (job,instance) node_custom</span><br><span class="line">  <span class="comment"># up&#123;instance="localhost:9090", job="Server"&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># and æ“ä½œç¬¦ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># 1.å¸Œæœ›åœ¨å»¶è¿Ÿæ—¶é—´å¾ˆé•¿å¹¶ä¸”ç”¨æˆ·è¯·æ±‚è¾ƒå¤šæ—¶è¿”å›ã€‚å¤„ç†ç¨‹åºè¶…è¿‡ä¸€ç§’ï¼Œå¹¶ä¸”æ¯ç§’åªæœ‰ä¸€ä¸ªè¯·æ±‚ã€‚</span></span><br><span class="line">(rate(prometheus_http_request_duration_seconds_sum[5m]) </span><br><span class="line"> /  </span><br><span class="line">rate(prometheus_http_request_duration_seconds_count[5m])) </span><br><span class="line"> &gt; 10^6 </span><br><span class="line">and rate(prometheus_http_request_duration_seconds_count[5m]) &gt; 1</span><br><span class="line">and on() hour() &gt; 9 &lt; 17</span><br></pre></td></tr></table></figure></p>
<p>Tips : x * 0 + 1ä¼šå°†ç¬æ—¶å‘é‡çš„æ‰€æœ‰å€¼éƒ½æ›´æ”¹ä¸º1ã€‚</p>
<p><br/></p>
<h3 id="2-ä¿®é¥°è¿ç®—ç¬¦"><a href="#2-ä¿®é¥°è¿ç®—ç¬¦" class="headerlink" title="2.ä¿®é¥°è¿ç®—ç¬¦"></a>2.ä¿®é¥°è¿ç®—ç¬¦</h3><p>æè¿°: å‘é‡ä¹‹é—´çš„æ“ä½œå°è¯•ä¸ºå·¦ä¾§çš„æ¯ä¸ªæ¡ç›®åœ¨å³ä¾§å‘é‡ä¸­æ‰¾åˆ°åŒ¹é…å…ƒç´ ã€‚</p>
<p>Tips : å‘é‡åŒ¹é…æ˜¯å°†ä¸¤ä¸ªç¬æ—¶å‘é‡ä¹‹é—´ä½¿ç”¨è¿ç®—ç¬¦è¿›è¡Œè¿‡æ»¤æˆ–è€…æŸ¥è¯¢ã€‚</p>
<p>Tips : å‘é‡åŒ¹é…è¡Œä¸ºæœ‰ä¸¤ç§åŸºæœ¬ç±»å‹<code>ä¸€å¯¹ä¸€</code>å’Œ<code>å¤šå¯¹ä¸€</code>/<code>ä¸€å¯¹å¤š</code>ã€‚</p>
<ul>
<li><strong>2.1 ä¸€å¯¹ä¸€å‘é‡åŒ¹é…</strong><br>æè¿°: ä¸€å¯¹ä¸€ä»æ“ä½œçš„æ¯ä¸€ä¾§æ‰¾åˆ°ä¸€å¯¹å”¯ä¸€çš„æ¡ç›®ã€‚å¦‚æœä¸¤ä¸ªæ¡ç›®å…·æœ‰å®Œå…¨ç›¸åŒçš„ä¸€ç»„æ ‡ç­¾å’Œç›¸åº”çš„å€¼ï¼Œåˆ™å®ƒä»¬åŒ¹é….<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯­æ³•</span></span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt; </span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯­æ³•ç¤ºä¾‹ï¼šè¿”å›ä¸€ä¸ªç»“æœå‘é‡ï¼Œå…¶ä¸­åŒ…å«åœ¨è¿‡å» 5 åˆ†é’Ÿå†…æµ‹é‡çš„æ¯ç§æ–¹æ³•çš„çŠ¶æ€ä»£ç ä¸º 500 çš„ HTTP è¯·æ±‚çš„æ¯”ä¾‹</span></span><br><span class="line">method_code:http_errors:rate5m&#123;code=<span class="string">"500"</span>&#125; / ignoring(code) method:http_requests:rate5m</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å…·ä½“ç¤ºä¾‹:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.æŸ¥è¯¢ç›®æ ‡æœºå™¨å·²ä½¿ç”¨çš„è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ ‡è¯†ç¬¦å æ¯”(åœ¨ä¸¤ä¸ªæ—¶é—´åºåˆ—æ ‡ç­¾åŒ¹é…æ—¶)</span></span><br><span class="line">process_open_fds&#123;instance=<span class="string">"localhost:9090"</span>&#125; / process_max_fds&#123;instance=<span class="string">"localhost:9090"</span>&#125; </span><br><span class="line">  <span class="comment">// &#123;instance="localhost:9090", job="Server"&#125; 0.00004863739013671875</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.åŒ¹é…ä¸¤ä¸ªæ ‡ç­¾ä¸å®Œç¾åŒ¹é…çš„ç¬æ—¶å˜é‡ã€‚</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªå®ä¾‹CPUåœ¨idleæ¨¡å¼ä¸‹æ‰€å ç”¨çš„æ—¶é—´æ¯”ä¾‹ï¼Œä½¿ç”¨ignoring(mode)æ—¶ï¼Œå°†å‘é‡åœ¨åˆ†ç»„æ—¶nodeæ ‡ç­¾å°†è¢«ä¸¢å¼ƒï¼Œå¹¶åŒ¹é…æˆåŠŸã€‚</span></span><br><span class="line">sum without(cpu) (rate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[<span class="number">5</span>m])) /ignoring(mode) sum without(mode,cpu) (rate(node_cpu_seconds_total[<span class="number">5</span>m]))</span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.107:9100", job="linux_exporter"&#125; 0.9783266498445258</span></span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.108:9100", job="linux_exporter"&#125; 0.9760616305723038</span></span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.109:9100", job="linux_exporter"&#125; 0.9807213018617855</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.æŒ‡å®šä¿ç•™æ ‡ç­¾çš„æ—¶é—´åºåˆ—è¿›è¡Œæ“ä½œï¼ˆç¤ºä¾‹ä¸­è¿™æ ·ä½¿ç”¨æ¯”è¾ƒå¤šä½™ï¼‰</span></span><br><span class="line">sum by(cpu) (rate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[<span class="number">5</span>m])) / on(mode) sum by(mode,cpu) (rate(node_cpu_seconds_total[<span class="number">5</span>m]))</span><br></pre></td></tr></table></figure></p>
<p>Tips : å½“å…·æœ‰å®Œå…¨ç›¸åŒæ ‡ç­¾çš„æ ·æœ¬å°†è¢«åŒ¹é…(ç»„åˆ)åœ¨ä¸€èµ·ã€‚<br>Tips : å¦‚æœæœŸæœ›ç»“æœæ—¶è¿”å›ä¸ºç©ºçš„ç¬æ—¶å‘é‡ï¼Œåˆ™å¯èƒ½å› ä¸ºæ“ä½œæ•°çš„æ ·æœ¬æ ‡ç­¾ä¸åŒ¹é…ã€‚</p>
<p><br/></p>
<ul>
<li><strong>2.2 å¤šå¯¹ä¸€å’Œä¸€å¯¹å¤šå‘é‡åŒ¹é…</strong><br>æè¿°: å¤šå¯¹ä¸€å’Œä¸€å¯¹å¤šåŒ¹é…æ˜¯æŒ‡â€œä¸€â€ç«¯çš„æ¯ä¸ªå‘é‡å…ƒç´ å¯ä»¥ä¸â€œå¤šâ€ç«¯çš„å¤šä¸ªå…ƒç´ åŒ¹é…çš„æƒ…å†µã€‚å¿…é¡»ä½¿ç”¨<code>group_left or group_right</code>ä¿®é¥°ç¬¦æ˜ç¡®è¯·æ±‚ï¼Œå…¶ä¸­<code>å·¦/å³</code>ç¡®å®šå“ªä¸ªå‘é‡å…·æœ‰æ›´é«˜çš„åŸºæ•°ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯­æ³•æ ¼å¼</span></span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹æŸ¥è¯¢ï¼šåˆ†ç»„ä¿®é¥°ç¬¦åªèƒ½ç”¨äº æ¯”è¾ƒå’Œ ç®—æœ¯ã€‚é»˜è®¤æƒ…å†µä¸‹andï¼Œæ“ä½œ asunlesså’Œ oræ“ä½œä¸æ­£ç¡®å‘é‡ä¸­çš„æ‰€æœ‰å¯èƒ½æ¡ç›®åŒ¹é…ã€‚</span></span><br><span class="line">method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å®é™…æ¡ˆä¾‹:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// # 1.å…è®¸ä½ æŒ‡å®šå·¦ä¾§æ“ä½œæ•°ç»„ä¸­å¯ä»¥æœ‰å¤šä¸ªåŒ¹é…æ ·æœ¬ã€‚ï¼ˆå¤šå¯¹n-1ï¼‰</span></span><br><span class="line">sum without(cpu)(rate(node_cpu_seconds_total[<span class="number">5</span>m])) / ignoring(mode) group_left sum without(mode,cpu)(rate(node_cpu_seconds_total[<span class="number">5</span>m])) </span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.225:9100", job="linux_exporter", mode="user"&#125;	0.015867011327565222</span></span><br><span class="line">  <span class="comment">// &#123; instance="10.0.0.225:9100", job="linux_exporter", mode="system"&#125;	0.0027793624511104906</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// # 2.å…è®¸ä½ æŒ‡å®šå³ä¾§æ“ä½œæ•°ç»„ä¸­å¯ä»¥æœ‰å¤šä¸ªåŒ¹é…æ ·æœ¬ã€‚ï¼ˆå¤šå¯¹n-1ï¼‰</span></span><br><span class="line"> sum without(mode,cpu)(rate(node_cpu_seconds_total[<span class="number">5</span>m])) / ignoring(mode) group_right sum without(cpu)(rate(node_cpu_seconds_total[<span class="number">5</span>m]))</span><br></pre></td></tr></table></figure></p>
<p>Tips : <code>å¤šå¯¹ä¸€å’Œä¸€å¯¹å¤š</code>åŒ¹é…æ˜¯åº”è¯¥ä»”ç»†è€ƒè™‘çš„é«˜çº§ç”¨ä¾‹ã€‚é€šå¸¸æ­£ç¡®å¯ä½¿ç”¨<code>ignoring(&lt;labels&gt;)</code>æä¾›æ‰€éœ€çš„ç»“æœã€‚</p>
<p><br></p>
<h4 id="ignoring-ä¿®é¥°ç¬¦"><a href="#ignoring-ä¿®é¥°ç¬¦" class="headerlink" title="ignoring ä¿®é¥°ç¬¦"></a>ignoring ä¿®é¥°ç¬¦</h4><p>æè¿°: åœ¨åŒ¹é…æ—¶å¿½ç•¥æŸäº›æ ‡ç­¾ï¼ˆç±»ä¼¼äºèšåˆæ“ä½œä¸­çš„withoutæ–¹å¼</p>
<h4 id="on-ä¿®é¥°ç¬¦"><a href="#on-ä¿®é¥°ç¬¦" class="headerlink" title="on ä¿®é¥°ç¬¦"></a>on ä¿®é¥°ç¬¦</h4><p>æè¿°: åœ¨åŒ¹é…æ—¶å…è®¸å‡å°‘è¯¥ç»„è¢«è®¤ä¸ºæ ‡ç­¾æ¥æä¾›çš„åˆ—è¡¨ï¼ˆç±»ä¼¼äºèšåˆæ“ä½œä¸­çš„byæ–¹å¼ï¼‰</p>
<h4 id="group-left-ä¿®é¥°ç¬¦"><a href="#group-left-ä¿®é¥°ç¬¦" class="headerlink" title="group_left ä¿®é¥°ç¬¦"></a>group_left ä¿®é¥°ç¬¦</h4><p>æè¿°: è¯¥ä¿®é¥°ç¬¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼Œä¸€æ˜¯æŒ‡å®šå·¦ä¾§æ“ä½œæ•°ç»„ä¸­å¯ä»¥æœ‰å¤šä¸ªåŒ¹é…æ ·æœ¬ï¼ˆ<code>å§‹ç»ˆä»å·¦ä¾§æ“ä½œæ•°çš„æ ·æœ¬ä¸­è·å–æ‰€æœ‰æ ‡ç­¾</code>ï¼‰ç¡®ä¿ä¿ç•™å·¦ä¾§éœ€è¦è¿›è¡Œå¤šå¯¹ä¸€å‘é‡åŒ¹é…çš„é¢å¤–æ ‡ç­¾ï¼ŒäºŒæ˜¯å°†ä¿¡æ¯æŒ‡æ ‡ä¸­çš„æ ‡ç­¾æ·»åŠ åˆ°ä¸€ä¸ªç›®æ ‡çš„å…¶å®ƒæŒ‡æ ‡ä¸­ã€‚</p>
<p>ç®€å•ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) è¯´æ˜: å°†Python_infoä¸­çš„versionæ ‡ç­¾æ·»åŠ åˆ°upè¡¨è¾¾å¼åŒ¹é…åˆ°æ‰€æœ‰çš„æŒ‡æ ‡å†…ã€‚</span></span><br><span class="line"><span class="comment"># å³æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¹˜æ³•è¿ç®—ç¬¦æˆ–è€…group_leftä¿®é¥°ç¬¦è¿æ¥åˆ°å…¶å®ƒä»»ä½•æŒ‡æ ‡ã€‚</span></span><br><span class="line">up * on (instance,job) group_left (version) python_info</span><br><span class="line">  <span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">  &#123;instance=<span class="string">"10.20.172.103:8000"</span>, job=<span class="string">"control"</span>, version=<span class="string">"3.7.3"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) ç›®æ ‡è®¾å¤‡çš„æ¸©åº¦ä¼ æ„Ÿå™¨</span></span><br><span class="line">node_hwmon_temp_celsius * ignoring(label) group_left(label) node_hwmon_sensor_label</span><br><span class="line">  <span class="comment"># &#123;env="prod", instance="10.0.0.224:9100", job="linux_exporter", label="package_id_0", sensor="temp1"&#125; 33</span></span><br></pre></td></tr></table></figure></p>
<p>Tips: å¯ä½¿ç”¨ä»»ä½•è¿ç®—ç¬¦æ¥è¿æ¥æŒ‡æ ‡ï¼Œå½“ä¿¡æ¯æŒ‡æ ‡çš„å€¼ä¸º1æ—¶æ—¶å€™ï¼Œä¹˜æ³•ä¸ä¼šæ›´æ”¹å…¶ä»–æŒ‡æ ‡çš„å€¼ã€‚</p>
<h4 id="group-right-ä¿®é¥°ç¬¦"><a href="#group-right-ä¿®é¥°ç¬¦" class="headerlink" title="group_right ä¿®é¥°ç¬¦"></a>group_right ä¿®é¥°ç¬¦</h4><p>æè¿°:  å…¶å·¥ä½œæ–¹å¼ä¸group_leftç›¸åŒï¼Œåªæ˜¯å°†æ“ä½œå¯¹è±¡ä»å·¦æ¢åˆ°å³ï¼Œä½†æ˜¯é€šå¸¸ä½¿ç”¨group_leftå› ä¸ºä»»ä½•æ ‡ç­¾éƒ½æ˜¯ä»å·¦å‘å³å¤åˆ¶çš„ï¼Œä¸ºäº†ä¿è¯ä¸€è‡´æ€§ä»¥åŠæ–¹ä¾¿äººå‘˜ç†è§£æ‰€ä»¥æ¨èã€‚</p>
<p>ç®€å•ç¤ºä¾‹:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.å°†å·¦ä¾§prometheus_build_infoæŒ‡æ ‡ä¸­çš„version,revisionæ ‡ç­¾å¤åˆ¶åˆ°å³ä¾§upæŒ‡æ ‡ä¸­è¿›è¡Œå±•ç¤ºã€‚</span></span><br><span class="line">prometheus_build_info * on (instance) group_right(version,revision) up</span><br><span class="line">  <span class="comment">// &#123;instance="localhost:9090", job="Server", revision="3cafc58827d1ebd1a67749f88be4218f0bab3d8d", version="2.26.0"&#125; 1</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="3-èšåˆè¿ç®—ç¬¦"><a href="#3-èšåˆè¿ç®—ç¬¦" class="headerlink" title="3.èšåˆè¿ç®—ç¬¦"></a>3.èšåˆè¿ç®—ç¬¦</h3><p>æè¿°: Prometheus æ”¯æŒä»¥ä¸‹å†…ç½®èšåˆè¿ç®—ç¬¦ï¼Œå¯ç”¨äºèšåˆå•ä¸ªå³æ—¶å‘é‡çš„å…ƒç´ ï¼Œä»è€Œç”Ÿæˆå…·æœ‰èšåˆå€¼çš„æ›´å°‘å…ƒç´ çš„æ–°å‘é‡ã€‚</p>
<h4 id="åˆ†ç»„"><a href="#åˆ†ç»„" class="headerlink" title="åˆ†ç»„"></a>åˆ†ç»„</h4><p>æè¿°: åœ¨å­¦ä¹ èšåˆè¿ç®—ç¬¦ä¹‹å‰ï¼Œéœ€è¦äº†è§£å®è·µåºåˆ—çš„åˆ†ç»„æ–¹å¼ã€‚</p>
<p><strong>(1) Without æŒ‡å®šè¦åˆ é™¤çš„æ ‡ç­¾</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å°†æŒ‡æ ‡çš„device,mountpointæ ‡ç­¾å–æ¶ˆï¼Œå¹¶è¿›è¡Œå…¶å®ƒä¸åŒæ ‡ç­¾åˆ†ç»„å¹¶æ±‚å€¼åªå’Œ</span></span><br><span class="line">sum without(device,mountpoint)(node_filesystem_size_bytes&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;)</span><br><span class="line">  <span class="comment"># &#123;fstype="ext4", instance="10.0.0.107:9100", job="linux_exporter"&#125;  105114386432</span></span><br><span class="line">  <span class="comment"># &#123;fstype="nfs", instance="10.0.0.107:9100", job="linux_exporter"&#125;  2998958817280</span></span><br><span class="line">  <span class="comment"># &#123;fstype="tmpfs", instance="10.0.0.107:9100", job="linux_exporter"&#125;   52056260608</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.å½“ä¸ä¸º without æä¾›æ ‡ç­¾æ—¶ï¼Œè¾“å‡ºæ•ˆæœä¸ node_filesystem_size_bytes ä¸€è‡´</span></span><br><span class="line">sum without()(node_filesystem_size_bytes&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>(2) By æŒ‡å®šè¦ä¿ç•™çš„æ ‡ç­¾</strong></p>
<p>Tips : ä½•æ—¶ç”¨Without ï¼Œä½•æ—¶ç”¨By?<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è¿°ä¸¤ç§æƒ…å†µä½¿ç”¨Byå¯èƒ½æ›´æœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="comment"># 1.ä¸withoutä¸åŒçš„æ˜¯å®ƒä¸ä¼šè‡ªåŠ¨åˆ é™¤`__name__`æ ‡ç­¾</span></span><br><span class="line">sort_desc(count by(__name__)(&#123;__name__=~<span class="string">"node_filesystem.+"</span>&#125;))</span><br><span class="line">  <span class="comment"># node_filesystem_files&#123;&#125; 	116</span></span><br><span class="line">  <span class="comment"># node_filesystem_files_free&#123;&#125; 	116</span></span><br><span class="line">  <span class="comment"># node_filesystem_free_bytes&#123;&#125;  116</span></span><br><span class="line">  <span class="comment"># node_filesystem_readonly&#123;&#125;   	116</span></span><br><span class="line">  <span class="comment"># node_filesystem_size_bytes&#123;&#125;  116</span></span><br><span class="line">  <span class="comment"># node_filesystem_avail_bytes&#123;&#125; 116</span></span><br><span class="line">  <span class="comment"># node_filesystem_device_error&#123;&#125; 116</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.åˆ é™¤ä»»ä½•ä½ ä¸çŸ¥é“çš„æ ‡ç­¾ã€‚</span></span><br><span class="line">count by(release)(node_uname_info)</span><br><span class="line">  <span class="comment"># &#123;release="5.4.0-70-generic"&#125; 	1</span></span><br><span class="line">  <span class="comment"># &#123;release="5.4.0-60-generic"&#125; 	2</span></span><br><span class="line">  <span class="comment"># &#123;release="5.4.0-42-generic"&#125; 	3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.å¯ä»¥ä½¿ç”¨sumå’Œä¸€ä¸ªç©ºçš„byï¼Œç”šè‡³å¯ä»¥å¿½ç•¥byï¼Œä¾‹å¦‚</span></span><br><span class="line">sum by()(node_uname_info) <span class="comment"># ==&gt;&gt; sum(node_uname_info)</span></span><br><span class="line">  <span class="comment"># &#123;&#125; 	6  # å•ä¸€æ—¶é—´åºåˆ—ï¼Œè¯¥æ—¶é—´åºåˆ—æ²¡æœ‰æ ‡ç­¾ã€‚</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="èšåˆ"><a href="#èšåˆ" class="headerlink" title="èšåˆ"></a>èšåˆ</h4><p>æè¿°: èšåˆè¿ç®—ç¬¦å¯„ä»…é€‚ç”¨äºç¬æ—¶å‘é‡ï¼Œä¹Ÿè¾“å‡ºç¬æ—¶å‘é‡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># èšåˆè¿ç®—ç¬¦åˆ—è¡¨</span></span><br><span class="line">sum ï¼ˆè®¡ç®—ç»´åº¦çš„æ€»å’Œï¼‰</span><br><span class="line">min ï¼ˆé€‰æ‹©æœ€å°å°ºå¯¸ï¼‰</span><br><span class="line">max ï¼ˆé€‰æ‹©æœ€å¤§å°ºå¯¸ï¼‰</span><br><span class="line">avg ï¼ˆè®¡ç®—ç»´åº¦ä¸Šçš„å¹³å‡å€¼ï¼‰</span><br><span class="line">group ï¼ˆç»“æœå‘é‡ä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯ 1ï¼‰</span><br><span class="line">stddev ï¼ˆè®¡ç®—ç»´åº¦ä¸Šçš„æ€»ä½“æ ‡å‡†åå·®ï¼‰</span><br><span class="line">stdvar ï¼ˆè®¡ç®—ç»´åº¦ä¸Šçš„æ€»ä½“æ ‡å‡†æ–¹å·®ï¼‰</span><br><span class="line">count ï¼ˆè®¡ç®—å‘é‡ä¸­å…ƒç´ çš„æ•°é‡ï¼‰</span><br><span class="line">count_values ï¼ˆè®¡ç®—å…·æœ‰ç›¸åŒå€¼çš„å…ƒç´ æ•°ï¼‰</span><br><span class="line">bottomk ï¼ˆæ ·æœ¬å€¼çš„æœ€å° k ä¸ªå…ƒç´ ï¼‰</span><br><span class="line">topk ï¼ˆæ ·æœ¬å€¼æœ€å¤§çš„ k ä¸ªå…ƒç´ ï¼‰</span><br><span class="line">quantile ï¼ˆåœ¨ç»´åº¦ä¸Šè®¡ç®— Ï†-åˆ†ä½æ•° (0 â‰¤ Ï† â‰¤ 1)ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯­æ³•æ ¼å¼:</span></span><br><span class="line">&lt;aggr-op&gt; [without|by (&lt;label list&gt;)] ([parameter,] &lt;vector expression&gt;)</span><br><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜:</span></span><br><span class="line">- &lt;label list&gt; : æ˜¯åŠ å¼•å·çš„æ ‡ç­¾ï¼Œå¯ä»¥åŒ…æ‹¬åé¢çš„é€—å·.</span><br><span class="line">- without : ä»ç»“æœå‘é‡ä¸­åˆ é™¤åˆ—å‡ºçš„æ ‡ç­¾ï¼Œè€Œæ‰€æœ‰å…¶ä»–æ ‡ç­¾éƒ½ä¿ç•™åœ¨è¾“å‡ºä¸­.</span><br><span class="line">- by : æ‰§è¡Œç›¸åçš„æ“ä½œå¹¶åˆ é™¤byå­å¥ä¸­æœªåˆ—å‡ºçš„æ ‡ç­¾ï¼Œå³ä½¿å®ƒä»¬çš„æ ‡ç­¾å€¼åœ¨å‘é‡çš„æ‰€æœ‰å…ƒç´ ä¹‹é—´éƒ½ç›¸åŒã€‚</span><br><span class="line">- parameter : å–å€¼ count_valuesï¼Œquantileï¼Œtopkå’Œ bottomkã€‚</span><br></pre></td></tr></table></figure></p>
<p><strong>å®ä¾‹æ¼”ç¤º:</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¡ç®—æ¯ä¸ªåº”ç”¨ç¨‹åºå’Œç»„åœ¨æ‰€æœ‰å®ä¾‹ä¸Šçœ‹åˆ°çš„ HTTP è¯·æ±‚æ€»æ•°</span></span><br><span class="line">sum without (instance) (prometheus_prometheus_http_requests_total)</span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/alerts", job="LocalServer"&#125;	10</span></span><br><span class="line">sum by (code, handler) (prometheus_prometheus_http_requests_total)</span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/metrics"&#125; 83458</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.è®¡ç®—è¿è¡Œæ¯ä¸ªæ„å»ºç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„æ•°é‡ï¼Œ</span></span><br><span class="line">count_values(<span class="string">"version"</span>, go_info) <span class="comment">//&#123;version="1"&#125; 62</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.è¦åœ¨æ‰€æœ‰å®ä¾‹ä¸­è·å¾— 5 ä¸ªæœ€å¤§çš„ HTTP è¯·æ±‚æ•°ï¼Œ</span></span><br><span class="line">topk(<span class="number">5</span>, prometheus_prometheus_http_requests_total)</span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/metrics", instance="localhost:9090", job="LocalServer"&#125; 83467</span></span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/api/v1/query_range", instance="localhost:9090", job="LocalServer"&#125; 6283</span></span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/api/v1/query", instance="localhost:9090", job="LocalServer"&#125; 	5095</span></span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/api/v1/series", instance="localhost:9090", job="LocalServer"&#125; 	460</span></span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/api/v1/label/:name/values", instance="localhost:9090", job="LocalServer"&#125; 	186</span></span><br></pre></td></tr></table></figure></p>
<p>Tips ï¼šè¿ç®—ç¬¦æ—¢å¯ç”¨äºèšåˆæ‰€æœ‰æ ‡ç­¾ç»´åº¦ï¼Œä¹Ÿå¯é€šè¿‡åŒ…å«withoutorbyå­å¥æ¥ä¿ç•™ä¸åŒçš„ç»´åº¦</p>
<p><br></p>
<h3 id="4-è¿ç®—ç¬¦ä¼˜å…ˆçº§"><a href="#4-è¿ç®—ç¬¦ä¼˜å…ˆçº§" class="headerlink" title="4.è¿ç®—ç¬¦ä¼˜å…ˆçº§"></a>4.è¿ç®—ç¬¦ä¼˜å…ˆçº§</h3><p>æè¿°ï¼šä¸‹é¢çš„åˆ—è¡¨æ˜¾ç¤ºäº† Prometheus ä¸­äºŒå…ƒè¿ç®—ç¬¦çš„ä¼˜å…ˆçº§ï¼Œä»é«˜åˆ°ä½ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line">*, /,%</span><br><span class="line">+, -</span><br><span class="line">==, !=, &lt;=, &lt;, &gt;=,&gt;</span><br><span class="line">and, unless</span><br><span class="line">or</span><br></pre></td></tr></table></figure></p>
<p>Tips :ç›¸åŒä¼˜å…ˆçº§çš„è¿ç®—ç¬¦æ˜¯å·¦ç»“åˆçš„ã€‚ä¾‹å¦‚<code>2 * 3 % 2</code>ç›¸å½“äº<code>(2 * 3) % 2</code>, ç„¶è€Œ^æ˜¯å³ç»“åˆçš„ï¼Œæ‰€ä»¥ <code>2 ^ 3 ^ 2</code>ç­‰ä»·äº<code>2 ^ (3 ^ 2)</code>ã€‚</p>
<hr>
<h2 id="0x02-PromQL-å†…ç½®å‡½æ•°ä»‹ç»"><a href="#0x02-PromQL-å†…ç½®å‡½æ•°ä»‹ç»" class="headerlink" title="0x02 PromQL å†…ç½®å‡½æ•°ä»‹ç»"></a>0x02 PromQL å†…ç½®å‡½æ•°ä»‹ç»</h2><p>Prometheus æä¾›äº†å…¶å®ƒå¤§é‡çš„å†…ç½®å‡½æ•°ï¼Œå¯ä»¥å¯¹æ—¶åºæ•°æ®è¿›è¡Œä¸°å¯Œçš„å¤„ç†ã€‚æŸäº›å‡½æ•°æœ‰é»˜è®¤çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š<code>year(v=vector(time()) instant-vector)</code>ã€‚å…¶ä¸­å‚æ•° v æ˜¯ä¸€ä¸ªç¬æ—¶å‘é‡ï¼Œå¦‚æœä¸æä¾›è¯¥å‚æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ <code>vector(time())</code>, <code>instant-vector è¡¨ç¤ºå‚æ•°ç±»å‹ {} : 1626661808.684</code>ã€‚</p>
<p>å®˜æ–¹å‚è€ƒ: <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/querying/functions/</a></p>
<p><br></p>
<h3 id="1-èšåˆå‡½æ•°"><a href="#1-èšåˆå‡½æ•°" class="headerlink" title="1.èšåˆå‡½æ•°"></a>1.èšåˆå‡½æ•°</h3><h4 id="sum-å‡½æ•°"><a href="#sum-å‡½æ•°" class="headerlink" title="sum å‡½æ•°"></a>sum å‡½æ•°</h4><p>æè¿°: æˆ‘ä»¬å¯ä»¥æ ¹æ®pathæ ‡ç­¾è¿›è¡Œèšåˆæ“ä½œï¼Œsumå‡½æ•°å¯ä»¥å¯¹æ ·æœ¬è¿›è¡Œåšæ±‚å’Œæ“ä½œã€‚</p>
<p><strong>åˆ†ç»„:</strong></p>
<ul>
<li>without å­—å¥: è¡¨ç¤ºè¦ç§»é™¤çš„æ ‡ç­¾ã€‚</li>
<li><p>by å­—å¥: è¡¨ç¤ºåªæ˜¾ç¤ºçš„æ ‡ç­¾ã€‚</p>
</li>
<li><p>1) PromQL: <code>sum by(path)(rate(http_requested_total[2m]))</code>, è¯´æ˜: èšåˆæ±‚å’Œæ“ä½œåªæ˜¾ç¤ºæŒ‡å®šæ ‡ç­¾çš„é”®ã€å€¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;path=<span class="string">"/"</span>&#125; 0</span><br><span class="line">&#123;path=<span class="string">"/api/"</span>&#125; 0.03333333333333333</span><br><span class="line">&#123;path=<span class="string">"/favicon.ico"</span>&#125; 0.04444444444444444</span><br></pre></td></tr></table></figure>
</li>
<li><p>2) PromQL: <code>sum without(path)(rate(http_requested_total[2m]))</code>, è¯´æ˜: èšåˆæ±‚å’Œæ“ä½œé™¤äº†æŒ‡å®šæ ‡ç­¾çš„åŒ…æ‹¬å…¶å®ƒæ ‡ç­¾çš„é”®ã€å€¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;instance=<span class="string">"10.20.172.103:8000"</span>, job=<span class="string">"control"</span>, method=<span class="string">"GET"</span>&#125; 0.040740740740740744</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h4 id="avg-å‡½æ•°"><a href="#avg-å‡½æ•°" class="headerlink" title="avg() å‡½æ•°"></a>avg() å‡½æ•°</h4><p>æè¿°: å°†è¿”å›ç»„ä¸­æ—¶é—´åºåˆ—æ‰€ä»¥å€¼çš„å¹³å‡æ•°æ¥ä½œä¸ºç»„çš„å€¼ã€‚</p>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (1) è¿”å›æ¯ä¸ªèŠ‚ç‚¹å®ä¾‹æ¯ç§CPUæ¨¡å¼çš„å¹³å‡ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">avg without(cpu)(node_cpu_seconds_total&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;)</span><br><span class="line">  <span class="comment">// ä¸ä¸‹é¢æ•ˆæœä¸€è‡´ </span></span><br><span class="line">  <span class="comment">// sum without(cpu)(node_cpu_seconds_total&#123;instance="10.0.0.107:9100"&#125;) </span></span><br><span class="line">  <span class="comment">// / </span></span><br><span class="line">  <span class="comment">// count without(cpu)(node_cpu_seconds_total&#123;instance="10.0.0.107:9100"&#125;)</span></span><br><span class="line"><span class="comment">// è¾“å‡ºç»“æœï¼š</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"steal"</span>&#125;	<span class="number">0</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"system"</span>&#125;	<span class="number">80513.27249999999</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"user"</span>&#125;	<span class="number">162807.48375</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"idle"</span>&#125;	<span class="number">12163467.506250001</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"iowait"</span>&#125;	<span class="number">8603.5525</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"irq"</span>&#125;	<span class="number">0</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"nice"</span>&#125;	<span class="number">212.6525</span></span><br><span class="line">&#123; instance=<span class="string">"10.0.0.107:9100"</span>, job=<span class="string">"linux_exporter"</span>, mode=<span class="string">"softirq"</span>&#125;	<span class="number">4911.07375</span></span><br></pre></td></tr></table></figure></p>
<p>TIPS : æœ‰æ—¶ä½ ä¼šå‘ç°è¾“å…¥ä¸­å­˜åœ¨NaNæ—¶éƒ½ä¼šå¯¼è‡´æ•´ä¸ªç»“æœå˜ä¸ºNaN(ä»»ä½•æ¶‰åŠNaNçš„æµ®ç‚¹æ•°è¿ç®—éƒ½ä¼šäº§ç”ŸNaN)ï¼Œå¹¶ä¸” 1 / 0 æ—¶ä¹Ÿä¼šè¾“å‡ºNaNã€‚</p>
<p><br></p>
<h4 id="count-å‡½æ•°"><a href="#count-å‡½æ•°" class="headerlink" title="count() å‡½æ•°"></a>count() å‡½æ•°</h4><p>æè¿°: count é›†åˆå°†è®¡ç®—å¹¶è¿”å›åˆ†ç»„ä¸­çš„æ—¶é—´åºåˆ—æ•°ã€‚</p>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.è¿”å›æœºå™¨åŒ…å«çš„ç£ç›˜è®¾å¤‡æ•°é‡</span></span><br><span class="line">count without(device)(node_disk_read_bytes_total&#123;device=~<span class="string">"sd.+"</span>,instance=<span class="string">"10.0.0.107:9100"</span>&#125;)</span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.107:9100", job="linux_exporter"&#125; 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.è®¡æ•°æ ‡ç­¾æœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼ä¾‹å¦‚è¿”å›è¯¥ç›®æ ‡çš„å®ä¾‹çš„CPUæ•°é‡</span></span><br><span class="line">count without(cpu)(count without(mode)(node_cpu_seconds_total&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;))</span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.107:9100", job="linux_exporter"&#125;	8 // 8 æ ¸</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.ç”Ÿæˆæ²¡æœ‰æ ‡ç­¾çš„å•ä¸ªæ ·æœ¬ã€‚</span></span><br><span class="line">count(count without(cpu)(node_cpu_seconds_total&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;))</span><br><span class="line">  <span class="comment">// &#123;&#125; 8</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="count-values-å‡½æ•°"><a href="#count-values-å‡½æ•°" class="headerlink" title="count_values() å‡½æ•°"></a>count_values() å‡½æ•°</h4><p>æè¿°: è¯¥å‡½æ•°å¯ä»¥ä»ä¸€ä¸ªç»„ä¸­è¿”å›å¤šä¸ªæ—¶é—´åºåˆ—ã€‚å¹¶æŒ‰ç…§ç»„ä¸­çš„æ—¶é—´åºåˆ—å€¼å»ºç«‹é¢‘ç‡ç›´æ–¹å›¾ï¼Œæ¯ä¸ªå€¼çš„è®¡æ•°ä½œä¸ºè¾“å‡ºæ—¶é—´åºåˆ—çš„å€¼ï¼ŒåŸå§‹å€¼ä½œä¸ºæ–°æ ‡ç­¾ã€‚</p>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.æŸ¥è¯¢ç›®æ ‡ç³»ç»Ÿä¸­æœ‰å‡ ä¸ªçš„å†…æ ¸ç‰ˆæœ¬æ•°</span></span><br><span class="line">count_values(<span class="string">"kernelVersion"</span>,count without(instance,version,nodename,nodeType)(node_uname_info))</span><br><span class="line">  <span class="comment"># &#123;kernelVersion="1"&#125;	1</span></span><br><span class="line">  <span class="comment"># &#123;kernelVersion="2"&#125;	1</span></span><br><span class="line">  <span class="comment"># &#123;kernelVersion="3"&#125;	1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æŸ¥è¯¢æœºå™¨æ•°å’Œç£ç›˜è®¾å¤‡æ•°</span></span><br><span class="line">count_values without(instance)(<span class="string">"devices"</span>,count without(device)(node_disk_io_now))</span><br><span class="line">count_values without(instance)(<span class="string">"devices"</span>,count without(device)(node_disk_io_now&#123;device=~<span class="string">"sd.+"</span>&#125;))</span><br><span class="line">  <span class="comment"># è¡¨ç¤ºæœ‰ä¸‰å°æœºå™¨åªæœ‰ä¸€å—ç‰©ç†ç¡¬ç›˜</span></span><br><span class="line">  <span class="comment"># &#123;devices="1", env="prod", job="linux_exporter"&#125;	3</span></span><br></pre></td></tr></table></figure></p>
<p>Tips: count_values å¯ä¸count ç»“åˆä½¿ç”¨ï¼Œæ¥è®¡ç®—ç»™å®šçš„èšåˆç»„çš„å”¯ä¸€å€¼çš„æ•°é‡ã€‚</p>
<p><br></p>
<h4 id="min-å‡½æ•°"><a href="#min-å‡½æ•°" class="headerlink" title="min() å‡½æ•°"></a>min() å‡½æ•°</h4><h4 id="max-å‡½æ•°"><a href="#max-å‡½æ•°" class="headerlink" title="max() å‡½æ•°"></a>max() å‡½æ•°</h4><p>æè¿°: ä¸¤ä¸ªèšåˆå‡½æ•°åˆ†åˆ«æ±‚å–ç»„å†…æœ€å°æˆ–æœ€å¤§å€¼ä½œä¸ºç»„çš„è¿”å›å€¼ã€‚</p>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">min without(device,fstype,mountpoint)(node_filesystem_size_bytes)</span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.224:9100", job="linux_exporter"&#125; 	5242880</span></span><br><span class="line"></span><br><span class="line">max without(device,fstype,mountpoint)(node_filesystem_size_bytes)</span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.223:9100", job="linux_exporter"&#125;	2998958817280</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : å¦‚æœç»„ä¸­çš„å€¼å­˜åœ¨æ˜¯NaNï¼Œåˆ™ç»“æœä¹Ÿä»…ä»…è¿”å›NaN</p>
<p><br></p>
<h4 id="stddev-å‡½æ•°"><a href="#stddev-å‡½æ•°" class="headerlink" title="stddev() å‡½æ•°"></a>stddev() å‡½æ•°</h4><h4 id="stdvar-å‡½æ•°"><a href="#stdvar-å‡½æ•°" class="headerlink" title="stdvar() å‡½æ•°"></a>stdvar() å‡½æ•°</h4><p>æè¿°: æ ‡å‡†å·®æ˜¯å¯¹ä¸€ç»„æ•°å­—çš„ç¦»æ•£ç¨‹åº¦è¿›è¡Œç»Ÿè®¡æµ‹é‡ã€‚åœ¨ç›‘æ§ä¸­æ ‡å‡†å·®çš„ä¸»è¦ç”¨äºæ£€æµ‹å¼‚å¸¸å€¼ã€‚<br>ä¾‹å¦‚, ä½ æœ‰æ•°å­—{2,4,6}å’Œ{3ï¼Œ4ï¼Œ5}å…¶å¹³å‡å€¼éƒ½æ˜¯4ï¼Œå‰è€…çš„æ ‡å‡†å·®ä¸º 1.633ï¼Œåè€…æ ‡å‡†å·®ä¸º0.816</p>
<p>ä¾‹å¦‚ï¼Œä¸¤ç»„æ•°çš„é›†åˆ{0,5,9,14}å’Œ{5,6,8,9}å…¶å¹³å‡å€¼éƒ½æ˜¯7ï¼Œä½†ç¬¬äºŒä¸ªé›†åˆå…·æœ‰è¾ƒå°çš„æ ‡å‡†å·®ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å¹³å‡æ•°: 0 + 5 + 9 + 14 / 4 = 7</span><br><span class="line"><span class="comment"># æ­¤å¤„æ ·æœ¬æ•°é‡è¾ƒå°‘æ‰€ä»¥ç›´æ¥é‡‡ç”¨ n (æ ·æœ¬ä¸ªæ•°)</span></span><br><span class="line">æ–¹å·®: ((0-7)^2 + (5-7)^2 + (9-7)^2 + (14-7)^2) / 4 = (49 + 4 + 4 + 49) / 4  = 106 / 4 = 26.5</span><br><span class="line">æ ‡å‡†å·®: sqrt(æ–¹å·®) = sqrt(26.5) = 5.1478150704935</span><br><span class="line">  <span class="comment"># go è¯­è¨€ä¸­</span></span><br><span class="line">  <span class="comment"># fmt.Println(float64(106) / float64(4))</span></span><br><span class="line">  <span class="comment"># fmt.Println(math.Sqrt(float64(106) / float64(4)))</span></span><br></pre></td></tr></table></figure></p>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¡¨è¾¾å¼æ‰¾åˆ°æ¯”å¹³å‡å€¼è‡³å°‘é«˜å‡º2ä¸¤ä¸ªæ ‡å‡†å·®çš„å®ä¾‹</span></span><br><span class="line">some_gauge_metrics &gt; ingnoring (instance)(some_gauge_metrics)</span><br><span class="line">(</span><br><span class="line">  avg without (instance) (some_gauge_metrics)</span><br><span class="line">  +</span><br><span class="line">  2 * stddev without (instance) (some_gauge_metrics)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>Tips: æ ‡å‡†æ–¹å·®æ˜¯æ ‡å‡†å·®çš„å¹³æ–¹ã€‚<br>Tips: å› ä¸ºæœ‰ä¸¤ä¸ªå®šä¹‰,ç”¨åœ¨ä¸åŒçš„åœºåˆ<code>å¦‚æ˜¯æ€»ä½“,æ ‡å‡†å·®å…¬å¼æ ¹å·å†…é™¤ä»¥n,å¦‚æ˜¯æ ·æœ¬,æ ‡å‡†å·®å…¬å¼æ ¹å·å†…é™¤ä»¥ï¼ˆn-1)</code>,å› ä¸ºæˆ‘ä»¬å¤§é‡æ¥è§¦çš„æ˜¯æ ·æœ¬,æ‰€ä»¥<code>æ™®éä½¿ç”¨æ ¹å·å†…é™¤ä»¥ï¼ˆn-1)</code>,</p>
<p><br></p>
<h4 id="topk-å‡½æ•°"><a href="#topk-å‡½æ•°" class="headerlink" title="topk() å‡½æ•°"></a>topk() å‡½æ•°</h4><h4 id="bottomk-å‡½æ•°"><a href="#bottomk-å‡½æ•°" class="headerlink" title="bottomk() å‡½æ•°"></a>bottomk() å‡½æ•°</h4><p>æè¿°: è¯¥å‡½æ•°ä¸å…¶å®ƒèšåˆå‡½æ•°ä¸‰ä¸ªä¸åŒçš„åœ°æ–¹ï¼Œç¬¬ä¸€ï¼Œå®ƒä»¬è¿”å›çš„æ˜¯æ—¶é—´åºåˆ—çš„æ ‡ç­¾è€Œéåˆ†ç»„æ ‡ç­¾ï¼Œç¬¬äºŒï¼Œæ¯ç»„å¯ä»¥è¿”å›å¤šä¸ªæ—¶é—´åºåˆ—ï¼Œç¬¬ä¸‰ï¼Œå®ƒä»¬é‡‡ç”¨é¢å¤–çš„å‚æ•°ã€‚</p>
<ul>
<li>topk() å‡½æ•°: è¿”å›åˆ†ç»„ä¸­æœ€å¤§çš„kä¸ªæ—¶é—´åºåˆ—ã€‚</li>
<li>tottomk() å‡½æ•°: è¿”å›åˆ†ç»„ä¸­æœ€å°çš„kä¸ªæ—¶é—´åºåˆ—ã€‚</li>
</ul>
<p>ç¤ºä¾‹æ¼”ç¤º:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (1) è¿”å›å€¼æœ€å¤§çš„2ä¸ªæ—¶é—´åºåˆ—ï¼Œå¹¶ä¸”æ¯ç»„æœ€å¤šè¿”å›ä¸¤ä¸ªæ—¶é—´åºåˆ—ã€‚</span></span><br><span class="line">topk without(device,fstype,mountpoint)(<span class="number">2</span>,node_filesystem_size_bytes&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;) </span><br><span class="line">  <span class="comment">// node_filesystem_size_bytes&#123; device="192.168.1.3:/nask8sapp", fstype="nfs", instance="10.0.0.107:9100", job="linux_exporter", mountpoint="/nfsdisk-31"&#125; 2998958817280</span></span><br><span class="line">  <span class="comment">// node_filesystem_size_bytes&#123; device="/dev/mapper/ubuntu--vg-lv--0", fstype="ext4", instance="10.0.0.107:9100", job="linux_exporter", mountpoint="/"&#125; 104091082752</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// (2) è¿”å›å€¼æœ€å°çš„2ä¸ªæ—¶é—´åºåˆ—ï¼Œå¹¶ä¸”æ¯ç»„æœ€å¤šè¿”å›ä¸¤ä¸ªæ—¶é—´åºåˆ—ã€‚</span></span><br><span class="line">bottomk without(device,fstype,mountpoint)(<span class="number">2</span>,node_filesystem_size_bytes&#123;instance=<span class="string">"10.0.0.107:9100"</span>&#125;) / <span class="number">1024</span>^<span class="number">3</span>  <span class="comment">// ä½¿ç”¨è¿ç®—ç¬¦æ—¶ä¼šåˆ é™¤__name__æ ‡ç­¾ã€‚</span></span><br><span class="line">  <span class="comment">// &#123;device="tmpfs", fstype="tmpfs", instance="10.0.0.107:9100", job="linux_exporter", mountpoint="/run/lock"&#125; 0.0048828125</span></span><br><span class="line">  <span class="comment">// &#123;device="/dev/sda2", fstype="ext4", instance="10.0.0.107:9100", job="linux_exporter", mountpoint="/boot"&#125; 0.9530258178710938</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// (3) è®¡ç®—è¿‡å»ä¸€ä¸ªå°æ—¶å†…çš„æœ€å¤§æ—¶é—´åºåˆ—è¿”å›å‰5</span></span><br><span class="line">topk(<span class="number">5</span>,avg_over_time(prometheus_http_requests_total[<span class="number">1</span>h])) </span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/metrics", instance="localhost:9090", job="Server"&#125;	518.5</span></span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/api/v1/query", instance="localhost:9090", job="Server"&#125;	69.30000000000001</span></span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/static/*filepath", instance="localhost:9090", job="Server"&#125;	6</span></span><br><span class="line">  <span class="comment">// &#123;code="400", handler="/api/v1/query", instance="localhost:9090", job="Server"&#125;	3.933333333333333</span></span><br><span class="line">  <span class="comment">// &#123;code="200", handler="/api/v1/label/:name/values", instance="localhost:9090", job="Server"&#125;	3</span></span><br></pre></td></tr></table></figure></p>
<p>Tips: è¯¥topkèšåˆå‡½æ•°ä¸ä¼šåˆ é™¤<code>__name__</code>æ ‡ç­¾ï¼Œä½†æ˜¯å¦‚æœ<code>é’ˆå¯¹å…¶æ•°æ®è¿›è¡Œè¿ç®—æ—¶æˆ–è€…åŒ…å«å…¶å®ƒå‡½æ•°æ—¶</code>ä¼šåˆ é™¤<code>__name__</code>æ ‡ç­¾ï¼ˆçœ‹ä¸Šè¿°ä¸¤ä¸ªç¤ºä¾‹ï¼‰ï¼Œå®ƒä»¬ä¼šåœ¨ç»“æœä¸­å±•ç¤ºã€‚</p>
<p><br></p>
<h4 id="quantile-å‡½æ•°"><a href="#quantile-å‡½æ•°" class="headerlink" title="quantile() å‡½æ•°"></a>quantile() å‡½æ•°</h4><p>æè¿°: è¯¥èšåˆå‡½æ•°æŒ‡å®šåˆ†ä½æ•°çš„å€¼ä½œä¸ºç»„çš„è¿”å›å€¼ï¼Œé€‚ç”¨äºå¯¹ç¬æ—¶å‘é‡åšè·¨èšåˆç»„æŸ¥è¯¢,å¹¶ä¸”ä¸topkç±»ä¼¼åˆ†ä½æ•°ä½¿ç”¨ä¸€ä¸ªå‚æ•°ã€‚</p>
<ul>
<li><p>ä¾‹å¦‚1, æŸ¥è¯¢ä¸åŒç›®æ ‡æœºå™¨ä¸­CPUç³»ç»Ÿæ¨¡å¼ä½¿ç”¨ç‡çš„ç¬¬90ç™¾åˆ†ä½æ˜¯å¤šå°‘ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ„å‘³ç€åœ¨90%çš„CPUæ¯ç§’è‡³å°‘æœ‰0.007ç§’å¤„äºç³»ç»Ÿæ¨¡å¼ã€‚</span></span><br><span class="line">quantile without(cpu) (<span class="number">0.9</span>,rate(node_cpu_seconds_total&#123;mode=<span class="string">"system"</span>&#125;[<span class="number">5</span>m]))</span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.224:9100", job="linux_exporter", mode="system"&#125; 	0.007323449333398858</span></span><br><span class="line">  <span class="comment">// &#123;instance="10.0.0.225:9100", job="linux_exporter", mode="system"&#125;   0.0032833333333352737</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¾‹å¦‚2,ä½¿ç”¨åˆ†ä½æ•°æ¥æ˜¾ç¤ºå›¾è¡¨ä¸­çš„ä¸­ä½æ•°ï¼Œç¬¬25ç™¾åˆ†ä½æ•°å’Œç¬¬75ç™¾åˆ†ä½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">quantile without(instance) (<span class="number">0.75</span>,rate(process_cpu_seconds_total[<span class="number">5</span>m]))</span><br><span class="line">  <span class="comment">// &#123;job="Server"&#125; 0.0024166666666666004</span></span><br><span class="line"></span><br><span class="line">quantile without(instance) (<span class="number">0.25</span>,rate(process_cpu_seconds_total[<span class="number">5</span>m]))</span><br><span class="line">  <span class="comment">// &#123;job="Server"&#125; 0.0024166666666666004</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h3 id="2-ç±»å‹å‡½æ•°"><a href="#2-ç±»å‹å‡½æ•°" class="headerlink" title="2.ç±»å‹å‡½æ•°"></a>2.ç±»å‹å‡½æ•°</h3><h4 id="vector-å‡½æ•°"><a href="#vector-å‡½æ•°" class="headerlink" title="vector() å‡½æ•°"></a>vector() å‡½æ•°</h4><p>æè¿°: <code>vector(s scalar)</code> å‡½æ•°å°†æ ‡é‡ s ä½œä¸ºæ²¡æœ‰æ ‡ç­¾çš„å‘é‡è¿”å›ï¼Œ<code>å³è¿”å›ç»“æœä¸ºï¼škey: value= {}, s</code>, å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ— æ ‡ç­¾çš„ç¬æ—¶å‘é‡çš„æ ·æœ¬å¹¶ç»™äºˆå®šå€¼ã€‚</p>
<p>ä¾‹å¦‚ï¼Œvector(1024) è¿”å› <code>{} 1024</code><br>ä¾‹å¦‚, sum(node_not_metrics) or vector(1024) è¿”å› <code>{} 1024</code>, ä¸å­˜åœ¨çš„æŒ‡æ ‡ä¹Ÿå§‹ç»ˆè¿”å›ä¸€ä¸ªæ ·æœ¬ã€‚</p>
<p><br></p>
<h4 id="scalar-å‡½æ•°"><a href="#scalar-å‡½æ•°" class="headerlink" title="scalar() å‡½æ•°"></a>scalar() å‡½æ•°</h4><p>æè¿°: <code>scalar(v instant-vector)</code> å‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªå•å…ƒç´ çš„ç¬æ—¶å‘é‡, å®ƒè¿”å›å…¶å”¯ä¸€çš„æ—¶é—´åºåˆ—çš„å€¼ä½œä¸ºä¸€ä¸ªæ ‡é‡ã€‚</p>
<p>Tipsï¼šå¦‚æœåº¦é‡æŒ‡æ ‡çš„æ ·æœ¬æ•°é‡å¤§äº 1 æˆ–è€…ç­‰äº 0, åˆ™è¿”å› NaNï¼Œå®ƒåœ¨å¤„ç†æ ‡é‡å¸¸é‡æ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<p>ç¤ºä¾‹æ¼”ç¤ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å¤„ç†æ ‡é‡å¸¸é‡ä¸”ä»…ä»…é€‚ç”¨äºç¬æ—¶å‘é‡çš„æ•°å­¦å‡½æ•°</span></span><br><span class="line">scalar(sqrt(vector(4)))  <span class="comment"># &gt;&gt; scalar	2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.ä¸æ—¶é—´å‡½æ•°è¿ç”¨</span></span><br><span class="line">scalar(year())  <span class="comment"># &gt;&gt; scalar	2021</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.ä¸ºä½ æä¾›è®¡ç®—æœºCPUéç©ºé—²çš„æ—¶é—´æ¯”ä¾‹(ä½¿ç”¨scalarä¼šä¸¢å¤±æ‰€æœ‰çš„æ ‡ç­¾)</span></span><br><span class="line">  sum(rate(node_cpu_seconds_total&#123;mode!=<span class="string">"idle"</span>&#125;[5m])) / scalar(count(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;)) <span class="comment"># &#123;&#125; 0.017490234375018142</span></span><br></pre></td></tr></table></figure><br><br/></p>
<h3 id="3-æ•°å­¦å‡½æ•°"><a href="#3-æ•°å­¦å‡½æ•°" class="headerlink" title="3.æ•°å­¦å‡½æ•°"></a>3.æ•°å­¦å‡½æ•°</h3><p>æè¿°: æ•°å­¦å‡½æ•°å¯¹ç¬æ—¶å‘é‡æ‰§è¡Œæ ‡å‡†æ•°å­¦è®¡ç®—ã€‚å¹¶ä¸”ç¬æ—¶å‘é‡ä¸­çš„æ¯ä¸ªæ ·æœ¬éƒ½ç‹¬ç«‹å¤„ç†ï¼Œè¿”å›å€¼å°†åˆ é™¤æŒ‡æ ‡åç§°ã€‚</p>
<h4 id="abs-å‡½æ•°"><a href="#abs-å‡½æ•°" class="headerlink" title="abs() å‡½æ•°"></a>abs() å‡½æ•°</h4><p>æè¿°: <code>abs(v instant-vector)</code> è¿”å›è¾“å…¥å‘é‡çš„æ‰€æœ‰æ ·æœ¬çš„ç»å¯¹å€¼ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(vector(time()))  <span class="comment"># &#123;&#125; 1626662058.627</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="ln-å‡½æ•°"><a href="#ln-å‡½æ•°" class="headerlink" title="ln() å‡½æ•°"></a>ln() å‡½æ•°</h4><p>æè¿°: ln(v instant-vector) è®¡ç®—ç¬æ—¶å‘é‡ v ä¸­æ‰€æœ‰æ ·æœ¬æ•°æ®çš„è‡ªç„¶å¯¹æ•°ã€‚ç‰¹æ®Šæƒ…å†µï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln(+Inf) = +Inf</span><br><span class="line">ln(0) = -Inf</span><br><span class="line">ln(x &lt; 0) = NaN</span><br><span class="line">ln(NaN) = NaN</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="log2-å‡½æ•°"><a href="#log2-å‡½æ•°" class="headerlink" title="log2() å‡½æ•°"></a>log2() å‡½æ•°</h4><p>æè¿°: <code>log2(v instant-vector)</code> å‡½æ•°è®¡ç®—ç¬æ—¶å‘é‡ v ä¸­æ‰€æœ‰æ ·æœ¬æ•°æ®çš„äºŒè¿›åˆ¶å¯¹æ•°ã€‚ç‰¹æ®Šæƒ…å†µåŒä¸Šã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log2(vector(2)) <span class="comment"># &#123;&#125;	1</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="log10-å‡½æ•°"><a href="#log10-å‡½æ•°" class="headerlink" title="log10() å‡½æ•°"></a>log10() å‡½æ•°</h4><p>æè¿°: <code>log10(v instant-vector)</code> è®¡ç®—ç¬æ—¶å‘é‡ v ä¸­æ‰€æœ‰æ ·æœ¬æ•°æ®çš„åè¿›åˆ¶å¯¹æ•°ã€‚ç‰¹æ®Šæƒ…å†µåŒä¸Šã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log2(vector(10)) <span class="comment"># &#123;&#125;	1</span></span><br></pre></td></tr></table></figure><br><br></p>
<h4 id="exp-å‡½æ•°"><a href="#exp-å‡½æ•°" class="headerlink" title="exp() å‡½æ•°"></a>exp() å‡½æ•°</h4><p>æè¿°: <code>exp(v instant-vector)</code> å‡½æ•°ï¼Œè¾“å…¥ä¸€ä¸ªç¬æ—¶å‘é‡ï¼Œè¿”å›å„ä¸ªæ ·æœ¬å€¼çš„ e çš„æŒ‡æ•°å€¼ï¼Œå³ e çš„ N æ¬¡æ–¹ã€‚å½“ N çš„å€¼è¶³å¤Ÿå¤§æ—¶ä¼šè¿”å› +Infã€‚</p>
<p>Tips ï¼š exp å‡½æ•°æä¾›è‡ªç„¶å¯¹æ•°ï¼Œä¸lnå‡½æ•°ç›¸åã€‚</p>
<p>ç‰¹æ®Šæƒ…å†µä¸ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exp(+Inf) = +Inf</span><br><span class="line">Exp(NaN) = NaN</span><br><span class="line">exp(vector(1))  <span class="comment"># &#123;&#125; 	2.718281828459045 æ¬§æ‹‰æ•°å­—e</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="sqrt-å‡½æ•°"><a href="#sqrt-å‡½æ•°" class="headerlink" title="sqrt() å‡½æ•°"></a>sqrt() å‡½æ•°</h4><p>æè¿°: <code>sqrt(v instant-vector)</code> å‡½æ•°è®¡ç®—å‘é‡ v ä¸­æ‰€æœ‰å…ƒç´ çš„å¹³æ–¹æ ¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sqrt(vector(9)) <span class="comment"># &#123;&#125; 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sqrt æ—©äºæŒ‡æ•°è¿ç®—ç¬¦^ï¼Œä¾‹å¦‚</span></span><br><span class="line">vector(9) ^ 0.5   <span class="comment"># &#123;&#125; 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ ·å¦‚æœä½ éœ€è¦å…¶å®ƒæ–¹æ ¹ï¼Œä¾‹å¦‚</span></span><br><span class="line">vector(9) ^ (1/3)  <span class="comment"># &#123;&#125; 	2.080083823051904</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="ceil-å‡½æ•°"><a href="#ceil-å‡½æ•°" class="headerlink" title="ceil() å‡½æ•°"></a>ceil() å‡½æ•°</h4><p>æè¿°: <code>ceil (v instant-vector)</code>å°† v ä¸­æ‰€æœ‰å…ƒç´ çš„æ ·æœ¬å€¼<code>å‘ä¸Šå››èˆäº”å…¥</code>åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node_load5&#123;instance=<span class="string">"192.168.1.75:9100"</span>&#125;       <span class="comment"># ç»“æœä¸º 2.79</span></span><br><span class="line">ceil(node_load5&#123;instance=<span class="string">"192.168.1.75:9100"</span>&#125;) <span class="comment"># ç»“æœä¸º 3</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="floor-å‡½æ•°"><a href="#floor-å‡½æ•°" class="headerlink" title="floor() å‡½æ•°"></a>floor() å‡½æ•°</h4><p>æè¿°: <code>floor(v instant-vector)</code> å‡½æ•°ä¸ ceil() å‡½æ•°ç›¸åï¼Œå°† v ä¸­æ‰€æœ‰å…ƒç´ çš„æ ·æœ¬å€¼<code>å‘ä¸‹å››èˆäº”å…¥</code>åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ã€‚</p>
<p><br></p>
<h4 id="round-å‡½æ•°"><a href="#round-å‡½æ•°" class="headerlink" title="round() å‡½æ•°"></a>round() å‡½æ•°</h4><p>æè¿°: <code>round(v instant-vector, to_nearest=1 scalar)</code> å‡½æ•°ä¸ ceil å’Œ floor å‡½æ•°ç±»ä¼¼ï¼Œè¿”å›å‘é‡ä¸­æ‰€æœ‰æ ·æœ¬å€¼çš„æœ€æ¥è¿‘çš„æ•´æ•°ã€‚to_nearest å‚æ•°æ˜¯å¯é€‰çš„, é»˜è®¤ä¸º 1 è¡¨ç¤ºæ ·æœ¬è¿”å›çš„æ˜¯æœ€æ¥è¿‘ 1 çš„æ•´æ•°å€çš„å€¼ã€‚ä½ ä¹Ÿå¯ä»¥å°†è¯¥å‚æ•°æŒ‡å®šä¸ºä»»æ„å€¼ï¼ˆä¹Ÿå¯ä»¥æ˜¯å°æ•°ï¼‰ï¼Œè¡¨ç¤ºæ ·æœ¬è¿”å›çš„æ˜¯æœ€æ¥è¿‘å®ƒçš„æ•´æ•°å€çš„å€¼ã€‚</p>
<p>å®ä¾‹æ¼”ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceil(vector(6.5))  <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line">floor(vector(6.5)) <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">round(vector(6.5)) <span class="comment"># 7</span></span><br><span class="line">round(vector(6.4)) <span class="comment"># 6</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="clamp-å‡½æ•°"><a href="#clamp-å‡½æ•°" class="headerlink" title="clamp() å‡½æ•°"></a>clamp() å‡½æ•°</h4><p>æè¿°: <code>clamp(v instant-vector, min scalar, max scalar)</code> å°†æ‰€æœ‰å…ƒç´ çš„æ ·æœ¬å€¼é’³åˆ¶åœ¨<code>v</code>ä¸‹é™ä¸º<code>min</code>å’Œä¸Šé™ä¸º<code>max</code>ã€‚</p>
<p>ç‰¹æ®Šæƒ…å†µï¼š - è¿”å›ç©ºå‘é‡ if <code>min &gt; max</code> - è¿”å›<code>NaN</code>if<code>min</code>æˆ–<code>max</code>is<code>NaN</code></p>
<p><br></p>
<h4 id="clamp-max-å‡½æ•°"><a href="#clamp-max-å‡½æ•°" class="headerlink" title="clamp_max() å‡½æ•°"></a>clamp_max() å‡½æ•°</h4><p>æè¿°: <code>clamp_max(v instant-vector, max scalar)</code>å‡½æ•°ï¼Œè¾“å…¥ä¸€ä¸ªç¬æ—¶å‘é‡å’Œæœ€å¤§å€¼ï¼Œæ ·æœ¬æ•°æ®å€¼è‹¥å¤§äº maxï¼Œåˆ™æ”¹ä¸º maxï¼Œå¦åˆ™ä¸å˜ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node_load5&#123;instance=<span class="string">"192.168.1.75:9100"</span>&#125;               <span class="comment"># ç»“æœä¸º 2.79</span></span><br><span class="line">clamp_max(node_load5&#123;instance=<span class="string">"192.168.1.75:9100"</span>&#125;, 2) <span class="comment"># ç»“æœä¸º 2</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="clamp-min-å‡½æ•°"><a href="#clamp-min-å‡½æ•°" class="headerlink" title="clamp_min() å‡½æ•°"></a>clamp_min() å‡½æ•°</h4><p>æè¿°: <code>clamp_min(v instant-vector, min scalar)</code> å‡½æ•°ï¼Œè¾“å…¥ä¸€ä¸ªç¬æ—¶å‘é‡å’Œæœ€å°å€¼ï¼Œæ ·æœ¬æ•°æ®å€¼è‹¥å°äº minï¼Œåˆ™æ”¹ä¸º min å¦åˆ™ä¸å˜ã€‚</p>
<p>ä¾‹å¦‚ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">node_load5&#123;instance=<span class="string">"192.168.1.75:9100"</span>&#125; <span class="comment"># ç»“æœä¸º 2.79</span></span><br><span class="line">clamp_min(node_load5&#123;instance=<span class="string">"192.168.1.75:9100"</span>&#125;, 3) <span class="comment"># ç»“æœä¸º 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‚£äº›ç›®æ ‡è¿›ç¨‹ä½¿ç”¨æœ€å°‘æ˜¯10ä¸ªæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦(min &lt; å€¼ &lt; max)</span></span><br><span class="line">clamp_min(process_open_fds,10)</span><br><span class="line">  <span class="comment"># &#123;instance="192.168.1.225:9100", job="linux_exporter"&#125;	9</span></span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125;	10</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="4-æ—¶é—´å‡½æ•°"><a href="#4-æ—¶é—´å‡½æ•°" class="headerlink" title="4.æ—¶é—´å‡½æ•°"></a>4.æ—¶é—´å‡½æ•°</h3><p>æè¿°: Prometheusæä¾›å‡ ä¸ªå¤„ç†æ—¶é—´çš„å‡½æ•°ï¼Œæ³¨æ„å…¶å®Œå…¨ä½¿ç”¨UTCå¹¶æ²¡æœ‰æ—¶åŒºçš„æ¦‚å¿µã€‚</p>
<h4 id="time-å‡½æ•°"><a href="#time-å‡½æ•°" class="headerlink" title="time() å‡½æ•°"></a>time() å‡½æ•°</h4><p>æè¿°: time() å‡½æ•°è¿”å›ä» <code>1970-01-01</code> åˆ°ç°åœ¨çš„ç§’æ•°ã€‚æ³¨æ„ï¼šå®ƒä¸æ˜¯ç›´æ¥è¿”å›å½“å‰æ—¶é—´è€Œæ˜¯æ—¶é—´æˆ³.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿”å›å½“å‰æ—¶é—´UTCæ ¼å¼</span></span><br><span class="line">time()  <span class="comment"># scalar 1626675614.185</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># èŠ‚ç‚¹å¼€æœºæ—¶é—´</span></span><br><span class="line">time() - process_start_time_seconds <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125;	243129.00699996948</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="minute-å‡½æ•°"><a href="#minute-å‡½æ•°" class="headerlink" title="minute() å‡½æ•°"></a>minute() å‡½æ•°</h4><p>æè¿°: <code>minute(v=vector(time()) instant-vector)</code> å‡½æ•°è¿”å›ç»™å®š UTC æ—¶é—´å½“å‰å°æ—¶çš„ç¬¬å¤šå°‘åˆ†é’Ÿã€‚ç»“æœèŒƒå›´ï¼š0~59ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minute(vector(time()))  <span class="comment">#  50 åˆ†é’Ÿ</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="hour-å‡½æ•°"><a href="#hour-å‡½æ•°" class="headerlink" title="hour()  å‡½æ•°"></a>hour()  å‡½æ•°</h4><p><code>hour(v=vector(time()) instant-vector)</code>ä»¥ UTC æ ¼å¼è¿”å›æ¯ä¸ªç»™å®šæ—¶é—´çš„ä¸€å¤©ä¸­çš„å°æ—¶ã€‚è¿”å›å€¼ä» 0 åˆ° 23ã€‚</p>
<p><br></p>
<h4 id="month-å‡½æ•°"><a href="#month-å‡½æ•°" class="headerlink" title="month() å‡½æ•°"></a>month() å‡½æ•°</h4><p>æè¿°: <code>month(v=vector(time()) instant-vector)</code> å‡½æ•°è¿”å›ç»™å®š UTC æ—¶é—´å½“å‰å±äºç¬¬å‡ ä¸ªæœˆï¼Œç»“æœèŒƒå›´ï¼š0~12ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">month(vector(time()))   <span class="comment"># 7 åˆ†é’Ÿ</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="year-å‡½æ•°"><a href="#year-å‡½æ•°" class="headerlink" title="year() å‡½æ•°"></a>year() å‡½æ•°</h4><p>æè¿°: <code>year(v=vector(time()) instant-vector)</code> å‡½æ•°è¿”å›è¢«ç»™å®š UTC æ—¶é—´çš„å½“å‰å¹´ä»½ã€‚</p>
<p>æ³¨æ„: å³ä½¿åŒºé—´å‘é‡å†…çš„å€¼åˆ†å¸ƒä¸å‡åŒ€ï¼Œå®ƒä»¬åœ¨èšåˆæ—¶çš„æƒé‡ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚</p>
<p>å®ä¾‹æ¼”ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.æŸ¥çœ‹è¿›ç¨‹æ˜¯å“ªä¸€å¹´å¼€å§‹è¿è¡Œ</span></span><br><span class="line">year(process_start_time_seconds)  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125; 2021</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.è®¡ç®—æœ¬æœˆå¯åŠ¨çš„è¿›ç¨‹çš„æ—¶é—´åºåˆ—</span></span><br><span class="line">year(process_start_time_seconds) == bool scalar(year())  * (month(process_start_time_seconds) == bool scalar(month()))</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125; 1</span></span><br><span class="line">  <span class="comment"># &#123;instance="192.168.1.225:9100", job="linux_exporter"&#125; 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.è®¡ç®—æœ¬æœˆå¯åŠ¨çš„è¿›ç¨‹çš„æ—¶é—´åºåˆ—ä¸ªæ•° </span></span><br><span class="line">sum(year(process_start_time_seconds) == bool scalar(year())  * (month(process_start_time_seconds) == bool scalar(month())))  <span class="comment"># &#123;&#125; 1</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : ä¹˜æ³•è¿ç®—ç¬¦åœ¨å¸ƒå°”å€¼ä½¿ç”¨æ—¶å°±åƒ<code>å’Œ</code>è¿ç®—ç¬¦ä¸€æ ·å€¼1è¡¨ç¤ºçœŸï¼Œå¦åˆ™ä¸ºå‡ã€‚</p>
<p><br></p>
<h4 id="day-of-month-å‡½æ•°"><a href="#day-of-month-å‡½æ•°" class="headerlink" title="day_of_month() å‡½æ•°"></a>day_of_month() å‡½æ•°</h4><p>æè¿°: <code>day_of_month(v=vector(time()) instant-vector)</code> å‡½æ•°ï¼Œè¿”å›è¢«ç»™å®š UTC æ—¶é—´æ‰€åœ¨æœˆçš„ç¬¬å‡ å¤©ã€‚è¿”å›å€¼èŒƒå›´ï¼š1~31ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">day_of_month(vector(time())) <span class="comment"># 19 å·</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="day-of-week-å‡½æ•°"><a href="#day-of-week-å‡½æ•°" class="headerlink" title="day_of_week() å‡½æ•°"></a>day_of_week() å‡½æ•°</h4><p>æè¿°: <code>day_of_week(v=vector(time()) instant-vector)</code> å‡½æ•°ï¼Œè¿”å›è¢«ç»™å®š UTC æ—¶é—´æ‰€åœ¨å‘¨çš„ç¬¬å‡ å¤©ã€‚è¿”å›å€¼èŒƒå›´ï¼š0~6ï¼Œ0 è¡¨ç¤ºæ˜ŸæœŸå¤©ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">day_of_week(vector(time())) <span class="comment"># 1 æ˜ŸæœŸå¤©</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="days-in-month-å‡½æ•°"><a href="#days-in-month-å‡½æ•°" class="headerlink" title="days_in_month() å‡½æ•°"></a>days_in_month() å‡½æ•°</h4><p>æè¿°: <code>days_in_month(v=vector(time()) instant-vector)</code> å‡½æ•°ï¼Œè¿”å›å½“æœˆä¸€å…±æœ‰å¤šå°‘å¤©ã€‚è¿”å›å€¼èŒƒå›´ï¼š28~31ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">days_in_month(vector(time())) <span class="comment"># 31 å½“æœˆ31å¤©</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="timestamp-å‡½æ•°"><a href="#timestamp-å‡½æ•°" class="headerlink" title="timestamp() å‡½æ•°"></a>timestamp() å‡½æ•°</h4><p>æè¿°ï¼š<code>timestamp(v instant-vector)</code> å‡½æ•°è¿”å›å‘é‡ v ä¸­çš„æ¯ä¸ªæ ·æœ¬çš„æ—¶é—´æˆ³ï¼ˆä» 1970-01-01 åˆ°ç°åœ¨çš„ç§’æ•°ï¼‰ã€‚</p>
<p>è¯¥å‡½æ•°ä» Prometheus 2.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥, ä¸å…¶å®ƒæ—¶é—´å‡½æ•°ä¸åŒçš„æ˜¯ï¼Œå®ƒæŸ¥çœ‹ç¬æ—¶å‘é‡ä¸­çš„æ ·æœ¬çš„æ—¶é—´æˆ³è€Œä¸æ˜¯å€¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®ä¾‹1.</span></span><br><span class="line">timestamp(vector(time()))  <span class="comment"># &#123;&#125; 	1629783662.714</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ä¾‹2.å¯ä»¥çœ‹åˆ°æ¯ä¸ªç›®æ ‡çš„æœ€åå¼‚å¸¸æŠ“å–çš„å¼€å§‹æ—¶é—´ã€‚</span></span><br><span class="line">timestamp(up) <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125; 1629783745.147</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ä¾‹3.è¿”å›Prometheuså¯åŠ¨èŠ‚ç‚¹å¯¼å‡ºå™¨æŠ“å–æ—¶é—´ä¸èŠ‚ç‚¹å¯¼å‡ºå™¨è®¤ä¸ºçš„å½“å‰å®è·µçš„å·®å€¼ã€‚</span></span><br><span class="line">node_time_seconds - timestamp(node_time_seconds)  <span class="comment"># &#123;instance="192.168.1.107:9100", job="linux_exporter"&#125; 0.0025420188903808594</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="5-æ ‡ç­¾å‡½æ•°"><a href="#5-æ ‡ç­¾å‡½æ•°" class="headerlink" title="5.æ ‡ç­¾å‡½æ•°"></a>5.æ ‡ç­¾å‡½æ•°</h3><h4 id="label-join-å‡½æ•°"><a href="#label-join-å‡½æ•°" class="headerlink" title="label_join() å‡½æ•°"></a>label_join() å‡½æ•°</h4><p>æè¿°: è¯¥å‡½æ•°å…è®¸ä½ å°†æ ‡ç­¾çº¸è¿æ¥åœ¨ç”¨ï¼Œç±»ä¼¼äºåœ¨é‡æ–°æ ‡è®°æ—¶å¤„ç†souce_lablesæ–¹æ³•ï¼ŒåŒæ ·è¯¥å‡½æ•°ä¹Ÿä¸ä¼šåˆ é™¤æŒ‡æ ‡åç§°ã€‚</p>
<p>è¯­æ³•æ ¼å¼: <code>label_join(v instant-vector, dst_label string, separator string, src_label_1 string, src_label_2 string, ...)</code></p>
<p>Tips: è¯¥å‡½æ•°å¯ä»¥å°†æ—¶é—´åºåˆ— v ä¸­å¤šä¸ªæ ‡ç­¾ src_label çš„å€¼ï¼Œ<code>é€šè¿‡ separator ä½œä¸ºè¿æ¥ç¬¦å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„æ ‡ç­¾ dst_label ä¸­</code>,æ³¨æ„å¯ä»¥æœ‰å¤šä¸ª src_label æ ‡ç­¾ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡¨è¾¾å¼è¿”å›çš„æ—¶é—´åºåˆ—å¤šäº†ä¸€ä¸ª foo æ ‡ç­¾ï¼Œæ ‡ç­¾å€¼ä¸º <code>etcd,etcd-k8s</code>ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">up&#123;instance=<span class="string">"192.168.1.8:2379"</span>,job=<span class="string">"etcd"</span>,service=<span class="string">"etcd-k8s"</span>&#125; =&gt; </span><br><span class="line">  <span class="comment"># up&#123;endpoint="api",instance="192.168.1.8:2379",job="etcd",service="etcd-k8s"&#125;  1</span></span><br><span class="line">label_join(up&#123;instance=<span class="string">"192.168.1.8:2379"</span>,job=<span class="string">"etcd"</span>,service=<span class="string">"etcd-k8s"</span>&#125;, <span class="string">"foo"</span>, <span class="string">","</span>, <span class="string">"job"</span>, <span class="string">"service"</span>) =&gt; </span><br><span class="line">  <span class="comment"># up&#123;endpoint="api",foo="etcd,etcd-k8s",instance="192.168.13.248:2379",job="etcd",namespace="monitoring",service="etcd-k8s"&#125;  1</span></span><br></pre></td></tr></table></figure></p>
<p>ä¾‹å¦‚, ä¸€ä¸ªç®€å•ä¾‹å­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">go_info&#123;job=<span class="string">"LocalServer"</span>&#125;  </span><br><span class="line">  <span class="comment"># ==&gt; go_info&#123;instance="localhost:9090", job="LocalServer", version="go1.16.4"&#125; 1</span></span><br><span class="line"></span><br><span class="line">label_join(go_info&#123;job=<span class="string">"LocalServer"</span>&#125;,<span class="string">"newlable"</span>,<span class="string">'|'</span>,<span class="string">"job"</span>,<span class="string">"version"</span>)</span><br><span class="line">  <span class="comment"># ==&gt; go_info&#123;instance="localhost:9090", job="LocalServer", newlable="LocalServer|go1.16.4", version="go1.16.4"&#125; 1</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="label-replace-å‡½æ•°"><a href="#label-replace-å‡½æ•°" class="headerlink" title="label_replace() å‡½æ•°"></a>label_replace() å‡½æ•°</h4><p>æè¿°: è¯¥å‡½æ•°å…è®¸ä½ å¯¹æ ‡ç­¾å€¼è¿›è¡Œæ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢ã€‚ä¸å¤§å¤šæ•°å‡½æ•°ä¸åŒçš„æ˜¯ï¼Œè¯¥å‡½æ•°ä¸ä¼šåˆ é™¤æŒ‡æ ‡åç§°ã€‚</p>
<p>Tips: ä¸ºäº†èƒ½å¤Ÿè®©å®¢æˆ·ç«¯çš„å›¾æ ‡æ›´å…·æœ‰å¯è¯»æ€§ï¼Œå¯ä»¥é€šè¿‡ label_replace å‡½æ•°ä¸ºæ—¶é—´åºåˆ—æ·»åŠ é¢å¤–çš„æ ‡ç­¾ã€‚</p>
<p>label_replace çš„å…·ä½“æ ¼å¼å‚æ•°ï¼š<code>label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)</code></p>
<p>ä¾‹å¦‚: è¯¥å‡½æ•°ä¼šä¾æ¬¡å¯¹ v ä¸­çš„æ¯ä¸€æ¡æ—¶é—´åºåˆ—è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡ regex åŒ¹é… src_label çš„å€¼ï¼Œå¹¶å°†åŒ¹é…éƒ¨åˆ† relacement å†™å…¥åˆ° dst_label æ ‡ç­¾ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">label_replace(up, <span class="string">"host"</span>, <span class="string">"<span class="variable">$1</span>"</span>, <span class="string">"instance"</span>,  <span class="string">"(.*):.*"</span>)</span><br><span class="line">label_replace(up&#123;job=<span class="string">"api-server"</span>,service=<span class="string">"a:c"</span>&#125;, <span class="string">"foo"</span>, <span class="string">"<span class="variable">$1</span>"</span>, <span class="string">"service"</span>, <span class="string">"(.*):.*"</span>)</span><br></pre></td></tr></table></figure></p>
<p>å‡½æ•°å¤„ç†åï¼Œæ—¶é—´åºåˆ—å°†åŒ…å«ä¸€ä¸ª host æ ‡ç­¾ï¼Œhost æ ‡ç­¾çš„å€¼ä¸º Exporter å®ä¾‹çš„ IP åœ°å€ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">up&#123;host=<span class="string">"localhost"</span>,instance=<span class="string">"localhost:8080"</span>,job=<span class="string">"cadvisor"</span>&#125;   1</span><br><span class="line">up&#123;host=<span class="string">"localhost"</span>,instance=<span class="string">"localhost:9090"</span>,job=<span class="string">"prometheus"</span>&#125;   1</span><br><span class="line">up&#123;host=<span class="string">"localhost"</span>,instance=<span class="string">"localhost:9100"</span>,job=<span class="string">"node"</span>&#125;   1</span><br></pre></td></tr></table></figure></p>
<p>ä¾‹å¦‚: æ›´ç®€å•çš„ä¾‹å­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">up&#123;job=<span class="string">"LocalServer"</span>&#125; </span><br><span class="line"><span class="comment"># ==&gt; up&#123;instance="localhost:9090", job="LocalServer"&#125;</span></span><br><span class="line"></span><br><span class="line">label_replace(up&#123;job=<span class="string">"LocalServer"</span>&#125;, <span class="string">"instance"</span>, <span class="string">"<span class="variable">$1</span>:9200"</span>, <span class="string">"job"</span>,  <span class="string">"(.*)"</span>)</span><br><span class="line"><span class="comment"># ==&gt; up&#123;instance="LocalServer:9200", job="LocalServer"&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="6-ç¼ºå¤±ä¸æ’åºå‡½æ•°"><a href="#6-ç¼ºå¤±ä¸æ’åºå‡½æ•°" class="headerlink" title="6.ç¼ºå¤±ä¸æ’åºå‡½æ•°"></a>6.ç¼ºå¤±ä¸æ’åºå‡½æ•°</h3><h4 id="absent-å‡½æ•°"><a href="#absent-å‡½æ•°" class="headerlink" title="absent() å‡½æ•°"></a>absent() å‡½æ•°</h4><p>æè¿°: <code>absent(v instant-vector)</code> è¯¥å‡½æ•°åœ¨å¤šå¯¹å¤šé€»è¾‘è¿ç®—ç¬¦ä¸­æ‰€è¿°ï¼Œè¯¥å‡½æ•°æ‰®æ¼”notè¿ç®—ç¬¦çš„è§’è‰²ã€‚</p>
<p>å³å¦‚æœä¼ é€’ç»™å®ƒçš„å‘é‡å‚æ•°å…·æœ‰æ ·æœ¬æ•°æ®ï¼Œåˆ™è¿”å›ç©ºå‘é‡ï¼›å¦‚æœä¼ é€’çš„å‘é‡å‚æ•°æ²¡æœ‰æ ·æœ¬æ•°æ®ï¼Œåˆ™è¿”å›ä¸å¸¦åº¦é‡æŒ‡æ ‡åç§°ä¸”å¸¦æœ‰æ ‡ç­¾çš„æ—¶é—´åºåˆ—ä¸”æ ·æœ¬å€¼ä¸º1ã€‚</p>
<p>Tips: å½“ç›‘æ§åº¦é‡æŒ‡æ ‡æ—¶, å¦‚æœè·å–åˆ°çš„æ ·æœ¬æ•°æ®æ˜¯ç©ºçš„, ä½¿ç”¨ absent æ–¹æ³•å¯¹å‘Šè­¦æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0.å¦‚æœå‚æ•°æ˜¯ç¬æ—¶å‘é‡é€‰æ‹©å™¨ï¼Œå®ƒä½¿ç”¨æ¥è‡ªä»»ä½•ç›¸ç­‰åŒ¹é…å™¨çš„æ ‡ç­¾ã€‚</span></span><br><span class="line">absent(up)  <span class="comment"># ç©ºçš„ç¬æ—¶çŸ¢é‡</span></span><br><span class="line">absent(up_not_existent) <span class="comment"># &#123;&#125; 1</span></span><br><span class="line">absent(up_not_existent) <span class="comment"># &#123;&#125; 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.æä¾›çš„å‘é‡æ ·æœ¬æ•°æ®æ¼”ç¤º</span></span><br><span class="line">go_gc_duration_seconds_sum&#123;job=<span class="string">"LocalServer"</span>&#125;         ==&gt;&gt; 	4.2270563150000005</span><br><span class="line">absent(go_gc_duration_seconds_sum&#123;job=<span class="string">"LocalServer"</span>&#125;) ==&gt;&gt;  Empty query result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æä¾›çš„å‘é‡æ— æ ·æœ¬æ•°æ®æ¼”ç¤º</span></span><br><span class="line">prometheus_http_requests_total&#123;method=<span class="string">"get"</span>&#125; <span class="comment"># Empty query result</span></span><br><span class="line">absent(prometheus_http_requests_total&#123;method=<span class="string">"get"</span>&#125;)       =&gt; 1  <span class="comment"># è¿”å›ä¸å¸¦åº¦é‡æŒ‡æ ‡åç§°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.ç”±äºä¸å­˜åœ¨åº¦é‡æŒ‡æ ‡ nonexistentï¼Œæ‰€ä»¥è¿”å›ä¸å¸¦åº¦é‡æŒ‡æ ‡åç§°ä¸”å¸¦æœ‰æ ‡ç­¾çš„æ—¶é—´åºåˆ—ï¼Œä¸”æ ·æœ¬å€¼ä¸º1</span></span><br><span class="line">absent(nonexistent&#123;job=<span class="string">"myjob"</span>&#125;)  =&gt; &#123;job=<span class="string">"myjob"</span>&#125;                =&gt; 1 </span><br><span class="line"><span class="comment"># æ­£åˆ™åŒ¹é…çš„ instance ä¸ä½œä¸ºè¿”å› labels ä¸­çš„ä¸€éƒ¨åˆ†</span></span><br><span class="line">absent(nonexistent&#123;job=<span class="string">"myjob"</span>,instance=~<span class="string">".*"</span>&#125;) =&gt; &#123;job=<span class="string">"myjob"</span>&#125; =&gt; 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.sumå‡½æ•°è¿”å›çš„æ—¶é—´åºåˆ—ä¸å¸¦æœ‰æ ‡ç­¾ä¸”æ²¡æœ‰æ ·æœ¬æ•°æ®</span></span><br><span class="line">absent(sum(nonexistent&#123;job=<span class="string">"myjob"</span>&#125;))  =&gt; &#123;&#125;  =&gt; 1</span><br></pre></td></tr></table></figure></p>
<p>Tips: å¯¹äºæ£€æµ‹æ•´ä¸ªä»»åŠ¡æ˜¯ä»æœåŠ¡å‘ç°ä¸¢å¤±ä¸­æ˜¯æœ‰æ•ˆçš„ã€‚</p>
<p><br></p>
<h4 id="histogram-quantile-å‡½æ•°"><a href="#histogram-quantile-å‡½æ•°" class="headerlink" title="histogram_quantile() å‡½æ•°"></a>histogram_quantile() å‡½æ•°</h4><p>æè¿°: <code>histogram_quantile(Ï† float, b instant-vector)</code> ä» bucket ç±»å‹çš„å‘é‡ b ä¸­è®¡ç®— <code>Ï† (0 â‰¤ Ï† â‰¤ 1)</code> åˆ†ä½æ•°ï¼ˆç™¾åˆ†ä½æ•°çš„ä¸€èˆ¬å½¢å¼ï¼‰çš„æ ·æœ¬çš„æœ€å¤§å€¼ã€‚è¯¥å‡½æ•°é€‚ç”¨äºåœ¨ç¬æ—¶å‘é‡ä¸­é’ˆå¯¹å•ä¸ªhistogramç±»å‹å­é¡¹çš„ä¸åŒæ¡¶è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<p>Tips :ï¼ˆæœ‰å…³ Ï† åˆ†ä½æ•°çš„è¯¦ç»†è¯´æ˜ä»¥åŠç›´æ–¹å›¾æŒ‡æ ‡ç±»å‹çš„ä½¿ç”¨ï¼Œè¯·å‚é˜…ç›´æ–¹å›¾å’Œæ‘˜è¦ï¼‰ã€‚å‘é‡ b ä¸­çš„æ ·æœ¬æ˜¯æ¯ä¸ª bucket çš„é‡‡æ ·ç‚¹æ•°é‡ã€‚æ¯ä¸ªæ ·æœ¬çš„ labels ä¸­å¿…é¡»è¦æœ‰ le è¿™ä¸ª label æ¥è¡¨ç¤ºæ¯ä¸ª bucket çš„ä¸Šè¾¹ç•Œï¼Œæ²¡æœ‰ le æ ‡ç­¾çš„æ ·æœ¬ä¼šè¢«å¿½ç•¥ã€‚ç›´æ–¹å›¾æŒ‡æ ‡ç±»å‹è‡ªåŠ¨æä¾›å¸¦æœ‰ _bucket åç¼€å’Œç›¸åº”æ ‡ç­¾çš„æ—¶é—´åºåˆ—ã€‚</p>
<ul>
<li>ä¾‹å¦‚ï¼Œä¸€ä¸ªç›´æ–¹å›¾æŒ‡æ ‡åç§°ä¸º employee_age_bucket_bucketï¼Œè¦è®¡ç®—è¿‡å» 10 åˆ†é’Ÿå†… ç¬¬ 90 ä¸ªç™¾åˆ†ä½æ•°ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹è¡¨è¾¾å¼ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">histogram_quantile(0.9, rate(employee_age_bucket_bucket[10m]))</span><br><span class="line"><span class="comment"># è¿”å›ï¼š</span></span><br><span class="line"><span class="comment"># &#123;instance="10.0.86.71:8080",job="prometheus"&#125; 35.714285714285715</span></span><br></pre></td></tr></table></figure>
è¿™è¡¨ç¤ºæœ€è¿‘ 10 åˆ†é’Ÿä¹‹å†… 90% çš„æ ·æœ¬çš„æœ€å¤§å€¼ä¸º 35.714285714285715ã€‚</li>
</ul>
<p>Tips : è¿™ä¸ªè®¡ç®—ç»“æœæ˜¯æ¯ç»„æ ‡ç­¾ç»„åˆæˆä¸€ä¸ªæ—¶é—´åºåˆ—ã€‚æˆ‘ä»¬å¯èƒ½ä¸ä¼šå¯¹æ‰€æœ‰è¿™äº›ç»´åº¦<code>ï¼ˆå¦‚ jobã€instance å’Œ methodï¼‰</code>æ„Ÿå…´è¶£ï¼Œå¹¶å¸Œæœ›å°†å…¶ä¸­çš„ä¸€äº›ç»´åº¦è¿›è¡Œèšåˆï¼Œåˆ™å¯ä»¥ä½¿ç”¨ sum() å‡½æ•°</p>
<ul>
<li>ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡¨è¾¾å¼æ ¹æ® job æ ‡ç­¾æ¥å¯¹ç¬¬ 90 ä¸ªç™¾åˆ†ä½æ•°è¿›è¡Œèšåˆï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># histogram_quantile() å‡½æ•°å¿…é¡»åŒ…å« le æ ‡ç­¾</span></span><br><span class="line">histogram_quantile(0.9, sum(rate(employee_age_bucket_bucket[10m])) by (job, le))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœè¦èšåˆæ‰€æœ‰çš„æ ‡ç­¾ï¼Œåˆ™ä½¿ç”¨å¦‚ä¸‹è¡¨è¾¾å¼ï¼š</span></span><br><span class="line">histogram_quantile(0.9,sum(rate(employee_age_bucket_bucket[10m])) by (le))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips: å¯ä»¥ä½¿ç”¨ rate() å‡½æ•°æ¥æŒ‡å®šåˆ†ä½æ•°è®¡ç®—çš„æ—¶é—´çª—å£ã€‚</p>
<p>æ³¨æ„: <code>histogram_quantile</code> è¿™ä¸ªå‡½æ•°æ˜¯æ ¹æ®å‡å®šæ¯ä¸ªåŒºé—´å†…çš„æ ·æœ¬åˆ†å¸ƒæ˜¯çº¿æ€§åˆ†å¸ƒæ¥è®¡ç®—ç»“æœå€¼çš„(ä¹Ÿå°±æ˜¯è¯´å®ƒçš„ç»“æœæœªå¿…å‡†ç¡®)ï¼Œæœ€é«˜çš„ bucket å¿…é¡»æ˜¯ <code>le=&quot;+Inf&quot;</code> (å¦åˆ™å°±è¿”å› NaN)ã€‚å¦‚æœåˆ†ä½æ•°ä½äºæœ€é«˜çš„ <code>bucketï¼ˆ+Infï¼‰</code> ä¸­ï¼Œåˆ™è¿”å›ç¬¬äºŒä¸ªæœ€é«˜çš„ bucket çš„ä¸Šè¾¹ç•Œã€‚å¦‚æœè¯¥ bucket çš„ä¸Šè¾¹ç•Œå¤§äº 0ï¼Œåˆ™å‡è®¾æœ€ä½çš„ bucket çš„çš„ä¸‹è¾¹ç•Œä¸º 0ï¼Œè¿™ç§æƒ…å†µä¸‹åœ¨è¯¥ bucket å†…ä½¿ç”¨å¸¸è§„çš„çº¿æ€§æ’å€¼ã€‚å¦‚æœåˆ†ä½æ•°ä½äºæœ€ä½çš„ bucket ä¸­ï¼Œåˆ™è¿”å›æœ€ä½ bucket çš„ä¸Šè¾¹ç•Œã€‚</p>
<p>æ³¨æ„: å¦‚æœ b å«æœ‰å°‘äº 2 ä¸ª bucketsï¼Œé‚£ä¹ˆä¼šè¿”å› NaNï¼Œå¦‚æœ Ï† &lt; 0 ä¼šè¿”å› -Infï¼Œå¦‚æœ Ï† &gt; 1 ä¼šè¿”å› +Infã€‚</p>
<p><br></p>
<h4 id="sort-å‡½æ•°"><a href="#sort-å‡½æ•°" class="headerlink" title="sort() å‡½æ•°"></a>sort() å‡½æ•°</h4><p>æè¿°: <code>sort(v instant-vector)</code> å‡½æ•°å¯¹å‘é‡æŒ‰å…ƒç´ çš„å€¼è¿›è¡Œå‡åºæ’åºï¼Œè¿”å›ç»“æœï¼š<code>key: value = åº¦é‡æŒ‡æ ‡ï¼šæ ·æœ¬å€¼[å‡åºæ’åˆ—]</code>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort(node_load5&#123;&#125;)      <span class="comment"># æ­£åº</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="sort-desc-å‡½æ•°"><a href="#sort-desc-å‡½æ•°" class="headerlink" title="sort_desc() å‡½æ•°"></a>sort_desc() å‡½æ•°</h4><p>æè¿°: <code>sort(v instant-vector)</code> å‡½æ•°å¯¹å‘é‡æŒ‰å…ƒç´ çš„å€¼è¿›è¡Œé™åºæ’åºï¼Œè¿”å›ç»“æœï¼š<code>key: value = åº¦é‡æŒ‡æ ‡ï¼šæ ·æœ¬å€¼[é™åºæ’åˆ—]</code>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort_desc(node_load5&#123;&#125;) <span class="comment"># ååº</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<h3 id="7-è®¡æ•°å™¨"><a href="#7-è®¡æ•°å™¨" class="headerlink" title="7.è®¡æ•°å™¨"></a>7.è®¡æ•°å™¨</h3><p>æè¿°: è®¡æ•°å™¨åŒ…æ‹¬ counter ç±»å‹ã€summary ç±»å‹å’Œhistogramç±»å‹æŒ‡å®šä¸­çš„_sum,_count,_bucketçš„æ—¶é—´åºåˆ—ã€‚</p>
<p>Tips: è®¡æ•°å™¨çš„å€¼åªå‡ä¸é™ï¼Œå½“åº”ç”¨é‡æ–°å¯åŠ¨åï¼Œè®¡æ•°å™¨åˆå§‹åŒ–ä¸º0.</p>
<h4 id="rate-å‡½æ•°"><a href="#rate-å‡½æ•°" class="headerlink" title="rate å‡½æ•°"></a>rate å‡½æ•°</h4><p>æè¿°: <code>rate(v range-vector)</code> å‡½æ•°å¯ä»¥ç›´æ¥è®¡ç®—åŒºé—´å‘é‡ v åœ¨æ—¶é—´çª—å£å†…å¹³å‡å¢é•¿é€Ÿç‡ï¼Œå³<code>è¿”å›è®¡æ•°å™¨åœ¨ä¼ å…¥ç»™å®ƒçš„èŒƒå›´å‘é‡ä¸­çš„æ¯ä¸ªæ—¶é—´åºåˆ—æ¯ç§’å¢åŠ é€Ÿç‡</code>ã€‚å®ƒä¼šåœ¨å•è°ƒæ€§å‘ç”Ÿå˜åŒ–æ—¶(å¦‚ç”±äºé‡‡æ ·ç›®æ ‡é‡å¯å¼•èµ·çš„è®¡æ•°å™¨å¤ä½)è‡ªåŠ¨ä¸­æ–­ã€‚</p>
<p>Tips: </p>
<ul>
<li>1.è¯¥å‡½æ•°çš„è¿”å›ç»“æœä¸å¸¦æœ‰åº¦é‡æŒ‡æ ‡ï¼Œåªæœ‰æ ‡ç­¾åˆ—è¡¨ã€‚</li>
<li>2.è¯¥å‡½æ•°å¯æ±‚å¾—æŸä¸€æ—¶é—´å†…çš„<code>å¹³å‡ç‡( æ¬¡æ•° / æŒ‡å®šæ—¶é—´ç§’ )</code>ï¼Œè€Œä¸”è‡ªåŠ¨å¤„ç†ç”±è¿›ç¨‹é‡å¯å¯¼è‡´å¾—è®¡æ•°å™¨é‡ç½®å¯¹å…¶å¾—é—®é¢˜ã€‚</li>
<li>3.å»ºè®®ä½¿ç”¨çš„èŒƒå›´å‘é‡çš„èŒƒå›´è‡³å°‘æ˜¯æŠ“å–é—´éš”çš„å››å€ï¼Œä¾‹å¦‚å¯¹äº1minçš„æŠ“å–é—´éš”ï¼Œä½ å¯ä»¥ä½¿ç”¨4minçš„rateï¼Œä½†æ˜¯é€šå¸¸ä¼šä½¿ç”¨5minï¼Œrate(x_total[5m])ã€‚</li>
</ul>
<p><br></p>
<p><strong>ç¤ºä¾‹æ¼”ç¤º:</strong></p>
<ul>
<li><p>1) PromQL: <code>rate(http_requested_total[5m])</code>, è¯´æ˜: æ±‚å¾—æœ€å5åˆ†é’Ÿçš„å¹³å‡æ¯ç§’çš„è¯·æ±‚ç‡ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;instance="10.20.172.103:8000", job="control", method="GET", path="/"&#125;  0.003508771929824561</span><br><span class="line">&#123;instance="10.20.172.103:8000", job="control", method="GET", path="/api/"&#125; 0.021052631578947368</span><br><span class="line">&#123;instance="10.20.172.103:8000", job="control", method="GET", path="/favicon.ico"&#125; 0.03508771929824561</span><br></pre></td></tr></table></figure>
</li>
<li><p>2) PromQL: <code>rate(prometheus_http_requests_total[5m])</code>, ä¾‹å¦‚ä»¥ä¸‹è¡¨è¾¾å¼è¿”å›åŒºé—´å‘é‡ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—è¿‡å» 5 åˆ†é’Ÿå†… HTTP è¯·æ±‚æ•°çš„æ¯ç§’å¢é•¿ç‡ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;code="200",handler="label_values",instance="120.77.65.193:9090",job="prometheus",method="get"&#125; 0</span><br><span class="line">&#123;code="200",handler="query_range",instance="120.77.65.193:9090",job="prometheus",method="get"&#125;  0</span><br><span class="line">&#123;code="200",handler="prometheus",instance="120.77.65.193:9090",job="prometheus",method="get"&#125;   0.2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : rate() å‡½æ•°è¿”å›å€¼ç±»å‹åªèƒ½ç”¨è®¡æ•°å™¨ï¼Œåœ¨é•¿æœŸè¶‹åŠ¿åˆ†ææˆ–è€…å‘Šè­¦ä¸­æ¨èä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>æ³¨æ„: å½“å°† rate() å‡½æ•°ä¸èšåˆè¿ç®—ç¬¦ï¼ˆä¾‹å¦‚ sum()ï¼‰æˆ–éšæ—¶é—´èšåˆçš„å‡½æ•°ï¼ˆä»»ä½•ä»¥ _over_time ç»“å°¾çš„å‡½æ•°ï¼‰ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œ<code>å¿…é¡»å…ˆæ‰§è¡Œ rate å‡½æ•°ï¼Œç„¶åå†è¿›è¡Œsumèšåˆæ“ä½œ</code>ï¼Œå¦åˆ™å½“é‡‡æ ·ç›®æ ‡é‡æ–°å¯åŠ¨æ—¶ rate() æ— æ³•æ£€æµ‹åˆ°è®¡æ•°å™¨æ˜¯å¦è¢«é‡ç½®ã€‚</p>
<p><br></p>
<h4 id="increase-å‡½æ•°"><a href="#increase-å‡½æ•°" class="headerlink" title="increase() å‡½æ•°"></a>increase() å‡½æ•°</h4><p>æè¿°: <code>increase(v range-vector)</code> å‡½æ•°æ˜¯rateå‡½æ•°ä¸Šçš„è¯­æ³•ç³–ï¼Œä¾‹å¦‚ <code>increase(x_total[5m])</code> ç­‰åŒäº <code>rate(x_total[5m] * 300)</code> çš„ç»“æœä¹˜ä»¥èŒƒå›´å‘é‡çš„æ—¶é—´èŒƒå›´å…¶å®ƒé€»è¾‘ç›¸åŒã€‚</p>
<p>Tips: è¯¥å‡½æ•°è·å–åŒºé—´å‘é‡ä¸­çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ ·æœ¬å¹¶è¿”å›å…¶å¢é•¿é‡, å®ƒä¼šåœ¨å•è°ƒæ€§å‘ç”Ÿå˜åŒ–æ—¶(å¦‚ç”±äºé‡‡æ ·ç›®æ ‡é‡å¯å¼•èµ·çš„è®¡æ•°å™¨å¤ä½)è‡ªåŠ¨ä¸­æ–­ã€‚ç”±äºè¿™ä¸ªå€¼è¢«å¤–æ¨åˆ°æŒ‡å®šçš„æ•´ä¸ªæ—¶é—´èŒƒå›´ï¼Œæ‰€ä»¥å³ä½¿æ ·æœ¬å€¼éƒ½æ˜¯æ•´æ•°ï¼Œä½ ä»ç„¶å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªéæ•´æ•°å€¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.è¯¥å‡½æ•°çš„é²æ£’æ€§è¡¨ç°ä¹‹ä¸€æ˜¯å®ƒä»¬åœ¨ç»™å®šæ•´æ•°è¾“å…¥æ—¶å¯ä»¥è¿”å›éæ•´æ•°ç»“æœï¼Œ</span></span><br><span class="line">increase(x_total[15s]) <span class="comment"># 10s ä¸º 3ï¼Œä½†æ˜¯ä» 10s æ•°æ®æ¨å¯¼åˆ°15s ï¼Œåœ¨increaseä¼šäº§ç”Ÿçš„ç»“æ„æ˜¯4.5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡¨è¾¾å¼è¿”å›åŒºé—´å‘é‡ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—è¿‡å» 5 åˆ†é’Ÿå†… HTTP è¯·æ±‚æ•°çš„å¢é•¿æ•°ï¼š</span></span><br><span class="line">increase(prometheus_http_requests_total&#123;job=<span class="string">"apiserver"</span>&#125;[5m])</span><br></pre></td></tr></table></figure>
<p>Tips: increase çš„è¿”å›å€¼ç±»å‹åªèƒ½æ˜¯è®¡æ•°å™¨ç±»å‹ï¼Œä¸»è¦ä½œç”¨æ˜¯å¢åŠ å›¾è¡¨å’Œæ•°æ®çš„å¯è¯»æ€§, ä½¿ç”¨ rate å‡½æ•°è®°å½•è§„åˆ™çš„ä½¿ç”¨ç‡ï¼Œä»¥ä¾¿æŒç»­è·Ÿè¸ªæ•°æ®æ ·æœ¬å€¼çš„å˜åŒ–ã€‚</p>
<p><br></p>
<h4 id="irate-å‡½æ•°"><a href="#irate-å‡½æ•°" class="headerlink" title="irate() å‡½æ•°"></a>irate() å‡½æ•°</h4><p>æè¿°ï¼š<code>irate(v range-vector)</code> å‡½æ•°ç”¨äºè®¡ç®—åŒºé—´å‘é‡çš„å¢é•¿ç‡ï¼Œä½†æ˜¯å…¶ååº”å‡ºçš„æ˜¯ç¬æ—¶å¢é•¿ç‡ï¼ˆå³è¿”å›ä¸€ä¸ªè®¡æ•°å™¨æ­£åœ¨å¢åŠ çš„æ¯ç§’é€Ÿç‡ï¼‰ï¼Œå¤šç”¨äºå›¾å½¢å±•ç¤ºã€‚</p>
<p>Tips: irate å‡½æ•°æ˜¯é€šè¿‡åŒºé—´å‘é‡ä¸­æœ€åä¸¤ä¸ªä¸¤æœ¬æ•°æ®æ¥è®¡ç®—åŒºé—´å‘é‡çš„å¢é•¿é€Ÿç‡ï¼Œå®ƒä¼šåœ¨å•è°ƒæ€§å‘ç”Ÿå˜åŒ–æ—¶(å¦‚ç”±äºé‡‡æ ·ç›®æ ‡é‡å¯å¼•èµ·çš„è®¡æ•°å™¨å¤ä½)è‡ªåŠ¨ä¸­æ–­ã€‚è¿™ç§æ–¹å¼å¯ä»¥é¿å…åœ¨æ—¶é—´çª—å£èŒƒå›´å†…çš„â€œé•¿å°¾é—®é¢˜â€ï¼Œå¹¶ä¸”ä½“ç°å‡ºæ›´å¥½çš„çµæ•åº¦ï¼Œé€šè¿‡irateå‡½æ•°ç»˜åˆ¶çš„å›¾æ ‡èƒ½å¤Ÿæ›´å¥½çš„ååº”æ ·æœ¬æ•°æ®çš„ç¬æ—¶å˜åŒ–çŠ¶æ€ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è¡¨è¾¾å¼è¿”å›åŒºé—´å‘é‡ä¸­æ¯ä¸ªæ—¶é—´åºåˆ—è¿‡å» 5 åˆ†é’Ÿå†…æœ€åä¸¤ä¸ªæ ·æœ¬æ•°æ®çš„ HTTP è¯·æ±‚æ•°çš„å¢é•¿ç‡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irate(prometheus_http_requests_total&#123;job=<span class="string">"api-server"</span>&#125;[5m])</span><br></pre></td></tr></table></figure></p>
<p>Tips: è¯¥å‡½æ•°åªèƒ½ç”¨äºç»˜åˆ¶å¿«é€Ÿå˜åŒ–çš„è®¡æ•°å™¨ï¼Œåœ¨é•¿æœŸè¶‹åŠ¿åˆ†ææˆ–è€…å‘Šè­¦ä¸­æ›´æ¨èä½¿ç”¨ rate å‡½æ•°ã€‚å› ä¸ºä½¿ç”¨ irate å‡½æ•°æ—¶ï¼Œé€Ÿç‡çš„ç®€çŸ­å˜åŒ–ä¼šé‡ç½® FOR è¯­å¥ï¼Œå½¢æˆçš„å›¾å½¢æœ‰å¾ˆå¤šæ³¢å³°ï¼Œéš¾ä»¥é˜…è¯»ã€‚</p>
<p>Tips: å¦‚æœquery_range çš„æ­¥é•¿å¤§äºæŠ“å–æ—¶é—´é—´éš”ï¼Œåˆ™ä½¿ç”¨irateæ—¶å°†è·³è¿‡æ•°æ®ã€‚</p>
<p>æ³¨æ„: å½“å°†<code>irate()</code>å‡½æ•°ä¸<code>èšåˆè¿ç®—ç¬¦</code>ï¼ˆä¾‹å¦‚ sum()ï¼‰æˆ–éšæ—¶é—´èšåˆçš„å‡½æ•°ï¼ˆä»»ä½•ä»¥ _over_time ç»“å°¾çš„å‡½æ•°ï¼‰ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå¿…é¡»å…ˆæ‰§è¡Œ irate å‡½æ•°ï¼Œç„¶åå†è¿›è¡Œèšåˆæ“ä½œï¼Œå¦åˆ™å½“é‡‡æ ·ç›®æ ‡é‡æ–°å¯åŠ¨æ—¶ irate() æ— æ³•æ£€æµ‹åˆ°è®¡æ•°å™¨æ˜¯å¦è¢«é‡ç½®ã€‚</p>
<p><br></p>
<h4 id="resets-å‡½æ•°"><a href="#resets-å‡½æ•°" class="headerlink" title="resets() å‡½æ•°"></a>resets() å‡½æ•°</h4><p>æè¿°: <code>resets(v range-vector)</code> çš„å‚æ•°æ˜¯ä¸€ä¸ªåŒºé—´å‘é‡ï¼ˆ<code>è¿”å›èŒƒå›´å‘é‡ä¸­çš„æ¯ä¸ªæ—¶é—´åºåˆ—é‡ç½®æ¬¡æ•°</code>ï¼‰ã€‚å¯¹äºæ¯ä¸ªæ—¶é—´åºåˆ—å®ƒéƒ½è¿”å›ä¸€ä¸ªè®¡æ•°å™¨é‡ç½®çš„æ¬¡æ•°ã€‚ä¸¤ä¸ªè¿ç»­æ ·æœ¬ä¹‹é—´çš„å€¼çš„å‡å°‘è¢«è®¤ä¸ºæ˜¯ä¸€æ¬¡è®¡æ•°å™¨é‡ç½®ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.æ˜¾ç¤ºè¿›ç¨‹çš„CPUæ—¶é—´åœ¨è¿‡å»ä¸€ä¸ªå°æ—¶é‡ç½®çš„æ¬¡æ•°ã€‚</span></span><br><span class="line">resets(process_cpu_seconds_total[1h])</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="prom-Server"&#125;	0</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="8-Gaugeç±»å‹å¤„ç†å‡½æ•°"><a href="#8-Gaugeç±»å‹å¤„ç†å‡½æ•°" class="headerlink" title="8.Gaugeç±»å‹å¤„ç†å‡½æ•°"></a>8.Gaugeç±»å‹å¤„ç†å‡½æ•°</h3><h4 id="changes-å‡½æ•°"><a href="#changes-å‡½æ•°" class="headerlink" title="changes() å‡½æ•°"></a>changes() å‡½æ•°</h4><p>æè¿°: <code>changes (v range-vector)</code>è¾“å…¥ä¸€ä¸ªåŒºé—´å‘é‡è¿”å›è¿™ä¸ªåŒºé—´å‘é‡å†…Gaugeç±»å‹æ¯ä¸ªæ ·æœ¬æ•°æ®å€¼å˜åŒ–çš„æ¬¡æ•°<code>ï¼ˆç¬æ—¶å‘é‡ï¼‰</code>ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾‹å¦‚ï¼Œå¦‚æœæ ·æœ¬æ•°æ®å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™è¿”å›ç»“æœä¸º 1</span></span><br><span class="line">changes(node_load5&#123;instance=<span class="string">"192.168.1.75:9100"</span>&#125;[1m])  <span class="comment"># ç»“æœä¸º 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚ï¼Œè®¡ç®—è¿›ç¨‹é‡å¯æ¬¡æ•°ã€‚</span></span><br><span class="line">changes(process_start_time_seconds[1h])  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125; 0</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="deriv-å‡½æ•°"><a href="#deriv-å‡½æ•°" class="headerlink" title="deriv() å‡½æ•°"></a>deriv() å‡½æ•°</h4><p>æè¿°: <code>deriv(v range-vector)</code> å‡½æ•°ç”¨äºè¿”å›<code>GuaGue</code>å€¼çš„å˜åŒ–é€Ÿåº¦ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªåŒºé—´å‘é‡è¿”å›ä¸€ä¸ªç¬æ—¶å‘é‡ã€‚</p>
<p>Tips: å®ƒä½¿ç”¨ç®€å•çš„çº¿æ€§å›å½’è®¡ç®—åŒºé—´å‘é‡ v ä¸­å„ä¸ªæ—¶é—´åºåˆ—çš„å¯¼æ•°, ä½¿ç”¨æœ€å°äºŒä¹˜æ³•å›å½’æ¥ä¼°è®¡èŒƒå›´å‘é‡ä¸­çš„æ¯ä¸ªæ—¶é—´åºåˆ—çš„æ–œç‡ã€‚</p>
<p>Tips: è¿™ä¸ªå‡½æ•°ä¸€èˆ¬åªç”¨åœ¨ Gauge ç±»å‹çš„æ—¶é—´åºåˆ—ä¸Šã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.æ ¹æ®è¿‡å»ä¸€å°æ—¶çš„æ ·æœ¬è®¡ç®—æ¯ç§’é©»ç•™å†…å­˜çš„å˜åŒ–é€Ÿåº¦ã€‚</span></span><br><span class="line">deriv(process_resident_memory_bytes[1h])  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125; 1195.152658509455</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="predict-linear-å‡½æ•°"><a href="#predict-linear-å‡½æ•°" class="headerlink" title="predict_linear() å‡½æ•°"></a>predict_linear() å‡½æ•°</h4><p>æè¿°: <code>predict_linear(v range-vector, t scalar)</code> å‡½æ•°å¯ä»¥é¢„æµ‹æ—¶é—´åºåˆ— v åœ¨ t ç§’åçš„å€¼ã€‚æ ¹æ®æ‰€æä¾›èŒƒå›´å†…çš„æ•°æ®é¢„æµ‹æœªæ¥Gaugeçš„å€¼ã€‚</p>
<p>Tips: å®ƒåŸºäºç®€å•çº¿æ€§å›å½’çš„æ–¹å¼ï¼Œå¯¹æ—¶é—´çª—å£å†…çš„æ ·æœ¬æ•°æ®è¿›è¡Œç»Ÿè®¡ï¼Œä»è€Œå¯ä»¥å¯¹æ—¶é—´åºåˆ—çš„å˜åŒ–è¶‹åŠ¿åšå‡ºé¢„æµ‹ã€‚è¯¥å‡½æ•°çš„è¿”å›ç»“æœä¸å¸¦æœ‰åº¦é‡æŒ‡æ ‡ï¼Œåªæœ‰æ ‡ç­¾åˆ—è¡¨ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒåŸºäº 2 å°æ—¶çš„æ ·æœ¬æ•°æ®ï¼Œæ¥é¢„æµ‹ä¸»æœºå¯ç”¨ç£ç›˜ç©ºé—´çš„æ˜¯å¦åœ¨ 4 ä¸ªå°æ—¶å€™è¢«å æ»¡ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¡¨è¾¾å¼ï¼š<code>predict_linear(node_filesystem_free{job=&quot;node&quot;}[2h], 4 * 3600) &lt; 0</code> é€šè¿‡ä¸‹é¢çš„ä¾‹å­æ¥è§‚å¯Ÿè¿”å›å€¼ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(prometheus_http_requests_total&#123;code=<span class="string">"200"</span>,instance=<span class="string">"120.77.65.193:9090"</span>,job=<span class="string">"prometheus"</span>,method=<span class="string">"get"</span>&#125;[5m], 5)</span><br><span class="line">  <span class="comment"># ç»“æœï¼š</span></span><br><span class="line">  &#123;code=<span class="string">"200"</span>,handler=<span class="string">"query_range"</span>,instance=<span class="string">"120.77.65.193:9090"</span>,job=<span class="string">"prometheus"</span>,method=<span class="string">"get"</span>&#125;  1</span><br><span class="line">  &#123;code=<span class="string">"200"</span>,handler=<span class="string">"prometheus"</span>,instance=<span class="string">"120.77.65.193:9090"</span>,job=<span class="string">"prometheus"</span>,method=<span class="string">"get"</span>&#125;   4283.449995397104</span><br><span class="line">  &#123;code=<span class="string">"200"</span>,handler=<span class="string">"static"</span>,instance=<span class="string">"120.77.65.193:9090"</span>,job=<span class="string">"prometheus"</span>,method=<span class="string">"get"</span>&#125;   22.99999999999999</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure></p>
<p>ä¾‹å¦‚, é¢„æµ‹å››ä¸ªå°æ—¶å†…æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿå‰©ä½™çš„å¯ç”¨ç©ºé—´é‡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(node_filesystem_free_bytes&#123;instance=<span class="string">"192.168.1.107:9100"</span>&#125;[1h],4 * 3600)</span><br><span class="line">  <span class="comment"># &#123;device="/dev/mapper/ubuntu--vg-lv--0",fstype="ext4", instance="192.168.1.107:9100", job="linux_exporter", mountpoint="/"&#125;</span></span><br><span class="line">    81532763513.3</span><br><span class="line"><span class="comment"># ç­‰åŒäº</span></span><br><span class="line">deriv(node_filesystem_free_bytes&#123;instance=<span class="string">"192.168.1.107:9100"</span>&#125;[1h] * 4 * 3600) + node_filesystem_free_bytes&#123;instance=<span class="string">"192.168.1.107:9100"</span>&#125;[1h]</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå‡½æ•°ä¸€èˆ¬åªç”¨åœ¨ Gauge ç±»å‹çš„æ—¶é—´åºåˆ—ä¸Šã€‚</p>
<p><br></p>
<h4 id="delta-å‡½æ•°"><a href="#delta-å‡½æ•°" class="headerlink" title="delta() å‡½æ•°"></a>delta() å‡½æ•°</h4><p>æè¿°: <code>delta(v range-vector)</code>å€¼ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªåŒºé—´å‘é‡ï¼Œè¿”å›ä¸€ä¸ªç¬æ—¶å‘é‡ã€‚å®ƒè®¡ç®—ä¸€ä¸ªåŒºé—´å‘é‡ v çš„ç¬¬ä¸€ä¸ªå…ƒç´ å’Œæœ€åä¸€ä¸ªå…ƒç´ ä¹‹é—´çš„å·®å€¼ã€‚ç”±äºè¿™ä¸ªå€¼è¢«å¤–æ¨åˆ°æŒ‡å®šçš„æ•´ä¸ªæ—¶é—´èŒƒå›´ï¼Œæ‰€ä»¥å³ä½¿æ ·æœ¬å€¼éƒ½æ˜¯æ•´æ•°ï¼Œä½ ä»ç„¶å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªéæ•´æ•°å€¼ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­è¿”å›è¿‡å»ä¸¤å°æ—¶çš„ CPU æ¸©åº¦å·®ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">delta(node_hwmon_temp_celsius&#123;instance=<span class="string">"aiserver"</span>&#125;[1h])</span><br><span class="line">  <span class="comment"># &#123;chip="platform_coretemp_0", instance="aiserver", job="K8S-weiyigeek-Prod", sensor="temp1"&#125;</span></span><br><span class="line">  <span class="comment"># 	-2.0338977305373644</span></span><br><span class="line">  <span class="comment"># &#123;chip="platform_coretemp_0", instance="aiserver", job="K8S-weiyigeek-Prod", sensor="temp10"&#125;</span></span><br><span class="line">  <span class="comment"># 	-2.0338977305373644</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="idelta-å‡½æ•°"><a href="#idelta-å‡½æ•°" class="headerlink" title="idelta() å‡½æ•°"></a>idelta() å‡½æ•°</h4><p>æè¿°: <code>idelta(v range-vector)</code> çš„å‚æ•°æ˜¯ä¸€ä¸ªåŒºé—´å‘é‡, è¿”å›ä¸€ä¸ªç¬æ—¶å‘é‡ã€‚å®ƒè®¡ç®—æœ€æ–°çš„ 2 ä¸ªæ ·æœ¬å€¼ä¹‹é—´çš„å·®å€¼ã€‚<br>å³é‡‡ç”¨æ—¶é—´èŒƒå›´ä¸­çš„æœ€åä¸¤ä¸ªæ ·æœ¬å¹¶è¿”å›å®ƒä»¬çš„å·®å¼‚ã€‚</p>
<p><br></p>
<h4 id="holt-winters-å‡½æ•°"><a href="#holt-winters-å‡½æ•°" class="headerlink" title="holt_winters() å‡½æ•°"></a>holt_winters() å‡½æ•°</h4><p>æè¿°: <code>holt_winters(v range-vector, sf scalar, tf scalar) å‡½æ•°</code>åŸºäºåŒºé—´å‘é‡ vï¼Œç”Ÿæˆæ—¶é—´åºåˆ—æ•°æ®å¹³æ»‘å€¼ã€‚å¹³æ»‘å› å­ sf è¶Šä½, å¯¹æ—§æ•°æ®çš„é‡è§†ç¨‹åº¦è¶Šé«˜ã€‚è¶‹åŠ¿å› å­ tf è¶Šé«˜ï¼Œå¯¹æ•°æ®çš„è¶‹åŠ¿çš„è€ƒè™‘å°±è¶Šå¤šã€‚å…¶ä¸­<code>0&lt; sf, tf &lt;=1</code>å¹¶ä¸”å®ƒåªèƒ½ä¸ä»ªè¡¨ä¸€èµ·ä½¿ç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å¹³æ»‘å†…å­˜ä½¿ç”¨é‡ï¼Œå¹³æ»‘å› å­ä¸º0.1ï¼Œè¶‹åŠ¿å› å­ä¸º0.5,è¯¥ä¸¤ä¸ªå› æ•°å¿…é¡»ä»‹äºï¼ˆ0~1ï¼‰ä¹‹é—´ã€‚</span></span><br><span class="line">holt_winters(process_resident_memory_bytes[1h],0.1,0.5)</span><br><span class="line">  <span class="comment"># &#123;instance="localhost:9090", job="Server"&#125; 	167181065.43937477</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="9-lt-aggregation-gt-over-time-éšæ—¶é—´èšåˆå‡½æ•°"><a href="#9-lt-aggregation-gt-over-time-éšæ—¶é—´èšåˆå‡½æ•°" class="headerlink" title="9.&lt;aggregation&gt;_over_time() éšæ—¶é—´èšåˆå‡½æ•°"></a>9.<code>&lt;aggregation&gt;</code>_over_time() éšæ—¶é—´èšåˆå‡½æ•°</h3><p>æè¿°: ä¸‹é¢çš„å‡½æ•°åˆ—è¡¨å…è®¸ä¼ å…¥ä¸€ä¸ªåŒºé—´å‘é‡ï¼Œå®ƒä»¬ä¼šèšåˆæ¯ä¸ªæ—¶é—´åºåˆ—çš„èŒƒå›´ï¼Œå¹¶è¿”å›ä¸€ä¸ªç¬æ—¶å‘é‡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* avg_over_time(range-vector) : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„å¹³å‡å€¼ã€‚</span><br><span class="line">* min_over_time(range-vector) : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„æœ€å°å€¼ã€‚</span><br><span class="line">* max_over_time(range-vector) : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„æœ€å¤§å€¼ã€‚</span><br><span class="line">* sum_over_time(range-vector) : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„æ±‚å’Œã€‚</span><br><span class="line">* stddev_over_time(range-vector) : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„æ€»ä½“æ ‡å‡†å·®ã€‚</span><br><span class="line">* stdvar_over_time(range-vector) : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„æ€»ä½“æ ‡å‡†æ–¹å·®ã€‚</span><br><span class="line">* count_over_time(range-vector)  : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„æ ·æœ¬æ•°æ®ä¸ªæ•°ã€‚</span><br><span class="line">* quantile_over_time(scalar, range-vector) : åŒºé—´å‘é‡å†…æ¯ä¸ªåº¦é‡æŒ‡æ ‡çš„æ ·æœ¬æ•°æ®å€¼åˆ†ä½æ•°ï¼ŒÏ†-quantile (0 â‰¤ Ï† â‰¤ 1)ï¼Œè¯¥å‡½æ•°é€‚ç”¨äºåœ¨èŒƒå›´å‘é‡ä¸­è·¨å•ä¸ªæ—¶åºæ•°æ®æŸ¥è¯¢ã€‚</span><br></pre></td></tr></table></figure></p>
<p>Tips : è¯·æ³¨æ„ï¼ŒæŒ‡å®šé—´éš”ä¸­çš„æ‰€æœ‰å€¼åœ¨èšåˆä¸­éƒ½å…·æœ‰ç›¸åŒçš„æƒé‡ï¼Œå³ä½¿è¿™äº›å€¼åœ¨æ•´ä¸ªé—´éš”ä¸­çš„é—´éš”ä¸ç­‰ã€‚</p>
<p><br></p>
<h4 id="absent-over-time-å‡½æ•°"><a href="#absent-over-time-å‡½æ•°" class="headerlink" title="absent_over_time() å‡½æ•°"></a>absent_over_time() å‡½æ•°</h4><p>æè¿°: <code>absent_over_time(v range-vector)</code> å¦‚æœä¼ é€’ç»™å®ƒçš„èŒƒå›´å‘é‡æœ‰ä»»ä½•å…ƒç´ åˆ™è¿”å›ä¸€ä¸ªç©ºå‘é‡ï¼Œå¦‚æœä¼ é€’ç»™å®ƒçš„èŒƒå›´å‘é‡æ²¡æœ‰å…ƒç´ ï¼Œåˆ™è¿”å›ä¸€ä¸ªå€¼ä¸º 1 çš„ 1 å…ƒç´ å‘é‡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">absent_over_time(nonexistent&#123;job=<span class="string">"myjob"</span>&#125;[1h])</span><br><span class="line"><span class="comment"># =&gt; &#123;job="myjob"&#125;</span></span><br><span class="line"></span><br><span class="line">absent_over_time(nonexistent&#123;job=<span class="string">"myjob"</span>,instance=~<span class="string">".*"</span>&#125;[1h])</span><br><span class="line"><span class="comment"># =&gt; &#123;job="myjob"&#125;</span></span><br><span class="line"></span><br><span class="line">absent_over_time(sum(nonexistent&#123;job=<span class="string">"myjob"</span>&#125;)[1h:])</span><br><span class="line"><span class="comment"># =&gt; &#123;&#125;</span></span><br></pre></td></tr></table></figure><br>Tips : åœ¨ç»™å®šçš„æŒ‡æ ‡åç§°å’Œæ ‡ç­¾ç»„åˆåœ¨ä¸€å®šæ—¶é—´å†…ä¸å­˜åœ¨æ—¶é—´åºåˆ—æ—¶å‘å‡ºè­¦æŠ¥éå¸¸æœ‰ç”¨ã€‚</p>
<p><br></p>
<h4 id="ç¤ºä¾‹æ¼”ç¤º"><a href="#ç¤ºä¾‹æ¼”ç¤º" class="headerlink" title="ç¤ºä¾‹æ¼”ç¤º"></a>ç¤ºä¾‹æ¼”ç¤º</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.æŸ¥çœ‹ä¸€ä¸ªè¿›ç¨‹å†…å­˜å³°å€¼ä½¿ç”¨é‡</span></span><br><span class="line">max_over_time(process_resident_memory_bytes[1h]) <span class="comment"># &#123;instance="localhost:9090", job="prom-Server"&#125; 	219848704</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æ›´è¿‘ä¸€æ­¥è®¡ç®—æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚</span></span><br><span class="line">max without(instance)(max_over_time(process_resident_memory_bytes[1h]))</span><br></pre></td></tr></table></figure>
<p>Tips: ä¸è¦åœ¨rateä¸Šä½¿ç”¨<code>avg_over_time</code>,å› ä¸ºè¯¥å‡½æ•°è¿”å›çš„æ˜¯ç¬æ—¶è€Œä¸æ˜¯èŒƒå›´å‘é‡ã€‚</p>
<hr>
<h2 id="0x03-å®é™…æ¡ˆä¾‹"><a href="#0x03-å®é™…æ¡ˆä¾‹" class="headerlink" title="0x03 å®é™…æ¡ˆä¾‹"></a>0x03 å®é™…æ¡ˆä¾‹</h2><p>æè¿°: å®é™…æ¡ˆä¾‹å°†ä¼šæŒç»­æ›´æ–°ã€‚<br><strong>åŸºç¡€ç¤ºä¾‹:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çš„å¤šä¸ªæŒ‚è½½ç‚¹çš„æ–‡ä»¶ç³»ç»Ÿç©ºé—´å¤§å°</span></span><br><span class="line">node_filesystem_size_bytes</span><br><span class="line">  <span class="comment"># node_filesystem_size_bytes&#123;device="/dev/mapper/ubuntu--vg-lv--0", fstype="ext4", instance="192.168.1.107:9100", job="linux_exporter", mountpoint="/"&#125;  104091082752</span></span><br><span class="line">  <span class="comment"># node_filesystem_size_bytes&#123;device="/dev/sda4", fstype="ext4", instance="192.168.1.223:9100", job="linux_exporter", mountpoint="/"&#125; 284151599104</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æŒ‡å®šlabelçš„nameæŸ¥è¯¢</span></span><br><span class="line">prometheus_prometheus_http_requests_total&#123;code=<span class="string">"200"</span>&#125;</span><br><span class="line">prometheus_prometheus_http_requests_total&#123;code=<span class="string">"200"</span>,job=<span class="string">"prometheus"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æŸ¥è¯¢æŒ‡å®šæ ‡ç­¾çš„èŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿç©ºé—´å¤§å°</span></span><br><span class="line">node_filesystem_size_bytes &#123;env=<span class="string">"prod"</span>, fstype=<span class="string">"ext4"</span>, instance=<span class="string">"192.168.1.107:9100"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.é‡‡ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…</span></span><br><span class="line"><span class="comment"># - prometheus è¯·æ±‚å“åº”ç åœ¨2.xå’Œ3.xä»¥åŠè®¿é—®è·¯å¾„ä¸ä¸º/alert.*åŒ¹é…åˆ°çš„ã€‚</span></span><br><span class="line">prometheus_prometheus_http_requests_total&#123;code =~ <span class="string">"2.*|3.*"</span>,handler !~ <span class="string">"/alert.*"</span>&#125;</span><br><span class="line">  <span class="comment"># prometheus_prometheus_http_requests_total&#123;code="200", handler="/api/v1/label/:name/values", instance="localhost:9090", job="Server"&#125; 40</span></span><br><span class="line">  <span class="comment"># prometheus_prometheus_http_requests_total&#123;code="200", handler="/api/v1/labels", instance="localhost:9090", job="Server"&#125; 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.é€šè¿‡`[time]`æ¥å®ç°æ—¶é—´èŒƒå›´</span></span><br><span class="line">prometheus_prometheus_http_requests_total&#123;code =~ <span class="string">"2.*|3.*"</span>,handler=~ <span class="string">"/alert.*"</span> ,job=<span class="string">"prometheus"</span>&#125;[5m]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.äº”åˆ†é’Ÿçš„cpuå¹³å‡ä½¿ç”¨ç‡</span></span><br><span class="line">100 - (avg(irate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[5m])) * 100)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.å¯ç”¨çš„å†…å­˜ç™¾åˆ†æ¯”</span></span><br><span class="line">(node_memory_MemAvailable_bytes / (node_memory_MemTotal_bytes))* 100 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.ç£ç›˜ä¸€åˆ†é’Ÿè¯»çš„é€Ÿç‡</span></span><br><span class="line">irate(node_disk_reads_completed_total&#123;&#125;[1m])  </span><br><span class="line">rate(prometheus_tsdb_head_samples_appended_total[5m]) <span class="comment"># - è®¡ç®—å‡º Prometheus ä¸€åˆ†é’Ÿå†…æ¯ç§’çš„å¹³å‡é‡‡é›†æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.ç½‘ç»œäº”åˆ†é’Ÿçš„æ¥æ”¶é€Ÿç‡ï¼ˆç½‘ç»œæµé‡ï¼‰</span></span><br><span class="line">irate(node_network_receive_bytes_total&#123;device!~<span class="string">'tap.*|veth.*|br.*|docker.*|virbr*|lo*'</span>&#125;[5m])* 8</span><br><span class="line">  <span class="comment"># &#123;cluster="weiyigeek-lb-vip.k8s", device="cali05e09d75aa7", instance="192.168.1.225:9100", job="linux_exporter"&#125; 5476.866666666667</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="promtheus"><a href="#promtheus" class="headerlink" title="promtheus"></a>promtheus</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç›‘æ§å®ä¾‹æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">avg without()(up) &lt; 1</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CPU æŒ‡æ ‡ # </span></span><br><span class="line"><span class="comment"># CPU æ ¸å¿ƒæ•°ç»Ÿè®¡</span></span><br><span class="line">count without(cpu)(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;)</span><br><span class="line"><span class="comment"># CPU ä½¿ç”¨ç‡å¤§äº90%</span></span><br><span class="line">(node_load5 /ignoring(mode)  count without(cpu)(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;) * 100) &gt; 90</span><br><span class="line">round(100 - ((avg by (instance,job,env)(irate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[5m]))) * 100)) &gt; 90</span><br><span class="line"><span class="comment"># ç³»ç»Ÿæ¯ä¸ªCPUæ¨¡å¼çš„å¹³å‡æ¶ˆè€—</span></span><br><span class="line">avg without(cpu)(rate(node_cpu_seconds_total[5m]))</span><br><span class="line"><span class="comment"># æ‰€æœ‰CPUçš„ç©ºé—²æ¨¡å¼çš„æ—¶é—´æ¯”ä¾‹</span></span><br><span class="line">avg without(cpu, mode)(rate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[5m]))</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Windows-win-exporter"><a href="#Windows-win-exporter" class="headerlink" title="Windows (win_exporter)"></a>Windows (win_exporter)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows CPU æ ¸å¿ƒæ•°</span></span><br><span class="line">count without(core)(windows_cpu_time_total&#123;mode=<span class="string">"idle"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows CPU å¹³å‡ä½¿ç”¨ç‡å¤§äº90%</span></span><br><span class="line">round (100 - ((avg without(core,mode)(irate(windows_cpu_time_total&#123;mode=<span class="string">"idle"</span>&#125;[5m]))) * 100)) &gt; 90</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows Mem å¹³å‡ä½¿ç”¨ç‡å¤§äº90%</span></span><br><span class="line">round((1 - (windows_os_physical_memory_free_bytes / windows_cs_physical_memory_bytes)) * 100) &gt; 90</span><br></pre></td></tr></table></figure>
        </div>
        
        <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
        
        <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½çœ‹å‹,æ¬¢è¿å…³æ³¨åšä¸»å¾®ä¿¡å…¬ä¼—å·å“Ÿ! â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘å³å¯å…³é—­ç»§ç»­æµè§ˆæ–‡ç« .<br>  <b style="color:red;"> æ¸©é¦¨æç¤º: æœªè§£é”çš„ç”¨æˆ·ä¸èƒ½ç²˜è´´å¤åˆ¶æ–‡ç« å†…å®¹å“Ÿ!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
           

        <!-- Google å¹¿å‘Š -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2023-01-31T02:29:10.642Z" itemprop="dateUpdated">2023-01-31 10:29:10</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Prometheus/4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ .md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Prometheus/4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ .md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2021/4-25-554.html" target="_blank" rel="external">https://blog.weiyigeek.top/2021/4-25-554.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Prometheus/" rel="tag">Prometheus</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/4-25-554.html&title=ã€Š4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/4-25-554.html&title=ã€Š4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/4-25-554.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/4-25-554.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/4-25-554.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/4-25-551.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">2.Prometheusç›‘æ§å…¥é—¨ä¹‹ç›‘æ§é…ç½®è¯´æ˜</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/4-22-550.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">1.Prometheusç›‘æ§å…¥é—¨ä¹‹ä»‹ç»æ•´ä½“æ¶æ„åŠå®‰è£…</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-PromQL-ä»‹ç»"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 PromQL ä»‹ç»</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-åŸºç¡€ç®€è¿°"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.åŸºç¡€ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-åŸºç¡€æ ‡å‡†"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.åŸºç¡€æ ‡å‡†</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-æ•°æ®ç±»å‹"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.æ•°æ®ç±»å‹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ç¬æ—¶æ•°æ®-Instant-vector"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">ç¬æ—¶æ•°æ® (Instant vector)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#åŒºé—´æ•°æ®-Range-vector"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">åŒºé—´æ•°æ® (Range vector)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#çº¯é‡æ•°æ®-Scalar"><span class="post-toc-number">1.3.3.</span> <span class="post-toc-text">çº¯é‡æ•°æ® (Scalar)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å­—ç¬¦ä¸²æ•°æ®-String"><span class="post-toc-number">1.3.4.</span> <span class="post-toc-text">å­—ç¬¦ä¸²æ•°æ® (String)</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-é€‰æ‹©å™¨-Selector"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">4.é€‰æ‹©å™¨ - (Selector)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-åŒ¹é…å™¨-Matcher"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">5.åŒ¹é…å™¨ - (Matcher)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-åç§»ä¿®æ”¹å™¨-Offset"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">6.åç§»ä¿®æ”¹å™¨ - (Offset)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-ä¿®é¥°ç¬¦"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">7.ä¿®é¥°ç¬¦ - @</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#8-å­æŸ¥è¯¢"><span class="post-toc-number">1.8.</span> <span class="post-toc-text">8.å­æŸ¥è¯¢</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#9-æŸ¥è¯¢ç±»å‹"><span class="post-toc-number">1.9.</span> <span class="post-toc-text">9.æŸ¥è¯¢ç±»å‹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Counter-ç±»å‹"><span class="post-toc-number">1.9.1.</span> <span class="post-toc-text">Counter ç±»å‹</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Gauge-ç±»å‹"><span class="post-toc-number">1.9.2.</span> <span class="post-toc-text">Gauge ç±»å‹</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Summary-ç±»å‹"><span class="post-toc-number">1.9.3.</span> <span class="post-toc-text">Summary ç±»å‹</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Histogram-ç±»å‹"><span class="post-toc-number">1.9.4.</span> <span class="post-toc-text">Histogram ç±»å‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#10-APIæŸ¥è¯¢æŒ‡æ ‡æ•°æ®"><span class="post-toc-number">1.10.</span> <span class="post-toc-text">10.APIæŸ¥è¯¢æŒ‡æ ‡æ•°æ®</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Query"><span class="post-toc-number">1.10.1.</span> <span class="post-toc-text">Query</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Query-range"><span class="post-toc-number">1.10.2.</span> <span class="post-toc-text">Query_range</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-è¡¨è¾¾å¼è¯­è¨€è¿ç®—ç¬¦"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 è¡¨è¾¾å¼è¯­è¨€è¿ç®—ç¬¦</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-äºŒå…ƒè¿ç®—ç¬¦"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.äºŒå…ƒè¿ç®—ç¬¦</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-ä¿®é¥°è¿ç®—ç¬¦"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.ä¿®é¥°è¿ç®—ç¬¦</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ignoring-ä¿®é¥°ç¬¦"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">ignoring ä¿®é¥°ç¬¦</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#on-ä¿®é¥°ç¬¦"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">on ä¿®é¥°ç¬¦</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#group-left-ä¿®é¥°ç¬¦"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">group_left ä¿®é¥°ç¬¦</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#group-right-ä¿®é¥°ç¬¦"><span class="post-toc-number">2.2.4.</span> <span class="post-toc-text">group_right ä¿®é¥°ç¬¦</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-èšåˆè¿ç®—ç¬¦"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3.èšåˆè¿ç®—ç¬¦</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#åˆ†ç»„"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text">åˆ†ç»„</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#èšåˆ"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text">èšåˆ</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-è¿ç®—ç¬¦ä¼˜å…ˆçº§"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">4.è¿ç®—ç¬¦ä¼˜å…ˆçº§</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-PromQL-å†…ç½®å‡½æ•°ä»‹ç»"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 PromQL å†…ç½®å‡½æ•°ä»‹ç»</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-èšåˆå‡½æ•°"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.èšåˆå‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#sum-å‡½æ•°"><span class="post-toc-number">3.1.1.</span> <span class="post-toc-text">sum å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#avg-å‡½æ•°"><span class="post-toc-number">3.1.2.</span> <span class="post-toc-text">avg() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#count-å‡½æ•°"><span class="post-toc-number">3.1.3.</span> <span class="post-toc-text">count() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#count-values-å‡½æ•°"><span class="post-toc-number">3.1.4.</span> <span class="post-toc-text">count_values() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#min-å‡½æ•°"><span class="post-toc-number">3.1.5.</span> <span class="post-toc-text">min() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#max-å‡½æ•°"><span class="post-toc-number">3.1.6.</span> <span class="post-toc-text">max() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#stddev-å‡½æ•°"><span class="post-toc-number">3.1.7.</span> <span class="post-toc-text">stddev() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#stdvar-å‡½æ•°"><span class="post-toc-number">3.1.8.</span> <span class="post-toc-text">stdvar() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#topk-å‡½æ•°"><span class="post-toc-number">3.1.9.</span> <span class="post-toc-text">topk() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#bottomk-å‡½æ•°"><span class="post-toc-number">3.1.10.</span> <span class="post-toc-text">bottomk() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#quantile-å‡½æ•°"><span class="post-toc-number">3.1.11.</span> <span class="post-toc-text">quantile() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-ç±»å‹å‡½æ•°"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.ç±»å‹å‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#vector-å‡½æ•°"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">vector() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#scalar-å‡½æ•°"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">scalar() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-æ•°å­¦å‡½æ•°"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.æ•°å­¦å‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#abs-å‡½æ•°"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">abs() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ln-å‡½æ•°"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">ln() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#log2-å‡½æ•°"><span class="post-toc-number">3.3.3.</span> <span class="post-toc-text">log2() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#log10-å‡½æ•°"><span class="post-toc-number">3.3.4.</span> <span class="post-toc-text">log10() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#exp-å‡½æ•°"><span class="post-toc-number">3.3.5.</span> <span class="post-toc-text">exp() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#sqrt-å‡½æ•°"><span class="post-toc-number">3.3.6.</span> <span class="post-toc-text">sqrt() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ceil-å‡½æ•°"><span class="post-toc-number">3.3.7.</span> <span class="post-toc-text">ceil() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#floor-å‡½æ•°"><span class="post-toc-number">3.3.8.</span> <span class="post-toc-text">floor() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#round-å‡½æ•°"><span class="post-toc-number">3.3.9.</span> <span class="post-toc-text">round() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#clamp-å‡½æ•°"><span class="post-toc-number">3.3.10.</span> <span class="post-toc-text">clamp() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#clamp-max-å‡½æ•°"><span class="post-toc-number">3.3.11.</span> <span class="post-toc-text">clamp_max() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#clamp-min-å‡½æ•°"><span class="post-toc-number">3.3.12.</span> <span class="post-toc-text">clamp_min() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-æ—¶é—´å‡½æ•°"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.æ—¶é—´å‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#time-å‡½æ•°"><span class="post-toc-number">3.4.1.</span> <span class="post-toc-text">time() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#minute-å‡½æ•°"><span class="post-toc-number">3.4.2.</span> <span class="post-toc-text">minute() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#hour-å‡½æ•°"><span class="post-toc-number">3.4.3.</span> <span class="post-toc-text">hour()  å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#month-å‡½æ•°"><span class="post-toc-number">3.4.4.</span> <span class="post-toc-text">month() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#year-å‡½æ•°"><span class="post-toc-number">3.4.5.</span> <span class="post-toc-text">year() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#day-of-month-å‡½æ•°"><span class="post-toc-number">3.4.6.</span> <span class="post-toc-text">day_of_month() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#day-of-week-å‡½æ•°"><span class="post-toc-number">3.4.7.</span> <span class="post-toc-text">day_of_week() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#days-in-month-å‡½æ•°"><span class="post-toc-number">3.4.8.</span> <span class="post-toc-text">days_in_month() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#timestamp-å‡½æ•°"><span class="post-toc-number">3.4.9.</span> <span class="post-toc-text">timestamp() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-æ ‡ç­¾å‡½æ•°"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">5.æ ‡ç­¾å‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#label-join-å‡½æ•°"><span class="post-toc-number">3.5.1.</span> <span class="post-toc-text">label_join() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#label-replace-å‡½æ•°"><span class="post-toc-number">3.5.2.</span> <span class="post-toc-text">label_replace() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-ç¼ºå¤±ä¸æ’åºå‡½æ•°"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">6.ç¼ºå¤±ä¸æ’åºå‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#absent-å‡½æ•°"><span class="post-toc-number">3.6.1.</span> <span class="post-toc-text">absent() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#histogram-quantile-å‡½æ•°"><span class="post-toc-number">3.6.2.</span> <span class="post-toc-text">histogram_quantile() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#sort-å‡½æ•°"><span class="post-toc-number">3.6.3.</span> <span class="post-toc-text">sort() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#sort-desc-å‡½æ•°"><span class="post-toc-number">3.6.4.</span> <span class="post-toc-text">sort_desc() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-è®¡æ•°å™¨"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">7.è®¡æ•°å™¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#rate-å‡½æ•°"><span class="post-toc-number">3.7.1.</span> <span class="post-toc-text">rate å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#increase-å‡½æ•°"><span class="post-toc-number">3.7.2.</span> <span class="post-toc-text">increase() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#irate-å‡½æ•°"><span class="post-toc-number">3.7.3.</span> <span class="post-toc-text">irate() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#resets-å‡½æ•°"><span class="post-toc-number">3.7.4.</span> <span class="post-toc-text">resets() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#8-Gaugeç±»å‹å¤„ç†å‡½æ•°"><span class="post-toc-number">3.8.</span> <span class="post-toc-text">8.Gaugeç±»å‹å¤„ç†å‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#changes-å‡½æ•°"><span class="post-toc-number">3.8.1.</span> <span class="post-toc-text">changes() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#deriv-å‡½æ•°"><span class="post-toc-number">3.8.2.</span> <span class="post-toc-text">deriv() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#predict-linear-å‡½æ•°"><span class="post-toc-number">3.8.3.</span> <span class="post-toc-text">predict_linear() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#delta-å‡½æ•°"><span class="post-toc-number">3.8.4.</span> <span class="post-toc-text">delta() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#idelta-å‡½æ•°"><span class="post-toc-number">3.8.5.</span> <span class="post-toc-text">idelta() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#holt-winters-å‡½æ•°"><span class="post-toc-number">3.8.6.</span> <span class="post-toc-text">holt_winters() å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#9-lt-aggregation-gt-over-time-éšæ—¶é—´èšåˆå‡½æ•°"><span class="post-toc-number">3.9.</span> <span class="post-toc-text">9.&lt;aggregation&gt;_over_time() éšæ—¶é—´èšåˆå‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#absent-over-time-å‡½æ•°"><span class="post-toc-number">3.9.1.</span> <span class="post-toc-text">absent_over_time() å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ç¤ºä¾‹æ¼”ç¤º"><span class="post-toc-number">3.9.2.</span> <span class="post-toc-text">ç¤ºä¾‹æ¼”ç¤º</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-å®é™…æ¡ˆä¾‹"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 å®é™…æ¡ˆä¾‹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#promtheus"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">promtheus</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#node-exporter"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">node_exporter</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Windows-win-exporter"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Windows (win_exporter)</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
    <!-- 
  <div class="post-wechat" style="position:fixed;top: 360px;bottom: 500px;right: 3%;width: 190px;text-align: center;">
    <p><b>å…³æ³¨ã€å…¨æ ˆå·¥ç¨‹å¸ˆä¿®ç‚¼æŒ‡å—ã€‘</b></p>
    <img src="/img/wechat-gzh.jpg" class="img-responsive" alt="weiyigeek">
    <p><b>æ¬¢è¿æ·»åŠ ã€ä½œè€…ã€‘å¾®ä¿¡</b></p>
    <img src="/img/wehat.jpg" class="img-responsive" alt="weiyigeek">
  </div>
 -->

    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="/img/share-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2023 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/4-25-554.html&title=ã€Š4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/4-25-554.html&title=ã€Š4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/4-25-554.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š4.Prometheusç›‘æ§å…¥é—¨ä¹‹PromQLè¡¨è¾¾å¼è¯­æ³•å­¦ä¹ ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/4-25-554.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/4-25-554.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMUlEQVR42u3ay07EMAwFUP7/p8sWaWjm2umAkpyuUBGtTxfGj3x9xdf140p+e71cd3+Vv+WBCwMDY1nGNbyqYd391V3or/fH772NAQMD4wBG/ujxJ0g+0PgtVTYGBgZGlZGENX4yBgYGxjwjCS5vg/8t4WJgYCzISFJnrxycGc99pBfHwMBYkJFP3f/+54/sNzAwMJZiXMWr+pxe4ViOCgMDY2tGnuB6xdzM0Y3y4Q8MDIwjGUmb2gs0H8DldzAwME5g5GOyaqDJ0L+67LxNuBgYGAcwZlaP+dqgGWhSGmJgYGzHyFvTckvZWmr2PgQGBsbejOpYP78/bj6ry8towYmBgbEpIxpjFQOqlpi9kd8v/zcwMDC2ZuQHGvLlYpWa3L99DgYGxtaMXi2Zrx6rBeh8CsbAwDiBUS3+xm3tU2vRQtAYGBibMpJXznyhfACXp+DmmREMDIwFGb1iLl8kVIu53gIVAwPjBMZTw/3qQjQvLt98egwMjK0Z1VF+HsRM8Vc9ooGBgXEOI0lzvfKuim+uVDEwMA5gJCl4pq3tjeQKa04MDIxjGPMlYLVZ7S1WC00sBgbG4oxeAn0q0Hzo9ib5YmBgbM2YOSKW5PI8BffKxDIGAwNjWcazA7LkMFmeyvOUjYGBcQKjl/jytFsIqHd0DAMDA2OiHa0uOJvFKAYGBkawBuil3fkSEwMD4xxG0sT2VgUz6fUj4zYMDIwFGVMnNVqrhWrZN3PgDAMDY3HGN0RH+ggq7lOXAAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  





<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// ç«™ç‚¹è¿è¡Œæ—¶é—´
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "å¤©" + RunHours + "æ—¶" + RunMinutes + "åˆ†" + RunSeconds + "ç§’";
  document.getElementById(id).innerHTML = "ç½‘ç«™å·²åœ¨é£é›¨ä¸­å‹‰å‹‰å¼ºå¼ºè¿è¡Œäº†ã€" + RunTime + "ã€‘";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
    
  <div class="post-wechat" style="position:fixed;top: 360px;bottom: 500px;right: 3%;width: 190px;text-align: center;">
    <p><b>å…³æ³¨ã€å…¨æ ˆå·¥ç¨‹å¸ˆä¿®ç‚¼æŒ‡å—ã€‘</b></p>
    <img src="/img/wechat-gzh.jpg" class="img-responsive" alt="weiyigeek">
    <p><b>æ¬¢è¿æ·»åŠ ã€ä½œè€…ã€‘å¾®ä¿¡</b></p>
    <img src="/img/wehat.jpg" class="img-responsive" alt="weiyigeek">
  </div>

</body>
</html>