{"title":"2.Prometheus监控入门之监控配置说明","slug":"虚拟云容/云容器/Kubernetes/功能组件/Prometheus/2.Prometheus监控入门之监控配置说明及其实例","date":"2021-04-25T09:37:47.000Z","updated":"2023-01-31T02:29:10.642Z","url":"2021/4-25-551.html","path":"api/articles/2021/4-25-551.html.json","covers":["https://img.weiyigeek.top/2021/5/20210507165748.png","https://img.weiyigeek.top/2021/5/20210520100107.png","https://img.weiyigeek.top/2021/5/20210510123823.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<hr>\n<h2 id=\"0x00-组件介绍\"><a href=\"#0x00-组件介绍\" class=\"headerlink\" title=\"0x00 组件介绍\"></a>0x00 组件介绍</h2><h3 id=\"Prometheus\"><a href=\"#Prometheus\" class=\"headerlink\" title=\"Prometheus\"></a>Prometheus</h3><p>描述: 如果我们采用<code>prometheus</code>提供的二进制可执行文件进行搭建prometheus服务器,可以按照以下流程进行操作运行，二进制Release下载地址: <a href=\"https://github.com/prometheus/prometheus/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/prometheus/releases</a></p>\n<p><strong>简单流程:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 下载二进制可执行文件</span></span><br><span class=\"line\">wget https://github.com/prometheus/prometheus/releases/download/v2.26.0/prometheus-2.26.0.linux-amd64.tar.gz</span><br><span class=\"line\">tar -zxvf prometheus-2.26.0.linux-amd64.tar.gz  -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/prometheus-2.26.0.linux-amd64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 后台启动并修改开放端口</span></span><br><span class=\"line\">nohup ./prometheus --config.file=prometheus.yml --web.enable-lifecycle  --web.listen-address=:30090 &amp; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 查看启动状态</span></span><br><span class=\"line\">ps -ef | grep prometheus </span><br><span class=\"line\">lsof -i:19908</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 查看启动的命令行参数</span></span><br><span class=\"line\">./prometheus -h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 强行关闭 Prometheus</span></span><br><span class=\"line\">lsof -i:19908</span><br><span class=\"line\"><span class=\"built_in\">kill</span> -9 pid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (6) 补充系统服务进行启动Prometheus</span></span><br><span class=\"line\">sudo tee /usr/lib/systemd/system/prometheus.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Prometheus Server Systemd</span><br><span class=\"line\">Documentation=https://prometheus.io</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/prometheus/prometheus --config.file=/usr/<span class=\"built_in\">local</span>/prometheus/prometheus.yml  --web.listen-address=:9090 --storage.tsdb.path=/app/prometheus_data --storage.tsdb.retention.time=7d --web.enable-lifecycle --web.enable-admin-api\t</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl daemon-reload &amp;&amp; systemctl restart prometheus.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (7) 自动发现日志文件配置</span></span><br><span class=\"line\">mkdir /etc/prometheus/ &amp;&amp; touch /etc/prometheus/WeiyiGeek_linux_nodes.yml</span><br></pre></td></tr></table></figure></p>\n<p><strong>启动参数:</strong> 运行后我们可以访问<code>http://192.168.12.107:30090/classic/flags</code>查看到自定义或者默认的启动参数。</p>\n<table>\n<thead>\n<tr>\n<th>Command-Line Flags - 参数名称</th>\n<th>参数值</th>\n<th style=\"text-align:left\">参数说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>alertmanager.notification-queue-capacity</td>\n<td>10000</td>\n</tr>\n<tr>\n<td>alertmanager.timeout</td>\n<td></td>\n</tr>\n<tr>\n<td>config.file</td>\n<td>/etc/prometheus/prometheus.yml</td>\n<td style=\"text-align:left\">指定 prometheus.yml配置文件</td>\n</tr>\n<tr>\n<td>enable-feature</td>\n<td></td>\n</tr>\n<tr>\n<td>log.format</td>\n<td>logfmt</td>\n<td style=\"text-align:left\">设置打印日志的格式，若有自动化日志提取工具可以使用这个参数规范日志打印的格式<code>logger:stderr</code></td>\n</tr>\n<tr>\n<td>log.level</td>\n<td>info</td>\n</tr>\n<tr>\n<td>query.lookback-delta</td>\n<td>5m</td>\n</tr>\n<tr>\n<td>query.max-concurrency</td>\n<td>20</td>\n</tr>\n<tr>\n<td>query.max-samples</td>\n<td>50000000</td>\n</tr>\n<tr>\n<td>query.timeout</td>\n<td>2m</td>\n</tr>\n<tr>\n<td>rules.alert.for-grace-period</td>\n<td>10m</td>\n</tr>\n<tr>\n<td>rules.alert.for-outage-tolerance</td>\n<td>1h</td>\n</tr>\n<tr>\n<td>rules.alert.resend-delay</td>\n<td>1m</td>\n</tr>\n<tr>\n<td>scrape.adjust-timestamps</td>\n<td>true</td>\n</tr>\n<tr>\n<td>storage.exemplars.exemplars-limit</td>\n<td>0</td>\n</tr>\n<tr>\n<td>storage.remote.flush-deadline</td>\n<td>1m</td>\n</tr>\n<tr>\n<td>storage.remote.read-concurrent-limit</td>\n<td>10</td>\n</tr>\n<tr>\n<td>storage.remote.read-max-bytes-in-frame</td>\n<td>1048576</td>\n</tr>\n<tr>\n<td>storage.remote.read-sample-limit</td>\n<td>50000000</td>\n</tr>\n<tr>\n<td>storage.tsdb.allow-overlapping-blocks</td>\n<td>false</td>\n</tr>\n<tr>\n<td>storage.tsdb.max-block-duration</td>\n<td>1d12h</td>\n</tr>\n<tr>\n<td>storage.tsdb.min-block-duration</td>\n<td>2h</td>\n</tr>\n<tr>\n<td>storage.tsdb.no-lockfile</td>\n<td>false</td>\n<td style=\"text-align:left\">如果用k8s的deployment 管理要设置为tue</td>\n</tr>\n<tr>\n<td>storage.tsdb.path</td>\n<td>data/</td>\n<td style=\"text-align:left\">指定tsdb数据存储路径(容器中默认是/prometheus/data)</td>\n</tr>\n<tr>\n<td>storage.tsdb.retention</td>\n<td>0s</td>\n</tr>\n<tr>\n<td>storage.tsdb.retention.size</td>\n<td>0B</td>\n<td style=\"text-align:left\"><code>[EXPERIMENTAL]</code>要保留的最大存储块字节数,最旧的数据将首先被删除默认为0或禁用。</td>\n</tr>\n<tr>\n<td>storage.tsdb.retention.time</td>\n<td>0s</td>\n<td style=\"text-align:left\">指定数据存储时间即何时删除旧数据(推荐7d)</td>\n</tr>\n<tr>\n<td>storage.tsdb.wal-compression</td>\n<td>true</td>\n<td style=\"text-align:left\">启用压缩预写日志（WAL）,根据您的数据您可以预期WAL大小将减少一半而额外的CPU负载却很少</td>\n</tr>\n<tr>\n<td>storage.tsdb.wal-segment-size</td>\n<td>0B</td>\n</tr>\n<tr>\n<td>web.config.file</td>\n<td></td>\n</tr>\n<tr>\n<td>web.console.libraries</td>\n<td>console_libraries</td>\n</tr>\n<tr>\n<td>web.console.templates</td>\n<td>consoles</td>\n</tr>\n<tr>\n<td>web.cors.origin</td>\n<td>.*</td>\n</tr>\n<tr>\n<td>web.enable-admin-api</td>\n<td>false</td>\n<td style=\"text-align:left\">是否启用 admin api 的访问权限(TSDB管理API)</td>\n</tr>\n<tr>\n<td>web.enable-lifecycle</td>\n<td>true</td>\n<td style=\"text-align:left\">是否启用 API，启用API后，可以通过 API指令完成 Prometheus 的 停止、热加载配置文件 等</td>\n</tr>\n<tr>\n<td>web.external-url</td>\n<td></td>\n</tr>\n<tr>\n<td>web.listen-address</td>\n<td>0.0.0.0:9090</td>\n<td style=\"text-align:left\">监听地址和提供服务端口</td>\n</tr>\n<tr>\n<td>web.max-connections</td>\n<td>512</td>\n</tr>\n<tr>\n<td>web.page-title</td>\n<td>Prometheus Time Series Collection and Processing Server</td>\n</tr>\n<tr>\n<td>web.read-timeout</td>\n<td>5m</td>\n</tr>\n<tr>\n<td>web.route-prefix</td>\n<td>/</td>\n</tr>\n<tr>\n<td>web.user-assets</td>\n</tr>\n</tbody>\n</table>\n<p>Tips ： 当我们启用了 API 时我们可以使用它来看当前<code>prometheus.yml</code>中的配置和利用POST请求重载配置。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前配置,如果使修改后的prometheus.yml配置生效可参照下面得方式(在也不用重启容器了)</span></span><br><span class=\"line\">curl http://192.168.12.107:30090/api/v1/status/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式1.如果在本机二进制可执行时可以通过使用SIGHUP来重载Prometheus而不用重启(ctrl+c)</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> -SIGHUP prometheus</span><br><span class=\"line\"><span class=\"comment\"># 方式2.Yes, sending SIGHUP to the Prometheus process or an HTTP POST request to the /-/reload endpoint </span></span><br><span class=\"line\">curl -X POST http://192.168.12.107:30090/-/reload</span><br><span class=\"line\">  <span class=\"comment\"># level=info ts=2021-05-08T06:37:53.793Z caller=main.go:944 msg=\"Loading configuration file\" filename=/etc/prometheus/prometheus.yml</span></span><br><span class=\"line\">  <span class=\"comment\"># level=info ts=2021-05-08T06:37:53.799Z caller=main.go:975 msg=\"Completed loading of configuration file\" filename=/etc/prometheus/prometheus.yml totalDuration=6.025725ms remote_storage=2.732µs web_handler=617ns query_engine=1.456µs scrape=124.866µs scrape_sd=55.119µs notify=1.099µs notify_sd=1.377µs rules=4.424043ms</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210507165748.png\" alt=\"WeiyiGeek.status-config\" title=\"\" class=\"\">\n                <p>WeiyiGeek.status-config</p>\n            </figure>\n<p><br></p>\n<h3 id=\"Exporter-amp-Collectors\"><a href=\"#Exporter-amp-Collectors\" class=\"headerlink\" title=\"Exporter&amp;Collectors\"></a>Exporter&amp;Collectors</h3><p>描述: Prometheus 给我们提供了多种场景的监控程序，我们可以通过<code>https://github.com/prometheus?q=_export&amp;type=&amp;language=&amp;sort=</code>Prometheus Gitlab项目中查看到。</p>\n<ul>\n<li>(0) node_export : Node 主要监控主机硬件和系统资源相关指标，建议Windows用户使用Windows exporter。<br>项目地址: <a href=\"https://github.com/prometheus/node_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/node_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9100</span></span><br><span class=\"line\"><span class=\"comment\"># Docker</span></span><br><span class=\"line\">docker run -d --net=<span class=\"string\">\"host\"</span> --pid=<span class=\"string\">\"host\"</span> -v <span class=\"string\">\"/:/host:ro,rslave\"</span> quay.io/prometheus/node-exporter:latest --path.rootfs=/host</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Docker compose</span></span><br><span class=\"line\">---</span><br><span class=\"line\">version: <span class=\"string\">'3.8'</span></span><br><span class=\"line\">services:</span><br><span class=\"line\">  node_exporter:</span><br><span class=\"line\">    image: prom/node-exporter:latest</span><br><span class=\"line\">    container_name: node_exporter</span><br><span class=\"line\">    <span class=\"built_in\">command</span>:</span><br><span class=\"line\">      - <span class=\"string\">'--path.rootfs=/host'</span></span><br><span class=\"line\">    network_mode: host</span><br><span class=\"line\">    pid: host</span><br><span class=\"line\">    restart: unless-stopped</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - <span class=\"string\">'/:/host:ro,rslave'</span></span><br><span class=\"line\"><span class=\"comment\"># Using the binary execute file</span></span><br><span class=\"line\"><span class=\"comment\"># Auth 与 SSL 配置参考: https://github.com/prometheus/exporter-toolkit/blob/v0.1.0/https/README.md</span></span><br><span class=\"line\">./node_exporter --web.config=<span class=\"string\">\"web-config.yml\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在某些系统上，timex收集器需要一个附加的Docker标志-cap-add=SYS_TIME，以便访问所需的系统调用。</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>补充:Linux配置Systemd服务启动<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ftp -v -n 192.168.12.31&lt;&lt;EOF</span><br><span class=\"line\">user WeiyiGeektemp</span><br><span class=\"line\">binary</span><br><span class=\"line\">lcd /tmp</span><br><span class=\"line\">prompt</span><br><span class=\"line\">get node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">bye</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"download from ftp successfully\"</span></span><br><span class=\"line\">sudo tar -zxvf /tmp/node_exporter-1.1.2.linux-amd64.tar.gz -C /usr/<span class=\"built_in\">local</span>/</span><br><span class=\"line\">sudo ln -s /usr/<span class=\"built_in\">local</span>/node_exporter-1.1.2.linux-amd64/node_exporter /usr/<span class=\"built_in\">local</span>/bin/node_exporter</span><br><span class=\"line\">sudo tee /usr/lib/systemd/system/node_exporter.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Node Exporter Clinet</span><br><span class=\"line\">Documentation=https://prometheus.io/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/bin/node_exporter --web.listen-address=:9100</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo chmod 754 /usr/lib/systemd/system/node_exporter.service</span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> node_exporter.service</span><br><span class=\"line\">sudo systemctl start node_exporter.service</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<ul>\n<li>(1) windows_exporter : 该采集器主要针对于Windows的机器。<br>项目地址: <a href=\"https://github.com/prometheus-community/windows_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus-community/windows_exporter</a><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9182</span></span><br><span class=\"line\"><span class=\"comment\"># Usage</span></span><br><span class=\"line\"><span class=\"comment\"># - 仅启用service collector并指定自定义查询</span></span><br><span class=\"line\">.\\windows_exporter.exe --collectors.enabled <span class=\"string\">\"service\"</span> --collector.service.services-where <span class=\"string\">\"Name='windows_exporter'\"</span></span><br><span class=\"line\"><span class=\"comment\"># - 仅启用process collector并指定自定义查询</span></span><br><span class=\"line\">.\\windows_exporter.exe --collectors.enabled <span class=\"string\">\"process\"</span> --collector.process.whitelist=<span class=\"string\">\"firefox.+\"</span></span><br><span class=\"line\"><span class=\"comment\"># - 将[defaults]与--collectors.enabled参数一起使用，该参数将与所有默认收集器一起展开。</span></span><br><span class=\"line\">.\\windows_exporter.exe --collectors.enabled <span class=\"string\">\"[defaults],process,container\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Using a configuration file</span></span><br><span class=\"line\">.\\windows_exporter.exe --config.file=config.yml</span><br><span class=\"line\"><span class=\"variable\">$config</span> = <span class=\"string\">\"\"</span><span class=\"string\">\"</span></span><br><span class=\"line\"><span class=\"string\">collectors:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: cpu,cs,logical_disk,net,os,system,service,logon,process,tcp</span></span><br><span class=\"line\"><span class=\"string\">collector:</span></span><br><span class=\"line\"><span class=\"string\">  service:</span></span><br><span class=\"line\"><span class=\"string\">    services-where: Name='windows_exporter'</span></span><br><span class=\"line\"><span class=\"string\">log:</span></span><br><span class=\"line\"><span class=\"string\">  level: error</span></span><br><span class=\"line\"><span class=\"string\">scrape:</span></span><br><span class=\"line\"><span class=\"string\">  timeout-margin: 0.5</span></span><br><span class=\"line\"><span class=\"string\">telemetry:</span></span><br><span class=\"line\"><span class=\"string\">  addr: \"</span>:<span class=\"number\">9182</span><span class=\"string\">\"</span></span><br><span class=\"line\"><span class=\"string\">  path: /metrics</span></span><br><span class=\"line\"><span class=\"string\">  max-requests: 5</span></span><br><span class=\"line\"><span class=\"string\">\"</span><span class=\"string\">\"\"</span></span><br><span class=\"line\">echo <span class=\"variable\">$config</span> &gt; config.yml</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><strong>补充:</strong> 采用PowerShell和bat添加自启动服务和设置防火墙放行。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - PowerShell</span></span><br><span class=\"line\"><span class=\"comment\">#####################################</span></span><br><span class=\"line\"><span class=\"comment\"># Prometheus Metrics Nodes Services #</span></span><br><span class=\"line\"><span class=\"comment\"># Prometheus Exporter firewall Rule #</span></span><br><span class=\"line\"><span class=\"comment\"># Author: WeiyiGeek                 #</span></span><br><span class=\"line\"><span class=\"comment\"># Desc: 需要将该脚本以及windows_exporter-$&#123;exporterVersion&#125;-amd64.exe文件放入到d:\\pro中</span></span><br><span class=\"line\"><span class=\"comment\">#####################################</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$exporterVersion</span>=<span class=\"string\">\"0.16.0\"</span></span><br><span class=\"line\"><span class=\"variable\">$currentPath</span>=(Get-Location).path</span><br><span class=\"line\"><span class=\"variable\">$serviceName</span>=<span class=\"string\">\"prometheus_exporter_service\"</span></span><br><span class=\"line\">@<span class=\"string\">\"</span></span><br><span class=\"line\"><span class=\"string\">collectors:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: cpu,cs,logical_disk,net,os,system,service,logon,process,tcp</span></span><br><span class=\"line\"><span class=\"string\">collector:</span></span><br><span class=\"line\"><span class=\"string\">  service:</span></span><br><span class=\"line\"><span class=\"string\">    services-where: Name='windows_exporter'</span></span><br><span class=\"line\"><span class=\"string\">log:</span></span><br><span class=\"line\"><span class=\"string\">  level: error</span></span><br><span class=\"line\"><span class=\"string\">scrape:</span></span><br><span class=\"line\"><span class=\"string\">  timeout-margin: 0.5</span></span><br><span class=\"line\"><span class=\"string\">telemetry:</span></span><br><span class=\"line\"><span class=\"string\">  addr: \"</span>:9100<span class=\"string\">\"</span></span><br><span class=\"line\"><span class=\"string\">  path: /metrics</span></span><br><span class=\"line\"><span class=\"string\">  max-requests: 5</span></span><br><span class=\"line\"><span class=\"string\">\"</span>@ | Out-File config.yml -Encoding utf8</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果服务存在则停止以及删除旧服务</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (Get-Service -Name <span class=\"variable\">$&#123;serviceName&#125;</span> -ErrorAction Ignore ) </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"注意: 操作时需要关闭系统中全部services.msc服务窗口\"</span></span><br><span class=\"line\">  sc stop <span class=\"variable\">$&#123;serviceName&#125;</span> </span><br><span class=\"line\">  sc delete <span class=\"variable\">$&#123;serviceName&#125;</span> </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 服务创建</span></span><br><span class=\"line\"><span class=\"variable\">$params</span> = @&#123;</span><br><span class=\"line\">  Name = <span class=\"variable\">$&#123;serviceName&#125;</span></span><br><span class=\"line\">  BinaryPathName = <span class=\"string\">\"<span class=\"variable\">$currentPath</span>\\windows_exporter-<span class=\"variable\">$&#123;exporterVersion&#125;</span>-amd64.exe --config.file=<span class=\"variable\">$currentPath</span>\\config.yml\"</span></span><br><span class=\"line\">  DisplayName = <span class=\"string\">\"prometheus_windows_exporter_service\"</span></span><br><span class=\"line\">  StartupType = <span class=\"string\">\"Automatic\"</span></span><br><span class=\"line\">  Description = <span class=\"string\">\"windows exporter service open 9100 port!\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">New-Service @params</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 启动及服务查看</span></span><br><span class=\"line\">Get-Service -Name <span class=\"string\">\"prometheus_windows_exporter_service\"</span> | Start-Service -PassThru</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 防火墙规则设置（只允许10.0.30.200机器访问）</span></span><br><span class=\"line\">New-NetFirewallRule -Name <span class=\"string\">\"prometheus_windows_exporter_service\"</span> -DisplayName <span class=\"string\">\"prometheus_windows_exporter_service\"</span> -Description <span class=\"string\">\"prometheus_windows_exporter_service\"</span> -Direction Inbound -LocalPort 9100 -RemoteAddress 10.0.30.200 -Protocol TCP -Action Allow -Enabled True</span><br><span class=\"line\">Get-NetFirewallRule -Name <span class=\"string\">\"prometheus_windows_exporter_service\"</span>  | Format-Table</span><br><span class=\"line\"><span class=\"comment\"># - bat</span></span><br><span class=\"line\">sc create prometheus_windows_exporter_service binPath= <span class=\"string\">\"d:\\weiyigeek\\windows_exporter-0.16.0-amd64.exe --config.file=d:\\weiyigeek\\config.yml\"</span> start= <span class=\"string\">\"auto\"</span> displayname= <span class=\"string\">\"prometheus_windows_exporter_service\"</span></span><br><span class=\"line\">sc start prometheus_windows_exporter_service</span><br><span class=\"line\">netsh advfirewall firewall add rule name=<span class=\"string\">\"prometheus_windows_exporter_service\"</span> dir=<span class=\"keyword\">in</span> protocol=tcp localport=9100 action=allow remoteip=10.0.30.2 <span class=\"built_in\">enable</span>=yes</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>补充：</strong>采用msi格式进行安装部署<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msiexec /i <span class=\"string\">\"D:\\weiyigeek\\windoes_exporter.msi\"</span> ENABELD_COLLECTORS=<span class=\"string\">\"os,cpu,cs.logical_disk,net,system,process\"</span> LISTEN_PORT=<span class=\"string\">\"9182\"</span> EXTRA_FLAGS=<span class=\"string\">\"--collector.process.whitelist=abc|windows_exporter\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<ul>\n<li>(2) blackbox_exporter : Blackbox 允许通过HTTP、HTTPS、DNS、TCP和ICMP对端点进行黑盒探测(其支持TLS和基本身份验证)。<br>项目地址: <a href=\"https://github.com/prometheus/blackbox_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/blackbox_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9115</span></span><br><span class=\"line\"><span class=\"comment\"># Using the docker image</span></span><br><span class=\"line\">docker run --rm -d -p 9115:9115 --name blackbox_exporter -v `<span class=\"built_in\">pwd</span>`:/config prom/blackbox-exporter:master --config.file=/config/blackbox.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Checking the results</span></span><br><span class=\"line\">curl http://localhost:9115/probe?target=google.com&amp;module=http_2xx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Prometheus Configuration</span></span><br><span class=\"line\"><span class=\"comment\"># 黑盒导出器需要作为参数传递给目标，这可以通过重新标记来完成。</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: <span class=\"string\">'blackbox'</span></span><br><span class=\"line\">    metrics_path: /probe</span><br><span class=\"line\">    params:</span><br><span class=\"line\">      module: [http_2xx]  <span class=\"comment\"># Look for a HTTP 200 response.</span></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets:</span><br><span class=\"line\">        - http://prometheus.io    <span class=\"comment\"># Target to probe with http.</span></span><br><span class=\"line\">        - https://prometheus.io   <span class=\"comment\"># Target to probe with https.</span></span><br><span class=\"line\">        - http://example.com:8080 <span class=\"comment\"># Target to probe with http on port 8080.</span></span><br><span class=\"line\">    relabel_configs:</span><br><span class=\"line\">      - source_labels: [__address__]</span><br><span class=\"line\">        target_label: __param_target</span><br><span class=\"line\">      - source_labels: [__param_target]</span><br><span class=\"line\">        target_label: instance</span><br><span class=\"line\">      - target_label: __address__</span><br><span class=\"line\">        replacement: 127.0.0.1:9115  <span class=\"comment\"># The blackbox exporter's real hostname:port.</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>(3) statsd_exporter: 该采集器接收StatsD样式的指标，并将其导出为Prometheus指标。<br>项目地址: <a href=\"https://github.com/prometheus/statsd_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/statsd_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9125</span></span><br><span class=\"line\"><span class=\"comment\"># Using Docker</span></span><br><span class=\"line\">docker pull prom/statsd-exporter</span><br><span class=\"line\">docker run -d -p 9102:9102 -p 9125:9125 -p 9125:9125/udp \\</span><br><span class=\"line\">        -v <span class=\"variable\">$PWD</span>/statsd_mapping.yml:/tmp/statsd_mapping.yml \\</span><br><span class=\"line\">        prom/statsd-exporter --statsd.mapping-config=/tmp/statsd_mapping.yml</span><br></pre></td></tr></table></figure>\nTips : 使用或者不使用 StatsD<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 使用 StatsD : 要将指标从现有的StatsD环境导入Prometheus，请配置StatsD的转发器后端，以将所有接收到的指标重复到statsd_exporter 流程中。</span></span><br><span class=\"line\"><span class=\"comment\"># 该导出器通过配置的映射规则将StatsD指标转换为Prometheus指标。</span></span><br><span class=\"line\">+----------+                         +-------------------+                        +--------------+</span><br><span class=\"line\">|  StatsD  |---(UDP/TCP repeater)---&gt;|  statsd_exporter  |&lt;---(scrape /metrics)---|  Prometheus  |</span><br><span class=\"line\">+----------+                         +-------------------+                        +--------------+</span><br><span class=\"line\"><span class=\"comment\"># - 没有StatsD ：由于StatsD导出器使用与StatsD本身相同的线路协议，因此您还可以配置应用程序以将StatsD指标直接发送到导出器。在这种情况下，您不再需要运行StatsD服务器。</span></span><br><span class=\"line\"><span class=\"comment\"># 我们建议仅将此作为中间解决方案，并建议长期使用本机Prometheus仪器。</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>(4) snmp_exporter : 建议使用此导出器以Prometheus可以提取的格式公开SNMP数据,尽管SNMP使用分层数据结构，而Prometheus使用n维矩阵，所以两个系统可以完美地映射而无需手工遍历数据 ;<br>项目地址: <a href=\"https://github.com/prometheus/snmp_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/snmp_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9116</span></span><br><span class=\"line\"><span class=\"comment\"># Using : 二进制文件可以从Github发布页面下载不需要特殊安装。</span></span><br><span class=\"line\">./snmp_exporter</span><br><span class=\"line\"><span class=\"comment\"># http://localhost:9116/snmp?target=1.2.3.4 </span></span><br><span class=\"line\"><span class=\"comment\"># http://localhost:9116/snmp?module=if_mib&amp;target=1.2.3.4</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Prometheus Configuration: 目标和模块可以通过重新标记作为参数传递。</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: <span class=\"string\">'snmp'</span></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets:</span><br><span class=\"line\">        - 192.168.1.2  <span class=\"comment\"># SNMP device.</span></span><br><span class=\"line\">        - switch.local <span class=\"comment\"># SNMP device.</span></span><br><span class=\"line\">    metrics_path: /snmp</span><br><span class=\"line\">    params:</span><br><span class=\"line\">      module: [if_mib]</span><br><span class=\"line\">    relabel_configs:</span><br><span class=\"line\">      - source_labels: [__address__]</span><br><span class=\"line\">        target_label: __param_target</span><br><span class=\"line\">      - source_labels: [__param_target]</span><br><span class=\"line\">        target_label: instance</span><br><span class=\"line\">      - target_label: __address__</span><br><span class=\"line\">        replacement: 127.0.0.1:9116  <span class=\"comment\"># The SNMP exporter's real hostname:port.</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : SNMP OID Tree 构成说明, SNMP由OID树构成，由MIB描述，OID子树在树中的不同位置具有相同的顺序。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 数字是OID，括号中的名称是MIB的名称</span></span><br><span class=\"line\">1.3.6.1.2.1.2.2.1.1 (ifIndex)</span><br><span class=\"line\">1.3.6.1.2.1.2.2.1.2 (ifDescr)</span><br><span class=\"line\">1.3.6.1.2.1.31.1.1.1.10 (ifHCOutOctets)</span><br></pre></td></tr></table></figure><br>Tips: Prometheus能够将SNMP索引实例映射到标签。例如ifEntry指定的INDEX ifIndex。这成为ifIndexPrometheus中的标签。</p>\n<p><br/></p>\n<ul>\n<li>(5) consul_exporter : 该采集器支持外接配置中心，将领事服务运行状况导出到Prometheus。<br>项目地址: <a href=\"https://github.com/prometheus/consul_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/consul_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9107</span></span><br><span class=\"line\"><span class=\"comment\"># - Using Source</span></span><br><span class=\"line\">make</span><br><span class=\"line\">./consul_exporter [flags]</span><br><span class=\"line\"><span class=\"comment\"># - Using Docker</span></span><br><span class=\"line\">docker pull prom/consul-exporter</span><br><span class=\"line\">docker run -d -p 9107:9107 prom/consul-exporter --consul.server=172.17.0.1:8500</span><br><span class=\"line\"><span class=\"comment\"># 如果您的容器需要能够与Consul服务器或代理进行通信。使用可从容器访问的IP或设置命令的--dns和--dns-search选项docker run 命令</span></span><br><span class=\"line\">docker run -d -p 9107:9107 --dns=172.17.0.1 --dns-search=service.consul prom/consul-exporter --consul.server=consul:8500</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>(6) DCGM-Exporter : 该采集器主要针对于 NVIDIA GPU 相关的指标进行采集工具。<br>此存储库包含Golang绑定和DCGM导出器，用于在Kubernetes中收集GPU遥测数据。项目地址:<a href=\"https://github.com/NVIDIA/gpu-monitoring-tools#dcgm-exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/NVIDIA/gpu-monitoring-tools#dcgm-exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9400</span></span><br><span class=\"line\"><span class=\"comment\"># Usage</span></span><br><span class=\"line\"><span class=\"comment\"># - Quickstart：要在GPU节点上收集指标，只需启动dcgm exporter容器：</span></span><br><span class=\"line\">$ docker run -d --gpus all --rm -p 9400:9400 nvcr.io/nvidia/k8s/dcgm-exporter:2.0.13-2.1.2-ubuntu18.04</span><br><span class=\"line\">$ curl localhost:9400/metrics</span><br><span class=\"line\"><span class=\"comment\"># - Quickstart on Kubernetes : 考虑使用 NVIDIA GPU Operator 而不是直接使用DCGM导出器。</span></span><br><span class=\"line\">$ helm repo add gpu-helm-charts \\</span><br><span class=\"line\">  https://nvidia.github.io/gpu-monitoring-tools/helm-charts</span><br><span class=\"line\">$ helm repo update</span><br><span class=\"line\">$ helm install --generate-name gpu-helm-charts/dcgm-exporter</span><br><span class=\"line\">$ kubectl create -f https://raw.githubusercontent.com/NVIDIA/gpu-monitoring-tools/master/dcgm-exporter.yaml</span><br><span class=\"line\">$ NAME=$(kubectl get pods -l <span class=\"string\">\"app.kubernetes.io/name=dcgm-exporter\"</span> -o <span class=\"string\">\"jsonpath=&#123; .items[0].metadata.name&#125;\"</span>)</span><br><span class=\"line\">$ kubectl port-forward <span class=\"variable\">$NAME</span> 8080:9400 &amp;</span><br><span class=\"line\"><span class=\"comment\"># - Building from Source</span></span><br><span class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/NVIDIA/gpu-monitoring-tools.git</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> gpu-monitoring-tools</span><br><span class=\"line\">$ make binary</span><br><span class=\"line\">$ sudo make install</span><br><span class=\"line\">$ dcgm-exporter &amp;</span><br><span class=\"line\">$ curl localhost:9400/metrics</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>(7) mysqld_exporter : Prometheus exporter for MySQL服务器度量,支持版本说明<code>MySQL &gt;= 5.6</code>和<code>MariaDB &gt;= 10.2</code>。<br>项目地址: <a href=\"https://github.com/prometheus/mysqld_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/mysqld_exporter</a><br>注意：MySQL/MariaDB&lt;5.6并不支持所有的收集方法</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9104</span></span><br><span class=\"line\"><span class=\"comment\"># Required Grants</span></span><br><span class=\"line\">CREATE USER <span class=\"string\">'exporter'</span>@<span class=\"string\">'localhost'</span> IDENTIFIED BY <span class=\"string\">'XXXXXXXX'</span> WITH MAX_USER_CONNECTIONS 3;</span><br><span class=\"line\">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO <span class=\"string\">'exporter'</span>@<span class=\"string\">'localhost'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Using Binary</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> DATA_SOURCE_NAME=<span class=\"string\">'user:password@(hostname:3306)/'</span></span><br><span class=\"line\">./mysqld_exporter &lt;flags&gt;</span><br><span class=\"line\"><span class=\"comment\">#  &lt;General flags&gt; 参考地址 : https://github.com/prometheus/mysqld_exporter#general-flags</span></span><br><span class=\"line\"><span class=\"comment\"># Example format for flags for version &gt; 0.10.0:</span></span><br><span class=\"line\"><span class=\"comment\"># --collect.auto_increment.columns</span></span><br><span class=\"line\"><span class=\"comment\"># --no-collect.auto_increment.columns</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Using Docker</span></span><br><span class=\"line\">docker network create my-mysql-network</span><br><span class=\"line\">docker pull prom/mysqld-exporter</span><br><span class=\"line\">docker run -d -p 9104:9104 </span><br><span class=\"line\">  --network my-mysql-network  \\</span><br><span class=\"line\">  -e DATA_SOURCE_NAME=<span class=\"string\">\"user:password@(hostname:3306)/\"</span> \\</span><br><span class=\"line\">  prom/mysqld-exporter</span><br></pre></td></tr></table></figure>\n<p>补充说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - mysqld_exporter参数配置文件</span></span><br><span class=\"line\">sudo tee /etc/mysqld_exporter.cnf<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[client]</span><br><span class=\"line\">user=mysql_exporter</span><br><span class=\"line\">password=123456</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 将mysqld_exporter作为系统服务进行启动。</span></span><br><span class=\"line\">sudo tee /usr/lib/systemd/system/mysqld_exporter.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=MySQL exporter Clinet</span><br><span class=\"line\">Documentation=https://github.com/prometheus/mysqld_exporter</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/bin/mysqld_exporter --config.my-cnf=/etc/mysqld_exporter.cnf</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">chmod 754 /usr/lib/systemd/system/mysqld_exporter.service</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl <span class=\"built_in\">enable</span> mysqld_exporter.service &amp;&amp; systemctl start mysqld_exporter.service &amp;&amp; systemctl status mysqld_exporter</span><br><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl restart mysqld_exporter.service &amp;&amp; systemctl status mysqld_exporter</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl status mysqld_exporter</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<ul>\n<li>(8) memcached_exporter : 该导出器主要针对于 memcached 内存数据库。<br>项目地址:<a href=\"https://github.com/prometheus/memcached_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/memcached_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9150</span></span><br><span class=\"line\"><span class=\"comment\"># Using source</span></span><br><span class=\"line\">make</span><br><span class=\"line\">./memcached_exporter</span><br><span class=\"line\"><span class=\"comment\"># Using Docker</span></span><br><span class=\"line\">docker run -p 9150:9150 quay.io/prometheus/memcached-exporter:latest</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>(9) influxdb_exporter : 从0.9.0开始使用的InfluxDB格式指标的导出器。它通过HTTP API收集在线协议中的指标， 对其进行转换并将其公开以供Prometheus使用。此导出器支持float，int和boolean字段。标签将转换为Prometheus标签。<br>默认情况下导出器还会监听UDP套接字（端口9122），在该套接字上使用/metrics端点公开influxDB指标，并在端点上公开导出程序的自我指标<code>/metrics/exporter</code>。<br>项目地址: <a href=\"https://github.com/prometheus/influxdb_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/influxdb_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9122</span></span><br><span class=\"line\"><span class=\"comment\"># Using</span></span><br><span class=\"line\"><span class=\"comment\"># influxdb_exporter显示为普通的InfluxDB服务器。</span></span><br><span class=\"line\"><span class=\"comment\"># 例如要与Telegraf一起使用，请将以下内容放入您的中</span></span><br><span class=\"line\">[[outputs.influxdb]]</span><br><span class=\"line\">  urls = [<span class=\"string\">\"http://localhost:9122\"</span>]</span><br><span class=\"line\"><span class=\"comment\"># 或者如果您想使用UDP：</span></span><br><span class=\"line\">[[outputs.influxdb]]</span><br><span class=\"line\">  urls = [<span class=\"string\">\"udp://localhost:9122\"</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># example</span></span><br><span class=\"line\"><span class=\"comment\"># 默认情况下，公开的指标没有原始时间戳</span></span><br><span class=\"line\">http_requests_total&#123;method=<span class=\"string\">\"post\"</span>,code=<span class=\"string\">\"200\"</span>&#125; 1027</span><br><span class=\"line\">http_requests_total&#123;method=<span class=\"string\">\"post\"</span>,code=<span class=\"string\">\"400\"</span>&#125;    3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用标志 --timestamps 将原始时间戳添加到公开的指标中</span></span><br><span class=\"line\">http_requests_total&#123;method=<span class=\"string\">\"post\"</span>,code=<span class=\"string\">\"200\"</span>&#125; 1027 1395066363000</span><br><span class=\"line\">http_requests_total&#123;method=<span class=\"string\">\"post\"</span>,code=<span class=\"string\">\"400\"</span>&#125;    3 1395066363000</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : 请注意Telegraf已经支持通过HTTP通过HTTP输出Prometheus度量标准 outputs.prometheus_client，从而避免了也必须运行influxdb_exporter。<br>Tips : 如果多次提交或多次采集了该指标，则只会存储最后一个值和时间戳。</p>\n<p><br/></p>\n<ul>\n<li>(10) graphite_exporter : Graphite纯文本协议中导出的度量标准的导出器。它通过TCP和UDP接收数据，并进行转换并将其公开以供Prometheus使用。此导出器对于从现有Graphite设置导出度量标准以及核心Prometheus导出器（例如Node Exporter）未涵盖的度量很有用(即脚本自定义收集参数值反馈)。<br>项目地址: <a href=\"https://github.com/prometheus/graphite_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/graphite_exporter</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9108 / 9109 (Tcp|Udp)</span></span><br><span class=\"line\"><span class=\"comment\"># Using Docker</span></span><br><span class=\"line\">docker pull prom/graphite-exporter</span><br><span class=\"line\">docker run -d -p 9108:9108 -p 9109:9109 -p 9109:9109/udp \\</span><br><span class=\"line\">  -v <span class=\"variable\">$&#123;PWD&#125;</span>/graphite_mapping.conf:/tmp/graphite_mapping.conf \\</span><br><span class=\"line\">  prom/graphite-exporter --graphite.mapping-config=/tmp/graphite_mapping.confsing Docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Usage</span></span><br><span class=\"line\">make</span><br><span class=\"line\">./graphite_exporter</span><br><span class=\"line\"><span class=\"comment\"># 配置现有监视以将Graphite纯文本数据发送到UDP或TCP上的端口9109,作为一个简单的演示：</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"test_tcp 1234 <span class=\"variable\">$(date +%s)</span>\"</span> | nc localhost 9109</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"test_udp 1234 <span class=\"variable\">$(date +%s)</span>\"</span> | nc -u -w1 localhost 9109</span><br><span class=\"line\"><span class=\"comment\"># 为避免使用无限制的内存，指标将在最后一次推送到五分钟后进行垃圾回收，可通过`--graphite.sample-expiry`设置;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果验证:</span></span><br><span class=\"line\">http://localhost:9108/metrics</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>(11) collectd_exporter : 它接受collected的网络插件发送的collected的 二进制网络协议 ， 并通过collected的write_http插件发送的HTTP POST接受JSON格式的JSON格式的 度量，并将其转换并公开以供Prometheus使用。该导出器对于从现有收集的设置中导出度量标准以及核心Prometheus导出器（如Node Exporter）未涵盖的度量很有用。<br>描述:  <a href=\"https://github.com/prometheus/collectd_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/collectd_exporter</a></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9103 、25826(UDP)</span></span><br><span class=\"line\"><span class=\"comment\"># Using Docker</span></span><br><span class=\"line\">docker pull prom/collectd-exporter</span><br><span class=\"line\">docker run -d -p 9103:9103 -p 25826:25826/udp prom/collectd-exporter --collectd.listen-address=<span class=\"string\">\":25826\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Binary network protocol</span></span><br><span class=\"line\">LoadPlugin network</span><br><span class=\"line\">&lt;Plugin network&gt;</span><br><span class=\"line\">  Server <span class=\"string\">\"prometheus.example.com\"</span> <span class=\"string\">\"25826\"</span></span><br><span class=\"line\">&lt;/Plugin&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># JSON format (值得学习)</span></span><br><span class=\"line\">LoadPlugin write_http</span><br><span class=\"line\">&lt;Plugin write_http&gt;</span><br><span class=\"line\">  &lt;Node <span class=\"string\">\"collectd_exporter\"</span>&gt;</span><br><span class=\"line\">    URL <span class=\"string\">\"http://localhost:9103/collectd-post\"</span></span><br><span class=\"line\">    Format <span class=\"string\">\"JSON\"</span></span><br><span class=\"line\">    StoreRates <span class=\"literal\">false</span></span><br><span class=\"line\">  &lt;/Node&gt;</span><br><span class=\"line\">&lt;/Plugin&gt;</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<ul>\n<li>(12) haproxy_exporter : 简单的服务器，它可以抓取HAProxy数据并通过HTTP将它们导出，供Prometheus使用。注意：自HAProxy 2.0.0起，官方资源包括Prometheus导出器模块，该模块可在构建期间通过单个标志内置到二进制文件中，并提供无导出器的Prometheus端点。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9101</span></span><br><span class=\"line\"><span class=\"comment\"># Using Binary</span></span><br><span class=\"line\">./haproxy_exporter [flags]</span><br><span class=\"line\"><span class=\"comment\"># Using Socket : 作为localhost HTTP的替代方法，可以使用stats套接字。在HAProxy中启用stats套接字，例如：</span></span><br><span class=\"line\">stats socket /run/haproxy/admin.sock mode 660 level admin</span><br><span class=\"line\">haproxy_exporter --haproxy.scrape-uri=unix:/run/haproxy/admin.sock</span><br><span class=\"line\"><span class=\"comment\"># Using Docker</span></span><br><span class=\"line\">docker run -p 9101:9101 quay.io/prometheus/haproxy-exporter:v0.12.0 --haproxy.scrape-uri=<span class=\"string\">\"http://user:pass@haproxy.example.com/haproxy?stats;csv\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Usage : HTTP统计URL</span></span><br><span class=\"line\">haproxy_exporter --haproxy.scrape-uri=<span class=\"string\">\"http://localhost:5000/baz?stats;csv\"</span></span><br><span class=\"line\">haproxy_exporter --haproxy.scrape-uri=<span class=\"string\">\"http://haproxy.example.com/haproxy?stats;csv\"</span></span><br><span class=\"line\">haproxy_exporter --haproxy.scrape-uri=<span class=\"string\">\"http://user:pass@haproxy.example.com/haproxy?stats;csv\"</span>  <span class=\"comment\"># 带有认证</span></span><br><span class=\"line\">haproxy_exporter --no-haproxy.ssl-verify --haproxy.scrape-uri=<span class=\"string\">\"https://haproxy.example.com/haproxy?stats;csv\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>(13) jmx_exporter : 该收集器可配置地抓取和公开JMX目标的mBean, 该导出程序旨在作为Java代理运行，公开HTTP服务器并提供本地JVM的度量。它也可以作为独立的HTTP服务器运行，并刮擦远程JMX目标，但这有许多缺点，例如难以配置并且无法公开过程指标（例如，内存和CPU使用率）。因此，强烈建议将导出程序作为Java代理运行。<br>项目地址: <a href=\"https://github.com/prometheus/jmx_exporter\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/jmx_exporter</a></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 8080</span></span><br><span class=\"line\">java -javaagent:./jmx_prometheus_javaagent-0.15.0.jar=8080:config.yaml -jar yourJar.jar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Using : To run as a javaagent download the jar and run:</span></span><br><span class=\"line\">java -javaagent:./jmx_prometheus_javaagent-0.15.0.jar=8080:config.yaml -jar yourJar.jar</span><br><span class=\"line\"><span class=\"comment\"># Configuration</span></span><br><span class=\"line\">---</span><br><span class=\"line\">startDelaySeconds: 0</span><br><span class=\"line\">hostPort: 127.0.0.1:1234</span><br><span class=\"line\">username: </span><br><span class=\"line\">password: </span><br><span class=\"line\">jmxUrl: service:jmx:rmi:///jndi/rmi://127.0.0.1:1234/jmxrmi</span><br><span class=\"line\">ssl: <span class=\"literal\">false</span></span><br><span class=\"line\">lowercaseOutputName: <span class=\"literal\">false</span></span><br><span class=\"line\">lowercaseOutputLabelNames: <span class=\"literal\">false</span></span><br><span class=\"line\">whitelistObjectNames: [<span class=\"string\">\"org.apache.cassandra.metrics:*\"</span>]</span><br><span class=\"line\">blacklistObjectNames: [<span class=\"string\">\"org.apache.cassandra.metrics:type=ColumnFamily,*\"</span>]</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - pattern: <span class=\"string\">'org.apache.cassandra.metrics&lt;type=(\\w+), name=(\\w+)&gt;&lt;&gt;Value: (\\d+)'</span></span><br><span class=\"line\">    name: cassandra_<span class=\"variable\">$1_</span><span class=\"variable\">$2</span></span><br><span class=\"line\">    value: <span class=\"variable\">$3</span></span><br><span class=\"line\">    valueFactor: 0.001</span><br><span class=\"line\">    labels: &#123;&#125;</span><br><span class=\"line\">    <span class=\"built_in\">help</span>: <span class=\"string\">\"Cassandra metric <span class=\"variable\">$1</span> <span class=\"variable\">$2</span>\"</span></span><br><span class=\"line\">    cache: <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"built_in\">type</span>: GAUGE</span><br><span class=\"line\">    attrNameSnakeCase: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Test</span></span><br><span class=\"line\">curl http://localhost:8080/metrics</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># run_sample_httpserver.sh</span></span><br><span class=\"line\"><span class=\"meta\">#!/usr/bin/env bash</span></span><br><span class=\"line\"><span class=\"comment\"># Script to run a java application for testing jmx4prometheus.</span></span><br><span class=\"line\">version=$(sed -n -e <span class=\"string\">'s#.*&lt;version&gt;\\(.*-SNAPSHOT\\)&lt;/version&gt;#\\1#p'</span> pom.xml)</span><br><span class=\"line\"><span class=\"comment\"># Note: You can use localhost:5556 instead of 5556 for configuring socket hostname.</span></span><br><span class=\"line\">java -Dcom.sun.management.jmxremote.ssl=<span class=\"literal\">false</span> -Dcom.sun.management.jmxremote.authenticate=<span class=\"literal\">false</span> -Dcom.sun.management.jmxremote.port=5555 -jar jmx_prometheus_httpserver/target/jmx_prometheus_httpserver-<span class=\"variable\">$&#123;version&#125;</span>-jar-with-dependencies.jar 5556 example_configs/httpserver_sample_config.yml</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<ul>\n<li>(13) exporter-toolkit : Prometheus出口商工具包(Go库), 该存储库旨在与client_golang存储库结合使用 。如果要检测现有的Go应用程序，则 client_golang是您要查找的存储库。</li>\n</ul>\n<p>项目地址: <a href=\"https://github.com/prometheus/exporter-toolkit\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/exporter-toolkit</a></p>\n<p><br></p>\n<ul>\n<li>(14) redis_exporter : Prometheus Redis 指标采集器支持版本<code>Redis 2.x, 3.x, 4.x, 5.x, and 6.x</code></li>\n</ul>\n<p>项目地址: <a href=\"https://github.com/oliver006/redis_exporter/\" target=\"_blank\" rel=\"noopener\">https://github.com/oliver006/redis_exporter/</a><br>命令行参数参考: <a href=\"https://github.com/oliver006/redis_exporter/#command-line-flags\" target=\"_blank\" rel=\"noopener\">https://github.com/oliver006/redis_exporter/#command-line-flags</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Build &amp;&amp; Run Binary</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/oliver006/redis_exporter.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> redis_exporter</span><br><span class=\"line\">go build .</span><br><span class=\"line\">./redis_exporter --version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Run Docker</span></span><br><span class=\"line\">docker run -d --name redis_exporter -p 9121:9121 -e REDIS_ADDR=<span class=\"string\">\"redis://192.168.12.1doc85:6379\"</span>  -e REDIS_PASSWORD=<span class=\"string\">\"weiyigeek.top\"</span> oliver006/redis_exporter:alpine</span><br><span class=\"line\">docker run -d --name redis_exporter --network host -e REDIS_ADDR=<span class=\"string\">\"redis://192.168.12.1doc85:6379\"</span>  -e REDIS_PASSWORD=<span class=\"string\">\"weiyigeek.top\"</span> oliver006/redis_exporter</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Kubernetes 部署配置示例</span></span><br><span class=\"line\"><span class=\"comment\"># k8s-redis-and-exporter-deployment.yaml</span></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: redis</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  namespace: redis</span><br><span class=\"line\">  name: redis</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: redis</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        prometheus.io/scrape: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">        prometheus.io/port: <span class=\"string\">\"9121\"</span></span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: redis</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: redis</span><br><span class=\"line\">        image: redis:4</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 100Mi</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 6379</span><br><span class=\"line\">      - name: redis-exporter</span><br><span class=\"line\">        image: oliver006/redis_exporter:latest</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 100Mi</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9121</span><br></pre></td></tr></table></figure>\n<p>Configuration &amp;&amp; 配置:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基本构型</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: redis_exporter</span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">    - targets: [<span class=\"string\">'localhost:9121'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置刮多个Redis主机</span></span><br><span class=\"line\"><span class=\"comment\"># 使用命令行标志redis.addr=运行导出程序，这样它就不会在每次刮取/metrics端点时都尝试访问本地实例。</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: <span class=\"string\">'redis_exporter_targets'</span></span><br><span class=\"line\">    file_sd_configs:</span><br><span class=\"line\">      - files:</span><br><span class=\"line\">        - targets-redis-instances.yml</span><br><span class=\"line\">    metrics_path: /scrape</span><br><span class=\"line\">    relabel_configs:</span><br><span class=\"line\">      - source_labels: [__address__]</span><br><span class=\"line\">        target_label: __param_target</span><br><span class=\"line\">      - source_labels: [__param_target]</span><br><span class=\"line\">        target_label: instance</span><br><span class=\"line\">      - target_label: __address__</span><br><span class=\"line\">        replacement: &lt;&lt;REDIS-EXPORTER-HOSTNAME&gt;&gt;:9121</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">## config for scraping the exporter itself</span></span><br><span class=\"line\">  - job_name: <span class=\"string\">'redis_exporter'</span></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets:</span><br><span class=\"line\">        - &lt;&lt;REDIS-EXPORTER-HOSTNAME&gt;&gt;:9121</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># targets-redis-instances.yml</span></span><br><span class=\"line\">- targets: [ <span class=\"string\">\"redis://redis-host-01:6379\"</span>, <span class=\"string\">\"redis://redis-host-02:6379\"</span> ]</span><br><span class=\"line\">  <span class=\"string\">\"labels\"</span>: &#123; <span class=\"string\">'env'</span>: <span class=\"string\">'prod'</span> &#125;</span><br></pre></td></tr></table></figure></p>\n<p>补充说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/redis_exporter.service &lt;&lt; EOF</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=redis_exporter</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/redis_exporter-v1.20.0.linux-amd64/redis_exporter -redis.addr=IP:6379  -redis.password=passwd </span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">chmod 754 /usr/lib/systemd/system/redis_exporter.service</span><br><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl <span class=\"built_in\">enable</span> redis_exporter .service &amp;&amp; systemctl start redis_exporter .service &amp;&amp; systemctl status redis_exporter </span><br><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl restart redis_exporter .service &amp;&amp; systemctl status redis_exporter </span><br><span class=\"line\">systemctl status redis_exporter</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"Alertmanager\"><a href=\"#Alertmanager\" class=\"headerlink\" title=\"Alertmanager\"></a>Alertmanager</h3><p>描述: Alertmanager处理客户端应用程序（如Prometheus服务器）发送的警报。它负责重复数据消除、分组，并将它们路由到正确的接收器集成，如电子邮件、PagerDuty或OpsGenie,同时它还负责沉默和抑制警报。</p>\n<p>项目地址: <a href=\"https://github.com/prometheus/alertmanager\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/alertmanager</a><br>文档帮助: <a href=\"http://prometheus.io/docs/alerting/alertmanager/\" target=\"_blank\" rel=\"noopener\">http://prometheus.io/docs/alerting/alertmanager/</a></p>\n<p><br/></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210520100107.png\" alt=\"WeiyiGeek.Alertmanager-组件架构\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Alertmanager-组件架构</p>\n            </figure>\n<p><br/></p>\n<p><strong>标签 在 Alertmanager 主要关键作用:</strong></p>\n<ul>\n<li>1) 降噪: 发送更高级的告警从而忽略某些告警。</li>\n<li>2) 静音: 知道某个告警并且正在处理，无需再次报警，例如在<code>Alertmanager</code>中设置<code>Silences</code>静默。</li>\n<li>3) 路由: 使用多个路由树，将告警通过各种方式进行发送。</li>\n<li>4) 分组: 使得某一特征的标签实例发送一个通知。</li>\n<li>5) 抑制重复: 如果已经发送了警告可以设置报警间隔时间以达到抑制重复警告。</li>\n<li>6) 通知: 通过模板或者邮件、Webhook、企业微信进行发送通知。</li>\n</ul>\n<p><br/></p>\n<p><strong>简单流程:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口: 9093</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Install</span></span><br><span class=\"line\"><span class=\"comment\"># - Docker images</span></span><br><span class=\"line\">$ docker run --name alertmanager -d -p 127.0.0.1:9093:9093 quay.io/prometheus/alertmanager</span><br><span class=\"line\"><span class=\"comment\"># - Compiling the binary</span></span><br><span class=\"line\">$ mkdir -p <span class=\"variable\">$GOPATH</span>/src/github.com/prometheus</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src/github.com/prometheus</span><br><span class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/prometheus/alertmanager.git</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> alertmanager</span><br><span class=\"line\">$ make build</span><br><span class=\"line\">$ ./alertmanager --config.file=&lt;your_file&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Usage</span></span><br><span class=\"line\">usage: alertmanager [&lt;flags&gt;]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (6) 补充系统服务进行启动alertmanager</span></span><br><span class=\"line\">sudo tee /usr/lib/systemd/system/alertmanager.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Prometheus Alertmanager Server Systemd</span><br><span class=\"line\">Documentation=https://prometheus.io</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/alertmanager/alertmanager --config.file=/usr/<span class=\"built_in\">local</span>/alertmanager/alertmanager.yml --web.listen-address=:9093 --storage.path=/monitor/alertmanager/data</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo systemctl daemon-reload &amp;&amp; systemctl restart alertmanager.service</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>启动参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1 nobody    7:47 /bin/alertmanager --config.file=/etc/alertmanager.yaml --storage.path=/alertmanager</span></span><br><span class=\"line\">Flags:</span><br><span class=\"line\">--config.file=<span class=\"string\">\"alertmanager.yml\"</span>  Alertmanager configuration file name.</span><br><span class=\"line\">--storage.path=<span class=\"string\">\"data/\"</span>     Base path <span class=\"keyword\">for</span> data storage.</span><br><span class=\"line\">--data.retention=120h      How long to keep data <span class=\"keyword\">for</span>.</span><br><span class=\"line\">--alerts.gc-interval=30m   Interval between alert GC.</span><br><span class=\"line\">--web.external-url=WEB.EXTERNAL-URL The URL under <span class=\"built_in\">which</span> Alertmanager is externally reachable (<span class=\"keyword\">for</span> example, <span class=\"keyword\">if</span> Alertmanager is served via a reverse proxy). Used <span class=\"keyword\">for</span> generating relative and</span><br><span class=\"line\">                            absolute links back to Alertmanager itself. If the URL has a path portion, it will be used to prefix all HTTP endpoints served by Alertmanager. If omitted,</span><br><span class=\"line\">                            relevant URL components will be derived automatically.</span><br><span class=\"line\">--web.route-prefix=WEB.ROUTE-PREFIX  Prefix <span class=\"keyword\">for</span> the internal routes of web endpoints. Defaults to path of --web.external-url.</span><br><span class=\"line\">--web.listen-address=<span class=\"string\">\":9093\"</span>  Address to listen on <span class=\"keyword\">for</span> the web interface and API.</span><br><span class=\"line\">--web.get-concurrency=0    Maximum number of GET requests processed concurrently. If negative or zero, the <span class=\"built_in\">limit</span> is GOMAXPROC or 8, whichever is larger.</span><br><span class=\"line\">--web.timeout=0            Timeout <span class=\"keyword\">for</span> HTTP requests. If negative or zero, no timeout is <span class=\"built_in\">set</span>.</span><br><span class=\"line\">--cluster.listen-address=<span class=\"string\">\"0.0.0.0:9094\"</span>  Listen address <span class=\"keyword\">for</span> cluster. Set to empty string to <span class=\"built_in\">disable</span> HA mode.</span><br><span class=\"line\">--cluster.advertise-address=CLUSTER.ADVERTISE-ADDRESS Explicit address to advertise <span class=\"keyword\">in</span> cluster.</span><br><span class=\"line\">--cluster.peer=CLUSTER.PEER ... Initial peers (may be repeated).</span><br><span class=\"line\">--cluster.peer-timeout=15s Time to <span class=\"built_in\">wait</span> between peers to send notifications.</span><br><span class=\"line\">--cluster.gossip-interval=200ms Interval between sending gossip messages. By lowering this value (more frequent) gossip messages are propagated across the cluster more quickly at the expenseof increased bandwidth.</span><br><span class=\"line\">--cluster.pushpull-interval=1m0s Interval <span class=\"keyword\">for</span> gossip state syncs. Setting this interval lower (more frequent) will increase convergence speeds across larger clusters at the expense of ncreased bandwidth usage.</span><br><span class=\"line\">--cluster.tcp-timeout=10s  Timeout <span class=\"keyword\">for</span> establishing a stream connection with a remote node <span class=\"keyword\">for</span> a full state sync, and <span class=\"keyword\">for</span> stream <span class=\"built_in\">read</span> and write operations.</span><br><span class=\"line\">--cluster.probe-timeout=500ms Timeout to <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> an ack from a probed node before assuming it is unhealthy. This should be <span class=\"built_in\">set</span> to 99-percentile of RTT (round-trip time) on your network.</span><br><span class=\"line\">--cluster.probe-interval=1s Interval between random node probes. Setting this lower (more frequent) will cause the cluster to detect failed nodes more quickly at the expense of increased bandwidth usage.</span><br><span class=\"line\">--cluster.settle-timeout=1m0s Maximum time to <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> cluster connections to settle before evaluating notifications.</span><br><span class=\"line\">--cluster.reconnect-interval=10s Interval between attempting to reconnect to lost peers.</span><br><span class=\"line\">--cluster.reconnect-timeout=6h0m0s Length of time to attempt to reconnect to a lost peer.</span><br><span class=\"line\">--log.level=info           Only <span class=\"built_in\">log</span> messages with the given severity or above. One of: [debug, info, warn, error]</span><br><span class=\"line\">--log.format=logfmt        Output format of <span class=\"built_in\">log</span> messages. One of: [logfmt, json]</span><br><span class=\"line\">--version                  Show application version.</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tips ：amtool是用于与Alertmanager API交互的cli工具，它与Alertmanager的所有版本捆绑在一起。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.Install</span></span><br><span class=\"line\">go get github.com/prometheus/alertmanager/cmd/amtool</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.Examples</span></span><br><span class=\"line\"><span class=\"comment\"># - 查看所有当前触发的警报：</span></span><br><span class=\"line\">$ amtool alert</span><br><span class=\"line\">  Alertname        Starts At                Summary</span><br><span class=\"line\">  Test_Alert       2017-08-02 18:30:18 UTC  This is a testing alert!</span><br><span class=\"line\">  Test_Alert       2017-08-02 18:30:18 UTC  This is a testing alert!</span><br><span class=\"line\">  Check_Foo_Fails  2017-08-02 18:30:18 UTC  This is a testing alert!</span><br><span class=\"line\">  Check_Foo_Fails  2017-08-02 18:30:18 UTC  This is a testing alert!</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 通过扩展输出查看所有当前触发的警报：</span></span><br><span class=\"line\">amtool -o extended alert</span><br><span class=\"line\">  Labels                                        Annotations                                                    Starts At                Ends At                  Generator URL</span><br><span class=\"line\">  alertname=<span class=\"string\">\"Test_Alert\"</span> instance=<span class=\"string\">\"node0\"</span>       link=<span class=\"string\">\"https://example.com\"</span> summary=<span class=\"string\">\"This is a testing alert!\"</span>  2017-08-02 18:31:24 UTC  0001-01-01 00:00:00 UTC  http://my.testing.script.local</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 使用Alertmanager提供的丰富查询语法：</span></span><br><span class=\"line\">$ amtool -o extended alert query alertname=<span class=\"string\">\"Test_Alert\"</span></span><br><span class=\"line\">$ amtool -o extended alert query alertname=~<span class=\"string\">\"Test.*\"</span> instance=~<span class=\"string\">\".+1\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 暂停警报(Silence an alert)与查看静音的警报</span></span><br><span class=\"line\">$ amtool silence add alertname=<span class=\"string\">\"Test_Alert\"</span> instance=~<span class=\"string\">\".+0\"</span></span><br><span class=\"line\">$ amtool silence query</span><br><span class=\"line\">  ID                                    Matchers              Ends At                  Created By  Comment</span><br><span class=\"line\">  b3ede22e-ca14-4aa0-932c-ca2f3445f926  alertname=Test_Alert  2017-08-02 19:54:50 UTC  kellel</span><br><span class=\"line\">$ amtool silence query</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 启动警报(也可以进行匹配启动)或者终止所有沉默</span></span><br><span class=\"line\">$ amtool silence expire b3ede22e-ca14-4aa0-932c-ca2f3445f926</span><br><span class=\"line\">$ amtool silence expire $(amtool silence -q query instance=~<span class=\"string\">\".+0\"</span>)</span><br><span class=\"line\">$ amtool silence expire $(amtool silence query -q)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"Pushgateway\"><a href=\"#Pushgateway\" class=\"headerlink\" title=\"Pushgateway\"></a>Pushgateway</h3><p>描述: PushGateway 作为 Prometheus 生态中的一个重要一员，它允许任何客户端向其 Push 符合规范的自定义监控指标，并且可以允许临时任务和批处理作业向 Prometheus 公开其指标，再结合 Prometheus 统一收集监控。例如被采集的主机由于网络环境的限制无法直接到达Prometheus server,因此可以将其指标推送到 Pushgateway ,然后在由 Pushgateway 将这些指标公开给 Prometheus，其次是在监控业务数据的时候需要将不同数据汇总, 由 Prometheus 统一收集。<br>项目地址: <a href=\"https://github.com/prometheus/pushgateway\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/pushgateway</a></p>\n<p><br></p>\n<p><strong>应用场景:</strong> Prometheus 采用定时 Pull 模式，可能由于子网络或者防火墙的原因，不能直接拉取各个 Target 的指标数据，此时可以采用各个 Target 往 PushGateway 上 Push 数据，然后 Prometheus 去 PushGateway 上定时 pull。其次在监控各个业务数据时，需要将各个不同的业务数据进行统一汇总，此时也可以采用 PushGateway 来统一收集，然后 Prometheus 来统一拉取。</p>\n<p><br></p>\n<p><strong>Pushgateway 架构说明:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Batch Job - <span class=\"string\">\"Single push before exiting\"</span> -&gt; Pushgateway &lt;-  <span class=\"string\">\"Regular Scrapes - Prometheus</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Pushgateway 安装配置说明:</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认端口：9091</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Using Docker</span></span><br><span class=\"line\">docker pull prom/pushgateway</span><br><span class=\"line\">docker run -d -p 9091:9091 prom/pushgateway</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  补充系统服务进行启动alertmanager</span></span><br><span class=\"line\">sudo tee /usr/lib/systemd/system/pushgateway.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Prometheus pushgateway Server Systemd</span><br><span class=\"line\">Documentation=https://prometheus.io</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/pushgateway/pushgateway --web.listen-address=:9091</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo systemctl daemon-reload &amp;&amp; systemctl restart pushgateway.service</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>Pushgateway 补充说明:</strong></p>\n<ul>\n<li>1) 指标数据上传: 通过支持Prometheus的多种编程语言模块进行实现，例如Python中Prometheus_client中的<code>push_to_gateway / pushadd_to_gateway / delete_from_gateway</code>等函数，或者利用http请求进行上传例如linux中curl(后面实战部分会进行讲解)。</li>\n<li>2) 桥接: 因为测控和展示是独立的两件事，例如可以通过Go、python、Java客户端中Graphite桥接实现将指标输出数据转化为其他非Prometheus格式的数据，从而使得将指标转换为Graphite能够解读的格式数据输出。</li>\n<li>3) 解析器: 在客户端库注册表中访问到指标输出内容，以将Prometheus的指标数据输入到其他监控系统或者本地工具中，例如DataDog、InfluxDB、Sensu和Metricbeat该类系统由相应的组件可以解析这类脚本。</li>\n<li>4) 指标类型: 我们可以在Prometheus里的<code>/metrics</code>看到指标的HELP(对指标含义的描述)和TYPE(该指标的格式)。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.</span></span><br><span class=\"line\"><span class=\"comment\"># TYPE promhttp_metric_handler_requests_in_flight gauge</span></span><br><span class=\"line\">promhttp_metric_handler_requests_in_flight 1</span><br></pre></td></tr></table></figure></li>\n<li>5) 指标标签: 为该指标打上标签并且标签的排序并不重要，但是前缀指标相同的指标建议放在一处之中，可确保Prometheus最佳的写入性能。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">prometheus_test_seconds_sum&#123;label=<span class=\"string\">\"bar\"</span>,baz=<span class=\"string\">\"qu\"</span>&#125; 0</span><br><span class=\"line\">prometheus_test_seconds_count&#123;label=<span class=\"string\">\"bar\"</span>,baz=<span class=\"string\">\"quu\"</span>&#125; 1</span><br><span class=\"line\">prometheus_test_seconds_sum&#123;label=<span class=\"string\">\"flar\"</span>,baz=<span class=\"string\">\"qu\"</span>&#125; 2</span><br><span class=\"line\">prometheus_test_seconds_count&#123;label=<span class=\"string\">\"flar\"</span>,baz=<span class=\"string\">\"quu\"</span>&#125; 3</span><br></pre></td></tr></table></figure></li>\n<li>6) 编码格式: 默认的上传指标中的HELP和标签值均实验完整的UTF-8编码，因此需要反斜杠来进行转义特殊字符，<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># HELP : 下处是换行和反斜杠</span></span><br><span class=\"line\">HELP escaping Test newline \\\\n and backslash \\\\ escaped</span><br><span class=\"line\">TYPE escaping gauge</span><br><span class=\"line\"><span class=\"comment\"># LABLE : 下处是换行符、反斜杠和双引号</span></span><br><span class=\"line\">escaping&#123;foo=<span class=\"string\">\"newline \\n backslash \\\\ double quote \\\" \"</span>&#125; 1</span><br></pre></td></tr></table></figure></li>\n<li>7) 时间戳: 在上传的指标数据中可以标明时间戳(以毫秒为单位的整数值，它自UNIX纪元之后算起)，但是通常不要使用展示格式的时间戳，而是通过e指数来表示。</li>\n<li>8) 指标解析检查: 我们可以采用promtool进行检测我们上传到pushgateway中的指标数据的格式是否有效，所以通过上传的指标可以被抓取但并不意味该指标符合格式要求。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -s http://10.10.107.249:9091/metrics | promtool check metrics</span><br><span class=\"line\">test_metric counter metrics should have <span class=\"string\">\"_total\"</span> suffix</span><br><span class=\"line\">test_metric no <span class=\"built_in\">help</span> text</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>PushGateway 常用 RestFul 接口:</strong><br>描述: 常用方法有POST/PUT以及DELETE格式为<code>http://10.10.107.249:9091/metrics/job/{工作名称}/标签名称/标签内容</code>，注意<code>&lt;工作名称&gt;</code>是job标签的值，后面跟任意数量的标签对，instance标签可以有也可以没有。</p>\n<p>简单示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 1) Push a single sample(单个) into the group identified by &#123;job=\"some_job\"&#125; 以及指定指标的参数标签:</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"some_metric 3.14\"</span> | curl --data-binary @- http://10.10.107.249:9091/metrics/job/some_job</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"some_metric 3.14\"</span> | curl --data-binary @- http://10.10.107.249:9091/metrics/job/some_job/labels/demo_test</span><br><span class=\"line\">  <span class=\"comment\"># 输出结果</span></span><br><span class=\"line\">  <span class=\"comment\"># # TYPE some_metric untyped  # 注意这里的类型。</span></span><br><span class=\"line\">  <span class=\"comment\"># some_metric&#123;instance=\"\",job=\"some_job\",labels=\"demo_test\"&#125; 3.14</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 2) Push something more complex (复杂多个) into the group identified by &#123;job=\"some_job\",instance=\"some_instance\"&#125;:</span></span><br><span class=\"line\">cat &lt;&lt;EOF | curl --data-binary @- http://10.10.107.249:9091/metrics/job/some_job/instance/some_instance</span><br><span class=\"line\"><span class=\"comment\"># TYPE some_metric counter</span></span><br><span class=\"line\">some_metric&#123;label=<span class=\"string\">\"val1\"</span>&#125; 42</span><br><span class=\"line\"><span class=\"comment\"># TYPE another_metric gauge</span></span><br><span class=\"line\"><span class=\"comment\"># HELP another_metric Just an example.</span></span><br><span class=\"line\">another_metric 2398.283</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 3) 删除由标识的组中的所有度量 &#123;job=\"some_job\",instance=\"some_instance\"&#125; :</span></span><br><span class=\"line\">curl -X DELETE http://10.10.107.249:9091/metrics/job/some_job/instance/some_instance</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 4) 删除由标识的组中的所有指标&#123;job=\"some_job\"&#125;（请注意&#123;job=\"some_job\",instance=\"some_instance\"&#125;，即使这些指标具有相同的作业标签，该示例中也不包括该组中的指标）：</span></span><br><span class=\"line\">curl -X DELETE http://10.10.107.249:9091/metrics/job/some_job</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 5) 删除所有组中的所有指标（要求通过命令行标志启用admin API --web.enable-admin-api）</span></span><br><span class=\"line\">curl -X PUT http://10.10.107.249:9091/api/v1/admin/wipe</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210510123823.png\" alt=\"WeiyiGeek.利用CURL上传数据到pushgateway之中\" title=\"\" class=\"\">\n                <p>WeiyiGeek.利用CURL上传数据到pushgateway之中</p>\n            </figure>\n<p>Tips : Pushgateway显然不是聚合器或分布式计数器而是指标缓存,适用于服务级别指标。</p>\n<p>Tips : Pushgateway必须被配置为一个目标，由Prometheus使用一种常用的方法进行抓取。但是您应该始终在scrape config中设置<code>honor_labels: true</code></p>\n<p>Tips : 为了防止 pushgateway 重启或意外挂掉，导致数据丢失，可以通过 <code>-persistence.file</code> 和 <code>-persistence.interval</code> 参数将数据持久化下来。</p>\n<p>Tips : API所有的推送都是通过HTTP完成的界面有点像REST,例如:<code>/metrics/job/&lt;JOB_NAME&gt;{/&lt;LABEL_NAME&gt;/&lt;LABEL_VALUE&gt;}</code>, 参考地址:<a href=\"https://github.com/prometheus/pushgateway#api。\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/pushgateway#api。</a></p>\n<hr>\n<h2 id=\"0x01-配置文件\"><a href=\"#0x01-配置文件\" class=\"headerlink\" title=\"0x01 配置文件\"></a>0x01 配置文件</h2><h3 id=\"Prometheus-yml\"><a href=\"#Prometheus-yml\" class=\"headerlink\" title=\"Prometheus.yml\"></a>Prometheus.yml</h3><p>描述: 该配置文件为Prometheus的服务端配置文件,设置采集数据的主机以及采集器相关参数，在Prometheus启动时常常使用e <code>--config.file</code> 参数指定该配置文件的绝对路径。<br>帮助文档: <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/\" target=\"_blank\" rel=\"noopener\">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p>\n<p>Tips : 该文件以YAML格式编写，由下面描述的方案定义。括号表示参数是可选的。对于非列表参数，该值设置为指定的默认值。<br>Configuration file 主要配置对象:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* &lt;scrape_config&gt;</span><br><span class=\"line\">  * &lt;tls_config&gt;</span><br><span class=\"line\">  * &lt;azure_sd_config&gt;</span><br><span class=\"line\">  * &lt;consul_sd_config&gt;</span><br><span class=\"line\">  * &lt;digitalocean_sd_config&gt;</span><br><span class=\"line\">  * &lt;dockerswarm_sd_config&gt;</span><br><span class=\"line\">  * &lt;dns_sd_config&gt;</span><br><span class=\"line\">  * &lt;ec2_sd_config&gt;</span><br><span class=\"line\">  * &lt;openstack_sd_config&gt;</span><br><span class=\"line\">  * &lt;file_sd_config&gt;</span><br><span class=\"line\">  * &lt;gce_sd_config&gt;</span><br><span class=\"line\">  * &lt;hetzner_sd_config&gt;</span><br><span class=\"line\">  * &lt;kubernetes_sd_config&gt;</span><br><span class=\"line\">  * &lt;marathon_sd_config&gt;</span><br><span class=\"line\">  * &lt;nerve_sd_config&gt;</span><br><span class=\"line\">  * &lt;serverset_sd_config&gt;</span><br><span class=\"line\">  * &lt;triton_sd_config&gt;</span><br><span class=\"line\">  * &lt;eureka_sd_config&gt;</span><br><span class=\"line\">  * &lt;scaleway_sd_config&gt;</span><br><span class=\"line\">  * &lt;static_config&gt;</span><br><span class=\"line\">  * &lt;relabel_config&gt;</span><br><span class=\"line\">  * &lt;metric_relabel_configs&gt;</span><br><span class=\"line\">* &lt;alert_relabel_configs&gt;</span><br><span class=\"line\">* &lt;alertmanager_config&gt;</span><br><span class=\"line\">* &lt;remote_write&gt;</span><br><span class=\"line\">* &lt;remote_read&gt;</span><br></pre></td></tr></table></figure></p>\n<p>Tips : 通用占位符定义如下：</p>\n<ul>\n<li><code>&lt;boolean&gt;</code>: a boolean that can take the values true or false</li>\n<li><code>&lt;duration&gt;</code>: a duration matching the regular expression <code>((([0-9]+)y)?(([0-9]+)w)?(([0-9]+)d)?(([0-9]+)h)?(([0-9]+)m)?(([0-9]+)s)?(([0-9]+)ms)?|0)</code>, e.g. 1d, 1h30m, 5m, 10s</li>\n<li><code>&lt;filename&gt;</code>: a valid path in the current working directory</li>\n<li><code>&lt;host&gt;</code>: a valid string consisting of a hostname or IP followed by an optional port number</li>\n<li><code>&lt;int&gt;</code>: an integer value</li>\n<li><code>&lt;labelname&gt;:</code> a string matching the regular expression [a-zA-Z_][a-zA-Z0-9_]*</li>\n<li><code>&lt;labelvalue&gt;</code>: a string of unicode characters</li>\n<li><code>&lt;path&gt;</code>: a valid URL path</li>\n<li><code>&lt;scheme&gt;</code>: a string that can take the values http or https</li>\n<li><code>&lt;secret&gt;</code>: a regular string that is a secret, such as a password</li>\n<li><code>&lt;string&gt;</code>: a regular string</li>\n<li><code>&lt;tmpl_string&gt;:</code> a string which is template-expanded before usage</li>\n</ul>\n<p><br/></p>\n<h4 id=\"1-语法格式\"><a href=\"#1-语法格式\" class=\"headerlink\" title=\"(1) 语法格式\"></a>(1) 语法格式</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 全局配置指定在所有其他配置上下文中有效的参数</span></span><br><span class=\"line\">global:</span><br><span class=\"line\">  [ scrape_interval: &lt;duration&gt; | default = 1m ]     <span class=\"comment\"># 默认情况下刮取目标的频率。</span></span><br><span class=\"line\">  [ scrape_timeout: &lt;duration&gt; | default = 10s ]     <span class=\"comment\"># 刮取请求超时的时间。</span></span><br><span class=\"line\">  [ evaluation_interval: &lt;duration&gt; | default = 1m ] <span class=\"comment\"># 评估规则的频率。</span></span><br><span class=\"line\">  external_labels: <span class=\"comment\"># 与任何时间序列或警报通信时要添加的标签,外部系统（联合、远程存储、Alertmanager）。</span></span><br><span class=\"line\">    [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]</span><br><span class=\"line\">  [ query_log_file: &lt;string&gt; ] <span class=\"comment\"># #PromQL查询记录到的文件,重新加载配置将重新打开文件。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 从所有匹配的文件中读取监控规则与警报规则。</span></span><br><span class=\"line\">rule_files:</span><br><span class=\"line\">  [ - &lt;filepath_glob&gt; ... ]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#- 警报指定与Alertmanager相关的设置。</span></span><br><span class=\"line\">alerting:</span><br><span class=\"line\">  alert_relabel_configs: <span class=\"comment\"># - 警报重新标记在发送到Alertmanager之前应用于警报,用途是确保一对具有不同外部标签的Prometheus服务器发送相同的警报。</span></span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">    [ timeout: &lt;duration&gt; | default = 10s ]     <span class=\"comment\"># Per-target Alertmanager timeout when pushing alerts.</span></span><br><span class=\"line\">    [ api_version: &lt;string&gt; | default = v2 ]    <span class=\"comment\"># The api version of Alertmanager.</span></span><br><span class=\"line\">    [ path_prefix: &lt;path&gt; | default = / ]       <span class=\"comment\"># Prefix for the HTTP path alerts are pushed to.</span></span><br><span class=\"line\">    [ scheme: &lt;scheme&gt; | default = http ]       <span class=\"comment\"># Configures the protocol scheme used for requests.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 与远程写入功能相关的设置。将其应用到远程端点,写重新标记应用于外部标签之后还可限制发送的样本</span></span><br><span class=\"line\">remote_write:</span><br><span class=\"line\">  [ name: &lt;string&gt; ] <span class=\"comment\"># 远程写入配置的名称，如果指定，则该名称在远程写入配置中必须是唯一的。</span></span><br><span class=\"line\">  url: &lt;string&gt;      <span class=\"comment\"># 要向其发送示例的终结点的URL。</span></span><br><span class=\"line\">  [ remote_timeout: &lt;duration&gt; | default = 30s ]</span><br><span class=\"line\">  headers:  <span class=\"comment\"># 与每个远程写入请求一起发送的自定义HTTP头，主要自己设置的标题不能被覆盖。</span></span><br><span class=\"line\">    [ &lt;string&gt;: &lt;string&gt; ... ]</span><br><span class=\"line\">  write_relabel_configs:  <span class=\"comment\"># #远程写重新标记配置的列表。</span></span><br><span class=\"line\">    [ - &lt;relabel_config&gt; ... ]</span><br><span class=\"line\">  queue_config:    <span class=\"comment\"># 配置用于写入远程存储的队列。 </span></span><br><span class=\"line\">  <span class=\"comment\"># Number of samples to buffer per shard before we block reading of more</span></span><br><span class=\"line\">  <span class=\"comment\"># samples from the WAL. It is recommended to have enough capacity in each</span></span><br><span class=\"line\">  <span class=\"comment\"># shard to buffer several requests to keep throughput up while processing</span></span><br><span class=\"line\">  <span class=\"comment\"># occasional slow remote requests.</span></span><br><span class=\"line\">  [ capacity: &lt;int&gt; | default = 2500 ]</span><br><span class=\"line\">  <span class=\"comment\"># Maximum number of shards, i.e. amount of concurrency.</span></span><br><span class=\"line\">  [ max_shards: &lt;int&gt; | default = 200 ]</span><br><span class=\"line\">  <span class=\"comment\"># Minimum number of shards, i.e. amount of concurrency.</span></span><br><span class=\"line\">  [ min_shards: &lt;int&gt; | default = 1 ]</span><br><span class=\"line\">  <span class=\"comment\"># Maximum number of samples per send.</span></span><br><span class=\"line\">  [ max_samples_per_send: &lt;int&gt; | default = 500]</span><br><span class=\"line\">  <span class=\"comment\"># Maximum time a sample will wait in buffer.</span></span><br><span class=\"line\">  [ batch_send_deadline: &lt;duration&gt; | default = 5s ]</span><br><span class=\"line\">  <span class=\"comment\"># Initial retry delay. Gets doubled for every retry.</span></span><br><span class=\"line\">  [ min_backoff: &lt;duration&gt; | default = 30ms ]</span><br><span class=\"line\">  <span class=\"comment\"># Maximum retry delay.</span></span><br><span class=\"line\">  [ max_backoff: &lt;duration&gt; | default = 100ms ]</span><br><span class=\"line\">  <span class=\"comment\"># Retry upon receiving a 429 status code from the remote-write storage.</span></span><br><span class=\"line\">  <span class=\"comment\"># This is experimental and might change in the future.</span></span><br><span class=\"line\">  [ retry_on_http_429: &lt;boolean&gt; | default = <span class=\"literal\">false</span> ]</span><br><span class=\"line\"></span><br><span class=\"line\">  metadata_config:   <span class=\"comment\"># 配置向远程存储发送序列元数据(随时可能更改或在将来的版本中删除。)</span></span><br><span class=\"line\">    <span class=\"comment\"># Whether metric metadata is sent to remote storage or not.</span></span><br><span class=\"line\">    [ send: &lt;boolean&gt; | default = <span class=\"literal\">true</span> ]</span><br><span class=\"line\">    <span class=\"comment\"># How frequently metric metadata is sent to remote storage.</span></span><br><span class=\"line\">    [ send_interval: &lt;duration&gt; | default = 1m ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 与远程读取功能相关的设置(键值对参数设置与上述基本一致)</span></span><br><span class=\"line\">remote_read:</span><br><span class=\"line\">  [ - &lt;remote_read&gt; ... ]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 指定了一组目标和描述如何获取它们的参数(刮擦配置列表)。</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  [ - &lt;scrape_config&gt; ... ]</span><br><span class=\"line\">    job_name: &lt;job_name&gt;     <span class=\"comment\"># 采集对象的作业名称。</span></span><br><span class=\"line\">    [ scrape_interval: &lt;duration&gt; | default = &lt;global_config.scrape_interval&gt; ] <span class=\"comment\"># job局部刮取目标的频率。</span></span><br><span class=\"line\">    [ scrape_timeout: &lt;duration&gt; | default = &lt;global_config.scrape_timeout&gt; ]   <span class=\"comment\"># job局部请求超时的时间。</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># honor_labels 处理标签之间的冲突注意(“作业”和“实例”标签，手动配置的目标标签，以及由服务发现实现生成的标签）。</span></span><br><span class=\"line\">    <span class=\"comment\"># 将pushu labels设置为“true”对于诸如联合和清除Pushgateway之类的用例非常有用，在这些用例中，应该保留在目标中指定的所有标签。</span></span><br><span class=\"line\">    [ honor_labels: &lt;boolean&gt; | default = <span class=\"literal\">false</span> ]  <span class=\"comment\"># 如为true则保存冲突标签</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># honor_timestamps 是否信任被刮取的数据上的时间戳。</span></span><br><span class=\"line\">    [ honor_timestamps: &lt;boolean&gt; | default = <span class=\"literal\">true</span> ]   <span class=\"comment\"># 如果将timestamps设置为“true”，则将使用目标公开的度量的时间戳。</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [ scheme: &lt;scheme&gt; | default = http ]         <span class=\"comment\"># 目标拉取协议(https|http)</span></span><br><span class=\"line\">    [ metrics_path: &lt;path&gt; | default = /metrics ] <span class=\"comment\"># 从目标获取度量的HTTP资源路径。</span></span><br><span class=\"line\">    params:                                       <span class=\"comment\"># (可选的)HTTP URL参数。</span></span><br><span class=\"line\">      [ &lt;string&gt;: [&lt;string&gt;, ...] ]</span><br><span class=\"line\">    authorization:     <span class=\"comment\"># 使用配置的凭据在每个scrape请求上设置“Authorization”头。</span></span><br><span class=\"line\">      <span class=\"comment\"># Sets the authentication type of the request.</span></span><br><span class=\"line\">      [ <span class=\"built_in\">type</span>: &lt;string&gt; | default: Bearer ]</span><br><span class=\"line\">      <span class=\"comment\"># Sets the credentials of the request. It is mutually exclusive with `credentials_file`.</span></span><br><span class=\"line\">      [ credentials: &lt;secret&gt; ]</span><br><span class=\"line\">      <span class=\"comment\"># Sets the credentials of the request with the credentials read from the  configured file. It is mutually exclusive with `credentials`.</span></span><br><span class=\"line\">      [ credentials_file: &lt;filename&gt; ]</span><br><span class=\"line\">    basic_auth:  <span class=\"comment\"># 使用配置的用户名和密码在每个scrape请求上设置“Authorization”头。</span></span><br><span class=\"line\">      [ username: &lt;string&gt; ]</span><br><span class=\"line\">      [ password: &lt;secret&gt; ]  <span class=\"comment\"># 密码和密码文件是互斥的。</span></span><br><span class=\"line\">      [ password_file: &lt;string&gt; ]</span><br><span class=\"line\"></span><br><span class=\"line\">    [ follow_redirects: &lt;bool&gt; | default = <span class=\"literal\">true</span> ] <span class=\"comment\"># 配置刮取请求是否遵循HTTP 3xx重定向。</span></span><br><span class=\"line\"></span><br><span class=\"line\">    tls_config:             <span class=\"comment\"># 请求站点的SSL证书(tls连接)设置</span></span><br><span class=\"line\">      [ &lt;tls_config&gt; ]</span><br><span class=\"line\">        [ ca_file: &lt;filename&gt; ]     <span class=\"comment\"># 用于验证API服务器证书的CA证书。</span></span><br><span class=\"line\">        [ cert_file: &lt;filename&gt; ]   <span class=\"comment\"># 用于向服务器进行客户端证书身份验证的证书和密钥文件。</span></span><br><span class=\"line\">        [ key_file: &lt;filename&gt; ]</span><br><span class=\"line\">        [ server_name: &lt;string&gt; ]   <span class=\"comment\"># 用于指示服务器的名称(https://tools.ietf.org/html/rfc4366#section-3.1)</span></span><br><span class=\"line\">        [ insecure_skip_verify: &lt;boolean&gt; ] <span class=\"comment\"># 禁用服务器证书验证。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    [ proxy_url: &lt;string&gt; ]  <span class=\"comment\"># 代理设置</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># - 设置多种服务发现方式(详情参考上面的URL),这里主要讲解最常用的file_sd_config和kubernetes_sd_configs配置</span></span><br><span class=\"line\">    <span class=\"comment\"># 基于文件的服务发现提供了一种更通用的方法来配置静态目标，并充当插入自定义服务发现机制的接口(文件可以YAML或JSON格式提供,格式样例看下面的tips)。</span></span><br><span class=\"line\">    file_sd_configs:  <span class=\"comment\">#它读取一组包含零个或多个&lt;static_config&gt;列表的文件。</span></span><br><span class=\"line\">      - files:</span><br><span class=\"line\">        - my/path/tg_*.json</span><br><span class=\"line\">        [ refresh_interval: &lt;duration&gt; | default = 5m ] <span class=\"comment\"># 该静态文件刷新时间间隔</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 基于kubernetes的服务发现,允许从 Kubernetes' REST API 拉取集群pod相关信息并时刻保持同步。</span></span><br><span class=\"line\">    kubernetes_sd_configs:</span><br><span class=\"line\">      [ api_server: &lt;host&gt; ]  </span><br><span class=\"line\">      role: &lt;string&gt;  <span class=\"comment\"># One of endpoints, service, pod, node, or ingress.</span></span><br><span class=\"line\">      namespaces:     <span class=\"comment\">#可选命名空间发现。如果省略则使用所有名称空间。</span></span><br><span class=\"line\">        names:</span><br><span class=\"line\">          [ - &lt;string&gt; ]</span><br><span class=\"line\">      <span class=\"comment\"># 可选的标签和字段选择器，用于将发现过程限制为可用资源的子集。</span></span><br><span class=\"line\">      [ selectors:</span><br><span class=\"line\">        [ - role: &lt;string&gt;</span><br><span class=\"line\">          [ label: &lt;string&gt; ]</span><br><span class=\"line\">          [ field: &lt;string&gt; ] ]]</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 用于向API服务器进行身份验证的可选身份验证信息。</span></span><br><span class=\"line\">      tls_config:  <span class=\"comment\"># tls 访问必须设置</span></span><br><span class=\"line\">        [ &lt;tls_config&gt; ]</span><br><span class=\"line\">      basic_auth:</span><br><span class=\"line\">        [ username: &lt;string&gt; ]</span><br><span class=\"line\">        [ password: &lt;secret&gt; ] | [ password_file: &lt;string&gt; ]</span><br><span class=\"line\">      authorization:</span><br><span class=\"line\">      <span class=\"comment\"># Sets the authentication type.</span></span><br><span class=\"line\">      [ <span class=\"built_in\">type</span>: &lt;string&gt; | default: Bearer ]  <span class=\"comment\"># 设置身份验证类型。</span></span><br><span class=\"line\">      <span class=\"comment\"># 设置凭据。它与“凭证文件”互斥。</span></span><br><span class=\"line\">      [ credentials: &lt;secret&gt; ] | [ credentials_file: &lt;filename&gt; ]</span><br><span class=\"line\">      </span><br><span class=\"line\">    <span class=\"comment\"># ----------------------------------------------------------------------- #</span></span><br><span class=\"line\">    <span class=\"comment\"># List of Azure service discovery configurations.</span></span><br><span class=\"line\">    azure_sd_configs:</span><br><span class=\"line\">      [ - &lt;azure_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of Consul service discovery configurations.</span></span><br><span class=\"line\">    consul_sd_configs:</span><br><span class=\"line\">      [ - &lt;consul_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of DigitalOcean service discovery configurations.</span></span><br><span class=\"line\">    digitalocean_sd_configs:</span><br><span class=\"line\">      [ - &lt;digitalocean_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of Docker Swarm service discovery configurations.</span></span><br><span class=\"line\">    dockerswarm_sd_configs:</span><br><span class=\"line\">      [ - &lt;dockerswarm_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of DNS service discovery configurations.</span></span><br><span class=\"line\">    dns_sd_configs:</span><br><span class=\"line\">      [ - &lt;dns_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of EC2 service discovery configurations.</span></span><br><span class=\"line\">    ec2_sd_configs:</span><br><span class=\"line\">      [ - &lt;ec2_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of Eureka service discovery configurations.</span></span><br><span class=\"line\">    eureka_sd_configs:</span><br><span class=\"line\">      [ - &lt;eureka_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of GCE service discovery configurations.</span></span><br><span class=\"line\">    gce_sd_configs:</span><br><span class=\"line\">      [ - &lt;gce_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of Hetzner service discovery configurations.</span></span><br><span class=\"line\">    hetzner_sd_configs:</span><br><span class=\"line\">      [ - &lt;hetzner_sd_config&gt; ... ]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># List of Marathon service discovery configurations.</span></span><br><span class=\"line\">    marathon_sd_configs:</span><br><span class=\"line\">      [ - &lt;marathon_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of AirBnB's Nerve service discovery configurations.</span></span><br><span class=\"line\">    nerve_sd_configs:</span><br><span class=\"line\">      [ - &lt;nerve_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of OpenStack service discovery configurations.</span></span><br><span class=\"line\">    openstack_sd_configs:</span><br><span class=\"line\">      [ - &lt;openstack_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of Scaleway service discovery configurations.</span></span><br><span class=\"line\">    scaleway_sd_configs:</span><br><span class=\"line\">      [ - &lt;scaleway_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of Zookeeper Serverset service discovery configurations.</span></span><br><span class=\"line\">    serverset_sd_configs:</span><br><span class=\"line\">      [ - &lt;serverset_sd_config&gt; ... ]</span><br><span class=\"line\">    <span class=\"comment\"># List of Triton service discovery configurations.</span></span><br><span class=\"line\">    triton_sd_configs:</span><br><span class=\"line\">      [ - &lt;triton_sd_config&gt; ... ]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># - 在scrape配置中指定静态目标的规范方法,允许指定目标列表和它们的公共标签集</span></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">    - targets: [<span class=\"string\">'localhost:9090'</span>, <span class=\"string\">'localhost:9191'</span>]</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># - 重新标记是一个强大的工具，可以在目标被刮除之前动态重写它的标签集(重点)</span></span><br><span class=\"line\">    relabel_configs:</span><br><span class=\"line\">      [ source_labels: <span class=\"string\">'['</span> &lt;labelname&gt; [, ...] <span class=\"string\">']'</span> ]       <span class=\"comment\"># 源标签从现有标签中选择值</span></span><br><span class=\"line\">      [ separator: &lt;string&gt; | default = ; ]      <span class=\"comment\"># 源标签从现有标签中选择值</span></span><br><span class=\"line\">      [ regex: &lt;regex&gt; | default = (.*);([^:].) ] <span class=\"comment\"># 与提取的值匹配的正则表达式。</span></span><br><span class=\"line\">      [ modulus: &lt;int&gt; ]  <span class=\"comment\"># 取源标签值散列的模数。</span></span><br><span class=\"line\">      [ replacement: &lt;string&gt; | default = <span class=\"variable\">$1</span> ] <span class=\"comment\"># - 如果正则表达式匹配，则对其执行正则表达式替换的替换值。</span></span><br><span class=\"line\">      [ action: &lt;relabel_action&gt; | default = replace ] <span class=\"comment\"># 基于正则表达式匹配执行的操作, 可选actions (replace, keep, drop, labelmap,labeldrop and labelkeep) 最后详细介绍。</span></span><br><span class=\"line\">      [ target_label: &lt;labelname&gt; ]  <span class=\"comment\"># 在替换操作中写入结果值的标签,对于替换操作是强制性的</span></span><br><span class=\"line\"></span><br><span class=\"line\">    metric_relabel_configs:   <span class=\"comment\"># - 公制重新标记配置的列表,用途是排除成本太高而无法摄取的时间序列。</span></span><br><span class=\"line\"></span><br><span class=\"line\">    [ sample_limit: &lt;int&gt; | default = 0 ]  <span class=\"comment\"># 每次刮取将被接受的刮取样品数量限制(0 means no limit)。</span></span><br><span class=\"line\">    [ target_limit: &lt;int&gt; | default = 0 ]  <span class=\"comment\"># 每个scrape配置将接受的唯一目标数限制(0 means no limit)。</span></span><br></pre></td></tr></table></figure>\n<p>Tips : 文件必须包含使用以下格式的静态配置列表;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JSON json [ &#123; <span class=\"string\">\"targets\"</span>: [ <span class=\"string\">\"&lt;host&gt;\"</span>, ... ], <span class=\"string\">\"labels\"</span>: &#123; <span class=\"string\">\"&lt;labelname&gt;\"</span>: <span class=\"string\">\"&lt;labelvalue&gt;\"</span>, ... &#125; &#125;, ... ]</span><br><span class=\"line\">YAML yaml - targets: [ - <span class=\"string\">'&lt;host&gt;'</span> ] labels: [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]</span><br></pre></td></tr></table></figure></p>\n<p>Tips : 在 Prometheus监控kubernetes允许从以下role之一方式进行目标的发现;</p>\n<ul>\n<li><p><code>node</code> : 为每个群集节点发现一个目标，其地址默认为Kubelet的HTTP端口，地址类型顺序: <code>NodeInternalIP, NodeExternalIP, NodeLegacyHostIP, and NodeHostName.</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Available meta labels: 此外instance节点的标签将设置为从API服务器检索到的节点名。</span></span><br><span class=\"line\">__meta_kubernetes_node_name：节点对象的名称</span><br><span class=\"line\">__meta_kubernetes_node_label_&lt;labelname&gt;：节点对象中的每个标签。</span><br><span class=\"line\">__meta_kubernetes_node_labelpresent_&lt;labelname&gt; :是的对于节点对象中的每个标签。</span><br><span class=\"line\">__meta_kubernetes_node_annotation_&lt;annotationname&gt;：来自节点对象的每个注释。</span><br><span class=\"line\">__meta_kubernetes_node_annotationpresent_&lt;annotationname&gt; :是的对于节点对象中的每个注释。</span><br><span class=\"line\">__meta_kubernetes_node_address_&lt;address_type&gt;：每个节点地址类型的第一个地址（如果存在）。</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>service</code> : 为每个服务的每个服务端口发现一个目标。这对于服务的黑盒监视通常很有用。地址将设置为服务的Kubernetes DNS名称和相应的服务端口。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__meta_kubernetes_namespace：服务对象的命名空间。</span><br><span class=\"line\">__meta_kubernetes_service_annotation_&lt;annotationname&gt;：来自服务对象的每个批注。</span><br><span class=\"line\">__meta_kubernetes_service_annotationpresent_&lt;annotationname&gt;：“<span class=\"literal\">true</span>”表示服务对象的每个注释。</span><br><span class=\"line\">__meta_kubernetes_service_cluster_ip：服务的群集IP地址(不适用于ExternalName类型的服务）</span><br><span class=\"line\">__meta_kubernetes_service_external_name：服务的DNS名称(适用于ExternalName类型的服务）</span><br><span class=\"line\">__meta_kubernetes_service_label_&lt;labelname&gt;：来自服务对象的每个标签。</span><br><span class=\"line\">__meta_kubernetes_service_labelpresent_&lt;labelname&gt; :是的对于服务对象的每个标签。</span><br><span class=\"line\">__meta_kubernetes_service_name：服务对象的名称</span><br><span class=\"line\">__meta_kubernetes_service_port_name：目标的服务端口的名称。</span><br><span class=\"line\">__meta_kubernetes_service_port_protocol：目标的服务端口的协议。</span><br><span class=\"line\">__meta_kubernetes_service_type：服务的类型</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>pod</code> : 发现所有pod并将其容器作为目标公开。对于容器的每个声明端口，生成一个单独的目标。如果容器没有指定的端口，则为每个容器创建一个端口空闲目标，以便通过重新标记手动添加端口。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__meta_kubernetes_namespace：pod对象的命名空间。</span><br><span class=\"line\">__meta_kubernetes_pod_name：pod对象的名称</span><br><span class=\"line\">__meta_kubernetes_pod_ip：pod对象的pod IP。</span><br><span class=\"line\">__meta_kubernetes_pod_label_&lt;labelname&gt;：pod对象中的每个标签。</span><br><span class=\"line\">__meta_kubernetes_pod_labelpresent_&lt;labelname&gt; :是的对于pod对象中的每个标签。</span><br><span class=\"line\">__meta_kubernetes_pod_annotation_&lt;annotationname&gt;：pod对象中的每个注释。</span><br><span class=\"line\">__meta_kubernetes_pod_annotationpresent_&lt;annotationname&gt; :是的对于pod对象的每个注释。</span><br><span class=\"line\">__meta_kubernetes_pod_container_init :是的如果容器是 初始化容器</span><br><span class=\"line\">__meta_kubernetes_pod_container_name：目标地址指向的容器的名称。</span><br><span class=\"line\">__meta_kubernetes_pod_container_port_name：容器端口的名称</span><br><span class=\"line\">__meta_kubernetes_pod_container_port_number：集装箱端口号</span><br><span class=\"line\">__meta_kubernetes_pod_container_port_protocol：集装箱港口的协议</span><br><span class=\"line\">__meta_kubernetes_pod_ready：设置为是的或<span class=\"literal\">false</span>吊舱准备就绪</span><br><span class=\"line\">__meta_kubernetes_pod_phase：设置为悬而未决的 ,Running ,成功 ,Failed或未知在生命周期 .</span><br><span class=\"line\">__meta_kubernetes_pod_node_name：pod被调度到的节点的名称。</span><br><span class=\"line\">__meta_kubernetes_pod_host_ip：pod对象的当前主机IP。</span><br><span class=\"line\">__meta_kubernetes_pod_uid：pod对象的UID。</span><br><span class=\"line\">__meta_kubernetes_pod_controller_kind：pod控制器的对象类型。</span><br><span class=\"line\">__meta_kubernetes_pod_controller_name：吊舱控制器的名称</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>endpoints : 从服务的列出的终结点发现目标。对于每个endpointaddress，每个端口都会发现一个目标。如果端点由一个pod支持，那么pod的所有附加容器端口（未绑定到端点端口）也会被发现作为目标。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__meta_kubernetes_namespace：endpoints对象的命名空间。</span><br><span class=\"line\">__meta_kubernetes_endpoints_name：endpoints对象的名称。</span><br><span class=\"line\">对于直接从端点列表中发现的所有目标（未从底层POD中额外推断出的目标），将附加以下标签：</span><br><span class=\"line\">__meta_kubernetes_endpoint_hostname：终结点的主机名</span><br><span class=\"line\">__meta_kubernetes_endpoint_node_name：承载终结点的节点的名称。</span><br><span class=\"line\">__meta_kubernetes_endpoint_ready：设置为是的或<span class=\"literal\">false</span>对于端点的就绪状态</span><br><span class=\"line\">__meta_kubernetes_endpoint_port_name：终结点端口的名称</span><br><span class=\"line\">__meta_kubernetes_endpoint_port_protocol：终结点端口的协议</span><br><span class=\"line\">__meta_kubernetes_endpoint_address_target_kind：终结点地址目标的类型。</span><br><span class=\"line\">__meta_kubernetes_endpoint_address_target_name：终结点地址目标的名称。</span><br><span class=\"line\">如果端点属于服务，则role: service发现已附加</span><br><span class=\"line\">对于由吊舱支持的所有目标role: pod发现已附加</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ingress : 为每个入口的每个路径发现一个目标。这通常对黑盒监控入口很有用地址将设置为入口规范中指定的主机。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__meta_kubernetes_namespace：ingress对象的命名空间。</span><br><span class=\"line\">__meta_kubernetes_ingress_name -入口对象的名称</span><br><span class=\"line\">__meta_kubernetes_ingress_label_&lt;labelname&gt;：来自ingress对象的每个标签。</span><br><span class=\"line\">__meta_kubernetes_ingress_labelpresent_&lt;labelname&gt; :是的对于ingress对象中的每个标签。</span><br><span class=\"line\">__meta_kubernetes_ingress_annotation_&lt;annotationname&gt;：来自ingress对象的每个注释。</span><br><span class=\"line\">__meta_kubernetes_ingress_annotationpresent_&lt;annotationname&gt; :是的对于ingress对象的每个注释。</span><br><span class=\"line\">__meta_kubernetes_ingress_scheme：入口协议方案，https如果设置了TLSconfig。默认为http .</span><br><span class=\"line\">__meta_kubernetes_ingress_path：从入口规范的路径默认为 / .</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : relabel_config 对象中<code>&lt;relabel_action&gt;</code>确定要执行的重新标记操作：</p>\n<ul>\n<li><code>replace</code>：匹配<code>正则表达式</code>针对串联的<code>source_labels</code>. 然后，集合<code>目标_标签</code>到<code>replacement</code>，具有匹配组引用(<code>${1}</code> ,<code>${2}</code>，…）在<code>替换</code>被它们的价值所取代。如果<code>regex</code>不匹配，不进行替换</li>\n<li><code>keep</code>为哪个目标删除<code>正则表达式</code>与连接的不匹配<code>source_labels</code> .</li>\n<li><code>drop</code>为哪个目标删除<code>正则表达式</code>匹配连接的<code>source_labels</code> .</li>\n<li><code>hashmod</code>：套<code>目标_标签</code>致<code>modulus</code> 连接的<code>源代码标签</code> .</li>\n<li><code>labelmap</code>：匹配<code>正则表达式</code>所有的标签名称，然后将匹配标签的值复制到<code>replacement</code>具有匹配组引用(<code>${1}</code> ,<code>${2}</code>，…）在<code>替换</code>被它们的价值所取代</li>\n<li><code>labeldrop</code>：匹配<code>正则表达式</code>所有的标签名称。任何匹配的标签都将从标签集中删除。</li>\n<li><code>labelkeep</code>：匹配<code>正则表达式</code>所有的标签名称。任何不匹配的标签将从标签集中删除。</li>\n</ul>\n<p>必须小心<code>labeldrop</code>和<code>labelkeep</code>以确保一旦标签被移除，度量仍然是唯一的。</p>\n<p><br/></p>\n<h4 id=\"2-基础示例\"><a href=\"#2-基础示例\" class=\"headerlink\" title=\"(2) 基础示例\"></a>(2) 基础示例</h4><ul>\n<li>2.1) 基本常规监控 global config 的yaml文件示例<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 全局配置</span></span><br><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span> <span class=\"number\">60</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_timeout:</span> <span class=\"number\">10</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  evaluation_interval:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  external_labels:</span></span><br><span class=\"line\"><span class=\"attr\">    monitor:</span> <span class=\"string\">codelab</span></span><br><span class=\"line\"><span class=\"attr\">    foo:</span>     <span class=\"string\">bar</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 监控报警规则</span></span><br><span class=\"line\"><span class=\"attr\">rule_files:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">\"mysql-alter.rules\"</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">\"./rules/*-alter.rules\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 报警管理服务设置</span></span><br><span class=\"line\"><span class=\"attr\">alerting:</span></span><br><span class=\"line\"><span class=\"attr\">  alertmanagers:</span></span><br><span class=\"line\"><span class=\"attr\">  - scheme:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">    static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - targets:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">[\"1.2.3.4:9093\",\"1.2.3.5:9093\",\"1.2.3.6:9093\"]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 在使用 pushgateway 组件时使用</span></span><br><span class=\"line\"><span class=\"attr\">remote_write:</span></span><br><span class=\"line\"><span class=\"attr\">  - url:</span> <span class=\"attr\">http://remote1/push</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">drop_expensive</span></span><br><span class=\"line\"><span class=\"attr\">    write_relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - source_labels:</span> <span class=\"string\">[__name__]</span></span><br><span class=\"line\"><span class=\"attr\">      regex:</span>         <span class=\"string\">expensive.*</span></span><br><span class=\"line\"><span class=\"attr\">      action:</span>        <span class=\"string\">drop</span></span><br><span class=\"line\"><span class=\"attr\">  - url:</span> <span class=\"attr\">https://remote2/push</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">rw_tls</span></span><br><span class=\"line\"><span class=\"attr\">    headers:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">value</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">      cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">      key_file:</span> <span class=\"string\">valid_key_file</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">remote_read:</span></span><br><span class=\"line\"><span class=\"attr\">  - url:</span> <span class=\"attr\">http://remote1/read</span></span><br><span class=\"line\"><span class=\"attr\">    read_recent:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">  - url:</span> <span class=\"attr\">https://remote3/read</span></span><br><span class=\"line\"><span class=\"attr\">    read_recent:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">read_special</span></span><br><span class=\"line\"><span class=\"attr\">    required_matchers:</span></span><br><span class=\"line\"><span class=\"attr\">      job:</span> <span class=\"string\">special</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">      cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">      key_file:</span> <span class=\"string\">valid_key_file</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - scrape 配置 (重点)</span></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务1</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">  <span class=\"comment\"># scrape_interval is defined by the configured global (60s).</span></span><br><span class=\"line\">  <span class=\"comment\"># scrape_timeout is defined by the global default (10s).</span></span><br><span class=\"line\"><span class=\"attr\">  honor_labels:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">  metrics_path:</span> <span class=\"string\">'/metrics'</span></span><br><span class=\"line\"><span class=\"attr\">  scheme:</span> <span class=\"string\">'http'</span></span><br><span class=\"line\"><span class=\"attr\">  file_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - files:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">foo/*.slow.json</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">foo/*.slow.yml</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">single/file.yml</span></span><br><span class=\"line\"><span class=\"attr\">      refresh_interval:</span> <span class=\"number\">10</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    - files:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">bar/*.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - targets:</span> <span class=\"string\">['localhost:9090',</span> <span class=\"string\">'localhost:9191'</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      key1:</span> <span class=\"string\">label</span></span><br><span class=\"line\"><span class=\"attr\">      your:</span> <span class=\"string\">label</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[job,</span> <span class=\"string\">__meta_dns_name]</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"string\">(.*)some-[regex]</span></span><br><span class=\"line\"><span class=\"attr\">    target_label:</span>  <span class=\"string\">job</span></span><br><span class=\"line\"><span class=\"attr\">    replacement:</span>   <span class=\"string\">foo-$&#123;1&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    action:</span> <span class=\"string\">'replace'</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[abc]</span></span><br><span class=\"line\"><span class=\"attr\">    target_label:</span>  <span class=\"string\">cde</span></span><br><span class=\"line\"><span class=\"attr\">  - replacement:</span>   <span class=\"string\">static</span></span><br><span class=\"line\"><span class=\"attr\">    target_label:</span>  <span class=\"string\">abc</span></span><br><span class=\"line\"><span class=\"attr\">  - regex:</span></span><br><span class=\"line\"><span class=\"attr\">    replacement:</span>   <span class=\"string\">static</span></span><br><span class=\"line\"><span class=\"attr\">    target_label:</span>  <span class=\"string\">abc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  authorization:</span></span><br><span class=\"line\"><span class=\"attr\">    credentials_file:</span> <span class=\"string\">valid_token_file</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务2</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-x</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_interval:</span> <span class=\"number\">50</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  scrape_timeout:</span>  <span class=\"number\">5</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  sample_limit:</span> <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"attr\">  metrics_path:</span> <span class=\"string\">/my_path</span></span><br><span class=\"line\"><span class=\"attr\">  scheme:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">  basic_auth:</span></span><br><span class=\"line\"><span class=\"attr\">    username:</span> <span class=\"string\">admin_name</span></span><br><span class=\"line\"><span class=\"attr\">    password:</span> <span class=\"string\">\"multiline\\nmysecret\\ntest\"</span></span><br><span class=\"line\"><span class=\"attr\">  dns_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - refresh_interval:</span> <span class=\"number\">15</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">    names:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">first.dns.address.domain.com</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">second.dns.address.domain.com</span></span><br><span class=\"line\"><span class=\"attr\">  - names:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">first.dns.address.domain.com</span></span><br><span class=\"line\">    <span class=\"comment\"># refresh_interval defaults to 30s.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[job]</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"string\">(.*)some-[regex]</span></span><br><span class=\"line\"><span class=\"attr\">    action:</span>        <span class=\"string\">drop</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[__address__]</span></span><br><span class=\"line\"><span class=\"attr\">    modulus:</span>       <span class=\"number\">8</span></span><br><span class=\"line\"><span class=\"attr\">    target_label:</span>  <span class=\"string\">__tmp_hash</span></span><br><span class=\"line\"><span class=\"attr\">    action:</span>        <span class=\"string\">hashmod</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[__tmp_hash]</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">    action:</span>        <span class=\"string\">keep</span></span><br><span class=\"line\"><span class=\"attr\">  - action:</span>        <span class=\"string\">labelmap</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  - action:</span>        <span class=\"string\">labeldrop</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"string\">d</span></span><br><span class=\"line\"><span class=\"attr\">  - action:</span>        <span class=\"string\">labelkeep</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"string\">k</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  metric_relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[__name__]</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"string\">expensive_metric.*</span></span><br><span class=\"line\"><span class=\"attr\">    action:</span>        <span class=\"string\">drop</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[pod_name]</span></span><br><span class=\"line\"><span class=\"attr\">    separator:</span> <span class=\"string\">;</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span> <span class=\"string\">(.+)</span></span><br><span class=\"line\"><span class=\"attr\">    target_label:</span> <span class=\"string\">pod</span></span><br><span class=\"line\"><span class=\"attr\">    replacement:</span> <span class=\"string\">$1</span></span><br><span class=\"line\"><span class=\"attr\">    action:</span> <span class=\"string\">replace</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务2 - consul 服务发现</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-y</span></span><br><span class=\"line\"><span class=\"attr\">  consul_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - server:</span> <span class=\"string\">'localhost:1234'</span></span><br><span class=\"line\"><span class=\"attr\">    token:</span> <span class=\"string\">mysecret</span></span><br><span class=\"line\"><span class=\"attr\">    services:</span> <span class=\"string\">['nginx',</span> <span class=\"string\">'cache'</span><span class=\"string\">,</span> <span class=\"string\">'mysql'</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">[\"canary\",</span> <span class=\"string\">\"v1\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">    node_meta:</span></span><br><span class=\"line\"><span class=\"attr\">      rack:</span> <span class=\"string\">\"123\"</span></span><br><span class=\"line\"><span class=\"attr\">    allow_stale:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    scheme:</span> <span class=\"string\">https</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">      ca_file:</span> <span class=\"string\">valid_ca_file</span></span><br><span class=\"line\"><span class=\"attr\">      cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">      key_file:</span>  <span class=\"string\">valid_key_file</span></span><br><span class=\"line\"><span class=\"attr\">      insecure_skip_verify:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  relabel_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - source_labels:</span> <span class=\"string\">[__meta_sd_consul_tags]</span></span><br><span class=\"line\"><span class=\"attr\">    separator:</span>     <span class=\"string\">','</span></span><br><span class=\"line\"><span class=\"attr\">    regex:</span>         <span class=\"attr\">label:([^=]+)=([^,]+)</span></span><br><span class=\"line\"><span class=\"attr\">    target_label:</span>  <span class=\"string\">$&#123;1&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    replacement:</span>   <span class=\"string\">$&#123;2&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务3</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-z</span></span><br><span class=\"line\"><span class=\"attr\">  tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">    cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">    key_file:</span> <span class=\"string\">valid_key_file</span></span><br><span class=\"line\"><span class=\"attr\">  authorization:</span></span><br><span class=\"line\"><span class=\"attr\">    credentials:</span> <span class=\"string\">mysecret</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务4 - kubernetes 相关服务发现(重点)</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">  kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">    api_server:</span> <span class=\"string\">'https://localhost:1234'</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">      cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">      key_file:</span> <span class=\"string\">valid_key_file</span></span><br><span class=\"line\"><span class=\"attr\">    basic_auth:</span></span><br><span class=\"line\"><span class=\"attr\">      username:</span> <span class=\"string\">'myusername'</span></span><br><span class=\"line\"><span class=\"attr\">      password:</span> <span class=\"string\">'mysecret'</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-kubernetes-namespaces</span></span><br><span class=\"line\"><span class=\"attr\">  kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - role:</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\"><span class=\"attr\">    api_server:</span> <span class=\"string\">'https://localhost:1234'</span></span><br><span class=\"line\"><span class=\"attr\">    namespaces:</span></span><br><span class=\"line\"><span class=\"attr\">      names:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">  basic_auth:</span></span><br><span class=\"line\"><span class=\"attr\">    username:</span> <span class=\"string\">'myusername'</span></span><br><span class=\"line\"><span class=\"attr\">    password_file:</span> <span class=\"string\">valid_password_file</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务5</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-marathon</span></span><br><span class=\"line\"><span class=\"attr\">  marathon_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - servers:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">'https://marathon.example.com:443'</span></span><br><span class=\"line\"><span class=\"attr\">    auth_token:</span> <span class=\"string\">\"mysecret\"</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">      cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">      key_file:</span> <span class=\"string\">valid_key_file</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务6</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-ec2</span></span><br><span class=\"line\"><span class=\"attr\">  ec2_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - region:</span> <span class=\"string\">us-east-1</span></span><br><span class=\"line\"><span class=\"attr\">      access_key:</span> <span class=\"string\">access</span></span><br><span class=\"line\"><span class=\"attr\">      secret_key:</span> <span class=\"string\">mysecret</span></span><br><span class=\"line\"><span class=\"attr\">      profile:</span> <span class=\"string\">profile</span></span><br><span class=\"line\"><span class=\"attr\">      filters:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"attr\">tag:environment</span></span><br><span class=\"line\"><span class=\"attr\">          values:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">prod</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"attr\">tag:service</span></span><br><span class=\"line\"><span class=\"attr\">          values:</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"bullet\">            -</span> <span class=\"string\">db</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务7</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-azure</span></span><br><span class=\"line\"><span class=\"attr\">  azure_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - environment:</span> <span class=\"string\">AzurePublicCloud</span></span><br><span class=\"line\"><span class=\"attr\">      authentication_method:</span> <span class=\"string\">OAuth</span></span><br><span class=\"line\"><span class=\"attr\">      subscription_id:</span> <span class=\"number\">11</span><span class=\"string\">AAAA11-A11A-111A-A111-1111A1111A11</span></span><br><span class=\"line\"><span class=\"attr\">      tenant_id:</span> <span class=\"string\">BBBB222B-B2B2-2B22-B222-2BB2222BB2B2</span></span><br><span class=\"line\"><span class=\"attr\">      client_id:</span> <span class=\"number\">333333</span><span class=\"string\">CC-3C33-3333-CCC3-33C3CCCCC33C</span></span><br><span class=\"line\"><span class=\"attr\">      client_secret:</span> <span class=\"string\">mysecret</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">9100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务8</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-nerve</span></span><br><span class=\"line\"><span class=\"attr\">  nerve_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - servers:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">      paths:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/monitoring</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务9</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"number\">0123</span><span class=\"string\">service-xxx</span></span><br><span class=\"line\"><span class=\"attr\">  metrics_path:</span> <span class=\"string\">/metrics</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - targets:</span></span><br><span class=\"line\"><span class=\"attr\">      - localhost:</span><span class=\"number\">9090</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务10</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">badfederation</span></span><br><span class=\"line\"><span class=\"attr\">  honor_timestamps:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">  metrics_path:</span> <span class=\"string\">/federate</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - targets:</span></span><br><span class=\"line\"><span class=\"attr\">      - localhost:</span><span class=\"number\">9090</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务11(支持中文和繁文)</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">测试</span></span><br><span class=\"line\"><span class=\"attr\">  metrics_path:</span> <span class=\"string\">/metrics</span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - targets:</span></span><br><span class=\"line\"><span class=\"attr\">      - localhost:</span><span class=\"number\">9090</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务12</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-triton</span></span><br><span class=\"line\"><span class=\"attr\">  triton_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - account:</span> <span class=\"string\">'testAccount'</span></span><br><span class=\"line\"><span class=\"attr\">    dns_suffix:</span> <span class=\"string\">'triton.example.com'</span></span><br><span class=\"line\"><span class=\"attr\">    endpoint:</span> <span class=\"string\">'triton.example.com'</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">9163</span></span><br><span class=\"line\"><span class=\"attr\">    refresh_interval:</span> <span class=\"number\">1</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    version:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">      cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">      key_file:</span> <span class=\"string\">valid_key_file</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务13</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">digitalocean-droplets</span></span><br><span class=\"line\"><span class=\"attr\">  digitalocean_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - authorization:</span></span><br><span class=\"line\"><span class=\"attr\">        credentials:</span> <span class=\"string\">abcdef</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务14</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">dockerswarm</span></span><br><span class=\"line\"><span class=\"attr\">  dockerswarm_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - host:</span> <span class=\"attr\">http://127.0.0.1:2375</span></span><br><span class=\"line\"><span class=\"attr\">    role:</span> <span class=\"string\">nodes</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务15 - (openstack)</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-openstack</span></span><br><span class=\"line\"><span class=\"attr\">  openstack_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - role:</span> <span class=\"string\">instance</span></span><br><span class=\"line\"><span class=\"attr\">    region:</span> <span class=\"string\">RegionOne</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">    refresh_interval:</span> <span class=\"number\">1</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\"><span class=\"attr\">      ca_file:</span> <span class=\"string\">valid_ca_file</span></span><br><span class=\"line\"><span class=\"attr\">      cert_file:</span> <span class=\"string\">valid_cert_file</span></span><br><span class=\"line\"><span class=\"attr\">      key_file:</span>  <span class=\"string\">valid_key_file</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务16</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">hetzner</span></span><br><span class=\"line\"><span class=\"attr\">  hetzner_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">hcloud</span></span><br><span class=\"line\"><span class=\"attr\">      authorization:</span></span><br><span class=\"line\"><span class=\"attr\">        credentials:</span> <span class=\"string\">abcdef</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">robot</span></span><br><span class=\"line\"><span class=\"attr\">      basic_auth:</span></span><br><span class=\"line\"><span class=\"attr\">        username:</span> <span class=\"string\">abcdef</span></span><br><span class=\"line\"><span class=\"attr\">        password:</span> <span class=\"string\">abcdef</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务17</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">service-eureka</span></span><br><span class=\"line\"><span class=\"attr\">  eureka_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - server:</span> <span class=\"string\">'http://eureka.example.com:8761/eureka'</span></span><br><span class=\"line\"><span class=\"comment\"># - 工作任务18</span></span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">scaleway</span></span><br><span class=\"line\"><span class=\"attr\">  scaleway_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">instance</span></span><br><span class=\"line\"><span class=\"attr\">      project_id:</span> <span class=\"number\">11111111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-111111111112</span></span><br><span class=\"line\"><span class=\"attr\">      access_key:</span> <span class=\"string\">SCWXXXXXXXXXXXXXXXXX</span></span><br><span class=\"line\"><span class=\"attr\">      secret_key:</span> <span class=\"number\">11111111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-111111111111</span></span><br><span class=\"line\"><span class=\"attr\">    - role:</span> <span class=\"string\">baremetal</span></span><br><span class=\"line\"><span class=\"attr\">      project_id:</span> <span class=\"number\">11111111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-111111111112</span></span><br><span class=\"line\"><span class=\"attr\">      access_key:</span> <span class=\"string\">SCWXXXXXXXXXXXXXXXXX</span></span><br><span class=\"line\"><span class=\"attr\">      secret_key:</span> <span class=\"number\">11111111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-1111</span><span class=\"bullet\">-111111111111</span></span><br></pre></td></tr></table></figure></li>\n<li><p>2.2) kubernetes 集群监控服务发现配置: <a href=\"https://github.com/prometheus/prometheus/blob/release-2.26/documentation/examples/prometheus-kubernetes.yml\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/prometheus/blob/release-2.26/documentation/examples/prometheus-kubernetes.yml</a></p>\n</li>\n<li><p>2.3) # - 补充: 实际工作任务示例19</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">'prometheus'</span>  <span class=\"comment\">###这个必须配置，这个地址抓取的所有数据会自动加上`job=prometheus`的标签   </span></span><br><span class=\"line\">  <span class=\"comment\"># metrics_path defaults to '/metrics' #抓取监控目标的路径，默认是/metrics 可以根据自己业务的需要进行修  </span></span><br><span class=\"line\">  <span class=\"comment\"># scheme defaults to 'http'.    </span></span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span>   <span class=\"comment\">#这是通过静态文件的配置方法：这种方法直接指定要抓去目标的ip和端口    </span></span><br><span class=\"line\"><span class=\"attr\">  - targets:</span> <span class=\"string\">['localhost:9090']</span> </span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">gateway</span>    </span><br><span class=\"line\"><span class=\"attr\">  static_configs:</span>     </span><br><span class=\"line\"><span class=\"attr\">  - targets:</span> <span class=\"string\">['127.0.0.1:9091']</span>      </span><br><span class=\"line\"><span class=\"attr\">  labels:</span>   <span class=\"comment\"># 打上标签 instance会被指定为'gataway'</span></span><br><span class=\"line\"><span class=\"attr\">    instance:</span> <span class=\"string\">gataway</span>  </span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">node_export</span>    </span><br><span class=\"line\"><span class=\"attr\">  file_sd_configs:</span>       </span><br><span class=\"line\"><span class=\"attr\">    refresh_interval:</span> <span class=\"number\">1</span><span class=\"string\">m</span>   <span class=\"comment\"># 刷新发现文件的时间间隔      </span></span><br><span class=\"line\"><span class=\"attr\">    - files:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/data/prometheus-2.12.0.linux-amd64/node_discovery.json</span>  </span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">mysql_discovery</span></span><br><span class=\"line\"><span class=\"attr\">  file_sd_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  refresh_interval:</span> <span class=\"number\">1</span><span class=\"string\">m</span> <span class=\"comment\"># 刷新发现文件的时间间隔     </span></span><br><span class=\"line\"><span class=\"attr\">  - files:</span>        </span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/data/prometheus-2.12.0.linux-amd64/mysql_discovery.json</span>  </span><br><span class=\"line\"><span class=\"attr\">- job_name:</span> <span class=\"string\">redis_discovery</span>    </span><br><span class=\"line\"><span class=\"attr\">  file_sd_configs:</span>       </span><br><span class=\"line\"><span class=\"attr\">  refresh_interval:</span> <span class=\"number\">1</span><span class=\"string\">m</span> <span class=\"comment\"># 刷新发现文件的时间间隔     </span></span><br><span class=\"line\"><span class=\"attr\">  - files:</span>  <span class=\"comment\"># 备注：尽量使用动态发现的配置以免配置文件过长</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/data/prometheus-2.12.0.linux-amd64/redis_discovery.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################# discovery files 模版示例 #################</span></span><br><span class=\"line\"><span class=\"comment\"># 方式1./data/prometheus-2.12.0.linux-amd64/node_discovery.json  </span></span><br><span class=\"line\"><span class=\"string\">[</span></span><br><span class=\"line\">  <span class=\"string\">&#123;\"targets\":</span> <span class=\"string\">[\"127.0.0.1:9100\"],\"labels\":</span> <span class=\"string\">&#123;\"instance\":</span> <span class=\"string\">\"test\"</span><span class=\"string\">,\"idc\":</span> <span class=\"string\">\"beijing\"</span><span class=\"string\">&#125;&#125;,</span></span><br><span class=\"line\">  <span class=\"string\">&#123;\"targets\":</span> <span class=\"string\">[\"127.0.0.1:9101\"],\"labels\":</span> <span class=\"string\">&#123;\"instance\":</span> <span class=\"string\">\"test2\"</span><span class=\"string\">,\"idc\":</span> <span class=\"string\">\"beijing\"</span><span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2./data/prometheus-2.12.0.linux-amd64/redis_discovery.yaml</span></span><br><span class=\"line\"><span class=\"attr\">- targets:</span> <span class=\"string\">[</span> <span class=\"string\">'127.0.0.1:9199'</span><span class=\"string\">,'192.168.1.1:9199'</span> <span class=\"string\">]</span> </span><br><span class=\"line\"><span class=\"attr\">  labels:</span> <span class=\"string\">&#123;</span> <span class=\"string\">\"env\"</span><span class=\"string\">:</span> <span class=\"string\">\"production\"</span><span class=\"string\">,\"instance\":</span> <span class=\"string\">\"node-1\"</span> <span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"attr\">- targets:</span> <span class=\"string\">[</span> <span class=\"string\">'192.168.1.3:9199'</span><span class=\"string\">,'192.168.1.3:9199'</span> <span class=\"string\">]</span> </span><br><span class=\"line\"><span class=\"attr\">  labels:</span> <span class=\"string\">&#123;</span> <span class=\"string\">\"env\"</span><span class=\"string\">:</span> <span class=\"string\">\"production\"</span><span class=\"string\">,\"instance\":</span> <span class=\"string\">\"node-2\"</span> <span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"3-API-Rsetful\"><a href=\"#3-API-Rsetful\" class=\"headerlink\" title=\"(3) API Rsetful\"></a>(3) API Rsetful</h4><p>描述: Prometheus 在 2.0 版本以后已经提供了一个简单的管理接口，可以方便我们进行对Prometheus数据库的增删改查，注意如果要使用API就必须添加启动参数<code>--web.enable-admin-api</code>默认是关闭的。</p>\n<p>下述是<code>Prometheus</code>常用的API RESTful接口示例,如果想要使用:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 查询指定参数返回的指标名称和值</span></span><br><span class=\"line\">http://192.168.12.107:30090/api/v1/series?match[]=up</span><br><span class=\"line\">http://192.168.12.107:30090/api/v1/series?match[]=&#123;service_name=%22kube-state-metrics%22&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查询指定标签的Values值</span></span><br><span class=\"line\">http://192.168.12.107:30090/api/v1/label/instance/values</span><br><span class=\"line\">  <span class=\"comment\"># status\t\"success\"</span></span><br><span class=\"line\">  <span class=\"comment\"># data\t[…]</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 删除tsdb中指定Job Name的metric</span></span><br><span class=\"line\">http://localhost:30090/api/v1/admin/tsdb/delete_series?match[]=up&amp;match[]=&#123;job=~<span class=\"string\">'kubernetes-kube-state'</span>&#125;<span class=\"string\">\"</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># (4) 通过API接口进行重载Prometheus配置</span></span><br><span class=\"line\"><span class=\"string\">http://localhost:30090/-/reload</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"Alert-rules\"><a href=\"#Alert-rules\" class=\"headerlink\" title=\"Alert.rules\"></a>Alert.rules</h3><p>描述: 该文件主要是记录(Recording)规则和警报(Alert)规则文件,将Prometheus服务端pull下来的监控指标参数进行匹配对比,如匹配上则报警或者例利用Alertmanager发送报警信息。</p>\n<p>Prometheus 支持两种类型的规则可以配置然后定期评估：记录规则和警报规则, 要在Prometheus中包含规则请创建一个包含必要规则语句的文件, 并让Prometheus通过Prometheus配置中的<code>rule_files</code>字段加载该文件(YAML格式)。</p>\n<h4 id=\"1-语法格式-1\"><a href=\"#1-语法格式-1\" class=\"headerlink\" title=\"(1) 语法格式\"></a>(1) 语法格式</h4><ul>\n<li>1.录制规则(<code>Defining recording rules</code>): 录制规则允许您预计算经常需要或计算代价高昂的表达式，并将其结果保存为一组新的时间序列。<ul>\n<li>查询预计算结果通常比每次需要时执行原始表达式快得多, 这对于仪表板尤其有用,由于仪表板每次刷新时都需要重复查询相同的表达式。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Syntax-checking rules </span></span><br><span class=\"line\">promtool check rules /path/to/example.rules.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Syntax</span></span><br><span class=\"line\">groups:</span><br><span class=\"line\">  <span class=\"comment\"># The name of the group. Must be unique within a file.</span></span><br><span class=\"line\">  name: &lt;string&gt;</span><br><span class=\"line\">  <span class=\"comment\"># How often rules in the group are evaluated.</span></span><br><span class=\"line\">  [ interval: &lt;duration&gt; | default = global.evaluation_interval ]</span><br><span class=\"line\"></span><br><span class=\"line\">rules:</span><br><span class=\"line\">  <span class=\"comment\"># ------- 录制规则的语法为：---------</span></span><br><span class=\"line\">  <span class=\"comment\"># The name of the time series to output to. Must be a valid metric name.</span></span><br><span class=\"line\">  record: &lt;string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># The PromQL expression to evaluate. Every evaluation cycle this is</span></span><br><span class=\"line\">  <span class=\"comment\"># evaluated at the current time, and the result recorded as a new set of</span></span><br><span class=\"line\">  <span class=\"comment\"># time series with the metric name as given by 'record'.</span></span><br><span class=\"line\">  expr: &lt;string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Labels to add or overwrite before storing the result.</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    [ &lt;labelname&gt;: &lt;labelvalue&gt; ]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>2.警报规则(<code>Alerting rules</code>)：允许您基于 <code>Prometheus expression</code>语言表达式定义警报条件，并向外部服务发送有关触发警报的通知。每当警报表达式在给定的时间点产生一个或多个向量元素时，警报将对这些元素的标签集计为活动。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Syntax</span></span><br><span class=\"line\">groups:</span><br><span class=\"line\">  <span class=\"comment\"># The name of the group. Must be unique within a file.</span></span><br><span class=\"line\">  name: &lt;string&gt;</span><br><span class=\"line\">  <span class=\"comment\"># How often rules in the group are evaluated.</span></span><br><span class=\"line\">  [ interval: &lt;duration&gt; | default = global.evaluation_interval ]</span><br><span class=\"line\"></span><br><span class=\"line\">rules:</span><br><span class=\"line\">  <span class=\"comment\"># ------- 警报规则的语法是：---------</span></span><br><span class=\"line\">  <span class=\"comment\"># The name of the alert. Must be a valid label value.</span></span><br><span class=\"line\">  alert: &lt;string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># The PromQL expression to evaluate. Every evaluation cycle this is</span></span><br><span class=\"line\">  <span class=\"comment\"># evaluated at the current time, and all resultant time series become</span></span><br><span class=\"line\">  <span class=\"comment\"># pending/firing alerts.</span></span><br><span class=\"line\">  expr: &lt;string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Alerts are considered firing once they have been returned for this long.</span></span><br><span class=\"line\">  <span class=\"comment\"># Alerts which have not yet fired for long enough are considered pending.</span></span><br><span class=\"line\">  [ <span class=\"keyword\">for</span>: &lt;duration&gt; | default = 0s ]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Labels to add or overwrite for each alert.</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    [ &lt;labelname&gt;: &lt;tmpl_string&gt; ]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Annotations to add to each alert.</span></span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    [ &lt;labelname&gt;: &lt;tmpl_string&gt; ]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"2-基础示例-1\"><a href=\"#2-基础示例-1\" class=\"headerlink\" title=\"(2) 基础示例\"></a>(2) 基础示例</h4><ul>\n<li><p>1) Defining recording rules: A simple example rules file would be:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">groups:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">example</span></span><br><span class=\"line\"><span class=\"attr\">    rules:</span></span><br><span class=\"line\"><span class=\"attr\">    - record:</span> <span class=\"attr\">job:http_inprogress_requests:sum</span></span><br><span class=\"line\"><span class=\"attr\">      expr:</span> <span class=\"string\">sum</span> <span class=\"string\">by</span> <span class=\"string\">(job)</span> <span class=\"string\">(http_inprogress_requests)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># -- K8s Recording rule</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">k8s.rules</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - expr:</span> <span class=\"string\">sum(rate(container_cpu_usage_seconds_total[5m]))</span> <span class=\"string\">by</span> <span class=\"string\">(namespace)</span></span><br><span class=\"line\"><span class=\"attr\">    record:</span> <span class=\"attr\">namespace:container_memory_usage_bytes:sum</span></span><br><span class=\"line\"><span class=\"attr\">  - expr:</span> <span class=\"string\">sum(container_memory_usage_bytes)</span> <span class=\"string\">by</span> <span class=\"string\">(namespace)</span></span><br><span class=\"line\"><span class=\"attr\">    record:</span> <span class=\"attr\">namespace:container_memory_usage_bytes:sum</span></span><br><span class=\"line\"><span class=\"attr\">  - expr:</span> <span class=\"string\">sum</span> <span class=\"string\">by</span> <span class=\"string\">(namespace,pod_name,container_name)(rate(container_cpu_usage_seconds_total[5m]))</span></span><br><span class=\"line\"><span class=\"attr\">    record:</span> <span class=\"attr\">namespace_pod_name_container_name:container_cpu_usage_seconds_total:sum_rate</span></span><br><span class=\"line\"><span class=\"string\">```</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"number\">2</span><span class=\"string\">)</span> <span class=\"string\">Defining</span> <span class=\"string\">alerting</span> <span class=\"attr\">rules:</span> <span class=\"string\">An</span> <span class=\"string\">example</span> <span class=\"string\">rules</span> <span class=\"string\">file</span> <span class=\"string\">with</span> <span class=\"string\">an</span> <span class=\"string\">alert</span> <span class=\"string\">would</span> <span class=\"attr\">be:</span></span><br><span class=\"line\"><span class=\"string\">```yaml</span></span><br><span class=\"line\"><span class=\"attr\">groups:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">example</span>  <span class=\"comment\"># 报警分组</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">HighRequestLatency</span>  <span class=\"comment\"># 报警名称</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"attr\">job:request_latency_seconds:mean5m&#123;job=\"myjob\"&#125;</span> <span class=\"string\">&gt; 0.5  # 规则表达式</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">10</span><span class=\"string\">m</span>   <span class=\"comment\"># 持续时间如果在10m内多次收到报警则进行发送报警信息。</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span>    <span class=\"comment\"># 规则标签</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">critical</span> <span class=\"comment\"># 报警级别</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span>  <span class=\"comment\"># 注释 可以加入label值和value值 </span></span><br><span class=\"line\"><span class=\"attr\">      summary:</span> <span class=\"string\">\"Instance <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> High request latency\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3) 实践环境中的报警规则</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">groups:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">节点监控基础规则(Basic</span> <span class=\"string\">Rules)</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">节点状态宕机</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"string\">up</span> <span class=\"string\">==</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">for:</span> <span class=\"number\">2</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">critical</span></span><br><span class=\"line\"><span class=\"attr\">      status:</span> <span class=\"string\">down</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">summary:</span> <span class=\"string\">\"来自 <span class=\"template-variable\">&#123;&#123; $labels.job &#125;&#125;</span> Job,节点 <span class=\"template-variable\">&#123;&#123;$labels.instance&#125;&#125;</span> 状态宕机\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">description:</span> <span class=\"string\">\"节点 <span class=\"template-variable\">&#123;&#123;$labels.instance&#125;&#125;</span> 宕机已超过2分钟请进行人工处理。\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">CPU</span> <span class=\"string\">使用情况</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"number\">100</span><span class=\"bullet\">-(avg(irate(node_cpu_seconds_total&#123;mode=\"idle\"&#125;[5m]))</span> <span class=\"string\">by(instance)*</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">&gt; 70</span></span><br><span class=\"line\"><span class=\"string\">​      for: 5m</span></span><br><span class=\"line\"><span class=\"string\">​      labels:</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">summary:</span> <span class=\"string\">\"节点 <span class=\"template-variable\">&#123;&#123;$labels.mountpoint&#125;&#125;</span> CPU 使用率过高！\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">description:</span> <span class=\"string\">\"节点 <span class=\"template-variable\">&#123;&#123;$labels.mountpoint &#125;&#125;</span> CPU已持续3分钟使用大于 70% (目前使用:<span class=\"template-variable\">&#123;&#123;$value&#125;&#125;</span>%)\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">Memory</span> <span class=\"string\">使用情况</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"number\">100</span> <span class=\"bullet\">-</span> <span class=\"string\">(node_memory_MemTotal_bytes</span> <span class=\"bullet\">-</span> <span class=\"string\">node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes</span> <span class=\"string\">)</span> <span class=\"string\">/</span> <span class=\"string\">node_memory_MemTotal_bytes</span> <span class=\"string\">*</span> <span class=\"number\">100</span> <span class=\"string\">&gt; 80</span></span><br><span class=\"line\"><span class=\"string\">​      for: 1m</span></span><br><span class=\"line\"><span class=\"string\">​      labels:</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">summary:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 内存使用率过高！\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 内存使用大于80%(目前使用:<span class=\"template-variable\">&#123;&#123;$value&#125;&#125;</span>%)\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">IO</span> <span class=\"string\">性能情况</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"number\">100</span> <span class=\"bullet\">-</span> <span class=\"string\">(avg(irate(node_disk_io_time_seconds_total[5m]))</span> <span class=\"string\">by(instance)*</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">&lt;</span> <span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">for:</span> <span class=\"number\">2</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">summary:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流入磁盘IO使用率过高！\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 流入磁盘IO大于70%(目前使用:<span class=\"template-variable\">&#123;&#123;$value&#125;&#125;</span>)\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">Network</span> <span class=\"string\">接收(receive)情况</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"string\">((sum(rate</span> <span class=\"string\">(node_network_receive_bytes_total&#123;device!~'tap.*|veth.*|br.*|docker.*|virbr*|lo*'&#125;[5m]))</span> <span class=\"string\">by</span> <span class=\"string\">(instance))</span> <span class=\"string\">/</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">&gt; 102400</span></span><br><span class=\"line\"><span class=\"string\">​      for: 5m</span></span><br><span class=\"line\"><span class=\"string\">​      labels:</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">summary:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流入网络带宽过高！\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 流入网络带宽持续5分钟高于100M. RX带宽使用率<span class=\"template-variable\">&#123;&#123;$value&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">Network</span> <span class=\"string\">传输(transmit)情况</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"string\">((sum(rate</span> <span class=\"string\">(node_network_transmit_bytes_total&#123;device!~'tap.*|veth.*|br.*|docker.*|virbr*|lo*'&#125;[5m]))</span> <span class=\"string\">by</span> <span class=\"string\">(instance))</span> <span class=\"string\">/</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">&gt; 102400</span></span><br><span class=\"line\"><span class=\"string\">​      for: 1m</span></span><br><span class=\"line\"><span class=\"string\">​      labels:</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">summary:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 流出网络带宽过高！\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint &#125;&#125;</span>流出网络带宽持续2分钟高于100M. RX带宽使用率<span class=\"template-variable\">&#123;&#123;$value&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">TCP会话</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"string\">node_netstat_Tcp_CurrEstab</span> <span class=\"string\">&gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">​      for: 1m</span></span><br><span class=\"line\"><span class=\"string\">​      labels:</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">summary:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint&#125;&#125;</span> TCP_ESTABLISHED过高！\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint &#125;&#125;</span> TCP_ESTABLISHED大于1000%(目前使用:<span class=\"template-variable\">&#123;&#123;$value&#125;&#125;</span>%)\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">磁盘容量</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">expr:</span> <span class=\"number\">100</span><span class=\"bullet\">-(node_filesystem_free_bytes&#123;fstype=~\"ext4|xfs\"&#125;/node_filesystem_size_bytes</span> <span class=\"string\">&#123;fstype=~\"ext4|xfs\"&#125;*100)</span> <span class=\"string\">&gt; 80</span></span><br><span class=\"line\"><span class=\"string\">​      for: 1m</span></span><br><span class=\"line\"><span class=\"string\">​      labels:</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">annotations:</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">summary:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint&#125;&#125;</span> 磁盘分区使用率过高！\"</span></span><br><span class=\"line\"><span class=\"string\">​</span>        <span class=\"attr\">description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;$labels.mountpoint &#125;&#125;</span> 磁盘分区使用大于80%(目前使用:<span class=\"template-variable\">&#123;&#123;$value&#125;&#125;</span>%)\"</span></span><br><span class=\"line\"><span class=\"comment\"># -- 业务监控规则</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">业务监控(Business</span> <span class=\"string\">monitoring)</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">APIHighRequestLatency</span>  <span class=\"comment\">#对请求延迟中值大于1s的任何实例发出警报。</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">api_http_request_latencies_second&#123;quantile=\"0.5\"&#125;</span> <span class=\"string\">&gt; 1</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">10</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      summary:</span> <span class=\"string\">\"High request latency on <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> has a median request latency above 1s (current value: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span>s)\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># -- 数据库监控规则</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">RedisAlert</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">Redis</span> <span class=\"string\">内存情况</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"number\">100</span> <span class=\"string\">*</span> <span class=\"string\">(redis_memory_used_bytes</span> <span class=\"string\">/</span> <span class=\"string\">redis_config_maxmemory)</span> <span class=\"string\">&gt; 90</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">1</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      summary:</span> <span class=\"string\">\"Redis <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> memory userd over 90\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"Redis memory used over 90 duration above 1m\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># -- 队列监控规则</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">KafkaAlert</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">kafka</span> <span class=\"string\">消费者(Consumer)group_lag情况</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">sum(kafka_consumergroup_lag&#123;instance</span> <span class=\"string\">!=</span> <span class=\"string\">\"kafka-dev\"</span> <span class=\"string\">&#125;)</span> <span class=\"string\">by</span> <span class=\"string\">(instance,</span> <span class=\"string\">consumergroup,topic)</span> <span class=\"string\">&gt; 500</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">5</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">generality</span></span><br><span class=\"line\"><span class=\"string\">​</span>      <span class=\"attr\">status:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      summary:</span> <span class=\"string\">\"kafka <span class=\"template-variable\">&#123;&#123; $labels.topic &#125;&#125;</span> 消费延迟报警\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"kafka 消费延迟有 <span class=\"template-variable\">&#123;&#123; $value&#125;&#125;</span> 队列数\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : 规则检测频率时间是与全局变量中的<code>evaluation_interval</code>设置相关。<br>Tips : 标签和注释值可以使用控制台模板进行模板化。<code>$labels</code>变量保存警报实例的标签键/值对,可以通过<code>$externalLabels</code>变量访问配置的外部标签, <code>$value</code>变量保存警报实例的评估值。<br>Tips : 按照<code>evaluation_interval</code>配置该告警规则30s执行一次，如果持续<code>for:2m</code>即2分钟内收到数据则该警告会被触发，并且在达到设定得时间长度前该告警将处于pending状态。<br><br/></p>\n<h3 id=\"Alertmanager-yml\"><a href=\"#Alertmanager-yml\" class=\"headerlink\" title=\"Alertmanager.yml\"></a>Alertmanager.yml</h3><p>描述: Alertmanager是通过命令行标志和配置文件配置的。当命令行标志配置不可变的系统参数时，配置文件定义禁止规则、通知路由和通知接收器(<code>Prometheus的报警通知配置文件</code>),要指定要加载的配置文件，请使用–config.file标志<code>./alertmanager --config.file=alertmanager.yml</code>。</p>\n<p>Alertmanager.yml Configuration file 主要配置对象:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 全局配置: 包括报警解决后的超时时间、SMTP 相关配置、各种渠道通知的 API 地址等等。</span></span><br><span class=\"line\">* &lt;global&gt;</span><br><span class=\"line\">  * &lt;http_config&gt;</span><br><span class=\"line\">  * &lt;tls_config&gt;</span><br><span class=\"line\"><span class=\"comment\"># - 用来设置报警的分发策略，它是一个树状结构，按照深度优先从左向右的顺序进行匹配。</span></span><br><span class=\"line\">* &lt;route&gt;</span><br><span class=\"line\"><span class=\"comment\"># - 抑制规则配置，当存在与另一组匹配的警报（源）时，抑制规则将禁用与一组匹配的警报（目标）。</span></span><br><span class=\"line\">* &lt;inhibit_rule&gt;</span><br><span class=\"line\">* &lt;templates&gt;</span><br><span class=\"line\"><span class=\"comment\"># - 配置告警消息接受者信息，例如常用的 email、wechat、slack、webhook 等消息通知方式。</span></span><br><span class=\"line\">* &lt;receiver&gt;</span><br><span class=\"line\">  * &lt;email_config&gt;</span><br><span class=\"line\">  * &lt;pagerduty_config&gt;</span><br><span class=\"line\">    * &lt;image_config&gt;</span><br><span class=\"line\">    * &lt;link_config&gt;</span><br><span class=\"line\">  * &lt;pushover_config&gt;</span><br><span class=\"line\">  * &lt;slack_config&gt;</span><br><span class=\"line\">    * &lt;action_config&gt;</span><br><span class=\"line\">    * &lt;field_config&gt;</span><br><span class=\"line\">  * &lt;opsgenie_config&gt;</span><br><span class=\"line\">    * &lt;responder&gt;</span><br><span class=\"line\">  * &lt;victorops_config&gt;</span><br><span class=\"line\">  * &lt;webhook_config&gt;</span><br><span class=\"line\">  * &lt;wechat_config&gt;</span><br></pre></td></tr></table></figure></p>\n<p>Tips: 通用占位符定义如下：</p>\n<ul>\n<li><code>&lt;duration&gt;</code>：与正则表达式匹配的持续时间 <code>[0-9]+(ms|[smhdwy])</code></li>\n<li><code>&lt;labelname&gt;</code>：与正则表达式匹配的字符串<code>[a-zA-Z_][a-zA-Z0-9_]*</code></li>\n<li><code>&lt;labelvalue&gt;</code>：一串unicode字符</li>\n<li><code>&lt;filepath&gt;</code>：当前工作目录中的有效路径</li>\n<li><code>&lt;boolean&gt;</code>：可以接受值的布尔值true或false</li>\n<li><code>&lt;string&gt;</code>：常规字符串</li>\n<li><code>&lt;secret&gt;</code>：是秘密的常规字符串，例如密码</li>\n<li><code>&lt;tmpl_string&gt;</code>：使用前已模板扩展的字符串</li>\n<li><code>&lt;tmpl_secret&gt;</code>：一个字符串，在使用前会进行模板扩展，这是一个秘密</li>\n<li><code>&lt;int&gt;</code>：一个整数值</li>\n</ul>\n<p><br></p>\n<h4 id=\"1-语法格式-2\"><a href=\"#1-语法格式-2\" class=\"headerlink\" title=\"(1) 语法格式\"></a>(1) 语法格式</h4><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 全局配置指定在所有其他配置上下文中有效的参数,它们也可以作为其他配置部分的默认值。</span></span><br><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"comment\"># The default SMTP From header field.</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">smtp_from:</span> <span class=\"string\">&lt;tmpl_string&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\">  <span class=\"comment\"># The default SMTP smarthost used for sending emails, including port number.</span></span><br><span class=\"line\">  <span class=\"comment\"># Port number usually is 25, or 587 for SMTP over TLS (sometimes referred to as STARTTLS).</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">smtp_smarthost:</span> <span class=\"string\">&lt;string&gt;</span> <span class=\"string\">]</span>    <span class=\"comment\"># Example: smtp.example.org:587</span></span><br><span class=\"line\">  <span class=\"comment\"># The default hostname to identify to the SMTP server.</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">smtp_hello:</span> <span class=\"string\">&lt;string&gt;</span> <span class=\"string\">| default = \"localhost\" ]</span></span><br><span class=\"line\"><span class=\"string\">  # SMTP Auth using CRAM-MD5, LOGIN and PLAIN. If empty, Alertmanager doesn't authenticate to the SMTP server.</span></span><br><span class=\"line\"><span class=\"string\">  [ smtp_auth_username: &lt;string&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  # SMTP Auth using LOGIN and PLAIN.</span></span><br><span class=\"line\"><span class=\"string\">  [ smtp_auth_password: &lt;secret&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  # SMTP Auth using PLAIN.</span></span><br><span class=\"line\"><span class=\"string\">  [ smtp_auth_identity: &lt;string&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  # SMTP Auth using CRAM-MD5.</span></span><br><span class=\"line\"><span class=\"string\">  [ smtp_auth_secret: &lt;secret&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  # The default SMTP TLS requirement.</span></span><br><span class=\"line\"><span class=\"string\">  # Note that Go does not support unencrypted connections to remote SMTP endpoints.</span></span><br><span class=\"line\"><span class=\"string\">  [ smtp_require_tls: &lt;bool&gt; | default = true ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # 用于延迟通知的API URL</span></span><br><span class=\"line\"><span class=\"string\">  [ slack_api_url: &lt;secret&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  [ victorops_api_key: &lt;secret&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  [ victorops_api_url: &lt;string&gt; | default = \"https://alert.victorops.com/integrations/generic/20131114/alert/\" ]</span></span><br><span class=\"line\"><span class=\"string\">  [ pagerduty_url: &lt;string&gt; | default = \"https://events.pagerduty.com/v2/enqueue\" ]</span></span><br><span class=\"line\"><span class=\"string\">  [ opsgenie_api_key: &lt;secret&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  [ opsgenie_api_url: &lt;string&gt; | default = \"https://api.opsgenie.com/\" ]</span></span><br><span class=\"line\"><span class=\"string\">  [ wechat_api_url: &lt;string&gt; | default = \"https://qyapi.weixin.qq.com/cgi-bin/\" ]</span></span><br><span class=\"line\"><span class=\"string\">  [ wechat_api_secret: &lt;secret&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  [ wechat_api_corp_id: &lt;string&gt; ]</span></span><br><span class=\"line\"><span class=\"string\">  </span></span><br><span class=\"line\"><span class=\"string\">  # - 默认的HTTP客户端配置</span></span><br><span class=\"line\"><span class=\"string\">  # Note that `basic_auth`, `bearer_token` and `bearer_token_file` options are mutually exclusive(相互排斥).</span></span><br><span class=\"line\"><span class=\"string\">  [ http_config: &lt;http_config&gt; ]                </span></span><br><span class=\"line\"><span class=\"string\">    # Sets the `Authorization` header with the configured username and password.</span></span><br><span class=\"line\"><span class=\"string\">    # password and password_file are mutually exclusive.</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    basic_auth:</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">username:</span> <span class=\"string\">&lt;string&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">password:</span> <span class=\"string\">&lt;secret&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">password_file:</span> <span class=\"string\">&lt;string&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Sets the `Authorization` header with the configured bearer token.</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"attr\">bearer_token:</span> <span class=\"string\">&lt;secret&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Sets the `Authorization` header with the bearer token read from the configured file.</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"attr\">bearer_token_file:</span> <span class=\"string\">&lt;filepath&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Configures the TLS settings.</span></span><br><span class=\"line\"><span class=\"attr\">    tls_config:</span></span><br><span class=\"line\">      <span class=\"comment\"># CA certificate to validate the server certificate with.</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">ca_file:</span> <span class=\"string\">&lt;filepath&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># Certificate and key files for client cert authentication to the server.</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">cert_file:</span> <span class=\"string\">&lt;filepath&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">key_file:</span> <span class=\"string\">&lt;filepath&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># ServerName extension to indicate the name of the server.</span></span><br><span class=\"line\">      <span class=\"comment\"># http://tools.ietf.org/html/rfc4366#section-3.1</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">server_name:</span> <span class=\"string\">&lt;string&gt;</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># Disable validation of the server certificate.</span></span><br><span class=\"line\">      <span class=\"string\">[</span> <span class=\"attr\">insecure_skip_verify:</span> <span class=\"string\">&lt;boolean&gt;</span> <span class=\"string\">| default = false]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # Optional proxy URL.</span></span><br><span class=\"line\"><span class=\"string\">    [ proxy_url: &lt;string&gt; ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  [ resolve_timeout: &lt;duration&gt; | default = 5m ] # 默认的HTTP客户端配置</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># - 从中读取自定义通知模板定义的文件,最后一个组件可以使用通配符匹配器,例如“templates/*.tmpl”。</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;filepath&gt;</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 路由块定义路由树中的节点及其子节点。如果未设置则从其父节点继承其可选配置参数。</span></span><br><span class=\"line\"><span class=\"attr\">route:</span> <span class=\"string\">&lt;route&gt;</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">receiver:</span> <span class=\"string\">&lt;string&gt;</span> <span class=\"string\">]</span> </span><br><span class=\"line\">  <span class=\"comment\"># 用于将传入警报分组在一起的标签。例如，cluster=A和alertname=LatencyHigh的多个警报将被批处理到单个组中。</span></span><br><span class=\"line\">  <span class=\"comment\"># To aggregate by all possible labels use the special value '...' as the sole label name, for example:</span></span><br><span class=\"line\">  <span class=\"comment\"># group_by: ['...']</span></span><br><span class=\"line\">  <span class=\"comment\"># 这将有效地完全禁用聚合，按原样传递所有警报。这不太可能是您想要的，除非您的警报量非常低，或者您的上游通知系统执行自己的分组。</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">group_by:</span> <span class=\"string\">[</span> <span class=\"string\">&lt;labelname&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 警报是否应继续匹配后续同级节点。</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">continue:</span> <span class=\"string\">&lt;boolean&gt;</span> <span class=\"string\">| default = false ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # 警报必须满足的一组相等匹配器才能匹配节点。</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">  match:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"string\">&lt;labelname&gt;:</span> <span class=\"string\">&lt;labelvalue&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 警报必须满足的一组正则表达式匹配器才能匹配节点。</span></span><br><span class=\"line\"><span class=\"attr\">  match_re:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"string\">&lt;labelname&gt;:</span> <span class=\"string\">&lt;regex&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 为一组警报发送通知的初始等待时间。允许等待禁止警报到达或为同一组收集更多初始警报(通常是0到几分钟。）</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">group_wait:</span> <span class=\"string\">&lt;duration&gt;</span> <span class=\"string\">| default = 30s ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # 在发送有关添加到已发送初始通知的警报组中的新警报的通知之前要等待多长时间(通常约5分钟或以上。）</span></span><br><span class=\"line\"><span class=\"string\">  [ group_interval: &lt;duration&gt; | default = 5m ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # 如果警报已成功发送，则在再次发送通知之前要等待多长时间(通常约3小时或以上）。</span></span><br><span class=\"line\"><span class=\"string\">  [ repeat_interval: &lt;duration&gt; | default = 4h ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # 零个或多个子路由。</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">  routes:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;route&gt;</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通知接收者列表：Receiver是一个或多个通知集成的命名配置（此处正对于webhook与wechat详细讲解）。</span></span><br><span class=\"line\"><span class=\"attr\">receivers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">&lt;string&gt;</span>  <span class=\"comment\">#  接收方的唯一名称。</span></span><br><span class=\"line\">  <span class=\"comment\"># 多个通知集成的配置。</span></span><br><span class=\"line\"><span class=\"attr\">  webhook_configs:</span> <span class=\"comment\"># - webhook接收器允许配置通用接收器。</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"attr\">send_resolved:</span> <span class=\"string\">&lt;boolean&gt;</span> <span class=\"string\">| default = true ] # 是否通知已解决的警报。</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    url:</span> <span class=\"string\">&lt;string&gt;</span>  <span class=\"comment\"># POST 请求地址</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"attr\">http_config:</span> <span class=\"string\">&lt;http_config&gt;</span> <span class=\"string\">| default = global.http_config ]  # HTTP客户端的配置。</span></span><br><span class=\"line\"><span class=\"string\">    [ max_alerts: &lt;int&gt; | default = 0 ]  # 单个webhook消息中包含的最大警报数, 将其保留为默认值 0 包括所有警报。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">  wechat_configs:</span> <span class=\"comment\"># - 微信通知通过微信API发送。</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"attr\">send_resolved:</span> <span class=\"string\">&lt;boolean&gt;</span> <span class=\"string\">| default = false ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # The API key to use when talking to the WeChat API.</span></span><br><span class=\"line\"><span class=\"string\">    [ api_secret: &lt;secret&gt; | default = global.wechat_api_secret ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # The WeChat API URL.</span></span><br><span class=\"line\"><span class=\"string\">    [ api_url: &lt;string&gt; | default = global.wechat_api_url ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # The corp id for authentication.</span></span><br><span class=\"line\"><span class=\"string\">    [ corp_id: &lt;string&gt; | default = global.wechat_api_corp_id ]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # API request data as defined by the WeChat API.</span></span><br><span class=\"line\"><span class=\"string\">    # [ message: &lt;tmpl_string&gt; | default = '<span class=\"template-variable\">&#123;&#123; template \"wechat.default.message\" . &#125;&#125;</span>' ]</span></span><br><span class=\"line\"><span class=\"string\">    # [ agent_id: &lt;string&gt; | default = '<span class=\"template-variable\">&#123;&#123; template \"wechat.default.agent_id\" . &#125;&#125;</span>' ]</span></span><br><span class=\"line\"><span class=\"string\">    # [ to_user: &lt;string&gt; | default = '<span class=\"template-variable\">&#123;&#123; template \"wechat.default.to_user\" . &#125;&#125;</span>' ]</span></span><br><span class=\"line\"><span class=\"string\">    # [ to_party: &lt;string&gt; | default = '<span class=\"template-variable\">&#123;&#123; template \"wechat.default.to_party\" . &#125;&#125;</span>' ]</span></span><br><span class=\"line\"><span class=\"string\">    # [ to_tag: &lt;string&gt; | default = '<span class=\"template-variable\">&#123;&#123; template \"wechat.default.to_tag\" . &#125;&#125;</span>' ]</span></span><br><span class=\"line\"><span class=\"string\">  </span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">  email_configs:</span>  </span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;email_config&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  victorops_configs:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;victorops_config&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  pagerduty_configs:</span> <span class=\"comment\"># PagerDuty通知通过PagerDuty API发送</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;pagerduty_config&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  pushover_configs:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;pushover_config&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  slack_configs:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;slack_config&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  opsgenie_configs:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"bullet\">-</span> <span class=\"string\">&lt;opsgenie_config&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 抑制规则列表: 当存在与另一组匹配器匹配的警报（源）时，禁止规则会使与一组匹配器匹配的警报（目标）静音。对于相等列表中的标签名称，目标警报和源警报必须具有相同的标签值。</span></span><br><span class=\"line\"><span class=\"attr\">inhibit_rules:</span></span><br><span class=\"line\">  <span class=\"comment\"># Matchers that have to be fulfilled in the alerts to be muted.</span></span><br><span class=\"line\"><span class=\"attr\">  target_match:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"string\">&lt;labelname&gt;:</span> <span class=\"string\">&lt;labelvalue&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  target_match_re:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"string\">&lt;labelname&gt;:</span> <span class=\"string\">&lt;regex&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Matchers for which one or more alerts have to exist for the</span></span><br><span class=\"line\">  <span class=\"comment\"># inhibition to take effect.</span></span><br><span class=\"line\"><span class=\"attr\">  source_match:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"string\">&lt;labelname&gt;:</span> <span class=\"string\">&lt;labelvalue&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">  source_match_re:</span></span><br><span class=\"line\">    <span class=\"string\">[</span> <span class=\"string\">&lt;labelname&gt;:</span> <span class=\"string\">&lt;regex&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Labels that must have an equal value in the source and target</span></span><br><span class=\"line\">  <span class=\"comment\"># alert for the inhibition to take effect.</span></span><br><span class=\"line\">  <span class=\"string\">[</span> <span class=\"attr\">equal:</span> <span class=\"string\">'['</span> <span class=\"string\">&lt;labelname&gt;,</span> <span class=\"string\">...</span> <span class=\"string\">']'</span> <span class=\"string\">]</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"2-基础示例-2\"><a href=\"#2-基础示例-2\" class=\"headerlink\" title=\"(2) 基础示例\"></a>(2) 基础示例</h4><ul>\n<li><p>1.官方示例: <a href=\"https://github.com/prometheus/alertmanager/blob/master/doc/examples/simple.yml\" target=\"_blank\" rel=\"noopener\">https://github.com/prometheus/alertmanager/blob/master/doc/examples/simple.yml</a></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"comment\"># The smarthost and SMTP sender used for mail notifications.</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_smarthost:</span> <span class=\"string\">'localhost:25'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_from:</span> <span class=\"string\">'alertmanager@example.org'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_auth_username:</span> <span class=\"string\">'alertmanager'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_auth_password:</span> <span class=\"string\">'password'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The directory from which notification templates are read.</span></span><br><span class=\"line\"><span class=\"attr\">templates:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">'/etc/alertmanager/template/*.tmpl'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The root route on which each incoming alert enters.</span></span><br><span class=\"line\"><span class=\"attr\">route:</span></span><br><span class=\"line\"><span class=\"attr\">  receiver:</span> <span class=\"string\">'default-receiver'</span>  <span class=\"comment\"># 默认接收器</span></span><br><span class=\"line\"><span class=\"attr\">  group_by:</span> <span class=\"string\">['alertname',</span> <span class=\"string\">'cluster'</span><span class=\"string\">,</span> <span class=\"string\">'service'</span><span class=\"string\">]</span> <span class=\"comment\"># 用于将传入警报分组在一起的标签。</span></span><br><span class=\"line\"><span class=\"attr\">  group_wait:</span> <span class=\"number\">30</span><span class=\"string\">s</span>    <span class=\"comment\"># 当传入警报创建新的警报组时，请至少等待“group_wait”以发送初始通知。\\</span></span><br><span class=\"line\"><span class=\"attr\">  group_interval:</span> <span class=\"number\">5</span><span class=\"string\">m</span>  <span class=\"comment\"># 发送第一个通知时，请等待“group_interval”以发送一批新警报，这些警报已开始为该组触发。</span></span><br><span class=\"line\"><span class=\"attr\">  repeat_interval:</span> <span class=\"number\">3</span><span class=\"string\">h</span> <span class=\"comment\"># 如果警报已成功发送，请等待“重复间隔”发送警报。</span></span><br><span class=\"line\">  <span class=\"comment\"># - 所有上述属性都由所有子路由继承，并且可以在每个子路由上覆盖。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 子路由设置 </span></span><br><span class=\"line\"><span class=\"attr\">  routes:</span></span><br><span class=\"line\">  <span class=\"comment\"># 此路由对警报标签执行正则表达式匹配，以捕获与服务列表相关的警报。</span></span><br><span class=\"line\"><span class=\"attr\">  - match_re:</span> <span class=\"comment\"># 该服务有一个子路由用于关键警报，即任何不匹配的警报，即 severity != critical，退回到父节点并发送到“team-X-Mail”</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">^(foo1|foo2|baz)$</span></span><br><span class=\"line\"><span class=\"attr\">    receiver:</span> <span class=\"string\">team-X-mails</span>  </span><br><span class=\"line\"><span class=\"attr\">    routes:</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span></span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">critical</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">team-X-pager</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span>  <span class=\"comment\"># 匹配到  service == files 并且 severity == critical 采用 team-Y-pager 接收器发送信息</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">files</span></span><br><span class=\"line\"><span class=\"attr\">    receiver:</span> <span class=\"string\">team-Y-mails</span></span><br><span class=\"line\"><span class=\"attr\">    routes:</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span></span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">critical</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">team-Y-pager</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  - match:</span>   <span class=\"comment\"># 此路由处理来自数据库服务的所有警报。如果没有团队来处理则默认为DB团队。</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">    receiver:</span> <span class=\"string\">team-DB-pager</span></span><br><span class=\"line\"><span class=\"attr\">    group_by:</span> <span class=\"string\">[alertname,</span> <span class=\"string\">cluster,</span> <span class=\"string\">database]</span> <span class=\"comment\"># 还按受影响的数据库对警报进行分组。</span></span><br><span class=\"line\"><span class=\"attr\">    routes:</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span></span><br><span class=\"line\"><span class=\"attr\">        owner:</span> <span class=\"string\">team-X</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">team-X-pager</span></span><br><span class=\"line\"><span class=\"attr\">      continue:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span></span><br><span class=\"line\"><span class=\"attr\">        owner:</span> <span class=\"string\">team-Y</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">team-Y-pager</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 所有service=mysql或service=cassandra的警报都会被发送到数据库寻呼机。</span></span><br><span class=\"line\"><span class=\"attr\">  - receiver:</span> <span class=\"string\">'database-pager'</span></span><br><span class=\"line\"><span class=\"attr\">    group_wait:</span> <span class=\"number\">10</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">    match_re:</span></span><br><span class=\"line\"><span class=\"attr\">      service:</span> <span class=\"string\">mysql|cassandra</span></span><br><span class=\"line\">  <span class=\"comment\"># 所有带有team=frontend标签的警报都与此子路由匹配。它们按产品和环境分组，而不是按集群和警报名称分组。</span></span><br><span class=\"line\"><span class=\"attr\">  - receiver:</span> <span class=\"string\">'frontend-pager'</span></span><br><span class=\"line\"><span class=\"attr\">    group_by:</span> <span class=\"string\">[product,</span> <span class=\"string\">environment]</span></span><br><span class=\"line\"><span class=\"attr\">    match:</span></span><br><span class=\"line\"><span class=\"attr\">      team:</span> <span class=\"string\">frontend</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果另一个警报正在触发，抑制规则允许将一组警报静音。如果同一个警报已经很严重，我们可以使用它来禁用任何警告级别的通知。</span></span><br><span class=\"line\"><span class=\"attr\">inhibit_rules:</span></span><br><span class=\"line\"><span class=\"attr\">- source_match:</span></span><br><span class=\"line\"><span class=\"attr\">    severity:</span> <span class=\"string\">'critical'</span></span><br><span class=\"line\"><span class=\"attr\">  target_match:</span></span><br><span class=\"line\"><span class=\"attr\">    severity:</span> <span class=\"string\">'warning'</span></span><br><span class=\"line\">  <span class=\"comment\"># 如果alertname相同，则应用抑制。</span></span><br><span class=\"line\">  <span class=\"comment\"># 注意：如果源警报和目标警报中都缺少“equal”中列出的所有标签名称，则将应用禁止规则！</span></span><br><span class=\"line\"><span class=\"attr\">  equal:</span> <span class=\"string\">['alertname',</span> <span class=\"string\">'cluster'</span><span class=\"string\">,</span> <span class=\"string\">'service'</span><span class=\"string\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">receivers:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'team-X-mails'</span>  <span class=\"comment\"># team-X-mails 接收器</span></span><br><span class=\"line\"><span class=\"attr\">  email_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - to:</span> <span class=\"string\">'team-X+alerts@example.org'</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'team-X-pager'</span>  <span class=\"comment\"># team-X-pager 接收器</span></span><br><span class=\"line\"><span class=\"attr\">  email_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - to:</span> <span class=\"string\">'team-X+alerts-critical@example.org'</span></span><br><span class=\"line\"><span class=\"attr\">  pagerduty_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - service_key:</span> <span class=\"string\">&lt;team-X-key&gt;</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'team-Y-mails'</span></span><br><span class=\"line\"><span class=\"attr\">  email_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - to:</span> <span class=\"string\">'team-Y+alerts@example.org'</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'team-Y-pager'</span></span><br><span class=\"line\"><span class=\"attr\">  pagerduty_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - service_key:</span> <span class=\"string\">&lt;team-Y-key&gt;</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'team-DB-pager'</span></span><br><span class=\"line\"><span class=\"attr\">  pagerduty_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - service_key:</span> <span class=\"string\">&lt;team-DB-key&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.自定义常用示例:</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\"><span class=\"attr\">  group_wait:</span> <span class=\"number\">30</span><span class=\"string\">s</span>  </span><br><span class=\"line\"><span class=\"attr\">  group_interval:</span> <span class=\"number\">10</span><span class=\"string\">m</span>  </span><br><span class=\"line\"><span class=\"attr\">  repeat_interval:</span> <span class=\"number\">10</span><span class=\"string\">m</span>  </span><br><span class=\"line\"><span class=\"attr\">  resolve_timeout:</span> <span class=\"number\">5</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">  group_by:</span> <span class=\"string\">['alertname','cluster']</span></span><br><span class=\"line\"><span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">'demo.tmpl'</span></span><br><span class=\"line\"><span class=\"attr\">route:</span>  </span><br><span class=\"line\"><span class=\"attr\">  receiver:</span> <span class=\"string\">webhook</span>  </span><br><span class=\"line\"><span class=\"attr\">  group_wait:</span> <span class=\"number\">30</span><span class=\"string\">s</span>  </span><br><span class=\"line\"><span class=\"attr\">  group_interval:</span> <span class=\"number\">10</span><span class=\"string\">m</span>  </span><br><span class=\"line\"><span class=\"attr\">  repeat_interval:</span> <span class=\"number\">10</span><span class=\"string\">m</span>  </span><br><span class=\"line\"><span class=\"attr\">  group_by:</span> <span class=\"string\">['alertname']</span>  </span><br><span class=\"line\"><span class=\"attr\">  routes:</span>  </span><br><span class=\"line\"><span class=\"attr\">  - receiver:</span> <span class=\"string\">webhook</span>    </span><br><span class=\"line\"><span class=\"attr\">    group_wait:</span> <span class=\"number\">10</span><span class=\"string\">s</span>   </span><br><span class=\"line\"><span class=\"attr\">    match:</span>      </span><br><span class=\"line\"><span class=\"attr\">      job_name:</span> <span class=\"string\">mysql|kubernetes</span>  </span><br><span class=\"line\"><span class=\"attr\">  - receiver:</span> <span class=\"string\">'webhook-kafka'</span>    </span><br><span class=\"line\"><span class=\"attr\">    group_by:</span> <span class=\"string\">[instance,</span> <span class=\"string\">alertname]</span>   </span><br><span class=\"line\"><span class=\"attr\">    match_re:</span>      </span><br><span class=\"line\"><span class=\"attr\">      instance:</span> <span class=\"string\">^kafka-(.*)</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># alertmanager抑制\t</span></span><br><span class=\"line\"><span class=\"attr\">inhibit_rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - source_match:</span></span><br><span class=\"line\"><span class=\"attr\">      altername:</span> <span class=\"string\">'Dingtaik api 调用过多'</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">'critical'</span></span><br><span class=\"line\"><span class=\"attr\">    target_macth:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">'warning'</span></span><br><span class=\"line\"><span class=\"attr\">    equal:</span> <span class=\"string\">['alertname','instance']</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">receivers:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">webhook</span>  </span><br><span class=\"line\"><span class=\"attr\">  webhook_configs:</span>  </span><br><span class=\"line\"><span class=\"attr\">  - url:</span> <span class=\"attr\">http://localhost:8060/dingtalk/ops_dingding/send</span>     </span><br><span class=\"line\"><span class=\"attr\">    send_resolved:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">webhook-kafka</span>  </span><br><span class=\"line\"><span class=\"attr\">  webhook_configs:</span>  </span><br><span class=\"line\"><span class=\"attr\">  - url:</span> <span class=\"attr\">http://localhost:8062/dingtalk/ops_59/send</span>   </span><br><span class=\"line\"><span class=\"attr\">    send_resolved:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : 我们没有主动添加新的接收器，建议通过<a href=\"https://prometheus.io/docs/alerting/latest/configuration/#webhook_config\" target=\"_blank\" rel=\"noopener\">webhook</a>接收器实现自定义通知集成。</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"monitor","path":"api/categories/monitor.json"},{"name":"kubernetes","path":"api/categories/kubernetes.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"Prometheus","path":"api/tags/Prometheus.json"}]}