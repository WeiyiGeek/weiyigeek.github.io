{"title":"6.Nginx开发语法与内置常量变量介绍(收集中)","slug":"系统运维/Application/Web/WebApp/Nginx/6.Nginx开发语法与内置常量变量介绍(收集中)","date":"2020-09-02T05:34:30.000Z","updated":"2022-10-10T02:31:22.415Z","url":"2020/9-2-680.html","path":"api/articles/2020/9-2-680.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-内置常变量扩展\"><a href=\"#0x00-内置常变量扩展\" class=\"headerlink\" title=\"0x00 内置常变量扩展\"></a>0x00 内置常变量扩展</h2><h3 id=\"Ngx-变量介绍\"><a href=\"#Ngx-变量介绍\" class=\"headerlink\" title=\"Ngx 变量介绍\"></a>Ngx 变量介绍</h3><table>\n<thead>\n<tr>\n<th>变量名称</th>\n<th>描述说明</th>\n<th>示例演示</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ngx.var.uri</td>\n<td>请求的域名<code>/</code>后的路径字符串但不带?请求参数</td>\n<td><code>/image/weiyigeek.png</code></td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2 id=\"0x01-内置指令扩展\"><a href=\"#0x01-内置指令扩展\" class=\"headerlink\" title=\"0x01 内置指令扩展\"></a>0x01 内置指令扩展</h2><h3 id=\"指令介绍使用\"><a href=\"#指令介绍使用\" class=\"headerlink\" title=\"指令介绍使用\"></a>指令介绍使用</h3><p>internal 关键字: 表示在 location 中加入 “internal” 声明仅限内部调用。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /nodeOne/auth/ &#123;</span><br><span class=\"line\">  internal;</span><br><span class=\"line\">  root  /var/resource/media/;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">location = /check/auth &#123;</span><br><span class=\"line\">  internal;</span><br><span class=\"line\">  proxy_pass http://foo.com/check-spam;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注意：但是由于nginx的if判断中不需要 嵌套和多条件的 &amp;&amp; 和 || ，那就只能分开写啦:<br>nginx的配置中不支持if条件的逻辑与／逻辑或运算 ，并且不支持if的嵌套语法，我们可以用变量的方式来实现：<br>首先是伪代码（即不被nginx支持），写在这里只是为了方便理解：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$remote_addr</span> ~ <span class=\"string\">\"^(12.34|56.78)\"</span> &amp;&amp; <span class=\"variable\">$http_user_agent</span> ~* <span class=\"string\">\"spider\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">return</span> 403;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">下面这是等效的，并真实可用的配置</span><br><span class=\"line\">代码如下:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">set</span> <span class=\"variable\">$flag</span> 0;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$remote_addr</span> ~ <span class=\"string\">\"^(12.34|56.78)\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">set</span> <span class=\"variable\">$flag</span> <span class=\"string\">\"<span class=\"variable\">$&#123;flag&#125;</span>1\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$http_user_agent</span> ~* <span class=\"string\">\"spider\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">set</span> <span class=\"variable\">$flag</span> <span class=\"string\">\"<span class=\"variable\">$&#123;flag&#125;</span>2\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$flag</span> = <span class=\"string\">\"012\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">return</span> 403;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>配置stream 模块（用于tcp和udp的转发）添加用于端口转发的配置文件conf/stream.conf</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">worker_processes  auto;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#error_log  logs/error.log;</span></span><br><span class=\"line\"><span class=\"comment\">#error_log  logs/error.log  notice;</span></span><br><span class=\"line\"><span class=\"comment\">#error_log  logs/error.log  info;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pid        logs/nginx.pid;</span></span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    <span class=\"comment\"># 使用epoll,由系统linux内核2.6提供的高性能方式</span></span><br><span class=\"line\">    use epoll;</span><br><span class=\"line\">    worker_connections  65535;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">stream &#123;</span><br><span class=\"line\">  server &#123;</span><br><span class=\"line\">    listen 9990;</span><br><span class=\"line\">    proxy_pass 172.20.9.80:3306;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  server &#123;</span><br><span class=\"line\">    listen 9992;</span><br><span class=\"line\">    proxy_pass 172.20.9.76:22;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">....</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","comments":true,"excerpt":"[TOC]","categories":[{"name":"基础入门","path":"api/categories/基础入门.json"},{"name":"运维实践","path":"api/categories/运维实践.json"}],"tags":[{"name":"Nginx","path":"api/tags/Nginx.json"}]}