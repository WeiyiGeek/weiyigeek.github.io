<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="ingress-nginx">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-05-28T12:37:47.000Z" itemprop="datePublished" class="page-time">
  2020-05-28
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Kubernetes/">Kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Kubernetes/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">è´Ÿè½½å‡è¡¡</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Ingress-Nginx/Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-05-28 20:37:47" datetime="2020-05-28T12:37:47.000Z"  itemprop="datePublished">2020-05-28</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Kubernetes/">Kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Kubernetes/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">è´Ÿè½½å‡è¡¡</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-Kubernetesä¸­Ingressè·¨åŸŸè®¾ç½®"><a href="#0x00-Kubernetesä¸­Ingressè·¨åŸŸè®¾ç½®" class="headerlink" title="0x00 Kubernetesä¸­Ingressè·¨åŸŸè®¾ç½®"></a>0x00 Kubernetesä¸­Ingressè·¨åŸŸè®¾ç½®</h2><p>æè¿°: åœ¨æ‚¨åœ¨<code>kubernetes</code>æ­å»ºingresså¹¶é€šè¿‡å…¶è®¿é—®é›†ç¾¤å†…éƒ¨éƒ¨ç½²çš„é¡¹ç›®æ—¶ï¼Œæœ‰äº›åŠŸèƒ½å¯èƒ½ä¼šå­˜åœ¨å¦‚ä¸‹æŠ¥é”™ï¼š<code>Access to XMLHttpRequest at ... has been blocked by CORS policy: No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource.</code><br>ä¸Šè¿°é”™è¯¯æç¤ºè¿™æ˜¯ä¸€ä¸ªè·¨åŸŸé—®é¢˜ï¼Œåœ¨ä¼ ç»Ÿé¡¹ç›®ä¸­æˆ‘ä»¬æ›´æ”¹Nginxé…ç½®å³å¯ï¼Œç„¶ååœ¨kubernetesä¸­æˆ–è€…ingressä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å¤„ç†è¿™ç§é—®é¢˜å‘¢ï¼Ÿ</p>
<p><strong>è§£å†³æ–¹å¼</strong><br>æˆ‘ä»¬å¯ä»¥åœ¨<code>kubernetes</code>ä¸­çš„è·¨åŸŸè®¾ç½®åœ¨Ingressä¸­è¿›è¡Œé…ç½®ï¼Œè¦åœ¨Ingressè§„åˆ™ä¸­å¯ç”¨è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰åªéœ€æ·»åŠ å¦‚ä¸‹æ³¨é‡Š: <code>nginx.ingress.kubernetes.io/enable-cors: &quot;true&quot;</code>, é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä½¿ç”¨ä»¥ä¸‹æ³¨é‡Šæ¥æ§åˆ¶CORSã€‚</p>
<ul>
<li><p><code>nginx.ingress.kubernetes.io/cors-allow-methods</code> : æ§åˆ¶æ¥å—å“ªäº›æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªå¤šå€¼å­—æ®µï¼Œä»¥â€ï¼Œâ€åˆ†éš”ï¼Œä»…æ¥å—å­—æ¯ï¼ˆå¤§å†™å’Œå°å†™ï¼‰ï¼Œé»˜è®¤<code>GET, PUT, POST, DELETE, PATCH, OPTIONS</code>ã€‚</p>
</li>
<li><p><code>nginx.ingress.kubernetes.io/cors-allow-headers</code> : æ§åˆ¶æ¥å—å“ªäº›Headerè¯·æ±‚å¤´ã€‚è¿™æ˜¯ä¸€ä¸ªå¤šå€¼å­—æ®µï¼Œä»¥â€ï¼Œâ€åˆ†éš”ï¼Œå¹¶æ¥å—å­—æ¯ï¼Œæ•°å­—ï¼Œ_å’Œ-ã€‚é»˜è®¤ï¼š <code>DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</code></p>
</li>
<li><p><code>nginx.ingress.kubernetes.io/cors-expose-headers</code>: æ§åˆ¶å“ªäº›å“åº”å¤´æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚è¿™æ˜¯ä¸€ä¸ªå¤šå€¼å­—æ®µï¼Œä»¥â€ï¼Œâ€åˆ†éš”ï¼Œå¹¶æ¥å—å­—æ¯ï¼Œæ•°å­—ï¼Œ_ï¼Œ-å’Œã€‚é»˜è®¤å€¼ï¼šç©ºã€‚ä¾‹ï¼š<code>nginx.ingress.kubernetes.io/cors-expose-headers: &quot;Version, X-CustomResponseHeader&quot;</code></p>
</li>
<li><p><code>nginx.ingress.kubernetes.io/cors-allow-origin</code>: æ§åˆ¶CORSæ¥å—çš„åŸäº§åœ°ã€‚è¿™æ˜¯ä¸€ä¸ªå•å­—æ®µå€¼ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š<code>http(s)://origin-site.comæˆ–http(s)://origin-site.com:port</code>ï¼Œé»˜è®¤ï¼š *ï¼Œä¾‹ï¼š <code>nginx.ingress.kubernetes.io/cors-allow-origin: &quot;https://origin-site.com:4443&quot;</code></p>
</li>
<li><p><code>nginx.ingress.kubernetes.io/cors-allow-credentials</code>: æ§åˆ¶åœ¨CORSæ“ä½œæœŸé—´æ˜¯å¦å¯ä»¥ä¼ é€’å‡­æ®ã€‚é»˜è®¤ï¼š trueï¼Œä¾‹ï¼š <code>nginx.ingress.kubernetes.io/cors-allow-credentials: &quot;false&quot;</code></p>
</li>
<li><p><code>nginx.ingress.kubernetes.io/cors-max-age</code>: æ§åˆ¶å¯ä»¥å°†é¢„æ£€è¯·æ±‚ç¼“å­˜å¤šé•¿æ—¶é—´ã€‚é»˜è®¤å€¼ï¼š1728000 ç¤ºä¾‹ï¼š<code>nginx.ingress.kubernetes.io/cors-max-age: 600</code></p>
</li>
</ul>
<p><strong>ç¤ºä¾‹æ¼”ç¤º</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">front-web</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">front-web</span></span><br><span class="line"><span class="attr">    ref:</span> <span class="string">front</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/enable-cors:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">"GET, POST"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="string">"Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/cors-expose-headers:</span> <span class="string">"Version, X-CustomResponseHeader"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/cors-allow-credentials:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.ingress.allowOrigin</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/cors-max-age:</span> <span class="number">600</span></span><br></pre></td></tr></table></figure></p>
<p>Ingress CORSå®˜æ–¹æ–‡æ¡£: <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors</a></p>
<hr>
<h2 id="0x01-Kubernetesä¸­ingress-nginxæ–‡ä»¶ä¸Šä¼ ä»£ç†è®¿é—®è¶…æ—¶è®¾ç½®"><a href="#0x01-Kubernetesä¸­ingress-nginxæ–‡ä»¶ä¸Šä¼ ä»£ç†è®¿é—®è¶…æ—¶è®¾ç½®" class="headerlink" title="0x01 Kubernetesä¸­ingress-nginxæ–‡ä»¶ä¸Šä¼ ä»£ç†è®¿é—®è¶…æ—¶è®¾ç½®"></a>0x01 Kubernetesä¸­ingress-nginxæ–‡ä»¶ä¸Šä¼ ä»£ç†è®¿é—®è¶…æ—¶è®¾ç½®</h2><p>æè¿°: æ—©ä¸Šå¼€å‘ä¸€å¼  <code>504 gateway time-out</code>ç•Œé¢æˆªå›¾ç»™æˆ‘, è¯´æ˜¯åœ¨åå°å¯¼å‡º1æ•°æ®ä¸€åˆ†é’Ÿåæ˜¾ç¤ºæ­¤é”™è¯¯é¡µé¢ï¼Œç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡æ˜¯é€šè¿‡K8så’Œingressæä¾›å¤–éƒ¨è®¿é—®çš„ï¼Œ</p>
<p>é”™è¯¯åŸå› : åå°åº”ç”¨ç•Œé¢ä¸ºä½¿ç”¨ingressæ–¹å¼è®¿é—®, æ‰€ä»¥é—®é¢˜ç‚¹åœ¨<code>ingress-nginx-controller</code>æœ‰å…³ï¼Œé€šè¿‡æŸ¥è¯¢å‘ç°ingressæŠ¥<code>504 gateway time-out</code>é”™è¯¯ï¼Œé€šå¸¸ä¸<code>proxy timeout</code>æœ‰å…³ã€‚<br>ç”±äºé»˜è®¤çš„<code>ingress-nginx-controller</code>é…ç½®çš„<code>nginx.conf</code>çš„å‡ ä¸ª<code>timeout</code>å‚æ•°éƒ½æ˜¯60 æ­¤å¤„ä¿®æ”¹ä¸º300ï¼Œè¯·æ ¹æ®åº”ç”¨å®é™…æƒ…å†µä¿®æ”¹ã€‚</p>
<p><br/></p>
<p><strong>è§£å†³åŠæ³•:</strong><br>æè¿°: ä¿®æ”¹è¯¥åº”ç”¨åŸŸåæ‰€å¯¹åº”çš„çš„ingressèµ„æºï¼Œåœ¨<code>metadata-annotations</code>ä¸‹é¢å¢åŠ å¦‚ä¸‹å‡ è¡Œã€‚<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">nginx.ingress.kubernetes.io/proxy-connect-timeout:</span> <span class="string">"30"</span>   <span class="comment"># æ³¨æ„,æ­¤å€¼ä¸èƒ½è¶…è¿‡75.</span></span><br><span class="line"><span class="string">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="string">"120"</span></span><br><span class="line"><span class="string">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="string">"120"</span></span><br></pre></td></tr></table></figure></p>
<p><strong>æ‰©å±•çŸ¥è¯†1.æ–‡ä»¶å¤ªå¤§æŠ¥413ï¼šRequest Entity Too Large</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è§£å†³åŠæ³•:åˆ›å»º ingress æ—¶æ·»åŠ  annotationsï¼ˆæ³¨é‡Šï¼‰</span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-body-size: 1024m</span><br></pre></td></tr></table></figure></p>
<p><strong>æ‰©å±•çŸ¥è¯†2.å½“http çš„URIå¤ªé•¿æˆ–è€…request headerè¿‡å¤§æ—¶ä¼šæŠ¥414 Request URI too largeæˆ–400 bad requesté”™è¯¯è§£å†³åŠæ³•</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¢æˆ·ç«¯è¯·æ±‚å¤´ç¼“å†²åŒºå¤§å°</span></span><br><span class="line"><span class="string">client_header_buffer_size</span> <span class="number">128</span><span class="string">k;</span>  </span><br><span class="line"><span class="comment"># è¯·æ±‚å¤´æ€»é•¿åº¦å¤§äº128kæ—¶ä½¿ç”¨å¦‚ä¸‹è®¾ç½®çš„ç¼“å­˜åŒº</span></span><br><span class="line"><span class="string">large_client_header_buffers</span> <span class="number">4</span> <span class="number">128</span><span class="string">k;</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x02-Kubernetesä¸­ingress-nginxè·å–çœŸå®å®¢æˆ·ç«¯IP"><a href="#0x02-Kubernetesä¸­ingress-nginxè·å–çœŸå®å®¢æˆ·ç«¯IP" class="headerlink" title="0x02 Kubernetesä¸­ingress-nginxè·å–çœŸå®å®¢æˆ·ç«¯IP"></a>0x02 Kubernetesä¸­ingress-nginxè·å–çœŸå®å®¢æˆ·ç«¯IP</h2><p>æè¿°: æœ€è¿‘å°†éƒ¨åˆ†ä¸šåŠ¡é€šè¿‡Ingressè¿›è¡Œå‘å¸ƒç®¡ç†, ä»è€Œå®ç°åº”ç”¨ç°è“å‘å¸ƒã€é‡‘ä¸é›€å‘å¸ƒï¼Œæ›´è´´è¿‘å½“ä¸‹è‡ªåŠ¨åŒ–è¿ç»´æŠ€æœ¯çš„å‘å±•ï¼Œå¹¶ä¸ºäº†è¿›è¡Œå®ç°ä¸ƒå±‚è‡ªå®šä¹‰è´Ÿè½½è½¬å‘, å°†ä¸åŒåº”ç”¨ç¨‹åºé…ç½®åˆ°æŒ‡å®šä¸šåŠ¡åŸŸåä¸‹ä¸åŒçš„ç›®å½•ï¼Œå¹¶å‡å°‘ä¸šåŠ¡ç®¡ç†å¤æ‚åŒ–ï¼ŒåŒæ—¶èŠ‚çº¦åŸŸåèµ„æºï¼Œå³å¤šä¸ªä¸šåŠ¡å¯ä»¥é€šè¿‡ä¸€ä¸ªåŸŸåå‡ºå»æä¾›æœåŠ¡ã€‚</p>
<p>ä½†æ˜¯åœ¨å®é™…ç¯å¢ƒä¸­å´å‘ç°ä¸€ä¸ªå°é—®é¢˜ï¼Œåœ¨é€šè¿‡ingress-nginxè®¿é—®åç«¯åº”ç”¨æ—¶ï¼Œæ— æ³•æ— æ³•è·å–çœŸå®çš„å®¢æˆ·ç«¯IPï¼Œå› ä¸ºé€šå¸¸ç”¨æˆ·ipçš„ä¼ é€’ä¾é çš„æ˜¯X-Forwarded-*å‚æ•°ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹ingressæ˜¯æ²¡æœ‰å¼€å¯çš„ï¼Œå…¶ä¸­åˆç”±äº<code>Ingress-Nginx</code>å‰ç«¯ä»£ç†æ˜¯é‡‡ç”¨ç¡¬ä»¶è´Ÿè½½å°†çœŸå®IPè®°å½•åœ¨è‡ªå®šä¹‰Headerä¸­ï¼Œæ‰€ä»¥ç»è¿‡ä¸€å¤©çš„èµ„æ–™æŸ¥æ‰¾ä¸å®è·µï¼Œæœ€ç»ˆå°†è¯¥é—®é¢˜è¿›è¡Œè§£å†³ï¼Œä¸‹é¢å°†è®°ä¸€æ³¢è§£å†³æ€è·¯æµç¨‹å’Œé…ç½®å®è·µã€‚</p>
<p><strong>ç¯å¢ƒè¯´æ˜</strong></p>
<ul>
<li>1.é€»è¾‘è¯·æ±‚è®¿é—®æµç¨‹: å®¢æˆ·ç«¯ -&gt; è¾¹ç•Œé˜²ç«å¢™ -&gt; A10ï¼ˆç¡¬ä»¶ï¼‰è´Ÿè½½å‡è¡¡ -&gt; Ingrees-Nginx -&gt; statefulsets.apps (åº”ç”¨é…ç½®ã€æ‰©å®¹åŠå…¶ç”Ÿå‘½ç®¡ç†) -&gt; Pod (åº”ç”¨ç¨‹åº)ã€‚</li>
<li>2.A10ç¡¬ä»¶è´Ÿè½½å‡è¡¡: åœ¨ç¡¬ä»¶è´Ÿè½½å‡è¡¡ä¸Šè®¾ç½®è¯¥ä¸šåŠ¡åŸŸåçš„SSLï¼Œå³å®ç°å¤–ç½‘è®¿é—®<code>https-&gt;è½¬å†…ç½‘-&gt;http</code>ã€‚</li>
<li>3.ingress-nginxéƒ¨ç½²è¯´æ˜: ç”±helméƒ¨ç½²çš„ingressåç§°ç©ºé—´ kube-baseã€‚</li>
<li>4.ingress-nginx-controller çš„ Rule åŠå…¶ ConfigMap é…ç½®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ï¼ˆ1ï¼‰è‡ªå®šä¹‰ingressç®¡ç†åŸŸååç«¯æ˜ å°„é…ç½®</span></span><br><span class="line">$ kubectl get ingress -n app weiyigeek-app</span><br><span class="line">  <span class="comment"># NAME        CLASS           HOSTS          ADDRESS       PORTS   AGE</span></span><br><span class="line">  <span class="comment"># weiyigeek-app   ingress-nginx   app.weiyigeek.top   11.20.7.61   80      41d</span></span><br><span class="line"><span class="comment"># å…³é”®é…ç½®</span></span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: ingress-nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: app.weiyigeek.top</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: app-shangbao</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">        path: /shangbao/</span><br><span class="line">        pathType: ImplementationSpecific</span><br><span class="line"></span><br><span class="line"><span class="comment"># ï¼ˆ2ï¼‰ingress-nginx-controller æ§åˆ¶å™¨ services æœåŠ¡æŸ¥çœ‹</span></span><br><span class="line">$ kubectl get svc -n kube-base ingress-nginx-controller</span><br><span class="line">  <span class="comment"># NAME                       TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)                      AGE</span></span><br><span class="line">  <span class="comment"># ingress-nginx-controller   NodePort   11.20.7.61   &lt;none&gt;        80:30080/TCP,443:30443/TCP   332d</span></span><br><span class="line">$ kubectl get svc -n kube-base ingress-nginx-controller</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    k8s.kuboard.cn/workload: ingress-nginx-controller</span><br><span class="line">    meta.helm.sh/release-name: ingress-nginx</span><br><span class="line">    meta.helm.sh/release-namespace: kube-base</span><br><span class="line">  creationTimestamp: <span class="string">"2021-02-15T04:57:22Z"</span></span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: kube-base</span><br><span class="line">  resourceVersion: <span class="string">"82785800"</span></span><br><span class="line">  uid: 79ac32ad-82a6-4a77-b5ad-71d30ebb07c5</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 11.20.7.61</span><br><span class="line">  clusterIPs:</span><br><span class="line">  - 11.20.7.61</span><br><span class="line">  externalTrafficPolicy: Cluster  <span class="comment"># å…³é”®ç‚¹</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    nodePort: 30080</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  - name: https</span><br><span class="line">    nodePort: 30443</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 443</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 01.é€šè¿‡ä¸šåŠ¡åç«¯æ—¥å¿—å‘ç°è·å–çš„åœ°å€ä¸ºK8Sçš„masterèŠ‚ç‚¹åœ°å€ï¼Œè€ŒéçœŸå®çš„IPåœ°å€<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¥å¿—</span></span><br><span class="line">2022-01-13 09:59:19.365 [http-nio-80-exec-10] INFO  com.******.aop.AspectHandler-Access of com.******.controller.PageController.toPage?index  [IP]10.41.40.26,10.41.40.26,172.20.170.128,</span><br><span class="line">2022-01-13 09:59:19.367 [http-nio-80-exec-10] INFO  com.******.aop.AspectHandler-Return of com.******.controller.PageController.toPage:shangbao/index  [IP]10.41.40.26,10.41.40.26,172.20.170.128,</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¨‹åºä¸­è·å–çœŸå®IPåœ°å€çš„è¯·æ±‚å¤´å‡ ç§Header.</span></span><br><span class="line">String ip0 = request.getHeader(<span class="string">"X-Real-IP"</span>);</span><br><span class="line">String ip1 = request.getHeader(<span class="string">"X_FORWARDED_FOR"</span>);</span><br><span class="line">String ip2 = request.getHeader(<span class="string">"X-Forwarded-For"</span>);</span><br><span class="line">String ip3 = request.getHeader(<span class="string">"Proxy-Client-IP"</span>);</span><br><span class="line">String ip4 = request.getHeader(<span class="string">"WL-Proxy-Client-IP"</span>);</span><br><span class="line">String ip5 = request.getHeader(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">String ip6 = request.getHeader(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">String ip7 = request.getHeader(<span class="string">"x-Original-Forwarded-For"</span>);</span><br><span class="line">String ip8 = request.getRemoteAddr();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>step 02.é€šè¿‡æŠ“å–A10è´Ÿè½½å‡è¡¡æµé‡åŠå…¶A10è®¿é—®ingress-nginxçš„æµé‡ï¼Œå‘ç°ç¡¬ä»¶è´Ÿè½½å‡è¡¡çœŸå®IPå¸¦å…¥è®°å½•çš„<code>Header</code>å­—æ®µæ˜¯ <code>X_FORWARDED_FOR</code>, è¿™æ ·åšçš„å¥½åˆæ˜¯é˜²æ­¢å®¢æˆ·ç«¯è¯·æ±‚æ—¶ä¼ªé€ çœŸå®IPã€‚</li>
</ul>
<figure class="image-box">
                <a rel=Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20220113212607.png" target="_blank" title="WeiyiGeek.A10è®¿é—®ingress-nginxçš„æµé‡" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20220113212607.png" alt="WeiyiGeek.A10è®¿é—®ingress-nginxçš„æµé‡" title="" class=""></a>
                <p>WeiyiGeek.A10è®¿é—®ingress-nginxçš„æµé‡</p>
            </figure>
<p><br/></p>
<ul>
<li>Step 03.æƒ³è¦Ingress-Nginxä¼ é€’è‡ªå®šä¹‰çš„<code>X_FORWARDED_FOR</code>å­—æ®µ,æˆ‘ä»¬éœ€è¦åœ¨ ingress-nginx é…ç½®å­—å…¸ä¸­åŠ å…¥å¦‚ä¸‹é…ç½®.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½® ingress-nginx å­—å…¸æ›´æ”¹åä¼šè‡ªåŠ¨æ›´æ–°è¿›ingress-nginxçš„PODä¸­/etc/nginx/nginx.confçš„æ–‡ä»¶é‡Œã€‚</span></span><br><span class="line">$ kubectl get cm -n kube-base ingress-nginx-controller -o yaml</span><br><span class="line">$ kubectl edit cm -n kube-base ingress-nginx-controller</span><br><span class="line">apiVersion: v1</span><br><span class="line">  data:</span><br><span class="line">    <span class="built_in">enable</span>-underscores-in-headers: <span class="string">"true"</span></span><br><span class="line">    use-forwarded-headers: <span class="string">"true"</span></span><br><span class="line">    forwarded-for-header: X_FORWARDED_FOR</span><br><span class="line">    compute-full-forwarded-for: <span class="string">"true"</span></span><br><span class="line">    proxy-real-ip-cidr: 192.168.4.11,192.168.10.11 </span><br><span class="line"></span><br><span class="line"><span class="comment"># å…·ä½“çš„ ingres-nginx çš„ configMap é…ç½®</span></span><br><span class="line">tee ingress-nginx-controller-cm.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  allow-snippet-annotations: <span class="string">"true"</span></span><br><span class="line">  compute-full-forwarded-for: <span class="string">"true"</span></span><br><span class="line">  <span class="built_in">enable</span>-real-ip: <span class="string">"true"</span></span><br><span class="line">  <span class="built_in">enable</span>-underscores-in-headers: <span class="string">"true"</span></span><br><span class="line">  forwarded-for-header: X_FORWARDED_FOR</span><br><span class="line">  proxy-real-ip-cidr: 192.168.10.1/24,10.41.40.21/28,172.20.0.0/16</span><br><span class="line">  proxy-set-headers: X_FORWARDED_FOR</span><br><span class="line">  use-forwarded-headers: <span class="string">"true"</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.2.0</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><strong>å‚æ•°è§£æ:</strong></p>
<ol>
<li><p><code>enable-underscores-in-headers</code>: æ˜¯å¦åœ¨æ ‡é¢˜åç§°ä¸­å¯ç”¨ä¸‹åˆ’çº¿, ç¼ºçœé»˜è®¤ä¸ºoffï¼Œè¡¨ç¤ºå¦‚æœè¯·æ±‚ä¸­<code>header name</code> ä¸­åŒ…å«ä¸‹åˆ’çº¿ï¼Œåˆ™å¿½ç•¥æ‰ä¸ä¼šä¼ é€’åˆ°åç«¯ä»£ç†æˆ–è€…åº”ç”¨ç¨‹åºï¼Œå³è·å–ä¸åˆ°è¯¥Headerï¼Œæ‰€ä»¥æ­¤å¤„ä¸ºäº†ä¸ä¸¢å¼ƒA10ä¼ é€’è¿‡æ¥çš„ <code>X_FORWARDED_FOR</code> Header éœ€è¦å°†è¯¥å‚æ•°è®¾ç½®ä¸ºTrueã€‚</p>
</li>
<li><p><code>use-forwarded-headers</code>: å¦‚æœè®¾ç½®ä¸ºTrueæ—¶ï¼Œåˆ™å°†è®¾å®šçš„<code>X-Forwarded-*</code> Headerä¼ é€’ç»™åç«¯, å½“Ingressåœ¨<code>L7 ä»£ç†/è´Ÿè½½å‡è¡¡å™¨</code>ä¹‹åä½¿ç”¨æ­¤é€‰é¡¹ã€‚ å¦‚æœè®¾ç½®ä¸º false æ—¶ï¼Œåˆ™ä¼šå¿½ç•¥ä¼ å…¥çš„<code>X-Forwarded-*</code>Header, å½“ Ingress ç›´æ¥æš´éœ²åœ¨äº’è”ç½‘æˆ–è€… L3/æ•°æ®åŒ…çš„è´Ÿè½½å‡è¡¡å™¨åé¢,å¹¶ä¸”ä¸ä¼šæ›´æ”¹æ•°æ®åŒ…ä¸­çš„æº IPè¯·ä½¿ç”¨æ­¤é€‰é¡¹ã€‚</p>
</li>
<li><p><code>forwarded-for-header</code>: è®¾ç½®ç”¨äºæ ‡è¯†å®¢æˆ·ç«¯çš„åŸå§‹ IP åœ°å€çš„ Header å­—æ®µã€‚é»˜è®¤å€¼<code>X-Forwarded-For</code>ï¼Œæ­¤å¤„ç”±äºA10å¸¦å…¥çš„æ˜¯è‡ªå®šä¹‰è®°å½•IPçš„Header,æ‰€ä»¥æ­¤å¤„å¡«å…¥æ˜¯<code>X_FORWARDED_FOR</code>.</p>
</li>
<li><p><code>compute-full-forwarded-for</code>: å°† remote address é™„åŠ åˆ° X-Forwarded-For Headerè€Œä¸æ˜¯æ›¿æ¢å®ƒã€‚å½“å¯ç”¨æ­¤é€‰é¡¹åç«¯åº”ç”¨ç¨‹åºè´Ÿè´£æ ¹æ®è‡ªå·±çš„å—ä¿¡ä»»ä»£ç†åˆ—è¡¨æ’é™¤å¹¶æå–å®¢æˆ·ç«¯ IPã€‚</p>
</li>
<li><p><code>proxy-real-ip-cidr</code>: å¦‚æœå¯ç”¨ <code>use-forwarded-headers</code> æˆ– <code>use-proxy-protocol</code>ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¯¥å‚æ•°å…¶å®šä¹‰äº†å¤–éƒ¨è´Ÿè½½è¡¡å™¨ ã€ç½‘ç»œä»£ç†ã€CDNç­‰åœ°å€ï¼Œå¤šä¸ªåœ°å€å¯ä»¥ä»¥é€—å·åˆ†éš”çš„ CIDR ã€‚é»˜è®¤å€¼: â€œ0.0.0.0/0â€</p>
</li>
</ol>
<p>Tips: ä¸ºäº†ç»Ÿä¸€å¯ç§»æ¤æ€§ï¼Œåœ¨ç¨‹åºè®¾ç½®æˆ–è€…ç¡¬ä»¶è´Ÿè½½è½¬å‘ä¸­ï¼Œè½¬å‘ã€è®¾ç½®çš„ header é‡Œä¸å»ºè®®é‡‡ç”¨<code>&quot;_&quot;ä¸‹åˆ’çº¿</code>,å¯ä»¥ç”¨<code>é©¼å³°å‘½å</code>æˆ–è€…å…¶ä»–çš„ç¬¦å·<code>(å¦‚å‡å·-)</code>è¿›è¡Œä»£æ›¿ï¼Œä¸Šè¿°çš„<code>X_FORWARDED_FOR</code>å­—æ®µæŠŠæˆ‘æ˜¯å‘å¾—ï¼Œæ¬²å“­æ— æ³ªã€‚<br><br></p>
<p>ä¸Šè¿°å‚æ•°é…ç½®ååœ¨<code>ingress-nginx-control</code>ä¸­çš„<code>/etc/nginx/nginx.conf</code>ç»“æœå¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use-forwarded-headers å‚æ•°è®¾ç½®å</span></span><br><span class="line">real_ip_header      X_FORWARDED_FOR;</span><br><span class="line">real_ip_recursive   on;</span><br><span class="line">set_real_ip_from    192.168.10.11;</span><br><span class="line">set_real_ip_from    192.168.4.11;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We can't use $proxy_add_x_forwarded_for because the realip module replaces the remote_addr too soon</span></span><br><span class="line"><span class="comment"># æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ `$proxy_add_x_forwarded_for`, å› ä¸º realip æ¨¡å—è¿‡æ—©åœ°æ›¿æ¢äº†è¿œç¨‹ remote_addrã€‚</span></span><br><span class="line">map <span class="variable">$http_x_forwarded_for</span> <span class="variable">$full_x_forwarded_for</span> &#123;</span><br><span class="line">  default          <span class="string">"<span class="variable">$http_x_forwarded_for</span>, <span class="variable">$realip_remote_addr</span>"</span>;</span><br><span class="line">  <span class="string">''</span>               <span class="string">"<span class="variable">$realip_remote_addr</span>"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<ul>
<li>Step 04.ä¸ºäº†åœ¨åç«¯æ¼”ç¤º<code>ingress-nginx</code>ä¼ é€’è¿‡æ¥çš„å‚æ•°, åˆ›å»ºä¸€ä¸ªnginxåº”ç”¨åœ¨log_formatå‚æ•°è®¾ç½®å¦‚ä¸‹<code>&quot;$http_X_FORWARDED_FOR&quot; - &quot;$http_X_Real_IP&quot;&#39;</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/nginx/nginx.conf</span></span><br><span class="line">log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">  <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">  <span class="string">'"$http_user_agent" "$http_x_forwarded_for" - "$http_X_FORWARDED_FOR" - "$http_X_Real_IP"'</span>;</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ "10.41.40.22" -- "10.41.40.22" --  "10.20.172.103"  </span></span><br><span class="line"></span><br><span class="line">proxy_set_header X-Real-IP              <span class="variable">$remote_addr</span>;   <span class="comment"># realip æ¨¡å— å·²ç»å°† X_FORWARDED_FOR å­—æ®µèµ‹å€¼ç»™ $remote_addr, æ‰€ä»¥è¯¥å­—æ®µä¹Ÿè®°å½•äº†çœŸå®IP.</span></span><br><span class="line">proxy_set_header X-Forwarded-For        <span class="variable">$full_x_forwarded_for</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips: <code>remote_addr</code>: ä»£è¡¨å®¢æˆ·ç«¯çš„IPï¼Œä½†å®ƒçš„å€¼ä¸æ˜¯ç”±å®¢æˆ·ç«¯æä¾›çš„ï¼Œè€Œæ˜¯æœåŠ¡ç«¯æ ¹æ®å®¢æˆ·ç«¯çš„ipæŒ‡å®šçš„ï¼Œå¦‚æœä½ ä½¿ç”¨äº†ä»£ç†åˆ™è¯¥å­—æ®µè®°å½•çš„çš„æ˜¯ä»£ç†IPã€‚<br>Tips: <code>X-Forwarded-For</code>: ç®€ç§° XFF å®ƒæ˜¯ä¸€ä¸ªå¤´éƒ¨æ‰©å±•,TTPåè®®å¹¶æ²¡æœ‰å¯¹å®ƒçš„å®šä¹‰ï¼Œå®ƒæœ€å¼€å§‹æ˜¯ç”± Squid è¿™ä¸ªç¼“å­˜ä»£ç†è½¯ä»¶å¼•å…¥ç”¨æ¥è¡¨ç¤º HTTP è¯·æ±‚ç«¯çœŸå® IPï¼Œå½“å‰è¢«å„å¤§ HTTP ä»£ç†ã€è´Ÿè½½å‡è¡¡ç­‰è½¬å‘æœåŠ¡å¹¿æ³›ä½¿ç”¨å¹¶è¢«å†™å…¥ RFC 7239ï¼ˆForwarded HTTP Extensionï¼‰æ ‡å‡†ä¹‹ä¸­ï¼Œæ ¼å¼ä¸º:<code>X-Forwarded-For: client, proxy1, proxy2</code>ï¼ˆæ³¨æ„ï¼šå¦‚æœæœªç»ä¸¥æ ¼å¤„ç†å¯ä»¥è¢«ä¼ªé€ ï¼‰ï¼Œä¾‹å¦‚å¦‚æœä¸€ä¸ª HTTP è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ä¹‹å‰ï¼Œç»è¿‡äº†ä¸‰ä¸ªä»£ç† Proxy1ã€Proxy2ã€Proxy3ï¼ŒIP åˆ†åˆ«ä¸º IP1ã€IP2ã€IP3ï¼Œç”¨æˆ·çœŸå® IP ä¸º IP0ï¼Œè€ŒæœåŠ¡ç«¯X-Forwarded-For è¾“å‡ºçš„æ˜¯IP0, IP1, IP2ï¼ŒProxy3 ç›´è¿æœåŠ¡å™¨ï¼Œå®ƒä¼šç»™ XFF è¿½åŠ  IP2ï¼Œè¡¨ç¤ºå®ƒæ˜¯åœ¨å¸® Proxy2 è½¬å‘è¯·æ±‚ï¼Œæ‰€ä»¥è¯´åˆ—è¡¨ä¸­å¹¶æ²¡æœ‰ IP3ï¼ŒIP3 å¯ä»¥åœ¨æœåŠ¡ç«¯é€šè¿‡ Remote Address å­—æ®µè·å¾—<br>Tips: <code>X-Real-IP</code>: è‡ªå®šä¹‰å¤´éƒ¨å­—æ®µï¼Œé€šå¸¸è¢« HTTP ä»£ç†ç”¨æ¥è¡¨ç¤ºä¸å®ƒäº§ç”Ÿ TCP è¿æ¥çš„è®¾å¤‡ IPï¼Œè¯¥è®¾å¤‡å¯èƒ½æ˜¯å…¶ä»–ä»£ç†ï¼Œä¹Ÿå¯èƒ½æ˜¯çœŸæ­£çš„è¯·æ±‚ç«¯ï¼Œå…³é”®è¦çœ‹ç»è¿‡ä»£ç†çš„å±‚çº§æ¬¡æ•°æˆ–æ˜¯æ˜¯å¦å§‹ç»ˆå°†çœŸå®IPä¸€è·¯ä¼ ä¸‹æ¥ï¼ˆæ³¨æ„ï¼šå¦‚æœæœªç»ä¸¥æ ¼å¤„ç†ï¼Œå¯ä»¥è¢«ä¼ªé€ ï¼‰ã€‚</p>
<p><br/></p>
<ul>
<li>Step 05.åœ¨åº”ç”¨ Pod ä¸­è¿›è¡Œåˆ©ç”¨tcpdumpæŠ“åŒ…ï¼Œæ—¥å¿—è®°å½•çœŸå®IPå’Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤º:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it -n app shangbao-text sh</span><br><span class="line"><span class="comment"># tcpdump -nnX port 80 -vv -w test.pcap </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—æ•ˆæœ:</span></span><br><span class="line">2022-01-13 22:31:00.178  INFO 1 --- [p-nio-80-exec-4] com.******.aop.AspectHandler: Access of com.******.controller.PageController.toPage?index  [IP]183.222.192.169,183.222.192.169,10.41.40.21,172.20.35.192,</span><br><span class="line">2022-01-13 22:31:00.180  INFO 1 --- [p-nio-80-exec-4] com.******.aop.AspectHandler: Return of com.******.controller.PageController.toPage:shangbao/index  [IP]183.222.192.169,183.222.192.169,10.41.40.21,172.20.35.192,</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20220113222702.png" target="_blank" title="WeiyiGeek.åœ¨Podä¸­æŠ“åŒ…ä½¿ç”¨wirshakeæ‰“å¼€" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20220113222702.png" alt="WeiyiGeek.åœ¨Podä¸­æŠ“åŒ…ä½¿ç”¨wirshakeæ‰“å¼€" title="" class=""></a>
                <p>WeiyiGeek.åœ¨Podä¸­æŠ“åŒ…ä½¿ç”¨wirshakeæ‰“å¼€</p>
            </figure>
<p>å®˜æ–¹æ–‡æ¡£åœ°å€: <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#proxy-real-ip-cidr" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#proxy-real-ip-cidr</a></p>
<p><strong>çŸ¥è¯†è¡¥å……: Ingress Podä¸­æ— æ³•ä¿ç•™æºIP</strong><br>é—®é¢˜ç°è±¡: Ingress Podä¸­æ— æ³•ä¿ç•™çœŸå®å®¢æˆ·ç«¯IPï¼Œæ˜¾ç¤ºä¸ºèŠ‚ç‚¹IPæˆ–100.XX.XX.XXç½‘æ®µæˆ–å…¶å®ƒåœ°å€ã€‚</p>
<p>é—®é¢˜åŸå› : Ingressæ‰€ä½¿ç”¨çš„Serviceä¸­<code>externalTrafficPolicy</code>è®¾ä¸ºäº†Cluster, SLBä¸Šä½¿ç”¨äº†ä¸ƒå±‚ä»£ç†, ä½¿ç”¨äº†WAFæ¥å…¥æˆ–WAFé€æ˜æ¥å…¥æœåŠ¡ã€‚<br>è§£å†³æ–¹æ¡ˆ:</p>
<ul>
<li>å¯¹äºè®¾ç½®externalTrafficPolicyä¸ºClusterï¼Œä¸”å‰ç«¯ä½¿ç”¨äº†å››å±‚SLBçš„æƒ…å†µã€‚å¯ä»¥å°†externalTrafficPolicyæ”¹ä¸ºLocalã€‚ä½†å¯èƒ½ä¼šå¯¼è‡´é›†ç¾¤å†…éƒ¨ä½¿ç”¨SLB IPè®¿é—®Ingressä¸é€šï¼Œå…·ä½“è§£å†³æ–¹æ¡ˆï¼Œè¯·å‚è§é›†ç¾¤å†…è®¿é—®é›†ç¾¤LoadBalanceræš´éœ²çš„SLBåœ°å€ä¸é€šã€‚</li>
<li>å¯¹äºä½¿ç”¨äº†ä¸ƒå±‚ä»£ç†ï¼ˆä¸ƒå±‚SLBã€WAFã€é€æ˜WAFï¼‰çš„æƒ…å†µï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤è§£å†³ï¼š<br>ç¡®ä¿ä½¿ç”¨çš„ä¸ƒå±‚ä»£ç†ä¸”å¼€å¯äº†X-Forwarded-Forè¯·æ±‚å¤´ã€‚<br>åœ¨Ingress Controllerçš„ConfigMapä¸­ï¼ˆé»˜è®¤ä¸ºkube-systemå‘½åç©ºé—´ä¸‹çš„nginx-configurationï¼‰æ·»åŠ enable-real-ip: â€œtrueâ€ã€‚<br>è§‚å¯Ÿæ—¥å¿—ï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥è·å–åˆ°æºIPã€‚<br>å¯¹äºé“¾è·¯è¾ƒé•¿ï¼Œå­˜åœ¨å¤šæ¬¡è½¬å‘çš„æƒ…å†µï¼ˆä¾‹å¦‚åœ¨Ingress Controllerå‰é¢å¤–é…ç½®äº†åå‘ä»£ç†æœåŠ¡ï¼‰ï¼Œå¯ä»¥åœ¨å¼€å¯enable-real-ipæ—¶é€šè¿‡è§‚å¯Ÿæ—¥å¿—ä¸­remote_addrçš„å€¼ï¼Œæ¥ç¡®å®šçœŸå®IPæ˜¯å¦æ˜¯ä»¥X-Forwarded-Forè¯·æ±‚å¤´ä¼ é€’åˆ°Ingresså®¹å™¨ä¸­ã€‚è‹¥ä¸æ˜¯ï¼Œè¯·åœ¨è¯·æ±‚åˆ°è¾¾Ingress Controllerä¹‹å‰åˆ©ç”¨X-Forwarded-Forç­‰æ–¹å¼æºå¸¦å®¢æˆ·ç«¯çœŸå®IPã€‚</li>
</ul>
<p><strong>æ€»ç»“è¯´æ˜:</strong><br>æè¿°: ç”±ä¸Šè¿°å¯çŸ¥å¹¶ä¸æ˜¯æ‰€æœ‰çš„åœºæ™¯éƒ½èƒ½é€šè¿‡X-Forwarded-Foræ¥è·å–ç”¨æˆ·æ­£å¼ip, ä¾‹å¦‚å½“æœåŠ¡å™¨å‰ç«¯ä½¿ç”¨äº†CDNçš„æ—¶å€™ï¼ŒX-Forwarded-For æ–¹å¼è·å–åˆ°çš„å¯èƒ½å°±æ˜¯CDNçš„æ¥æºipäº†ï¼Œæ­¤ç§æƒ…å†µå¯ä»¥å’ŒCDNé…ç½®ç®¡ç†åå°çº¦å®šä¸€ä¸ªå­—æ®µåæ¥è®°å½•ç”¨æˆ·çœŸå®ip, ç„¶åä»£ç†å°†è¿™ä¸ªå­—æ®µé€å±‚ä¼ é€’æœ€ååˆ°åº”ç”¨æœåŠ¡ç«¯ã€‚</p>
<p>å„ç§æ–¹å¼åœ¨CDNç¯å¢ƒä¸‹,è·å–çœŸå®IPåœ°å€çš„ä¼˜ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>CDNè‡ªå®šä¹‰headerå¤´<br>ä¼˜ç‚¹ï¼šè·å–åˆ°æœ€çœŸå®çš„ç”¨æˆ·IPåœ°å€,ç”¨æˆ·ç»å¯¹ä¸å¯èƒ½ä¼ªè£…IPã€‚<br>ç¼ºç‚¹ï¼šéœ€è¦CDNå‚å•†æä¾›ã€‚</p>
</li>
<li><p>è·å–forwarded-forå¤´<br>ä¼˜ç‚¹ï¼šå¯ä»¥è·å–åˆ°ç”¨æˆ·çš„IPåœ°å€ã€‚<br>ç¼ºç‚¹ï¼šç¨‹åºéœ€è¦æ”¹åŠ¨,ä»¥åŠç”¨æˆ·IPæœ‰å¯èƒ½æ˜¯ä¼ªè£…çš„ã€‚</p>
</li>
<li><p>ä½¿ç”¨realipè·å–<br>ä¼˜ç‚¹ï¼šç¨‹åºä¸éœ€è¦æ”¹åŠ¨ï¼Œç›´æ¥ä½¿ç”¨remote_addrå³å¯è·å–IPåœ°å€ã€‚<br>ç¼ºç‚¹ï¼šipåœ°å€æœ‰å¯èƒ½è¢«ä¼ªè£…ï¼Œè€Œä¸”éœ€è¦çŸ¥é“æ‰€æœ‰CDNèŠ‚ç‚¹çš„ipåœ°å€æˆ–è€…ipæ®µã€‚</p>
</li>
</ul>
<p>è‡³æ­¤å®Œæ¯•ï¼</p>
<p><br></p>
<h2 id="0x03-Kubernetesä¸­ingress-nginx-å¦‚ä½•åœ¨å¤–éƒ¨è®¾ç½®è‡ªå®šä¹‰nginxæŒ‡ä»¤snippet"><a href="#0x03-Kubernetesä¸­ingress-nginx-å¦‚ä½•åœ¨å¤–éƒ¨è®¾ç½®è‡ªå®šä¹‰nginxæŒ‡ä»¤snippet" class="headerlink" title="0x03 Kubernetesä¸­ingress-nginx å¦‚ä½•åœ¨å¤–éƒ¨è®¾ç½®è‡ªå®šä¹‰nginxæŒ‡ä»¤snippet"></a>0x03 Kubernetesä¸­ingress-nginx å¦‚ä½•åœ¨å¤–éƒ¨è®¾ç½®è‡ªå®šä¹‰nginxæŒ‡ä»¤snippet</h2><p>æè¿°: æˆ‘ä»¬å¯ä»¥åœ¨ingress-nginxçš„configMapå’ŒingressåŸŸåè§„åˆ™ä¸­ï¼Œåˆ©ç”¨ConfigMapå’ŒAnnotationsè¿›è¡Œè‡ªå®šä¹‰é…ç½® snippet å¹¶æ³¨å…¥nginx.confä¸­ã€‚</p>
<ul>
<li>ConfigMap: ä½¿ç”¨ConfigMapåœ¨NGINXä¸­è®¾ç½®å…¨å±€é…ç½®ã€‚</li>
<li>Annotations: å¦‚æœéœ€è¦ç‰¹å®šå…¥å£è§„åˆ™çš„ç‰¹å®šé…ç½®ï¼Œè¯·ä½¿ç”¨æ­¤é€‰é¡¹ã€‚</li>
</ul>
<p><strong>1.åœ¨ConfigMapä¸­é…ç½®</strong><br>æè¿°: æˆ‘ä»¬å¯ä»¥åœ¨Ingress-nginxä¸­çš„ConfigMapè¿›è¡Œé…ç½®å…¨å±€ç”Ÿæ•ˆçš„NginxæŒ‡ä»¤ç‰‡æ®µï¼Œå…¶ä¸­ä¸»è¦ä½ç½®çš„æŒ‡ä»¤ç‰‡æ®µåµŒå…¥ä½ç½®å‚æ•°å¦‚ä¸‹:</p>
<ul>
<li><code>main-snippet</code>: å°†è‡ªå®šä¹‰é…ç½®æ·»åŠ åˆ° nginx é…ç½®çš„ä¸»è¦éƒ¨åˆ†ã€‚</li>
<li><code>http-snippet</code>: å°†è‡ªå®šä¹‰é…ç½®æ·»åŠ åˆ° nginx é…ç½®çš„ http éƒ¨åˆ†ã€‚</li>
<li><code>server-snippet</code>: å°†è‡ªå®šä¹‰é…ç½®æ·»åŠ åˆ° nginx é…ç½®ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨ã€‚</li>
<li><code>location-snippet</code>: å°†è‡ªå®šä¹‰é…ç½®æ·»åŠ åˆ° nginx é…ç½®ä¸­çš„æ‰€æœ‰ä½ç½®ã€‚æ‚¨ä¸èƒ½ä½¿ç”¨å®ƒæ¥æ·»åŠ ä»£ç†åˆ° Kubernetes pod çš„æ–°ä½ç½®ï¼Œå› ä¸ºè¯¥ç‰‡æ®µæ— æ³•è®¿é—® Go æ¨¡æ¿å‡½æ•°ã€‚å¦‚æœè¦æ·»åŠ è‡ªå®šä¹‰ä½ç½®ï¼Œåˆ™å¿…é¡»æä¾›è‡ªå·±çš„ nginx.tmplã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit cm -n kube-base ingress-nginx-controller</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  allow-snippet-annotations: <span class="string">"true"</span></span><br><span class="line">  main-snippet: |</span><br><span class="line">    ....æŒ‡ä»¤....</span><br><span class="line">  http-snippet: |</span><br><span class="line">    ....æŒ‡ä»¤....</span><br><span class="line">  server-snippet: | </span><br><span class="line">    ....æŒ‡ä»¤....</span><br><span class="line">  location-snippet: |</span><br><span class="line">    ....æŒ‡ä»¤....</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    meta.helm.sh/release-name: ingress-nginx</span><br><span class="line">    meta.helm.sh/release-namespace: ingress-nginx</span><br><span class="line">  creationTimestamp: <span class="string">"2022-06-24T05:20:53Z"</span></span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">    app.kubernetes.io/instance: ingress-nginx</span><br><span class="line">    app.kubernetes.io/managed-by: Helm</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">    app.kubernetes.io/version: 1.2.1</span><br><span class="line">    helm.sh/chart: ingress-nginx-4.1.4</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  resourceVersion: <span class="string">"1501009"</span></span><br><span class="line">  uid: 0611906f-d100-4907-b29c-d4f55fc269ad</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p><strong>2.åœ¨ingressåŸŸåè§„åˆ™ä¸­é…ç½®</strong><br>æ¸©é¦¨æç¤º: å¦‚æœè¦åœ¨ingressç«™ç‚¹é…ç½®æ¸…å•ä¸­åœ¨ annotations åŠ å…¥ Nginx æŒ‡ä»¤ç‰‡æ®µ snippet ï¼Œ åˆ™æˆ‘ä»¬éœ€è¦åœ¨ ingress-nginx çš„ ConfigMap data å¯¹è±¡ä¸­åŠ å…¥<code>allow-snippet-annotations: &quot;true&quot;</code>é”®å€¼å¯¹å³å¯å¯ç”¨ï¼Œç„¶åæˆ‘ä»¬ä¾¿å¯åœ¨ Ingress é…ç½®ç«™ç‚¹èµ„æºæ¸…å•é‡Œçš„annotationså¯¹è±¡ä¸‹ä½¿ç”¨ã€‚</p>
<p><code>nginx.ingress.kubernetes.io/server-snippet</code> : ä½¿ç”¨æ³¨é‡Šå¯ä»¥åœ¨æœåŠ¡å™¨é…ç½®å—ä¸­æ·»åŠ è‡ªå®šä¹‰é…ç½®ã€‚(æ¯ä¸ªè™šæ‹Ÿä¸»æœºåªèƒ½é…ç½®ä¸€æ¬¡) æ›´æ”¹å½±å“å±€éƒ¨serverç«™ç‚¹ã€‚<br><code>nginx.ingress.kubernetes.io/configuration-snippet</code> : ä½¿ç”¨æ­¤æ³¨é‡Šæ‚¨å¯ä»¥å‘NGINXä½ç½®æ·»åŠ å…¶ä»–é…ç½®ã€‚(ä½†å¤šç§Ÿæˆ·é›†ç¾¤ä¸­æ…ç”¨) æ›´æ”¹å½±å“å…¨å±€ã€‚<br><code>nginx.ingress.kubernetes.io/stream-snippet</code> : ä½¿ç”¨æ³¨é‡Šå¯ä»¥æ·»åŠ è‡ªå®šä¹‰æµé…ç½®ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit ingress -n app weiyigeek-app</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/configuration-snippet: |</span><br><span class="line">      ....æŒ‡ä»¤ç‰‡æ®µ.....</span><br><span class="line">    nginx.ingress.kubernetes.io/stream-snippet: |</span><br><span class="line">      ....æŒ‡ä»¤ç‰‡æ®µ.....</span><br><span class="line">    nginx.ingress.kubernetes.io/server-snippet: |</span><br><span class="line">      ....æŒ‡ä»¤ç‰‡æ®µ.....</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p><em>å®è·µç¤ºä¾‹:</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/configuration-snippet: |</span><br><span class="line">      proxy_set_header X-FORWARDED-FOR <span class="variable">$http_X_FORWARDED_FOR</span>;</span><br><span class="line">      server_tokens off; location /itwork/res/css &#123; deny all;<span class="built_in">return</span> 403;&#125;      </span><br><span class="line">    nginx.ingress.kubernetes.io/stream-snippet: |</span><br><span class="line">      server &#123;</span><br><span class="line">        listen 8000;</span><br><span class="line">        proxy_pass 127.0.0.1:80;</span><br><span class="line">      &#125;</span><br><span class="line">    nginx.ingress.kubernetes.io/server-snippet: |</span><br><span class="line">      add_header X-Frame-Options SAMEORIGIN;</span><br><span class="line">      <span class="comment"># set_header X-Frame-Options SAMEORIGIN;</span></span><br><span class="line">      <span class="built_in">set</span> <span class="variable">$flag</span> 0;</span><br><span class="line">      <span class="built_in">set</span> <span class="variable">$childdomain</span> <span class="string">""</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"(Mobile)"</span> )&#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="variable">$host</span> ~* <span class="string">"(.*).weiyigeek.top"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$childdomain</span> <span class="variable">$1</span>;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>2"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="variable">$flag</span> = <span class="string">"012"</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 http://m.weiyigeek.top/<span class="variable">$1</span><span class="variable">$request_uri</span> ;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="0x04-Kubernetesä¸­ingress-nginxæŒ‡å®šnodeäº²å’Œæ€§å’Œnginx-ingress-controllerä¿®æ”¹ç¼ºçœç«¯å£"><a href="#0x04-Kubernetesä¸­ingress-nginxæŒ‡å®šnodeäº²å’Œæ€§å’Œnginx-ingress-controllerä¿®æ”¹ç¼ºçœç«¯å£" class="headerlink" title="0x04 Kubernetesä¸­ingress-nginxæŒ‡å®šnodeäº²å’Œæ€§å’Œnginx-ingress-controllerä¿®æ”¹ç¼ºçœç«¯å£"></a>0x04 Kubernetesä¸­ingress-nginxæŒ‡å®šnodeäº²å’Œæ€§å’Œnginx-ingress-controllerä¿®æ”¹ç¼ºçœç«¯å£</h2><p>æè¿°: åœ¨æˆ‘ä»¬éœ€è¦æŒ‡å®šingress-nginx-controlleråº”ç”¨Podå…è®¸è¿è¡Œåœ¨é‚£äº›å·¥ä½œèŠ‚ç‚¹æ—¶å¯ä»¥å¯¹å…¶è¿›è¡ŒNodeå’ŒPodäº²å’Œæ€§è®¾ç½®, ä¸æ­¤åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥æ›´æ”¹ <code>nginx-ingress-controller</code> çš„æœåŠ¡ç«¯å£, ä½†æ³¨æ„ä¿®æ”¹åéœ€è¦æ›´æ”¹å¯¹åº”çš„ServiceæœåŠ¡å‘ç°ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployments.apps  -n kube-base  ingress-nginx-controller -o wide</span><br><span class="line">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES                                               SELECTOR</span><br><span class="line">ingress-nginx-controller   9/9     9            9           329d   controller   harbor.cloud/weiyigeek/ingress-nginx-controller:v0.44.0   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘æŸ¥çœ‹ ingress-nginx-controller ç¼ºçœçš„80ã€443ç«¯å£</span></span><br><span class="line">$ kubectl get deployments.apps  -n kube-base  ingress-nginx-controller </span><br><span class="line"><span class="comment"># äº²å’Œæ€§è®¾ç½®</span></span><br><span class="line">  spec:</span><br><span class="line">      affinity:</span><br><span class="line">        nodeAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            nodeSelectorTerms:</span><br><span class="line">            - matchExpressions:</span><br><span class="line">              - key: node</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                - app</span><br><span class="line">                - work</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - podAffinityTerm:</span><br><span class="line">              labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                - key: app.kubernetes.io/name</span><br><span class="line">                  operator: In</span><br><span class="line">                  values:</span><br><span class="line">                  - ingress-nginx</span><br><span class="line">              topologyKey: kubernetes.io/hostname</span><br><span class="line">            weight: 100</span><br><span class="line"><span class="comment"># nginx-ingress-controller å¯åŠ¨å‚æ•°</span></span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - /nginx-ingress-controller</span><br><span class="line">        - --default-backend-service=$(POD_NAMESPACE)/default-backend</span><br><span class="line">        - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class="line">        - --election-id=ingress-controller-leader</span><br><span class="line">        - --ingress-class=ingress-nginx</span><br><span class="line">        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class="line">        - --validating-webhook=:6443</span><br><span class="line">        - --validating-webhook-certificate=/usr/<span class="built_in">local</span>/certificates/cert</span><br><span class="line">        - --validating-webhook-key=/usr/<span class="built_in">local</span>/certificates/key</span><br><span class="line">        <span class="comment"># å…³é”®ç‚¹:å¢åŠ ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°å‚æ•°ï¼ˆä¸€ä¸ªæ˜¯httpç«¯å£ï¼Œä¸€ä¸ªæ˜¯httpsç«¯å£ï¼‰</span></span><br><span class="line">        - --http-port=8080</span><br><span class="line">        - --https-port=8443</span><br><span class="line">        name: controller</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          hostPort: 8080</span><br><span class="line">          name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          hostPort: 8443</span><br><span class="line">          name: https</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 6443</span><br><span class="line">          hostPort: 6443</span><br><span class="line">          name: webhook</span><br><span class="line">          protocol: TCP</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="0x05-Kubernetesä¸­ingress-nginxå¦‚ä½•ä¸ºé¡¹ç›®é…ç½®å­è·¯å¾„"><a href="#0x05-Kubernetesä¸­ingress-nginxå¦‚ä½•ä¸ºé¡¹ç›®é…ç½®å­è·¯å¾„" class="headerlink" title="0x05 Kubernetesä¸­ingress-nginxå¦‚ä½•ä¸ºé¡¹ç›®é…ç½®å­è·¯å¾„"></a>0x05 Kubernetesä¸­ingress-nginxå¦‚ä½•ä¸ºé¡¹ç›®é…ç½®å­è·¯å¾„</h2><p><strong>æ–¹å¼1.åˆ›å»ºå¸¦æœ‰app-rootæ³¨é‡Šçš„Ingressè§„åˆ™</strong><br>æè¿°: å°† approot.weiyigeek.top è¯·æ±‚é‡å®šå‘åˆ° approot.weiyigeek.top/app1 å­ç›®å½•ä¸Šã€‚<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/app-root:</span> <span class="string">/app1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">approot</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">approot.weiyigeek.top</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">http-svc</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥rewriteæ˜¯å¦æ­£å¸¸</span></span><br><span class="line"><span class="string">curl</span> <span class="bullet">-I</span> <span class="bullet">-k</span> <span class="string">approot.weiyigeek.top</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">302</span> <span class="string">Moved</span> <span class="string">Temporarily</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>æ–¹å¼2.åˆ›å»ºå¸¦æœ‰rewriteæ³¨é‡Šçš„Ingressè§„åˆ™</strong><br>æè¿°: åœ¨è¿™ä¸ªIngresså®šä¹‰ä¸­å…ƒç»„<code>ï¼ˆ.*ï¼‰</code>æ•è·çš„æ‰€æœ‰å­—ç¬¦éƒ½å°†åˆ†é…ç»™å ä½ç¬¦ $2ï¼Œç„¶åå°†å…¶ç”¨ä½œé‡å†™ç›®æ ‡æ³¨é‡Šä¸­çš„å‚æ•°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸Šé¢çš„å…¥å£å®šä¹‰å°†è¿›è¡Œä»¥ä¸‹é‡å†™ï¼š</p>
<ul>
<li>weiyigeek.top/demo é‡å†™ä¸º weiyigeek.top/</li>
<li>weiyigeek.top/demo/ é‡å†™ä¸º weiyigeek.top/</li>
<li>weiyigeek.top/demo/issues é‡å†™ä¸º weiyigeek.top/issues</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">rewrite</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">rewrite.bar.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">http-svc</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/demo(/|$)(.*)</span></span><br><span class="line"><span class="comment"># å…ƒç»„1 $1 = (/|$)</span></span><br><span class="line"><span class="comment"># å…ƒç»„2 $2 = (.*)</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>æ–¹å¼3.é€šè¿‡æ³¨é‡Šserver-snippetç‰‡æ®µè„šæœ¬è¿›è¡ŒIngressè§„åˆ™é‡å†™</strong><br>æè¿°: ä¾‹å¦‚å°†è®¿é—® <code>web.weiyigeek.top/index</code> çš„è¯·æ±‚é‡å®šå‘åˆ°<code>http://m.weiyigeek.top/web/index</code>.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr"> annotations:</span></span><br><span class="line">   <span class="string">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">     if ($host ~* "(.*).weiyigeek.top") &#123;</span></span><br><span class="line"><span class="string">          return 301 http://m.weiyigeek.top/$1$request_uri ;</span></span><br><span class="line"><span class="string">     &#125;</span></span><br><span class="line"><span class="string"></span><span class="attr"> name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr"> namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr"> rules:</span></span><br><span class="line"><span class="attr"> - host:</span> <span class="string">'*.weiyigeek.top'</span></span><br><span class="line"><span class="attr">   http:</span></span><br><span class="line"><span class="attr">     paths:</span></span><br><span class="line"><span class="attr">     - backend:</span></span><br><span class="line"><span class="attr">         serviceName:</span> <span class="string">web-nginx</span></span><br><span class="line"><span class="attr">         servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">       path:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2.è®¿é—®test.weiyigeek.top/service/indexé‡å®šå‘åˆ°test.weiyigeek.top/s1/indexåœ°å€</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example-ingress</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      rewrite /service/(.*)  /s1/$1 break;</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">test.weiyigeek.top</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/service/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">app1</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<hr>
<h2 id="0x06-Kubernetes-ä¸­-ingress-nginx-ä¸Šçš„-HTTP-çš„é€Ÿç‡é™åˆ¶è¯·æ±‚"><a href="#0x06-Kubernetes-ä¸­-ingress-nginx-ä¸Šçš„-HTTP-çš„é€Ÿç‡é™åˆ¶è¯·æ±‚" class="headerlink" title="0x06 Kubernetes ä¸­ ingress-nginx ä¸Šçš„ HTTP çš„é€Ÿç‡é™åˆ¶è¯·æ±‚"></a>0x06 Kubernetes ä¸­ ingress-nginx ä¸Šçš„ HTTP çš„é€Ÿç‡é™åˆ¶è¯·æ±‚</h2><p>æè¿°: åœ¨æŸäº›æƒ…å†µæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ingress-nginx</code>é’ˆå¯¹è¯·æ±‚é€Ÿç‡è¿›è¡Œè¯·æ±‚é™åˆ¶ã€‚</p>
<p>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ä¸¤ç§æ–¹å¼<code>ç®¡ç†é€šè¿‡é…ç½®æ˜ å°„</code>å’Œ<code>æ³¨é‡Šè°ƒæ•´</code>æ¥å®Œæˆã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®æ˜ å°„-ConfigMap</span></span><br><span class="line">$ kubectl get cm -n ingress-nginx ingress-nginx-controller -o yaml</span><br><span class="line">data:</span><br><span class="line">  http-snippet: |</span><br><span class="line">    limit_req_zone <span class="variable">$http_authorization</span> zone=my-zone:20m rate=5r/s;</span><br><span class="line">    limit_req_zone <span class="variable">$binary_remote_addr</span> zone=my-zone:20m rate=10r/s;</span><br><span class="line">    limit_req_zone <span class="variable">$http_someheader</span> zone=my-zone:20m rate=20r/s;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ³¨é‡Š-annotations</span></span><br><span class="line"><span class="comment"># - å…¥å£èµ„æºä¸­çš„æ³¨é‡Šï¼š</span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/configuration-snippet: |</span><br><span class="line">      limit_req zone=my-zone-1 burst=10 nodelay;</span><br><span class="line">      limit_req_log_level notice;</span><br><span class="line">      limit_req_status 429;</span><br><span class="line"></span><br><span class="line"><span class="comment"># - ä¸€ä¸ªå…¥å£å®šä¹‰çš„ä¸åŒä½ç½®çš„ä¸åŒèŠ‚æµç¤ºä¾‹ï¼š</span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/server-snippet: |</span><br><span class="line">      location /content/images/ &#123;</span><br><span class="line">        limit_req zone=my-zone-2 burst=50 nodelay;</span><br><span class="line">      &#125;</span><br><span class="line">      location /content/texts/ &#123;</span><br><span class="line">        limit_req zone=my-zone-3 burst=50 nodelay;</span><br><span class="line">      &#125;</span><br><span class="line">    nginx.ingress.kubernetes.io/configuration-snippet: |</span><br><span class="line">      limit_req zone=my-zone-1 burst=10 nodelay;</span><br><span class="line">      limit_req_log_level notice;</span><br><span class="line">      limit_req_status 429;</span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: è¯·æ³¨æ„ http-snippet ä¸å…è®¸ä½œä¸ºæ³¨é‡Šï¼Œè€Œåªèƒ½åœ¨ConfigMapä¸­è¿›è¡Œæ˜ å°„é…ç½®ï¼</p>
<p><br></p>
<hr>
<h2 id="0x07-Kubernetesä¸­ingress-nginxä¼˜åŒ–é…ç½®"><a href="#0x07-Kubernetesä¸­ingress-nginxä¼˜åŒ–é…ç½®" class="headerlink" title="0x07 Kubernetesä¸­ingress-nginxä¼˜åŒ–é…ç½®"></a>0x07 Kubernetesä¸­ingress-nginxä¼˜åŒ–é…ç½®</h2><p>æè¿°: åœ¨K8sé›†ç¾¤ä¸­éƒ¨ç½²å®‰è£… ingress-nginx åé»˜è®¤å¹¶æœªè¿›è¡Œç›¸åº”çš„ä¼˜åŒ–é…ç½®ï¼Œæœ¬å°ç»“å°†é’ˆå¯¹äºç”Ÿäº§ç¯å¢ƒçš„ä¸­çš„ ingress-nginx æ§åˆ¶å™¨è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä» ingress-nginx-controller èµ„æºçš„ Pod ã€ConfigMap ã€ä»¥åŠä¸šåŠ¡çš„ ingress è§„åˆ™å…¥æ‰‹ã€‚</p>
<p><br/></p>
<h3 id="ingress-nginx-controller-Pod"><a href="#ingress-nginx-controller-Pod" class="headerlink" title="ingress-nginx-controller Pod"></a>ingress-nginx-controller Pod</h3><p>æ¸©é¦¨æç¤º: æˆ‘ä»¬éœ€è¦é’ˆå¯¹æ‰¿è½½ ingress-nginx çš„ç›¸å…³ Pod å®¹å™¨è¿›è¡Œå†…æ ¸å‚æ•°ä¼˜åŒ–ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployments.apps -n ingress-nginx ingress-nginx-controller</span><br><span class="line">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">ingress-nginx-controller   9/9     9            9           5d20h</span><br><span class="line"></span><br><span class="line">$ kubectl get deployments.apps -n ingress-nginx ingress-nginx-controller  -o yaml</span><br><span class="line"><span class="comment"># åœ¨ spec.template.spec å¯¹è±¡ä¸‹æ·»åŠ ä¸€ä¸ªåˆå§‹åŒ– initContainers å®¹å™¨</span></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: sysctl</span><br><span class="line">    image: alpine:3.10</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - sh</span><br><span class="line">    - -c</span><br><span class="line">    - |</span><br><span class="line">      mount -o remount rw /proc/sys</span><br><span class="line">      sysctl -w net.core.somaxconn=65535</span><br><span class="line">      sysctl -w net.ipv4.tcp_tw_reuse=1</span><br><span class="line">      sysctl -w net.ipv4.ip_local_port_range=<span class="string">"1024 65535"</span></span><br><span class="line">      sysctl -w fs.file-max=1048576</span><br><span class="line">      sysctl -w fs.inotify.max_user_instances=16384</span><br><span class="line">      sysctl -w fs.inotify.max_user_watches=524288</span><br><span class="line">      sysctl -w fs.inotify.max_queued_events=16384</span><br><span class="line">    securityContext:</span><br><span class="line">      privileged: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<h3 id="ingress-nginx-controller-ConfigMap"><a href="#ingress-nginx-controller-ConfigMap" class="headerlink" title="ingress-nginx-controller ConfigMap"></a>ingress-nginx-controller ConfigMap</h3><p>æ¸©é¦¨æç¤º: æˆ‘ä»¬éœ€è¦æŒ‰ç…§éœ€è¦å°†ä¸‹è¿°K/Vé…ç½®é¡¹æ’å…¥åˆ° ingress-nginx çš„ configMap é‡Œçš„ data å¯¹è±¡ä¸‹ã€‚</p>
<p><strong>ingress-nginx èµ„æºæŸ¥çœ‹</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ Ingress-nginx å…¨å±€é…ç½®å‚æ•°:</span></span><br><span class="line">kubectl get cm -n ingress-nginx nginx-ingress-controller -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ Ingress-nginx å…¨å±€é…ç½®å‚æ•°:</span></span><br><span class="line">kubectl edit cm -n ingress-nginx nginx-ingress-controller</span><br></pre></td></tr></table></figure></p>
<p><strong>ä¼˜åŒ–é…ç½®</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è´Ÿè½½å·¥ä½œæœºåˆ¶,è½®è¯¢</span></span><br><span class="line">load-balance: <span class="string">"round_robin"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é”™è¯¯æ—¥å¿—ç­‰çº§è®¾ç½® (debug, info, notice, warn, error, crit, alert, or emerg)</span></span><br><span class="line">error-log-level: <span class="string">"notice"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨Gzipèµ„æºå‹ç¼© (3kä»¥ä¸Š)</span></span><br><span class="line">use-gzip: <span class="string">"true"</span></span><br><span class="line">gzip-level: <span class="string">"2"</span></span><br><span class="line">gzip-min-length: <span class="string">"3072"</span></span><br><span class="line">gzip-types: <span class="string">"text/html text/plain text/css text/javascript application/javascript application/x-javascript application/xml application/x-httpd-php application/x-font-ttf application/json image/x-icon image/svg+xml image/avif image/webp font/ttf font/opentype"</span></span><br><span class="line"><span class="comment"># ä¸å»ºè®®è¿›è¡Œç…§ç‰‡å‹ç¼© image/jpeg image/gif image/png å¯èƒ½åè€Œä¼šå¢åŠ å…¶ä½“ç§¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨Brotlièµ„æºå‹ç¼©ï¼ˆåŒç­‰æ¡ä»¶ä¸‹ä¼˜äºGzipï¼Œä»»é€‰ä¸€ä¸ªï¼‰</span></span><br><span class="line"><span class="built_in">enable</span>-brotli: <span class="string">"true"</span></span><br><span class="line">brotli-level: 5</span><br><span class="line">brotli-min-length: 3072</span><br><span class="line">brotli-types: <span class="string">"text/plain text/css text/javascript application/javascript application/x-javascript application/xml application/x-httpd-php application/x-font-ttf image/x-icon  image/svg+xml image/avif image/webp font/ttf font/opentype"</span></span><br><span class="line"><span class="comment"># ä¸å»ºè®®è¿›è¡Œç…§ç‰‡å‹ç¼© image/jpeg image/gif image/png å¯èƒ½åè€Œä¼šå¢åŠ å…¶ä½“ç§¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨http2æ”¯æŒ(å®é™…ä¸Šé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå¦‚æœè¿‡å…³é—­è¯·å°†å…¶è®¾ç½®ä¸ºtrue)</span></span><br><span class="line">use-http2: <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ssl ä¼šè¯å¤ç”¨</span></span><br><span class="line">ssl_session_cache: <span class="string">"shared:SSL:10m;"</span></span><br><span class="line">ssl-session-timeout: <span class="string">"10m"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># worker æ¯ä¸ªå·¥ä½œè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°ä¸åŒæ—¶æ‰“å¼€æœ€å¤§è¿æ¥æ•°è®¾ç½®</span></span><br><span class="line">worker-processes: <span class="string">"auto"</span> </span><br><span class="line">max-worker-open-files: <span class="string">"10240"</span></span><br><span class="line">max-worker-connections: <span class="string">"32767"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¤ç”¨</span></span><br><span class="line"><span class="built_in">enable</span>-multi-accept: <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># keep-alive è¿æ¥è¶…æ—¶å’Œæœ€å¤§è¯·æ±‚æ•°è°ƒæ•´ </span></span><br><span class="line">keep-alive: <span class="string">"75"</span></span><br><span class="line">keep-alive-requests: <span class="string">"10000"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># upstream-keepalive ä¸ä¸Šæ¸¸Podè¿æ¥è¶…æ—¶ä¸æœ€å¤§è¯·æ±‚æ•°è°ƒæ•´</span></span><br><span class="line">upstream-keepalive-time: <span class="string">"30m"</span></span><br><span class="line">upstream-keepalive-timeout: <span class="string">"60"</span></span><br><span class="line">upstream-keepalive-requests: <span class="string">"10000"</span></span><br><span class="line">upstream-keepalive-connections: <span class="string">"512"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy-connect è®¾ç½® ingress-nginx ä¸ pstream pod ä¹‹é—´è¿æ¥è¯·æ±‚è¶…æ—¶å®è·µã€‚</span></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸ä»£ç†æœåŠ¡å™¨å»ºç«‹è¿æ¥çš„è¶…æ—¶æ—¶é—´(ä¸èƒ½è¶…è¿‡75s)</span></span><br><span class="line">proxy-connect-timeout: <span class="string">"30"</span></span><br><span class="line"><span class="comment"># è®¾ç½®å°†è¯·æ±‚ä¼ è¾“åˆ°ä»£ç†æœåŠ¡å™¨çš„è¶…æ—¶æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼ˆè¶…æ—¶ä»…åœ¨ä¸¤ä¸ªè¿ç»­çš„å†™æ“ä½œä¹‹é—´è®¾ç½®ï¼Œè€Œä¸æ˜¯ä¸ºæ•´ä¸ªè¯·æ±‚çš„ä¼ è¾“è®¾ç½®ï¼‰</span></span><br><span class="line">proxy-send-timeout: <span class="string">"120"</span></span><br><span class="line"><span class="comment"># è®¾ç½®ä»ä»£ç†æœåŠ¡å™¨è¯»å–å“åº”çš„è¶…æ—¶æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰</span></span><br><span class="line">proxy-read-timeout: <span class="string">"120"</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>å¼€å‘æµ‹è¯•:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨ nginx Opentracing æ‰©å±•, é»˜è®¤å€¼ï¼šç¦ç”¨</span></span><br><span class="line"><span class="built_in">enable</span>-opentracing: <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ¸©é¦¨æç¤º:</p>
<ul>
<li>åœ¨ Nginx ä¸­çš„ <code>upstream</code> ä¸»è¦æ˜¯é…ç½®å‡è¡¡æ± å’Œè°ƒåº¦æ–¹æ³•.</li>
<li>åœ¨ Nginx ä¸­çš„ <code>proxy_pass</code> ä¸»è¦æ˜¯é…ç½®ä»£ç†æœåŠ¡å™¨ipæˆ–æœåŠ¡å™¨ç»„çš„åå­—.</li>
</ul>
<p>æ¸©é¦¨æç¤º: åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€é…ç½®<code>upstream-keepalive-*</code>ç›¸å…³å‚æ•°, ä½¿å¾— nginx å°½å¯èƒ½å¿«é€Ÿå¤„ç† HTTP è¯·æ±‚ï¼ˆå°½é‡å°‘é‡Šæ”¾å¹¶é‡å»º TCP è¿æ¥ï¼‰ï¼ŒåŒæ—¶æ§åˆ¶ nginx å†…å­˜ä½¿ç”¨é‡ã€‚</p>
<p>æ¸©é¦¨æç¤º: ingress nginx ä¸ upstream pod å»ºç«‹ TCP è¿æ¥å¹¶è¿›è¡Œé€šä¿¡ï¼Œå…¶ä¸­æ¶‰åŠ 3 ä¸ªè¶…æ—¶é…ç½®æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨ã€‚</p>
<ul>
<li>proxy-read-timeout é€‰é¡¹ è®¾ç½® nginx ä¸ upstream pod ä¹‹é—´è¯»æ“ä½œçš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤è®¾ç½®ä¸º 60sï¼Œå½“ä¸šåŠ¡æ–¹æœåŠ¡å¼‚å¸¸å¯¼è‡´å“åº”è€—æ—¶é£™æ¶¨æ—¶ï¼Œå¼‚å¸¸è¯·æ±‚ä¼šé•¿æ—¶é—´å¤¯ä½ ingress ç½‘å…³ï¼Œæˆ‘ä»¬åœ¨æ‹‰å–æ‰€æœ‰æœåŠ¡æ­£å¸¸è¯·æ±‚çš„ P99.99 è€—æ—¶ä¹‹åï¼Œå°†ç½‘å…³ä¸ upstream pod ä¹‹é—´è¯»å†™è¶…æ—¶å‡ç¼©çŸ­åˆ° 3sï¼Œä½¿å¾— nginx å¯ä»¥åŠæ—¶ææ–­å¼‚å¸¸è¯·æ±‚ï¼Œé¿å…é•¿æ—¶é—´è¢«å¤¯ä½ã€‚</li>
<li>proxy-connect-timeout é€‰é¡¹ è®¾ç½® nginx ä¸ upstream pod è¿æ¥å»ºç«‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤è®¾ç½®ä¸º 5sï¼Œç”±äºåœ¨ nginx å’Œä¸šåŠ¡å‡åœ¨å†…ç½‘åŒæœºæˆ¿é€šä¿¡ï¼Œæˆ‘ä»¬å°†æ­¤è¶…æ—¶æ—¶é—´ç¼©çŸ­åˆ° 1sã€‚</li>
</ul>
<p><br/></p>
<h3 id="ingress-Rule"><a href="#ingress-Rule" class="headerlink" title="ingress Rule"></a>ingress Rule</h3><p>æè¿°: é€šå¸¸æˆ‘ä»¬éœ€è¦ä¸ºå•ä¸ªä¸šåŠ¡è¿›è¡Œç›¸åº”é…ç½®, æ­¤æ—¶æˆ‘ä»¬ä¾¿éœ€è¦å†ä¸šåŠ¡çš„ingresséƒ¨ç½²æ¸…å•ä¸­è¿›è¡Œä¿®æ­£ã€‚</p>
<p>ä¾‹å¦‚: ç¼–è¾‘ blog.weiyigeek.top è™šæ‹Ÿä¸»æœºç«™ç‚¹çš„ ingress è§„åˆ™ (<code>kubectl edit ingress -n weiyigeek blog.weiyigeek.top</code>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># è§£å†³: 413 Request Entity Too Large é—®é¢˜</span></span><br><span class="line">    ingress.kubernetes.io/proxy-body-size: <span class="string">"128m"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è§£å†³ï¼šåç«¯å¤§æ–‡ä»¶ä¸Šä¼ é—®é¢˜</span></span><br><span class="line">    nginx.ingress.kubernetes.io/client-body-buffer-size: 64m</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-max-temp-file-size: 128m</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è§£å†³: ä¸Šä¼ æ–‡ä»¶è¾ƒæ…¢é—®é¢˜</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-buffer-size: 64m</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-buffering: <span class="string">"on"</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-buffers-number: <span class="string">"4"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è§£å†³: 504 ç½‘å…³è¶…æ—¶å³åç«¯backendè¶…æ—¶é—®é¢˜</span></span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-connect-timeout: 60</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-read-timeout: 180s</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-send-timeout: 60s</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è§£å†³: å¤„ç†Nginxä»£ç†è½¬å‘ä¸åç«¯æœåŠ¡æ–‡ä»¶ä¸Šä¼ ç¼“å­˜åŒºè®¾ç½®(åŸç”Ÿå‘½ä»¤)</span></span><br><span class="line">    nginx.ingress.kubernetes.io/server-snippet: |</span><br><span class="line">      location ~ /fastfile &#123;</span><br><span class="line">        client_max_body_size 1024m;   <span class="comment"># å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°ï¼Œè‹¥è¶…è¿‡æ‰€è®¾å®šçš„å¤§å°ï¼Œè¿”å›413é”™è¯¯.äººè¯ï¼šèƒ½ä¸Šä¼ å¤šå¤§æ–‡ä»¶</span></span><br><span class="line">        client_header_timeout 60;     <span class="comment"># è¯»å–è¯·æ±‚å¤´çš„è¶…æ—¶æ—¶é—´ï¼Œè‹¥è¶…è¿‡æ‰€è®¾å®šçš„å¤§å°ï¼Œè¿”å›408é”™è¯¯ã€‚ </span></span><br><span class="line">        client_body_timeout 60;       <span class="comment"># è¯»å–è¯·æ±‚å®ä½“çš„è¶…æ—¶æ—¶é—´ï¼Œè‹¥è¶…è¿‡æ‰€è®¾å®šçš„å¤§å°ï¼Œè¿”å›413é”™è¯¯ã€‚</span></span><br><span class="line">        client_body_buffer_size 10m;  <span class="comment"># ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œäººè¯ï¼šä¸€æ¬¡èƒ½æ¥å—å¤šå°‘æ–‡ä»¶ï¼Œå»ºè®®æ ¹æ®å¸¦å®½ä¸Šé™è®¾ç½®ï¼Œå‡å°‘ç£ç›˜è¯»å†™ï¼ŒåŠ å¿«é€Ÿåº¦</span></span><br><span class="line">        proxy_connect_timeout 60;     <span class="comment"># Nginxä¸åç«¯ä»£ç†è¿æ¥è¶…æ—¶æ—¶é—´,httpè¯·æ±‚æ— æ³•ç«‹å³è¢«å®¹å™¨(tomcat, nettyç­‰)å¤„ç†ï¼Œè¢«æ”¾åœ¨nginxçš„å¾…å¤„ç†æ± ä¸­ç­‰å¾…è¢«å¤„ç†ã€‚</span></span><br><span class="line">        proxy_read_timeout 180;       <span class="comment"># åç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)æ—¶é—´ï¼Œhttpè¯·æ±‚è¢«å®¹å™¨(tomcat, nettyç­‰)å¤„ç†åï¼Œnginxä¼šç­‰å¾…å¤„ç†ç»“æœï¼Œä¹Ÿå°±æ˜¯å®¹å™¨è¿”å›çš„responseã€‚</span></span><br><span class="line">        proxy_send_timeout 30;        <span class="comment"># httpè¯·æ±‚è¢«æœåŠ¡å™¨å¤„ç†å®Œåï¼ŒæŠŠæ•°æ®ä¼ è¿”å›ç»™Nginxçš„ç”¨æ—¶ï¼Œé»˜è®¤60ç§’ã€‚</span></span><br><span class="line">        proxy_buffer_size 1024k;      <span class="comment"># è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">        proxy_buffers 6 500k;             <span class="comment"># proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯&gt;ï¼Œè¿™æ ·è®¾ç½®</span></span><br><span class="line">        proxy_busy_buffers_size 1024k;    <span class="comment"># é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span></span><br><span class="line">        proxy_temp_file_write_size 1024k; <span class="comment"># è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼å°†ä»upstreamæœåŠ¡å™¨ä¼ è¾“</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="0x08-Kubernetesä¸­ingress-nginxå®‰å…¨é…ç½®"><a href="#0x08-Kubernetesä¸­ingress-nginxå®‰å…¨é…ç½®" class="headerlink" title="0x08 Kubernetesä¸­ingress-nginxå®‰å…¨é…ç½®"></a>0x08 Kubernetesä¸­ingress-nginxå®‰å…¨é…ç½®</h2><p>æè¿°: åœ¨ K8s é›†ç¾¤ä¸­éƒ¨ç½²å®‰è£… ingress-nginx åé»˜è®¤å¹¶æœªæ ¹æ®åº”ç”¨å®‰å…¨éœ€è¦è¿›è¡Œç›¸åº”çš„å®‰å…¨é…ç½®ï¼Œæœ¬å°ç»“å°†é’ˆå¯¹äºç”Ÿäº§ç¯å¢ƒçš„ä¸­çš„ ingress-nginx æ§åˆ¶å™¨ä»¥åŠåº”ç”¨å¸¸è§è¿›è¡Œå®‰å…¨å®‰å…¨é…ç½®ã€‚</p>
<p><strong>1.é…ç½®æŒ‡å®šçš„ Ingress Class</strong><br>æè¿°: å¦‚æœä¸€ä¸ªK8Sé›†ç¾¤ä¸­éƒ¨ç½²äº†å¤šä¸ªingress controlleræ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºingressçš„æ—¶å€™ï¼Œé€šè¿‡ingressClassNameæŒ‡å®šingress classï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ingress -n web www-weiyigeek -o yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: blog-weiyigeek-top</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># ....Kubernetes æ³¨é‡Šæ·»åŠ åˆ°ç‰¹å®šçš„ Ingress å¯¹è±¡è‡ªå®šä¹‰å…¶è¡Œä¸º....</span></span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span><br><span class="line">  labels:</span><br><span class="line">    app: blog</span><br><span class="line">    ref: blog.weiyigeek.top</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx  <span class="comment"># å…³é”®ç‚¹</span></span><br><span class="line">  rules:</span><br><span class="line">  - host: weiyigeek.top</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: blog</span><br><span class="line">            port:</span><br><span class="line">              number: 8080</span><br><span class="line">        path: /</span><br><span class="line">        pathType: ImplementationSpecific</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>2.å®‰å…¨é…ç½®ä¹‹å¼ºåˆ¶è·³è½¬HTTPS</strong><br>æè¿°: é€šè¿‡è¿™ä¸ªannotationå¯ä»¥å¼ºåˆ¶ httpsï¼Œå¦‚æœæ˜¯httpè¯·æ±‚ï¼Œä¼šé€šè¿‡308 redirect åˆ° https.</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># é€šè¿‡é‡å®šå‘å®æ–½æœåŠ¡å™¨ç«¯ HTTPS</span></span><br><span class="line">    <span class="comment"># å¯ç”¨äº†TLSï¼Œåˆ™æ§åˆ¶å™¨ä¼šå°† ï¼ˆ308ï¼‰ é‡å®šå‘åˆ° HTTPS</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># å¼ºåˆ¶é‡å®šå‘åˆ° HTTPS </span></span><br><span class="line">    nginx.ingress.kubernetes.io/force-ssl-redirect: <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># ä¿ç•™ URI ä¸­çš„å°¾éƒ¨æ–œæ </span></span><br><span class="line">    redirectnginx.ingress.kubernetes.io/preserve-trailing-slash: <span class="string">"true"</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>3.å®‰å…¨é…ç½®ä¹‹è·¨åŸŸè®¿é—®cors</strong><br>æè¿°: å½“å°†Ingress-Nginxä½œä¸ºAPIç½‘å…³ï¼Œå¿…é¡»è¿›è¡Œè·¨åŸŸé…ç½®å¦åˆ™ä¼šå¯¹ä¸šåŠ¡é€ æˆå½±å“ï¼Œä¾‹å¦‚æˆ‘ä»¬å…¬å¸çš„CDNä¸šåŠ¡å¿…é¡»è®¾ç½®è·¨åŸŸæ–¹é¢é…ç½®ã€‚</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># å¯ç”¨corsè·¨åŸŸ ï¼ˆå­—é¢æ„ä¹‰ï¼‰</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">enable</span>-cors: <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®æ§åˆ¶ CORS çš„å¯æ¥å—æ¥æº,éµå¾ªä»¥ä¸‹æ ¼å¼ http(s)://origin-site.com[:port]</span></span><br><span class="line">    nginx.ingress.kubernetes.io/cors-allow-originï¼š<span class="string">"https://*.weiyigeek.top"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®æ”¯æŒè·¨åŸŸè¯·æ±‚çš„æ–¹æ³• (GET, PUT, POST, DELETE, PATCH, OPTIONS)</span></span><br><span class="line">    nginx.ingress.kubernetes.io/cors-allow-methods: <span class="string">"GET, PUT, POST, OPTIONS"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®æ”¯æŒè·¨åŸŸè¯·æ±‚çš„æ ‡å¤´ (DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization)</span></span><br><span class="line">    nginx.ingress.kubernetes.io/cors-allow-headers: <span class="string">"X-Forwarded-For, X-App-Weiyigeek"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®æ”¯æŒå“åº”å…¬å¼€é‚£äº›æŒ‡å®šè¡¨å¤´ </span></span><br><span class="line">    nginx.ingress.kubernetes.io/cors-expose-headers: <span class="string">"*, X-CustomResponseHeader"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®åœ¨ CORS æ“ä½œæœŸé—´ä¼ é€’å‡­æ® ï¼ˆä¸ºäº†å®‰å…¨è®¾ç½®falseé™¤éä¸šåŠ¡ç¡®å®éœ€è¦ï¼‰</span></span><br><span class="line">    nginx.ingress.kubernetes.io/cors-allow-credentials: <span class="string">"false"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®æ§åˆ¶å¯ä»¥ç¼“å­˜é¢„æ£€è¯·æ±‚çš„æ—¶é—´é•¿åº¦ 1728000</span></span><br><span class="line">    nginx.ingress.kubernetes.io/cors-max-age: 600</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>4.å®‰å…¨é…ç½®ä¹‹é˜²æ­¢DDOSè¯·æ±‚é™æµ</strong><br>æè¿°: é€šå¸¸é’ˆå¯¹äºæ–‡ä»¶ä¸‹è½½æœåŠ¡å™¨æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„é…ç½®, æˆ‘ä»¬å¯ä»¥é€šè¿‡ rps é™åˆ¶æ¯ç§’è¯·æ±‚æ•°ï¼Œrpm é™åˆ¶æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œconnectionsé™åˆ¶è¿æ¥æ•°, å¦‚è‹¥è¶…è¿‡å°†è¿”å› 503 ã€‚</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># æ¯åˆ†é’Ÿä»ç»™å®š IP æ¥å—çš„è¯·æ±‚æ•°ã€‚çªå‘æµé‡é™åˆ¶è®¾ç½®ä¸ºæ­¤é™åˆ¶ä¹˜ä»¥çªå‘ä¹˜æ•°ï¼Œé»˜è®¤ä¹˜æ•°ä¸º 5ã€‚ï¼ˆé¡ºåº3ï¼‰</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">limit</span>-rps: <span class="string">"5"</span></span><br><span class="line">    <span class="comment"># æ¯ç§’ä»ç»™å®š IP æ¥å—çš„è¯·æ±‚æ•°ï¼Œçªå‘æµé‡é™åˆ¶è®¾ç½®ä¸ºæ­¤é™åˆ¶ä¹˜ä»¥çªå‘ä¹˜æ•°ï¼Œé»˜è®¤ä¹˜æ•°ä¸º 5ã€‚ï¼ˆé¡ºåº2ï¼‰</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">limit</span>-rpm: <span class="string">"300"</span></span><br><span class="line">    <span class="comment"># å…è®¸æ¥è‡ªå•ä¸ª IP åœ°å€çš„å¹¶å‘è¿æ¥æ•°ï¼Œè¶…è¿‡æ­¤é™åˆ¶æ—¶è¿”å› 503 é”™è¯¯ã€‚ï¼ˆé¡ºåº1ï¼‰</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">limit</span>-connections: <span class="string">"10"</span></span><br><span class="line">    <span class="comment"># çªå‘å¤§å°é™åˆ¶é€Ÿç‡çš„ä¹˜æ•°ã€‚é»˜è®¤çªå‘ä¹˜æ•°ä¸º 5</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">limit</span>-burst-multiplierï¼š<span class="string">"5"</span></span><br><span class="line">    <span class="comment"># é…ç½®ç™½åå•ä¸å—é€Ÿç‡é™åˆ¶ã€‚(å±€éƒ¨)</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">limit</span>-whitelist: <span class="string">"10.0.0.0/24,172.10.0.1"</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>5.å®‰å…¨é…ç½®ä¹‹è¯·æ±‚è®¿é—®ç™½åå•</strong></p>
<p>æè¿°: é…ç½®ç™½åå•æ¯”é»‘åå•æ›´åŠ å®‰å…¨ï¼Œä¸æœ€å°æ‰€éœ€æƒé™ä¸€æ ·ï¼Œä¸»è¦æ˜¯ç”¨äºå®‰å…¨é™åˆ¶ï¼Œåªå…è®¸ç‰¹å®šçš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä½†ç”±äºç°åœ¨ç½‘ç»œä¸­NATçš„å¹¿æ³›åº”ç”¨ï¼Œä½†æ˜¯å‚æ•°ä½¿ç”¨çš„åœºæ™¯æ¯”è¾ƒæœ‰é™ï¼Œä¾‹å¦‚é’ˆå¯¹äºå†…ç½‘é‡‡é›†ç›‘æ§æœåŠ¡è°ƒç”¨ï¼Œå³å°†å…¶è®¿é—®è¯·æ±‚IPåŠ å…¥åˆ°ç™½åå•ä¸­ï¼Œæ‰ä¸å—å®‰å…¨ç­–ç•¥é™åˆ¶å½±å“ã€‚</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line"><span class="comment"># é€šè¿‡æ³¨é‡ŠæŒ‡å®šå…è®¸çš„å®¢æˆ·ç«¯ IP æºèŒƒå›´ï¼Œè¯¥å€¼æ˜¯ä»¥é€—å·åˆ†éš”çš„CIDRåˆ—è¡¨ã€‚(å…¨å±€)</span></span><br><span class="line">    ingress.kubernetes.io/whitelist-source-range: <span class="string">"10.0.0.0/24,172.10.0.1"</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>6.å®‰å…¨é…ç½®ä¹‹è¯·æ±‚è®¿é—®æ—¥å¿—è®°å½•</strong><br>æè¿°: ä¸ºäº†ç­‰ä¿åˆè§„é€šå¸¸éœ€è¦å°†å„ç±»æ—¥å¿—å­˜å‚¨ 180 å¤©åŠä»¥ä¸Šï¼Œæ‰€ä»¥ingressä¹Ÿæ˜¯éå¸¸é‡è¦ï¼Œå½“ä¸šåŠ¡è¢«æ”»å‡»æ—¶æˆ‘ä»¬å¯ä»¥å¿«é€Ÿæº¯æºè¿½è¸ªï¼Œä»¥åŠå…¶è¡Œä¸ºåˆ†æã€‚</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># å¯ç”¨è®¿é—®æ—¥å¿—ï¼Œé»˜è®¤æƒ…å†µå¤„äºå¯ç”¨çŠ¶æ€.ä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½éœ€è¦ä¸ºç»™å®šå…¥å£ç¦ç”¨è®¿é—®æ—¥å¿—è®¾ç½®ä¸ºFalseå³å¯ã€‚</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">enable</span>-access-log: <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># å¯ç”¨é‡å†™æ—¥å¿—ï¼Œé»˜è®¤æƒ…å†µå¤„äºæœªå¯ç”¨çŠ¶æ€ï¼Œå¦‚å¯ç”¨é‡å†™æ—¥å¿—åœ¨é€šçŸ¥çº§åˆ«å‘é€åˆ°error_logæ–‡ä»¶ã€‚</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">enable</span>-rewrite-log: <span class="string">"true"</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>7.å®‰å…¨é…ç½®ä¹‹NginxæŒ‡å®šä»£ç†å“åº”æ ‡å¤´</strong><br>æè¿°: åœ¨ä½¿ç”¨ ingress-nginx åœºæ™¯ä¸­å…ä¸äº†é…ç½®ä½¿ç”¨ä»£ç†æˆ–å“åº”è¡¨å¤´ï¼Œä¾‹å¦‚å¸¸è§çš„<code>X-Frame-Options</code>è§„å®šäº†å…è®¸é‚£äº›ç«™ç‚¹åµŒå…¥é…ç½®ç›®æ ‡iframeç«™ç‚¹ã€‚</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># ç”¨äºæ’å…¥ server å—ä¸­çš„ä»£ç æ®µ</span></span><br><span class="line">    nginx.ingress.kubernetes.io/server-snippet: |</span><br><span class="line">      <span class="comment"># éšè—nginxç‰ˆæœ¬</span></span><br><span class="line">      server_tokens off;</span><br><span class="line">      <span class="comment"># Frame å®‰å…¨æ§åˆ¶ æ·»åŠ  X-Frame-Options å¤´</span></span><br><span class="line">      add_header X-Frame-Options SAMEORIGIN;</span><br><span class="line">      <span class="comment"># MIME æ¨¡æ‹Ÿæ¢æµ‹ ã€XXS-Protectionã€Spider Robots çˆ¬å–ç­–ç•¥é™åˆ¶</span></span><br><span class="line">      more_set_headers <span class="string">'x-content-type-options: nosniff</span></span><br><span class="line"><span class="string">'</span> <span class="string">'x-xss-protection: 1; mode=block'</span> <span class="string">'X-Robots-Tag: none;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”¨äºæ’å…¥ location å—ä»£ç æ®µ</span></span><br><span class="line">    nginx.ingress.kubernetes.io/configuration-snippet: |</span><br><span class="line">      <span class="comment"># è‡ªå®šä¹‰è®¿é—®åç«¯æœåŠ¡æ—¶æ‰€å¸¦å¤´</span></span><br><span class="line">      proxy_set_header My-Custom-Header <span class="variable">$http_my_custom_header</span>;</span><br><span class="line">      <span class="comment"># å°† X-FORWARDED-FOR å­—æ®µè·å–åˆ°å¤–éƒ¨IPå¸¦å…¥åç«¯æœåŠ¡</span></span><br><span class="line">      proxy_set_header X-FORWARDED-FOR <span class="variable">$http_X_FORWARDED_FOR</span>;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>8.å®‰å…¨é…ç½®ä¹‹Nginxç¦æ­¢è®¿é—®æŸä¸€ç›®å½•</strong><br>æè¿°: åœ¨ä½¿ç”¨ ingress-nginx åœºæ™¯ä¸­ï¼Œå¦‚ä½•ç¦æ­¢å®¢æˆ·ç«¯è®¿é—® ingress ç«™ç‚¹æŸä¸€ç›®å½•ä¸‹çš„æ‰€æœ‰èµ„æºï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® server-snippet æ³¨é‡Šï¼Œä¾‹å¦‚ã€‚</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># ç”¨äºæ’å…¥ server å—ä¸­çš„ä»£ç æ®µï¼Œç¦æ­¢è®¿é—® ç«™ç‚¹çš„ /itwork/ ç›®å½•ä¸‹èµ„æº</span></span><br><span class="line">    nginx.ingress.kubernetes.io/server-snippet: |</span><br><span class="line">      location /itwork/ &#123; deny all;<span class="built_in">return</span> 403;&#125;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>9.å®‰å…¨é…ç½®ä¹‹è¯·æ±‚è®¿é—®è®¤è¯</strong></p>
<p>æè¿°: é’ˆå¯¹äºæŸäº›æœªæœ‰è®¤è¯çš„APIæ¥å£åº”ç”¨ï¼Œå¯ä»¥é€šè¿‡åœ¨ Ingress è§„åˆ™ä¸­æ·»åŠ é¢å¤–çš„æ³¨é‡Šæ¥æ·»åŠ èº«ä»½éªŒè¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># è®¤è¯ç±»å‹ [basic|digest]</span></span><br><span class="line">    nginx.ingress.kubernetes.io/auth-type: </span><br><span class="line">    <span class="comment"># åŒ…å«ç”¨æˆ·/å¯†ç å®šä¹‰çš„å¯†ç çš„åç§°ï¼Œä½¿ç”¨configMapå­˜å‚¨htpasswdç”Ÿæˆçƒ­è®¤è¯</span></span><br><span class="line">    <span class="comment"># $ htpasswd -c auth weiyigee</span></span><br><span class="line">    <span class="comment"># $ kubectl create secret generic basic-auth --from-file=auth</span></span><br><span class="line">    nginx.ingress.kubernetes.io/auth-secret: basic-auth</span><br><span class="line">    <span class="comment"># è®¤è¯å¯†é’¥æœ‰ä¸¤ç§å½¢å¼ï¼š</span></span><br><span class="line">    <span class="comment"># auth-secret é»˜è®¤ï¼Œå¯†é’¥ä¸­çš„ htpasswd æ–‡ä»¶ä½äºå¯†é’¥ä¸­auth</span></span><br><span class="line">    <span class="comment"># auth-map å¯†é’¥æ˜¯ç”¨æˆ·åï¼Œå€¼æ˜¯æ•£åˆ—å¯†ç </span></span><br><span class="line">    nginx.ingress.kubernetes.io/auth-secret-type:auth-file</span><br><span class="line">    <span class="comment"># è®¾ç½®è®¤è¯æç¤º</span></span><br><span class="line">    nginx.ingress.kubernetes.io/auth-realm: <span class="string">"èº«ä»½è®¤è¯"</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p><strong>10.å®‰å…¨é…ç½®ä¹‹å¯ç”¨SSLæ¡æ‰‹åŠ å¯†å¥—ä»¶</strong><br>æè¿°: é€šå¸¸ä¸ºäº†åº”ç”¨å®‰å…¨æˆ‘ä»¬ä¼šä¸ºå…¶æ·»åŠ è¯ä¹¦ï¼Œä½†æ˜¯ä¸€äº›å·²çŸ¥è„†å¼±æ€§çš„SSLåŠ å¯†æ–¹å¼ä¼šå½±å“åˆ°åº”ç”¨ä¿¡æ¯å®‰å…¨ï¼Œä¾‹å¦‚ RC4 ä¸ MD5 ç­‰</p>
<p>ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1.ConfigMap</span></span><br><span class="line">$ kubectl edit cm -n ingress-nginx ingress-nginx-controller</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  <span class="comment"># æŒ‡å®šå¯ä»¥ç”¨çš„åŠ å¯†å¥—ä»¶ </span></span><br><span class="line">  ssl-ciphers: <span class="string">"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE:ECDH:AES:HIGH:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:!NULL:!aNULL:!eNULL:!EXPORT:!PSK:!ADH:!DH:!DES:!MD5:!RC4"</span></span><br><span class="line">  <span class="comment"># ssl åè®®</span></span><br><span class="line">  ssl-protocols: <span class="string">"TLSv1.1 TLSv1.2 TLSv1.3"</span></span><br><span class="line">  <span class="comment"># ssl ä¼šè¯å¤ç”¨</span></span><br><span class="line">  ssl_session_cache: <span class="string">"shared:SSL:10m;"</span></span><br><span class="line">  ssl-session-timeout: <span class="string">"10m"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2.Annotations </span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># é…ç½®æŒ‡å®šåœ¨ä½¿ç”¨ SSLv3 å’Œ TLS åè®®æ—¶ï¼ŒæœåŠ¡å™¨å¯†ç åº”ä¼˜å…ˆäºå®¢æˆ·ç«¯å¯†ç ã€‚</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-prefer-server-ciphers: <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># æŒ‡å®šåŠ å¯†å¥—ä»¶</span></span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-ciphers: <span class="string">"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE:ECDH:AES:HIGH:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:!NULL:!aNULL:!eNULL:!EXPORT:!PSK:!ADH:!DH:!DES:!MD5:!RC4;"</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>11.å®‰å…¨é…ç½®ä¹‹å¯ç”¨ modsecurity wafæ¨¡å—</strong><br>æè¿°: ModSecurity (<a href="http://modsecurity.org/" target="_blank" rel="noopener">http://modsecurity.org/</a>) æ˜¯ä¸€ä¸ªå¼€æºçš„Web Applicationé˜²ç«å¢™, å¯ä»¥ä¸ºä¸€ç»„ç‰¹å®šçš„å…¥å£ä½ç½®å¯ç”¨å®ƒã€‚å¿…é¡»é¦–å…ˆé€šè¿‡åœ¨ ConfigMap ä¸­å¯ç”¨ ModSecurity æ¥å¯ç”¨ ModSecurity æ¨¡å—ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œè¿™å°†ä¸ºæ‰€æœ‰è·¯å¾„å¯ç”¨ ModSecurityï¼Œå¹¶ä¸”å¿…é¡»æ‰‹åŠ¨ç¦ç”¨æ¯ä¸ªè·¯å¾„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1.ConfigMap</span></span><br><span class="line">$ kubectl edit cm -n ingress-nginx ingress-nginx-controller</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  <span class="comment"># å¯ç”¨ modsecurity wafæ¨¡å—æ‹¦æˆªå¸¸è§„Webæ”»å‡»</span></span><br><span class="line">  <span class="built_in">enable</span>-modsecurity: <span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2.Annotations </span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment"># å¯ç”¨ modsecurity</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">enable</span>-modsecurity: <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®ä»¥ä¸‹æ³¨é‡Šæ¥å¯ç”¨ OWASP æ ¸å¿ƒè§„åˆ™é›†</span></span><br><span class="line">    nginx.ingress.kubernetes.io/<span class="built_in">enable</span>-owasp-core-rules: <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># è®¾ç½®ä»¥ä¸‹å†…å®¹ä»nginxä¼ é€’äº‹åŠ¡ID</span></span><br><span class="line">    nginx.ingress.kubernetes.io/modsecurity-transaction-id: <span class="string">"<span class="variable">$request_id</span>"</span></span><br><span class="line">    <span class="comment"># é€šè¿‡ä»£ç æ®µæ·»åŠ è‡ªå·±çš„ä¸€ç»„ modsecurity è§„åˆ™ï¼š</span></span><br><span class="line">    nginx.ingress.kubernetes.io/modsecurity-snippet: |</span><br><span class="line">      Include /etc/nginx/owasp-modsecurity-crs/nginx-modsecurity.conf</span><br><span class="line"></span><br><span class="line">      SecRuleEngine On</span><br><span class="line">      SecDebugLog /tmp/modsec_debug.log</span><br></pre></td></tr></table></figure>
<p>OWASP æ ¸å¿ƒè§„åˆ™é›† ï¼š<a href="https://www.modsecurity.org/CRS/Documentation/" target="_blank" rel="noopener">https://www.modsecurity.org/CRS/Documentation/</a><br>å»ºè®®çš„é…ç½®å‚è€ƒ ï¼š<a href="https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended" target="_blank" rel="noopener">https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended</a></p>

        </div>
        
  <hr>
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>

  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ï¼Œè½¬ä¸ªå‘ã€‘(äººé—´äº”å¤§æƒ…)</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œè°¢è°¢ï¼ã€‚</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="æ‰«æVisit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-08-15T14:39:08.638Z" itemprop="dateUpdated">2022-08-15 22:39:08</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Ingress-Nginx/Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Ingress-Nginx/Ingress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2020/5-28-588.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/5-28-588.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">ğŸ‘ é’Ÿæ„ä½œè€…</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ingress-nginx/" rel="tag">ingress-nginx</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/5-28-588.html&title=ã€ŠIngress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/5-28-588.html&title=ã€ŠIngress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/5-28-588.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠIngress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/5-28-588.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/5-28-588.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/6-1-278.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">ç«ç‹æ‰©å±•å¼€å‘å…¥é—¨å®è·µ</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/5-28-621.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Redhat8.xå‘è¡Œç‰ˆç³»ç»ŸåŸºç¡€ä½¿ç”¨è®°å½•</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-Kubernetesä¸­Ingressè·¨åŸŸè®¾ç½®"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 Kubernetesä¸­Ingressè·¨åŸŸè®¾ç½®</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-Kubernetesä¸­ingress-nginxæ–‡ä»¶ä¸Šä¼ ä»£ç†è®¿é—®è¶…æ—¶è®¾ç½®"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 Kubernetesä¸­ingress-nginxæ–‡ä»¶ä¸Šä¼ ä»£ç†è®¿é—®è¶…æ—¶è®¾ç½®</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-Kubernetesä¸­ingress-nginxè·å–çœŸå®å®¢æˆ·ç«¯IP"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 Kubernetesä¸­ingress-nginxè·å–çœŸå®å®¢æˆ·ç«¯IP</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-Kubernetesä¸­ingress-nginx-å¦‚ä½•åœ¨å¤–éƒ¨è®¾ç½®è‡ªå®šä¹‰nginxæŒ‡ä»¤snippet"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 Kubernetesä¸­ingress-nginx å¦‚ä½•åœ¨å¤–éƒ¨è®¾ç½®è‡ªå®šä¹‰nginxæŒ‡ä»¤snippet</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-Kubernetesä¸­ingress-nginxæŒ‡å®šnodeäº²å’Œæ€§å’Œnginx-ingress-controllerä¿®æ”¹ç¼ºçœç«¯å£"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 Kubernetesä¸­ingress-nginxæŒ‡å®šnodeäº²å’Œæ€§å’Œnginx-ingress-controllerä¿®æ”¹ç¼ºçœç«¯å£</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x05-Kubernetesä¸­ingress-nginxå¦‚ä½•ä¸ºé¡¹ç›®é…ç½®å­è·¯å¾„"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x05 Kubernetesä¸­ingress-nginxå¦‚ä½•ä¸ºé¡¹ç›®é…ç½®å­è·¯å¾„</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x06-Kubernetes-ä¸­-ingress-nginx-ä¸Šçš„-HTTP-çš„é€Ÿç‡é™åˆ¶è¯·æ±‚"><span class="post-toc-number">7.</span> <span class="post-toc-text">0x06 Kubernetes ä¸­ ingress-nginx ä¸Šçš„ HTTP çš„é€Ÿç‡é™åˆ¶è¯·æ±‚</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x07-Kubernetesä¸­ingress-nginxä¼˜åŒ–é…ç½®"><span class="post-toc-number">8.</span> <span class="post-toc-text">0x07 Kubernetesä¸­ingress-nginxä¼˜åŒ–é…ç½®</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ingress-nginx-controller-Pod"><span class="post-toc-number">8.1.</span> <span class="post-toc-text">ingress-nginx-controller Pod</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ingress-nginx-controller-ConfigMap"><span class="post-toc-number">8.2.</span> <span class="post-toc-text">ingress-nginx-controller ConfigMap</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ingress-Rule"><span class="post-toc-number">8.3.</span> <span class="post-toc-text">ingress Rule</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x08-Kubernetesä¸­ingress-nginxå®‰å…¨é…ç½®"><span class="post-toc-number">9.</span> <span class="post-toc-text">0x08 Kubernetesä¸­ingress-nginxå®‰å…¨é…ç½®</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¿˜è¯·æ”¯æŒä¸€ä¸‹åšä¸»å“Ÿ, è°¢è°¢å„ä½çœ‹å‹â™¥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="228" height="228" alt="æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="228" height="228" alt="æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½æœ‹å‹,å¯ä»¥å…³ä¸ªæ³¨å—? â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">ä¸ªäººGithub</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">ä¸ªäººGitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">ä¸ªäººçŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘+äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved. ITå”¯ä¸€æå®¢ ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/5-28-588.html&title=ã€ŠIngress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/5-28-588.html&title=ã€ŠIngress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/5-28-588.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠIngress-Nginxè¿›é˜¶å­¦ä¹ å®è·µæ‰©å……é…ç½®è®°å½•ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/5-28-588.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/5-28-588.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLklEQVR42u3aS24jMQwFwNz/0p3tAEl73qPsAC2VVoE/bZUWDEXy6yte1491927y+X8/8/o5b14YGBiPZVwvV7utu2/dbf3n669/93YPGBgYBzDyR88C8evPrLAxMDAw8jRu5ZXZ8WFgYGAk6VrynPxbfxpwMTAwHshILrHJj61fdz9+F8fAwHggI6+6//3fH+lvYGBgPIpxlWvW5kyecC0sDAyMvRl5gEvSwdmmowtq8gQMDIwjGfkQWLvRtmwXlfYwMDC2ZszKZPlGV4p0dVjHwMDYlNG2AfLtzhqWs2PCwMDYlTFL/tqCWh7KZweBgYGxN6MNgnkb4PXls21eRg1ODAyMTRlt0ExeaYt3s5LfL/83MDAwtmasXybfG77rAQ4MDIytGXkS1hbx26ZC3qSMjhUDA2MjRjsM0bYhVwpt0WgFBgbGMYzZoEN7EU2uvkMwBgbGAYy2odiGyPwaPLs2Y2Bg7M1oL5DtJt6VXEZ7w8DAOICRJ4j5u215Lm8b3I5cYGBgbM1oU8Y2lWyPpn0OBgbGOYz2obP25Err9PZYMTAwDmC0BfpPJJErJUIMDIxdGVe58imzZKN50e0/wRcDA2NrxqzoPxvnylPGPE0ctjkxMDAeyKgLW6NksW1S1gEdAwPjAMYsdftEmjgcHcPAwMAoByPagJsPWNweCgYGBsabBjLai24R4jEwMA5grI9TzAY1ZuEbAwPjNMbSpMaotZBcemflPAwMjO0Y31eXQc/NYjWRAAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
