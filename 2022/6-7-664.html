<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="k8s">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                å­¦ä¹ ä¹‹è·¯
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/sites"  >
                <i class="icon icon-lg icon-globe"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="/img/video-account.jpg" target="_blank" >
                <i class="icon icon-lg icon-video-camera"></i>
                è§†é¢‘å·
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                å‹æƒ…é“¾æ¥
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤</h1>
        <h5 class="subtitle">
            
                <time datetime="2022-06-07T06:36:30.000Z" itemprop="datePublished" class="page-time">
  2022-06-07
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap" style="display: none;">
  <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤-cost"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤</h1>
        <div class="post-meta">
            <time class="post-time" title="2022-06-07 14:36:30" datetime="2022-06-07T06:36:30.000Z"  itemprop="datePublished">2022-06-07</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <span class="post-href" style="display: none;">https://mp.weixin.qq.com/s/v_kO8o8mWOYc38kot86g6Q|cost</span> 
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-å‰è¨€ç®€è¿°"><a href="#0x00-å‰è¨€ç®€è¿°" class="headerlink" title="0x00 å‰è¨€ç®€è¿°"></a>0x00 å‰è¨€ç®€è¿°</h2><p>æè¿°: åœ¨æˆ‘åšå®¢ä»¥åŠå‰é¢çš„æ–‡ç« ä¹‹ä¸­è®²è§£Kubernetesç›¸å…³é›†ç¾¤ç¯å¢ƒçš„æ­å»ºè¯´æ˜, éšç€K8SåŠå…¶ç›¸å…³ç»„ä»¶çš„è¿­ä»£, ä¸è¯»è€…å½“å‰æ¥è§¦çš„ç‰ˆæœ¬æœ‰æ‰€ä¸åŒï¼Œåœ¨ä¸Šä¸€ç« ä¸­æˆ‘ä»¬ä¸€èµ·å®è·µäº†ã€ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼è¿›è¡Œå®‰è£…éƒ¨ç½²é«˜å¯ç”¨çš„K8Sé›†ç¾¤V1.23.6ã€‘(<a href="https://blog.weiyigeek.top/2022/5-7-654.html">https://blog.weiyigeek.top/2022/5-7-654.html</a>) , æ‰€ä»¥æœ¬ç« å°†å®è·µä½¿ç”¨kubeadmæ–¹å¼éƒ¨ç½²æ­å»ºé«˜å¯ç”¨çš„kubernetesé›†ç¾¤V1.23.7ï¼Œæ­¤å¤„ä»ç„¶æŒ‰ç…§ubuntu 20.04ç³»ç»Ÿä»¥åŠhaproxyã€keepaliveã€containerdã€etcdã€kubeadmã€kubectl ç­‰ç›¸å…³å·¥å…·æ’ä»¶ã€æœ€æ–°æˆ–è€…ç¨³å®šçš„ç‰ˆæœ¬ã€‘è¿›è¡Œå®è·µï¼Œè¿™é‡Œä¸å†å¯¹k8sç­‰ç›¸å…³åŸºç¡€çŸ¥è¯†åšä»‹ç»ï¼Œå¦‚æœ‰æ–°å…¥é—¨çš„ç«¥é‹ï¼Œè¯·è®¿é—®å¦‚ä¸‹ã€åšå®¢æ–‡ç« ã€‘(<a href="https://blog.weiyigeek.top/tags/k8s/">https://blog.weiyigeek.top/tags/k8s/</a>) æˆ–è€…ã€Bç«™ä¸“æ ã€‘(<a href="https://www.bilibili.com/read/readlist/rl520875?spm_id_from=333.999.0.0" target="_blank" rel="noopener">https://www.bilibili.com/read/readlist/rl520875?spm_id_from=333.999.0.0</a>) æŒ‰ç…§é¡ºåºå­¦ä¹ ã€‚</p>
<p><strong>Kubernetes ç®€è¿°</strong><br>Kubernetes (åç»­ç®€ç§°k8s)æ˜¯ Google(2014å¹´6æœˆ) å¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’å¼•æ“ï¼Œä½¿ç”¨Goè¯­è¨€å¼€å‘ï¼Œå®ƒæ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²ã€å¤§è§„æ¨¡å¯ä¼¸ç¼©ã€ä»¥åŠäº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œç®¡ç†ã€‚å…¶ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨æ›´åŠ ç®€å•å¹¶ä¸”é«˜æ•ˆï¼Œæä¾›äº†èµ„æºè°ƒåº¦ã€éƒ¨ç½²ç®¡ç†ã€æœåŠ¡å‘ç°ã€æ‰©å®¹ç¼©å®¹ã€çŠ¶æ€ ç›‘æ§ã€ç»´æŠ¤ç­‰ä¸€æ•´å¥—åŠŸèƒ½, åŠªåŠ›æˆä¸ºè·¨ä¸»æœºé›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è‡ªåŠ¨åŒ–æ‰©å±•ä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºå®¹å™¨çš„å¹³å°ï¼Œå®ƒæ”¯æŒä¸€äº›åˆ—CNCFæ¯•ä¸šé¡¹ç›®ï¼ŒåŒ…æ‹¬ Containerdã€calico ç­‰ ã€‚</p>
<p><strong>æ‰©å±•æ–‡ç« :</strong><br>1.ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²v1.23.6çš„K8Sé›†ç¾¤å®è·µ(ä¸Š)ã€ <a href="https://mp.weixin.qq.com/s/sYpHENyehAnGOQQakYzhUA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/sYpHENyehAnGOQQakYzhUA</a> ã€‘<br>2.ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²v1.23.6çš„K8Sé›†ç¾¤å®è·µ(ä¸‹)ã€ <a href="https://mp.weixin.qq.com/s/-ksiNJG6v4q47ez7_H3uYQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/-ksiNJG6v4q47ez7_H3uYQ</a> ã€‘</p>
<p><strong>åŸæ–‡åœ°å€</strong>: <a href="https://blog.weiyigeek.top/2022/6-7-664.html">21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤</a></p>
<hr>
<h2 id="0x01-ç¯å¢ƒå‡†å¤‡"><a href="#0x01-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="0x01 ç¯å¢ƒå‡†å¤‡"></a>0x01 ç¯å¢ƒå‡†å¤‡</h2><h3 id="ä¸»æœºè§„åˆ’"><a href="#ä¸»æœºè§„åˆ’" class="headerlink" title="ä¸»æœºè§„åˆ’"></a>ä¸»æœºè§„åˆ’</h3><p>æ¸©é¦¨æç¤º: åŒæ ·æ­¤å¤„ä½¿ç”¨çš„æ˜¯ Ubuntu 20.04 æ“ä½œç³»ç»Ÿ, è¯¥ç³»ç»Ÿå·²åšå®‰å…¨åŠ å›ºå’Œå†…æ ¸ä¼˜åŒ–ç¬¦åˆç­‰ä¿2.0è¦æ±‚ã€SecOpsDev/Ubuntu-InitializeSecurity.sh at master Â· WeiyiGeek/SecOpsDev (github.com)ã€‘, å¦‚ä½ çš„Linuxæœªè¿›è¡Œç›¸åº”é…ç½®ç¯å¢ƒå¯èƒ½ä¸è¯»è€…æœ‰äº›è®¸å·®å¼‚, å¦‚éœ€è¦è¿›è¡Œ(windows serverã€Ubuntuã€CentOS)å®‰å…¨åŠ å›ºè¯·å‚ç…§å¦‚ä¸‹åŠ å›ºè„šæœ¬è¿›è¡ŒåŠ å›º, è¯·å¤§å®¶ç–¯ç‹‚çš„ star ã€‚</p>
<p>åŠ å›ºè„šæœ¬åœ°å€:ã€ <a href="https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh" target="_blank" rel="noopener">https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh</a> ã€‘</p>
<table>
<thead>
<tr>
<th style="text-align:center">ä¸»æœºåœ°å€</th>
<th style="text-align:center">ä¸»æœºåç§°</th>
<th style="text-align:center">ä¸»æœºé…ç½®</th>
<th style="text-align:center">ä¸»æœºè§’è‰²</th>
<th style="text-align:center">è½¯ä»¶ç»„ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">10.20.176.212</td>
<td style="text-align:center">devtest-master-212</td>
<td style="text-align:center">8C/16G</td>
<td style="text-align:center">æ§åˆ¶èŠ‚ç‚¹</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">10.20.176.213</td>
<td style="text-align:center">devtest-master-213</td>
<td style="text-align:center">8C/16G</td>
<td style="text-align:center">æ§åˆ¶èŠ‚ç‚¹</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">10.20.176.214</td>
<td style="text-align:center">devtest-master-214</td>
<td style="text-align:center">8C/32G</td>
<td style="text-align:center">æ§åˆ¶èŠ‚ç‚¹</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">10.20.176.215</td>
<td style="text-align:center">devtest-work-215</td>
<td style="text-align:center">8C/16G</td>
<td style="text-align:center">å·¥ä½œèŠ‚ç‚¹</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">10.20.176.211</td>
<td style="text-align:center">slbvip.k8s.devtest</td>
<td style="text-align:center">-</td>
<td style="text-align:center">è™šæ‹ŸVIP</td>
<td style="text-align:center">è™šæ‹Ÿç½‘å¡åœ°å€</td>
</tr>
</tbody>
</table>
<p><br/></p>
<h3 id="è½¯ä»¶ç‰ˆæœ¬"><a href="#è½¯ä»¶ç‰ˆæœ¬" class="headerlink" title="è½¯ä»¶ç‰ˆæœ¬"></a>è½¯ä»¶ç‰ˆæœ¬</h3><p><strong>æ“ä½œç³»ç»Ÿ</strong></p>
<ul>
<li>Ubuntu 20.04 LTS - 5.4.0-92-generic</li>
</ul>
<p><strong>é«˜å¯ç”¨è½¯ä»¶</strong></p>
<ul>
<li>ipvsadm - 1:1.31-1</li>
<li>haproxy - 2.0.13-2</li>
<li>keepalived - 1:2.0.19-2</li>
</ul>
<p><strong>ETCDæ•°æ®åº“</strong></p>
<ul>
<li>etcd - v3.5.4</li>
</ul>
<p><strong>å®¹å™¨è¿è¡Œæ—¶</strong></p>
<ul>
<li>containerd.io - 1.6.6</li>
</ul>
<p><strong>Kubernetes</strong></p>
<ul>
<li>kubeadm - v1.23.7</li>
<li>kube-apiserver - v1.23.7</li>
<li>kube-controller-manager - v1.23.7</li>
<li>kubectl - v1.23.7</li>
<li>kubelet - v1.23.7</li>
<li>kube-proxy - v1.23.7</li>
<li>kube-scheduler - v1.23.7</li>
</ul>
<p><strong>ç½‘ç»œæ’ä»¶&amp;è¾…åŠ©è½¯ä»¶</strong></p>
<ul>
<li>calico - v3.22</li>
<li>coredns - v1.9.1</li>
<li>kubernetes-dashboard - v2.5.1</li>
<li>k9s - v0.25.18</li>
</ul>
<p><br/></p>
<h3 id="ç½‘ç»œè§„åˆ’"><a href="#ç½‘ç»œè§„åˆ’" class="headerlink" title="ç½‘ç»œè§„åˆ’"></a>ç½‘ç»œè§„åˆ’</h3><table>
<thead>
<tr>
<th>å­ç½‘ Subnet</th>
<th>ç½‘æ®µ</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>nodeSubnet</td>
<td>10.20.176.0/24</td>
<td>å®¿ä¸»æœºèŠ‚ç‚¹å­ç½‘</td>
</tr>
<tr>
<td>ServiceSubnet</td>
<td>10.96.0.0/16</td>
<td>SVC å­ç½‘</td>
</tr>
<tr>
<td>PodSubnet</td>
<td>10.66.0.0/16</td>
<td>POD å­ç½‘</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="0x02-å®‰è£…éƒ¨ç½²"><a href="#0x02-å®‰è£…éƒ¨ç½²" class="headerlink" title="0x02 å®‰è£…éƒ¨ç½²"></a>0x02 å®‰è£…éƒ¨ç½²</h2><h3 id="1-å‡†å¤‡åŸºç¡€ä¸»æœºç¯å¢ƒé…ç½®"><a href="#1-å‡†å¤‡åŸºç¡€ä¸»æœºç¯å¢ƒé…ç½®" class="headerlink" title="1.å‡†å¤‡åŸºç¡€ä¸»æœºç¯å¢ƒé…ç½®"></a>1.å‡†å¤‡åŸºç¡€ä¸»æœºç¯å¢ƒé…ç½®</h3><p>æ­¥éª¤ 01.ã€æ‰€æœ‰ä¸»æœºã€‘ä¸»æœºåè®¾ç½®æŒ‰ç…§ä¸Šè¿°ä¸»æœºè§„åˆ’è¿›è¡Œè®¾ç½®ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾‹å¦‚, åœ¨10.20.176.212ä¸»æœºä¸­è¿è¡Œã€‚</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname devtest-master-212</span><br><span class="line"><span class="comment"># ä¾‹å¦‚, åœ¨10.20.176.213ä¸»æœºä¸­è¿è¡Œã€‚</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname devtest-master-213</span><br><span class="line"><span class="comment"># ä¾‹å¦‚, åœ¨10.20.176.214ä¸»æœºä¸­è¿è¡Œã€‚</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname devtest-master-214</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚, åœ¨10.10.107.215ä¸»æœºä¸­è¿è¡Œã€‚</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname devtest-work-215</span><br></pre></td></tr></table></figure><br><br/></p>
<p>æ­¥éª¤ 02.ã€æ‰€æœ‰ä¸»æœºã€‘å°†è§„åˆ’ä¸­çš„ä¸»æœºåç§°ä¸IPåœ°å€è¿›è¡Œç¡¬è§£æã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo tee -a /etc/hosts &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">10.20.176.211 slbvip.k8s.devtest</span><br><span class="line">10.20.176.212 devtest-master-212</span><br><span class="line">10.20.176.213 devtest-master-213</span><br><span class="line">10.20.176.214 devtest-master-214</span><br><span class="line">10.20.176.215 devtest-work-215</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><br><br/></p>
<p>æ­¥éª¤ 03.éªŒè¯æ¯ä¸ªèŠ‚ç‚¹ä¸ŠIPã€MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§,ä¿è¯å…¶èƒ½ç›¸äº’æ­£å¸¸é€šä¿¡<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨å‘½ä»¤ ip link æˆ– ifconfig -a æ¥è·å–ç½‘ç»œæ¥å£çš„ MAC åœ°å€</span></span><br><span class="line">ifconfig -a</span><br><span class="line"><span class="comment"># ä½¿ç”¨å‘½ä»¤ æŸ¥çœ‹ product_uuid æ ¡éªŒ</span></span><br><span class="line">sudo cat /sys/class/dmi/id/product_uuid</span><br></pre></td></tr></table></figure><br><br/></p>
<p>æ­¥éª¤ 04.ã€æ‰€æœ‰ä¸»æœºã€‘ç³»ç»Ÿæ—¶é—´åŒæ­¥ä¸æ—¶åŒºè®¾ç½®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">date -R</span><br><span class="line">sudo ntpdate ntp.aliyun.com</span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line"><span class="comment"># sudo dpkg-reconfigure tzdata</span></span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-local-rtc 0</span><br><span class="line">timedatectl</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 05.ã€æ‰€æœ‰ä¸»æœºã€‘ç¦ç”¨ç³»ç»Ÿäº¤æ¢åˆ†åŒº<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sed -i <span class="string">'s|^/swap.img|#/swap.ing|g'</span> /etc/fstab</span><br><span class="line"><span class="comment"># éªŒè¯äº¤æ¢åˆ†åŒºæ˜¯å¦è¢«ç¦ç”¨</span></span><br><span class="line">free | grep <span class="string">"Swap:"</span></span><br></pre></td></tr></table></figure></p>
<p><em>è¡¥å……:å…³é—­æˆ–è€…å¼€å¯Swapå¯¹äºKubernetesçš„å½±å“</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">é¦–å…ˆï¼ŒåŸºäºå®‰å…¨æ€§ï¼ˆå¦‚åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ‰¿è¯ºçš„ Secret åªä¼šåœ¨å†…å­˜ä¸­è¯»å†™ï¼Œä¸ä¼šè½ç›˜ï¼‰ã€åˆ©äºä¿è¯èŠ‚ç‚¹åŒæ­¥ä¸€è‡´æ€§ç­‰åŸå› ï¼Œä» 1.8 ç‰ˆå¼€å§‹ï¼ŒKubernetes å°±åœ¨å®ƒçš„æ–‡æ¡£ä¸­æ˜ç¡®å£°æ˜äº†å®ƒé»˜è®¤ä¸æ”¯æŒSwap åˆ†åŒºï¼Œåœ¨æœªå…³é—­ Swap åˆ†åŒºçš„æœºå™¨ä¸­ï¼Œé›†ç¾¤å°†ç›´æ¥æ— æ³•å¯åŠ¨ã€‚å…³é—­ Swap çš„å‘½ä»¤ä¸ºï¼š</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿˜æ˜¯å…ˆå¤‡ä»½ä¸€ä¸‹</span></span><br><span class="line">$ yes | sudo cp /etc/fstab /etc/fstab_bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œä¿®æ”¹</span></span><br><span class="line">$ sudo cat /etc/fstab_bak | grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯é€‰æ“ä½œ</span></span><br><span class="line">å½“ç„¶ï¼Œåœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„è¯ï¼Œå…³é—­ Swap å½±å“è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œå¦‚æœæœåŠ¡å™¨é™¤äº† Kubernetes è¿˜æœ‰å…¶ä»–ç”¨é€”çš„è¯ï¼ˆé™¤éå®åœ¨å¤ªç©·ï¼Œå¦åˆ™å»ºè®®ä¸è¦è¿™æ ·æ··ç”¨ï¼›ä¸€å®šè¦æ··ç”¨çš„è¯ï¼Œå®å¯æŠŠå…¶ä»–æœåŠ¡æ¬åˆ° Kubernetes ä¸Šï¼‰ã€‚å…³é—­ Swap æœ‰å¯èƒ½ä¼šå¯¹å…¶ä»–æœåŠ¡äº§ç”Ÿä¸è‰¯çš„å½±å“ï¼Œè¿™æ—¶éœ€è¦ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹çš„ kubelet é…ç½®ï¼Œå»æ‰å¿…é¡»å…³é—­ Swap çš„é»˜è®¤é™åˆ¶ï¼Œå…·ä½“æ“ä½œä¸ºï¼š</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"KUBELET_EXTRA_ARGS=--fail-swap-on=false"</span> &gt;&gt; /etc/sysconfig/kubelet</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 06.ã€æ‰€æœ‰ä¸»æœºã€‘ç³»ç»Ÿå†…æ ¸å‚æ•°è°ƒæ•´<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¦ç”¨ swap åˆ†åŒº</span></span><br><span class="line">egrep -q <span class="string">"^(#)?vm.swappiness.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?vm.swappiness.*|vm.swappiness = 0|g"</span>  /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"vm.swappiness = 0"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="comment"># å…è®¸è½¬å‘</span></span><br><span class="line">egrep -q <span class="string">"^(#)?net.ipv4.ip_forward.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?net.ipv4.ip_forward.*|net.ipv4.ip_forward = 1|g"</span>  /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"net.ipv4.ip_forward = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># - å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡</span></span><br><span class="line">egrep -q <span class="string">"^(#)?net.bridge.bridge-nf-call-iptables.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?net.bridge.bridge-nf-call-iptables.*|net.bridge.bridge-nf-call-iptables = 1|g"</span> /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-iptables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">egrep -q <span class="string">"^(#)?net.bridge.bridge-nf-call-ip6tables.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?net.bridge.bridge-nf-call-ip6tables.*|net.bridge.bridge-nf-call-ip6tables = 1|g"</span> /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-ip6tables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure><br><br/></p>
<p>æ­¥éª¤ 07.ã€æ‰€æœ‰ä¸»æœºã€‘ç¦ç”¨ç³»ç»Ÿé˜²ç«å¢™<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw <span class="built_in">disable</span> &amp;&amp; systemctl <span class="built_in">disable</span> ufw &amp;&amp; systemctl stop ufw</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="2-è´Ÿè½½å‡è¡¡ç®¡ç†ipvsadmå·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½"><a href="#2-è´Ÿè½½å‡è¡¡ç®¡ç†ipvsadmå·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½" class="headerlink" title="2.è´Ÿè½½å‡è¡¡ç®¡ç†ipvsadmå·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½"></a>2.è´Ÿè½½å‡è¡¡ç®¡ç†ipvsadmå·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½</h3><p>æ­¥éª¤ 01.å®‰è£…ipvsæ¨¡å—ä»¥åŠè´Ÿè½½å‡è¡¡ç›¸å…³ä¾èµ–ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison ipvsadm</span><br><span class="line">  <span class="comment"># ipvsadm |   1:1.31-1 | http://mirrors.aliyun.com/ubuntu focal/main amd64 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo apt -y install ipvsadm ipset sysstat conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬ </span></span><br><span class="line">apt-mark hold ipvsadm</span><br><span class="line">  <span class="comment"># ipvsadm set on hold.</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.å°†æ¨¡å—åŠ è½½åˆ°å†…æ ¸ä¸­(å¼€æœºè‡ªåŠ¨è®¾ç½®-éœ€è¦é‡å¯æœºå™¨ç”Ÿæ•ˆ)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/modules-load.d/k8s-.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># netfilter</span></span><br><span class="line">br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># containerd</span></span><br><span class="line">overlay</span><br><span class="line"></span><br><span class="line"><span class="comment"># nf_conntrack</span></span><br><span class="line">nf_conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment"># ipvs</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">xt_set</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.æ‰‹åŠ¨åŠ è½½æ¨¡å—åˆ°Linuxå†…æ ¸ä¸­ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /etc/modules.d/</span><br><span class="line">tee /etc/modules.d/k8s-ipvs.modules &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># netfilter æ¨¡å— å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡</span></span><br><span class="line">modprobe -- br_netfilter</span><br><span class="line"><span class="comment"># containerd</span></span><br><span class="line">modprobe -- overlay</span><br><span class="line"><span class="comment"># nf_conntrack</span></span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line"><span class="comment"># ipvs</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_lc</span><br><span class="line">modprobe -- ip_vs_lblc</span><br><span class="line">modprobe -- ip_vs_lblcr</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- ip_vs_dh</span><br><span class="line">modprobe -- ip_vs_fo</span><br><span class="line">modprobe -- ip_vs_nq</span><br><span class="line">modprobe -- ip_vs_sed</span><br><span class="line">modprobe -- ip_vs_ftp</span><br><span class="line">modprobe -- ip_tables</span><br><span class="line">modprobe -- ip_set</span><br><span class="line">modprobe -- ipt_set</span><br><span class="line">modprobe -- ipt_rpfilter</span><br><span class="line">modprobe -- ipt_REJECT</span><br><span class="line">modprobe -- ipip</span><br><span class="line">modprobe -- xt_set</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒé™è®¾ç½®ã€å¹¶åŠ è½½åˆ°ç³»ç»Ÿä¹‹ä¸­</span></span><br><span class="line">chmod 755 /etc/modules.d/k8s-ipvs.modules &amp;&amp; bash /etc/modules.d/k8s-ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">  <span class="comment"># ip_vs_sh               16384  0</span></span><br><span class="line">  <span class="comment"># ip_vs_wrr              16384  0</span></span><br><span class="line">  <span class="comment"># ip_vs_rr               16384  0</span></span><br><span class="line">  <span class="comment"># ip_vs                 155648  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span></span><br><span class="line">  <span class="comment"># nf_conntrack          139264  1 ip_vs</span></span><br><span class="line">  <span class="comment"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span></span><br><span class="line">  <span class="comment"># nf_defrag_ipv4         16384  1 nf_conntrack</span></span><br><span class="line">  <span class="comment"># libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span></span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: åœ¨ kernel 4.19 ç‰ˆæœ¬åŠä»¥ä¸Šå°†ä½¿ç”¨ nf_conntrack æ¨¡å—, åˆ™åœ¨ 4.18 ç‰ˆæœ¬ä»¥ä¸‹åˆ™éœ€ä½¿ç”¨nf_conntrack_ipv4 æ¨¡å—ã€‚</p>
<hr>
<h3 id="3-é«˜å¯ç”¨HAProxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®"><a href="#3-é«˜å¯ç”¨HAProxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®" class="headerlink" title="3.é«˜å¯ç”¨HAProxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®"></a>3.é«˜å¯ç”¨HAProxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®</h3><p>æè¿°: ç”±äºæ˜¯æµ‹è¯•å­¦ä¹ ç¯å¢ƒ, æ­¤å¤„æˆ‘æœªä¸“é—¨å‡†å¤‡ä¸¤å°HAæœåŠ¡å™¨, è€Œæ˜¯ç›´æ¥é‡‡ç”¨masterèŠ‚ç‚¹æœºå™¨ï¼Œå¦‚æœæ˜¯æ­£å¼ç¯å¢ƒå»ºè®®ç‹¬ç«‹å‡ºæ¥ã€‚</p>
<p>æ­¥éª¤ 01.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘å®‰è£…ä¸‹è½½ haproxy (HAä»£ç†å¥åº·æ£€æµ‹) ä¸ keepalived (è™šæ‹Ÿè·¯ç”±åè®®-ä¸»ä»)ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison haproxy keepalived</span><br><span class="line">  <span class="comment">#  haproxy | 2.0.13-2ubuntu0.5 | http://mirrors.aliyun.com/ubuntu focal-security/main amd64 Packages</span></span><br><span class="line">  <span class="comment"># keepalived | 1:2.0.19-2ubuntu0.2 | http://mirrors.aliyun.com/ubuntu focal-updates/main amd64 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo apt -y install haproxy keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬ </span></span><br><span class="line">apt-mark hold haproxy keepalived</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 02.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘è¿›è¡Œ HAProxy é…ç½®ï¼Œå…¶é…ç½®ç›®å½•ä¸º <code>/etc/haproxy/</code>ï¼Œæ‰€æœ‰èŠ‚ç‚¹é…ç½®æ˜¯ä¸€è‡´çš„ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/haproxy/haproxy.cfg&#123;,.bak&#125;</span><br><span class="line">tee /etc/haproxy/haproxy.cfg&lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">global</span><br><span class="line">  user haproxy</span><br><span class="line">  group haproxy</span><br><span class="line">  maxconn 2000</span><br><span class="line">  daemon</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span> local0</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span> local1 err</span><br><span class="line">  chroot /var/lib/haproxy</span><br><span class="line">  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br><span class="line">  stats timeout 30s</span><br><span class="line">  <span class="comment"># Default SSL material locations</span></span><br><span class="line">  ca-base /etc/ssl/certs</span><br><span class="line">  crt-base /etc/ssl/private</span><br><span class="line">  <span class="comment"># See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.0.3&amp;config=intermediate</span></span><br><span class="line">  ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><br><span class="line">  ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256</span><br><span class="line">  ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  <span class="built_in">log</span>     global</span><br><span class="line">  mode    http</span><br><span class="line">  option  httplog</span><br><span class="line">  option  dontlognull</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  timeout http-request 15s</span><br><span class="line">  timeout http-keep-alive 15s</span><br><span class="line">  <span class="comment"># errorfile 400 /etc/haproxy/errors/400.http</span></span><br><span class="line">  <span class="comment"># errorfile 403 /etc/haproxy/errors/403.http</span></span><br><span class="line">  <span class="comment"># errorfile 408 /etc/haproxy/errors/408.http</span></span><br><span class="line">  <span class="comment"># errorfile 500 /etc/haproxy/errors/500.http</span></span><br><span class="line">  <span class="comment"># errorfile 502 /etc/haproxy/errors/502.http</span></span><br><span class="line">  <span class="comment"># errorfile 503 /etc/haproxy/errors/503.http</span></span><br><span class="line">  <span class="comment"># errorfile 504 /etc/haproxy/errors/504.http</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: ç®¡ç†HAproxy (å¯é€‰)</span></span><br><span class="line"><span class="comment"># frontend monitor-in</span></span><br><span class="line"><span class="comment">#   bind *:33305</span></span><br><span class="line"><span class="comment">#   mode http</span></span><br><span class="line"><span class="comment">#   option httplog</span></span><br><span class="line"><span class="comment">#   monitor-uri /monitor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: åŸºäºå››å±‚ä»£ç†, 1644 3ä¸ºVIPçš„ ApiServer æ§åˆ¶å¹³é¢ç«¯å£, ç”±äºæ˜¯ä¸masterèŠ‚ç‚¹åœ¨ä¸€èµ·æ‰€ä»¥ä¸èƒ½ä½¿ç”¨6443ç«¯å£.</span></span><br><span class="line">frontend k8s-master</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:16443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:16443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: Master èŠ‚ç‚¹çš„é»˜è®¤ Apiserver æ˜¯6443ç«¯å£</span></span><br><span class="line">backend k8s-master</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server devtest-master-212 10.20.176.212:6443 check</span><br><span class="line">  server devtest-master-213 10.20.176.213:6443 check</span><br><span class="line">  server devtest-master-214 10.20.176.214:6443 check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><br><br/></p>
<p>æ­¥éª¤ 03.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘è¿›è¡Œ KeepAlived ç›¸å…³é…ç½® ï¼Œå…¶é…ç½®ç›®å½•ä¸º <code>/etc/haproxy/</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºé…ç½®ç›®å½•ï¼Œåˆ†åˆ«åœ¨å„ä¸ªmasterèŠ‚ç‚¹æ‰§è¡Œã€‚</span></span><br><span class="line">mkdir -vp /etc/keepalived</span><br><span class="line"><span class="comment"># __ROLE__ è§’è‰²: MASTER æˆ–è€… BACKUP</span></span><br><span class="line"><span class="comment"># __NETINTERFACE__ å®¿ä¸»æœºç‰©ç†ç½‘å¡åç§° ä¾‹å¦‚æˆ‘çš„ens32</span></span><br><span class="line"><span class="comment"># __IP__ å®¿ä¸»æœºç‰©ç†IPåœ°å€</span></span><br><span class="line"><span class="comment"># __VIP__ è™šæ‹ŸVIPåœ°å€</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">  state __ROLE__</span><br><span class="line">  interface __NETINTERFACE__</span><br><span class="line">  mcast_src_ip __IP__</span><br><span class="line">  virtual_router_id 51</span><br><span class="line">  priority 101</span><br><span class="line">  advert_int 2</span><br><span class="line">  authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass K8SHA_KA_AUTH</span><br><span class="line">  &#125;</span><br><span class="line">  virtual_ipaddress &#123;</span><br><span class="line">    __VIP__</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># HA å¥åº·æ£€æŸ¥</span></span><br><span class="line">  <span class="comment"># track_script &#123;</span></span><br><span class="line">  <span class="comment">#   chk_apiserver</span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤å¤„å°† devtest-master-212 é…ç½®ä¸º Master (devtest-master-212 ä¸»æœºä¸Šæ‰§è¡Œ)</span></span><br><span class="line"><span class="comment"># devtest-master-212 10.20.176.212 =&gt; MASTER</span></span><br><span class="line">sed -i -e <span class="string">'s#__ROLE__#MASTER#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__NETINTERFACE__#ens32#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__IP__#10.20.176.212#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__VIP__#10.20.176.211#g'</span> /etc/keepalived/keepalived.conf </span><br><span class="line"></span><br><span class="line"><span class="comment"># devtest-master-213 10.20.176.213 =&gt; BACKUP  (devtest-master-213 ä¸»æœºä¸Šæ‰§è¡Œ)</span></span><br><span class="line">sed -i -e <span class="string">'s#__ROLE__#BACKUP#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__NETINTERFACE__#ens32#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__IP__#10.20.176.213#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__VIP__#10.20.176.211#g'</span> /etc/keepalived/keepalived.conf </span><br><span class="line"></span><br><span class="line"><span class="comment"># devtest-master-214 10.20.176.214 =&gt; BACKUP  (devtest-master-214 ä¸»æœºä¸Šæ‰§è¡Œ)</span></span><br><span class="line">sed -i -e <span class="string">'s#__ROLE__#BACKUP#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__NETINTERFACE__#ens32#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__IP__#10.20.176.214#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__VIP__#10.20.176.211#g'</span> /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: æ³¨æ„ä¸Šè¿°çš„å¥åº·æ£€æŸ¥æ˜¯å…³é—­æ³¨é‡Šäº†çš„ï¼Œä½ éœ€è¦å°†K8Sé›†ç¾¤å»ºç«‹å®Œæˆåå†å¼€å¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">track_script &#123;</span><br><span class="line">  chk_apiserver</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 04.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘è¿›è¡Œé…ç½® KeepAlived å¥åº·æ£€æŸ¥æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sudo tee /etc/keepalived/check_apiserver.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(seq 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  check_code=$(pgrep haproxy)</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line">    err=$(expr <span class="variable">$err</span> + 1)</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    err=0</span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">"0"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"systemctl stop keepalived"</span></span><br><span class="line">  /usr/bin/systemctl stop keepalived</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line">sudo chmod +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 05.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘å¯åŠ¨ haproxy ã€keepalived ç›¸å…³æœåŠ¡åŠæµ‹è¯•VIPæ¼‚ç§»ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡è½½ Systemd è®¾ç½® haproxy ã€keepalived å¼€æœºè‡ªå¯ä»¥åŠç«‹å³å¯åŠ¨</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now haproxy &amp;&amp; sudo systemctl <span class="built_in">enable</span> --now keepalived</span><br><span class="line">  <span class="comment"># Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.</span></span><br><span class="line">  <span class="comment"># Executing: /lib/systemd/systemd-sysv-install enable haproxy</span></span><br><span class="line">  <span class="comment"># Synchronizing state of keepalived.service with SysV service script with /lib/systemd/systemd-sysv-install.</span></span><br><span class="line">  <span class="comment"># Executing: /lib/systemd/systemd-sysv-install enable keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ devtest-master-212 ä¸»æœºä¸­å‘ç°vipåœ°å€åœ¨å…¶ä¸»æœºä¸Šã€‚</span></span><br><span class="line">root@devtest-master-212:~$ ip addr</span><br><span class="line">  <span class="comment"># 2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span></span><br><span class="line">  <span class="comment">#   link/ether 00:50:56:8a:57:69 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#   inet 10.20.176.212/24 brd 10.20.176.255 scope global ens32</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#   inet 10.20.176.211/24 scope global ens32</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#   inet6 fe80::250:56ff:fe8a:5769/64 scope link</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶å®ƒä¸¤å°Masterä¸»æœºä¸Šé€šä¿¡éªŒè¯ã€‚</span></span><br><span class="line">root@devtest-master-213:~$ ping 10.20.176.211</span><br><span class="line">  <span class="comment"># PING 10.20.176.211 (10.20.176.211) 56(84) bytes of data.</span></span><br><span class="line">  <span class="comment"># 64 bytes from 10.20.176.211: icmp_seq=1 ttl=64 time=0.161 ms</span></span><br><span class="line">root@devtest-master-214:~$ ping 10.20.176.211</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220621153045.png" target="_blank" title="WeiyiGeek. KeepAlived-åœ°å€å­˜æ´»éªŒè¯" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220621153045.png" alt="WeiyiGeek. KeepAlived-åœ°å€å­˜æ´»éªŒè¯" title="" class=""></a>
                <p>WeiyiGeek. KeepAlived-åœ°å€å­˜æ´»éªŒè¯</p>
            </figure></p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨éªŒè¯VIPæ¼‚ç§»,æˆ‘ä»¬å°†è¯¥æœåŠ¡å™¨ä¸Škeepalivedåœæ­¢æ‰ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@devtest-master-212:~$ pgrep haproxy</span><br><span class="line">  <span class="comment"># 6120</span></span><br><span class="line">  <span class="comment"># 6121</span></span><br><span class="line">root@devtest-master-212:~$ /usr/bin/systemctl stop keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶,å‘ç°VIPå·²ç»é£˜åˆ°devtest-master-212ä¸»æœºä¸­</span></span><br><span class="line">root@devtest-master-215:~$ ip addr show ens32</span><br><span class="line">  <span class="comment"># 2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/ether 00:0c:29:93:28:61 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet10.20.176.215/24 brd 10.10.107.255 scope global ens32</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet 10.20.176.211/32 scope global ens32</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼ŒHAProxy ä¸ Keepalived é…ç½®å°±å‘Šä¸€æ®µè½äº†ã€‚</p>
<hr>
<h3 id="4-å®¹å™¨è¿è¡Œæ—¶containerd-ioå®‰è£…é…ç½®"><a href="#4-å®¹å™¨è¿è¡Œæ—¶containerd-ioå®‰è£…é…ç½®" class="headerlink" title="4.å®¹å™¨è¿è¡Œæ—¶containerd.ioå®‰è£…é…ç½®"></a>4.å®¹å™¨è¿è¡Œæ—¶containerd.ioå®‰è£…é…ç½®</h3><p>æ­¥éª¤ 01.åˆ†åˆ«åœ¨masterä¸workèŠ‚ç‚¹ä¸Šå®‰è£…containerdã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å¸è½½æ—§ç‰ˆæœ¬ </span></span><br><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æ›´æ–°aptåŒ…ç´¢å¼•å¹¶å®‰è£…åŒ…ä»¥å…è®¸aptåœ¨HTTPSä¸Šä½¿ç”¨å­˜å‚¨åº“</span></span><br><span class="line">sudo apt-get install -y \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates \</span><br><span class="line">  curl \</span><br><span class="line">  gnupg-agent \</span><br><span class="line">  software-properties-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥ # -fsSL</span></span><br><span class="line">curl https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.é€šè¿‡æœç´¢æŒ‡çº¹çš„æœ€å8ä¸ªå­—ç¬¦è¿›è¡Œå¯†é’¥éªŒè¯</span></span><br><span class="line">sudo apt-key fingerprint 0EBFCD88</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.è®¾ç½®ç¨³å®šå­˜å‚¨åº“</span></span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">  <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">  stable"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.å®‰è£…ç‰¹å®šç‰ˆæœ¬åœ¨repoä¸­åˆ—å‡ºå¯ç”¨çš„ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison containerd.io</span><br><span class="line">  <span class="comment"># containerd.io |    1.6.6-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class="line">  <span class="comment"># containerd.io |    1.6.4-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class="line">  <span class="comment"># containerd.io |   1.5.11-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.ä½¿ç”¨ç¬¬äºŒåˆ—ä¸­çš„ç‰ˆæœ¬å­—ç¬¦ä¸²å®‰è£…ç‰¹å®šçš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚: 1.6.6-1</span></span><br><span class="line">sudo apt-get install containerd.io=1.6.6-1</span><br><span class="line"><span class="comment"># ç¦»çº¿å®‰è£…: apt install -y ./containerd.io_1.6.6-1_amd64.deb</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 02.ä¸‹è½½å®‰è£…ååœ¨ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘è¿›è¡Œcontainerd é…ç½®ï¼Œæ­¤å¤„å°†åˆ›å»ºå¹¶ä¿®æ”¹ config.toml æ–‡ä»¶.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸º containerd ç”Ÿæˆé»˜è®¤é…ç½®</span></span><br><span class="line">mkdir -vp /etc/containerd</span><br><span class="line">containerd config default &gt;/etc/containerd/config.toml</span><br><span class="line">ls /etc/containerd/config.toml</span><br><span class="line">  <span class="comment"># /etc/containerd/config.toml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause é•œåƒæº</span></span><br><span class="line">sed -i <span class="string">"s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g"</span>  /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ SystemdCgroup</span></span><br><span class="line">sed -i <span class="string">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."docker.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com","https://xlx9erfu.mirror.aliyuncs.com","https://docker.mirrors.ustc.edu.cn"]'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># gcr.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."gcr.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."gcr.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://gcr.mirrors.ustc.edu.cn"]'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s.gcr.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."k8s.gcr.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://gcr.mirrors.ustc.edu.cn/google-containers/","https://registry.cn-hangzhou.aliyuncs.com/google_containers/"]'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># quay.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."quay.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."quay.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://quay.mirrors.ustc.edu.cn"]'</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 03.ä¿®æ”¹é…ç½®åã€æ‰€æœ‰èŠ‚ç‚¹ã€‘é‡è½½containerdæœåŠ¡å¹¶æŸ¥çœ‹ç›¸å…³æœåŠ¡åŠå…¶ç‰ˆæœ¬ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®é‡è½½ä¸æœåŠ¡é‡å¯</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart containerd.service</span><br><span class="line">systemctl status -l containerd.service</span><br><span class="line">  <span class="comment"># â— containerd.service - containerd container runtime</span></span><br><span class="line">  <span class="comment">#    Loaded: loaded (/lib/systemd/system/containerd.service; enabled; vendor preset: enabled)</span></span><br><span class="line">  <span class="comment">#    Active: active (running) since Thu 2022-06-16 05:22:50 UTC; 5 days ago</span></span><br><span class="line">  <span class="comment">#      Docs: https://containerd.io</span></span><br><span class="line">  <span class="comment">#  Main PID: 790 (containerd)</span></span><br><span class="line">  <span class="comment">#     Tasks: 51</span></span><br><span class="line">  <span class="comment">#    Memory: 76.3M</span></span><br><span class="line">  <span class="comment">#    CGroup: /system.slice/containerd.service</span></span><br><span class="line">  <span class="comment">#            â”œâ”€ 790 /usr/bin/containerd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯ç‰ˆæœ¬æŸ¥çœ‹</span></span><br><span class="line">root@devtest-master-212:/var/cache/apt/archives<span class="comment"># ctr version</span></span><br><span class="line"><span class="comment"># Client:</span></span><br><span class="line"><span class="comment">#   Version:  1.6.6</span></span><br><span class="line"><span class="comment">#   Revision: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span></span><br><span class="line"><span class="comment">#   Go version: go1.17.11</span></span><br><span class="line"><span class="comment"># Server:</span></span><br><span class="line"><span class="comment">#   Version:  1.6.6</span></span><br><span class="line"><span class="comment">#   Revision: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span></span><br><span class="line"><span class="comment">#   UUID: 71a28bbb-6ed6-408d-a873-e394d48b35d8</span></span><br><span class="line"></span><br><span class="line">root@devtest-master-212:/var/cache/apt/archives<span class="comment"># runc -v</span></span><br><span class="line">  <span class="comment"># runc version 1.1.2</span></span><br><span class="line">  <span class="comment"># commit: v1.1.2-0-ga916309</span></span><br><span class="line">  <span class="comment"># spec: 1.0.2-dev</span></span><br><span class="line">  <span class="comment"># go: go1.17.11</span></span><br><span class="line">  <span class="comment"># libseccomp: 2.5.1</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="5-å®‰è£…æºé…ç½®ä¸åˆå§‹åŒ–é›†ç¾¤é…ç½®å‡†å¤‡"><a href="#5-å®‰è£…æºé…ç½®ä¸åˆå§‹åŒ–é›†ç¾¤é…ç½®å‡†å¤‡" class="headerlink" title="5.å®‰è£…æºé…ç½®ä¸åˆå§‹åŒ–é›†ç¾¤é…ç½®å‡†å¤‡"></a>5.å®‰è£…æºé…ç½®ä¸åˆå§‹åŒ–é›†ç¾¤é…ç½®å‡†å¤‡</h3><p>æ­¥éª¤ 01.ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘Kubernetes å®‰è£…æºé…ç½®åŠå…¶kubeletã€kubeadmã€kubectlå·¥å…·ä¸‹è½½å®‰è£…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) gpg ç­¾åä¸‹è½½å¯¼å…¥</span></span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) Kubernetes å®‰è£…æº</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list </span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line">apt update</span><br><span class="line"><span class="comment"># å…¶å®ƒæ–¹å¼:</span></span><br><span class="line"><span class="comment"># (2) è®¾ç½®ç¨³å®šå­˜å‚¨åº“</span></span><br><span class="line"><span class="comment"># sudo add-apt-repository "deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) K8Så¯ç”¨ç‰ˆæœ¬,æ­¤å¤„å¯ä»¥çœ‹è§æœ€æ–°çš„æ˜¯ 1.24.1 , ç”±äºåšä¸»å®è·µçš„K8Sæ˜¯ä¸ºå¼€å‘æµ‹è¯•ç¯å¢ƒæ‰€æ­å»ºï¼Œåˆ™æ­¤å¤„é€‰æ‹© 1.23.7 ç‰ˆæœ¬ã€‚</span></span><br><span class="line">apt-cache madison kubelet | more</span><br><span class="line">  kubelet |  1.24.1-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages</span><br><span class="line">  kubelet |  1.24.0-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages</span><br><span class="line">  kubelet |  1.23.7-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) ä¸‹è½½å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„kubeletã€kubeadmã€kubectl</span></span><br><span class="line">K8S_VERSION=<span class="string">"1.23.7-00"</span></span><br><span class="line">sudo apt install kubelet=<span class="variable">$&#123;K8S_VERSION&#125;</span> kubeadm=<span class="variable">$&#123;K8S_VERSION&#125;</span> kubectl=<span class="variable">$&#123;K8S_VERSION&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘é‡è½½systemdå®ˆæŠ¤è¿›ç¨‹å¹¶å°† kubelet è®¾ç½®æˆå¼€æœºå¯åŠ¨<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart containerd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 03.ã€devtest-master-212ã€‘ä¸ºäº†èŠ‚çº¦æ‹‰å–å®è·µæˆ‘ä»¬å¯ä»¥åœ¨æŸä¸€å°masterèŠ‚ç‚¹ä¸Šå…ˆæ‹‰å–æ‰€K8Sé›†ç¾¤æ‰€éœ€è¦çš„é•œåƒã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€éœ€é•œåƒ</span></span><br><span class="line">kubeadm config images list --kubernetes-version=1.23.7</span><br><span class="line">  <span class="comment"># k8s.gcr.io/kube-apiserver:v1.23.7</span></span><br><span class="line">  <span class="comment"># k8s.gcr.io/kube-controller-manager:v1.23.7</span></span><br><span class="line">  <span class="comment"># k8s.gcr.io/kube-scheduler:v1.23.7</span></span><br><span class="line">  <span class="comment"># k8s.gcr.io/kube-proxy:v1.23.7</span></span><br><span class="line">  <span class="comment"># k8s.gcr.io/pause:3.6</span></span><br><span class="line">  <span class="comment"># k8s.gcr.io/etcd:3.5.1-0</span></span><br><span class="line">  <span class="comment"># k8s.gcr.io/coredns/coredns:v1.8.6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨é˜¿é‡Œæä¾›çš„é•œåƒæºè¿›è¡Œæ‹‰å–v1.23.7ç‰ˆæœ¬ä¾èµ–çš„ç›¸å…³é•œåƒ</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(kubeadm config images list --kubernetes-version=1.23.7 --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers -v 5);<span class="keyword">do</span></span><br><span class="line">  ctr -n k8s.io images pull <span class="variable">$&#123;i&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.23.7</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.23.7</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.23.7</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.23.7</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä» container.io ä¸­çš„é•œåƒå¯¼å‡ºæœ¬åœ°</span></span><br><span class="line"><span class="keyword">for</span> images <span class="keyword">in</span> $(ctr -n k8s.io i ls name~=registry.cn-hangzhou.aliyuncs.com/google_containers -q);<span class="keyword">do</span></span><br><span class="line">  temp_name=<span class="variable">$&#123;images##*/&#125;</span> </span><br><span class="line">  tar_name=$(<span class="built_in">echo</span> <span class="variable">$temp_name</span> |  tr <span class="string">':'</span> <span class="string">'_'</span>)</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"export <span class="variable">$&#123;images&#125;</span> &gt;&gt; <span class="variable">$tar_name</span>.tar"</span></span><br><span class="line">  ctr -n k8s.io images <span class="built_in">export</span> <span class="variable">$&#123;tar_name&#125;</span>.tar <span class="variable">$&#123;images&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æœ¬åœ°å¯¼å…¥é•œåƒåˆ° container.io ä¸­</span></span><br><span class="line"><span class="keyword">for</span> tarfile <span class="keyword">in</span> $(ls);<span class="keyword">do</span></span><br><span class="line">    $ ctr images import --base-name foo/bar foobar.tar</span><br><span class="line">  ctr -n k8s.io images <span class="built_in">export</span> <span class="variable">$&#123;tar_name&#125;</span>.tar <span class="variable">$&#123;images&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 04.å¯¼å…¥åˆ°å„ä¸ªèŠ‚ç‚¹åæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å¯¼å…¥çš„é•œåƒåˆ—è¡¨ä¿¡æ¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1</span></span><br><span class="line">ctr -n k8s.io i ls name~=registry.cn-hangzhou.aliyuncs.com/google_container</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2</span></span><br><span class="line">crictl images | grep <span class="string">"registry.cn-hangzhou.aliyuncs.com/google"</span></span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64               3.0                 99e59f495ffaa       314kB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   v1.8.6              a4ca41631cc7a       13.6MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.5.1-0             25f8c7f3da61c       98.9MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.23.7             03c169f383d97       32.6MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.23.7             e34d4a6252edd       30.2MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.23.7             b1aa05aa5100e       39.3MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.23.7             ed0ccfa052ab4       15.1MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.6                 6270bb605e12e       302kB</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="6-ä½¿ç”¨kubeadmå®‰è£…éƒ¨ç½²K8Sé›†ç¾¤"><a href="#6-ä½¿ç”¨kubeadmå®‰è£…éƒ¨ç½²K8Sé›†ç¾¤" class="headerlink" title="6.ä½¿ç”¨kubeadmå®‰è£…éƒ¨ç½²K8Sé›†ç¾¤"></a>6.ä½¿ç”¨kubeadmå®‰è£…éƒ¨ç½²K8Sé›†ç¾¤</h3><p>æ­¥éª¤ 01.ã€devtest-master-212 èŠ‚ç‚¹ã€‘ç”ŸæˆK8Såˆå§‹åŒ–yamlé…ç½®æ–‡ä»¶ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œç¼–è¾‘ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm-init-default.yaml</span><br><span class="line">$ vim kubeadm-init-default.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤å¤„ä¸ºv1.23.x é€‚ç”¨çš„é›†ç¾¤åˆå§‹åŒ–é…ç½®æ¸…å•</span></span><br><span class="line">tee kubeadm-init-cluster.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: devtes.httpweiyigeektop</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 10.20.176.212   <span class="comment"># å…³é”®ç‚¹: å½“å‰èŠ‚ç‚¹åœ°å€</span></span><br><span class="line">  bindPort: 6443                    <span class="comment"># å…³é”®ç‚¹: APIç«¯å£é»˜è®¤å³å¯</span></span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /run/containerd/containerd.sock  <span class="comment"># å…³é”®ç‚¹: æŒ‡å®šcontainerdä¸ºè¿è¡Œæ—¶</span></span><br><span class="line">  imagePullPolicy: IfNotPresent</span><br><span class="line">  name: devtest-master-212          <span class="comment"># å…³é”®ç‚¹: å½“å‰èŠ‚ç‚¹åç§°</span></span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:                         <span class="comment"># å…³é”®ç‚¹: è¯ä¹¦ä¸­å¿ƒåŒ…å«çš„SANsåˆ—è¡¨ä¸€èˆ¬åŒ…å«VIPä¸å„èŠ‚ç‚¹çš„ä¸»æœºåç§°</span></span><br><span class="line">  - slbvip.k8s.devtest</span><br><span class="line">  - localhost</span><br><span class="line">  - devtest-master-212</span><br><span class="line">  - devtest-master-213</span><br><span class="line">  - devtest-master-214</span><br><span class="line">  - 10.20.176.211</span><br><span class="line">  - 10.20.176.212</span><br><span class="line">  - 10.20.176.213</span><br><span class="line">  - 10.20.176.214</span><br><span class="line">  - 10.66.66.2</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers  <span class="comment"># å…³é”®ç‚¹: é›†ç¾¤æ‰€éœ€é•œåƒä»“åº“æºåŠ å¿«æ‹‰å–</span></span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.23.7                      <span class="comment"># å…³é”®ç‚¹: K8Sé›†ç¾¤ç‰ˆæœ¬æ­¤å¤„ä¸æˆ‘ä»¬æå‰ä¸‹è½½çš„é•œåƒç‰ˆæœ¬å¿…é¡»ä¸€è‡´å¦åˆ™å°†ä¼šé‡æ–°æ‹‰å–æŒ‡å®šK8Sé›†ç¾¤æ‰€éœ€é•œåƒã€‚</span></span><br><span class="line">controlPlaneEndpoint: slbvip.k8s.devtest:16443  <span class="comment"># å…³é”®ç‚¹: é«˜å¯ç”¨VIPåœ°å€çš„åŸŸåä¸haproxyä»£ç†ç«¯å£ã€‚</span></span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.test                       <span class="comment"># å…³é”®ç‚¹: é›†ç¾¤dnsæ ¹åŸŸé»˜è®¤cluster.local</span></span><br><span class="line">  serviceSubnet: 10.96.0.0/12                   <span class="comment"># å…³é”®ç‚¹: services æœåŠ¡å­ç½‘æ®µ</span></span><br><span class="line">  podSubnet: 10.66.0.0/16                       <span class="comment"># å…³é”®ç‚¹: pod æœåŠ¡å­ç½‘æ®µ</span></span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs                                      <span class="comment"># å…³é”®ç‚¹: å¯ç”¨IPVSæ”¯æŒ</span></span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs:</span><br><span class="line">  - 10.66.66.2/32                               <span class="comment"># å…³é”®ç‚¹: æ’å‡ºæŒ‡å®šIP</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.ã€devtest-master-212 èŠ‚ç‚¹ã€‘å‡†å¤‡å¥½åˆå§‹åŒ–yamlæ¸…å•å, é€šè¿‡ kubeadm init å‘½ä»¤è¿›è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ï¼Œå¹¶å°†æ—¥å¿—è¾“å…¥åˆ°kubeadm-init.logã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-init-cluster.yaml --v=5 | tee kubeadm-init.log</span><br><span class="line"><span class="comment"># --config æŒ‡å®šyamlé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># --v æŒ‡å®šæ—¥å¿—ç­‰çº§ debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“æ‰§è¡Œåå‡ºç°å¦‚ä¸‹æç¤ºè¡¨æ˜èŠ‚ç‚¹åˆå§‹åŒ–å®‰è£…æˆåŠŸï¼Œå¯ä»¥æŒ‰ç…§æŒ‡å®šæç¤ºè¿›è¡Œæ‰§è¡Œã€‚</span></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"><span class="comment"># To start using your cluster, you need to run the following as a regular user:</span></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternatively, if you are the root user, you can run:</span></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># You should now deploy a pod network to the cluster.</span></span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€æ§åˆ¶èŠ‚ç‚¹åŠ å…¥å‘½ä»¤ã€‘</span></span><br><span class="line"><span class="comment"># You can now join any number of control-plane nodes by copying certificate authorities and service account keys on each node and then running the following as root:</span></span><br><span class="line">  kubeadm join slbvip.k8s.devtest:16443 --token devtes.httpweiyigeektop \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22 \</span><br><span class="line">        --control-plane</span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€å·¥ä½œèŠ‚ç‚¹åŠ å…¥å‘½ä»¤ã€‘</span></span><br><span class="line"><span class="comment"># Then you can join any number of worker nodes by running the following on each as root:</span></span><br><span class="line">kubeadm join slbvip.k8s.devtest:16443 --token devtes.httpweiyigeektop \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.å°†ã€devtest-master-212ã€‘èŠ‚ç‚¹ä¸­<code>/etc/kubernetes/</code>ç›®å½•ä¸­çš„å¦‚ä¸‹æ–‡ä»¶è¿›è¡Œå¤åˆ¶æ‰“åŒ…ï¼Œå¹¶é€šè¿‡httpåè®®å°†å…¶åˆ†äº«ç»™å…¶å®ƒæœºå™¨è¿›è¡Œä¸‹è½½<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†caè¯ä¹¦æ‹·è´åˆ°æŒ‡å®šç›®å½•</span></span><br><span class="line">mkdir -vp /tmp/pki/etcd &amp;&amp; cp /etc/kubernetes/pki/ca.* /etc/kubernetes/pki/sa.* /etc/kubernetes/pki/front-proxy-ca.* /tmp/pki</span><br><span class="line">cp /etc/kubernetes/pki/etcd/ca.* /tmp/pki/etcd/</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‹ç¼©ä¾èµ–ä¾èµ–çš„caè¯ä¹¦ç›®å½•</span></span><br><span class="line">tar -zcvf pki.tar.gz pki/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ python æ­å»ºä¸€ä¸ªä¸´æ—¶ http æœåŠ¡</span></span><br><span class="line">python3 -m http.server 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å…¶å®ƒã€èŠ‚ç‚¹ã€‘è¿›å…¥åˆ°/tmp/æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œä¸‹è½½</span></span><br><span class="line"><span class="built_in">cd</span> /tmp/ &amp;&amp; wget 10.20.176.212:8080/pki.tar.gz</span><br><span class="line">tar -zxvf /tmp/pki.tar.gz -C /etc/kubernetes/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è§£å‹åçš„å¤åˆ¶åˆ°/etc/kubernetes/ç›®å½•ä¸­çš„æ–‡ä»¶ç›¸å…³ç»“æ„ã€‚</span></span><br><span class="line">tree /etc/kubernetes/</span><br><span class="line">/etc/kubernetes/</span><br><span class="line">â””â”€â”€ pki</span><br><span class="line">    â”œâ”€â”€ ca.crt</span><br><span class="line">    â”œâ”€â”€ ca.key</span><br><span class="line">    â”œâ”€â”€ etcd</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ ca.crt</span><br><span class="line">    â”‚Â Â  â””â”€â”€ ca.key</span><br><span class="line">    â”œâ”€â”€ front-proxy-ca.crt</span><br><span class="line">    â”œâ”€â”€ front-proxy-ca.key</span><br><span class="line">    â”œâ”€â”€ sa.key</span><br><span class="line">    â””â”€â”€ sa.pub</span><br><span class="line">2 directories, 8 files</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 04.åœ¨å…¶ä½™ã€masterã€‘èŠ‚ç‚¹ä¸­æ‰§è¡Œå¦‚ä¸‹ kubeadm join å‘½ä»¤æ·»åŠ æ–°çš„ Master èŠ‚ç‚¹åˆ°K8Sé›†ç¾¤æ§åˆ¶é¢æ¿ä¸­, åŠ å…¥æˆåŠŸåå¦‚ä¸‹å›¾æ‰€ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join slbvip.k8s.devtest:16443 \</span><br><span class="line">--control-plane \</span><br><span class="line">--token devtes.httpweiyigeektop \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22 \</span><br><span class="line">--cri-socket /run/containerd/containerd.sock</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220621221035.png" target="_blank" title="WeiyiGeek.master-join" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220621221035.png" alt="WeiyiGeek.master-join" title="" class=""></a>
                <p>WeiyiGeek.master-join</p>
            </figure>
<p>æ¸©é¦¨æç¤º: åœ¨<code>v1.23.x</code>å¦‚æœè¦ä½¿ç”¨containerdè¿è¡Œæ—¶å¿…é¡»<code>--cri-socket</code>æŒ‡å®šå…¶è¿è¡Œæ—¶socketã€‚</p>
<p><br></p>
<p>æ­¥éª¤ 05.åœ¨å…¶ä½™ã€workã€‘èŠ‚ç‚¹ä¸­æ‰§è¡Œå¦‚ä¸‹ kubeadm join å‘½ä»¤æ·»åŠ æ–°çš„ Work èŠ‚ç‚¹åˆ°K8Sé›†ç¾¤ä¸­, åŠ å…¥æˆåŠŸåå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join slbvip.k8s.devtest:16443 \</span><br><span class="line">  --token devtes.httpweiyigeektop \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:4e5b3acb1d821bbd3976355f7b12b1daaa44e1fc38cbdfb2f86f4078d9507f22 \</span><br><span class="line">  --cri-socket /run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220621221934.png" target="_blank" title="WeiyiGeek.work-join" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220621221934.png" alt="WeiyiGeek.work-join" title="" class=""></a>
                <p>WeiyiGeek.work-join</p>
            </figure>
<p><br></p>
<p>æ­¥éª¤ 06.å…¨éƒ¨åŠ å…¥åˆ°é›†ç¾¤åæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹æ·»åŠ çš„èŠ‚ç‚¹ä»¥åŠå…¶èŠ‚ç‚¹è§’è‰²è®¾ç½®ï¼Œæœ€ç»ˆæ‰§è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹æŸ¥çœ‹</span></span><br><span class="line">root@devtest-master-212:~$ kubectl get node</span><br><span class="line">  <span class="comment"># NAME                 STATUS   ROLES                  AGE     VERSION</span></span><br><span class="line">  <span class="comment"># devtest-master-212   Ready    control-plane,master   15m     v1.23.7</span></span><br><span class="line">  <span class="comment"># devtest-master-213   Ready    control-plane,master   5m19s   v1.23.7</span></span><br><span class="line">  <span class="comment"># devtest-master-214   Ready    control-plane,master   2m7s    v1.23.7</span></span><br><span class="line">  <span class="comment"># devtest-work-215     Ready    &lt;none&gt;                 14m     v1.23.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹è§’è‰²è®¾ç½®ï¼Œæ­¤å¤„å°†devtest-work-215èŠ‚ç‚¹çš„ROLESè®¾ç½®ä¸º workã€‚</span></span><br><span class="line">root@devtest-master-212:~$ kubectl label node devtest-work-215 node-role.kubernetes.io/work=</span><br><span class="line">  <span class="comment"># node/devtest-work-215 labeled</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220621222257.png" target="_blank" title="WeiyiGeek.cluster-roles" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220621222257.png" alt="WeiyiGeek.cluster-roles" title="" class=""></a>
                <p>WeiyiGeek.cluster-roles</p>
            </figure>
<p><br></p>
<p>æ­¥éª¤ 07.æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ã€é›†ç¾¤ç»„ä»¶ã€ä»¥åŠé›†ç¾¤ä¸­æ‰€æœ‰Podè¿›è¡ŒæŸ¥çœ‹, æ‰§è¡Œç»“æœå¦‚ä¸‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@devtest-master-212:~<span class="comment"># kubectl cluster-info</span></span><br><span class="line">  Kubernetes control plane is running at https://slbvip.k8s.devtest:16443</span><br><span class="line">  CoreDNS is running at https://slbvip.k8s.devtest:16443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line">  To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line">root@devtest-master-212:~<span class="comment"># kubectl get cs</span></span><br><span class="line">  Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">  NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">  scheduler            Healthy   ok</span><br><span class="line">  controller-manager   Healthy   ok</span><br><span class="line">  etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>,<span class="string">"reason"</span>:<span class="string">""</span>&#125;</span><br><span class="line"></span><br><span class="line">root@devtest-master-212:~<span class="comment"># kubectl get pod -A</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220621223144.png" target="_blank" title="WeiyiGeek.cluster-info" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220621223144.png" alt="WeiyiGeek.cluster-info" title="" class=""></a>
                <p>WeiyiGeek.cluster-info</p>
            </figure>
<p><br></p>
<p>æ­¥éª¤ 08.å¼€å¯æ‰€æœ‰ã€masterã€‘ä¸­keepalivedçš„å¥åº·æ£€æŸ¥,å¹¶é‡å¯keepalived.serviceæœåŠ¡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">...</span><br><span class="line"><span class="comment"># å¼€å¯ HA å¥åº·æ£€æŸ¥ï¼Œä¾‹å¦‚</span></span><br><span class="line">  track_script &#123;</span><br><span class="line">    chk_apiserver</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">systemctl restart keepalived.service</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 09.ç„¶åæˆ‘ä»¬ä¸ºkubectlæ·»åŠ å‘½ä»¤è‡ªåŠ¨è¡¥é½ä¸å…¨åŠŸèƒ½ï¼Œæ‰§è¡Œå¦‚ä¸‹ä»£ç å³å¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install -y bash-completion</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"source &lt;(kubectl completion bash)"</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 10.æœ€åæˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€ä¸ªnginxçš„PodéªŒè¯é›†ç¾¤ç¯å¢ƒ, å¹¶é€šè¿‡curlè¿›è¡Œè®¿é—®ï¼Œä½†æ˜¯æ­¤æ—¶ä½ ä¼šå‘ç°åªæœ‰åœ¨ã€devtest-work-215ã€‘ä¸»æœºä¸Šæ‰èƒ½è®¿é—®è¯¥nginxï¼Œè€Œå…¶å®ƒèŠ‚ç‚¹è®¿é—®æ—¶ä¼šæŠ¥<code>Connection timed out</code>, å…¶åŸå› å¯çœ‹ä¸‹é¢çš„æ¸©é¦¨æç¤ºã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image nginx:latest --port=80</span><br><span class="line">  pod/nginx created</span><br><span class="line"></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">  NAME    READY   STATUS    RESTARTS   AGE   IP          NODE               NOMINATED NODE   READINESS GATES</span><br><span class="line">  nginx   1/1     Running   0          68s   10.22.0.5   devtest-work-215   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">curl -I http://10.22.0.5</span><br><span class="line">  curl: (28) Failed to connect to 10.22.0.5 port 80: Connection timed out</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: è¿™æ˜¯ç”±äºæˆ‘ä»¬æ²¡æœ‰ä¸ºé›†ç¾¤é…ç½®ç½‘ç»œæ’ä»¶ï¼Œè€Œå¸¸ç”¨çš„ç½‘ç»œæ’ä»¶æ˜¯flannelã€calicoï¼ˆ<code>ä¸‹é¢å°†ä¼šä»¥æ­¤ä¸ºä¾‹</code>ï¼‰ä»¥åŠå½“ä¸‹ciliumã€‚</p>
<p><br/></p>
<p>æ­¥éª¤ 11.ç‰¹åˆ«æ³¨æ„æ­¤å¤„ä¸ºäº†èƒ½åœ¨åç»­æ¼”ç¤ºä¸­å°†Podåº”ç”¨è°ƒåº¦åˆ°MasterèŠ‚ç‚¹ä¸Š,æ­¤æ—¶æˆ‘ä»¬éœ€è¦åˆ†åˆ«å»é™¤æ§åˆ¶èŠ‚ç‚¹çš„æ±¡ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node devtest-master-212 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class="line">  <span class="comment"># node/devtest-master-212 untainted</span></span><br><span class="line"></span><br><span class="line">kubectl taint node devtest-master-213 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class="line">  <span class="comment"># node/devtest-master-213 untainted</span></span><br><span class="line"></span><br><span class="line">kubectl taint node devtest-master-214 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class="line">  <span class="comment"># node/devtest-master-214 untainted</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<hr>
<h3 id="7-éƒ¨ç½²é…ç½®-Calico-ç½‘ç»œæ’ä»¶"><a href="#7-éƒ¨ç½²é…ç½®-Calico-ç½‘ç»œæ’ä»¶" class="headerlink" title="7.éƒ¨ç½²é…ç½® Calico ç½‘ç»œæ’ä»¶"></a>7.éƒ¨ç½²é…ç½® Calico ç½‘ç»œæ’ä»¶</h3><p>æè¿°: åœ¨èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ—¶æœ‰æ—¶ä½ ä¼šå‘ç°å…¶èŠ‚ç‚¹çŠ¶æ€ä¸º NotReady, ä»¥åŠå‰é¢éƒ¨ç½²Podæ— æ³•è¢«å…¶å®ƒèŠ‚ç‚¹æœºå™¨è¿›è¡Œä»£ç†è½¬å‘è®¿é—®ï¼Œæ‰€ä»¥éƒ¨ç½²calicoæ’ä»¶å¯ä»¥è®©Podä¸é›†ç¾¤æ­£å¸¸é€šä¿¡ã€‚</p>
<p>æ­¥éª¤ 01.åœ¨ã€devtest-master-212ã€‘èŠ‚ç‚¹ä¸Šæ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„ calico å½“å‰æœ€æ–°ç‰ˆæœ¬ä¸º v3.22, å®˜æ–¹é¡¹ç›®åœ°å€ (<a href="https://github.com/projectcalico/calico" target="_blank" rel="noopener">https://github.com/projectcalico/calico</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å– calico éƒ¨ç½²æ¸…å•</span></span><br><span class="line">wget https://docs.projectcalico.org/v3.22/manifests/calico.yaml</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 02.ä¿®æ”¹ calico.yaml æ–‡ä»¶çš„ä¸­å¦‚ä¸‹ K/V, å³ Pod è·å–IPåœ°å€çš„åœ°å€æ± , ä»ç½‘ç»œè§„åˆ’ä¸­æˆ‘ä»¬è®¾ç½®ä¸º <code>10.66.0.0/16</code>, æ³¨æ„é»˜è®¤æƒ…å†µä¸‹å¦‚ä¸‹å­—æ®µæ˜¯æ³¨é‡Šçš„ä¸”é»˜è®¤åœ°å€æ± ä¸º<code>192.168.0.0/16</code>ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim calico.yaml</span><br><span class="line"><span class="comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span></span><br><span class="line"><span class="comment"># chosen from this range. Changing this value after installation will have</span></span><br><span class="line"><span class="comment"># no effect. This should fall within `--cluster-cidr`.</span></span><br><span class="line">- name: CALICO_IPV4POOL_CIDR</span><br><span class="line">  value: <span class="string">"10.66.0.0/16"</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220622103937.png" target="_blank" title="WeiyiGeek.CALICO_IPV4POOL_CIDR" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220622103937.png" alt="WeiyiGeek.CALICO_IPV4POOL_CIDR" title="" class=""></a>
                <p>WeiyiGeek.CALICO_IPV4POOL_CIDR</p>
            </figure>
<p><br/></p>
<p>æ­¥éª¤ 03.æ‰§è¡Œ kubectl apply å‘½ä»¤éƒ¨ç½² calico åˆ°é›†ç¾¤ä¹‹ä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br><span class="line">  <span class="comment"># configmap/calico-config created</span></span><br><span class="line">  <span class="comment"># ....</span></span><br><span class="line">  <span class="comment"># poddisruptionbudget.policy/calico-kube-controllers created</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 04.æŸ¥çœ‹calicoç½‘ç»œæ’ä»¶åœ¨å„èŠ‚ç‚¹ä¸Šéƒ¨ç½²ç»“æœ,çŠ¶æ€ä¸ºRunningè¡¨ç¤ºéƒ¨ç½²æˆåŠŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system -o wide| head -n 6</span><br><span class="line">  <span class="comment"># NAME                                         READY   STATUS    RESTARTS        AGE     IP              NODE                 NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># calico-kube-controllers-6b77fff45-w29rq      1/1     Running   0               8m5s    10.66.35.65     devtest-master-214   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># calico-node-7gxdc                            1/1     Running   0               8m5s    10.20.176.213   devtest-master-213   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># calico-node-tsk6w                            1/1     Running   0               8m5s    10.20.176.212   devtest-master-212   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># calico-node-vnkhg                            1/1     Running   0               8m5s    10.20.176.215   devtest-work-215     &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># calico-node-xh2dw                            1/1     Running   0               8m5s    10.20.176.214   devtest-master-214   &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220622104018.png" target="_blank" title="WeiyiGeek.calico-éƒ¨ç½²æƒ…å†µ" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220622104018.png" alt="WeiyiGeek.calico-éƒ¨ç½²æƒ…å†µ" title="" class=""></a>
                <p>WeiyiGeek.calico-éƒ¨ç½²æƒ…å†µ</p>
            </figure>
<p><br/></p>
<p>æ­¥éª¤ 05.æ­¤æ—¶åˆ é™¤ nginx çš„ Pod å†é‡æ–°åˆ›å»ºä¸€ä¸ªPodåº”ç”¨ï¼Œå¹¶åœ¨éã€devtest-work-215 ã€‘èŠ‚ç‚¹ä¸Šè¿›è¡Œè®¿é—®æµ‹è¯•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@devtest-master-212:/opt/init/k8s<span class="comment"># kubectl run nginx --image=nginx:latest --port=80</span></span><br><span class="line">  <span class="comment"># pod/nginx created</span></span><br><span class="line"></span><br><span class="line">root@devtest-master-212:/opt/init/k8s<span class="comment"># kubectl get pod nginx</span></span><br><span class="line">  <span class="comment"># NAME    READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># nginx   1/1     Running   0          10s</span></span><br><span class="line"></span><br><span class="line">root@devtest-master-212:/opt/init/k8s<span class="comment"># kubectl get pod nginx -o wide</span></span><br><span class="line">  <span class="comment"># NAME    READY   STATUS    RESTARTS   AGE   IP   NODE   NOMINATED NODE       READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx   1/1     Running   0          13s   10.66.53.66   devtest-work-215   &lt;none&gt;   &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">root@devtest-master-212:/opt/init/k8s<span class="comment"># curl -I 10.66.53.66</span></span><br><span class="line">  <span class="comment"># HTTP/1.1 200 OK</span></span><br><span class="line">  <span class="comment"># Server: nginx/1.21.5</span></span><br><span class="line">  <span class="comment"># Date: Wed, 15 Jun 2022 11:39:48 GMT</span></span><br><span class="line">  <span class="comment"># Content-Type: text/html</span></span><br><span class="line">  <span class="comment"># Content-Length: 615</span></span><br><span class="line">  <span class="comment"># Last-Modified: Tue, 28 Dec 2021 15:28:38 GMT</span></span><br><span class="line">  <span class="comment"># Connection: keep-alive</span></span><br><span class="line">  <span class="comment"># ETag: "61cb2d26-267"</span></span><br><span class="line">  <span class="comment"># Accept-Ranges: bytes</span></span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œé«˜å¯ç”¨çš„K8Sé›†ç¾¤éƒ¨ç½²å®Œæ¯•ï¼Œåœ¨ä¸‹èŠ‚ä¸­å°†å®è·µæ¼”ç¤ºåœ¨é›†ç¾¤ä¸­å®‰è£… Metrics Server ã€kubernetes-dashboardã€nfs-provisionerã€ingress ç­‰å®‰è£…å®è·µã€‚</p>
<hr>
<h2 id="0x03-é›†ç¾¤è¾…åŠ©æ’ä»¶éƒ¨ç½²"><a href="#0x03-é›†ç¾¤è¾…åŠ©æ’ä»¶éƒ¨ç½²" class="headerlink" title="0x03 é›†ç¾¤è¾…åŠ©æ’ä»¶éƒ¨ç½²"></a>0x03 é›†ç¾¤è¾…åŠ©æ’ä»¶éƒ¨ç½²</h2><h3 id="1-é›†ç¾¤ä¸­åŸºäºnfsçš„provisionerçš„åŠ¨æ€æŒå·ç¯å¢ƒéƒ¨ç½²"><a href="#1-é›†ç¾¤ä¸­åŸºäºnfsçš„provisionerçš„åŠ¨æ€æŒå·ç¯å¢ƒéƒ¨ç½²" class="headerlink" title="1.é›†ç¾¤ä¸­åŸºäºnfsçš„provisionerçš„åŠ¨æ€æŒå·ç¯å¢ƒéƒ¨ç½²"></a>1.é›†ç¾¤ä¸­åŸºäºnfsçš„provisionerçš„åŠ¨æ€æŒå·ç¯å¢ƒéƒ¨ç½²</h3><p>æè¿°: åœ¨K8Sé›†ç¾¤ä¸­æˆ‘ä»¬å¸¸å¸¸ä¼šä½¿ç”¨åŠ¨æ€æŒä¹…å·å¯¹åº”ç”¨æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜ï¼Œä¾‹å¦‚åº”ç”¨é…ç½®ã€ä¾èµ–æ’ä»¶ã€åº”ç”¨æ•°æ®ä»¥åŠåº”ç”¨è®¿é—®æ—¥å¿—ç­‰ï¼Œæ‰€ä»¥åŠ¨æ€æŒä¹…å·çš„é‡è¦æ€§ä¸è¨€è€Œå–»ï¼Œæ­¤å°èŠ‚å°†è®²è§£å¦‚ä½•æ­å»ºä»¥åŠnfså­˜å‚¨æœåŠ¡ä»¥åŠä½¿ç”¨<code>kubernetes-sigs</code>æä¾›çš„[nfs-subdir-external-provisioner] (<a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner)é¡¹ç›®é’ˆå¯¹å·²å­˜åœ¨çš„" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner)é¡¹ç›®é’ˆå¯¹å·²å­˜åœ¨çš„</a> nfs æœåŠ¡å™¨è¿›è¡Œ provisioner éƒ¨ç½²ã€‚</p>
<p><br></p>
<p><strong>Q: ä»€ä¹ˆæ˜¯nfs-subdir-external-provisioner?</strong></p>
<blockquote>
<p>NFS subdir external provisioner æ˜¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®å™¨ï¼Œå®ƒä½¿ç”¨æ‚¨ç°æœ‰çš„å’Œå·²é…ç½®çš„ NFS æœåŠ¡å™¨æ¥æ”¯æŒé€šè¿‡  Persistent Volume Claims åŠ¨æ€é…ç½® Kubernetes Persistent Volumesã€‚<br>æŒä¹…å·é…ç½®ä¸º  \${namespace}-\${pvcName}-\${pvName}ã€‚</p>
</blockquote>
<p>æ¸©é¦¨æç¤ºï¼šåœ¨è¿›è¡Œæ­¤ç¯å¢ƒæ­å»ºæ—¶ï¼Œè¯·æ³¨æ„æ‚¨å¿…é¡»å·²ç»æœ‰é…ç½®å¥½çš„ NFS æœåŠ¡å™¨ï¼Œä¸ºäº†ä¿æŒä¸æ—©æœŸéƒ¨ç½²æ–‡ä»¶çš„å‘åå…¼å®¹æ€§ï¼ŒNFS Client Provisioner çš„å‘½ååœ¨éƒ¨ç½² YAML ä¸­ä¿ç•™ä¸º nfs-storage-provisionerã€‚</p>
<p>é¡¹ç›®åœ°å€: <a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></p>
<p><br></p>
<p>æ­¥éª¤ 01.æˆ‘åœ¨ä¸€å°Ubuntu 20.04ä¸»æœºä¸Šé…ç½® NFS å­˜å‚¨æœåŠ¡å™¨(IPåœ°å€ä¸º10.20.176.102)ï¼Œå¦‚æœä½ å·²æœ‰å­˜å‚¨æœåŠ¡å™¨æä¾›çš„NFSæœåŠ¡å™¨åˆ™å¯ä»¥ç•¥è¿‡æ­¤æ­¥éª¤ï¼Œå…¶å®ƒæ“ä½œç³»ç»Ÿå®‰è£…éƒ¨ç½²è¯·çœ‹å‡ºæˆ‘çš„è¿™ç¯‡åšå®¢æ–‡ç« [NFSç½‘ç»œæ–‡ä»¶ç³»ç»ŸåŸºç¡€é…ç½®ä¸ä½¿ç”¨] (<a href="https://blog.weiyigeek.top/2019/5-16-104.html">https://blog.weiyigeek.top/2019/5-16-104.html</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step1.Install Required Packagesï¼ˆServerï¼‰</span></span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install nfs-kernel-server rpcbind</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step2.Configure NFS Server</span></span><br><span class="line"><span class="comment"># [æ ¹æ®éœ€æ±‚é…ç½®] è®¾ç½®å…è®¸è¿æ¥çš„ip, Example Allow 192.168.1.0/24 to be Accessed on Network</span></span><br><span class="line">$ nano /etc/hosts.allow</span><br><span class="line">portmap: 192.168.1.0/24   </span><br><span class="line"></span><br><span class="line"><span class="comment"># [æ ¹æ®éœ€æ±‚é…ç½®] idmapd é…ç½®, æ­¤å¤„é…ç½®ç«¯å£ä¸º40000</span></span><br><span class="line">$ nano /etc/default/nfs-common</span><br><span class="line">NEED_IDMAPD=YES  </span><br><span class="line">STATDOPTS=<span class="string">"--port 40000"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [æ ¹æ®éœ€æ±‚é…ç½®] å†…æ ¸æœåŠ¡é…ç½®,æ­¤å¤„mountdæœåŠ¡ç«¯å£ä¸º40001</span></span><br><span class="line">$ nano /etc/default/nfs-kernel-server</span><br><span class="line">RPCMOUNTDOPTS=<span class="string">"--manage-gids --port 40001"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NFS æœåŠ¡å™¨å…±äº«è·¯å¾„é…ç½®</span></span><br><span class="line">$ nano /etc/exports</span><br><span class="line"><span class="comment"># Example for NFSv2 and NFSv3:</span></span><br><span class="line"><span class="comment"># /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)</span></span><br><span class="line"><span class="comment"># Example for NFSv4:</span></span><br><span class="line"><span class="comment"># /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)</span></span><br><span class="line"><span class="comment"># /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)</span></span><br><span class="line">/app/storage/nfs *(rw,sync,no_root_squash,no_subtree_check)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step3.åˆ›å»ºNFSé…ç½®éœ€è¦å…±äº«çš„ç›®å½•</span></span><br><span class="line">mkdir -vp /app/storage/nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step4.è‡ªå¯åŠ¨RPCæœåŠ¡äºnfså…±äº«æœåŠ¡</span></span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind nfs-server.service</span><br><span class="line">systemctl start rpcbind nfs-server.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step5.æ›´æ–°nfsé…ç½®æ–‡ä»¶ (nano /etc/exports)</span></span><br><span class="line">  exportfs -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step6.Ubuntué˜²ç«å¢™è§„åˆ™é…ç½® ï¼ˆPS: é€šè¿‡rpcinfoå‘½ä»¤å¯ä»¥æŸ¥çœ‹ NFS ç›¸å…³çš„ç«¯å£ï¼‰</span></span><br><span class="line">ufw allow 111,2049,40000,40001/tcp</span><br><span class="line">ufw reload</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 02.ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘åœ¨å®¢æˆ·ç«¯å°è¯•æŒ‚è½½æ­å»ºçš„NFSæœåŠ¡å™¨ï¼Œå¹¶åˆ†åˆ«åœ¨èŠ‚ç‚¹æœºå™¨æŒ‚è½½åˆ°<code>/storage/nfs</code>ç›®å½•ä¸­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ NFS æŒ‚è½½ç›®å½•</span></span><br><span class="line">showmount -e 127.0.0.1</span><br><span class="line">  <span class="comment"># Export list for 127.0.0.1:</span></span><br><span class="line">  <span class="comment"># /app/storage/nfs *</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½ NFS æœåŠ¡å™¨åˆ°æŒ‡å®šèŠ‚ç‚¹ç›®å½•çš„/storage/nfsç›®å½•</span></span><br><span class="line">mkdir -vp /storage/nfs</span><br><span class="line"><span class="comment"># ä¸´æ—¶æŒ‚è½½</span></span><br><span class="line">mount -t nfs 10.20.176.102:/app/storage/nfs /storage/nfs</span><br><span class="line"><span class="comment"># æ°¸ä¹…æŒ‚è½½å°†æŒ‚è½½é…ç½®å†™å…¥åˆ°/etc/fstabä¸­</span></span><br><span class="line">tee -a /etc/fstab &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">10.20.176.102:/app/storage/nfs /storage/nfs nfs defaults 0 0</span><br><span class="line">EOF</span><br><span class="line">mount -a </span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‚è½½ä¿¡æ¯</span></span><br><span class="line">$ mount -l</span><br><span class="line">$ df -Th | grep <span class="string">"/storage/nfs"</span></span><br><span class="line">10.20.176.102:/app/storage/nfs nfs4   97G   11G   82G  12% /storage/nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœä¸ä½¿ç”¨äº†åˆ™å¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œå¸è½½æŒ‚è½½ç‚¹</span></span><br><span class="line">umount /storage/nfs</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220622162349.png" target="_blank" title="WeiyiGeek.æŒ‚è½½NFSæœåŠ¡åˆ°å„ä¸ªèŠ‚ç‚¹" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220622162349.png" alt="WeiyiGeek.æŒ‚è½½NFSæœåŠ¡åˆ°å„ä¸ªèŠ‚ç‚¹" title="" class=""></a>
                <p>WeiyiGeek.æŒ‚è½½NFSæœåŠ¡åˆ°å„ä¸ªèŠ‚ç‚¹</p>
            </figure>
<p><br></p>
<p>æ­¥éª¤ 03.helm3 éƒ¨ç½²å·¥å…·å¿«é€Ÿå®‰è£…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># helm3 å®‰è£…</span></span><br><span class="line">$ wget https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz &amp;&amp; tar -zxf helm-v3.9.0-linux-amd64.tar.gz</span><br><span class="line">$ tar -zxf helm-v3.9.0-linux-amd64.tar.gz</span><br><span class="line">$ cp linux-amd64/helm /usr/<span class="built_in">local</span>/bin/helm3</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 04.åœ¨Githubä¸­ä¸‹è½½nfs-subdir-external-provisionerçš„releaseå‹ç¼©åŒ…æˆ–è€…ä½¿ç”¨helm3æŒ‡å®šä»“åº“è¿›è¡Œå®‰è£…ã€‚</p>
<ul>
<li><p>æ–¹å¼1.release å‹ç¼©åŒ…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/releases/download/nfs-subdir-external-provisioner-4.0.16/nfs-subdir-external-provisioner-4.0.16.tgz</span><br><span class="line">$ tar -zxvf nfs-subdir-external-provisioner-4.0.16.tgz</span><br><span class="line"><span class="comment"># æŒ‰ç…§æŒ‡å®šéœ€æ±‚ç¼–è¾‘å¦‚ä¸‹valueså€¼</span></span><br><span class="line">$ egrep -v <span class="string">'^$|#'</span> values.yaml</span><br><span class="line">replicaCount: 1</span><br><span class="line">strategyType: Recreate</span><br><span class="line">image:</span><br><span class="line">  repository: registry.cn-hangzhou.aliyuncs.com/weiyigeek/nfs-subdir-external-provisioner</span><br><span class="line">  tag: v4.0.2</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">imagePullSecrets: []</span><br><span class="line">nfs:</span><br><span class="line">  server: 10.20.176.102</span><br><span class="line">  path: /app/storage/nfs</span><br><span class="line">  mountOptions:</span><br><span class="line">  volumeName: nfs-subdir-external-provisioner-root</span><br><span class="line">  reclaimPolicy: Retain</span><br><span class="line">storageClass:</span><br><span class="line">  create: <span class="literal">true</span></span><br><span class="line">  provisionerName: cluster.local/nfs-storage-subdir-provisioner</span><br><span class="line">  defaultClass: <span class="literal">false</span></span><br><span class="line">  name: nfs-storage</span><br><span class="line">  allowVolumeExpansion: <span class="literal">true</span></span><br><span class="line">  reclaimPolicy: Delete</span><br><span class="line">  archiveOnDelete: <span class="literal">true</span></span><br><span class="line">  onDelete:</span><br><span class="line">  pathPattern:</span><br><span class="line">  accessModes: ReadWriteOnce</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">leaderElection:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">rbac:</span><br><span class="line">  create: <span class="literal">true</span></span><br><span class="line">podSecurityPolicy:</span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line">podAnnotations: &#123;&#125;</span><br><span class="line">podSecurityContext: &#123;&#125;</span><br><span class="line">securityContext: &#123;&#125;</span><br><span class="line">serviceAccount:</span><br><span class="line">  create: <span class="literal">true</span></span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  name:</span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line">tolerations: []</span><br><span class="line">affinity: &#123;&#125;</span><br><span class="line">labels: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šä¸‹è½½è§£å‹ç›®å½•è¿›è¡Œchatå›¾è¡¨å®‰è£…</span></span><br><span class="line">$ helm3 install nfs-storage nfs-subdir-external-provisioner/</span><br><span class="line">  NAME: nfs-storage</span><br><span class="line">  LAST DEPLOYED: Mon Jun 20 15:41:50 2022</span><br><span class="line">  NAMESPACE: default</span><br><span class="line">  STATUS: deployed</span><br><span class="line">  REVISION: 1</span><br><span class="line">  TEST SUITE: None</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ–¹å¼2.helm3æŒ‡å®šä»“åº“</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br><span class="line">$ helm nfs-storage nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \</span><br><span class="line">  --<span class="built_in">set</span> nfs.server=10.20.176.102 \</span><br><span class="line">  --<span class="built_in">set</span> nfs.path=/app/storage/nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°</span></span><br><span class="line">$ helm3 upgrade nfs-storage nfs-subdir-external-provisioner/</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ¸©é¦¨æç¤º: ç”±äºnfs-subdir-external-provisioneré•œåƒæ˜¯k8s.gcr.ioåŸŸåä¸‹å›½å†…å¯èƒ½æ— æ³•æ‹‰å–ï¼Œæ­¤å¤„æˆ‘å·²ç»æ‹‰å–åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“ä¸­<code>registry.cn-hangzhou.aliyuncs.com/weiyigeek/nfs-subdir-external-provisioner:v4.0.2</code>ï¼Œå¦‚æœä½ éœ€è¦è‡ªè¡Œæ‹‰å–è¯·å‚è€ƒæ­¤ç¯‡<a href="https://blog.weiyigeek.top/2022/6-1-663.html">ä½¿ç”¨Aliyunå®¹å™¨é•œåƒæœåŠ¡å¯¹æµ·å¤–é•œåƒä»“åº“ä¸­é•œåƒè¿›è¡Œæ‹‰å–æ„å»º</a> ()</p>
<p><br></p>
<p>æ­¥éª¤ 05.æŸ¥çœ‹éƒ¨ç½²çš„nfs-storageåŠ¨æ€æŒä¹…å·ä»¥åŠå…¶podçŠ¶æ€<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ helm3 list</span><br><span class="line">  NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                    APP VERSION</span><br><span class="line">  nfs-storage     default         1               2022-06-20 15:41:50.960642233 +0800 CST deployed        nfs-subdir-external-provisioner-4.0.16   4.0.2</span><br><span class="line"></span><br><span class="line">$ kubectl get storageclasses.storage.k8s.io</span><br><span class="line">  NAME          PROVISIONER                                    RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">  nfs-storage   cluster.local/nfs-storage-subdir-provisioner   Delete          Immediate           <span class="literal">true</span>                   17s</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">  NAME                                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">  nfs-storage-nfs-subdir-external-provisioner-77f4d85f74-kljck   1/1     Running   0          33s</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 06.å¦‚æƒ³å¸è½½helm3å®‰è£…çš„nfs-storageåŠ¨æ€å·æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm3 uninstall nfs-storage</span><br><span class="line">release <span class="string">"nfs-storage"</span> uninstalled</span><br></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼ŒåŸºäºNFSçš„provisioner åŠ¨æ€æŒä¹…å·çš„å®‰è£…éƒ¨ç½²åˆ°æ­¤ç»“æŸã€‚</p>
<p>æ¸©é¦¨æç¤º: å¦‚æœéœ€è¦éƒ¨ç½²å¤šä¸ªnfsæŒä¹…å·, åˆ™æˆ‘ä»¬éœ€è¦æ›´æ”¹values.yamlä¸­å¦‚ä¸‹å­—æ®µï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„åç§°ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values.yaml</span></span><br><span class="line">nfs:</span><br><span class="line">  server: 10.20.176.102</span><br><span class="line">  path: /app/storage/nfs/pvc/<span class="built_in">local</span></span><br><span class="line">  volumeName: nfs-subdir-external-provisioner-local</span><br><span class="line">  ....</span><br><span class="line">storageClass:</span><br><span class="line">  ....</span><br><span class="line">  provisionerName: cluster.local/nfs-local-subdir-provision  <span class="comment"># å…³é”®ç‚¹(æä¾›è€…ä¸èƒ½ä¸€æ ·)</span></span><br><span class="line">  name: nfs-local</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚,æ­¤å¤„åˆ›å»ºä¸¤ä¸ªnfsåŠ¨æ€å·å³nfs-localä¸nfs-devã€‚</span></span><br><span class="line">helm3 install nfs-local nfs-subdir-external-provisioner/</span><br><span class="line">helm3 install nfs-dev nfs-subdir-external-provisioner-dev/</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm éƒ¨ç½²ç»“æœæŸ¥çœ‹</span></span><br><span class="line">helm3 list</span><br><span class="line">  <span class="comment"># NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION</span></span><br><span class="line">  <span class="comment"># nfs-dev         default         1               2022-07-14 11:27:33.997601363 +0800 CST deployed        nfs-subdir-external-provisioner-4.0.16  4.0.2</span></span><br><span class="line">  <span class="comment"># nfs-local       default         1               2022-07-14 11:28:02.49579496 +0800 CST  deployed        nfs-subdir-external-provisioner-4.0.16  4.0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># storageclasses æŸ¥çœ‹</span></span><br><span class="line">kubectl get storageclasses.storage.k8s.io</span><br><span class="line">  <span class="comment"># NAME                PROVISIONER                                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span></span><br><span class="line">  <span class="comment"># nfs-dev (default)   cluster.local/nfs-dev-subdir-provisioner     Delete          Immediate           true                   4m36s</span></span><br><span class="line">  <span class="comment"># nfs-local           cluster.local/nfs-local-subdir-provisioner   Delete          Immediate           true                   4m8s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nfs-subdir-external-provisioner pod æŸ¥çœ‹</span></span><br><span class="line">kubectl get pod</span><br><span class="line">  <span class="comment"># NAME                                                         READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h      1/1     Running   0          5m4s</span></span><br><span class="line">  <span class="comment"># nfs-local-nfs-subdir-external-provisioner-6f97d44bb8-424tk   1/1     Running   0          4m36s</span></span><br></pre></td></tr></table></figure></p>
<p>æ­£å¸¸æƒ…å†µä¸‹æ˜¾ç¤ºå‡ºçš„æ—¥å¿—ä¿¡æ¯:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h</span><br><span class="line">  <span class="comment"># I0714 03:27:35.390909       1 leaderelection.go:242] attempting to acquire leader lease  default/cluster.local-nfs-dev-subdir-provisioner...</span></span><br><span class="line">  <span class="comment"># I0714 03:27:35.400777       1 leaderelection.go:252] successfully acquired lease default/cluster.local-nfs-dev-subdir-provisioner</span></span><br><span class="line">  <span class="comment"># I0714 03:27:35.400856       1 event.go:278] Event(v1.ObjectReference&#123;Kind:"Endpoints", Namespace:"default", Name:"cluster.local-nfs-dev-subdir-provisioner", UID:"34019115-d09e-433d-85d6-c254c5492ce5", APIVersion:"v1", ResourceVersion:"5510886", FieldPath:""&#125;): type: 'Normal' reason: 'LeaderElection' nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h_b0aaa93a-f7fc-4931-b0cf-e04f42cefd9a became leader</span></span><br><span class="line">  <span class="comment"># I0714 03:27:35.400943       1 controller.go:820] Starting provisioner controller cluster.local/nfs-dev-subdir-provisioner_nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h_b0aaa93a-f7fc-4931-b0cf-e04f42cefd9a!</span></span><br><span class="line">  <span class="comment"># I0714 03:27:35.501130       1 controller.go:869] Started provisioner controller cluster.local/nfs-dev-subdir-provisioner_nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h_b0aaa93a-f7fc-4931-b0cf-e04f42cefd9a!</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="2-é›†ç¾¤ä¸­å®‰è£…metrics-serverè·å–å®¢æˆ·ç«¯èµ„æºç›‘æ§æŒ‡æ ‡"><a href="#2-é›†ç¾¤ä¸­å®‰è£…metrics-serverè·å–å®¢æˆ·ç«¯èµ„æºç›‘æ§æŒ‡æ ‡" class="headerlink" title="2.é›†ç¾¤ä¸­å®‰è£…metrics-serverè·å–å®¢æˆ·ç«¯èµ„æºç›‘æ§æŒ‡æ ‡"></a>2.é›†ç¾¤ä¸­å®‰è£…metrics-serverè·å–å®¢æˆ·ç«¯èµ„æºç›‘æ§æŒ‡æ ‡</h3><p>æè¿°: é€šå¸¸åœ¨é›†ç¾¤å®‰è£…å®Œæˆå,æˆ‘ä»¬éœ€è¦å¯¹å…¶è®¾ç½®ç½‘ç»œã€æŒä¹…å·å­˜å‚¨ç­‰æ’ä»¶, é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€å®‰è£…metrics-serverä»¥ä¾¿äºè·å–Nodeä¸Podç›¸å…³èµ„æºæ¶ˆè€—ç­‰ä¿¡æ¯ï¼Œå¦åˆ™ä½ åœ¨æ‰§è¡Œ<code>kubectl top</code>å‘½ä»¤æ—¶ä¼šæç¤º<code>error: Metrics API not available</code>, æ‰€ä»¥æœ¬å°èŠ‚å°†é’ˆå¯¹Metrics-serverçš„å®‰è£…è¿›è¡Œè®²è§£ã€‚</p>
<p>é¡¹ç›®åœ°å€: <a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/metrics-server</a></p>
<p><strong>Q: ä»€ä¹ˆæ˜¯metrics-server?</strong></p>
<blockquote>
<p>Metrics Server æ˜¯ Kubernetes å†…ç½®è‡ªåŠ¨ç¼©æ”¾ç®¡é“çš„å¯æ‰©å±•ã€é«˜æ•ˆçš„å®¹å™¨èµ„æºæŒ‡æ ‡æ¥æºã€‚<br>Metrics Server ä» Kubelets æ”¶é›†èµ„æºæŒ‡æ ‡ï¼Œå¹¶é€šè¿‡ Metrics API åœ¨ Kubernetes apiserver ä¸­å…¬å¼€å®ƒä»¬ï¼Œä¾› Horizontal Pod Autoscaler å’Œ Vertical Pod Autoscaler ä½¿ç”¨ã€‚  </p>
</blockquote>
<blockquote>
<p>ç®€å•çš„è¯´: Metrics Server æ˜¯é›†ç¾¤è§£æç›‘æ§æ•°æ®çš„èšåˆå™¨,å®‰è£…åç”¨æˆ·å¯ä»¥é€šè¿‡æ ‡å‡†çš„APIï¼ˆ/apis/metrics.k8s.ioï¼‰æ¥è®¿é—®ç›‘æ§æ•°æ®ï¼Œæ­¤å¤„å€¼å¾—æ³¨æ„çš„æ˜¯Metrics-Serverå¹¶ékube-apiserverçš„ä¸€éƒ¨åˆ†,è€Œæ˜¯é€šè¿‡Aggregatorè¿™ç§æ’ä»¶æœºåˆ¶,åœ¨ç‹¬ç«‹éƒ¨ç½²çš„æƒ…å†µä¸‹åŒkube-apiserverä¸€èµ·ç»Ÿä¸€å¯¹å¤–æœåŠ¡çš„ï¼Œå½“è¿›è¡Œapiè¯·æ±‚æ—¶kube-aggregatorç»Ÿä¸€æ¥å£ä¼šåˆ†æè®¿é—®apiå…·ä½“çš„ç±»å‹ï¼Œå¸®æˆ‘ä»¬è´Ÿè½½åˆ°å…·ä½“çš„apiä¸Šã€‚</p>
</blockquote>
<p>æ¸©é¦¨æç¤º: æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>kubectl top</code> å‘½ä»¤æ¥è®¿é—® Metrics API è·å–èµ„æºç›‘æ§ç›¸å…³æ•°æ®ã€‚</p>
<p>æ¸©é¦¨æç¤º: æ³¨æ„ Metrics API åªå¯ä»¥æŸ¥è¯¢å½“å‰åº¦é‡æ•°æ®,å¹¶ä¸ä¿å­˜å†å²æ•°æ®ã€‚</p>
<p><br/></p>
<p><strong>å®‰è£…ä½¿ç”¨</strong></p>
<p>æ­¥éª¤ 01.Metrics Server å¯ä»¥ç›´æ¥ä» YAML æ¸…å•å®‰è£…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®˜æ–¹ Helm å›¾è¡¨å®‰è£…ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) ä¸‹è½½ YAML æ¸…å•</span></span><br><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml</span><br><span class="line">root@devtest-master-212:/opt/init/k8s<span class="comment"># ls</span></span><br><span class="line">  calico.yaml   kubeadm-init-cluster.yaml  kubeadm-init.log  metrics-server.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) æå‰ä¸‹è½½ç›¸åº”çš„é•œåƒåŠ å¿«éƒ¨ç½²</span></span><br><span class="line">grep <span class="string">"image:"</span> metrics-server.yaml</span><br><span class="line">  <span class="comment"># image: k8s.gcr.io/metrics-server/metrics-server:v0.6.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) ç”±äºå…¶é•œåƒå›½å†…æ— æ³•è®¿é—®æ­¤å¤„æˆ‘ä»¬é‡‡ç”¨é˜¿é‡Œäº‘k8s.gcr.ioé•œåƒæº</span></span><br><span class="line">sed -i <span class="string">'s#k8s.gcr.io/metrics-server#registry.cn-hangzhou.aliyuncs.com/google_containers#g'</span> metrics-server.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) éƒ¨ç½²èµ„æºæ¸…å•</span></span><br><span class="line">kubectl apply -f metrics-server.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/metrics-server created</span></span><br><span class="line">  ......</span><br><span class="line">  <span class="comment"># apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 02.ä¸è®ºæ˜¯åœ¨äºŒè¿›åˆ¶æ–¹å¼æˆ–kubeadmæ–¹å¼å®‰è£…k8sé›†ç¾¤, éƒ½åœ¨éƒ¨ç½² metrics-server èµ„æºæ¸…å•å Pod çŠ¶æ€ä¸º 0/1 å¹¶æŠ¥å‡º<code>annot validate certificate for 10.10.107.223 because it doesn&#39;t contain any IP SANs</code>é”™è¯¯é—®é¢˜è§£å†³ã€‚</p>
<ul>
<li>é”™è¯¯ä¿¡æ¯:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod -n kube-system metrics-server-6ffc8966f5-cf2qh</span><br><span class="line"><span class="comment"># Warning  Unhealthy  8s (x17 over 2m27s)  kubelet  Readiness probe failed: HTTP probe failed with statuscode: 500</span></span><br><span class="line"></span><br><span class="line">$ kubectl logs -f --tail 50 -n kube-system metrics-server-6ffc8966f5-cf2qh</span><br><span class="line"><span class="comment"># E0520 11:13:17.379944       1 scraper.go:140] "Failed to scrape node" err="Get \"https://10.10.107.226:10250/metrics/resource\": x509: cannot validate certificate for 10.10.107.226 because it doesn't contain any IP SANs" node="node-1"</span></span><br><span class="line"><span class="comment"># E0520 11:13:17.382948       1 scraper.go:140] "Failed to scrape node" err="Get \"https://10.10.107.223:10250/metrics/resource\": x509: cannot validate certificate for 10.10.107.223 because it doesn't contain any IP SANs" node="master-223"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>é—®é¢˜åŸå› : ç”±äº metrics-server æœªè·å¾—TLS Bootstrap ç­¾å‘è¯ä¹¦çš„å¯¼è‡´è®¿é—®å„èŠ‚ç‚¹èµ„æºæ—¶æŠ¥é”™ã€‚</p>
</li>
<li><p>è§£å†³åŠæ³•: å¯ç”¨ TLS BootStrap è¯ä¹¦ç­¾å‘</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ†åˆ«åœ¨ Master ä¸ Node èŠ‚ç‚¹ä¸­å¯ç”¨TLS BootStrap è¯ä¹¦ç­¾å‘ï¼Œåœ¨ kubelet çš„ yaml é…ç½®ä¸­è¿½åŠ å…¥å¦‚ä¸‹K/V.</span></span><br><span class="line"><span class="comment"># æ–¹å¼1.Kubeadm æ­å»ºçš„é›†ç¾¤</span></span><br><span class="line">$ vim /var/lib/kubelet/config.yaml</span><br><span class="line">...</span><br><span class="line">serverTLSBootstrap: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2.äºŒè¿›åˆ¶æ­å»ºçš„é›†ç¾¤(æ³¨æ„æ­¤è·¯å¾„æ ¹æ®ä½ çš„kubelet.serviceè¿›è¡Œé…ç½®), æ­¤å¤„æˆ‘ä»¬å®šä¹‰çš„è·¯å¾„ä¸º /etc/kubernetes/cfg/kubelet-config.yaml </span></span><br><span class="line"><span class="comment"># /var/lib/kubelet/config.yaml</span></span><br><span class="line">$ tee -a /etc/kubernetes/cfg/kubelet-config.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">serverTLSBootstrap: <span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeadm å®‰è£…æ–¹å¼å¯ä»¥ä½¿ç”¨å¦‚ä¸‹</span></span><br><span class="line">tee -a /var/lib/kubelet/config.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">serverTLSBootstrap: <span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æœ€ååˆ†åˆ«é‡å¯å„ä¸ªèŠ‚ç‚¹kubeletæœåŠ¡å³å¯</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart kubelet.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æŸ¥çœ‹èŠ‚ç‚¹çš„è¯ä¹¦ç­¾å‘è¯·æ±‚</span></span><br><span class="line">kubectl get csr</span><br><span class="line">  <span class="comment"># NAME        AGE   SIGNERNAME                      REQUESTOR                        REQUESTEDDURATION   CONDITION</span></span><br><span class="line">  <span class="comment"># csr-6w6xp   7s    kubernetes.io/kubelet-serving   system:node:devtest-master-212   &lt;none&gt;              Pending</span></span><br><span class="line">  <span class="comment"># csr-bpqzl   5s    kubernetes.io/kubelet-serving   system:node:devtest-master-213   &lt;none&gt;              Pending</span></span><br><span class="line">  <span class="comment"># csr-gtksm   3s    kubernetes.io/kubelet-serving   system:node:devtest-work-215     &lt;none&gt;              Pending</span></span><br><span class="line">  <span class="comment"># csr-vzfs7   4s    kubernetes.io/kubelet-serving   system:node:devtest-master-214   &lt;none&gt;              Pending</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.åŒæ„ç­¾å‘æ‰€æœ‰èŠ‚ç‚¹çš„CSRè¯·æ±‚ </span></span><br><span class="line">kubectl certificate approve $(kubectl get csr | grep -v NAME | grep <span class="string">"Pending"</span>  | cut -d <span class="string">" "</span> -f 1)</span><br><span class="line">  <span class="comment"># certificatesigningrequest.certificates.k8s.io/csr-6w6xp approved</span></span><br><span class="line">  <span class="comment"># certificatesigningrequest.certificates.k8s.io/csr-bpqzl approved</span></span><br><span class="line">  <span class="comment"># certificatesigningrequest.certificates.k8s.io/csr-gtksm approved</span></span><br><span class="line">  <span class="comment"># certificatesigningrequest.certificates.k8s.io/csr-vzfs7 approved</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220622144018.png" target="_blank" title="WeiyiGeek.è¯ä¹¦ç­¾å‘è¯·æ±‚" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220622144018.png" alt="WeiyiGeek.è¯ä¹¦ç­¾å‘è¯·æ±‚" title="" class=""></a>
                <p>WeiyiGeek.è¯ä¹¦ç­¾å‘è¯·æ±‚</p>
            </figure>
<p><br/></p>
<p>æ­¥éª¤ 03.Metrics Server é»˜è®¤æ˜¯å®‰è£…åœ¨kube-systemåç§°ç©ºé—´ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å…¶deploymentã€Podè¿è¡Œä»¥åŠSVCæƒ…å†µã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.éƒ¨ç½²æ¸…å•çŠ¶æ€æŸ¥çœ‹</span></span><br><span class="line">kubectl get deploy,pod,svc -n kube-system -l k8s-app=metrics-server</span><br><span class="line">  <span class="comment"># NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line">  <span class="comment"># deployment.apps/metrics-server   1/1     1            1           5h37m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                                  READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># pod/metrics-server-6ffc8966f5-c4jvn   1/1     Running   0          14m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span></span><br><span class="line">  <span class="comment"># service/metrics-server   ClusterIP   10.111.197.94   &lt;none&gt;        443/TCP   5h37m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æ³¨å†Œåˆ°K8Sé›†ç¾¤ä¸­çš„ metrics.k8s.io API æŸ¥çœ‹</span></span><br><span class="line">kubectl get apiservices.apiregistration.k8s.io  | grep <span class="string">"metrics"</span></span><br><span class="line">  <span class="comment"># v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        14h</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 04.æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä»¥åŠPodçš„èµ„æºæŒ‡æ ‡ï¼ˆCPU/MEMï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top node</span><br><span class="line">  <span class="comment"># NAME                 CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span></span><br><span class="line">  <span class="comment"># devtest-master-212   219m         2%     2793Mi          17%</span></span><br><span class="line">  <span class="comment"># devtest-master-213   211m         2%     2417Mi          15%</span></span><br><span class="line">  <span class="comment"># devtest-master-214   203m         1%     2467Mi          7%</span></span><br><span class="line">  <span class="comment"># devtest-work-215     90m          1%     1601Mi          10%</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤åç§°ç©ºé—´ä¸­Podçš„èµ„æºä¿¡æ¯</span></span><br><span class="line">$ kubectl top pod</span><br><span class="line">  <span class="comment"># NAME    CPU(cores)   MEMORY(bytes)</span></span><br><span class="line">  <span class="comment"># nginx   0m           10Mi</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="3-é›†ç¾¤ç®¡ç†åŸç”ŸUIå·¥å…·kubernetes-dashboardå®‰è£…éƒ¨ç½²"><a href="#3-é›†ç¾¤ç®¡ç†åŸç”ŸUIå·¥å…·kubernetes-dashboardå®‰è£…éƒ¨ç½²" class="headerlink" title="3.é›†ç¾¤ç®¡ç†åŸç”ŸUIå·¥å…·kubernetes-dashboardå®‰è£…éƒ¨ç½²"></a>3.é›†ç¾¤ç®¡ç†åŸç”ŸUIå·¥å…·kubernetes-dashboardå®‰è£…éƒ¨ç½²</h3><p>æè¿°:Kubernetes Dashboardæ˜¯Kubernetesé›†ç¾¤çš„é€šç”¨ã€åŸºäºwebçš„UIã€‚å®ƒå…è®¸ç”¨æˆ·ç®¡ç†é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå¹¶å¯¹å…¶è¿›è¡Œæ•…éšœæ’é™¤ï¼Œä»¥åŠç®¡ç†é›†ç¾¤æœ¬èº«ã€‚</p>
<p>é¡¹ç›®åœ°å€: <a href="https://github.com/kubernetes/dashboard/" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/</a></p>
<p>æ­¥éª¤ 01.ä»Githubä¸­æ‹‰å–dashboardéƒ¨ç½²èµ„æºæ¸…å•ï¼Œå½“å‰æœ€æ–°ç‰ˆæœ¬v2.6.0 ã€2022å¹´6æœˆ22æ—¥ 16:46:37ã€‘<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½èµ„æºæ¸…å•å¹¶éƒ¨ç½² dashboard </span></span><br><span class="line">$ wget -L https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml -O dashboard.yaml</span><br><span class="line">$ kubectl apply -f dashboard.yaml</span><br><span class="line">$ grep <span class="string">"image:"</span> dashboard.yaml</span><br><span class="line">  <span class="comment"># image: kubernetesui/dashboard:v2.6.0</span></span><br><span class="line">  <span class="comment"># image: kubernetesui/metrics-scraper:v1.0.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä¸€æ¡å‘½ä»¤æå®šéƒ¨ç½²</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/kubernetes-dashboard created</span></span><br><span class="line">  ......</span><br><span class="line">  <span class="comment"># deployment.apps/dashboard-metrics-scraper created</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.ä½¿ç”¨kubectl getå‘½ä»¤æŸ¥çœ‹éƒ¨ç½²çš„dashboardç›¸å…³èµ„æºæ˜¯å¦æ­£å¸¸ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod,svc -n kubernetes-dashboard</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-6f669b9c9b-vfmzp   1/1     Running   0          73m</span><br><span class="line">kubernetes-dashboard-67b9478795-2gwmm        1/1     Running   0          73m</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.106.168.38    &lt;none&gt;        8000/TCP   73m</span><br><span class="line">service/kubernetes-dashboard        ClusterIP   10.106.191.197   &lt;none&gt;        443/TCP    73m</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘ service/kubernetes-dashboard æœåŠ¡å°†ç«¯å£é€šè¿‡nodePortæ–¹å¼è¿›è¡Œæš´éœ²ä¸º30443ã€‚</span></span><br><span class="line">$ kubectl edit svc -n kubernetes-dashboard kubernetes-dashboard</span><br><span class="line"><span class="comment"># service/kubernetes-dashboard edited</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">.....</span><br><span class="line">spec:</span><br><span class="line">.....</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8443</span><br><span class="line">    nodePort: 31443  <span class="comment"># æ–°å¢</span></span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort     <span class="comment"># ä¿®æ”¹</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 03.é»˜è®¤ä»ªè¡¨æ¿éƒ¨ç½²åŒ…å«è¿è¡Œæ‰€éœ€çš„æœ€å°RBACæƒé™é›†ï¼Œè€Œè¦æƒ³ä½¿ç”¨dashboardæ“ä½œé›†ç¾¤ä¸­çš„èµ„æºï¼Œé€šå¸¸æˆ‘ä»¬è¿˜éœ€è¦è‡ªå®šä¹‰åˆ›å»ºkubernetes-dashboardç®¡ç†å‘˜è§’è‰²ã€‚<br>æƒé™æ§åˆ¶å‚è€ƒåœ°å€: <a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåæœ€å°æƒé™çš„Token(åªèƒ½æ“ä½œkubernetes-dashboardåç§°ç©ºé—´ä¸‹çš„èµ„æº)</span></span><br><span class="line">kubectl get sa -n kubernetes-dashboard kubernetes-dashboard</span><br><span class="line">kubectl describe secrets -n kubernetes-dashboard kubernetes-dashboard-token-jhdpb | grep <span class="string">'^token:'</span>|awk <span class="string">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure>
<p>Kubernetes Dashboard æ”¯æŒå‡ ç§ä¸åŒçš„ç”¨æˆ·èº«ä»½éªŒè¯æ–¹å¼ï¼š</p>
<ul>
<li>Authorization header</li>
<li>Bearer Token (é»˜è®¤)</li>
<li>Username/password</li>
<li>Kubeconfig file  (é»˜è®¤)</li>
</ul>
<p>æ¸©é¦¨æç¤º: æ­¤å¤„ä½¿ç”¨Bearer Tokenæ–¹å¼, ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºæˆ‘ä»¬å‘ Dashboard çš„æœåŠ¡å¸æˆ·æˆäºˆç®¡ç†å‘˜æƒé™ (Admin privileges), è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ä¸å»ºè®®å¦‚æ­¤æ“ä½œ, è€Œæ˜¯æŒ‡å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªåç§°ç©ºé—´ä¸‹çš„èµ„æºè¿›è¡Œæ“ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tee rbac-dashboard-admin.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-admin</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-admin</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: dashboard-admin</span><br><span class="line">    namespace: kubernetes-dashboard</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f rbac-dashboard-admin.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/dashboard-admin created</span></span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€… ä¸¤æ¡å‘½ä»¤æå®š</span></span><br><span class="line"><span class="comment"># kubectl create serviceaccount -n devtest devtest-ns-admin</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding devtest-ns-admin --clusterrole=admin --serviceaccount=devtest:devtest-ns-admin</span></span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ 04.è·å– sa åˆ›å»ºçš„ dashboard-admin ç”¨æˆ·çš„ secrets åç§°å¹¶è·å–è®¤è¯ token ï¼Œç”¨äºä¸Šè¿°æ­å»ºçš„dashboard è®¤è¯ä½¿ç”¨ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sa -n kubernetes-dashboard dashboard-admin -o yaml | grep <span class="string">"\- name"</span> | awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line">  <span class="comment"># dashboard-admin-token-crh7v</span></span><br><span class="line">kubectl describe secrets -n kubernetes-dashboard dashboard-admin-token-crh7v | grep <span class="string">"^token:"</span> | awk <span class="string">'&#123;print $2&#125;'</span></span><br><span class="line">  <span class="comment">#  è·å–åˆ°è®¤è¯Token</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 05.åˆ©ç”¨ä¸Šè¿° Token è¿›è¡Œç™»é™†Kubernetes-dashboardçš„UI,å…¶åœ°å€ä¸ºnodeèŠ‚ç‚¹åŠ ä¸Š31443,ä¾‹å¦‚æ­¤å¤„<code>https://10.20.176.212:31443/#/workloads?namespace=default</code>ã€‚</p>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220622165638.png" target="_blank" title="WeiyiGeek.Kubernetes-dashboard" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220622165638.png" alt="WeiyiGeek.Kubernetes-dashboard" title="" class=""></a>
                <p>WeiyiGeek.Kubernetes-dashboard</p>
            </figure>
<hr>
<h3 id="4-é›†ç¾¤ç®¡ç†K9Så®¢æˆ·ç«¯å·¥å…·å®‰è£…ä½¿ç”¨"><a href="#4-é›†ç¾¤ç®¡ç†K9Så®¢æˆ·ç«¯å·¥å…·å®‰è£…ä½¿ç”¨" class="headerlink" title="4.é›†ç¾¤ç®¡ç†K9Så®¢æˆ·ç«¯å·¥å…·å®‰è£…ä½¿ç”¨"></a>4.é›†ç¾¤ç®¡ç†K9Så®¢æˆ·ç«¯å·¥å…·å®‰è£…ä½¿ç”¨</h3><p>æè¿°: k9s æ˜¯ç”¨äºç®¡ç† Kubernetes é›†ç¾¤çš„ CLI, K9s æä¾›äº†ä¸€ä¸ªç»ˆç«¯ UI æ¥ä¸æ‚¨çš„ Kubernetes é›†ç¾¤è¿›è¡Œäº¤äº’ã€‚é€šè¿‡å°è£… kubectl åŠŸèƒ½ k9s æŒç»­ç›‘è§† Kubernetes çš„å˜åŒ–å¹¶æä¾›åç»­å‘½ä»¤æ¥ä¸æ‚¨è§‚å¯Ÿåˆ°çš„èµ„æºè¿›è¡Œäº¤äº’ï¼Œç›´ç™½çš„è¯´å°±æ˜¯k9så¯ä»¥è®©å¼€å‘è€…å¿«é€ŸæŸ¥çœ‹å¹¶è§£å†³è¿è¡Œ Kubernetes æ—¶çš„æ—¥å¸¸é—®é¢˜ã€‚<br>å®˜ç½‘åœ°å€: <a href="https://k9scli.io/" target="_blank" rel="noopener">https://k9scli.io/</a><br>å‚è€ƒåœ°å€: <a href="https://github.com/derailed/k9s" target="_blank" rel="noopener">https://github.com/derailed/k9s</a></p>
<p>æ­¤å¤„,ä»¥å®‰è£…äºŒè¿›åˆ¶åŒ…ä¸ºä¾‹è¿›è¡Œå®è·µã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åˆ©ç”¨ wget å‘½ä»¤ -c çŸ­ç‚¹ç»­ä¼ å’Œ -b åå°ä¸‹è½½</span></span><br><span class="line">wget -b -c https://github.com/derailed/k9s/releases/download/v0.25.18/k9s_Linux_x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.è§£å‹å¹¶åˆ é™¤å¤šä½™æ–‡ä»¶</span></span><br><span class="line">tar -zxf k9s_linux_x86_64.tar.gz</span><br><span class="line">rm  k9s_linux_x86_64.tar.gz  LICENSE  README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æ‹·è´ kubernetes æ§åˆ¶é…ç½®æ–‡ä»¶åˆ°åŠ ç›®å½•ä¸­</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.ç›´æ¥è¿è¡Œå³å¯ï¼Œå¦‚æœä½ å¯¹vimæ“ä½œæ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆæ­å–œä½ äº†ä½ å¾ˆå¿«èƒ½ä¸Šæ‰‹k9s.</span></span><br><span class="line">/stroage/nfs<span class="comment"># ./k9s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.é€€å‡ºk9sæŒ‡ä»¤</span></span><br><span class="line">:quit</span><br></pre></td></tr></table></figure></p>
<p>æ›´å¤šä½¿ç”¨æŠ€å·§è¯·å‚è€ƒ: [K9sä¹‹K8sé›†ç¾¤ç®¡ç†å·¥å…·å®è·µå°è¯•] (<a href="https://blog.weiyigeek.top/2022/1-1-582.html">https://blog.weiyigeek.top/2022/1-1-582.html</a>)</p>
<hr>
<h3 id="5-é›†ç¾¤æœåŠ¡Serviceä¸ƒå±‚è´Ÿè½½å‡è¡¡ingressç¯å¢ƒæ­å»ºéƒ¨ç½²"><a href="#5-é›†ç¾¤æœåŠ¡Serviceä¸ƒå±‚è´Ÿè½½å‡è¡¡ingressç¯å¢ƒæ­å»ºéƒ¨ç½²" class="headerlink" title="5.é›†ç¾¤æœåŠ¡Serviceä¸ƒå±‚è´Ÿè½½å‡è¡¡ingressç¯å¢ƒæ­å»ºéƒ¨ç½²"></a>5.é›†ç¾¤æœåŠ¡Serviceä¸ƒå±‚è´Ÿè½½å‡è¡¡ingressç¯å¢ƒæ­å»ºéƒ¨ç½²</h3><p><strong>Q: ä»€ä¹ˆæ˜¯Ingress?</strong><br>A: Ingress æ˜¯ç®¡ç†å¯¹é›†ç¾¤ä¸­æœåŠ¡çš„æä¾›å¤–éƒ¨è®¿é—®çš„ API å¯¹è±¡,Ingress æ§åˆ¶å™¨è´Ÿè´£å®ç° Ingressï¼Œé€šå¸¸ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼Œä½†å®ƒä¹Ÿå¯ä»¥é…ç½®è¾¹ç¼˜è·¯ç”±å™¨æˆ–å…¶ä»–å‰ç«¯æ¥å¸®åŠ©å¤„ç†æµé‡ï¼Œå®ƒå¯ä»¥å°†æ¥è‡ªé›†ç¾¤å¤–éƒ¨çš„ HTTP å’Œ HTTPS è·¯ç”±è½¬å‘åˆ°é›†ç¾¤å†…éƒ¨çš„ Service ä¸­ã€‚</p>
<p>Ingress åªæ˜¯ä¸€ä¸ªç»Ÿç§°ï¼Œå…¶ç”± Ingress å’Œ Ingress Controller ä¸¤éƒ¨åˆ†ç»„æˆã€‚</p>
<ul>
<li>Ingress ç”¨ä½œå°†åŸæ¥éœ€è¦æ‰‹åŠ¨é…ç½®çš„è§„åˆ™æŠ½è±¡æˆä¸€ä¸ª Ingress å¯¹è±¡ï¼Œä½¿ç”¨ YAML æ ¼å¼çš„æ–‡ä»¶æ¥åˆ›å»ºå’Œç®¡ç†ã€‚</li>
<li>Ingress Controller ç”¨ä½œé€šè¿‡ä¸ Kubernetes API äº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ Ingress è§„åˆ™å˜åŒ–ã€‚</li>
</ul>
<p>ä½¿ç”¨ Ingress æ§åˆ¶å™¨å¯ä»¥è½»æ¾å®ç°å¤–éƒ¨URLè®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡ã€è´Ÿè½½å‡è¡¡ã€ä»£ç†è½¬å‘ã€æ”¯æŒé…ç½®SSL/TLSå¹¶æä¾›åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ Ingress ä¸ä¼šæš´éœ²ä»»æ„ç«¯å£æˆ–åè®®ï¼Œé€šè¿‡ä½¿ç”¨ <code>Service.Type=NodePort</code> æˆ– <code>Service.Type=LoadBalancer</code>ç±»å‹çš„æœåŠ¡å‘å‘ Internet å…¬å¼€ HTTP å’Œ HTTPS çš„è®¿é—®æœåŠ¡</p>
<p><strong>Q: å¸¸ç”¨ Ingress æ§åˆ¶å™¨æœ‰é‚£äº›?</strong><br>å…¶ä¸­ingress controllerç›®å‰ä¸»è¦æœ‰ä¸¤ç§åŸºäºnginxæœåŠ¡çš„ingress controller (å››å±‚æˆ–è€…ä¸ƒå±‚)å’ŒåŸºäºtraefikçš„ingress controller(ç›®å‰æ”¯æŒhttpå’Œhttpsåè®®)ï¼Œå…¶å®ƒæ›´å¤šé€‚ç”¨äºKubernetesçš„ingressæ§åˆ¶å™¨å¯ä»¥å‚è€ƒåœ°å€[<a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/#%E5%85%B6%E4%BB%96%E6%8E%A7%E5%88%B6%E5%99%A8]" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/#%E5%85%B6%E4%BB%96%E6%8E%A7%E5%88%B6%E5%99%A8]</a></p>
<ul>
<li>ingress-Nginx : ç”¨äº <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Nginx Kubernetes Ingress</a> æ§åˆ¶å™¨èƒ½å¤Ÿä¸ NGINX Web æœåŠ¡å™¨ï¼ˆä½œä¸ºä»£ç†ï¼‰ä¸€èµ·ä½¿ç”¨ (æ¨è)</li>
<li>ingress-Traefik ï¼šç”± <a href="https://doc.traefik.io/traefik/providers/kubernetes-ingress/" target="_blank" rel="noopener">Traefik Kubernetes Ingress</a> æä¾›ç¨‹åºæ˜¯ä¸€ä¸ªç”¨äº Traefik ä»£ç†çš„Ingressæ§åˆ¶å™¨ã€‚</li>
<li>ingress-istio : <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/" target="_blank" rel="noopener">Istio Ingress</a> æ˜¯ä¸€ä¸ªåŸºäºIstioçš„Ingressæ§åˆ¶å™¨ã€‚</li>
</ul>
<p>æ¸©é¦¨æç¤º: ç†æƒ³æƒ…å†µä¸‹æ‰€æœ‰ Ingress æ§åˆ¶å™¨éƒ½åº”ç¬¦åˆå‚è€ƒè§„èŒƒã€‚å®é™…ä¸Šå„ç§ Ingress æ§åˆ¶å™¨çš„æ“ä½œç•¥æœ‰ä¸åŒ,è¯·å‚è€ƒç›¸åº”Ingressçš„æ§åˆ¶å™¨å®˜æ–¹æ–‡æ¡£ã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå®¢æˆ·ç«¯è¯·æ±‚è®¿é—®å¤–éƒ¨URLåœ°å€, Ingress å°†å…¶æ‰€æœ‰æµé‡å‘é€åˆ°ä¸€ä¸ªServiceä¸­, åç«¯ Pod æä¾›æœåŠ¡ç«¯å“åº”é€šè¿‡è·¯ç”±è¿›è¡Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/1/20220309090428.png" target="_blank" title="WeiyiGeek.Ingress" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/1/20220309090428.png" alt="WeiyiGeek.Ingress" title="" class=""></a>
                <p>WeiyiGeek.Ingress</p>
            </figure>
<p>æ¸©é¦¨æç¤º: åŸºäºnginxæœåŠ¡çš„ingress controlleræ ¹æ®ä¸åŒçš„å¼€å‘å…¬å¸ï¼Œåˆåˆ†ä¸ºk8sç¤¾åŒºçš„ingres-nginxå’Œnginxå…¬å¸çš„nginx-ingressï¼Œåœ¨æ­¤æ ¹æ®githubä¸Šçš„æ´»è·ƒåº¦å’Œå…³æ³¨äººæ•°ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ˜¯k8sç¤¾åŒºçš„ingres-nginxã€‚</p>
<ul>
<li>k8sç¤¾åŒºæä¾›çš„ingressï¼Œgithubåœ°å€å¦‚ä¸‹ï¼š<a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx</a></li>
<li>nginxç¤¾åŒºæä¾›çš„ingressï¼Œgithubåœ°å€å¦‚ä¸‹ï¼š<a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">https://github.com/nginxinc/kubernetes-ingress</a></li>
</ul>
<p><br></p>
<p><strong>Q: K8Sç¤¾åŒºæä¾› Ingress è§„åˆ™æœ‰å“ªäº›?</strong></p>
<ul>
<li>host : è™šæ‹Ÿä¸»æœºåç§°, ä¸»æœºåé€šé…ç¬¦ä¸»æœºå¯ä»¥æ˜¯ç²¾ç¡®åŒ¹é…ï¼ˆä¾‹å¦‚â€foo.bar.comâ€ï¼‰æˆ–é€šé…ç¬¦ï¼ˆä¾‹å¦‚â€œ *.foo.comâ€ï¼‰</li>
<li>paths : URLè®¿é—®è·¯å¾„ã€‚</li>
<li>pathType : Ingress ä¸­çš„æ¯ä¸ªè·¯å¾„éƒ½éœ€è¦æœ‰å¯¹åº”çš„è·¯å¾„ç±»å‹ï¼ˆPath Typeï¼‰</li>
<li>backend : æ˜¯ Service æ–‡æ¡£ä¸­æ‰€è¿°çš„æœåŠ¡å’Œç«¯å£åç§°çš„ç»„åˆä¸è§„åˆ™çš„ host å’Œ path åŒ¹é…çš„å¯¹ Ingress çš„ HTTPï¼ˆå’Œ HTTPS ï¼‰è¯·æ±‚å°†å‘é€åˆ°åˆ—å‡ºçš„ backend, ä¸€èˆ¬æƒ…å†µå¯ä»¥å•ç‹¬ä¸ºè·¯å¾„è®¾ç½®Backendä»¥åŠæœªåŒ¹é…çš„urlé»˜è®¤è®¿é—®çš„åç«¯defaultBackendã€‚</li>
</ul>
<p>Ingress ä¸­çš„æ¯ä¸ªè·¯å¾„éƒ½éœ€è¦æœ‰å¯¹åº”çš„è·¯å¾„ç±»å‹ï¼ˆPath Typeï¼‰ï¼Œæœªæ˜ç¡®è®¾ç½® pathType çš„è·¯å¾„æ— æ³•é€šè¿‡åˆæ³•æ€§æ£€æŸ¥ï¼Œå½“å‰æ”¯æŒçš„è·¯å¾„ç±»å‹æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>Exactï¼šç²¾ç¡®åŒ¹é… URL è·¯å¾„ï¼Œä¸”åŒºåˆ†å¤§å°å†™ã€‚</li>
<li>Prefixï¼šåŸºäºä»¥<code>/</code>åˆ†éš”çš„URLè·¯å¾„å‰ç¼€åŒ¹é…, ä¸”åŒºåˆ†å¤§å°å†™ï¼Œå¹¶ä¸”å¯¹è·¯å¾„ä¸­çš„å…ƒç´ é€ä¸ªå®Œæˆã€‚</li>
<li>ImplementationSpecificï¼šæ­¤è·¯å¾„ç±»å‹åŒ¹é…æ–¹æ³•å–å†³äº IngressClass, å…·ä½“å®ç°å¯ä»¥å°†å…¶ä½œä¸ºå•ç‹¬çš„ pathType å¤„ç†æˆ–è€…ä¸ Prefix ã€ Exact ç±»å‹ä½œç›¸åŒå¤„ç†ã€‚</li>
</ul>
<p>è¯´æ˜ï¼š å¦‚æœè·¯å¾„çš„æœ€åä¸€ä¸ªå…ƒç´ æ˜¯è¯·æ±‚è·¯å¾„ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„å­å­—ç¬¦ä¸²ï¼Œåˆ™ä¸ä¼šåŒ¹é… ï¼ˆä¾‹å¦‚ï¼š/foo/bar åŒ¹é… /foo/bar/baz, ä½†ä¸åŒ¹é… /foo/barbazï¼‰ã€‚</p>
<p>æ¸©é¦¨æç¤º: defaultBackend é€šå¸¸åœ¨ Ingress æ§åˆ¶å™¨ä¸­é…ç½®ï¼Œä»¥æœåŠ¡ä¸è§„èŒƒä¸­çš„è·¯å¾„ä¸åŒ¹é…çš„ä»»ä½•è¯·æ±‚ã€‚<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">tee</span> <span class="string">&gt; test.yaml &lt;&lt; 'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  defaultBackend:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">      port:</span></span><br><span class="line"><span class="attr">        number:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span></span><br></pre></td></tr></table></figure><br>æ³¨æ„, å…¥å£æ§åˆ¶å™¨å’Œè´Ÿè½½å¹³è¡¡å™¨å¯èƒ½éœ€è¦ä¸€ä¸¤åˆ†é’Ÿæ‰èƒ½åˆ†é… IP åœ°å€ã€‚ åœ¨æ­¤ä¹‹å‰ï¼Œä½ é€šå¸¸ä¼šçœ‹åˆ°åœ°å€å­—æ®µçš„å€¼è¢«è®¾å®šä¸º<code>&lt;pending&gt;</code>ã€‚</p>
<p>æ¸©é¦¨æç¤º: ingressæ§åˆ¶å™¨èµ„æºæ¸…å•åœ¨v1.19ä»¥åŠä¹‹åç‰ˆæœ¬é›†ç¾¤ä¸­å†™æ³•å¦‚ä¸‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;-EOF | kubectl apply -f -</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: foo.bar.com</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    <span class="comment">#URLé‡å®šå‘ã€‚</span></span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /<span class="variable">$1</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: foo.bar.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">    <span class="comment"># åœ¨Ingress Controllerçš„ç‰ˆæœ¬â‰¥0.22.0ä¹‹åï¼Œpathä¸­éœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰è·¯å¾„ï¼Œå¹¶åœ¨rewrite-targetä¸­ç»“åˆæ•è·ç»„ä¸€èµ·ä½¿ç”¨ã€‚</span></span><br><span class="line">      - path: /svc(/|$)(.*)</span><br><span class="line">        backend:</span><br><span class="line">          service: </span><br><span class="line">            name: web1-service</span><br><span class="line">            port: </span><br><span class="line">              number: 80</span><br><span class="line">        pathType: ImplementationSpecific</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>Q: Nginx Ingress Controllerä¸K8Sé›†ç¾¤ç‰ˆæœ¬å¯¹åº”å…³ç³»</strong><br>å‚è€ƒåœ°å€: <a href="https://github.com/kubernetes/ingress-nginx#support-versions-table" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx#support-versions-table</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Support Versions table</span><br><span class="line">Ingress-NGINX version 	k8s supported version 	Alpine Version 	Nginx Version</span><br><span class="line">v1.2.1 	1.23, 1.22, 1.21, 1.20, 1.19 	3.14.6 	1.19.10â€ </span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>å¿«é€Ÿå®‰è£…é…ç½®</strong><br>ç¯å¢ƒä¾èµ–è¯´æ˜: <code>Chart version 4.x.x and above: Kubernetes v1.19+</code></p>
<p>æ­¥éª¤ 01.å¦‚æœæ‚¨æœ‰ Helmï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²å…¥å£æ§åˆ¶å™¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">helm3 repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm3 repo update</span><br><span class="line">helm3 search repo ingress-nginx -l</span><br><span class="line">  <span class="comment"># NAME                            CHART VERSION   APP VERSION     DESCRIPTION</span></span><br><span class="line">  <span class="comment"># ingress-nginx/ingress-nginx     4.1.4           1.2.1           Ingress controller for Kubernetes using NGINX a...</span></span><br><span class="line">  <span class="comment"># ingress-nginx/ingress-nginx     4.1.3           1.2.1           Ingress controller for Kubernetes using NGINX a...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ingress-nginx Chart æ¨¡æ¿å‚æ•°é…ç½®</span></span><br><span class="line">helm3 show values --version 4.1.4 ingress-nginx/ingress-nginx &gt; values.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#  values.yaml é…ç½®ä¿®æ”¹å®Œæ¯•åå®‰è£… ingress-nginx</span></span><br><span class="line">helm3 install ingress-nginx -f values.yaml --version 4.1.4 ingress-nginx/ingress-nginx  --namespace ingress-nginx --create-namespace --debug</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ¸©é¦¨æç¤º: ä¸Šé¢åœ¨ä¸éœ€è¿›è¡Œå¯ç”¨å‚æ•°é…ç½®æ—¶å¯é‡‡ç”¨ä¸€æ¡å‘½ä»¤æå®š(æ³¨æ„æå‰æ‹‰å–ç›¸å…³é•œåƒ)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm3 upgrade --install ingress-nginx ingress-nginx \</span><br><span class="line">  --repo https://kubernetes.github.io/ingress-nginx \</span><br><span class="line">  --namespace ingress-nginx --create-namespace</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: ä½¿ç”¨å¦‚ä¸‹æ›´æ–°helmå›¾è¡¨éƒ¨ç½²çš„åº”ç”¨ä»¥æ›´æ–°ä¿®æ”¹ä¸ºå›½å†…é•œåƒæºã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ crictl pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.2.1</span><br><span class="line">$ crictl pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1</span><br><span class="line"></span><br><span class="line">helm3 upgrade ingress-nginx --namespace ingress-nginx --version 4.1.4 -f values.yaml ingress-nginx/ingress-nginx --debug</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.æŸ¥çœ‹ingress-nginxçš„éƒ¨ç½²æƒ…å†µï¼Œä¸€äº› pod åº”è¯¥åœ¨ ingress-nginx å‘½åç©ºé—´ä¸­å¯åŠ¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">helm3 list -n ingress-nginx</span><br><span class="line">  <span class="comment"># NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                  APP VERSION</span></span><br><span class="line">  <span class="comment"># ingress-nginx   ingress-nginx   1               2022-06-24 13:12:36.692931823 +0800 CST deployed        ingress-nginx-4.1.4    1.2.1</span></span><br><span class="line">helm3 <span class="built_in">history</span> ingress-nginx  -n ingress-nginx</span><br><span class="line">  <span class="comment"># REVISION        UPDATED                         STATUS          CHART                   APP VERSION     DESCRIPTION</span></span><br><span class="line">  <span class="comment"># 1               Fri Jun 24 13:20:49 2022        deployed        ingress-nginx-4.1.4     1.2.1           Install complete</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰å¾… Pod åº”ç”¨éƒ¨ç½²ä¸ºæ­£å¸¸</span></span><br><span class="line">kubectl <span class="built_in">wait</span> --namespace ingress-nginx \</span><br><span class="line">  --<span class="keyword">for</span>=condition=ready pod \</span><br><span class="line">  --selector=app.kubernetes.io/component=controller \</span><br><span class="line">  --timeout=120s</span><br><span class="line">  <span class="comment"># pod/ingress-nginx-controller-7cfd586878-fkdb5 condition met</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ ingress-nginx çš„ Pod ä¸ SVC </span></span><br><span class="line">kubectl get pod,svc -n ingress-nginx</span><br><span class="line">  <span class="comment"># NAME                                               READY   STATUS      RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># pod/ingress-ingress-nginx-admission-create-pjm6x   0/1     Completed   0          7m47s</span></span><br><span class="line">  <span class="comment"># pod/ingress-nginx-controller-7cfd586878-fkdb5      1/1     Running     0          18m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span></span><br><span class="line">  <span class="comment"># service/ingress-nginx-controller             NodePort    10.107.81.40     &lt;none&gt;        80:30080/TCP,443:30443/TCP   18m</span></span><br><span class="line">  <span class="comment"># service/ingress-nginx-controller-admission   ClusterIP   10.106.154.244   &lt;none&gt;        443/TCP                      18m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ ingress çš„ ingressclasses åç§°åç»­æ‰èƒ½ä½¿ç”¨ã€‚</span></span><br><span class="line">kubectl get ingressclasses.networking.k8s.io</span><br><span class="line">  NAME    CONTROLLER             PARAMETERS   AGE</span><br><span class="line">  nginx   k8s.io/ingress-nginx   &lt;none&gt;       19m</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.é’ˆå¯¹æ­å»ºçš„ ingress-nginx æœåŠ¡éªŒè¯, æ­¤å¤„è®¿é—®åº”è¯¥æ˜¯NGINXæ ‡å‡†404é”™è¯¯é¡µé¢,å› ä¸º</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get the application URL by running these commands:</span></span><br><span class="line"><span class="built_in">export</span> HTTP_NODE_PORT=30080</span><br><span class="line"><span class="built_in">export</span> HTTPS_NODE_PORT=30443</span><br><span class="line"><span class="built_in">export</span> NODE_IP=$(kubectl --namespace ingress-nginx get nodes -o jsonpath=<span class="string">"&#123;.items[0].status.addresses[1].address&#125;"</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Visit http://<span class="variable">$NODE_IP</span>:<span class="variable">$HTTP_NODE_PORT</span> to access your application via HTTP."</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Visit https://<span class="variable">$NODE_IP</span>:<span class="variable">$HTTPS_NODE_PORT</span> to access your application via HTTPS."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•è®¿é—® ingress - nginx</span></span><br><span class="line">$ curl -I --insecure http://devtest-master-212:30080</span><br><span class="line">$ curl -I --insecure https://devtest-master-212:30443</span><br><span class="line">  <span class="comment"># HTTP/2 404</span></span><br><span class="line">  <span class="comment"># date: Fri, 24 Jun 2022 07:07:12 GMT</span></span><br><span class="line">  <span class="comment"># content-type: text/html</span></span><br><span class="line">  <span class="comment"># content-length: 146</span></span><br><span class="line">  <span class="comment"># strict-transport-security: max-age=15724800; includeSubDomains</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 04.ä¼˜åŒ–ingress Podå†…æ ¸å‚æ•°ä»¥åŠæ‰©å®¹Podåˆ°æ¯ä¸ªèŠ‚ç‚¹ä¹‹ä¸Š, æ›´å¤šä¼˜åŒ–å¯ä»¥å‚è€ƒ [<a href="https://blog.weiyigeek.top/2020/5-28-588.html#0x07-Kubernetes%E4%B8%ADingress-nginx%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE]">https://blog.weiyigeek.top/2020/5-28-588.html#0x07-Kubernetes%E4%B8%ADingress-nginx%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE]</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¾‘ ingress-nginx-controllerèµ„æºæ¸…å•æ·»åŠ ä¸€ä¸ª initContainers è¿›è¡Œå†…æ ¸å‚æ•°åˆå§‹åŒ–</span></span><br><span class="line">$ kubectl edit deployments.apps -n ingress-nginx ingress-nginx-controller</span><br><span class="line">....</span><br><span class="line">  initContainers:</span><br><span class="line">  - <span class="built_in">command</span>:</span><br><span class="line">    - sh</span><br><span class="line">    - -c</span><br><span class="line">    - |</span><br><span class="line">      mount -o remount rw /proc/sys</span><br><span class="line">      sysctl -w net.core.somaxconn=65535</span><br><span class="line">      sysctl -w net.ipv4.tcp_tw_reuse=1</span><br><span class="line">      sysctl -w net.ipv4.ip_local_port_range=<span class="string">"1024 65535"</span></span><br><span class="line">      sysctl -w fs.file-max=1048576</span><br><span class="line">      sysctl -w fs.inotify.max_user_instances=16384</span><br><span class="line">      sysctl -w fs.inotify.max_user_watches=524288</span><br><span class="line">      sysctl -w fs.inotify.max_queued_events=16384</span><br><span class="line">    image: alpine:3.10</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: sysctl</span><br><span class="line">    resources: &#123;&#125;</span><br><span class="line">    securityContext:</span><br><span class="line">      privileged: <span class="literal">true</span></span><br><span class="line">    terminationMessagePath: /dev/termination-log</span><br><span class="line">    terminationMessagePolicy: File</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å®¹ ingress-nginx-controller å‰¯æœ¬ä¸ºèŠ‚ç‚¹æ•°é‡ (æ³¨æ„æ­¤å¤„å·²å»é™¤masterèŠ‚ç‚¹æ±¡ç‚¹)</span></span><br><span class="line">kubectl scale deployment --replicas=4 -n ingress-nginx ingress-nginx-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ ingress-controller çš„Pod</span></span><br><span class="line">kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o wide</span><br><span class="line">  NAME                                        READY   STATUS    RESTARTS   AGE     IP              NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">  ingress-nginx-controller-7f8cd9c4fc-6lqgw   1/1     Running   0          5m33s   10.66.55.65     devtest-master-213   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">  ingress-nginx-controller-7f8cd9c4fc-8svfj   1/1     Running   0          3m16s   10.66.53.79     devtest-work-215     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">  ingress-nginx-controller-7f8cd9c4fc-g75fz   1/1     Running   0          6m40s   10.66.237.129   devtest-master-212   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">  ingress-nginx-controller-7f8cd9c4fc-jl5qg   1/1     Running   0          5m33s   10.66.35.67     devtest-master-214   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ href="https://img.weiyigeek.top/2022/5/20220624150133.png" target="_blank" title="WeiyiGeek.ingress-initContainers" data-fancybox="images"><img src="https://img.weiyigeek.top/2022/5/20220624150133.png" alt="WeiyiGeek.ingress-initContainers" title="" class=""></a>
                <p>WeiyiGeek.ingress-initContainers</p>
            </figure>
<p><br/></p>

        </div>
        
        <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
        
        <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½çœ‹å‹,æ¬¢è¿å…³æ³¨åšä¸»å¾®ä¿¡å…¬ä¼—å·å“Ÿ! â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘å³å¯å…³é—­ç»§ç»­æµè§ˆæ–‡ç« .<br>  <b style="color:red;"> æ¸©é¦¨æç¤º: æœªè§£é”çš„ç”¨æˆ·ä¸èƒ½ç²˜è´´å¤åˆ¶æ–‡ç« å†…å®¹å“Ÿ!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
           

        <!-- Google å¹¿å‘Š -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2023-03-13T03:53:36.921Z" itemprop="dateUpdated">2023-03-13 11:53:36</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤-cost.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤-cost.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2022/6-7-664.html" target="_blank" rel="external">https://blog.weiyigeek.top/2022/6-7-664.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2022/6-7-664.html&title=ã€Š21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2022/6-7-664.html&title=ã€Š21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2022/6-7-664.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2022/6-7-664.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2022/6-7-664.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2022/6-7-701.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">10.è®¡ç®—æœºç§‘å­¦å¯¼è®ºä¹‹è½¯ä»¶å·¥ç¨‹å­¦ä¹ ç¬”è®°</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2022/6-6-700.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">9.è®¡ç®—æœºç§‘å­¦å¯¼è®ºä¹‹ç¨‹åºè®¾è®¡è¯­è¨€å­¦ä¹ ç¬”è®°</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 å‰è¨€ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-ç¯å¢ƒå‡†å¤‡"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 ç¯å¢ƒå‡†å¤‡</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ä¸»æœºè§„åˆ’"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">ä¸»æœºè§„åˆ’</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#è½¯ä»¶ç‰ˆæœ¬"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">è½¯ä»¶ç‰ˆæœ¬</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç½‘ç»œè§„åˆ’"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">ç½‘ç»œè§„åˆ’</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-å®‰è£…éƒ¨ç½²"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 å®‰è£…éƒ¨ç½²</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-å‡†å¤‡åŸºç¡€ä¸»æœºç¯å¢ƒé…ç½®"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.å‡†å¤‡åŸºç¡€ä¸»æœºç¯å¢ƒé…ç½®</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-è´Ÿè½½å‡è¡¡ç®¡ç†ipvsadmå·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.è´Ÿè½½å‡è¡¡ç®¡ç†ipvsadmå·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-é«˜å¯ç”¨HAProxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.é«˜å¯ç”¨HAProxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-å®¹å™¨è¿è¡Œæ—¶containerd-ioå®‰è£…é…ç½®"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.å®¹å™¨è¿è¡Œæ—¶containerd.ioå®‰è£…é…ç½®</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-å®‰è£…æºé…ç½®ä¸åˆå§‹åŒ–é›†ç¾¤é…ç½®å‡†å¤‡"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">5.å®‰è£…æºé…ç½®ä¸åˆå§‹åŒ–é›†ç¾¤é…ç½®å‡†å¤‡</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-ä½¿ç”¨kubeadmå®‰è£…éƒ¨ç½²K8Sé›†ç¾¤"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">6.ä½¿ç”¨kubeadmå®‰è£…éƒ¨ç½²K8Sé›†ç¾¤</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-éƒ¨ç½²é…ç½®-Calico-ç½‘ç»œæ’ä»¶"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">7.éƒ¨ç½²é…ç½® Calico ç½‘ç»œæ’ä»¶</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-é›†ç¾¤è¾…åŠ©æ’ä»¶éƒ¨ç½²"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 é›†ç¾¤è¾…åŠ©æ’ä»¶éƒ¨ç½²</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-é›†ç¾¤ä¸­åŸºäºnfsçš„provisionerçš„åŠ¨æ€æŒå·ç¯å¢ƒéƒ¨ç½²"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">1.é›†ç¾¤ä¸­åŸºäºnfsçš„provisionerçš„åŠ¨æ€æŒå·ç¯å¢ƒéƒ¨ç½²</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-é›†ç¾¤ä¸­å®‰è£…metrics-serverè·å–å®¢æˆ·ç«¯èµ„æºç›‘æ§æŒ‡æ ‡"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">2.é›†ç¾¤ä¸­å®‰è£…metrics-serverè·å–å®¢æˆ·ç«¯èµ„æºç›‘æ§æŒ‡æ ‡</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-é›†ç¾¤ç®¡ç†åŸç”ŸUIå·¥å…·kubernetes-dashboardå®‰è£…éƒ¨ç½²"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">3.é›†ç¾¤ç®¡ç†åŸç”ŸUIå·¥å…·kubernetes-dashboardå®‰è£…éƒ¨ç½²</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-é›†ç¾¤ç®¡ç†K9Så®¢æˆ·ç«¯å·¥å…·å®‰è£…ä½¿ç”¨"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">4.é›†ç¾¤ç®¡ç†K9Så®¢æˆ·ç«¯å·¥å…·å®‰è£…ä½¿ç”¨</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-é›†ç¾¤æœåŠ¡Serviceä¸ƒå±‚è´Ÿè½½å‡è¡¡ingressç¯å¢ƒæ­å»ºéƒ¨ç½²"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">5.é›†ç¾¤æœåŠ¡Serviceä¸ƒå±‚è´Ÿè½½å‡è¡¡ingressç¯å¢ƒæ­å»ºéƒ¨ç½²</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
    <!-- 
  <div id="post-wechat" class="post-wechat" style="position:fixed;top: 360px;bottom: 500px;right: 3%;width: 190px;text-align: center; z-index: 9999">
    <p><b>å…³æ³¨ã€å…¨æ ˆå·¥ç¨‹å¸ˆä¿®ç‚¼æŒ‡å—ã€‘</b></p>
    <img src="/img/wechat-gzh.jpg" class="img-responsive" alt="weiyigeek">
    <p><b>æ¬¢è¿æ·»åŠ ã€ä½œè€…ã€‘å¾®ä¿¡</b></p>
    <img src="/img/wehat.jpg" class="img-responsive" alt="weiyigeek">
  </div>


 -->

    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="/img/share-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2023 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div>
        <div id="blog-wormhole-id" >
          <a href="https://www.foreverblog.cn/go.html" target="_blank"> 
            <img src="https://img.foreverblog.cn/wormhole_2_tp.gif" alt="åå¹´ä¹‹çº¦è™«æ´" style="height:32px;max-height:50px;display:block;margin:0 auto;" title="ç©¿æ¢­è™«æ´-éšæœºè®¿é—®åå¹´ä¹‹çº¦å‹é“¾åšå®¢">
          </a>
        </div>
        <div id="cc-myssl-id" >
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2022/6-7-664.html&title=ã€Š21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2022/6-7-664.html&title=ã€Š21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2022/6-7-664.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š21-kubernetesè¿›é˜¶ä¹‹kubeadmæ–¹å¼å®‰è£…é«˜å¯ç”¨k8sé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2022/6-7-664.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2022/6-7-664.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMElEQVR42u3a24rDMAxF0f7/T6evhSGefaS0YHnnaQhp4uUBYV1eL3xdH9ffO5/3756/e2f6q9YlQ4aMbRnX8lozyJvJG9Z/r9cmQ4aMcxhkEWs8/xUJ4nxtMmTIkEGeWR/pyDO178qQIUNGGnBJuEyDrAwZMmR0FsSLaGRrfpqLy5AhY0NGurhf/v2V/oYMGTK2Ylzh1W9zkpZnvCoZMmSMZqTNyPUi+NGQlOfSLZMhQ8ZURtqG5IkuD9brTUF3ZMiQMZrBA2LazuTDE7VBtH82SIYMGUMZ5HVp0T9Nhvnzxf+DDBkyNmSkjUk+/vXUHZQwy5AhYzQjTSn5B1CdDz8TNzhlyJBxACMub+HgS1LZ2giIDBkyTmOkwS4tsaXbRw6UMmTImMrohFf+ybg7EbYfZMiQcQKjs7ja0ZCX3tC2ypAhYzSjH+zSpmNxBqT0vAwZMuYx0vEIEkxrQbkYXmXIkDGaQYZW0+NjbbCs1aKQIUPGaEYtgtWSUg5Ok20ZMmTMZpBDIR+PqDUM+AHxdlUyZMg4jEGKXGTkqxas+RdlyJBxGiMtxJPCXHoorKW1MmTImM24wosvLi2xdcK6DBkyZjNq1XVevePJMElTH2h2ypAhY1tGLcimY2Q8BKejHjJkyDiHkQ5+cR5PbjuNVRkyZMhIS2/pMTHdggcCrgwZMg5g8AGLfoaNMDJkyDiAQZJYknx2Dn+dMQ4ZMmTMZvDUsZhehouoBWsZMmQMZbwBSO2dOzSDJsUAAAAASUVORK5CYII=" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å”¯ä¸€æå®¢-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// ç«™ç‚¹è¿è¡Œæ—¶é—´
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + " å¤© " + RunHours + " æ—¶ " + RunMinutes + " åˆ† " + RunSeconds + " ç§’";
  document.getElementById(id).innerHTML = "ç½‘ç«™å·²åœ¨é£é›¨ä¸­å‹‰å‹‰å¼ºå¼ºè¿è¡Œäº†ã€ " + RunTime + " ã€‘";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
    
  <div id="post-wechat" class="post-wechat" style="position:fixed;top: 360px;bottom: 500px;right: 3%;width: 190px;text-align: center; z-index: 9999">
    <p><b>å…³æ³¨ã€å…¨æ ˆå·¥ç¨‹å¸ˆä¿®ç‚¼æŒ‡å—ã€‘</b></p>
    <img src="/img/wechat-gzh.jpg" class="img-responsive" alt="weiyigeek">
    <p><b>æ¬¢è¿æ·»åŠ ã€ä½œè€…ã€‘å¾®ä¿¡</b></p>
    <img src="/img/wehat.jpg" class="img-responsive" alt="weiyigeek">
  </div>



</body>
</html>