{"title":"6.Jenkins进阶之分布式架构综合实践","slug":"系统运维/自动化运维/CI-CD/Jenkins/6.Jenkins进阶之分布式架构综合实践","date":"2020-12-31T05:34:30.000Z","updated":"2023-01-31T02:29:10.467Z","url":"2020/12-31-534.html","path":"api/articles/2020/12-31-534.html.json","covers":["https://img.weiyigeek.top/2021/1/20210317174011.png","https://img.weiyigeek.top/2021/1/20210317113540.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x01-Jenkins之K8s集群自动化部署单war包应用\"><a href=\"#0x01-Jenkins之K8s集群自动化部署单war包应用\" class=\"headerlink\" title=\"0x01 Jenkins之K8s集群自动化部署单war包应用\"></a>0x01 Jenkins之K8s集群自动化部署单war包应用</h2><p><strong>实验目的</strong><br>描述: 采用Jenkins从Gitlab中拉取测试项目以及代码质量检测，然后进行编译构建并利用K8s集群进行WAR包应用部署实践，最后将生成的制品进行归档到Gitlab的Release之中;</p>\n<p>动态配置文件或者脚本:</p>\n<ul>\n<li>setting.xml (Maven编译构建配置文件)</li>\n<li>HelloWorld.yaml (应用部署资源清单)</li>\n<li>options.sh (部署脚本)</li>\n</ul>\n<p><br></p>\n<h3 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h3><p>描述: 假定你已经按照我前面几篇文章中安装好基础环境。</p>\n<h3 id=\"0-HelloWorld-Tomcat-应用服务器\"><a href=\"#0-HelloWorld-Tomcat-应用服务器\" class=\"headerlink\" title=\"(0) HelloWorld - Tomcat 应用服务器\"></a>(0) HelloWorld - Tomcat 应用服务器</h3><ul>\n<li><p>Step 1.基础镜像拉取于上传到私有仓库中</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">weiyigeek@weiyigeek-107:~/k8s/sonarqube$ docker tag tomcat:8.5.61-jdk8-corretto harbor.weiyigeek.top/devops/tomcat:8.5.61-jdk8-corretto</span><br><span class=\"line\">weiyigeek@weiyigeek-107:~/k8s/sonarqube$ docker push harbor.weiyigeek.top/devops/tomcat:8.5.61-jdk8-corretto</span><br><span class=\"line\">The push refers to repository [harbor.weiyigeek.top/devops/tomcat]</span><br><span class=\"line\">f13244e4918b: Pushed</span><br><span class=\"line\">536f15f78828: Pushed</span><br><span class=\"line\">1c98b6d16fad: Pushed</span><br><span class=\"line\">fdef502bf282: Pushed</span><br><span class=\"line\">cee8d35c645b: Pushed</span><br><span class=\"line\">8.5.61-jdk8-corretto: digest: sha256:110d7391739e868daf8c1bdd03fcb7ffe9eaf2b134768b9162e2cd47d58f7255 size: 1368</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 2.资源清单文件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; HelloWorld.yaml &lt;&lt;'END'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">deploy-maven-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span>         <span class=\"comment\"># Service 类型</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">java-maven</span>       <span class=\"comment\"># 【注意】与deployment资源控制器创建的Pod标签进行绑定;</span></span><br><span class=\"line\"><span class=\"attr\">    release:</span> <span class=\"string\">stabel</span>       <span class=\"comment\"># Service 服务发现不能缺少Pod标签，有了Pod标签才能与之SVC对应</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span>                  <span class=\"comment\"># 映射端口</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">8080</span>              <span class=\"comment\"># cluster 访问端口</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">8080</span>        <span class=\"comment\"># Pod 容器内的服务端口</span></span><br><span class=\"line\"><span class=\"attr\">    nodePort:</span> <span class=\"number\">30089</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">deploy-java-maven</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"deploy-maven-svc\"</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">3</span>                <span class=\"comment\"># 副本数</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span>                  <span class=\"comment\"># 选择器</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">java-maven</span>   <span class=\"comment\"># 匹配的Pod标签非常重要</span></span><br><span class=\"line\"><span class=\"attr\">      release:</span> <span class=\"string\">stabel</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">java-maven</span>      <span class=\"comment\"># 模板标签</span></span><br><span class=\"line\"><span class=\"attr\">        release:</span> <span class=\"string\">stabel</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span>                <span class=\"comment\"># 关键点</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">webapps</span>         <span class=\"comment\"># 卷名称</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span>             <span class=\"comment\"># 采用hostPath卷</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span>   <span class=\"comment\"># 卷类型DirectoryOrCreate: 如果子节点上没有该目录便会进行创建</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/nfsdisk-31/test/</span>  <span class=\"comment\"># 各主机节点上已存在的目录此处是NFS共享</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">timezone</span>     <span class=\"comment\"># 容器时区设置</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">java-maven</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">harbor.weiyigeek.top/devops/tomcat:8.5.61-jdk8-corretto</span>  <span class=\"comment\"># 拉取的镜像</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span> <span class=\"string\">[\"bash\",\"-c\",\"cp</span> <span class=\"string\">/tmp/$&#123;APPNAME&#125;</span> <span class=\"string\">/usr/local/tomcat/webapps/ROOT.war</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">catalina.sh</span> <span class=\"string\">run\"]</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">APPNAME</span></span><br><span class=\"line\"><span class=\"attr\">            value:</span> <span class=\"string\">HelloWorld-v1.40.war</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">http</span>         <span class=\"comment\"># 此端口在服务中的名称</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">8080</span>  <span class=\"comment\"># 容器暴露的端口</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span>        <span class=\"comment\"># 挂载指定卷目录</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">webapps</span>      <span class=\"comment\"># Tomcat 应用目录</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/tmp/</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">logs</span>         <span class=\"comment\"># Tomcat 日志目录</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/usr/local/tomcat/logs</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">timezone</span>     <span class=\"comment\"># 镜像时区设置</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span>      <span class=\"comment\"># 卷的体积要求模板此处采用StorageClass存储类主要针对于应用日志的存储;</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span>                <span class=\"comment\"># 根据模板自动创建PV与PVC并且进行一一对应绑定;</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">logs</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      storageClassName:</span> <span class=\"string\">managed-nfs-storage</span> <span class=\"comment\"># StorageClass存储类</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">1</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"string\">END</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"1-Nginx-Web服务器\"><a href=\"#1-Nginx-Web服务器\" class=\"headerlink\" title=\"(1) Nginx - Web服务器\"></a>(1) Nginx - Web服务器</h3><ul>\n<li><p>Step 1.Nginx 配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@468dd7df372e:/<span class=\"comment\"># grep -v \"#\" /etc/nginx/conf.d/default.conf</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    listen  [::]:80;</span><br><span class=\"line\">    server_name  rel.weiyigeek.top;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        root   /usr/share/nginx/html;</span><br><span class=\"line\">        index  index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    error_page   500 502 503 504  /50x.html;</span><br><span class=\"line\">    location = /50x.html &#123;</span><br><span class=\"line\">        root   /usr/share/nginx/html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 2.将Jenkins构建的Release进行上传在Nginx 中进行归档所以需要资源清单进行部署;</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; jenkins-release-nginx.yaml &lt;&lt;'END'</span></span><br><span class=\"line\"><span class=\"string\"># apiVersion: extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"string\"># kind: Ingress</span></span><br><span class=\"line\"><span class=\"string\"># metadata:</span></span><br><span class=\"line\"><span class=\"string\">#   annotations:</span></span><br><span class=\"line\"><span class=\"string\">#     kubernetes.io/ingress.class: nginx</span></span><br><span class=\"line\"><span class=\"string\">#   labels:</span></span><br><span class=\"line\"><span class=\"string\">#     app: release</span></span><br><span class=\"line\"><span class=\"string\">#   name: jenkins-release</span></span><br><span class=\"line\"><span class=\"string\">#   namespace: devops</span></span><br><span class=\"line\"><span class=\"string\"># spec:</span></span><br><span class=\"line\"><span class=\"string\">#   rules:</span></span><br><span class=\"line\"><span class=\"string\">#   - host: rel.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"string\">#     http:</span></span><br><span class=\"line\"><span class=\"string\">#       paths:</span></span><br><span class=\"line\"><span class=\"string\">#       - backend:</span></span><br><span class=\"line\"><span class=\"string\">#           serviceName: release-svc</span></span><br><span class=\"line\"><span class=\"string\">#           servicePort: 80</span></span><br><span class=\"line\"><span class=\"string\">#         path: /</span></span><br><span class=\"line\"><span class=\"string\"># ---</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">release-svc</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devops</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">release</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">    nodePort:</span> <span class=\"number\">30003</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginxconf</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devops</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">default.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    server &#123;</span></span><br><span class=\"line\"><span class=\"string\">      listen       80;</span></span><br><span class=\"line\"><span class=\"string\">      listen  [::]:80;</span></span><br><span class=\"line\"><span class=\"string\">      server_name  rel.weiyigeek.top;</span></span><br><span class=\"line\"><span class=\"string\">      location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">          root   /usr/share/nginx/html;</span></span><br><span class=\"line\"><span class=\"string\">          index  index.html index.htm;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">      error_page   500 502 503 504  /50x.html;</span></span><br><span class=\"line\"><span class=\"string\">      location = /50x.html &#123;</span></span><br><span class=\"line\"><span class=\"string\">          root   /usr/share/nginx/html;</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">release-deployment</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devops</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">release</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">release</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">release</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">release-nginx</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">nginx:latest</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span>  <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">/etc/nginx/conf.d/</span></span><br><span class=\"line\"><span class=\"attr\">            readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">/usr/share/nginx/html/</span></span><br><span class=\"line\"><span class=\"attr\">            readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">nginxconf</span></span><br><span class=\"line\"><span class=\"attr\">          defaultMode:</span> <span class=\"number\">0755</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span> </span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/nfsdisk-31/release</span></span><br><span class=\"line\"><span class=\"string\">END</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.访问验证</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.测试文件</span></span><br><span class=\"line\">~$ <span class=\"built_in\">cd</span> /nfsdisk-31/release &amp;&amp; touch index.html</span><br><span class=\"line\">  <span class=\"comment\"># echo \"Hello World, Boy or Girl;\" &gt; index.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.deployments状态查询与SVC</span></span><br><span class=\"line\">~$ kubectl get deployments.apps -n devops  release-deployment -o wide</span><br><span class=\"line\">  <span class=\"comment\"># NAME                 READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS      IMAGES         SELECTOR</span></span><br><span class=\"line\">  <span class=\"comment\"># release-deployment   1/1     1            1           4d11h   release-nginx   nginx:latest   app=release</span></span><br><span class=\"line\">~$ kubectl get svc -n devops  release-svc</span><br><span class=\"line\">  <span class=\"comment\"># NAME          TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># release-svc   NodePort   10.106.107.201   &lt;none&gt;        80:30003/TCP   4d11h</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.访问验证</span></span><br><span class=\"line\">~/k8s/nginx$ curl rel.weiyigeek.top/index.html</span><br><span class=\"line\">~/k8s/nginx$ curl http://192.168.12.108:30003/index.html</span><br><span class=\"line\">  <span class=\"comment\"># Hello World, Boy or Girl;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"2-Jenkins-Pipeline-脚本\"><a href=\"#2-Jenkins-Pipeline-脚本\" class=\"headerlink\" title=\"(2) Jenkins Pipeline 脚本\"></a>(2) Jenkins Pipeline 脚本</h3><p>Jenkins 流水线脚本如下:<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// @ 预定定义变量</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> PRJECT = <span class=\"string\">\"ssh://git@weiyigeek.top/blog.git\"</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> PUBKEY = <span class=\"string\">\"5e2f46d9-6725-4399-847f-dafb3f29d0ce\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// @ ssh 登陆链接函数</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> getSSH() &#123;</span><br><span class=\"line\">  <span class=\"keyword\">def</span> remote = [:]</span><br><span class=\"line\">  remote.name = <span class=\"string\">\"K8S#$&#123;DEPLOY_HOST&#125;\"</span></span><br><span class=\"line\">  remote.user = <span class=\"string\">\"$&#123;DEPLOY_USER&#125;\"</span></span><br><span class=\"line\">  remote.host = <span class=\"string\">\"$&#123;DEPLOY_HOST&#125;\"</span></span><br><span class=\"line\">  remote.port = <span class=\"number\">20211</span></span><br><span class=\"line\">  remote.allowAnyHosts = <span class=\"literal\">true</span>   </span><br><span class=\"line\">  withCredentials([string(<span class=\"string\">credentialsId:</span> <span class=\"string\">\"$&#123;DEPLOY_CREDENTIALSID&#125;\"</span>, <span class=\"string\">variable:</span> <span class=\"string\">'sshpassword'</span>)]) &#123;</span><br><span class=\"line\">    remote.password = sshpassword</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> remote</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// @ Secure 密钥获取</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> getSecure(Ticket_Token) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">def</span> token = <span class=\"string\">\"\"</span></span><br><span class=\"line\">  withCredentials([string(<span class=\"string\">credentialsId:</span> Ticket_Token, <span class=\"string\">variable:</span> <span class=\"string\">'secure_token'</span>)]) &#123;</span><br><span class=\"line\">    token = secure_token</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  println token</span><br><span class=\"line\">  <span class=\"keyword\">return</span> token</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  <span class=\"comment\">/* Job 工作节点的绑定 */</span></span><br><span class=\"line\">  agent &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 1) 采用K8s动态生成Jnlp的Jenkins 节点</span></span><br><span class=\"line\">    kubernetes &#123;</span><br><span class=\"line\">      cloud <span class=\"string\">'kubernetes'</span></span><br><span class=\"line\">      namespace <span class=\"string\">'devops'</span></span><br><span class=\"line\">      inheritFrom <span class=\"string\">'jenkins-slave'</span></span><br><span class=\"line\">      workingDir <span class=\"string\">'/home/jenkins/agent'</span></span><br><span class=\"line\">      <span class=\"comment\">// yamlFile 'KubernetesPod.yaml' // 指定 yaml 资源清单其内容包含在yaml对象中</span></span><br><span class=\"line\">      yaml <span class=\"string\">\"\"\"\\</span></span><br><span class=\"line\"><span class=\"string\">apiVersion:</span></span><br><span class=\"line\"><span class=\"string\">kind: Pod</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    jenkins: \"slave\"</span></span><br><span class=\"line\"><span class=\"string\">    jenkins/label: 'k8s-slave'</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  containers:</span></span><br><span class=\"line\"><span class=\"string\">  - name: 'jnlp'</span></span><br><span class=\"line\"><span class=\"string\">    image: 'harbor.weiyigeek.top/devops/jenkins-jnlp:3.13.6-alpine'</span></span><br><span class=\"line\"><span class=\"string\">    imagePullPolicy: 'IfNotPresent'                                    </span></span><br><span class=\"line\"><span class=\"string\">    command: [\"/bin/sh\",\"-c\",\"/usr/local/bin/jenkins-agent.sh &amp;&amp; cat\"] </span></span><br><span class=\"line\"><span class=\"string\">    tty: true</span></span><br><span class=\"line\"><span class=\"string\">    volumeMounts:</span></span><br><span class=\"line\"><span class=\"string\">    - mountPath: \"/home/jenkins/.m2\"</span></span><br><span class=\"line\"><span class=\"string\">      name: \"volume-0\"</span></span><br><span class=\"line\"><span class=\"string\">    - mountPath: \"/var/run/docker.sock\"</span></span><br><span class=\"line\"><span class=\"string\">      name: \"volume-1\"</span></span><br><span class=\"line\"><span class=\"string\">    \"\"\"</span>.stripIndent()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* 全局选项 */</span></span><br><span class=\"line\">  options &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Gitlab 相关设置(连接凭据与Pipeline步骤)</span></span><br><span class=\"line\">    gitLabConnection(<span class=\"string\">'Gitlab-weiyigeek'</span>)</span><br><span class=\"line\">    gitlabBuilds(<span class=\"string\">builds:</span> [<span class=\"string\">'代码拉取'</span>, <span class=\"string\">'代码检测'</span>, <span class=\"string\">'项目构建'</span>,<span class=\"string\">'项目部署'</span>,<span class=\"string\">'成品归档'</span>,<span class=\"string\">'消息通知'</span>])</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 全局超时设置 30分钟</span></span><br><span class=\"line\">    timeout(<span class=\"string\">time:</span> <span class=\"number\">30</span>, <span class=\"string\">unit:</span> <span class=\"string\">'MINUTES'</span>)   </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Job 自动触发构建参数 */</span></span><br><span class=\"line\">  triggers &#123;</span><br><span class=\"line\">    <span class=\"comment\">// gitlab 项目进行 git Push或者是Comment 触发构建</span></span><br><span class=\"line\">    gitlab(</span><br><span class=\"line\"><span class=\"symbol\">      triggerOnPush:</span> <span class=\"literal\">false</span>, </span><br><span class=\"line\"><span class=\"symbol\">      triggerOnMergeRequest:</span> <span class=\"literal\">true</span>, </span><br><span class=\"line\"><span class=\"symbol\">      triggerOpenMergeRequestOnPush:</span> <span class=\"string\">\"never\"</span>, </span><br><span class=\"line\"><span class=\"symbol\">      noteRegex:</span> <span class=\"string\">\"jenkins build\"</span>,</span><br><span class=\"line\"><span class=\"symbol\">      branchFilterType:</span> <span class=\"string\">'All'</span></span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\">  全局参数, 在shell可通过变量名访问，而在script pipeline脚本中通过params.参数名称访问.  $&#123;params.RELEASE_VERSION&#125;</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  parameters &#123;</span><br><span class=\"line\">    string(<span class=\"string\">name:</span> <span class=\"string\">'RELEASE_VERSION'</span>, <span class=\"string\">defaultValue:</span> <span class=\"string\">\"master\"</span>, <span class=\"string\">description:</span> <span class=\"string\">'Message: 请选择部署的Tags版本?'</span>,<span class=\"string\">trim:</span> <span class=\"string\">'True'</span>)</span><br><span class=\"line\">    choice(<span class=\"string\">name:</span> <span class=\"string\">'PREJECT_OPERATION'</span>, <span class=\"string\">choices:</span> [<span class=\"string\">'deploy'</span>, <span class=\"string\">'rollback'</span>, <span class=\"string\">'redeploy'</span>], <span class=\"string\">description:</span> <span class=\"string\">'Message: 选择项目操作方式?'</span>)</span><br><span class=\"line\">    choice(<span class=\"string\">name:</span> <span class=\"string\">'SONARQUBE'</span>, <span class=\"string\">choices:</span> [<span class=\"string\">'False'</span>,<span class=\"string\">'True'</span>],<span class=\"string\">description:</span> <span class=\"string\">'Message: 是否进行代码质量检测?'</span>)</span><br><span class=\"line\">    choice(<span class=\"string\">name:</span> <span class=\"string\">'GITLAB_RELEASE'</span>, <span class=\"string\">choices:</span> [<span class=\"string\">'False'</span>,<span class=\"string\">'True'</span>],<span class=\"string\">description:</span> <span class=\"string\">'Message: 是否进行编译成品发布到Gitlab开发项目Release中?'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\">  环境变量设置, 在shell可通过变量名访问，而在script pipeline脚本中通过env.参数名称访问.  $&#123;env.GITLAB_URL&#125; </span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  environment &#123;</span><br><span class=\"line\">    <span class=\"comment\">// # GitLab 仓库相关信息（修改点1）</span></span><br><span class=\"line\">    GITLAB_URL = <span class=\"string\">'ssh://git@gitlab.weiyigeek.top:2222/weiyigeek/helloworld.git'</span>  </span><br><span class=\"line\">    GITLAB_PROJECTID = <span class=\"string\">'45'</span></span><br><span class=\"line\">    GITLAB_PUB = <span class=\"string\">'5e2f46d9-6725-4399-847f-dafb3f29d0ce'</span></span><br><span class=\"line\">    GITLAB_TOKEN = <span class=\"string\">'ce228573-ad3d-40e8-a3bf-b9de510080db'</span></span><br><span class=\"line\">    GITLAB_REL = <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/$&#123;GITLAB_PROJECTID&#125;/releases\"</span></span><br><span class=\"line\">    GITLAB_DOWNLOAD = <span class=\"string\">\"http://192.168.12.107:30003/$&#123;JOB_NAME&#125;/$&#123;APP_NAME&#125;\"</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// # 应用名称&amp;后缀以及集成结果（修改点2）</span></span><br><span class=\"line\">    APP_NAME = <span class=\"string\">\"$&#123;JOB_NAME&#125;-$&#123;RELEASE_VERSION&#125;$&#123;APP_SUFFIX&#125;\"</span></span><br><span class=\"line\">    APP_SUFFIX = <span class=\"string\">\".war\"</span></span><br><span class=\"line\">    APP_FILE = <span class=\"string\">'target/*.war'</span></span><br><span class=\"line\">    APP_DIR = <span class=\"string\">'/nfsdisk-31/test/'</span></span><br><span class=\"line\">    <span class=\"comment\">// # Kubernetes 部署应用相关名称空间以及标签和SVC地址</span></span><br><span class=\"line\">    K8S_NAMESPACE = <span class=\"string\">\"default\"</span></span><br><span class=\"line\">    K8S_SELECTOR = <span class=\"string\">\"app=java-maven\"</span></span><br><span class=\"line\">    KS8_ADDRESS = <span class=\"string\">\"http://192.168.12.107:30089\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// # 应用部署主机（修改点3）</span></span><br><span class=\"line\">    <span class=\"keyword\">def</span> SERVER = <span class=\"string\">''</span></span><br><span class=\"line\">    DEPLOY_CREDENTIALSID = <span class=\"string\">\"b846141f-55c2-4b46-98a7-29b9e76af3cc\"</span> <span class=\"comment\">//12.107</span></span><br><span class=\"line\">    DEPLOY_HOST = <span class=\"string\">\"192.168.12.107\"</span></span><br><span class=\"line\">    DEPLOY_USER = <span class=\"string\">\"root\"</span></span><br><span class=\"line\">    DEPLOY_PORT = <span class=\"number\">20211</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// # 代码质量检测项目名称和检测反馈超时时间</span></span><br><span class=\"line\">    SONARQUBE_CREDENTIALSID = <span class=\"string\">\"18d24c8f-9772-4b3e-934c-f80ed0e96cde\"</span></span><br><span class=\"line\">    SONARQUBE_PROJECTKEY = <span class=\"string\">\"$&#123;JOB_NAME&#125;\"</span></span><br><span class=\"line\">    SONARQUBE_TIMEOUT = <span class=\"string\">'10'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// # 企业微信WebHookURL 1150-曾老师</span></span><br><span class=\"line\">    QYWX_WEBHOOK = <span class=\"string\">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=7d7f46fa-28c6-40b3-9c45-de243ec51150'</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Job 步骤状态 */</span></span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage (<span class=\"string\">'代码拉取'</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        <span class=\"comment\">// (1) 代码超时时间设置 5 分钟</span></span><br><span class=\"line\">        timeout(<span class=\"string\">time:</span> <span class=\"number\">5</span>, <span class=\"string\">unit:</span> <span class=\"string\">'MINUTES'</span>) &#123;</span><br><span class=\"line\">          script &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// (1) 动态SSH公与私钥导入到我们动态运行的工作节点之中。</span></span><br><span class=\"line\">              withCredentials([</span><br><span class=\"line\">                sshUserPrivateKey(<span class=\"string\">credentialsId:</span> <span class=\"string\">'1d4e61cb-5d59-4da8-813b-a5fb345770c9'</span>, <span class=\"string\">keyFileVariable:</span> <span class=\"string\">'keyFile'</span>, <span class=\"string\">passphraseVariable:</span> <span class=\"string\">'pass'</span>, <span class=\"string\">usernameVariable:</span> <span class=\"string\">'user'</span>),</span><br><span class=\"line\">                string(<span class=\"string\">credentialsId:</span> <span class=\"string\">'79a78423-e539-4b1f-a872-f0cf1dd3f9fa'</span>, <span class=\"string\">variable:</span> <span class=\"string\">'keyPub'</span>)</span><br><span class=\"line\">              ]) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// SSH Private Key</span></span><br><span class=\"line\">              writeFile <span class=\"string\">file:</span> <span class=\"string\">'private.key'</span>, <span class=\"string\">text:</span> keyFile</span><br><span class=\"line\">              sh <span class=\"string\">\"cp \\$(cat private.key) ~/.ssh/id_ed25519\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"comment\">// SSH Public</span></span><br><span class=\"line\">              writeFile <span class=\"string\">file:</span> <span class=\"string\">'private.pub'</span>, <span class=\"string\">text:</span> keyPub</span><br><span class=\"line\">              sh <span class=\"string\">\"echo \\$(cat private.pub) | base64 -d &gt; ~/.ssh/id_ed25519.pub\"</span></span><br><span class=\"line\">              &#125;  </span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"comment\">// (2) Gitlab 项目拉取</span></span><br><span class=\"line\">              checkout([<span class=\"string\">$class:</span> <span class=\"string\">'GitSCM'</span>, <span class=\"string\">branches:</span> [[<span class=\"string\">name:</span> <span class=\"string\">\"$&#123;params.RELEASE_VERSION&#125;\"</span>]], <span class=\"string\">doGenerateSubmoduleConfigurations:</span> <span class=\"literal\">false</span>, <span class=\"string\">extensions:</span> [], <span class=\"string\">submoduleCfg:</span> [], <span class=\"string\">userRemoteConfigs:</span> [[<span class=\"string\">credentialsId:</span> <span class=\"string\">\"$&#123;env.GITLAB_PUB&#125;\"</span>, <span class=\"string\">url:</span> <span class=\"string\">\"$&#123;env.GITLAB_URL&#125;\"</span>]]])</span><br><span class=\"line\">              <span class=\"comment\">// (3) 流水线状态同步</span></span><br><span class=\"line\">              updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码拉取'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span>(Exception err) &#123;</span><br><span class=\"line\">              updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码拉取'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">              <span class=\"comment\">// (4) 显示错误信息但还是会进行下一阶段操作(err.toString()  == unstable '拉取代码失败')</span></span><br><span class=\"line\">              echo err.toString()  </span><br><span class=\"line\">              <span class=\"comment\">// 将会停止构建</span></span><br><span class=\"line\">              error <span class=\"string\">\"[-Error] : 代码拉取失败\\n [-Msg] : $&#123;err.getMessage()&#125; \"</span></span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// (5) 显示当前版本Commit信息以及可用Tag版本</span></span><br><span class=\"line\">            <span class=\"comment\">// def INFO = sh label: 'release_info',returnStdout: true, returnStatus: true, script: \"\"\"\\</span></span><br><span class=\"line\">            <span class=\"comment\">// echo \"Git Commit:\" &amp;&amp; \\</span></span><br><span class=\"line\">            <span class=\"comment\">// git branch &amp;&amp; \\</span></span><br><span class=\"line\">            <span class=\"comment\">// git log --oneline  | grep \"$&#123;params.RELEASE_VERSION&#125;\" &amp;&amp; \\</span></span><br><span class=\"line\">            <span class=\"comment\">// echo \"Available Tag Version:\" &amp;&amp; \\</span></span><br><span class=\"line\">            <span class=\"comment\">// git tag -l --column;</span></span><br><span class=\"line\">            <span class=\"comment\">// \"\"\"</span></span><br><span class=\"line\">            <span class=\"comment\">// \"\"\"</span></span><br><span class=\"line\">            <span class=\"comment\">// git tag -l --column | tr -d ' '  &gt; tag ;</span></span><br><span class=\"line\">            <span class=\"comment\">// export a=\"\\$(sed \"s#v#, v#g\" tag)'\";</span></span><br><span class=\"line\">            <span class=\"comment\">// echo [\\$&#123;a#,*&#125;]</span></span><br><span class=\"line\">            <span class=\"comment\">// \"\"\"</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// (6) 输出预定变量值</span></span><br><span class=\"line\">            echo <span class=\"string\">\"[-Info] : RELEASE_VERSION: $&#123;params.RELEASE_VERSION&#125; , PREJECT_OPERATION: $&#123;params.PREJECT_OPERATION&#125;, SONARQUBE: $&#123;params.SONARQUBE&#125;, GITLAB_RELEASE: $&#123;params.GITLAB_RELEASE&#125;\"</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// (7) 切换数据库版本(Jenkinsfile中使用)</span></span><br><span class=\"line\">            <span class=\"comment\">//sh label: 'checkout_version', script: '[ -n \"$&#123;RELEASE_VERSION&#125;\" ] &amp;&amp;  git checkout $&#123;RELEASE_VERSION&#125; || &#123; echo -e \"切换至指定的tag的版本 tag：$&#123;RELEASE_VERSION&#125; 不存在或为空，请检查输入的tag!\" &amp;&amp; exit 1; &#125;'</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">stage (<span class=\"string\">'代码检测'</span>) &#123;  </span><br><span class=\"line\">  <span class=\"comment\">// (8) 判断是否进行代码质量检测(满足则继续否则跳过)</span></span><br><span class=\"line\">  when &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果项目是回滚操作则不进行代码质量检测，然后当SONARQUBE参数为True时进行质量检测，否则不进行。</span></span><br><span class=\"line\">    expression &#123; <span class=\"keyword\">return</span> params.PREJECT_OPERATION != <span class=\"string\">\"rollback\"</span> &#125;</span><br><span class=\"line\">    anyOf &#123;</span><br><span class=\"line\">      environment <span class=\"string\">name:</span> <span class=\"string\">'SONARQUBE'</span>, <span class=\"string\">value:</span> <span class=\"string\">'True'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  steps &#123;</span><br><span class=\"line\">    script &#123;</span><br><span class=\"line\">    <span class=\"comment\">// (9) Tool 后的名称一定是对应全局工具配置中sonar扫描器的名字进行代码质量检测</span></span><br><span class=\"line\">      <span class=\"keyword\">def</span> sonarqubeScanner = tool <span class=\"string\">'Sonar-Scanner'</span>;</span><br><span class=\"line\">      withSonarQubeEnv(<span class=\"string\">credentialsId:</span> <span class=\"string\">\"$&#123;SONARQUBE_CREDENTIALSID&#125;\"</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 注意: 可以将sonarQube的属性定义在这里，也可以定义在项目文件中然后在这里引用配置文件</span></span><br><span class=\"line\">        sh <span class=\"string\">\"$&#123;sonarqubeScanner&#125;/bin/sonar-scanner \"</span> + </span><br><span class=\"line\">              <span class=\"string\">\"-Dsonar.projectName=$&#123;JOB_NAME&#125; \"</span> + </span><br><span class=\"line\">              <span class=\"string\">\"-Dsonar.projectKey=$&#123;SONARQUBE_PROJECTKEY&#125; \"</span> + </span><br><span class=\"line\">              <span class=\"string\">\"-Dsonar.projectVersion=$&#123;RELEASE_VERSION&#125; \"</span> + </span><br><span class=\"line\">              <span class=\"string\">\"-Dsonar.sourceEncoding=utf8  \"</span> + </span><br><span class=\"line\">              <span class=\"string\">\"-Dsonar.sources=.  \"</span> + </span><br><span class=\"line\">              <span class=\"string\">\"-Dsonar.language=java  \"</span> + </span><br><span class=\"line\">              <span class=\"string\">\"-Dsonar.java.binaries=.\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// (10) 暂停xxs等待sonarqube扫描反馈，根据实际时间进行调整; </span></span><br><span class=\"line\">        <span class=\"comment\">// NANOSECONDS SECONDS</span></span><br><span class=\"line\">        sleep <span class=\"string\">time:</span> <span class=\"string\">\"$&#123;SONARQUBE_TIMEOUT&#125;\"</span>, <span class=\"string\">unit:</span> <span class=\"string\">'SECONDS'</span></span><br><span class=\"line\">        <span class=\"comment\">// sh \"sleep $&#123;SONARQUBE_TIMEOUT&#125;\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 方式1</span></span><br><span class=\"line\">        <span class=\"comment\">// timeout(1) &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//     def qg = waitForQualityGate() </span></span><br><span class=\"line\">        <span class=\"comment\">//     if (qg.status != 'OK') &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//         error \"未通过Sonarqube的代码质量阈检查，请及时修改！failure: $&#123;qg.status&#125;\"</span></span><br><span class=\"line\">        <span class=\"comment\">//     &#125; else &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//         echo \"successful\"</span></span><br><span class=\"line\">        <span class=\"comment\">//     &#125;</span></span><br><span class=\"line\">        <span class=\"comment\">// &#125; </span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 方式2 (根据实际时间进行调整)</span></span><br><span class=\"line\">          timeout(<span class=\"string\">time:</span> <span class=\"number\">1</span>, <span class=\"string\">unit:</span> <span class=\"string\">'MINUTES'</span>) &#123;</span><br><span class=\"line\">            waitForQualityGate <span class=\"string\">abortPipeline:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码检测'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span>(Exception err) &#123;</span><br><span class=\"line\">          updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'代码检测'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">          unstable <span class=\"string\">'代码检测失败'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">  <span class=\"comment\">// (11) 项目构建打包处理</span></span><br><span class=\"line\">  stage (<span class=\"string\">\"项目构建\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 当操作为 PREJECT_OPERATION 为回滚(rollback) 时不进行构建打包</span></span><br><span class=\"line\">    when &#123;</span><br><span class=\"line\">      expression &#123; <span class=\"keyword\">return</span> params.PREJECT_OPERATION != <span class=\"string\">\"rollback\"</span> &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    steps &#123;</span><br><span class=\"line\">      script &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// Maven 配置依赖(动态配置)</span></span><br><span class=\"line\">          sh <span class=\"string\">script:</span> <span class=\"string\">\"curl -s -o settings.xml http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/raw/master/settings.xml\"</span></span><br><span class=\"line\">          sh <span class=\"string\">script:</span> <span class=\"string\">'/usr/local/maven/bin/mvn -s \"settings.xml\" clean install -Dmaven.test.skip=true'</span></span><br><span class=\"line\">          <span class=\"comment\">// 补充还可以采用此种方式进行更新流水线状态</span></span><br><span class=\"line\">          <span class=\"comment\">// gitlabCommitStatus(connection: gitLabConnection('Gitlab 用户认证凭据'),name: \"项目构建\") &#123; ... &#125;   </span></span><br><span class=\"line\">          updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'项目构建'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span>(Exception err) &#123;</span><br><span class=\"line\">          updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'项目构建'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">          unstable <span class=\"string\">'项目构建失败'</span> </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// (12) 进行开发测试部署</span></span><br><span class=\"line\">  stage (<span class=\"string\">\"项目部署\"</span>) &#123;</span><br><span class=\"line\">    steps &#123;</span><br><span class=\"line\">      script &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ssh 连接函数调用</span></span><br><span class=\"line\">        SERVER = getSSH() </span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 项目部署所用得资源清单以及</span></span><br><span class=\"line\">            sh <span class=\"string\">script:</span> <span class=\"string\">\"\"\"\\</span></span><br><span class=\"line\"><span class=\"string\">            curl -s http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/raw/master/$&#123;JOB_NAME&#125;.yaml | sed s#__APPNAME__#$&#123;APP_NAME&#125;#g &gt; ./$&#123;JOB_NAME&#125;.yaml &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">            wget http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/raw/master/options.sh -O options.sh</span></span><br><span class=\"line\"><span class=\"string\">            \"\"\"</span></span><br><span class=\"line\">            <span class=\"comment\">// ssh 插件调用</span></span><br><span class=\"line\">            sshPut <span class=\"string\">remote:</span> SERVER, <span class=\"string\">from:</span> <span class=\"string\">\"./$&#123;JOB_NAME&#125;.yaml\"</span> , <span class=\"string\">into:</span> <span class=\"string\">\"$&#123;APP_DIR&#125;$&#123;JOB_NAME&#125;.yaml\"</span></span><br><span class=\"line\">            <span class=\"comment\">// 部署脚本</span></span><br><span class=\"line\">            sh <span class=\"string\">script:</span> <span class=\"string\">\"chmod +x options.sh &amp;&amp; sh -x ./options.sh\"</span></span><br><span class=\"line\">            updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'测试部署'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">          &#125;<span class=\"keyword\">catch</span>(Exception err) &#123;</span><br><span class=\"line\">            updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'测试部署'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">            unstable <span class=\"string\">'部署失败'</span> <span class=\"comment\">// echo err.toString() </span></span><br><span class=\"line\">            error <span class=\"string\">\"[-Error] : 项目部署失败 \\n[-Msg] : $&#123;err.getMessage()&#125; \"</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// (13) 进行成品归档 archiveArtifacts </span></span><br><span class=\"line\">  stage(<span class=\"string\">'成品归档'</span>) &#123;</span><br><span class=\"line\">    when &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 当操作为 PREJECT_OPERATION 为rollback(回滚)时 且当 params.GITLAB_RELEASE 为False 时不进行成品归档</span></span><br><span class=\"line\">      expression &#123; <span class=\"keyword\">return</span> params.PREJECT_OPERATION != <span class=\"string\">\"rollback\"</span> &amp;&amp; params.GITLAB_RELEASE &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    steps &#123;</span><br><span class=\"line\">      script &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ! params.RELEASE_VERSION.contains(<span class=\"string\">\"master\"</span>) ) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Jenkins 归档</span></span><br><span class=\"line\">            archiveArtifacts <span class=\"string\">artifacts:</span> <span class=\"string\">\"$&#123;APP_FILE&#125;\"</span>, <span class=\"string\">onlyIfSuccessful:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Gitlab Token 用于 Gitlab - Release 版本分发</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> gitlab_token = getSecure(<span class=\"string\">\"$&#123;GITLAB_TOKEN&#125;\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 判断 Gitlab - Release 版本是否存在</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> gitlab_release = sh(<span class=\"string\">returnStatus:</span> <span class=\"literal\">true</span>, <span class=\"string\">script:</span> <span class=\"string\">\"sudo apk add jq &amp;&amp; curl -s --header 'PRIVATE-TOKEN: $&#123;gitlab_token&#125;' $&#123;GITLAB_REL&#125; | jq .[].tag_name | grep -c '$&#123;params.RELEASE_VERSION&#125;'\"</span>)</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// 上传得 Release Nginx web 根路径</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> gitlab_release_dir = <span class=\"string\">\"/nfsdisk-31/release/$&#123;JOB_NAME&#125;/\"</span></span><br><span class=\"line\">          </span><br><span class=\"line\">            echo gitlab_token + <span class=\"string\">\" --- \"</span> + gitlab_release + <span class=\"string\">\"=====\"</span>  + gitlab_release_dir + <span class=\"string\">\"---\"</span> </span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 根据 gitlab_release 变量判断是否进行release-cli 发布指定版本得 `Release`</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( gitlab_release != <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">              sshCommand <span class=\"string\">remote:</span> SERVER, <span class=\"string\">command:</span> <span class=\"string\">\"mkdir -p $&#123;gitlab_release_dir&#125;\"</span></span><br><span class=\"line\">              sshPut <span class=\"string\">remote:</span> SERVER, <span class=\"string\">from:</span> <span class=\"string\">\"./$&#123;APP_NAME&#125;\"</span> ,<span class=\"string\">into:</span> <span class=\"string\">\"$&#123;gitlab_release_dir&#125;$&#123;APP_NAME&#125;\"</span></span><br><span class=\"line\">              sh <span class=\"string\">script:</span> <span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">              /usr/local/bin/release-cli --server-url \"http://gitlab.weiyigeek.top\" --private-token \"$&#123;gitlab_token&#125;\" \\</span></span><br><span class=\"line\"><span class=\"string\">              --project-id $&#123;GITLAB_PROJECTID&#125;  create \\</span></span><br><span class=\"line\"><span class=\"string\">              --name \"$&#123;JOB_NAME&#125;-$&#123;params.RELEASE_VERSION&#125;\" \\</span></span><br><span class=\"line\"><span class=\"string\">              --tag-name \"$&#123;params.RELEASE_VERSION&#125;\" \\</span></span><br><span class=\"line\"><span class=\"string\">              --description \"此 $&#123;JOB_NAME&#125; 项目 $&#123;params.RELEASE_VERSION&#125;版本 来自 Jenkins Build 编译构建上传。\" \\</span></span><br><span class=\"line\"><span class=\"string\">              --assets-link '&#123;\"name\": \"$&#123;APP_NAME&#125;\",\"url\":\"$&#123;GITLAB_DOWNLOAD&#125;\",\"link_type\":\"other\"&#125;'</span></span><br><span class=\"line\"><span class=\"string\">              \"\"\"</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              echo <span class=\"string\">\"[-Tips] :  Gitlab Release 中已存在 $&#123;params.GITLAB_RELEASE&#125; 版本, 将不会提交该Release到Gitlab中\"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'成品归档'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (Exception err) &#123;</span><br><span class=\"line\">            updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'成品归档'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">            echo err.toString()  </span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            echo <span class=\"string\">\"# 版本不能为 $&#123;param.RELEASE_VERSION&#125; , 将不会进行归档!\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// (12) POST阶段当所有任务执行后触发进行工作空间的清理以及消息通知;</span></span><br><span class=\"line\">  post &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 无论如何，我已经完成了 无论成功与否都将执行</span></span><br><span class=\"line\">    always &#123;</span><br><span class=\"line\">      script &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 企业微信消息通知</span></span><br><span class=\"line\">        <span class=\"keyword\">def</span> GIT_COMMIT=sh <span class=\"string\">returnStdout:</span> <span class=\"literal\">true</span>, <span class=\"string\">script:</span> <span class=\"string\">\"git show --oneline --ignore-all-space --text | head -n 1\"</span></span><br><span class=\"line\">        qyWechatNotification <span class=\"string\">aboutSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">failNotify:</span> <span class=\"literal\">true</span>, <span class=\"string\">failSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">mentionedMobile:</span> <span class=\"string\">''</span>, <span class=\"string\">startBuild:</span> <span class=\"literal\">true</span>, <span class=\"string\">successSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">unstableSend:</span> <span class=\"literal\">true</span>, <span class=\"string\">webhookUrl:</span> <span class=\"string\">\"$&#123;env.QYWX_WEBHOOK&#125;\"</span></span><br><span class=\"line\">        sh <span class=\"string\">\"\"\"\\</span></span><br><span class=\"line\"><span class=\"string\">        curl -s $&#123;env.QYWX_WEBHOOK&#125; \\</span></span><br><span class=\"line\"><span class=\"string\">        -H 'Content-Type: application/json' \\</span></span><br><span class=\"line\"><span class=\"string\">        -d '</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">          \"msgtype\": \"text\",</span></span><br><span class=\"line\"><span class=\"string\">          \"text\": &#123;</span></span><br><span class=\"line\"><span class=\"string\">              \"content\": \"项目: $&#123;env.SONARQUBE_PROJECTKEY&#125;, 版本: $&#123;params.RELEASE_VERSION&#125;, 操作: $&#123;params.PREJECT_OPERATION&#125; , 信息: $&#123;GIT_COMMIT&#125;, Gitlab-Release 发布： $&#123;params.GITLAB_RELEASE&#125;, 部署地址: $&#123;env.KS8_ADDRESS&#125;\"</span></span><br><span class=\"line\"><span class=\"string\">          &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;'</span></span><br><span class=\"line\"><span class=\"string\">      \"\"\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      deleteDir()  <span class=\"comment\">/* clean up our workspace */</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    success &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'[-Info] : I succeeeded! - 任务成功'</span></span><br><span class=\"line\">      updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'消息通知'</span>, <span class=\"string\">state:</span> <span class=\"string\">'success'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    unstable &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'[-Info] : I am unstable - 不稳定 :/'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    failure &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'[-Info] : I failed - 任务失败 :( '</span></span><br><span class=\"line\">      updateGitlabCommitStatus <span class=\"string\">name:</span> <span class=\"string\">'消息通知'</span>, <span class=\"string\">state:</span> <span class=\"string\">'failed'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    changed &#123;</span><br><span class=\"line\">      echo <span class=\"string\">'[-Info] : Things were different before - 与以前的情况不一样...'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"3-Shell-部署脚本\"><a href=\"#3-Shell-部署脚本\" class=\"headerlink\" title=\"(3) Shell 部署脚本\"></a>(3) Shell 部署脚本</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"comment\"># // 基础变量</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> K8sMaster=<span class=\"string\">\"<span class=\"variable\">$&#123;DEPLOY_USER&#125;</span>@<span class=\"variable\">$&#123;DEPLOY_HOST&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> AppName=<span class=\"string\">\"<span class=\"variable\">$&#123;APP_FILE##*/&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> FindAppName=$(find <span class=\"variable\">$&#123;WORKSPACE&#125;</span> -maxdepth 2 -<span class=\"built_in\">type</span> f -name <span class=\"variable\">$&#123;AppName&#125;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># // 若操作值不为rollback则执行该判断代码块中的内容。</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [<span class=\"variable\">$&#123;PREJECT_OPERATION&#125;</span> != <span class=\"string\">\"rollback\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$&#123;FindAppName&#125;</span>\"</span> != <span class=\"string\">\"\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"[-Msg]: <span class=\"variable\">$&#123;FindAppName&#125;</span> ./<span class=\"variable\">$&#123;APP_NAME&#125;</span> Copying....\"</span></span><br><span class=\"line\">    cp -rf <span class=\"variable\">$&#123;FindAppName&#125;</span> ./<span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"[-Error]: FindAppName param error!\"</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># // 判断应用文件是否存在与共享目录中</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">judge</span></span> () &#123;</span><br><span class=\"line\">  <span class=\"built_in\">export</span> ExistResult=$(ssh -p <span class=\"variable\">$&#123;DEPLOY_PORT&#125;</span> <span class=\"variable\">$&#123;K8sMaster&#125;</span> <span class=\"string\">\"ls <span class=\"variable\">$&#123;APP_DIR&#125;</span> | grep <span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span> | wc -l\"</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># // 部署操作函数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">deploy</span></span> () &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;ExistResult&#125;</span> -eq 0 || <span class=\"string\">\"<span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span>\"</span> == <span class=\"string\">\"master\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    scp -P <span class=\"variable\">$&#123;DEPLOY_PORT&#125;</span> <span class=\"string\">\"<span class=\"variable\">$&#123;APP_NAME&#125;</span>\"</span> <span class=\"variable\">$&#123;K8sMaster&#125;</span>:<span class=\"variable\">$&#123;APP_DIR&#125;</span><span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"[-Msg]: /<span class=\"variable\">$&#123;APP_NAME&#125;</span> current Deploy.....\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 部署脚本</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span>\"</span> == <span class=\"string\">\"master\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    ssh -p <span class=\"variable\">$&#123;DEPLOY_PORT&#125;</span> <span class=\"variable\">$&#123;K8sMaster&#125;</span> <span class=\"string\">\"kubectl -n <span class=\"variable\">$&#123;K8S_NAMESPACE&#125;</span> delete pod -l <span class=\"variable\">$&#123;K8S_SELECTOR&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    ssh -p <span class=\"variable\">$&#123;DEPLOY_PORT&#125;</span> <span class=\"variable\">$&#123;K8sMaster&#125;</span> <span class=\"string\">\"kubectl apply -f <span class=\"variable\">$&#123;APP_DIR&#125;</span><span class=\"variable\">$&#123;JOB_NAME&#125;</span>.yaml\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># // 回退操作函数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">rollback</span></span> () &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;ExistResult&#125;</span> -ne 0 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    ssh -p <span class=\"variable\">$&#123;DEPLOY_PORT&#125;</span> <span class=\"variable\">$&#123;K8sMaster&#125;</span> <span class=\"string\">\"kubectl apply -f <span class=\"variable\">$&#123;APP_DIR&#125;</span><span class=\"variable\">$&#123;JOB_NAME&#125;</span>.yaml\"</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">\"[-Eroor]: /<span class=\"variable\">$&#123;APP_NAME&#125;</span> version not exsit.....\"</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># // 重部署操作函数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">redeploy</span></span> () &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 如果是以前部署过则删除以前部署的项目目录,否则重新部署;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"v<span class=\"variable\">$&#123;GIT_COMMIT&#125;</span>\"</span> = <span class=\"string\">\"v<span class=\"variable\">$&#123;GIT_PREVIOUS_SUCCESSFUL_COMMIT&#125;</span>\"</span> || <span class=\"variable\">$&#123;ExistResult&#125;</span> -gt 0 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> -e <span class=\"string\">\"[-Message]:  <span class=\"variable\">$&#123;RELEASE_VERSION&#125;</span> Version Exsit !\"</span></span><br><span class=\"line\">    ssh -p <span class=\"variable\">$&#123;DEPLOY_PORT&#125;</span> <span class=\"variable\">$&#123;K8sMaster&#125;</span> <span class=\"string\">\"find <span class=\"variable\">$&#123;APP_DIR&#125;</span> -d -maxdepth 1 -type f -name <span class=\"variable\">$&#123;APP_NAME&#125;</span>\"</span></span><br><span class=\"line\">    scp -P <span class=\"variable\">$&#123;DEPLOY_PORT&#125;</span> <span class=\"string\">\"<span class=\"variable\">$&#123;APP_NAME&#125;</span>\"</span> <span class=\"variable\">$&#123;K8sMaster&#125;</span>:<span class=\"variable\">$&#123;APP_DIR&#125;</span><span class=\"variable\">$&#123;APP_NAME&#125;</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 触发重新部署脚本</span></span><br><span class=\"line\">  deploy</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># // 判断是否存在历史版本</span></span><br><span class=\"line\">judge</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主操作入口判断</span></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"variable\">$&#123;PREJECT_OPERATION&#125;</span> <span class=\"keyword\">in</span></span><br><span class=\"line\"><span class=\"string\">\"deploy\"</span>)</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"1.deploy\"</span></span><br><span class=\"line\">  deploy</span><br><span class=\"line\">;;</span><br><span class=\"line\"><span class=\"string\">\"rollback\"</span>)</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"2.rollback\"</span></span><br><span class=\"line\">  rollback</span><br><span class=\"line\">;;</span><br><span class=\"line\"><span class=\"string\">\"redeploy\"</span>)</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"3.redeploy\"</span></span><br><span class=\"line\">  redeploy</span><br><span class=\"line\">;;</span><br><span class=\"line\">*)</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"[-Error] : <span class=\"variable\">$&#123;PREJECT_OPERATION&#125;</span> Param Error not in deploy/rollback/redeploy !\"</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"4-效果预览\"><a href=\"#4-效果预览\" class=\"headerlink\" title=\"(4) 效果预览\"></a>(4) 效果预览</h3><ul>\n<li>Step 1.在<code>BlueOcean</code>进行构建部署参数选择。<br>描述: 我们可以进行初次部署回滚以及重新构建部署,还包括代码质量检测以及成品自动归档的选择控制。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210317174011.png\" alt=\"WeiyiGeek.BlueOcean部署\" title=\"\" class=\"\">\n                <p>WeiyiGeek.BlueOcean部署</p>\n            </figure>\n<ul>\n<li>Step 2.在K8s集群中进行查看Pod迭代变化。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/nfsdisk-31/<span class=\"built_in\">test</span><span class=\"comment\"># kubectl get pod --watch</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                      READY   STATUS        RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-0                       1/1     Running       0          83s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-1                       1/1     Running       0          80s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-2                       1/1     Terminating   0          76s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-2                       0/1     Terminating   0          106s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-2                       0/1     Pending       0          0s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-2                       0/1     ContainerCreating   0          0s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-2                       1/1     Running             0          2s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-1                       1/1     Terminating         0          112s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-1                       0/1     Terminating         0          2m26s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-1                       0/1     Pending             0          0s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-1                       0/1     ContainerCreating   0          0s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-1                       1/1     Running             0          3s</span></span><br><span class=\"line\">  <span class=\"comment\"># deploy-java-maven-0                       1/1     Terminating         0          2m32s</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210317113540.png\" alt=\"WeiyiGeek.实验效果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.实验效果</p>\n            </figure>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"DevOps","path":"api/categories/DevOps.json"},{"name":"CI-CD","path":"api/categories/CI-CD.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"}]}