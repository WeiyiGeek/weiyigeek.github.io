{"title":"1.Goè¯­è¨€é¡¹ç›®æ€§èƒ½è°ƒä¼˜å®è·µ","slug":"ç¼–ç¨‹ä¸–ç•Œ/Go/Extension/1.Goè¯­è¨€é¡¹ç›®æ€§èƒ½è°ƒä¼˜å®è·µ","date":"2020-04-26T03:16:58.000Z","updated":"2023-01-31T02:29:10.673Z","url":"2020/4-26-605.html","path":"api/articles/2020/4-26-605.html.json","covers":["https://img.weiyigeek.top/2021/5/20211127145003.png","https://img.weiyigeek.top/2021/5/20211129113617.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-å‰è¨€ç®€è¿°\"><a href=\"#0x00-å‰è¨€ç®€è¿°\" class=\"headerlink\" title=\"0x00 å‰è¨€ç®€è¿°\"></a>0x00 å‰è¨€ç®€è¿°</h2><p>åœ¨è®¡ç®—æœºæ€§èƒ½è°ƒè¯•é¢†åŸŸé‡Œ <code>profiling</code> æ˜¯æŒ‡å¯¹åº”ç”¨ç¨‹åºçš„ç”»åƒï¼Œç”»åƒå°±æ˜¯åº”ç”¨ç¨‹åºä½¿ç”¨ CPU å’Œå†…å­˜çš„æƒ…å†µã€‚ </p>\n<p>Goè¯­è¨€æ˜¯ä¸€ä¸ªå¯¹æ€§èƒ½ç‰¹åˆ«çœ‹é‡çš„è¯­è¨€ï¼Œæ‰€ä»¥å…¶è‡ªå¸¦äº† profiling çš„åº“ï¼Œæœ¬ç« å°†ä¸»è¦è®²è§£æ€ä¹ˆåœ¨ golang ä¸­åš profilingã€‚</p>\n<p><br/></p>\n<p>Goè¯­è¨€é¡¹ç›®ä¸­çš„æ€§èƒ½ä¼˜åŒ–ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š<br><code>CPU profile</code>ï¼šæŠ¥å‘Šç¨‹åºçš„ CPU ä½¿ç”¨æƒ…å†µï¼ŒæŒ‰ç…§ä¸€å®šé¢‘ç‡å»é‡‡é›†åº”ç”¨ç¨‹åºåœ¨ CPU å’Œå¯„å­˜å™¨ä¸Šé¢çš„æ•°æ®ã€‚<br><code>Memory Profileï¼ˆHeap Profileï¼‰</code>ï¼šæŠ¥å‘Šç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚<br><code>Block Profiling</code>ï¼šæŠ¥å‘Š goroutines ä¸åœ¨è¿è¡ŒçŠ¶æ€çš„æƒ…å†µï¼Œå¯ä»¥ç”¨æ¥åˆ†æå’ŒæŸ¥æ‰¾æ­»é”ç­‰æ€§èƒ½ç“¶é¢ˆã€‚<br><code>Goroutine Profiling</code>ï¼šæŠ¥å‘Š goroutines çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠ goroutineè°ƒç”¨å…³ç³»ã€‚</p>\n<p><br></p>\n<p><strong>Q: é‚£å¦‚ä½•è¿›è¡Œç¨‹åºæ€§èƒ½æ•°æ®çš„é‡‡é›†?</strong><br>Goè¯­è¨€å†…ç½®äº†è·å–ç¨‹åºçš„è¿è¡Œæ•°æ®çš„å·¥å…·ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¸¤ä¸ªæ ‡å‡†åº“ï¼š</p>\n<ul>\n<li><code>runtime/pprof</code>ï¼šé‡‡é›†<code>å·¥å…·å‹åº”ç”¨</code>è¿è¡Œæ•°æ®è¿›è¡Œåˆ†æ</li>\n<li><code>net/http/pprof</code>ï¼šé‡‡é›†<code>æœåŠ¡å‹åº”ç”¨</code>è¿è¡Œæ—¶æ•°æ®è¿›è¡Œåˆ†æ</li>\n</ul>\n<p>Tips: å½“pprofè¢«å¼•ç”¨å¼€å¯åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆ10msï¼‰å°±ä¼šæ”¶é›†ä¸‹å½“å‰çš„å †æ ˆä¿¡æ¯ï¼Œè·å–å„ä¸ªå‡½æ•°å ç”¨çš„CPUä»¥åŠå†…å­˜èµ„æºï¼›æœ€åé€šè¿‡å¯¹è¿™äº›é‡‡æ ·æ•°æ®è¿›è¡Œåˆ†æï¼Œå½¢æˆä¸€ä¸ªæ€§èƒ½åˆ†ææŠ¥å‘Šã€‚</p>\n<p>Tips: é€šå¸¸åœ¨æˆ‘ä»¬è¿›è¡Œæ€§èƒ½æµ‹è¯•æ—¶ä¼šä¸åŸºå‡†æµ‹è¯•è”ç”¨ï¼Œæ‰¾å‡ºç¨‹åºæœ€éœ€è¦ä¼˜åŒ–çš„ç‚¹ï¼Œã€éå¸¸æ³¨æ„ã€‘æˆ‘ä»¬åªåœ¨è¿›è¡Œæ€§èƒ½æµ‹è¯•çš„æ—¶å€™æ‰åœ¨ä»£ç ä¸­å¼•å…¥pprofã€‚</p>\n<p><br/></p>\n<h2 id=\"0x01-æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ\"><a href=\"#0x01-æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ\" class=\"headerlink\" title=\"0x01 æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ\"></a>0x01 æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ</h2><h3 id=\"1-å·¥å…·å‹åº”ç”¨\"><a href=\"#1-å·¥å…·å‹åº”ç”¨\" class=\"headerlink\" title=\"1.å·¥å…·å‹åº”ç”¨\"></a>1.å·¥å…·å‹åº”ç”¨</h3><p>æè¿°: å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ˜¯è¿è¡Œä¸€æ®µæ—¶é—´å°±ç»“æŸé€€å‡ºç±»å‹ã€‚é‚£ä¹ˆæœ€å¥½çš„åŠæ³•æ˜¯åœ¨åº”ç”¨é€€å‡ºçš„æ—¶å€™æŠŠ profiling çš„æŠ¥å‘Šä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œè¿›è¡Œåˆ†æã€‚å¯¹äºè¿™ç§æƒ…å†µå¯ä»¥ä½¿ç”¨runtime/pprofåº“ã€‚</p>\n<p>é¦–å…ˆåœ¨ä½ æµ‹è¯•çš„ä»£ç ä¸­å¯¼å…¥<code>runtime/pprof</code>å·¥å…·: <code>import &quot;runtime/pprof&quot;</code>, å…¶ä¸»è¦åŒ…å«äº†CPU å’Œ å†…å­˜ç­‰æ€§èƒ½åˆ†æã€‚</p>\n<p><strong>CPUæ€§èƒ½åˆ†æ:</strong> å®ƒä¼šåœ¨åº”ç”¨æ‰§è¡Œç»“æŸåç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜äº†ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ <code>CPU profiling</code> æ•°æ®, å¾—åˆ°é‡‡æ ·æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>go tool pprof</code>å·¥å…·è¿›è¡ŒCPUæ€§èƒ½åˆ†æã€‚<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// å¼€å¯CPUæ€§èƒ½åˆ†æï¼š</span></span><br><span class=\"line\">pprof.StartCPUProfile(w io.Writer)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// åœæ­¢CPUæ€§èƒ½åˆ†æï¼š</span></span><br><span class=\"line\">pprof.StopCPUProfile()</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>å†…å­˜æ€§èƒ½ä¼˜åŒ–</strong> å¾—åˆ°é‡‡æ ·æ•°æ®ä¹‹åï¼Œä½¿ç”¨go tool pprofå·¥å…·è¿›è¡Œå†…å­˜æ€§èƒ½åˆ†æã€‚<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// è®°å½•ç¨‹åºçš„å †æ ˆä¿¡æ¯</span></span><br><span class=\"line\">pprof.WriteHeapProfile(w io.Writer)</span><br></pre></td></tr></table></figure></p>\n<p>Tips: é»˜è®¤å®ƒæ˜¯ä½¿ç”¨<code>-inuse_space</code>è¿›è¡Œç»Ÿè®¡ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>-inuse-objects</code>æŸ¥çœ‹åˆ†é…å¯¹è±¡çš„æ•°é‡ã€‚</p>\n<p><br></p>\n<h3 id=\"2-æœåŠ¡å‹åº”ç”¨\"><a href=\"#2-æœåŠ¡å‹åº”ç”¨\" class=\"headerlink\" title=\"2.æœåŠ¡å‹åº”ç”¨\"></a>2.æœåŠ¡å‹åº”ç”¨</h3><p>æè¿°: å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ˜¯ä¸€ç›´è¿è¡Œçš„ï¼Œæ¯”å¦‚ web åº”ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨net/http/pprofåº“ï¼Œå®ƒèƒ½å¤Ÿåœ¨æä¾› HTTP æœåŠ¡è¿›è¡Œåˆ†æã€‚</p>\n<p>é¦–å…ˆï¼Œä½ éœ€è¦åœ¨<code>web server</code>ç«¯ä»£ç ä¸­æŒ‰å¦‚ä¸‹æ–¹å¼å¯¼å…¥<code>net/http/pprof</code>, ä¾‹å¦‚ <code>import _ &quot;net/http/pprof&quot;</code>, å®ƒè¡¨ç¤ºåªåŠ è½½initæ–¹æ³•è€Œä¸æ˜¯ä½¿ç”¨å…¶çš„æ–¹æ³•ã€‚</p>\n<p>å¦‚æœä½ çš„<code>Web Server</code>ä½¿ç”¨äº†é»˜è®¤çš„ <code>http.DefaultServeMux</code> é€šå¸¸æ˜¯ä»£ç ç›´æ¥ä½¿ç”¨ `http.ListenAndServe(â€œ0.0.0.0:8000â€, nil) , æŒ‰ç…§ä¸Šè¿°è¦æ±‚å¯¼å…¥å³å¯ã€‚</p>\n<p>å¦‚æœä½ ä½¿ç”¨è‡ªå®šä¹‰çš„ Muxï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ³¨å†Œä¸€äº›è·¯ç”±è§„åˆ™ï¼š<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">r.HandleFunc(<span class=\"string\">\"/debug/pprof/\"</span>, pprof.Index)</span><br><span class=\"line\">r.HandleFunc(<span class=\"string\">\"/debug/pprof/cmdline\"</span>, pprof.Cmdline)</span><br><span class=\"line\">r.HandleFunc(<span class=\"string\">\"/debug/pprof/profile\"</span>, pprof.Profile)</span><br><span class=\"line\">r.HandleFunc(<span class=\"string\">\"/debug/pprof/symbol\"</span>, pprof.Symbol)</span><br><span class=\"line\">r.HandleFunc(<span class=\"string\">\"/debug/pprof/trace\"</span>, pprof.Trace)</span><br></pre></td></tr></table></figure></p>\n<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ginæ¡†æ¶ï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨<code>github.com/gin-contrib/pprof</code>ï¼Œåœ¨ä»£ç ä¸­é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ³¨å†Œpprofç›¸å…³è·¯ç”±: <code>pprof.Register(router)</code></p>\n<p>Tips: æ€»ä¹‹,ä¸ç®¡æ˜¯é‚£ç§æ–¹å¼ï¼Œä½ çš„ HTTP æœåŠ¡éƒ½æ‹¥æœ‰<code>/debug/pprof</code> endpointï¼Œè®¿é—®å®ƒä¼šå¾—åˆ°Serverç«¯ç¨‹åºç›¸å…³çš„Allocsã€Goroutineä»¥åŠHeapç­‰ä¿¡æ¯ï¼š </p>\n<ul>\n<li><code>/debug/pprof/profile</code>ï¼šCPU profilingçš„è·¯å¾„ï¼Œè®¿é—®æ­¤é“¾æ¥ä¼šæŒç»­è®°å½• 30så¹¶ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ä¾›ä¸‹è½½ã€‚</li>\n<li><code>/debug/pprof/heap</code>ï¼š Memory Profiling çš„è·¯å¾„ï¼Œè®¿é—®è¿™ä¸ªé“¾æ¥ä¼šå¾—åˆ°ä¸€ä¸ªå†…å­˜ Profiling ç»“æœçš„æ–‡ä»¶ã€‚</li>\n<li><code>/debug/pprof/block</code>ï¼šblock Profiling çš„è·¯å¾„</li>\n<li><code>/debug/pprof/goroutines</code>ï¼šè®°å½•è¿è¡Œçš„ goroutines åˆ—è¡¨ï¼Œä»¥åŠè°ƒç”¨å…³ç³»ã€‚</li>\n</ul>\n<p><br></p>\n<h3 id=\"3-pprof-å‘½ä»¤è¯­æ³•\"><a href=\"#3-pprof-å‘½ä»¤è¯­æ³•\" class=\"headerlink\" title=\"3.pprof å‘½ä»¤è¯­æ³•\"></a>3.pprof å‘½ä»¤è¯­æ³•</h3><p>æè¿°: ä¸ç®¡æ˜¯å·¥å…·å‹åº”ç”¨è¿˜æ˜¯æœåŠ¡å‹åº”ç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åº”çš„pprofåº“è·å–æ•°æ®ä¹‹åï¼Œä¸‹ä¸€æ­¥çš„éƒ½è¦å¯¹è¿™äº›æ•°æ®è¿›è¡Œåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>go tool pprof</code>å‘½ä»¤è¡Œå·¥å…·ã€‚</p>\n<p>go tool pprof æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ä¸º <code>go tool pprof [binary] [source]</code> ,å…¶ä¸­</p>\n<ul>\n<li>binary æ˜¯åº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨æ¥è§£æå„ç§ç¬¦å·ï¼›</li>\n<li>source è¡¨ç¤º profile æ•°æ®çš„æ¥æºï¼Œå¯ä»¥æ˜¯æœ¬åœ°çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ http åœ°å€ã€‚</li>\n</ul>\n<p>Tips: éå¸¸æ³¨æ„è·å–çš„ Profiling æ•°æ®æ˜¯åŠ¨æ€çš„ï¼Œè¦æƒ³è·å¾—æœ‰æ•ˆçš„æ•°æ®ï¼Œè¯·ä¿è¯åº”ç”¨å¤„äºè¾ƒå¤§çš„è´Ÿè½½ï¼ˆæ¯”å¦‚æ­£åœ¨ç”Ÿæˆä¸­è¿è¡Œçš„æœåŠ¡ï¼Œæˆ–è€…é€šè¿‡å…¶ä»–å·¥å…·æ¨¡æ‹Ÿè®¿é—®å‹åŠ›ï¼‰ã€‚<code>å¦‚æœåº”ç”¨å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¾—åˆ°çš„ç»“æœå¯èƒ½æ²¡æœ‰ä»»ä½•æ„ä¹‰</code>ã€‚</p>\n<p><br></p>\n<p><strong>pprofä¸æ€§èƒ½æµ‹è¯•ç»“åˆ</strong><br>æè¿°: go test, å‘½ä»¤æœ‰ä¸¤ä¸ªå‚æ•°å’Œ pprof ç›¸å…³ï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å®šç”Ÿæˆçš„ <code>CPU å’Œ Memory profiling</code> ä¿å­˜çš„æ–‡ä»¶ï¼š</p>\n<ul>\n<li>-cpuprofileï¼šcpu profiling æ•°æ®è¦ä¿å­˜çš„æ–‡ä»¶åœ°å€</li>\n<li>-memprofileï¼šmemory profiling æ•°æ®è¦æŠ¥æ–‡çš„æ–‡ä»¶åœ°å€</li>\n</ul>\n<p>æ¯”å¦‚ä¸‹é¢æ‰§è¡Œæµ‹è¯•çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ‰§è¡Œ CPU profilingï¼Œå¹¶æŠŠç»“æœä¿å­˜åœ¨ cpu.prof æ–‡ä»¶ä¸­ï¼š<code>go test -bench . -cpuprofile=cpu.prof</code></p>\n<p>æ¯”å¦‚ä¸‹é¢æ‰§è¡Œæµ‹è¯•çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ‰§è¡Œ Mem profilingï¼Œå¹¶æŠŠç»“æœä¿å­˜åœ¨ cpu.prof æ–‡ä»¶ä¸­ï¼š<code>go test -bench . -memprofile=./mem.prof</code></p>\n<p>Tips: ç‰¹åˆ«æ³¨æ„Profiling ä¸€èˆ¬å’Œæ€§èƒ½æµ‹è¯•ä¸€èµ·ä½¿ç”¨,åœ¨å‰æ–‡æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼Œåªæœ‰åº”ç”¨åœ¨è´Ÿè½½é«˜çš„æƒ…å†µä¸‹ Profiling æ‰æœ‰æ„ä¹‰ã€‚<br><br></p>\n<p><strong>å®è·µæ¡ˆä¾‹:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">âœ go <span class=\"built_in\">test</span> -bench . -cpuprofile=cpu.prof</span><br><span class=\"line\">  <span class=\"comment\"># goos: linux</span></span><br><span class=\"line\">  <span class=\"comment\"># goarch: amd64</span></span><br><span class=\"line\">  <span class=\"comment\"># pkg: weiyigeek.top/studygo/Day08/07perfomance/testdemo</span></span><br><span class=\"line\">  <span class=\"comment\"># cpu: Intel(R) Core(TM) i5-3570 CPU @ 3.40GHz</span></span><br><span class=\"line\">  <span class=\"comment\"># BenchmarkFib1-4           365628              3098 ns/op</span></span><br><span class=\"line\">  <span class=\"comment\"># BenchmarkFibOpt1-4        592876              1946 ns/op</span></span><br><span class=\"line\">  <span class=\"comment\"># BenchmarkFib2-4             4468            230122 ns/op</span></span><br><span class=\"line\">  <span class=\"comment\"># BenchmarkFibOpt2-4          8101            142212 ns/op</span></span><br><span class=\"line\">  <span class=\"comment\"># PASS</span></span><br><span class=\"line\">  <span class=\"comment\"># ok      weiyigeek.top/studygo/Day08/07perfomance/testdemo       4.720s</span></span><br><span class=\"line\"></span><br><span class=\"line\">âœ go tool pprof cpu.prof   </span><br><span class=\"line\">  <span class=\"comment\"># File: testdemo.test</span></span><br><span class=\"line\">  <span class=\"comment\"># Type: cpu</span></span><br><span class=\"line\">  <span class=\"comment\"># Time: Nov 29, 2021 at 10:58am (CST)</span></span><br><span class=\"line\">  <span class=\"comment\"># Duration: 4.72s, Total samples = 4.58s (97.12%)</span></span><br><span class=\"line\">  <span class=\"comment\"># Entering interactive mode (type \"help\" for commands, \"o\" for options)</span></span><br><span class=\"line\">  <span class=\"comment\"># (pprof) top3</span></span><br><span class=\"line\">  <span class=\"comment\"># Showing nodes accounting for 4.55s, 99.34% of 4.58s total</span></span><br><span class=\"line\">  <span class=\"comment\"># Dropped 31 nodes (cum &lt;= 0.02s)</span></span><br><span class=\"line\">  <span class=\"comment\"># Showing top 3 nodes out of 10</span></span><br><span class=\"line\">  <span class=\"comment\">#       flat  flat%   sum%        cum   cum%</span></span><br><span class=\"line\">  <span class=\"comment\">#     4.55s 99.34% 99.34%      4.55s 99.34%  weiyigeek.top/studygo/Day08/07perfomance/testdemo.calcStep</span></span><br><span class=\"line\">  <span class=\"comment\">#         0     0% 99.34%      4.56s 99.56%  testing.(*B).launch</span></span><br><span class=\"line\">  <span class=\"comment\">#         0     0% 99.34%      4.57s 99.78%  testing.(*B).runN</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"4-ç®€å•ç¤ºä¾‹\"><a href=\"#4-ç®€å•ç¤ºä¾‹\" class=\"headerlink\" title=\"4.ç®€å•ç¤ºä¾‹\"></a>4.ç®€å•ç¤ºä¾‹</h3><p><strong>ç¤ºä¾‹1.é¦–å…ˆæˆ‘ä»¬æ¥å†™ä¸€æ®µæœ‰é—®é¢˜çš„ä»£ç </strong><br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// weiyigeek.top/studygo/Day08/07perfomance/pporftest/main.go</span></span><br><span class=\"line\"><span class=\"comment\">// è¿›è¡ŒGoè¯­è¨€æ€§èƒ½æµ‹è¯•çš„ç”¨ä¾‹ä»£ç ã€‚</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">  <span class=\"string\">\"flag\"</span></span><br><span class=\"line\">  <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">  <span class=\"string\">\"os\"</span></span><br><span class=\"line\">  <span class=\"string\">\"runtime/pprof\"</span></span><br><span class=\"line\">  <span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// logicCode å‡½æ•°ä¸­åŒ…å«ä¸€æ®µæœ‰é—®é¢˜çš„ä»£ç </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">logicCode</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> c <span class=\"keyword\">chan</span> <span class=\"keyword\">int</span> <span class=\"comment\">// æœªå¯¹é€šé“cè¿›è¡Œåˆå§‹åŒ– make(chan int)</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> v := &lt;-c: <span class=\"comment\">// æ­¤æ—¶å¤„äºé˜»å¡çš„çŠ¶æ€</span></span><br><span class=\"line\">      fmt.Printf(<span class=\"string\">\"recv from chan, value:%v\\n\"</span>, v)</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">      <span class=\"comment\">// time.Sleep(time.Second)  // é—®é¢˜è§£å†³åŠæ³•</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// main æ€§èƒ½æµ‹è¯•å…¥å£å‡½æ•°</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// å¼€å‘è§„èŒƒä¸€è‡´æ€§</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> (</span><br><span class=\"line\">    isCPUPprof, isMemPprof <span class=\"keyword\">bool</span></span><br><span class=\"line\">  )</span><br><span class=\"line\">  <span class=\"comment\">// flagåŒ…ä¸»è¦æ¥æ”¶å‘½ä»¤è¡Œå‚æ•°ä»¥åŠè§£æï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œæ§åˆ¶æ˜¯å¦å¼€å¯CPUå’ŒMemçš„æ€§èƒ½åˆ†æ</span></span><br><span class=\"line\">  flag.BoolVar(&amp;isCPUPprof, <span class=\"string\">\"cpu\"</span>, <span class=\"literal\">false</span>, <span class=\"string\">\"turn cpu pprof on\"</span>)</span><br><span class=\"line\">  flag.BoolVar(&amp;isMemPprof, <span class=\"string\">\"mem\"</span>, <span class=\"literal\">false</span>, <span class=\"string\">\"turn mem pprof on\"</span>)</span><br><span class=\"line\">  flag.Parse()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// æ˜¯å¦è¿›è¡ŒCPUå¿ƒç†æµ‹è¯•</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> isCPUPprof &#123;</span><br><span class=\"line\">    <span class=\"comment\">// åœ¨å½“å‰å¯æ‰§è¡Œç¨‹åºä¸‹åˆ›å»ºä¸€ä¸ªcpu.pprofæ–‡ä»¶</span></span><br><span class=\"line\">    f1, err := os.Create(<span class=\"string\">\"./cpu.pprof\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">      fmt.Printf(<span class=\"string\">\"create cpu pprof failed, err:%v\\n\"</span>, err)</span><br><span class=\"line\">      <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// å¾€æ–‡ä»¶ä¸­è®°å½•CPU Profileä¿¡æ¯</span></span><br><span class=\"line\">    pprof.StartCPUProfile(f1)</span><br><span class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">      pprof.StopCPUProfile()</span><br><span class=\"line\">      f1.Close()</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// è¿›è¡Œæ€§èƒ½æµ‹è¯•çš„å‡½æ•°è°ƒç”¨ï¼Œæ­¤å¤„æ—¶å¹¶å‘</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++ &#123;</span><br><span class=\"line\">    <span class=\"keyword\">go</span> logicCode()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  time.Sleep(<span class=\"number\">20</span> * time.Second)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// æ˜¯å¦è¿›è¡Œå†…å­˜åˆ†æ?</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> isMemPprof &#123;</span><br><span class=\"line\">    f2, err := os.Create(<span class=\"string\">\"./mem.pprof\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">      fmt.Printf(<span class=\"string\">\"create mem pprof failed, err:%v\\n\"</span>, err)</span><br><span class=\"line\">      <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    pprof.WriteHeapProfile(f2)</span><br><span class=\"line\">    f2.Close()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>ç¼–è¯‘æ‰§è¡Œ:<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">âœ  pporftest <span class=\"keyword\">go</span> build                             </span><br><span class=\"line\">âœ  pporftest ./pporftest -cpu <span class=\"literal\">true</span>  <span class=\"comment\">// ç­‰å¾…30ç§’åä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªcpu.pprofæ–‡ä»¶ã€‚</span></span><br><span class=\"line\">âœ  pporftest ls</span><br><span class=\"line\">cpu.pprof  main.<span class=\"keyword\">go</span>  pporftest</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>å½“æ‰§è¡Œ<code>pporftest</code>ç¨‹åºç”Ÿæˆ<code>cpu.pprof</code>æ–‡ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä¸¤ç§æ–¹å¼è¿›è¡ŒæŸ¥çœ‹åˆ†æç»“æœã€‚</p>\n<ul>\n<li>ç¬¬ä¸€ç§ï¼Œæ˜¯ä½¿ç”¨goå·¥å…·é“¾é‡Œçš„pprofæ¥è¿›å…¥äº¤äº’ç•Œé¢æŸ¥çœ‹åˆ†æç»“æœã€‚</li>\n<li>ç¬¬äºŒç§ï¼Œæ˜¯ä½¿ç”¨graphvizå›¾å½¢åŒ–å·¥å…·ï¼Œé€šè¿‡svgå›¾çš„æ–¹å¼æŸ¥çœ‹ç¨‹åºä¸­è¯¦ç»†çš„CPUå ç”¨æƒ…å†µ</li>\n</ul>\n<p><br/></p>\n<p><strong>å‘½ä»¤è¡Œäº¤äº’ç•Œé¢</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.åˆ†æç¨‹åºçš„cpu.pprofæ–‡ä»¶</span></span><br><span class=\"line\">$ go tool pprof cpu.pprof</span><br><span class=\"line\">File: pporftest</span><br><span class=\"line\">Type: cpu</span><br><span class=\"line\">Time: Nov 27, 2021 at 2:14pm (CST)</span><br><span class=\"line\">Duration: 20.17s, Total samples = 57.72s (286.19%)</span><br><span class=\"line\">Entering interactive mode (<span class=\"built_in\">type</span> <span class=\"string\">\"help\"</span> <span class=\"keyword\">for</span> commands, <span class=\"string\">\"o\"</span> <span class=\"keyword\">for</span> options)</span><br><span class=\"line\">(pprof) top  <span class=\"comment\"># æ¥æŸ¥çœ‹ç¨‹åºä¸­å ç”¨CPUå‰å‡ ä½çš„å‡½æ•°ï¼š</span></span><br><span class=\"line\">Showing nodes accounting <span class=\"keyword\">for</span> 57.71s, 100% of 57.72s total</span><br><span class=\"line\">Dropped 5 nodes (cum &lt;= 0.29s)</span><br><span class=\"line\">      flat  flat%   sum%        cum   cum%</span><br><span class=\"line\">    22.36s 38.74% 38.74%     41.66s 72.18%  runtime.selectnbrecv</span><br><span class=\"line\">    19.30s 33.44% 72.18%     19.30s 33.44%  runtime.chanrecv</span><br><span class=\"line\">    16.05s 27.81%   100%     57.71s   100%  main.logicCode   <span class=\"comment\"># ç½ªé­ç¥¸é¦–å…¶å ç”¨çš„CPUè€—æ—¶ç´¯è®¡å·²è¾¾åˆ°100%</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç»“æœä¸­äº”ä¸ªå…³é”®å‚æ•°æµ…æ</span></span><br><span class=\"line\">  <span class=\"comment\"># * flatï¼šå½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶</span></span><br><span class=\"line\">  <span class=\"comment\"># * flatï¼š:å½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶ç™¾åˆ†æ¯”</span></span><br><span class=\"line\">  <span class=\"comment\"># * sun%ï¼šå‡½æ•°å ç”¨CPUçš„è€—æ—¶ç´¯è®¡ç™¾åˆ†æ¯”</span></span><br><span class=\"line\">  <span class=\"comment\"># * cumï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶</span></span><br><span class=\"line\">  <span class=\"comment\"># * cum%ï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶ç™¾åˆ†æ¯”</span></span><br><span class=\"line\">  <span class=\"comment\"># * æœ€åä¸€åˆ—ï¼šå‡½æ•°åç§°</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.ä½¿ç”¨list å‡½æ•°åå‘½ä»¤æŸ¥çœ‹å…·ä½“çš„å‡½æ•°åˆ†æï¼Œä¾‹å¦‚æ‰§è¡Œlist logicCodeæŸ¥çœ‹æˆ‘ä»¬ç¼–å†™çš„å‡½æ•°çš„è¯¦ç»†åˆ†æã€‚</span></span><br><span class=\"line\">(pprof)  list logicCode</span><br><span class=\"line\">Total: 57.72s</span><br><span class=\"line\">ROUTINE ======================== main.logicCode <span class=\"keyword\">in</span> /home/weiyigeek/app/program/project/go/src/weiyigeek.top/studygo/Day08/07perfomance/pporftest/main.go</span><br><span class=\"line\">  16.05s     57.71s (flat, cum)   100% of Total</span><br><span class=\"line\">        .          .     12:// logicCode å‡½æ•°ä¸­åŒ…å«ä¸€æ®µæœ‰é—®é¢˜çš„ä»£ç </span><br><span class=\"line\">        .          .     13:func <span class=\"function\"><span class=\"title\">logicCode</span></span>() &#123;</span><br><span class=\"line\">        .          .     14:   var c chan int // æœªå¯¹é€šé“cè¿›è¡Œåˆå§‹åŒ–</span><br><span class=\"line\">        .          .     15:   <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">        .          .     16:           select &#123;</span><br><span class=\"line\">  16.05s     57.71s     17:           <span class=\"keyword\">case</span> v := &lt;-c: // æ­¤æ—¶å¤„äºé˜»å¡çš„çŠ¶æ€   <span class=\"comment\"># å¯ä»¥çœ‹åˆ°å°±æ˜¯æ­¤è¡Œæœ‰é—®é¢˜ã€‚</span></span><br><span class=\"line\">        .          .     18:                   fmt.Printf(<span class=\"string\">\"recv from chan, value:%v\\n\"</span>, v)</span><br><span class=\"line\">        .          .     19:           default:</span><br><span class=\"line\">        .          .     20:</span><br><span class=\"line\">        .          .     21:           &#125;</span><br><span class=\"line\">        .          .     22:   &#125;</span><br></pre></td></tr></table></figure></p>\n<p>Tips: åœ¨å¤§å¤šæ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†æä¸Šé¢äº”åˆ—(å…³é”®æŒ‡æ ‡)å¾—å‡ºä¸€ä¸ªåº”ç”¨ç¨‹åºçš„è¿è¡Œæƒ…å†µï¼Œå¹¶å¯¹ç¨‹åºè¿›è¡Œä¼˜åŒ–ã€‚</p>\n<p>æ€»ç»“ï¼šé€šè¿‡ä¸Šé¢çš„ç»“æœåˆ†æå‘ç°å¤§éƒ¨åˆ†CPUèµ„æºè¢«17è¡Œå ç”¨ï¼Œæˆ‘ä»¬åˆ†æå‡º<code>selectè¯­å¥ä¸­çš„default</code>æ²¡æœ‰å†…å®¹ä¼šå¯¼è‡´ä¸Šé¢çš„<code>case v:=&lt;-c:</code>ä¸€ç›´æ‰§è¡Œ, æˆ‘ä»¬åœ¨defaultåˆ†æ”¯æ·»åŠ ä¸€è¡Œ<code>time.Sleep(time.Second)</code>å³å¯, æ­¤æ—¶æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹åˆ†æç»“æœ:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">âœ go build</span><br><span class=\"line\">âœ ./pporftest -cpu <span class=\"literal\">true</span></span><br><span class=\"line\">âœ go tool pprof cpu.pprof      </span><br><span class=\"line\">(pprof) top</span><br><span class=\"line\">Showing nodes accounting <span class=\"keyword\">for</span> 0, 0% of 0 total</span><br><span class=\"line\">      flat  flat%   sum%        cum   cum%</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>graphviz å¯è§†åŒ–å›¾å½¢å·¥å…·</strong><br>é¡¹ç›®åœ°å€: <a href=\"https://graphviz.gitlab.io/\" target=\"_blank\" rel=\"noopener\">https://graphviz.gitlab.io/</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.graphvizå·¥å…·å®‰è£…(å®ƒä¼šè‡ªåŠ¨è®¾ç½®ç¯å¢ƒå˜é‡)</span></span><br><span class=\"line\">âœ sudo apt install graphviz <span class=\"comment\"># // Ubuntu</span></span><br><span class=\"line\">brew install graphviz     <span class=\"comment\"># // Mac</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.éªŒè¯å·¥å…·æ˜¯å¦å®‰è£…é…ç½®æˆåŠŸ</span></span><br><span class=\"line\">âœ dot -version</span><br><span class=\"line\">dot - graphviz version 2.43.0 (0)</span><br><span class=\"line\">libdir = <span class=\"string\">\"/usr/lib/x86_64-linux-gnu/graphviz\"</span></span><br><span class=\"line\">Activated plugin library: libgvplugin_dot_layout.so.6</span><br><span class=\"line\">Using layout: dot:dot_layout</span><br><span class=\"line\">Activated plugin library: libgvplugin_core.so.6</span><br><span class=\"line\">Using render: dot:core</span><br><span class=\"line\">Using device: dot:dot:core</span><br><span class=\"line\">The plugin configuration file:</span><br><span class=\"line\">        /usr/lib/x86_64-linux-gnu/graphviz/config6a</span><br><span class=\"line\">                was successfully loaded.</span><br><span class=\"line\">    render      :  cairo dot dot_json fig gd json json0 map mp pic pov ps svg tk visio vml vrml xdot xdot_json</span><br><span class=\"line\">    layout      :  circo dot fdp neato nop nop1 nop2 osage patchwork sfdp twopi</span><br><span class=\"line\">    textlayout  :  textlayout</span><br><span class=\"line\">    device      :  canon cmap cmapx cmapx_np dot dot_json eps fig gd gd2 gif gv imap imap_np ismap jpe jpeg jpg json json0 mp pdf pic plain plain-ext png pov ps ps2 svg svgz tk vdx vml vmlz vrml wbmp webp x11 xdot xdot1.2 xdot1.4 xdot_json xlib</span><br><span class=\"line\">    loadimage   :  (lib) eps gd gd2 gif jpe jpeg jpg png ps svg webp xbm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.æ­¤æ—¶æˆ‘ä»¬é€šè¿‡dotç”Ÿæˆçš„å›¾ç‰‡æŸ¥çœ‹ç¨‹åºçš„CPUå ç”¨æƒ…å†µã€‚</span></span><br><span class=\"line\">âœ go build &amp;&amp; ./pporftest -cpu <span class=\"literal\">true</span> &amp;&amp; go tool pprof cpu.pprof</span><br><span class=\"line\">File: pporftest</span><br><span class=\"line\">Type: cpu</span><br><span class=\"line\">(pprof) gif</span><br><span class=\"line\">Generating report <span class=\"keyword\">in</span> profile001.gif</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20211127145003.png\" alt=\"WeiyiGeek.graphvizå¯è§†åŒ–æ€§èƒ½å æ¯”æŸ¥çœ‹\" title=\"\" class=\"\">\n                <p>WeiyiGeek.graphvizå¯è§†åŒ–æ€§èƒ½å æ¯”æŸ¥çœ‹</p>\n            </figure></p>\n<p>è¡¥å……è¯´æ˜: é™¤äº†åˆ†æCPUæ€§èƒ½æ•°æ®ï¼Œpprofä¹Ÿæ”¯æŒåˆ†æå†…å­˜æ€§èƒ½æ•°æ®.<br>æ¯”å¦‚ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ†æhttpæœåŠ¡çš„heapæ€§èƒ½æ•°æ®ï¼ŒæŸ¥çœ‹å½“å‰ç¨‹åºçš„å†…å­˜å ç”¨ä»¥åŠçƒ­ç‚¹å†…å­˜å¯¹è±¡ä½¿ç”¨çš„æƒ…å†µã€‚<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å†…å­˜å ç”¨æ•°æ®</span></span><br><span class=\"line\">go tool pprof -inuse_space http://127.0.0.1:8080/debug/pprof/heap</span><br><span class=\"line\">go tool pprof -inuse_objects http://127.0.0.1:8080/debug/pprof/heap</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ä¸´æ—¶å†…å­˜åˆ†é…æ•°æ®</span></span><br><span class=\"line\">go tool pprof -alloc_space http://127.0.0.1:8080/debug/pprof/heap</span><br><span class=\"line\">go tool pprof -alloc_objects http://127.0.0.1:8080/debug/pprof/heap</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h2 id=\"0x02-ç¬¬ä¸‰æ–¹æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ\"><a href=\"#0x02-ç¬¬ä¸‰æ–¹æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ\" class=\"headerlink\" title=\"0x02 ç¬¬ä¸‰æ–¹æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ\"></a>0x02 ç¬¬ä¸‰æ–¹æ€§èƒ½è°ƒè¯•å·¥å…·å®è·µ</h2><h3 id=\"1-Go-torch\"><a href=\"#1-Go-torch\" class=\"headerlink\" title=\"1.Go-torch\"></a>1.Go-torch</h3><p>æè¿°: ç«ç„°å›¾ï¼ˆFlame Graphï¼‰æ˜¯ Bredan Gregg åˆ›å»ºçš„ä¸€ç§æ€§èƒ½åˆ†æå›¾è¡¨ï¼Œå› ä¸ºå®ƒçš„æ ·å­è¿‘ä¼¼ ğŸ”¥ è€Œå¾—å;<br>ä¸Šé¢çš„ profiling ç»“æœä¹Ÿæ˜¯è½¬æ¢æˆç«ç„°å›¾ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦ä»‹ç»ä¸€ä¸ªå·¥å…·<code>go-torch</code>ï¼Œå®ƒ æ˜¯ uber å¼€æºçš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ç›´æ¥è¯»å– golang profiling æ•°æ®ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç«ç„°å›¾çš„ svg æ–‡ä»¶ã€‚</p>\n<p>ç«ç„°å›¾ svg æ–‡ä»¶å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€ï¼Œå®ƒå¯¹äºè°ƒç”¨å›¾çš„æœ€ä¼˜ç‚¹æ˜¯å®ƒæ˜¯åŠ¨æ€çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç‚¹å‡»æ¯ä¸ªæ–¹å—æ¥ zoom in åˆ†æå®ƒä¸Šé¢çš„å†…å®¹ã€‚</p>\n<p>ç«ç„°å›¾çš„è°ƒç”¨é¡ºåºä»ä¸‹åˆ°ä¸Šï¼Œæ¯ä¸ªæ–¹å—ä»£è¡¨ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¸Šé¢ä¸€å±‚è¡¨ç¤ºè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨å“ªäº›å‡½æ•°ï¼Œæ–¹å—çš„å¤§å°ä»£è¡¨äº†å ç”¨ CPU ä½¿ç”¨çš„é•¿çŸ­ã€‚</p>\n<p>Tips: ç«ç„°å›¾çš„é…è‰²å¹¶æ²¡æœ‰ç‰¹æ®Šçš„æ„ä¹‰ï¼Œé»˜è®¤çš„çº¢ã€é»„é…è‰²æ˜¯ä¸ºäº†æ›´åƒç«ç„°è€Œå·²ã€‚</p>\n<p><br/></p>\n<p><strong>ç¯å¢ƒå®‰è£…:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®‰è£… go-torch</span></span><br><span class=\"line\">go get -v github.com/uber/go-torch</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… FlameGraph</span></span><br><span class=\"line\"><span class=\"comment\"># Perl å®‰è£… https://www.perl.org/get.html</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class=\"line\"><span class=\"comment\"># å°†FlameGraphç›®å½•åŠ å…¥åˆ°æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ä¸­ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æœ€ååœ¨go-torchç›®å½•ä¸‹æ‰§è¡Œ</span></span><br><span class=\"line\">go install</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>å·¥å…·å‚æ•°æµ…æ:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go-torch æ ¼å¼ä¸å‚æ•°:</span><br><span class=\"line\"><span class=\"comment\"># -u â€“urlï¼šè¦è®¿é—®çš„ URLï¼Œè¿™é‡Œåªæ˜¯ä¸»æœºå’Œç«¯å£éƒ¨åˆ†</span></span><br><span class=\"line\"><span class=\"comment\"># -s â€“suffixï¼špprof profile çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º /debug/pprof/profile</span></span><br><span class=\"line\"><span class=\"comment\"># â€“secondsï¼šè¦æ‰§è¡Œ profiling çš„æ—¶é—´é•¿åº¦ï¼Œé»˜è®¤ä¸º 30s</span></span><br><span class=\"line\">go-torch -u http://localhost:8080 -s /debug/pprof/profile â€“seconds 30</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>å·¥å…·ä½¿ç”¨å®è·µ:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å‹æµ‹å·¥å…·wrk</span></span><br><span class=\"line\">https://github.com/adjust/go-wrk</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨wrkè¿›è¡Œå‹æµ‹:</span></span><br><span class=\"line\">go-wrk -n 50000 http://127.0.0.1:8080/book/list</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åœ¨ä¸Šé¢å‹æµ‹è¿›è¡Œçš„åŒæ—¶ï¼Œæ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ, ç„¶å30ç§’ä¹‹åç»ˆç«¯ä¼šåˆå¤å¦‚ä¸‹æç¤ºï¼šWriting svg to torch.svg:</span></span><br><span class=\"line\">go-torch -u http://127.0.0.1:8080 -t 30</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ­¤å¤–è¿˜å¯ä»¥å€ŸåŠ©ç«ç„°å›¾åˆ†æå†…å­˜æ€§èƒ½æ•°æ®ï¼š</span></span><br><span class=\"line\">go-torch -inuse_space http://127.0.0.1:8080/debug/pprof/heap</span><br><span class=\"line\">go-torch -inuse_objects http://127.0.0.1:8080/debug/pprof/heap</span><br><span class=\"line\">go-torch -alloc_space http://127.0.0.1:8080/debug/pprof/heap</span><br><span class=\"line\">go-torch -alloc_objects http://127.0.0.1:8080/debug/pprof/heap</span><br></pre></td></tr></table></figure></p>\n<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€<code>torch.svg</code>å°±èƒ½çœ‹åˆ°å¦‚ä¸‹ç«ç„°å›¾äº†ã€‚ </p>\n<p><img src=\"https://img.weiyigeek.top/2021/5/20211129113617.png\" alt=\"WeiyiGeek.Flame Graph\"></p>\n<p><br/></p>\n<p><strong>Q: å¦‚åˆ†æ Flame Graph ç«ç„°å›¾?</strong></p>\n<blockquote>\n<p>æè¿°: ç«ç„°å›¾çš„<code>yè½´</code>è¡¨ç¤ºcpuè°ƒç”¨æ–¹æ³•çš„å…ˆåï¼Œ<code>xè½´</code>è¡¨ç¤ºåœ¨æ¯ä¸ªé‡‡æ ·è°ƒç”¨æ—¶é—´å†…æ–¹æ³•æ‰€å çš„æ—¶é—´ç™¾åˆ†æ¯”ï¼Œè¶Šå®½ä»£è¡¨å æ®cpuæ—¶é—´è¶Šå¤šã€‚<br>é€šè¿‡ç«ç„°å›¾æˆ‘ä»¬å°±å¯ä»¥æ›´æ¸…æ¥šçš„æ‰¾å‡ºè€—æ—¶é•¿çš„å‡½æ•°è°ƒç”¨ï¼Œç„¶åä¸æ–­çš„ä¿®æ­£ä»£ç ï¼Œé‡æ–°é‡‡æ ·ï¼Œä¸æ–­ä¼˜åŒ–ã€‚</p>\n</blockquote>\n<p><br></p>\n<h3 id=\"2-Go-wrk-å‹æµ‹å·¥å…·\"><a href=\"#2-Go-wrk-å‹æµ‹å·¥å…·\" class=\"headerlink\" title=\"2.Go-wrk å‹æµ‹å·¥å…·\"></a>2.Go-wrk å‹æµ‹å·¥å…·</h3><p>å‹æµ‹å·¥å…· wrk åé¢ä½¿ç”¨åˆ°å†ä»‹ç» æ¨èä½¿ç”¨<a href=\"https://github.com/wg/wrk\" target=\"_blank\" rel=\"noopener\">https://github.com/wg/wrk</a> æˆ– <a href=\"https://github.com/adjust/go-wrk\" target=\"_blank\" rel=\"noopener\">https://github.com/adjust/go-wrk</a></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Development","path":"api/categories/Development.json"},{"name":"Programming","path":"api/categories/Programming.json"}],"tags":[{"name":"Go","path":"api/tags/Go.json"}]}