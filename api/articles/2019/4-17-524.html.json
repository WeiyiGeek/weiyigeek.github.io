{"title":"5.Redis基础运维之在K8S中的安装与配置","slug":"数据存储/Redis/5.Redis基础运维之在K8S中的安装与配置","date":"2019-04-17T12:35:30.000Z","updated":"2022-04-26T07:55:24.062Z","url":"2019/4-17-524.html","path":"api/articles/2019/4-17-524.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210908090018.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>描述: 我们知道在 Kubernetes 容器编排平台中, 我们可以非常方便的进行应用的扩容缩, 同时也能非常方便的进行业务的迭代，此处由于学习以及开发测试的需求，本章主要讲解在Kubernetes搭建了单实例和Redis集群主从同步的环境流程步骤, 如果是高频访问重要的线上业务我们最好是部署在物理机器上;</p>\n<p><br></p>\n<p><strong>K8S 环境说明:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># K8S 高可用集群</span></span><br><span class=\"line\">~$ kubectl cluster-info</span><br><span class=\"line\">  Kubernetes master is running at https://WeiyiGeek-lb-vip.k8s:16443</span><br><span class=\"line\">  KubeDNS is running at https://WeiyiGeek-lb-vip.k8s:16443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># K8s 集群节点</span></span><br><span class=\"line\">~$ kubectl get node -o wide</span><br><span class=\"line\">  NAME       STATUS   ROLES    AGE    VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">  WeiyiGeek-107   Ready    master   238d   v1.19.6   192.168.12.107   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-70-generic   docker://20.10.3</span><br><span class=\"line\">  WeiyiGeek-108   Ready    master   238d   v1.19.6   192.168.12.108   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class=\"line\">  WeiyiGeek-109   Ready    master   238d   v1.19.6   192.168.12.109   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class=\"line\">  WeiyiGeek-223   Ready    &lt;none&gt;   238d   v1.19.6   192.168.12.223   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-42-generic   docker://19.3.14</span><br><span class=\"line\">  WeiyiGeek-224   Ready    &lt;none&gt;   238d   v1.19.6   192.168.12.224   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-42-generic   docker://19.3.14</span><br><span class=\"line\">  WeiyiGeek-225   Ready    &lt;none&gt;   238d   v1.19.6   192.168.12.225   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-42-generic   docker://19.3.14</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 挂载的NFS到各个节点</span></span><br><span class=\"line\"> mount -l | grep <span class=\"string\">\"nfsdisk-31\"</span></span><br><span class=\"line\">192.168.12.31:/nask8sapp on /nfsdisk-31 <span class=\"built_in\">type</span> nfs (rw,relatime,vers=3,rsize=32768,wsize=32768,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=192.168.12.31,mountvers=3,mountport=1048,mountproto=udp,local_lock=none,addr=192.168.12.31)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 动态卷存储(NFS)</span></span><br><span class=\"line\">$ kubectl get storageclasses.storage.k8s.io</span><br><span class=\"line\">  NAME                            PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class=\"line\">  managed-nfs-storage (default)   fuseim.pri/ifs   Delete          Immediate           <span class=\"literal\">false</span>                  234d</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Redis 版本说明:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Redis 6.2.5</span><br><span class=\"line\">Redis-cli 6.2.5</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x01-Redis-单实例实践\"><a href=\"#0x01-Redis-单实例实践\" class=\"headerlink\" title=\"0x01 Redis 单实例实践\"></a>0x01 Redis 单实例实践</h2><p>描述: 首先我们先使用kubernetes进行安装部署Redis单示例，此处有两种方案进行<code>redis</code>配置文件的引入一种是通过<code>hostPath</code>，另外一种是通过<code>configMap</code>(推荐方式)，不管您选择哪种方案最终实现的效果都是一样，只不过configMap更方便Redis服务配置的管理与更新。</p>\n<h3 id=\"1-配置准备\"><a href=\"#1-配置准备\" class=\"headerlink\" title=\"1.配置准备\"></a>1.配置准备</h3><ul>\n<li>Step 1.Redis 服务的配置文件清单准备。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /nfsdisk-31/datastore/redis/demo1/redis.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># 绑定任意接口、服务端口、后台运行。</span></span><br><span class=\"line\"><span class=\"built_in\">bind</span> 0.0.0.0</span><br><span class=\"line\">port 6379</span><br><span class=\"line\">daemonize no</span><br><span class=\"line\">supervised no</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># redis服务pid进程文件名</span></span><br><span class=\"line\">pidfile <span class=\"string\">\"/var/run/redis.pid\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭保护模式，并配置使用密码访问</span></span><br><span class=\"line\">protected-mode no</span><br><span class=\"line\">requirepass 123456</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 数据文件保存路径，rdb/AOF文件也保存在这里</span></span><br><span class=\"line\">dir <span class=\"string\">\"/data\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日志文件记录文件(notice / verbose)</span></span><br><span class=\"line\"><span class=\"comment\"># /var/log/redis/redis.log</span></span><br><span class=\"line\">loglevel verbose  </span><br><span class=\"line\">logfile <span class=\"string\">\"/logs/redis.log\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 最大客户端连接数</span></span><br><span class=\"line\">maxclients 10000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 客户端连接空闲多久后断开连接，单位秒，0表示禁用</span></span><br><span class=\"line\">timeout 300</span><br><span class=\"line\">tcp-keepalive 60 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 内存初始化</span></span><br><span class=\"line\">maxmemory 1gb</span><br><span class=\"line\">maxmemory-policy volatile-lru</span><br><span class=\"line\">slowlog-max-len 128</span><br><span class=\"line\">lua-time-limit 5000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Redis 数据持久化(rdb/aof)配置</span></span><br><span class=\"line\"><span class=\"comment\"># 数据自动保存脚本条件例如300s中有10key发生变化</span></span><br><span class=\"line\">save 300 100</span><br><span class=\"line\">save 60 10000</span><br><span class=\"line\"><span class=\"comment\"># RDB 文件名</span></span><br><span class=\"line\">dbfilename <span class=\"string\">\"dump.rdb\"</span></span><br><span class=\"line\"><span class=\"comment\"># 对RDB文件进行压缩，建议以（磁盘）空间换（CPU）时间。</span></span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\"><span class=\"comment\"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span></span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\"><span class=\"comment\"># RDB自动触发策略是否启用，默认为yes</span></span><br><span class=\"line\">rdb-save-incremental-fsync yes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># AOF开启</span></span><br><span class=\"line\">appendonly yes</span><br><span class=\"line\"><span class=\"comment\"># AOF文件名</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\"><span class=\"comment\"># 可选值 always， everysec，no，建议设置为everysec</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Redis风险命令重命名</span></span><br><span class=\"line\"><span class=\"comment\"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class=\"line\">rename-command FLUSHDB b840fc02d524045429941cc15f59e41cb7be6c53</span><br><span class=\"line\">rename-command FLUSHALL b840fc02d524045429941cc15f59e41cb7be6c54</span><br><span class=\"line\">rename-command EVAL b840fc02d524045429941cc15f59e41cb7be6c55</span><br><span class=\"line\">rename-command DEBUG b840fc02d524045429941cc15f59e41cb7be6c56</span><br><span class=\"line\"><span class=\"comment\"># rename-command SHUTDOWN SHUTDOWN</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips: 非常大的巨坑在使用k8s中的container作为redis容器时其<code>daemonize no</code>一定要设置为no 【非常注意】。</p>\n<ul>\n<li>Step 2.准备Redis相关目录的创建与创建configMap资源对象的redis配置文件<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 数据与日志存储目录</span></span><br><span class=\"line\">mkdir /nfsdisk-31/datastore/redis/demo1/&#123;data,logs&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li><p>Step 3.方式1.k8s资源清单的部署准备(<code>此处采用hostpath卷的方式来传入配置文件以及存储持久化的redis{aof/rdb}数据</code>)</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">Redis-single.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">redisdemo1</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">redis:6.2.5-alpine</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span> <span class=\"string\">[</span> <span class=\"string\">\"redis-server\"</span><span class=\"string\">,</span> <span class=\"string\">\"/conf/redis.conf\"</span> <span class=\"string\">]</span></span><br><span class=\"line\">        <span class=\"comment\"># 单个文件与目录挂载</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/conf/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">          readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">logs</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/logs</span></span><br><span class=\"line\">        <span class=\"comment\"># 时区设置</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">        <span class=\"comment\"># 采用hostPath卷,只映射配置文件到pod中</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">FileOrCreate</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/nfsdisk-31/datastore/redis/demo1/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">        <span class=\"comment\"># 采用hostPath卷</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span>     </span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/nfsdisk-31/datastore/redis/demo1/data</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">logs</span></span><br><span class=\"line\">        <span class=\"comment\"># 采用hostPath卷</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span> </span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/nfsdisk-31/datastore/redis/demo1/logs</span></span><br><span class=\"line\">        <span class=\"comment\"># 时区定义</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">timezone</span>                             </span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redisdemo1</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - port:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 4.方式2.k8s资源清单的部署准备(<code>此处采用configMap的方式来传入配置文件以及采用动态存储卷来存储持久化的redis{aof/rdb}数据</code>)</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">redis-single-1.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cm</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">redisdemo2</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">redis-cm</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">redis-cm</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">redis:6.2.5-alpine</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span> <span class=\"string\">[</span> <span class=\"string\">\"redis-server\"</span><span class=\"string\">,</span> <span class=\"string\">\"/conf/redis.conf\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\">        <span class=\"comment\"># 从configmap获取的配置文件，挂载到指定文件中</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/conf/redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">          subPath:</span> <span class=\"string\">redis.conf</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">logs</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/logs</span></span><br><span class=\"line\">        <span class=\"comment\"># 时区设置</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/localtime</span>              </span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">        <span class=\"comment\"># 配置文件采用configMap</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">redis-single</span></span><br><span class=\"line\"><span class=\"attr\">          defaultMode:</span> <span class=\"number\">0755</span></span><br><span class=\"line\">        <span class=\"comment\"># 日志采用hostPath卷</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">logs</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span> </span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/nfsdisk-31/datastore/redis/demo1/logs</span></span><br><span class=\"line\">        <span class=\"comment\"># 时区定义</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">timezone</span>                             </span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      storageClassName:</span> <span class=\"string\">\"managed-nfs-storage\"</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">1</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redisdemo2</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - port:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis-cm</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"2-流程步骤\"><a href=\"#2-流程步骤\" class=\"headerlink\" title=\"2.流程步骤\"></a>2.流程步骤</h3><p>Step 1.部署redis单实例基础环境<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 名称空间的创建 （PS:非常注意在删除名称空间时需要查看是否有存在Pod）</span></span><br><span class=\"line\">kubectl create namespace database</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) Redis 配置文件部署到configMap中 &amp; 查看</span></span><br><span class=\"line\">kubectl create configmap -n database redis-single --from-file=/nfsdisk-31/datastore/redis/demo1/redis.conf</span><br><span class=\"line\">kubectl get cm -n database redis-single -o json</span><br><span class=\"line\">  <span class=\"comment\"># NAME           DATA   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-single   1      12s</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210908090018.png\" alt=\"WeiyiGeek.configMap资源\" title=\"\" class=\"\">\n                <p>WeiyiGeek.configMap资源</p>\n            </figure>\n<ul>\n<li>Step 2.按照方式1资源清单构建项目（hostpath的方式）<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 资源清单的部署</span></span><br><span class=\"line\">kubectl create --save-config -f Redis-single.yaml</span><br><span class=\"line\">  <span class=\"comment\"># statefulset.apps/redis created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/redisdemo1 created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 部署的redis单实例pod，sts,svc 查看</span></span><br><span class=\"line\">kubectl get sts -n database</span><br><span class=\"line\">  <span class=\"comment\"># NAME            READY   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># redis           1/1     9m16s</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pod -n database -l app=redis -o wide --show-labels</span><br><span class=\"line\">  <span class=\"comment\"># NAME      READY   STATUS    RESTARTS   AGE     IP               NODE       LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-0   1/1     Running   0          4m12s   172.16.183.73   WeiyiGeek-224   app=redis,controller-revision-hash=redis-6d69c85769,statefulset.kubernetes.io/pod-name=redis-0</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get svc -n database | grep <span class=\"string\">\"redisdemo1\"</span></span><br><span class=\"line\">  <span class=\"comment\"># redisdemo1            ClusterIP   10.100.14.177   &lt;none&gt;        6379/TCP                         8m47s</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) pod启动日志查看</span></span><br><span class=\"line\">kubectl logs -n database -l app=redis</span><br><span class=\"line\">  <span class=\"comment\"># 1:C 07 Sep 2021 13:15:51.149 # Redis version=6.2.5, bits=64, commit=00000000, modified=0, pid=1, just started</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:C 07 Sep 2021 13:15:51.149 # Configuration loaded</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.150 * monotonic clock: POSIX clock_gettime</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.151 * Running mode=standalone, port=6379.</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.151 # Server initialized</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.153 * Loading RDB produced by version 6.2.5</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.153 * RDB age 247 seconds</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.153 * RDB memory usage when created 0.77 Mb</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.153 * DB loaded from disk: 0.002 seconds</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 13:15:51.153 * Ready to accept connections</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 服务访问验证测试</span></span><br><span class=\"line\">redis-cli -h 10.100.14.177</span><br><span class=\"line\">10.100.14.177:6379&gt; auth 123456 <span class=\"comment\"># OK</span></span><br><span class=\"line\">10.100.14.177:6379&gt; ping        <span class=\"comment\"># PONG</span></span><br><span class=\"line\">10.100.14.177:6379&gt; role        <span class=\"comment\"># 1) \"master\"</span></span><br><span class=\"line\">10.100.14.177:6379&gt; <span class=\"built_in\">set</span> name weiyigeek <span class=\"comment\"># OK</span></span><br><span class=\"line\">10.100.14.177:6379&gt; hset bashdemo name <span class=\"string\">\"weiyigeek\"</span> age 18      <span class=\"comment\"># (integer) 2</span></span><br><span class=\"line\">10.100.14.177:6379&gt; hset bashdemo addr <span class=\"string\">\"ChongQing\"</span> pro <span class=\"string\">\"北京\"</span>  <span class=\"comment\"># (integer) 2</span></span><br><span class=\"line\">10.100.14.177:6379&gt; get name    <span class=\"comment\"># \"weiyigeek\"</span></span><br><span class=\"line\">10.100.14.177:6379&gt; HGETALL bashdemo</span><br><span class=\"line\">1) <span class=\"string\">\"name\"</span></span><br><span class=\"line\">2) <span class=\"string\">\"weiyigeek\"</span></span><br><span class=\"line\">3) <span class=\"string\">\"age\"</span></span><br><span class=\"line\">4) <span class=\"string\">\"18\"</span></span><br><span class=\"line\">5) <span class=\"string\">\"addr\"</span></span><br><span class=\"line\">6) <span class=\"string\">\"ChongQing\"</span></span><br><span class=\"line\">7) <span class=\"string\">\"pro\"</span></span><br><span class=\"line\">8) <span class=\"string\">\"\\xe5\\x8c\\x97\\xe4\\xba\\xac\"</span></span><br><span class=\"line\">10.100.14.177:6379&gt; HVALS bashdemo</span><br><span class=\"line\">1) <span class=\"string\">\"weiyigeek\"</span></span><br><span class=\"line\">2) <span class=\"string\">\"18\"</span></span><br><span class=\"line\">3) <span class=\"string\">\"ChongQing\"</span></span><br><span class=\"line\">4) <span class=\"string\">\"\\xe5\\x8c\\x97\\xe4\\xba\\xac\"</span></span><br><span class=\"line\">10.100.14.177:6379&gt; save <span class=\"comment\"># OK</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>Step 3.按照方式2资源清单构建项目（动态卷的方式）<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 部署redis的资源清单</span></span><br><span class=\"line\">kubectl create --save-config -f redis-single-1.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看不是的sts，pod，svc，pv等资源</span></span><br><span class=\"line\">kubectl get sts -n database -o wide --show-labels redis-cm</span><br><span class=\"line\">  <span class=\"comment\"># NAME       READY   AGE     CONTAINERS   IMAGES               LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-cm   1/1     3m26s   redis        redis:6.2.5-alpine   &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pod -n database -o wide --show-labels -l app=redis-cm</span><br><span class=\"line\">  <span class=\"comment\"># NAME         READY   STATUS    RESTARTS   AGE     IP               NODE      LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-cm-0   1/1     Running   0          2m54s   172.16.100.106   WeiyiGeek-224  app=redis-cm,controller-revision-hash=redis-cm-5988f6b7f8,statefulset.kubernetes.io/pod-name=redis-cm-0</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get svc -n database -o wide --show-labels redisdemo2</span><br><span class=\"line\">  <span class=\"comment\"># NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE     SELECTOR       LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># redisdemo2   ClusterIP   10.102.39.181   &lt;none&gt;        6379/TCP   6m12s   app=redis-cm   &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pvc -n database -o wide --show-labels -l app=redis-cm</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                    STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE    VOLUMEMODE   LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># persistentvolumeclaim/data-redis-cm-0   Bound    pvc-00ee48e8-b1ca-4640-96c5-16f7265a2c61   1Gi        RWO            managed-nfs-storage   4m4s   Filesystem   app=redis-cm</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) pod启动日志查看</span></span><br><span class=\"line\">$ kubectl logs -n database redis-cm-0</span><br><span class=\"line\">  <span class=\"comment\"># 1:C 07 Sep 2021 14:48:10.357 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:C 07 Sep 2021 14:48:10.357 # Redis version=6.2.5, bits=64, commit=00000000, modified=0, pid=1, just started</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:C 07 Sep 2021 14:48:10.357 # Configuration loaded</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 14:48:10.357 * monotonic clock: POSIX clock_gettime</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 14:48:10.358 * Running mode=standalone, port=6379.</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 14:48:10.358 # Server initialized</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 14:48:10.360 * Ready to accept connections</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 服务访问验证测试</span></span><br><span class=\"line\">$ redis-cli -h 10.102.39.181</span><br><span class=\"line\">10.102.39.181:6379&gt; auth 123456  <span class=\"comment\"># OK</span></span><br><span class=\"line\">10.102.39.181:6379&gt; keys *       <span class=\"comment\"># (empty list or set)</span></span><br><span class=\"line\">10.102.39.181:6379&gt; <span class=\"built_in\">set</span> name weiyigeek <span class=\"comment\"># OK</span></span><br><span class=\"line\">10.102.39.181:6379&gt; hset 10086 name <span class=\"string\">\"China Mobile\"</span> age <span class=\"string\">\"15\"</span>  <span class=\"comment\"># (integer) 2</span></span><br><span class=\"line\">10.102.39.181:6379&gt; get name        <span class=\"comment\"># \"weiyigeek\"</span></span><br><span class=\"line\">10.102.39.181:6379&gt; HGET 10086 name <span class=\"comment\"># \"China Mobile\"</span></span><br><span class=\"line\">10.102.39.181:6379&gt; HGETALL 10086</span><br><span class=\"line\">1) <span class=\"string\">\"name\"</span></span><br><span class=\"line\">2) <span class=\"string\">\"China Mobile\"</span></span><br><span class=\"line\">3) <span class=\"string\">\"age\"</span></span><br><span class=\"line\">4) <span class=\"string\">\"15\"</span></span><br><span class=\"line\">10.102.39.181:6379&gt; save <span class=\"comment\"># OK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 查看其持久化rdb与aof文件</span></span><br><span class=\"line\">/nfsdisk-31/data/database-data-redis-cm-0-pvc-00ee48e8-b1ca-4640-96c5-16f7265a2c61<span class=\"comment\"># ls</span></span><br><span class=\"line\">  <span class=\"comment\"># appendonly.aof  dump.rdb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (6) 访问日志查看</span></span><br><span class=\"line\">/nfsdisk-31/datastore/redis/demo1/logs<span class=\"comment\"># cat redis.log</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 15:08:58.044 - Accepted 172.16.0.192:59435</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 15:09:17.382 - DB 0: 1 keys (0 volatile) in 4 slots HT.</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 15:12:32.897 - DB 0: 2 keys (0 volatile) in 4 slots HT.</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 15:12:37.910 - DB 0: 2 keys (0 volatile) in 4 slots HT.</span></span><br><span class=\"line\">  <span class=\"comment\"># 1:M 07 Sep 2021 15:12:38.027 * DB saved on disk</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x02-Redis-集群主从实践\"><a href=\"#0x02-Redis-集群主从实践\" class=\"headerlink\" title=\"0x02 Redis 集群主从实践\"></a>0x02 Redis 集群主从实践</h2><p>描述: 在Kubernetes中部署Redis集群很有挑战，因为每个Redis实例都依赖于一个配置文件，该文件跟踪其他集群实例及其角色。为此，我们需要结合使用Kubernetes状态集（StatefulSets）和持久卷（PersistentVolumes）。</p>\n<h3 id=\"1-自定义Redis集群构建\"><a href=\"#1-自定义Redis集群构建\" class=\"headerlink\" title=\"(1) 自定义Redis集群构建\"></a>(1) 自定义Redis集群构建</h3><h4 id=\"1-配置准备-1\"><a href=\"#1-配置准备-1\" class=\"headerlink\" title=\"1.配置准备\"></a>1.配置准备</h4><p><strong>Step 1.文件及其目录说明:</strong></p>\n<ul>\n<li>Redis 配置文件: /conf/redis.conf</li>\n<li>集群配置更新文件: /conf/update-node.sh</li>\n<li>集群节点配置文件: /data/nodes.conf</li>\n<li>数据存储目录：/data</li>\n</ul>\n<p><br/></p>\n<p><strong>Step 2.配置文件准备</strong><br>redis 配置文件的使用方式</p>\n<ul>\n<li>(1) 方式1.创建 Configmap 来存储该配置文件 <code>kubectl create configmap redis-conf --from-file=redis.conf</code>，此处演示采用的方法</li>\n<li>(2) 方式2.利用 Hostpath Volumes 卷挂载该配置文件</li>\n</ul>\n<p>Redis配置文件示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 监听端口</span></span><br><span class=\"line\">port 6379</span><br><span class=\"line\"><span class=\"comment\"># 启用外部连接关闭安全模式</span></span><br><span class=\"line\">protected-mode no</span><br><span class=\"line\">requirepass weiyigeek.top</span><br><span class=\"line\"><span class=\"comment\"># 开启Redis的AOF持久化 &amp;&amp; 日志文件</span></span><br><span class=\"line\">appendonly yes </span><br><span class=\"line\">appendfilename appendonly.aof </span><br><span class=\"line\"><span class=\"comment\"># AOF持久化文件存在的位置以及其文件名称</span></span><br><span class=\"line\">dir /data</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\"><span class=\"comment\"># 每秒钟同步一次折中的方案</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\">no-appendfsync-on-rewrite no</span><br><span class=\"line\">auto-aof-rewrite-percentage 100</span><br><span class=\"line\">auto-aof-rewrite-min-size 64mb</span><br><span class=\"line\"><span class=\"comment\"># 主从认证及其从节点只读</span></span><br><span class=\"line\">masterauth weiyigeek.top</span><br><span class=\"line\">slave-read-only yes</span><br><span class=\"line\"><span class=\"comment\"># 集群模式打开</span></span><br><span class=\"line\">cluster-enabled yes </span><br><span class=\"line\">cluster-config-file  /data/nodes.conf</span><br><span class=\"line\">cluster-node-timeout 5000</span><br><span class=\"line\"><span class=\"comment\"># 当负责一个插槽的主库下线且没有相应的从库进行故障恢复时集群仍然可用</span></span><br><span class=\"line\">cluster-require-full-coverage no</span><br><span class=\"line\"><span class=\"comment\"># 只有当一个主节点至少拥有其他给定数量个处于正常工作中的从节点的时候，才会分配从节点给集群中孤立的主节点</span></span><br><span class=\"line\">cluster-migration-barrier 1</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Step 3.Redis-cluster 部署的资源清单</strong><br>描述: 部署清单包括三个部分configMap/Statefulset/Service资源对象清单.<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; Redis-cluster-5.0.10.yaml &lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"comment\"># 外部命令参数传递执行精妙之处值得学习</span></span><br><span class=\"line\">  <span class=\"string\">update-node.sh:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    #!/bin/sh</span></span><br><span class=\"line\"><span class=\"string\">    REDIS_NODES=\"/data/nodes.conf\"</span></span><br><span class=\"line\"><span class=\"string\">    if [ ! -f /data/nodes.conf ];then touch /data/nodes.conf;fi</span></span><br><span class=\"line\"><span class=\"string\">    sed -i -e \"/myself/ s/[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;/$&#123;POD_IP&#125;/\" $&#123;REDIS_NODES&#125;</span></span><br><span class=\"line\"><span class=\"string\">    exec \"$@\"</span></span><br><span class=\"line\"><span class=\"string\">  redis.conf: |+</span></span><br><span class=\"line\"><span class=\"string\">    # 监听端口</span></span><br><span class=\"line\"><span class=\"string\">    port 6379</span></span><br><span class=\"line\"><span class=\"string\">    # 启用外部连接关闭安全模式</span></span><br><span class=\"line\"><span class=\"string\">    protected-mode no</span></span><br><span class=\"line\"><span class=\"string\">    masterauth weiyigeek.top</span></span><br><span class=\"line\"><span class=\"string\">    requirepass weiyigeek.top</span></span><br><span class=\"line\"><span class=\"string\">    # 开启Redis的AOF持久化 &amp;&amp; 日志文件</span></span><br><span class=\"line\"><span class=\"string\">    appendonly yes </span></span><br><span class=\"line\"><span class=\"string\">    appendfilename appendonly.aof </span></span><br><span class=\"line\"><span class=\"string\">    # AOF持久化文件存在的位置以及其文件名称</span></span><br><span class=\"line\"><span class=\"string\">    dir /data</span></span><br><span class=\"line\"><span class=\"string\">    dbfilename dump.rdb</span></span><br><span class=\"line\"><span class=\"string\">    slave-read-only yes</span></span><br><span class=\"line\"><span class=\"string\">    # 每秒钟同步一次折中的方案</span></span><br><span class=\"line\"><span class=\"string\">    appendfsync everysec</span></span><br><span class=\"line\"><span class=\"string\">    no-appendfsync-on-rewrite no</span></span><br><span class=\"line\"><span class=\"string\">    auto-aof-rewrite-percentage 100</span></span><br><span class=\"line\"><span class=\"string\">    auto-aof-rewrite-min-size 64mb</span></span><br><span class=\"line\"><span class=\"string\">    # 集群模式打开</span></span><br><span class=\"line\"><span class=\"string\">    cluster-enabled yes </span></span><br><span class=\"line\"><span class=\"string\">    cluster-config-file /data/nodes.conf</span></span><br><span class=\"line\"><span class=\"string\">    cluster-node-timeout 5000</span></span><br><span class=\"line\"><span class=\"string\">    # 当负责一个插槽的主库下线且没有相应的从库进行故障恢复时集群仍然可用</span></span><br><span class=\"line\"><span class=\"string\">    cluster-require-full-coverage no</span></span><br><span class=\"line\"><span class=\"string\">    # 只有当一个主节点至少拥有其他给定数量个处于正常工作中的从节点的时候，才会分配从节点给集群中孤立的主节点</span></span><br><span class=\"line\"><span class=\"string\">    cluster-migration-barrier 1</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">redis:5.0.10-alpine</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">16379</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">gossip</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span> <span class=\"string\">[\"/conf/update-node.sh\",</span> <span class=\"string\">\"redis-server\"</span><span class=\"string\">,</span> <span class=\"string\">\"/conf/redis.conf\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/conf</span></span><br><span class=\"line\"><span class=\"attr\">          readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\"><span class=\"attr\">          readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/localtime</span>                <span class=\"comment\"># 在Pod中时区设置(挂载主机的时区)</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">          defaultMode:</span> <span class=\"number\">0755</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">timezone</span> </span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[</span> <span class=\"string\">\"ReadWriteOnce\"</span> <span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      storageClassName:</span> <span class=\"string\">\"managed-nfs-storage\"</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">5</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># headless Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">\"None\"</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - port:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">  - port:</span> <span class=\"number\">16379</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">16379</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">gossip</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"2-流程步骤-1\"><a href=\"#2-流程步骤-1\" class=\"headerlink\" title=\"2.流程步骤\"></a>2.流程步骤</h4><p><strong>Step 4.资源清单部署流程与结果查看:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 名称空间创建</span></span><br><span class=\"line\">$ kubectl create namespace database</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 按照资源清单StatefulSet控制器创建Pod</span></span><br><span class=\"line\">$ kubectl create -f Redis-cluster-5.0.10.yaml</span><br><span class=\"line\">  <span class=\"comment\"># configmap/redis-cluster created</span></span><br><span class=\"line\">  <span class=\"comment\"># statefulset.apps/redis-cluster created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/redis-cluster created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 查看应用的 statefulsets,pod,svc 等信息</span></span><br><span class=\"line\">$ kubectl get statefulsets,pod,svc -n database -o wide --show-labels | grep -v <span class=\"string\">\"redis-single\"</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                             READY   AGE     CONTAINERS   IMAGES                LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># statefulset.apps/redis-cluster   6/6     27m     redis        redis:5.0.10-alpine   &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NAME                  READY   STATUS    RESTARTS   AGE     IP               NODE      LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-cluster-0   1/1     Running   0          27m     172.16.183.81    weiyigeek-225  app=redis-cluster,controller-revision-hash=redis-cluster-6bf876ccf9,statefulset.kubernetes.io/pod-name=redis-cluster-0</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-cluster-1   1/1     Running   0          26m     172.16.182.226   weiyigeek-226  app=redis-cluster,controller-revision-hash=redis-cluster-6bf876ccf9,statefulset.kubernetes.io/pod-name=redis-cluster-1</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-cluster-2   1/1     Running   0          26m     172.16.24.204    weiyigeek-223  app=redis-cluster,controller-revision-hash=redis-cluster-6bf876ccf9,statefulset.kubernetes.io/pod-name=redis-cluster-2</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-cluster-3   1/1     Running   0          26m     172.16.100.67    weiyigeek-224  app=redis-cluster,controller-revision-hash=redis-cluster-6bf876ccf9,statefulset.kubernetes.io/pod-name=redis-cluster-3</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-cluster-4   1/1     Running   0          26m     172.16.243.67    weiyigeek-109  app=redis-cluster,controller-revision-hash=redis-cluster-6bf876ccf9,statefulset.kubernetes.io/pod-name=redis-cluster-4</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-cluster-5   1/1     Running   0          26m     172.16.135.195   weiyigeek-108  app=redis-cluster,controller-revision-hash=redis-cluster-6bf876ccf9,statefulset.kubernetes.io/pod-name=redis-cluster-5</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)              AGE     SELECTOR            LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># service/redis-cluster   ClusterIP   None           &lt;none&gt;        6379/TCP,16379/TCP   25m     app=redis-cluster   &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># $ 通过svc服务名称访问集群 </span></span><br><span class=\"line\">ping redis-cluster.database.svc.cluster.local</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Step 5.手动进行 Redis 集群配置</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 获取各个pod的IP地址</span></span><br><span class=\"line\">kubectl get pod -n database -l app=redis-cluster -o jsonpath=<span class=\"string\">'&#123; range.items [*]&#125;&#123;.status.podIP&#125;:6379 '</span>| sed <span class=\"string\">\"s# :6379 ##g\"</span></span><br><span class=\"line\"><span class=\"comment\"># 172.16.182.219:6379 172.16.183.72:6379 172.16.24.202:6379 172.16.100.65:6379 172.16.135.193:6379 172.16.243.65:6379</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 进入redis-cluster-0 pod中的shell</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -n database -it redis-cluster-0 sh </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 为此让我们运行以下命令并输入'yes'接受配置。我们将看到前三个节点将被选择为主节点，后三个节点将被选择为从节点。</span></span><br><span class=\"line\">/data $ redis-cli --cluster create --cluster-replicas 1 172.16.182.219:6379 172.16.183.72:6379 172.16.24.202:6379 172.16.100.65:6379 172.16.135.193:6379 172.16.243.65:6379</span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span></span><br><span class=\"line\">  <span class=\"comment\"># Master[0] -&gt; Slots 0 - 5460</span></span><br><span class=\"line\">  <span class=\"comment\"># Master[1] -&gt; Slots 5461 - 10922</span></span><br><span class=\"line\">  <span class=\"comment\"># Master[2] -&gt; Slots 10923 - 16383</span></span><br><span class=\"line\">  <span class=\"comment\"># Adding replica 172.16.100.65:6379 to 172.16.182.219:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># Adding replica 172.16.135.193:6379 to 172.16.183.72:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># Adding replica 172.16.243.65:6379 to 172.16.24.202:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># M: be20868bb9de5688d50c54d2654ffe1f11c28794 172.16.182.219:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[0-5460] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\"># M: ba71016f951653985ff1ad42528f4c09bcf51ddb 172.16.183.72:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\"># M: fb2f078d21d1efbcf93dc43cbead6aff9ea9eb76 172.16.24.202:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 17244c7a73416380f9ed254ee9d8b1b56836e0a0 172.16.100.65:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates be20868bb9de5688d50c54d2654ffe1f11c28794</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 677b964d754148db24e953bdd4e08de3a89c4eed 172.16.135.193:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates ba71016f951653985ff1ad42528f4c09bcf51ddb</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 200f775a8e0f83b9e39cd1bf597d65aba53d5f26 172.16.243.65:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates fb2f078d21d1efbcf93dc43cbead6aff9ea9eb76</span></span><br><span class=\"line\">  <span class=\"comment\"># Can I set the above configuration? (type 'yes' to accept): yes</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Nodes configuration updated</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Assign a different config epoch to each node</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class=\"line\">  <span class=\"comment\"># Waiting for the cluster to join</span></span><br><span class=\"line\">  <span class=\"comment\"># ....</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Performing Cluster Check (using node 172.16.182.219:6379)</span></span><br><span class=\"line\">  <span class=\"comment\"># M: be20868bb9de5688d50c54d2654ffe1f11c28794 172.16.182.219:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[0-5460] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\">#    1 additional replica(s)</span></span><br><span class=\"line\">  <span class=\"comment\"># M: fb2f078d21d1efbcf93dc43cbead6aff9ea9eb76 172.16.24.202:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\">#    1 additional replica(s)</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 677b964d754148db24e953bdd4e08de3a89c4eed 172.16.135.193:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots: (0 slots) slave</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates ba71016f951653985ff1ad42528f4c09bcf51ddb</span></span><br><span class=\"line\">  <span class=\"comment\"># M: ba71016f951653985ff1ad42528f4c09bcf51ddb 172.16.183.72:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\">#    1 additional replica(s)</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 17244c7a73416380f9ed254ee9d8b1b56836e0a0 172.16.100.65:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots: (0 slots) slave</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates be20868bb9de5688d50c54d2654ffe1f11c28794</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 200f775a8e0f83b9e39cd1bf597d65aba53d5f26 172.16.243.65:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots: (0 slots) slave</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates fb2f078d21d1efbcf93dc43cbead6aff9ea9eb76</span></span><br><span class=\"line\">  <span class=\"comment\"># [OK] All nodes agree about slots configuration.</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class=\"line\">  <span class=\"comment\"># [OK] All 16384 slots covered.</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tips: 也可以利用下面两条命令一步到位的方式:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> REDIS_POD_IP=$(kubectl get pod -n database -l app=redis-cluster -o jsonpath=<span class=\"string\">'&#123; range.items [*]&#125;&#123;.status.podIP&#125;:6379 '</span>| sed <span class=\"string\">\"s# :6379 ##g\"</span>)</span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it -n database redis-cluster-0 -- sh -c <span class=\"string\">\"/usr/local/bin/redis-cli -a weiyigeek.top --cluster create --cluster-replicas 1 <span class=\"variable\">$&#123;REDIS_POD_IP&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2</span></span><br><span class=\"line\">kubectl -n database <span class=\"built_in\">exec</span> -it redis-cluster-0 -- redis-cli --cluster create --cluster-replicas 1 $(kubectl get pods -n database -l app=redis-cluster -o jsonpath=<span class=\"string\">'&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379 '</span>| sed <span class=\"string\">\"s# :6379 ##g\"</span>)</span><br></pre></td></tr></table></figure></p>\n<p>Tips: 在集群中我们可以利用SVC服务发现的机制采用 <code>redis-cluster-1.redis-cluster.database.svc.cluster.local</code> 域名的方式访问Pod;</p>\n<p><br></p>\n<p><strong>Step 6.Redis 集群访问验证</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 先以单台为例查看集群状态</span></span><br><span class=\"line\">~/k8s/redis-master-slave$ kubectl <span class=\"built_in\">exec</span> -it -n database redis-cluster-0 -- sh -c <span class=\"string\">\"redis-cli -a weiyigeek.top ping\"</span></span><br><span class=\"line\">  <span class=\"comment\"># PONG</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 集群信息 </span></span><br><span class=\"line\">~/k8s/redis-master-slave$ kubectl <span class=\"built_in\">exec</span> -it -n database redis-cluster-0 -- sh -c <span class=\"string\">\"redis-cli -a weiyigeek.top cluster info\"</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_state:ok</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_slots_assigned:16384</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_slots_ok:16384</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_slots_pfail:0</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_slots_fail:0</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_known_nodes:6</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_size:3</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_current_epoch:6</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_my_epoch:1</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_stats_messages_ping_sent:1735</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_stats_messages_pong_sent:1797</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_stats_messages_sent:3532</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_stats_messages_ping_received:1792</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_stats_messages_pong_received:1735</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_stats_messages_meet_received:5</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster_stats_messages_received:3532</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 当前节点角色</span></span><br><span class=\"line\">~/k8s/redis-master-slave$ kubectl <span class=\"built_in\">exec</span> -it -n database redis-cluster-0 -- sh -c <span class=\"string\">\"redis-cli -a weiyigeek.top role\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 1) \"master\"  # 当前主机角色</span></span><br><span class=\"line\">  <span class=\"comment\"># 2) (integer) 1288</span></span><br><span class=\"line\">  <span class=\"comment\"># 3) 1) 1) \"172.16.243.67\"  # Slave IP</span></span><br><span class=\"line\">  <span class=\"comment\">#       2) \"6379\"</span></span><br><span class=\"line\">  <span class=\"comment\">#       3) \"1288\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 从节点信息</span></span><br><span class=\"line\">~/k8s/redis-master-slave$ kubectl <span class=\"built_in\">exec</span> -it -n database redis-cluster-0 -- sh -c <span class=\"string\">\"redis-cli -a weiyigeek.top info replication\"</span></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\">  <span class=\"comment\"># role:master</span></span><br><span class=\"line\">  <span class=\"comment\"># connected_slaves:1</span></span><br><span class=\"line\">  <span class=\"comment\"># slave0:ip=172.16.243.67,port=6379,state=online,offset=1372,lag=0</span></span><br><span class=\"line\">  <span class=\"comment\"># master_replid:222f4d18c5d0913cb367d8bff49edc717563a96d</span></span><br><span class=\"line\">  <span class=\"comment\"># master_replid2:0000000000000000000000000000000000000000</span></span><br><span class=\"line\">  <span class=\"comment\"># master_repl_offset:1372</span></span><br><span class=\"line\">  <span class=\"comment\"># second_repl_offset:-1</span></span><br><span class=\"line\">  <span class=\"comment\"># repl_backlog_active:1</span></span><br><span class=\"line\">  <span class=\"comment\"># repl_backlog_size:1048576</span></span><br><span class=\"line\">  <span class=\"comment\"># repl_backlog_first_byte_offset:1</span></span><br><span class=\"line\">  <span class=\"comment\"># repl_backlog_histlen:1372</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 列举出集群 nodes 相关信息以及卡槽信息</span></span><br><span class=\"line\">~/k8s/redis-master-slave$ kubectl <span class=\"built_in\">exec</span> -it -n database redis-cluster-0 -- sh -c <span class=\"string\">\"redis-cli -a weiyigeek.top cluster nodes\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ee0aa0c0742e6a9362a96f182d54483ec065fdba 172.16.182.226:6379@16379 master - 0 1611220585017 2 connected 5461-10922</span></span><br><span class=\"line\">  <span class=\"comment\"># 3324007374edeaf4bed02423148970ee8171a7cb 172.16.135.195:6379@16379 slave ee0aa0c0742e6a9362a96f182d54483ec065fdba 0 1611220583514 6 connected</span></span><br><span class=\"line\">  <span class=\"comment\"># f5a740fcbfdcd398da6e380f496fb5cb92236748 172.16.183.81:6379@16379 myself,master - 0 1611220583000 1 connected 0-5460</span></span><br><span class=\"line\">  <span class=\"comment\"># 7697cf77b6da8b58663d23e9ad8150f33a6ee9cd 172.16.24.204:6379@16379 master - 0 1611220583515 3 connected 10923-16383</span></span><br><span class=\"line\">  <span class=\"comment\"># 99509917de27b2f9ba02fb1b09d137014a0ae5f9 172.16.100.67:6379@16379 slave 7697cf77b6da8b58663d23e9ad8150f33a6ee9cd 0 1611220585016 4 connected</span></span><br><span class=\"line\">  <span class=\"comment\"># b5aa6a5f06f1ad2b9debccc6842bcc5f0d9ff732 172.16.243.67:6379@16379 slave f5a740fcbfdcd398da6e380f496fb5cb92236748 0 1611220584015 5 connected</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Step 7.查看Redis 集群各工作节点状态</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 一个脚本全部搞定,对于/conf/update-node.sh的脚本此处也显化出其功能.</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> pod_name <span class=\"keyword\">in</span> $(kubectl get pod -n database -l app=redis-cluster -o jsonpath=<span class=\"string\">'&#123; range.items [*]&#125;&#123;.spec.hostname&#125; '</span>);<span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"variable\">$&#123;pod_name&#125;</span></span><br><span class=\"line\">  kubectl <span class=\"built_in\">exec</span> -it -n database <span class=\"variable\">$&#123;pod_name&#125;</span> -- sh -c <span class=\"string\">\"redis-cli -a weiyigeek.top cluster nodes\"</span> | grep <span class=\"string\">\"myself\"</span>;</span><br><span class=\"line\">  kubectl <span class=\"built_in\">exec</span> -it -n database <span class=\"variable\">$&#123;pod_name&#125;</span> -- sh -c <span class=\"string\">\"redis-cli -a weiyigeek.top info replication\"</span> | egrep <span class=\"string\">\"role|slave\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> .</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 当Pod重启后会又一个新的IP地址,此时通过update-node.sh脚本, 进行将原IP地址替换为新POD的IP地址</span></span><br><span class=\"line\"><span class=\"comment\"># 前三个为主-Master</span></span><br><span class=\"line\"><span class=\"comment\"># f5a740fcbfdcd398da6e380f496fb5cb92236748 172.16.183.81:6379@16379 myself,master - 0 1611221210000 1 connected 0-5460  # 注意槽的分配端</span></span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:1</span><br><span class=\"line\">slave0:ip=172.16.243.67,port=6379,state=online,offset=2436,lag=1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ee0aa0c0742e6a9362a96f182d54483ec065fdba 172.16.182.226:6379@16379 myself,master - 0 1611221211000 2 connected 5461-10922</span></span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:1</span><br><span class=\"line\">slave0:ip=172.16.135.195,port=6379,state=online,offset=2436,lag=0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7697cf77b6da8b58663d23e9ad8150f33a6ee9cd 172.16.24.204:6379@16379 myself,master - 0 1611221209000 3 connected 10923-16383</span></span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:1</span><br><span class=\"line\">slave0:ip=172.16.100.67,port=6379,state=online,offset=2436,lag=0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 后三个为从-Slave</span></span><br><span class=\"line\"><span class=\"comment\"># 99509917de27b2f9ba02fb1b09d137014a0ae5f9 172.16.100.67:6379@16379 myself,slave 7697cf77b6da8b58663d23e9ad8150f33a6ee9cd 0 1611221211000 4 connected</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">slave_repl_offset:2436</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># b5aa6a5f06f1ad2b9debccc6842bcc5f0d9ff732 172.16.243.67:6379@16379 myself,slave f5a740fcbfdcd398da6e380f496fb5cb92236748 0 1611221211000 5 connected</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">slave_repl_offset:2436</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3324007374edeaf4bed02423148970ee8171a7cb 172.16.135.195:6379@16379 myself,slave ee0aa0c0742e6a9362a96f182d54483ec065fdba 0 1611221209000 6 connected</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">slave_repl_offset:2436</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">connected_slaves:0</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Step 8.Redis 集群之数据写入和查询实践</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/k8s/redis-master-slave$ kubectl <span class=\"built_in\">exec</span> -it -n database redis-cluster-0 -- sh -c <span class=\"string\">\"redis-cli -h redis-cluster-0 -c -a weiyigeek.top\"</span></span><br><span class=\"line\">redis-cluster-0:6379&gt; <span class=\"built_in\">set</span> name weiyigeek</span><br><span class=\"line\">-&gt; Redirected to slot [5798] located at 172.16.182.226:6379   <span class=\"comment\"># 存储到 172.16.182.226 Master 节点中</span></span><br><span class=\"line\">OK</span><br><span class=\"line\">172.16.182.226:6379&gt; <span class=\"built_in\">set</span> demo Redis-Cluster                   <span class=\"comment\"># 存储到 172.16.183.81 Master 节点中</span></span><br><span class=\"line\">-&gt; Redirected to slot [903] located at 172.16.183.81:6379</span><br><span class=\"line\">OK</span><br><span class=\"line\">172.16.183.81:6379&gt; <span class=\"built_in\">set</span> web www.weiyigeek.top</span><br><span class=\"line\">-&gt; Redirected to slot [9635] located at 172.16.182.226:6379   <span class=\"comment\"># 存储到 172.16.182.226 Master 节点中</span></span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure></p>\n<p>Tips: 可以看到写入的数据根据分配的数据槽,分别存储在redis集群中各个对应的Master节点上.</p>\n<p><br></p>\n<p><strong>Step 9.利用redis-cli客户端工具连接查看集群</strong><br>描述: 有时你的主机里面没有redis-tools相关工具时,并且在k8s中搭建的redis集群,如果想通过一些可视化的工具访问时,必须要进行代理访问,所以说非常的不方便,为了方便测试与调试,我们可以在k8s中部署带又redis-cli相关工具的容器.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee redis-cli.yml&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: redis-cli</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: redis-cli</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: redis-cli</span><br><span class=\"line\">      port: 8080</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: redis-cli</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: redis-cli</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: redis-cli</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: redis-cli</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: redis-cli</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: redis-cli</span><br><span class=\"line\">          image: redis:6.2.4-alpine</span><br><span class=\"line\">          <span class=\"built_in\">command</span>:</span><br><span class=\"line\">            - <span class=\"string\">\"top\"</span></span><br><span class=\"line\">            - <span class=\"string\">\"-d\"</span></span><br><span class=\"line\">            - <span class=\"string\">\"360\"</span></span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            limits:</span><br><span class=\"line\">              cpu: 1000m</span><br><span class=\"line\">              memory: 1024Mi</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署</span></span><br><span class=\"line\">kubectl create --save-config -f redis-cli.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看Pod状态</span></span><br><span class=\"line\">kubectl get pod -n monitor -l app=redis-cli -o wide</span><br><span class=\"line\">  NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">  redis-cli-5f786d69f-nckbt   1/1     Running   0          75d   172.19.6.14   aiserver   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用其连接redis集群</span></span><br><span class=\"line\">kubectl  -n monitor <span class=\"built_in\">exec</span> -it redis-cli-5f786d69f-nckbt -- sh -c <span class=\"string\">\"redis-cli -h redis-cluster.database.svc.cluster.local -c -a weiyigeek.top\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>总结:</strong><br>Redis是一个强大的数据存储和缓存工具。因为Redis存储数据的方式，Redis集群更是能通过提供分片、相关性能优势、线性扩展和高可用性，来进一步扩展其功能。数据在多个节点之间自动分割，即使节点的子集出现故障或者不能和集群其他部分通信，操作仍然能够继续。</p>\n<p><br></p>\n<h4 id=\"3-使用实践\"><a href=\"#3-使用实践\" class=\"headerlink\" title=\"3.使用实践\"></a>3.使用实践</h4><p><strong>One,应用连接写入测试</strong><br>描述: 我编写了一个java应用来测试数据的写入,以下是资源清单以及实践结果.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 配置清单</span></span><br><span class=\"line\">cat &gt; redis-cluster-connect.yaml &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">apiVersion: v1 </span><br><span class=\"line\">kind: Pod </span><br><span class=\"line\">metadata:</span><br><span class=\"line\"> name: redis-test</span><br><span class=\"line\"> namespace: default </span><br><span class=\"line\"> labels:</span><br><span class=\"line\">  app: redis-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: redis-test</span><br><span class=\"line\">    image: java:8</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - <span class=\"string\">\"java\"</span></span><br><span class=\"line\">    - <span class=\"string\">\"-jar\"</span></span><br><span class=\"line\">    - <span class=\"string\">\"/app/redis.jar\"</span></span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">      - name: app</span><br><span class=\"line\">        mountPath: /app</span><br><span class=\"line\">      - name: timezone</span><br><span class=\"line\">        mountPath: /etc/localtime       <span class=\"comment\"># 在Pod中时区设置(挂载主机的时区)</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">    - name: app</span><br><span class=\"line\">      hostPath:</span><br><span class=\"line\">        path: /nfsdisk-31/<span class=\"built_in\">test</span></span><br><span class=\"line\">    - name: timezone </span><br><span class=\"line\">      hostPath:</span><br><span class=\"line\">        path: /usr/share/zoneinfo/Asia/Shanghai </span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 部署配置</span></span><br><span class=\"line\">kubectl create -f redis-cluster-connect.yaml</span><br><span class=\"line\"><span class=\"comment\"># - 运行状态</span></span><br><span class=\"line\">kubectl get pod -l app=redis-test -o wide</span><br><span class=\"line\">  <span class=\"comment\"># NAME         READY   STATUS    RESTARTS   AGE     IP              NODE   </span></span><br><span class=\"line\">  <span class=\"comment\"># redis-test   1/1     Running   0          5m57s   172.16.183.76   WeiyiGeek-225</span></span><br><span class=\"line\"><span class=\"comment\"># - 运行日志</span></span><br><span class=\"line\">kubectl logs redis-test  | more</span><br><span class=\"line\"><span class=\"comment\"># 测试输出</span></span><br><span class=\"line\">  <span class=\"comment\"># host:redis-test</span></span><br><span class=\"line\">  <span class=\"comment\"># ip:172.16.183.76</span></span><br><span class=\"line\">  <span class=\"comment\"># # 写入了10W的数据</span></span><br><span class=\"line\">  <span class=\"comment\"># # Set Keys start ------ Wed Sep 08 07:59:24 UTC 2021  </span></span><br><span class=\"line\">  <span class=\"comment\"># # Set Keys end ------ Wed Sep 08 08:05:27 UTC 2021</span></span><br><span class=\"line\">  <span class=\"comment\"># # Get Keys start ------</span></span><br><span class=\"line\">  <span class=\"comment\"># Wed Sep 08 08:05:27 UTC 2021</span></span><br><span class=\"line\">  <span class=\"comment\"># 0 - clusterredis-test1631087965024 : Ip:172.16.183.76 - Time:Wed Sep 08 07:59:25 UTC 2021</span></span><br><span class=\"line\">  <span class=\"comment\"># 1 - clusterredis-test1631087965033 : Ip:172.16.183.76 - Time:Wed Sep 08 07:59:25 UTC 2021</span></span><br><span class=\"line\">  <span class=\"comment\"># 2 - clusterredis-test1631087965035 : Ip:172.16.183.76 - Time:Wed Sep 08 07:59:25 UTC 2021</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 库中Keys总量</span></span><br><span class=\"line\">redis-cluster.database.svc.cluster.local:6379&gt; info keyspace</span><br><span class=\"line\">  <span class=\"comment\"># # Keyspace</span></span><br><span class=\"line\">  <span class=\"comment\"># db0:keys=200000,expires=0,avg_ttl=0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过通配符匹配keys名称</span></span><br><span class=\"line\">redis-cluster.database.svc.cluster.local:6379&gt; keys clusterredis-test16310880576*</span><br><span class=\"line\">  <span class=\"comment\"># 1) \"clusterredis-test1631088057679\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 2) \"clusterredis-test1631088057605\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 3) \"clusterredis-test1631088057622\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 4) \"clusterredis-test1631088057644\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取键值</span></span><br><span class=\"line\">redis-cli -h redis-cluster.database.svc.cluster.local -c -a weiyigeek.top</span><br><span class=\"line\">redis-cluster.database.svc.cluster.local:6379&gt; get <span class=\"string\">\"clusterredis-test1631088057644\"</span></span><br><span class=\"line\"><span class=\"string\">\"Ip:172.16.183.76 - Time:Wed Sep 08 08:00:57 UTC 2021\"</span></span><br><span class=\"line\">redis-cluster.database.svc.cluster.local:6379&gt; get <span class=\"string\">\"clusterredis-test1631088057645\"</span></span><br><span class=\"line\">-&gt; Redirected to slot [8995] located at 172.16.24.194:6379</span><br><span class=\"line\"><span class=\"string\">\"Ip:172.16.183.76 - Time:Wed Sep 08 08:00:57 UTC 2021\"</span></span><br><span class=\"line\">172.16.24.194:6379&gt;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"2-Redis-cluster-operator-集群构建\"><a href=\"#2-Redis-cluster-operator-集群构建\" class=\"headerlink\" title=\"(2) Redis-cluster-operator 集群构建\"></a>(2) Redis-cluster-operator 集群构建</h3><p><strong>资源清单</strong><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; redis-StatefulSet.yaml &lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-app</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"redis-service\"</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">      appCluster:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">        appCluster:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      terminationGracePeriodSeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\"><span class=\"attr\">      affinity:</span></span><br><span class=\"line\"><span class=\"attr\">        podAntiAffinity:</span></span><br><span class=\"line\"><span class=\"attr\">          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\"><span class=\"attr\">          - weight:</span> <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"attr\">            podAffinityTerm:</span></span><br><span class=\"line\"><span class=\"attr\">              labelSelector:</span></span><br><span class=\"line\"><span class=\"attr\">                matchExpressions:</span></span><br><span class=\"line\"><span class=\"attr\">                - key:</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">                  operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\"><span class=\"attr\">                  values:</span></span><br><span class=\"line\"><span class=\"bullet\">                  -</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">              topologyKey:</span> <span class=\"string\">kubernetes.io/hostname</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">\"redis\"</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"redis-server\"</span>                  <span class=\"comment\">#redis启动命令</span></span><br><span class=\"line\"><span class=\"attr\">        args:</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"/etc/redis/redis.conf\"</span>         <span class=\"comment\">#redis-server后面跟的参数,换行代表空格</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"--protected-mode\"</span>              <span class=\"comment\">#允许外网访问</span></span><br><span class=\"line\"><span class=\"bullet\">          -</span> <span class=\"string\">\"no\"</span></span><br><span class=\"line\">        <span class=\"comment\"># command: redis-server /etc/redis/redis.conf --protected-mode no</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span>                          <span class=\"comment\">#资源</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span>                         <span class=\"comment\">#请求的资源</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"string\">\"300m\"</span>                     <span class=\"comment\">#m代表千分之,相当于0.1 个cpu资源</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"string\">\"800Mi\"</span>                 <span class=\"comment\">#内存100m大小</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">              containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">\"TCP\"</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">cluster</span></span><br><span class=\"line\"><span class=\"attr\">              containerPort:</span> <span class=\"number\">16379</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">\"TCP\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">\"redis-conf\"</span>              <span class=\"comment\">#挂载configmap生成的文件</span></span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">\"/etc/redis\"</span>         <span class=\"comment\">#挂载到哪个路径下</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">\"redis-data\"</span>              <span class=\"comment\">#挂载持久卷的路径</span></span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">\"/var/lib/redis\"</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">\"redis-conf\"</span>                  <span class=\"comment\">#引用configMap卷</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">\"redis-conf\"</span></span><br><span class=\"line\"><span class=\"attr\">          items:</span></span><br><span class=\"line\"><span class=\"attr\">            - key:</span> <span class=\"string\">\"redis.conf\"</span>             <span class=\"comment\">#创建configMap指定的名称</span></span><br><span class=\"line\"><span class=\"attr\">              path:</span> <span class=\"string\">\"redis.conf\"</span>            <span class=\"comment\">#里面的那个文件--from-file参数后面的文件</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span>                     <span class=\"comment\">#进行pvc持久卷声明,</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">redis-data</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span> <span class=\"string\">[\"ReadWriteMany\"]</span></span><br><span class=\"line\"><span class=\"attr\">      storageClassName:</span> <span class=\"string\">\"managed-nfs-storage\"</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">10</span><span class=\"string\">G</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>服务资源</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; redis-headless-service.yml &lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">redis-port</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    nodePort:</span> <span class=\"number\">31001</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    appCluster:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"bullet\">-f</span> <span class=\"string\">redis-headless-service.yml</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>集群资源清单</strong><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; redis-cluster-5.0.10.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"comment\"># if your operator run as cluster-scoped, add this annotations</span></span><br><span class=\"line\">    <span class=\"string\">redis.kun/scope:</span> <span class=\"string\">cluster-scoped</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-secret</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">Opaque</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  password:</span> <span class=\"string\">UTNGNmF5NWoyMDI=</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span>   <span class=\"comment\"># 空间标注</span></span><br><span class=\"line\">    <span class=\"string\">volume.beta.kubernetes.io/storage-class:</span> <span class=\"string\">\"managed-nfs-storage\"</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  accessModes:</span> <span class=\"string\">[\"ReadWriteMany\"]</span></span><br><span class=\"line\"><span class=\"attr\">  resources:</span></span><br><span class=\"line\"><span class=\"attr\">    requests:</span></span><br><span class=\"line\"><span class=\"attr\">      storage:</span> <span class=\"number\">1</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">redis.kun/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DistributedRedisCluster</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"comment\"># if your operator run as cluster-scoped, add this annotations</span></span><br><span class=\"line\">    <span class=\"string\">redis.kun/scope:</span> <span class=\"string\">cluster-scoped</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">example-distributedrediscluster</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"attr\">redis:5.0.10-alpine</span></span><br><span class=\"line\"><span class=\"attr\">  masterSize:</span> <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"attr\">  clusterReplicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  config:</span></span><br><span class=\"line\"><span class=\"attr\">    activerehashing:</span> <span class=\"string\">\"yes\"</span></span><br><span class=\"line\"><span class=\"attr\">    appendfsync:</span> <span class=\"string\">everysec</span></span><br><span class=\"line\"><span class=\"attr\">    appendonly:</span> <span class=\"string\">\"yes\"</span></span><br><span class=\"line\"><span class=\"attr\">    hash-max-ziplist-entries:</span> <span class=\"string\">\"512\"</span></span><br><span class=\"line\"><span class=\"attr\">    hash-max-ziplist-value:</span> <span class=\"string\">\"64\"</span></span><br><span class=\"line\"><span class=\"attr\">    hll-sparse-max-bytes:</span> <span class=\"string\">\"3000\"</span></span><br><span class=\"line\"><span class=\"attr\">    list-compress-depth:</span> <span class=\"string\">\"0\"</span></span><br><span class=\"line\"><span class=\"attr\">    maxmemory-policy:</span> <span class=\"string\">noeviction</span></span><br><span class=\"line\"><span class=\"attr\">    maxmemory-samples:</span> <span class=\"string\">\"5\"</span></span><br><span class=\"line\"><span class=\"attr\">    no-appendfsync-on-rewrite:</span> <span class=\"string\">\"no\"</span></span><br><span class=\"line\"><span class=\"attr\">    notify-keyspace-events:</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"attr\">    set-max-intset-entries:</span> <span class=\"string\">\"512\"</span></span><br><span class=\"line\"><span class=\"attr\">    slowlog-log-slower-than:</span> <span class=\"string\">\"10000\"</span></span><br><span class=\"line\"><span class=\"attr\">    slowlog-max-len:</span> <span class=\"string\">\"128\"</span></span><br><span class=\"line\"><span class=\"attr\">    stop-writes-on-bgsave-error:</span> <span class=\"string\">\"yes\"</span></span><br><span class=\"line\"><span class=\"attr\">    tcp-keepalive:</span> <span class=\"string\">\"0\"</span></span><br><span class=\"line\"><span class=\"attr\">    timeout:</span> <span class=\"string\">\"0\"</span></span><br><span class=\"line\"><span class=\"attr\">    zset-max-ziplist-entries:</span> <span class=\"string\">\"128\"</span></span><br><span class=\"line\"><span class=\"attr\">    zset-max-ziplist-value:</span> <span class=\"string\">\"64\"</span></span><br><span class=\"line\"><span class=\"attr\">  passwordSecret:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">redis-secret</span></span><br><span class=\"line\"><span class=\"attr\">  resources:</span></span><br><span class=\"line\"><span class=\"attr\">    limits:</span></span><br><span class=\"line\"><span class=\"attr\">      cpu:</span> <span class=\"number\">500</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">      memory:</span> <span class=\"number\">500</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">    requests:</span></span><br><span class=\"line\"><span class=\"attr\">      cpu:</span> <span class=\"number\">200</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">      memory:</span> <span class=\"number\">100</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">redis-svc</span></span><br><span class=\"line\"><span class=\"attr\">  storage:</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">persistent-claim</span></span><br><span class=\"line\"><span class=\"attr\">    size:</span> <span class=\"number\">1</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"attr\">    class:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">    deleteClaim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Database","path":"api/categories/Database.json"}],"tags":[{"name":"Redis","path":"api/tags/Redis.json"}]}