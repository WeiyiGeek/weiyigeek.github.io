{"title":"Ansible自动化运维工具常规记录","slug":"系统运维/自动化运维/Ansible/Ansible自动化运维工具常规记录","date":"2022-04-28T06:34:30.000Z","updated":"2022-05-25T02:07:59.782Z","url":"2022/4-28-657.html","path":"api/articles/2022/4-28-657.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-入坑出坑\"><a href=\"#0x00-入坑出坑\" class=\"headerlink\" title=\"0x00 入坑出坑\"></a>0x00 入坑出坑</h2><h3 id=\"1-Ansible-如何切换用户建立SSH并使用sudo权限执行程序。\"><a href=\"#1-Ansible-如何切换用户建立SSH并使用sudo权限执行程序。\" class=\"headerlink\" title=\"1.Ansible 如何切换用户建立SSH并使用sudo权限执行程序。\"></a>1.Ansible 如何切换用户建立SSH并使用sudo权限执行程序。</h3><p>描述: 在使用Ansible往往赋予其低权限用户, 假如由于项目需求，需要使用ansible在控制节点以root身份运行playbook，并在playbook中调用其他程序操作/etc下的文件，所以该程序需要使用sudo或者root权限运行，我们应该如何配置。</p>\n<p><strong>操作步骤:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.客户端-生成ssh公密钥</span></span><br><span class=\"line\"><span class=\"comment\"># 【注：切换到建立ssh连接的用户weiyigeek运行: su weiyigeek，因为该认证文件只适用于本用户weiyigeek与其他用户的ssh连接认证】</span></span><br><span class=\"line\">ssh-keygen</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.拷贝ssh公钥到被控制机器节点</span></span><br><span class=\"line\">ssh-copy-id -i ~/.ssh/id_rsa.pub weiyigeek@xx.xx.xx.xx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.客户端-在root用户的环境中运行之前建好的test.yml文件</span></span><br><span class=\"line\">ansible-playbook test.yml --user=weiyigeek --private-key=/home/weiyigeek/.ssh/id_rsa -s </span><br><span class=\"line\"><span class=\"comment\"># 参数说明: </span></span><br><span class=\"line\"><span class=\"comment\"># --user=weiyigeek 表示使用weiyigeek与被控节点的weiyigeek建立ssh连接。</span></span><br><span class=\"line\"><span class=\"comment\"># --private-key表示ssh使用的认证文件。</span></span><br><span class=\"line\"><span class=\"comment\"># -s 表示在连接到被控制机器节点后使用weiyigeek 的sudo权限运行test.yml中的命令。</span></span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: ansible 输入 weiyigeek 用户的sudo密码有两种配置方式，一种是在命令行中添加<code>--ask-sudo-pass</code>, 另外一种则是在ansible的配置文件<code>/etc/ansible/hosts</code>中配置sudo密码。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 此处采用第二种方式</span></span><br><span class=\"line\">[node-1]</span><br><span class=\"line\">192.168.1.108 ansible_user=<span class=\"string\">'WeiyiGeek'</span> ansible_sudo_pass=<span class=\"string\">'123456'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[node-2]</span><br><span class=\"line\">192.168.1.107 ansible_sudo_pass=<span class=\"string\">'123456'</span></span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 可能会遇到的问题，在拷贝玩ssh文件到被控制主机后，第一次运行会出现检查keys的对话，导致ssh连接失败，如下所示, 所以为了解决该问题我们可以在ansible的默认配置文件<code>/etc/ansible/ansible.cfg</code>中, 添加如下语句即可 <code>host_key_checking = False</code>.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The authenticity of host <span class=\"string\">'192.168.0.5 (192.168.0.5)'</span> can\\<span class=\"string\">'t be established.</span></span><br><span class=\"line\"><span class=\"string\">ECDSA key fingerprint is 05:51:e5:c4:d4:66:9b:af:5b:c9:ba:e9:e6:a4:2b:fe.</span></span><br><span class=\"line\"><span class=\"string\">Are you sure you want to continue connecting (yes/no)?</span></span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"自动化运维","path":"api/categories/自动化运维.json"},{"name":"运维基础","path":"api/categories/运维基础.json"}],"tags":[{"name":"Ansible","path":"api/tags/Ansible.json"}]}