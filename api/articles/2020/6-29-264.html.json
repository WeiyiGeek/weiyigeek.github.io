{"title":"Phantomjs网页前端自动化测试之利器","slug":"系统运维/自动化测试/Phantomjs/Phantomjs网页前端自动化测试之利器","date":"2020-06-29T06:34:30.000Z","updated":"2022-09-30T08:43:17.424Z","url":"2020/6-29-264.html","path":"api/articles/2020/6-29-264.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言基础\"><a href=\"#0x00-前言基础\" class=\"headerlink\" title=\"0x00 前言基础\"></a>0x00 前言基础</h4><p>描述:Phantomjs <code>/ˈfæntəm/js</code>是一个基于webkit的JavaScript API实现网页前端自动化测试。它使用QtWebKit作为它核心浏览器的功能，使用webkit来编译解释执行JavaScript代码。任何你可以在基于webkit浏览器做的事情它都能做到，可以使用js编写业务脚本来请求、浏览和操作页面，可以将它看做一个是<code>一个无界面浏览器</code>。</p>\n<p>它不仅是个隐形的浏览器，提供了诸如CSS选择器、支持Web标准、DOM操作、JSON、HTML5、Canvas、SVG等，同时也提供了处理文件I/O的操作，从而使你可以向操作系统读写文件等.</p>\n<p>PhantomJS的用处可谓非常广泛，诸如<code>网络监测、网页截屏、无需浏览器的 Web 测试、页面访问自动化</code>等。</p>\n<p><em>附录说明:</em></p>\n<ul>\n<li>官方地址:<a href=\"http://phantomjs.org/\" target=\"_blank\" rel=\"noopener\">http://phantomjs.org/</a></li>\n<li>PhantomJS GitHub：<a href=\"https://github.com/ariya/phantomjs/\" target=\"_blank\" rel=\"noopener\">https://github.com/ariya/phantomjs/</a></li>\n<li>PhantomJS官方API：<a href=\"http://phantomjs.org/api/\" target=\"_blank\" rel=\"noopener\">http://phantomjs.org/api/</a></li>\n<li>PhantomJS官方示例：<a href=\"http://phantomjs.org/examples/\" target=\"_blank\" rel=\"noopener\">http://phantomjs.org/examples/</a></li>\n</ul>\n<hr>\n<h4 id=\"0x01-应用安装\"><a href=\"#0x01-应用安装\" class=\"headerlink\" title=\"0x01 应用安装\"></a>0x01 应用安装</h4><p>描述:下面会根据使用场景从而不同的应用系统发行版本里安装Phantomjs流程:</p>\n<h4 id=\"Windows\"><a href=\"#Windows\" class=\"headerlink\" title=\"Windows\"></a>Windows</h4><p>描述:首先我们需要在下载<a href=\"https://phantomjs.org/download.html\" target=\"_blank\" rel=\"noopener\">PhantomJS</a>，选择Windows运行的版本进行下载，然后放在一个指定目录中（建议加上环境变量）；<br><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$systempath</span> = [System.Environment]::GetEnvironmentVariable(<span class=\"string\">\"PATH\"</span>,<span class=\"string\">\"Machine\"</span>)</span><br><span class=\"line\"><span class=\"variable\">$systempath</span> = <span class=\"variable\">$systempath</span> + <span class=\"string\">\";\"</span> + <span class=\"string\">\"D:\\WeiyiGeek\\PhantomJS\\bin\"</span></span><br><span class=\"line\">[System.Environment]::setEnvironmentVariable(<span class=\"string\">\"PATH\"</span>,<span class=\"variable\">$systempath</span>,<span class=\"string\">\"Machine\"</span>)</span><br></pre></td></tr></table></figure></p>\n<p>下载操作PS:<br><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$InstallPath</span>=<span class=\"string\">\"F:\\WeiyiGeek\\Tools\"</span></span><br><span class=\"line\"><span class=\"variable\">$InstallUrl</span>=<span class=\"string\">\"https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-windows.zip\"</span></span><br><span class=\"line\">mkdir <span class=\"variable\">$InstallPath</span></span><br><span class=\"line\"><span class=\"variable\">$down</span>=<span class=\"built_in\">New-Object</span> <span class=\"string\">\"System.Net.WebClient\"</span></span><br><span class=\"line\"><span class=\"variable\">$down</span>.DownloadFile(<span class=\"variable\">$InstallUrl</span>,<span class=\"string\">\"$&#123;InstallPath&#125;\\phantomjs-2.1.1-windows.zip\"</span>)</span><br><span class=\"line\">Expand-Archive -Path <span class=\"string\">\"$&#123;InstallPath&#125;/phantomjs-2.1.1-windows.zip\"</span> -DestinationPath <span class=\"variable\">$InstallPath</span> -Force</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"CentOS7\"><a href=\"#CentOS7\" class=\"headerlink\" title=\"CentOS7\"></a>CentOS7</h4><p>基础软件安装:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install jq || yum install jq</span><br></pre></td></tr></table></figure></p>\n<p>命令执行如下:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class=\"line\">yum install bzip2 <span class=\"comment\"># 安装bzip2</span></span><br><span class=\"line\">tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class=\"line\">mv phantomjs-2.1.1-linux-x86_64/ /usr/<span class=\"built_in\">local</span>/src/phantomjs</span><br><span class=\"line\">ln -sf /usr/<span class=\"built_in\">local</span>/src/phantomjs/bin/phantomjs /usr/<span class=\"built_in\">local</span>/bin/phantomjs</span><br><span class=\"line\">phantomjs -v <span class=\"comment\"># 测试版本号</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装中文字体</span></span><br><span class=\"line\">yum install fontconfig freetype2 -y</span><br><span class=\"line\">yum install bitmap-fonts bitmap-fonts-cjk -y</span><br><span class=\"line\">yum groupinstall <span class=\"string\">\"fonts\"</span> -y <span class=\"comment\"># 安装字体相关的依赖包</span></span><br><span class=\"line\"><span class=\"built_in\">fc</span>-cache <span class=\"comment\"># 刷新字体缓存</span></span><br></pre></td></tr></table></figure></p>\n<p>Ubuntu:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.拷贝windows字体(C:\\Windows\\Fonts)至/usr/share/fonts/Windows-Fonts, </span></span><br><span class=\"line\">mkdir /usr/share/fonts/Windows-Fonts</span><br><span class=\"line\">chmod -R 644 /usr/share/fonts/Windows-Fonts &amp;&amp; <span class=\"built_in\">cd</span> /usr/share/fonts/Windows-Fonts</span><br><span class=\"line\">mkfontscale &amp;&amp; mkfontdir &amp;&amp; <span class=\"built_in\">fc</span>-cache</span><br><span class=\"line\">ln -s /usr/share/fonts/Windows-Fonts /usr/lib/x86_64-linux-gnu/fonts </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.安装系统字体相关工具</span></span><br><span class=\"line\">sudo apt install -y fontconfig xfonts-utils</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"0x02-使用入门\"><a href=\"#0x02-使用入门\" class=\"headerlink\" title=\"0x02 使用入门\"></a>0x02 使用入门</h4><p>hantomjs 使用<br>PhantomJS 基础示例参考目录:<code>/usr/local/src/phantomjs/examples/</code></p>\n<h4 id=\"0x03-自定义脚本\"><a href=\"#0x03-自定义脚本\" class=\"headerlink\" title=\"0x03 自定义脚本\"></a>0x03 自定义脚本</h4><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">操作界面中的DOM树主要使用使用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">evaluate(<span class=\"function\"><span class=\"keyword\">function</span>, <span class=\"title\">arg1</span>, <span class=\"title\">arg2</span>, ...) </span>&#123;object&#125;  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//完整截图几种方式</span></span><br><span class=\"line\"><span class=\"comment\">//方式1:设置viewPortSize</span></span><br><span class=\"line\">page.viewportSize = &#123;<span class=\"attr\">width</span>: <span class=\"number\">4800</span>,<span class=\"attr\">height</span>: <span class=\"number\">8000</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//方式2:通过BOM方法操作滚动条</span></span><br><span class=\"line\"><span class=\"built_in\">window</span>.scrollTo(<span class=\"number\">0</span>,<span class=\"number\">10000</span>);</span><br><span class=\"line\">window.document.body.scrollTop = document.body.scrollHeight; #适应的高度</span><br></pre></td></tr></table></figure>\n<p>如何延迟截图，页面请求的资源，如图片、异步cgi、js等，返回的时间以及执行的长短都是不确定的，如果截图过早，可能很多空白区域，因此需要定时截图，在打开页面后，使用setTimeout来延迟截图<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.setTimeout(<span class=\"function\"><span class=\"title\">function</span></span> () &#123;  </span><br><span class=\"line\">        page.render(<span class=\"string\">\"test.png\"</span>);  </span><br><span class=\"line\">        phantom.exit();  </span><br><span class=\"line\"> &#125;, 1000);</span><br></pre></td></tr></table></figure></p>\n<p>phantomjs - phantomjs CasperJS: 如何退出脚本执行？<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">casper.test.begin(<span class=\"string\">'Exit'</span>, <span class=\"keyword\">function</span> suite(<span class=\"built_in\">test</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> casper.exit();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure></p>\n<p>这里附上java操作phantomjs的代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.newsTest.weixin;  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.BufferedReader;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStream;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStreamReader;  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\"> * 类名： DownLoad </span></span><br><span class=\"line\"><span class=\"comment\"> * 包名： com.newsTest.weixin </span></span><br><span class=\"line\"><span class=\"comment\"> * 作者： zhouyh </span></span><br><span class=\"line\"><span class=\"comment\"> * 时间： 2014-9-10 下午04:19:46 </span></span><br><span class=\"line\"><span class=\"comment\"> * 描述： TODO(这里用一句话描述这个类的作用)  </span></span><br><span class=\"line\"><span class=\"comment\"> */</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicDownLoad</span> </span>&#123;  </span><br><span class=\"line\">    <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">     *  </span></span><br><span class=\"line\"><span class=\"comment\">     * 方法名：getSrcContent </span></span><br><span class=\"line\"><span class=\"comment\">     * 作者：zhouyh </span></span><br><span class=\"line\"><span class=\"comment\">     * 创建时间：2014-9-10 下午06:57:32 </span></span><br><span class=\"line\"><span class=\"comment\">     * 描述：根据传入的url，调用phantomjs进行下载，并返回源码信息 </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> </span></span><br><span class=\"line\"><span class=\"comment\">     */</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">getSrcContent</span><span class=\"params\">(String url)</span></span>&#123;  </span><br><span class=\"line\">        <span class=\"comment\">//windows下phantomjs位置  </span></span><br><span class=\"line\">        String path = <span class=\"string\">\"D:/phantomjs-1.9.7-windows/\"</span>;  </span><br><span class=\"line\">        Runtime rt = Runtime.getRuntime();  </span><br><span class=\"line\">        Process process = <span class=\"keyword\">null</span>;  </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            process = rt.exec(path + <span class=\"string\">\"phantomjs.exe D:/phantomjs-1.9.7-windows/test.js \"</span> + url.trim());  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;  </span><br><span class=\"line\">            <span class=\"comment\">// TODO 这里写异常处理的代码  </span></span><br><span class=\"line\">            e.printStackTrace();  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        InputStream is = process.getInputStream();  </span><br><span class=\"line\">        BufferedReader br = <span class=\"keyword\">new</span> BufferedReader(<span class=\"keyword\">new</span> InputStreamReader(is));  </span><br><span class=\"line\">        StringBuffer sbf = <span class=\"keyword\">new</span> StringBuffer();  </span><br><span class=\"line\">        String tmp = <span class=\"string\">\"\"</span>;  </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">while</span>((tmp = br.readLine())!=<span class=\"keyword\">null</span>)&#123;    </span><br><span class=\"line\">                sbf.append(tmp);    </span><br><span class=\"line\">            &#125;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;  </span><br><span class=\"line\">            <span class=\"comment\">// TODO 这里写异常处理的代码  </span></span><br><span class=\"line\">            e.printStackTrace();  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">          </span><br><span class=\"line\">        <span class=\"keyword\">return</span> sbf.toString();  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br><span class=\"line\">    <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">     * 方法名：main </span></span><br><span class=\"line\"><span class=\"comment\">     * 作者：zhouyh </span></span><br><span class=\"line\"><span class=\"comment\">     * 创建时间：2014-9-10 下午04:19:46 </span></span><br><span class=\"line\"><span class=\"comment\">     * 描述：TODO(这里用一句话描述这个方法的作用) </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> args </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> IOException  </span></span><br><span class=\"line\"><span class=\"comment\">     */</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span></span>&#123;  </span><br><span class=\"line\">        <span class=\"comment\">// TODO Auto-generated method stub  </span></span><br><span class=\"line\">        String src = DynamicDownLoad.getSrcContent(<span class=\"string\">\"http://weixin.sogou.com/gzh?openid=oIWsFt9MmzCvfJgaVxEUevPcuUCg\"</span>);  </span><br><span class=\"line\">        System.out.println(src);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>补充：对于延迟截图，还是有个问题，就是无法监听ajax或者资源是否完整加载导致页面不全；解决方案，viewport设置一个比截图高度的矮，通过比较生产图片的高度来判断截取图片的结果</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"自动化测试","path":"api/categories/自动化测试.json"},{"name":"运维基础","path":"api/categories/运维基础.json"}],"tags":[{"name":"Phantomjs","path":"api/tags/Phantomjs.json"}]}