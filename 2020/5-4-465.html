<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 Docker容器Registry私有镜像仓库安全配置与GC回收实践|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Docker">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
        
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>Docker容器Registry私有镜像仓库安全配置与GC回收实践</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">Docker容器Registry私有镜像仓库安全配置与GC回收实践</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-05-04T06:36:30.000Z" itemprop="datePublished" class="page-time">
  2020-05-04
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-虚拟云容/云容器/Docker/奇技淫巧/3.Docker容器Registry私有镜像仓库安全配置与GC回收实践"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">Docker容器Registry私有镜像仓库安全配置与GC回收实践</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-05-04 14:36:30" datetime="2020-05-04T06:36:30.000Z"  itemprop="datePublished">2020-05-04</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h4 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h4><p>描述:本来我想直接写Harbor的Docker镜像仓库搭建配置与使用，但是觉得还是应该从基础的Docker的Registry镜像讲起从安全构建到GC回收同时加深学习映像;</p>
<p>官网介绍:Registry是一个无状态的，高度可扩展的服务器端应用程序，存储，让你分发图像。它是开源的根据许可Apache许可证。</p>
<p>此时就不在详细讲解Registry的介绍了，有兴趣的朋友可以参见官网文档或者前面我笔记中的介绍;<br>以下是一些知识点复习:</p>
<ul>
<li>(1) Registry是一个几种存放image并对外提供上传下载以及一系列API的服务,Registry与镜像的关系可以想象成自己机器上的源码和远端SVN或者Git服务的关系，可以很容易和本地源代码以及远端Git服务的关系相对应。</li>
<li>(2) Registry开源常用于构建私有镜像仓库;</li>
</ul>
<p>Q:为什么不直接采用Docker官网Hub作为存储镜像的地方?</p>
<blockquote>
<p>答:我认为主要是以下几个方面的影响<br>1.存储空间有限<br>2.上传/拉取速度有限<br>3.企业内部敏感开发项目(如果是您肯定不会上传到别人的服务器中)<br>4.免费开源</p>
</blockquote>
<p>反之使用Registey好处:</p>
<ul>
<li>镜像存储位置由您掌握</li>
<li>全面管理控制自己的镜像</li>
<li>镜像存储和分配紧密集成到您的内部开发流程</li>
</ul>
<p>Registry 版本说明:</p>
<ul>
<li>Docker Registry 1.0版本(hub/docker.io等公共的镜像仓库还支持，安全性以及兼容性不如V2.0)</li>
<li>Docker Registry 2.0版本在安全性和性能上做了诸多优化，并重新设计了镜像的存储的格式;(<code>Docker目前1.6之后支持V2</code>)</li>
</ul>
<p>名词解释:</p>
<ul>
<li>1.repository name(存储库名词) 存储库指在库中存储的镜像。<code>/project/redis:latest</code><ul>
<li>经典存储库名称由2级路径构成，每级路径小于30个字符，V2的api不强制要求这样的格式。</li>
<li>每级路径名至少有一个小写字母或者数字，使用句号，破折号和下划线分割。更严格来说，它必须符合正则表达式：<code>[a-z0-9]+[._-][a-z0-9]+)</code></li>
<li>多级路径用/分隔</li>
<li>存储库名称总长度（包括/）不能超过256个字符</li>
</ul>
</li>
<li>2.digest(摘要) 摘要是镜像每个层的唯一标示。虽然算法允许使用任意算法，但是为了兼容性应该使用sha256。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">例如 - sha256:6c3c624b58dbbcd3c0dd82b4c53f04194d1247c6eebdaab7c610cf7d66709b3b</span><br><span class="line"><span class="comment"># 用一个简单的例子，在伪代码来演示摘要计算</span></span><br><span class="line"><span class="built_in">let</span> C = <span class="string">'a small string'</span></span><br><span class="line"><span class="built_in">let</span> B = sha256(C)</span><br><span class="line"><span class="built_in">let</span> D = <span class="string">'sha256:'</span> + EncodeHex(B)</span><br><span class="line"><span class="built_in">let</span> ID(C) = D</span><br><span class="line"></span><br><span class="line"><span class="comment"># python伪代码</span></span><br><span class="line">import hashlib</span><br><span class="line">C = <span class="string">'a small string'</span></span><br><span class="line">B = hashlib.sha256(C)</span><br><span class="line">D = <span class="string">'sha256:'</span> + B.hexdigest()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="0x01-基础安装"><a href="#0x01-基础安装" class="headerlink" title="0x01 基础安装"></a>0x01 基础安装</h4><p>测试环境:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OS</span></span><br><span class="line">CentOS Linux release 7.8.2003 (Core)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux</span></span><br><span class="line">Server Version: 19.03.9</span><br><span class="line">Storage Driver: overlay2</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h5 id="1-基础命令"><a href="#1-基础命令" class="headerlink" title="1) 基础命令"></a>1) 基础命令</h5><p>基础实例:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.Start your registry</span></span><br><span class="line">docker run -d -p 5000:5000 --restart=always --name registry registry:2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.拉取镜像并修改</span></span><br><span class="line">docker pull ubuntu</span><br><span class="line">docker run --name ubuntu-test -d ubuntu </span><br><span class="line">docker commit -a <span class="string">"Weiyigeek"</span> -m <span class="string">"镜像描述"</span> ubuntu-test ubuntu-custom:1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.Tag the image so that it points to your registry</span></span><br><span class="line">docker image tag ubuntu-custom:1.0 127.0.0.1:5000/ubuntu-custom:1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.从镜像仓储上传与下载镜像</span></span><br><span class="line">docker push localhost:5000/ubuntu-custom:1.0</span><br><span class="line">docker pull localhost:5000/ubuntu-custom:1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.删除本地/远程的ubuntu-custom:1.0</span></span><br><span class="line">docker image remove ubuntu-custom:1.0</span><br><span class="line">docker image remove localhost:5000/ubuntu-custom:1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.registry仓库删除与清除卷;</span></span><br><span class="line">docker container stop registry &amp;&amp; docker container rm -v registry</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="2-基础配置"><a href="#2-基础配置" class="headerlink" title="2) 基础配置"></a>2) 基础配置</h5><p>Registry 镜像环境变量:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Environment variable</span></span><br><span class="line"><span class="comment"># 自定义Registry仓库镜像存放的物理地址</span></span><br><span class="line">REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry</span><br><span class="line"><span class="comment"># 启用DELETE操作否则不能执行 -X DELETE</span></span><br><span class="line">REGISTRY_STORAGE_DELETE_ENABLED=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定Registry地址与端口</span></span><br><span class="line">REGISTRY_HTTP_ADDR=0.0.0.0:5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 证书Certificate设置</span></span><br><span class="line">REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt</span><br><span class="line">REGISTRY_HTTP_TLS_KEY=/certs/domain.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地基础认证</span></span><br><span class="line">REGISTRY_AUTH=htpasswd</span><br><span class="line">REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm</span><br><span class="line">REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd</span><br></pre></td></tr></table></figure></p>
<p>指定环境变量运行Registry仓库:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) docker run 时指定环境变量</span></span><br><span class="line">$ docker run -d \</span><br><span class="line">  --restart=always \</span><br><span class="line">  --name registry \</span><br><span class="line">  -v <span class="string">"<span class="variable">$(pwd)</span>"</span>/auth:/auth \</span><br><span class="line">  -v /opt/docker/registry:/var/lib/registry \</span><br><span class="line">  -v <span class="string">"<span class="variable">$(pwd)</span>"</span>/certs:/certs \</span><br><span class="line">  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \</span><br><span class="line">  -e REGISTRY_STORAGE_DELETE_ENABLED=<span class="literal">true</span> \</span><br><span class="line">  -p 443:443 \</span><br><span class="line">  registry:2</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (2) Yaml 配置</span></span><br><span class="line">docker run -d -p 5000:5000 --restart=always --name registry \</span><br><span class="line">  -v `<span class="built_in">pwd</span>`/config.yml:/etc/docker/registry/config.yml \</span><br><span class="line">  registry:2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如:开发配置的config.yaml</span></span><br><span class="line">version: 0.1</span><br><span class="line"><span class="built_in">log</span>:</span><br><span class="line">  level: debug</span><br><span class="line">storage:</span><br><span class="line">  filesystem:</span><br><span class="line">    rootdirectory: /var/lib/registry</span><br><span class="line">http:</span><br><span class="line">  addr: localhost:5000</span><br><span class="line">  host: https://registry.weiyigeek.top:5000</span><br><span class="line">  secret: asecretforlocaldevelopment</span><br><span class="line">  debug:</span><br><span class="line">    addr: localhost:5001</span><br><span class="line"></span><br><span class="line">auth:</span><br><span class="line">  htpasswd:</span><br><span class="line">    realm: basic-realm</span><br><span class="line">    path: /path/to/htpasswd</span><br></pre></td></tr></table></figure>
<p>参考地址:<a href="https://github.com/docker/distribution/blob/master/cmd/registry/config-example.yml" target="_blank" rel="noopener">https://github.com/docker/distribution/blob/master/cmd/registry/config-example.yml</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (3) docker-compose 构建镜像仓库</span></span><br><span class="line"><span class="comment"># docker-compose.yml </span></span><br><span class="line">registry:</span><br><span class="line">  restart: always</span><br><span class="line">  image: registry:2</span><br><span class="line">  ports:</span><br><span class="line">    - 5000:5000</span><br><span class="line">  environment:</span><br><span class="line">    REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain.crt</span><br><span class="line">    REGISTRY_HTTP_TLS_KEY: /certs/domain.key</span><br><span class="line">    REGISTRY_AUTH: htpasswd</span><br><span class="line">    REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd</span><br><span class="line">    REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm</span><br><span class="line">    REGISTRY_STORAGE_DELETE_ENABLED=<span class="literal">true</span></span><br><span class="line">  volumes:</span><br><span class="line">    - /opt/docker/registry:/var/lib/registry</span><br><span class="line">    - /opt/docker/certs:/certs</span><br><span class="line">    - /opt/docker/auth:/auth</span><br></pre></td></tr></table></figure>
<p><br></p>
<h5 id="3-生产实例"><a href="#3-生产实例" class="headerlink" title="3) 生产实例"></a>3) 生产实例</h5><p>描述:此处以实际生产环境为例进行<code>Docker Registry</code>私有仓库搭建;</p>
<p>3.1) 服务器拉取Docker Registry镜像并创建Autho认证的.htpasswd文件;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull registry:2</span><br><span class="line"><span class="comment"># Digest: sha256:8be26f81ffea54106bae012c6f349df70f4d5e7e2ec01b143c46e2c03b9e551d</span></span><br><span class="line"><span class="comment"># Status: Downloaded newer image for registry:2</span></span><br><span class="line"><span class="comment"># docker.io/library/registry:2</span></span><br><span class="line"></span><br><span class="line">$ mkdir -vp /opt/registry/ &amp;&amp; <span class="built_in">cd</span> <span class="variable">$_</span></span><br><span class="line">htpasswd -Bbn weiyigeek 123456                  <span class="comment"># -n 不更新文件输入到终端标准输出</span></span><br><span class="line">htpasswd -bB -c auth.htpasswd weiyigeek 123456  <span class="comment"># -c 创建存储认证字符串，-b 强制加密密码，-B 在命令行中接收密码</span></span><br></pre></td></tr></table></figure><br>Tips:在Push或者Delete镜像是通过HTTP请求Registry的API完成的，每个请求都需要一个Token才能完成操作，而此Token需要使用auth文件(<code>明文用户/密码编码</code>)来进行鉴权;</p>
<p>3.2) Docker Registry 自签证书<br>描述:如果Registry仓库使用TLS认证时必须带有证书，当外部访问该Registry仓库时候提供安全通道，我们可以在认证机构购买签名证书或者自签证书也可以;<br>使用 OpenSSL 来生成 CA （证书授权中心，certificate authority）、 中级 CA（intermediate CA） 和末端证书（end certificate）。包括 OCSP、CRL 和 CA颁发者Issuer信息、具体颁发和失效日期。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1:交互式证书生成</span></span><br><span class="line"><span class="variable">$openssl</span> req -newkey rsa:4096 -nodes -sha256 -keyout ./certs/domain.key -x509 -days 365 -out ./certs/domain.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2:配置文件方式生成</span></span><br><span class="line">cat &gt;ca.conf &lt;&lt;EOF</span><br><span class="line">[ req ]</span><br><span class="line">default_bits  = 2048</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">prompt   = no</span><br><span class="line">encrypt_key  = no</span><br><span class="line">x509_extensions  = v3_ca</span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">CN = localhost</span><br><span class="line">[ CA_default ]</span><br><span class="line">copy_extensions = copy</span><br><span class="line">[ alternate_names ]</span><br><span class="line">DNS.2=localhost</span><br><span class="line">[ v3_ca ]</span><br><span class="line">subjectAltName=@alternate_names</span><br><span class="line">subjectKeyIdentifier=<span class="built_in">hash</span></span><br><span class="line">authorityKeyIdentifier=keyid:always,issuer:always</span><br><span class="line">basicConstraints = critical,CA:<span class="literal">true</span></span><br><span class="line">keyUsage=keyCertSign,cRLSign,digitalSignature,keyEncipherment,nonRepudiation</span><br><span class="line">EOF</span><br><span class="line">openssl req -days 365 -x509 -config ca.conf -new -keyout certs/domain.key -out certs/domain.crt</span><br></pre></td></tr></table></figure>
<p>3.3) 挂载安全认证与自签证书并启动registry容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 0.0.0.0:8443:5000 --name registry-net \</span><br><span class="line">    -v /var/lib/registry-net:/var/lib/registry \</span><br><span class="line">    -v /opt/registry/certs:/certs \</span><br><span class="line">    -v /opt/registry/auth.htpasswd:/etc/docker/registry/auth.htpasswd \</span><br><span class="line">    -e REGISTRY_AUTH=<span class="string">"&#123;htpasswd: &#123;realm: localhost, path: /etc/docker/registry/auth.htpasswd&#125;&#125;"</span> \</span><br><span class="line">    -e REGISTRY_HTTP_ADDR=0.0.0.0:5000 \</span><br><span class="line">    -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">    -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \</span><br><span class="line">    -e REGISTRY_STORAGE_DELETE_ENABLED=<span class="literal">true</span> \</span><br><span class="line">    registry</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器(只能本地访问)</span></span><br><span class="line"><span class="variable">$docker</span> ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                     NAMES</span><br><span class="line">86bc983e8183        registry            <span class="string">"/entrypoint.sh /etc…"</span>   About a minute ago   Up About a minute   127.0.0.1:443-&gt;5000/tcp   registry</span><br></pre></td></tr></table></figure></p>
<p>3.4) 验证registry是否可登录，登录后账号密码将会base64存储在 /root/.docker/config.json 之中，为后续使用skopeo的时候做准备;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$docker</span> login localhost -u weiyigeek -p 123456</span><br><span class="line"><span class="comment"># WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span></span><br><span class="line"><span class="comment"># WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">cat /root/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"auths"</span>: &#123;</span><br><span class="line">    <span class="string">"https://index.docker.io/v1/"</span>: &#123; <span class="string">"auth"</span>: <span class="string">"d2VpxOQ=="</span>&#125;,</span><br><span class="line">    <span class="string">"localhost"</span>: &#123;<span class="string">"auth"</span>: <span class="string">"d2VpeWlnZWVrOjEyMzQ1Ng=="</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"HttpHeaders"</span>: &#123;<span class="string">"User-Agent"</span>: <span class="string">"Docker-Client/19.03.9 (linux)"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># base64 编码</span></span><br><span class="line"><span class="variable">$echo</span> <span class="string">"d2VpeWlnZWVrOjEyMzQ1Ng=="</span> | base64 -d</span><br><span class="line">weiyigeek:123456[</span><br></pre></td></tr></table></figure></p>
<p>3.5) 上传一个镜像到registry之中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$docker</span> tag alpine localhost/alpine:latest</span><br><span class="line"><span class="variable">$docker</span> images</span><br><span class="line">localhost/alpine    latest              a24bb4013296        2 months ago        5.57MB</span><br><span class="line"><span class="variable">$docker</span> push localhost/alpine:latest</span><br><span class="line"><span class="comment"># The push refers to repository [localhost/alpine]</span></span><br><span class="line"><span class="comment"># 50644c29ef5a: Pushed</span></span><br><span class="line"><span class="comment"># latest: digest: sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65 size: 528</span></span><br></pre></td></tr></table></figure></p>
<p>3.6)registry 查看上传的镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 查看registry中存储的镜像仓库名称 (注意--cacert参数如果证书未导入到系统中则必须加上)</span></span><br><span class="line"><span class="variable">$curl</span> --cacert /opt/registry/certs/domain.crt -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/_catalog</span><br><span class="line">&#123;<span class="string">"repositories"</span>:[<span class="string">"alpine"</span>]&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.7) 利用skopeo转储镜像到registry之中和操作镜像:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 首先信任CA证书，根据不同的发行版选择相应的路径和命令行即可，为后面skopeo命令使用做准备。</span></span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line">update-ca-trust force-enable</span><br><span class="line">cp certs/domain.crt /etc/pki/ca-trust/<span class="built_in">source</span>/anchors/localhost.crt</span><br><span class="line">update-ca-trust</span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">cp certs/domain.crt /usr/<span class="built_in">local</span>/share/ca-certificates/localhost.crt</span><br><span class="line">$ update-ca-certificates</span><br><span class="line"><span class="comment"># Debian</span></span><br><span class="line">cp certs/domain.crt /usr/share/ca-certificates/localhost.crt</span><br><span class="line"><span class="built_in">echo</span> localhost.crt &gt;&gt; /etc/ca-certificates.conf</span><br><span class="line">update-ca-certificates</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) COPY 镜像到 registry</span></span><br><span class="line">skopeo inspect docker://docker.io/alpine</span><br><span class="line"><span class="comment"># 以 localhost/library/alpine:3.10 为例</span></span><br><span class="line"><span class="comment"># localhost   就是该 registry 的域名或者 URL </span></span><br><span class="line"><span class="comment"># library     就是项目名称 project</span></span><br><span class="line"><span class="comment"># alpine:3.12 就是镜像名和镜像的 tag</span></span><br><span class="line">skopeo copy docker://alpine:3.12 docker://localhost/library/alpine:3.12</span><br><span class="line"><span class="comment"># Getting image source signatures</span></span><br><span class="line"><span class="comment"># Copying blob df20fa9351a1 done</span></span><br><span class="line"><span class="comment"># Copying config a24bb40132 done</span></span><br><span class="line"><span class="comment"># Writing manifest to image destination</span></span><br><span class="line"><span class="comment"># Storing signatures</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 删除registry仓库中的镜像(删除后并不彻底)</span></span><br><span class="line">skopeo delete docker://localhost/alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 查看仓库里的镜像</span></span><br><span class="line">curl --cacert /opt/registry/certs/domain.crt -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/_catalog</span><br><span class="line">&#123;<span class="string">"repositories"</span>:[<span class="string">"library/alpine"</span>]&#125;</span><br><span class="line">skopeo inspect docker://localhost/library/alpine:3.12</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"localhost/library/alpine"</span>,</span><br><span class="line">    <span class="string">"Digest"</span>: <span class="string">"sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65"</span>,</span><br><span class="line">    <span class="string">"RepoTags"</span>: [<span class="string">"3.12"</span>],</span><br><span class="line">    <span class="string">"Created"</span>: <span class="string">"2020-05-29T21:19:46.363518345Z"</span>,</span><br><span class="line">    <span class="string">"DockerVersion"</span>: <span class="string">"18.09.7"</span>,</span><br><span class="line">    <span class="string">"Labels"</span>: null,</span><br><span class="line">    <span class="string">"Architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">    <span class="string">"Os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">    <span class="string">"Layers"</span>: [<span class="string">"sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c"</span>],</span><br><span class="line">    <span class="string">"Env"</span>: [<span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>注意事项:</em></p>
<ul>
<li>1.证书颁发者可以用中间证书提供给您。在这种情况下，你必须用中间证书串连您的证书形成的证书捆绑。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat domain.crt intermediate-certificates.pem &gt; certs/domain.crt</span><br></pre></td></tr></table></figure></li>
<li>2.Let’s Encrypt:<a href="https://letsencrypt.org/how-it-works/" target="_blank" rel="noopener">https://letsencrypt.org/how-it-works/</a> </li>
</ul>
<hr>
<h4 id="0x02-Registry-目录结构"><a href="#0x02-Registry-目录结构" class="headerlink" title="0x02 Registry 目录结构"></a>0x02 Registry 目录结构</h4><p>描述: 此时以上传的library/alpine:3.12镜像为例查看registry目录中文件变化;</p>
<p>registry 仓库结构目录如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># registry 持久化位置</span></span><br><span class="line"><span class="variable">$ls</span> /var/lib/registry/docker/registry/v2/</span><br><span class="line">blobs  repositories</span><br><span class="line"></span><br><span class="line"><span class="comment"># registry 树形结构</span></span><br><span class="line">tree -h /var/lib/registry/docker/registry/v2/</span><br><span class="line">/var/lib/registry/docker/registry/v2/</span><br><span class="line">├── [  20]  blobs</span><br><span class="line">│   └── [  36]  sha256</span><br><span class="line">│       ├── [  78]  a1</span><br><span class="line">│       │   └── [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65  <span class="comment"># 镜像data manifest (存储了data config与data layer 的 Digest摘要信息)</span></span><br><span class="line">│       │       └── [ 528]  data</span><br><span class="line">│       ├── [  78]  a2</span><br><span class="line">│       │   └── [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e  <span class="comment"># 镜像data config</span></span><br><span class="line">│       │       └── [1.5K]  data <span class="comment">#  "mediaType": "application/vnd.docker.container.image.v1+json",</span></span><br><span class="line">│       └── [  78]  df</span><br><span class="line">│           └── [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c  <span class="comment"># 镜像data layer (通常体积最大)</span></span><br><span class="line">│               └── [2.7M]  data <span class="comment"># "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span></span><br><span class="line">└── [  21]  repositories</span><br><span class="line">    └── [  20]  library</span><br><span class="line">        └── [  55]  alpine</span><br><span class="line">            ├── [  20]  _layers</span><br><span class="line">            │   └── [ 150]  sha256</span><br><span class="line">            │       ├── [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e   <span class="comment"># 指向 &gt; blobs/sha256/a24bb401......6b63d83e</span></span><br><span class="line">            │       │   └── [  71]  link</span><br><span class="line">            │       └── [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c   <span class="comment"># 指向 &gt; blobs/sha256/df20fa9.......9a752eb4c</span></span><br><span class="line">            │           └── [  71]  link</span><br><span class="line">            ├── [  35]  _manifests</span><br><span class="line">            │   ├── [  20]  revisions  <span class="comment"># 修订记录</span></span><br><span class="line">            │   │   └── [  78]  sha256  </span><br><span class="line">            │   │       └── [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65  <span class="comment"># 修订指向 manifest  &gt;  blobs/sha256/a15790640......c90fd65</span></span><br><span class="line">            │   │           └── [  71]  link</span><br><span class="line">            │   └── [  18]  tags</span><br><span class="line">            │       └── [  34]  3.12</span><br><span class="line">            │           ├── [  18]  current</span><br><span class="line">            │           │   └── [  71]  link  <span class="comment"># 指向 blobs 中 data manifest digest a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span></span><br><span class="line">            │           └── [  20]  index</span><br><span class="line">            │               └── [  78]  sha256</span><br><span class="line">            │                   └── [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65 </span><br><span class="line">            │                       └── [  71]  link  <span class="comment"># 同上</span></span><br><span class="line">            └── [   6]  _uploads  <span class="comment"># 镜像上传过程中的临时目录</span></span><br><span class="line">26 directories, 8 files</span><br></pre></td></tr></table></figure></p>
<p>Q: 那 registry 存储目录到底长什么样? 🤔</p>
<blockquote>
<p>答: 结合下面这张图可以看见，registry 存储目录下只有两种文件名的文件<code>即data与link文件</code><br>(1) link 文件: 是普通的文本文件存放在 repositories 目录下，其内容是指向 data 文件的 sha256 digest值, 从字面意义上就很好理解它;<br>(2) data 文件: 存放在 blobs 目录下文件且分为三个文件(即镜像的<code>layer/config/manifest</code>等文件)</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) Repositories</span></span><br><span class="line"><span class="variable">$ls</span> /var/lib/registry/docker/registry/v2/repositories/alpine/</span><br><span class="line">_layers  _manifests  _uploads</span><br><span class="line"><span class="comment"># - _layers/sha256 目录下的文件夹名是镜像的Layer和Config的Digest,通该目录下的link文件找到对应 blobs 目录下的 data 文件,实际上当我们 pull 一个镜像的 layer 时，是通过 link 文件找到 layer 在 registry 中实际的存储位置的。</span></span><br><span class="line"><span class="comment"># - _manifests 文件夹下的 tags 和 revisions 目录下的 link 文件则指向该镜像的 manifest 文件，保存在所有历史镜像tag的manifest文件的link。当删除一个镜像时，只会删除该镜像最新的 tag 的 link 文件。</span></span><br><span class="line">  <span class="comment"># - revisions 目录记录了镜像修订版本</span></span><br><span class="line">  <span class="variable">$ls</span> /var/lib/registry/docker/registry/v2/repositories/alpine(镜像名称)/_manifests/revisions/sha256/</span><br><span class="line">  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">  <span class="comment"># - tags 目录下的文件夹名例如3.10就是镜像的Tag,在它的子目录下的 current/link 文件则记录了当前 tag 指向的 manifest 文件的位置;</span></span><br><span class="line">    <span class="comment"># 比如我们的 alpine:latest 镜像，每次 push 新的 latest 镜像时current/link 都会更新成指向最新镜像的 manifest 文件。</span></span><br><span class="line">  $ ls /var/lib/registry/docker/registry/v2/repositories/alpine(镜像名称)/_manifests/tags/3.12(镜像标记)/</span><br><span class="line">  current  index  <span class="comment"># 目前都指向 a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65 即 镜像 data manifest</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) Blobs</span></span><br><span class="line"><span class="variable">$ls</span> /var/lib/registry/docker/registry/v2/blobs/sha256/</span><br><span class="line">a1/ a2/ df/ </span><br><span class="line"></span><br><span class="line"><span class="variable">$find</span> /var/lib/registry/docker/registry/v2/ -name <span class="string">"data"</span> -<span class="built_in">exec</span> ls -sh &#123;&#125; \;</span><br><span class="line"><span class="comment"># image layer 文件是 gzip 格式的 tar 包，是镜像层真实内容的 tar.gzip 格式存储形式。</span></span><br><span class="line">2.7M ./blobs/sha256/df/df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># image config 文件是 json 格式的，它是在构建时候生成的根据DockerFile和宿主机的一些信息; （记录了"rootfs"."diff_ids"）</span></span><br><span class="line">4.0K ./blobs/sha256/a2/a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># image manifest 文件json 文件格式的，存放该镜像 layer 和 image config 文件的索引。(镜像拉取首先需拉取此文件)</span></span><br><span class="line">4.0K ./blobs/sha256/a1/a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65/data</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Docker容器Registry私有镜像仓库安全配置与GC回收实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821092456.png" target="_blank" title="WeiyiGeek.registry存储结构" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821092456.png" alt="WeiyiGeek.registry存储结构" title="" class=""></a>
                <p>WeiyiGeek.registry存储结构</p>
            </figure>
<p><br></p>
<p>此时我们可以再往Registry中COPY一个镜像方便后面进行对比分析:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$skopeo</span> copy docker://debian:buster-slim docker://localhost/library/debian:buster-slim</span><br><span class="line"><span class="variable">$curl</span> --cacert /opt/registry/certs/domain.crt -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/_catalog</span><br><span class="line">&#123;<span class="string">"repositories"</span>:[<span class="string">"library/alpine"</span>,<span class="string">"library/debian"</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比分析 registry 中 alpine:3.12 和 debian:buster-slim 两个基础镜像，此时在registry 存储目录的结构如下:</span></span><br><span class="line"><span class="variable">$tree</span> -h /var/lib/registry/docker/registry/v2/</span><br><span class="line">/var/lib/registry/docker/registry/v2/</span><br><span class="line">├── [  20]  blobs</span><br><span class="line">│   └── [  66]  sha256</span><br><span class="line">│       ├── [  78]  a1</span><br><span class="line">│       │   └── [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">│       │       └── [ 528]  data</span><br><span class="line">│       ├── [  78]  a2</span><br><span class="line">│       │   └── [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e</span><br><span class="line">│       │       └── [1.5K]  data</span><br><span class="line">│       ├── [  78]  bf</span><br><span class="line">│       │   └── [  18]  bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb  <span class="comment"># debian:buster-slim 的 Data Layer</span></span><br><span class="line">│       │       └── [ 26M]  data</span><br><span class="line">│       ├── [  78]  c7</span><br><span class="line">│       │   └── [  18]  c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773  <span class="comment"># debian:buster-slim 的 Data Config</span></span><br><span class="line">│       │       └── [1.5K]  data</span><br><span class="line">│       ├── [  78]  df</span><br><span class="line">│       │   └── [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c</span><br><span class="line">│       │       └── [2.7M]  data</span><br><span class="line">│       └── [  78]  e0</span><br><span class="line">│           └── [  18]  e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02  <span class="comment"># debian:buster-slim 的 Data Manifest</span></span><br><span class="line">│               └── [ 529]  data</span><br><span class="line">└── [  21]  repositories</span><br><span class="line">    └── [  34]  library</span><br><span class="line">        ├── [  55]  alpine  <span class="comment"># 此处不做过多说明</span></span><br><span class="line">        │   ├── [  20]  _layers</span><br><span class="line">        │   │   └── [ 150]  sha256</span><br><span class="line">        │   │       ├── [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e</span><br><span class="line">        │   │       │   └── [  71]  link</span><br><span class="line">        │   │       └── [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c</span><br><span class="line">        │   │           └── [  71]  link</span><br><span class="line">        │   ├── [  35]  _manifests</span><br><span class="line">        │   │   ├── [  20]  revisions</span><br><span class="line">        │   │   │   └── [  78]  sha256</span><br><span class="line">        │   │   │       └── [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">        │   │   │           └── [  71]  link</span><br><span class="line">        │   │   └── [  18]  tags</span><br><span class="line">        │   │       └── [  34]  3.12</span><br><span class="line">        │   │           ├── [  18]  current</span><br><span class="line">        │   │           │   └── [  71]  link</span><br><span class="line">        │   │           └── [  20]  index</span><br><span class="line">        │   │               └── [  78]  sha256</span><br><span class="line">        │   │                   └── [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">        │   │                       └── [  71]  link</span><br><span class="line">        │   └── [   6]  _uploads</span><br><span class="line">        └── [  55]  debian</span><br><span class="line">            ├── [  20]  _layers</span><br><span class="line">            │   └── [ 150]  sha256</span><br><span class="line">            │       ├── [  18]  bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb</span><br><span class="line">            │       │   └── [  71]  link  <span class="comment"># 摘要指向 blobs 中debian:buster-slim 的 Data Layer </span></span><br><span class="line">            │       └── [  18]  c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773</span><br><span class="line">            │           └── [  71]  link  <span class="comment"># 摘要指向 blobs 中debian:buster-slim 的 Data Config</span></span><br><span class="line">            ├── [  35]  _manifests</span><br><span class="line">            │   ├── [  20]  revisions</span><br><span class="line">            │   │   └── [  78]  sha256</span><br><span class="line">            │   │       └── [  18]  e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02</span><br><span class="line">            │   │           └── [  71]  link <span class="comment"># 摘要指向 blobs 中 debian:buster-slim 的 Data Manifest</span></span><br><span class="line">            │   └── [  25]  tags</span><br><span class="line">            │       └── [  34]  buster-slim <span class="comment"># 以下摘要都是指向 blobs 中 debian:buster-slim 的 Data Manifest</span></span><br><span class="line">            │           ├── [  18]  current</span><br><span class="line">            │           │   └── [  71]  link</span><br><span class="line">            │           └── [  20]  index</span><br><span class="line">            │               └── [  78]  sha256</span><br><span class="line">            │                   └── [  18]  e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02</span><br><span class="line">            │                       └── [  71]  link</span><br><span class="line">            └── [   6]  _uploads</span><br><span class="line">48 directories, 16 files</span><br></pre></td></tr></table></figure></p>
<p><br> </p>
<p>然后我们再采用skopeo删除我们上传到Registry仓库中的镜像，再进行目录的对比:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$skopeo</span> delete docker://localhost/library/alpine:3.12 --debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出变化的目录结构部分</span></span><br><span class="line">repositories</span><br><span class="line">    └── library</span><br><span class="line">        ├── alpine</span><br><span class="line">        │   ├── _layers</span><br><span class="line">        │   │   └── sha256</span><br><span class="line">        │   │       ├── a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e</span><br><span class="line">        │   │       │   └── link</span><br><span class="line">        │   │       └── df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c</span><br><span class="line">        │   │           └── link</span><br><span class="line">        │   ├── _manifests</span><br><span class="line">        │   │   ├── revisions</span><br><span class="line">        │   │   │   └── sha256</span><br><span class="line">        │   │   │       └── a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">        │   │   └── tags  <span class="comment"># tags 下面的目录与文件被删除</span></span><br><span class="line">        │   └── _uploads</span><br></pre></td></tr></table></figure></p>
<p><strong>总结上述:</strong></p>
<ul>
<li>1.上述可以看见当<code>skopeo delete</code>删除一个镜像时，只是对_manifests下的文件<code>revisions/sha256/a15790640a6690...ka9f2b0d7cc90fd65/link</code>与<code>tags即其子目录文件</code>进行删除;实际上两者删除的是同一个内容，即对记录了该镜像 manifests 文件 digest摘要 的 link 文件。</li>
<li>2.运行后从–debug参数中得到<code>DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</code>可以得出通过 registry API 来 DELETE 一个镜像实质上是删除 repositories 元数据文件夹下的 tag 名文件夹和该 tag 的 revisions 下的 link 文件。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 我们也可以采用Registry API 进行操作达到同样的效率</span></span><br><span class="line">我们定义摘要字符串匹配以下语法：</span><br><span class="line">digest      := algorithm <span class="string">":"</span> hex</span><br><span class="line">algorithm   := /[A-Fa-f0-9_+.-]+/</span><br><span class="line">hex         := /[A-Fa-f0-9]+/</span><br><span class="line"><span class="comment"># digest = sha256:6c3c624b58dbbcd3c0dd82b4c53f04194d1247c6eebdaab7c610cf7d66709b3b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) 获取到镜像 Docker-Content-Digest:</span></span><br><span class="line"><span class="variable">$curl</span> -I -u <span class="string">'weiyigeek:123456'</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X GET https://localhost/v2/library/alpine/manifests/3.12</span><br><span class="line"><span class="comment"># HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment"># Content-Length: 528</span></span><br><span class="line"><span class="comment"># Content-Type: application/vnd.docker.distribution.manifest.v2+json</span></span><br><span class="line"><span class="comment"># Docker-Content-Digest: sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span></span><br><span class="line"><span class="comment"># Docker-Distribution-Api-Version: registry/2.0</span></span><br><span class="line"><span class="comment"># Etag: "sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65"</span></span><br><span class="line"><span class="comment"># X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="comment"># Date: Fri, 21 Aug 2020 02:30:06 GMT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 删除registry仓库中的指定Docker-Content-Digest的镜像tags 与 links 文件</span></span><br><span class="line"><span class="variable">$curl</span> -u <span class="string">'weiyigeek:123456'</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X DELETE https://localhost/v2/library/alpine/manifests/sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看出删除仓库中的镜像，只是把在registry仓库中镜像的tags子目录与revisions/sha256/…/link文件进行删除，而blobs中的镜像 data 与 repositories 中镜像目录library/alpine/并未被删除，这样导致的后果是registry仓库的服务器将会占用一部分存储资源导致资源的浪费，那如何解决这个问题就是我们下面提到的<code>Registry GC</code> 机制;</p>
<hr>
<h4 id="0x03-Registry-API"><a href="#0x03-Registry-API" class="headerlink" title="0x03 Registry API"></a>0x03 Registry API</h4><p>描述:可以通过registry API操作管理镜像或者获取镜像manifest相关信息;<br>官方参考地址: <a href="https://docs.docker.com/registry/spec/api/" target="_blank" rel="noopener">https://docs.docker.com/registry/spec/api/</a></p>
<h5 id="API-一览"><a href="#API-一览" class="headerlink" title="API 一览"></a>API 一览</h5><p>描述:通过API遇到的错误代码如下表所示: <a href="https://docs.docker.com/registry/spec/api/#errors-2" target="_blank" rel="noopener">https://docs.docker.com/registry/spec/api/#errors-2</a></p>
<p>API方法和URI列表涵盖如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Method</th>
<th>Path</th>
<th>Entity</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GET</td>
<td><code>/v2/</code></td>
<td>Base</td>
<td>Check that the endpoint implements Docker Registry API V2.</td>
</tr>
<tr>
<td style="text-align:left">GET</td>
<td><code>/v2/_catalog</code> <br>  <code>/v2/_catalog?n=&lt;integer&gt;</code></td>
<td>Catalog</td>
<td>检索注册中心中可用的存储库的排序json列表</td>
</tr>
<tr>
<td style="text-align:left">GET</td>
<td><code>/v2/&lt;name&gt;/tags/list</code></td>
<td>Tags</td>
<td>获取存储库下由“name”标识的标记。</td>
</tr>
<tr>
<td style="text-align:left">GET</td>
<td><code>/v2/manifests/</code></td>
<td>Manifest</td>
<td>获取由“name”和“reference”标识的清单，其中“reference”可以是标记或摘要。还可以向这个端点发出一个’ HEAD ‘请求，在不接收所有数据的情况下获取资源信息。</td>
</tr>
<tr>
<td style="text-align:left">PUT</td>
<td><code>/v2/manifests/</code></td>
<td>Manifest</td>
<td>把由“name”和“reference”标识的清单放在“reference”可以是标签或摘要的地方。</td>
</tr>
<tr>
<td style="text-align:left">DELETE</td>
<td><code>/v2/manifests/</code></td>
<td>Manifest</td>
<td>删除由“name”和“reference”标识的清单。注意，一个清单只能被“摘要”删除。</td>
</tr>
<tr>
<td style="text-align:left">GET</td>
<td><code>/v2/blobs/</code></td>
<td>Blob</td>
<td>从由“摘要”标识的注册表中检索blob。还可以向这个端点发出一个’ HEAD ‘请求，在不接收所有数据的情况下获取资源信息。</td>
</tr>
<tr>
<td style="text-align:left">DELETE</td>
<td><code>/v2/blobs/</code></td>
<td>Blob</td>
<td>删除由“name”和“digest”标识的blob</td>
</tr>
<tr>
<td style="text-align:left">POST</td>
<td><code>/v2/blobs/uploads/</code></td>
<td>Initiate Blob Upload</td>
<td>如果成功，将提供一个上传位置来完成上传。可选地，如果“digest”参数存在，请求主体将用于在单个请求中完成上传。</td>
</tr>
<tr>
<td style="text-align:left">GET</td>
<td><code>/v2/blobs/uploads/</code></td>
<td>Blob Upload</td>
<td>此端点的主要目的是解决可恢复上传的当前状态利用uuid。</td>
</tr>
<tr>
<td style="text-align:left">PATCH</td>
<td><code>/v2/blobs/uploads/</code></td>
<td>Blob Upload</td>
<td>上传指定上传的数据块。</td>
</tr>
<tr>
<td style="text-align:left">PUT</td>
<td><code>/v2/blobs/uploads/</code></td>
<td>Blob Upload</td>
<td>完成’ uuid ‘指定的上传，可选附加主体作为最后块</td>
</tr>
<tr>
<td style="text-align:left">DELETE</td>
<td><code>/v2/blobs/uploads/</code></td>
<td>Blob Upload</td>
<td>取消未完成的上传进程，释放相关资源。如果没有调用此操作，未完成的上传最终将超时。</td>
</tr>
</tbody>
</table>
<p><strong>(Important)结合registry仓库解释镜像PULL与PUSH过程:</strong></p>
<ul>
<li><p>(1) PULL 镜像: 镜像由一个json清单和层叠文件组成，pull镜像的过程就是检索这两个组件的过程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- 第一步就是获取清单，清单由下面几个字段组成:</span><br><span class="line">registry:5000/v2/redis/manifests/latest(获取redis:latest清单文件)</span><br><span class="line"><span class="comment"># 字段	描述</span></span><br><span class="line"><span class="comment"># name	镜像名称</span></span><br><span class="line"><span class="comment"># tag	镜像当前版本的tag</span></span><br><span class="line"><span class="comment"># fsLayers	层描述列表(包括摘要)</span></span><br><span class="line"><span class="comment"># signature	一个JWS签名，用来验证清单内容</span></span><br><span class="line"></span><br><span class="line">- 第二步当获取清单之后，客户端需要验证前面(signature)，以确保名称和fsLayers层是有效的。确认后客户端可以使用digest去下载各个fs层。在V2api中层存储在blobs中已digest作为键值.</span><br><span class="line">1.首先拉取镜像清单(pulling an Image Manifest)</span><br><span class="line">  $ HEAD /v2/&lt;image/manifests/&lt;reference&gt;<span class="comment">#检查镜像清单是否存在</span></span><br><span class="line">  $ GET /v2/&lt;image&gt;/manifests/&lt;reference&gt;<span class="comment">#拉取镜像清单</span></span><br><span class="line">  提示：reference可是是tag或者是digest  </span><br><span class="line">2.开始拉取每个层(pulling a Layer)</span><br><span class="line">  $ GET /v2/&lt;image&gt;/blobs/&lt;digest&gt;</span><br><span class="line">  提示：digest是镜像每个fsLayer层的唯一标识，存在于清单的fsLayers里面。</span><br></pre></td></tr></table></figure>
</li>
<li><p>(2) PUSH 镜像: 推送镜像和拉取镜像过程相反,先推各个层到registry仓库，然后上传清单.(Pushing a Layer(上传层)分为2步)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2.1) 使用post请求在registry仓库启动上传服务,返回一个url这个url用来上传数据和检查状态。</span></span><br><span class="line"><span class="comment"># 首先Existing Layers(检查层是否存在)，若返回200 OK 则表示存在，不用上传</span></span><br><span class="line">$ HEAD /v2/image/blobs/&lt;digest&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始上传服务(Starting An Upload)，如果post请求返回202 accepted，一个url会在location字段返回.</span></span><br><span class="line">$ POST /v2/image/blobs/uploads/</span><br><span class="line"><span class="comment"># 202 Accepted</span></span><br><span class="line"><span class="comment"># Location: /v2/\&lt;image&gt;/blobs/uploads/\&lt;uuid&gt;</span></span><br><span class="line"><span class="comment"># Range: bytes=0-&lt;offset&gt;</span></span><br><span class="line"><span class="comment"># Content-Length: 0</span></span><br><span class="line"><span class="comment"># Docker-Upload-UUID: &lt;uuid&gt; # 可以用来查看上传状态和实现断点续传</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.2) 开始上传层(Uploging the Layer)</span></span><br><span class="line">&gt; PUT /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;?digest=&lt;digest&gt; </span><br><span class="line">Content-Length: &lt;size of layer&gt;&gt;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传进度(Upload Progress)</span></span><br><span class="line">$ GET /v2/&lt;image&gt;/blobs/uploads/&lt;uuid&gt;</span><br><span class="line"><span class="comment"># 204 No Content</span></span><br><span class="line"><span class="comment"># Location: /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;</span></span><br><span class="line"><span class="comment"># Range: bytes=0-&lt;offset&gt;</span></span><br><span class="line"><span class="comment"># Docker-Upload-UUID: &lt;uuid&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重点-整块上传(Monolithic Upload)</span></span><br><span class="line">&gt; PUT /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;?digest=&lt;digest&gt; </span><br><span class="line">&gt; Content-Length: &lt;size of layer&gt;</span><br><span class="line">&gt; Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;Layer Binary Data&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重点-分块上传(Chunked Upload)</span></span><br><span class="line">&gt; PATCH /v2/\&lt;name&gt;/blobs/uploads/\&lt;uuid&gt;</span><br><span class="line">&gt; Content-Length: \&lt;size of chunk&gt;</span><br><span class="line">&gt; Content-Range: \&lt;start of range&gt;-\&lt;end of range&gt;</span><br><span class="line"></span><br><span class="line">&gt; Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">\&lt;Layer Chunk Binary Data&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果服务器不接受这个块，则返回:</span></span><br><span class="line"><span class="comment">#   416 Requested Range Not Satisfiable</span></span><br><span class="line"><span class="comment">#   Location: /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;</span></span><br><span class="line"><span class="comment">#   Range: 0-&lt;last valid range&gt;</span></span><br><span class="line"><span class="comment">#   Content-Length: 0</span></span><br><span class="line"><span class="comment">#   Docker-Upload-UUID: &lt;uuid&gt;</span></span><br><span class="line">             </span><br><span class="line"><span class="comment"># 成功则返回：</span></span><br><span class="line"><span class="comment">#   202 Accepted</span></span><br><span class="line"><span class="comment">#   Location: /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;</span></span><br><span class="line"><span class="comment">#   Range: bytes=0-&lt;offset&gt;</span></span><br><span class="line"><span class="comment">#   Content-Length: 0</span></span><br><span class="line"><span class="comment">#   Docker-Upload-UUID: &lt;uuid&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重点-交叉上传(Cross Repository Blob Mount)可以把客户端有访问权限的已有存储库中的层挂载到当前存储库中</span></span><br><span class="line">POST /v2/&lt;name&gt;/blobs/uploads/?mount=&lt;digest&gt;&amp;from=&lt;repository name&gt;</span><br><span class="line">Content-Length: 0</span><br><span class="line"><span class="comment"># 成功返回：</span></span><br><span class="line"><span class="comment">#   201 Created</span></span><br><span class="line"><span class="comment">#   Location: /v2/&lt;name&gt;/blobs/&lt;digest&gt;</span></span><br><span class="line"><span class="comment">#   Content-Length: 0</span></span><br><span class="line"><span class="comment">#   Docker-Content-Digest: &lt;digest&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 失败返回:</span></span><br><span class="line"><span class="comment">#   202 Accepted</span></span><br><span class="line"><span class="comment">#   Location: /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;</span></span><br><span class="line"><span class="comment">#   Range: bytes=0-&lt;offset&gt;</span></span><br><span class="line"><span class="comment">#   Content-Length: 0</span></span><br><span class="line"><span class="comment">#   Docker-Upload-UUID: &lt;uuid&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.3) 上传完成(Completed Upload)，但是注意分块上传在最后一块上传完毕后，需要提交一个上传完成的请求</span></span><br><span class="line">&gt; PUT /v2/&lt;name&gt;/blob/uploads/&lt;uuid&gt;?digest=&lt;digest&gt;</span><br><span class="line">&gt; Content-Length: &lt;size of chunk&gt;</span><br><span class="line">&gt; Content-Range: &lt;start of range&gt;-&lt;end of range&gt;</span><br><span class="line">&gt; Content-Type: application/octet-stream   </span><br><span class="line"></span><br><span class="line">&lt;Last Layer Chunk Binary Data&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 成功返回：</span></span><br><span class="line"><span class="comment"># 201 Created</span></span><br><span class="line"><span class="comment"># Location: /v2/&lt;name&gt;/blobs/&lt;digest&gt;</span></span><br><span class="line"><span class="comment"># Content-Length: 0</span></span><br><span class="line"><span class="comment"># Docker-Content-Digest: &lt;digest&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h5 id="实际示例"><a href="#实际示例" class="headerlink" title="实际示例"></a>实际示例</h5><p>Tips: 后续不再加<code>--cacert /opt/registry/certs/domain.crt</code>参数，默认大家都已经把证书导入带系统本地;</p>
<ul>
<li><p>0.Registry V2协议及其认证请求验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Registry 仓库协议</span></span><br><span class="line"><span class="variable">$curl</span> -I -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="comment"># 采用一个RFC7235兼容的授权头进行认证</span></span><br><span class="line"><span class="variable">$curl</span> -I -H <span class="string">'Authorization: Basic d2VpeWlnZWVrOjEyMzQ1Ng=='</span> -X GET https://localhost/v2/</span><br><span class="line">HTTP/1.1 200 OK</span><br></pre></td></tr></table></figure>
<p><br></p>
</li>
<li><p>1.查看Registry仓库中有那些镜像(不精确-当通过delete删除镜像时候此处并未删除需要手动到repositories文件夹中删除)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Registry 仓库中所有镜像</span></span><br><span class="line">curl --cacert /opt/registry/certs/domain.crt -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/_catalog</span><br><span class="line">&#123;<span class="string">"repositories"</span>:[<span class="string">"library/alpine"</span>,<span class="string">"library/debian"</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回仓库中指定条目的镜像(通过-v 参数可看出last的不同)</span></span><br><span class="line">curl --cacert /opt/registry/certs/domain.crt -u <span class="string">'weiyigeek:123456'</span> -X GET <span class="string">"https://localhost/v2/_catalog?n=1&amp;last=a"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li><p>2.获取某个镜像的标签列表 (注意加或者未加Project的区别)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/alpine/tags/list</span><br><span class="line"><span class="comment"># &#123;"name":"alpine","tags":["latest"]&#125;</span></span><br><span class="line">curl -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/library/alpine/tags/list  <span class="comment"># 'library/alpine'</span></span><br><span class="line"><span class="comment"># &#123;"name":"library/alpine","tags":["3.12"]&#125;</span></span><br><span class="line"><span class="comment"># 列出镜像部分tags(Pagination)</span></span><br><span class="line">curl -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/library/alpine/tags/list?n=&lt;<span class="built_in">integer</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.拉取Registry 仓库镜像中Manifests(清单)文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断指定镜像与tags的Manifests(清单)是否存在</span></span><br><span class="line">curl -I -u <span class="string">'weiyigeek:123456'</span> -X HEAD https://localhost/v2/library/alpine/manifests/3.12</span><br><span class="line"><span class="comment"># HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment"># Content-Length: 2783</span></span><br><span class="line"><span class="comment"># Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 仓库中`Manifests`清单</span></span><br><span class="line">$ curl -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/library/alpine/manifests/3.12</span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment">#    "schemaVersion": 1,</span></span><br><span class="line"><span class="comment">#    "name": "library/alpine",</span></span><br><span class="line"><span class="comment">#    "tag": "3.12",</span></span><br><span class="line"><span class="comment">#    "architecture": "amd64",</span></span><br><span class="line"><span class="comment">#    "fsLayers": [&#123;</span></span><br><span class="line"><span class="comment">#          "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"&#125;,&#123;</span></span><br><span class="line"><span class="comment">#          "blobSum": "sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c"</span></span><br><span class="line"><span class="comment">#       &#125;</span></span><br><span class="line"><span class="comment">#    ],</span></span><br><span class="line"><span class="comment">#    "history": [</span></span><br><span class="line"><span class="comment">#       &#123;</span></span><br><span class="line"><span class="comment">#          "v1Compatibility": "&#123;\"architecture\":\"amd64\",\"config\":&#123;\"Hostname\":\"\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/sh\"],\"ArgsEscaped\":true,\"Image\":\"sha256:64771e4514cb653a0fe68e1ceed5bd16640ebf3bd859dc3333efe87dc4709a5d\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":null&#125;,\"container\":\"ce1874fa1fc1eb128516899352f185645f492c443b5a80d9a3fae8b09d1b6b16\",\"container_config\":&#123;\"Hostname\":\"ce1874fa1fc1\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/sh\",\"-c\",\"#(nop) \",\"CMD [\\\"/bin/sh\\\"]\"],\"ArgsEscaped\":true,\"Image\":\"sha256:64771e4514cb653a0fe68e1ceed5bd16640ebf3bd859dc3333efe87dc4709a5d\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":&#123;&#125;&#125;,\"created\":\"2020-05-29T21:19:46.363518345Z\",\"docker_version\":\"18.09.7\",\"id\":\"4a28aef4f8a9e13b1df98eaf8e651db2857161cea27134dad697ad0c7a7de12d\",\"os\":\"linux\",\"parent\":\"a5213fa3ad8fa7a42f88213945845ef49dcf11328d51576b8f076142ce75bdf8\",\"throwaway\":true&#125;"</span></span><br><span class="line"><span class="comment">#       &#125;,</span></span><br><span class="line"><span class="comment">#       &#123;</span></span><br><span class="line"><span class="comment">#          "v1Compatibility": "&#123;\"id\":\"a5213fa3ad8fa7a42f88213945845ef49dcf11328d51576b8f076142ce75bdf8\",\"created\":\"2020-05-29T21:19:46.192045972Z\",\"container_config\":&#123;\"Cmd\":[\"/bin/sh -c #(nop) ADD file:c92c248239f8c7b9b3c067650954815f391b7bcb09023f984972c082ace2a8d0 in / \"]&#125;&#125;"</span></span><br><span class="line"><span class="comment">#       &#125;</span></span><br><span class="line"><span class="comment">#    ],</span></span><br><span class="line"><span class="comment">#    "signatures": [</span></span><br><span class="line"><span class="comment">#       &#123;</span></span><br><span class="line"><span class="comment">#          "header": &#123;</span></span><br><span class="line"><span class="comment">#             "jwk": &#123;</span></span><br><span class="line"><span class="comment">#                "crv": "P-256",</span></span><br><span class="line"><span class="comment">#                "kid": "P6TV:UOU3:V564:FNEL:DQG2:WQX5:6Z5P:NQF6:XZOR:JTMI:Q2QI:AQZ3",</span></span><br><span class="line"><span class="comment">#                "kty": "EC",</span></span><br><span class="line"><span class="comment">#                "x": "n70C5idlCOFB4ubdg5K6MCvRBIH6d5YzhTRumV1i6D8",</span></span><br><span class="line"><span class="comment">#                "y": "OmZn6AyifVg3kZ67ICPViHTHBXvMui8fPwqXzbTnWw0"</span></span><br><span class="line"><span class="comment">#             &#125;,</span></span><br><span class="line"><span class="comment">#             "alg": "ES256"</span></span><br><span class="line"><span class="comment">#          &#125;,</span></span><br><span class="line"><span class="comment">#          "signature": "S4Tvfqx0nA7hULgyKdKKdoYpgMsTqxlbQ6JDeQv1HXZie1zMCsafNZfLI59kivzHb7IV8hwEnvxehL0cKuoZ4w",</span></span><br><span class="line"><span class="comment">#          "protected": "eyJmb3JtYXRMZW5ndGgiOjIxMzYsImZvcm1hdFRhaWwiOiJDbjAiLCJ0aW1lIjoiMjAyMC0wOC0yMlQwNzoyNDozM1oifQ"</span></span><br><span class="line"><span class="comment">#       &#125;</span></span><br><span class="line"><span class="comment">#    ]</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>4.获取仓库镜像的manifests内容 (go-hello:scratch)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -v -u <span class="string">'weiyigeek:123456'</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X GET https://localhost/v2/go-hello/manifests/scratch </span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment">#    "schemaVersion": 2,</span></span><br><span class="line"><span class="comment">#    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",</span></span><br><span class="line"><span class="comment">#    "config": &#123;</span></span><br><span class="line"><span class="comment">#       "mediaType": "application/vnd.docker.container.image.v1+json",</span></span><br><span class="line"><span class="comment">#       "size": 1472,</span></span><br><span class="line"><span class="comment">#       "digest": "sha256:cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209"</span></span><br><span class="line"><span class="comment">#    &#125;,</span></span><br><span class="line"><span class="comment">#    "layers": [</span></span><br><span class="line"><span class="comment">#       &#123;</span></span><br><span class="line"><span class="comment">#          "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span></span><br><span class="line"><span class="comment">#          "size": 1106793,</span></span><br><span class="line"><span class="comment">#          "digest": "sha256:5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368"</span></span><br><span class="line"><span class="comment">#       &#125;</span></span><br><span class="line"><span class="comment">#    ]</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>5.获取(镜像:版本)标识的data manifests的 digest<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">curl -I --cacert /opt/registry/certs/domain.crt -u <span class="string">'weiyigeek:123456'</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X GET https://localhost/v2/go-hello/manifests/scratch</span><br><span class="line"><span class="comment"># HTTP/1.1 200 OK</span></span><br><span class="line"><span class="comment"># Content-Length: 528</span></span><br><span class="line"><span class="comment"># Content-Type: application/vnd.docker.distribution.manifest.v2+json</span></span><br><span class="line"><span class="comment"># 注意Docker-Content-Digest中的内容: 在registry2.3或更高版本删除清单时,必须在HEAD或GET获取清单以获取要删除的正确digest携带以下头;</span></span><br><span class="line"><span class="comment"># Docker-Content-Digest: sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span></span><br><span class="line"><span class="comment"># Docker-Distribution-Api-Version: registry/2.0</span></span><br><span class="line"><span class="comment"># Etag: "sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e"</span></span><br><span class="line"><span class="comment"># X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="comment"># Date: Fri, 21 Aug 2020 02:30:06 GMT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 【简约版本:直接提取Docker-Content-Digest头内容】</span></span><br><span class="line">curl -Is -u <span class="string">'weiyigeek:123456'</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X GET https://localhost/v2/library/alpine/manifests/3.12 | grep <span class="string">"Docker-Content-Digest:"</span> | cut -f 2 -d <span class="string">" "</span></span><br><span class="line">sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line"></span><br><span class="line"><span class="comment"># 【如不指定Accept则默认为 application/vnd.docker.distribution.manifest.v1+prettyjws 】</span></span><br><span class="line">curl -I -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/library/alpine/manifests/3.12                                     HTTP/1.1 200 OK</span><br><span class="line"><span class="comment"># Content-Length: 2783</span></span><br><span class="line"><span class="comment"># Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws</span></span><br><span class="line"><span class="comment"># Docker-Content-Digest: sha256:cae82a43ba96214acd380f3d4ed043445f56f80f0fc99f3f927d5e6eaee40791</span></span><br><span class="line"><span class="comment"># Docker-Distribution-Api-Version: registry/2.0</span></span><br><span class="line"><span class="comment"># Etag: "sha256:cae82a43ba96214acd380f3d4ed043445f56f80f0fc99f3f927d5e6eaee40791"</span></span><br><span class="line"><span class="comment"># X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="comment"># Date: Sat, 22 Aug 2020 03:01:16 GMT</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>6.删除仓库中的镜像即删除(repositories下面的 _manifests 中的Tags 与 revisions 下的link)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加入 -v 参数 查看请求返回流程  </span></span><br><span class="line"><span class="variable">$curl</span> -v --cacert /opt/registry/certs/domain.crt -u <span class="string">'weiyigeek:123456'</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X DELETE https://localhost/v2/go-hello/manifests/sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class="line"><span class="comment">#  202 Accepted</span></span><br><span class="line"><span class="comment">#  Content-Length: None</span></span><br><span class="line"><span class="comment"># 失败 返回404错误</span></span><br></pre></td></tr></table></figure>
注意：默认情况下，registry不允许删除镜像操作，需要在启动registry时指定环境变量<code>REGISTRY_STORAGE_DELETE_ENABLED=true</code>,或者修改其配置文件即可。reference必须是digest,否则删除将失败。在registry2.3或更高版本删除清单时，必须在HEAD或GET获取清单以获取要删除的正确digest携带以下头：<br>Accept: application/vnd.docker.distribution.manifest.v2+json</li>
</ul>
<ul>
<li><p>7.拉取镜像，由于层被存储在注册表中的blobs中所以是需要通过一个标准的HTTP请求来进行拉取一个层的信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 先查看镜像 data 相关的 Digest 码</span></span><br><span class="line">curl -s -u <span class="string">'weiyigeek:123456'</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X GET https://localhost/v2/library/alpine/manifests/3.12 | jq <span class="string">'"Data Config - " + .config.digest'</span>,<span class="string">'"Data Layer - " + .layers[0].digest'</span></span><br><span class="line"><span class="comment"># "Data Config - sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e"</span></span><br><span class="line"><span class="comment"># "Data Layer - sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 获取拉取镜像的data config 与 data layer 文件</span></span><br><span class="line">curl -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/library/alpine/blobs/sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e | jq </span><br><span class="line"></span><br><span class="line">curl -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/library/alpine/blobs/sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c -o /tmp/alpine-3.12.tar.gz</span><br><span class="line">[root@k8s tmp]$ ls -lh alpine-3.12.tar.gz</span><br><span class="line">-rw-r--r--.  1 root root 2.7M 8月  22 16:27 alpine-3.12.tar.gz</span><br><span class="line">[root@k8s tmp]$ tar -zxvf alpine-3.12.tar.gz  <span class="comment"># 实际上该压缩文件中存放的是rootfs文件系统</span></span><br><span class="line"><span class="comment"># bin/</span></span><br><span class="line"><span class="comment"># bin/arch</span></span><br><span class="line"><span class="comment"># bin/ash</span></span><br><span class="line"><span class="comment"># bin/base64</span></span><br><span class="line"><span class="comment"># bin/bbconfig</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>8.镜像通过Registry API上传到仓库中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有层上传使用两个步骤来管理上传过程。</span></span><br><span class="line">* 第一步开始在注册表中的服务上传，返回一个URL来进行第二步。</span><br><span class="line">* 第二步使用上载URL传递的实际数据。上传都开始返回，可用于将数据推和检查上传状态URL的POST请求。</span><br><span class="line"><span class="comment"># Location头将用于每个请求后进行通信的上载位置。虽然它不会在本技术规格改变，客户应使用API​​返回的最新值。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) 开始上载一个POST请求 </span></span><br><span class="line"><span class="comment"># POST /v2/&lt;name&gt;/blobs/uploads/</span></span><br><span class="line"></span><br><span class="line">curl -I -u <span class="string">'weiyigeek:123456'</span> -X POST https://localhost/v2/<span class="built_in">test</span>-images/blobs/uploads/</span><br><span class="line"><span class="comment"># 如果POST请求是成功的它将返回 202响应 将与Location头上传的URL返回：</span></span><br><span class="line"><span class="comment"># HTTP/1.1 202 Accepted</span></span><br><span class="line"><span class="comment"># Content-Length: 0</span></span><br><span class="line"><span class="comment"># Docker-Distribution-Api-Version: registry/2.0</span></span><br><span class="line"><span class="comment"># Docker-Upload-Uuid: 9efa5ca7-d009-4532-88de-695c1f945e59  # 必须额</span></span><br><span class="line"><span class="comment"># Location: https://localhost/v2/test-images/blobs/uploads/9efa5ca7-d009-4532-88de-695c1f945e59?_state=XqlcahxfSzts1a43SgEs_MQ9-GAczgadg-Ra3vayoh57Ik5hbWUiOiJ0ZXN0LWltYWdlcyIsIlVVSUQiOiI5ZWZhNWNhNy1kMDA5LTQ1MzItODhkZS02OTVjMWY5NDVlNTkiLCJPZmZzZXQiOjAsIlN0YXJ0ZWRBdCI6IjIwMjAtMDgtMjJUMDg6NDA6NDguMDkwNTk0NzQ4WiJ9  # 指定了位置标头</span></span><br><span class="line"><span class="comment"># Range: 0-0</span></span><br><span class="line"><span class="comment"># X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="comment"># Date: Sat, 22 Aug 2020 08:40:48 GMT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 通过HEAD请求到BLOB存储API进行检查镜像相关层是否存在(可用返回200 OK)</span></span><br><span class="line"><span class="comment"># HEAD /v2/&lt;name&gt;/blobs/&lt;digest&gt;</span></span><br><span class="line"></span><br><span class="line">curl -I -u <span class="string">'weiyigeek:123456'</span> -X HEAD https://localhost/v2/<span class="built_in">test</span>-images/blobs/sha256:a14....jk5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 上传进度查看此时需要第一步中的Docker-Upload-Uuid之进行请求</span></span><br><span class="line"><span class="comment"># GET /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;</span></span><br><span class="line">curl -I -u <span class="string">'weiyigeek:123456'</span> -X GET https://localhost/v2/<span class="built_in">test</span>-images/blobs/uploads/9efa5ca7-d009-4532-88de-695c1f945e59</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) Monolithic Upload 简单的单块上传，并可以通过想避免分块的复杂性的</span></span><br><span class="line"><span class="comment"># PUT /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;?digest=&lt;digest&gt;</span></span><br><span class="line"><span class="comment"># Content-Length: &lt;size of layer&gt;</span></span><br><span class="line"><span class="comment"># Content-Type: application/octet-stream</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;Layer Binary Data&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) Chunked Upload 进行组块的上载，该客户机可以指定一个范围报头和仅包括层文件的一部分：</span></span><br><span class="line"><span class="comment"># PATCH /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;</span></span><br><span class="line"><span class="comment"># Content-Length: &lt;size of chunk&gt;</span></span><br><span class="line"><span class="comment"># Content-Range: &lt;start of range&gt;-&lt;end of range&gt;</span></span><br><span class="line"><span class="comment"># Content-Type: application/octet-stream</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;Layer Chunk Binary Data&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (6) 跨存储库Blob挂载,可以从客户机具有读访问权的另一个存储库挂载blob，从而不需要将已知的blob上传到注册中心,要发出一个blob挂载而不是一个upload, POST请求应该以以下格式发出(成功将返回202 Accepted):</span></span><br><span class="line">POST /v2/&lt;name&gt;/blobs/uploads/?mount=&lt;digest&gt;&amp;from=&lt;repository name&gt;</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (7) Completed Upload 当镜像上传完毕必须进行以下请求否则仓库不认为镜像个层全部上传，当接收到最后一个块和层已被验证时候将返回201 Create 并且返回该镜像的Docker-Content-Digest值;</span></span><br><span class="line"><span class="comment"># PUT /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;?digest=&lt;digest&gt;</span></span><br><span class="line"><span class="comment"># Content-Length: &lt;size of chunk&gt;</span></span><br><span class="line"><span class="comment"># Content-Range: &lt;start of range&gt;-&lt;end of range&gt;</span></span><br><span class="line"><span class="comment"># Content-Type: application/octet-stream</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;Last Layer Chunk Binary Data&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (8) 取消上传镜像到仓库，可通过发出DELETE请求到registry之中;</span></span><br><span class="line"><span class="comment"># DELETE /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (9) 删除层(Deleting a Layer)</span></span><br><span class="line"><span class="comment"># DELETE /v2/&lt;image&gt;/blobs/&lt;digest&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 成功返回:</span></span><br><span class="line"><span class="comment"># 202 Accepted</span></span><br><span class="line"><span class="comment"># Content-Length: None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (10) 上传镜像清单(Pushing an Image Manifest),我们上传完镜像层之后，就开始上传镜像清单</span></span><br><span class="line"><span class="comment"># PUT /v2/&lt;name&gt;/manifests/&lt;reference&gt;</span></span><br><span class="line"><span class="comment"># Content-Type: &lt;manifest media type&gt;</span></span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment"># "name": &lt;name&gt;,</span></span><br><span class="line"><span class="comment"># "tag": &lt;tag&gt;,</span></span><br><span class="line"><span class="comment"># "fsLayers": [</span></span><br><span class="line"><span class="comment">#   &#123;</span></span><br><span class="line"><span class="comment">#     "blobSum": &lt;digest&gt;</span></span><br><span class="line"><span class="comment">#   &#125;,</span></span><br><span class="line"><span class="comment">#   ...</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"><span class="comment"># ],</span></span><br><span class="line"><span class="comment"># "history": &lt;v1 images&gt;,</span></span><br><span class="line"><span class="comment"># "signature": &lt;JWS&gt;,</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果清单中有层("blobSum":&lt;digest&gt;)是未知的，则返回</span></span><br><span class="line"><span class="comment"># &#123;  "errors:" [&#123;          "code": "BLOB_UNKNOWN",          "message": "blob unknown to registry",          "detail": &#123;              "digest": &lt;digest&gt;</span></span><br><span class="line"><span class="comment">#         &#125;</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     ...</span></span><br><span class="line"><span class="comment">#   ]</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">删除镜像Manifests与镜像层信息:</span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">curl -Is -u &#39;weiyigeek:123456&#39; -H &#39;Accept: application&#x2F;vnd.docker.distribution.manifest.v2+json&#39; -X GET https:&#x2F;&#x2F;localhost&#x2F;v2&#x2F;library&#x2F;alpine&#x2F;manifests&#x2F;3.12 | grep &quot;Docker-Content-Digest:&quot; | cut -f 2 -d &quot; &quot;</span><br><span class="line">sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line"></span><br><span class="line">curl -s -u &#39;weiyigeek:123456&#39; -H &#39;Accept: application&#x2F;vnd.docker.distribution.manifest.v2+json&#39; -X GET https:&#x2F;&#x2F;localhost&#x2F;v2&#x2F;library&#x2F;alpine&#x2F;manifests&#x2F;3.12 | grep &quot;digest&quot;</span><br><span class="line">&quot;digest&quot;: &quot;sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e&quot;</span><br><span class="line">&quot;digest&quot;: &quot;sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c&quot;</span><br><span class="line"></span><br><span class="line"># 删除 镜像  _Manifests Tags</span><br><span class="line">curl -v --cacert &#x2F;opt&#x2F;registry&#x2F;certs&#x2F;domain.crt -u &#39;weiyigeek:123456&#39; -H &#39;Accept: application&#x2F;vnd.docker.distribution.manifest.v2+json&#39; -X DELETE https:&#x2F;&#x2F;localhost&#x2F;v2&#x2F;library&#x2F;alpine&#x2F;manifests&#x2F;sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line"></span><br><span class="line"># 删除 镜像 _Layer</span><br><span class="line">curl -v -u &#39;weiyigeek:123456&#39; -X DELETE https:&#x2F;&#x2F;localhost&#x2F;v2&#x2F;library&#x2F;alpine&#x2F;blobs&#x2F;sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e</span><br><span class="line"></span><br><span class="line">curl -v -u &#39;weiyigeek:123456&#39; -X DELETE https:&#x2F;&#x2F;localhost&#x2F;v2&#x2F;library&#x2F;alpine&#x2F;blobs&#x2F;sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c</span><br><span class="line"></span><br><span class="line">curl -v -u &#39;weiyigeek:123456&#39; -X DELETE &quot;https:&#x2F;&#x2F;localhost&#x2F;v2&#x2F;library&#x2F;alpine&#x2F;blobs&#x2F;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&quot;</span><br><span class="line"></span><br><span class="line">curl -v -u &#39;weiyigeek:123456&#39; -X DELETE https:&#x2F;&#x2F;localhost&#x2F;v2&#x2F;library&#x2F;alpine&#x2F;blobs&#x2F;sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line"></span><br><span class="line"># 清空后效果</span><br><span class="line">repositories</span><br><span class="line">    |</span><br><span class="line">   library</span><br><span class="line">    │   ├── alpine</span><br><span class="line">    │   │   ├── _layers</span><br><span class="line">    │   │   │   └── sha256</span><br><span class="line">    │   │   │       ├── a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e</span><br><span class="line">    │   │   │       ├── a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4</span><br><span class="line">    │   │   │       └── df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c</span><br><span class="line">    │   │   ├── _manifests</span><br><span class="line">    │   │   │   ├── revisions</span><br><span class="line">    │   │   │   │   └── sha256</span><br><span class="line">    │   │   │   │       └── a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">    │   │   │   └── tags</span><br><span class="line">    │   │   └── _uploads</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>简单粗暴清空 Registry 仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tree</span> /var/lib/registry/docker/registry/v2/blobs/sha256/</span><br><span class="line">/var/lib/registry/docker/registry/v2/blobs/sha256/</span><br><span class="line">├── 0e</span><br><span class="line">├── 32</span><br><span class="line">├── 3f</span><br><span class="line">├── 53</span><br><span class="line">├── 59</span><br><span class="line">├── 8d</span><br><span class="line">├── a1</span><br><span class="line">├── a2</span><br><span class="line">├── b7</span><br><span class="line">├── b9</span><br><span class="line">├── cb</span><br><span class="line">├── df</span><br><span class="line">└── e7</span><br><span class="line">rm -rf /var/lib/registry/docker/registry/v2/blobs/sha256/*</span><br><span class="line">rm -rf /var/lib/registry/docker/registry/v2/repositories/*</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="0x04-Registry-GC"><a href="#0x04-Registry-GC" class="headerlink" title="0x04 Registry GC"></a>0x04 Registry GC</h4><p>描述:在上一章节中我们阐述了为什么要引入Registry GC机制，再说其目的用处前我们先对其进行一个简单的介绍;</p>
<p>Q: 什么是Registry GC ?</p>
<blockquote>
<p>答 :GC英文全称<code>Garbage collection</code>就是垃圾回收的意思，从 docker 官方文档关于GC偷来的 example 来解释一下吧。<br>官网文档:<a href="https://docs.docker.com/registry/garbage-collection/" target="_blank" rel="noopener">https://docs.docker.com/registry/garbage-collection/</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#假如镜像 A 和镜像 B 它们分别引用了layer a，b和 a，c。</span></span><br><span class="line">-  A  -</span><br><span class="line">|     |</span><br><span class="line">a  -  b  -  c </span><br><span class="line">|           |</span><br><span class="line">----  B ----</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 registry API 删除镜像 B 之后，layer c 并没有删掉，只是删掉了对它的引用所以 c 是多余的（就是我们上诉提到那种清情况）。</span></span><br><span class="line">-  A  -</span><br><span class="line">|     |</span><br><span class="line">a  -  b  -  c </span><br><span class="line"></span><br><span class="line"><span class="comment">#此时通过GC机制之后 Layer C 被删除掉了即没有被引用的层将被彻底删除;</span></span><br><span class="line">-  A  -</span><br><span class="line">|     |</span><br><span class="line">a  -  b</span><br></pre></td></tr></table></figure>
<p>此处可以借鉴registry GC 的源码文件 garbagecollect.go 可以看到 GC 的主要分两个阶段:</p>
<ul>
<li><p>(1) marking 阶段：根据上文我们提到的 link 文件，通过扫描所有镜像 tags 目录下的 link 文件就可以得到这些镜像的 manifest，在 manifest 中保存在该镜像所有的 layer 和 config 文件的 digest 值，把这些值标记为不能清除。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">markSet := <span class="built_in">make</span>(<span class="keyword">map</span>[digest.Digest]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">manifestArr := <span class="built_in">make</span>([]ManifestDel, <span class="number">0</span>)</span><br><span class="line">err := repositoryEnumerator.Enumerate(ctx, <span class="function"><span class="keyword">func</span><span class="params">(repoName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  emit(repoName)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> err error</span><br><span class="line">  named, err := reference.WithName(repoName)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to parse repo name %s: %v"</span>, repoName, err)</span><br><span class="line">  &#125;</span><br><span class="line">  repository, err := registry.Repository(ctx, named)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to construct repository: %v"</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  manifestService, err := repository.Manifests(ctx)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to construct manifest service: %v"</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  manifestEnumerator, ok := manifestService.(distribution.ManifestEnumerator)</span><br><span class="line">  <span class="keyword">if</span> !ok &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">"unable to convert ManifestService into ManifestEnumerator"</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>(2) sweep 阶段:删除操作当marking完成之后没有标记blobs(layer 和 config)就会被清理掉;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sweep</span></span><br><span class="line">vacuum := NewVacuum(ctx, storageDriver)</span><br><span class="line"><span class="keyword">if</span> !opts.DryRun &#123;</span><br><span class="line">  <span class="keyword">for</span> _, obj := <span class="keyword">range</span> manifestArr &#123;</span><br><span class="line">    err = vacuum.RemoveManifest(obj.Name, obj.Digest, obj.Tags)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to delete manifest %s: %v"</span>, obj.Digest, err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">blobService := registry.Blobs()</span><br><span class="line">deleteSet := <span class="built_in">make</span>(<span class="keyword">map</span>[digest.Digest]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">err = blobService.Enumerate(ctx, <span class="function"><span class="keyword">func</span><span class="params">(dgst digest.Digest)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="comment">// check if digest is in markSet. If not, delete it!</span></span><br><span class="line">  <span class="keyword">if</span> _, ok := markSet[dgst]; !ok &#123;</span><br><span class="line">    deleteSet[dgst] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=Docker容器Registry私有镜像仓库安全配置与GC回收实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821214936.png" target="_blank" title="WeiyiGeek.marking and sweep" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821214936.png" alt="WeiyiGeek.marking and sweep" title="" class=""></a>
                <p>WeiyiGeek.marking and sweep</p>
            </figure>
<p>Q:那 GC 都干了啥？</p>
<blockquote>
<p>答: 我们可以利用registry容器中的<code>registry garbage-collect</code>命令进行GC回收操作;</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it registry sh -c <span class="string">"/bin/registry garbage-collect -m --delete-untagged=true /etc/docker/registry/config.yml"</span></span><br><span class="line">/ <span class="comment"># cat /etc/docker/registry/config.yml </span></span><br><span class="line">version: 0.1</span><br><span class="line"><span class="built_in">log</span>:</span><br><span class="line">  fields:</span><br><span class="line">    service: registry</span><br><span class="line">storage:</span><br><span class="line">  cache:</span><br><span class="line">    blobdescriptor: inmemory</span><br><span class="line">  filesystem:</span><br><span class="line">    rootdirectory: /var/lib/registry  <span class="comment"># 关键点</span></span><br><span class="line">http:</span><br><span class="line">  addr: :5000</span><br><span class="line">  headers:</span><br><span class="line">    X-Content-Type-Options: [nosniff]</span><br><span class="line">health:</span><br><span class="line">  storagedriver:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    interval: 10s</span><br><span class="line">    threshold: 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># marking 阶段</span></span><br><span class="line">library/alpine <span class="comment"># Registry中的镜像未标记将会被删除 </span></span><br><span class="line">library/debian </span><br><span class="line">library/debian: marking manifest sha256:e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02</span><br><span class="line">library/debian: marking blob sha256:c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773</span><br><span class="line">library/debian: marking blob sha256:bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb</span><br><span class="line"></span><br><span class="line"><span class="comment"># sweep 阶段</span></span><br><span class="line">3 blobs marked, 3 blobs and 0 manifests eligible <span class="keyword">for</span> deletion</span><br><span class="line">blob eligible <span class="keyword">for</span> deletion: sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/a1/a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65  go.version=go1.11.2 instance.id=fe470a94-4f51-4764-93e5-0f1d5d6172bf service=registry</span><br><span class="line">blob eligible <span class="keyword">for</span> deletion: sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e</span><br><span class="line">INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/a2/a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e  go.version=go1.11.2 instance.id=fe470a94-4f51-4764-93e5-0f1d5d6172bf service=registry</span><br><span class="line">blob eligible <span class="keyword">for</span> deletion: sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c</span><br><span class="line">INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/df/df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c  go.version=go1.11.2 instance.id=fe470a94-4f51-4764-93e5-0f1d5d6172bf service=registry</span><br></pre></td></tr></table></figure>
<p>此时经过GC之后的Registry 存储目录长什么样子?<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ tree /var/lib/registry/docker/registry/v2</span><br><span class="line">/var/lib/registry/docker/registry/v2</span><br><span class="line">├── blobs</span><br><span class="line">│   └── sha256</span><br><span class="line">│       ├── a1</span><br><span class="line">│       ├── a2</span><br><span class="line">│       ├── bf</span><br><span class="line">│       │   └── bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── c7</span><br><span class="line">│       │   └── c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── df</span><br><span class="line">│       └── e0</span><br><span class="line">│           └── e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02</span><br><span class="line">│               └── data</span><br><span class="line">└── repositories</span><br><span class="line">    └── library</span><br><span class="line">        ├── alpine  <span class="comment"># 可以看见镜像名称并未删除</span></span><br><span class="line">        │   ├── _layers</span><br><span class="line">        │   │   └── sha256</span><br><span class="line">        │   │       ├── a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e</span><br><span class="line">        │   │       │   └── link</span><br><span class="line">        │   │       └── df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c</span><br><span class="line">        │   │           └── link</span><br><span class="line">        │   ├── _manifests</span><br><span class="line">        │   │   ├── revisions</span><br><span class="line">        │   │   │   └── sha256</span><br><span class="line">        │   │   │       └── a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65</span><br><span class="line">        │   │   └── tags</span><br><span class="line">        │   └── _uploads</span><br><span class="line">        └── debian</span><br><span class="line">            ├── _layers</span><br><span class="line">            │   └── sha256</span><br><span class="line">            │       ├── bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb</span><br><span class="line">            │       │   └── link</span><br><span class="line">            │       └── c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773</span><br><span class="line">            │           └── link</span><br><span class="line">            ├── _manifests</span><br><span class="line">            │   ├── revisions</span><br><span class="line">            │   │   └── sha256</span><br><span class="line">            │   │       └── e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02</span><br><span class="line">            │   │           └── link</span><br><span class="line">            │   └── tags</span><br><span class="line">            │       └── buster-slim</span><br><span class="line">            │           ├── current</span><br><span class="line">            │           │   └── link</span><br><span class="line">            │           └── index</span><br><span class="line">            │               └── sha256</span><br><span class="line">            │                   └── e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02</span><br><span class="line">            │                       └── link</span><br><span class="line">            └── _uploads</span><br><span class="line">40 directories, 10 files</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="Shell-脚本"><a href="#Shell-脚本" class="headerlink" title="Shell 脚本"></a>Shell 脚本</h5><p>示例1:查看Docker官方镜像仓库中镜像的所有标签</p>
<ul>
<li>方式1:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># set -xe </span></span><br><span class="line"><span class="comment"># 其实实现方法就是通过镜像仓库的 restful API，来查询，然后把返回的 json 结果简单处理一下，然后打印出来。</span></span><br><span class="line">image_name=<span class="variable">$1</span></span><br><span class="line">repo_url=https://registry.hub.docker.com/v1/repositories</span><br><span class="line">curl -s <span class="variable">$&#123;repo_url&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/tags | jq | grep name | awk <span class="string">'&#123;print $2&#125;'</span> | sed -e <span class="string">'s/"//g'</span></span><br></pre></td></tr></table></figure></li>
<li>方式2:一条命令搞定<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skopeo inspect docker://docker.io/alpine | jq <span class="string">".RepoTags"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>示例2.registry信息查看脚本与RegistryGC回收脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Description:查看Registry仓库中的镜像信息并从仓库中删除指定镜像，然后进行垃圾回收</span></span><br><span class="line"><span class="comment"># Author:WeiyiGeek</span></span><br><span class="line"><span class="comment"># createTime:2020年8月23日 16:55:57</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment"># [+ Defined]</span></span><br><span class="line">PARM=<span class="variable">$1</span></span><br><span class="line">IMAGE_NAME=<span class="variable">$&#123;2&#125;</span></span><br><span class="line">ACTION=<span class="variable">$&#123;PARM:="NONE"&#125;</span></span><br><span class="line"></span><br><span class="line">REGISTRY_URL=<span class="string">"https://localhost/v2"</span></span><br><span class="line">REGISTRY_NAME=<span class="string">"registry"</span></span><br><span class="line">REGISTRY_HOME=<span class="string">"/var/lib/registry/docker/registry/v2"</span></span><br><span class="line">MANIFESTS_DIGEST=<span class="string">""</span></span><br><span class="line">AUTH=<span class="string">"Authorization: Basic d2VpeWlnZWVrOjEyMzQ1Ng=="</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Usage</span></span>()&#123;</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\e[32mUsage: <span class="variable">$0</span> &#123;view&#125; \e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\e[32m       <span class="variable">$0</span> &#123;tags&#125; &lt;image-name&gt; \e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\e[32m       <span class="variable">$0</span> &#123;gc&#125; &lt;registry-container-name|container-id&gt; \e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\e[32m       <span class="variable">$0</span> &#123;delete&#125; &lt;image-name&gt; &lt;reference&gt; \e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\e[32m #查看仓库中的镜像信息并从仓库中删除指定镜像，然后进行垃圾回收 \e[0m"</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># [+ 显示仓库中的镜像]</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ViewRegistry</span></span>()&#123;</span><br><span class="line">  curl -s -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/_catalog"</span> | jq <span class="string">".repositories"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># [+ 显示仓库中镜像标记]</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ViewTags</span></span>()&#123;</span><br><span class="line">  <span class="built_in">local</span> FLAG=0</span><br><span class="line">  <span class="built_in">local</span> IMAGE_NAME=<span class="variable">$1</span></span><br><span class="line">  curl -s -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/_catalog"</span> | jq <span class="string">".repositories"</span> &gt; registry.repo</span><br><span class="line">  sed -i <span class="string">"s#\[##g;s#]##g;s# ##g;s#\"##g;s#,##g;/^\s*$/d"</span> registry.repo</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> $(cat registry.repo)</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$i</span>"</span> == <span class="string">"<span class="variable">$&#123;IMAGE_NAME&#125;</span>"</span> ]];<span class="keyword">then</span></span><br><span class="line">      FLAG=1</span><br><span class="line">      <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="variable">$FLAG</span> -eq 1 ]];<span class="keyword">then</span></span><br><span class="line">    curl -s -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/tags/list"</span> | jq <span class="string">".tags"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\e[31m[ERROR]: Registry 不存在 <span class="variable">$&#123;IMAGE_NAME&#125;</span> 该镜像\e[0m"</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># [+ 仓库废弃镜像回收] </span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">GcRegistry</span></span>()&#123;</span><br><span class="line">  docker <span class="built_in">exec</span> -it <span class="variable">$1</span> sh -c <span class="string">"/bin/registry garbage-collect -m --delete-untagged=true /etc/docker/registry/config.yml"</span></span><br><span class="line">  <span class="keyword">if</span> [[ $? -ne 0 ]];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\e[31m[ERROR]:GC Failed! \e[0m"</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 删除 blobs/sha256中的空目录</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> $(find <span class="variable">$&#123;REGISTRY_HOME&#125;</span>/blobs/sha256/ | grep -v <span class="string">"data"</span>);<span class="keyword">do</span> </span><br><span class="line">    <span class="keyword">if</span> [[ $(ls -A <span class="variable">$i</span>|wc -c) -eq 0 ]];<span class="keyword">then</span> </span><br><span class="line">      <span class="built_in">echo</span> -e <span class="string">"[info]delete empty directory : <span class="variable">$&#123;i&#125;</span>"</span></span><br><span class="line">      rm -rf <span class="variable">$&#123;i&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"[+ Registry restart ....]"</span></span><br><span class="line">  docker restart <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [+ 删除仓库中的镜像]</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Del</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> IMAGE_NAME=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">local</span> TAGS=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$TAGS</span>"</span> != <span class="string">""</span> ]];<span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 验证删除的镜像是否存在</span></span><br><span class="line">    curl -s -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/manifests/<span class="variable">$&#123;TAGS&#125;</span>"</span> &gt; images.mainfests</span><br><span class="line">    </span><br><span class="line">    err_flag=$(grep -c <span class="string">'"errors"'</span> images.mainfests)</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$err_flag</span> -ne 0 ]];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> -e <span class="string">"\e[31m[ERROR]:<span class="variable">$(cat images.mainfests)</span> \e[0m"</span></span><br><span class="line">      <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取要删除镜像的digest摘要</span></span><br><span class="line">    MANIFESTS_DIGEST=$(curl -s -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/manifests/<span class="variable">$&#123;TAGS&#125;</span>"</span> | grep <span class="string">"Docker-Content-Digest:"</span> | cut -f 2 -d <span class="string">" "</span>)</span><br><span class="line"></span><br><span class="line">    grep <span class="string">"digest"</span> images.mainfests | sed <span class="string">'s# ##g;s#"##g;s#digest:##g'</span> &gt; images.digest</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;MANIFESTS_DIGEST&#125;</span> &gt;&gt; images.digest</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除 镜像 _Manifests目录中的Tags相关目录</span></span><br><span class="line">    curl -v -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> -H <span class="string">'Accept: application/vnd.docker.distribution.manifest.v2+json'</span> -X DELETE <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/manifests/<span class="variable">$&#123;MANIFESTS_DIGEST&#125;</span>"</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 删除 镜像 _Layer 目录下的link</span></span><br><span class="line">    <span class="keyword">for</span> digest <span class="keyword">in</span> $(cat images.digest);<span class="keyword">do</span></span><br><span class="line">      curl -v -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> -X DELETE <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/blobs/<span class="variable">$&#123;digest&#125;</span>"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># GC 回收(注意参数为容器镜像名称)</span></span><br><span class="line">  GcRegistry <span class="variable">$&#123;REGISTRY_NAME&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 判断 镜像 是否存在其它 tags 不存在时候直接删除其目录</span></span><br><span class="line">  <span class="variable">$flag_tags</span>=$(curl -s -H <span class="string">"<span class="variable">$&#123;AUTH&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;REGISTRY_URL&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/tags/list"</span> | jq <span class="string">".tags"</span>) </span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="variable">$flag_tags</span> ]];<span class="keyword">then</span></span><br><span class="line">    rm -rf <span class="string">"<span class="variable">$&#123;REGISTRY_HOME&#125;</span>/repositories/<span class="variable">$&#123;IMAGE_NAME&#125;</span>"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="comment"># 删除 _layers 目录下的digest文件空的目录</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> $(find <span class="variable">$&#123;REGISTRY_HOME&#125;</span>/repositories/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/_layers/sha256/ | grep -v <span class="string">"link"</span>);<span class="keyword">do</span> </span><br><span class="line">      <span class="keyword">if</span> [[ $(ls -A <span class="variable">$i</span>|wc -c) -eq 0 ]];<span class="keyword">then</span> </span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"[info]delete empty directory : <span class="variable">$&#123;i&#125;</span>"</span></span><br><span class="line">        rm -rf <span class="variable">$&#123;i&#125;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 删除 manifests 目录下的digest文件空的目录</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> $(find <span class="variable">$&#123;REGISTRY_HOME&#125;</span>/repositories/<span class="variable">$&#123;IMAGE_NAME&#125;</span>/_manifests/revisions/sha256/ | grep -v <span class="string">"link"</span>);<span class="keyword">do</span> </span><br><span class="line">      <span class="keyword">if</span> [[ $(ls -A <span class="variable">$i</span>|wc -c) -eq 0 ]];<span class="keyword">then</span> </span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"[info]delete empty directory : <span class="variable">$&#123;i&#125;</span>"</span></span><br><span class="line">        rm -rf <span class="variable">$&#123;i&#125;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [Main]</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"NONE"</span> ]];<span class="keyword">then</span></span><br><span class="line">  Usage</span><br><span class="line"><span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"view"</span> ]];<span class="keyword">then</span></span><br><span class="line">  ViewRegistry</span><br><span class="line"><span class="keyword">elif</span>  [[ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"tags"</span> ]];<span class="keyword">then</span></span><br><span class="line">  ViewTags <span class="variable">$2</span></span><br><span class="line"><span class="keyword">elif</span>  [[ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"delete"</span> ]];<span class="keyword">then</span></span><br><span class="line">  Del <span class="variable">$2</span> <span class="variable">$3</span></span><br><span class="line"><span class="keyword">elif</span>  [[ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"gc"</span> ]];<span class="keyword">then</span></span><br><span class="line">  GcRegistry <span class="variable">$2</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  Usage</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>章节总结:</strong></p>
<ul>
<li><p>(1) 在GC之后registry存储目录我们可以看到，原本blobs目录下有6个data文件现在已经变成3个，而alpine:3.12镜像相关的<code>Layer、Config、Manifest</code>文件已经被GC清理掉了; 但是在 repositories 目录下，该镜像的 _layers 下的 link 文件依旧存在🤔。</p>
</li>
<li><p>(2) 总结以上，用下面这三张图片就能直观地理解这些过程啦</p>
<ul>
<li>2.1 delete 镜像之前的 registry 存储目录结构<figure class="image-box">
                <a rel=Docker容器Registry私有镜像仓库安全配置与GC回收实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821092456.png" target="_blank" title="WeiyiGeek.1" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821092456.png" alt="WeiyiGeek.1" title="" class=""></a>
                <p>WeiyiGeek.1</p>
            </figure></li>
<li>2.2 delete 镜像之后的 registry 存储目录结构<figure class="image-box">
                <a rel=Docker容器Registry私有镜像仓库安全配置与GC回收实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821222548.png" target="_blank" title="WeiyiGeek.2" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821222548.png" alt="WeiyiGeek.2" title="" class=""></a>
                <p>WeiyiGeek.2</p>
            </figure></li>
<li>2.3 GC 之后的 registry 存储目录结构<figure class="image-box">
                <a rel=Docker容器Registry私有镜像仓库安全配置与GC回收实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821222637.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200821222637.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
</li>
</ul>
</li>
<li><p>(3) GC 之后一定要重启，因为 registry 容器缓存了镜像 layer 的信息当删除掉一个镜像 A 后边 GC 掉该镜像的 layer 之后，如果不重启 registry 容器，<code>当重新 PUSH 镜像 A 的时候就会提示镜像 layer 已经存在，不会重新上传 layer 但实际上已经被 GC 掉了，最终会导致镜像 A 不完整无法 pull 到该镜像</code>。</p>
</li>
<li><p>(4) GC 不是事务性操作，所以在进行 GC 的时候最好暂停 PUSH 镜像，以免把正在上传的镜像 layer 给 GC 掉。</p>
</li>
</ul>
<hr>
<h4 id="0x05-配置文件解析"><a href="#0x05-配置文件解析" class="headerlink" title="0x05 配置文件解析"></a>0x05 配置文件解析</h4><h5 id="config-yaml-文件一览"><a href="#config-yaml-文件一览" class="headerlink" title="config.yaml 文件一览"></a>config.yaml 文件一览</h5><p>Registry 仓库的 config.yaml 文件<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置版本</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="comment"># 日志配置日志系统的行为</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="comment"># 访问日志系统的ACCESSLOG配置行为</span></span><br><span class="line"><span class="attr">  accesslog:</span></span><br><span class="line"><span class="attr">    disabled:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="comment"># 日志输出的格式默认info.Permitted values are error, warn, info, debug</span></span><br><span class="line"><span class="attr">  level:</span> <span class="string">debug</span> </span><br><span class="line">  <span class="comment"># 日志输出的格式默认 text , json, and logstash</span></span><br><span class="line"><span class="attr">  formatter:</span> <span class="string">text</span></span><br><span class="line">  <span class="comment"># 字段名称的地图</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">staging</span></span><br><span class="line">  <span class="comment"># 配置日志记录挂钩的行为</span></span><br><span class="line"><span class="attr">  hooks:</span></span><br><span class="line"><span class="attr">    - type:</span> <span class="string">mail</span></span><br><span class="line"><span class="attr">      disabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      levels:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">panic</span></span><br><span class="line"><span class="attr">      options:</span></span><br><span class="line"><span class="attr">        smtp:</span></span><br><span class="line"><span class="attr">          addr:</span> <span class="string">mail.example.com:25</span></span><br><span class="line"><span class="attr">          username:</span> <span class="string">mailuser</span></span><br><span class="line"><span class="attr">          password:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">          insecure:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        from:</span> <span class="string">sender@example.com</span></span><br><span class="line"><span class="attr">        to:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">errors@example.com</span></span><br><span class="line"><span class="comment"># 日志等级(error, warn, info, debug):deprecated: use "log"</span></span><br><span class="line"><span class="attr">loglevel:</span> <span class="string">debug</span></span><br><span class="line"><span class="comment"># 存储后端配置必须</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="comment"># 使用本地磁盘存储注册表文件</span></span><br><span class="line"><span class="attr">  filesystem:</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">/var/lib/registry</span></span><br><span class="line"><span class="attr">    maxthreads:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">  azure:</span></span><br><span class="line"><span class="attr">    accountname:</span> <span class="string">accountname</span></span><br><span class="line"><span class="attr">    accountkey:</span> <span class="string">base64encodedaccountkey</span></span><br><span class="line"><span class="attr">    container:</span> <span class="string">containername</span></span><br><span class="line">  <span class="comment"># Google Cloud Storage</span></span><br><span class="line"><span class="attr">  gcs:</span></span><br><span class="line"><span class="attr">    bucket:</span> <span class="string">bucketname</span></span><br><span class="line"><span class="attr">    keyfile:</span> <span class="string">/path/to/keyfile</span></span><br><span class="line"><span class="attr">    credentials:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">service_account</span></span><br><span class="line"><span class="attr">      project_id:</span> <span class="string">project_id_string</span></span><br><span class="line"><span class="attr">      private_key_id:</span> <span class="string">private_key_id_string</span></span><br><span class="line"><span class="attr">      private_key:</span> <span class="string">private_key_string</span></span><br><span class="line"><span class="attr">      client_email:</span> <span class="string">client@example.com</span></span><br><span class="line"><span class="attr">      client_id:</span> <span class="string">client_id_string</span></span><br><span class="line"><span class="attr">      auth_uri:</span> <span class="attr">http://example.com/auth_uri</span></span><br><span class="line"><span class="attr">      token_uri:</span> <span class="attr">http://example.com/token_uri</span></span><br><span class="line"><span class="attr">      auth_provider_x509_cert_url:</span> <span class="attr">http://example.com/provider_cert_url</span></span><br><span class="line"><span class="attr">      client_x509_cert_url:</span> <span class="attr">http://example.com/client_cert_url</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">/gcs/object/name/prefix</span></span><br><span class="line"><span class="attr">    chunksize:</span> <span class="number">5242880</span></span><br><span class="line">  <span class="comment"># Amazon Simple Storage Service (S3)</span></span><br><span class="line"><span class="attr">  s3:</span></span><br><span class="line"><span class="attr">    accesskey:</span> <span class="string">awsaccesskey</span></span><br><span class="line"><span class="attr">    secretkey:</span> <span class="string">awssecretkey</span></span><br><span class="line"><span class="attr">    region:</span> <span class="string">us-west-1</span></span><br><span class="line"><span class="attr">    regionendpoint:</span> <span class="attr">http://myobjects.local</span></span><br><span class="line"><span class="attr">    bucket:</span> <span class="string">bucketname</span></span><br><span class="line"><span class="attr">    encrypt:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    keyid:</span> <span class="string">mykeyid</span></span><br><span class="line"><span class="attr">    secure:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    v4auth:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    chunksize:</span> <span class="number">5242880</span></span><br><span class="line"><span class="attr">    multipartcopychunksize:</span> <span class="number">33554432</span></span><br><span class="line"><span class="attr">    multipartcopymaxconcurrency:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">    multipartcopythresholdsize:</span> <span class="number">33554432</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">/s3/object/name/prefix</span></span><br><span class="line">  <span class="comment"># Openstack Swift object storage. </span></span><br><span class="line"><span class="attr">  swift:</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">    authurl:</span> <span class="attr">https://storage.myprovider.com/auth/v1.0</span> <span class="string">or</span> <span class="attr">https://storage.myprovider.com/v2.0</span> <span class="string">or</span> <span class="attr">https://storage.myprovider.com/v3/auth</span></span><br><span class="line"><span class="attr">    tenant:</span> <span class="string">tenantname</span></span><br><span class="line"><span class="attr">    tenantid:</span> <span class="string">tenantid</span></span><br><span class="line"><span class="attr">    domain:</span> <span class="string">domain</span> <span class="string">name</span> <span class="string">for</span> <span class="string">Openstack</span> <span class="string">Identity</span> <span class="string">v3</span> <span class="string">API</span></span><br><span class="line"><span class="attr">    domainid:</span> <span class="string">domain</span> <span class="string">id</span> <span class="string">for</span> <span class="string">Openstack</span> <span class="string">Identity</span> <span class="string">v3</span> <span class="string">API</span></span><br><span class="line"><span class="attr">    insecureskipverify:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    region:</span> <span class="string">fr</span></span><br><span class="line"><span class="attr">    container:</span> <span class="string">containername</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">/swift/object/name/prefix</span></span><br><span class="line">  <span class="comment"># Aliyun OSS for object storage</span></span><br><span class="line"><span class="attr">  oss:</span></span><br><span class="line"><span class="attr">    accesskeyid:</span> <span class="string">accesskeyid</span></span><br><span class="line"><span class="attr">    accesskeysecret:</span> <span class="string">accesskeysecret</span></span><br><span class="line"><span class="attr">    region:</span> <span class="string">OSS</span> <span class="string">region</span> <span class="string">name</span></span><br><span class="line"><span class="attr">    endpoint:</span> <span class="string">optional</span> <span class="string">endpoints</span></span><br><span class="line"><span class="attr">    internal:</span> <span class="string">optional</span> <span class="string">internal</span> <span class="string">endpoint</span></span><br><span class="line"><span class="attr">    bucket:</span> <span class="string">OSS</span> <span class="string">bucket</span></span><br><span class="line"><span class="attr">    encrypt:</span> <span class="string">optional</span> <span class="string">data</span> <span class="string">encryption</span> <span class="string">setting</span></span><br><span class="line"><span class="attr">    secure:</span> <span class="string">optional</span> <span class="string">ssl</span> <span class="string">setting</span></span><br><span class="line"><span class="attr">    chunksize:</span> <span class="string">optional</span> <span class="string">size</span> <span class="string">valye</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">optional</span> <span class="string">root</span> <span class="string">directory</span></span><br><span class="line"><span class="attr">  inmemory:</span>  <span class="comment"># This driver takes no parameters</span></span><br><span class="line">  <span class="comment"># 使用delete结构允许通过摘要删除映像blob和清单</span></span><br><span class="line"><span class="attr">  delete:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  redirect:</span></span><br><span class="line"><span class="attr">    disable:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 使用高速缓存结构，以便能够在存储后端访问的数据缓存。目前唯一可用的高速缓存提供对层的元数据，它使用blobdescriptor字段如果配置的快速访问。</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line">    <span class="comment"># 如果设置为Redis的，一个Redis的缓存池元数据层。如果设置为inmemory，一个inmemory地图缓存层的元数据。</span></span><br><span class="line"><span class="attr">    blobdescriptor:</span> <span class="string">redis</span></span><br><span class="line">  <span class="comment"># 维护维修</span></span><br><span class="line"><span class="attr">  maintenance:</span></span><br><span class="line">    <span class="comment"># 上传清除</span></span><br><span class="line"><span class="attr">    uploadpurging:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      age:</span> <span class="number">168</span><span class="string">h</span></span><br><span class="line"><span class="attr">      interval:</span> <span class="number">24</span><span class="string">h</span></span><br><span class="line"><span class="attr">      dryrun:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># 如果在维护只读部分，使设置为true，客户端将不会被允许写入注册表。</span></span><br><span class="line"><span class="attr">    readonly:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 认证相关(只能配置一个身份验证提供者。)</span></span><br><span class="line"><span class="attr">auth:</span></span><br><span class="line"><span class="attr">  silly:</span></span><br><span class="line">    <span class="comment"># 使用范围</span></span><br><span class="line"><span class="attr">    realm:</span> <span class="string">silly-realm</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">silly-service</span></span><br><span class="line">  <span class="comment"># 令牌的认证您可以从registry中分离认证系统</span></span><br><span class="line"><span class="attr">  token:</span></span><br><span class="line"><span class="attr">    autoredirect:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    realm:</span> <span class="string">token-realm</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">token-service</span></span><br><span class="line"><span class="attr">    issuer:</span> <span class="string">registry-token-issuer</span></span><br><span class="line"><span class="attr">    rootcertbundle:</span> <span class="string">/root/certs/bundle</span></span><br><span class="line">  <span class="comment"># 支持htpasswd的认证允许您使用的是Apache的htpasswd文件来配置基本身份验证</span></span><br><span class="line"><span class="attr">  htpasswd:</span></span><br><span class="line"><span class="attr">    realm:</span> <span class="string">basic-realm</span></span><br><span class="line">    <span class="comment"># 唯一支持的密码格式是bcrypt。</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/path/to/htpasswd</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">middleware:</span></span><br><span class="line"><span class="attr">  registry:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ARegistryMiddleware</span></span><br><span class="line"><span class="attr">      options:</span></span><br><span class="line"><span class="attr">        foo:</span> <span class="string">bar</span></span><br><span class="line"><span class="attr">  repository:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ARepositoryMiddleware</span></span><br><span class="line"><span class="attr">      options:</span></span><br><span class="line"><span class="attr">        foo:</span> <span class="string">bar</span></span><br><span class="line"><span class="attr">  storage:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">cloudfront</span></span><br><span class="line"><span class="attr">      options:</span></span><br><span class="line"><span class="attr">        baseurl:</span> <span class="attr">https://my.cloudfronted.domain.com/</span></span><br><span class="line"><span class="attr">        privatekey:</span> <span class="string">/path/to/pem</span></span><br><span class="line"><span class="attr">        keypairid:</span> <span class="string">cloudfrontkeypairid</span></span><br><span class="line"><span class="attr">        duration:</span> <span class="number">3000</span><span class="string">s</span></span><br><span class="line"><span class="attr">        ipfilteredby:</span> <span class="string">awsregion</span></span><br><span class="line"><span class="attr">        awsregion:</span> <span class="string">us-east-1,</span> <span class="string">use-east-2</span></span><br><span class="line"><span class="attr">        updatefrenquency:</span> <span class="number">12</span><span class="string">h</span></span><br><span class="line"><span class="attr">        iprangesurl:</span> <span class="attr">https://ip-ranges.amazonaws.com/ip-ranges.json</span></span><br><span class="line"><span class="attr">  storage:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">redirect</span></span><br><span class="line"><span class="attr">      options:</span></span><br><span class="line"><span class="attr">        baseurl:</span> <span class="attr">https://example.com/</span></span><br><span class="line"><span class="comment"># 报表</span></span><br><span class="line"><span class="attr">reporting:</span></span><br><span class="line"><span class="attr">  bugsnag:</span></span><br><span class="line"><span class="attr">    apikey:</span> <span class="string">bugsnagapikey</span></span><br><span class="line"><span class="attr">    releasestage:</span> <span class="string">bugsnagreleasestage</span></span><br><span class="line"><span class="attr">    endpoint:</span> <span class="string">bugsnagendpoint</span></span><br><span class="line"><span class="attr">  newrelic:</span></span><br><span class="line"><span class="attr">    licensekey:</span> <span class="string">newreliclicensekey</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">newrelicname</span></span><br><span class="line"><span class="attr">    verbose:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># HTTP服务器主机上的注册表中的配置</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line"><span class="attr">  addr:</span> <span class="attr">localhost:5000</span></span><br><span class="line"><span class="attr">  prefix:</span> <span class="string">/my/nested/registry/</span></span><br><span class="line"><span class="attr">  host:</span> <span class="attr">https://myregistryaddress.org:5000</span></span><br><span class="line"><span class="attr">  secret:</span> <span class="string">asecretforlocaldevelopment</span></span><br><span class="line"><span class="attr">  relativeurls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  draintimeout:</span> <span class="number">60</span><span class="string">s</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">    certificate:</span> <span class="string">/path/to/x509/public</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">/path/to/x509/private</span></span><br><span class="line"><span class="attr">    clientcas:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/path/to/ca.pem</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/path/to/another/ca.pem</span></span><br><span class="line"><span class="attr">    letsencrypt:</span></span><br><span class="line"><span class="attr">      cachefile:</span> <span class="string">/path/to/cache-file</span></span><br><span class="line"><span class="attr">      email:</span> <span class="string">emailused@letsencrypt.com</span></span><br><span class="line"><span class="attr">      hosts:</span> <span class="string">[myregistryaddress.org]</span></span><br><span class="line"><span class="attr">  debug:</span></span><br><span class="line"><span class="attr">    addr:</span> <span class="attr">localhost:5001</span></span><br><span class="line">    <span class="comment"># 监控</span></span><br><span class="line"><span class="attr">    prometheus:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/metrics</span></span><br><span class="line">  <span class="comment"># 它来指定报头的HTTP服务器应该在响应；</span></span><br><span class="line"><span class="attr">  headers:</span></span><br><span class="line"><span class="attr">    X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">  http2:</span></span><br><span class="line"><span class="attr">    disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 通知公告</span></span><br><span class="line"><span class="attr">notifications:</span></span><br><span class="line"><span class="attr">  events:</span></span><br><span class="line"><span class="attr">    includereferences:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 可以接受的事件通知的清单</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">alistener</span></span><br><span class="line"><span class="attr">      disabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">https://my.listener.com/event</span></span><br><span class="line"><span class="attr">      headers:</span> <span class="string">&lt;http.Header&gt;</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">      threshold:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      backoff:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">      ignoredmediatypes:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">application/octet-stream</span></span><br><span class="line"><span class="attr">      ignore:</span></span><br><span class="line"><span class="attr">        mediatypes:</span></span><br><span class="line"><span class="bullet">           -</span> <span class="string">application/octet-stream</span></span><br><span class="line"><span class="attr">        actions:</span></span><br><span class="line"><span class="bullet">           -</span> <span class="string">pull</span></span><br><span class="line"><span class="comment"># redis 相关配置</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line"><span class="attr">  addr:</span> <span class="attr">localhost:6379</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">asecret</span></span><br><span class="line"><span class="attr">  db:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  dialtimeout:</span> <span class="number">10</span><span class="string">ms</span></span><br><span class="line"><span class="attr">  readtimeout:</span> <span class="number">10</span><span class="string">ms</span></span><br><span class="line"><span class="attr">  writetimeout:</span> <span class="number">10</span><span class="string">ms</span></span><br><span class="line"><span class="attr">  pool:</span></span><br><span class="line"><span class="attr">    maxidle:</span> <span class="number">16</span></span><br><span class="line"><span class="attr">    maxactive:</span> <span class="number">64</span></span><br><span class="line"><span class="attr">    idletimeout:</span> <span class="number">300</span><span class="string">s</span></span><br><span class="line"><span class="comment"># 健康检查</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line"><span class="attr">  storagedriver:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">    threshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 文件结构包括要定期检查的路径的列表为一个文件的\存在。如果文件存在于指定的路径，健康检查将失败。您可以使用这一机制通过创建一个文件，使注册表进行旋转。</span></span><br><span class="line"><span class="attr">  file:</span></span><br><span class="line"><span class="attr">    - file:</span> <span class="string">/path/to/checked/file</span></span><br><span class="line"><span class="attr">      interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">    - uri:</span> <span class="attr">http://server.to.check/must/return/200</span></span><br><span class="line"><span class="attr">      headers:</span></span><br><span class="line"><span class="attr">        Authorization:</span> <span class="string">[Basic</span> <span class="string">QWxhZGRpbjpvcGVuIHNlc2FtZQ==]</span></span><br><span class="line"><span class="attr">      statuscode:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">3</span><span class="string">s</span></span><br><span class="line"><span class="attr">      interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">      threshold:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  tcp:</span></span><br><span class="line"><span class="attr">    - addr:</span> <span class="string">redis-server.domain.com:6379</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">3</span><span class="string">s</span></span><br><span class="line"><span class="attr">      interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">      threshold:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line"><span class="attr">  remoteurl:</span> <span class="attr">https://registry-1.docker.io</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">[username]</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">[password]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">compatibility:</span></span><br><span class="line"><span class="attr">  schema1:</span></span><br><span class="line"><span class="attr">    signingkeyfile:</span> <span class="string">/etc/registry/key.json</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line"><span class="attr">validation:</span></span><br><span class="line"><span class="attr">  manifests:</span></span><br><span class="line"><span class="attr">    urls:</span></span><br><span class="line"><span class="attr">      allow:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">^https?://([^/]+\.)*example\.com/</span></span><br><span class="line"><span class="attr">      deny:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">^https?://www\.example\.com/</span></span><br></pre></td></tr></table></figure></p>

        </div>
        <!-- Google 广告 -->
          

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-03-29T05:39:03.676Z" itemprop="dateUpdated">2022-03-29 13:39:03</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/虚拟云容/云容器/Docker/奇技淫巧/3.Docker容器Registry私有镜像仓库安全配置与GC回收实践.md" target="_blank" rel="noopener noreferrer">_posts/虚拟云容/云容器/Docker/奇技淫巧/3.Docker容器Registry私有镜像仓库安全配置与GC回收实践.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2020/5-4-465.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/5-4-465.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/5-4-465.html&title=《Docker容器Registry私有镜像仓库安全配置与GC回收实践》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/5-4-465.html&title=《Docker容器Registry私有镜像仓库安全配置与GC回收实践》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/5-4-465.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Docker容器Registry私有镜像仓库安全配置与GC回收实践》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/5-4-465.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/5-4-465.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/5-7-478.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">1.Podman容器管理工具基础学习</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/5-3-467.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Docker容器镜像体积缩小技巧</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x01-基础安装"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 基础安装</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-Registry-目录结构"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 Registry 目录结构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x03-Registry-API"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 Registry API</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x04-Registry-GC"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 Registry GC</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x05-配置文件解析"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x05 配置文件解析</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- 微信公众号关注/文章版权复制 -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">博主Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">博主Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">墨天轮</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">西瓜视频</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/5-4-465.html&title=《Docker容器Registry私有镜像仓库安全配置与GC回收实践》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/5-4-465.html&title=《Docker容器Registry私有镜像仓库安全配置与GC回收实践》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/5-4-465.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Docker容器Registry私有镜像仓库安全配置与GC回收实践》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/5-4-465.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/5-4-465.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMUlEQVR42u3aS5IiMQwFwL7/pZkLNOY9CzoGO2tFEPVReqGQLP/8xNcjuJ7dv35n+9TowsDA+FpGEtzeB9ZvyH8nC4eBgXEDIwliElz+7PoNT//HwMDAWJZx63Sc3JN/FwMDA6N93TrQpE1tUzYGBsbNjKSJbRvXSbn5wV4cAwPjCxl7G2d/8/sj8w0MDIyvYjzKK39bmy4fgwsDA+NsRp7gkiAm7W5eXD4dqWJgYFzAyDfdkkY3T9brRcn/wcDAuIGxJuWb9e3hifwg2os4MTAwDmXkh7TyRnSyoZ8s6C/3Y2BgXMBoDzfMk2a7fC8iwcDAOJqRlINtYi02yOJ7ou08DAyMoxl7W2DtEuQpe+8ICAYGxm2MveFlvsW2txxti4uBgXEGIw+uHQPkBWWbTItjFhgYGAcx2uAmyHbkOapkMTAwjmBMkl07pKzPgIwHnBgYGCcx2n53HlCbcEfdNgYGxnGM+UZ829xOxpkYGBj3MNrH2uIvb4nnMWBgYJzK2HvdOpR2CNoecv3lWxgYGBcwktSWbK5NAsrLyheDTAwMjKMZbUCTBP2uo2MYGBhnMx7ltbe51m7kJdQXw0sMDIyDGPP5YHI8Ii891+G+YdiJgYHxtYwkyeYfy2u29vDHi2XFwMC4gJGUa5/Y0J8cwsDAwMDIS7R5mZgsU7TphoGBgVGOBPYWIm9035xwMTAw/ntG0sS244G2+GvxGBgY9zDy1nFv9NgGsZesMTAwDmX8AzohdHInVbZ/AAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// 站点运行时间
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "天" + RunHours + "时" + RunMinutes + "分" + RunSeconds + "秒";
  document.getElementById(id).innerHTML = "网站已在风雨中勉勉强强运行了【" + RunTime + "】";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>