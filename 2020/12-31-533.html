<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 5.Jenkins进阶之分布式架构扩充知识|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Jenkins">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>5.Jenkins进阶之分布式架构扩充知识</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">5.Jenkins进阶之分布式架构扩充知识</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-12-31T04:34:30.000Z" itemprop="datePublished" class="page-time">
  2020-12-31
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/CI-CD/">CI-CD</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-系统运维/自动化运维/CI-CD/Jenkins/5.Jenkins进阶之分布式架构扩充知识"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">5.Jenkins进阶之分布式架构扩充知识</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-12-31 12:34:30" datetime="2020-12-31T04:34:30.000Z"  itemprop="datePublished">2020-12-31</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/CI-CD/">CI-CD</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h2><p>描述: 有了上一章的基础<code>&quot;4.Jenkins进阶之分布式架构环境配置&quot;</code>介绍，本章主要介绍Kubernetes 的插件使用实例, 以及自定义 Slave 的 Jenkins-Jnlp 容器镜像模板(重点)，在进行K8s动态节点生成时拉取使用，极大的节约了系统资源。</p>
<hr>
<h2 id="0x01-Kubernetes-plugin-使用"><a href="#0x01-Kubernetes-plugin-使用" class="headerlink" title="0x01 Kubernetes-plugin 使用"></a>0x01 Kubernetes-plugin 使用</h2><p>描述: 前面已经对Jenkins集成Kubernetes进行部署和配置，本章将进行介绍与实践如何使用该插件以及帮助文档的记录;</p>
<p>说明: Kubernetes-plugin 它是在Kubernetes集群中运行动态代理的Jenkins插件, 该插件为每个启动的代理创建一个Kubernetes Pod，由Docker映像定义运行，并在每次构建后停止。</p>
<p>备注: 代理是使用JNLP启动的，因此预期图像会自动连接到Jenkins主机，以下是重要的环境变量（我们说过不建议使用自己jnlp覆盖默认的jnlp容器）。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jenkins/inbound-agent </span></span><br><span class="line">JENKINS_URL: Jenkins web interface url</span><br><span class="line">JENKINS_SECRET: the secret key <span class="keyword">for</span> authentication</span><br><span class="line">JENKINS_AGENT_NAME: the name of the Jenkins agent</span><br><span class="line">JENKINS_NAME: the name of the Jenkins agent (Deprecated. Only here <span class="keyword">for</span> backwards compatibility)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>插件地址: <a href="https://github.com/jenkinsci/kubernetes-plugin" target="_blank" rel="noopener">https://github.com/jenkinsci/kubernetes-plugin</a></li>
<li>自定义jnlp容器模板镜像地址: <a href="https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp" target="_blank" rel="noopener">https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp</a></li>
</ul>
<p>该镜像是Jenkins自定义jnlp容器模板，主要用于Jenkins工作节点容器化使用，主要包含Gitlab_release发布、 docker 容器管理、kubectl 集群管理功能。我们可以直接在docker 的环境中 <code>docker pull weiyigeek/alpine-jenkins-jnlp</code>下来</p>
<p><br></p>
<h3 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h3><ul>
<li><p><strong>1.先决条件</strong></p>
<ul>
<li>正在运行的Kubernetes集群1.14或更高版本。对于OpenShift用户，这意味着OpenShift容器平台4.x。</li>
<li>安装了一个Jenkins实例</li>
<li>已安装Jenkins Kubernetes插件</li>
</ul>
</li>
<li><p><strong>2.填写Kubernetes插件配置</strong></p>
<ul>
<li>您将打开Jenkins UI并导航至Manage Jenkins-&gt; Configure System-&gt; Cloud-&gt; Kubernetes并输入相应的Kubernetes URL和Jenkins URL，除非Jenkins在Kubernetes中运行否则默认工作（参考上一章）。</li>
</ul>
</li>
<li><p><strong>3.支持的凭证</strong></p>
<ul>
<li>Username/password - 用户名密码</li>
<li>Secret File (kubeconfig file) - 秘密文件（kubeconfig文件）</li>
<li>Secret text (Token-based authentication) (OpenShift) - 秘密文本（基于令牌的身份验证）（OpenShift）</li>
<li>Google Service Account from private key (GKE authentication) - 来自私钥的Google服务帐户（GKE身份验证）</li>
<li>X.509 Client Certificate - X.509客户端证书</li>
</ul>
</li>
</ul>
<p><br></p>
<h3 id="插件参数"><a href="#插件参数" class="headerlink" title="插件参数"></a>插件参数</h3><h4 id="podTemplate-Pod和容器模板"><a href="#podTemplate-Pod和容器模板" class="headerlink" title="podTemplate - Pod和容器模板"></a>podTemplate - Pod和容器模板</h4><p>描述: podTemplate 是用于创建代理的pod的模板可以通过<code>用户界面或管道进行配置</code>, 无论哪种方式它都可以访问以下字段：</p>
<ul>
<li>1) cloud ：在Jenkins设置中定义的云的名称。默认为kubernetes</li>
<li>2) name : Pod 名称</li>
<li>3) namespace : 名称空间设置</li>
<li>4) label : 标签值可以设置为唯一的值，以避免跨构建冲突，或省略，并在步骤中定义POD_LABEL。</li>
<li>5) yaml : 资源清单声明</li>
<li>6) yamlFile : 指定资源清单的文件</li>
<li>7) yamlMergeStrategy : 控制yaml定义是覆盖还是与从用声明的pod模板继承的yaml定义合并inheritFrom。默认为override()。</li>
<li>8) showRawYaml : 启用或禁用原始Yaml文件的输出默认为true (后续实践)</li>
<li>8) serviceAccount : k8s中创建的服务帐户</li>
<li>9) nodeSelector ：节点选择器</li>
<li>10) nodeUsageMode : 节点调用模式(NORMAL它控制Jenkins是只调度标签表达式匹配的作业，EXCLUSIVE尽可能多地使用该节点。)</li>
<li>11) volumes ：为pod定义各种类型的卷并在所有容器中挂载卷</li>
<li>12) envVars ：应用于所有容器的环境变量(<code>envVar 环境变量其值是内联定义的, secretEnvVar 一个环境变量其值是从Kubernetes机密派生的。</code>)</li>
<li>13) imagePullSecrets : 从私有的镜像仓库中拉取镜像的凭据</li>
<li>14) annotations : Pod 注解</li>
<li>15) InheritFrom ：继承的一个或多个Pod模板的列表</li>
<li>16) slaveConnectTimeout : 代理程序联机超时时间（单位s）</li>
<li>17) podRetention ：控制保留代理Pod的行为(<code>Can be &#39;never()&#39;, &#39;onFailure()&#39;, &#39;always()&#39;, or &#39;default()&#39;</code>),如果为空则按照下面的active Deadline Seconds参数进行。</li>
<li>18) activeDeadlineSeconds ： pod将在这个截止日期过后被删除。</li>
<li>19) idleMinutes : 允许Pod保持活动状态以供重用，直到在执行最后一步以来经过了配置的分钟数为止。</li>
<li>20) runAsUser : 用户ID，用于将pod中的所有容器运行为。</li>
<li>21) runAsGroup : 组ID，用于将Pod中的所有容器运行为。</li>
<li>22) hostNetwork : 使用主机网络。</li>
<li>23) container  : 用于创建pod容器的容器模板 (见下文) - (重点)。</li>
<li>24) defaultContainer : 指定Pod中默认容器则在stages中不用加入container进行指定选择;</li>
</ul>
<p><br></p>
<h4 id="container-容器模板的定义"><a href="#container-容器模板的定义" class="headerlink" title="container - 容器模板的定义"></a>container - 容器模板的定义</h4><p>描述: containerTemplate 是一个将被添加到pod中的容器模板它属于container中数组对象。同样它可以通过用户界面或管道进行配置，并允许你设置以下字段:</p>
<p><strong>containerTemplate - 容器模板</strong></p>
<ul>
<li>name  : 容器的名称。</li>
<li>image : 容器的图像。</li>
<li>envVars : 应用于容器的环境变量（<code>补充和覆盖在pod级别设置的env var</code>）。<ul>
<li>envVar 环境变量，其值是内联定义的。</li>
<li>secretEnvVar 一个环境变量，其值是从Kubernetes机密派生的。</li>
</ul>
</li>
<li>workingDir : 工作空间目录</li>
<li>command : 容器将执行的命令。</li>
<li>args    : 传递给命令的参数。</li>
<li>ttyEnabled : 标记以指示应启用tty。</li>
<li>livenessProbe : 要添加到容器中的exec liveness探针的参数（不支持httpGet liveness探针）</li>
<li>ports : 暴露容器上的端口。</li>
<li>alwaysPullImage : 容器在启动时将拉出图像。</li>
<li>runAsUser : 用于运行容器的用户ID。</li>
<li>runAsGroup : 运行容器的组ID。</li>
</ul>
<p><br/></p>
<p><strong>Liveness Probe Usage</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">containerTemplate(</span><br><span class="line">  name: <span class="string">'busybox'</span>, </span><br><span class="line">  image: <span class="string">'busybox'</span>,</span><br><span class="line">  ttyEnabled: <span class="literal">true</span>, </span><br><span class="line">  <span class="built_in">command</span>: <span class="string">'cat'</span>, </span><br><span class="line">  livenessProbe: containerLivenessProbe( </span><br><span class="line">    execArgs: <span class="string">'some --command'</span>, </span><br><span class="line">    initialDelaySeconds: 30, </span><br><span class="line">    timeoutSeconds: 1, </span><br><span class="line">    failureThreshold: 3, </span><br><span class="line">    periodSeconds: 10, </span><br><span class="line">    successThreshold: 1</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>Tips : 默认情况下<code>代理连接超时设置为100秒</code>。在某些情况下您想要设置一个不同的值，如果可以可以将system属性设置<code>org.csanchez.jenkins.plugins.kubernetes.PodTemplate.connectionTimeout</code>为一个不同的值</p>
<hr>
<h3 id="Pipeline-Support-实践示例"><a href="#Pipeline-Support-实践示例" class="headerlink" title="Pipeline Support 实践示例"></a>Pipeline Support 实践示例</h3><h4 id="Scripted-Pipeline"><a href="#Scripted-Pipeline" class="headerlink" title="Scripted Pipeline"></a>Scripted Pipeline</h4><p>描述： Scripted Pipeline 示例参考: </p>
<ul>
<li><a href="https://github.com/jenkinsci/kubernetes-plugin/tree/master/examples" target="_blank" rel="noopener">https://github.com/jenkinsci/kubernetes-plugin/tree/master/examples</a></li>
<li><a href="https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline" target="_blank" rel="noopener">https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline</a></li>
</ul>
<p><br></p>
<p><strong>(1) containerTemplate</strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">podTemplate(</span><br><span class="line"><span class="symbol">  cloud:</span> <span class="string">'kubernetes'</span>,</span><br><span class="line"><span class="symbol">  name:</span> <span class="string">'jenkins-slave'</span>,</span><br><span class="line"><span class="symbol">  namespace:</span> <span class="string">'devops'</span>,</span><br><span class="line"><span class="symbol">  label:</span> <span class="string">'k8s-slave'</span>,</span><br><span class="line">  <span class="comment">// 容器及容器模板定义</span></span><br><span class="line"><span class="symbol">  containers:</span> [</span><br><span class="line">    containerTemplate(</span><br><span class="line"><span class="symbol">      name:</span> <span class="string">'maven'</span>,</span><br><span class="line"><span class="symbol">      image:</span> <span class="string">'maven:3.6-jdk-8-alpine'</span>,</span><br><span class="line"><span class="symbol">      ttyEnabled:</span> <span class="literal">true</span>,</span><br><span class="line"><span class="symbol">      command:</span> <span class="string">'cat'</span>,</span><br><span class="line"><span class="symbol">      privileged:</span> <span class="literal">false</span>,</span><br><span class="line"><span class="symbol">      alwaysPullImage:</span> <span class="literal">false</span>,</span><br><span class="line"><span class="symbol">      workingDir:</span> <span class="string">'/home/jenkins/agent'</span>,</span><br><span class="line"><span class="symbol">      resourceRequestCpu:</span> <span class="string">'100m'</span>,</span><br><span class="line"><span class="symbol">      resourceLimitCpu:</span> <span class="string">'500m'</span>,</span><br><span class="line"><span class="symbol">      resourceRequestMemory:</span> <span class="string">'100Mi'</span>,</span><br><span class="line"><span class="symbol">      resourceLimitMemory:</span> <span class="string">'500Mi'</span>,</span><br><span class="line"><span class="symbol">      envVars:</span> [</span><br><span class="line">        envVar(<span class="string">key:</span> <span class="string">'MYSQL_ALLOW_EMPTY_PASSWORD'</span>, <span class="string">value:</span> <span class="string">'true'</span>)</span><br><span class="line">       <span class="comment">//, secretEnvVar(key: 'MYSQL_PASSWORD', secretName: 'mysql-secret', secretKey: 'password')</span></span><br><span class="line">      ]</span><br><span class="line">      <span class="comment">//,ports: [portMapping(name: 'mysql', containerPort: 3306, hostPort: 3306)]</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//     ),</span></span><br><span class="line">    <span class="comment">// containerTemplate(</span></span><br><span class="line">    <span class="comment">//         name: 'jnlp',</span></span><br><span class="line">    <span class="comment">//         image: 'registry.cn-hangzhou.aliyuncs.com/google-containers/jnlp-slave:alpine',</span></span><br><span class="line">    <span class="comment">//         args: '$&#123;computer.jnlpmac&#125; $&#123;computer.name&#125;',</span></span><br><span class="line">    <span class="comment">//         command: ''</span></span><br><span class="line">    <span class="comment">//     )</span></span><br><span class="line">  ]</span><br><span class="line">  ,<span class="string">volumes:</span> [</span><br><span class="line">    hostPathVolume(<span class="string">hostPath:</span> <span class="string">'/nfsdisk-31/appstorage/mavenRepo'</span>, <span class="string">mountPath:</span> <span class="string">'/home/jenkins'</span>),</span><br><span class="line">    hostPathVolume(<span class="string">hostPath:</span> <span class="string">'/var/run/docker.sock'</span>, <span class="string">mountPath:</span> <span class="string">'/var/run/docker.sock'</span>),</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    emptyDirVolume(mountPath: '/etc/mount1', memory: false),</span></span><br><span class="line"><span class="comment">    secretVolume(mountPath: '/etc/mount2', secretName: 'my-secret'),</span></span><br><span class="line"><span class="comment">    configMapVolume(mountPath: '/etc/mount3', configMapName: 'my-config'),</span></span><br><span class="line"><span class="comment">    hostPathVolume(mountPath: '/etc/mount4', hostPath: '/mnt/my-mount'),</span></span><br><span class="line"><span class="comment">    nfsVolume(mountPath: '/etc/mount5', serverAddress: '127.0.0.1', serverPath: '/', readOnly: true),</span></span><br><span class="line"><span class="comment">    persistentVolumeClaim(mountPath: '/home/jenkins', claimName: 'jenkins', readOnly: false),</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  ],</span><br><span class="line"><span class="symbol">  annotations:</span> [</span><br><span class="line">    podAnnotation(<span class="string">key:</span> <span class="string">"maven-pod"</span>, <span class="string">value:</span> <span class="string">"Kubernetes-jenkins-Test"</span>)</span><br><span class="line">  ],</span><br><span class="line"><span class="symbol">  showRawYaml:</span> <span class="string">'flase'</span></span><br><span class="line">  <span class="comment">//,defaultContainer: 'maven'   # scripted pipeline 不支持该参数</span></span><br><span class="line">  <span class="comment">//,imagePullSecrets: [ 'pull-secret' ]</span></span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">// 注意此次node中则为Pod模板名称</span></span><br><span class="line"> node (<span class="string">'k8s-slave'</span>) &#123;</span><br><span class="line">    <span class="comment">// container 中指定Pod中容器名称</span></span><br><span class="line">    container(<span class="string">'maven'</span>) &#123;</span><br><span class="line">      stage(<span class="string">'maven'</span>) &#123;</span><br><span class="line">        container(<span class="string">'maven'</span>) &#123;</span><br><span class="line">          sh <span class="string">"hostname &amp;&amp; ip addr"</span></span><br><span class="line">          sh (<span class="string">"mvn -version"</span>)</span><br><span class="line">          sh <span class="string">"env"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行结果:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Still waiting to schedule task</span></span><br><span class="line"><span class="comment"># Waiting for next available executor on 'jenkins-slave-09vf0-sf3k6' </span></span><br><span class="line"><span class="comment"># 等待下一个可用的执行器启动</span></span><br><span class="line"></span><br><span class="line">Created Pod: kubernetes devops/jenkins-slave-rtjxx-q3nhn</span><br><span class="line">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Scheduled] Successfully assigned devops/jenkins-slave-rtjxx-q3nhn to work-223</span><br><span class="line"></span><br><span class="line">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Pulled] Container image <span class="string">"maven:3.6-jdk-8-alpine"</span> already present on machine</span><br><span class="line">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Created] Created container maven | Started container maven</span><br><span class="line"></span><br><span class="line">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Pulled] Container image <span class="string">"jenkins/inbound-agent:4.3-4"</span> already present on machine</span><br><span class="line">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Created] Created container jnlp | Started container jnlp</span><br><span class="line"></span><br><span class="line">Agent jenkins-slave-rtjxx-q3nhn is provisioned from template jenkins-slave-rtjxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------</span></span><br><span class="line">apiVersion: <span class="string">"v1"</span></span><br><span class="line">kind: <span class="string">"Pod"</span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    maven-pod: <span class="string">"Kubernetes-jenkins-Test"</span>   <span class="comment"># 我们添加的注解</span></span><br><span class="line">    buildUrl: <span class="string">"http://jenkins.devops.svc.cluster.local:8080/job/Kubernetes-jenkins-slave/23/"</span></span><br><span class="line">    runUrl: <span class="string">"job/Kubernetes-jenkins-slave/23/"</span></span><br><span class="line">  labels:</span><br><span class="line">    jenkins: <span class="string">"slave"</span></span><br><span class="line">    jenkins/label-digest: <span class="string">"823e2bb3db243573786b7a360a483f1acc7a0f96"</span></span><br><span class="line">    jenkins/label: <span class="string">"k8s-slave"</span></span><br><span class="line">  name: <span class="string">"jenkins-slave-rtjxx-q3nhn"</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - <span class="built_in">command</span>:</span><br><span class="line">    - <span class="string">"cat"</span>   <span class="comment"># 运行的命令</span></span><br><span class="line">    env:</span><br><span class="line">    - name: <span class="string">"MYSQL_ALLOW_EMPTY_PASSWORD"</span>  <span class="comment"># 运行的环境变量</span></span><br><span class="line">      value: <span class="string">"true"</span></span><br><span class="line">    image: <span class="string">"maven:3.6-jdk-8-alpine"</span></span><br><span class="line">    imagePullPolicy: <span class="string">"IfNotPresent"</span>    <span class="comment"># 镜像拉取策略</span></span><br><span class="line">    name: <span class="string">"maven"</span>                      <span class="comment"># 容器名称</span></span><br><span class="line">    resources: </span><br><span class="line">      limits:</span><br><span class="line">        memory: <span class="string">"500Mi"</span></span><br><span class="line">        cpu: <span class="string">"500m"</span></span><br><span class="line">      requests:</span><br><span class="line">        memory: <span class="string">"100Mi"</span></span><br><span class="line">        cpu: <span class="string">"100m"</span></span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    volumeMounts:                      <span class="comment"># 卷挂载情况</span></span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins"</span></span><br><span class="line">      name: <span class="string">"volume-0"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">    - mountPath: <span class="string">"/var/run/docker.sock"</span></span><br><span class="line">      name: <span class="string">"volume-1"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">      name: <span class="string">"workspace-volume"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">    workingDir: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">  - env:                                   <span class="comment"># jnlp 环境变量</span></span><br><span class="line">    - name: <span class="string">"JENKINS_SECRET"</span></span><br><span class="line">      value: <span class="string">"********"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_AGENT_NAME"</span></span><br><span class="line">      value: <span class="string">"jenkins-slave-rtjxx-q3nhn"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_NAME"</span></span><br><span class="line">      value: <span class="string">"jenkins-slave-rtjxx-q3nhn"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_AGENT_WORKDIR"</span></span><br><span class="line">      value: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_URL"</span></span><br><span class="line">      value: <span class="string">"http://jenkins.devops.svc.cluster.local:8080/"</span></span><br><span class="line">    image: <span class="string">"jenkins/inbound-agent:4.3-4"</span></span><br><span class="line">    name: <span class="string">"jnlp"</span>                         <span class="comment"># jenkins-jnlp 容器的名称 </span></span><br><span class="line">    resources:</span><br><span class="line">      limits: &#123;&#125;</span><br><span class="line">      requests:</span><br><span class="line">        memory: <span class="string">"256Mi"</span></span><br><span class="line">        cpu: <span class="string">"100m"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins"</span></span><br><span class="line">      name: <span class="string">"volume-0"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">    - mountPath: <span class="string">"/var/run/docker.sock"</span></span><br><span class="line">      name: <span class="string">"volume-1"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">      name: <span class="string">"workspace-volume"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/os: <span class="string">"linux"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: <span class="string">"/nfsdisk-31/appstorage/mavenRepo"</span></span><br><span class="line">    name: <span class="string">"volume-0"</span></span><br><span class="line">  - hostPath:</span><br><span class="line">      path: <span class="string">"/var/run/docker.sock"</span></span><br><span class="line">    name: <span class="string">"volume-1"</span></span><br><span class="line">  - emptyDir:</span><br><span class="line">      medium: <span class="string">""</span></span><br><span class="line">    name: <span class="string">"workspace-volume"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line">+ hostname</span><br><span class="line">  <span class="comment"># jenkins-slave-rtjxx-q3nhn</span></span><br><span class="line"></span><br><span class="line">+ ip addr</span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line">  <span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line">  <span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># 2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/ipip 0.0.0.0 brd 0.0.0.0</span></span><br><span class="line">  <span class="comment"># 4: eth0@if162: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1480 qdisc noqueue state UP </span></span><br><span class="line">  <span class="comment">#     link/ether de:c6:df:23:e1:7f brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 172.16.24.220/32 brd 172.16.24.220 scope global eth0</span></span><br><span class="line">  <span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line">+ mvn -version</span><br><span class="line">  <span class="comment"># Apache Maven 3.6.1 (d66c9c0b3152b2e69ee9bac180bb8fcc8e6af555; 2019-04-04T19:00:29Z)</span></span><br><span class="line">  <span class="comment"># Maven home: /usr/share/maven</span></span><br><span class="line">  <span class="comment"># Java version: 1.8.0_212, vendor: IcedTea, runtime: /usr/lib/jvm/java-1.8-openjdk/jre</span></span><br><span class="line">  <span class="comment"># Default locale: en_US, platform encoding: UTF-8</span></span><br><span class="line">  <span class="comment"># OS name: "linux", version: "5.4.0-42-generic", arch: "amd64", family: "unix"</span></span><br><span class="line"></span><br><span class="line">+ env</span><br><span class="line">  <span class="comment"># JENKINS_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># POD_CONTAINER=maven</span></span><br><span class="line">  <span class="comment"># STAGE_NAME=maven</span></span><br><span class="line">  <span class="comment"># KUBERNETES_SERVICE_PORT=443</span></span><br><span class="line">  <span class="comment"># JAVA_VERSION=8u212</span></span><br><span class="line">  <span class="comment"># MAVEN_HOME=/usr/share/maven</span></span><br><span class="line">  <span class="comment"># MAVEN_CONFIG=/root/.m2</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : 在PodTemplate模板中设置 <code>showRawYaml: &#39;flase&#39;</code> 则将不会显示资源清单在日志中;</p>
<figure class="image-box">
                <a rel=5.Jenkins进阶之分布式架构扩充知识 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210207131120.png" target="_blank" title="WeiyiGeek.脚本式流水线k8s插件使用" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210207131120.png" alt="WeiyiGeek.脚本式流水线k8s插件使用" title="" class=""></a>
                <p>WeiyiGeek.脚本式流水线k8s插件使用</p>
            </figure>
<p>Tips : 要使用 secretEnvVar 我们必须在 <code>Dashboard -&gt; 凭据 -&gt; 系统 -&gt; 全局凭据 (unrestricted)</code> 进行添加一个Secret-text凭据(未能成功复现);<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Secret text	4fc93636-d8f1-4051-8011-d852873fc740	mysql-secret	Secret text	mysql-secret</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="Declarative-Pipeline"><a href="#Declarative-Pipeline" class="headerlink" title="Declarative Pipeline"></a>Declarative Pipeline</h4><p>描述: 声明式管道支持需要Jenkins 2.66+, 在Declarative Pipeline使用的 kubernetes 选项说明;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options are [activeDeadlineSeconds, cloud, containerTemplate, containerTemplates, customWorkspace, defaultContainer, idleMinutes, inheritFrom, instanceCap, label, namespace, nodeSelector, podRetention, serviceAccount, slaveConnectTimeout, supplementalGroups, workingDir, workspaceVolume, yaml, yamlFile, yamlMergeStrategy]</span><br></pre></td></tr></table></figure></p>
<p>示例帮助: <a href="https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/samples" target="_blank" rel="noopener">https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/samples</a></p>
<p><br></p>
<p><strong>示例1.通过yaml文件资源清单创建</strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    kubernetes &#123;</span><br><span class="line">      cloud <span class="string">'kubernetes'</span></span><br><span class="line">      namespace <span class="string">'devops'</span></span><br><span class="line">      workingDir <span class="string">'/home/jenkins/agent'</span></span><br><span class="line">      <span class="comment">// 继承模板</span></span><br><span class="line">      inheritFrom <span class="string">'jenkins-slave'</span></span><br><span class="line">      defaultContainer <span class="string">'maven'</span> </span><br><span class="line">      <span class="comment">// yamlFile 'KubernetesPod.yaml'</span></span><br><span class="line">      yaml <span class="string">"""\</span></span><br><span class="line"><span class="string">apiVersion:</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    jenkins: "slave"</span></span><br><span class="line"><span class="string">    jenkins/label: 'k8s-slave'</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: 'maven'</span></span><br><span class="line"><span class="string">    image: 'maven:3.6-jdk-8-alpine'</span></span><br><span class="line"><span class="string">    imagePullPolicy: 'IfNotPresent'     # 镜像拉取策略</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">    - cat</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    """</span>.stripIndent()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage (<span class="string">'declarative Pipeline - kubernetes'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"declarative Pipeline - kubernetes"</span></span><br><span class="line">        container (<span class="string">'maven'</span>) &#123;</span><br><span class="line">          sh <span class="string">"echo $&#123;POD_CONTAINER&#125;"</span></span><br><span class="line">          sh <span class="string">"mvn -version"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行结果:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">[Pipeline] Start of Pipeline</span><br><span class="line">[Pipeline] podTemplate</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] node</span><br><span class="line"><span class="comment"># 'kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8' is offline</span></span><br><span class="line"><span class="comment"># Agent kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8 is provisioned from template Kubernetes-jenkins-slave_49-fcd1s-m3n3q</span></span><br><span class="line">---</span><br><span class="line">kind: <span class="string">"Pod"</span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    buildUrl: <span class="string">"http://jenkins.devops.svc.cluster.local:8080/job/Kubernetes-jenkins-slave/49/"</span></span><br><span class="line">    runUrl: <span class="string">"job/Kubernetes-jenkins-slave/49/"</span></span><br><span class="line">  labels:</span><br><span class="line">    jenkins: <span class="string">"slave"</span></span><br><span class="line">    jenkins/label: <span class="string">"Kubernetes-jenkins-slave_49-fcd1s"</span></span><br><span class="line">    jenkins/label-digest: <span class="string">"95508e0ca05226ba84989959dc886ad4011cf125"</span></span><br><span class="line">  name: <span class="string">"kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8"</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - <span class="built_in">command</span>:</span><br><span class="line">    - <span class="string">"cat"</span></span><br><span class="line">    image: <span class="string">"maven:3.6-jdk-8-alpine"</span></span><br><span class="line">    imagePullPolicy: <span class="string">"IfNotPresent"</span></span><br><span class="line">    name: <span class="string">"maven"</span></span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">      name: <span class="string">"workspace-volume"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">  - env:</span><br><span class="line">    - name: <span class="string">"JENKINS_SECRET"</span></span><br><span class="line">      value: <span class="string">"********"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_AGENT_NAME"</span></span><br><span class="line">      value: <span class="string">"kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_NAME"</span></span><br><span class="line">      value: <span class="string">"kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_AGENT_WORKDIR"</span></span><br><span class="line">      value: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_URL"</span></span><br><span class="line">      value: <span class="string">"http://jenkins.devops.svc.cluster.local:8080/"</span></span><br><span class="line">    image: <span class="string">"jenkins/inbound-agent:4.3-4"</span></span><br><span class="line">    name: <span class="string">"jnlp"</span></span><br><span class="line">    resources:</span><br><span class="line">      limits: &#123;&#125;</span><br><span class="line">      requests:</span><br><span class="line">        memory: <span class="string">"256Mi"</span></span><br><span class="line">        cpu: <span class="string">"100m"</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins/.m2"</span></span><br><span class="line">      name: <span class="string">"volume-0"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">      name: <span class="string">"workspace-volume"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">  hostNetwork: <span class="literal">false</span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/os: <span class="string">"linux"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: <span class="string">"/nfsdisk-31/appstorage/mavenRepo"</span></span><br><span class="line">    name: <span class="string">"volume-0"</span></span><br><span class="line">  - emptyDir:</span><br><span class="line">      medium: <span class="string">""</span></span><br><span class="line">    name: <span class="string">"workspace-volume"</span></span><br><span class="line"></span><br><span class="line">Running on kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8 <span class="keyword">in</span> /home/jenkins/agent/workspace/Kubernetes-jenkins-slave</span><br><span class="line">  <span class="comment"># [Pipeline] &#123;</span></span><br><span class="line">  <span class="comment"># [Pipeline] container</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#123;</span></span><br><span class="line">  <span class="comment"># [Pipeline] stage</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#123; (declarative Pipeline - kubernetes)</span></span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">declarative Pipeline - kubernetes</span><br><span class="line">  <span class="comment"># [Pipeline] container</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#123;</span></span><br><span class="line">  <span class="comment"># [Pipeline] sh</span></span><br><span class="line">+ <span class="built_in">echo</span> maven</span><br><span class="line">maven</span><br><span class="line">  <span class="comment"># [Pipeline] sh</span></span><br><span class="line">+ mvn -version</span><br><span class="line">Apache Maven 3.6.1 (d66c9c0b3152b2e69ee9bac180bb8fcc8e6af555; 2019-04-04T19:00:29Z)</span><br><span class="line">Maven home: /usr/share/maven</span><br><span class="line">Java version: 1.8.0_212, vendor: IcedTea, runtime: /usr/lib/jvm/java-1.8-openjdk/jre</span><br><span class="line">Default locale: en_US, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">"linux"</span>, version: <span class="string">"5.4.0-42-generic"</span>, arch: <span class="string">"amd64"</span>, family: <span class="string">"unix"</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#125;</span></span><br><span class="line">  <span class="comment"># [Pipeline] // container</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#125;</span></span><br><span class="line">  <span class="comment"># [Pipeline] // stage</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#125;</span></span><br><span class="line">  <span class="comment"># [Pipeline] // container</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#125;</span></span><br><span class="line">  <span class="comment"># [Pipeline] // node</span></span><br><span class="line">  <span class="comment"># [Pipeline] &#125;</span></span><br><span class="line">  <span class="comment"># [Pipeline] // podTemplate</span></span><br><span class="line">  <span class="comment"># [Pipeline] End of Pipeline</span></span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure></p>
<p>Tips :默认情况下在容器中运行步骤, 步骤将嵌套在隐式container（name）{…}块中，而不是在jnlp容器中执行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defaultContainer <span class="string">'maven'</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : 您也可以使用yamlFile将pod模板保存在单独的KubernetesPod.yaml文件中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    kubernetes &#123;</span><br><span class="line">      yamlFile <span class="string">'KubernetesPod.yaml'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">     ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x02-自定义Jenkins工作节点之jnlp-slave镜像模板构建"><a href="#0x02-自定义Jenkins工作节点之jnlp-slave镜像模板构建" class="headerlink" title="0x02 自定义Jenkins工作节点之jnlp-slave镜像模板构建"></a>0x02 自定义Jenkins工作节点之jnlp-slave镜像模板构建</h2><h3 id="Dockerfile-构建依赖"><a href="#Dockerfile-构建依赖" class="headerlink" title="Dockerfile 构建依赖"></a>Dockerfile 构建依赖</h3><p>描述: 下述相关脚本以及文件下载地址请在<code>WeiyiGeek</code>微信公众号回复<code>jenkins-jnlp-dockerfile</code>关键字获取; </p>
<p>自定义的jnlp容器模板主要实现功能: </p>
<ul>
<li>用户权限控制(sudo)</li>
<li>ssh 远程连接</li>
<li>git 代码版本控制</li>
<li>docker 容器管理</li>
<li>kubectl 集群管理</li>
<li>Java 运行环境</li>
<li>Maven 运行环境</li>
<li>SonarQube 扫描环境</li>
<li>Gitlab_release 上传环境</li>
<li>中文环境支持</li>
<li>时区更改配置</li>
</ul>
<p><br></p>
<p>Tips: 在K8s集群中测试alpine镜像执行相应的安装(需要在Alpine调试新安装软件时使用):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: alpine-app</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: alpine-app</span><br><span class="line">    image: alpine:latest</span><br><span class="line">    args:</span><br><span class="line">    - sleep</span><br><span class="line">    - <span class="string">"100000"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">pod/alpine-app created</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">  <span class="comment"># NAME                                       READY   STATUS    RESTARTS   AGE    IP              NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># alpine-app                                 1/1     Running   0          116s   10.100.37.194   worker-02   &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>Dockerfile</strong></p>
<p>自定义jnlp容器模板镜像地址: <a href="https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp" target="_blank" rel="noopener">https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp</a></p>
<p>该镜像是Jenkins自定义jnlp容器模板，主要用于Jenkins工作节点容器化使用，主要包含Gitlab_release发布、 docker 容器管理、kubectl 集群管理功能。我们可以直接在docker 的环境中 <code>docker pull weiyigeek/alpine-jenkins-jnlp</code>下来</p>
<p>说明: 镜像构建文件<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#----------------------------------------------------------------------#</span></span><br><span class="line"><span class="comment"># Title: Base in Alpine Images Create Custom Jenkins Kubernetes jnlp Images</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># WebSite: https://weiyigeek.top</span></span><br><span class="line"><span class="comment"># MainFunction:</span></span><br><span class="line"><span class="comment">#   Install ssh-server docker git openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm jq</span></span><br><span class="line"><span class="comment">#   Install JDK8</span></span><br><span class="line"><span class="comment">#   - https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span></span><br><span class="line"><span class="comment">#   - https://github.com/sgerrand/alpine-pkg-glibc/releases/</span></span><br><span class="line"><span class="comment">#   - https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub</span></span><br><span class="line"><span class="comment">#   Install jnlp</span></span><br><span class="line"><span class="comment">#   - https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting/</span></span><br><span class="line"><span class="comment">#   Install Maven</span></span><br><span class="line"><span class="comment">#   - https://apache.osuosl.org/maven/maven-3/$&#123;MAVEN_VERSION&#125;/binaries</span></span><br><span class="line"><span class="comment">#   Install SonarqubeScan</span></span><br><span class="line"><span class="comment">#   - https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.5.0.2216-linux.zip</span></span><br><span class="line"><span class="comment">#   Install Gitlab Release Version: 0.0.6</span></span><br><span class="line"><span class="comment">#   - https://gitlab.com/gitlab-org/release-cli/-/releases</span></span><br><span class="line"><span class="comment">#   Install kubernetes cli</span></span><br><span class="line"><span class="comment">#   - kubectl Version: 1.19.3</span></span><br><span class="line"><span class="comment"># Version: alpine-3.13.1</span></span><br><span class="line"><span class="comment"># Release: v1.10</span></span><br><span class="line"><span class="comment"># ChangeLog:</span></span><br><span class="line"><span class="comment"># v1.9 -  增加 中文环境</span></span><br><span class="line"><span class="comment"># v1.10 - 增加 node.js 环境支持</span></span><br><span class="line"><span class="comment">#-------------------------------------------------#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.13</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span>  Jenkins Custom Work Node Jnlp Container - &lt;master@weiyigeek.top&gt; - WeiyiGeek</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> USERNAME=jenkins \</span><br><span class="line">    AGENT_WORKDIR=/home/jenkins \</span><br><span class="line">    BASE_DIR=/usr/local  \</span><br><span class="line">    BASE_BIN=/usr/local/bin  \</span><br><span class="line">    BASE_URL=http://<span class="number">192.168</span>.<span class="number">12.107</span>:<span class="number">8080</span>  \</span><br><span class="line">    LOCALE=locale.md \</span><br><span class="line">    JDK_NAME=jdk-<span class="number">8</span>u281-linux-x64   \</span><br><span class="line">    JDK_DIR=/usr/local/jdk1.<span class="number">8.0</span>_281  \</span><br><span class="line">    GLIBC_NAME=glibc-<span class="number">2.32</span>-r0.apk \</span><br><span class="line">    GLIBC_BIN_NAME=glibc-bin-<span class="number">2.32</span>-r0.apk \</span><br><span class="line">    GLIBC_I18N_NAME=glibc-i18n-<span class="number">2.32</span>-r0.apk \</span><br><span class="line">    MAVEN_NAME=apache-maven-<span class="number">3.6</span>.<span class="number">3</span>-bin \</span><br><span class="line">    MAVEN_DIR=/usr/local/apache-maven-<span class="number">3.6</span>.<span class="number">3</span> \</span><br><span class="line">    SONAR_SCANNER_NAME=sonar-scanner-cli-<span class="number">4.5</span>.<span class="number">0.2216</span>-linux \</span><br><span class="line">    SONAR_SCANNER_DIR=/usr/local/sonar-scanner-<span class="number">4.5</span>.<span class="number">0.2216</span>-linux \</span><br><span class="line">    GITLAB_CLI=release-cli-<span class="number">0.6</span>.<span class="number">0</span>-linux-amd64 </span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG=en_US.UTF-<span class="number">8</span> \</span><br><span class="line">    LC_ALL=en_US.UTF-<span class="number">8</span> \</span><br><span class="line">    JAVA_HOME=/usr/local/jdk8  \ </span><br><span class="line">    JRE_HOME=/usr/local/jdk8/jre \ </span><br><span class="line">    MAVEN_HOME=/usr/local/maven \ </span><br><span class="line">    MAVEN_RPEO=/home/jenkins/.m2 \</span><br><span class="line">    SONAR_SCANNER_HOME=/usr/local/sonar-scanner \</span><br><span class="line">    NODEJS_MODULES=/usr/lib/node_modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户ROOT切换</span></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="comment"># Shell 命令 - 此种方式极大减少了构建的镜像大小;</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm jq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod 4755 /bin/busybox \</span></span><br><span class="line"><span class="bash">    &amp;&amp; addgroup -g 1000 -S <span class="variable">$&#123;USERNAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; adduser <span class="variable">$&#123;USERNAME&#125;</span> -D -g <span class="variable">$&#123;USERNAME&#125;</span> -G root -u 1000 -s /bin/sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"jenkins   ALL=(root) NOPASSWD:ALL"</span> &gt;&gt; /etc/sudoers \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p <span class="variable">$&#123;AGENT_WORKDIR&#125;</span>/.ssh <span class="variable">$&#123;AGENT_WORKDIR&#125;</span>/.m2 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;GLIBC_NAME&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GLIBC_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;GLIBC_BIN_NAME&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GLIBC_BIN_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;GLIBC_I18N_NAME&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GLIBC_I18N_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /etc/apk/keys/sgerrand.rsa.pub <span class="variable">$&#123;BASE_URL&#125;</span>/sgerrand.rsa.pub \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;LOCALE&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;LOCALE&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;JDK_NAME&#125;</span>.tar.gz <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;JDK_NAME&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O <span class="variable">$&#123;BASE_BIN&#125;</span>/agent.jar <span class="variable">$&#123;BASE_URL&#125;</span>/agent.jar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o <span class="variable">$&#123;BASE_BIN&#125;</span>/jenkins-agent.sh <span class="variable">$&#123;BASE_URL&#125;</span>/jenkins-agent.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /tmp/<span class="variable">$&#123;MAVEN_NAME&#125;</span>.tar.gz <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;MAVEN_NAME&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /tmp/<span class="variable">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /usr/<span class="built_in">local</span>/bin/release-cli <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GITLAB_CLI&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /usr/<span class="built_in">local</span>/bin/kubectl <span class="variable">$&#123;BASE_URL&#125;</span>/kubectl \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/#PermitRootLogin.*/PermitRootLogin yes/g"</span> /etc/ssh/sshd_config \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/^#\s*StrictHostKeyChecking ask/StrictHostKeyChecking no/g"</span> /etc/ssh/ssh_config \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t dsa -P <span class="string">""</span> -f /etc/ssh/ssh_host_dsa_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t rsa -P <span class="string">""</span> -f /etc/ssh/ssh_host_rsa_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t ecdsa -P <span class="string">""</span> -f /etc/ssh/ssh_host_ecdsa_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t ed25519 -P <span class="string">""</span> -f /etc/ssh/ssh_host_ed25519_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t ed25519 -P <span class="string">""</span> -C <span class="string">"master@weiyigeek.top"</span> -f /home/jenkins/.ssh/id_ed25519 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add /tmp/<span class="variable">$&#123;GLIBC_NAME&#125;</span> /tmp/<span class="variable">$&#123;GLIBC_BIN_NAME&#125;</span> /tmp/<span class="variable">$&#123;GLIBC_I18N_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -zxf /tmp/<span class="variable">$&#123;JDK_NAME&#125;</span>.tar.gz -C <span class="variable">$&#123;BASE_DIR&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv <span class="variable">$&#123;JDK_DIR&#125;</span> <span class="variable">$&#123;JAVA_HOME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -zxf /tmp/<span class="variable">$&#123;MAVEN_NAME&#125;</span>.tar.gz -C <span class="variable">$&#123;BASE_DIR&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv <span class="variable">$&#123;MAVEN_DIR&#125;</span> <span class="variable">$&#123;MAVEN_HOME&#125;</span> \ </span></span><br><span class="line">    &amp;&amp; unzip /tmp/$&#123;SONAR_SCANNER_NAME&#125;.zip -d $&#123;BASE_DIR&#125; \</span><br><span class="line">    &amp;&amp; mv $&#123;SONAR_SCANNER_DIR&#125; $&#123;SONAR_SCANNER_HOME&#125; \</span><br><span class="line">    &amp;&amp; npm config set registry https://registry.npmmirror.com \</span><br><span class="line">    &amp;&amp; chmod a+x $&#123;BASE_BIN&#125;/* \</span><br><span class="line">    &amp;&amp; chown -R jenkins:jenkins $&#123;BASE_DIR&#125;/ $&#123;AGENT_WORKDIR&#125;/ $&#123;NODEJS_MODULES&#125;/ \</span><br><span class="line">    &amp;&amp; echo <span class="string">"root:WeiyiGeek"</span> | chpasswd \</span><br><span class="line">    &amp;&amp; echo <span class="string">"jenkins:WeiyiGeek"</span> | chpasswd \</span><br><span class="line">    &amp;&amp; cat /tmp/$&#123;LOCALE&#125; | xargs -i /usr/glibc-compat/bin/localedef -i &#123;&#125; -f UTF-<span class="number">8</span> &#123;&#125;.UTF-<span class="number">8</span> \</span><br><span class="line">    &amp;&amp; sed -i <span class="string">"s#use_embedded_jre=true#use_embedded_jre=false#g"</span> $&#123;SONAR_SCANNER_HOME&#125;/bin/sonar-scanner \</span><br><span class="line">    &amp;&amp; rm -rf /var/cache/apk/* /tmp/* $&#123;SONAR_SCANNER_HOME&#125;/jre/* \</span><br><span class="line">    &amp;&amp; cd $&#123;JAVA_HOME&#125; \</span><br><span class="line">    &amp;&amp; rm -rf COPYRIGHT LICENSE README release THIRDPARTYLICENSEREADME-JAVAFX.txt THIRDPARTYLICENSEREADME.txt Welcome.html  javafx-src.zip src.zip \</span><br><span class="line">    lib/plugin.jar \</span><br><span class="line">    lib/ext/jfxrt.jar \</span><br><span class="line">    bin/javaws \</span><br><span class="line">    lib/javaws.jar \</span><br><span class="line">    lib/desktop \</span><br><span class="line">    plugin \</span><br><span class="line">    lib/deploy* \</span><br><span class="line">    lib/*javafx* \</span><br><span class="line">    lib/*jfx* \</span><br><span class="line">    lib/amd64/libdecora_sse.so \</span><br><span class="line">    lib/amd64/libprism_*.so \</span><br><span class="line">    lib/amd64/libfxplugins.so \</span><br><span class="line">    lib/amd64/libglass.so \</span><br><span class="line">    lib/amd64/libgstreamer-lite.so \</span><br><span class="line">    lib/amd64/libjavafx*.so \</span><br><span class="line">    lib/amd64/libjfx*.so</span><br><span class="line">    &amp;&amp; echo <span class="string">"export LANG=zh_CN.UTF-8"</span> &gt; /etc/profile.d/locale.sh </span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> jenkins </span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$&#123;AGENT_WORKDIR&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib/dt.jar:$&#123;JAVA_HOME&#125;/lib/tools.jar \</span><br><span class="line">    PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;MAVEN_HOME&#125;/bin:$&#123;SONAR_SCANNER_HOME&#125;/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/usr/local/bin/jenkins-agent.sh"</span>]</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>local.md</strong><br>描述：让alpine操作系统中文字符支持;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">tee local.md &lt;&lt;<span class="string">'END'</span></span><br><span class="line">en_AG</span><br><span class="line">en_AU</span><br><span class="line">en_BW</span><br><span class="line">en_CA</span><br><span class="line">en_DK</span><br><span class="line">en_GB</span><br><span class="line">en_HK</span><br><span class="line">en_IE</span><br><span class="line">en_IN</span><br><span class="line">en_NG</span><br><span class="line">en_NZ</span><br><span class="line">en_PH</span><br><span class="line">en_SG</span><br><span class="line">en_US</span><br><span class="line">en_ZA</span><br><span class="line">en_ZM</span><br><span class="line">en_ZW</span><br><span class="line">zh_CN</span><br><span class="line">zh_HK</span><br><span class="line">zh_SG</span><br><span class="line">zh_TW</span><br><span class="line">zu_ZA</span><br><span class="line">END</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>jenkins-agent.sh</strong><br>描述: 容器启动时与<code>jenkins</code>利用Java jnlp 进行连接的脚本;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Usage jenkins-agent.sh [options] -url http://jenkins [SECRET] [AGENT_NAME]</span></span><br><span class="line"><span class="comment"># Optional environment variables :</span></span><br><span class="line"><span class="comment"># * JENKINS_TUNNEL : HOST:PORT for a tunnel to route TCP traffic to jenkins host, when jenkins can't be directly accessed over network</span></span><br><span class="line"><span class="comment"># * JENKINS_URL : alternate jenkins URL</span></span><br><span class="line"><span class="comment"># * JENKINS_SECRET : agent secret, if not set as an argument</span></span><br><span class="line"><span class="comment"># * JENKINS_AGENT_NAME : agent name, if not set as an argument</span></span><br><span class="line"><span class="comment"># * JENKINS_AGENT_WORKDIR : agent work directory, if not set by optional parameter -workDir</span></span><br><span class="line"><span class="comment"># * JENKINS_WEB_SOCKET: true if the connection should be made via WebSocket rather than TCP</span></span><br><span class="line"><span class="comment"># * JENKINS_DIRECT_CONNECTION: Connect directly to this TCP agent port, skipping the HTTP(S) connection parameter download.</span></span><br><span class="line"><span class="comment">#                              Value: "&lt;HOST&gt;:&lt;PORT&gt;"</span></span><br><span class="line"><span class="comment"># * JENKINS_INSTANCE_IDENTITY: The base64 encoded InstanceIdentity byte array of the Jenkins master. When this is set,</span></span><br><span class="line"><span class="comment">#                              the agent skips connecting to an HTTP(S) port for connection info.</span></span><br><span class="line"><span class="comment"># * JENKINS_PROTOCOLS:         Specify the remoting protocols to attempt when instanceIdentity is provided.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># if `docker run` only has one arguments, we assume user is running alternate command like `bash` to inspect the image</span></span><br><span class="line">        <span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="comment"># if -tunnel is not provided, try env vars</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"<span class="variable">$@</span>"</span> <span class="keyword">in</span></span><br><span class="line">                *<span class="string">"-tunnel "</span>*) ;;</span><br><span class="line">                *)</span><br><span class="line">                <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$JENKINS_TUNNEL</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                  TUNNEL=<span class="string">"-tunnel <span class="variable">$JENKINS_TUNNEL</span>"</span></span><br><span class="line">                <span class="keyword">fi</span> ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># if -workDir is not provided, try env vars</span></span><br><span class="line">        <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$JENKINS_AGENT_WORKDIR</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">"<span class="variable">$@</span>"</span> <span class="keyword">in</span></span><br><span class="line">                        *<span class="string">"-workDir"</span>*) <span class="built_in">echo</span> <span class="string">"Warning: Work directory is defined twice in command-line arguments and the environment variable"</span> ;;</span><br><span class="line">                        *)</span><br><span class="line">                        WORKDIR=<span class="string">"-workDir <span class="variable">$JENKINS_AGENT_WORKDIR</span>"</span> ;;</span><br><span class="line">                <span class="keyword">esac</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$JENKINS_URL</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                URL=<span class="string">"-url <span class="variable">$JENKINS_URL</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$JENKINS_NAME</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                JENKINS_AGENT_NAME=<span class="string">"<span class="variable">$JENKINS_NAME</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$JENKINS_WEB_SOCKET</span>"</span> = <span class="literal">true</span> ]; <span class="keyword">then</span></span><br><span class="line">                WEB_SOCKET=-webSocket</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$JENKINS_PROTOCOLS</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                PROTOCOLS=<span class="string">"-protocols <span class="variable">$JENKINS_PROTOCOLS</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$JENKINS_DIRECT_CONNECTION</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                DIRECT=<span class="string">"-direct <span class="variable">$JENKINS_DIRECT_CONNECTION</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$JENKINS_INSTANCE_IDENTITY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                INSTANCE_IDENTITY=<span class="string">"-instanceIdentity <span class="variable">$JENKINS_INSTANCE_IDENTITY</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># if java home is defined, use it</span></span><br><span class="line">        JAVA_BIN=<span class="string">"java"</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$JAVA_HOME</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                JAVA_BIN=<span class="string">"<span class="variable">$JAVA_HOME</span>/bin/java"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># if both required options are defined, do not pass the parameters</span></span><br><span class="line">        OPT_JENKINS_SECRET=<span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$JENKINS_SECRET</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">"<span class="variable">$@</span>"</span> <span class="keyword">in</span></span><br><span class="line">                        *<span class="string">"<span class="variable">$&#123;JENKINS_SECRET&#125;</span>"</span>*) <span class="built_in">echo</span> <span class="string">"Warning: SECRET is defined twice in command-line arguments and the environment variable"</span> ;;</span><br><span class="line">                        *)</span><br><span class="line">                        OPT_JENKINS_SECRET=<span class="string">"<span class="variable">$&#123;JENKINS_SECRET&#125;</span>"</span> ;;</span><br><span class="line">                <span class="keyword">esac</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        OPT_JENKINS_AGENT_NAME=<span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$JENKINS_AGENT_NAME</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">"<span class="variable">$@</span>"</span> <span class="keyword">in</span></span><br><span class="line">                        *<span class="string">"<span class="variable">$&#123;JENKINS_AGENT_NAME&#125;</span>"</span>*) <span class="built_in">echo</span> <span class="string">"Warning: AGENT_NAME is defined twice in command-line arguments and the environment variable"</span> ;;</span><br><span class="line">                        *)</span><br><span class="line">                        OPT_JENKINS_AGENT_NAME=<span class="string">"<span class="variable">$&#123;JENKINS_AGENT_NAME&#125;</span>"</span> ;;</span><br><span class="line">                <span class="keyword">esac</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#<span class="doctag">TODO:</span> Handle the case when the command-line and Environment variable contain different values.</span></span><br><span class="line">        <span class="comment">#It is fine it blows up for now since it should lead to an error anyway.</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">exec</span> <span class="variable">$JAVA_BIN</span> <span class="variable">$JAVA_OPTS</span> -cp /usr/<span class="built_in">local</span>/bin/agent.jar hudson.remoting.jnlp.Main -headless <span class="variable">$TUNNEL</span> <span class="variable">$URL</span> <span class="variable">$WORKDIR</span> <span class="variable">$WEB_SOCKET</span> <span class="variable">$DIRECT</span> <span class="variable">$PROTOCOLS</span> <span class="variable">$INSTANCE_IDENTITY</span> <span class="variable">$OPT_JENKINS_SECRET</span> <span class="variable">$OPT_JENKINS_AGENT_NAME</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>镜像构建所需软件</strong><br>备注: 在Jenkins 2.277版本中添加一个新的节点中获取匹配当前版本的 agent.jar, 或者是在 jenkins 官网 <a href="https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting" target="_blank" rel="noopener">https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting</a> 进行下载;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/k8s/jenkins/jnlp-slave$ ls</span><br><span class="line">agent.jar                      build              jdk-8u281-linux-x64.tar.gz  Jenkins.zip  release-cli-0.6.0-linux-amd64  sonar-scanner-cli-4.5.0.2216-linux.zip</span><br><span class="line">apache-maven-3.6.3-bin.tar.gz  glibc-2.32-r0.apk  jenkins-agent.sh            kubectl      sgerrand.rsa.pub</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="Dockerfile-构建操作"><a href="#Dockerfile-构建操作" class="headerlink" title="Dockerfile 构建操作"></a>Dockerfile 构建操作</h3><p><strong>操作流程</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (0) 启动一个临时的web服务器（`存放上面的镜像构建所需软件`-非常重要-否则将会导致构建失败）</span></span><br><span class="line">~/k8s/jenkins/jnlp-slave$ python3 -m http.server 8080</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...</span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /glibc-2.32-r0.apk HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /glibc-bin-2.32-r0.apk HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /glibc-i18n-2.32-r0.apk HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /sgerrand.rsa.pub HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /locale.md HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /jdk-8u281-linux-x64.tar.gz HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /agent.jar HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /jenkins-agent.sh HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /apache-maven-3.6.3-bin.tar.gz HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /sonar-scanner-cli-4.5.0.2216-linux.zip HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /release-cli-0.6.0-linux-amd64 HTTP/1.1" 200 -</span></span><br><span class="line"><span class="comment"># 172.17.0.4 - - [30/Mar/2021 17:32:00] "GET /kubectl HTTP/1.1" 200 -</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) 镜像构建</span></span><br><span class="line">docker build -t weiyigeek/alpine-jenkins-jnlp .</span><br><span class="line">  <span class="comment"># Successfully built b47b6581b712</span></span><br><span class="line">  <span class="comment"># Successfully tagged weiyigeek/alpine-jenkins-jnlp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 查看构建信息</span></span><br><span class="line">docker images weiyigeek/alpine-jenkins-jnlp --all</span><br><span class="line">  <span class="comment"># REPOSITORY                               TAG           IMAGE ID       CREATED             SIZE</span></span><br><span class="line">  <span class="comment"># harbor.weiyigeek.top/devops/jenkins-jnlp   3.13.1-alpine   b47b6581b712   About an hour ago   715MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 推送镜像</span></span><br><span class="line">docker push weiyigeek/alpine-jenkins-jnlp</span><br><span class="line">  <span class="comment"># The push refers to repository [harbor.weiyigeek.top/devops/jenkins-jnlp]</span></span><br><span class="line">  <span class="comment"># 059ea3fbd3b3: Pushed</span></span><br><span class="line">  <span class="comment"># 1119ff37d4a9: Layer already exists</span></span><br><span class="line">  <span class="comment"># 3.13.1-alpine: digest: sha256:1f869c553340c9399c7db9072169600a17ddb0ec41d41d3a4365b8c1571fc201 size: 741</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 采用Ansible各节点拉取镜像</span></span><br><span class="line">ansible node -m shell -a <span class="string">"docker pull weiyigeek/alpine-jenkins-jnlp"</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=5.Jenkins进阶之分布式架构扩充知识 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210330173121.png" target="_blank" title="WeiyiGeek.DockerFile构建自定义Jnlp容器" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210330173121.png" alt="WeiyiGeek.DockerFile构建自定义Jnlp容器" title="" class=""></a>
                <p>WeiyiGeek.DockerFile构建自定义Jnlp容器</p>
            </figure>
<p><br></p>
<h3 id="自定义-jenkins-jnlp-slave-镜像的使用"><a href="#自定义-jenkins-jnlp-slave-镜像的使用" class="headerlink" title="自定义 jenkins-jnlp-slave 镜像的使用"></a>自定义 jenkins-jnlp-slave 镜像的使用</h3><p>描述: 此处还是利用Jenkins的kubernetes插件，让jenkins在进job时动态的生成工作节点(Pod)，并在结束后销毁容器。</p>
<ul>
<li><p>Step 1.创建流水线 <code>Kubernetes-jenkins-slave</code> Job 在流水线中采用Pipeline Script脚本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    kubernetes &#123;</span><br><span class="line">      cloud <span class="string">'kubernetes'</span></span><br><span class="line">      namespace <span class="string">'devops'</span></span><br><span class="line">      inheritFrom <span class="string">'jenkins-slave'</span></span><br><span class="line">      workingDir <span class="string">'/home/jenkins/agent'</span></span><br><span class="line">      <span class="comment">// yamlFile 'KubernetesPod.yaml'</span></span><br><span class="line">      yaml <span class="string">"""\</span></span><br><span class="line"><span class="string">apiVersion:</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    jenkins: "slave"</span></span><br><span class="line"><span class="string">    jenkins/label: 'k8s-slave'</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: 'jnlp'</span></span><br><span class="line"><span class="string">    image: 'weiyigeek/alpine-jenkins-jnlp'</span></span><br><span class="line"><span class="string">    imagePullPolicy: 'IfNotPresent'                                     # 镜像拉取策略</span></span><br><span class="line"><span class="string">    command: ["/bin/sh","-c","/usr/local/bin/jenkins-agent.sh &amp;&amp; cat"]  # 重点测试的时候(心酸累)希望读者体验一哈</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - mountPath: "/home/jenkins/.m2"</span></span><br><span class="line"><span class="string">      name: "volume-0"</span></span><br><span class="line"><span class="string">    - mountPath: "/var/run/docker.sock"</span></span><br><span class="line"><span class="string">      name: "volume-1"</span></span><br><span class="line"><span class="string">    """</span>.stripIndent()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage (<span class="string">'declarative Pipeline - kubernetes'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"declarative Pipeline - kubernetes"</span></span><br><span class="line">        sh <span class="string">"mvn -version"</span></span><br><span class="line">        sh <span class="string">"release-cli -v"</span></span><br><span class="line">        sh <span class="string">"sonar-scanner -v"</span></span><br><span class="line">        sh <span class="string">"kubectl version"</span></span><br><span class="line">        sh <span class="string">"docker --version &amp;&amp; sudo docker ps"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.配置<code>Pod Templates</code>模板如下因为我们需要继承一哈</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">名称：jenkins-slave</span><br><span class="line">命名空间: devops</span><br><span class="line">标签列表: k8s-slave</span><br><span class="line">添加主机卷: </span><br><span class="line"> - 主机: /nfsdisk-31/appstorage/mavenRepo</span><br><span class="line"> - Pod 挂载路径: /home/jenkins/.m2</span><br><span class="line"> - 主机: /var/run/docker.sock</span><br><span class="line"> - Pod 挂载路径: /var/run/docker.sock</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.在BlueOcen中运行并查看结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 可以看见当进行调度时k8s会动态的拉取镜像并运行，当任务结束后会自动销毁Pod</span></span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Pending   0          0s</span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Pending   0          0s</span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     ContainerCreating   0          0s</span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   1/1     Running             0          3s</span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   1/1     Terminating         0          13s</span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Terminating         0          45s</span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Terminating         0          46s</span><br><span class="line">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Terminating         0          46s</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 动态创建的slave启动的Pod脚本</span></span><br><span class="line">---</span><br><span class="line">kind: <span class="string">"Pod"</span></span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    buildUrl: <span class="string">"http://jenkins.devops.svc.cluster.local:8080/job/Kubernetes-jenkins-slave/63/"</span></span><br><span class="line">    runUrl: <span class="string">"job/Kubernetes-jenkins-slave/63/"</span></span><br><span class="line">  labels:</span><br><span class="line">    jenkins: <span class="string">"slave"</span></span><br><span class="line">    jenkins/label: <span class="string">"Kubernetes-jenkins-slave_63-01h9j"</span></span><br><span class="line">    jenkins/label-digest: <span class="string">"0fe6224168b9ce0350e7db8678c10953c2e6f533"</span></span><br><span class="line">  name: <span class="string">"kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5"</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - <span class="built_in">command</span>:</span><br><span class="line">    - <span class="string">"/bin/sh"</span></span><br><span class="line">    - <span class="string">"-c"</span></span><br><span class="line">    - <span class="string">"/usr/local/bin/jenkins-agent.sh &amp;&amp; cat"</span></span><br><span class="line">    env:</span><br><span class="line">    - name: <span class="string">"JENKINS_SECRET"</span></span><br><span class="line">      value: <span class="string">"********"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_AGENT_NAME"</span></span><br><span class="line">      value: <span class="string">"kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_NAME"</span></span><br><span class="line">      value: <span class="string">"kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_AGENT_WORKDIR"</span></span><br><span class="line">      value: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">    - name: <span class="string">"JENKINS_URL"</span></span><br><span class="line">      value: <span class="string">"http://jenkins.devops.svc.cluster.local:8080/"</span></span><br><span class="line">    image: <span class="string">"weiyigeek/alpine-jenkins-jnlp"</span></span><br><span class="line">    imagePullPolicy: <span class="string">"IfNotPresent"</span></span><br><span class="line">    name: <span class="string">"jnlp"</span></span><br><span class="line">    resources:</span><br><span class="line">      limits: &#123;&#125;</span><br><span class="line">      requests:</span><br><span class="line">        memory: <span class="string">"256Mi"</span></span><br><span class="line">        cpu: <span class="string">"100m"</span></span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins/.m2"</span></span><br><span class="line">      name: <span class="string">"volume-0"</span></span><br><span class="line">    - mountPath: <span class="string">"/var/run/docker.sock"</span></span><br><span class="line">      name: <span class="string">"volume-1"</span></span><br><span class="line">    - mountPath: <span class="string">"/home/jenkins/agent"</span></span><br><span class="line">      name: <span class="string">"workspace-volume"</span></span><br><span class="line">      readOnly: <span class="literal">false</span></span><br><span class="line">  hostNetwork: <span class="literal">false</span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/os: <span class="string">"linux"</span></span><br><span class="line">  restartPolicy: <span class="string">"Never"</span></span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: <span class="string">"/nfsdisk-31/appstorage/mavenRepo"</span></span><br><span class="line">    name: <span class="string">"volume-0"</span></span><br><span class="line">  - hostPath:</span><br><span class="line">      path: <span class="string">"/var/run/docker.sock"</span></span><br><span class="line">    name: <span class="string">"volume-1"</span></span><br><span class="line">  - emptyDir:</span><br><span class="line">      medium: <span class="string">""</span></span><br><span class="line">    name: <span class="string">"workspace-volume"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Running on kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5 in /home/jenkins/agent/workspace/Kubernetes-jenkins-slave</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本反馈</span></span><br><span class="line">declarative Pipeline - kubernetes</span><br><span class="line">+ mvn -version</span><br><span class="line">  Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)</span><br><span class="line">  Maven home: /usr/<span class="built_in">local</span>/maven</span><br><span class="line">  Java version: 1.8.0_281, vendor: Oracle Corporation, runtime: /usr/<span class="built_in">local</span>/jdk8/jre</span><br><span class="line">  Default locale: en_US, platform encoding: ANSI_X3.4-1968</span><br><span class="line">  OS name: <span class="string">"linux"</span>, version: <span class="string">"5.4.0-42-generic"</span>, arch: <span class="string">"amd64"</span>, family: <span class="string">"unix"</span></span><br><span class="line"></span><br><span class="line">+ release-cli -v</span><br><span class="line">     version 0.6.0</span><br><span class="line"></span><br><span class="line">+ sonar-scanner -v</span><br><span class="line">  INFO: Scanner configuration file: /usr/<span class="built_in">local</span>/sonar-scanner/conf/sonar-scanner.properties</span><br><span class="line">  INFO: Project root configuration file: NONE</span><br><span class="line">  INFO: SonarScanner 4.5.0.2216</span><br><span class="line">  INFO: Java 1.8.0_281 Oracle Corporation (64-bit)</span><br><span class="line">  INFO: Linux 5.4.0-42-generic amd64</span><br><span class="line"></span><br><span class="line">+ kubectl version</span><br><span class="line">  Client Version: version.Info&#123;Major:<span class="string">"1"</span>, Minor:<span class="string">"19"</span>, GitVersion:<span class="string">"v1.19.6"</span>, GitCommit:<span class="string">"fbf646b339dc52336b55d8ec85c181981b86331a"</span>, GitTreeState:<span class="string">"clean"</span>, BuildDate:<span class="string">"2020-12-18T12:09:30Z"</span>, GoVersion:<span class="string">"go1.15.5"</span>, Compiler:<span class="string">"gc"</span>, Platform:<span class="string">"linux/amd64"</span>&#125;</span><br><span class="line">  Server Version: version.Info&#123;Major:<span class="string">"1"</span>, Minor:<span class="string">"19"</span>, GitVersion:<span class="string">"v1.19.6"</span>, GitCommit:<span class="string">"fbf646b339dc52336b55d8ec85c181981b86331a"</span>, GitTreeState:<span class="string">"clean"</span>, BuildDate:<span class="string">"2020-12-18T12:01:36Z"</span>, GoVersion:<span class="string">"go1.15.5"</span>, Compiler:<span class="string">"gc"</span>, Platform:<span class="string">"linux/amd64"</span>&#125;</span><br><span class="line"></span><br><span class="line">+ docker --version</span><br><span class="line">  Docker version 20.10.3, build 48d30b5b32e99c932b4ea3edca74353feddd83ff</span><br><span class="line"></span><br><span class="line">+ sudo docker ps  <span class="comment"># 非常注意权限</span></span><br><span class="line">CONTAINER ID   IMAGE                                                           COMMAND                  CREATED              STATUS          PORTS     NAMES</span><br><span class="line">bd9948326a78   harbor.weiyigeek.top/devops/jenkins-jnlp                          <span class="string">"/bin/sh -c '/usr/lo…"</span>   39 seconds ago       Up 32 seconds             k8s_jnlp_kubernetes-jenkins-slave-68-91jbw-svtg2-3vq9b_devops_6d4bc0d2-b34f-46fc-9c9d-65537cb2bff8_0</span><br><span class="line">84538d2017c2   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2   <span class="string">"/pause"</span>                 About a minute ago   Up 58 seconds             k8s_POD_kubernetes-jenkins-slave-68-91jbw-svtg2-3vq9b_devops_6d4bc0d2-b34f-46fc-9c9d-65537cb2bff8_0</span><br><span class="line"></span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=5.Jenkins进阶之分布式架构扩充知识 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210208155114.png" target="_blank" title="WeiyiGeek.custom-jenkins-jnlp" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210208155114.png" alt="WeiyiGeek.custom-jenkins-jnlp" title="" class=""></a>
                <p>WeiyiGeek.custom-jenkins-jnlp</p>
            </figure>
<p><br></p>
<h3 id="Dockerfile-迭代更新"><a href="#Dockerfile-迭代更新" class="headerlink" title="Dockerfile 迭代更新"></a>Dockerfile 迭代更新</h3><ul>
<li>截止于【2021年5月17日 16:41:37】最新更新的Dockerfile<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#----------------------------------------------------------------------#</span></span><br><span class="line"><span class="comment"># Title: Base in Alpine Images Create Custom Jenkins Kubernetes jnlp Images</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># WebSite: https://weiyigeek.top</span></span><br><span class="line"><span class="comment"># Email: mastr@weiyigeek.top</span></span><br><span class="line"><span class="comment"># Release: v1.11</span></span><br><span class="line"><span class="comment"># Image Version: alpine-3.13.1</span></span><br><span class="line"><span class="comment"># MainFunction:</span></span><br><span class="line"><span class="comment">#   Install ssh-server docker git openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm jq</span></span><br><span class="line"><span class="comment">#   Install JDK8 Version: 1.8.0_281</span></span><br><span class="line"><span class="comment">#   - https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span></span><br><span class="line"><span class="comment">#   - https://github.com/sgerrand/alpine-pkg-glibc/releases/</span></span><br><span class="line"><span class="comment">#   - https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub</span></span><br><span class="line"><span class="comment">#   Install jnlp Version: 4.11.2 (两钟方式都可以下载agent)</span></span><br><span class="line"><span class="comment">#   - https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting/</span></span><br><span class="line"><span class="comment">#   - http://youjenkins-domainname/jnlpJars/agent.jar</span></span><br><span class="line"><span class="comment">#   Install Maven Version: 3.8.4</span></span><br><span class="line"><span class="comment">#   - https://apache.osuosl.org/maven/maven-3/$&#123;MAVEN_VERSION&#125;/binaries</span></span><br><span class="line"><span class="comment">#   Install SonarqubeScan Version: 4.5.0</span></span><br><span class="line"><span class="comment">#   - https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.5.0.2216-linux.zip</span></span><br><span class="line"><span class="comment">#   Install Gitlab Release Version: 0.10.0</span></span><br><span class="line"><span class="comment">#   - https://gitlab.com/gitlab-org/release-cli/-/releases</span></span><br><span class="line"><span class="comment">#   Install kubernetes cli</span></span><br><span class="line"><span class="comment">#   - kubectl Version: 1.23.1</span></span><br><span class="line"><span class="comment">#   Install docker cli</span></span><br><span class="line"><span class="comment">#   - kubectl Version: 20.10.3</span></span><br><span class="line"><span class="comment"># ChangeLog:</span></span><br><span class="line"><span class="comment"># v1.8 - 增加 docker</span></span><br><span class="line"><span class="comment"># v1.9 -  增加 中文环境</span></span><br><span class="line"><span class="comment"># v1.10 - 增加 node.js 环境支持</span></span><br><span class="line"><span class="comment"># v1.11 - 更新依赖软件版本及其agent.jar版本</span></span><br><span class="line"><span class="comment">#-------------------------------------------------#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.13</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span>  Jenkins Custom Work Node Jnlp Container - &lt;master@weiyigeek.top&gt; - WeiyiGeek</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> USERNAME=jenkins \</span><br><span class="line">    AGENT_WORKDIR=/home/jenkins \</span><br><span class="line">    BASE_DIR=/usr/local  \</span><br><span class="line">    BASE_BIN=/usr/local/bin  \</span><br><span class="line">    BASE_URL=http://<span class="number">192.168</span>.<span class="number">12.107</span>:<span class="number">8080</span>  \</span><br><span class="line">    LOCALE=locale.md \</span><br><span class="line">    JDK_NAME=jdk-<span class="number">8</span>u281-linux-x64   \</span><br><span class="line">    JDK_DIR=/usr/local/jdk1.<span class="number">8.0</span>_281  \</span><br><span class="line">    GLIBC_NAME=glibc-<span class="number">2.32</span>-r0.apk \</span><br><span class="line">    GLIBC_BIN_NAME=glibc-bin-<span class="number">2.32</span>-r0.apk \</span><br><span class="line">    GLIBC_I18N_NAME=glibc-i18n-<span class="number">2.32</span>-r0.apk \</span><br><span class="line">    MAVEN_NAME=apache-maven-<span class="number">3.8</span>.<span class="number">4</span>-bin \</span><br><span class="line">    MAVEN_DIR=/usr/local/apache-maven-<span class="number">3.8</span>.<span class="number">4</span> \</span><br><span class="line">    SONAR_SCANNER_NAME=sonar-scanner-cli-<span class="number">4.5</span>.<span class="number">0.2216</span>-linux \</span><br><span class="line">    SONAR_SCANNER_DIR=/usr/local/sonar-scanner-<span class="number">4.5</span>.<span class="number">0.2216</span>-linux \</span><br><span class="line">    GITLAB_CLI=release-cli-<span class="number">0.10</span>.<span class="number">0</span>-linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG=en_US.UTF-<span class="number">8</span> \</span><br><span class="line">    LC_ALL=en_US.UTF-<span class="number">8</span> \</span><br><span class="line">    JAVA_HOME=/usr/local/jdk8  \</span><br><span class="line">    JRE_HOME=/usr/local/jdk8/jre \</span><br><span class="line">    MAVEN_HOME=/usr/local/maven \</span><br><span class="line">    MAVEN_RPEO=/home/jenkins/.m2 \</span><br><span class="line">    SONAR_SCANNER_HOME=/usr/local/sonar-scanner \</span><br><span class="line">    NODEJS_MODULES=/usr/lib/node_modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户ROOT切换</span></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="comment"># Shell 命令 - 此种方式极大减少了构建的镜像大小;</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm bash jq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod 4755 /bin/busybox \</span></span><br><span class="line"><span class="bash">    &amp;&amp; addgroup -g 1000 -S <span class="variable">$&#123;USERNAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; adduser <span class="variable">$&#123;USERNAME&#125;</span> -D -g <span class="variable">$&#123;USERNAME&#125;</span> -G root -u 1000 -s /bin/sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"jenkins   ALL=(root) NOPASSWD:ALL"</span> &gt;&gt; /etc/sudoers \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p <span class="variable">$&#123;AGENT_WORKDIR&#125;</span>/.ssh <span class="variable">$&#123;AGENT_WORKDIR&#125;</span>/.m2 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;GLIBC_NAME&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GLIBC_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;GLIBC_BIN_NAME&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GLIBC_BIN_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;GLIBC_I18N_NAME&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GLIBC_I18N_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /etc/apk/keys/sgerrand.rsa.pub <span class="variable">$&#123;BASE_URL&#125;</span>/sgerrand.rsa.pub \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;LOCALE&#125;</span> <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;LOCALE&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O /tmp/<span class="variable">$&#123;JDK_NAME&#125;</span>.tar.gz <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;JDK_NAME&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O <span class="variable">$&#123;BASE_BIN&#125;</span>/agent.jar <span class="variable">$&#123;BASE_URL&#125;</span>/agent.jar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o <span class="variable">$&#123;BASE_BIN&#125;</span>/jenkins-agent.sh <span class="variable">$&#123;BASE_URL&#125;</span>/jenkins-agent.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /tmp/<span class="variable">$&#123;MAVEN_NAME&#125;</span>.tar.gz <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;MAVEN_NAME&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /tmp/<span class="variable">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /usr/<span class="built_in">local</span>/bin/release-cli <span class="variable">$&#123;BASE_URL&#125;</span>/<span class="variable">$&#123;GITLAB_CLI&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /usr/<span class="built_in">local</span>/bin/kubectl <span class="variable">$&#123;BASE_URL&#125;</span>/kubectl \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL -o /usr/<span class="built_in">local</span>/bin/docker <span class="variable">$&#123;BASE_URL&#125;</span>/docker \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/#PermitRootLogin.*/PermitRootLogin yes/g"</span> /etc/ssh/sshd_config \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/^#\s*StrictHostKeyChecking ask/StrictHostKeyChecking no/g"</span> /etc/ssh/ssh_config \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t dsa -P <span class="string">""</span> -f /etc/ssh/ssh_host_dsa_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t rsa -P <span class="string">""</span> -f /etc/ssh/ssh_host_rsa_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t ecdsa -P <span class="string">""</span> -f /etc/ssh/ssh_host_ecdsa_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t ed25519 -P <span class="string">""</span> -f /etc/ssh/ssh_host_ed25519_key \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ssh-keygen -t ed25519 -P <span class="string">""</span> -C <span class="string">"master@weiyigeek.top"</span> -f /home/jenkins/.ssh/id_ed25519 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add /tmp/<span class="variable">$&#123;GLIBC_NAME&#125;</span> /tmp/<span class="variable">$&#123;GLIBC_BIN_NAME&#125;</span> /tmp/<span class="variable">$&#123;GLIBC_I18N_NAME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -zxf /tmp/<span class="variable">$&#123;JDK_NAME&#125;</span>.tar.gz -C <span class="variable">$&#123;BASE_DIR&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv <span class="variable">$&#123;JDK_DIR&#125;</span> <span class="variable">$&#123;JAVA_HOME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -zxf /tmp/<span class="variable">$&#123;MAVEN_NAME&#125;</span>.tar.gz -C <span class="variable">$&#123;BASE_DIR&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv <span class="variable">$&#123;MAVEN_DIR&#125;</span> <span class="variable">$&#123;MAVEN_HOME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; unzip /tmp/<span class="variable">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip -d <span class="variable">$&#123;BASE_DIR&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv <span class="variable">$&#123;SONAR_SCANNER_DIR&#125;</span> <span class="variable">$&#123;SONAR_SCANNER_HOME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; npm config <span class="built_in">set</span> registry https://registry.npmmirror.com \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x <span class="variable">$&#123;BASE_BIN&#125;</span>/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chown -R jenkins:jenkins <span class="variable">$&#123;BASE_DIR&#125;</span>/ <span class="variable">$&#123;AGENT_WORKDIR&#125;</span>/ <span class="variable">$&#123;NODEJS_MODULES&#125;</span>/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"root:WeiyiGeek"</span> | chpasswd \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"jenkins:WeiyiGeek"</span> | chpasswd \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat /tmp/<span class="variable">$&#123;LOCALE&#125;</span> | xargs -i /usr/glibc-compat/bin/localedef -i &#123;&#125; -f UTF-8 &#123;&#125;.UTF-8 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s#use_embedded_jre=true#use_embedded_jre=false#g"</span> <span class="variable">$&#123;SONAR_SCANNER_HOME&#125;</span>/bin/sonar-scanner \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/* /tmp/* <span class="variable">$&#123;SONAR_SCANNER_HOME&#125;</span>/jre/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> <span class="variable">$&#123;JAVA_HOME&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf COPYRIGHT LICENSE README release THIRDPARTYLICENSEREADME-JAVAFX.txt THIRDPARTYLICENSEREADME.txt Welcome.html  javafx-src.zip src.zip \</span></span><br><span class="line"><span class="bash">    lib/plugin.jar \</span></span><br><span class="line"><span class="bash">    lib/ext/jfxrt.jar \</span></span><br><span class="line"><span class="bash">    bin/javaws \</span></span><br><span class="line"><span class="bash">    lib/javaws.jar \</span></span><br><span class="line"><span class="bash">    lib/desktop \</span></span><br><span class="line"><span class="bash">    plugin \</span></span><br><span class="line"><span class="bash">    lib/deploy* \</span></span><br><span class="line"><span class="bash">    lib/*javafx* \</span></span><br><span class="line"><span class="bash">    lib/*jfx* \</span></span><br><span class="line"><span class="bash">    lib/amd64/libdecora_sse.so \</span></span><br><span class="line"><span class="bash">    lib/amd64/libprism_*.so \</span></span><br><span class="line"><span class="bash">    lib/amd64/libfxplugins.so \</span></span><br><span class="line"><span class="bash">    lib/amd64/libglass.so \</span></span><br><span class="line"><span class="bash">    lib/amd64/libgstreamer-lite.so \</span></span><br><span class="line"><span class="bash">    lib/amd64/libjavafx*.so \</span></span><br><span class="line"><span class="bash">    lib/amd64/libjfx*.so \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"export LANG=zh_CN.UTF-8"</span> &gt; /etc/profile.d/locale.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> jenkins</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$&#123;AGENT_WORKDIR&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib/dt.jar:$&#123;JAVA_HOME&#125;/lib/tools.jar \</span><br><span class="line">    PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;MAVEN_HOME&#125;/bin:$&#123;SONAR_SCANNER_HOME&#125;/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/usr/local/bin/jenkins-agent.sh"</span>]</span></span><br></pre></td></tr></table></figure>
</li>
</ul>

        </div>
        <!-- Google 广告 -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-07-20T08:36:07.727Z" itemprop="dateUpdated">2022-07-20 16:36:07</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/系统运维/自动化运维/CI-CD/Jenkins/5.Jenkins进阶之分布式架构扩充知识.md" target="_blank" rel="noopener noreferrer">_posts/系统运维/自动化运维/CI-CD/Jenkins/5.Jenkins进阶之分布式架构扩充知识.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2020/12-31-533.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/12-31-533.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/12-31-533.html&title=《5.Jenkins进阶之分布式架构扩充知识》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/12-31-533.html&title=《5.Jenkins进阶之分布式架构扩充知识》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/12-31-533.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《5.Jenkins进阶之分布式架构扩充知识》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/12-31-533.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/12-31-533.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/12-31-618.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">8.Jenkins进阶之工作学习所遇补充</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/12-30-523.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">3.Jenkins进阶之流水线pipeline基础使用实践</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-Kubernetes-plugin-使用"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 Kubernetes-plugin 使用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#环境依赖"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">环境依赖</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#插件参数"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">插件参数</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#podTemplate-Pod和容器模板"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">podTemplate - Pod和容器模板</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#container-容器模板的定义"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">container - 容器模板的定义</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Pipeline-Support-实践示例"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">Pipeline Support 实践示例</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Scripted-Pipeline"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text">Scripted Pipeline</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Declarative-Pipeline"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text">Declarative Pipeline</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-自定义Jenkins工作节点之jnlp-slave镜像模板构建"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 自定义Jenkins工作节点之jnlp-slave镜像模板构建</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Dockerfile-构建依赖"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">Dockerfile 构建依赖</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Dockerfile-构建操作"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">Dockerfile 构建操作</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#自定义-jenkins-jnlp-slave-镜像的使用"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">自定义 jenkins-jnlp-slave 镜像的使用</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Dockerfile-迭代更新"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">Dockerfile 迭代更新</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- 微信公众号关注/文章版权复制 -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">个人Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">个人Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">个人知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云+云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/12-31-533.html&title=《5.Jenkins进阶之分布式架构扩充知识》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/12-31-533.html&title=《5.Jenkins进阶之分布式架构扩充知识》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/12-31-533.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《5.Jenkins进阶之分布式架构扩充知识》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/12-31-533.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/12-31-533.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACIElEQVR42u3aS27jMBAFQN//0plNFgEytt9rygFEFldGIFEqLTr94eMRr69f6+ffV655th6fWBgYGLdlJNu1Wz/b4TWvZWNgYJzGePYq+dav70o+R/75MDAwMPIXWlkJFQMDA6Nl5AVqgp/tgIGBcTIjCYvtldHj/74Wx8DAuCEjb5/9/e+PzDcwMDBuxVgpO2dB+dp7v3fAwMDYmjEbYc4aZHkx/LrofZpoYmBgHMD4RNN/fZCZXImBgbE3I7e248xZoz+/9z8ZLgYGxtaMPBGcBdYZMmm6YWBgnMCY3ZCH0ZXxQ/IhoukoBgbGFow8aVspU2eJY33AAgMDYztGmxS24Xg2WmiTSwwMjNMYs8I1aootBPE3oRkDA+MARn2soQzB7bPqNBEDA+NgRhsQZ8ll/g5LvUAMDIyNGCsN+tkhjJaKgYFxMqMNu8XMoRyOtuNVDAyMkxkraWJ+bzKRfAPDwMDYmtEGxDZMXzUKXTpFgoGBsQUjP7A1KzhnQ9Dkq2NgYJzGuLaIXUkxh405DAyMrRntEYoWdlWumgdiDAyMnRhf5bqqEE0K3bwwxsDA2JvR9tVnhW47pMzbdjUGAwPjtow8yK4E6FkqWc9jMTAwtmasDBTzgLv+H+DNCBMDAwOjbI2tHPbKU0YMDAyMNiy2Y8u23K1nGhgYGBsxZuPJ2RGKJKDXCSUGBsbWjLx0zEPqrNzNnz4cZGJgYNyP8Q/hYxQZCpLd2wAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>