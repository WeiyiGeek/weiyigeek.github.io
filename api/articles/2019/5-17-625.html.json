{"title":"bat示例待整理","slug":"系统运维/Windows/Bat批处理编程/bat示例未整理","date":"2019-05-17T05:34:30.000Z","updated":"2022-03-29T04:55:20.335Z","url":"2019/5-17-625.html","path":"api/articles/2019/5-17-625.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<p>下载一个“Bat To Exe Converter”的程序即可将.bat的文件转换为.exe的执行文件Bat To Exe Converter下载地址如下：<br>  pageid: 224</p>\n<p><a href=\"http://pan.baidu.com/s/1sjNM8Lf\" target=\"_blank\" rel=\"noopener\">http://pan.baidu.com/s/1sjNM8Lf</a></p>\n<p>转换方法我就不介绍了，一共就几个选项，我想只要不是智障应该都知道怎样用的。<br>封装为.exe的程序后如下图：</p>\n<h3 id=\"基础示例\"><a href=\"#基础示例\" class=\"headerlink\" title=\"基础示例\"></a>基础示例</h3><p><strong>实际案例1.: 系统补丁检测并安装批处理</strong><br>描述: 可以使用下面的方法来检测和打补丁,采用systeminfo命令可以列出打过的补丁。<br><figure class=\"highlight bat\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">@<span class=\"built_in\">ECHO</span> off</span><br><span class=\"line\"><span class=\"comment\">REM By Leo</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> <span class=\"built_in\">TITLE</span>=Windows 补丁安装脚本 V0.<span class=\"number\">070408</span></span><br><span class=\"line\"><span class=\"built_in\">TITLE</span> <span class=\"variable\">%TITLE%</span></span><br><span class=\"line\"><span class=\"built_in\">SETLOCAL</span> ENABLEDELAYEDEXPANSION</span><br><span class=\"line\"><span class=\"built_in\">SET</span> PATCHFLAG=KB</span><br><span class=\"line\"><span class=\"built_in\">SET</span> CAT=<span class=\"variable\">%PATCHFLAG%</span>*.cat</span><br><span class=\"line\"><span class=\"built_in\">SET</span> PATCHLIST=\"<span class=\"variable\">%temp%</span>\\patcheslist.tmp\"</span><br><span class=\"line\"><span class=\"built_in\">SET</span> INSTALLED=√ 已安装</span><br><span class=\"line\"><span class=\"built_in\">SET</span> NOTINSTALLED=× 未安装</span><br><span class=\"line\"><span class=\"built_in\">SET</span> DELIMS=-----------------------------------------</span><br><span class=\"line\"><span class=\"built_in\">SET</span> PATCH_TOTAL=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> PATCH_NOTINSTALLED=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> FLAG_INSTALLED=<span class=\"number\">1</span>*</span><br><span class=\"line\"><span class=\"built_in\">SET</span> FLAG_NOTINSTALLED=<span class=\"number\">0</span>*</span><br><span class=\"line\"> </span><br><span class=\"line\">:main</span><br><span class=\"line\"><span class=\"built_in\">TITLE</span> 正在搜索... -- <span class=\"variable\">%TITLE%</span></span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> 正在搜索当前目录\"<span class=\"variable\">%cd%</span>\"及其子目录下的补丁...</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> 如果想在搜索完成后立即安装未安装的补丁，请按回车。</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span>.</span><br><span class=\"line\"><span class=\"comment\">REM 搜索补丁，没有搜索到则退出，否则继续。</span></span><br><span class=\"line\"><span class=\"keyword\">CALL</span> :pfind || (<span class=\"keyword\">call</span> :error <span class=\"number\">1</span>&amp; <span class=\"keyword\">goto</span> :eof)</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span>.</span><br><span class=\"line\">:confirm</span><br><span class=\"line\"><span class=\"built_in\">TITLE</span> 请选择要安装的补丁 -- <span class=\"variable\">%TITLE%</span></span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> 搜索到如上<span class=\"variable\">%PATCH_TOTAL%</span>个补丁，其中<span class=\"variable\">%PATCH_NOTINSTALLED%</span>个未安装。安装全部请输入ALL，否则请直接按回车安装尚未安装的补丁。</span><br><span class=\"line\"><span class=\"built_in\">SET</span> confirm=</span><br><span class=\"line\"><span class=\"built_in\">SET</span> /p confirm=</span><br><span class=\"line\"><span class=\"keyword\">IF</span> /i \"<span class=\"variable\">%confirm%</span>\" == \"ALL\" (<span class=\"built_in\">SET</span> confirm=</span><br><span class=\"line\"> ) <span class=\"keyword\">ELSE</span> <span class=\"keyword\">IF</span> <span class=\"keyword\">not</span> <span class=\"keyword\">defined</span> confirm (<span class=\"built_in\">SET</span> confirm=<span class=\"variable\">%FLAG_INSTALLED:~0,1%</span></span><br><span class=\"line\"> ) <span class=\"keyword\">ELSE</span> <span class=\"keyword\">GOTO</span> confirm</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> <span class=\"variable\">%DELIMS%</span></span><br><span class=\"line\"><span class=\"built_in\">ECHO</span>.</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> 正在安装，请稍候。安装程序不会抢占窗口焦点，所以你可以干点别的：）</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span>.</span><br><span class=\"line\"><span class=\"keyword\">CALL</span> :setup <span class=\"variable\">%confirm%</span></span><br><span class=\"line\"><span class=\"built_in\">del</span> <span class=\"variable\">%PATCHLIST%</span> <span class=\"number\">2</span>&gt;<span class=\"built_in\">nul</span> &gt;<span class=\"built_in\">nul</span></span><br><span class=\"line\"><span class=\"built_in\">TITLE</span> 安装已结束 -- <span class=\"variable\">%TITLE%</span></span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> <span class=\"variable\">%DELIMS%</span></span><br><span class=\"line\"><span class=\"built_in\">ECHO</span>.</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> 安装已结束。要使补丁生效，你可能需要手动重新启动计算机。</span><br><span class=\"line\"><span class=\"built_in\">ECHO</span> 按任意键退出。</span><br><span class=\"line\"><span class=\"built_in\">SET</span> <span class=\"built_in\">TITLE</span>=</span><br><span class=\"line\"><span class=\"built_in\">ENDLOCAL</span></span><br><span class=\"line\"><span class=\"built_in\">PAUSE</span> &gt;<span class=\"built_in\">nul</span></span><br><span class=\"line\"><span class=\"built_in\">TITLE</span> <span class=\"variable\">%ComSpec%</span></span><br><span class=\"line\"><span class=\"keyword\">goto</span> :eof</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">REM 安装补丁</span></span><br><span class=\"line\">:setup</span><br><span class=\"line\"><span class=\"keyword\">if</span> \"%<span class=\"number\">1</span>\" == \"\" (<span class=\"built_in\">set</span> patchsum=<span class=\"variable\">%PATCH_TOTAL%</span>) <span class=\"keyword\">ELSE</span> <span class=\"built_in\">set</span> patchsum=<span class=\"variable\">%PATCH_NOTINSTALLED%</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> patch_counter=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">FOR</span> /f \"eol=%<span class=\"number\">1</span> usebackq tokens=<span class=\"number\">2</span>,*\" <span class=\"variable\">%%i</span> <span class=\"keyword\">in</span> (<span class=\"variable\">%PATCHLIST%</span>) <span class=\"keyword\">DO</span> (</span><br><span class=\"line\"> <span class=\"built_in\">set</span> /a patch_counter+=<span class=\"number\">1</span></span><br><span class=\"line\"> <span class=\"built_in\">TITLE</span> <span class=\"variable\">!patch_counter!</span>/<span class=\"variable\">%patchsum%</span>-<span class=\"variable\">%%i</span> -- <span class=\"variable\">%TITLE%</span></span><br><span class=\"line\"> <span class=\"built_in\">set</span> nobackup=nobackup</span><br><span class=\"line\"> <span class=\"built_in\">echo</span> <span class=\"variable\">%%i</span> | <span class=\"built_in\">find</span> /i \"<span class=\"variable\">%PATCHFLAG%</span><span class=\"number\">8</span>\" <span class=\"number\">2</span>&gt;<span class=\"built_in\">nul</span> &gt;<span class=\"built_in\">nul</span> &amp;&amp; <span class=\"built_in\">set</span> nobackup=n</span><br><span class=\"line\"> <span class=\"variable\">%%j</span> /quiet /passive /norestart /<span class=\"variable\">!nobackup!</span> <span class=\"number\">2</span>&gt;<span class=\"built_in\">nul</span> &gt;<span class=\"built_in\">nul</span></span><br><span class=\"line\"> <span class=\"built_in\">ECHO</span> <span class=\"variable\">!patch_counter!</span>/<span class=\"variable\">%patchsum%</span> <span class=\"variable\">%%i</span> √)</span><br><span class=\"line\"><span class=\"keyword\">goto</span> :eof</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">REM 搜索当前目录下的补丁，返回非零值为失败。</span></span><br><span class=\"line\">:pfind</span><br><span class=\"line\"><span class=\"built_in\">SET</span> REG=HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall</span><br><span class=\"line\"><span class=\"built_in\">SET</span> listinreg=\"<span class=\"variable\">%temp%</span>\\listinreg.tmp\"</span><br><span class=\"line\">reg query <span class=\"variable\">%reg%</span>&gt;<span class=\"variable\">%listinreg%</span></span><br><span class=\"line\"><span class=\"built_in\">del</span> <span class=\"variable\">%PATCHLIST%</span> <span class=\"number\">2</span>&gt;<span class=\"built_in\">nul</span> &gt;<span class=\"built_in\">nul</span></span><br><span class=\"line\"><span class=\"comment\">REM 补丁是一个压缩包</span></span><br><span class=\"line\"><span class=\"keyword\">FOR</span> /r <span class=\"variable\">%%i</span> <span class=\"keyword\">in</span> (*<span class=\"variable\">%PATCHFLAG%</span>*.exe) <span class=\"keyword\">DO</span> <span class=\"keyword\">CALL</span> :pfind.sub \"<span class=\"variable\">%%~</span>ni\" \"<span class=\"variable\">%%~</span>fi\" \"<span class=\"variable\">%%~</span>sfi\"</span><br><span class=\"line\"><span class=\"comment\">REM 补丁在压缩包展开后的目录内</span></span><br><span class=\"line\"><span class=\"keyword\">FOR</span> /r <span class=\"variable\">%%i</span> <span class=\"keyword\">in</span> (<span class=\"variable\">%cat%</span>) <span class=\"keyword\">DO</span> <span class=\"keyword\">IF</span> <span class=\"keyword\">exist</span> <span class=\"variable\">%%~</span>dpiupdate.exe <span class=\"keyword\">FOR</span> /f <span class=\"variable\">%%j</span> <span class=\"keyword\">in</span> (\"<span class=\"variable\">%%~</span>dpiupdate.exe\") <span class=\"keyword\">DO</span> <span class=\"keyword\">CALL</span> :pfind.sub \"<span class=\"variable\">%%~</span>ni\" \"<span class=\"variable\">%%~</span>fj\" \"<span class=\"variable\">%%~</span>sfj\"</span><br><span class=\"line\"><span class=\"keyword\">IF</span> <span class=\"keyword\">not</span> <span class=\"keyword\">exist</span> <span class=\"variable\">%PATCHLIST%</span> <span class=\"keyword\">EXIT</span> /b <span class=\"number\">1</span></span><br><span class=\"line\">sort <span class=\"variable\">%PATCHLIST%</span> /o <span class=\"variable\">%PATCHLIST%</span></span><br><span class=\"line\"><span class=\"comment\">rem 得到补丁个数</span></span><br><span class=\"line\"><span class=\"keyword\">FOR</span> /f \"tokens=<span class=\"number\">3</span> delims= \" <span class=\"variable\">%%i</span> <span class=\"keyword\">in</span> ('<span class=\"built_in\">find</span> /c /i \"<span class=\"variable\">%FLAG_NOTINSTALLED%</span>\" <span class=\"variable\">%PATCHLIST%</span>') <span class=\"keyword\">DO</span> <span class=\"built_in\">SET</span> PATCH_NOTINSTALLED=<span class=\"variable\">%%i</span></span><br><span class=\"line\"><span class=\"keyword\">FOR</span> /f \"tokens=<span class=\"number\">3</span> delims= \" <span class=\"variable\">%%i</span> <span class=\"keyword\">in</span> ('<span class=\"built_in\">find</span> /c /i \"<span class=\"variable\">%FLAG_INSTALLED%</span>\" <span class=\"variable\">%PATCHLIST%</span>') <span class=\"keyword\">DO</span> <span class=\"built_in\">SET</span> /a PATCH_TOTAL=<span class=\"variable\">%%i</span> + <span class=\"variable\">%PATCH_NOTINSTALLED%</span></span><br><span class=\"line\"><span class=\"built_in\">del</span> <span class=\"variable\">%listinreg%</span> <span class=\"number\">2</span>&gt;<span class=\"built_in\">nul</span> &gt;<span class=\"built_in\">nul</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> <span class=\"keyword\">not</span> <span class=\"keyword\">defined</span> patch_total <span class=\"keyword\">EXIT</span> /b <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> <span class=\"variable\">%patch_total%</span> <span class=\"keyword\">LSS</span> <span class=\"number\">1</span> <span class=\"keyword\">EXIT</span> /b <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"keyword\">EXIT</span> /b <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">goto</span> :eof</span><br><span class=\"line\"><span class=\"comment\">REM 看看补丁安装了没，然后写到标准输出和%PATCHLIST%内</span></span><br><span class=\"line\">:pfind.sub</span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"%~<span class=\"number\">3</span>\" == \"\" <span class=\"keyword\">GOTO</span> :eof</span><br><span class=\"line\"><span class=\"keyword\">CALL</span> :getkbnum %<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> id=<span class=\"variable\">!errorlevel!</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> <span class=\"keyword\">not</span> \"<span class=\"variable\">!id!</span>\" == \"-<span class=\"number\">1</span>\" (</span><br><span class=\"line\"> <span class=\"built_in\">find</span> /i \"<span class=\"variable\">!id!</span>\" <span class=\"variable\">%listinreg%</span> <span class=\"number\">2</span>&gt;<span class=\"built_in\">nul</span> &gt;<span class=\"built_in\">nul</span> &amp;&amp; (</span><br><span class=\"line\"> <span class=\"built_in\">set</span> status=<span class=\"variable\">%FLAG_INSTALLED%</span>&amp; <span class=\"built_in\">set</span> isinstalled=<span class=\"variable\">%INSTALLED%</span></span><br><span class=\"line\"> )||(<span class=\"built_in\">set</span> status=<span class=\"variable\">%FLAG_NOTINSTALLED%</span>&amp; <span class=\"built_in\">set</span> isinstalled=<span class=\"variable\">%NOTINSTALLED%</span>)</span><br><span class=\"line\"> <span class=\"built_in\">ECHO</span> <span class=\"variable\">!status!</span> <span class=\"variable\">%PATCHFLAG%</span><span class=\"variable\">!id!</span> <span class=\"variable\">%2&gt;&gt;%</span>PATCHLIST%</span><br><span class=\"line\"> <span class=\"built_in\">ECHO</span> <span class=\"variable\">!isinstalled!</span> <span class=\"variable\">%PATCHFLAG%</span><span class=\"variable\">!id!</span> %<span class=\"number\">3</span></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">goto</span> :eof</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">REM 返回给定字串中的KB号，返回-1表示失败。</span></span><br><span class=\"line\">:getkbnum</span><br><span class=\"line\"><span class=\"built_in\">SETLOCAL</span> ENABLEDELAYEDEXPANSION</span><br><span class=\"line\"><span class=\"built_in\">SET</span> str=%~<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> <span class=\"keyword\">not</span> <span class=\"keyword\">defined</span> str <span class=\"keyword\">EXIT</span> /b -<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> <span class=\"keyword\">not</span> <span class=\"keyword\">defined</span> PATCHFLAG <span class=\"built_in\">SET</span> PATCHFLAG=KB</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">%PATCHFLAG%</span>&gt;getsize.tmp</span><br><span class=\"line\"><span class=\"keyword\">for</span> <span class=\"variable\">%%i</span> <span class=\"keyword\">in</span> (getsize.tmp) <span class=\"keyword\">do</span> <span class=\"built_in\">SET</span> /a offset=<span class=\"variable\">%%~</span>zi-<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"built_in\">del</span> getsize.tmp <span class=\"number\">2</span>&gt;<span class=\"built_in\">nul</span> &gt;<span class=\"built_in\">nul</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> <span class=\"built_in\">start</span>=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\">REM 仅有%PATCHFLAG%则返回-1</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> /i \"<span class=\"variable\">%str%</span>\" == \"<span class=\"variable\">%PATCHFLAG%</span>\" <span class=\"keyword\">EXIT</span> /b -<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"comment\">REM 删除%PATCHFLAG%前的字符，删除失败则返回-1</span></span><br><span class=\"line\">:getkbnum.findkb</span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"%~<span class=\"number\">1</span>\" == \"<span class=\"variable\">!str!</span>\" (<span class=\"keyword\">IF</span> \"<span class=\"variable\">!str:~%start%,%offset%!</span>\" == \"\" (<span class=\"keyword\">EXIT</span> /b -<span class=\"number\">1</span></span><br><span class=\"line\"> ) <span class=\"keyword\">ELSE</span> <span class=\"keyword\">IF</span> /i \"<span class=\"variable\">!str:~%start%,%offset%!</span>\" == \"<span class=\"variable\">%PATCHFLAG%</span>\" (<span class=\"built_in\">SET</span> str=<span class=\"variable\">!str:~%start%!</span></span><br><span class=\"line\"> ) <span class=\"keyword\">ELSE</span> (<span class=\"built_in\">SET</span> /a <span class=\"built_in\">start</span>+=<span class=\"number\">1</span> &amp; <span class=\"keyword\">goto</span> getkbnum.findkb))</span><br><span class=\"line\"><span class=\"comment\">REM 仅有%PATCHFLAG%则返回-1</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> str=<span class=\"variable\">!str:~%offset%!</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"<span class=\"variable\">%str%</span>\" == \"\" <span class=\"keyword\">EXIT</span> /b -<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> <span class=\"built_in\">start</span>=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\">REM 保证%PATCHFLAG%后的第一个字符不是数字时，仍能返回-1</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"<span class=\"variable\">!str:~%start%,1!</span>\" <span class=\"keyword\">GTR</span> \"<span class=\"number\">9</span>\" <span class=\"keyword\">EXIT</span> /b -<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"<span class=\"variable\">!str:~%start%,1!</span>\" <span class=\"keyword\">LSS</span> \"<span class=\"number\">0</span>\" <span class=\"keyword\">EXIT</span> /b -<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"comment\">REM 返回%PATCHFLAG%后的数字</span></span><br><span class=\"line\">:getkbnum.findnum</span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"<span class=\"variable\">!str:~%start%,1!</span>\" <span class=\"keyword\">GTR</span> \"<span class=\"number\">9</span>\" <span class=\"keyword\">EXIT</span> /b <span class=\"variable\">!str:~0,%start%!</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"<span class=\"variable\">!str:~%start%,1!</span>\" <span class=\"keyword\">LSS</span> \"<span class=\"number\">0</span>\" <span class=\"keyword\">EXIT</span> /b <span class=\"variable\">!str:~0,%start%!</span></span><br><span class=\"line\"><span class=\"built_in\">SET</span> /a <span class=\"built_in\">start</span>+=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">goto</span> getkbnum.findnum</span><br><span class=\"line\"><span class=\"built_in\">ENDLOCAL</span></span><br><span class=\"line\"><span class=\"keyword\">EXIT</span> /b -<span class=\"number\">1</span></span><br><span class=\"line\"> </span><br><span class=\"line\">:error</span><br><span class=\"line\"><span class=\"built_in\">TITLE</span> ERROR -- <span class=\"variable\">%TITLE%</span></span><br><span class=\"line\"><span class=\"keyword\">IF</span> \"%<span class=\"number\">1</span>\" == \"<span class=\"number\">1</span>\" (<span class=\"built_in\">ECHO</span> 没有找到补丁。使用的搜索规则是：CAT:<span class=\"variable\">%cat%</span>,PATCHFLAG:<span class=\"variable\">%PATCHFLAG%</span>。程序已结束。)</span><br><span class=\"line\"><span class=\"built_in\">SET</span> <span class=\"built_in\">TITLE</span>=</span><br><span class=\"line\"><span class=\"built_in\">PAUSE</span> &gt;<span class=\"built_in\">nul</span></span><br><span class=\"line\"><span class=\"built_in\">TITLE</span> <span class=\"variable\">%ComSpec%</span></span><br><span class=\"line\"><span class=\"keyword\">goto</span> :eof</span><br></pre></td></tr></table></figure><br>参考来源: <a href=\"https://blog.csdn.net/darkread/article/details/8064493\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/darkread/article/details/8064493</a></p>\n<p>实例说明：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@<span class=\"built_in\">echo</span> off</span><br><span class=\"line\">mkdir delete</span><br><span class=\"line\">mkdir other</span><br><span class=\"line\">mkdir photo_bak</span><br><span class=\"line\">mkdir photo_ksh</span><br><span class=\"line\">mkdir photo_ksh.rar</span><br><span class=\"line\">mkdir photo_ksh_backup</span><br><span class=\"line\">mkdir photo_ksh_log</span><br><span class=\"line\">mkdir photo_rar</span><br><span class=\"line\">mkdir photo_rar_log</span><br><span class=\"line\">mkdir photo_sfzh_f</span><br><span class=\"line\">mkdir photo_sfzh_z</span><br><span class=\"line\">mkdir temp</span><br><span class=\"line\">mkdir demo</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> /f <span class=\"string\">\"delims=\"</span> %%N <span class=\"keyword\">in</span> (<span class=\"string\">'dir /A:D /B'</span>) ^</span><br><span class=\"line\"><span class=\"keyword\">do</span> ( </span><br><span class=\"line\">xcopy createQuxian.cmd %%N /y</span><br><span class=\"line\">)</span><br><span class=\"line\">pause</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例.利用批处理文件进行更改系统网络IP与网关。</strong><br><figure class=\"highlight bat\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@<span class=\"built_in\">echo</span> off</span><br><span class=\"line\"><span class=\"built_in\">set</span> /p add=请输入IP地址最后一位(<span class=\"number\">1</span>~<span class=\"number\">254</span>):</span><br><span class=\"line\"><span class=\"built_in\">set</span> address=<span class=\"number\">10</span>.<span class=\"number\">10</span>.<span class=\"number\">102</span>.<span class=\"variable\">%add%</span></span><br><span class=\"line\">:: <span class=\"built_in\">rem</span> 以太网IP 与 网关设置</span><br><span class=\"line\">netsh interface ip <span class=\"built_in\">set</span> address name=\"以太网\" source=static addr=<span class=\"variable\">%address%</span> mask=<span class=\"number\">255</span>.<span class=\"number\">255</span>.<span class=\"number\">255</span>.<span class=\"number\">0</span> gateway=<span class=\"number\">10</span>.<span class=\"number\">10</span>.<span class=\"number\">102</span>.<span class=\"number\">1</span> gwmetric=<span class=\"number\">1</span></span><br><span class=\"line\">:: <span class=\"built_in\">rem</span> 网络DNS域名解析服务器地址设置</span><br><span class=\"line\">netsh interface ip <span class=\"built_in\">set</span> dnsservers name=\"以太网\" source=static address=<span class=\"number\">192</span>.<span class=\"number\">168</span>.<span class=\"number\">10</span>.<span class=\"number\">254</span> register=primary</span><br><span class=\"line\">:: 刷新DNS解析</span><br><span class=\"line\"><span class=\"built_in\">ipconfig</span> /flushdns</span><br><span class=\"line\"><span class=\"built_in\">ipconfig</span></span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Development","path":"api/categories/Development.json"},{"name":"Windows脚本","path":"api/categories/Windows脚本.json"}],"tags":[{"name":"Bat","path":"api/tags/Bat.json"}]}