<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 4.Jenkins进阶之分布式架构环境配置|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Jenkins">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
        
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>4.Jenkins进阶之分布式架构环境配置</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">4.Jenkins进阶之分布式架构环境配置</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-12-30T04:34:30.000Z" itemprop="datePublished" class="page-time">
  2020-12-30
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/CI-CD/">CI-CD</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-系统运维/自动化运维/CI-CD/Jenkins/4.Jenkins进阶之分布式架构环境配置"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">4.Jenkins进阶之分布式架构环境配置</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-12-30 12:34:30" datetime="2020-12-30T04:34:30.000Z"  itemprop="datePublished">2020-12-30</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/CI-CD/">CI-CD</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<hr>
<h2 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h2><p><strong>Q: 什么是Jenkins的分布式节点构建?</strong></p>
<blockquote>
<p>描述: 简单的说就是通过将构建过程分配到从属Slave节点上，从而减轻Master节点的压力，而且可以同时构建多个有点类似负载均衡的概念。<br>随着现在容器的盛行我们可以将server节点和agent节点在容器或者基于Kubernetes中部署, 可以实现动态的资源分配等等好处。</p>
</blockquote>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113140710.png" target="_blank" title="WeiyiGeek.Jenkins分布式节点" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113140710.png" alt="WeiyiGeek.Jenkins分布式节点" title="" class=""></a>
                <p>WeiyiGeek.Jenkins分布式节点</p>
            </figure>
<p><br></p>
<h3 id="1-节点说明"><a href="#1-节点说明" class="headerlink" title="1.节点说明"></a>1.节点说明</h3><p>描述: 我们在使用Jenkins的时候一般都会分为server节点与agent节点(也可以叫 slave 节点)。</p>
<ul>
<li>1) server ：主要用于处理调度构建作业，把构建分发到slave节点进行实际执行，监视slave节点的状态（必要时让它们进行上线或者离线），记录和发布构建产物。</li>
<li>2) agent ： 主要用于处理Job任务等例如编译和发布, agent节点可以分为静态节点和动态节点;</li>
</ul>
<p><strong>节点类型:</strong></p>
<ul>
<li>1) 静态节点是固定的一台vm虚机或者容器。</li>
<li>2) 动态节点是随着任务的构建来自动创建agent节点。</li>
</ul>
<p><br></p>
<h3 id="2-节点连接"><a href="#2-节点连接" class="headerlink" title="2.节点连接"></a>2.节点连接</h3><p><strong>agent节点加入的两种方式:</strong></p>
<ul>
<li>ssh : 在Linux系统中最方便的就是通过SSH启动Jenkins节点,关键是需要再Slave机器中开启sshd服务以及网络连通;</li>
<li>jnlp ：兼容各种操作系统只要网络可以正常通信都可以采用此种方法(需要安装Java环境);</li>
</ul>
<p><br/></p>
<h4 id="SSH-方式"><a href="#SSH-方式" class="headerlink" title="SSH 方式"></a>SSH 方式</h4><p>环境依赖: SSH Slaves plugin 插件 、SSH Credentials Plugin 插件（管理认证票据）<br>添加流程: </p>
<ul>
<li>1） 输入Slave节点IP</li>
<li>2） 添加Credentials认证票据(账号密码、或、密钥登陆)</li>
<li>3）在这里设置的credentials在jenkins的其他需要credentials的地方，可以通过下拉菜单选择使用，比如添加slave时可以直接在Credentials下拉菜单里选择对应的credential就行</li>
</ul>
<p><br/></p>
<p><strong>用户密码方式添加:</strong><br>添加流程:</p>
<ul>
<li>1) 新建节点-&gt;输入节点IP</li>
<li>2）基础信息配置</li>
<li>3) 选择Jenkins凭据</li>
<li>4）启动代理</li>
</ul>
<p><strong>私钥方式方式添加:</strong><br>添加流程:(相比于上面的流程唯一不同的是Jenkins凭据选择为<code>ssh private key</code>) </p>
<ul>
<li>记住是私钥不是公钥 <code>cat .ssh/id_rsa</code> 输入到Private Key之中</li>
</ul>
<p><br/></p>
<h4 id="JNLP-方式"><a href="#JNLP-方式" class="headerlink" title="JNLP 方式"></a>JNLP 方式</h4><p>描述: 与ssh方式是master主动连接slave不同而JNLP方式是slave主动连接master。</p>
<p>Tips : 复制节点在节点环境配置好之后，我们再添加节点就可以复制了修改IP和其他自定义配置即可。</p>
<p>Tips : 在需要Jenkins全局安全配置上开启 Inbound agents 端口 50000/tcp 代理端口, 此端口的作用是便于Agent的jnlp与jenkins的master节点间进行通信;</p>
<p><br></p>
<h3 id="3-点明主题"><a href="#3-点明主题" class="headerlink" title="3.点明主题"></a>3.点明主题</h3><p><strong>Q: 传统Jenkins的server、agent分布式方案有什么缺陷?</strong></p>
<ul>
<li>1.高可用管理: Master 节点发生单点故障时整个流程都不可用了;</li>
<li>2.配置管理维护: 每个 Slave节点的配置环境不一样，来完成不同语言的编译打包等操作，但是这些差异化的配置导致管理起来非常不方便，维护起来也是比较费劲</li>
<li>3.资源分配不均衡：有的 Slave节点要运行的job出现排队等待，而有的Slave节点处于空闲状态</li>
<li>4.资源浪费： 每台 Slave节点可能是实体机或者VM，当Slave节点处于空闲状态时，也不会完全释放掉资源</li>
</ul>
<p>Tips : 正因为上面的这些种种痛点我们渴望一种更高效更可靠的方式来完成这个 CI/CD 流程，而 Docker 虚拟化容器技术能很好的解决这个痛点，又特别是在 Kubernetes 集群环境下面能够更好来解决上面的问题，所以我们可以引入Kubernates来解决！</p>
<p>Tips : 基于Kubernete的CI/CD可以使用的工具有很多, 比如Jenkins、Gitlab CI已经新兴的drone之类的都是可以，大家可以根据需求进行学习搭建并落地;</p>
<p><br></p>
<p><strong>Q: 什么是 Kubernetes ? 它有何作用?</strong><br>答: Kubernetes （简称K8S）是Google开源的容器集群管理系统，在Docker技术的基础上，为容器化的应用提供部署运行、资源调度、服务发现和动态伸缩等一系列完整功能，提高了大规模容器集群管理的便捷性。<br>其主要功能如下：</p>
<ul>
<li>1.使用Docker对应用程序包装(package)、实例化(instantiate)、运行(run)。</li>
<li>2.以集群的方式运行、管理跨机器的容器。以集群的方式运行、管理跨机器的容器。</li>
<li>3.解决 Docker跨机器容器之间的通讯问题。解决Docker跨机器容器之间的通讯问题。</li>
<li>4.Kubernetes 的自我修复机制使得容器集群总是运行在用户期望的状态。</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113142559.png" target="_blank" title="WeiyiGeek.Kubernetes 搭建 Jenkins 集群示意图" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113142559.png" alt="WeiyiGeek.Kubernetes 搭建 Jenkins 集群示意图" title="" class=""></a>
                <p>WeiyiGeek.Kubernetes 搭建 Jenkins 集群示意图</p>
            </figure>
<p>PS : 从图上可以看到 <code>Jenkins Master 和 Jenkins Slave</code> 以 Pod 形式运行在 Kubernetes 集群的 Node 上，Master 运行在其中一个节点，并且将其配置数据存储到一个 Volume 上去，Slave 运行在各个节点上，并且它不是一直处于运行状态，它会按照需求动态的创建并自动删除。<br>PS : 这种方式的工作流程大致为当 Jenkins Master 接受到 Build 请求时，会根据配置的 Label 动态创建一个运行在 Pod 中的 Jenkins Slave 并注册到 Master 上，当运行完 Job 后，这个 Slave 会被注销并且这个 Pod 也会自动删除，恢复到最初状态</p>
<p><br></p>
<p><strong>Q: Kubernets方式部署给我们带来什么好处?</strong></p>
<ul>
<li>1.服务高可用，当 Jenkins Master 出现故障时，Kubernetes 会自动创建一个新的 Jenkins Master 容器，并且将 Volume 分配给新创建的容器，保证数据不丢失，从而达到集群服务高可用。</li>
<li>2.动态伸缩，合理使用资源，每次运行 Job 时，会自动创建一个 Jenkins Slave，Job 完成后，Slave 自动注销并删除容器，资源自动释放，而且 Kubernetes 会根据每个资源的使用情况，动态分配 Slave 到空闲的节点上创建，降低出现因某节点资源利用率高，还排队等待在该节点的情况。</li>
<li>3.扩展性好，当 Kubernetes 集群的资源严重不足而导致 Job 排队等待时，可以很容易的添加一个 Kubernetes Node 到集群中，从而实现扩展。</li>
</ul>
<p><strong>常用 Kubernates + Harbor + Jenkins + gitlab 持续集成方案：</strong><br>Tips : 大致工作流程 <code>手动 /自动构建 -&gt; Jenkins 调度 K8S API -&gt; 动态生成 Jenkins Slave pod -&gt; Slave pod
拉取 Git 代码／编译／打包镜像 -&gt;推送到镜像仓库 Harbor -&gt; Slave 工作完成，Pod 自动销毁 -&gt; 部署
到测试或生产 Kubernetes平台</code>。（完全自动化，无需人工干预）</p>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://img2020.cnblogs.com/blog/1829785/202006/1829785-20200603233012120-1568519709.png" target="_blank" title="weiyigeek.CI/CD集成" data-fancybox="images"><img src="https://img2020.cnblogs.com/blog/1829785/202006/1829785-20200603233012120-1568519709.png" alt="weiyigeek.CI/CD集成" title="" class=""></a>
                <p>weiyigeek.CI/CD集成</p>
            </figure>
<p><br></p>
<h3 id="4-知识扩展"><a href="#4-知识扩展" class="headerlink" title="4.知识扩展"></a>4.知识扩展</h3><p><strong>(1) 官方的Jenkins镜像网站</strong><br>Hub Docker Images : <a href="https://hub.docker.com/r/jenkins/jenkins/" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/jenkins/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins</span><br></pre></td></tr></table></figure></p>
<p><strong>(2) Kubernetes 插件官方帮助</strong><br>kubernetes Plugs : <a href="https://plugins.jenkins.io/kubernetes/" target="_blank" rel="noopener">https://plugins.jenkins.io/kubernetes/</a></p>
<hr>
<h2 id="0x01-安装部署"><a href="#0x01-安装部署" class="headerlink" title="0x01 安装部署"></a>0x01 安装部署</h2><h3 id="0-分布式架构过程说明"><a href="#0-分布式架构过程说明" class="headerlink" title="(0) 分布式架构过程说明"></a>(0) 分布式架构过程说明</h3><p>将 Jenkins 的 <code>Master/Agent</code> 分布式架构直接部署在宿主机上不是一个很好的选择；但是它作为一个向容器化过度的中间阶段，是必要学习掌握的。</p>
<p>Tips : 整个 Jenkins 服务分布式部署是很简单的其步骤为：</p>
<ul>
<li>部署一个 Jenkins Master 节点。</li>
<li>通过 Jenkins 的 WEB 页面，在 Master 节点上添加 Agent node 节点。</li>
<li>添加完 Agent Node 节点后，Jenkins Master 会提供部署 Agent Node 服务的软件包和启动方式；直接找台服务器，根据提示运行就行。</li>
</ul>
<h4 id="在-Master-节点中添加-Agent-方式"><a href="#在-Master-节点中添加-Agent-方式" class="headerlink" title="在 Master 节点中添加 Agent 方式"></a>在 Master 节点中添加 Agent 方式</h4><ul>
<li><p>Step 1.新建节点页面的访问路径<br>描述: 在 Jenkins 服务的页面上找到”新建节点“的页面；它的访问路径如下： <code>Manage Jenkins -》Manage Nodes and Clouds（管理节点）-》New Node（新建节点）</code></p>
</li>
<li><p>Step 2.节点名称和节点类型<br>描述：通过上面的访问路径，进入添加节点的第一个页面。在这里需要填写一下【节点名称】和选择节点类型，一般选择永久节点 [Permanent Agent] 即可</p>
</li>
<li><p>Step 3.在节点的详细设置页面中填写更多信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 配置项 	配置项说明/配置信息</span><br><span class="line">* Name/名称 	Jenkins Agent 的名称</span><br><span class="line">* of executors / 并发执行数 	Agent 节点可以同时执行几个 Job</span><br><span class="line">* Remote root directory / 远程工作目录 	从节点上jenkins agent的工作目录，推荐只用绝对路径，如/home//jenkins-agent。注意jenkins要有该目录的读写权限</span><br><span class="line">* Labels / 标签 	给Agent节点设置标签；Job 任务可以根据标签选择特定的 Agent 节点执行。</span><br><span class="line">* Usage / Agent 节点的使用方法 	有两种方式：1、尽量使用此Agent执行任务；2、只执行标签匹配的任务。</span><br><span class="line">* Lanuch method / Agent 启动方法 	有多种选择，这里使用”Launch agent by connecting it to the master“/通过将 Agent 连接到 Master 来启动它</span><br><span class="line">* 其他的配置项可以选择默认状态，也可以更加自己的理解设置。</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 4.获取部署 Agent 的方法<br>描述: 上面的步骤操作完成后，就会有个展示配置 Agent 节点的页面。其中提供了两中部署 Agent 的方式，我们选择第二种。</p>
</li>
<li><p>Step 5.在 Agent 服务器的命令行执行启动命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1.将密码通过命令行直接传入(不安全)</span></span><br><span class="line">java -jar agent.jar -jnlpUrl http://jenkins.example.com/computer/agent-test/slave-agent.jnlp -secret d4abba3f13324b85ab2997e22c3442045bb86fcd213f79fa01416a5fd0399a18 -workDir <span class="string">""</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2.将密码信息写入到文件中 Agent 启动方式</span></span><br><span class="line"><span class="built_in">echo</span> d4abba3f13324b85ab2997e22c3442045bb86fcd213f79fa01416a5fd0399a18 &gt; secret-file</span><br><span class="line">java -jar agent.jar -jnlpUrl http://jenkins.example.com/computer/agent-test/slave-agent.jnlp -secret @secret-file -workDir <span class="string">""</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h3 id="1-单主机部署配置固定-agent"><a href="#1-单主机部署配置固定-agent" class="headerlink" title="(1) 单主机部署配置固定 agent"></a>(1) 单主机部署配置固定 agent</h3><p>描述: 添加一个普通、固定(永久)的节点到Jenkins即给 Jenkins 增加了一个普通的永久代理人；之所以叫做“固定”是因为Jenkins没给这种节点提供更高级的集成方式;</p>
<ul>
<li>例如：动态配置。没有其他代理类型能选择的话可以选择该代理类型；</li>
<li>例如，你在添加不受Jenkins管理的物理机、在Jenkins外部管理的虚拟机等。</li>
</ul>
<p><br/></p>
<p><strong>环境准备:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04.1 LTS</span><br><span class="line">Release:        20.04</span><br><span class="line">Codename:       focal</span><br><span class="line"></span><br><span class="line">kubernetes 安装的 Jenkins 2.275 : `http://jenkins.weiyigeek.top:8080/`</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h4 id="Java-Web-启动-Agent-方式"><a href="#Java-Web-启动-Agent-方式" class="headerlink" title="Java Web 启动 Agent 方式"></a>Java Web 启动 Agent 方式</h4><p><strong>Q: 如何实现Jenkins分布式构建?</strong></p>
<ul>
<li><p>Step 1.开启代理程序的TCP端口：Manage Jenkins -&gt; Configure Global Security(全局安全配置) -&gt; 代理 -&gt; 设置为固定的50000端口</p>
</li>
<li><p>Step 2.在 Manage Jenkins -&gt; Manage Nodes 节点列表 -&gt; 新增节点 -&gt; 节点名称（agent-机器名称）-&gt; 添加一个普通、固定的节点到Jenkins;</p>
</li>
<li><p>Step 3.此时有两种 Slave 节点连接Master节点的方法 -&gt; (<code>Launch agent by connecting it to the master</code> 或者 <code>通过Java Web启动代理</code>) ;<br>描述: 使用<code>Java Web Start</code>就必须在Agent机器上打开JNLP文件，然后将创建到Jenkins服务器的TCP连接，意味着<code>不需要Jenkins服务器访问Agent 而是Agent能够链接到Jenkins Server即可</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在命令行中启动节点</span></span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 -workDir <span class="string">"/home/jenkins"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run from agent command line, with the secret stored in a file:</span></span><br><span class="line"><span class="built_in">echo</span> 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 &gt; secret-file</span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret @secret-file -workDir <span class="string">"/home/jenkins"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203194425.png" target="_blank" title="WeiyiGeek.Create-Node" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203194425.png" alt="WeiyiGeek.Create-Node" title="" class=""></a>
                <p>WeiyiGeek.Create-Node</p>
            </figure>
<ul>
<li><p>Step 4.采用<code>VM方式</code>运行agent.jar连接到Jenkins的Server节点, 首先我们知道上面的agent.jar和secret信息等;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 我们在一台Linux服务器中下载agent.jar和启动连接。</span></span><br><span class="line">wget http://192.168.12.107:30001/jnlpJars/agent.jar</span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 -workDir <span class="string">"/home/jenkins"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 运行后输入以下日志</span></span><br><span class="line">  <span class="comment"># INFO: Agent discovery successful</span></span><br><span class="line">  <span class="comment"># Agent address: 192.168.1.200</span></span><br><span class="line">  <span class="comment"># Agent port:    30081</span></span><br><span class="line">  <span class="comment"># Identity:      0b:a1:da:6c:8e:e2:ca:f8:17:f6:b7:ee:cb:ff:84:0d</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Handshaking</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connecting to 192.168.1.200:30081</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Trying protocol: JNLP4-connect</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Remote identity confirmed: 0b:a1:da:6c:8e:e2:ca:f8:17:f6:b7:ee:cb:ff:84:0d</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:30 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connected   # 表示 成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 使用nohup后台运行agent</span></span><br><span class="line">nohup java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 -workDir <span class="string">"/home/jenkins"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.采用<code>Docker方式</code>运行agent.jar连接到Jenkins的Server节点, 此种方式非常简单拉取镜像和启动镜像；<br>参考连接: <a href="https://hub.docker.com/r/jenkins/inbound-agent" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/inbound-agent</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 拉取镜像</span></span><br><span class="line">docker pull jenkins/inbound-agent:alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 获取 Jenkins 的 SVC 地址(由于我的Master是采用K8s搭建的)</span></span><br><span class="line">~$ kubectl get svc -n devops</span><br><span class="line">  <span class="comment"># NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span></span><br><span class="line">  <span class="comment"># jenkins          NodePort    10.99.55.239     &lt;none&gt;        8080:30001/TCP,50000:32001/TCP   19d</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 启动 agent 镜像(注意参数)</span></span><br><span class="line"><span class="comment"># docker run --init jenkins/inbound-agent -url http://jenkins-server:port -workDir=/home/jenkins/agent &lt;secret&gt; &lt;agent name&gt;</span></span><br><span class="line">~$ docker run -d --name jenkins-agent --init jenkins/inbound-agent:alpine -url http://10.99.55.239:8080 -workDir=/home/jenkins/agent 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 node-1</span><br><span class="line">c7a00c89f92f16c07d35e572d2ba9da3c17c47a2746e46e3d3225bff418a78f3</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 查看是否启动成功</span></span><br><span class="line">~$ docker logs c7a00c89f92f16c07d35e572d2ba9da3c17c47a2746e46e3d3225bff418a78f3</span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:39 AM hudson.remoting.jnlp.Main createEngine</span></span><br><span class="line">  <span class="comment"># INFO: Setting up agent: node-1</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:39 AM hudson.remoting.jnlp.Main$CuiListener &lt;init&gt;</span></span><br><span class="line">  <span class="comment"># INFO: Jenkins agent is running in headless mode.</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.Engine startEngine</span></span><br><span class="line">  <span class="comment"># INFO: Using Remoting version: 4.6</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM org.jenkinsci.remoting.engine.WorkDirManager initializeWorkDir</span></span><br><span class="line">  <span class="comment"># INFO: Using /home/jenkins/agent/remoting as a remoting work directory</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM org.jenkinsci.remoting.engine.WorkDirManager setupLogging</span></span><br><span class="line">  <span class="comment"># INFO: Both error and output logs will be printed to /home/jenkins/agent/remoting</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Locating server among [http://10.99.55.239:8080]</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver resolve</span></span><br><span class="line">  <span class="comment"># INFO: Remoting server accepts the following protocols: [JNLP4-connect, Ping]</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Agent discovery successful</span></span><br><span class="line">  <span class="comment">#   Agent address: 10.99.55.239</span></span><br><span class="line">  <span class="comment">#   Agent port:    50000</span></span><br><span class="line">  <span class="comment">#   Identity:      8e:c7:1e:e1:39:ee:f4:2a:43:f6:aa:d9:0e:b7:b6:62</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Handshaking</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connecting to 10.99.55.239:50000</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Trying protocol: JNLP4-connect</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:58:00 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Remote identity confirmed: 8e:c7:1e:e1:39:ee:f4:2a:43:f6:aa:d9:0e:b7:b6:62</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:58:02 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connected   # 表示连接成功</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203200129.png" target="_blank" title="WeiyiGeek.jenkins-agent-docker" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203200129.png" alt="WeiyiGeek.jenkins-agent-docker" title="" class=""></a>
                <p>WeiyiGeek.jenkins-agent-docker</p>
            </figure>
<ul>
<li>Step 6.采用kubernetes集群以静态的方式部署agent，我们首先编写一个部署文件，并且定义好名称空间、镜像、agent配置信息。同样此处我们创建一个node-2的agent节点;</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (0) 在命令行中启动节点参数实例 (注意K8s下面的环境变量)</span></span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-2/jenkins-agent.jnlp -secret a06d5adaef69cbaf34e9296d8340d464163ab9f5bbf6b465a290237dc38d45db -workDir <span class="string">"/home/jenkins/agent"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) Jenkins-agent-Deployment 资源清单</span></span><br><span class="line">cat &gt; Jenkins-agent-Deployment.yaml &lt;&lt;<span class="string">'END'</span></span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins-agent</span><br><span class="line">  name: jenkins-agent-node2</span><br><span class="line">  namespace: devops</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: jenkins-agent-node</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: jenkins-agent-node</span><br><span class="line">      namespace: devops</span><br><span class="line">      name: jenkins-agent-node2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: jenkins-agent</span><br><span class="line">          image: jenkins/inbound-agent:alpine</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 1000m</span><br><span class="line">              memory: 2Gi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 500m</span><br><span class="line">              memory: 512Mi</span><br><span class="line">          env:</span><br><span class="line">            - name: JENKINS_URL</span><br><span class="line">              value: http://10.99.55.239:8080</span><br><span class="line">            - name: JENKINS_SECRET</span><br><span class="line">              value: a06d5adaef69cbaf34e9296d8340d464163ab9f5bbf6b465a290237dc38d45db</span><br><span class="line">            - name: JENKINS_AGENT_NAME</span><br><span class="line">              value: node-2</span><br><span class="line">            - name: JENKINS_AGENT_WORKDIR</span><br><span class="line">              value: /home/jenkins/workspace</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="comment"># JENKINS_URL: url for the Jenkins server, can be used as a replacement to -url option, or to set alternate jenkins URL</span></span><br><span class="line"><span class="comment"># JENKINS_TUNNEL: (HOST:PORT) connect to this agent host and port instead of Jenkins server, assuming this one do route TCP traffic to Jenkins master</span></span><br><span class="line"><span class="comment"># JENKINS_SECRET: agent secret, if not set as an argument</span></span><br><span class="line"><span class="comment"># JENKINS_AGENT_NAME: agent name, if not set as an argument</span></span><br><span class="line"><span class="comment"># JENKINS_AGENT_WORKDIR: agent work directory, if not set by optional parameter -workDir</span></span><br><span class="line"><span class="comment"># JENKINS_WEB_SOCKET: true if the connection should be made via WebSocket rather than TCP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2)通过kubectl工具在k8s集群中部署`jenkins agent deployment`并查验状态</span></span><br><span class="line">kubectl create -f Jenkins-agent-Deployment.yaml</span><br><span class="line">  <span class="comment"># deployment.apps/jenkins-agent-node2 created</span></span><br><span class="line"></span><br><span class="line">~/k8s/jenkins$ kubectl get pod -n devops -o wide | grep <span class="string">"jenkins-agent"</span></span><br><span class="line">  <span class="comment"># jenkins-agent-node2-574bb65cb8-5kh7g   1/1     Running   0          29s     172.16.182.237 </span></span><br><span class="line"></span><br><span class="line">~/k8s/jenkins$ kubectl logs -f jenkins-agent-node2-574bb65cb8-5kh7g -n devops</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 在传入JENKINS_URL时建议尽量采用域名的方式;</span></span><br><span class="line">~/k8s/jenkins$ kubectl <span class="built_in">exec</span> -it jenkins-agent-node2-574bb65cb8-5kh7g -n devops bash</span><br><span class="line">  <span class="comment"># bash-5.0$ ping jenkins.devops</span></span><br><span class="line">  <span class="comment"># PING jenkins.devops (10.99.55.239): 56 data bytes</span></span><br><span class="line">  <span class="comment"># bash-5.0$ ping jenkins.devops.svc.cluster.local</span></span><br><span class="line">  <span class="comment"># PING jenkins.devops.svc.cluster.local (10.99.55.239): 56 data bytes</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203202042.png" target="_blank" title="WeiyiGeek.kubernetes-jenkins-agent" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203202042.png" alt="WeiyiGeek.kubernetes-jenkins-agent" title="" class=""></a>
                <p>WeiyiGeek.kubernetes-jenkins-agent</p>
            </figure>
<p><br></p>
<h4 id="Launch-agents-via-SSH-启动-Agent-方式"><a href="#Launch-agents-via-SSH-启动-Agent-方式" class="headerlink" title="Launch agents via SSH 启动 Agent 方式"></a>Launch agents via SSH 启动 Agent 方式</h4><p>描述: 当前Jenkins 2.277版本默认是不支持SSH 启动 Agent 方式, 我们需要安装ssh Agent插件;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSH Agent - This plugin allows you to provide SSH credentials to builds via a ssh-agent <span class="keyword">in</span> Jenkins</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li><p>Step 1.首先创建一个凭据存储服务器认证信息。</p>
</li>
<li><p>Step 2.之后创建一个新的节点添加以下配置。配置ssh的主机和认证信息最后保存(agent配置完成)。</p>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204090727.png" target="_blank" title="WeiyiGeek.ssh-agent" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204090727.png" alt="WeiyiGeek.ssh-agent" title="" class=""></a>
                <p>WeiyiGeek.ssh-agent</p>
            </figure>
<ul>
<li>Step 3.保存后创建一个测试的Pipeline项目<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  <span class="comment">// 此处agent指令是必须的</span></span><br><span class="line">  agent none</span><br><span class="line">  stages &#123;</span><br><span class="line">    <span class="comment">// docker 构建的</span></span><br><span class="line">    stage (<span class="string">'node-1'</span>)&#123;</span><br><span class="line">      agent &#123;</span><br><span class="line">        node &#123; label <span class="string">"docker-jenkins-slave"</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"----- node-1 ------"</span></span><br><span class="line">        sh <span class="string">"hostname &amp;&amp; ifconfig"</span></span><br><span class="line">        sh <span class="string">"env"</span></span><br><span class="line">        echo <span class="string">"----- node-1 end------"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// k8s 集群中构建的</span></span><br><span class="line">     stage (<span class="string">'node-2'</span>)&#123;</span><br><span class="line">      agent &#123;</span><br><span class="line">        node &#123; label <span class="string">"k8s-node-2"</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"----- node-2 ------"</span></span><br><span class="line">        sh <span class="string">"hostname &amp;&amp; ifconfig"</span></span><br><span class="line">        sh <span class="string">"env"</span></span><br><span class="line">        echo <span class="string">"----- node-2 end------"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输出结果:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">Started by user Jenkins 管理员</span><br><span class="line">Running <span class="keyword">in</span> Durability level: MAX_SURVIVABILITY</span><br><span class="line">[Pipeline] Start of Pipeline</span><br><span class="line">[Pipeline] stage</span><br><span class="line"></span><br><span class="line">[Pipeline] &#123; (node-1)</span><br><span class="line">Running on node-1 <span class="keyword">in</span> /home/jenkins/workspace/pineline-use-node</span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-1 ------</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ hostname</span><br><span class="line">c7a00c89f92f</span><br><span class="line">+ ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  </span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:10783 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:14915 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:38664627 (36.8 MiB)  TX bytes:5669411 (5.4 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[Pipeline] sh</span><br><span class="line">  <span class="comment"># + env</span></span><br><span class="line">  <span class="comment"># JENKINS_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># LANGUAGE=en_US:en</span></span><br><span class="line">  <span class="comment"># RUN_CHANGES_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=changes</span></span><br><span class="line">  <span class="comment"># HOSTNAME=c7a00c89f92f</span></span><br><span class="line">  <span class="comment"># NODE_LABELS=docker-jenkins-slave node-1</span></span><br><span class="line">  <span class="comment"># HUDSON_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># SHLVL=3</span></span><br><span class="line">  <span class="comment"># HOME=/home/jenkins</span></span><br><span class="line">  <span class="comment"># BUILD_URL=http://192.168.12.107:30001/job/pineline-use-node/3/</span></span><br><span class="line">  <span class="comment"># HUDSON_COOKIE=de8bbafb-13fd-42d5-99a4-7ffaebf9a3e2</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVER_COOKIE=durable-8dd62800688ecbc8d9c9e78a15c49a2d</span></span><br><span class="line">  <span class="comment"># WORKSPACE=/home/jenkins/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># JAVA_VERSION=jdk8u272-b10</span></span><br><span class="line">  <span class="comment"># NODE_NAME=node-1</span></span><br><span class="line">  <span class="comment"># RUN_ARTIFACTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=artifacts</span></span><br><span class="line">  <span class="comment"># STAGE_NAME=node-1</span></span><br><span class="line">  <span class="comment"># EXECUTOR_NUMBER=0</span></span><br><span class="line">  <span class="comment"># RUN_TESTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=tests</span></span><br><span class="line">  <span class="comment"># BUILD_DISPLAY_NAME=#3</span></span><br><span class="line">  <span class="comment"># HUDSON_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># AGENT_WORKDIR=/home/jenkins/agent</span></span><br><span class="line">  <span class="comment"># JOB_BASE_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line">  <span class="comment"># BUILD_ID=3</span></span><br><span class="line">  <span class="comment"># BUILD_TAG=jenkins-pineline-use-node-3</span></span><br><span class="line">  <span class="comment"># LANG=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># JENKINS_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># JOB_URL=http://192.168.12.107:30001/job/pineline-use-node/</span></span><br><span class="line">  <span class="comment"># BUILD_NUMBER=3</span></span><br><span class="line">  <span class="comment"># JENKINS_NODE_COOKIE=a822e652-5870-44ef-b671-d6c1f2afaffb</span></span><br><span class="line">  <span class="comment"># RUN_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect</span></span><br><span class="line">  <span class="comment"># HUDSON_SERVER_COOKIE=04b411a999365c6a</span></span><br><span class="line">  <span class="comment"># JOB_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/display/redirect</span></span><br><span class="line">  <span class="comment"># JOB_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># LC_ALL=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># JAVA_HOME=/opt/java/openjdk</span></span><br><span class="line">  <span class="comment"># PWD=/home/jenkins/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># WORKSPACE_TMP=/home/jenkins/workspace/pineline-use-node@tmp</span></span><br><span class="line">  <span class="comment"># GITLAB_OBJECT_KIND=none</span></span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-1 end------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Pipeline] stage</span><br><span class="line">[Pipeline] &#123; (node-2)</span><br><span class="line">Running on node-2 <span class="keyword">in</span> /home/jenkins/agent/workspace/pineline-use-node</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-2 ------</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ hostname</span><br><span class="line">jenkins-agent-node2-574bb65cb8-5kh7g</span><br><span class="line">+ ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 5E:A7:08:EA:68:0F  </span><br><span class="line">          inet addr:172.16.182.237  Bcast:172.16.182.237  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1480  Metric:1</span><br><span class="line">          RX packets:8149 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:11311 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:30953238 (29.5 MiB)  TX bytes:4382625 (4.1 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[Pipeline] sh</span><br><span class="line">  <span class="comment"># + env</span></span><br><span class="line">  <span class="comment"># JENKINS_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># JENKINS_SECRET=a06d5adaef69cbaf34e9296d8340d464163ab9f5bbf6b465a290237dc38d45db</span></span><br><span class="line">  <span class="comment"># agentType=k8s</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT=tcp://10.96.0.1:443</span></span><br><span class="line">  <span class="comment"># KUBERNETES_SERVICE_PORT=443</span></span><br><span class="line">  <span class="comment"># LANGUAGE=en_US:en</span></span><br><span class="line">  <span class="comment"># RUN_CHANGES_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=changes</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP_ADDR=10.100.233.217</span></span><br><span class="line">  <span class="comment"># HOSTNAME=jenkins-agent-node2-574bb65cb8-5kh7g</span></span><br><span class="line">  <span class="comment"># SHLVL=3</span></span><br><span class="line">  <span class="comment"># NODE_LABELS=k8s-node-2 node-2</span></span><br><span class="line">  <span class="comment"># HUDSON_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># HOME=/home/jenkins</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP_PORT=9000</span></span><br><span class="line">  <span class="comment"># BUILD_URL=http://192.168.12.107:30001/job/pineline-use-node/3/</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># HUDSON_COOKIE=c088e600-327b-4e78-a80e-4ba7bd7254f3</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVER_COOKIE=durable-4d6313311ef99675e2bfd51284774a87</span></span><br><span class="line">  <span class="comment"># JENKINS_AGENT_WORKDIR=/home/jenkins/workspace</span></span><br><span class="line">  <span class="comment"># SONARQUBE_SERVICE_HOST=10.100.233.217</span></span><br><span class="line">  <span class="comment"># WORKSPACE=/home/jenkins/agent/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># JAVA_VERSION=jdk8u272-b10</span></span><br><span class="line">  <span class="comment"># NODE_NAME=node-2</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP=tcp://10.100.233.217:9000</span></span><br><span class="line">  <span class="comment"># RUN_ARTIFACTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=artifacts</span></span><br><span class="line">  <span class="comment"># STAGE_NAME=node-2</span></span><br><span class="line">  <span class="comment"># EXECUTOR_NUMBER=1</span></span><br><span class="line">  <span class="comment"># SONARQUBE_SERVICE_PORT=9000</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT=tcp://10.100.233.217:9000</span></span><br><span class="line">  <span class="comment"># RUN_TESTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=tests</span></span><br><span class="line">  <span class="comment"># BUILD_DISPLAY_NAME=#3</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP_ADDR=10.99.55.239</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1</span></span><br><span class="line">  <span class="comment"># HUDSON_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># AGENT_WORKDIR=/home/jenkins/agent</span></span><br><span class="line">  <span class="comment"># JOB_BASE_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_HOST=10.99.55.239</span></span><br><span class="line">  <span class="comment"># SONARQUBE_SERVICE_PORT_SONARQUBE=9000</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP_ADDR=10.99.55.239</span></span><br><span class="line">  <span class="comment"># BUILD_ID=3</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP_PORT=50000</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP_PORT=443</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_PORT_AGENT=50000</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># BUILD_TAG=jenkins-pineline-use-node-3</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># JENKINS_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP_PORT=8080</span></span><br><span class="line">  <span class="comment"># LANG=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># JOB_URL=http://192.168.12.107:30001/job/pineline-use-node/</span></span><br><span class="line">  <span class="comment"># JENKINS_AGENT_NAME=node-2</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># BUILD_NUMBER=3</span></span><br><span class="line">  <span class="comment"># JENKINS_NODE_COOKIE=243aa3e8-0de2-4297-b617-8764795f5cab</span></span><br><span class="line">  <span class="comment"># RUN_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT=tcp://10.99.55.239:8080</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_PORT=8080</span></span><br><span class="line">  <span class="comment"># HUDSON_SERVER_COOKIE=04b411a999365c6a</span></span><br><span class="line">  <span class="comment"># JOB_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/display/redirect</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP=tcp://10.99.55.239:50000</span></span><br><span class="line">  <span class="comment"># KUBERNETES_SERVICE_PORT_HTTPS=443</span></span><br><span class="line">  <span class="comment"># JOB_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># LC_ALL=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># PWD=/home/jenkins/agent/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP=tcp://10.99.55.239:8080</span></span><br><span class="line">  <span class="comment"># JAVA_HOME=/opt/java/openjdk</span></span><br><span class="line">  <span class="comment"># KUBERNETES_SERVICE_HOST=10.96.0.1</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_PORT_WEB=8080</span></span><br><span class="line">  <span class="comment"># WORKSPACE_TMP=/home/jenkins/agent/workspace/pineline-use-node@tmp</span></span><br><span class="line">  <span class="comment"># GITLAB_OBJECT_KIND=none</span></span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-2 end------</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204105425.png" target="_blank" title="WeiyiGeek.Pipeline流水线选择" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204105425.png" alt="WeiyiGeek.Pipeline流水线选择" title="" class=""></a>
                <p>WeiyiGeek.Pipeline流水线选择</p>
            </figure>
<hr>
<h3 id="2-集群搭建Jenkins-Master-节点"><a href="#2-集群搭建Jenkins-Master-节点" class="headerlink" title="(2) 集群搭建Jenkins Master 节点"></a>(2) 集群搭建Jenkins Master 节点</h3><p><strong>环境准备:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- Kubernetes 集群 ：<span class="string">"v1.19.6"</span></span><br><span class="line">- NFS : 数据持久化最常用的共享存储</span><br><span class="line">- Jenkins 镜像 : jenkins/jenkins:2.277-alpine</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="2-1-基础环境"><a href="#2-1-基础环境" class="headerlink" title="2.1) 基础环境"></a>2.1) 基础环境</h4><h5 id="NFS-Network-File-System-环境"><a href="#NFS-Network-File-System-环境" class="headerlink" title="NFS (Network File System) 环境"></a>NFS (Network File System) 环境</h5><p>描述：它最大的功能就是可以通过网络，让不同的机器、不同的操作系统可以共享彼此的文件。我们可以利用NFS共享Jenkins运行的配置文件、Maven的仓库依赖文件等。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NFS 客户端安装: Master&amp;node节点都执行</span></span><br><span class="line">~$ ansible dtk8s -m shell -a <span class="string">"sudo apt-get install nfs-common rpcbind -y"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Windows 2008 R2搭建的NFS服务端</span></span><br><span class="line">showmount -e 192.168.1.31</span><br><span class="line">Export list <span class="keyword">for</span> 192.168.1.31:</span><br><span class="line">/nask8sapp  (everyone)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全配置 (设置指定的作用域)</span></span><br><span class="line">基于 Unix 软件的 Portmap 的入站规则，允许 Portmap 服务的流量。[TCP 111] - 设置其作用域</span><br><span class="line">NFS 服务器(NFS-UDP-In) NFS 服务器允许 NFS 通信的入站规则。[UDP 2049] - 设置其作用域</span><br><span class="line">NFS 服务器(NFS-TCP-In) NFS 服务器允许 NFS 通信的入站规则。[TCP 2049] - 设置其作用域</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时与永久挂载</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">"sudo mkdir /nfsdisk-31"</span>  <span class="comment"># 目录创建</span></span><br><span class="line">sudo mount.nfs 192.168.12.31:/nask8sapp /nfsdisk-31/</span><br><span class="line">ls /nfsdisk-31/</span><br><span class="line"><span class="comment"># /nfsdisk-31/1.txt </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 /etc/fstab 挂载</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">'echo "192.168.12.31:/nask8sapp /nfsdisk-31 nfs defaults 0 0"|sudo tee -a /etc/fstab'</span></span><br><span class="line"><span class="comment"># weiyigeek-* | CHANGED | rc=0 &gt;&gt;</span></span><br><span class="line"><span class="comment"># 192.168.12.31:/nask8sapp /nfsdisk-31 nfs defaults 0 0</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">'sudo mount -a'</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">'mount | grep "nfs"'</span></span><br><span class="line"><span class="comment"># weiyigeek-* | CHANGED | rc=0 &gt;&gt;</span></span><br><span class="line"><span class="comment"># 192.168.12.31:/nask8sapp on /nfsdisk-31 type nfs (rw,relatime,vers=3,rsize=32768,wsize=32768,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=192.168.12.31,mountvers=3,mountport=1048,mountproto=udp,local_lock=none,addr=192.168.12.31)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 至此下一步我们需要在k8s集群中进行配置 NFS client provisioner</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="NFS-Client-Provisioner-环境"><a href="#NFS-Client-Provisioner-环境" class="headerlink" title="NFS Client Provisioner 环境"></a>NFS Client Provisioner 环境</h5><p>注意: 安装配置是一个Kubernetes的简易NFS的外部provisioner，本身不提供NFS，需要现有 的NFS服务器提供存储。<br>nfs-client-provisioner 构建的yaml文件:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; nfs-client-provisioner.yaml  &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"># NFS 驱动编排的资源清单</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  strategy:</span>          <span class="comment"># 策略</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span>   <span class="comment"># 再生(循环使用)</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nfs-client-provisioner</span>   <span class="comment"># 服务帐户名称</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner</span> </span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span>                <span class="comment"># 时区设置</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">PROVISIONER_NAME</span>                   <span class="comment"># StorageClass 对象中定义的 provisioner 键需要保持一致</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.31</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">NFS_PATH</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/nask8sapp</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">timezone</span>                            <span class="comment"># 时区定义</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span>   </span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nfs-client-root</span>                     <span class="comment"># 存储卷</span></span><br><span class="line"><span class="attr">        nfs:</span></span><br><span class="line"><span class="attr">          server:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.31</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/nask8sapp</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Storageclass 部署文件</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">managed-nfs-storage</span>    <span class="comment"># 重要 StorageClass Name绑定</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">storageclass.kubernetes.io/is-default-class:</span> <span class="string">"true"</span>   <span class="comment">#设置其为默认存储后端</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span>   <span class="comment"># 或选择另一个名称，必须与NFS 驱动编排匹配部署的 env PROVISIONER_NAME</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  archiveOnDelete:</span> <span class="string">"false"</span>    <span class="comment"># 删除pvc后，后端存储上的pv也自动删除</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># nfs-client-provisioner - rbac授权资源清单</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt; nfs-client-rbac.yaml&lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["events"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["create",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["endpoints"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>执行 &amp; 运行pod<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~/k8s/nfs-client-provisioner$ ls</span><br><span class="line"><span class="comment"># nfs-client-provisioner.yaml  nfs-client-rbac.yaml</span></span><br><span class="line"></span><br><span class="line">~/k8s/nfs-client-provisioner$ kubectl create -f .</span><br><span class="line"><span class="comment"># deployment.apps/nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># storageclass.storage.k8s.io/managed-nfs-storage created</span></span><br><span class="line"><span class="comment"># serviceaccount/nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span></span><br><span class="line"><span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span></span><br><span class="line"></span><br><span class="line">$ kubectl get storageclasses.storage.k8s.io</span><br><span class="line"><span class="comment"># NAME                            PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span></span><br><span class="line"><span class="comment"># managed-nfs-storage (default)   fuseim.pri/ifs   Delete          Immediate           false                  53s</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line"><span class="comment"># NAME                                     READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># nfs-client-provisioner-57946d456-b4s7l   1/1     Running   0          22s</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h4 id="2-2-搭建流程"><a href="#2-2-搭建流程" class="headerlink" title="2.2) 搭建流程"></a>2.2) 搭建流程</h4><h5 id="资源清单"><a href="#资源清单" class="headerlink" title="资源清单"></a>资源清单</h5><ul>
<li><strong>Step 1.创建PV、PVC，为Jenkins提供数据持久化</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; jenkins-PVC.yaml &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">devops</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">  annotations:</span>   <span class="comment"># 空间标注</span></span><br><span class="line">    <span class="string">volume.beta.kubernetes.io/storage-class:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><strong>Step 2.创建角色授权</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; jenkins-role.yaml &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-cr</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["extensions",</span> <span class="string">"apps"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["deployments"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"delete"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["services"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"delete"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create","delete","get","list","patch","update","watch"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods/exec"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create","delete","get","list","patch","update","watch"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods/log"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get","list","watch"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["secrets"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get"]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-crd</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-cr</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><strong>Step 3.在Kubernetes中Deployment部署Jenkins以及Service资源创建</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; jenkins-deployment.yaml &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> <span class="string">jenkins-sa</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">jenkins/jenkins:2.275-alpine</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="attr">-XshowSettings:vm</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.initialDelay=0</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN=50</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">jenkins-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span> </span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">agent</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h5 id="创建查看"><a href="#创建查看" class="headerlink" title="创建查看"></a>创建查看</h5><ul>
<li><strong>Step 4.采用kubectl命令创建上面的资源清单</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) PVC 持久卷创建</span></span><br><span class="line">$ kubectl create -f jenkins-PVC.yaml</span><br><span class="line">  <span class="comment"># namespace/devops created</span></span><br><span class="line">  <span class="comment"># persistentvolumeclaim/jenkins-pvc created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) Jenkins 在集群中角色创建绑定</span></span><br><span class="line">kubectl create -f jenkins-role.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/jenkins-sa created</span></span><br><span class="line">  <span class="comment"># clusterrole.rbac.authorization.k8s.io/jenkins-cr created</span></span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/jenkins-crd created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 部署 Jenkins deployment 和 SVC </span></span><br><span class="line">kubectl create -f jenkins-deployment.yaml</span><br><span class="line">  <span class="comment"># deployment.apps/jenkins created</span></span><br><span class="line">  <span class="comment"># service/jenkins created</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li><strong>Step 5.查看创建的PVC、POD以及SVC</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pvc,pod,svc -n devops</span><br><span class="line">  <span class="comment"># NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span></span><br><span class="line">  <span class="comment"># persistentvolumeclaim/jenkins-pvc   Bound    pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d   5Gi        RWX            managed-nfs-storage   23m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                          READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># pod/jenkins-689775956-nph9z   1/1     Running   0          15m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME              TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE</span></span><br><span class="line">  <span class="comment"># service/jenkins   NodePort   10.104.214.1   &lt;none&gt;        8080:30001/TCP,50000:30465/TCP   15m</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><strong>Step 6.我们进入Pod容器内部进行查看</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -n devops -it jenkins-7db7878f8f-78tmk bash</span><br><span class="line">$ ps aux   <span class="comment"># 可看到有两个进程正在运行</span></span><br><span class="line"><span class="comment"># PID   USER     TIME  COMMAND</span></span><br><span class="line"><span class="comment"># 1 jenkins   0:39 /sbin/tini -- /usr/local/bin/jenkins.sh  # 主运行文件</span></span><br><span class="line"><span class="comment"># 6 jenkins  57:00 java -Duser.home=/var/jenkins_home -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai -Djenkins.model.Jenkins.slaveAgentPort=50000 -jar /usr/share/jenkins/jenkins.war   # 运行 jenkins.war 的命令</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>查看容器入口执行文件: cat <code>/usr/local/bin/jenkins.sh</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /bin/bash -e</span></span><br><span class="line">: <span class="string">"<span class="variable">$&#123;JENKINS_WAR:="/usr/share/jenkins/jenkins.war"&#125;</span>"</span></span><br><span class="line">: <span class="string">"<span class="variable">$&#123;JENKINS_HOME:="/var/jenkins_home"&#125;</span>"</span></span><br><span class="line">: <span class="string">"<span class="variable">$&#123;COPY_REFERENCE_FILE_LOG:="$&#123;JENKINS_HOME&#125;</span>/copy_reference_file.log"</span>&#125;<span class="string">"</span></span><br><span class="line"><span class="string">: "</span><span class="variable">$&#123;REF:="/usr/share/jenkins/ref"&#125;</span><span class="string">"</span></span><br><span class="line"><span class="string">touch "</span><span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span><span class="string">" || &#123; echo "</span>Can not write to <span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>. Wrong volume permissions?<span class="string">"; exit 1; &#125;</span></span><br><span class="line"><span class="string">echo "</span>--- Copying files at $(date)<span class="string">" &gt;&gt; "</span><span class="variable">$COPY_REFERENCE_FILE_LOG</span><span class="string">"</span></span><br><span class="line"><span class="string">find "</span><span class="variable">$&#123;REF&#125;</span><span class="string">" \( -type f -o -type l \) -exec bash -c '. /usr/local/bin/jenkins-support; for arg; do copy_reference_file "</span><span class="variable">$arg</span><span class="string">"; done' _ &#123;&#125; +</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># if `docker run` first argument start with `--` the user is passing jenkins launcher arguments</span></span><br><span class="line"><span class="string">if [[ <span class="variable">$#</span> -lt 1 ]] || [[ "</span><span class="variable">$1</span><span class="string">" == "</span>--<span class="string">"* ]]; then</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # read JAVA_OPTS and JENKINS_OPTS into arrays to avoid need for eval (and associated vulnerabilities)</span></span><br><span class="line"><span class="string">  java_opts_array=()</span></span><br><span class="line"><span class="string">  while IFS= read -r -d '' item; do</span></span><br><span class="line"><span class="string">    java_opts_array+=( "</span><span class="variable">$item</span><span class="string">" )</span></span><br><span class="line"><span class="string">  done &lt; &lt;([[ <span class="variable">$JAVA_OPTS</span> ]] &amp;&amp; xargs printf '%s\0' &lt;&lt;&lt;"</span><span class="variable">$JAVA_OPTS</span><span class="string">")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  readonly agent_port_property='jenkins.model.Jenkins.slaveAgentPort'</span></span><br><span class="line"><span class="string">  if [ -n "</span><span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT:-&#125;</span><span class="string">" ] &amp;&amp; [[ "</span><span class="variable">$&#123;JAVA_OPTS:-&#125;</span><span class="string">" != *"</span><span class="variable">$&#123;agent_port_property&#125;</span><span class="string">"* ]]; then</span></span><br><span class="line"><span class="string">    java_opts_array+=( "</span>-D<span class="variable">$&#123;agent_port_property&#125;</span>=<span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT&#125;</span><span class="string">" )</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  if [[ "</span><span class="variable">$DEBUG</span><span class="string">" ]] ; then</span></span><br><span class="line"><span class="string">    java_opts_array+=( \</span></span><br><span class="line"><span class="string">      '-Xdebug' \</span></span><br><span class="line"><span class="string">      '-Xrunjdwp:server=y,transport=dt_socket,address=5005,suspend=y' \</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  jenkins_opts_array=( )</span></span><br><span class="line"><span class="string">  while IFS= read -r -d '' item; do</span></span><br><span class="line"><span class="string">    jenkins_opts_array+=( "</span><span class="variable">$item</span><span class="string">" )</span></span><br><span class="line"><span class="string">  done &lt; &lt;([[ <span class="variable">$JENKINS_OPTS</span> ]] &amp;&amp; xargs printf '%s\0' &lt;&lt;&lt;"</span><span class="variable">$JENKINS_OPTS</span><span class="string">")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  exec java -Duser.home="</span><span class="variable">$JENKINS_HOME</span><span class="string">" "</span><span class="variable">$&#123;java_opts_array[@]&#125;</span><span class="string">" -jar <span class="variable">$&#123;JENKINS_WAR&#125;</span> "</span><span class="variable">$&#123;jenkins_opts_array[@]&#125;</span><span class="string">" "</span><span class="variable">$@</span><span class="string">"</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># As argument is not jenkins, assume user want to run his own process, for example a `bash` shell to explore this image</span></span><br><span class="line"><span class="string">exec "</span><span class="variable">$@</span><span class="string">"</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : <code>/usr/local/bin/jenkins.sh</code> 以及 <code>usr/share/jenkins/</code>可用帮助我们进行Jenkins手动升级;</p>
<p><br/></p>
<h5 id="服务访问"><a href="#服务访问" class="headerlink" title="服务访问"></a>服务访问</h5><ul>
<li><strong>Step 7.因为我们Service是采用NodePort类型其端口为30001，我们直接在浏览器用这个端口访问Jenkins UI, 下面是精简操作如果不理解的童鞋，需要按照第一篇文章的操作进行初始化；</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Jenkins 初始化密码获取的两种方式;</span></span><br><span class="line"><span class="comment"># 方式1.认证</span></span><br><span class="line">$ kubectl logs -n devops pod/jenkins-689775956-nph9z | grep -A 2 <span class="string">"following password"</span></span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">c45f558fa237472f9f8f954ceb3a323e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2.动态卷Jenkins持久化目录</span></span><br><span class="line"><span class="comment"># 容器中的目录 : /var/jenkins_home/secrets/initialAdminPassword - pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d</span></span><br><span class="line">$ cat /nfsdisk-31/devops-jenkins-pvc-pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d/secrets/initialAdminPassword</span><br><span class="line">c45f558fa237472f9f8f954ceb3a323e</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113162155.png" target="_blank" title="WeiyiGeek.Jenkins Init" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113162155.png" alt="WeiyiGeek.Jenkins Init" title="" class=""></a>
                <p>WeiyiGeek.Jenkins Init</p>
            </figure>
<p><br/></p>
<ul>
<li><strong>Step 7.安装 <code>Jenkins入门学习之持续化集成与部署</code> 文章的操作进行初始化, 当然您也可以选择自定义插件安装 -&gt; Languages (两项插件) 先进行汉化</strong></li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163216.png" target="_blank" title="WeiyiGeek.Languages-Chinese" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163216.png" alt="WeiyiGeek.Languages-Chinese" title="" class=""></a>
                <p>WeiyiGeek.Languages-Chinese</p>
            </figure>
<p><br/></p>
<ul>
<li><strong>Step 8.Create First Admin User -&gt; Instance Configuration (Jenkins URL) -&gt; Save -&gt; Restart 安装成功</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Jenkins URL: http://jenkins.weiyigeek.top:30001/  <span class="comment"># 注意需要添加解析</span></span><br><span class="line">Jenkins URL: http://192.168.10.10:30001</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163957.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163957.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><p><strong>Step 9.插件镜像仓库设置加快拉取进度 <code>Dashboard -&gt; 插件管理 -&gt; 高级 -&gt; 升级站点</code>;</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级站点</span></span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户定义的时区 -&gt; Time Zone -&gt; Asia/Beijing</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Step 10.最后最新进行常用插件安装，可以参考最后一章</strong></p>
</li>
</ul>
<hr>
<h3 id="3-集群动态创建-Agent-节点-Slave-节点"><a href="#3-集群动态创建-Agent-节点-Slave-节点" class="headerlink" title="(3) 集群动态创建 Agent 节点 - Slave 节点"></a>(3) 集群动态创建 Agent 节点 - Slave 节点</h3><p>描述: 前面我们说过Jenkins的分布式架构(Master-Slave)，其中 master 主要负责负载地调度而 slave 执行构建任务，并且当Job构建完成后Pod就会自动销毁, 所以其可以很好地解决性能与资源占用问题。</p>
<p><strong>步骤说明:</strong></p>
<ul>
<li>Step 1.所以在 Jenkins 服务安装好 <a href="https://plugins.jenkins.io/kubernetes/" target="_blank" rel="noopener">Kubernetes 插件</a> 并配置好连接 Kubernetes 的信息，就可以在 Kubernetes 集群中动态创建 Agent 节点了。其中 Jenkins Master节点可以直接安装在宿主机中，也可以部署在 Kubernetes 集群中。<br>该插件为每个要启动的 Jenkins Agent 节点创建一个 Kubernetes Pod 对象，并在构建完成后销毁 Pod 。<ul>
<li>Agent 节点是使用JNLP启动的，是通过 Agent 节点镜像自动连接 Jenkins Master 节点。使用这种连接方式，需要对 Agent 节点设置一些环境变量：<blockquote>
<ul>
<li>1.JENKINS_URL：Jenkins Web界面URL</li>
<li>2.JENKINS_SECRET：用于认证的密钥</li>
<li>3.JENKINS_AGENT_NAME：Jenkins代理的名称</li>
<li>4.JENKINS_NAME：Jenkins代理的名称（不建议使用。仅在此处是为了向后兼容）</li>
</ul>
</blockquote>
</li>
</ul>
</li>
</ul>
<p>Tips : 这些环境变量会在 Pod 创建配置中设定好，用于 Agent 节点启动时连接 Master 节点。</p>
<p><br></p>
<ul>
<li>Step 2.Kubernetes 插件使用时，最先要配置的是<code>连接 Kubernetes 集群的连接信息</code>和 <code>Jenkins 服务 Master 节点连接地址</code>(其他连接信息自动生成不需要配置)。<ul>
<li>1.Jenkins 服务使用 Kubernetes 插件连接 Kubernetes 集群，并动态创建 Agent 节点。连接 Kubernetes 集群需要配置的 Kubernetes 连接信息包括：</li>
<li>2.Kubernetes 集群名称</li>
<li>3.Kubernetes 集群Api-server 的连接地址</li>
<li>4.Kubernetes 集群服务证书：Kubernetes 集群节点间通信都是使用证书双向认证加密的，一般所有的证书都使用同一个 CA 证书做证书申请签发；这里的服务器证书就是这个CA 证书。因为此时 Jenkins Master 节点也就是一个 Kubernetes Agent 节点，也需要信任 CA 证书，信任CA 证书签发的其他节点上的证书。</li>
<li>5.Kubernetes 命名空间：应该是创建的 Agent 节点在哪个命名空间中运行。</li>
<li>6.凭证（Kubernetes 认证）：支持的凭证包括：用户名密码、秘密文件（kubeconfig文件）、秘密文本（基于令牌的身份验证）（OpenShift）、来自私钥的Google服务帐户（GKE身份验证）、X.509客户端证书。</li>
</ul>
</li>
</ul>
<p>将会具体使用配置将会在下面进行详述的配置讲解。</p>
<p><br></p>
<h4 id="内置-Jenkins-Master-接入内部-K8s-集群"><a href="#内置-Jenkins-Master-接入内部-K8s-集群" class="headerlink" title="内置 Jenkins Master 接入内部 K8s 集群"></a>内置 Jenkins Master 接入内部 K8s 集群</h4><p><strong>配置流程:</strong></p>
<ul>
<li>Step 1.安装kubernetes插件: 点击 Manage Jenkins -&gt; Manage Plugins -&gt; Available -&gt; Kubernetes 勾选安装即可。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 kubernetes plugins</span></span><br><span class="line">Kubernetes Client API Plugin - Kubernetes客户端API插件，供其他Jenkins插件使用 - 4.11.1		</span><br><span class="line">Kubernetes Credentials Plugin - Kubernetes证书的公共类 - 0.8.0	</span><br><span class="line">Kubernetes plugin - 这个插件集成了Jenkins与Kubernetes - 1.28.7</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 2.在Jenkins中配置k8s信息：安装完毕后点击 Manage Jenkins —&gt; Configure System —&gt; (拖到最下方) Add a new cloud —&gt; 选择 Kubernetes，然后填写 Kubernetes 和 Jenkins 配置信息。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubernetes 集群名称 Name:</span></span><br><span class="line">kubernetes </span><br><span class="line"><span class="comment"># Kubernetes 地址</span></span><br><span class="line">https://kubernetes.default.svc.cluster.local</span><br><span class="line"><span class="comment"># Kubernetes 服务证书 key 内容</span></span><br><span class="line">ca.crt </span><br><span class="line"><span class="comment"># Kubernetes 命名空间</span></span><br><span class="line">devops</span><br><span class="line"><span class="comment"># 添加凭据可选</span></span><br><span class="line"><span class="comment"># Jenkins 地址 : The URL of the Jenkins Master server. </span></span><br><span class="line"><span class="comment"># 格式 : 服务名.namespace.svc.cluster.local:8080</span></span><br><span class="line">http://jenkins.devops.svc.cluster.local:8080</span><br><span class="line"><span class="comment"># 注意: Jenkins通道不需要添加slave它会自动识别(网上博客说加上之后可能导致Pod反复重启-应该在新版本中不会存在)</span></span><br><span class="line"><span class="comment"># Jenkins 通道</span></span><br><span class="line">jenkins.devops.svc.cluster.local:50000</span><br><span class="line"><span class="comment"># Pod Labels</span></span><br><span class="line">Key: app</span><br><span class="line">Value: k8s</span><br><span class="line"><span class="comment"># 其它值默认即可(如需配置相应即可)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips: 设置JNLP访问协议，打开<code>Jenkins/Configure Global Security</code>找到 Agents, 设置 Port 为 指定端口50000（<code>对于集群搭建Jenkins-Master想接入其它VM物理机上的Agent节点</code>）, Agent protocols 选Inbound TCP Agent Protocol/4 (TLS encryption)保存；</p>
<p><br></p>
<ul>
<li>Step 3.点击Test Connection，如果出现 <code>Connected to Kubernetes v1.19.6</code> 的提示信息证明 Jenkins 已经可以和 Kubernetes 系统正常通信了(CSDN - 滞后性太严重了，还是得看官网)<br>Tips : 注意如果这里 Connection 失败的话，很有可能是权限问题，这里就需要把我们创建的 jenkins 的 serviceAccount 对应的 secret 添加到这里的 Credentials 里面。</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202224506.png" target="_blank" title="WeiyiGeek.JenkinsConnectionK8s" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202224506.png" alt="WeiyiGeek.JenkinsConnectionK8s" title="" class=""></a>
                <p>WeiyiGeek.JenkinsConnectionK8s</p>
            </figure>
<p><br></p>
<h4 id="独立Jenkins-Master节点接入外部K8s集群"><a href="#独立Jenkins-Master节点接入外部K8s集群" class="headerlink" title="独立Jenkins Master节点接入外部K8s集群"></a>独立Jenkins Master节点接入外部K8s集群</h4><ul>
<li>Step 1.创建<code>Kubernetes Namespace</code>与<code>Service Account</code>(可参考前面搭建)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Kubenates的上创建devops命名空间，用于Jenkins使用</span></span><br><span class="line">kubectl create namespace devops</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Kubernetes上为Jenkins构建创建有Cluster Admin权限的Service Account jenkins：</span></span><br><span class="line">kubectl create clusterrolebinding jenkins --clusterrole cluster-admin --serviceaccount=devops:jenkins</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Step 2.生成调度凭证即<code>Kubernetes的 server certificate key和Client P12 Certificate File</code>, 其作用是采用<code>P12 Certificate File</code>提供给<code>jenkins Master</code>去调用Kubenetes,<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ~/.kube/config 运行以下命令分别生成生成 ca.crt, client.crt, client.key</span></span><br><span class="line">$ cat ~/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ********ORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://weiyigeek-lb-vip.k8s:16443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR........VRFMLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNS........BQUklWQVRFIEtFWS0tLS0tCg==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) 复制 certificate-authority-data 的内容运行以下命令生成 `ca.crt` - ca证书</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;certificate-authority-data&gt;"</span> | base64 -d &gt; ca.crt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"LS0*******tLS1"</span> | base64 -d &gt; ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 复制 client-certificate-data的内容，运行以下命令生成 `client.crt` -  客户端证书</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;client-certificate-data&gt;"</span> | base64 -d &gt; client.crt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"LS0tLS1CRUd*******tLQo="</span>  | base64 -d &gt; client.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 复制 client-key-data的内容，运行以下命令生成 `client.key` - 密钥</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;client-key-data&gt;"</span> | base64 -d &gt; client.key</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"LS0tL*******g=="</span> | base64 -d &gt; client.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补充: 2022年1月18日 17:19:58</span></span><br><span class="line">cat ~/.kube/config | grep <span class="string">"certificate-authority-data"</span> | sed s/[[:space:]]//g | cut -d <span class="string">':'</span> -f 2 | base64 -d &gt; ca.crt</span><br><span class="line">cat ~/.kube/config | grep <span class="string">"client-certificate-data"</span> | sed s/[[:space:]]//g | cut -d <span class="string">':'</span> -f 2 | base64 -d &gt; client.crt</span><br><span class="line">cat ~/.kube/config | grep <span class="string">"client-key-data"</span> | sed s/[[:space:]]//g | cut -d <span class="string">':'</span> -f 2 | base64 -d &gt; client.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 之后再根据前面步骤生成的 ca.crt, client.crt 和 client.key 来生成 PKCS12 格式的 cert.pfx</span></span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out cert.pfx -inkey client.key -<span class="keyword">in</span> client.crt -certfile ca.crt</span><br><span class="line">  <span class="comment"># Enter Export Password: weiyigeek</span></span><br><span class="line">  <span class="comment"># Verifying - Enter Export Password: weiyigeek</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 3.在Jenkins上集成 Kubernetes 首先需要将 cert.pfx 导入到<code>Jenkins Global Credential</code> 凭据中(注意输入密码)</p>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204113516.png" target="_blank" title="WeiyiGeek.cert.pfx" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204113516.png" alt="WeiyiGeek.cert.pfx" title="" class=""></a>
                <p>WeiyiGeek.cert.pfx</p>
            </figure>
<p><br/></p>
<p>Step 4.然后按照上面的方式在<code>Jenkins</code>上配置Kubernetes Cloud, 不同的是需要填入以下信息，最后点击“Test Connection”按钮测试Jenkins是否可以成功连接Kubernetes。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes 名称 : kubernetes-external</span></span><br><span class="line"><span class="comment"># Kubernetes 地址 : https://192.168.12.110:16443    # 此处由于做了高可用所以不是master节点地址:6443</span></span><br><span class="line"><span class="comment"># Kubernetes 服务证书 key ：ca.crt 的内容</span></span><br><span class="line"><span class="comment"># Kubernetes 命名空间 : devops</span></span><br><span class="line"><span class="comment"># Jenkins 地址 ：http://jenkins.devops.svc.cluster.local:8080</span></span><br><span class="line"><span class="comment"># Jenkins 通道 ：jenkins.devops.svc.cluster.local:50000 （注意此为tcp连接，不要加上http）</span></span><br><span class="line"><span class="comment"># Tips : 注意勾选从 master 传递给 agent 的环境变量</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205094218.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205094218.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p>Tips ： 在进行第五步是建议在各个Work节点拉取<code>jenkins/inbound-agent:4.3-4</code>镜像</p>
<p><br/></p>
<ul>
<li>Step 5.下面设置 Pod Templates 此处需添加一个Pod 模板名称等相关信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 Pod 模板 </span></span><br><span class="line">Pod 模板名称: jenkins-slave</span><br><span class="line">命名空间：devops                 <span class="comment"># 一定不要写错误了否则不能创建Pod</span></span><br><span class="line">标签列表: jenkins-slave     <span class="comment"># 后续Job可以指定该标签进行运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加容器列表 (jenkins/inbound-agent:4.3-4)  # 差点把我坑哭了 (测试时候可以先不加容器，默认有一个jnlp名称容器)</span></span><br><span class="line"><span class="comment"># 名称 ：       maven</span></span><br><span class="line"><span class="comment"># Docker 镜像 : maven:3.6-jdk-8-alpine  </span></span><br><span class="line"><span class="comment"># 工作目录 : /home/jenkins/</span></span><br><span class="line"><span class="comment"># 运行的命令 : sleep 9000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载到 Pod 代理中的卷列表</span></span><br><span class="line"><span class="comment"># 选择 Host Path Volume 将maven进行持久化存储（此处路径与您setting配置有关默认是运行用户家目录中）</span></span><br><span class="line"><span class="comment"># Maven 持久化目录 : /home/jenkins/.m2  # 此处应该是您各个K8s的Work节点上NFS目录;</span></span><br><span class="line">/nfsdisk-31/appstorage/mavenRepo <span class="comment"># 主机目录（root@weiyigeek-107 ）NFS目录</span></span><br><span class="line">/home/jenkins/.m2                <span class="comment"># Pod挂载目录</span></span><br><span class="line"><span class="comment"># docker socket 目录: </span></span><br><span class="line">/var/run/docker.sock    <span class="comment"># 主机目录(由于各个节点都安装docker)</span></span><br><span class="line">/var/run/docker.sock    <span class="comment"># Pod挂载目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Service Account 账户权限</span></span><br><span class="line">Service Account ：jenkins-sa   <span class="comment"># 前面创建的ServiceAccount</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204203103.png" target="_blank" title="WeiyiGeek.Slave Pod 模板" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204203103.png" alt="WeiyiGeek.Slave Pod 模板" title="" class=""></a>
                <p>WeiyiGeek.Slave Pod 模板</p>
            </figure>
<p>Tips : 警告如果要为JNLP代理提供自己的Docker映像则必须将容器命名为jnlp，以便它覆盖默认容器否则，将导致两个代理尝试同时连接到主服务器</p>
<p>Tips : 该 Jenkins的 Kubernetes 插件默认jnlp容器是<code>&quot;jenkins/inbound-agent:4.3-4&quot;, name: &quot;jnlp&quot;</code>，我们可以自定义jnlp容器进行覆盖只需将容器名称更改为jnlp即可(不过一般情况下不建议更改)，直接添加pod即可;</p>
<p>Tips ：镜像的选择就是一个坑开始使用的是<code>jenkins/inbound-agent:alpine</code>然后容器名称并未设置为jnlp覆盖默认的<code>&quot;jenkins/inbound-agent:4.3-4&quot;</code>容器（实际用不着），导致都执行了节点加入命令（其实是两个开放的都是链接到jenkins-jlnp 50000端口上）, 发现官网(<a href="https://hub.docker.com/r/jenkins/jnlp-slave)提示的警告该图像曾经以" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/jnlp-slave)提示的警告该图像曾经以</a> jenkinsci/jnlp-slave 和 jenkins/jnlp-slave 的形式发布。  这些图像已弃用，请使用<code>jenkins/inbound-agent</code>，即我们可以在jenkins/inbound-agent镜像的基础上添加我们需要的工具即可，然后再次docker build。</p>
<p>采用的是或者不加镜像容器信息最后完满解决;</p>
<p><br></p>
<ul>
<li>Step 6.创建一个Job Pipeline 验证测试环境;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// <span class="comment"># scripted Pipeline </span></span><br><span class="line">def podTemplates = <span class="string">'jenkins-slave'</span></span><br><span class="line">podTemplate(label: podTemplates, cloud: <span class="string">'kubernetes'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    node (podTemplates) &#123;</span><br><span class="line">        stage(<span class="string">'init'</span>) &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Hello world, Kubernetes Jenkins Slave"</span></span><br><span class="line">            sh <span class="string">"hostname &amp;&amp; ls /home/jenkins/.m2 &amp;&amp; sleep 300"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输出结果:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// <span class="comment"># scripted Pipeline </span></span><br><span class="line">podTemplate(name: <span class="string">'jenkins-slave'</span>, label: <span class="string">'jenkins-slave'</span>, cloud: <span class="string">'kubernetes'</span>,containers: [</span><br><span class="line">    containerTemplate(name: <span class="string">'maven'</span>, image: <span class="string">'maven:3.6-jdk-8-alpine'</span>, ttyEnabled: <span class="literal">true</span>, <span class="built_in">command</span>: <span class="string">'sleep'</span>, args: <span class="string">'30'</span>)</span><br><span class="line">])&#123;</span><br><span class="line">    node (podTemplates) &#123;</span><br><span class="line">        stage(<span class="string">'init'</span>) &#123;</span><br><span class="line">            container (<span class="string">'maven'</span>) &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Hello world, Kubernetes Jenkins Slave"</span></span><br><span class="line">                sh <span class="string">'mvn -version'</span></span><br><span class="line">                sh <span class="string">"hostname &amp;&amp; ls /home/jenkins/.m2 &amp;&amp; pwd"</span></span><br><span class="line">                sh <span class="string">"env"</span></span><br><span class="line">                sh <span class="string">"pwd &amp;&amp; ls"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205152239.png" target="_blank" title="WeiyiGeek.result" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205152239.png" alt="WeiyiGeek.result" title="" class=""></a>
                <p>WeiyiGeek.result</p>
            </figure>
<hr>
<h2 id="0x03-补充说明"><a href="#0x03-补充说明" class="headerlink" title="0x03 补充说明"></a>0x03 补充说明</h2><h3 id="1-K8s-集群中对搭建的Jenkins进行版本升级"><a href="#1-K8s-集群中对搭建的Jenkins进行版本升级" class="headerlink" title="(1) K8s 集群中对搭建的Jenkins进行版本升级"></a>(1) K8s 集群中对搭建的Jenkins进行版本升级</h3><p>描述: 在 K8s 中对 Jenkins 升级是非常的简单只需要把image键中版本值进行改变(<code>只需要使用新的版本镜像替换即可</code>)，从而拉取新的镜像运行即可。</p>
<p>Tips : 注意此处做了PVC持久化如果未作持久化的童鞋需要注意数据的保存, 其次是拉取的版本的Jenkins镜像必须存在</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ grep <span class="string">"jenkins:2.277-alpine"</span> jenkins-deployment.yaml</span><br><span class="line">  <span class="comment"># image: jenkins/jenkins:2.277-alpine</span></span><br><span class="line">  <span class="comment"># https://updates.jenkins.io/download/war/2.277/jenkins.war</span></span><br><span class="line">$ kubectl apply -f jenkins-deployment.yaml</span><br><span class="line">$ kubectl get pod -n devops</span><br><span class="line">  <span class="comment"># NAME                       READY   STATUS              RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># jenkins-5df679b7ff-5r8d4   0/1     ContainerCreating   0          24s</span></span><br><span class="line">  <span class="comment"># jenkins-7db7878f8f-78tmk   1/1     Running             2          18d  # 原版本等待新版本的Pod启动完毕后自动销毁;</span></span><br></pre></td></tr></table></figure>
<p>Tips: 对于Jenkins版本在生产环境中不建议冒冒失失进行升级其中原因你我心知，但是针对于出现严重漏洞不得不修复时，建议构建新的环境再依次迁移（同时注意备份），确定无任何问题后再关闭下线并进行切换</p>
<p>Tips : 此处为测试学习环境，看到这个提示我的强迫症就上来了;</p>
<figure class="image-box">
                <a rel=4.Jenkins进阶之分布式架构环境配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202163113.png" target="_blank" title="WeiyiGeek.K8s集群中对Jenkins进行升级" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202163113.png" alt="WeiyiGeek.K8s集群中对Jenkins进行升级" title="" class=""></a>
                <p>WeiyiGeek.K8s集群中对Jenkins进行升级</p>
            </figure>
<p><br></p>
<h3 id="2-移植其他Jenkins机器上的插件到Kubernetes安装的Jenkins中然后进行重新Jenkins-需要非常注意版本问题"><a href="#2-移植其他Jenkins机器上的插件到Kubernetes安装的Jenkins中然后进行重新Jenkins-需要非常注意版本问题" class="headerlink" title="(2) 移植其他Jenkins机器上的插件到Kubernetes安装的Jenkins中然后进行重新Jenkins(需要非常注意版本问题-)"></a>(2) 移植其他Jenkins机器上的插件到Kubernetes安装的Jenkins中然后进行重新Jenkins(需要非常注意版本问题-)</h3><p>简单操作流程:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf jenkins_2.272.x_plugins.tar.gz -C ./jenkins/</span><br><span class="line"></span><br><span class="line">~/jenkins$ <span class="built_in">cd</span> var/lib/jenkins/plugins/</span><br><span class="line"></span><br><span class="line">~/jenkins/var/lib/jenkins/plugins$ cp -a . /nfsdisk-31/devops-jenkins-pvc-pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d/plugins/</span><br><span class="line"></span><br><span class="line">$ chown -R jenkins:jenkins /nfsdisk-31/devops-jenkins-pvc-pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d/plugins</span><br></pre></td></tr></table></figure></p>
<p>Tips : 注意此处是我的PVC持久化的目录路径,与你实践的环境是不一致的。</p>
<p><br></p>
<hr>
<h2 id="0x04-入坑出坑"><a href="#0x04-入坑出坑" class="headerlink" title="0x04 入坑出坑"></a>0x04 入坑出坑</h2><h3 id="问题1-在K8s中安装Jenkins时报错从logs日志显示Can-not-write-to-var-jenkins-home-copy-reference-file-log-Wrong-volume-permissions-错误"><a href="#问题1-在K8s中安装Jenkins时报错从logs日志显示Can-not-write-to-var-jenkins-home-copy-reference-file-log-Wrong-volume-permissions-错误" class="headerlink" title="问题1.在K8s中安装Jenkins时报错从logs日志显示Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?错误"></a>问题1.在K8s中安装Jenkins时报错从logs日志显示<code>Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?</code>错误</h3><ul>
<li>错误信息: 没有权限在 jenkins 的 home 目录下面创建文件;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-ops logs jenkins2-59764f8f65-rcvh5</span><br><span class="line">Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?</span><br><span class="line">touch: cannot touch <span class="string">'/var/jenkins_home/copy_reference_file.log'</span>: Permission denied</span><br></pre></td></tr></table></figure></li>
<li>错误原因: 因为默认的镜像使用的是 jenkins 这个用户，而我们通过 PVC 挂载到 nfs 服务器的共享数据目录下面却是 root 用户的，所以没有权限访问该目录</li>
<li>问题解决: 只需要在 nfs 共享数据目录下面把我们的目录权限重新分配下即可：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R 1000 /data/k8s/jenkins2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="问题2-Jenkins调用节点执行任务时java-lang-IllegalStateException-Agent-is-not-connected-after-100-seconds-status-Running报错导致不断重启"><a href="#问题2-Jenkins调用节点执行任务时java-lang-IllegalStateException-Agent-is-not-connected-after-100-seconds-status-Running报错导致不断重启" class="headerlink" title="问题2.Jenkins调用节点执行任务时java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: Running报错导致不断重启"></a>问题2.Jenkins调用节点执行任务时<code>java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: Running</code>报错导致不断重启</h3><p><strong>问题描述: Agent 不能 通过 jnlp 与 Jenkins 的 Master 相连接</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2021-02-04 05:37:46.886+0000 [id=1985]  WARNING o.c.j.p.k.KubernetesLauncher<span class="comment">#launch: Error in provisioning; agent=KubernetesSlave name: jenkins-slave-b63kv, template=PodTemplate&#123;id='83f07044-1633-468a-91c8-e05ffb924303', name='jenkins-slave', namespace='devops', label='jenkins-slave', serviceAccount='jenkins-sa', volumes=[HostPathVolume [mountPath=/home/jenkins/.m2, hostPath=/tmp/.m2]], containers=[ContainerTemplate&#123;name='jnlp', image='jenkins/inbound-agent:alpine', workingDir='/home/jenkins', command='sleep', args='9999999', resourceRequestCpu='', resourceRequestMemory='', resourceRequestEphemeralStorage='', resourceLimitCpu='', resourceLimitMemory='', resourceLimitEphemeralStorage='', livenessProbe=ContainerLivenessProbe&#123;execArgs='', timeoutSeconds=0, initialDelaySeconds=0, failureThreshold=0, periodSeconds=0, successThreshold=0&#125;&#125;]&#125;</span></span><br><span class="line">java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: Running</span><br><span class="line">        at org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher.launch(KubernetesLauncher.java:244)</span><br><span class="line">        at hudson.slaves.SlaveComputer.lambda<span class="variable">$_connect</span><span class="variable">$0</span>(SlaveComputer.java:294)</span><br><span class="line">        at jenkins.util.ContextResettingExecutorService<span class="variable">$2</span>.call(ContextResettingExecutorService.java:46)</span><br><span class="line">        at jenkins.security.ImpersonatingExecutorService<span class="variable">$2</span>.call(ImpersonatingExecutorService.java:80)</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">2021-02-04 05:37:46.886+0000 [id=1985]  INFO    o.c.j.p.k.KubernetesSlave<span class="comment">#_terminate: Terminating Kubernetes instance for agent jenkins-slave-b63kv</span></span><br><span class="line">2021-02-04 05:37:46.900+0000 [id=1985]  INFO    o.c.j.p.k.KubernetesSlave<span class="comment">#deleteSlavePod: Terminated Kubernetes instance for agent devops/jenkins-slave-b63kv</span></span><br><span class="line">2021-02-04 05:37:46.901+0000 [id=1985]  INFO    o.c.j.p.k.KubernetesSlave<span class="comment">#_terminate: Disconnected computer jenkins-slave-b63kv</span></span><br><span class="line">Terminated Kubernetes instance <span class="keyword">for</span> agent devops/jenkins-slave-b63kv</span><br><span class="line">Disconnected computer jenkins-slave-b63kv</span><br></pre></td></tr></table></figure></p>
<p><strong>问题原因:</strong></p>
<blockquote>
<p>答: 这个问题困扰了我好久，总结可能出现该问题的情况，<br>1.指定的 Jenkins-jnlp 容器镜像的Agent不能正常连接到Master<br>2.指定的 Jenkins-jnlp 镜像启动参数问题。</p>
</blockquote>
<p><strong>解决办法:</strong></p>
<blockquote>
<p>答: 换镜像,在后面的章节中我会将自定义<code>Jenkins Slave Jnlp</code> 容器镜像的DockerFile文件进行分享,此时你可以将Pod模板中的ContainerTemplate容器模板删除即可,利用在pipeline 脚本中进行指定,例如:<code>docker.io/weiyigeek/alpine-jenkins-jnlp:v2.285</code>。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    kubernetes &#123;</span><br><span class="line">      cloud <span class="string">'kubernetes'</span></span><br><span class="line">      namespace <span class="string">'devops'</span></span><br><span class="line">      inheritFrom <span class="string">'jenkins-slave'</span></span><br><span class="line">      workingDir <span class="string">'/home/jenkins/agent'</span></span><br><span class="line">      <span class="comment">// yamlFile 'KubernetesPod.yaml'</span></span><br><span class="line">      yaml <span class="string">"""\</span></span><br><span class="line"><span class="string">apiVersion:</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    jenkins: "slave"</span></span><br><span class="line"><span class="string">    jenkins/label: 'k8s-slave'</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: 'jnlp'</span></span><br><span class="line"><span class="string">    image: 'docker.io/weiyigeek/alpine-jenkins-jnlp:v2.285'</span></span><br><span class="line"><span class="string">    imagePullPolicy: 'IfNotPresent'                                    </span></span><br><span class="line"><span class="string">    command: ["/bin/sh","-c","/usr/local/bin/jenkins-agent.sh &amp;&amp; cat"] </span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - mountPath: "/home/jenkins/.m2"</span></span><br><span class="line"><span class="string">      name: "volume-0"</span></span><br><span class="line"><span class="string">    - mountPath: "/var/run/docker.sock"</span></span><br><span class="line"><span class="string">      name: "volume-1"</span></span><br><span class="line"><span class="string">    """</span>.stripIndent()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><br></p>
<h3 id="问题3-基于-Kubernetes-部署-Jenkins-动态-slave-后，运行-Jenkins-Job-会抛java-nio-channels-ClosedChannelException"><a href="#问题3-基于-Kubernetes-部署-Jenkins-动态-slave-后，运行-Jenkins-Job-会抛java-nio-channels-ClosedChannelException" class="headerlink" title="问题3.基于 Kubernetes 部署 Jenkins 动态 slave 后，运行 Jenkins Job 会抛java.nio.channels.ClosedChannelException"></a>问题3.基于 Kubernetes 部署 Jenkins 动态 slave 后，运行 Jenkins Job 会抛java.nio.channels.ClosedChannelException</h3><p>异常问题:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FATAL: java.nio.channels.ClosedChannelException</span><br><span class="line">java.nio.channels.ClosedChannelException</span><br><span class="line">Also:   hudson.remoting.Channel<span class="variable">$CallSiteStackTrace</span>: Remote call to JNLP4-connect connection from 10.244.8.1/10.244.8.1:55340</span><br><span class="line">    at hudson.remoting.Channel.attachCallSiteStackTrace(Channel.java:1741)</span><br><span class="line">    at hudson.remoting.Request.call(Request.java:202)</span><br><span class="line">    at hudson.remoting.Channel.call(Channel.java:954)</span><br><span class="line">    at hudson.FilePath.act(FilePath.java:1071)</span><br><span class="line">    at hudson.FilePath.act(FilePath.java:1060)</span><br><span class="line">    at hudson.FilePath.mkdirs(FilePath.java:1245)</span><br><span class="line">    at hudson.model.AbstractProject.checkout(AbstractProject.java:1202)</span><br><span class="line">    at hudson.model.AbstractBuild<span class="variable">$AbstractBuildExecution</span>.defaultCheckout(AbstractBuild.java:574)</span><br><span class="line">    at jenkins.scm.SCMCheckoutStrategy.checkout(SCMCheckoutStrategy.java:86)</span><br><span class="line">    at hudson.model.AbstractBuild<span class="variable">$AbstractBuildExecution</span>.run(AbstractBuild.java:499)</span><br><span class="line">    at hudson.model.Run.execute(Run.java:1819)</span><br><span class="line">    at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:43)</span><br><span class="line">    at hudson.model.ResourceController.execute(ResourceController.java:97)</span><br><span class="line">    at hudson.model.Executor.run(Executor.java:429)</span><br><span class="line">Caused: hudson.remoting.RequestAbortedException</span><br><span class="line">  at hudson.remoting.Request.abort(Request.java:340)</span><br><span class="line">  at hudson.remoting.Channel.terminate(Channel.java:1038)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.impl.ChannelApplicationLayer.onReadClosed(ChannelApplicationLayer.java:209)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.ApplicationLayer.onRecvClosed(ApplicationLayer.java:222)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.ProtocolStack<span class="variable">$Ptr</span>.onRecvClosed(ProtocolStack.java:832)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.FilterLayer.onRecvClosed(FilterLayer.java:287)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.impl.SSLEngineFilterLayer.onRecvClosed(SSLEngineFilterLayer.java:172)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.ProtocolStack<span class="variable">$Ptr</span>.onRecvClosed(ProtocolStack.java:832)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.NetworkLayer.onRecvClosed(NetworkLayer.java:154)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.impl.NIONetworkLayer.ready(NIONetworkLayer.java:142)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.IOHub<span class="variable">$OnReady</span>.run(IOHub.java:795)</span><br><span class="line">  at jenkins.util.ContextResettingExecutorService<span class="variable">$1</span>.run(ContextResettingExecutorService.java:28)</span><br><span class="line">  at jenkins.security.ImpersonatingExecutorService<span class="variable">$1</span>.run(ImpersonatingExecutorService.java:59)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure></p>
<p>问题原因: 抛 <code>java.nio.channels.ClosedChannelException</code> 异常的原因是 <code>Jenkins Slave Pod 在 Jenkins Job</code> 运行时突然挂掉，然后 Master Pod 无法和 Slave Pod 进行通信。那么解决方法就是找到 Slave Pod 经常挂掉的原因，经排查是 Slave Pod 的资源限制不合理，配置的 CPU 和内存太小，导致 Pod 在运行是很容易超出资源限制，然后被 k8s Kill 掉。</p>
<p>解决办法:打开 Jenkins 设置 Slave Pod 模版的资源限制：<code>Jenkins-&gt;系统管理-&gt;系统设置-&gt;云-&gt;镜像-&gt;Kubernetes Pod Template-&gt;Container Template-&gt;高级</code>，然后根据实际情况调整 CPU 和内存需求。</p>

        </div>
        <!-- Google 广告 -->
          

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-10-23T08:29:14.698Z" itemprop="dateUpdated">2022-10-23 16:29:14</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/系统运维/自动化运维/CI-CD/Jenkins/4.Jenkins进阶之分布式架构环境配置.md" target="_blank" rel="noopener noreferrer">_posts/系统运维/自动化运维/CI-CD/Jenkins/4.Jenkins进阶之分布式架构环境配置.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2020/12-30-531.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/12-30-531.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=《4.Jenkins进阶之分布式架构环境配置》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=《4.Jenkins进阶之分布式架构环境配置》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《4.Jenkins进阶之分布式架构环境配置》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/12-30-531.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/12-30-523.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">3.Jenkins进阶之流水线pipeline基础使用实践</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/12-29-519.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">2.Jenkins进阶之流水线pipeline语法入门学习</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-节点说明"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.节点说明</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-节点连接"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.节点连接</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#SSH-方式"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">SSH 方式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#JNLP-方式"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">JNLP 方式</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-点明主题"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.点明主题</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-知识扩展"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">4.知识扩展</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-安装部署"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 安装部署</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#0-分布式架构过程说明"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">(0) 分布式架构过程说明</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#在-Master-节点中添加-Agent-方式"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">在 Master 节点中添加 Agent 方式</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-单主机部署配置固定-agent"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">(1) 单主机部署配置固定 agent</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Java-Web-启动-Agent-方式"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">Java Web 启动 Agent 方式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Launch-agents-via-SSH-启动-Agent-方式"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">Launch agents via SSH 启动 Agent 方式</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-集群搭建Jenkins-Master-节点"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">(2) 集群搭建Jenkins Master 节点</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-1-基础环境"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text">2.1) 基础环境</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-搭建流程"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text">2.2) 搭建流程</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-集群动态创建-Agent-节点-Slave-节点"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">(3) 集群动态创建 Agent 节点 - Slave 节点</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#内置-Jenkins-Master-接入内部-K8s-集群"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">内置 Jenkins Master 接入内部 K8s 集群</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#独立Jenkins-Master节点接入外部K8s集群"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text">独立Jenkins Master节点接入外部K8s集群</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-补充说明"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x03 补充说明</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-K8s-集群中对搭建的Jenkins进行版本升级"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">(1) K8s 集群中对搭建的Jenkins进行版本升级</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-移植其他Jenkins机器上的插件到Kubernetes安装的Jenkins中然后进行重新Jenkins-需要非常注意版本问题"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">(2) 移植其他Jenkins机器上的插件到Kubernetes安装的Jenkins中然后进行重新Jenkins(需要非常注意版本问题-)</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-入坑出坑"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x04 入坑出坑</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题1-在K8s中安装Jenkins时报错从logs日志显示Can-not-write-to-var-jenkins-home-copy-reference-file-log-Wrong-volume-permissions-错误"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">问题1.在K8s中安装Jenkins时报错从logs日志显示Can not write to &#x2F;var&#x2F;jenkins_home&#x2F;copy_reference_file.log. Wrong volume permissions?错误</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题2-Jenkins调用节点执行任务时java-lang-IllegalStateException-Agent-is-not-connected-after-100-seconds-status-Running报错导致不断重启"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">问题2.Jenkins调用节点执行任务时java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: Running报错导致不断重启</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题3-基于-Kubernetes-部署-Jenkins-动态-slave-后，运行-Jenkins-Job-会抛java-nio-channels-ClosedChannelException"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">问题3.基于 Kubernetes 部署 Jenkins 动态 slave 后，运行 Jenkins Job 会抛java.nio.channels.ClosedChannelException</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- 微信公众号关注/文章版权复制 -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">博主Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">博主Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">墨天轮</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">西瓜视频</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=《4.Jenkins进阶之分布式架构环境配置》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=《4.Jenkins进阶之分布式架构环境配置》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《4.Jenkins进阶之分布式架构环境配置》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/12-30-531.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKklEQVR42u3aO27kMBAFQN//0nLqYDX7XlM2ILIYGYMxpWLQw/58fcXr+rF+fpJ//+477X8tLQwMjNcyro/r7jv5zskr3h1Q8m4YGBjnMNqtk0B8F1LXwzoGBgbGjPF5n9krYmBgYDzFyMNlEqAxMDAwVpLYFv/s0TyWi2NgYLyQMSuc/c3fv9LfwMDAeBXjKldS9J+Fy2thYWBg7M3IA1xLavdpAy4GBsY5jNmAxSzURic6anxiYGDszcj/LSnff/48KdK1Yxz/+d3AwMDYiDELr0lJbpYMJ88qGpkYGBgvZ+SBMm8YrHwyK8xhYGDszchLab9S54v3iY4VAwNjU0ZSbmuHwGa7JYDbPTEwMA5mtOnorKmZH9PtFRMDA+MARltKy4cq8nR3JZRjYGDszVi55M3GL9q2ZTFsgYGBsTUjecB607HF1yEbAwNjU0b+4Fkzsm0VFL8P7aljYGC8lrFysctboeu86JqIgYFxJKMt2bdp6rPPwsDAOIeRF8Ly0ljeIl05SgwMjDMZS63EEj8L3HXXFAMD4+WMfPArL4q1pf9ZqxUDA2NvxlWu5KI2e9225PePSyEGBsamjFmzMx+2yIfD8mGO5IqJgYGxH2MWZFvYLPUt0l0MDIwDGMl1rU1ok+ZB+wtwi8TAwMB4qPSWJ6V1EouBgYFRBs38JdoBjocDLgYGxqsYSRKbDEO0AxazRBoDA+M0xlNjEwl11jB4rJGJgYHxPsY32xCyUPAdejMAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// 站点运行时间
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "天" + RunHours + "时" + RunMinutes + "分" + RunSeconds + "秒";
  document.getElementById(id).innerHTML = "网站已在风雨中勉勉强强运行了【" + RunTime + "】";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>