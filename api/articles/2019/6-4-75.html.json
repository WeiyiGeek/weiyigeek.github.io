{"title":"SSH远程连接服务安装与介绍","slug":"系统运维/Application/Connect/SSH远程连接服务安装与配置","date":"2019-06-04T05:34:30.000Z","updated":"2023-03-10T02:52:56.733Z","url":"2019/6-4-75.html","path":"api/articles/2019/6-4-75.html.json","covers":["https://img.weiyigeek.top/2019/20190723094808.png","https://img.weiyigeek.top/2019/20190703211256.png","https://img.weiyigeek.top/2019/20190723111244.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-快速入门\"><a href=\"#0x00-快速入门\" class=\"headerlink\" title=\"0x00 快速入门\"></a>0x00 快速入门</h2><p>SSH(Secure Shell,安全外壳协议)命令是openssh套件中的客户端连接工具，采用了非对称加密算法aymmetric encryption algorithm实现安全的远程登录服务器;<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190723094808.png\" alt=\"WeiyiGeek.ssh安全外壳协议\" title=\"\" class=\"\">\n                <p>WeiyiGeek.ssh安全外壳协议</p>\n            </figure><br>SCP(Secure Copy Protocol)Linux机器间的文件传递最简单最安全的方式scp命令</p>\n<hr>\n<h2 id=\"0x01-安全配置\"><a href=\"#0x01-安全配置\" class=\"headerlink\" title=\"0x01 安全配置\"></a>0x01 安全配置</h2><p><strong>ssh服务安装</strong>：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Debian 系</span></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install -y openssh-server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Redhat 系</span></span><br><span class=\"line\">sudo yum update</span><br><span class=\"line\">sudo yum install -y openssh-server</span><br><span class=\"line\">sudo dnf install -y openssh-server</span><br></pre></td></tr></table></figure></p>\n<p><strong>服务启动/自启设置</strong>：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span>/<span class=\"built_in\">disable</span> sshd  <span class=\"comment\"># 自启启用或禁用</span></span><br><span class=\"line\">systemctl start sshd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.</span></span><br><span class=\"line\"><span class=\"comment\"># chkconfig ssh on/off         # 自启启用或禁用               </span></span><br><span class=\"line\"><span class=\"comment\"># service ssh start</span></span><br><span class=\"line\"><span class=\"comment\"># /etc/init.d/ssh start</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># kail-Deban自启服务</span></span><br><span class=\"line\"><span class=\"comment\"># update-rc.d ssh enable      #开启自启</span></span><br><span class=\"line\"><span class=\"comment\"># update-rc.d ssh disabled    #关闭自启</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看启动状态以及进程</span></span><br><span class=\"line\">systemctl status sshd</span><br><span class=\"line\">sudo ps -e | grep ssh</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>配置文件 <code>/etc/ssh/sshd_config</code> 说明：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(1)基础配置</span></span><br><span class=\"line\">Port 20222    <span class=\"comment\"># SSH 预设使用 22 端口，建议更改默认的通信端口，例如20222</span></span><br><span class=\"line\">Protocol 2　 <span class=\"comment\"># 选择的SSH协议版本2,如果要同时支持两者，就必须要使用 2,1 这个分隔</span></span><br><span class=\"line\"><span class=\"comment\">#ListenAddress 0.0.0.0　　     #监听的来自主机网卡的所有请求</span></span><br><span class=\"line\">ListenAddress 192.168.0.100   <span class=\"comment\">#只监听来自 192.168.0.100 这个 IP 的SSH联机，如果不使用设定的话，则预设所有接口均接受 SSH</span></span><br><span class=\"line\">PidFile /var/run/sshd.pid　　　<span class=\"comment\">#可以放置 SSHD 这个 PID 的档案！左列为默认值</span></span><br><span class=\"line\">LoginGraceTime 60              <span class=\"comment\"># 当使用者连上 SSH server 之后，会出现输入密码的画面在多久时间内没有成功连上 SSH server 就断线！时间为秒！</span></span><br><span class=\"line\">Compression yes　　　　　　     <span class=\"comment\"># 是否可以使用压缩指令 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(2)关于 version 1 的一些设定</span></span><br><span class=\"line\">KeyRegenerationInterval 3600　 　　　<span class=\"comment\"># 由前面联机的说明可以知道， version 1 会使用 server 的 Public Key ，那么如果这个 Public </span></span><br><span class=\"line\">　　　　　　　　　　　　　　　　　　    <span class=\"comment\"># Key 被偷的话，岂不完蛋？所以需要每隔一段时间，来重新建立一次！这里的时间为秒！</span></span><br><span class=\"line\">ServerKeyBits 768 　　　　　　　　　   <span class=\"comment\"># Server key 的长度！</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(3)关于登录文件的讯息数据放置与 daemon 的名称</span></span><br><span class=\"line\">SyslogFacility AUTH　<span class=\"comment\"># 当有人使用 SSH 登入系统的时候，SSH会记录资讯，这个信息要记录在什么 daemon name 底下？</span></span><br><span class=\"line\"><span class=\"comment\">#预设是以 AUTH 来设定的，即是 /var/log/secure 里面！</span></span><br><span class=\"line\"><span class=\"comment\">#Linux 基础其它可用的 daemon name 为：DAEMON,USER,AUTH, LOCAL0,LOCAL1,LOCAL2,LOCAL3,LOCAL4,LOCAL5,</span></span><br><span class=\"line\">LogLevel INFO　　 <span class=\"comment\"># 登录记录的等级！任何讯息！</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(4)安全设定项目</span></span><br><span class=\"line\"><span class=\"comment\"># 4.1登入设定部分</span></span><br><span class=\"line\">PermitRootLogin no　　 　　<span class=\"comment\"># 是否允许 root 登入！预设是允许的，但是建议设定成 no！</span></span><br><span class=\"line\">UserLogin no　　　　　　　 <span class=\"comment\"># 在 SSH 底下本来就不接受 login 这个程序的登入！</span></span><br><span class=\"line\">StrictModes yes　　　　　　<span class=\"comment\"># 当使用者的 host key 改变之后，Server 就不接受联机，可以抵挡部分的木马程序！</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#说明主机的 Private Key 放置的档案，预设使用下面的档案即可</span></span><br><span class=\"line\">HostKey /etc/ssh/ssh_host_key　　　　<span class=\"comment\"># SSH version 1 使用的私钥</span></span><br><span class=\"line\">HostKey /etc/ssh/ssh_host_rsa_key　　<span class=\"comment\"># SSH version 2 使用的 RSA 私钥</span></span><br><span class=\"line\">HostKey /etc/ssh/ssh_host_dsa_key　　<span class=\"comment\"># SSH version 2 使用的 DSA 私钥</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.2 认证部分</span></span><br><span class=\"line\">RhostsAuthentication no　　<span class=\"comment\"># 本机系统不止使用 .rhosts ，因为仅使用 .rhosts 太 不安全了，所以这里一定要设定为 no ！</span></span><br><span class=\"line\">IgnoreRhosts yes　　　　　  <span class=\"comment\"># 是否取消使用 ~/.ssh/.rhosts 来做为认证！当然是！</span></span><br><span class=\"line\">RhostsRSAAuthentication no <span class=\"comment\"># 这个选项是专门给 version 1 用的，使用 rhosts 档案在# /etc/hosts.equiv配合 RSA 演算方式来进行认证！不要使用</span></span><br><span class=\"line\">HostbasedAuthentication no <span class=\"comment\"># 这个项目与上面的项目类似，不过是给 version 2 使用的！</span></span><br><span class=\"line\">IgnoreUserKnownHosts no　  <span class=\"comment\"># 是否忽略家目录内的 ~/.ssh/known_hosts 这个档案所记录主机内容？当然不要忽略，所以这里就是 no 啦！</span></span><br><span class=\"line\"></span><br><span class=\"line\">PasswordAuthentication yes  <span class=\"comment\"># 密码验证当然是需要的！所以这里写 yes 啰！</span></span><br><span class=\"line\">PermitEmptyPasswords no　　 <span class=\"comment\"># 若上面那一项如果设定为 yes 的话，这一项就最好设定 为 no，是否允许以空的密码登入！当然不许！</span></span><br><span class=\"line\">ChallengeResponseAuthentication yes  <span class=\"comment\"># 挑战任何的密码认证！所以，任何 login.conf 规定的认证方式，均可适用！</span></span><br><span class=\"line\"><span class=\"comment\">#PAMAuthenticationViaKbdInt yes      # 是否启用其它的 PAM 模块！启用这个模块将会导致 PasswordAuthentication 设定失效！</span></span><br><span class=\"line\"><span class=\"comment\">#RSAAuthentication yes　　 # 是否使用纯的 RSA 认证！？仅针对 version 1 ！</span></span><br><span class=\"line\">PubkeyAuthentication yes　  <span class=\"comment\"># 是否允许 Public Key ？当然允许啦！只有 version 2</span></span><br><span class=\"line\">AuthorizedKeysFile      .ssh/authorized_keys    <span class=\"comment\"># 上面这个在设定若要使用不需要密码登入的账号时，那么那个账号的存放档案所在档名！</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.3 与 Kerberos 有关的参数设定！因为我们没有 Kerberos 主机，所以底下不用设定！</span></span><br><span class=\"line\">KerberosAuthentication no</span><br><span class=\"line\">KerberosOrLocalPasswd yes</span><br><span class=\"line\">KerberosTicketCleanup yes</span><br><span class=\"line\">KerberosTgtPassing no</span><br><span class=\"line\">　</span><br><span class=\"line\"><span class=\"comment\"># 4.4 底下是有关在 X-Window 底下使用以及转发代理相关设定！</span></span><br><span class=\"line\">X11Forwarding yes</span><br><span class=\"line\">X11DisplayOffset 10</span><br><span class=\"line\">X11UseLocalhost yes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.5 登入后的项目：</span></span><br><span class=\"line\">PrintMotd no     <span class=\"comment\"># 登入后是否显示出一些信息呢？例如上次登入的时间、地点等等，预设是 yes ，但是，如果为了安全，可以考虑改为 no ！</span></span><br><span class=\"line\">PrintLastLog yes <span class=\"comment\"># 显示上次登入的信息！可以啊！预设也是 yes ！</span></span><br><span class=\"line\">KeepAlive yes　　 <span class=\"comment\"># 一般而言，如果设定这项目的话，那么 SSH Server 会传送 KeepAlive 的讯息给 Client 端，以确保两者的联机正常！</span></span><br><span class=\"line\">　　　　　　　　　 <span class=\"comment\"># 在这个情况下，任何一端死掉后， SSH 可以立刻知道！而不会有僵尸程序的发生！</span></span><br><span class=\"line\">UsePrivilegeSeparation yes <span class=\"comment\"># 使用者的权限设定项目！就设定为 yes 吧！</span></span><br><span class=\"line\">MaxStartups 10　　　　　　<span class=\"comment\"># 同时允许几个尚未登入的联机画面？当我们连上 SSH ，尚未输入密码时，这个时候就是我们所谓的联机画面啦！</span></span><br><span class=\"line\">　　　　　　　　　　　　　<span class=\"comment\"># 在这个联机画面中，为了保护主机，所以需要设定最大值，预设最多十个联机画面，而已经建立联机的不计算在这十个当中</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.6 关于使用者抵挡的设定项目：</span></span><br><span class=\"line\">DenyUsers *　　　　　　　 <span class=\"comment\"># 设定受抵挡的使用者名称，如果是全部的使用者，那就是全部 挡吧！若是部分使用者，可以将该账号填入！例如下列！</span></span><br><span class=\"line\">DenyUsers <span class=\"built_in\">test</span></span><br><span class=\"line\">DenyGroups <span class=\"built_in\">test</span>　　　　　 <span class=\"comment\"># 与 DenyUsers 相同！仅抵挡几个群组而已！</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.7 配置SSH加密套件</span></span><br><span class=\"line\">Ciphers aes256-ctr,aes128-ctr,aes192-ctr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.8 未禁用环境处理</span></span><br><span class=\"line\">PermitUserEnvironment no</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.9 配置SSH失败尝试</span></span><br><span class=\"line\">MaxAuthTries</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5. 关于 SFTP 服务的设定项目！</span></span><br><span class=\"line\">Subsystem      sftp    /usr/lib/ssh/sftp-server</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>ssh密匙认证</strong><br>原理：密匙认证需要依靠密匙，首先创建一对密匙（包括pub公匙和pri密匙，并且用公匙加密的数据只能用密匙解密），并把公匙放到需要远程服务器上。这样当登录远程服务器时，客户端软件就会向服务器发出请求，请求用你的密匙进行认证。<br>服务器收到请求之后，先在你在该服务器的宿主目录下寻找你的公匙 <code>authrozied_keys 和 knows_hosts</code>，然后检查该公匙是否是合法，<code>如果合法就用公匙加密一随机数（即所谓的challenge）并发送给客户端软件，客户端软件收到 “challenge”之后就用私匙解密再把它发送给服务器，因为用公匙加密的数据只能用密匙解密</code>，服务器经过比较就可以知道该客户连接的合法性。</p>\n<p>实验环境：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">客户机：172.16.142.4</span><br><span class=\"line\">远端主机：172.16.142.5</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>Step1-修改配置文件(远端主机)<br>要使ssh既能够通过证书免密码登陆，又不影响通过用户名口令登陆，需要对远端主机ssh进行配置，<code>配置文件为：/etc/ssh/sshd_config</code><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RSAAuthentication yes  <span class=\"comment\">#ssh v1</span></span><br><span class=\"line\">PubkeyAuthentication yes  <span class=\"comment\">#ssh v2</span></span><br><span class=\"line\">ServerKeyBits 1024</span><br><span class=\"line\">PasswordAuthentication yes <span class=\"comment\">#关键点</span></span><br><span class=\"line\">PermitRootLogin yes</span><br><span class=\"line\">UsePAM no</span><br></pre></td></tr></table></figure>\n配置完成后执行命令 service sshd restart 来重启ssh</li>\n</ul>\n<ul>\n<li><p>Step2-本地生成密匙(客户机)<br>在客户机以root用户执行下述命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost .ssh]<span class=\"comment\"># /usr/bin/ssh-keygen -t rsa -P </span></span><br><span class=\"line\">Generating public/private rsa key pair.</span><br><span class=\"line\">Enter file <span class=\"keyword\">in</span> <span class=\"built_in\">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class=\"line\">Enter passphrase (empty <span class=\"keyword\">for</span> no passphrase): </span><br><span class=\"line\">Enter same passphrase again: </span><br><span class=\"line\"><span class=\"comment\"># Your identification has been saved in /root/.ssh/id_rsa.  #私钥</span></span><br><span class=\"line\"><span class=\"comment\"># Your public key has been saved in /root/.ssh/id_rsa.pub.</span></span><br><span class=\"line\">The key fingerprint is:</span><br><span class=\"line\">30:f6:d7:2a:ac:56:eb:3f:fa:40:25:8d:90:96:68:cb root@localhost.localdomain</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step3-远程配置文件上传(远端主机)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost .ssh]<span class=\"comment\"># scp /root/.ssh/id_rsa.pub root@172.16.142.5:/root/.ssh/authorized_keys</span></span><br><span class=\"line\">root@172.16.142.5 password:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#或者采用</span></span><br><span class=\"line\">ssh-copy-id root@172.16.142.5</span><br></pre></td></tr></table></figure>\n<p>说明：将公钥拷贝到远端主机，并写入授权列表文件，你也可以把公钥文件拷贝过去后，在远端主机下直接执行；</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch /root/.ssh/authorized_keys</span><br><span class=\"line\">cat /root/.ssh/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#操作完毕，登陆检查。 </span></span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># ssh 172.16.142.5</span></span><br><span class=\"line\">Last login: Sat Dec 15 21:10:17 2007 from 172.16.142.4</span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># </span></span><br><span class=\"line\">无密码SSH登陆成功！</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x02-命令详细\"><a href=\"#0x02-命令详细\" class=\"headerlink\" title=\"0x02 命令详细\"></a>0x02 命令详细</h2><p><strong>ssh 命令</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh [选项] host参数 <span class=\"string\">'命令'</span></span><br><span class=\"line\">ssh root@ip</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#选项</span></span><br><span class=\"line\">-1：强制使用ssh协议版本1；</span><br><span class=\"line\">-2：强制使用ssh协议版本2；</span><br><span class=\"line\">-4：强制使用IPv4地址；</span><br><span class=\"line\">-6：强制使用IPv6地址；</span><br><span class=\"line\">-A：开启认证代理连接转发功能；</span><br><span class=\"line\">-a：关闭认证代理连接转发功能；</span><br><span class=\"line\">-b：使用本机指定地址作为对应连接的源ip地址 <span class=\"comment\">#(代理转发使用)</span></span><br><span class=\"line\">-C：请求压缩所有数据；</span><br><span class=\"line\">-D: 指定绑定地址和端口 <span class=\"comment\">#(代理转发使用)</span></span><br><span class=\"line\">-F：指定ssh指令的配置文件；</span><br><span class=\"line\">-f：后台执行ssh指令；</span><br><span class=\"line\">-g：允许远程主机连接主机的转发端口；</span><br><span class=\"line\">-i：指定身份文件；</span><br><span class=\"line\">-l：指定连接远程服务器登录用户名；</span><br><span class=\"line\">-N：不执行远程指令；</span><br><span class=\"line\">-o：指定配置选项；</span><br><span class=\"line\">-p：指定远程服务器上的端口；</span><br><span class=\"line\">-q：静默模式；</span><br><span class=\"line\">-X：开启X11转发功能；</span><br><span class=\"line\">-x：关闭X11转发功能；</span><br><span class=\"line\">-y：开启信任X11转发功能。</span><br><span class=\"line\">-T: 表示不分配伪终端,但-T相当于notty,ctrl+C会中断会话</span><br></pre></td></tr></table></figure></p>\n<p>基础示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 示例1.指定连接ssh的用户端口</span></span><br><span class=\"line\">ssh root@192.168.200.250 -p 2222</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例2.命令执行</span></span><br><span class=\"line\">ssh root@10.10.100.221 <span class=\"string\">'hostname -I'</span></span><br><span class=\"line\">Secure login: unauthorized users are not allowed to access the system.</span><br><span class=\"line\">root@10.10.100.221 password:</span><br><span class=\"line\">10.10.100.221</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例3.指定密匙登录</span></span><br><span class=\"line\">ssh root@DROPLET_IP -i /path/to/private_key</span><br><span class=\"line\"><span class=\"comment\">#用户名为root私钥文件路径为~/test，用户名为ubuntu，服务IP为203.111.111.111</span></span><br><span class=\"line\">ssh -i ~/<span class=\"built_in\">test</span> ubuntu@203.111.111.111</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例4.ssh指定用户名和指定shell类型连接(类似于反弹shell-并且不记录命令)</span></span><br><span class=\"line\">ssh -l root 10.10.107.222 /bin/bash</span><br><span class=\"line\"><span class=\"comment\"># id</span></span><br><span class=\"line\"><span class=\"comment\"># uid=0(root) gid=0(root) groups=0(root)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例5.循环命令执行</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> &#123;16..20&#125;;<span class=\"keyword\">do</span></span><br><span class=\"line\"> ssh -p 20211 192.168.1.<span class=\"variable\">$&#123;i&#125;</span> <span class=\"string\">'wget http://192.168.1.1:8000/filebeatInstall.sh -O /tmp/filebeatInstall.sh &amp;&amp; chmod +x /tmp/filebeatInstall.sh &amp;&amp; cd /tmp/ &amp;&amp; bash -c /tmp/filebeatInstall.sh'</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例6.端口映射转发示例</span></span><br><span class=\"line\"><span class=\"comment\"># 1) 监听本地10.10.107.242:8888端口，并将访问请求转发到10.22.0.3:80中</span></span><br><span class=\"line\">ssh -p 20211 -N -v -L 10.10.107.242:8888:10.22.0.3:80 root@10.10.107.242</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>ssh-keygen 命令</strong><br>描述：生成公匙与密匙进行相应的认证<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usage: ssh-keygen [-q] [-b bits] [-t dsa | ecdsa | ed25519 | rsa]</span><br><span class=\"line\">                  [-N new_passphrase] [-C comment] [-f output_keyfile]</span><br><span class=\"line\">       ssh-keygen -p [-P old_passphrase] [-N new_passphrase] [-f keyfile]</span><br><span class=\"line\">       ssh-keygen -i [-m key_format] [-f input_keyfile]</span><br><span class=\"line\">       ssh-keygen -e [-m key_format] [-f input_keyfile]</span><br><span class=\"line\">       ssh-keygen -y [-f input_keyfile]</span><br><span class=\"line\">       ssh-keygen -c [-P passphrase] [-C comment] [-f keyfile]</span><br><span class=\"line\">       ssh-keygen -l [-v] [-E fingerprint_hash] [-f input_keyfile]</span><br><span class=\"line\">       ssh-keygen -B [-f input_keyfile]</span><br><span class=\"line\">       ssh-keygen -D pkcs11</span><br><span class=\"line\">       ssh-keygen -F hostname [-f known_hosts_file] [-l]</span><br><span class=\"line\">       ssh-keygen -H [-f known_hosts_file]</span><br><span class=\"line\">       ssh-keygen -R hostname [-f known_hosts_file]</span><br><span class=\"line\">       ssh-keygen -r hostname [-f input_keyfile] [-g]</span><br><span class=\"line\">       ssh-keygen -G output_file [-v] [-b bits] [-M memory] [-S start_point]</span><br><span class=\"line\">       ssh-keygen -T output_file -f input_file [-v] [-a rounds] [-J num_lines]</span><br><span class=\"line\">                  [-j start_line] [-K checkpt] [-W generator]</span><br><span class=\"line\">       ssh-keygen -s ca_key -I certificate_identity [-h] [-U]</span><br><span class=\"line\">                  [-D pkcs11_provider] [-n principals] [-O option]</span><br><span class=\"line\">                  [-V validity_interval] [-z serial_number] file ...</span><br><span class=\"line\">       ssh-keygen -L [-f input_keyfile]</span><br><span class=\"line\">       ssh-keygen -A</span><br><span class=\"line\">       ssh-keygen -k -f krl_file [-u] [-s ca_public] [-z version_number]</span><br><span class=\"line\">                  file ...</span><br><span class=\"line\">       ssh-keygen -Q -f krl_file file ...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#参数解释</span></span><br><span class=\"line\">-a <span class=\"comment\">#当保存一个新格式的私钥(即ed25519密钥或设置-o标志时的任何SSH协议2密钥)时，此选项指定KDF的数量(增加碰撞难度)</span></span><br><span class=\"line\">-b <span class=\"comment\">#生成指定位数的密匙</span></span><br><span class=\"line\">-l <span class=\"comment\">#显示指定公钥文件的指纹支持私有RSA1密钥。对于RSA和DSA密钥ssh-keygen试图找到匹配的pub-并打印其指纹。如果与-v相结合则提供了密钥的可视ASCII艺术表示。</span></span><br><span class=\"line\">-p <span class=\"comment\">#交互模式输入密码</span></span><br><span class=\"line\">-o <span class=\"comment\">#Ed25519密钥总是使用新的私钥格式，使用新的OpenSSH格式保存私钥而不是更兼容的PEM格式。新格式增加了输入量抵抗暴力破解密码 ( 必须 &gt; 6.5 版本)</span></span><br><span class=\"line\">-t <span class=\"comment\">#指定加密类型生不同类型的密钥： rsa / dsa / ECDAS /ed25519</span></span><br><span class=\"line\">-f <span class=\"comment\">#指定私钥文件文件路径</span></span><br><span class=\"line\">-y <span class=\"comment\">#此选项将读取专用OpenSSH格式文件，并将OpenSSH公钥打印到stdout。</span></span><br></pre></td></tr></table></figure></p>\n<p>实际案例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1.生成带密码的密匙登录认证（安全认证算法Key）</span></span><br><span class=\"line\">ssh-keygen -t dsa -P <span class=\"string\">'123456'</span> -f ~/.ssh/id_dsa   <span class=\"comment\">#(不需要交互执行)</span></span><br><span class=\"line\"></span><br><span class=\"line\">ssh-keygen -t rsa -b 1024 -p  <span class=\"comment\">#命令行设置生成rsa密匙和交换式设置密匙密码 #(需要交互执行)</span></span><br><span class=\"line\">Enter passphrase (empty <span class=\"keyword\">for</span> no passphrase):</span><br><span class=\"line\">Enter same passphrase again:</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成Ed25519算法的key</span></span><br><span class=\"line\">ssh-keygen -o -a 100 -t ed25519 -f ~/.ssh/id_ed25519 -C <span class=\"string\">\"john@example.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2.命令行设置密匙密码并生成密匙</span></span><br><span class=\"line\">ssh-keygen -N <span class=\"string\">\"123456789\"</span></span><br><span class=\"line\">ssh-keygen -P <span class=\"string\">\"123456789\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例3.终端密匙生成的目录文件</span></span><br><span class=\"line\">ssh-keygen -f /testdir/<span class=\"built_in\">test</span>/id_rsa</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例4.根据私钥生成公钥如果密匙有密码则需要输入密码</span></span><br><span class=\"line\">ssh-keygen -f /testdir/<span class=\"built_in\">test</span>/id_rsa -y</span><br><span class=\"line\">ssh-keygen -f /testdir/<span class=\"built_in\">test</span>/id_rsa -y &gt; id_rsa.pub</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例5.当前认证公钥key加密算法及其强度</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> key <span class=\"keyword\">in</span> ~/.ssh/id_*; <span class=\"keyword\">do</span> ssh-keygen -l -f <span class=\"string\">\"<span class=\"variable\">$&#123;key&#125;</span>\"</span> -v; <span class=\"keyword\">done</span> | uniq</span><br><span class=\"line\"><span class=\"comment\"># 2048 SHA256:pF71q3tXhtGx6EOIC/WZVKt/y9q5OCS2NviKlXVO1eY root@master (RSA)</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>scp 命令</strong><br>描述: 注意 scp命令不会进行内容的追加而会覆盖整个文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#语法：</span></span><br><span class=\"line\">scp [-r] 用户名@机器ip:文件路径 本地路径  <span class=\"comment\"># 下载文件或[文件夹]</span></span><br><span class=\"line\">scp [-r] 本地文件  用户名@机器ip:上传的文件路径  <span class=\"comment\"># 上传文件或[文件夹]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#参数</span></span><br><span class=\"line\">-r 表示目录</span><br><span class=\"line\">-P 指定端口(大写)</span><br></pre></td></tr></table></figure>\n<p>基础示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\"><span class=\"variable\">$scp</span> root@192.168.133.129:/root/index.html c:\\\\index.html   <span class=\"comment\">#注意Windows指定路径时候需要转义符号 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 上传</span></span><br><span class=\"line\"><span class=\"variable\">$scp</span> nssock2.zip root@192.168.133.129:/root</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定端口</span></span><br><span class=\"line\"><span class=\"variable\">$scp</span> -P 18768 Architecture.c root@23.106.133.193:/root</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 覆盖已存储的文件</span></span><br><span class=\"line\">~$ <span class=\"built_in\">echo</span> 1024 &gt; 1.txt</span><br><span class=\"line\">~$ scp -P 20211 1.txt weiyigeek@weiyigeek-108:~</span><br><span class=\"line\">**************WARNING**************</span><br><span class=\"line\">Authorized only. All activity will be monitored and reported.</span><br><span class=\"line\">1.txt     100%    5    13.2KB/s   00:00</span><br><span class=\"line\">~$ <span class=\"built_in\">echo</span> 1111 &gt; 1.txt</span><br><span class=\"line\">~$ scp -P 20211 1.txt weiyigeek@weiyigeek-108:~</span><br><span class=\"line\">**************WARNING**************</span><br><span class=\"line\">Authorized only. All activity will be monitored and reported.</span><br><span class=\"line\">1.txt     100%    5    13.9KB/s   00:00</span><br><span class=\"line\">~$ ssh -p 20211 weiyigeek@weiyigeek-108 <span class=\"string\">\"cat 1.txt\"</span></span><br><span class=\"line\">**************WARNING**************</span><br><span class=\"line\">Authorized only. All activity will be monitored and reported.</span><br><span class=\"line\">1111</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>ssh-add 命令</strong><br>描述：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 加载私有密匙到 ssh-agent 密匙管理即默认采用此密钥进行访问操作</span></span><br><span class=\"line\">&gt; ssh-agent zsh</span><br><span class=\"line\">&gt; ssh-add ~/.ssh/id_develop</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>scp-copy-id 命令</strong><br>描述：进行密匙的拷贝后面就能采用免密码登录;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基础语法</span></span><br><span class=\"line\">/usr/bin/ssh-copy-id [-h|-?|-f|-n] [-i [identity_file]] [-p port] [[-o &lt;ssh -o options&gt;] ...] [user@]hostname</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#参数</span></span><br><span class=\"line\">- i 指定认证文件</span><br><span class=\"line\">- o 指定ssh协议选项</span><br></pre></td></tr></table></figure></p>\n<p>基础示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1.将生成的公匙存入到对端的机器的.ssh/authorized_keys</span></span><br><span class=\"line\"><span class=\"variable\">$ssh</span>-copy-id -i /root/.ssh/id_rsa.pub root@10.10.107.234  <span class=\"comment\">#指定公匙文件</span></span><br><span class=\"line\">.ssh&gt; ssh-copy-id root@10.10.107.221  <span class=\"comment\">#或者 cp id_rsa.pub authorized_keys</span></span><br><span class=\"line\"><span class=\"comment\"># .ssh&gt; ssh 'root@10.10.107.221'</span></span><br><span class=\"line\"><span class=\"comment\"># Secure login: unauthorized users are not allowed to access the system.</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2.一步到位</span></span><br><span class=\"line\">cat ~/.ssh/id_rsa.pub | ssh -p 22 zsy@10.1.0.3 <span class=\"string\">\"umask 077;mkdir -p ~/.ssh;cat - &gt;&gt; ~/.ssh/authorized_keys\"</span></span><br><span class=\"line\"><span class=\"comment\">#一般是把本地生成的密匙复制到远程主机上authorized_keys文件中</span></span><br><span class=\"line\">[root@slave ~]<span class=\"variable\">$cat</span> .ssh/authorized_keys <span class=\"comment\">#同时记录连接的IP </span></span><br><span class=\"line\">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINDMnJ7QL1PXaWI63is2wqj9HG7Gc/AxT07F4RRujyPR ubuntu@WeiyiGeek</span><br><span class=\"line\"><span class=\"comment\">#将每个你访问过计算机的公钥(public key)都记录在~/.ssh/known_hosts [Centos]</span></span><br><span class=\"line\">[root@slave .ssh]<span class=\"comment\"># cat known_hosts</span></span><br><span class=\"line\">10.10.107.222 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJABL46Qd7sXwu/GW2+8KCNRfUXzh+6EGKnheq6+o+Uhp4PCt6M2/pMuV2mPfeIAsE/cYL1X0vYOtLrLG3Wjun0=</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#当ssh服务器未使用默认端口号时，使用如下命令</span></span><br><span class=\"line\">centos6中：ssh-copy-id -i ~/.ssh/id_rsa.pub <span class=\"string\">\"zsy@10.1.0.3 -p 22222\"</span></span><br><span class=\"line\">centos7中：ssh-copy-id -i ~/.ssh/id_rsa.pub zsy@10.1.0.3 -p 22222</span><br></pre></td></tr></table></figure></p>\n<p>使用 known_hosts 优缺点</p>\n<ul>\n<li>1.需要每次手动删除文件内容，一些自动化脚本的无法运行（在SSH登陆时失败），但是安全性高； </li>\n<li>2.SSH登陆时会忽略known_hsots的访问，但是安全性低；</li>\n</ul>\n<hr/>\n\n<h2 id=\"0x03-进阶使用\"><a href=\"#0x03-进阶使用\" class=\"headerlink\" title=\"0x03 进阶使用\"></a>0x03 进阶使用</h2><hr/>\n\n<h2 id=\"0x04-补充说明\"><a href=\"#0x04-补充说明\" class=\"headerlink\" title=\"0x04 补充说明\"></a>0x04 补充说明</h2><p><strong>在ssh中设置登录提示信息</strong><br>/etc/issue.net        #远程登录信息显示 不支持转义字符 只支持普通文本.是否显示欢迎信息，由ssh的配置文件/etc/ssh/sshd_config决定<br>/etc/motd               #本地或远程都可显示欢迎信息<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#修改Terminal login时得提示: 在/etc/ssh/sshd_config添加“Banner /etc/ssh/ssh_login_banner” 或者 Banner /etc/issue</span></span><br><span class=\"line\">/etc/issue     <span class=\"comment\">#本地登录信息显示</span></span><br><span class=\"line\">\\d : Show Current System 日期</span><br><span class=\"line\">\\S : 名称</span><br><span class=\"line\">\\l ：登录时终端编号</span><br><span class=\"line\">\\m ：硬件体系架构</span><br><span class=\"line\">\\n : 显示主机名</span><br><span class=\"line\">\\o : 显示域名</span><br><span class=\"line\">\\r : 显示内核kernel版本</span><br><span class=\"line\">\\t : 显示当前时间</span><br><span class=\"line\">\\u : 当前登录用户的序列号</span><br></pre></td></tr></table></figure><br>实际案例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;Authorized uses only. 您的所有活动均被监测和报告.&quot;&gt; &#x2F;etc&#x2F;issue</span><br><span class=\"line\">echo &quot;Authorized uses only. 您的所有活动均被监测和报告.&quot;&gt; &#x2F;etc&#x2F;issue.net</span><br><span class=\"line\">echo &quot;Authorized uses only. All activity may be monitored  and reported.&quot; &gt;&gt;&#x2F;etc&#x2F;motd</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190703211256.png\" alt=\"WeiyiGeek.issuenet\" title=\"\" class=\"\">\n                <p>WeiyiGeek.issuenet</p>\n            </figure></p>\n<p><br></p>\n<p><strong>用SecureCRT进行免密码登陆</strong><br>(1)将BT5生成的公私钥文件拷到windows本机上，打开SecureCRT新建session,配置服务器的基本信息后连接，当然这个时候是不会成功的。<br>(2)右键失败的session，选择“Session Options”—-&gt;”SSH2″—&gt;”PublicKey”—&gt;”Properties”后选择生成的私钥文件<br>选择完后，点击“ok”后，右键“Reconnect”即可成功登陆。</p>\n<p><br></p>\n<p><strong>云服务器 SSH-KEY公匙/密匙登录</strong><br>生成公匙和密匙：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置config文件，详细请参考从本地Linux机器登录到Linux云服务器（无公网IP）中的STEP1 /etc/ssh/ssh_config 文件</span></span><br><span class=\"line\"><span class=\"comment\">#找到ForwardAgent项，并设置为yes</span></span><br><span class=\"line\">chmod 400 私钥文件              <span class=\"comment\">#将您的私钥文件设置权限为400</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span> `ssh-agent`                      <span class=\"comment\">#启动ssh-agent</span></span><br><span class=\"line\">ssh-add                                   <span class=\"comment\">#加载私钥</span></span><br><span class=\"line\">ssh -i 私钥文件 系统管理员@服务器IP       <span class=\"comment\">#对于ubuntu系统管理员为ubuntu；</span></span><br><span class=\"line\">ssh -i ~/<span class=\"built_in\">test</span> ubuntu@203.111.111.111          <span class=\"comment\">#centos，debian，suse用</span></span><br></pre></td></tr></table></figure><br>利用公匙登录<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/root/.ssh/authorizeb_keys      <span class=\"comment\">#将A机生成的.pub添加到authorizeb_keys</span></span><br><span class=\"line\">chmod 600 /root/.ssh/authorizeb_keys <span class=\"comment\">#新建文件权限加入600</span></span><br><span class=\"line\">/etc/init.d/start                 <span class=\"comment\">#启动secure shell</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>自定义SSH版本信息</strong><br>描述：默认情况下telnet ip 22 端口会显示 openssh的版本信息<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#搜索可执行文档和路径</span></span><br><span class=\"line\"><span class=\"variable\">$whereis</span> sshd</span><br><span class=\"line\">sshd: /usr/sbin/sshd /usr/share/man/man8/sshd.8.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#替换二进制文件中的版本信息</span></span><br><span class=\"line\">cp /usr/sbin/sshd /usr/sbin/sshd2016.bak              <span class=\"comment\">#复制前需要进行备份</span></span><br><span class=\"line\">sed -i <span class=\"string\">'s/OpenSSH_4.2/OpenSSH_8.2/g'</span> /usr/sbin/sshd   <span class=\"comment\">#关键点</span></span><br><span class=\"line\">service restart sshd</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"variable\">$telnet</span> 22端口测试banner信息</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>ssh避免首次登录服务时候需要输入yes，这时我们可以将StrictHostKeyChecking修改为no</strong><br>方式1.配置文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/ssh/ssh_config</span><br><span class=\"line\">Host *</span><br><span class=\"line\">        GSSAPIAuthentication yes</span><br><span class=\"line\"><span class=\"comment\"># If this option is set to yes then remote X11 clients will have full access</span></span><br><span class=\"line\"><span class=\"comment\"># to the original X11 display. As virtually no X11 client supports the untrusted</span></span><br><span class=\"line\"><span class=\"comment\"># mode correctly we set this to yes.</span></span><br><span class=\"line\">        ForwardX11Trusted yes</span><br><span class=\"line\"><span class=\"comment\"># Send locale-related environment variables</span></span><br><span class=\"line\">        SendEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES</span><br><span class=\"line\">        SendEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT</span><br><span class=\"line\">        SendEnv LC_IDENTIFICATION LC_ALL LANGUAGE</span><br><span class=\"line\">        SendEnv XMODIFIERS</span><br><span class=\"line\">        StrictHostKeyChecking no  关键点</span><br></pre></td></tr></table></figure></p>\n<p>方式2.命令行方式<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 首先连接主机并且不校验主机</span></span><br><span class=\"line\">ssh -oStrictHostKeyChecking=no root@weiyigeek</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 之后在主机和ip地址之间生成正确的映射</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> domain <span class=\"keyword\">in</span> <span class=\"string\">\"github.com\"</span> <span class=\"string\">\"bitbucket.org\"</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">    sed -i <span class=\"string\">\"/<span class=\"variable\">$domain</span>/d\"</span> ~/.ssh/known_hosts</span><br><span class=\"line\">    line=$(ssh-keyscan <span class=\"variable\">$domain</span>,`nslookup <span class=\"variable\">$domain</span> | awk <span class=\"string\">'/^Address: / &#123; print $2 ; exit &#125;'</span>`)</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"variable\">$line</span> &gt;&gt; ~/.ssh/known_hosts</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x06-加固脚本\"><a href=\"#0x06-加固脚本\" class=\"headerlink\" title=\"0x06 加固脚本\"></a>0x06 加固脚本</h2><p><strong>Shell 脚本一览</strong>:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\"[-] 系统sshd服务安全策略设置.\"</span></span><br><span class=\"line\"><span class=\"comment\"># 备份文件</span></span><br><span class=\"line\">BACKUPDIR=/tmp/</span><br><span class=\"line\">cp -a /etc/ssh/sshd_config <span class=\"variable\">$&#123;BACKUPDIR&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 服务端口</span></span><br><span class=\"line\">VAR_SSHD_PORT=20222</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 0.设置SSH登录前Banner警告提示</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*(banner|Banner)\\s+\\W+.*$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*(banner|Banner)\\s+\\W+.*$/Banner \\/etc\\/issue.net/\"</span> /etc/ssh/sshd_config || \\</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"Banner /etc/issue.net\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.设置SSH禁止root远程登录（推荐配置-但还是要根据需求配置）</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^\\s*PermitRootLogin\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*PermitRootLogin\\s+.+$/PermitRootLogin no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"PermitRootLogin no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.设置SSH严格模式</span></span><br><span class=\"line\">sudo egrep -q <span class=\"string\">\"^(#)?\\s*StrictModes\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*StrictModes\\s+.+$/StrictModes yes/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"StrictModes yes\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.更改SSH服务端口</span></span><br><span class=\"line\">sudo egrep -q <span class=\"string\">\"^(#)?\\s*Port\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*Port\\s+.+$/Port <span class=\"variable\">$&#123;VAR_SSHD_PORT&#125;</span>/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"Port <span class=\"variable\">$&#123;VAR_SSHD_PORT&#125;</span>\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.关闭禁用用户的 .rhosts 文件 ~/.ssh/.rhosts 来做为认证，缺省 IgnoreRhosts yes.</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*IgnoreRhosts\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*IgnoreRhosts\\s+.+$/IgnoreRhosts yes/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"IgnoreRhosts yes\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*HostbasedAuthentication \\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*HostbasedAuthentication \\s+.+$/HostbasedAuthentication  no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"HostbasedAuthentication no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.设置安全协议版本</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*Protocol\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*Protocol\\s+.+$/Protocol 2/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"Protocol 2\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6.设置日志等级 默认是VERBOSE,设置为INFO</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*LogLevel\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*LogLevel\\s+.+$/LogLevel INFO/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"LogLevel INFO\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7.禁用空密码用户登录</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*PermitEmptyPasswords\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*PermitEmptyPasswords\\s+.+$/PermitEmptyPasswords no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"PermitEmptyPasswords no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 8.配置失败尝试次数（此处，设置为5次）</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*MaxAuthTries\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*MaxAuthTries\\s+.+$/MaxAuthTries 5/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"MaxAuthTries 5\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 9.配置连接空闲超时 (每120s进行心跳连接测试，若三次失败则断开链接)</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*ClientAliveInterval\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*ClientAliveInterval\\s+.+$/ClientAliveInterval 120/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"ClientAliveInterval 120\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*ClientAliveCountMax\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*ClientAliveCountMax\\s+.+$/ClientAliveCountMax 3/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"ClientAliveCountMax 5\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 10.不允许用户向ssh守护程序呈现环境</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*PermitUserEnvironment\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*PermitUserEnvironment\\s+.+$/PermitUserEnvironment no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"PermitUserEnvironment no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 11.设置SSH强加密算法</span></span><br><span class=\"line\">egrep <span class=\"string\">\"^\\s*Ciphers\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^\\s*Ciphers\\s+.+$/Ciphers aes256-ctr,aes128-ctr,aes192-ctr,aes128-gcm@openssh.com,aes256-gcm@openssh.com/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"Ciphers aes256-ctr,aes128-ctr,aes192-ctr,aes128-gcm@openssh.com,aes256-gcm@openssh.com\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 12.设置成功验证SSH服务器的时间为一分钟或更短</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?\\s*LoginGraceTime\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*LoginGraceTime\\s+.+$/LoginGraceTime 60/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"LoginGraceTime 60\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 13.禁用X11转发及端口转发</span></span><br><span class=\"line\">sudo egrep -q <span class=\"string\">\"^(#)?\\s*X11Forwarding\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*X11Forwarding\\s+.+$/X11Forwarding no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"X11Forwarding no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">sudo egrep -q <span class=\"string\">\"^(#)?\\s*X11UseLocalhost\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*X11UseLocalhost\\s+.+$/X11UseLocalhost yes/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"X11UseLocalhost yes\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">sudo egrep -q <span class=\"string\">\"^(#)?\\s*AllowTcpForwarding\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*AllowTcpForwarding\\s+.+$/AllowTcpForwarding no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"AllowTcpForwarding no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">sudo egrep -q <span class=\"string\">\"^(#)?\\s*AllowAgentForwarding\\s+.+$\"</span> /etc/ssh/sshd_config &amp;&amp; sed -ri <span class=\"string\">\"s/^(#)?\\s*AllowAgentForwarding\\s+.+$/AllowAgentForwarding no/\"</span> /etc/ssh/sshd_config || <span class=\"built_in\">echo</span> <span class=\"string\">\"AllowAgentForwarding no\"</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 14.设置SSH服务配置文件权限</span></span><br><span class=\"line\">chown root:root /etc/ssh/sshd_config </span><br><span class=\"line\">chmod og-rwx /etc/ssh/sshd_config</span><br><span class=\"line\">chown -R root:ssh_keys /etc/ssh/*key </span><br><span class=\"line\">chmod -R 400 /etc/ssh/*key </span><br><span class=\"line\">chown -R root:root /etc/ssh/*key.pub</span><br><span class=\"line\">chmod -R 444 /etc/ssh/*key.pub</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x0n-入坑解救\"><a href=\"#0x0n-入坑解救\" class=\"headerlink\" title=\"0x0n 入坑解救\"></a>0x0n 入坑解救</h2><h3 id=\"问题1-ssh免密码登录Permission-denied-publickey-gssapi-keyex-gssapi-with-mic\"><a href=\"#问题1-ssh免密码登录Permission-denied-publickey-gssapi-keyex-gssapi-with-mic\" class=\"headerlink\" title=\"问题1.ssh免密码登录Permission denied (publickey,gssapi-keyex,gssapi-with-mic)\"></a>问题1.ssh免密码登录Permission denied (publickey,gssapi-keyex,gssapi-with-mic)</h3><p>解决: 首先修改/home/Hadoop/.ssh以及/home/Hadoop/.ssh/authorized_keys的权限；<br>172.16.142.4（客户端）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/home/root文件夹的权限是600</span><br><span class=\"line\">/home/root/.ssh文件夹的权限是600 （好像这个权限关系不是很大）</span><br><span class=\"line\">/home/root/.ssh/id_dsa私钥的权限600</span><br></pre></td></tr></table></figure></p>\n<p>172.16.142.5（远端主机）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 700 /root/.ssh</span><br><span class=\"line\">chmod 644 /root/.ssh/authorized_keys  <span class=\"comment\">#注意后面放Public-KEY的英语不要打错</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"问题2-SSH修改端口报错-error-Bind-to-port-xxx-on-0-0-0-0-failed-Permission-denied-解决方法\"><a href=\"#问题2-SSH修改端口报错-error-Bind-to-port-xxx-on-0-0-0-0-failed-Permission-denied-解决方法\" class=\"headerlink\" title=\"问题2.SSH修改端口报错 error: Bind to port xxx on 0.0.0.0 failed: Permission denied.解决方法\"></a>问题2.SSH修改端口报错 error: Bind to port xxx on 0.0.0.0 failed: Permission denied.解决方法</h3><p>问题原因:Linux修改ssh Port端口后无法启动ssh访问，发现是SELinux导致的问题;<br>解决办法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(1) 永久方法 – 需要重启服务器修改/etc/selinux/config文件中设置</span></span><br><span class=\"line\">SELINUX=disabled</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(2) 临时方法 – 设置系统参数然后重启服务器,使用命令setenforce 0</span></span><br><span class=\"line\">setenforce 1 <span class=\"comment\">#设置SELinux 成为enforcing模式</span></span><br><span class=\"line\">setenforce 0 <span class=\"comment\">#设置SELinux 成为permissive模式</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启sshd服务</span></span><br><span class=\"line\">systemctl restart sshd</span><br></pre></td></tr></table></figure></p>\n<p><em>注意：</em></p>\n<ul>\n<li>此时如果仍提示输入密码，请检查如下文件夹和文件的操作权限，这是非常重要的，否则ssh公钥认证体制不能正常工作</li>\n<li>还有可能是禁用了root登录出现这种情况，当切换到普通用户—Hadoop之后就又能登录了<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190723111244.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n<p>总结: 出现这种警告，我觉得最终的原因是文件夹以及文件的读写权限的问题。</p>\n<p><br></p>\n<h3 id=\"问题3-连接ssh时出现Unable-to-negotiate-with-192-168-XX-XX-port-XXXX-no-matching-key-exchange-method-found-错误。\"><a href=\"#问题3-连接ssh时出现Unable-to-negotiate-with-192-168-XX-XX-port-XXXX-no-matching-key-exchange-method-found-错误。\" class=\"headerlink\" title=\"问题3.连接ssh时出现Unable to negotiate with 192.168.XX.XX port XXXX: no matching key exchange method found.错误。\"></a>问题3.连接ssh时出现<code>Unable to negotiate with 192.168.XX.XX port XXXX: no matching key exchange method found.</code>错误。</h3><p>问题信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh-copy-id gitlab@192.168.2.3</span><br><span class=\"line\">/usr/bin/ssh-copy-id: ERROR: Unable to negotiate with 192.168.2.3 port 22: no matching key exchange method found. Their offer: diffie-hellman-group1-sha1,diffie-hellman-group14-sha1</span><br></pre></td></tr></table></figure><br>问题原因: 找不到匹配的密钥交换方法,需要配置为<code>diffie-hellman-group1-sha1,diffie-hellman-group14-sha1</code><br>解决方法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi ~/.ssh/config</span><br><span class=\"line\">host 192.168.2.3</span><br><span class=\"line\">port 22</span><br><span class=\"line\">KexAlgorithms +diffie-hellman-group1-sha1,diffie-hellman-group14-sha1</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"问题4-在使用ssh-tunnel时碰到channel-1018-open-failed-administratively-prohibited-open-failed错误\"><a href=\"#问题4-在使用ssh-tunnel时碰到channel-1018-open-failed-administratively-prohibited-open-failed错误\" class=\"headerlink\" title=\"问题4.在使用ssh tunnel时碰到channel 1018: open failed: administratively prohibited: open failed错误.\"></a>问题4.在使用ssh tunnel时碰到<code>channel 1018: open failed: administratively prohibited: open failed</code>错误.</h3><p>错误信息: <code>channel 1018: open failed: administratively prohibited: open failed</code><br>问题解决:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/ssh/sshd_config</span><br><span class=\"line\">AllowTcpForwarding yes</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"connect","path":"api/tags/connect.json"}]}