{"title":"1.InfluxDB数据库快速入门与基础使用","slug":"数据存储/InfluxDB/1.InfluxDB数据库快速入门与基础使用","date":"2022-04-10T05:40:32.000Z","updated":"2022-07-19T02:37:49.497Z","url":"2022/4-10-660.html","path":"api/articles/2022/4-10-660.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220608142633.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220610190419.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220611103535.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><h3 id=\"InfluxDB-介绍\"><a href=\"#InfluxDB-介绍\" class=\"headerlink\" title=\"InfluxDB 介绍\"></a>InfluxDB 介绍</h3><p><strong>Q: 什么是InfluxDB?</strong></p>\n<blockquote>\n<p>InfluxDB 采用Go语言开发是一个开源时间序列平台, 是一个可编程且高性能的时间序列数据库，具有跨 OSS、云和企业产品的通用 API。<br>简单描述: Influxdb是由Golang 构建的时序数据库，由于由Go语言构建使得其跨平台部署相对方便。</p>\n</blockquote>\n<p><br/></p>\n<p><strong>Q: InfluxDB 有何用?</strong><br>描述: InfluxDB 主要用于存储和查询数据、度量、事件和实时分析的可扩展数据存储，在后台处理数据以用于 ETL 或监控和警报目的、用户仪表板以及可视化和探索数据等的 API。<br>常用于物联网、分析和云应用程序的时间序列数据平台以及存储大量资源监控数据指标, 所以通常其还会与Grafana联用进行数据的展示。</p>\n<p><br/></p>\n<p><strong>Q: InfluxDB 时间序列平台的优点有那些?</strong></p>\n<ul>\n<li>用于实时应用程序的强大 API 和 工具集, 可以用你喜欢的语言（InfluxDB API、Arduino、C#、Go、Java、JavaScript、Kotlin、Node.js、PHP、Python、R、Ruby、Scala 和 Swift）编写代码</li>\n<li>高性能时间序列引擎</li>\n<li>庞大的云和开源开发人员社区</li>\n<li>内存占用较少</li>\n</ul>\n<p><br/></p>\n<p><strong>Q: 版本区别说明</strong><br>描述: InfluxDB 当前主要发型版分为社区版本(免费) 和 企业版本(收费), 通常我们使用社区版本即可, 它包含了基本的时间序列工具包，社区版本当前master分支为 2.x 版本, 但是对于想使用 1.x 版本可以在Github或者Docker镜像中找寻到其。InfluxDB 2.x 相比较于 InfluxDB 1.x 来说性能有很大的提升并且将 influxCLI 不再打包在来自influxdb需要单独下载, 其次是有关系型数据库基础的朋友可能比较喜欢 InfluxDB 1.x 因为其查询更加贴近，而 2.x 版本中增删改查都有较大的变化。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># InfluxDB 1.x</span></span><br><span class=\"line\">show databases;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># InfluxDB 2.x</span></span><br><span class=\"line\">influx write -b primary -o primary -p <span class=\"string\">'t01,building=boli,floor=702a temp=24.51651036342'</span></span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 2019 年 1 月 11 日左右，这个仓库上的 master 将成为 InfluxDB 2.0 代码，infludata/platform 的内容将移至此存储库。如果你依赖于 master，你应该更新你的依赖来跟踪 maxter-1.x 分支。</p>\n<p>温馨提示: InfluxDB 1.x 数据存储在数据库（database）中，InfluxDB OSS 2.2中，数据存储在桶（bucket）中。</p>\n<p><br/></p>\n<h3 id=\"InfluxDB-参考来源\"><a href=\"#InfluxDB-参考来源\" class=\"headerlink\" title=\"InfluxDB 参考来源\"></a>InfluxDB 参考来源</h3><p>influxdb 官网地址: <a href=\"https://influxdata.com/\" target=\"_blank\" rel=\"noopener\">https://influxdata.com/</a><br>influxdb 帮助文档: <a href=\"https://docs.influxdata.com/influxdb/latest/introduction/get-started/\" target=\"_blank\" rel=\"noopener\">https://docs.influxdata.com/influxdb/latest/introduction/get-started/</a><br>influxdb Release: <a href=\"https://github.com/influxdata/influxdb/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/influxdata/influxdb/releases</a><br>influxdb v2.x 客户端工具 ：<a href=\"https://github.com/influxdata/influx-cli\" target=\"_blank\" rel=\"noopener\">https://github.com/influxdata/influx-cli</a></p>\n<hr>\n<h2 id=\"0x01-安装部署\"><a href=\"#0x01-安装部署\" class=\"headerlink\" title=\"0x01 安装部署\"></a>0x01 安装部署</h2><p>描述: 我们可以采用多种方式进行安装部署 InfluxData , 例如 Docker 映像、Debian 包、RPM 包和 InfluxDB 的压缩包等方式安装。<br>温馨提示: influx 命令行界面 (CLI) 客户端作为单独的二进制文件提供在同一位置。</p>\n<h3 id=\"使用-Docker-安装-IndluxDB-2-x\"><a href=\"#使用-Docker-安装-IndluxDB-2-x\" class=\"headerlink\" title=\"使用 Docker 安装 IndluxDB 2.x\"></a>使用 Docker 安装 IndluxDB 2.x</h3><p><strong>安装步骤</strong><br>步骤 01.直接运行docker run创建一个influxdb2容器。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /opt/influxdb-docker-data-volume &amp;&amp; <span class=\"built_in\">cd</span> <span class=\"variable\">$_</span></span><br><span class=\"line\">docker run --name influxdb2 -d -p 8086:8086 \\</span><br><span class=\"line\">  -e DOCKER_INFLUXDB_INIT_MODE=setup \\</span><br><span class=\"line\">  -e DOCKER_INFLUXDB_INIT_USERNAME=admin \\</span><br><span class=\"line\">  -e DOCKER_INFLUXDB_INIT_PASSWORD=weiyigeek.top \\</span><br><span class=\"line\">  -e DOCKER_INFLUXDB_INIT_ORG=weiyigeek \\</span><br><span class=\"line\">  -e DOCKER_INFLUXDB_INIT_BUCKET=primary \\</span><br><span class=\"line\">  --volume <span class=\"variable\">$PWD</span>:/var/lib/influxdb2 \\</span><br><span class=\"line\">  influxdb:2.2.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ENV 解释:</span></span><br><span class=\"line\">DOCKER_INFLUXDB_INIT_MODE=setup          <span class=\"comment\"># 指其定为初始化模式。</span></span><br><span class=\"line\">DOCKER_INFLUXDB_INIT_USERNAME=admin      <span class=\"comment\"># 指定UI登陆用户名</span></span><br><span class=\"line\">DOCKER_INFLUXDB_INIT_PASSWORD=password   <span class=\"comment\"># 指定UI登陆密码</span></span><br><span class=\"line\">DOCKER_INFLUXDB_INIT_ORG=org             <span class=\"comment\"># 创建初始org</span></span><br><span class=\"line\">DOCKER_INFLUXDB_INIT_BUCKET=bucket       <span class=\"comment\"># 创建初始bucket</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>参考地址:</strong></p>\n<ul>\n<li><a href=\"https://hub.docker.com/_/influxdb\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/_/influxdb</a></li>\n<li><a href=\"https://github.com/influxdata/influxdata-docker\" target=\"_blank\" rel=\"noopener\">https://github.com/influxdata/influxdata-docker</a></li>\n</ul>\n<p><br/></p>\n<h3 id=\"使用-Helm-在-Kubernetes-安装-InfluxDB-2-x\"><a href=\"#使用-Helm-在-Kubernetes-安装-InfluxDB-2-x\" class=\"headerlink\" title=\"使用 Helm 在 Kubernetes 安装 InfluxDB 2.x\"></a>使用 Helm 在 Kubernetes 安装 InfluxDB 2.x</h3><p>描述: 此处为了方便快捷安装部署influxdb，我在Kubernetes集群环境中采用<code>helm</code>方式（安装使用请参考【 <a href=\"https://blog.weiyigeek.top/2021/6-10-617.html\">https://blog.weiyigeek.top/2021/6-10-617.html</a> 】）进行<code>InfluxData</code>的安装部署。</p>\n<p><strong>实践操作</strong><br>步骤 01.添加Chart仓库并在其仓库中搜索influxdb<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm repo add bitnami https://charts.bitnami.com/bitnami </span><br><span class=\"line\">helm repo update &amp;&amp; helm search repo influxdb</span><br><span class=\"line\">  <span class=\"comment\"># NAME                    CHART VERSION   APP VERSION     DESCRIPTION</span></span><br><span class=\"line\">  <span class=\"comment\"># bitnami/influxdb        5.3.1           2.2.0           InfluxDB(TM) is an open source time-series data...</span></span><br><span class=\"line\">helm show values bitnami/influxdb &gt; influxdb.yml</span><br></pre></td></tr></table></figure></p>\n<p>步骤 03.执行如下命令安装influxdb需指定修改后的Chart图表相关values的influxdb.yml文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm install prometheus-influxdb bitnami/influxdb -f influxdb.yml --version 5.3.1 -n devtest --debug --create-namespace</span><br><span class=\"line\"><span class=\"comment\"># ** Please be patient while the chart is being deployed **</span></span><br><span class=\"line\"><span class=\"comment\"># InfluxDB&amp;trade; can be accessed through following DNS names from within your cluster:</span></span><br><span class=\"line\">    InfluxDB&amp;trade;: prometheus-influxdb.devtest.svc.cluster.prod (port 8086)</span><br><span class=\"line\">    InfluxDB&amp;trade; Prometheus Metrics: prometheus-influxdb-metrics.devtest.svc.cluster.prod (port 9122)</span><br><span class=\"line\"><span class=\"comment\"># To connect to your database run the following commands:</span></span><br><span class=\"line\">    kubectl run prometheus-influxdb-client --rm --tty -i --restart=<span class=\"string\">'Never'</span> --namespace devtest  \\</span><br><span class=\"line\">      --image docker.io/bitnami/influxdb:2.2.0-debian-10-r41 --privileged=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">      --<span class=\"built_in\">command</span> -- bash</span><br><span class=\"line\"><span class=\"comment\"># To connect to your database from outside the cluster execute the following commands:</span></span><br><span class=\"line\">    kubectl port-forward svc/prometheus-influxdb 8086:8086</span><br></pre></td></tr></table></figure></p>\n<p>步骤 04.验证部署的influxdb的Pod以及Service,然后进入prometheus-influxdb的Pod里shell终端中.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,svc -n devtest -l app.kubernetes.io/component=influxdb</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                       READY   STATUS    RESTARTS        AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/prometheus-influxdb-5fbc6d5f9d-ww6ck   1/1     Running   5 (4m49s ago)   10m</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># service/prometheus-influxdb           ClusterIP   10.98.134.121   &lt;none&gt;        8086/TCP,8088/TCP   10m</span></span><br><span class=\"line\">  <span class=\"comment\"># service/prometheus-influxdb-metrics   ClusterIP   10.109.222.86   &lt;none&gt;        9122/TCP            10m</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -n devtest -it prometheus-influxdb-5fbc6d5f9d-ww6ck -- bash</span><br><span class=\"line\">I have no name!@prometheus-influxdb-5fbc6d5f9d-ww6ck:/$</span><br></pre></td></tr></table></figure></p>\n<p>步骤 06.在prometheus-influxdb-5fbc6d5f9d-ww6ck终端中执行influx命令。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Pod 中关于 INFLUXDB 的环境变量</span></span><br><span class=\"line\">I have no name!@prometheus-influxdb-5fbc6d5f9d-ww6ck:/$ env | egrep <span class=\"string\">\"^INFLUXDB\"</span></span><br><span class=\"line\">INFLUXDB_ADMIN_USER_TOKEN=1VreF2TZuek7V6hmnquF</span><br><span class=\"line\">INFLUXDB_ADMIN_ORG=primary    <span class=\"comment\"># 缺省</span></span><br><span class=\"line\">INFLUXDB_CREATE_USER_TOKEN=no</span><br><span class=\"line\">INFLUXDB_ADMIN_USER=admin</span><br><span class=\"line\">INFLUXDB_HTTP_AUTH_ENABLED=<span class=\"literal\">true</span></span><br><span class=\"line\">INFLUXDB_ADMIN_BUCKET=primary <span class=\"comment\"># 缺省</span></span><br><span class=\"line\">INFLUXDB_ADMIN_USER_PASSWORD=iSzWSexDso</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># influx 客户端工具版本</span></span><br><span class=\"line\">$ influx version</span><br><span class=\"line\">Influx CLI dev (git: none) build_date: 2022-04-11T15:46:15Z</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># influxdb 监控检测</span></span><br><span class=\"line\">$ influx ping</span><br><span class=\"line\">OK</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># influxdb 服务配置</span></span><br><span class=\"line\">$ influx server-config</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"assets-path\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"bolt-path\"</span>: <span class=\"string\">\"/bitnami/influxdb/influxd.bolt\"</span>,  <span class=\"comment\"># 持久化关注点</span></span><br><span class=\"line\">  <span class=\"string\">\"e2e-testing\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"engine-path\"</span>: <span class=\"string\">\"/bitnami/influxdb\"</span>,  <span class=\"comment\"># 持久化关注点</span></span><br><span class=\"line\">  <span class=\"string\">\"feature-flags\"</span>: null,</span><br><span class=\"line\">  <span class=\"string\">\"flux-log-enabled\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"hardening-enabled\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"http-bind-address\"</span>: <span class=\"string\">\"0.0.0.0:8086\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"http-idle-timeout\"</span>: 180000000000,</span><br><span class=\"line\">  <span class=\"string\">\"http-read-header-timeout\"</span>: 10000000000,</span><br><span class=\"line\">  <span class=\"string\">\"http-read-timeout\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"http-write-timeout\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"influxql-max-select-buckets\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"influxql-max-select-point\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"influxql-max-select-series\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"log-level\"</span>: <span class=\"string\">\"info\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"metrics-disabled\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"nats-max-payload-bytes\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"nats-port\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"no-tasks\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"pprof-disabled\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"query-concurrency\"</span>: 1024,</span><br><span class=\"line\">  <span class=\"string\">\"query-initial-memory-bytes\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"query-max-memory-bytes\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"query-memory-bytes\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"query-queue-size\"</span>: 1024,</span><br><span class=\"line\">  <span class=\"string\">\"reporting-disabled\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"secret-store\"</span>: <span class=\"string\">\"bolt\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"session-length\"</span>: 60,</span><br><span class=\"line\">  <span class=\"string\">\"session-renew-disabled\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"sqlite-path\"</span>: <span class=\"string\">\"/bitnami/influxdb/influxd.sqlite\"</span>,  <span class=\"comment\"># 持久化关注点</span></span><br><span class=\"line\">  <span class=\"string\">\"storage-cache-max-memory-size\"</span>: 1073741824,</span><br><span class=\"line\">  <span class=\"string\">\"storage-cache-snapshot-memory-size\"</span>: 26214400,</span><br><span class=\"line\">  <span class=\"string\">\"storage-cache-snapshot-write-cold-duration\"</span>: <span class=\"string\">\"10m0s\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-compact-full-write-cold-duration\"</span>: <span class=\"string\">\"4h0m0s\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-compact-throughput-burst\"</span>: 50331648,</span><br><span class=\"line\">  <span class=\"string\">\"storage-max-concurrent-compactions\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"storage-max-index-log-file-size\"</span>: 1048576,</span><br><span class=\"line\">  <span class=\"string\">\"storage-no-validate-field-size\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-retention-check-interval\"</span>: <span class=\"string\">\"30m0s\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-series-file-max-concurrent-snapshot-compactions\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"storage-series-id-set-cache-size\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"storage-shard-precreator-advance-period\"</span>: <span class=\"string\">\"30m0s\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-shard-precreator-check-interval\"</span>: <span class=\"string\">\"10m0s\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-tsm-use-madv-willneed\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-validate-keys\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-wal-fsync-delay\"</span>: <span class=\"string\">\"0s\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"storage-wal-max-concurrent-writes\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"storage-wal-max-write-delay\"</span>: 600000000000,</span><br><span class=\"line\">  <span class=\"string\">\"storage-write-timeout\"</span>: 10000000000,</span><br><span class=\"line\">  <span class=\"string\">\"store\"</span>: <span class=\"string\">\"disk\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"testing-always-allow-setup\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"tls-cert\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"tls-key\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"tls-min-version\"</span>: <span class=\"string\">\"1.2\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"tls-strict-ciphers\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"tracing-type\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"ui-disabled\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-addr\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-cacert\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-capath\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-client-cert\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-client-key\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-client-timeout\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"vault-max-retries\"</span>: 0,</span><br><span class=\"line\">  <span class=\"string\">\"vault-skip-verify\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-tls-server-name\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"vault-token\"</span>: <span class=\"string\">\"\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>步骤 07.查看influxdb提供的UI界面, 此处我们可编辑svc将其通过NodePort方式保留服务, 也可通过port-forward临时转发其服务端口, 然后便可通过浏览器访问mater节点+32506端口进行访问。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.NodePort</span></span><br><span class=\"line\">$ kubectl edit svc -n devtest prometheus-influxdb</span><br><span class=\"line\">$ kubectl get svc -n devtest prometheus-influxdb</span><br><span class=\"line\">NAME                  TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE</span><br><span class=\"line\">prometheus-influxdb   NodePort   10.98.134.121   &lt;none&gt;        8086:32506/TCP,8088:30441/TCP   6d3h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.port-forward</span></span><br><span class=\"line\">kubectl port-forward  -n devtest --address 0.0.0.0  svc/prometheus-influxdb 32506:8086</span><br><span class=\"line\">  <span class=\"comment\"># Forwarding from 0.0.0.0:32506 -&gt; 8086</span></span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 此处登陆密码为前面env环境中获取的<code>INFLUXDB_ADMIN_USER</code>与<code>INFLUXDB_ADMIN_USER_PASSWORD</code>环境变量值(admin/iSzWSexDso)。</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220608142633.png\" alt=\"WeiyiGeek.influxdb-UI\" title=\"\" class=\"\">\n                <p>WeiyiGeek.influxdb-UI</p>\n            </figure>\n<p>步骤 08.安装并使用客户端工具连接创建的prometheus-influxdb远程influxdb数据库。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.创建一个 influxdb-client 容器 </span></span><br><span class=\"line\">kubectl run prometheus-influxdb-client --namespace devtest --rm --tty -i --restart=<span class=\"string\">'Never'</span> --image docker.io/bitnami/influxdb:2.2.0-debian-10-r41 --privileged=<span class=\"literal\">true</span> -- bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.下载安装部署influx二进制客户端到宿主机上</span></span><br><span class=\"line\">wget -c https://dl.influxdata.com/influxdb/releases/influxdb2-client-2.3.0-linux-amd64.tar.gz &amp;&amp; tar -zxvf influxdb2-client-2.3.0-linux-amd64.tar.gz</span><br><span class=\"line\">cp influxdb2-client-2.3.0-linux-amd64/influx /usr/<span class=\"built_in\">local</span>/bin/influx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启用命令自动补全</span></span><br><span class=\"line\"><span class=\"comment\"># CLI支持为bash、zsh和powershell生成完成，要启用单个shell会话的完成（临时生效），请运行以下命令之一：</span></span><br><span class=\"line\"><span class=\"comment\"># For bash:</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> &lt;(influx completion bash)</span><br><span class=\"line\"><span class=\"comment\"># For zsh:</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> &lt;(influx completion zsh)</span><br><span class=\"line\"><span class=\"comment\"># For pwsh:</span></span><br><span class=\"line\">Invoke-Expression ((influx completion powershell) -join <span class=\"string\">\"`n`\"</span>)</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 在V2.x版本及其之后客户端工具已经从influxdb中分离开成为一个独立的项目(<code>https://github.com/influxdata/influx-cli/</code>)。</p>\n<p>温馨提示: 如果希望自动补全在其它shell会话中也可以将该命令加入到<code>~/.bash_profile</code>文件中使得下次打开shell终端可以自动补全。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee -a ~/.bash_profile &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> &lt;(influx completion bash)</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></p>\n<p>步骤 09.安装完成后使用 influx命令 添加需要连接的 influxdb 数据库。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.使用 influx config 命令进行 influxdb 数据库连接设置。</span></span><br><span class=\"line\"><span class=\"comment\"># -a 激活状态</span></span><br><span class=\"line\"><span class=\"comment\"># -n 连接名称</span></span><br><span class=\"line\"><span class=\"comment\"># -t 指定认证Token</span></span><br><span class=\"line\"><span class=\"comment\"># -o 组织名称</span></span><br><span class=\"line\"><span class=\"comment\"># -u InfluxDB服务器的URL</span></span><br><span class=\"line\"><span class=\"comment\"># 在容器里面</span></span><br><span class=\"line\">influx config create -a -n prometheus-influxdb -t 1VreF2TZuek7V6hmnquF -o primary -u http://prometheus-influxdb:8086   </span><br><span class=\"line\"><span class=\"comment\"># 在宿主机上</span></span><br><span class=\"line\">influx config create -a -n prometheus-influxdb -t 1VreF2TZuek7V6hmnquF -o primary -u http://10.98.134.121:8086             </span><br><span class=\"line\"><span class=\"comment\"># 查看当前激活的influxdb连接对象</span></span><br><span class=\"line\">$ influx config</span><br><span class=\"line\">  Active  Name                   URL                             Org</span><br><span class=\"line\">  *       prometheus-influxdb    http://10.98.134.121:8086       primary</span><br><span class=\"line\">$ influx ping</span><br><span class=\"line\">  OK</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.使用 influx setup 命令进行数据库连接初始化设置。</span></span><br><span class=\"line\"><span class=\"comment\"># 删除influxdb连接字符串</span></span><br><span class=\"line\">$ influx config rm prometheus-influxdb</span><br><span class=\"line\">  Active  Name                    URL                         Org     Deleted</span><br><span class=\"line\">  *       prometheus-influxdb     http://10.98.134.121:8086             <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 10.influx 2.x 数据库数据增删改查。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 数据增加</span></span><br><span class=\"line\">influx write -b primary -o primary <span class=\"string\">'airSensors,sensor_id=home temperature=71.18922021239435,humidity=35.096794192432846,co=0.49012238573499495'</span></span><br><span class=\"line\">influx write -b primary -o primary <span class=\"string\">'airSensors,sensor_id=home temperature=72.18922021239435,humidity=36.096794192432846,co=0.50012238573499495'</span></span><br><span class=\"line\">influx write -b primary -o primary <span class=\"string\">'airSensors,sensor_id=home temperature=73.18922021239435,humidity=37.096794192432846,co=0.51012238573499495'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 数据删除</span></span><br><span class=\"line\">influx delete -b primary -o primary -p sensor_id=home --start <span class=\"string\">'2022-06-05T08:26:39.455Z'</span> --stop <span class=\"string\">'2022-06-10T09:50:39.455Z'</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220610190419.png\" alt=\"WeiyiGeek.利用Influxdb中DataExplorer查看插入的数据\" title=\"\" class=\"\">\n                <p>WeiyiGeek.利用Influxdb中DataExplorer查看插入的数据</p>\n            </figure>\n<p>温馨提示: 使用 <code>influx query</code> 命令后如果想要退出查询, 则可以按下 <code>ctrl + d</code>。</p>\n<p><br/></p>\n<h3 id=\"使用-kubectl-在-Kubernetes-部署-InfluxDB-1-X\"><a href=\"#使用-kubectl-在-Kubernetes-部署-InfluxDB-1-X\" class=\"headerlink\" title=\"使用 kubectl 在 Kubernetes 部署 InfluxDB 1.X\"></a>使用 kubectl 在 Kubernetes 部署 InfluxDB 1.X</h3><p>描述: 在k8s集群中可能我们常常会使用kubectl客户端工具指定资源清单的进行apply以部署相应资源,此处我们将演示以资源清单方式部署 InfluxDB 1.X。</p>\n<p>温馨提示: 当前【2022年6月7日 19:51:14】1.X 最新的InfluxDB版本为 1.8.10。</p>\n<p>步骤 01.准备的部署influxdb的资源清单如下：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># influxdb-Deployment.yaml</span></span><br><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">influxdb-Deployment.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">    nodePort:</span> <span class=\"number\">30083</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">    protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">api</span></span><br><span class=\"line\"><span class=\"attr\">    nodePort:</span> <span class=\"number\">30083</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">8086</span></span><br><span class=\"line\"><span class=\"attr\">    protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">8086</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">graphite</span></span><br><span class=\"line\"><span class=\"attr\">    nodePort:</span> <span class=\"number\">30003</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">2003</span></span><br><span class=\"line\"><span class=\"attr\">    protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">2003</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">  sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - image:</span> <span class=\"attr\">influxdb:1.8.10</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">influxdb</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">8083</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">influx</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">8086</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">api</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">2003</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">graphite</span></span><br><span class=\"line\"><span class=\"attr\">          protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - mountPath:</span> <span class=\"string\">/etc/influxdb</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\"><span class=\"attr\">        - mountPath:</span> <span class=\"string\">/var/lib/influxdb/</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">      restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"><span class=\"attr\">      terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">influxdb-config</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/nfsdisk-31/datastore/influxdb/data</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span>     </span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 02.准备influxdb使用的配置文件并存放到configMap资源控制器下。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee influxdb.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[meta]</span><br><span class=\"line\">  dir = <span class=\"string\">\"/var/lib/influxdb/meta\"</span></span><br><span class=\"line\">[data]</span><br><span class=\"line\">  dir = <span class=\"string\">\"/var/lib/influxdb/data\"</span></span><br><span class=\"line\">  engine = <span class=\"string\">\"tsm1\"</span></span><br><span class=\"line\">  wal-dir = <span class=\"string\">\"/var/lib/influxdb/wal\"</span></span><br><span class=\"line\"><span class=\"comment\"># Configure the graphite api</span></span><br><span class=\"line\">[[graphite]]</span><br><span class=\"line\">enabled = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># If not set, is actually set to bind-address.</span></span><br><span class=\"line\"><span class=\"built_in\">bind</span>-address = <span class=\"string\">\":2003\"</span> </span><br><span class=\"line\"><span class=\"comment\"># store graphite data in this database</span></span><br><span class=\"line\">database = <span class=\"string\">\"appdb\"</span>  </span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl create cm influxdb-config --from-file=influxdb.conf</span><br><span class=\"line\">configmap/influxdb-config created</span><br></pre></td></tr></table></figure></p>\n<p>步骤 03.使用kubectl工具按照influxdb-Deployment.yaml资源清单中的内容进行安装部署, 并且查看其部署情况。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f influxdb-Deployment.yaml</span><br><span class=\"line\">  <span class=\"comment\"># service/influxdb created</span></span><br><span class=\"line\">  <span class=\"comment\"># deployment.apps/influxdb created</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get pod,svc -l app=influxdb</span><br><span class=\"line\">  <span class=\"comment\"># NAME                           READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/influxdb-f54d77bc6-cp46r   1/1     Running   0          59s</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                                        AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># service/influxdb   NodePort   10.101.187.102   &lt;none&gt;        8083:30083/TCP,8086:30086/TCP,2003:30003/TCP   33h</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 04.进入到influxdb-f54d77bc6-cp46r的Pod容器内部shell终端，并使用influx客户端连接到默认的 influxdb 服务端口上。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl <span class=\"built_in\">exec</span> -it influxdb-f54d77bc6-cp46r bash</span><br><span class=\"line\"></span><br><span class=\"line\">root@influxdb-f54d77bc6-cp46r:/<span class=\"comment\"># influx</span></span><br><span class=\"line\">Connected to http://localhost:8086 version 1.8.10</span><br><span class=\"line\">InfluxDB shell version: 1.8.10</span><br><span class=\"line\">&gt; <span class=\"built_in\">help</span>  <span class=\"comment\"># 查看交互式帮助</span></span><br><span class=\"line\">Usage:</span><br><span class=\"line\">  connect &lt;host:port&gt;   connects to another node specified by host:port</span><br><span class=\"line\">  auth                  prompts <span class=\"keyword\">for</span> username and password</span><br><span class=\"line\">  pretty                toggles pretty <span class=\"built_in\">print</span> <span class=\"keyword\">for</span> the json format</span><br><span class=\"line\">  chunked               turns on chunked responses from server</span><br><span class=\"line\">  chunk size &lt;size&gt;     sets the size of the chunked responses.  Set to 0 to reset to the default chunked size</span><br><span class=\"line\">  use &lt;db_name&gt;         sets current database</span><br><span class=\"line\">  format &lt;format&gt;       specifies the format of the server responses: json, csv, or column</span><br><span class=\"line\">  precision &lt;format&gt;    specifies the format of the timestamp: rfc3339, h, m, s, ms, u or ns</span><br><span class=\"line\">  consistency &lt;level&gt;   sets write consistency level: any, one, quorum, or all</span><br><span class=\"line\">  <span class=\"built_in\">history</span>               displays <span class=\"built_in\">command</span> <span class=\"built_in\">history</span></span><br><span class=\"line\">  settings              outputs the current settings <span class=\"keyword\">for</span> the shell</span><br><span class=\"line\">  clear                 clears settings such as database or retention policy.  run <span class=\"string\">'clear'</span> <span class=\"keyword\">for</span> <span class=\"built_in\">help</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span>/quit/ctrl+d      quits the influx shell</span><br><span class=\"line\">  show databases        show database names</span><br><span class=\"line\">  show series           show series information</span><br><span class=\"line\">  show measurements     show measurement information</span><br><span class=\"line\">  show tag keys         show tag key information</span><br><span class=\"line\">  show field keys       show field key information</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 用户创建</span></span><br><span class=\"line\">&gt; create user <span class=\"string\">\"root\"</span> with password <span class=\"string\">'weiyigeek.top'</span> with all privileges</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示默认数据库</span></span><br><span class=\"line\">&gt; show databases</span><br><span class=\"line\">name: databases</span><br><span class=\"line\">name</span><br><span class=\"line\">----</span><br><span class=\"line\">_internal</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建数据库</span></span><br><span class=\"line\">&gt; create database <span class=\"string\">\"jmeter\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 切换数据库</span></span><br><span class=\"line\">&gt; use jmeter</span><br><span class=\"line\">Using database jmeter</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示当前数据库中的表</span></span><br><span class=\"line\">&gt; show MEASUREMENTS</span><br><span class=\"line\">name: measurements</span><br><span class=\"line\">name</span><br><span class=\"line\">----</span><br><span class=\"line\">Upgrade-Insecure-Requests:</span><br><span class=\"line\">events</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 假设该数据中存在events表,我们可以看到如下数据。</span></span><br><span class=\"line\">&gt; select * from events</span><br><span class=\"line\">name: events</span><br><span class=\"line\">time                application text              title</span><br><span class=\"line\">----                ----------- ----              -----</span><br><span class=\"line\">1654483349859000000 nginx       Test name started ApacheJMeter</span><br><span class=\"line\">1654483351852000000 nginx       Test name ended   ApacheJMeter</span><br></pre></td></tr></table></figure>\n<hr>\n<h2 id=\"0x02-InfluxDB2-X-数据查询\"><a href=\"#0x02-InfluxDB2-X-数据查询\" class=\"headerlink\" title=\"0x02 InfluxDB2.X 数据查询\"></a>0x02 InfluxDB2.X 数据查询</h2><p>描述: 在 InfluxDB2.x 中提供了两种语法查询数据，Flux 和 InfluxQL。</p>\n<h3 id=\"Flux-功能给你性脚本语言\"><a href=\"#Flux-功能给你性脚本语言\" class=\"headerlink\" title=\"Flux - 功能给你性脚本语言\"></a>Flux - 功能给你性脚本语言</h3><p>描述: Flux 一门新的功能性数据脚本语言(Flux Script)，旨在将查询、处理、分析和对数据的操作统一为一个语法，这里仅介绍针对查询需要的一些常用函数和操作，了解更多Flux见Flux官方文档。</p>\n<p>基础规定, 每个查询语句必须包含数据源，时间区间和过滤器, 对应关键字分别为 from,range，filter。实际上不包含filter也是可以的，可以理解为filter过滤条件就是all，所以说Flux查询遵循如下几个步骤.</p>\n<ul>\n<li>指定数据源</li>\n<li>时间范围</li>\n<li>过滤数据</li>\n<li>对数据整形、聚合函数（重新组织数据结构）</li>\n<li>输出结果</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.指定数据存放的bucket名称</span></span><br><span class=\"line\">from(bucket: <span class=\"string\">\"demo-bucket\"</span>)</span><br><span class=\"line\"><span class=\"comment\"># 2.确定时间范围(两种方式既可以使用相对的时间区间，也可以使用绝对的时间戳)</span></span><br><span class=\"line\">  <span class=\"comment\"># 相对时间区间格式为时间间隔 h/m/s例如 -1h,-5m</span></span><br><span class=\"line\">  |&gt; range(start: -1d)</span><br><span class=\"line\">  <span class=\"comment\"># 绝对的时间戳格式2021-01-01T00:00:00Z</span></span><br><span class=\"line\">  |&gt; range(start: 2022-06-10T02:20:10.765Z, stop:\t2022-06-11T02:20:10.765Z )</span><br><span class=\"line\"><span class=\"comment\"># 3.使用filter()对输入的数据进行过滤</span></span><br><span class=\"line\">  |&gt; filter(fn: (r) =&gt; r[<span class=\"string\">\"_measurement\"</span>] == <span class=\"string\">\"student\"</span>)</span><br><span class=\"line\">  |&gt; filter(fn: (r) =&gt; r[<span class=\"string\">\"std_name\"</span>] == <span class=\"string\">\"weiyigeek\"</span>)</span><br><span class=\"line\">  |&gt; filter(fn: (r) =&gt; r[<span class=\"string\">\"_field\"</span>] == <span class=\"string\">\"score\"</span>)</span><br><span class=\"line\"><span class=\"comment\"># 4.对数据整形、聚合函数,例如此处将聚合函数应用于固定的时间窗口。</span></span><br><span class=\"line\"><span class=\"comment\"># - every: 指定持续时间</span></span><br><span class=\"line\"><span class=\"comment\"># - fn：无引号字符串，操作中使用的聚合函数。</span></span><br><span class=\"line\"><span class=\"comment\"># - createEmpty: 是否显示空数据行</span></span><br><span class=\"line\">  |&gt; aggregateWindow(every: 1s, fn: mean, createEmpty: <span class=\"literal\">false</span>)</span><br><span class=\"line\"><span class=\"comment\"># 5.yield输出查询结果，名称为results</span></span><br><span class=\"line\">  |&gt; yield(name: <span class=\"string\">\"results\"</span>)</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220611103535.png\" alt=\"WeiyiGeek.使用Flux进行influxDB数据查询\" title=\"\" class=\"\">\n                <p>WeiyiGeek.使用Flux进行influxDB数据查询</p>\n            </figure>\n<p><br></p>\n<p><strong>Flux 标准库（部分）</strong><br>该部分列举常用flux标准库函数，根据用法可举一反三使用所有标准库函数</p>\n<ul>\n<li><p>buckets() ：返回当前组中所有的桶</p>\n</li>\n<li><p>from(bucket: “demo-bucket”) : 指定从那个bucket查询数据</p>\n</li>\n<li><p>range() : 指定时间区间range接收两个参数start和stop, 其中stop可以省略缺省值是当前时间,而start不能省略否则会报语法错误。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1</span></span><br><span class=\"line\">from(bucket:<span class=\"string\">\"weiyigeek\"</span>)</span><br><span class=\"line\">  |&gt; range(start: -1h)</span><br><span class=\"line\"><span class=\"comment\">#示例2</span></span><br><span class=\"line\">from(bucket:<span class=\"string\">\"weiyigeek\"</span>)</span><br><span class=\"line\">  |&gt; range(start: 2021-01-01T00:00:00Z, stop: 2021-01-01T12:00:00Z)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>filter() : 对数据进行过滤，接收一个判断函数,其类似于类似于java中的lamda, 例如<code>(r) =&gt; (r.recordProperty comparisonOperator comparisonExpression)</code>。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.判断函数返回一个boolean类型值, 只有符合条件的记录才会被返回。</span></span><br><span class=\"line\">from(bucket:<span class=\"string\">\"demo\"</span>)</span><br><span class=\"line\">  |&gt; range(start: -1h)</span><br><span class=\"line\">  |&gt; filter(fn: (r)=&gt;(r.owner==<span class=\"string\">\"weiyigeek\"</span>))  <span class=\"comment\"># 取最近24小时含有owner标签且值为wxm的记录.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.当filter内含有多个条件时可用 and 或 or 连接各个条件含有std_name标签值为weiyigeek</span></span><br><span class=\"line\">  |&gt; filter(fn: (r)=&gt;(r.owner==<span class=\"string\">\"weiyigeek\"</span> or r[<span class=\"string\">\"std_name\"</span>] == <span class=\"string\">\"weiyigeek\"</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>contains(value, set) ：判断value是否包含在set中。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例</span></span><br><span class=\"line\">fiels = [<span class=\"string\">\"tencent\"</span>,<span class=\"string\">\"ali\"</span>]</span><br><span class=\"line\">from(bucket: <span class=\"string\">\"demo\"</span>)</span><br><span class=\"line\">  |&gt; range(start: 2022-03-12T08:14:04Z,stop:2022-03-13T08:19:05Z)</span><br><span class=\"line\">  |&gt; filter(fn: (r) =&gt; contains(value:r.owner,<span class=\"built_in\">set</span>:fiels))</span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>window(very, period, offset) : 该函数根据时间将数据分组。</p>\n<blockquote>\n<p>very 指定每个时间窗口的时间，例如 every = 5 那么 时间窗口可以是 0m-5m，5m-10m，10m-15m。默认为 period 的值<br>period 明确在每个时间窗口中需要从时间窗口起始到多久的数据，例如时间窗口为10m-15m period = 3 则只取10m-13m的数据，13m-15m的数据会被抛弃。默认为 every 的值<br>offset 指定每个时间窗口的时间偏移量，例如时间窗口为10m-15m offset = 3 那么会取 13m-15m的数据，10m-13m的数据会被抛弃，但注意当offset = every 时 offset不生效。且offset大于every 时 生效offset = offset % every</p>\n</blockquote>\n</li>\n<li><p>min() : column 求最小值的列默认为_value , 取每个分组中最小值</p>\n</li>\n<li>max() : column 求最大值的列默认为_value , 取每个分组中最大值</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 例如, 获取 student 表中 score 字段的最大值。</span></span><br><span class=\"line\">from(bucket: <span class=\"string\">\"demo-bucket\"</span>)</span><br><span class=\"line\">  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)</span><br><span class=\"line\">  |&gt; filter(fn: (r) =&gt; r[<span class=\"string\">\"_measurement\"</span>] == <span class=\"string\">\"student\"</span> and r._field == <span class=\"string\">\"score\"</span>)</span><br><span class=\"line\">  |&gt; max()</span><br><span class=\"line\">  |&gt; yield(name: <span class=\"string\">\"mean\"</span>)</span><br><span class=\"line\"><span class=\"comment\"># 0\tstudent\tscore\t99\t2022-06-09T02:56:27.661Z\t2022-06-11T02:56:27.661Z\t2022-06-10T09:51:39.036Z\tweiyigeek</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>bottom(n:10, columns: [“_value”]) ：根据columns进行排序并返回最上层n条记录。</p>\n</li>\n<li><p>count(column: “_value”) ：统计_value列中的数据个数。</p>\n</li>\n<li><p>columns(column: “_value”) : 返回所有列标签名并存储在指定的列中默认为_value 通过column参数指定.</p>\n</li>\n<li><p>cumulativeSum(columns: [“_value”]) ： 根据给定列对该列数据进行累加，模拟输出忽略 _start, _stop 等列.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 原始数据：</span></span><br><span class=\"line\">_measurement \t_field \t62</span><br><span class=\"line\">temperature \twxm \t62</span><br><span class=\"line\">temperature \twxm \t65</span><br><span class=\"line\">temperature \twxm \t81.5</span><br><span class=\"line\">temperature \twxm \t81.5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># cumulativeSum函数执行后：</span></span><br><span class=\"line\">_measurement \t_field \t62</span><br><span class=\"line\">temperature \twxm \t62</span><br><span class=\"line\">temperature \twxm \t127   <span class=\"comment\"># 62 + 65</span></span><br><span class=\"line\">temperature \twxm \t208.5 <span class=\"comment\"># 62 + 65 + 81.5</span></span><br><span class=\"line\">temperature \twxm \t290   <span class=\"comment\"># 62 + 65 + 81.5 + 81.5</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>group(columns: [“host”, “_measurement”], mode:”by”) : 按那些列进行分组操作默认值为[]。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># mode </span></span><br><span class=\"line\">- <span class=\"string\">\"by\"</span>, 按columns内指定的列进行分组.</span><br><span class=\"line\">- <span class=\"string\">\"expect\"</span>, 按除了columns列中指定的列进行分组.</span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>derivative(unit: 1s, nonNegative: true, columns: [“_value”], timeColumn: “_time”) ：计算后续非空记录之间每单位时间的更改率。输出表架构将与输入表相同</p>\n<blockquote>\n<p>unit 求多长时间内的变化速率。变化速率=（下一个值-上一个值）/（下一个时间-上一个时间）* unit 默认值1s<br>nonNegative 变化速率是否可以是负值，如果是负数influxdb会假定前一个值为0 默认值true<br>columns 指定计算变化速率的列 默认值 [“_value”]<br>timeColumn 手动指定时间列 默认值 “_time”</p>\n</blockquote>\n</li>\n<li><p>difference(nonNegative: false, columns: [“_value”]) : 计算指定列中后续非null记录之间的差异。</p>\n<blockquote>\n<p>nonNegative 是否允许差值为负数，如果是负数influxdb会假定前一个值为0 默认值false, 计算相邻两行的差值（next-pre）<br>keepFirst 是否保留第一行，默认值为false</p>\n</blockquote>\n</li>\n<li><p>distinct(column: “host”): 按指定列去重.</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"InfluxQL-关系型数据库查询\"><a href=\"#InfluxQL-关系型数据库查询\" class=\"headerlink\" title=\"InfluxQL - 关系型数据库查询\"></a>InfluxQL - 关系型数据库查询</h3><p>描述:  InfluxDB 1.x数据存储在数据库（database）中，InfluxDB OSS 2.2中，数据存储在桶（bucket）中, 由于InfluxQL使用了1.x数据模型，在使用InfluxQL进行查询之前，必须将桶映射到一个数据库和保留策略(DBRP)。可以这样理解 InfluxQL 只有数据库才能使用，如果想要在桶上也能使用只有将桶映射成数据库。</p>\n<p>使用InfluxQL查询桶数据，需要完成以下步骤：</p>\n<ul>\n<li>1、确认桶有映射;</li>\n<li>2、映射未映射的桶;</li>\n<li>3、使用InfluxQL查询已映射的桶;</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.查询所有的DBRP（DataBase Retention Police）映射</span></span><br><span class=\"line\">influx v1 dbrp list</span><br><span class=\"line\">influx v1 dbrp list --bucket-id 04deb39109ae7bc6  <span class=\"comment\"># 根据bucket id来过滤</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.查看未映射的桶</span></span><br><span class=\"line\">$ influx bucket ls -o demo -n demo-bucket</span><br><span class=\"line\">  <span class=\"comment\"># ID                      Name            Retention       Shard group duration    Organization ID         Schema Type</span></span><br><span class=\"line\">  <span class=\"comment\"># 2d0184d3af5ec8b2        demo-bucket     infinite        24h0m0s                 08472f250ef4212e        implicit</span></span><br><span class=\"line\"><span class=\"comment\"># 创建 DBRP 映射</span></span><br><span class=\"line\">$ influx v1 dbrp create \\</span><br><span class=\"line\">  --db test_db \\</span><br><span class=\"line\">  --rp test_rp \\</span><br><span class=\"line\">  --bucket-id 2d0184d3af5ec8b2 \\</span><br><span class=\"line\">  --org demo \\</span><br><span class=\"line\">  --default</span><br><span class=\"line\"><span class=\"comment\"># --db value : The name of the database</span></span><br><span class=\"line\"><span class=\"comment\"># --rp value : The name of the retention policy</span></span><br><span class=\"line\"><span class=\"comment\"># --default  : Identify this retention policy as the default for the database</span></span><br><span class=\"line\">  <span class=\"comment\"># ID                      Database        Bucket ID               Retention Policy        Default Organization ID</span></span><br><span class=\"line\">  <span class=\"comment\"># 097f79ebcbee5000        test_db         2d0184d3af5ec8b2        test_rp                 true    08472f250ef4212e</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.使用curl利用API形式进行InfluxQL方式查询已映射的桶</span></span><br><span class=\"line\">curl --get \\</span><br><span class=\"line\"><span class=\"string\">\"http://10.98.134.121:8086/query\"</span> \\</span><br><span class=\"line\">  --header <span class=\"string\">\"Authorization: Token nxlkweOIxTOYQhNzI4QtuBHrKQtyOLFkA2KzJsBpO71hxZT7i6rmdyIgSuexuKbda1qL9x8vjJWUUH5rzBleKA==\"</span> \\</span><br><span class=\"line\">  --data-urlencode <span class=\"string\">\"q=SELECT * FROM test_db.test_rp.hobby\"</span></span><br><span class=\"line\">  <span class=\"comment\"># &#123;\"results\":[&#123;\"statement_id\":0,\"series\":[&#123;\"name\":\"hobby\",\"columns\":[\"time\",\"Love\",\"city\",\"id\",\"love\",\"name\"],\"values\":[[\"2022-06-10T14:15:44.661068711Z\",null,\"ChongQing\",1002,\"computer\",\"weiyigeek\"]]&#125;]&#125;]&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.移除指定的dbrp映射</span></span><br><span class=\"line\">influx v1 dbrp delete --id 097f79ebcbee5000</span><br><span class=\"line\">  <span class=\"comment\"># ID                      Database        Bucket ID               Retention Policy        Default Organization ID</span></span><br><span class=\"line\">  <span class=\"comment\"># 097f79ebcbee5000        test_db         2d0184d3af5ec8b2        test_rp                 true    08472f250ef4212e</span></span><br></pre></td></tr></table></figure>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Database","path":"api/categories/Database.json"}],"tags":[{"name":"InfluxDB","path":"api/tags/InfluxDB.json"}]}