{"title":"LDAP客户端认证配置与应用接入","slug":"数据存储/LDAP/LDAP客户端认证配置与使用","date":"2020-04-11T04:40:32.000Z","updated":"2022-03-29T05:39:06.312Z","url":"2020/4-11-41.html","path":"api/articles/2020/4-11-41.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414214237.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414214825.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414171924.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414173001.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414174642.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414173733.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200412010608.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200412012232.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-基础加深\"><a href=\"#0x00-基础加深\" class=\"headerlink\" title=\"0x00 基础加深\"></a>0x00 基础加深</h4><p>描述:通过上一篇笔记的学习以及操作，我们已经完成吧账号属性导入了OpenLDAP中，然后通过OpenLDAP用户进行验证登陆所以我们还需对客户端进行配置;<br>除此之外我们还将常见的开源应用进行接入OpenLDAP之中进行应用;</p>\n<p><em>(1) 用户与用户组的对应有如何关系?</em></p>\n<ul>\n<li><code>Posixgroup用户组属性</code>: OpenLDAP默认属性，该Posixgroup用户组属性和用户没有实际的对应关系，如果需要进行对应就需要把用户设置到Posixgroup中，且成员属性为<code>memberUid</code>,然后再把Dev该用户的gidNumber设置为上述用户组的gidNumber;<ul>\n<li>以上设置基本可以满足大部分业务场景的需要，但是如果我们需要根据用户组来过滤用户的话，Posixgroup用户组属性，是无法满足需要的,<code>比如：nginx与openldap集成过滤用户组时、proftpd与openldap集成过滤用户组时、openvpn与openldap集成过滤用户组时、gitlab与openldap集成过滤用户组时,Posixgroup用户组属性是无法满足的</code>,此时我们就需要使用groupOfUniqueNames用户组属性。<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414214237.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></li>\n</ul>\n</li>\n<li><code>groupOfUniqueNames用户组属性</code>:可以根据用户组过滤用户(过滤唯一)，roupOfUniqueNames用户组属性的成员属性为<code>uniqueMember</code>,可以看到groupOfUniqueNames用户组属性配置如下:<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414214825.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"0x01-认证配置\"><a href=\"#0x01-认证配置\" class=\"headerlink\" title=\"0x01 认证配置\"></a>0x01 认证配置</h4><h5 id=\"多组平台认证\"><a href=\"#多组平台认证\" class=\"headerlink\" title=\"多组平台认证\"></a>多组平台认证</h5><p>描述:通过前面对LDAP Account Manager的管理配置，默认情况下创建的用户会在People而创建的组会保存在Group之中;</p>\n<p>本段文章主要实践在Ldap中通过memberof的一个功能来实现<code>添加多组用于不同的平台认证</code>，首先需要查看我采用Docker搭建的openldap是支持memberof的功能。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#方式1：</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span> <span class=\"built_in\">exec</span> -it openldap slapcat -n 0 | grep olcModuleLoad</span><br><span class=\"line\">olcModuleLoad: &#123;0&#125;back_mdb</span><br><span class=\"line\">olcModuleLoad: &#123;1&#125;memberof  <span class=\"comment\">#可以看到该模块存在</span></span><br><span class=\"line\">olcModuleLoad: &#123;2&#125;refint</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#方式2:</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> openldap ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config dn</span><br><span class=\"line\">dn: cn=config</span><br><span class=\"line\">dn: cn=module&#123;0&#125;,cn=config</span><br><span class=\"line\">dn: cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;0&#125;core,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;1&#125;cosine,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;2&#125;nis,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;3&#125;inetorgperson,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;4&#125;ppolicy,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;5&#125;dhcp,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;6&#125;dnszone,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;7&#125;mail,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;8&#125;mmc,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;9&#125;openssh-lpk,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;10&#125;quota,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;11&#125;radius,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;12&#125;samba,cn=schema,cn=config</span><br><span class=\"line\">dn: cn=&#123;13&#125;zarafa,cn=schema,cn=config</span><br><span class=\"line\">dn: olcBackend=&#123;0&#125;mdb,cn=config</span><br><span class=\"line\">dn: olcDatabase=&#123;-1&#125;frontend,cn=config</span><br><span class=\"line\">dn: olcDatabase=&#123;0&#125;config,cn=config</span><br><span class=\"line\">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class=\"line\">dn: olcOverlay=&#123;0&#125;memberof,olcDatabase=&#123;1&#125;mdb,cn=config <span class=\"comment\">#服务存在</span></span><br><span class=\"line\">dn: olcOverlay=&#123;1&#125;refint,olcDatabase=&#123;1&#125;mdb,cn=config</span><br></pre></td></tr></table></figure></p>\n<p>操作流程:</p>\n<ul>\n<li>Step1.登录LAM新建立一个组选择<code>Groups选项卡</code>-&gt;<code>New Group</code>,然后<code>Tree View</code>-&gt;<code>ou=Group</code>查看新建立的组;</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414171924.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<ul>\n<li>Step2.此处以Gitlab ，Jenkins ，SonarQube以及Harbor为例创建四个用户，先创建一个gituser为例其账号密码相同<code>Users</code>-&gt;<code>New User</code>-&gt;<code>last Name</code>(其他属性按需求添加)-&gt;<code>set Password</code>，建议在建立用户的时候将<code>RDN identifier</code>设置为uid，其他三个用户类似创建即可;<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414173001.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n<ul>\n<li>Step3.创建四个Object属性为 groupOfUniqueNames 的组（<code>作用:根据用户组过滤用户该过滤是唯一的</code>） 分别对应上面四个平台,选择组<code>ou=Group</code>-&gt;<code>Create new entry here</code>-&gt;<code>Default</code>-&gt;Object classes:<code>groupOfUniqueNames</code>-&gt;<code>Proceed</code>-&gt;添加基础信息然后commit;</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414174642.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>最终创建结果如下:</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414173733.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>采用ldapsearch输出LDAP.ldif格式的文件来看我们创建的组与用户；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -LLL -x -H ldap://127.0.0.1:389/ -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> dn uniqueMember -w WeiyiGeek</span><br><span class=\"line\">dn: cn=gitlab,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">uniqueMember: uid=gituser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\">dn: cn=harbor,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">uniqueMember: uid=haruser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\">dn: cn=jenkins,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">uniqueMember: cn=jenkuser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\">dn: cn=sonarqube,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">uniqueMember: uid=sonaruser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -LLL -x -H ldap://127.0.0.1:389/ -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> <span class=\"string\">\"(|(objectClass=inetOrgPerson)(objectClass=groupOfUniqueNames))\"</span> -w WeiyiGeek</span><br><span class=\"line\"><span class=\"comment\">#User</span></span><br><span class=\"line\">dn: uid=gituser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: organizationalPerson</span><br><span class=\"line\">objectClass: person</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">homeDirectory: /home/gituser</span><br><span class=\"line\">userPassword:: e1NTSEF9UGVyM21xc1dJcnV3K1d2bWRiVmVpd3RWZHVVeVN6Tks=</span><br><span class=\"line\">uid: gituser</span><br><span class=\"line\">cn: gituser</span><br><span class=\"line\">uidNumber: 10000</span><br><span class=\"line\">gidNumber: 10000</span><br><span class=\"line\">sn: gituser</span><br><span class=\"line\">mail: gituser@weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\">dn: cn=jenkuser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: organizationalPerson</span><br><span class=\"line\">objectClass: person</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">homeDirectory: /home/jenkuser</span><br><span class=\"line\">uid: jenkuser</span><br><span class=\"line\">cn: jenkuser</span><br><span class=\"line\">uidNumber: 10001</span><br><span class=\"line\">gidNumber: 10000</span><br><span class=\"line\">userPassword:: e1NTSEF9UlpQM0VCOE5qSW92bzVvL3NlTUVvVEVOSlZoc1NFcFI=</span><br><span class=\"line\">sn: jenkuser</span><br><span class=\"line\">mail: jenkuser@weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\">dn: uid=sonaruser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: organizationalPerson</span><br><span class=\"line\">objectClass: person</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">homeDirectory: /home/sonaruser</span><br><span class=\"line\">uid: sonaruser</span><br><span class=\"line\">cn: sonaruser</span><br><span class=\"line\">uidNumber: 10002</span><br><span class=\"line\">gidNumber: 10000</span><br><span class=\"line\">userPassword:: e1NTSEF9SVRMTjJ4SGc1YS85bmNwQzlsU2NXcUhuYWNSWFdUTlo=</span><br><span class=\"line\">sn: sonaruser</span><br><span class=\"line\">mail: sonaruser@weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\">dn: uid=haruser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: organizationalPerson</span><br><span class=\"line\">objectClass: person</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">homeDirectory: /home/haruser</span><br><span class=\"line\">uid: haruser</span><br><span class=\"line\">cn: haruser</span><br><span class=\"line\">uidNumber: 10003</span><br><span class=\"line\">gidNumber: 10000</span><br><span class=\"line\">userPassword:: e1NTSEF9QVp4SXV2VnlDWmR1MVpsZEQ1SEpHUW9NUDh4dlJUQXc=</span><br><span class=\"line\">sn: haruser</span><br><span class=\"line\">mail: haruser@weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#groupOfUniqueNames</span></span><br><span class=\"line\">dn: cn=gitlab,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">cn: gitlab</span><br><span class=\"line\">description:: Z2l0bGFiIOW5s+WPsOS7k+W6k+iupOivgee7hA==</span><br><span class=\"line\">objectClass: groupOfUniqueNames</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">ou: Group</span><br><span class=\"line\">uniqueMember: uid=gituser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\">dn: cn=jenkins,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">cn: jenkins</span><br><span class=\"line\">description:: amVua2lucyDmjIHnu63pm4bmiJDkuI7lj5HluIPlubPlj7DorqTor4E=</span><br><span class=\"line\">objectClass: groupOfUniqueNames</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">ou: Group</span><br><span class=\"line\">uniqueMember: cn=jenkuser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\">dn: cn=sonarqube,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">cn: sonarqube</span><br><span class=\"line\">description:: c29uYXJxdWJlIOS7o+eggei0qOmHj+a1i+ivleW5s+WPsA==</span><br><span class=\"line\">objectClass: groupOfUniqueNames</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">ou: Group</span><br><span class=\"line\">uniqueMember: uid=sonaruser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\">dn: cn=harbor,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">cn: harbor</span><br><span class=\"line\">description:: aGFyYm9yIOW5s+WPsOiupOivgeS7k+W6kw==</span><br><span class=\"line\">objectClass: groupOfUniqueNames</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">ou: Group</span><br><span class=\"line\">uniqueMember: uid=haruser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br></pre></td></tr></table></figure></p>\n<p>至此，LDAP Account Manager平台上的操作就暂告一段落了，接下来我们就靠这个uniqueMember属性来实现不同分组验证登陆到不同的平台。</p>\n<p><br></p>\n<h4 id=\"0x02-应用服务接入\"><a href=\"#0x02-应用服务接入\" class=\"headerlink\" title=\"0x02 应用服务接入\"></a>0x02 应用服务接入</h4><h5 id=\"Ldap与sshd\"><a href=\"#Ldap与sshd\" class=\"headerlink\" title=\"Ldap与sshd\"></a>Ldap与sshd</h5><p>描述:采用SSH进行远程LDAP用户验证登陆,先查询本地数据库中是否存在该用户如果不存在则从LDAP中请求查看该用户，并使用该用户密码进行验证登陆 ;</p>\n<p>基础操作:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#停掉sssd服务</span></span><br><span class=\"line\">service sssd stop &amp;&amp; chkconfig sssd off</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装nslcd服务</span></span><br><span class=\"line\">yum install nss-pam-ldapd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改配置文件(如下所示即可)</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/nslcd.conf</span><br><span class=\"line\">uid nslcd</span><br><span class=\"line\">gid ldap</span><br><span class=\"line\">uri ldap://10.10.107.254/</span><br><span class=\"line\">base dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">binddn cn=admin,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">bindpw WeiyiGeek</span><br><span class=\"line\">ssl no</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/pam_ldap.conf</span><br><span class=\"line\">auth        required      pam_env.so</span><br><span class=\"line\">auth        required      pam_faildelay.so delay=2000000</span><br><span class=\"line\">auth        sufficient    pam_unix.so nullok try_first_pass</span><br><span class=\"line\">auth        requisite     pam_succeed_if.so uid &gt;= 1000 quiet_success</span><br><span class=\"line\">auth        required      pam_deny.so</span><br><span class=\"line\">auth        sufficient    pam_ldap.so use_first_pass <span class=\"comment\">#添加</span></span><br><span class=\"line\"></span><br><span class=\"line\">account     required      pam_unix.so</span><br><span class=\"line\">account     sufficient    pam_localuser.so</span><br><span class=\"line\">account     sufficient    pam_succeed_if.so uid &lt; 1000 quiet</span><br><span class=\"line\">account     required      pam_permit.so</span><br><span class=\"line\">account     [default=bad success=ok user_unknown=ignore] pam_ldap.so <span class=\"comment\">#添加</span></span><br><span class=\"line\"></span><br><span class=\"line\">password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=</span><br><span class=\"line\">password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok</span><br><span class=\"line\">password    required      pam_deny.so</span><br><span class=\"line\">password    sufficient    pam_ldap.so use_authok <span class=\"comment\">#添加</span></span><br><span class=\"line\"></span><br><span class=\"line\">session     optional      pam_keyinit.so revoke</span><br><span class=\"line\">session     required      pam_limits.so</span><br><span class=\"line\">-session     optional      pam_systemd.so</span><br><span class=\"line\">session     [success=1 default=ignore] pam_succeed_if.so service <span class=\"keyword\">in</span> crond quiet use_uid</span><br><span class=\"line\">session     required      pam_unix.so</span><br><span class=\"line\">session     optional      pam_ldap.so  <span class=\"comment\">#添加</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/pam.d/system-auth</span><br><span class=\"line\">session     optional      pam_mkhomedir.so skel=/etc/skel/ <span class=\"built_in\">umask</span>=0022</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/nsswitch.conf</span><br><span class=\"line\"><span class=\"comment\">#在此三行后边增加ldap，修改后默认登录的用户通过本地配置文件进行查找并匹配。当匹配不到用户信息时，会通过后端配置的LDAP认证服务进行匹配;</span></span><br><span class=\"line\">passwd: files ldap</span><br><span class=\"line\">shadow: files ldap</span><br><span class=\"line\">group: files ldap</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/sysconfig/authconfig</span><br><span class=\"line\">CACHECREDENTIALS=yes </span><br><span class=\"line\">FAILLOCKARGS=<span class=\"string\">\"deny=4 unlock_time=1200\"</span></span><br><span class=\"line\">FORCELEGACY=no</span><br><span class=\"line\">FORCESMARTCARD=no</span><br><span class=\"line\">IPADOMAINJOINED=no</span><br><span class=\"line\">IPAV2NONTP=no</span><br><span class=\"line\">PASSWDALGORITHM=md5  <span class=\"comment\">#默认密码加密方式默认SHA512</span></span><br><span class=\"line\">USEDB=no</span><br><span class=\"line\">USEECRYPTFS=no</span><br><span class=\"line\">USEFAILLOCK=no</span><br><span class=\"line\">USEFPRINTD=no</span><br><span class=\"line\">USEHESIOD=no</span><br><span class=\"line\">USEIPAV2=no</span><br><span class=\"line\">USEKERBEROS=no</span><br><span class=\"line\">USELDAP=yes <span class=\"comment\">#启用LDAP认证协议</span></span><br><span class=\"line\">USELDAPAUTH=yes  <span class=\"comment\">#启用OpenLDAP验证</span></span><br><span class=\"line\">USELOCAUTHORIZE=yes  <span class=\"comment\">#启用本地验证</span></span><br><span class=\"line\">USEMKHOMEDIR=no</span><br><span class=\"line\">USENIS=no</span><br><span class=\"line\">USEPAMACCESS=no</span><br><span class=\"line\">USEPASSWDQC=no</span><br><span class=\"line\">USEPWQUALITY=yes</span><br><span class=\"line\">USESHADOW=yes <span class=\"comment\">#启用密码验证</span></span><br><span class=\"line\">USESMARTCARD=no</span><br><span class=\"line\">USESSSD=no</span><br><span class=\"line\">USESSSDAUTH=no</span><br><span class=\"line\">USESYSNETAUTH=no</span><br><span class=\"line\">USEWINBIND=no</span><br><span class=\"line\">USEWINBINDAUTH=no</span><br><span class=\"line\">WINBINDKRB5=no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#验证配置，可以通过phpldapadmin增加一个用户，或者在ldaptest1的基础上复制条目（这里不过多的说明，不会的看前面的文章）</span></span><br><span class=\"line\"><span class=\"comment\">#此时假设您已经添加成功，在phpldapadmin中可以看到新增用户，但是在本地上是没有新建的用户的;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启服务</span></span><br><span class=\"line\">systemctl restart nslcd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看系统用户列表</span></span><br><span class=\"line\"><span class=\"comment\">#客户端查询：</span></span><br><span class=\"line\">ldapsearch -H ldap://172.27.1.111 -x -b <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> |grep dn</span><br><span class=\"line\"><span class=\"comment\">#服务端查询：</span></span><br><span class=\"line\">ldapsearch -x -b <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> |grep dn</span><br><span class=\"line\"><span class=\"comment\">#查询单个用户：</span></span><br><span class=\"line\">ldapsearch -x -b <span class=\"string\">\"uid=ldaptest3,ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span> | grep dn</span><br></pre></td></tr></table></figure></p>\n<p>ssh支持LDAP相关配置:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/ssh/sshd_config</span><br><span class=\"line\">UsePAM yes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/pam.d/sshd </span><br><span class=\"line\"><span class=\"comment\">#用于第一次登陆的账户自动创建家目录  </span></span><br><span class=\"line\">session    required     pam_mkhomedir.so</span><br><span class=\"line\"><span class=\"comment\">#OpenLDAP限制用户登录系统</span></span><br><span class=\"line\">account    required     pam_access.so</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/pam.d/password-auth </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#OpenLDAP限制用户登录系统（在账号中，不能让每个用户都能登录系统，所以要限制用户登录）</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/security/access.conf  <span class=\"comment\">#限制ldaptest3用户ssh登录系统</span></span><br><span class=\"line\">-:ldaptest3:ALL</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启ssh</span></span><br><span class=\"line\">systemctl restart sshd</span><br></pre></td></tr></table></figure></p>\n<p>测试结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#采用LDAP中的ldaptest1用户</span></span><br><span class=\"line\">[ldaptest1@localhost ~]$ getent passwd | grep -E <span class=\"string\">\"ldap|ns\"</span></span><br><span class=\"line\">nscd:x:28:28:NSCD Daemon:/:/sbin/nologin</span><br><span class=\"line\">nslcd:x:65:55:LDAP Client User:/:/sbin/nologin</span><br><span class=\"line\">ldaptest1:x:1001:1001:ldaptest1:/home/ldaptest1:/bin/bash</span><br><span class=\"line\">ldaptest2:x:1002:1002:ldaptest2:/home/ldaptest2:/bin/bash</span><br><span class=\"line\">ldaptest3:x:1003:1003:ldaptest3:/home/ldaptest3:/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#用户密码设置(默认是不允许更改密码，我已经在ldap服务端配置用户可以更新自己的密码)</span></span><br><span class=\"line\">[ldaptest2@localhost ~]$ passwd</span><br><span class=\"line\">更改用户 ldaptest2 的密码 。</span><br><span class=\"line\">(current) LDAP Password:</span><br><span class=\"line\">新的 密码：</span><br><span class=\"line\">重新输入新的 密码：</span><br><span class=\"line\">passwd：所有的身份验证令牌已经成功更新。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#客户端机器上面是验证否有ldaptest1用户，通过cat /etc/passwd 查询本地是没有的</span></span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># cat /etc/passwd</span></span><br><span class=\"line\">root:x:0:0:root:/root:/bin/bash</span><br><span class=\"line\">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class=\"line\">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class=\"line\">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class=\"line\">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class=\"line\">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class=\"line\">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class=\"line\">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class=\"line\">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class=\"line\">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class=\"line\">games:x:12:100:games:/usr/games:/sbin/nologin</span><br><span class=\"line\">ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin</span><br><span class=\"line\">nobody:x:99:99:Nobody:/:/sbin/nologin</span><br><span class=\"line\">systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin</span><br><span class=\"line\">dbus:x:81:81:System message bus:/:/sbin/nologin</span><br><span class=\"line\">polkitd:x:999:998:User <span class=\"keyword\">for</span> polkitd:/:/sbin/nologin</span><br><span class=\"line\">sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin</span><br><span class=\"line\">postfix:x:89:89::/var/spool/postfix:/sbin/nologin</span><br><span class=\"line\">chrony:x:998:996::/var/lib/chrony:/sbin/nologin</span><br><span class=\"line\">apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin</span><br><span class=\"line\">dhcpd:x:177:177:DHCP server:/:/sbin/nologin</span><br><span class=\"line\">nscd:x:28:28:NSCD Daemon:/:/sbin/nologin</span><br><span class=\"line\">nslcd:x:65:55:LDAP Client User:/:/sbin/nologin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#但是通过getent passwd方式查询的时候又有该用户</span></span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># getent passwd | grep \"ldap\"</span></span><br><span class=\"line\">ldaptest1:x:1001:1001:ldaptest1:/home/ldaptest1:/bin/bash</span><br><span class=\"line\">ldaptest2:x:1002:1002:ldaptest2:/home/ldaptest2:/bin/bash</span><br><span class=\"line\">ldaptest3:x:1003:1003:ldaptest3:/home/ldaptest3:/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#直接查看ldaptest1的ID，可以查询到，说明他通过了OpenLDAP进行的验证</span></span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># id ldaptest1</span></span><br><span class=\"line\">uid=1001(ldaptest1) gid=1001(ldaptest1) 组=1001(ldaptest1)</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># getent shadow | grep ldaptest1</span></span><br><span class=\"line\">ldaptest1:*:18363:0:99999:7:::0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#注意事项(如果输入的ldap中建立的cn用户密码失败时候会在message中显示-可以进行排错)</span></span><br><span class=\"line\"><span class=\"variable\">$tail</span> -n 5 -f messages</span><br><span class=\"line\">Apr 12 01:16:30 localhost nslcd[6617]: [f37e85] &lt;authc=<span class=\"string\">\"ldaptest2\"</span>&gt; uid=ldaptest2,ou=People,dc=WeiyiGeek,dc=com,dc=cn: lookup failed: Invalid credentials</span><br><span class=\"line\">Apr 12 01:16:33 localhost nslcd[6617]: [10b4e8] &lt;authc=<span class=\"string\">\"ldaptest2\"</span>&gt; uid=ldaptest2,ou=People,dc=WeiyiGeek,dc=com,dc=cn: lookup failed: Invalid credentials</span><br></pre></td></tr></table></figure></p>\n<p>登录结果:<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200412010608.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br></p>\n<p><strong>图形化简化部署</strong><br>描述:采用setup工具进行图形化部署OpenLDAP客户端(新手推荐)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install setuptool -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置文件备份（到时可以对比一下它修改的地方）</span></span><br><span class=\"line\">cp /etc/nsswitch.conf /etc/nsswitch.conf.bak</span><br><span class=\"line\">cp /etc/pam.d/system-auth-ac /etc/pam.d/system-auth-ac.bak</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改后的文件对比</span></span><br><span class=\"line\">vimdiff /etc/nsswitch.conf /etc/nsswitch.conf.bak</span><br><span class=\"line\">vimdiff /etc/pam.d/system-auth-ac /etc/pam.d/system-auth-ac.bak</span><br></pre></td></tr></table></figure></p>\n<p>图形化部署OpenLDAP客户端之采用LDAP认证<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200412012232.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Database","path":"api/categories/Database.json"}],"tags":[{"name":"LDAP","path":"api/tags/LDAP.json"}]}