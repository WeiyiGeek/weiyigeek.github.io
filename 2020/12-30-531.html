<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Jenkins">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
        
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-12-30T04:34:30.000Z" itemprop="datePublished" class="page-time">
  2020-12-30
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/CI-CD/">CI-CD</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-ç³»ç»Ÿè¿ç»´/è‡ªåŠ¨åŒ–è¿ç»´/CI-CD/Jenkins/4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-12-30 12:34:30" datetime="2020-12-30T04:34:30.000Z"  itemprop="datePublished">2020-12-30</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/">DevOps</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/DevOps/CI-CD/">CI-CD</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<hr>
<h2 id="0x00-å‰è¨€ç®€è¿°"><a href="#0x00-å‰è¨€ç®€è¿°" class="headerlink" title="0x00 å‰è¨€ç®€è¿°"></a>0x00 å‰è¨€ç®€è¿°</h2><p><strong>Q: ä»€ä¹ˆæ˜¯Jenkinsçš„åˆ†å¸ƒå¼èŠ‚ç‚¹æ„å»º?</strong></p>
<blockquote>
<p>æè¿°: ç®€å•çš„è¯´å°±æ˜¯é€šè¿‡å°†æ„å»ºè¿‡ç¨‹åˆ†é…åˆ°ä»å±SlaveèŠ‚ç‚¹ä¸Šï¼Œä»è€Œå‡è½»MasterèŠ‚ç‚¹çš„å‹åŠ›ï¼Œè€Œä¸”å¯ä»¥åŒæ—¶æ„å»ºå¤šä¸ªæœ‰ç‚¹ç±»ä¼¼è´Ÿè½½å‡è¡¡çš„æ¦‚å¿µã€‚<br>éšç€ç°åœ¨å®¹å™¨çš„ç››è¡Œæˆ‘ä»¬å¯ä»¥å°†serverèŠ‚ç‚¹å’ŒagentèŠ‚ç‚¹åœ¨å®¹å™¨æˆ–è€…åŸºäºKubernetesä¸­éƒ¨ç½², å¯ä»¥å®ç°åŠ¨æ€çš„èµ„æºåˆ†é…ç­‰ç­‰å¥½å¤„ã€‚</p>
</blockquote>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113140710.png" target="_blank" title="WeiyiGeek.Jenkinsåˆ†å¸ƒå¼èŠ‚ç‚¹" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113140710.png" alt="WeiyiGeek.Jenkinsåˆ†å¸ƒå¼èŠ‚ç‚¹" title="" class=""></a>
                <p>WeiyiGeek.Jenkinsåˆ†å¸ƒå¼èŠ‚ç‚¹</p>
            </figure>
<p><br></p>
<h3 id="1-èŠ‚ç‚¹è¯´æ˜"><a href="#1-èŠ‚ç‚¹è¯´æ˜" class="headerlink" title="1.èŠ‚ç‚¹è¯´æ˜"></a>1.èŠ‚ç‚¹è¯´æ˜</h3><p>æè¿°: æˆ‘ä»¬åœ¨ä½¿ç”¨Jenkinsçš„æ—¶å€™ä¸€èˆ¬éƒ½ä¼šåˆ†ä¸ºserverèŠ‚ç‚¹ä¸agentèŠ‚ç‚¹(ä¹Ÿå¯ä»¥å« slave èŠ‚ç‚¹)ã€‚</p>
<ul>
<li>1) server ï¼šä¸»è¦ç”¨äºå¤„ç†è°ƒåº¦æ„å»ºä½œä¸šï¼ŒæŠŠæ„å»ºåˆ†å‘åˆ°slaveèŠ‚ç‚¹è¿›è¡Œå®é™…æ‰§è¡Œï¼Œç›‘è§†slaveèŠ‚ç‚¹çš„çŠ¶æ€ï¼ˆå¿…è¦æ—¶è®©å®ƒä»¬è¿›è¡Œä¸Šçº¿æˆ–è€…ç¦»çº¿ï¼‰ï¼Œè®°å½•å’Œå‘å¸ƒæ„å»ºäº§ç‰©ã€‚</li>
<li>2) agent ï¼š ä¸»è¦ç”¨äºå¤„ç†Jobä»»åŠ¡ç­‰ä¾‹å¦‚ç¼–è¯‘å’Œå‘å¸ƒ, agentèŠ‚ç‚¹å¯ä»¥åˆ†ä¸ºé™æ€èŠ‚ç‚¹å’ŒåŠ¨æ€èŠ‚ç‚¹;</li>
</ul>
<p><strong>èŠ‚ç‚¹ç±»å‹:</strong></p>
<ul>
<li>1) é™æ€èŠ‚ç‚¹æ˜¯å›ºå®šçš„ä¸€å°vmè™šæœºæˆ–è€…å®¹å™¨ã€‚</li>
<li>2) åŠ¨æ€èŠ‚ç‚¹æ˜¯éšç€ä»»åŠ¡çš„æ„å»ºæ¥è‡ªåŠ¨åˆ›å»ºagentèŠ‚ç‚¹ã€‚</li>
</ul>
<p><br></p>
<h3 id="2-èŠ‚ç‚¹è¿æ¥"><a href="#2-èŠ‚ç‚¹è¿æ¥" class="headerlink" title="2.èŠ‚ç‚¹è¿æ¥"></a>2.èŠ‚ç‚¹è¿æ¥</h3><p><strong>agentèŠ‚ç‚¹åŠ å…¥çš„ä¸¤ç§æ–¹å¼:</strong></p>
<ul>
<li>ssh : åœ¨Linuxç³»ç»Ÿä¸­æœ€æ–¹ä¾¿çš„å°±æ˜¯é€šè¿‡SSHå¯åŠ¨JenkinsèŠ‚ç‚¹,å…³é”®æ˜¯éœ€è¦å†Slaveæœºå™¨ä¸­å¼€å¯sshdæœåŠ¡ä»¥åŠç½‘ç»œè¿é€š;</li>
<li>jnlp ï¼šå…¼å®¹å„ç§æ“ä½œç³»ç»Ÿåªè¦ç½‘ç»œå¯ä»¥æ­£å¸¸é€šä¿¡éƒ½å¯ä»¥é‡‡ç”¨æ­¤ç§æ–¹æ³•(éœ€è¦å®‰è£…Javaç¯å¢ƒ);</li>
</ul>
<p><br/></p>
<h4 id="SSH-æ–¹å¼"><a href="#SSH-æ–¹å¼" class="headerlink" title="SSH æ–¹å¼"></a>SSH æ–¹å¼</h4><p>ç¯å¢ƒä¾èµ–: SSH Slaves plugin æ’ä»¶ ã€SSH Credentials Plugin æ’ä»¶ï¼ˆç®¡ç†è®¤è¯ç¥¨æ®ï¼‰<br>æ·»åŠ æµç¨‹: </p>
<ul>
<li>1ï¼‰ è¾“å…¥SlaveèŠ‚ç‚¹IP</li>
<li>2ï¼‰ æ·»åŠ Credentialsè®¤è¯ç¥¨æ®(è´¦å·å¯†ç ã€æˆ–ã€å¯†é’¥ç™»é™†)</li>
<li>3ï¼‰åœ¨è¿™é‡Œè®¾ç½®çš„credentialsåœ¨jenkinsçš„å…¶ä»–éœ€è¦credentialsçš„åœ°æ–¹ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ‹‰èœå•é€‰æ‹©ä½¿ç”¨ï¼Œæ¯”å¦‚æ·»åŠ slaveæ—¶å¯ä»¥ç›´æ¥åœ¨Credentialsä¸‹æ‹‰èœå•é‡Œé€‰æ‹©å¯¹åº”çš„credentialå°±è¡Œ</li>
</ul>
<p><br/></p>
<p><strong>ç”¨æˆ·å¯†ç æ–¹å¼æ·»åŠ :</strong><br>æ·»åŠ æµç¨‹:</p>
<ul>
<li>1) æ–°å»ºèŠ‚ç‚¹-&gt;è¾“å…¥èŠ‚ç‚¹IP</li>
<li>2ï¼‰åŸºç¡€ä¿¡æ¯é…ç½®</li>
<li>3) é€‰æ‹©Jenkinså‡­æ®</li>
<li>4ï¼‰å¯åŠ¨ä»£ç†</li>
</ul>
<p><strong>ç§é’¥æ–¹å¼æ–¹å¼æ·»åŠ :</strong><br>æ·»åŠ æµç¨‹:(ç›¸æ¯”äºä¸Šé¢çš„æµç¨‹å”¯ä¸€ä¸åŒçš„æ˜¯Jenkinså‡­æ®é€‰æ‹©ä¸º<code>ssh private key</code>) </p>
<ul>
<li>è®°ä½æ˜¯ç§é’¥ä¸æ˜¯å…¬é’¥ <code>cat .ssh/id_rsa</code> è¾“å…¥åˆ°Private Keyä¹‹ä¸­</li>
</ul>
<p><br/></p>
<h4 id="JNLP-æ–¹å¼"><a href="#JNLP-æ–¹å¼" class="headerlink" title="JNLP æ–¹å¼"></a>JNLP æ–¹å¼</h4><p>æè¿°: ä¸sshæ–¹å¼æ˜¯masterä¸»åŠ¨è¿æ¥slaveä¸åŒè€ŒJNLPæ–¹å¼æ˜¯slaveä¸»åŠ¨è¿æ¥masterã€‚</p>
<p>Tips : å¤åˆ¶èŠ‚ç‚¹åœ¨èŠ‚ç‚¹ç¯å¢ƒé…ç½®å¥½ä¹‹åï¼Œæˆ‘ä»¬å†æ·»åŠ èŠ‚ç‚¹å°±å¯ä»¥å¤åˆ¶äº†ä¿®æ”¹IPå’Œå…¶ä»–è‡ªå®šä¹‰é…ç½®å³å¯ã€‚</p>
<p>Tips : åœ¨éœ€è¦Jenkinså…¨å±€å®‰å…¨é…ç½®ä¸Šå¼€å¯ Inbound agents ç«¯å£ 50000/tcp ä»£ç†ç«¯å£, æ­¤ç«¯å£çš„ä½œç”¨æ˜¯ä¾¿äºAgentçš„jnlpä¸jenkinsçš„masterèŠ‚ç‚¹é—´è¿›è¡Œé€šä¿¡;</p>
<p><br></p>
<h3 id="3-ç‚¹æ˜ä¸»é¢˜"><a href="#3-ç‚¹æ˜ä¸»é¢˜" class="headerlink" title="3.ç‚¹æ˜ä¸»é¢˜"></a>3.ç‚¹æ˜ä¸»é¢˜</h3><p><strong>Q: ä¼ ç»ŸJenkinsçš„serverã€agentåˆ†å¸ƒå¼æ–¹æ¡ˆæœ‰ä»€ä¹ˆç¼ºé™·?</strong></p>
<ul>
<li>1.é«˜å¯ç”¨ç®¡ç†: Master èŠ‚ç‚¹å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶æ•´ä¸ªæµç¨‹éƒ½ä¸å¯ç”¨äº†;</li>
<li>2.é…ç½®ç®¡ç†ç»´æŠ¤: æ¯ä¸ª SlaveèŠ‚ç‚¹çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²</li>
<li>3.èµ„æºåˆ†é…ä¸å‡è¡¡ï¼šæœ‰çš„ SlaveèŠ‚ç‚¹è¦è¿è¡Œçš„jobå‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„SlaveèŠ‚ç‚¹å¤„äºç©ºé—²çŠ¶æ€</li>
<li>4.èµ„æºæµªè´¹ï¼š æ¯å° SlaveèŠ‚ç‚¹å¯èƒ½æ˜¯å®ä½“æœºæˆ–è€…VMï¼Œå½“SlaveèŠ‚ç‚¹å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æº</li>
</ul>
<p>Tips : æ­£å› ä¸ºä¸Šé¢çš„è¿™äº›ç§ç§ç—›ç‚¹æˆ‘ä»¬æ¸´æœ›ä¸€ç§æ›´é«˜æ•ˆæ›´å¯é çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ª CI/CD æµç¨‹ï¼Œè€Œ Docker è™šæ‹ŸåŒ–å®¹å™¨æŠ€æœ¯èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œåˆç‰¹åˆ«æ˜¯åœ¨ Kubernetes é›†ç¾¤ç¯å¢ƒä¸‹é¢èƒ½å¤Ÿæ›´å¥½æ¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¼•å…¥Kubernatesæ¥è§£å†³ï¼</p>
<p>Tips : åŸºäºKuberneteçš„CI/CDå¯ä»¥ä½¿ç”¨çš„å·¥å…·æœ‰å¾ˆå¤š, æ¯”å¦‚Jenkinsã€Gitlab CIå·²ç»æ–°å…´çš„droneä¹‹ç±»çš„éƒ½æ˜¯å¯ä»¥ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œå­¦ä¹ æ­å»ºå¹¶è½åœ°;</p>
<p><br></p>
<p><strong>Q: ä»€ä¹ˆæ˜¯ Kubernetes ? å®ƒæœ‰ä½•ä½œç”¨?</strong><br>ç­”: Kubernetes ï¼ˆç®€ç§°K8Sï¼‰æ˜¯Googleå¼€æºçš„å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œåœ¨DockeræŠ€æœ¯çš„åŸºç¡€ä¸Šï¼Œä¸ºå®¹å™¨åŒ–çš„åº”ç”¨æä¾›éƒ¨ç½²è¿è¡Œã€èµ„æºè°ƒåº¦ã€æœåŠ¡å‘ç°å’ŒåŠ¨æ€ä¼¸ç¼©ç­‰ä¸€ç³»åˆ—å®Œæ•´åŠŸèƒ½ï¼Œæé«˜äº†å¤§è§„æ¨¡å®¹å™¨é›†ç¾¤ç®¡ç†çš„ä¾¿æ·æ€§ã€‚<br>å…¶ä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li>1.ä½¿ç”¨Dockerå¯¹åº”ç”¨ç¨‹åºåŒ…è£…(package)ã€å®ä¾‹åŒ–(instantiate)ã€è¿è¡Œ(run)ã€‚</li>
<li>2.ä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œã€ç®¡ç†è·¨æœºå™¨çš„å®¹å™¨ã€‚ä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œã€ç®¡ç†è·¨æœºå™¨çš„å®¹å™¨ã€‚</li>
<li>3.è§£å†³ Dockerè·¨æœºå™¨å®¹å™¨ä¹‹é—´çš„é€šè®¯é—®é¢˜ã€‚è§£å†³Dockerè·¨æœºå™¨å®¹å™¨ä¹‹é—´çš„é€šè®¯é—®é¢˜ã€‚</li>
<li>4.Kubernetes çš„è‡ªæˆ‘ä¿®å¤æœºåˆ¶ä½¿å¾—å®¹å™¨é›†ç¾¤æ€»æ˜¯è¿è¡Œåœ¨ç”¨æˆ·æœŸæœ›çš„çŠ¶æ€ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113142559.png" target="_blank" title="WeiyiGeek.Kubernetes æ­å»º Jenkins é›†ç¾¤ç¤ºæ„å›¾" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113142559.png" alt="WeiyiGeek.Kubernetes æ­å»º Jenkins é›†ç¾¤ç¤ºæ„å›¾" title="" class=""></a>
                <p>WeiyiGeek.Kubernetes æ­å»º Jenkins é›†ç¾¤ç¤ºæ„å›¾</p>
            </figure>
<p>PS : ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ° <code>Jenkins Master å’Œ Jenkins Slave</code> ä»¥ Pod å½¢å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤çš„ Node ä¸Šï¼ŒMaster è¿è¡Œåœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†å…¶é…ç½®æ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ª Volume ä¸Šå»ï¼ŒSlave è¿è¡Œåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å®ƒä¸æ˜¯ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå®ƒä¼šæŒ‰ç…§éœ€æ±‚åŠ¨æ€çš„åˆ›å»ºå¹¶è‡ªåŠ¨åˆ é™¤ã€‚<br>PS : è¿™ç§æ–¹å¼çš„å·¥ä½œæµç¨‹å¤§è‡´ä¸ºå½“ Jenkins Master æ¥å—åˆ° Build è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é…ç½®çš„ Label åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¿è¡Œåœ¨ Pod ä¸­çš„ Jenkins Slave å¹¶æ³¨å†Œåˆ° Master ä¸Šï¼Œå½“è¿è¡Œå®Œ Job åï¼Œè¿™ä¸ª Slave ä¼šè¢«æ³¨é”€å¹¶ä¸”è¿™ä¸ª Pod ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ï¼Œæ¢å¤åˆ°æœ€åˆçŠ¶æ€</p>
<p><br></p>
<p><strong>Q: Kubernetsæ–¹å¼éƒ¨ç½²ç»™æˆ‘ä»¬å¸¦æ¥ä»€ä¹ˆå¥½å¤„?</strong></p>
<ul>
<li>1.æœåŠ¡é«˜å¯ç”¨ï¼Œå½“ Jenkins Master å‡ºç°æ•…éšœæ—¶ï¼ŒKubernetes ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Jenkins Master å®¹å™¨ï¼Œå¹¶ä¸”å°† Volume åˆ†é…ç»™æ–°åˆ›å»ºçš„å®¹å™¨ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä»è€Œè¾¾åˆ°é›†ç¾¤æœåŠ¡é«˜å¯ç”¨ã€‚</li>
<li>2.åŠ¨æ€ä¼¸ç¼©ï¼Œåˆç†ä½¿ç”¨èµ„æºï¼Œæ¯æ¬¡è¿è¡Œ Job æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Jenkins Slaveï¼ŒJob å®Œæˆåï¼ŒSlave è‡ªåŠ¨æ³¨é”€å¹¶åˆ é™¤å®¹å™¨ï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸” Kubernetes ä¼šæ ¹æ®æ¯ä¸ªèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ŒåŠ¨æ€åˆ†é… Slave åˆ°ç©ºé—²çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œé™ä½å‡ºç°å› æŸèŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œè¿˜æ’é˜Ÿç­‰å¾…åœ¨è¯¥èŠ‚ç‚¹çš„æƒ…å†µã€‚</li>
<li>3.æ‰©å±•æ€§å¥½ï¼Œå½“ Kubernetes é›†ç¾¤çš„èµ„æºä¸¥é‡ä¸è¶³è€Œå¯¼è‡´ Job æ’é˜Ÿç­‰å¾…æ—¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æ·»åŠ ä¸€ä¸ª Kubernetes Node åˆ°é›†ç¾¤ä¸­ï¼Œä»è€Œå®ç°æ‰©å±•ã€‚</li>
</ul>
<p><strong>å¸¸ç”¨ Kubernates + Harbor + Jenkins + gitlab æŒç»­é›†æˆæ–¹æ¡ˆï¼š</strong><br>Tips : å¤§è‡´å·¥ä½œæµç¨‹ <code>æ‰‹åŠ¨ /è‡ªåŠ¨æ„å»º -&gt; Jenkins è°ƒåº¦ K8S API -&gt; åŠ¨æ€ç”Ÿæˆ Jenkins Slave pod -&gt; Slave pod
æ‹‰å– Git ä»£ç ï¼ç¼–è¯‘ï¼æ‰“åŒ…é•œåƒ -&gt;æ¨é€åˆ°é•œåƒä»“åº“ Harbor -&gt; Slave å·¥ä½œå®Œæˆï¼ŒPod è‡ªåŠ¨é”€æ¯ -&gt; éƒ¨ç½²
åˆ°æµ‹è¯•æˆ–ç”Ÿäº§ Kuberneteså¹³å°</code>ã€‚ï¼ˆå®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥å¹²é¢„ï¼‰</p>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://img2020.cnblogs.com/blog/1829785/202006/1829785-20200603233012120-1568519709.png" target="_blank" title="weiyigeek.CI/CDé›†æˆ" data-fancybox="images"><img src="https://img2020.cnblogs.com/blog/1829785/202006/1829785-20200603233012120-1568519709.png" alt="weiyigeek.CI/CDé›†æˆ" title="" class=""></a>
                <p>weiyigeek.CI/CDé›†æˆ</p>
            </figure>
<p><br></p>
<h3 id="4-çŸ¥è¯†æ‰©å±•"><a href="#4-çŸ¥è¯†æ‰©å±•" class="headerlink" title="4.çŸ¥è¯†æ‰©å±•"></a>4.çŸ¥è¯†æ‰©å±•</h3><p><strong>(1) å®˜æ–¹çš„Jenkinsé•œåƒç½‘ç«™</strong><br>Hub Docker Images : <a href="https://hub.docker.com/r/jenkins/jenkins/" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/jenkins/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins</span><br></pre></td></tr></table></figure></p>
<p><strong>(2) Kubernetes æ’ä»¶å®˜æ–¹å¸®åŠ©</strong><br>kubernetes Plugs : <a href="https://plugins.jenkins.io/kubernetes/" target="_blank" rel="noopener">https://plugins.jenkins.io/kubernetes/</a></p>
<hr>
<h2 id="0x01-å®‰è£…éƒ¨ç½²"><a href="#0x01-å®‰è£…éƒ¨ç½²" class="headerlink" title="0x01 å®‰è£…éƒ¨ç½²"></a>0x01 å®‰è£…éƒ¨ç½²</h2><h3 id="0-åˆ†å¸ƒå¼æ¶æ„è¿‡ç¨‹è¯´æ˜"><a href="#0-åˆ†å¸ƒå¼æ¶æ„è¿‡ç¨‹è¯´æ˜" class="headerlink" title="(0) åˆ†å¸ƒå¼æ¶æ„è¿‡ç¨‹è¯´æ˜"></a>(0) åˆ†å¸ƒå¼æ¶æ„è¿‡ç¨‹è¯´æ˜</h3><p>å°† Jenkins çš„ <code>Master/Agent</code> åˆ†å¸ƒå¼æ¶æ„ç›´æ¥éƒ¨ç½²åœ¨å®¿ä¸»æœºä¸Šä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼›ä½†æ˜¯å®ƒä½œä¸ºä¸€ä¸ªå‘å®¹å™¨åŒ–è¿‡åº¦çš„ä¸­é—´é˜¶æ®µï¼Œæ˜¯å¿…è¦å­¦ä¹ æŒæ¡çš„ã€‚</p>
<p>Tips : æ•´ä¸ª Jenkins æœåŠ¡åˆ†å¸ƒå¼éƒ¨ç½²æ˜¯å¾ˆç®€å•çš„å…¶æ­¥éª¤ä¸ºï¼š</p>
<ul>
<li>éƒ¨ç½²ä¸€ä¸ª Jenkins Master èŠ‚ç‚¹ã€‚</li>
<li>é€šè¿‡ Jenkins çš„ WEB é¡µé¢ï¼Œåœ¨ Master èŠ‚ç‚¹ä¸Šæ·»åŠ  Agent node èŠ‚ç‚¹ã€‚</li>
<li>æ·»åŠ å®Œ Agent Node èŠ‚ç‚¹åï¼ŒJenkins Master ä¼šæä¾›éƒ¨ç½² Agent Node æœåŠ¡çš„è½¯ä»¶åŒ…å’Œå¯åŠ¨æ–¹å¼ï¼›ç›´æ¥æ‰¾å°æœåŠ¡å™¨ï¼Œæ ¹æ®æç¤ºè¿è¡Œå°±è¡Œã€‚</li>
</ul>
<h4 id="åœ¨-Master-èŠ‚ç‚¹ä¸­æ·»åŠ -Agent-æ–¹å¼"><a href="#åœ¨-Master-èŠ‚ç‚¹ä¸­æ·»åŠ -Agent-æ–¹å¼" class="headerlink" title="åœ¨ Master èŠ‚ç‚¹ä¸­æ·»åŠ  Agent æ–¹å¼"></a>åœ¨ Master èŠ‚ç‚¹ä¸­æ·»åŠ  Agent æ–¹å¼</h4><ul>
<li><p>Step 1.æ–°å»ºèŠ‚ç‚¹é¡µé¢çš„è®¿é—®è·¯å¾„<br>æè¿°: åœ¨ Jenkins æœåŠ¡çš„é¡µé¢ä¸Šæ‰¾åˆ°â€æ–°å»ºèŠ‚ç‚¹â€œçš„é¡µé¢ï¼›å®ƒçš„è®¿é—®è·¯å¾„å¦‚ä¸‹ï¼š <code>Manage Jenkins -ã€‹Manage Nodes and Cloudsï¼ˆç®¡ç†èŠ‚ç‚¹ï¼‰-ã€‹New Nodeï¼ˆæ–°å»ºèŠ‚ç‚¹ï¼‰</code></p>
</li>
<li><p>Step 2.èŠ‚ç‚¹åç§°å’ŒèŠ‚ç‚¹ç±»å‹<br>æè¿°ï¼šé€šè¿‡ä¸Šé¢çš„è®¿é—®è·¯å¾„ï¼Œè¿›å…¥æ·»åŠ èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªé¡µé¢ã€‚åœ¨è¿™é‡Œéœ€è¦å¡«å†™ä¸€ä¸‹ã€èŠ‚ç‚¹åç§°ã€‘å’Œé€‰æ‹©èŠ‚ç‚¹ç±»å‹ï¼Œä¸€èˆ¬é€‰æ‹©æ°¸ä¹…èŠ‚ç‚¹ [Permanent Agent] å³å¯</p>
</li>
<li><p>Step 3.åœ¨èŠ‚ç‚¹çš„è¯¦ç»†è®¾ç½®é¡µé¢ä¸­å¡«å†™æ›´å¤šä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* é…ç½®é¡¹ 	é…ç½®é¡¹è¯´æ˜/é…ç½®ä¿¡æ¯</span><br><span class="line">* Name/åç§° 	Jenkins Agent çš„åç§°</span><br><span class="line">* of executors / å¹¶å‘æ‰§è¡Œæ•° 	Agent èŠ‚ç‚¹å¯ä»¥åŒæ—¶æ‰§è¡Œå‡ ä¸ª Job</span><br><span class="line">* Remote root directory / è¿œç¨‹å·¥ä½œç›®å½• 	ä»èŠ‚ç‚¹ä¸Šjenkins agentçš„å·¥ä½œç›®å½•ï¼Œæ¨èåªç”¨ç»å¯¹è·¯å¾„ï¼Œå¦‚/home//jenkins-agentã€‚æ³¨æ„jenkinsè¦æœ‰è¯¥ç›®å½•çš„è¯»å†™æƒé™</span><br><span class="line">* Labels / æ ‡ç­¾ 	ç»™AgentèŠ‚ç‚¹è®¾ç½®æ ‡ç­¾ï¼›Job ä»»åŠ¡å¯ä»¥æ ¹æ®æ ‡ç­¾é€‰æ‹©ç‰¹å®šçš„ Agent èŠ‚ç‚¹æ‰§è¡Œã€‚</span><br><span class="line">* Usage / Agent èŠ‚ç‚¹çš„ä½¿ç”¨æ–¹æ³• 	æœ‰ä¸¤ç§æ–¹å¼ï¼š1ã€å°½é‡ä½¿ç”¨æ­¤Agentæ‰§è¡Œä»»åŠ¡ï¼›2ã€åªæ‰§è¡Œæ ‡ç­¾åŒ¹é…çš„ä»»åŠ¡ã€‚</span><br><span class="line">* Lanuch method / Agent å¯åŠ¨æ–¹æ³• 	æœ‰å¤šç§é€‰æ‹©ï¼Œè¿™é‡Œä½¿ç”¨â€Launch agent by connecting it to the masterâ€œ/é€šè¿‡å°† Agent è¿æ¥åˆ° Master æ¥å¯åŠ¨å®ƒ</span><br><span class="line">* å…¶ä»–çš„é…ç½®é¡¹å¯ä»¥é€‰æ‹©é»˜è®¤çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æ›´åŠ è‡ªå·±çš„ç†è§£è®¾ç½®ã€‚</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 4.è·å–éƒ¨ç½² Agent çš„æ–¹æ³•<br>æè¿°: ä¸Šé¢çš„æ­¥éª¤æ“ä½œå®Œæˆåï¼Œå°±ä¼šæœ‰ä¸ªå±•ç¤ºé…ç½® Agent èŠ‚ç‚¹çš„é¡µé¢ã€‚å…¶ä¸­æä¾›äº†ä¸¤ä¸­éƒ¨ç½² Agent çš„æ–¹å¼ï¼Œæˆ‘ä»¬é€‰æ‹©ç¬¬äºŒç§ã€‚</p>
</li>
<li><p>Step 5.åœ¨ Agent æœåŠ¡å™¨çš„å‘½ä»¤è¡Œæ‰§è¡Œå¯åŠ¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1.å°†å¯†ç é€šè¿‡å‘½ä»¤è¡Œç›´æ¥ä¼ å…¥(ä¸å®‰å…¨)</span></span><br><span class="line">java -jar agent.jar -jnlpUrl http://jenkins.example.com/computer/agent-test/slave-agent.jnlp -secret d4abba3f13324b85ab2997e22c3442045bb86fcd213f79fa01416a5fd0399a18 -workDir <span class="string">""</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2.å°†å¯†ç ä¿¡æ¯å†™å…¥åˆ°æ–‡ä»¶ä¸­ Agent å¯åŠ¨æ–¹å¼</span></span><br><span class="line"><span class="built_in">echo</span> d4abba3f13324b85ab2997e22c3442045bb86fcd213f79fa01416a5fd0399a18 &gt; secret-file</span><br><span class="line">java -jar agent.jar -jnlpUrl http://jenkins.example.com/computer/agent-test/slave-agent.jnlp -secret @secret-file -workDir <span class="string">""</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h3 id="1-å•ä¸»æœºéƒ¨ç½²é…ç½®å›ºå®š-agent"><a href="#1-å•ä¸»æœºéƒ¨ç½²é…ç½®å›ºå®š-agent" class="headerlink" title="(1) å•ä¸»æœºéƒ¨ç½²é…ç½®å›ºå®š agent"></a>(1) å•ä¸»æœºéƒ¨ç½²é…ç½®å›ºå®š agent</h3><p>æè¿°: æ·»åŠ ä¸€ä¸ªæ™®é€šã€å›ºå®š(æ°¸ä¹…)çš„èŠ‚ç‚¹åˆ°Jenkinså³ç»™ Jenkins å¢åŠ äº†ä¸€ä¸ªæ™®é€šçš„æ°¸ä¹…ä»£ç†äººï¼›ä¹‹æ‰€ä»¥å«åšâ€œå›ºå®šâ€æ˜¯å› ä¸ºJenkinsæ²¡ç»™è¿™ç§èŠ‚ç‚¹æä¾›æ›´é«˜çº§çš„é›†æˆæ–¹å¼;</p>
<ul>
<li>ä¾‹å¦‚ï¼šåŠ¨æ€é…ç½®ã€‚æ²¡æœ‰å…¶ä»–ä»£ç†ç±»å‹èƒ½é€‰æ‹©çš„è¯å¯ä»¥é€‰æ‹©è¯¥ä»£ç†ç±»å‹ï¼›</li>
<li>ä¾‹å¦‚ï¼Œä½ åœ¨æ·»åŠ ä¸å—Jenkinsç®¡ç†çš„ç‰©ç†æœºã€åœ¨Jenkinså¤–éƒ¨ç®¡ç†çš„è™šæ‹Ÿæœºç­‰ã€‚</li>
</ul>
<p><br/></p>
<p><strong>ç¯å¢ƒå‡†å¤‡:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04.1 LTS</span><br><span class="line">Release:        20.04</span><br><span class="line">Codename:       focal</span><br><span class="line"></span><br><span class="line">kubernetes å®‰è£…çš„ Jenkins 2.275 : `http://jenkins.weiyigeek.top:8080/`</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h4 id="Java-Web-å¯åŠ¨-Agent-æ–¹å¼"><a href="#Java-Web-å¯åŠ¨-Agent-æ–¹å¼" class="headerlink" title="Java Web å¯åŠ¨ Agent æ–¹å¼"></a>Java Web å¯åŠ¨ Agent æ–¹å¼</h4><p><strong>Q: å¦‚ä½•å®ç°Jenkinsåˆ†å¸ƒå¼æ„å»º?</strong></p>
<ul>
<li><p>Step 1.å¼€å¯ä»£ç†ç¨‹åºçš„TCPç«¯å£ï¼šManage Jenkins -&gt; Configure Global Security(å…¨å±€å®‰å…¨é…ç½®) -&gt; ä»£ç† -&gt; è®¾ç½®ä¸ºå›ºå®šçš„50000ç«¯å£</p>
</li>
<li><p>Step 2.åœ¨ Manage Jenkins -&gt; Manage Nodes èŠ‚ç‚¹åˆ—è¡¨ -&gt; æ–°å¢èŠ‚ç‚¹ -&gt; èŠ‚ç‚¹åç§°ï¼ˆagent-æœºå™¨åç§°ï¼‰-&gt; æ·»åŠ ä¸€ä¸ªæ™®é€šã€å›ºå®šçš„èŠ‚ç‚¹åˆ°Jenkins;</p>
</li>
<li><p>Step 3.æ­¤æ—¶æœ‰ä¸¤ç§ Slave èŠ‚ç‚¹è¿æ¥MasterèŠ‚ç‚¹çš„æ–¹æ³• -&gt; (<code>Launch agent by connecting it to the master</code> æˆ–è€… <code>é€šè¿‡Java Webå¯åŠ¨ä»£ç†</code>) ;<br>æè¿°: ä½¿ç”¨<code>Java Web Start</code>å°±å¿…é¡»åœ¨Agentæœºå™¨ä¸Šæ‰“å¼€JNLPæ–‡ä»¶ï¼Œç„¶åå°†åˆ›å»ºåˆ°JenkinsæœåŠ¡å™¨çš„TCPè¿æ¥ï¼Œæ„å‘³ç€<code>ä¸éœ€è¦JenkinsæœåŠ¡å™¨è®¿é—®Agent è€Œæ˜¯Agentèƒ½å¤Ÿé“¾æ¥åˆ°Jenkins Serverå³å¯</code>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨å‘½ä»¤è¡Œä¸­å¯åŠ¨èŠ‚ç‚¹</span></span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 -workDir <span class="string">"/home/jenkins"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run from agent command line, with the secret stored in a file:</span></span><br><span class="line"><span class="built_in">echo</span> 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 &gt; secret-file</span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret @secret-file -workDir <span class="string">"/home/jenkins"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203194425.png" target="_blank" title="WeiyiGeek.Create-Node" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203194425.png" alt="WeiyiGeek.Create-Node" title="" class=""></a>
                <p>WeiyiGeek.Create-Node</p>
            </figure>
<ul>
<li><p>Step 4.é‡‡ç”¨<code>VMæ–¹å¼</code>è¿è¡Œagent.jarè¿æ¥åˆ°Jenkinsçš„ServerèŠ‚ç‚¹, é¦–å…ˆæˆ‘ä»¬çŸ¥é“ä¸Šé¢çš„agent.jarå’Œsecretä¿¡æ¯ç­‰;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) æˆ‘ä»¬åœ¨ä¸€å°LinuxæœåŠ¡å™¨ä¸­ä¸‹è½½agent.jarå’Œå¯åŠ¨è¿æ¥ã€‚</span></span><br><span class="line">wget http://192.168.12.107:30001/jnlpJars/agent.jar</span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 -workDir <span class="string">"/home/jenkins"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) è¿è¡Œåè¾“å…¥ä»¥ä¸‹æ—¥å¿—</span></span><br><span class="line">  <span class="comment"># INFO: Agent discovery successful</span></span><br><span class="line">  <span class="comment"># Agent address: 192.168.1.200</span></span><br><span class="line">  <span class="comment"># Agent port:    30081</span></span><br><span class="line">  <span class="comment"># Identity:      0b:a1:da:6c:8e:e2:ca:f8:17:f6:b7:ee:cb:ff:84:0d</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Handshaking</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connecting to 192.168.1.200:30081</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Trying protocol: JNLP4-connect</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:29 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Remote identity confirmed: 0b:a1:da:6c:8e:e2:ca:f8:17:f6:b7:ee:cb:ff:84:0d</span></span><br><span class="line">  <span class="comment"># Jul 24, 2020 5:57:30 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connected   # è¡¨ç¤º æˆåŠŸ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) ä½¿ç”¨nohupåå°è¿è¡Œagent</span></span><br><span class="line">nohup java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-1/jenkins-agent.jnlp -secret 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 -workDir <span class="string">"/home/jenkins"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.é‡‡ç”¨<code>Dockeræ–¹å¼</code>è¿è¡Œagent.jarè¿æ¥åˆ°Jenkinsçš„ServerèŠ‚ç‚¹, æ­¤ç§æ–¹å¼éå¸¸ç®€å•æ‹‰å–é•œåƒå’Œå¯åŠ¨é•œåƒï¼›<br>å‚è€ƒè¿æ¥: <a href="https://hub.docker.com/r/jenkins/inbound-agent" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/inbound-agent</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) æ‹‰å–é•œåƒ</span></span><br><span class="line">docker pull jenkins/inbound-agent:alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) è·å– Jenkins çš„ SVC åœ°å€(ç”±äºæˆ‘çš„Masteræ˜¯é‡‡ç”¨K8sæ­å»ºçš„)</span></span><br><span class="line">~$ kubectl get svc -n devops</span><br><span class="line">  <span class="comment"># NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span></span><br><span class="line">  <span class="comment"># jenkins          NodePort    10.99.55.239     &lt;none&gt;        8080:30001/TCP,50000:32001/TCP   19d</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) å¯åŠ¨ agent é•œåƒ(æ³¨æ„å‚æ•°)</span></span><br><span class="line"><span class="comment"># docker run --init jenkins/inbound-agent -url http://jenkins-server:port -workDir=/home/jenkins/agent &lt;secret&gt; &lt;agent name&gt;</span></span><br><span class="line">~$ docker run -d --name jenkins-agent --init jenkins/inbound-agent:alpine -url http://10.99.55.239:8080 -workDir=/home/jenkins/agent 52e2e9b37cd4a36310d39984ff461b48ef95b40101a4d34875b7248a7622bd92 node-1</span><br><span class="line">c7a00c89f92f16c07d35e572d2ba9da3c17c47a2746e46e3d3225bff418a78f3</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) æŸ¥çœ‹æ˜¯å¦å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">~$ docker logs c7a00c89f92f16c07d35e572d2ba9da3c17c47a2746e46e3d3225bff418a78f3</span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:39 AM hudson.remoting.jnlp.Main createEngine</span></span><br><span class="line">  <span class="comment"># INFO: Setting up agent: node-1</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:39 AM hudson.remoting.jnlp.Main$CuiListener &lt;init&gt;</span></span><br><span class="line">  <span class="comment"># INFO: Jenkins agent is running in headless mode.</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.Engine startEngine</span></span><br><span class="line">  <span class="comment"># INFO: Using Remoting version: 4.6</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM org.jenkinsci.remoting.engine.WorkDirManager initializeWorkDir</span></span><br><span class="line">  <span class="comment"># INFO: Using /home/jenkins/agent/remoting as a remoting work directory</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM org.jenkinsci.remoting.engine.WorkDirManager setupLogging</span></span><br><span class="line">  <span class="comment"># INFO: Both error and output logs will be printed to /home/jenkins/agent/remoting</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Locating server among [http://10.99.55.239:8080]</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver resolve</span></span><br><span class="line">  <span class="comment"># INFO: Remoting server accepts the following protocols: [JNLP4-connect, Ping]</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Agent discovery successful</span></span><br><span class="line">  <span class="comment">#   Agent address: 10.99.55.239</span></span><br><span class="line">  <span class="comment">#   Agent port:    50000</span></span><br><span class="line">  <span class="comment">#   Identity:      8e:c7:1e:e1:39:ee:f4:2a:43:f6:aa:d9:0e:b7:b6:62</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Handshaking</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connecting to 10.99.55.239:50000</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:57:40 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Trying protocol: JNLP4-connect</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:58:00 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Remote identity confirmed: 8e:c7:1e:e1:39:ee:f4:2a:43:f6:aa:d9:0e:b7:b6:62</span></span><br><span class="line">  <span class="comment"># Feb 03, 2021 11:58:02 AM hudson.remoting.jnlp.Main$CuiListener status</span></span><br><span class="line">  <span class="comment"># INFO: Connected   # è¡¨ç¤ºè¿æ¥æˆåŠŸ</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203200129.png" target="_blank" title="WeiyiGeek.jenkins-agent-docker" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203200129.png" alt="WeiyiGeek.jenkins-agent-docker" title="" class=""></a>
                <p>WeiyiGeek.jenkins-agent-docker</p>
            </figure>
<ul>
<li>Step 6.é‡‡ç”¨kubernetesé›†ç¾¤ä»¥é™æ€çš„æ–¹å¼éƒ¨ç½²agentï¼Œæˆ‘ä»¬é¦–å…ˆç¼–å†™ä¸€ä¸ªéƒ¨ç½²æ–‡ä»¶ï¼Œå¹¶ä¸”å®šä¹‰å¥½åç§°ç©ºé—´ã€é•œåƒã€agenté…ç½®ä¿¡æ¯ã€‚åŒæ ·æ­¤å¤„æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªnode-2çš„agentèŠ‚ç‚¹;</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (0) åœ¨å‘½ä»¤è¡Œä¸­å¯åŠ¨èŠ‚ç‚¹å‚æ•°å®ä¾‹ (æ³¨æ„K8sä¸‹é¢çš„ç¯å¢ƒå˜é‡)</span></span><br><span class="line">java -jar agent.jar -jnlpUrl http://192.168.12.107:30001/computer/node-2/jenkins-agent.jnlp -secret a06d5adaef69cbaf34e9296d8340d464163ab9f5bbf6b465a290237dc38d45db -workDir <span class="string">"/home/jenkins/agent"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) Jenkins-agent-Deployment èµ„æºæ¸…å•</span></span><br><span class="line">cat &gt; Jenkins-agent-Deployment.yaml &lt;&lt;<span class="string">'END'</span></span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins-agent</span><br><span class="line">  name: jenkins-agent-node2</span><br><span class="line">  namespace: devops</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: jenkins-agent-node</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: jenkins-agent-node</span><br><span class="line">      namespace: devops</span><br><span class="line">      name: jenkins-agent-node2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: jenkins-agent</span><br><span class="line">          image: jenkins/inbound-agent:alpine</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 1000m</span><br><span class="line">              memory: 2Gi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 500m</span><br><span class="line">              memory: 512Mi</span><br><span class="line">          env:</span><br><span class="line">            - name: JENKINS_URL</span><br><span class="line">              value: http://10.99.55.239:8080</span><br><span class="line">            - name: JENKINS_SECRET</span><br><span class="line">              value: a06d5adaef69cbaf34e9296d8340d464163ab9f5bbf6b465a290237dc38d45db</span><br><span class="line">            - name: JENKINS_AGENT_NAME</span><br><span class="line">              value: node-2</span><br><span class="line">            - name: JENKINS_AGENT_WORKDIR</span><br><span class="line">              value: /home/jenkins/workspace</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="comment"># JENKINS_URL: url for the Jenkins server, can be used as a replacement to -url option, or to set alternate jenkins URL</span></span><br><span class="line"><span class="comment"># JENKINS_TUNNEL: (HOST:PORT) connect to this agent host and port instead of Jenkins server, assuming this one do route TCP traffic to Jenkins master</span></span><br><span class="line"><span class="comment"># JENKINS_SECRET: agent secret, if not set as an argument</span></span><br><span class="line"><span class="comment"># JENKINS_AGENT_NAME: agent name, if not set as an argument</span></span><br><span class="line"><span class="comment"># JENKINS_AGENT_WORKDIR: agent work directory, if not set by optional parameter -workDir</span></span><br><span class="line"><span class="comment"># JENKINS_WEB_SOCKET: true if the connection should be made via WebSocket rather than TCP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2)é€šè¿‡kubectlå·¥å…·åœ¨k8sé›†ç¾¤ä¸­éƒ¨ç½²`jenkins agent deployment`å¹¶æŸ¥éªŒçŠ¶æ€</span></span><br><span class="line">kubectl create -f Jenkins-agent-Deployment.yaml</span><br><span class="line">  <span class="comment"># deployment.apps/jenkins-agent-node2 created</span></span><br><span class="line"></span><br><span class="line">~/k8s/jenkins$ kubectl get pod -n devops -o wide | grep <span class="string">"jenkins-agent"</span></span><br><span class="line">  <span class="comment"># jenkins-agent-node2-574bb65cb8-5kh7g   1/1     Running   0          29s     172.16.182.237 </span></span><br><span class="line"></span><br><span class="line">~/k8s/jenkins$ kubectl logs -f jenkins-agent-node2-574bb65cb8-5kh7g -n devops</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) åœ¨ä¼ å…¥JENKINS_URLæ—¶å»ºè®®å°½é‡é‡‡ç”¨åŸŸåçš„æ–¹å¼;</span></span><br><span class="line">~/k8s/jenkins$ kubectl <span class="built_in">exec</span> -it jenkins-agent-node2-574bb65cb8-5kh7g -n devops bash</span><br><span class="line">  <span class="comment"># bash-5.0$ ping jenkins.devops</span></span><br><span class="line">  <span class="comment"># PING jenkins.devops (10.99.55.239): 56 data bytes</span></span><br><span class="line">  <span class="comment"># bash-5.0$ ping jenkins.devops.svc.cluster.local</span></span><br><span class="line">  <span class="comment"># PING jenkins.devops.svc.cluster.local (10.99.55.239): 56 data bytes</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203202042.png" target="_blank" title="WeiyiGeek.kubernetes-jenkins-agent" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210203202042.png" alt="WeiyiGeek.kubernetes-jenkins-agent" title="" class=""></a>
                <p>WeiyiGeek.kubernetes-jenkins-agent</p>
            </figure>
<p><br></p>
<h4 id="Launch-agents-via-SSH-å¯åŠ¨-Agent-æ–¹å¼"><a href="#Launch-agents-via-SSH-å¯åŠ¨-Agent-æ–¹å¼" class="headerlink" title="Launch agents via SSH å¯åŠ¨ Agent æ–¹å¼"></a>Launch agents via SSH å¯åŠ¨ Agent æ–¹å¼</h4><p>æè¿°: å½“å‰Jenkins 2.277ç‰ˆæœ¬é»˜è®¤æ˜¯ä¸æ”¯æŒSSH å¯åŠ¨ Agent æ–¹å¼, æˆ‘ä»¬éœ€è¦å®‰è£…ssh Agentæ’ä»¶;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSH Agent - This plugin allows you to provide SSH credentials to builds via a ssh-agent <span class="keyword">in</span> Jenkins</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li><p>Step 1.é¦–å…ˆåˆ›å»ºä¸€ä¸ªå‡­æ®å­˜å‚¨æœåŠ¡å™¨è®¤è¯ä¿¡æ¯ã€‚</p>
</li>
<li><p>Step 2.ä¹‹ååˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ·»åŠ ä»¥ä¸‹é…ç½®ã€‚é…ç½®sshçš„ä¸»æœºå’Œè®¤è¯ä¿¡æ¯æœ€åä¿å­˜(agenté…ç½®å®Œæˆ)ã€‚</p>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204090727.png" target="_blank" title="WeiyiGeek.ssh-agent" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204090727.png" alt="WeiyiGeek.ssh-agent" title="" class=""></a>
                <p>WeiyiGeek.ssh-agent</p>
            </figure>
<ul>
<li>Step 3.ä¿å­˜ååˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„Pipelineé¡¹ç›®<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  <span class="comment">// æ­¤å¤„agentæŒ‡ä»¤æ˜¯å¿…é¡»çš„</span></span><br><span class="line">  agent none</span><br><span class="line">  stages &#123;</span><br><span class="line">    <span class="comment">// docker æ„å»ºçš„</span></span><br><span class="line">    stage (<span class="string">'node-1'</span>)&#123;</span><br><span class="line">      agent &#123;</span><br><span class="line">        node &#123; label <span class="string">"docker-jenkins-slave"</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"----- node-1 ------"</span></span><br><span class="line">        sh <span class="string">"hostname &amp;&amp; ifconfig"</span></span><br><span class="line">        sh <span class="string">"env"</span></span><br><span class="line">        echo <span class="string">"----- node-1 end------"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// k8s é›†ç¾¤ä¸­æ„å»ºçš„</span></span><br><span class="line">     stage (<span class="string">'node-2'</span>)&#123;</span><br><span class="line">      agent &#123;</span><br><span class="line">        node &#123; label <span class="string">"k8s-node-2"</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"----- node-2 ------"</span></span><br><span class="line">        sh <span class="string">"hostname &amp;&amp; ifconfig"</span></span><br><span class="line">        sh <span class="string">"env"</span></span><br><span class="line">        echo <span class="string">"----- node-2 end------"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>è¾“å‡ºç»“æœ:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">Started by user Jenkins ç®¡ç†å‘˜</span><br><span class="line">Running <span class="keyword">in</span> Durability level: MAX_SURVIVABILITY</span><br><span class="line">[Pipeline] Start of Pipeline</span><br><span class="line">[Pipeline] stage</span><br><span class="line"></span><br><span class="line">[Pipeline] &#123; (node-1)</span><br><span class="line">Running on node-1 <span class="keyword">in</span> /home/jenkins/workspace/pineline-use-node</span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-1 ------</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ hostname</span><br><span class="line">c7a00c89f92f</span><br><span class="line">+ ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  </span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:10783 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:14915 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:38664627 (36.8 MiB)  TX bytes:5669411 (5.4 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[Pipeline] sh</span><br><span class="line">  <span class="comment"># + env</span></span><br><span class="line">  <span class="comment"># JENKINS_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># LANGUAGE=en_US:en</span></span><br><span class="line">  <span class="comment"># RUN_CHANGES_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=changes</span></span><br><span class="line">  <span class="comment"># HOSTNAME=c7a00c89f92f</span></span><br><span class="line">  <span class="comment"># NODE_LABELS=docker-jenkins-slave node-1</span></span><br><span class="line">  <span class="comment"># HUDSON_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># SHLVL=3</span></span><br><span class="line">  <span class="comment"># HOME=/home/jenkins</span></span><br><span class="line">  <span class="comment"># BUILD_URL=http://192.168.12.107:30001/job/pineline-use-node/3/</span></span><br><span class="line">  <span class="comment"># HUDSON_COOKIE=de8bbafb-13fd-42d5-99a4-7ffaebf9a3e2</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVER_COOKIE=durable-8dd62800688ecbc8d9c9e78a15c49a2d</span></span><br><span class="line">  <span class="comment"># WORKSPACE=/home/jenkins/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># JAVA_VERSION=jdk8u272-b10</span></span><br><span class="line">  <span class="comment"># NODE_NAME=node-1</span></span><br><span class="line">  <span class="comment"># RUN_ARTIFACTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=artifacts</span></span><br><span class="line">  <span class="comment"># STAGE_NAME=node-1</span></span><br><span class="line">  <span class="comment"># EXECUTOR_NUMBER=0</span></span><br><span class="line">  <span class="comment"># RUN_TESTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=tests</span></span><br><span class="line">  <span class="comment"># BUILD_DISPLAY_NAME=#3</span></span><br><span class="line">  <span class="comment"># HUDSON_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># AGENT_WORKDIR=/home/jenkins/agent</span></span><br><span class="line">  <span class="comment"># JOB_BASE_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line">  <span class="comment"># BUILD_ID=3</span></span><br><span class="line">  <span class="comment"># BUILD_TAG=jenkins-pineline-use-node-3</span></span><br><span class="line">  <span class="comment"># LANG=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># JENKINS_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># JOB_URL=http://192.168.12.107:30001/job/pineline-use-node/</span></span><br><span class="line">  <span class="comment"># BUILD_NUMBER=3</span></span><br><span class="line">  <span class="comment"># JENKINS_NODE_COOKIE=a822e652-5870-44ef-b671-d6c1f2afaffb</span></span><br><span class="line">  <span class="comment"># RUN_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect</span></span><br><span class="line">  <span class="comment"># HUDSON_SERVER_COOKIE=04b411a999365c6a</span></span><br><span class="line">  <span class="comment"># JOB_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/display/redirect</span></span><br><span class="line">  <span class="comment"># JOB_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># LC_ALL=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># JAVA_HOME=/opt/java/openjdk</span></span><br><span class="line">  <span class="comment"># PWD=/home/jenkins/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># WORKSPACE_TMP=/home/jenkins/workspace/pineline-use-node@tmp</span></span><br><span class="line">  <span class="comment"># GITLAB_OBJECT_KIND=none</span></span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-1 end------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Pipeline] stage</span><br><span class="line">[Pipeline] &#123; (node-2)</span><br><span class="line">Running on node-2 <span class="keyword">in</span> /home/jenkins/agent/workspace/pineline-use-node</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-2 ------</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ hostname</span><br><span class="line">jenkins-agent-node2-574bb65cb8-5kh7g</span><br><span class="line">+ ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 5E:A7:08:EA:68:0F  </span><br><span class="line">          inet addr:172.16.182.237  Bcast:172.16.182.237  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1480  Metric:1</span><br><span class="line">          RX packets:8149 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:11311 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:30953238 (29.5 MiB)  TX bytes:4382625 (4.1 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">[Pipeline] sh</span><br><span class="line">  <span class="comment"># + env</span></span><br><span class="line">  <span class="comment"># JENKINS_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># JENKINS_SECRET=a06d5adaef69cbaf34e9296d8340d464163ab9f5bbf6b465a290237dc38d45db</span></span><br><span class="line">  <span class="comment"># agentType=k8s</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT=tcp://10.96.0.1:443</span></span><br><span class="line">  <span class="comment"># KUBERNETES_SERVICE_PORT=443</span></span><br><span class="line">  <span class="comment"># LANGUAGE=en_US:en</span></span><br><span class="line">  <span class="comment"># RUN_CHANGES_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=changes</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP_ADDR=10.100.233.217</span></span><br><span class="line">  <span class="comment"># HOSTNAME=jenkins-agent-node2-574bb65cb8-5kh7g</span></span><br><span class="line">  <span class="comment"># SHLVL=3</span></span><br><span class="line">  <span class="comment"># NODE_LABELS=k8s-node-2 node-2</span></span><br><span class="line">  <span class="comment"># HUDSON_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># HOME=/home/jenkins</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP_PORT=9000</span></span><br><span class="line">  <span class="comment"># BUILD_URL=http://192.168.12.107:30001/job/pineline-use-node/3/</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># HUDSON_COOKIE=c088e600-327b-4e78-a80e-4ba7bd7254f3</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVER_COOKIE=durable-4d6313311ef99675e2bfd51284774a87</span></span><br><span class="line">  <span class="comment"># JENKINS_AGENT_WORKDIR=/home/jenkins/workspace</span></span><br><span class="line">  <span class="comment"># SONARQUBE_SERVICE_HOST=10.100.233.217</span></span><br><span class="line">  <span class="comment"># WORKSPACE=/home/jenkins/agent/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># JAVA_VERSION=jdk8u272-b10</span></span><br><span class="line">  <span class="comment"># NODE_NAME=node-2</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT_9000_TCP=tcp://10.100.233.217:9000</span></span><br><span class="line">  <span class="comment"># RUN_ARTIFACTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=artifacts</span></span><br><span class="line">  <span class="comment"># STAGE_NAME=node-2</span></span><br><span class="line">  <span class="comment"># EXECUTOR_NUMBER=1</span></span><br><span class="line">  <span class="comment"># SONARQUBE_SERVICE_PORT=9000</span></span><br><span class="line">  <span class="comment"># SONARQUBE_PORT=tcp://10.100.233.217:9000</span></span><br><span class="line">  <span class="comment"># RUN_TESTS_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect?page=tests</span></span><br><span class="line">  <span class="comment"># BUILD_DISPLAY_NAME=#3</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP_ADDR=10.99.55.239</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1</span></span><br><span class="line">  <span class="comment"># HUDSON_HOME=/var/jenkins_home</span></span><br><span class="line">  <span class="comment"># AGENT_WORKDIR=/home/jenkins/agent</span></span><br><span class="line">  <span class="comment"># JOB_BASE_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_HOST=10.99.55.239</span></span><br><span class="line">  <span class="comment"># SONARQUBE_SERVICE_PORT_SONARQUBE=9000</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP_ADDR=10.99.55.239</span></span><br><span class="line">  <span class="comment"># BUILD_ID=3</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP_PORT=50000</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP_PORT=443</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_PORT_AGENT=50000</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># BUILD_TAG=jenkins-pineline-use-node-3</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># JENKINS_URL=http://192.168.12.107:30001/</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP_PORT=8080</span></span><br><span class="line">  <span class="comment"># LANG=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># JOB_URL=http://192.168.12.107:30001/job/pineline-use-node/</span></span><br><span class="line">  <span class="comment"># JENKINS_AGENT_NAME=node-2</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP_PROTO=tcp</span></span><br><span class="line">  <span class="comment"># BUILD_NUMBER=3</span></span><br><span class="line">  <span class="comment"># JENKINS_NODE_COOKIE=243aa3e8-0de2-4297-b617-8764795f5cab</span></span><br><span class="line">  <span class="comment"># RUN_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/3/display/redirect</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT=tcp://10.99.55.239:8080</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_PORT=8080</span></span><br><span class="line">  <span class="comment"># HUDSON_SERVER_COOKIE=04b411a999365c6a</span></span><br><span class="line">  <span class="comment"># JOB_DISPLAY_URL=http://192.168.12.107:30001/job/pineline-use-node/display/redirect</span></span><br><span class="line">  <span class="comment"># KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_50000_TCP=tcp://10.99.55.239:50000</span></span><br><span class="line">  <span class="comment"># KUBERNETES_SERVICE_PORT_HTTPS=443</span></span><br><span class="line">  <span class="comment"># JOB_NAME=pineline-use-node</span></span><br><span class="line">  <span class="comment"># LC_ALL=en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># PWD=/home/jenkins/agent/workspace/pineline-use-node</span></span><br><span class="line">  <span class="comment"># JENKINS_PORT_8080_TCP=tcp://10.99.55.239:8080</span></span><br><span class="line">  <span class="comment"># JAVA_HOME=/opt/java/openjdk</span></span><br><span class="line">  <span class="comment"># KUBERNETES_SERVICE_HOST=10.96.0.1</span></span><br><span class="line">  <span class="comment"># JENKINS_SERVICE_PORT_WEB=8080</span></span><br><span class="line">  <span class="comment"># WORKSPACE_TMP=/home/jenkins/agent/workspace/pineline-use-node@tmp</span></span><br><span class="line">  <span class="comment"># GITLAB_OBJECT_KIND=none</span></span><br><span class="line">[Pipeline] <span class="built_in">echo</span></span><br><span class="line">----- node-2 end------</span><br><span class="line">[Pipeline] End of Pipeline</span><br><span class="line">Finished: SUCCESS</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204105425.png" target="_blank" title="WeiyiGeek.Pipelineæµæ°´çº¿é€‰æ‹©" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204105425.png" alt="WeiyiGeek.Pipelineæµæ°´çº¿é€‰æ‹©" title="" class=""></a>
                <p>WeiyiGeek.Pipelineæµæ°´çº¿é€‰æ‹©</p>
            </figure>
<hr>
<h3 id="2-é›†ç¾¤æ­å»ºJenkins-Master-èŠ‚ç‚¹"><a href="#2-é›†ç¾¤æ­å»ºJenkins-Master-èŠ‚ç‚¹" class="headerlink" title="(2) é›†ç¾¤æ­å»ºJenkins Master èŠ‚ç‚¹"></a>(2) é›†ç¾¤æ­å»ºJenkins Master èŠ‚ç‚¹</h3><p><strong>ç¯å¢ƒå‡†å¤‡:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- Kubernetes é›†ç¾¤ ï¼š<span class="string">"v1.19.6"</span></span><br><span class="line">- NFS : æ•°æ®æŒä¹…åŒ–æœ€å¸¸ç”¨çš„å…±äº«å­˜å‚¨</span><br><span class="line">- Jenkins é•œåƒ : jenkins/jenkins:2.277-alpine</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="2-1-åŸºç¡€ç¯å¢ƒ"><a href="#2-1-åŸºç¡€ç¯å¢ƒ" class="headerlink" title="2.1) åŸºç¡€ç¯å¢ƒ"></a>2.1) åŸºç¡€ç¯å¢ƒ</h4><h5 id="NFS-Network-File-System-ç¯å¢ƒ"><a href="#NFS-Network-File-System-ç¯å¢ƒ" class="headerlink" title="NFS (Network File System) ç¯å¢ƒ"></a>NFS (Network File System) ç¯å¢ƒ</h5><p>æè¿°ï¼šå®ƒæœ€å¤§çš„åŠŸèƒ½å°±æ˜¯å¯ä»¥é€šè¿‡ç½‘ç»œï¼Œè®©ä¸åŒçš„æœºå™¨ã€ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯ä»¥å…±äº«å½¼æ­¤çš„æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨NFSå…±äº«Jenkinsè¿è¡Œçš„é…ç½®æ–‡ä»¶ã€Mavençš„ä»“åº“ä¾èµ–æ–‡ä»¶ç­‰ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NFS å®¢æˆ·ç«¯å®‰è£…: Master&amp;nodeèŠ‚ç‚¹éƒ½æ‰§è¡Œ</span></span><br><span class="line">~$ ansible dtk8s -m shell -a <span class="string">"sudo apt-get install nfs-common rpcbind -y"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹Windows 2008 R2æ­å»ºçš„NFSæœåŠ¡ç«¯</span></span><br><span class="line">showmount -e 192.168.1.31</span><br><span class="line">Export list <span class="keyword">for</span> 192.168.1.31:</span><br><span class="line">/nask8sapp  (everyone)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰å…¨é…ç½® (è®¾ç½®æŒ‡å®šçš„ä½œç”¨åŸŸ)</span></span><br><span class="line">åŸºäº Unix è½¯ä»¶çš„ Portmap çš„å…¥ç«™è§„åˆ™ï¼Œå…è®¸ Portmap æœåŠ¡çš„æµé‡ã€‚[TCP 111] - è®¾ç½®å…¶ä½œç”¨åŸŸ</span><br><span class="line">NFS æœåŠ¡å™¨(NFS-UDP-In) NFS æœåŠ¡å™¨å…è®¸ NFS é€šä¿¡çš„å…¥ç«™è§„åˆ™ã€‚[UDP 2049] - è®¾ç½®å…¶ä½œç”¨åŸŸ</span><br><span class="line">NFS æœåŠ¡å™¨(NFS-TCP-In) NFS æœåŠ¡å™¨å…è®¸ NFS é€šä¿¡çš„å…¥ç«™è§„åˆ™ã€‚[TCP 2049] - è®¾ç½®å…¶ä½œç”¨åŸŸ</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸´æ—¶ä¸æ°¸ä¹…æŒ‚è½½</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">"sudo mkdir /nfsdisk-31"</span>  <span class="comment"># ç›®å½•åˆ›å»º</span></span><br><span class="line">sudo mount.nfs 192.168.12.31:/nask8sapp /nfsdisk-31/</span><br><span class="line">ls /nfsdisk-31/</span><br><span class="line"><span class="comment"># /nfsdisk-31/1.txt </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ /etc/fstab æŒ‚è½½</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">'echo "192.168.12.31:/nask8sapp /nfsdisk-31 nfs defaults 0 0"|sudo tee -a /etc/fstab'</span></span><br><span class="line"><span class="comment"># weiyigeek-* | CHANGED | rc=0 &gt;&gt;</span></span><br><span class="line"><span class="comment"># 192.168.12.31:/nask8sapp /nfsdisk-31 nfs defaults 0 0</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">'sudo mount -a'</span></span><br><span class="line">ansible dtk8s -m shell -a <span class="string">'mount | grep "nfs"'</span></span><br><span class="line"><span class="comment"># weiyigeek-* | CHANGED | rc=0 &gt;&gt;</span></span><br><span class="line"><span class="comment"># 192.168.12.31:/nask8sapp on /nfsdisk-31 type nfs (rw,relatime,vers=3,rsize=32768,wsize=32768,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=192.168.12.31,mountvers=3,mountport=1048,mountproto=udp,local_lock=none,addr=192.168.12.31)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡³æ­¤ä¸‹ä¸€æ­¥æˆ‘ä»¬éœ€è¦åœ¨k8sé›†ç¾¤ä¸­è¿›è¡Œé…ç½® NFS client provisioner</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="NFS-Client-Provisioner-ç¯å¢ƒ"><a href="#NFS-Client-Provisioner-ç¯å¢ƒ" class="headerlink" title="NFS Client Provisioner ç¯å¢ƒ"></a>NFS Client Provisioner ç¯å¢ƒ</h5><p>æ³¨æ„: å®‰è£…é…ç½®æ˜¯ä¸€ä¸ªKubernetesçš„ç®€æ˜“NFSçš„å¤–éƒ¨provisionerï¼Œæœ¬èº«ä¸æä¾›NFSï¼Œéœ€è¦ç°æœ‰ çš„NFSæœåŠ¡å™¨æä¾›å­˜å‚¨ã€‚<br>nfs-client-provisioner æ„å»ºçš„yamlæ–‡ä»¶:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; nfs-client-provisioner.yaml  &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"># NFS é©±åŠ¨ç¼–æ’çš„èµ„æºæ¸…å•</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  strategy:</span>          <span class="comment"># ç­–ç•¥</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span>   <span class="comment"># å†ç”Ÿ(å¾ªç¯ä½¿ç”¨)</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nfs-client-provisioner</span>   <span class="comment"># æœåŠ¡å¸æˆ·åç§°</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner</span> </span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/localtime</span>                <span class="comment"># æ—¶åŒºè®¾ç½®</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">PROVISIONER_NAME</span>                   <span class="comment"># StorageClass å¯¹è±¡ä¸­å®šä¹‰çš„ provisioner é”®éœ€è¦ä¿æŒä¸€è‡´</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.31</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">NFS_PATH</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/nask8sapp</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">timezone</span>                            <span class="comment"># æ—¶åŒºå®šä¹‰</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span>   </span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nfs-client-root</span>                     <span class="comment"># å­˜å‚¨å·</span></span><br><span class="line"><span class="attr">        nfs:</span></span><br><span class="line"><span class="attr">          server:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.31</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/nask8sapp</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Storageclass éƒ¨ç½²æ–‡ä»¶</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">managed-nfs-storage</span>    <span class="comment"># é‡è¦ StorageClass Nameç»‘å®š</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">storageclass.kubernetes.io/is-default-class:</span> <span class="string">"true"</span>   <span class="comment">#è®¾ç½®å…¶ä¸ºé»˜è®¤å­˜å‚¨åç«¯</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span>   <span class="comment"># æˆ–é€‰æ‹©å¦ä¸€ä¸ªåç§°ï¼Œå¿…é¡»ä¸NFS é©±åŠ¨ç¼–æ’åŒ¹é…éƒ¨ç½²çš„ env PROVISIONER_NAME</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  archiveOnDelete:</span> <span class="string">"false"</span>    <span class="comment"># åˆ é™¤pvcåï¼Œåç«¯å­˜å‚¨ä¸Šçš„pvä¹Ÿè‡ªåŠ¨åˆ é™¤</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># nfs-client-provisioner - rbacæˆæƒèµ„æºæ¸…å•</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt; nfs-client-rbac.yaml&lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["events"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["create",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["endpoints"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œ &amp; è¿è¡Œpod<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~/k8s/nfs-client-provisioner$ ls</span><br><span class="line"><span class="comment"># nfs-client-provisioner.yaml  nfs-client-rbac.yaml</span></span><br><span class="line"></span><br><span class="line">~/k8s/nfs-client-provisioner$ kubectl create -f .</span><br><span class="line"><span class="comment"># deployment.apps/nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># storageclass.storage.k8s.io/managed-nfs-storage created</span></span><br><span class="line"><span class="comment"># serviceaccount/nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span></span><br><span class="line"><span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span></span><br><span class="line"><span class="comment"># rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span></span><br><span class="line"></span><br><span class="line">$ kubectl get storageclasses.storage.k8s.io</span><br><span class="line"><span class="comment"># NAME                            PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span></span><br><span class="line"><span class="comment"># managed-nfs-storage (default)   fuseim.pri/ifs   Delete          Immediate           false                  53s</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line"><span class="comment"># NAME                                     READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># nfs-client-provisioner-57946d456-b4s7l   1/1     Running   0          22s</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h4 id="2-2-æ­å»ºæµç¨‹"><a href="#2-2-æ­å»ºæµç¨‹" class="headerlink" title="2.2) æ­å»ºæµç¨‹"></a>2.2) æ­å»ºæµç¨‹</h4><h5 id="èµ„æºæ¸…å•"><a href="#èµ„æºæ¸…å•" class="headerlink" title="èµ„æºæ¸…å•"></a>èµ„æºæ¸…å•</h5><ul>
<li><strong>Step 1.åˆ›å»ºPVã€PVCï¼Œä¸ºJenkinsæä¾›æ•°æ®æŒä¹…åŒ–</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; jenkins-PVC.yaml &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">devops</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">  annotations:</span>   <span class="comment"># ç©ºé—´æ ‡æ³¨</span></span><br><span class="line">    <span class="string">volume.beta.kubernetes.io/storage-class:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><strong>Step 2.åˆ›å»ºè§’è‰²æˆæƒ</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; jenkins-role.yaml &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-cr</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["extensions",</span> <span class="string">"apps"</span><span class="string">]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["deployments"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"delete"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["services"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"delete"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create","delete","get","list","patch","update","watch"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods/exec"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create","delete","get","list","patch","update","watch"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["pods/log"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get","list","watch"]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["secrets"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get"]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-crd</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-cr</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><strong>Step 3.åœ¨Kubernetesä¸­Deploymentéƒ¨ç½²Jenkinsä»¥åŠServiceèµ„æºåˆ›å»º</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; jenkins-deployment.yaml &lt;&lt;'EOF'</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      serviceAccount:</span> <span class="string">jenkins-sa</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">jenkins/jenkins:2.275-alpine</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="attr">-XshowSettings:vm</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.initialDelay=0</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN=50</span> <span class="bullet">-Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span> <span class="bullet">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/login</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">12</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jenkinshome</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">jenkins-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">devops</span> </span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">50000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">agent</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h5 id="åˆ›å»ºæŸ¥çœ‹"><a href="#åˆ›å»ºæŸ¥çœ‹" class="headerlink" title="åˆ›å»ºæŸ¥çœ‹"></a>åˆ›å»ºæŸ¥çœ‹</h5><ul>
<li><strong>Step 4.é‡‡ç”¨kubectlå‘½ä»¤åˆ›å»ºä¸Šé¢çš„èµ„æºæ¸…å•</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) PVC æŒä¹…å·åˆ›å»º</span></span><br><span class="line">$ kubectl create -f jenkins-PVC.yaml</span><br><span class="line">  <span class="comment"># namespace/devops created</span></span><br><span class="line">  <span class="comment"># persistentvolumeclaim/jenkins-pvc created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) Jenkins åœ¨é›†ç¾¤ä¸­è§’è‰²åˆ›å»ºç»‘å®š</span></span><br><span class="line">kubectl create -f jenkins-role.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/jenkins-sa created</span></span><br><span class="line">  <span class="comment"># clusterrole.rbac.authorization.k8s.io/jenkins-cr created</span></span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/jenkins-crd created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) éƒ¨ç½² Jenkins deployment å’Œ SVC </span></span><br><span class="line">kubectl create -f jenkins-deployment.yaml</span><br><span class="line">  <span class="comment"># deployment.apps/jenkins created</span></span><br><span class="line">  <span class="comment"># service/jenkins created</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li><strong>Step 5.æŸ¥çœ‹åˆ›å»ºçš„PVCã€PODä»¥åŠSVC</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pvc,pod,svc -n devops</span><br><span class="line">  <span class="comment"># NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span></span><br><span class="line">  <span class="comment"># persistentvolumeclaim/jenkins-pvc   Bound    pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d   5Gi        RWX            managed-nfs-storage   23m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                          READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># pod/jenkins-689775956-nph9z   1/1     Running   0          15m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME              TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE</span></span><br><span class="line">  <span class="comment"># service/jenkins   NodePort   10.104.214.1   &lt;none&gt;        8080:30001/TCP,50000:30465/TCP   15m</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><strong>Step 6.æˆ‘ä»¬è¿›å…¥Podå®¹å™¨å†…éƒ¨è¿›è¡ŒæŸ¥çœ‹</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -n devops -it jenkins-7db7878f8f-78tmk bash</span><br><span class="line">$ ps aux   <span class="comment"># å¯çœ‹åˆ°æœ‰ä¸¤ä¸ªè¿›ç¨‹æ­£åœ¨è¿è¡Œ</span></span><br><span class="line"><span class="comment"># PID   USER     TIME  COMMAND</span></span><br><span class="line"><span class="comment"># 1 jenkins   0:39 /sbin/tini -- /usr/local/bin/jenkins.sh  # ä¸»è¿è¡Œæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># 6 jenkins  57:00 java -Duser.home=/var/jenkins_home -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai -Djenkins.model.Jenkins.slaveAgentPort=50000 -jar /usr/share/jenkins/jenkins.war   # è¿è¡Œ jenkins.war çš„å‘½ä»¤</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æŸ¥çœ‹å®¹å™¨å…¥å£æ‰§è¡Œæ–‡ä»¶: cat <code>/usr/local/bin/jenkins.sh</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /bin/bash -e</span></span><br><span class="line">: <span class="string">"<span class="variable">$&#123;JENKINS_WAR:="/usr/share/jenkins/jenkins.war"&#125;</span>"</span></span><br><span class="line">: <span class="string">"<span class="variable">$&#123;JENKINS_HOME:="/var/jenkins_home"&#125;</span>"</span></span><br><span class="line">: <span class="string">"<span class="variable">$&#123;COPY_REFERENCE_FILE_LOG:="$&#123;JENKINS_HOME&#125;</span>/copy_reference_file.log"</span>&#125;<span class="string">"</span></span><br><span class="line"><span class="string">: "</span><span class="variable">$&#123;REF:="/usr/share/jenkins/ref"&#125;</span><span class="string">"</span></span><br><span class="line"><span class="string">touch "</span><span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span><span class="string">" || &#123; echo "</span>Can not write to <span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>. Wrong volume permissions?<span class="string">"; exit 1; &#125;</span></span><br><span class="line"><span class="string">echo "</span>--- Copying files at $(date)<span class="string">" &gt;&gt; "</span><span class="variable">$COPY_REFERENCE_FILE_LOG</span><span class="string">"</span></span><br><span class="line"><span class="string">find "</span><span class="variable">$&#123;REF&#125;</span><span class="string">" \( -type f -o -type l \) -exec bash -c '. /usr/local/bin/jenkins-support; for arg; do copy_reference_file "</span><span class="variable">$arg</span><span class="string">"; done' _ &#123;&#125; +</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># if `docker run` first argument start with `--` the user is passing jenkins launcher arguments</span></span><br><span class="line"><span class="string">if [[ <span class="variable">$#</span> -lt 1 ]] || [[ "</span><span class="variable">$1</span><span class="string">" == "</span>--<span class="string">"* ]]; then</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # read JAVA_OPTS and JENKINS_OPTS into arrays to avoid need for eval (and associated vulnerabilities)</span></span><br><span class="line"><span class="string">  java_opts_array=()</span></span><br><span class="line"><span class="string">  while IFS= read -r -d '' item; do</span></span><br><span class="line"><span class="string">    java_opts_array+=( "</span><span class="variable">$item</span><span class="string">" )</span></span><br><span class="line"><span class="string">  done &lt; &lt;([[ <span class="variable">$JAVA_OPTS</span> ]] &amp;&amp; xargs printf '%s\0' &lt;&lt;&lt;"</span><span class="variable">$JAVA_OPTS</span><span class="string">")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  readonly agent_port_property='jenkins.model.Jenkins.slaveAgentPort'</span></span><br><span class="line"><span class="string">  if [ -n "</span><span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT:-&#125;</span><span class="string">" ] &amp;&amp; [[ "</span><span class="variable">$&#123;JAVA_OPTS:-&#125;</span><span class="string">" != *"</span><span class="variable">$&#123;agent_port_property&#125;</span><span class="string">"* ]]; then</span></span><br><span class="line"><span class="string">    java_opts_array+=( "</span>-D<span class="variable">$&#123;agent_port_property&#125;</span>=<span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT&#125;</span><span class="string">" )</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  if [[ "</span><span class="variable">$DEBUG</span><span class="string">" ]] ; then</span></span><br><span class="line"><span class="string">    java_opts_array+=( \</span></span><br><span class="line"><span class="string">      '-Xdebug' \</span></span><br><span class="line"><span class="string">      '-Xrunjdwp:server=y,transport=dt_socket,address=5005,suspend=y' \</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  jenkins_opts_array=( )</span></span><br><span class="line"><span class="string">  while IFS= read -r -d '' item; do</span></span><br><span class="line"><span class="string">    jenkins_opts_array+=( "</span><span class="variable">$item</span><span class="string">" )</span></span><br><span class="line"><span class="string">  done &lt; &lt;([[ <span class="variable">$JENKINS_OPTS</span> ]] &amp;&amp; xargs printf '%s\0' &lt;&lt;&lt;"</span><span class="variable">$JENKINS_OPTS</span><span class="string">")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  exec java -Duser.home="</span><span class="variable">$JENKINS_HOME</span><span class="string">" "</span><span class="variable">$&#123;java_opts_array[@]&#125;</span><span class="string">" -jar <span class="variable">$&#123;JENKINS_WAR&#125;</span> "</span><span class="variable">$&#123;jenkins_opts_array[@]&#125;</span><span class="string">" "</span><span class="variable">$@</span><span class="string">"</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># As argument is not jenkins, assume user want to run his own process, for example a `bash` shell to explore this image</span></span><br><span class="line"><span class="string">exec "</span><span class="variable">$@</span><span class="string">"</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : <code>/usr/local/bin/jenkins.sh</code> ä»¥åŠ <code>usr/share/jenkins/</code>å¯ç”¨å¸®åŠ©æˆ‘ä»¬è¿›è¡ŒJenkinsæ‰‹åŠ¨å‡çº§;</p>
<p><br/></p>
<h5 id="æœåŠ¡è®¿é—®"><a href="#æœåŠ¡è®¿é—®" class="headerlink" title="æœåŠ¡è®¿é—®"></a>æœåŠ¡è®¿é—®</h5><ul>
<li><strong>Step 7.å› ä¸ºæˆ‘ä»¬Serviceæ˜¯é‡‡ç”¨NodePortç±»å‹å…¶ç«¯å£ä¸º30001ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨æµè§ˆå™¨ç”¨è¿™ä¸ªç«¯å£è®¿é—®Jenkins UI, ä¸‹é¢æ˜¯ç²¾ç®€æ“ä½œå¦‚æœä¸ç†è§£çš„ç«¥é‹ï¼Œéœ€è¦æŒ‰ç…§ç¬¬ä¸€ç¯‡æ–‡ç« çš„æ“ä½œè¿›è¡Œåˆå§‹åŒ–ï¼›</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Jenkins åˆå§‹åŒ–å¯†ç è·å–çš„ä¸¤ç§æ–¹å¼;</span></span><br><span class="line"><span class="comment"># æ–¹å¼1.è®¤è¯</span></span><br><span class="line">$ kubectl logs -n devops pod/jenkins-689775956-nph9z | grep -A 2 <span class="string">"following password"</span></span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">c45f558fa237472f9f8f954ceb3a323e</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2.åŠ¨æ€å·JenkinsæŒä¹…åŒ–ç›®å½•</span></span><br><span class="line"><span class="comment"># å®¹å™¨ä¸­çš„ç›®å½• : /var/jenkins_home/secrets/initialAdminPassword - pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d</span></span><br><span class="line">$ cat /nfsdisk-31/devops-jenkins-pvc-pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d/secrets/initialAdminPassword</span><br><span class="line">c45f558fa237472f9f8f954ceb3a323e</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113162155.png" target="_blank" title="WeiyiGeek.Jenkins Init" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113162155.png" alt="WeiyiGeek.Jenkins Init" title="" class=""></a>
                <p>WeiyiGeek.Jenkins Init</p>
            </figure>
<p><br/></p>
<ul>
<li><strong>Step 7.å®‰è£… <code>Jenkinså…¥é—¨å­¦ä¹ ä¹‹æŒç»­åŒ–é›†æˆä¸éƒ¨ç½²</code> æ–‡ç« çš„æ“ä½œè¿›è¡Œåˆå§‹åŒ–, å½“ç„¶æ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå®šä¹‰æ’ä»¶å®‰è£… -&gt; Languages (ä¸¤é¡¹æ’ä»¶) å…ˆè¿›è¡Œæ±‰åŒ–</strong></li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163216.png" target="_blank" title="WeiyiGeek.Languages-Chinese" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163216.png" alt="WeiyiGeek.Languages-Chinese" title="" class=""></a>
                <p>WeiyiGeek.Languages-Chinese</p>
            </figure>
<p><br/></p>
<ul>
<li><strong>Step 8.Create First Admin User -&gt; Instance Configuration (Jenkins URL) -&gt; Save -&gt; Restart å®‰è£…æˆåŠŸ</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Jenkins URL: http://jenkins.weiyigeek.top:30001/  <span class="comment"># æ³¨æ„éœ€è¦æ·»åŠ è§£æ</span></span><br><span class="line">Jenkins URL: http://192.168.10.10:30001</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163957.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210113163957.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
</li>
</ul>
<p><br/></p>
<ul>
<li><p><strong>Step 9.æ’ä»¶é•œåƒä»“åº“è®¾ç½®åŠ å¿«æ‹‰å–è¿›åº¦ <code>Dashboard -&gt; æ’ä»¶ç®¡ç† -&gt; é«˜çº§ -&gt; å‡çº§ç«™ç‚¹</code>;</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‡çº§ç«™ç‚¹</span></span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æˆ·å®šä¹‰çš„æ—¶åŒº -&gt; Time Zone -&gt; Asia/Beijing</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Step 10.æœ€åæœ€æ–°è¿›è¡Œå¸¸ç”¨æ’ä»¶å®‰è£…ï¼Œå¯ä»¥å‚è€ƒæœ€åä¸€ç« </strong></p>
</li>
</ul>
<hr>
<h3 id="3-é›†ç¾¤åŠ¨æ€åˆ›å»º-Agent-èŠ‚ç‚¹-Slave-èŠ‚ç‚¹"><a href="#3-é›†ç¾¤åŠ¨æ€åˆ›å»º-Agent-èŠ‚ç‚¹-Slave-èŠ‚ç‚¹" class="headerlink" title="(3) é›†ç¾¤åŠ¨æ€åˆ›å»º Agent èŠ‚ç‚¹ - Slave èŠ‚ç‚¹"></a>(3) é›†ç¾¤åŠ¨æ€åˆ›å»º Agent èŠ‚ç‚¹ - Slave èŠ‚ç‚¹</h3><p>æè¿°: å‰é¢æˆ‘ä»¬è¯´è¿‡Jenkinsçš„åˆ†å¸ƒå¼æ¶æ„(Master-Slave)ï¼Œå…¶ä¸­ master ä¸»è¦è´Ÿè´£è´Ÿè½½åœ°è°ƒåº¦è€Œ slave æ‰§è¡Œæ„å»ºä»»åŠ¡ï¼Œå¹¶ä¸”å½“Jobæ„å»ºå®ŒæˆåPodå°±ä¼šè‡ªåŠ¨é”€æ¯, æ‰€ä»¥å…¶å¯ä»¥å¾ˆå¥½åœ°è§£å†³æ€§èƒ½ä¸èµ„æºå ç”¨é—®é¢˜ã€‚</p>
<p><strong>æ­¥éª¤è¯´æ˜:</strong></p>
<ul>
<li>Step 1.æ‰€ä»¥åœ¨ Jenkins æœåŠ¡å®‰è£…å¥½ <a href="https://plugins.jenkins.io/kubernetes/" target="_blank" rel="noopener">Kubernetes æ’ä»¶</a> å¹¶é…ç½®å¥½è¿æ¥ Kubernetes çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥åœ¨ Kubernetes é›†ç¾¤ä¸­åŠ¨æ€åˆ›å»º Agent èŠ‚ç‚¹äº†ã€‚å…¶ä¸­ Jenkins MasterèŠ‚ç‚¹å¯ä»¥ç›´æ¥å®‰è£…åœ¨å®¿ä¸»æœºä¸­ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ã€‚<br>è¯¥æ’ä»¶ä¸ºæ¯ä¸ªè¦å¯åŠ¨çš„ Jenkins Agent èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª Kubernetes Pod å¯¹è±¡ï¼Œå¹¶åœ¨æ„å»ºå®Œæˆåé”€æ¯ Pod ã€‚<ul>
<li>Agent èŠ‚ç‚¹æ˜¯ä½¿ç”¨JNLPå¯åŠ¨çš„ï¼Œæ˜¯é€šè¿‡ Agent èŠ‚ç‚¹é•œåƒè‡ªåŠ¨è¿æ¥ Jenkins Master èŠ‚ç‚¹ã€‚ä½¿ç”¨è¿™ç§è¿æ¥æ–¹å¼ï¼Œéœ€è¦å¯¹ Agent èŠ‚ç‚¹è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡ï¼š<blockquote>
<ul>
<li>1.JENKINS_URLï¼šJenkins Webç•Œé¢URL</li>
<li>2.JENKINS_SECRETï¼šç”¨äºè®¤è¯çš„å¯†é’¥</li>
<li>3.JENKINS_AGENT_NAMEï¼šJenkinsä»£ç†çš„åç§°</li>
<li>4.JENKINS_NAMEï¼šJenkinsä»£ç†çš„åç§°ï¼ˆä¸å»ºè®®ä½¿ç”¨ã€‚ä»…åœ¨æ­¤å¤„æ˜¯ä¸ºäº†å‘åå…¼å®¹ï¼‰</li>
</ul>
</blockquote>
</li>
</ul>
</li>
</ul>
<p>Tips : è¿™äº›ç¯å¢ƒå˜é‡ä¼šåœ¨ Pod åˆ›å»ºé…ç½®ä¸­è®¾å®šå¥½ï¼Œç”¨äº Agent èŠ‚ç‚¹å¯åŠ¨æ—¶è¿æ¥ Master èŠ‚ç‚¹ã€‚</p>
<p><br></p>
<ul>
<li>Step 2.Kubernetes æ’ä»¶ä½¿ç”¨æ—¶ï¼Œæœ€å…ˆè¦é…ç½®çš„æ˜¯<code>è¿æ¥ Kubernetes é›†ç¾¤çš„è¿æ¥ä¿¡æ¯</code>å’Œ <code>Jenkins æœåŠ¡ Master èŠ‚ç‚¹è¿æ¥åœ°å€</code>(å…¶ä»–è¿æ¥ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆä¸éœ€è¦é…ç½®)ã€‚<ul>
<li>1.Jenkins æœåŠ¡ä½¿ç”¨ Kubernetes æ’ä»¶è¿æ¥ Kubernetes é›†ç¾¤ï¼Œå¹¶åŠ¨æ€åˆ›å»º Agent èŠ‚ç‚¹ã€‚è¿æ¥ Kubernetes é›†ç¾¤éœ€è¦é…ç½®çš„ Kubernetes è¿æ¥ä¿¡æ¯åŒ…æ‹¬ï¼š</li>
<li>2.Kubernetes é›†ç¾¤åç§°</li>
<li>3.Kubernetes é›†ç¾¤Api-server çš„è¿æ¥åœ°å€</li>
<li>4.Kubernetes é›†ç¾¤æœåŠ¡è¯ä¹¦ï¼šKubernetes é›†ç¾¤èŠ‚ç‚¹é—´é€šä¿¡éƒ½æ˜¯ä½¿ç”¨è¯ä¹¦åŒå‘è®¤è¯åŠ å¯†çš„ï¼Œä¸€èˆ¬æ‰€æœ‰çš„è¯ä¹¦éƒ½ä½¿ç”¨åŒä¸€ä¸ª CA è¯ä¹¦åšè¯ä¹¦ç”³è¯·ç­¾å‘ï¼›è¿™é‡Œçš„æœåŠ¡å™¨è¯ä¹¦å°±æ˜¯è¿™ä¸ªCA è¯ä¹¦ã€‚å› ä¸ºæ­¤æ—¶ Jenkins Master èŠ‚ç‚¹ä¹Ÿå°±æ˜¯ä¸€ä¸ª Kubernetes Agent èŠ‚ç‚¹ï¼Œä¹Ÿéœ€è¦ä¿¡ä»» CA è¯ä¹¦ï¼Œä¿¡ä»»CA è¯ä¹¦ç­¾å‘çš„å…¶ä»–èŠ‚ç‚¹ä¸Šçš„è¯ä¹¦ã€‚</li>
<li>5.Kubernetes å‘½åç©ºé—´ï¼šåº”è¯¥æ˜¯åˆ›å»ºçš„ Agent èŠ‚ç‚¹åœ¨å“ªä¸ªå‘½åç©ºé—´ä¸­è¿è¡Œã€‚</li>
<li>6.å‡­è¯ï¼ˆKubernetes è®¤è¯ï¼‰ï¼šæ”¯æŒçš„å‡­è¯åŒ…æ‹¬ï¼šç”¨æˆ·åå¯†ç ã€ç§˜å¯†æ–‡ä»¶ï¼ˆkubeconfigæ–‡ä»¶ï¼‰ã€ç§˜å¯†æ–‡æœ¬ï¼ˆåŸºäºä»¤ç‰Œçš„èº«ä»½éªŒè¯ï¼‰ï¼ˆOpenShiftï¼‰ã€æ¥è‡ªç§é’¥çš„GoogleæœåŠ¡å¸æˆ·ï¼ˆGKEèº«ä»½éªŒè¯ï¼‰ã€X.509å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li>
</ul>
</li>
</ul>
<p>å°†ä¼šå…·ä½“ä½¿ç”¨é…ç½®å°†ä¼šåœ¨ä¸‹é¢è¿›è¡Œè¯¦è¿°çš„é…ç½®è®²è§£ã€‚</p>
<p><br></p>
<h4 id="å†…ç½®-Jenkins-Master-æ¥å…¥å†…éƒ¨-K8s-é›†ç¾¤"><a href="#å†…ç½®-Jenkins-Master-æ¥å…¥å†…éƒ¨-K8s-é›†ç¾¤" class="headerlink" title="å†…ç½® Jenkins Master æ¥å…¥å†…éƒ¨ K8s é›†ç¾¤"></a>å†…ç½® Jenkins Master æ¥å…¥å†…éƒ¨ K8s é›†ç¾¤</h4><p><strong>é…ç½®æµç¨‹:</strong></p>
<ul>
<li>Step 1.å®‰è£…kubernetesæ’ä»¶: ç‚¹å‡» Manage Jenkins -&gt; Manage Plugins -&gt; Available -&gt; Kubernetes å‹¾é€‰å®‰è£…å³å¯ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… kubernetes plugins</span></span><br><span class="line">Kubernetes Client API Plugin - Kuberneteså®¢æˆ·ç«¯APIæ’ä»¶ï¼Œä¾›å…¶ä»–Jenkinsæ’ä»¶ä½¿ç”¨ - 4.11.1		</span><br><span class="line">Kubernetes Credentials Plugin - Kubernetesè¯ä¹¦çš„å…¬å…±ç±» - 0.8.0	</span><br><span class="line">Kubernetes plugin - è¿™ä¸ªæ’ä»¶é›†æˆäº†Jenkinsä¸Kubernetes - 1.28.7</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 2.åœ¨Jenkinsä¸­é…ç½®k8sä¿¡æ¯ï¼šå®‰è£…å®Œæ¯•åç‚¹å‡» Manage Jenkins â€”&gt; Configure System â€”&gt; (æ‹–åˆ°æœ€ä¸‹æ–¹) Add a new cloud â€”&gt; é€‰æ‹© Kubernetesï¼Œç„¶åå¡«å†™ Kubernetes å’Œ Jenkins é…ç½®ä¿¡æ¯ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubernetes é›†ç¾¤åç§° Name:</span></span><br><span class="line">kubernetes </span><br><span class="line"><span class="comment"># Kubernetes åœ°å€</span></span><br><span class="line">https://kubernetes.default.svc.cluster.local</span><br><span class="line"><span class="comment"># Kubernetes æœåŠ¡è¯ä¹¦ key å†…å®¹</span></span><br><span class="line">ca.crt </span><br><span class="line"><span class="comment"># Kubernetes å‘½åç©ºé—´</span></span><br><span class="line">devops</span><br><span class="line"><span class="comment"># æ·»åŠ å‡­æ®å¯é€‰</span></span><br><span class="line"><span class="comment"># Jenkins åœ°å€ : The URL of the Jenkins Master server. </span></span><br><span class="line"><span class="comment"># æ ¼å¼ : æœåŠ¡å.namespace.svc.cluster.local:8080</span></span><br><span class="line">http://jenkins.devops.svc.cluster.local:8080</span><br><span class="line"><span class="comment"># æ³¨æ„: Jenkinsé€šé“ä¸éœ€è¦æ·»åŠ slaveå®ƒä¼šè‡ªåŠ¨è¯†åˆ«(ç½‘ä¸Šåšå®¢è¯´åŠ ä¸Šä¹‹åå¯èƒ½å¯¼è‡´Podåå¤é‡å¯-åº”è¯¥åœ¨æ–°ç‰ˆæœ¬ä¸­ä¸ä¼šå­˜åœ¨)</span></span><br><span class="line"><span class="comment"># Jenkins é€šé“</span></span><br><span class="line">jenkins.devops.svc.cluster.local:50000</span><br><span class="line"><span class="comment"># Pod Labels</span></span><br><span class="line">Key: app</span><br><span class="line">Value: k8s</span><br><span class="line"><span class="comment"># å…¶å®ƒå€¼é»˜è®¤å³å¯(å¦‚éœ€é…ç½®ç›¸åº”å³å¯)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips: è®¾ç½®JNLPè®¿é—®åè®®ï¼Œæ‰“å¼€<code>Jenkins/Configure Global Security</code>æ‰¾åˆ° Agents, è®¾ç½® Port ä¸º æŒ‡å®šç«¯å£50000ï¼ˆ<code>å¯¹äºé›†ç¾¤æ­å»ºJenkins-Masteræƒ³æ¥å…¥å…¶å®ƒVMç‰©ç†æœºä¸Šçš„AgentèŠ‚ç‚¹</code>ï¼‰, Agent protocols é€‰Inbound TCP Agent Protocol/4 (TLS encryption)ä¿å­˜ï¼›</p>
<p><br></p>
<ul>
<li>Step 3.ç‚¹å‡»Test Connectionï¼Œå¦‚æœå‡ºç° <code>Connected to Kubernetes v1.19.6</code> çš„æç¤ºä¿¡æ¯è¯æ˜ Jenkins å·²ç»å¯ä»¥å’Œ Kubernetes ç³»ç»Ÿæ­£å¸¸é€šä¿¡äº†(CSDN - æ»åæ€§å¤ªä¸¥é‡äº†ï¼Œè¿˜æ˜¯å¾—çœ‹å®˜ç½‘)<br>Tips : æ³¨æ„å¦‚æœè¿™é‡Œ Connection å¤±è´¥çš„è¯ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œè¿™é‡Œå°±éœ€è¦æŠŠæˆ‘ä»¬åˆ›å»ºçš„ jenkins çš„ serviceAccount å¯¹åº”çš„ secret æ·»åŠ åˆ°è¿™é‡Œçš„ Credentials é‡Œé¢ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202224506.png" target="_blank" title="WeiyiGeek.JenkinsConnectionK8s" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202224506.png" alt="WeiyiGeek.JenkinsConnectionK8s" title="" class=""></a>
                <p>WeiyiGeek.JenkinsConnectionK8s</p>
            </figure>
<p><br></p>
<h4 id="ç‹¬ç«‹Jenkins-MasterèŠ‚ç‚¹æ¥å…¥å¤–éƒ¨K8sé›†ç¾¤"><a href="#ç‹¬ç«‹Jenkins-MasterèŠ‚ç‚¹æ¥å…¥å¤–éƒ¨K8sé›†ç¾¤" class="headerlink" title="ç‹¬ç«‹Jenkins MasterèŠ‚ç‚¹æ¥å…¥å¤–éƒ¨K8sé›†ç¾¤"></a>ç‹¬ç«‹Jenkins MasterèŠ‚ç‚¹æ¥å…¥å¤–éƒ¨K8sé›†ç¾¤</h4><ul>
<li>Step 1.åˆ›å»º<code>Kubernetes Namespace</code>ä¸<code>Service Account</code>(å¯å‚è€ƒå‰é¢æ­å»º)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨Kubenatesçš„ä¸Šåˆ›å»ºdevopså‘½åç©ºé—´ï¼Œç”¨äºJenkinsä½¿ç”¨</span></span><br><span class="line">kubectl create namespace devops</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨Kubernetesä¸Šä¸ºJenkinsæ„å»ºåˆ›å»ºæœ‰Cluster Adminæƒé™çš„Service Account jenkinsï¼š</span></span><br><span class="line">kubectl create clusterrolebinding jenkins --clusterrole cluster-admin --serviceaccount=devops:jenkins</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Step 2.ç”Ÿæˆè°ƒåº¦å‡­è¯å³<code>Kubernetesçš„ server certificate keyå’ŒClient P12 Certificate File</code>, å…¶ä½œç”¨æ˜¯é‡‡ç”¨<code>P12 Certificate File</code>æä¾›ç»™<code>jenkins Master</code>å»è°ƒç”¨Kubenetes,<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ~/.kube/config è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ†åˆ«ç”Ÿæˆç”Ÿæˆ ca.crt, client.crt, client.key</span></span><br><span class="line">$ cat ~/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ********ORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    server: https://weiyigeek-lb-vip.k8s:16443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR........VRFMLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNS........BQUklWQVRFIEtFWS0tLS0tCg==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) å¤åˆ¶ certificate-authority-data çš„å†…å®¹è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ `ca.crt` - caè¯ä¹¦</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;certificate-authority-data&gt;"</span> | base64 -d &gt; ca.crt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"LS0*******tLS1"</span> | base64 -d &gt; ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) å¤åˆ¶ client-certificate-dataçš„å†…å®¹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ `client.crt` -  å®¢æˆ·ç«¯è¯ä¹¦</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;client-certificate-data&gt;"</span> | base64 -d &gt; client.crt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"LS0tLS1CRUd*******tLQo="</span>  | base64 -d &gt; client.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) å¤åˆ¶ client-key-dataçš„å†…å®¹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ `client.key` - å¯†é’¥</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;client-key-data&gt;"</span> | base64 -d &gt; client.key</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"LS0tL*******g=="</span> | base64 -d &gt; client.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¡¥å……: 2022å¹´1æœˆ18æ—¥ 17:19:58</span></span><br><span class="line">cat ~/.kube/config | grep <span class="string">"certificate-authority-data"</span> | sed s/[[:space:]]//g | cut -d <span class="string">':'</span> -f 2 | base64 -d &gt; ca.crt</span><br><span class="line">cat ~/.kube/config | grep <span class="string">"client-certificate-data"</span> | sed s/[[:space:]]//g | cut -d <span class="string">':'</span> -f 2 | base64 -d &gt; client.crt</span><br><span class="line">cat ~/.kube/config | grep <span class="string">"client-key-data"</span> | sed s/[[:space:]]//g | cut -d <span class="string">':'</span> -f 2 | base64 -d &gt; client.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) ä¹‹åå†æ ¹æ®å‰é¢æ­¥éª¤ç”Ÿæˆçš„ ca.crt, client.crt å’Œ client.key æ¥ç”Ÿæˆ PKCS12 æ ¼å¼çš„ cert.pfx</span></span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out cert.pfx -inkey client.key -<span class="keyword">in</span> client.crt -certfile ca.crt</span><br><span class="line">  <span class="comment"># Enter Export Password: weiyigeek</span></span><br><span class="line">  <span class="comment"># Verifying - Enter Export Password: weiyigeek</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 3.åœ¨Jenkinsä¸Šé›†æˆ Kubernetes é¦–å…ˆéœ€è¦å°† cert.pfx å¯¼å…¥åˆ°<code>Jenkins Global Credential</code> å‡­æ®ä¸­(æ³¨æ„è¾“å…¥å¯†ç )</p>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204113516.png" target="_blank" title="WeiyiGeek.cert.pfx" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204113516.png" alt="WeiyiGeek.cert.pfx" title="" class=""></a>
                <p>WeiyiGeek.cert.pfx</p>
            </figure>
<p><br/></p>
<p>Step 4.ç„¶åæŒ‰ç…§ä¸Šé¢çš„æ–¹å¼åœ¨<code>Jenkins</code>ä¸Šé…ç½®Kubernetes Cloud, ä¸åŒçš„æ˜¯éœ€è¦å¡«å…¥ä»¥ä¸‹ä¿¡æ¯ï¼Œæœ€åç‚¹å‡»â€œTest Connectionâ€æŒ‰é’®æµ‹è¯•Jenkinsæ˜¯å¦å¯ä»¥æˆåŠŸè¿æ¥Kubernetesã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes åç§° : kubernetes-external</span></span><br><span class="line"><span class="comment"># Kubernetes åœ°å€ : https://192.168.12.110:16443    # æ­¤å¤„ç”±äºåšäº†é«˜å¯ç”¨æ‰€ä»¥ä¸æ˜¯masterèŠ‚ç‚¹åœ°å€:6443</span></span><br><span class="line"><span class="comment"># Kubernetes æœåŠ¡è¯ä¹¦ key ï¼šca.crt çš„å†…å®¹</span></span><br><span class="line"><span class="comment"># Kubernetes å‘½åç©ºé—´ : devops</span></span><br><span class="line"><span class="comment"># Jenkins åœ°å€ ï¼šhttp://jenkins.devops.svc.cluster.local:8080</span></span><br><span class="line"><span class="comment"># Jenkins é€šé“ ï¼šjenkins.devops.svc.cluster.local:50000 ï¼ˆæ³¨æ„æ­¤ä¸ºtcpè¿æ¥ï¼Œä¸è¦åŠ ä¸Šhttpï¼‰</span></span><br><span class="line"><span class="comment"># Tips : æ³¨æ„å‹¾é€‰ä» master ä¼ é€’ç»™ agent çš„ç¯å¢ƒå˜é‡</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205094218.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205094218.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p>Tips ï¼š åœ¨è¿›è¡Œç¬¬äº”æ­¥æ˜¯å»ºè®®åœ¨å„ä¸ªWorkèŠ‚ç‚¹æ‹‰å–<code>jenkins/inbound-agent:4.3-4</code>é•œåƒ</p>
<p><br/></p>
<ul>
<li>Step 5.ä¸‹é¢è®¾ç½® Pod Templates æ­¤å¤„éœ€æ·»åŠ ä¸€ä¸ªPod æ¨¡æ¿åç§°ç­‰ç›¸å…³ä¿¡æ¯<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ  Pod æ¨¡æ¿ </span></span><br><span class="line">Pod æ¨¡æ¿åç§°: jenkins-slave</span><br><span class="line">å‘½åç©ºé—´ï¼šdevops                 <span class="comment"># ä¸€å®šä¸è¦å†™é”™è¯¯äº†å¦åˆ™ä¸èƒ½åˆ›å»ºPod</span></span><br><span class="line">æ ‡ç­¾åˆ—è¡¨: jenkins-slave     <span class="comment"># åç»­Jobå¯ä»¥æŒ‡å®šè¯¥æ ‡ç­¾è¿›è¡Œè¿è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ å®¹å™¨åˆ—è¡¨ (jenkins/inbound-agent:4.3-4)  # å·®ç‚¹æŠŠæˆ‘å‘å“­äº† (æµ‹è¯•æ—¶å€™å¯ä»¥å…ˆä¸åŠ å®¹å™¨ï¼Œé»˜è®¤æœ‰ä¸€ä¸ªjnlpåç§°å®¹å™¨)</span></span><br><span class="line"><span class="comment"># åç§° ï¼š       maven</span></span><br><span class="line"><span class="comment"># Docker é•œåƒ : maven:3.6-jdk-8-alpine  </span></span><br><span class="line"><span class="comment"># å·¥ä½œç›®å½• : /home/jenkins/</span></span><br><span class="line"><span class="comment"># è¿è¡Œçš„å‘½ä»¤ : sleep 9000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½åˆ° Pod ä»£ç†ä¸­çš„å·åˆ—è¡¨</span></span><br><span class="line"><span class="comment"># é€‰æ‹© Host Path Volume å°†mavenè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ï¼ˆæ­¤å¤„è·¯å¾„ä¸æ‚¨settingé…ç½®æœ‰å…³é»˜è®¤æ˜¯è¿è¡Œç”¨æˆ·å®¶ç›®å½•ä¸­ï¼‰</span></span><br><span class="line"><span class="comment"># Maven æŒä¹…åŒ–ç›®å½• : /home/jenkins/.m2  # æ­¤å¤„åº”è¯¥æ˜¯æ‚¨å„ä¸ªK8sçš„WorkèŠ‚ç‚¹ä¸ŠNFSç›®å½•;</span></span><br><span class="line">/nfsdisk-31/appstorage/mavenRepo <span class="comment"># ä¸»æœºç›®å½•ï¼ˆroot@weiyigeek-107 ï¼‰NFSç›®å½•</span></span><br><span class="line">/home/jenkins/.m2                <span class="comment"># PodæŒ‚è½½ç›®å½•</span></span><br><span class="line"><span class="comment"># docker socket ç›®å½•: </span></span><br><span class="line">/var/run/docker.sock    <span class="comment"># ä¸»æœºç›®å½•(ç”±äºå„ä¸ªèŠ‚ç‚¹éƒ½å®‰è£…docker)</span></span><br><span class="line">/var/run/docker.sock    <span class="comment"># PodæŒ‚è½½ç›®å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Service Account è´¦æˆ·æƒé™</span></span><br><span class="line">Service Account ï¼šjenkins-sa   <span class="comment"># å‰é¢åˆ›å»ºçš„ServiceAccount</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204203103.png" target="_blank" title="WeiyiGeek.Slave Pod æ¨¡æ¿" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210204203103.png" alt="WeiyiGeek.Slave Pod æ¨¡æ¿" title="" class=""></a>
                <p>WeiyiGeek.Slave Pod æ¨¡æ¿</p>
            </figure>
<p>Tips : è­¦å‘Šå¦‚æœè¦ä¸ºJNLPä»£ç†æä¾›è‡ªå·±çš„Dockeræ˜ åƒåˆ™å¿…é¡»å°†å®¹å™¨å‘½åä¸ºjnlpï¼Œä»¥ä¾¿å®ƒè¦†ç›–é»˜è®¤å®¹å™¨å¦åˆ™ï¼Œå°†å¯¼è‡´ä¸¤ä¸ªä»£ç†å°è¯•åŒæ—¶è¿æ¥åˆ°ä¸»æœåŠ¡å™¨</p>
<p>Tips : è¯¥ Jenkinsçš„ Kubernetes æ’ä»¶é»˜è®¤jnlpå®¹å™¨æ˜¯<code>&quot;jenkins/inbound-agent:4.3-4&quot;, name: &quot;jnlp&quot;</code>ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰jnlpå®¹å™¨è¿›è¡Œè¦†ç›–åªéœ€å°†å®¹å™¨åç§°æ›´æ”¹ä¸ºjnlpå³å¯(ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®æ›´æ”¹)ï¼Œç›´æ¥æ·»åŠ podå³å¯;</p>
<p>Tips ï¼šé•œåƒçš„é€‰æ‹©å°±æ˜¯ä¸€ä¸ªå‘å¼€å§‹ä½¿ç”¨çš„æ˜¯<code>jenkins/inbound-agent:alpine</code>ç„¶åå®¹å™¨åç§°å¹¶æœªè®¾ç½®ä¸ºjnlpè¦†ç›–é»˜è®¤çš„<code>&quot;jenkins/inbound-agent:4.3-4&quot;</code>å®¹å™¨ï¼ˆå®é™…ç”¨ä¸ç€ï¼‰ï¼Œå¯¼è‡´éƒ½æ‰§è¡Œäº†èŠ‚ç‚¹åŠ å…¥å‘½ä»¤ï¼ˆå…¶å®æ˜¯ä¸¤ä¸ªå¼€æ”¾çš„éƒ½æ˜¯é“¾æ¥åˆ°jenkins-jlnp 50000ç«¯å£ä¸Šï¼‰, å‘ç°å®˜ç½‘(<a href="https://hub.docker.com/r/jenkins/jnlp-slave)æç¤ºçš„è­¦å‘Šè¯¥å›¾åƒæ›¾ç»ä»¥" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/jnlp-slave)æç¤ºçš„è­¦å‘Šè¯¥å›¾åƒæ›¾ç»ä»¥</a> jenkinsci/jnlp-slave å’Œ jenkins/jnlp-slave çš„å½¢å¼å‘å¸ƒã€‚  è¿™äº›å›¾åƒå·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨<code>jenkins/inbound-agent</code>ï¼Œå³æˆ‘ä»¬å¯ä»¥åœ¨jenkins/inbound-agenté•œåƒçš„åŸºç¡€ä¸Šæ·»åŠ æˆ‘ä»¬éœ€è¦çš„å·¥å…·å³å¯ï¼Œç„¶åå†æ¬¡docker buildã€‚</p>
<p>é‡‡ç”¨çš„æ˜¯æˆ–è€…ä¸åŠ é•œåƒå®¹å™¨ä¿¡æ¯æœ€åå®Œæ»¡è§£å†³;</p>
<p><br></p>
<ul>
<li>Step 6.åˆ›å»ºä¸€ä¸ªJob Pipeline éªŒè¯æµ‹è¯•ç¯å¢ƒ;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// <span class="comment"># scripted Pipeline </span></span><br><span class="line">def podTemplates = <span class="string">'jenkins-slave'</span></span><br><span class="line">podTemplate(label: podTemplates, cloud: <span class="string">'kubernetes'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    node (podTemplates) &#123;</span><br><span class="line">        stage(<span class="string">'init'</span>) &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"Hello world, Kubernetes Jenkins Slave"</span></span><br><span class="line">            sh <span class="string">"hostname &amp;&amp; ls /home/jenkins/.m2 &amp;&amp; sleep 300"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>è¾“å‡ºç»“æœ:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// <span class="comment"># scripted Pipeline </span></span><br><span class="line">podTemplate(name: <span class="string">'jenkins-slave'</span>, label: <span class="string">'jenkins-slave'</span>, cloud: <span class="string">'kubernetes'</span>,containers: [</span><br><span class="line">    containerTemplate(name: <span class="string">'maven'</span>, image: <span class="string">'maven:3.6-jdk-8-alpine'</span>, ttyEnabled: <span class="literal">true</span>, <span class="built_in">command</span>: <span class="string">'sleep'</span>, args: <span class="string">'30'</span>)</span><br><span class="line">])&#123;</span><br><span class="line">    node (podTemplates) &#123;</span><br><span class="line">        stage(<span class="string">'init'</span>) &#123;</span><br><span class="line">            container (<span class="string">'maven'</span>) &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Hello world, Kubernetes Jenkins Slave"</span></span><br><span class="line">                sh <span class="string">'mvn -version'</span></span><br><span class="line">                sh <span class="string">"hostname &amp;&amp; ls /home/jenkins/.m2 &amp;&amp; pwd"</span></span><br><span class="line">                sh <span class="string">"env"</span></span><br><span class="line">                sh <span class="string">"pwd &amp;&amp; ls"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205152239.png" target="_blank" title="WeiyiGeek.result" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210205152239.png" alt="WeiyiGeek.result" title="" class=""></a>
                <p>WeiyiGeek.result</p>
            </figure>
<hr>
<h2 id="0x03-è¡¥å……è¯´æ˜"><a href="#0x03-è¡¥å……è¯´æ˜" class="headerlink" title="0x03 è¡¥å……è¯´æ˜"></a>0x03 è¡¥å……è¯´æ˜</h2><h3 id="1-K8s-é›†ç¾¤ä¸­å¯¹æ­å»ºçš„Jenkinsè¿›è¡Œç‰ˆæœ¬å‡çº§"><a href="#1-K8s-é›†ç¾¤ä¸­å¯¹æ­å»ºçš„Jenkinsè¿›è¡Œç‰ˆæœ¬å‡çº§" class="headerlink" title="(1) K8s é›†ç¾¤ä¸­å¯¹æ­å»ºçš„Jenkinsè¿›è¡Œç‰ˆæœ¬å‡çº§"></a>(1) K8s é›†ç¾¤ä¸­å¯¹æ­å»ºçš„Jenkinsè¿›è¡Œç‰ˆæœ¬å‡çº§</h3><p>æè¿°: åœ¨ K8s ä¸­å¯¹ Jenkins å‡çº§æ˜¯éå¸¸çš„ç®€å•åªéœ€è¦æŠŠimageé”®ä¸­ç‰ˆæœ¬å€¼è¿›è¡Œæ”¹å˜(<code>åªéœ€è¦ä½¿ç”¨æ–°çš„ç‰ˆæœ¬é•œåƒæ›¿æ¢å³å¯</code>)ï¼Œä»è€Œæ‹‰å–æ–°çš„é•œåƒè¿è¡Œå³å¯ã€‚</p>
<p>Tips : æ³¨æ„æ­¤å¤„åšäº†PVCæŒä¹…åŒ–å¦‚æœæœªä½œæŒä¹…åŒ–çš„ç«¥é‹éœ€è¦æ³¨æ„æ•°æ®çš„ä¿å­˜, å…¶æ¬¡æ˜¯æ‹‰å–çš„ç‰ˆæœ¬çš„Jenkinsé•œåƒå¿…é¡»å­˜åœ¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ grep <span class="string">"jenkins:2.277-alpine"</span> jenkins-deployment.yaml</span><br><span class="line">  <span class="comment"># image: jenkins/jenkins:2.277-alpine</span></span><br><span class="line">  <span class="comment"># https://updates.jenkins.io/download/war/2.277/jenkins.war</span></span><br><span class="line">$ kubectl apply -f jenkins-deployment.yaml</span><br><span class="line">$ kubectl get pod -n devops</span><br><span class="line">  <span class="comment"># NAME                       READY   STATUS              RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># jenkins-5df679b7ff-5r8d4   0/1     ContainerCreating   0          24s</span></span><br><span class="line">  <span class="comment"># jenkins-7db7878f8f-78tmk   1/1     Running             2          18d  # åŸç‰ˆæœ¬ç­‰å¾…æ–°ç‰ˆæœ¬çš„Podå¯åŠ¨å®Œæ¯•åè‡ªåŠ¨é”€æ¯;</span></span><br></pre></td></tr></table></figure>
<p>Tips: å¯¹äºJenkinsç‰ˆæœ¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å»ºè®®å†’å†’å¤±å¤±è¿›è¡Œå‡çº§å…¶ä¸­åŸå› ä½ æˆ‘å¿ƒçŸ¥ï¼Œä½†æ˜¯é’ˆå¯¹äºå‡ºç°ä¸¥é‡æ¼æ´ä¸å¾—ä¸ä¿®å¤æ—¶ï¼Œå»ºè®®æ„å»ºæ–°çš„ç¯å¢ƒå†ä¾æ¬¡è¿ç§»ï¼ˆåŒæ—¶æ³¨æ„å¤‡ä»½ï¼‰ï¼Œç¡®å®šæ— ä»»ä½•é—®é¢˜åå†å…³é—­ä¸‹çº¿å¹¶è¿›è¡Œåˆ‡æ¢</p>
<p>Tips : æ­¤å¤„ä¸ºæµ‹è¯•å­¦ä¹ ç¯å¢ƒï¼Œçœ‹åˆ°è¿™ä¸ªæç¤ºæˆ‘çš„å¼ºè¿«ç—‡å°±ä¸Šæ¥äº†;</p>
<figure class="image-box">
                <a rel=4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½® href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202163113.png" target="_blank" title="WeiyiGeek.K8sé›†ç¾¤ä¸­å¯¹Jenkinsè¿›è¡Œå‡çº§" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210202163113.png" alt="WeiyiGeek.K8sé›†ç¾¤ä¸­å¯¹Jenkinsè¿›è¡Œå‡çº§" title="" class=""></a>
                <p>WeiyiGeek.K8sé›†ç¾¤ä¸­å¯¹Jenkinsè¿›è¡Œå‡çº§</p>
            </figure>
<p><br></p>
<h3 id="2-ç§»æ¤å…¶ä»–Jenkinsæœºå™¨ä¸Šçš„æ’ä»¶åˆ°Kuberneteså®‰è£…çš„Jenkinsä¸­ç„¶åè¿›è¡Œé‡æ–°Jenkins-éœ€è¦éå¸¸æ³¨æ„ç‰ˆæœ¬é—®é¢˜"><a href="#2-ç§»æ¤å…¶ä»–Jenkinsæœºå™¨ä¸Šçš„æ’ä»¶åˆ°Kuberneteså®‰è£…çš„Jenkinsä¸­ç„¶åè¿›è¡Œé‡æ–°Jenkins-éœ€è¦éå¸¸æ³¨æ„ç‰ˆæœ¬é—®é¢˜" class="headerlink" title="(2) ç§»æ¤å…¶ä»–Jenkinsæœºå™¨ä¸Šçš„æ’ä»¶åˆ°Kuberneteså®‰è£…çš„Jenkinsä¸­ç„¶åè¿›è¡Œé‡æ–°Jenkins(éœ€è¦éå¸¸æ³¨æ„ç‰ˆæœ¬é—®é¢˜-)"></a>(2) ç§»æ¤å…¶ä»–Jenkinsæœºå™¨ä¸Šçš„æ’ä»¶åˆ°Kuberneteså®‰è£…çš„Jenkinsä¸­ç„¶åè¿›è¡Œé‡æ–°Jenkins(éœ€è¦éå¸¸æ³¨æ„ç‰ˆæœ¬é—®é¢˜-)</h3><p>ç®€å•æ“ä½œæµç¨‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf jenkins_2.272.x_plugins.tar.gz -C ./jenkins/</span><br><span class="line"></span><br><span class="line">~/jenkins$ <span class="built_in">cd</span> var/lib/jenkins/plugins/</span><br><span class="line"></span><br><span class="line">~/jenkins/var/lib/jenkins/plugins$ cp -a . /nfsdisk-31/devops-jenkins-pvc-pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d/plugins/</span><br><span class="line"></span><br><span class="line">$ chown -R jenkins:jenkins /nfsdisk-31/devops-jenkins-pvc-pvc-3cd916df-91cb-470d-b9ef-e9b4f115223d/plugins</span><br></pre></td></tr></table></figure></p>
<p>Tips : æ³¨æ„æ­¤å¤„æ˜¯æˆ‘çš„PVCæŒä¹…åŒ–çš„ç›®å½•è·¯å¾„,ä¸ä½ å®è·µçš„ç¯å¢ƒæ˜¯ä¸ä¸€è‡´çš„ã€‚</p>
<p><br></p>
<hr>
<h2 id="0x04-å…¥å‘å‡ºå‘"><a href="#0x04-å…¥å‘å‡ºå‘" class="headerlink" title="0x04 å…¥å‘å‡ºå‘"></a>0x04 å…¥å‘å‡ºå‘</h2><h3 id="é—®é¢˜1-åœ¨K8sä¸­å®‰è£…Jenkinsæ—¶æŠ¥é”™ä»logsæ—¥å¿—æ˜¾ç¤ºCan-not-write-to-var-jenkins-home-copy-reference-file-log-Wrong-volume-permissions-é”™è¯¯"><a href="#é—®é¢˜1-åœ¨K8sä¸­å®‰è£…Jenkinsæ—¶æŠ¥é”™ä»logsæ—¥å¿—æ˜¾ç¤ºCan-not-write-to-var-jenkins-home-copy-reference-file-log-Wrong-volume-permissions-é”™è¯¯" class="headerlink" title="é—®é¢˜1.åœ¨K8sä¸­å®‰è£…Jenkinsæ—¶æŠ¥é”™ä»logsæ—¥å¿—æ˜¾ç¤ºCan not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?é”™è¯¯"></a>é—®é¢˜1.åœ¨K8sä¸­å®‰è£…Jenkinsæ—¶æŠ¥é”™ä»logsæ—¥å¿—æ˜¾ç¤º<code>Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?</code>é”™è¯¯</h3><ul>
<li>é”™è¯¯ä¿¡æ¯: æ²¡æœ‰æƒé™åœ¨ jenkins çš„ home ç›®å½•ä¸‹é¢åˆ›å»ºæ–‡ä»¶;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-ops logs jenkins2-59764f8f65-rcvh5</span><br><span class="line">Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?</span><br><span class="line">touch: cannot touch <span class="string">'/var/jenkins_home/copy_reference_file.log'</span>: Permission denied</span><br></pre></td></tr></table></figure></li>
<li>é”™è¯¯åŸå› : å› ä¸ºé»˜è®¤çš„é•œåƒä½¿ç”¨çš„æ˜¯ jenkins è¿™ä¸ªç”¨æˆ·ï¼Œè€Œæˆ‘ä»¬é€šè¿‡ PVC æŒ‚è½½åˆ° nfs æœåŠ¡å™¨çš„å…±äº«æ•°æ®ç›®å½•ä¸‹é¢å´æ˜¯ root ç”¨æˆ·çš„ï¼Œæ‰€ä»¥æ²¡æœ‰æƒé™è®¿é—®è¯¥ç›®å½•</li>
<li>é—®é¢˜è§£å†³: åªéœ€è¦åœ¨ nfs å…±äº«æ•°æ®ç›®å½•ä¸‹é¢æŠŠæˆ‘ä»¬çš„ç›®å½•æƒé™é‡æ–°åˆ†é…ä¸‹å³å¯ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R 1000 /data/k8s/jenkins2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="é—®é¢˜2-Jenkinsè°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡æ—¶java-lang-IllegalStateException-Agent-is-not-connected-after-100-seconds-status-RunningæŠ¥é”™å¯¼è‡´ä¸æ–­é‡å¯"><a href="#é—®é¢˜2-Jenkinsè°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡æ—¶java-lang-IllegalStateException-Agent-is-not-connected-after-100-seconds-status-RunningæŠ¥é”™å¯¼è‡´ä¸æ–­é‡å¯" class="headerlink" title="é—®é¢˜2.Jenkinsè°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡æ—¶java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: RunningæŠ¥é”™å¯¼è‡´ä¸æ–­é‡å¯"></a>é—®é¢˜2.Jenkinsè°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡æ—¶<code>java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: Running</code>æŠ¥é”™å¯¼è‡´ä¸æ–­é‡å¯</h3><p><strong>é—®é¢˜æè¿°: Agent ä¸èƒ½ é€šè¿‡ jnlp ä¸ Jenkins çš„ Master ç›¸è¿æ¥</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2021-02-04 05:37:46.886+0000 [id=1985]  WARNING o.c.j.p.k.KubernetesLauncher<span class="comment">#launch: Error in provisioning; agent=KubernetesSlave name: jenkins-slave-b63kv, template=PodTemplate&#123;id='83f07044-1633-468a-91c8-e05ffb924303', name='jenkins-slave', namespace='devops', label='jenkins-slave', serviceAccount='jenkins-sa', volumes=[HostPathVolume [mountPath=/home/jenkins/.m2, hostPath=/tmp/.m2]], containers=[ContainerTemplate&#123;name='jnlp', image='jenkins/inbound-agent:alpine', workingDir='/home/jenkins', command='sleep', args='9999999', resourceRequestCpu='', resourceRequestMemory='', resourceRequestEphemeralStorage='', resourceLimitCpu='', resourceLimitMemory='', resourceLimitEphemeralStorage='', livenessProbe=ContainerLivenessProbe&#123;execArgs='', timeoutSeconds=0, initialDelaySeconds=0, failureThreshold=0, periodSeconds=0, successThreshold=0&#125;&#125;]&#125;</span></span><br><span class="line">java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: Running</span><br><span class="line">        at org.csanchez.jenkins.plugins.kubernetes.KubernetesLauncher.launch(KubernetesLauncher.java:244)</span><br><span class="line">        at hudson.slaves.SlaveComputer.lambda<span class="variable">$_connect</span><span class="variable">$0</span>(SlaveComputer.java:294)</span><br><span class="line">        at jenkins.util.ContextResettingExecutorService<span class="variable">$2</span>.call(ContextResettingExecutorService.java:46)</span><br><span class="line">        at jenkins.security.ImpersonatingExecutorService<span class="variable">$2</span>.call(ImpersonatingExecutorService.java:80)</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">2021-02-04 05:37:46.886+0000 [id=1985]  INFO    o.c.j.p.k.KubernetesSlave<span class="comment">#_terminate: Terminating Kubernetes instance for agent jenkins-slave-b63kv</span></span><br><span class="line">2021-02-04 05:37:46.900+0000 [id=1985]  INFO    o.c.j.p.k.KubernetesSlave<span class="comment">#deleteSlavePod: Terminated Kubernetes instance for agent devops/jenkins-slave-b63kv</span></span><br><span class="line">2021-02-04 05:37:46.901+0000 [id=1985]  INFO    o.c.j.p.k.KubernetesSlave<span class="comment">#_terminate: Disconnected computer jenkins-slave-b63kv</span></span><br><span class="line">Terminated Kubernetes instance <span class="keyword">for</span> agent devops/jenkins-slave-b63kv</span><br><span class="line">Disconnected computer jenkins-slave-b63kv</span><br></pre></td></tr></table></figure></p>
<p><strong>é—®é¢˜åŸå› :</strong></p>
<blockquote>
<p>ç­”: è¿™ä¸ªé—®é¢˜å›°æ‰°äº†æˆ‘å¥½ä¹…ï¼Œæ€»ç»“å¯èƒ½å‡ºç°è¯¥é—®é¢˜çš„æƒ…å†µï¼Œ<br>1.æŒ‡å®šçš„ Jenkins-jnlp å®¹å™¨é•œåƒçš„Agentä¸èƒ½æ­£å¸¸è¿æ¥åˆ°Master<br>2.æŒ‡å®šçš„ Jenkins-jnlp é•œåƒå¯åŠ¨å‚æ•°é—®é¢˜ã€‚</p>
</blockquote>
<p><strong>è§£å†³åŠæ³•:</strong></p>
<blockquote>
<p>ç­”: æ¢é•œåƒ,åœ¨åé¢çš„ç« èŠ‚ä¸­æˆ‘ä¼šå°†è‡ªå®šä¹‰<code>Jenkins Slave Jnlp</code> å®¹å™¨é•œåƒçš„DockerFileæ–‡ä»¶è¿›è¡Œåˆ†äº«,æ­¤æ—¶ä½ å¯ä»¥å°†Podæ¨¡æ¿ä¸­çš„ContainerTemplateå®¹å™¨æ¨¡æ¿åˆ é™¤å³å¯,åˆ©ç”¨åœ¨pipeline è„šæœ¬ä¸­è¿›è¡ŒæŒ‡å®š,ä¾‹å¦‚:<code>docker.io/weiyigeek/alpine-jenkins-jnlp:v2.285</code>ã€‚<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    kubernetes &#123;</span><br><span class="line">      cloud <span class="string">'kubernetes'</span></span><br><span class="line">      namespace <span class="string">'devops'</span></span><br><span class="line">      inheritFrom <span class="string">'jenkins-slave'</span></span><br><span class="line">      workingDir <span class="string">'/home/jenkins/agent'</span></span><br><span class="line">      <span class="comment">// yamlFile 'KubernetesPod.yaml'</span></span><br><span class="line">      yaml <span class="string">"""\</span></span><br><span class="line"><span class="string">apiVersion:</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    jenkins: "slave"</span></span><br><span class="line"><span class="string">    jenkins/label: 'k8s-slave'</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: 'jnlp'</span></span><br><span class="line"><span class="string">    image: 'docker.io/weiyigeek/alpine-jenkins-jnlp:v2.285'</span></span><br><span class="line"><span class="string">    imagePullPolicy: 'IfNotPresent'                                    </span></span><br><span class="line"><span class="string">    command: ["/bin/sh","-c","/usr/local/bin/jenkins-agent.sh &amp;&amp; cat"] </span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - mountPath: "/home/jenkins/.m2"</span></span><br><span class="line"><span class="string">      name: "volume-0"</span></span><br><span class="line"><span class="string">    - mountPath: "/var/run/docker.sock"</span></span><br><span class="line"><span class="string">      name: "volume-1"</span></span><br><span class="line"><span class="string">    """</span>.stripIndent()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><br></p>
<h3 id="é—®é¢˜3-åŸºäº-Kubernetes-éƒ¨ç½²-Jenkins-åŠ¨æ€-slave-åï¼Œè¿è¡Œ-Jenkins-Job-ä¼šæŠ›java-nio-channels-ClosedChannelException"><a href="#é—®é¢˜3-åŸºäº-Kubernetes-éƒ¨ç½²-Jenkins-åŠ¨æ€-slave-åï¼Œè¿è¡Œ-Jenkins-Job-ä¼šæŠ›java-nio-channels-ClosedChannelException" class="headerlink" title="é—®é¢˜3.åŸºäº Kubernetes éƒ¨ç½² Jenkins åŠ¨æ€ slave åï¼Œè¿è¡Œ Jenkins Job ä¼šæŠ›java.nio.channels.ClosedChannelException"></a>é—®é¢˜3.åŸºäº Kubernetes éƒ¨ç½² Jenkins åŠ¨æ€ slave åï¼Œè¿è¡Œ Jenkins Job ä¼šæŠ›java.nio.channels.ClosedChannelException</h3><p>å¼‚å¸¸é—®é¢˜:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FATAL: java.nio.channels.ClosedChannelException</span><br><span class="line">java.nio.channels.ClosedChannelException</span><br><span class="line">Also:   hudson.remoting.Channel<span class="variable">$CallSiteStackTrace</span>: Remote call to JNLP4-connect connection from 10.244.8.1/10.244.8.1:55340</span><br><span class="line">    at hudson.remoting.Channel.attachCallSiteStackTrace(Channel.java:1741)</span><br><span class="line">    at hudson.remoting.Request.call(Request.java:202)</span><br><span class="line">    at hudson.remoting.Channel.call(Channel.java:954)</span><br><span class="line">    at hudson.FilePath.act(FilePath.java:1071)</span><br><span class="line">    at hudson.FilePath.act(FilePath.java:1060)</span><br><span class="line">    at hudson.FilePath.mkdirs(FilePath.java:1245)</span><br><span class="line">    at hudson.model.AbstractProject.checkout(AbstractProject.java:1202)</span><br><span class="line">    at hudson.model.AbstractBuild<span class="variable">$AbstractBuildExecution</span>.defaultCheckout(AbstractBuild.java:574)</span><br><span class="line">    at jenkins.scm.SCMCheckoutStrategy.checkout(SCMCheckoutStrategy.java:86)</span><br><span class="line">    at hudson.model.AbstractBuild<span class="variable">$AbstractBuildExecution</span>.run(AbstractBuild.java:499)</span><br><span class="line">    at hudson.model.Run.execute(Run.java:1819)</span><br><span class="line">    at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:43)</span><br><span class="line">    at hudson.model.ResourceController.execute(ResourceController.java:97)</span><br><span class="line">    at hudson.model.Executor.run(Executor.java:429)</span><br><span class="line">Caused: hudson.remoting.RequestAbortedException</span><br><span class="line">  at hudson.remoting.Request.abort(Request.java:340)</span><br><span class="line">  at hudson.remoting.Channel.terminate(Channel.java:1038)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.impl.ChannelApplicationLayer.onReadClosed(ChannelApplicationLayer.java:209)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.ApplicationLayer.onRecvClosed(ApplicationLayer.java:222)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.ProtocolStack<span class="variable">$Ptr</span>.onRecvClosed(ProtocolStack.java:832)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.FilterLayer.onRecvClosed(FilterLayer.java:287)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.impl.SSLEngineFilterLayer.onRecvClosed(SSLEngineFilterLayer.java:172)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.ProtocolStack<span class="variable">$Ptr</span>.onRecvClosed(ProtocolStack.java:832)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.NetworkLayer.onRecvClosed(NetworkLayer.java:154)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.impl.NIONetworkLayer.ready(NIONetworkLayer.java:142)</span><br><span class="line">  at org.jenkinsci.remoting.protocol.IOHub<span class="variable">$OnReady</span>.run(IOHub.java:795)</span><br><span class="line">  at jenkins.util.ContextResettingExecutorService<span class="variable">$1</span>.run(ContextResettingExecutorService.java:28)</span><br><span class="line">  at jenkins.security.ImpersonatingExecutorService<span class="variable">$1</span>.run(ImpersonatingExecutorService.java:59)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">Finished: FAILURE</span><br></pre></td></tr></table></figure></p>
<p>é—®é¢˜åŸå› : æŠ› <code>java.nio.channels.ClosedChannelException</code> å¼‚å¸¸çš„åŸå› æ˜¯ <code>Jenkins Slave Pod åœ¨ Jenkins Job</code> è¿è¡Œæ—¶çªç„¶æŒ‚æ‰ï¼Œç„¶å Master Pod æ— æ³•å’Œ Slave Pod è¿›è¡Œé€šä¿¡ã€‚é‚£ä¹ˆè§£å†³æ–¹æ³•å°±æ˜¯æ‰¾åˆ° Slave Pod ç»å¸¸æŒ‚æ‰çš„åŸå› ï¼Œç»æ’æŸ¥æ˜¯ Slave Pod çš„èµ„æºé™åˆ¶ä¸åˆç†ï¼Œé…ç½®çš„ CPU å’Œå†…å­˜å¤ªå°ï¼Œå¯¼è‡´ Pod åœ¨è¿è¡Œæ˜¯å¾ˆå®¹æ˜“è¶…å‡ºèµ„æºé™åˆ¶ï¼Œç„¶åè¢« k8s Kill æ‰ã€‚</p>
<p>è§£å†³åŠæ³•:æ‰“å¼€ Jenkins è®¾ç½® Slave Pod æ¨¡ç‰ˆçš„èµ„æºé™åˆ¶ï¼š<code>Jenkins-&gt;ç³»ç»Ÿç®¡ç†-&gt;ç³»ç»Ÿè®¾ç½®-&gt;äº‘-&gt;é•œåƒ-&gt;Kubernetes Pod Template-&gt;Container Template-&gt;é«˜çº§</code>ï¼Œç„¶åæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ CPU å’Œå†…å­˜éœ€æ±‚ã€‚</p>

        </div>
        <!-- Google å¹¿å‘Š -->
          

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-10-23T08:29:14.698Z" itemprop="dateUpdated">2022-10-23 16:29:14</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/ç³»ç»Ÿè¿ç»´/è‡ªåŠ¨åŒ–è¿ç»´/CI-CD/Jenkins/4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®.md" target="_blank" rel="noopener noreferrer">_posts/ç³»ç»Ÿè¿ç»´/è‡ªåŠ¨åŒ–è¿ç»´/CI-CD/Jenkins/4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2020/12-30-531.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/12-30-531.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=ã€Š4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=ã€Š4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/12-30-531.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/12-30-523.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">3.Jenkinsè¿›é˜¶ä¹‹æµæ°´çº¿pipelineåŸºç¡€ä½¿ç”¨å®è·µ</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/12-29-519.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">2.Jenkinsè¿›é˜¶ä¹‹æµæ°´çº¿pipelineè¯­æ³•å…¥é—¨å­¦ä¹ </h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 å‰è¨€ç®€è¿°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-èŠ‚ç‚¹è¯´æ˜"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.èŠ‚ç‚¹è¯´æ˜</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-èŠ‚ç‚¹è¿æ¥"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.èŠ‚ç‚¹è¿æ¥</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#SSH-æ–¹å¼"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">SSH æ–¹å¼</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#JNLP-æ–¹å¼"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">JNLP æ–¹å¼</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-ç‚¹æ˜ä¸»é¢˜"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.ç‚¹æ˜ä¸»é¢˜</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-çŸ¥è¯†æ‰©å±•"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">4.çŸ¥è¯†æ‰©å±•</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-å®‰è£…éƒ¨ç½²"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 å®‰è£…éƒ¨ç½²</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#0-åˆ†å¸ƒå¼æ¶æ„è¿‡ç¨‹è¯´æ˜"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">(0) åˆ†å¸ƒå¼æ¶æ„è¿‡ç¨‹è¯´æ˜</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#åœ¨-Master-èŠ‚ç‚¹ä¸­æ·»åŠ -Agent-æ–¹å¼"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">åœ¨ Master èŠ‚ç‚¹ä¸­æ·»åŠ  Agent æ–¹å¼</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-å•ä¸»æœºéƒ¨ç½²é…ç½®å›ºå®š-agent"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">(1) å•ä¸»æœºéƒ¨ç½²é…ç½®å›ºå®š agent</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Java-Web-å¯åŠ¨-Agent-æ–¹å¼"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">Java Web å¯åŠ¨ Agent æ–¹å¼</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Launch-agents-via-SSH-å¯åŠ¨-Agent-æ–¹å¼"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">Launch agents via SSH å¯åŠ¨ Agent æ–¹å¼</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-é›†ç¾¤æ­å»ºJenkins-Master-èŠ‚ç‚¹"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">(2) é›†ç¾¤æ­å»ºJenkins Master èŠ‚ç‚¹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-1-åŸºç¡€ç¯å¢ƒ"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text">2.1) åŸºç¡€ç¯å¢ƒ</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-æ­å»ºæµç¨‹"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text">2.2) æ­å»ºæµç¨‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-é›†ç¾¤åŠ¨æ€åˆ›å»º-Agent-èŠ‚ç‚¹-Slave-èŠ‚ç‚¹"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">(3) é›†ç¾¤åŠ¨æ€åˆ›å»º Agent èŠ‚ç‚¹ - Slave èŠ‚ç‚¹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å†…ç½®-Jenkins-Master-æ¥å…¥å†…éƒ¨-K8s-é›†ç¾¤"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">å†…ç½® Jenkins Master æ¥å…¥å†…éƒ¨ K8s é›†ç¾¤</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ç‹¬ç«‹Jenkins-MasterèŠ‚ç‚¹æ¥å…¥å¤–éƒ¨K8sé›†ç¾¤"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text">ç‹¬ç«‹Jenkins MasterèŠ‚ç‚¹æ¥å…¥å¤–éƒ¨K8sé›†ç¾¤</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-è¡¥å……è¯´æ˜"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x03 è¡¥å……è¯´æ˜</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-K8s-é›†ç¾¤ä¸­å¯¹æ­å»ºçš„Jenkinsè¿›è¡Œç‰ˆæœ¬å‡çº§"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">(1) K8s é›†ç¾¤ä¸­å¯¹æ­å»ºçš„Jenkinsè¿›è¡Œç‰ˆæœ¬å‡çº§</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-ç§»æ¤å…¶ä»–Jenkinsæœºå™¨ä¸Šçš„æ’ä»¶åˆ°Kuberneteså®‰è£…çš„Jenkinsä¸­ç„¶åè¿›è¡Œé‡æ–°Jenkins-éœ€è¦éå¸¸æ³¨æ„ç‰ˆæœ¬é—®é¢˜"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">(2) ç§»æ¤å…¶ä»–Jenkinsæœºå™¨ä¸Šçš„æ’ä»¶åˆ°Kuberneteså®‰è£…çš„Jenkinsä¸­ç„¶åè¿›è¡Œé‡æ–°Jenkins(éœ€è¦éå¸¸æ³¨æ„ç‰ˆæœ¬é—®é¢˜-)</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-å…¥å‘å‡ºå‘"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x04 å…¥å‘å‡ºå‘</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é—®é¢˜1-åœ¨K8sä¸­å®‰è£…Jenkinsæ—¶æŠ¥é”™ä»logsæ—¥å¿—æ˜¾ç¤ºCan-not-write-to-var-jenkins-home-copy-reference-file-log-Wrong-volume-permissions-é”™è¯¯"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">é—®é¢˜1.åœ¨K8sä¸­å®‰è£…Jenkinsæ—¶æŠ¥é”™ä»logsæ—¥å¿—æ˜¾ç¤ºCan not write to &#x2F;var&#x2F;jenkins_home&#x2F;copy_reference_file.log. Wrong volume permissions?é”™è¯¯</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é—®é¢˜2-Jenkinsè°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡æ—¶java-lang-IllegalStateException-Agent-is-not-connected-after-100-seconds-status-RunningæŠ¥é”™å¯¼è‡´ä¸æ–­é‡å¯"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">é—®é¢˜2.Jenkinsè°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡æ—¶java.lang.IllegalStateException: Agent is not connected after 100 seconds, status: RunningæŠ¥é”™å¯¼è‡´ä¸æ–­é‡å¯</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é—®é¢˜3-åŸºäº-Kubernetes-éƒ¨ç½²-Jenkins-åŠ¨æ€-slave-åï¼Œè¿è¡Œ-Jenkins-Job-ä¼šæŠ›java-nio-channels-ClosedChannelException"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">é—®é¢˜3.åŸºäº Kubernetes éƒ¨ç½² Jenkins åŠ¨æ€ slave åï¼Œè¿è¡Œ Jenkins Job ä¼šæŠ›java.nio.channels.ClosedChannelException</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½æœ‹å‹,å¯ä»¥å…³ä¸ªæ³¨å—? â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=ã€Š4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/12-30-531.html&title=ã€Š4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š4.Jenkinsè¿›é˜¶ä¹‹åˆ†å¸ƒå¼æ¶æ„ç¯å¢ƒé…ç½®ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/12-30-531.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/12-30-531.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKklEQVR42u3aO27kMBAFQN//0nLqYDX7XlM2ILIYGYMxpWLQw/58fcXr+rF+fpJ//+477X8tLQwMjNcyro/r7jv5zskr3h1Q8m4YGBjnMNqtk0B8F1LXwzoGBgbGjPF5n9krYmBgYDzFyMNlEqAxMDAwVpLYFv/s0TyWi2NgYLyQMSuc/c3fv9LfwMDAeBXjKldS9J+Fy2thYWBg7M3IA1xLavdpAy4GBsY5jNmAxSzURic6anxiYGDszcj/LSnff/48KdK1Yxz/+d3AwMDYiDELr0lJbpYMJ88qGpkYGBgvZ+SBMm8YrHwyK8xhYGDszchLab9S54v3iY4VAwNjU0ZSbmuHwGa7JYDbPTEwMA5mtOnorKmZH9PtFRMDA+MARltKy4cq8nR3JZRjYGDszVi55M3GL9q2ZTFsgYGBsTUjecB607HF1yEbAwNjU0b+4Fkzsm0VFL8P7aljYGC8lrFysctboeu86JqIgYFxJKMt2bdp6rPPwsDAOIeRF8Ly0ljeIl05SgwMjDMZS63EEj8L3HXXFAMD4+WMfPArL4q1pf9ZqxUDA2NvxlWu5KI2e9225PePSyEGBsamjFmzMx+2yIfD8mGO5IqJgYGxH2MWZFvYLPUt0l0MDIwDGMl1rU1ok+ZB+wtwi8TAwMB4qPSWJ6V1EouBgYFRBs38JdoBjocDLgYGxqsYSRKbDEO0AxazRBoDA+M0xlNjEwl11jB4rJGJgYHxPsY32xCyUPAdejMAAAAASUVORK5CYII=" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// ç«™ç‚¹è¿è¡Œæ—¶é—´
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "å¤©" + RunHours + "æ—¶" + RunMinutes + "åˆ†" + RunSeconds + "ç§’";
  document.getElementById(id).innerHTML = "ç½‘ç«™å·²åœ¨é£é›¨ä¸­å‹‰å‹‰å¼ºå¼ºè¿è¡Œäº†ã€" + RunTime + "ã€‘";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>