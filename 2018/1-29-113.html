<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 采用Rsync与Inotify实时同步文件目录|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Rsync,Inotify">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>采用Rsync与Inotify实时同步文件目录</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">采用Rsync与Inotify实时同步文件目录</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-01-29T05:34:30.000Z" itemprop="datePublished" class="page-time">
  2018-01-29
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/">实时同步</a></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-系统运维/Application/Sync/采用Rsync与Inotify实时同步文件目录"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">采用Rsync与Inotify实时同步文件目录</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-01-29 13:34:30" datetime="2018-01-29T05:34:30.000Z"  itemprop="datePublished">2018-01-29</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/">实时同步</a></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<hr>
<h2 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h2><h3 id="1-Rsync-介绍"><a href="#1-Rsync-介绍" class="headerlink" title="1.Rsync 介绍"></a>1.Rsync 介绍</h3><p>描述: Rsync（<code>remote synchronize</code>）是一个提供快速增量文件传输的开源实用程序, rsync是根据GNU通用公共许可证免费提供的，目前由Wayne Davison维护。</p>
<p>Tips : 通过 rsync 可以解决对实时性要求不高的数据备份需求，例如定期的备份文件服务器数据到远端服务器，对本地磁盘定期做数据镜像等</p>
<p><strong>Rsync 特点</strong></p>
<ul>
<li>安全性高、备份迅速、支持增量备份</li>
</ul>
<p><br></p>
<p><strong>Rsync 应用</strong><br>描述: 随着应用系统规模的不断扩大，对数据的安全性和可靠性也提出的更好的要求，rsync在高端业务系统中也逐渐暴露出了很多不足，首先rsync同步数据时，需要扫描所有文件后进行比对，进行差量传输。如果文件数量达到了百万甚至千万量级，扫描所有文件将是非常耗时的。而且正在发生变化的往往是其中很少的一部分，这是非常低效的方式</p>
<p>其次 rsync不能实时的去监测、同步数据，虽然它可以通过linux守护进程的方式进行触发同步，但是两次触发动作一定会有时间差，这样就导致了服务端和客户端数据可能出现不一致，无法在应用故障时完全的恢复数据。基于以上原因<code>rsync+inotify</code>组合出现了！</p>
<p>Tips : rsync 服务器可以独立运行,也可由 Xinetd 运行.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Centos 6.x 需要依托与xinetd服务</span><br><span class="line">Centos 7.x 可直接独立运行</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>官方地址:</strong> <a href="https://rsync.samba.org/" target="_blank" rel="noopener">https://rsync.samba.org/</a><br><strong>官方文档:</strong> <a href="https://rsync.samba.org/documentation.html" target="_blank" rel="noopener">https://rsync.samba.org/documentation.html</a></p>
<p><br></p>
<h3 id="2-Inotify-介绍"><a href="#2-Inotify-介绍" class="headerlink" title="2.Inotify 介绍"></a>2.Inotify 介绍</h3><p>描述:Inotify 是一种强大的、细粒度的、异步的文件系统事件监控机制（基于inode的）,它是 Linux内核2.6.13 (June 18, 2005)版本新增的一个子系统（API）， ，它满足各种各样的文件监控需要，可以监控文件系统的<code>访问属性、读写属性、权限属性、删除创建、移动等操作</code>，也就是可以监控文件发生的一切变化 ，并可以将相应的事件通知给应用程序。</p>
<p>inotify是一个API，需要通过开发应用程序进行调用，对于大多数用户来讲这有着许多不便，inotify-tools的出现弥补了这一不足，inotify-tools是一套组件，inotify-tools是一个C库和一组命令行的工作提供Linux下inotify的简单接口，这些命令行工具可用于通过命令行或脚本对某文件系统的事件进行监控。</p>
<p>Tips: 该机制由著名的桌面搜索引擎项目beagle引入用于替代此前具有类似功能但存在诸多缺陷的dnotify</p>
<p>Tips : FreeBSD 和 Mac OS X 提供一个类似于 inotify 的 kqueue，在 FreeBSD 机器上输入 man 2 kqueue 获取更多信息，本文基于 Ubuntu Desktop version 8.04.1（即 Hardy），它运行在 Mac OS X version 10.5 Leopard 的 Parallels Desktop version 3.0。</p>
<p><br/></p>
<p><strong>Inotify 应用</strong><br>描述: Rsync可以实现触发式的文件同步，但是通过crontab守护进程方式进行触发，同步的数据和实际数据会有差异，而inotify可以监控文件系统的各种变化，当文件有任何变动时，就触发rsync同步，这样刚好解决了同步数据的实时性问题。</p>
<p>企业中常常以rsync Damon方式运行rsync来同步服务器之间数据，一般以Damon 方式与inotify结合时候运行在备份服务器端 而客户端则不需要以Damon运行，只需要安装rsync即可.</p>
<p>Tips : Inotify 是内核的集成功能，其可用在很多方面，此处与rsync结合只是为了实现文件同步</p>
<p>Tips : Inotify 是基于rsync的push模型，需要安装在没有运行rsync damon的一端，用来监视服务器需要与其他节点同步的文件变化将服务器文件推向Rsync服务端备份节点。</p>
<p>Tips : inotify既可以监控文件也可以监控目录, 当监控目录时，它可以同时监控目录及目录中的各子目录及文件的，此外，inotify 使用文件描述符作为接口，因而可以使用通常的文件I/O操作select、poll和epoll来监视文件系统的变化，幸好自动化 shell 脚本、使用 Nagios 等工具进行监控、通过常见的 cron 进行任务调度可以减轻这个负担。</p>
<p><br></p>
<p><strong>Inotify 参数说明</strong><br>描述: 在 inotify-tools 安装后会得到 <code>inotifywait</code> 和 <code>inotifywatch</code> 这两条命令：</p>
<ul>
<li>inotifywait: 通过inotify API等待被监控文件上的相应事件并返回监控结果，默认情况下，正常的结果返回至标准输出，诊断类的信息则返回至标准错误输出，它可以在监控到对应监控对象上指定的事件后退出，也可以进行持续性的监控</li>
<li>inotifywatch: 通过inotify API收集被监控文件或目录的相关事件并输出统计信息</li>
</ul>
<p><br></p>
<p>inotify 可以监视的文件系统常见事件包括:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IN_ACCESS：文件被访问</span><br><span class="line">IN_MODIFY：文件被修改</span><br><span class="line">IN_ATTRIB，文件属性被修改</span><br><span class="line">IN_CLOSE_WRITE，以可写方式打开的文件被关闭</span><br><span class="line">IN_CLOSE_NOWRITE，以不可写方式打开的文件被关闭</span><br><span class="line">IN_OPEN，文件被打开</span><br><span class="line">IN_MOVED_FROM，文件被移出监控的目录</span><br><span class="line">IN_MOVED_TO，文件被移入监控着的目录</span><br><span class="line">IN_CREATE，在监控的目录中新建文件或子目录</span><br><span class="line">IN_DELETE，文件或目录被删除</span><br><span class="line">IN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己</span><br><span class="line">IN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己</span><br></pre></td></tr></table></figure></p>
<p>Tips : inotify定义了下列的接口参数，可以用来限制inotify消耗kernel memory的大小, 由于这些参数都是内存参数，因此可以根据应用需求，通过/proc接口中的如下参数设定inotify能够使用的调节内存大小：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用程序调用inotify时需要初始化inotify实例，并时会为其设定一个事件队列，此文件中的值则是用于设定此队列长度的上限；超出此上限的事件将会被丢弃；</span></span><br><span class="line">/proc/sys/fs/inotify/max_queue_events</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此文件中的数值用于设定每个用户ID（以ID标识的用户）可以创建的inotify实例数目的上限；</span></span><br><span class="line">/proc/sys/fs/inotify/max_user_instances</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此文件中的数值用于设定每个用户ID可以监控的文件或目录数目上限；</span></span><br><span class="line">/proc/sys/fs/inotify/max_user_watches</span><br></pre></td></tr></table></figure></p>
<p>Tips : 根据以上在32位或者64位系统都可以执行如下命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 104857600 &gt; /proc/sys/fs/inotify/max_user_watches </span><br><span class="line"><span class="built_in">echo</span> <span class="string">'echo 104857600 &gt; /proc/sys/fs/inotify/max_user_watches'</span> &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>官方地址</strong><br>它由Rohan McGovern开发，其项目网址为<a href="http://inotify-tools.sourceforge.net" target="_blank" rel="noopener">http://inotify-tools.sourceforge.net</a><br>inotify-tools项目地址：<a href="https://github.com/rvoicilas/inotify-tools" target="_blank" rel="noopener">https://github.com/rvoicilas/inotify-tools</a> inotify-tools</p>
<hr>
<h2 id="0x01-安装配置"><a href="#0x01-安装配置" class="headerlink" title="0x01 安装配置"></a>0x01 安装配置</h2><h3 id="1-Centos-7-x-安装Rsync"><a href="#1-Centos-7-x-安装Rsync" class="headerlink" title="1.Centos 7.x 安装Rsync"></a>1.Centos 7.x 安装Rsync</h3><p>描述: CentOS7.x后则可以独立运行，即通过yum安装完成后即可以通过systemctl start rsync来启动，对于负荷较重的 rsync 服务器应该使用独立运行方式.</p>
<ul>
<li>Step 1.rsync 基础安装配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 yum 软件包管理工具进行安装 Rsync （客户端与服务端都安装）</span></span><br><span class="line">yum -y install rsyncd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认配置文件存在于 /etc/rsyncd.conf</span></span><br><span class="line">uid = rsync                       <span class="comment">#设置运行rsync 进程的用户</span></span><br><span class="line">gid = rsync</span><br><span class="line">use chroot = no      <span class="comment">#是否可以切换根目录</span></span><br><span class="line">max connections = 4</span><br><span class="line"><span class="comment"># pid file = /var/run/rsyncd.pid        #CentOS7中yum安装 不需指定pid file 否则报错</span></span><br><span class="line">lock file = /var/run/rsyncd.lock</span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log       <span class="comment">#此文件定义完成后 系统会自动创建</span></span><br><span class="line">exclude = lost+found/             </span><br><span class="line">transfer logging = yes</span><br><span class="line">timeout = 900</span><br><span class="line">ignore nonreadable = yes           <span class="comment">#同步时跳过没有权限的目录</span></span><br><span class="line">dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2 <span class="comment">#传输时不压缩的文件</span></span><br><span class="line"> </span><br><span class="line">[rsynctest]             <span class="comment">#此名字即客户端使用rsync来同步的路径</span></span><br><span class="line">path = /tmp/rsynctest   <span class="comment">#实际需要同步的路径</span></span><br><span class="line">comment = Test Rsync    <span class="comment">#备注</span></span><br><span class="line">ignore errors = yes</span><br><span class="line"><span class="built_in">read</span> only = yes         <span class="comment">#表示可以pull</span></span><br><span class="line">write only = no         <span class="comment">#表示可以push</span></span><br><span class="line">hosts allow = 192.168.133.130   <span class="comment">#只允许得ip地址连接</span></span><br><span class="line">hosts deny = *                   <span class="comment">#拒绝得ip地址连接</span></span><br><span class="line">list = <span class="literal">false</span></span><br><span class="line">uid = rsync         <span class="comment">#获取文件的身份</span></span><br><span class="line">gid = rsync</span><br><span class="line">auth users = rsyncuser   <span class="comment">#客户端获取文件的身份 此用户并不是本机中确实存在的用户</span></span><br><span class="line">secrets file = /etc/rsyncd.passwd     <span class="comment">#用来认证客户端的秘钥文件 格式 USERNAME:PASSWD 此文件权限</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 2.安全配置认证文件和相应用户与目录创建<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyncd.passwd    <span class="comment"># rsyncuser:123456</span></span><br><span class="line"><span class="comment"># 属主必须与运行rsync的用户一致</span></span><br><span class="line">chown nobody:nobody /etc/rsyncd.passwd</span><br><span class="line"><span class="comment"># 权限设置为600</span></span><br><span class="line">chmod +600 /etc/rsyncd.passwd</span><br><span class="line"><span class="comment"># 指定不能登录Shell</span></span><br><span class="line">usermod rsync -s /sbin/nologin  </span><br><span class="line"><span class="comment"># 安全起见，应新建目录，也可以用已经存在的</span></span><br><span class="line">mkdir /tmp/rsynctest</span><br><span class="line"><span class="comment"># 文件夹得宿主</span></span><br><span class="line">chown -R nobody.nobody /tmp/rsynctest</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 3.服务启动其默认监听在tcp 873 端口( 注意查看防火墙允许通过873/TCP)。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rsyncd.service</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 4.客户端使用 rsync 演示<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意: 只需要服务器 rsyncd.passwd 中的密码</span></span><br><span class="line"><span class="built_in">echo</span> 123456 &gt;&gt; /etc/rsyncd.passwd  </span><br><span class="line">chmod 600 /etc/rsyncd.passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意: 若要在crontab中添加自动同步，则必须指定--password-file 且rsyncuser一定为rsyncd.passwd中定义的，rsynctest 为服务器端 [ ] 中定义的.</span></span><br><span class="line">rsync -auv --password-file=/etc/rsyncd.passwd rsyncuser@192.168.111.243::rstest  /tmp</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714152707.png" target="_blank" title="WeiyiGeek.rsynctest" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714152707.png" alt="WeiyiGeek.rsynctest" title="" class=""></a>
                <p>WeiyiGeek.rsynctest</p>
            </figure>
</li>
</ul>
<p>Tips : 配置文件官方解析地址(<a href="https://download.samba.org/pub/rsync/rsyncd.conf.html" target="_blank" rel="noopener">https://download.samba.org/pub/rsync/rsyncd.conf.html</a>)</p>
<p><br></p>
<p><strong>源码包方式安装</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.从rsync官网下载rsync-3.1.2.tar.gz</span></span><br><span class="line">wget https://download.samba.org/pub/rsync/src/rsync-3.1.2.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.编译安装</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/rsync</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="comment"># Rsync依赖</span></span><br><span class="line">yum install mariadb  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.建立软连接</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/bin/rsync/bin/rsync /usr/bin/rsync   <span class="comment"># 软连接</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 4.配置 rsync server 配置文件</span></span><br><span class="line">vi /usr/<span class="built_in">local</span>/rsync/rsyncd.conf   </span><br><span class="line">pid = root  </span><br><span class="line">gid = root  </span><br><span class="line">use chroot = no  </span><br><span class="line">port = 873</span><br><span class="line">max connections = 200  </span><br><span class="line">timeout 600  </span><br><span class="line">pid file = /var/run/rsyncd.pid  </span><br><span class="line">lock file = /var/run/rsyncd.lock  </span><br><span class="line"><span class="built_in">log</span> file = /var/run/rsyncd.log  </span><br><span class="line">motd file = /etc/rsyncd.motd  </span><br><span class="line">ignore nonreadable = yes           </span><br><span class="line">dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span><br><span class="line"></span><br><span class="line">[<span class="built_in">test</span>]  </span><br><span class="line">path = /<span class="built_in">test</span>/  </span><br><span class="line">comment = ocpyang  <span class="built_in">test</span>  </span><br><span class="line">ignore errors  </span><br><span class="line"><span class="built_in">read</span> only = <span class="literal">true</span>  </span><br><span class="line">list = <span class="literal">false</span>  </span><br><span class="line">hosts allow = *  </span><br><span class="line"><span class="comment">#hosts deny = 0.0.0.0/32  </span></span><br><span class="line">auth users root  </span><br><span class="line"><span class="comment">#该用户系统中存在且对后面指定的备份目录拥有权限    </span></span><br><span class="line">secrets file = /usr/<span class="built_in">local</span>/rsync/rsyncd.secrets</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.此参数允许您指定在每次连接时向客户端显示的“每日消息”</span></span><br><span class="line">vi /usr/<span class="built_in">local</span>/rsync/rsyncd.motd </span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.建立安全用户</span></span><br><span class="line">vi /usr/<span class="built_in">local</span>/rsync/rsyncd.secrets</span><br><span class="line">root:snow01</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.配置文件软连接设置与权限配置</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/rsync/rsyncd.conf /etc/rsyncd.conf </span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/rsync/rsyncd.motd /etc/rsyncd.motd </span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/rsync/rsyncd.secrets  /etc/rsyncd.secrets</span><br><span class="line">chmod 600 /usr/<span class="built_in">local</span>/rsync/rsyncd.secrets </span><br><span class="line">chown root:root /usr/<span class="built_in">local</span>/rsync/rsyncd.secrets</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.启动守护进程</span></span><br><span class="line">/usr/bin/rsync --daemon --config=/etc/rsyncd.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/usr/bin/rsync --daemon --config=/etc/rsyncd.conf"</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.查看启动情况</span></span><br><span class="line">netstat -lntp | grep 873</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.客户端新建客户端密码文件(客户端不带用户名)</span></span><br><span class="line">vi /etc/rsyncd.secrets        <span class="comment"># snow01 </span></span><br><span class="line">chmod 600 /etc/rsyncd.secrets</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从服务器上拉取数据到本地</span></span><br><span class="line">rsync -vzrtopg --progress --delete --password-file=/etc/rsyncd.pwd root@192.168.5.189::<span class="built_in">test</span> /weiyigeek/</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="2-Centos-7-x-安装-inotify-tools"><a href="#2-Centos-7-x-安装-inotify-tools" class="headerlink" title="2.Centos 7.x 安装 inotify-tools"></a>2.Centos 7.x 安装 inotify-tools</h3><p>描述: 在安装前查看当前系统内核是否支持inotify功能(现在系统一般都是支持的因为现在发行版的内核&gt;=2.6.13) 但是我们还是可以使用下面的方式进行验证。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统内核是否支持inotify功能</span></span><br><span class="line">uname -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看允许监视的最大文件描述符是否存在</span></span><br><span class="line">$ ls -l /proc/sys/fs/inotify/</span><br><span class="line">-rw-r--r-- 1 root root 0 Jul 14 15:28 max_queued_events</span><br><span class="line">-rw-r--r-- 1 root root 0 Jul 14 15:28 max_user_instances</span><br><span class="line">-rw-r--r-- 1 root root 0 Jul 14 15:28 max_user_watches</span><br><span class="line">$ cat /proc/sys/fs/inotify/max_queued_events</span><br><span class="line">16384</span><br></pre></td></tr></table></figure><br>Tips : 若由此则说明系统内核支持inotify的实现软件一般有inotify-tools 和sersync 一般inotify-tools性能更优而sersync功能更强大。</p>
<p><br/></p>
<ul>
<li><p>Step 1.下载 inotify 与 编译安装inotify</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若没有安装gcc则请继续这步。</span></span><br><span class="line">yum groupinstall <span class="string">"Development Tools"</span>  </span><br><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz </span><br><span class="line">tar -xzf inotify-tools-3.14.tar.gz</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/inotify         </span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立软连接可直接命令行补齐：</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/inotify/bin/inotifywait /usr/bin/inotify</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.设置同步脚本示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 此脚本 只会当inotify监控到/tmp/目录下每当有一个文件发生改变时即通知rsync去同步，而不用扫描整个目录</span></span><br><span class="line"><span class="comment">#注意push同步时备份服务器的目录必须让rsyncuser有写权限否则出错</span></span><br><span class="line">cmd=<span class="string">"/usr/local/inotify/bin/inotifywait"</span></span><br><span class="line"><span class="variable">$cmd</span> -mrq --format <span class="string">'%w%f'</span> -e create,close_write,delete /tmp/ |\</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  [ ! -e <span class="string">"<span class="variable">$line</span>"</span> ] &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">  rsync -az --delete <span class="variable">$line</span> rsyncuser@192.168.111.243::rsynctest --password-file=/etc/rsyncd.passwd    <span class="comment">#会直接同步远程备份服务器上同改同建,就是不能同删除/</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>Tips: 此脚本每次只会更新inotify监控的新增的文件，对于监控到删除的文件，则不会在备份服务器删除，因为rysnc源没有扫描整个目录，只是 <code>rsync -az --delete $line</code>， inotifywait 命令用来监视需要备份的文件 若有变化则会通知。</p>
</li>
</ul>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714154603.png" target="_blank" title="WeiyiGeek.示例脚本" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714154603.png" alt="WeiyiGeek.示例脚本" title="" class=""></a>
                <p>WeiyiGeek.示例脚本</p>
            </figure>
<ul>
<li>Step 3.改进后此脚本完全扫描服务器端监控目录服务器的inotify目录无论增删改都完全与备份服务器同步。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">host=192.168.111.243</span><br><span class="line">src=/tmp        <span class="comment"># source,表来源</span></span><br><span class="line">dst=rsynctest   <span class="comment"># destination,表目的</span></span><br><span class="line">user=rsyncuser  </span><br><span class="line">rsync_passible=/etc/rsyncd.passwd</span><br><span class="line">inotify_home=/usr/<span class="built_in">local</span>/inotify/</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$src</span>"</span> ]\</span><br><span class="line">   || [ ! -e <span class="string">"<span class="variable">$rsync_passible</span>"</span> ]\</span><br><span class="line">   || [ ! -e <span class="string">"<span class="variable">$inotify_home</span>/bin/inotifywait"</span> ]\</span><br><span class="line">   || [ ! -e <span class="string">"/usr/bin/rsync"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"File is not enough to run inotify!"</span></span><br><span class="line">   <span class="built_in">exit</span> 9</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">  <span class="variable">$&#123;inotify_home&#125;</span>/bin/inotifywait -mrq  --format <span class="string">"%w%f"</span> -e close_write,delete,create <span class="variable">$src</span> |\</span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">              [ ! -e <span class="variable">$line</span> ] &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">              <span class="built_in">echo</span> <span class="string">'$line'</span>=<span class="variable">$line</span></span><br><span class="line">              <span class="built_in">cd</span> <span class="variable">$src</span> &amp;&amp; rsync -aruz -R --delete ./ --timeout=104 <span class="variable">$user</span>@<span class="variable">$host</span>::<span class="variable">$dst</span> --password-file=<span class="variable">$&#123;rsync_passible&#125;</span> &gt;/dev/null  2&gt;&amp;1</span><br><span class="line">         <span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714154913.png" target="_blank" title="WeiyiGeek.rsync-test" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714154913.png" alt="WeiyiGeek.rsync-test" title="" class=""></a>
                <p>WeiyiGeek.rsync-test</p>
            </figure>
<p><br></p>
<h3 id="3-Ubuntu-20-04-安装-inotify-tools"><a href="#3-Ubuntu-20-04-安装-inotify-tools" class="headerlink" title="3.Ubuntu 20.04 安装 inotify-tools"></a>3.Ubuntu 20.04 安装 inotify-tools</h3><p>描述: 上面演示了使用源代码编译安装的方式进行，下面将使用apt方式进行安装。</p>
<ul>
<li>Step 1.apt 安装 inotify-tools 查看其版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ apt install inotify-tools</span><br><span class="line"></span><br><span class="line">$ inotifywait --<span class="built_in">help</span></span><br><span class="line">inotifywait 3.14</span><br><span class="line"></span><br><span class="line">$ inotifywatch --<span class="built_in">help</span></span><br><span class="line">inotifywatch 3.14</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="0x02-命令与配置解析"><a href="#0x02-命令与配置解析" class="headerlink" title="0x02 命令与配置解析"></a>0x02 命令与配置解析</h2><h3 id="rsync-命令-文件同步解析"><a href="#rsync-命令-文件同步解析" class="headerlink" title="rsync 命令 - 文件同步解析"></a>rsync 命令 - 文件同步解析</h3><p>描述: rsync是一个功能非常强大的工具，其命令也有很多功能特色选项，我们下面就对它的选项一一进行分析说明,</p>
<p><strong>语法&amp;参数:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 语法</span></span><br><span class="line">rsync [-avrlptgoD] [-e ssh] [user@hostIP:/remote/dir] [/<span class="built_in">local</span>/path]</span><br><span class="line">rsync [OPTION] ... rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 参数</span></span><br><span class="line">-v, --verbose 详细模式输出,</span><br><span class="line">-q, --quiet 精简输出模式,(基本无用,什么都不输出)</span><br><span class="line">-c, --checksum 打开校验开关，强制对文件传输进行校验,</span><br><span class="line">-a, --archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rlptgoD,</span><br><span class="line">-r, --recursive 对子目录以递归模式处理,</span><br><span class="line">-R, --relative 使用相对路径信息,</span><br><span class="line">-b, --backup 创建备份，也就是对于目的已经存在有同样的文件名时,将老的文件重新命名为~filename,可以使用--suffix选项来指定不同的备份文件前缀,</span><br><span class="line">--backup-dir 将备份文件(如~filename)存放在在目录下,</span><br><span class="line">-suffix=SUFFIX 定义备份文件前缀,</span><br><span class="line">-u, --update 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件，不覆盖更新的文件,</span><br><span class="line">--copy-unsafe-links 仅仅拷贝指向SRC路径目录树以外的链结,</span><br><span class="line">--safe-links 忽略指向SRC路径目录树以外的链结,</span><br><span class="line">-l, --links 保留软链结,</span><br><span class="line">-L, --copy-links 想对待常规文件一样处理软链结,</span><br><span class="line">-H, --hard-links 保留硬链结,</span><br><span class="line">-p, --perms 保持文件权限,</span><br><span class="line">-o, --owner 保持文件属主信息,</span><br><span class="line">-g, --group 保持文件属组信息,</span><br><span class="line">-D, --devices 保持设备文件信息,</span><br><span class="line">-t, --<span class="built_in">times</span> 保持文件时间信息,</span><br><span class="line">-z, --compress对备份的文件在传输时进行压缩处理,</span><br><span class="line">-S, --sparse 对稀疏文件进行特殊处理以节省DST的空间,</span><br><span class="line">-n, --dry-run现实哪些文件将被传输,</span><br><span class="line">-w, --whole-file拷贝文件，不进行增量检测,</span><br><span class="line">-x, --one-file-system 不要跨越文件系统边界,</span><br><span class="line">-B, --block-size=SIZE 检验算法使用的块尺寸，默认是700字节,</span><br><span class="line">-e, --rsh=<span class="built_in">command</span>指定使用rsh、ssh方式进行数据同步,</span><br><span class="line">--rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息,</span><br><span class="line">-C, --cvs-exclude 使用和CVS一样的方法自动忽略文件，用来排除那些不希望传输的文件,(和rsyncd.conf配置文件效果相同)</span><br><span class="line">--existing 仅仅更新那些已经存在于DST的文件，而不备份那些新创建的文件,</span><br><span class="line">--delete 删除DST目标中,在SRC源中没有的文件, （受DST在前和在SRC在前的影响）</span><br><span class="line">--delete-excluded 同样删除接收端那些被该选项指定排除的文件,</span><br><span class="line">--delete-after 传输结束以后再删除,</span><br><span class="line">--ignore-errors 及时出现IO错误也进行删除,</span><br><span class="line">--max-delete=NUM 最多删除NUM个文件,</span><br><span class="line">--partial 保留那些因故没有完全传输的文件，以是加快随后的再次传输,</span><br><span class="line">-P 表示代替-partial和-progress两者的选项功能</span><br><span class="line">--force 强制删除目录，即使不为空,</span><br><span class="line">--numeric-ids 不将数字的用户和组id匹配为用户名和组名,</span><br><span class="line">--timeout=time ip超时时间，单位为秒,</span><br><span class="line">-I, --ignore-times 不跳过那些有同样的时间和长度的文件,</span><br><span class="line">--size-only 当决定是否要备份文件时，仅仅察看文件大小而不考虑文件时间,</span><br><span class="line">--modify-window=NUM 决定文件是否时间相同时使用的时间戳窗口，默认为0,</span><br><span class="line">-T --temp-dir=DIR 在DIR中创建临时文件,</span><br><span class="line">--compare-dest=DIR 同样比较DIR中的文件来决定是否需要备份,</span><br><span class="line">--progress 显示备份过程,在传输时现实传输过程,进度.</span><br><span class="line">--exclude=PATTERN 指定排除不需要传输的文件模式,</span><br><span class="line">--include=PATTERN 指定不排除而需要传输的文件模式,</span><br><span class="line">--exclude-from=FILE 排除FILE中指定模式的文件,</span><br><span class="line">--include-from=FILE 不排除FILE指定模式匹配的文件,</span><br><span class="line">--version 打印版本信息,</span><br><span class="line">--address 绑定到特定的地址,</span><br><span class="line">--config=FILE 指定其他的配置文件，不使用默认的rsyncd.conf文件,</span><br><span class="line">--port=PORT 指定其他的rsync服务端口,</span><br><span class="line">--blocking-io 对远程shell使用阻塞IO,</span><br><span class="line">--stats 给出某些文件的传输状态,</span><br><span class="line">--<span class="built_in">log</span>-format=formAT 指定日志文件格式,</span><br><span class="line">--password-file=FILE 从FILE中得到密码,</span><br><span class="line">--bwlimit=KBPS 限制I/O带宽，KBytes per second,KB每秒</span><br><span class="line">-e 使用协议通道，例如 -e ssh root@127.0.0.1:/remote/dir</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>rsync Windows 下的命令说明:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">rsync  version 3.0.8  protocol version 30</span><br><span class="line">Copyright (C) 1996-2011 by Andrew Tridgell, Wayne Davison, and others.</span><br><span class="line">Web site: http://rsync.samba.org/</span><br><span class="line">Capabilities:</span><br><span class="line">    64-bit files, 64-bit inums, 32-bit timestamps, 64-bit long ints,</span><br><span class="line">    socketpairs, hardlinks, symlinks, IPv6, batchfiles, inplace,</span><br><span class="line">    append, ACLs, no xattrs, iconv, symtimes</span><br><span class="line"></span><br><span class="line">rsync comes with ABSOLUTELY NO WARRANTY.  This is free software, and you</span><br><span class="line">are welcome to redistribute it under certain conditions.  See the GNU</span><br><span class="line">General Public Licence <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">rsync is a file transfer program capable of efficient remote update</span><br><span class="line">via a fast differencing algorithm.</span><br><span class="line"></span><br><span class="line">Usage: rsync [OPTION]... SRC [SRC]... DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST:SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST::SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br><span class="line">The <span class="string">':'</span> usages connect via remote shell, <span class="keyword">while</span> <span class="string">'::'</span> &amp; <span class="string">'rsync://'</span> usages connect</span><br><span class="line">to an rsync daemon, and require SRC or DEST to start with a module name.</span><br><span class="line"></span><br><span class="line">Options</span><br><span class="line"> -v, --verbose               increase verbosity</span><br><span class="line"> -q, --quiet                 suppress non-error messages</span><br><span class="line">     --no-motd               suppress daemon-mode MOTD (see manpage caveat)</span><br><span class="line"> -c, --checksum              skip based on checksum, not mod-time &amp; size</span><br><span class="line"> -a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)</span><br><span class="line">     --no-OPTION             turn off an implied OPTION (e.g. --no-D)</span><br><span class="line"> -r, --recursive             recurse into directories</span><br><span class="line"> -R, --relative              use relative path names</span><br><span class="line">     --no-implied-dirs       don<span class="string">'t send implied dirs with --relative</span></span><br><span class="line"><span class="string"> -b, --backup                make backups (see --suffix &amp; --backup-dir)</span></span><br><span class="line"><span class="string">     --backup-dir=DIR        make backups into hierarchy based in DIR</span></span><br><span class="line"><span class="string">     --suffix=SUFFIX         set backup suffix (default ~ w/o --backup-dir)</span></span><br><span class="line"><span class="string"> -u, --update                skip files that are newer on the receiver</span></span><br><span class="line"><span class="string">     --inplace               update destination files in-place (SEE MAN PAGE)</span></span><br><span class="line"><span class="string">     --append                append data onto shorter files</span></span><br><span class="line"><span class="string">     --append-verify         like --append, but with old data in file checksum</span></span><br><span class="line"><span class="string"> -d, --dirs                  transfer directories without recursing</span></span><br><span class="line"><span class="string"> -l, --links                 copy symlinks as symlinks</span></span><br><span class="line"><span class="string"> -L, --copy-links            transform symlink into referent file/dir</span></span><br><span class="line"><span class="string">     --copy-unsafe-links     only "unsafe" symlinks are transformed</span></span><br><span class="line"><span class="string">     --safe-links            ignore symlinks that point outside the source tree</span></span><br><span class="line"><span class="string"> -k, --copy-dirlinks         transform symlink to a dir into referent dir</span></span><br><span class="line"><span class="string"> -K, --keep-dirlinks         treat symlinked dir on receiver as dir</span></span><br><span class="line"><span class="string"> -H, --hard-links            preserve hard links</span></span><br><span class="line"><span class="string"> -p, --perms                 preserve permissions</span></span><br><span class="line"><span class="string"> -E, --executability         preserve the file'</span>s executability</span><br><span class="line">     --chmod=CHMOD           affect file and/or directory permissions</span><br><span class="line"> -A, --acls                  preserve ACLs (implies --perms)</span><br><span class="line"> -o, --owner                 preserve owner (super-user only)</span><br><span class="line"> -g, --group                 preserve group</span><br><span class="line">     --devices               preserve device files (super-user only)</span><br><span class="line">     --specials              preserve special files</span><br><span class="line"> -D                          same as --devices --specials</span><br><span class="line"> -t, --<span class="built_in">times</span>                 preserve modification <span class="built_in">times</span></span><br><span class="line"> -O, --omit-dir-times        omit directories from --<span class="built_in">times</span></span><br><span class="line">     --super                 receiver attempts super-user activities</span><br><span class="line"> -S, --sparse                handle sparse files efficiently</span><br><span class="line"> -n, --dry-run               perform a trial run with no changes made</span><br><span class="line"> -W, --whole-file            copy files whole (without delta-xfer algorithm)</span><br><span class="line"> -x, --one-file-system       don<span class="string">'t cross filesystem boundaries</span></span><br><span class="line"><span class="string"> -B, --block-size=SIZE       force a fixed checksum block-size</span></span><br><span class="line"><span class="string"> -e, --rsh=COMMAND           specify the remote shell to use</span></span><br><span class="line"><span class="string">     --rsync-path=PROGRAM    specify the rsync to run on the remote machine</span></span><br><span class="line"><span class="string">     --existing              skip creating new files on receiver</span></span><br><span class="line"><span class="string">     --ignore-existing       skip updating files that already exist on receiver</span></span><br><span class="line"><span class="string">     --remove-source-files   sender removes synchronized files (non-dirs)</span></span><br><span class="line"><span class="string">     --del                   an alias for --delete-during</span></span><br><span class="line"><span class="string">     --delete                delete extraneous files from destination dirs</span></span><br><span class="line"><span class="string">     --delete-before         receiver deletes before transfer, not during</span></span><br><span class="line"><span class="string">     --delete-during         receiver deletes during transfer (default)</span></span><br><span class="line"><span class="string">     --delete-delay          find deletions during, delete after</span></span><br><span class="line"><span class="string">     --delete-after          receiver deletes after transfer, not during</span></span><br><span class="line"><span class="string">     --delete-excluded       also delete excluded files from destination dirs</span></span><br><span class="line"><span class="string">     --ignore-errors         delete even if there are I/O errors</span></span><br><span class="line"><span class="string">     --force                 force deletion of directories even if not empty</span></span><br><span class="line"><span class="string">     --max-delete=NUM        don'</span>t delete more than NUM files</span><br><span class="line">     --max-size=SIZE         don<span class="string">'t transfer any file larger than SIZE</span></span><br><span class="line"><span class="string">     --min-size=SIZE         don'</span>t transfer any file smaller than SIZE</span><br><span class="line">     --partial               keep partially transferred files</span><br><span class="line">     --partial-dir=DIR       put a partially transferred file into DIR</span><br><span class="line">     --delay-updates         put all updated files into place at transfer<span class="string">'s end</span></span><br><span class="line"><span class="string"> -m, --prune-empty-dirs      prune empty directory chains from the file-list</span></span><br><span class="line"><span class="string">     --numeric-ids           don'</span>t map uid/gid values by user/group name</span><br><span class="line">     --timeout=SECONDS       <span class="built_in">set</span> I/O timeout <span class="keyword">in</span> seconds</span><br><span class="line">     --contimeout=SECONDS    <span class="built_in">set</span> daemon connection timeout <span class="keyword">in</span> seconds</span><br><span class="line"> -I, --ignore-times          don<span class="string">'t skip files that match in size and mod-time</span></span><br><span class="line"><span class="string">     --size-only             skip files that match in size</span></span><br><span class="line"><span class="string">     --modify-window=NUM     compare mod-times with reduced accuracy</span></span><br><span class="line"><span class="string"> -T, --temp-dir=DIR          create temporary files in directory DIR</span></span><br><span class="line"><span class="string"> -y, --fuzzy                 find similar file for basis if no dest file</span></span><br><span class="line"><span class="string">     --compare-dest=DIR      also compare destination files relative to DIR</span></span><br><span class="line"><span class="string">     --copy-dest=DIR         ... and include copies of unchanged files</span></span><br><span class="line"><span class="string">     --link-dest=DIR         hardlink to files in DIR when unchanged</span></span><br><span class="line"><span class="string"> -z, --compress              compress file data during the transfer</span></span><br><span class="line"><span class="string">     --compress-level=NUM    explicitly set compression level</span></span><br><span class="line"><span class="string">     --skip-compress=LIST    skip compressing files with a suffix in LIST</span></span><br><span class="line"><span class="string"> -C, --cvs-exclude           auto-ignore files the same way CVS does</span></span><br><span class="line"><span class="string"> -f, --filter=RULE           add a file-filtering RULE</span></span><br><span class="line"><span class="string"> -F                          same as --filter='</span>dir-merge /.rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">                             repeated: --filter='</span>- .rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">     --exclude=PATTERN       exclude files matching PATTERN</span></span><br><span class="line"><span class="string">     --exclude-from=FILE     read exclude patterns from FILE</span></span><br><span class="line"><span class="string">     --include=PATTERN       don'</span>t exclude files matching PATTERN</span><br><span class="line">     --include-from=FILE     <span class="built_in">read</span> include patterns from FILE</span><br><span class="line">     --files-from=FILE       <span class="built_in">read</span> list of <span class="built_in">source</span>-file names from FILE</span><br><span class="line"> -0, --from0                 all *-from/filter files are delimited by 0s</span><br><span class="line"> -s, --protect-args          no space-splitting; only wildcard special-chars</span><br><span class="line">     --address=ADDRESS       <span class="built_in">bind</span> address <span class="keyword">for</span> outgoing socket to daemon</span><br><span class="line">     --port=PORT             specify double-colon alternate port number</span><br><span class="line">     --sockopts=OPTIONS      specify custom TCP options</span><br><span class="line">     --blocking-io           use blocking I/O <span class="keyword">for</span> the remote shell</span><br><span class="line">     --stats                 give some file-transfer stats</span><br><span class="line"> -8, --8-bit-output          leave high-bit chars unescaped <span class="keyword">in</span> output</span><br><span class="line"> -h, --human-readable        output numbers <span class="keyword">in</span> a human-readable format</span><br><span class="line">     --progress              show progress during transfer</span><br><span class="line"> -P                          same as --partial --progress</span><br><span class="line"> -i, --itemize-changes       output a change-summary <span class="keyword">for</span> all updates</span><br><span class="line">     --out-format=FORMAT     output updates using the specified FORMAT</span><br><span class="line">     --<span class="built_in">log</span>-file=FILE         <span class="built_in">log</span> what we<span class="string">'re doing to the specified FILE</span></span><br><span class="line"><span class="string">     --log-file-format=FMT   log updates using the specified FMT</span></span><br><span class="line"><span class="string">     --password-file=FILE    read daemon-access password from FILE</span></span><br><span class="line"><span class="string">     --list-only             list the files instead of copying them</span></span><br><span class="line"><span class="string">     --bwlimit=KBPS          limit I/O bandwidth; KBytes per second</span></span><br><span class="line"><span class="string">     --stop-at=y-m-dTh:m     Stop rsync at year-month-dayThour:minute</span></span><br><span class="line"><span class="string">     --time-limit=MINS       Stop rsync after MINS minutes have elapsed</span></span><br><span class="line"><span class="string">     --write-batch=FILE      write a batched update to FILE</span></span><br><span class="line"><span class="string">     --only-write-batch=FILE like --write-batch but w/o updating destination</span></span><br><span class="line"><span class="string">     --read-batch=FILE       read a batched update from FILE</span></span><br><span class="line"><span class="string">     --protocol=NUM          force an older protocol version to be used</span></span><br><span class="line"><span class="string">     --iconv=CONVERT_SPEC    request charset conversion of filenames</span></span><br><span class="line"><span class="string">     --tr=BAD/GOOD           transliterate filenames</span></span><br><span class="line"><span class="string"> -4, --ipv4                  prefer IPv4</span></span><br><span class="line"><span class="string"> -6, --ipv6                  prefer IPv6</span></span><br><span class="line"><span class="string">     --version               print version number</span></span><br><span class="line"><span class="string">(-h) --help                  show this help (-h works with no other options)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use "rsync --daemon --help" to see the daemon-mode command-line options.</span></span><br><span class="line"><span class="string">Please see the rsync(1) and rsyncd.conf(5) man pages for full documentation.</span></span><br><span class="line"><span class="string">See http://rsync.samba.org/ for updates, bug reports, and answers</span></span><br></pre></td></tr></table></figure></p>
<p>Tips: rsync 同步或者异步同步数据。</p>
<p><br/></p>
<p><strong>用法示例:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0) 连接 Rsync 服务器以及显示更多文件信息</span></span><br><span class="line">rsync ip::</span><br><span class="line">rsync -av 115.29.246.254::</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) 默认端口连接(指定端口)和password文件来查看rsync服务中默认的项目目录。</span></span><br><span class="line"><span class="comment"># 从远程rsync服务器中拷贝文件到本地机当SRC路径信息包含"::"分隔符时启动该模式。</span></span><br><span class="line">rsync --password-file=/etc/rsyncd.passwd rs@192.168.200.251::</span><br><span class="line">rsync --password-file=/etc/rsyncd.passwd --port=8733 rs@192.168.200.251::</span><br><span class="line">rsync --password-file=/etc/rsyncd.passwd rsync://rs@192.168.200.251:873/backup/www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 本地主机中将 /etc/ 内复制到 /tmp/etc 目录中。</span></span><br><span class="line"><span class="comment"># 从本地主机中当SRC（源地址）和DES（目标地址）destination 路径信息都不包含有单个冒号":"分隔符时就启动这种工作模式。</span></span><br><span class="line">rsync -av /etc /tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) 将通过ssh将远程主机主机中的 /etc 复制到本地 /tmp。</span></span><br><span class="line"><span class="comment"># 使用一个远程shell程序rsh命令、ssh命令来实现将本地机器的内容拷贝到远程机器当DST路径地址包含单个冒号":"分隔符时启动该模式。</span></span><br><span class="line">rsync -av -e ssh user@rsh.server:/etc /tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) 从本地机器拷贝文件到远程rsync服务器中当DST路径信息包含"::"分隔符时启动该模式。</span></span><br><span class="line">rsync -av /databack root@192.168.78.192::www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5) 列远程机的文件列表类似于rsync传输不过只要在命令中省略掉本地机信息即可。</span></span><br><span class="line">rsync -v rsync://rs@192.168.200.251:8733/</span><br><span class="line">rsync -v rsync://root@192.168.78.192/www</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714192715.png" target="_blank" title="WeiyiGeek.rsync" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714192715.png" alt="WeiyiGeek.rsync" title="" class=""></a>
                <p>WeiyiGeek.rsync</p>
            </figure>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 6) 删除本地终端（Des）在（服务器）Src中没有的文件</span></span><br><span class="line">rsync -av --delete  rsync://rs@192.168.200.251:8733/backup /tmp/</span><br><span class="line">rsync -avz --delete --progress --password-file=/etc/rsyncd.passwd work@192.168.12.10::backup /tmp/</span><br><span class="line">  <span class="comment"># receiving/Sending incremental file list 接收增量文件列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7) 文件的上传与下载（注意文件夹的宿主）</span></span><br><span class="line">rsync -vzrtopg --progress ./sxx.php 172.17.16.24::www/back</span><br><span class="line">rsync -va --progress172.17.16.24::hosts_sync/dump.sh /root/   <span class="comment"># 同步数据到本地   </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8) 目录的上传和下载 （注意文件夹的宿主）</span></span><br><span class="line">rsync -r /root/mydir weiyigeek.top:remote/uploadfile     <span class="comment"># (代表将本地的目录mydir上传到服务上（注意上传文件的路径,是dir目录下的全部上传到远程目录）)</span></span><br><span class="line">rsync -r weiyigeek.top:remote/downloadfile /root/mydir   <span class="comment"># 代表将服务器上的目录下载到本地，最后的.代表当前目录</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714200925.png" target="_blank" title="WeiyiGeek.文件的上传与下载" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714200925.png" alt="WeiyiGeek.文件的上传与下载" title="" class=""></a>
                <p>WeiyiGeek.文件的上传与下载</p>
            </figure>
<p><br/></p>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714201108.png" target="_blank" title="WeiyiGeek.目录的上传和下载" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714201108.png" alt="WeiyiGeek.目录的上传和下载" title="" class=""></a>
                <p>WeiyiGeek.目录的上传和下载</p>
            </figure>
<p><br/></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 9) 可以同步客户端和服务器的对应目录，注意两个/都不能省而且一般使用-a参数替代-r, -a只能同步在客户端新创建的文件，而有时候本地还会删除一些文件需要服务器也做相应删除除了</span></span><br><span class="line">rsync -r --delete mydir/ weiyigeek.top:mydir/ </span><br><span class="line">rsync -r --delete weiyigeek.top:mydir/ mydir/</span><br><span class="line"></span><br><span class="line">rsync -r --progress /tmp/www/units/ --password-file=/etc/rsyncd.passwd rs@192.168.200.251::backup/units/</span><br><span class="line">rsync -r --password-file=/etc/rsyncd.passwd rs@192.168.200.251::backup/units/ /tmp/www/units/</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714202338.png" target="_blank" title="WeiyiGeek.实时同步" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714202338.png" alt="WeiyiGeek.实时同步" title="" class=""></a>
                <p>WeiyiGeek.实时同步</p>
            </figure>
<p><br/></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10) 在客户端使用rsync命令来备份服务端上的数据，比如通过SSH方式是通过系统用户来进行备份的。</span></span><br><span class="line">rsync -vzrtopg --progress --delete -e ssh work@172.16.78.1:/www/* /tmp/www/units/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11) 远程同步到本地( 远程同步 ), 但这样也是有风险的 一般在上面命令后再加一个 `--dry-run` 会开启验证</span></span><br><span class="line">rsync -avzH baker@serverip:wwwroot /var/www/html</span><br><span class="line">rsync -avzH --delete baker@serverip:wwwroot /var/www/html</span><br><span class="line">rsync --dry-run -av --delete mydir/ weiyigeek.top:mydir/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 12) 可以将本地完全同步到远程服务器中, 当服务器的数据出现问题，那么这时需要客户端的数据对服务端进行恢复，但前提是服务端允许客户端有写入权限，否则也不能在客户端直接对服务端进行恢复，使用rsync对数据进行恢复的方式如下:</span></span><br><span class="line">rsync -avz --progress /tmp/www/units/ work@172.16.78.1:www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 13) 完全同步同增同改</span></span><br><span class="line">rsync -auz -R --delete ./ rs@192.168.200.251::backup/www/units/  </span><br><span class="line">rsync -avz --progress /tmp/www/units/ rs@192.168.200.251::backup/www/units/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 14) 将SRC远程中在DES本地中没有的文件将被删除</span></span><br><span class="line">rsync -avz --progress --delete /tmp/www/units/ rs@192.168.200.251::backup/www/units/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 15) 利用find的一种巧妙方式可以用这种方法列出需要备份的文件列表,这种方法似乎比较少人用到。</span></span><br><span class="line">rsync -avR remote:<span class="string">'`find /home -name "*.[ch]"`'</span> /tmp/</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714203525.png" target="_blank" title="WeiyiGeek.rsync命令" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714203525.png" alt="WeiyiGeek.rsync命令" title="" class=""></a>
                <p>WeiyiGeek.rsync命令</p>
            </figure>
<p><br></p>
<h3 id="inotifywait-命令-等待监听事件的发生"><a href="#inotifywait-命令-等待监听事件的发生" class="headerlink" title="inotifywait 命令 - 等待监听事件的发生"></a>inotifywait 命令 - 等待监听事件的发生</h3><p>描述: inotifywait尤其适用于在脚本中等待某事件的发生, 并可基于特定的事件执行相应操作, 如将其用于脚本中监控某指定目录中的文件上的修改、新建、删除、属性信息的改变，而后使用rsync命令将某事件对应的文件同步至其它主机上。</p>
<p><strong>语法参数:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">Usage: inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Options - 参数说明</span></span><br><span class="line">@&lt;file&gt;   从监视中排除指定的文件。</span><br><span class="line">--exclude &lt;pattern&gt;  排除与扩展正则表达式&lt;pattern&gt;匹配的文件上的所有事件。</span><br><span class="line">--excludei &lt;pattern&gt; 不区分大小写</span><br><span class="line">-m, --monitor inotifywait的默认动作是在监控至指定文件的特定事件发生一次后就退出了，而使用此选项则可实现持续性的监控</span><br><span class="line">-d,--daemon  与--monitor相同，只是在后台运行，将事件记录到--outfile.Implies--syslog指定的文件中。</span><br><span class="line">-r, --recursive 递归监控指定目录下的所有文件，包括新建的文件或子目录；如果要监控的目录中文件数量巨大，则通常需要修改`/proc/sys/fs/inotify/max_users_watchs`内核参数因为其默认值为8192；</span><br><span class="line">--fromfile &lt;file&gt;    从&lt;file&gt;或-<span class="keyword">for</span> stdin读取要监视的文件。</span><br><span class="line">-o|--outfile &lt;file&gt;  将事件打印到&lt;file&gt;而不是标准输出。</span><br><span class="line">-s|--syslog          将错误发送到syslog而不是stderr。</span><br><span class="line">-q, --quit  即静默模式</span><br><span class="line">-qq         Print nothing (not even events).</span><br><span class="line">-c|--csv   Print events <span class="keyword">in</span> CSV format.</span><br><span class="line">-e, --event ：指定要监控的特定事件，默认是监控所有的事件；此处包括 access(访问), modify(修改), attrib(属性), close_write, close_nowirte, close(关闭), open(打开), moved_to, moved_from, move(移动), create(创建), delete(删除), delete_selt等（前面已有详细说明）</span><br><span class="line">  * access          file or directory contents were <span class="built_in">read</span></span><br><span class="line">  * modify          file or directory contents were written</span><br><span class="line">  * attrib          file or directory attributes changed</span><br><span class="line">  * close_write     file or directory closed, after being opened <span class="keyword">in</span> writable mode</span><br><span class="line">  * close_nowrite   file or directory closed, after being opened <span class="keyword">in</span> <span class="built_in">read</span>-only mode</span><br><span class="line">  * close           file or directory closed, regardless of <span class="built_in">read</span>/write mode</span><br><span class="line">  * open            file or directory opened</span><br><span class="line">  * moved_to        file or directory moved to watched directory</span><br><span class="line">  * moved_from      file or directory moved from watched directory</span><br><span class="line">  * move            file or directory moved to or from watched directory</span><br><span class="line">  * create          file or directory created within watched directory</span><br><span class="line">  * delete          file or directory deleted within watched directory</span><br><span class="line">  * delete_self     file or directory was deleted</span><br><span class="line">--timefmt ：当在--format选项中使用%T时，--timefrt选项则可以用来指定自定义的符合strftime规范的时间格式，此时间格式可用的格式符可以通过strftime的手册页获取；常用的参数是 <span class="string">'%d/%m/%y %H:%M'</span>（25/06/17/13:11）；</span><br><span class="line">--format ：自定义inotifywait的输出格式，如--format <span class="string">'%T %w %f'</span>；常用的格式符如下：</span><br><span class="line">  * %T：使用--timefmt选项中自定义的时间格式；</span><br><span class="line">  * %w：显示被监控文件的文件名；</span><br><span class="line">  * %f：如果发生某事件的对象是目录，则显示被监控目录的名字；默认显示为空串；</span><br><span class="line">-t|--timeout &lt;seconds&gt; 收听单个事件时，请在等待事件&lt;seconds&gt;秒。如果&lt;seconds&gt;为0，inotifywait将永远不会超时。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出状态</span></span><br><span class="line">0  -  您要求观看的事件已收到。</span><br><span class="line">1  -  收到了一个您没有要求监视的事件（通常是删除或卸载），或者发生了一些错误。</span><br><span class="line">2  -  提供了--timeout选项，并且在指定的时间间隔内未发生任何事件。</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>基础示例:</strong></p>
<ul>
<li><p>1.以特定的格式输出其<code>modify,delete,create,attrib</code>属性改变的文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">/usr/<span class="built_in">local</span>/inotify/bin/inotifywait -mrq --timefmt <span class="string">'%d/%m/%y/%H:%M'</span> --format <span class="string">'%T %w %f'</span> -e modify,delete,create,attrib <span class="variable">$1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2.监控/tmp/test目录及其内部所有文件上发生的create,delete,modify,close_write事件，则使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此命令在监控到某文件上第一次事件后就会退出</span></span><br><span class="line">inotifywait -r --timefmt <span class="string">'%d/%m/%y %H:%M'</span> --format <span class="string">'%T %w %f'</span> -e create,delete,modify,close_write /tmp/<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此命令会一直监控不会第一次事件后退出</span></span><br><span class="line">inotifywait -mr --timefmt <span class="string">'%d/%m/%y %H:%M'</span> --format <span class="string">'%T %w %f'</span> -e create,delete,modify,close_write /tmp/<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于修改，创建，与属性的更改则显示了三次目录</span></span><br><span class="line">inotifywait -mrq --format <span class="string">'%w%f'</span> -e modify,attrib,create,close_write,delete /tmp/</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=采用Rsync与Inotify实时同步文件目录 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714173620.png" target="_blank" title="WeiyiGeek.inotifywait" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210714173620.png" alt="WeiyiGeek.inotifywait" title="" class=""></a>
                <p>WeiyiGeek.inotifywait</p>
            </figure>
<hr>
<h2 id="0x04-安全配置"><a href="#0x04-安全配置" class="headerlink" title="0x04 安全配置"></a>0x04 安全配置</h2><p>描述: 安全配置其防御，一是限定访问的IP，另一个是不允许匿名访问添加用户口令。</p>
<p><strong>(1) 限定IP地址访问两种方式:</strong></p>
<ul>
<li>1.IPTables防火墙，给rsync的端口添加一个iptables, 例如只希望能够从内部网络（192.168.101.0/24）访问：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eth0 -p tcp -s 192.168.101.0/24 --dport 873 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 873 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></li>
<li>2.除此之外也可以在<code>/etc/rsyncd.conf</code>中的<code>hosts allow</code>也可以设置只允许来源ip。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts allow = X.X.X.X <span class="comment"># 允许访问的IP</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>(2) 添加用户认证</strong><br>描述: 添加rsync用户权限访问注意配置是在rsyncd.conf中的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">secrets file = /etc/rsyncd.secrets <span class="comment">#密码文件位置，认证文件设置，设置用户名和密码</span></span><br><span class="line">auth users = rsync                 <span class="comment">#授权帐号,认证的用户名，如果没有这行则表明是匿名，多个用户用,分隔。</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="示例1-CentOS-6-X-之-Rsync-远程安全访问同步设置"><a href="#示例1-CentOS-6-X-之-Rsync-远程安全访问同步设置" class="headerlink" title="示例1.CentOS 6.X 之 Rsync 远程安全访问同步设置"></a>示例1.CentOS 6.X 之 Rsync 远程安全访问同步设置</h3><ul>
<li>服务端<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试文件:</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"www.weiyigeek.top"</span> &gt; /var/www/html/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># Rsyncd配置文件:</span></span><br><span class="line">vim /etc/rsyncd.conf</span><br><span class="line">uid = nobody</span><br><span class="line">gid = nobody</span><br><span class="line">use chroot = yes</span><br><span class="line">address = 192.168.100.1</span><br><span class="line">port 873</span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">hosts allow = 192.168.100.0/24</span><br><span class="line"></span><br><span class="line">[wwwroot]</span><br><span class="line">path = /var/www/html</span><br><span class="line">comment = Document Root of www.gateway.com</span><br><span class="line"><span class="built_in">read</span> only = yes</span><br><span class="line">dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z</span><br><span class="line">auth users = baker</span><br><span class="line">secrets file = /etc/rsyncd_users.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置rsync登录账户和密码:</span></span><br><span class="line">vim /etc/rsyncd_users.db   <span class="comment"># baker:123</span></span><br><span class="line">chmod 600 rsyncd_users.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新服务：</span></span><br><span class="line">service xinetd restart</span><br></pre></td></tr></table></figure></li>
<li>客户端<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># baker 用户的 rsync 密码</span></span><br><span class="line">vim /etc/rsyncpasswd        <span class="comment"># 123</span></span><br><span class="line">chmod 600 /etc/rsyncpasswd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从远程wwwroot同步数据到本地 /var/www/html</span></span><br><span class="line">rsync -avzH --password-file=/etc/rsyncpasswd baker@serverip::wwwroot /var/www/html</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="0x05-Windows服务器根据目录变化执行同步到NFS网络存储"><a href="#0x05-Windows服务器根据目录变化执行同步到NFS网络存储" class="headerlink" title="0x05 Windows服务器根据目录变化执行同步到NFS网络存储"></a>0x05 Windows服务器根据目录变化执行同步到NFS网络存储</h2><p><strong>环境依赖：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows Server 2019</span><br><span class="line">cwRsync : rsync version 3.0.8</span><br><span class="line">python-3.8.10-amd64.exe</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>Python 依赖及其脚本:</strong></p>
<ul>
<li><p>requirements.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pypiwin32&#x3D;&#x3D;223</span><br><span class="line">pywin32&#x3D;&#x3D;302</span><br></pre></td></tr></table></figure>
</li>
<li><p>WatchSync.py</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import sys</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line">import win32con</span><br><span class="line">import win32file</span><br><span class="line">import win32event</span><br><span class="line">import win32process</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录文件变化类型</span></span><br><span class="line">ACTIONS = &#123;</span><br><span class="line">  1: <span class="string">"Created"</span>,</span><br><span class="line">  2: <span class="string">"Deleted"</span>,</span><br><span class="line">  3: <span class="string">"Updated"</span>,</span><br><span class="line">  4: <span class="string">"Renamed"</span>,</span><br><span class="line">  5: <span class="string">"Renamed Extension"</span></span><br><span class="line">&#125;</span><br><span class="line">FILE_LIST_DIRECTORY = 0x0001</span><br><span class="line"></span><br><span class="line"><span class="comment"># def handle_SIGINT(signum, frame):</span></span><br><span class="line"><span class="comment">#   try:</span></span><br><span class="line"><span class="comment">#     global sign</span></span><br><span class="line"><span class="comment">#     sign=False</span></span><br><span class="line"><span class="comment">#   except Exception as e:</span></span><br><span class="line"><span class="comment">#     print(e)</span></span><br><span class="line"><span class="comment">#   finally:</span></span><br><span class="line"><span class="comment">#     sys.exit(-1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 终端输入需要监控的文件夹目录</span></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == 2:</span><br><span class="line">  global path_to_watch </span><br><span class="line">  path_to_watch = str(sys.argv[1])</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">'Watching changes in'</span>, path_to_watch, <span class="string">"Directory Path!"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"[ERROR] Please Input Your Want Watch Dir\nUsage: &#123;&#125; D:\WeiyiGeek"</span>.format(sys.argv[0],sys.argv[0]))</span><br><span class="line">  sys.exit()</span><br><span class="line"></span><br><span class="line">def Win32watch():</span><br><span class="line">  <span class="comment"># 创建指定目录的handle句柄。</span></span><br><span class="line">  <span class="built_in">print</span>(path_to_watch)</span><br><span class="line">  hDir = win32file.CreateFile(</span><br><span class="line">    path_to_watch,</span><br><span class="line">    FILE_LIST_DIRECTORY,</span><br><span class="line">    win32con.FILE_SHARE_READ | win32con.FILE_SHARE_WRITE,</span><br><span class="line">    None,</span><br><span class="line">    win32con.OPEN_EXISTING,</span><br><span class="line">    win32con.FILE_FLAG_BACKUP_SEMANTICS,</span><br><span class="line">    None</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 注册SIGINT信号的处理器为handle_SIGINT函数</span></span><br><span class="line">  <span class="comment"># signal.signal(signal.SIGINT, handle_SIGINT) </span></span><br><span class="line">  <span class="keyword">while</span> True:</span><br><span class="line">    results = win32file.ReadDirectoryChangesW(</span><br><span class="line">      hDir,</span><br><span class="line">      1024,</span><br><span class="line">      True,</span><br><span class="line">      win32con.FILE_NOTIFY_CHANGE_FILE_NAME |</span><br><span class="line">      win32con.FILE_NOTIFY_CHANGE_DIR_NAME |</span><br><span class="line">      win32con.FILE_NOTIFY_CHANGE_ATTRIBUTES |</span><br><span class="line">      win32con.FILE_NOTIFY_CHANGE_SIZE |</span><br><span class="line">      win32con.FILE_NOTIFY_CHANGE_LAST_WRITE |</span><br><span class="line">      win32con.FILE_NOTIFY_CHANGE_SECURITY,</span><br><span class="line">      None,</span><br><span class="line">      None)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> action, filename <span class="keyword">in</span> results:</span><br><span class="line">      full_filename = os.path.join(path_to_watch, filename)</span><br><span class="line">      <span class="keyword">if</span> action == 1:</span><br><span class="line">        handle = win32process.CreateProcess(r<span class="string">'F:\soft\Sync\syncToremote.bat'</span>, <span class="string">''</span>, None, None, 0, win32process.CREATE_NO_WINDOW, None,None, win32process.STARTUPINFO())                  <span class="comment"># 创建进程获得句柄</span></span><br><span class="line">        waitid = win32event.WaitForSingleObject(handle[0], -1)  <span class="comment"># 等待进程结束</span></span><br><span class="line">        <span class="built_in">print</span>(full_filename, ACTIONS.get(action, <span class="string">"Unknown"</span>),datetime.now())</span><br><span class="line"></span><br><span class="line">Win32watch()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<p><strong>同步Bat批处理</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># F:\soft\Sync\syncToremote.bat</span></span><br><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">f:\soft\cwRsync\bin\rsync.exe --no-super -a /cygdrive/F/weiyigeek/WebRoot/res/zk/files/ /cygdrive/d/files/</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>执行及运行结果</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Usage: F:\soft\Sync\Watch.py D:\WeiyiGeek</span><br><span class="line">  <span class="comment"># Watching changes in F:\weiyigeek\WebRoot\res\zk\files Directory Path!</span></span><br><span class="line">  <span class="comment"># (&lt;PyHANDLE:720&gt;, &lt;PyHANDLE:728&gt;, 4760, 9776)</span></span><br><span class="line">  <span class="comment"># F:\weiyigeek\WebRoot\res\zk\files\1.txt Created 2021-11-10 15:47:50.441742</span></span><br><span class="line">  <span class="comment"># (&lt;PyHANDLE:436&gt;, &lt;PyHANDLE:768&gt;, 11400, 7580)</span></span><br><span class="line">  <span class="comment"># F:\weiyigeek\WebRoot\res\zk\files\2.txt Created 2021-11-10 15:47:52.472965</span></span><br><span class="line">  <span class="comment"># (&lt;PyHANDLE:412&gt;, &lt;PyHANDLE:772&gt;, 7976, 18096)</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x06-FAQ-你问我答"><a href="#0x06-FAQ-你问我答" class="headerlink" title="0x06 FAQ 你问我答"></a>0x06 FAQ 你问我答</h2><p><strong>Q：如何通过ssh进行rsync，而且无须输入密码？</strong><br>A：可以通过以下几个步骤</p>
<ol>
<li>通过ssh-keygen在server A上建立SSH keys，不要指定密码，你会在~/.ssh下看到identity和identity.pub文件</li>
<li>在server B上的home目录建立子目录.ssh</li>
<li>将A的identity.pub拷贝到server B上</li>
<li>将identity.pub加到~[user b]/.ssh/authorized_keys</li>
<li>于是server A上的A用户，可通过下面命令以用户B ssh到server B上了<br>e.g. ssh -l userB serverB<br>这样就使 server A上的用户A就可以ssh以用户B的身份无需密码登陆到server B上了</li>
</ol>
<p><br></p>
<p><strong>Q:如何通过在不危害安全的情况下,通过防火墙使用rsync?</strong></p>
<blockquote>
<p>A：解答如下：通常有两种情况一种是服务器在防火墙内，一种是服务器在防火墙外。无论哪种情况，通常还是使用ssh，这时最好新建一个备份用户，并且配置sshd仅允许这个用户通过RSA认证方式进入。<br>如果服务器在防火墙内，则最好限定客户端的IP地址，拒绝其它所有连接。如果客户机在防火墙内，则可以简单允许防火墙打开TCP端口22的ssh外发连接就ok了。</p>
</blockquote>
<p><br/></p>
<p><strong>Q:我能将更改过或者删除的文件也备份上来吗</strong><br>A：当然可以：你可以使用如：<code>rsync -other -options -backupdir = ./backup-2000-2-13</code> 这样的命令来实现。</p>
<p>这样如果源文件:/path/to/some/file.c改变了，那么旧的文件就会被移到./backup-2000-2-13/path/to/some/file.c，</p>
<p>这里这个目录需要自己手工建立起来</p>
<p><br/></p>
<p><strong>Q：我需要在防火墙上开放哪些端口以适应rsync</strong><br>A：视情况而定rsync可以直接通过873端口的tcp连接传文件，也可以通过22端口的ssh来进行文件传递，但你也可以通过下列命令改变它的端口：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync –port 8730 otherhost::</span><br><span class="line">或者</span><br><span class="line">rsync -e <span class="string">'ssh -p 2002'</span> otherhost:</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>Q：我如何通过rsync只复制目录结构，忽略掉文件呢？</strong><br>A：rsync -av –include ‘<em>/’ –exclude ‘</em>’ source-dir dest-dir</p>
<p><br/></p>
<p><strong>Q：为什么我总会出现”Read-only file system”的错误呢？</strong><br>A：看看是否忘了设”read only = no”了</p>
<p><br/></p>
<p><strong>Q：为什么我会出现’@ERROR: invalid gid’的错误呢？</strong><br>A：rsync使用时默认是用uid=nobody;gid=nobody来运行的，如果你的系统不存在nobody组的话，就会出现这样的错误，可以试试gid =nogroup或者其它</p>
<p><br/></p>
<p><strong>Q：绑定端口873失败是怎么回事？</strong><br>A：如果你不是以root权限运行这一守护进程的话，因为1024端口以下是特权端口，会出现这样的错误。你可以用–port参数来改变。</p>
<p><br/></p>
<p><strong>Q：为什么我认证失败？</strong><br>A：从你的命令行看来：<br>你用的是：</p>
<blockquote>
<p>bash$ rsync -a 144.16.251.213::test test<br>Password:<br>@ERROR: auth failed on module test<br>I dont understand this. Can somebody explain as to how to acomplish this.<br>All suggestions are welcome.<br>应该是没有以你的用户名登陆导致的问题，试试rsync -a <a href="mailto:max@144.16.251.213">max@144.16.251.213</a>::test test</p>
</blockquote>
<p><br/></p>
<p><strong>Q:当rsync遇到ssh不是标准端口时</strong><br>If ssh port is not 22, how does rsync specify this in command line?<br>A:rsync要借助ssh来运行，那么当ssh的端口不是默认的22怎么办？<br>把选项中的-e ssh 换成 -e ssh -p 12345<br>这里12345是ssh的端口号</p>
<p><br/></p>
<hr>
<h2 id="0x0n-入坑出坑"><a href="#0x0n-入坑出坑" class="headerlink" title="0x0n 入坑出坑"></a>0x0n 入坑出坑</h2><p>描述: 我们可以通过各种工具对rsync运行时错误日志查看与解决,主要在<code>/var/log/rsyncd.log</code>里面或<code>.err</code>文件里面。</p>
<h3 id="问题1-报-ERROR-chroot-failed错误"><a href="#问题1-报-ERROR-chroot-failed错误" class="headerlink" title="问题1.报@ERROR: chroot failed错误"></a>问题1.报<code>@ERROR: chroot failed</code>错误</h3><ul>
<li>错误信息: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -auzv --progress --password-file=/etc/rsync.pas root@192.168.133.128::backup /home/ </span><br><span class="line">@ERROR: chroot failed </span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1522) [receiver=3.0.3]</span><br></pre></td></tr></table></figure></li>
<li>错误原因: 服务器端的目录不存在或无权限</li>
<li>解决办法: 创建目录并修正权限可解决问题。</li>
<li>注意情况: windows下面我们需要给SvcwRsync用户，管理同步目录的所有权限基本上这样就可以了。</li>
</ul>
<p><br></p>
<h3 id="问题2-报-ERROR-auth-failed-on-module-tee错误"><a href="#问题2-报-ERROR-auth-failed-on-module-tee错误" class="headerlink" title="问题2.报@ERROR: auth failed on module tee错误"></a>问题2.报<code>@ERROR: auth failed on module tee</code>错误</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ERROR: auth failed on module tee </span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1522) [receiver=3.0.3]</span><br></pre></td></tr></table></figure></li>
<li>错误原因: 服务器端该模块（tee）需要验证用户名密码，但客户端没有提供正确的用户名密码，认证失败。</li>
<li>解决办法: 提供正确的用户名密码解决此问题。</li>
</ul>
<p><br></p>
<h3 id="问题3-报-ERROR-Unknown-module-39-tee-nonexists-39-错误。"><a href="#问题3-报-ERROR-Unknown-module-39-tee-nonexists-39-错误。" class="headerlink" title="问题3.报@ERROR: Unknown module &#39;tee_nonexists&#39;错误。"></a>问题3.报<code>@ERROR: Unknown module &#39;tee_nonexists&#39;</code>错误。</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ERROR: Unknown module <span class="string">'tee_nonexists'</span> </span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1522) [receiver=3.0.3]</span><br></pre></td></tr></table></figure></li>
<li>错误原因：服务器不存在指定模块</li>
<li>解决办法: 提供正确的模块名或在服务器端修改成你要的模块以解决问题。 </li>
</ul>
<p><br></p>
<h3 id="问题4-在client上遇到问题报could-not-open-password-file-quot-etc-rsync-pas-quot-No-such-file-or-directory-2-错误"><a href="#问题4-在client上遇到问题报could-not-open-password-file-quot-etc-rsync-pas-quot-No-such-file-or-directory-2-错误" class="headerlink" title="问题4.在client上遇到问题报could not open password file &quot;/etc/rsync.pas&quot;: No such file or directory (2)错误"></a>问题4.在client上遇到问题报<code>could not open password file &quot;/etc/rsync.pas&quot;: No such file or directory (2)</code>错误</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -auzv --progress --password-file=/etc/rsync.pas root@192.168.133.128::backup /home/ </span><br><span class="line">rsync: could not open password file <span class="string">"/etc/rsync.pas"</span>: No such file or directory (2) </span><br><span class="line">Password: </span><br><span class="line">@ERROR: auth failed on module backup </span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1506) [Receiver=3.0.7]</span><br></pre></td></tr></table></figure></li>
<li>错误原因: client 端 没有设置 <code>/etc/rsync.pass</code> 这个文件, 其次是该文件中用户:密码错误不对应。</li>
<li>解决方式: 因为在使用 rsync 命令的时候加了 <code>--password-file=/etc/rsync.pass</code> 参数。</li>
</ul>
<p><br></p>
<h3 id="问题5-在client上遇到问题报rsync-write-failed-on-quot-home-backup2010-quot-No-space-left-on-device-28-错误"><a href="#问题5-在client上遇到问题报rsync-write-failed-on-quot-home-backup2010-quot-No-space-left-on-device-28-错误" class="headerlink" title="问题5.在client上遇到问题报rsync: write failed on &quot;/home/backup2010/&quot;: No space left on device (28)错误"></a>问题5.在client上遇到问题报<code>rsync: write failed on &quot;/home/backup2010/&quot;: No space left on device (28)</code>错误</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rsync: write failed on <span class="string">"/home/backup2010/"</span>: No space left on device (28) </span><br><span class="line">rsync: recv_generator: mkdir <span class="string">"/home/backup2010/"</span> failed: No space left on device (28) </span><br><span class="line">*** Skipping any contents from this failed directory *** </span><br><span class="line">rsync error: error <span class="keyword">in</span> file IO (code 11) at receiver.c(302) [receiver=3.0.7] </span><br><span class="line">rsync: connection unexpectedly closed (2721 bytes received so far) [generator] </span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code 12) at io.c(601) [generator=3.0.7]</span><br></pre></td></tr></table></figure></li>
<li>错误原因: 磁盘空间不够所以无法操作,可以通过<code>df /home/backup2010</code>来查看可用空间和已用空间。</li>
<li>解决办法: 清理文件腾出空间或者添加磁盘空间。</li>
</ul>
<p><br></p>
<h3 id="问题6-报skipping-non-regular-file错误。"><a href="#问题6-报skipping-non-regular-file错误。" class="headerlink" title="问题6.报skipping non-regular file错误。"></a>问题6.报<code>skipping non-regular file</code>错误。</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eceiving incremental file list</span><br><span class="line">skipping non-regular file “vendor/bin/doctrine”</span><br><span class="line">skipping non-regular file “vendor/bin/doctrine.php”\</span><br><span class="line">sent 1990 bytes received 489209 bytes 327466.00 bytes/sec total size is 182515746 speedup is 371.57</span><br></pre></td></tr></table></figure></li>
<li>错误原因: source源文件有软链接。</li>
<li>解决方法: 修改为 <code>rsync -va</code> 其中 <code>-a == -rlptgoD (no -H,-A,-X)</code> 或者 <code>rsync -rvltOD</code> 也可以。</li>
</ul>
<p><br></p>
<h3 id="问题7-报-ERROR-module-is-read-only错误。"><a href="#问题7-报-ERROR-module-is-read-only错误。" class="headerlink" title="问题7.报@ERROR: module is read only错误。"></a>问题7.报<code>@ERROR: module is read only</code>错误。</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sending incremental file list</span><br><span class="line">ERROR: module is <span class="built_in">read</span> only</span><br><span class="line">rsync error: syntax or usage error (code 1) at main.c(866) [receiver=3.0.6]</span><br><span class="line">rsync: <span class="built_in">read</span> error: Connection reset by peer (104)</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code 12) at io.c(759) [sender=3.0.6]</span><br></pre></td></tr></table></figure></li>
<li>错误原因: Source源服务器端权限设置read为only只读权限。</li>
<li>解决方法: <code>read only = false</code></li>
</ul>
<p><br></p>
<h3 id="问题8-报password-file-must-not-be-other-accessible错误。"><a href="#问题8-报password-file-must-not-be-other-accessible错误。" class="headerlink" title="问题8.报password file must not be other-accessible错误。"></a>问题8.报<code>password file must not be other-accessible</code>错误。</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">password file must not be other-accessible</span><br><span class="line">continuing without password file</span><br></pre></td></tr></table></figure></li>
<li>错误原因: 因为 rsyncd.pwd rsyncd.secrets 的权限不对。</li>
<li>解决办法: 设置上述文件权限为600。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 rsyncd.pwd</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="问题9-报rsync-failed-to-connect-No-route-to-host错误。"><a href="#问题9-报rsync-failed-to-connect-No-route-to-host错误。" class="headerlink" title="问题9.报rsync: failed to connect No route to host错误。"></a>问题9.报<code>rsync: failed to connect No route to host</code>错误。</h3><ul>
<li>错误信息: rsync: failed to connect to 192.168.1.10: No route to host (113) rsync error: error in socket IO (code 10) at clientserver.c(104) [receiver=3.0.6]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rsync: failed to connect to 10.10.10.170: Connection refused (111) </span><br><span class="line">rsync: failed to connect to 96.44.169.178 (*inet_ntop failed*): Connection timed</span><br><span class="line">out (116)</span><br><span class="line">1 [main] rsync 3468 exception::handle: Exception: STATUS_ACCESS_VIOLATION</span><br><span class="line">740 [main] rsync 3468 open_stackdumpfile: Dumping stack trace to rsync.exe.s</span><br></pre></td></tr></table></figure></li>
<li>错误原因：对方没开机、防火墙阻挡、通过的网络上有防火墙阻挡都有可能。</li>
<li>解决方法: 在 iptables 中开放该端口，rsync 默认端口 873，其实就是把tcp udp的873端口打开。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables</span></span><br><span class="line">vi /etc/sysconfig/iptables</span><br><span class="line">iptables -A INPUT -m state –state NEW -m tcp -p tcp –dport 873-j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># firewall-cmd </span></span><br><span class="line">firewall-cmd --zone=public --add-port=873/tcp --permanent </span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="问题10-报rsync-error-error-starting-client-server-protocol错误。"><a href="#问题10-报rsync-error-error-starting-client-server-protocol错误。" class="headerlink" title="问题10.报rsync error: error starting client-server protocol错误。"></a>问题10.报<code>rsync error: error starting client-server protocol</code>错误。</h3><ul>
<li>错误信息: <code>rsync error: error starting client-server protocol (code 5) at main.c(1524) [Receiver=3.0.6]</code></li>
<li>错误原因: /etc/rsyncd.conf 配置文件内容有错误</li>
<li>解决办法: 请正确核对配置文件。</li>
</ul>
<p><br></p>
<h3 id="问题11-报rsync-chown-quot-quot-failed-Invalid-argument-22-错误。"><a href="#问题11-报rsync-chown-quot-quot-failed-Invalid-argument-22-错误。" class="headerlink" title="问题11.报rsync: chown &quot;&quot; failed: Invalid argument (22)错误。"></a>问题11.报<code>rsync: chown &quot;&quot; failed: Invalid argument (22)</code>错误。</h3><ul>
<li>错误信息: <code>sync: chown &quot;&quot; failed: Invalid argument (22)</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync: opendir <span class="string">"/kexue"</span> (<span class="keyword">in</span> dtsChannel) failed: Permission denied (13)  <span class="comment"># 注意查看同步的目录权限是否为755</span></span><br></pre></td></tr></table></figure></li>
<li>错误原因: 权限无法复制去掉同步权限的参数即可。(这种情况多见于Linux向Windows的时候)</li>
</ul>
<p><br></p>
<h3 id="问题12-报-ERROR-daemon-security-issue-—-contact-admin错误。"><a href="#问题12-报-ERROR-daemon-security-issue-—-contact-admin错误。" class="headerlink" title="问题12.报@ERROR: daemon security issue — contact admin错误。"></a>问题12.报<code>@ERROR: daemon security issue — contact admin</code>错误。</h3><ul>
<li>错误信息: <code>@ERROR: daemon security issue — contact admin rsync error: error starting client-server protocol (code 5) at main.c(1530) [sender=3.0.6]</code></li>
<li>错误原因: 同步的目录里面有权限不足的软连接文件</li>
<li>解决办法: 在服务器端的 /etc/rsyncd.conf 中修改入键值 <code>use chroot = yes</code>。</li>
</ul>
<p><br></p>
<h3 id="问题13-报rsync-read-error-Connection-reset-by-peer-104"><a href="#问题13-报rsync-read-error-Connection-reset-by-peer-104" class="headerlink" title="问题13.报rsync: read error: Connection reset by peer (104)"></a>问题13.报<code>rsync: read error: Connection reset by peer (104)</code></h3><ul>
<li>错误信息: <code>rsync: read error: Connection reset by peer (104) rsync error: error in rsync protocol data stream (code 12) at io.c(794) [receiver=3.0.6]</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">receiving incremental file list</span><br><span class="line">rsync: <span class="built_in">read</span> error: Connection reset by peer (104)</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code 12) at io.c(769) [receiver=3.0.8]</span><br><span class="line">rsync: connection unexpectedly closed (60 bytes received so far) [generator]</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code 12) at io.c(610) [generator=3.0.8]</span><br></pre></td></tr></table></figure></li>
<li>问题原因:<ul>
<li>磁盘挂载是用异步的(async)然后检查了/etc/fstab ，去掉async参数</li>
<li>我在服务器上查看日志看到有这么一行：rsync: unable to open configuration file “/etc/rsyncd.conf”: No such file or directory于是我：ln -s /etc/rsyncd/rsyncd.conf /etc/rsyncd.conf</li>
</ul>
</li>
<li>解决办法: 很大可能是服务器端没有开启 rsync 服务，开启服务 <code>rsync --daemon --config=/etc/rsyncd.conf</code> 对于centos 6.x及以下。</li>
</ul>
<p><br></p>
<h3 id="问题14-报-ERROR-failed-to-open-lock-file错误。"><a href="#问题14-报-ERROR-failed-to-open-lock-file错误。" class="headerlink" title="问题14.报@ERROR: failed to open lock file错误。"></a>问题14.报<code>@ERROR: failed to open lock file</code>错误。</h3><ul>
<li>错误信息: <code>@ERROR: failed to open lock file rsync error: error starting client-server protocol (code 5) at main.c(1495) [receiver=3.0.6]</code></li>
<li>解决版本：在配置文件 rsync.conf 中添加 lock file = rsyncd.lock 即可解决。</li>
</ul>
<p><br></p>
<h3 id="问题15-报rsync-error-received-SIGINT-SIGTERM-or-SIGHUP-code-20-at-rsync-c-544-错误。"><a href="#问题15-报rsync-error-received-SIGINT-SIGTERM-or-SIGHUP-code-20-at-rsync-c-544-错误。" class="headerlink" title="问题15.报rsync error: received SIGINT, SIGTERM, or SIGHUP (code 20) at rsync.c(544)错误。"></a>问题15.报<code>rsync error: received SIGINT, SIGTERM, or SIGHUP (code 20) at rsync.c(544)</code>错误。</h3><ul>
<li>错误信息:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rsync error: received SIGINT, SIGTERM, or SIGHUP (code 20) at rsync.c(544) [receiver=3.0.5] </span><br><span class="line">rsync error: received SIGINT, SIGTERM, or SIGHUP (code 20) at rsync.c(544) [generator=3.0.5]</span><br></pre></td></tr></table></figure></li>
<li>问题原因: 由于 Ctrl+C 或者 大量文件导致。</li>
</ul>
<p><br></p>
<h3 id="问题16-报-ERROR-invalid-uid-nobody错误。"><a href="#问题16-报-ERROR-invalid-uid-nobody错误。" class="headerlink" title="问题16.报@ERROR: invalid uid nobody错误。"></a>问题16.报<code>@ERROR: invalid uid nobody</code>错误。</h3><ul>
<li>错误信息: <code>rsync error: error starting client-server protocol (code 5) at main.c(1516) [Receiver=3.0.8]</code></li>
<li>问题原因: UID 不对 默认 是 nobody </li>
<li>解决方法:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uid = 0</span><br><span class="line">gid = 0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="问题17-在同步文件数较多的目录同步时出错rsync-writefd-unbuffered-failed-to-write-4-bytes-to-socket-sender-Connection-reset-by-peer-104-错误。"><a href="#问题17-在同步文件数较多的目录同步时出错rsync-writefd-unbuffered-failed-to-write-4-bytes-to-socket-sender-Connection-reset-by-peer-104-错误。" class="headerlink" title="问题17.在同步文件数较多的目录同步时出错rsync: writefd_unbuffered failed to write 4 bytes to socket [sender]: Connection reset by peer (104)错误。"></a>问题17.在同步文件数较多的目录同步时出错<code>rsync: writefd_unbuffered failed to write 4 bytes to socket [sender]: Connection reset by peer (104)</code>错误。</h3><ul>
<li>错误信息:在批处理中加上-v参数，看到错误信息如下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync: writefd_unbuffered failed to write 4 bytes to socket [sender]: Connection reset by peer (104)</span><br><span class="line">rsync: <span class="built_in">read</span> error: Connection reset by peer (104)</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code 12) at io.c(768) [sender=3.0.6]</span><br></pre></td></tr></table></figure></li>
<li>问题原因: 原以为是文件太多，缓冲区不够引起，但看这个解决方案，似乎是转换编码方面的bug了。</li>
<li>解决办法: 在samba.org上找到解决方案, 可以在客户端命令行中加上–no-iconv参数就可以了。在rsync的文档中描述如下：<a href="http://rsync.samba.org/ftp/rsync/rsync.html" target="_blank" rel="noopener">http://rsync.samba.org/ftp/rsync/rsync.html</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--iconv=CONVERT_SPEC</span><br><span class="line">Rsync can convert filenames between character sets using this option. Using a CONVERT_SPEC of <span class="string">"."</span> tells rsync to look up the default character-set via the locale setting. Alternately, you can fully specify what conversion to <span class="keyword">do</span> by giving a <span class="built_in">local</span> and a remote charset separated by a comma <span class="keyword">in</span> the order --iconv=LOCAL,REMOTE, e.g. --iconv=utf8,iso88591. This order ensures that the option will stay the same whether you<span class="string">'re pushing or pulling files. Finally, you can specify either --no-iconv or a CONVERT_SPEC of "-" to turn off any conversion. The default setting of this option is site-specific, and can also be affected via the RSYNC_ICONV environment variable.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="问题18-在window上rsync同步数据报错-rsync-error-some-files-attrs-were-not-transferred-see-previous-errors-code-2-3-at-main-c-1052-sender-3-0-8"><a href="#问题18-在window上rsync同步数据报错-rsync-error-some-files-attrs-were-not-transferred-see-previous-errors-code-2-3-at-main-c-1052-sender-3-0-8" class="headerlink" title="问题18.在window上rsync同步数据报错:rsync error: some files/attrs were not transferred (see previous errors) (code 2 3) at main.c(1052) [sender=3.0.8]"></a>问题18.在window上rsync同步数据报错:<code>rsync error: some files/attrs were not transferred (see previous errors) (code 2 3) at main.c(1052) [sender=3.0.8]</code></h3><ul>
<li>问题原因:<ul>
<li>因为rsync服务端执行的用户对同步的文件没有写入权限。</li>
<li>默认rsync是以SvcCWRSYNC此用户运行的，而一般同步的文件此用户是没有写入权限的。</li>
<li>SvcCWRSYNC默认归属于User组，将rsync的服务器端SvcCWRSYNC此用户隶属于加到administrator组就可以解决上面的报错。</li>
</ul>
</li>
</ul>
<p><br></p>
<h3 id="问题19-如果在使用inotifywait中出现error-while-loading-shared-libraries-libinotifytools-so-0-cannot-open-shared-object-file-No-such-file-or-directory。"><a href="#问题19-如果在使用inotifywait中出现error-while-loading-shared-libraries-libinotifytools-so-0-cannot-open-shared-object-file-No-such-file-or-directory。" class="headerlink" title="问题19.如果在使用inotifywait中出现error while loading shared libraries: libinotifytools.so.0: cannot open shared object file: No such file or directory。"></a>问题19.如果在使用inotifywait中出现<code>error while loading shared libraries: libinotifytools.so.0: cannot open shared object file: No such file or directory</code>。</h3><p>解决方法:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">32位系统：ln -s /usr/<span class="built_in">local</span>/lib/libinotifytools.so.0 /usr/lib/libinotifytools.so.0 </span><br><span class="line">64位系统：ln -s /usr/<span class="built_in">local</span>/lib/libinotifytools.so.0 /usr/lib64/libinotifytools.so.0</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="问题20-在windows使用-cwRsync中出现uid-gid-4294967295-1-is-impossible-to-set-on错误。"><a href="#问题20-在windows使用-cwRsync中出现uid-gid-4294967295-1-is-impossible-to-set-on错误。" class="headerlink" title="问题20.在windows使用 cwRsync中出现uid/gid 4294967295 (-1) is impossible to set on错误。"></a>问题20.在windows使用 cwRsync中出现<code>uid/gid 4294967295 (-1) is impossible to set on</code>错误。</h3><p>解决办法:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1.在客户端命令行加 --no-super 参数</span></span><br><span class="line"><span class="comment"># 方式2.在在服务器端的配置文件中添加,通过上面的方法完美解决了问题。</span></span><br><span class="line">uid = 0</span><br><span class="line">gid = 0</span><br><span class="line">fake super = yes</span><br></pre></td></tr></table></figure></p>

        </div>
        
  <hr>
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>

  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注，转个发】(人间五大情)</b>，这将对我的肯定，谢谢！。</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="扫描Visit(浏览)极客全栈修炼小程序"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-03-29T05:39:06.308Z" itemprop="dateUpdated">2022-03-29 13:39:06</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/系统运维/Application/Sync/采用Rsync与Inotify实时同步文件目录.md" target="_blank" rel="noopener noreferrer">_posts/系统运维/Application/Sync/采用Rsync与Inotify实时同步文件目录.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2018/1-29-113.html" target="_blank" rel="external">https://blog.weiyigeek.top/2018/1-29-113.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">👍 钟意作者</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Inotify/" rel="tag">Inotify</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Rsync/" rel="tag">Rsync</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2018/1-29-113.html&title=《采用Rsync与Inotify实时同步文件目录》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2018/1-29-113.html&title=《采用Rsync与Inotify实时同步文件目录》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2018/1-29-113.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《采用Rsync与Inotify实时同步文件目录》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2018/1-29-113.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2018/1-29-113.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2018/2-8-314.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">暂未入坑记</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2018/1-1-1.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">唯一极客的学习之路汇总</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Rsync-介绍"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.Rsync 介绍</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-Inotify-介绍"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.Inotify 介绍</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-安装配置"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 安装配置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Centos-7-x-安装Rsync"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.Centos 7.x 安装Rsync</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-Centos-7-x-安装-inotify-tools"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.Centos 7.x 安装 inotify-tools</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-Ubuntu-20-04-安装-inotify-tools"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3.Ubuntu 20.04 安装 inotify-tools</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-命令与配置解析"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 命令与配置解析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#rsync-命令-文件同步解析"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">rsync 命令 - 文件同步解析</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#inotifywait-命令-等待监听事件的发生"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">inotifywait 命令 - 等待监听事件的发生</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-安全配置"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x04 安全配置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#示例1-CentOS-6-X-之-Rsync-远程安全访问同步设置"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">示例1.CentOS 6.X 之 Rsync 远程安全访问同步设置</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x05-Windows服务器根据目录变化执行同步到NFS网络存储"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x05 Windows服务器根据目录变化执行同步到NFS网络存储</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x06-FAQ-你问我答"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x06 FAQ 你问我答</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x0n-入坑出坑"><span class="post-toc-number">7.</span> <span class="post-toc-text">0x0n 入坑出坑</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题1-报-ERROR-chroot-failed错误"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">问题1.报@ERROR: chroot failed错误</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题2-报-ERROR-auth-failed-on-module-tee错误"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">问题2.报@ERROR: auth failed on module tee错误</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题3-报-ERROR-Unknown-module-39-tee-nonexists-39-错误。"><span class="post-toc-number">7.3.</span> <span class="post-toc-text">问题3.报@ERROR: Unknown module &#39;tee_nonexists&#39;错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题4-在client上遇到问题报could-not-open-password-file-quot-etc-rsync-pas-quot-No-such-file-or-directory-2-错误"><span class="post-toc-number">7.4.</span> <span class="post-toc-text">问题4.在client上遇到问题报could not open password file &quot;&#x2F;etc&#x2F;rsync.pas&quot;: No such file or directory (2)错误</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题5-在client上遇到问题报rsync-write-failed-on-quot-home-backup2010-quot-No-space-left-on-device-28-错误"><span class="post-toc-number">7.5.</span> <span class="post-toc-text">问题5.在client上遇到问题报rsync: write failed on &quot;&#x2F;home&#x2F;backup2010&#x2F;&quot;: No space left on device (28)错误</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题6-报skipping-non-regular-file错误。"><span class="post-toc-number">7.6.</span> <span class="post-toc-text">问题6.报skipping non-regular file错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题7-报-ERROR-module-is-read-only错误。"><span class="post-toc-number">7.7.</span> <span class="post-toc-text">问题7.报@ERROR: module is read only错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题8-报password-file-must-not-be-other-accessible错误。"><span class="post-toc-number">7.8.</span> <span class="post-toc-text">问题8.报password file must not be other-accessible错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题9-报rsync-failed-to-connect-No-route-to-host错误。"><span class="post-toc-number">7.9.</span> <span class="post-toc-text">问题9.报rsync: failed to connect No route to host错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题10-报rsync-error-error-starting-client-server-protocol错误。"><span class="post-toc-number">7.10.</span> <span class="post-toc-text">问题10.报rsync error: error starting client-server protocol错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题11-报rsync-chown-quot-quot-failed-Invalid-argument-22-错误。"><span class="post-toc-number">7.11.</span> <span class="post-toc-text">问题11.报rsync: chown &quot;&quot; failed: Invalid argument (22)错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题12-报-ERROR-daemon-security-issue-—-contact-admin错误。"><span class="post-toc-number">7.12.</span> <span class="post-toc-text">问题12.报@ERROR: daemon security issue — contact admin错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题13-报rsync-read-error-Connection-reset-by-peer-104"><span class="post-toc-number">7.13.</span> <span class="post-toc-text">问题13.报rsync: read error: Connection reset by peer (104)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题14-报-ERROR-failed-to-open-lock-file错误。"><span class="post-toc-number">7.14.</span> <span class="post-toc-text">问题14.报@ERROR: failed to open lock file错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题15-报rsync-error-received-SIGINT-SIGTERM-or-SIGHUP-code-20-at-rsync-c-544-错误。"><span class="post-toc-number">7.15.</span> <span class="post-toc-text">问题15.报rsync error: received SIGINT, SIGTERM, or SIGHUP (code 20) at rsync.c(544)错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题16-报-ERROR-invalid-uid-nobody错误。"><span class="post-toc-number">7.16.</span> <span class="post-toc-text">问题16.报@ERROR: invalid uid nobody错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题17-在同步文件数较多的目录同步时出错rsync-writefd-unbuffered-failed-to-write-4-bytes-to-socket-sender-Connection-reset-by-peer-104-错误。"><span class="post-toc-number">7.17.</span> <span class="post-toc-text">问题17.在同步文件数较多的目录同步时出错rsync: writefd_unbuffered failed to write 4 bytes to socket [sender]: Connection reset by peer (104)错误。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题18-在window上rsync同步数据报错-rsync-error-some-files-attrs-were-not-transferred-see-previous-errors-code-2-3-at-main-c-1052-sender-3-0-8"><span class="post-toc-number">7.18.</span> <span class="post-toc-text">问题18.在window上rsync同步数据报错:rsync error: some files&#x2F;attrs were not transferred (see previous errors) (code 2 3) at main.c(1052) [sender&#x3D;3.0.8]</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题19-如果在使用inotifywait中出现error-while-loading-shared-libraries-libinotifytools-so-0-cannot-open-shared-object-file-No-such-file-or-directory。"><span class="post-toc-number">7.19.</span> <span class="post-toc-text">问题19.如果在使用inotifywait中出现error while loading shared libraries: libinotifytools.so.0: cannot open shared object file: No such file or directory。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题20-在windows使用-cwRsync中出现uid-gid-4294967295-1-is-impossible-to-set-on错误。"><span class="post-toc-number">7.20.</span> <span class="post-toc-text">问题20.在windows使用 cwRsync中出现uid&#x2F;gid 4294967295 (-1) is impossible to set on错误。</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，还请支持一下博主哟, 谢谢各位看友♥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="228" height="228" alt="打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="228" height="228" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- 微信公众号关注/文章版权复制 -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">个人Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">个人Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">个人知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云+云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2018/1-29-113.html&title=《采用Rsync与Inotify实时同步文件目录》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2018/1-29-113.html&title=《采用Rsync与Inotify实时同步文件目录》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2018/1-29-113.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《采用Rsync与Inotify实时同步文件目录》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2018/1-29-113.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2018/1-29-113.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACH0lEQVR42u3aQY7DIAwF0Ln/pTPbSlXSbzutFHisRm0HeCwsbPP3F4/jZbx+cv3t++fvc16vcvPAwMB4LOO4HNcL5JizrZ/Nk+8NAwNjH0Zv6gR5vfycjYGBgVH9zTwEY2BgYNwbcJMl55dLDAwMjDyJzYtrSaEtP5qbc3EMDIwHMvKq++///kp/AwMD41GMozh618QkRB6DgYGBsTYjD3B5a7O66ShBTWbAwMBYlNF74pA3JucFuOgTDAyMpRn5koXpWkX/eckPAwNjB8Zk+eQSOYFFx4qBgbEoo1qC7yWfeVMzP4jTJBYDA2M5xrw0X30oVg3f5QYnBgbGoowbzuAnwbp8w8XAwFiC0Sty5Qln3uBMtns6DwYGxgaMPMgmzcvq1bPacmi2BDAwMB7LqIa2/PFEDs7D8egeioGBsRyj+m31yUWOr4IxMDDWY8zTznzrvWdnzfCKgYGxHCO/wFULZ8l/Jc9YP1AxMDCWZkwiWF7cnzzFSPAYGBg7MKqNzLxwn7dFk7D7YVcYGBgbMCatgmorNC/JFY4SAwNjG0aviDYPsjd0JzEwMBZlHMXRw/SCbLIuBgbGDoxJl7B3sUu20psNAwNjbca9F7veI7D8yDAwMHZmTDbUa232nlCczoaBgYERNyxzUh52o0CMgYGBMc6D8wS4GcQxMDA2YCRJbL7MPLx+sdyGgYHxQMbopUb8y7zBmRfgMDAwNmD8AynKaph0zlIQAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
