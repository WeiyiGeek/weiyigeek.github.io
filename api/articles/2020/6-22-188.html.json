{"title":"Linux系统自定义制作ISO安装镜像","slug":"系统运维/Linux/系统安装/Linux系统自定义制作ISO安装镜像","date":"2020-06-22T11:35:30.000Z","updated":"2021-06-27T08:29:39.788Z","url":"2020/6-22-188.html","path":"api/articles/2020/6-22-188.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h4><p>在CentOS6系列版本系统在安装完成后会自动生成一个<code>install.log</code>文件,然后在CentOS7系列版本中就变化为<code>anaconda-ks.cfg</code>文件，它可以作为类似于Windows自动化安装的应答文件，只不过此处是用于Linux系统自动化安装的应答文件即<code>无人值守自动化安装配置文件</code>;</p>\n<p>Q:vmlinuz 与 initrd.img 介绍分别有何作用说明?</p>\n<blockquote>\n<p>答:(1) vmlinuz 指的是可引导和可压缩的内核，作用：<code>进程管理、内存管理、文件管理、驱动管理、网络管理</code>。<br>(2) initrd.img 是一个启动映象，放的是和启动相关的驱动模块。通常的步骤是先启动内核，然后内核挂载initrd.img，并执行里面的脚本来进一步挂载各种各样的模块。<br>其中最重要的就是根文件系统驱动模块，有了它才能挂载根文件系统，继而运行用户空间的第一个<code>应用程序init或者systemd</code>完成系统后续的启动；</p>\n</blockquote>\n<hr>\n<h4 id=\"0x01-实际案例\"><a href=\"#0x01-实际案例\" class=\"headerlink\" title=\"0x01 实际案例\"></a>0x01 实际案例</h4><p>实践环境描述:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]$ cat /etc/system-release</span><br><span class=\"line\">CentOS Linux release 7.8.2003 (Core)</span><br><span class=\"line\">[root@localhost ~]$ uname -r</span><br><span class=\"line\">3.10.0-1127.el7.x86_64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自定义基础镜像(本身自带rpm都比较少的)</span></span><br><span class=\"line\">CentOS-7-x86_64-Minimal-2003.iso </span><br><span class=\"line\">1.01 GB (1,085,276,160 字节)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"1-基础准备与介绍\"><a href=\"#1-基础准备与介绍\" class=\"headerlink\" title=\"1.基础准备与介绍\"></a>1.基础准备与介绍</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 创建并以loop挂载ISO镜像</span></span><br><span class=\"line\">mkdir /media/iso &amp;&amp; mount -o loop CentOS-7-x86_64-Minimal-2003.iso /media/iso</span><br><span class=\"line\"><span class=\"comment\"># mount: /dev/loop0 写保护，将以只读方式挂载</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 进行入镜像挂载的目录并查看里面文件</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /media/iso &amp;&amp; tree -L 1</span><br><span class=\"line\">.</span><br><span class=\"line\">├── CentOS_BuildTag  <span class=\"comment\"># 系统版本构建标签 20200420-1800</span></span><br><span class=\"line\">├── EFI      <span class=\"comment\"># UEFI 启动模式下必须文件，Legacy模式下是非必须文件</span></span><br><span class=\"line\">├── EULA     <span class=\"comment\"># 最终用户许可协议</span></span><br><span class=\"line\">├── GPL      <span class=\"comment\"># 通用公用许可证／执照(General Public License)</span></span><br><span class=\"line\">├── images   <span class=\"comment\"># 启动映像文件</span></span><br><span class=\"line\">├── isolinux <span class=\"comment\"># 存放光盘启动时的安装界面信息</span></span><br><span class=\"line\">├── LiveOS   <span class=\"comment\"># 存储了映像文件</span></span><br><span class=\"line\">├── Packages <span class=\"comment\"># 系统自带rpm包软件</span></span><br><span class=\"line\">├── repodata <span class=\"comment\"># 系统rpm包metadate源数据</span></span><br><span class=\"line\">├── RPM-GPG-KEY-CentOS-7 <span class=\"comment\"># rpm的GPG校验公钥</span></span><br><span class=\"line\">├── RPM-GPG-KEY-CentOS-Testing-7 <span class=\"comment\"># 同上</span></span><br><span class=\"line\">└── TRANS.TBL <span class=\"comment\"># 提供比ISO9660标准约定的基本文件名更加灵活的文件名, 用简约符号代表目录、文件、链接;</span></span><br><span class=\"line\">discinfo    <span class=\"comment\">#文件是安装价质的识别信息</span></span><br><span class=\"line\">.treeinfo   <span class=\"comment\">#文件是系统版本，创建时间及文件目录树结构信息</span></span><br><span class=\"line\">ks.cfg     <span class=\"comment\">#文件是无人值守自动化安装配置文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 下载镜像制作的相关软件</span></span><br><span class=\"line\">mv /etc/yum.repos.d/CentOS-Base.repo&#123;,.bak&#125; </span><br><span class=\"line\">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class=\"line\">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class=\"line\">yum clean all &amp;&amp; yum makecache </span><br><span class=\"line\">yum -y install anaconda repodata createrepo mkisofs rsync</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h5 id=\"2-一键安装自定义镜像\"><a href=\"#2-一键安装自定义镜像\" class=\"headerlink\" title=\"2.一键安装自定义镜像\"></a>2.一键安装自定义镜像</h5><p>Step 1.建立ISO生成目录和同步镜像到/mnt/iso目录之中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir /mnt/iso </span><br><span class=\"line\"><span class=\"comment\">#同步/media/iso下的文件到/mnt/iso路径下，除了Packages和repodata文件夹</span></span><br><span class=\"line\">$ /usr/bin/rsync -a --exclude=Packages/ --exclude=repodata/ /media/iso/ /mnt/iso</span><br></pre></td></tr></table></figure></p>\n<p>Step 2.复制指定rpm包(剔除多余的rpm包)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将当前安装后的系统安装rpm包名称进行列出</span></span><br><span class=\"line\">$ rpm -qa &gt; rpm.txt &amp;&amp; mkdir /mnt/iso/&#123;Packages,repodata&#125;</span><br><span class=\"line\">SRCDIR=/media/iso/Packages</span><br><span class=\"line\">DSTDIR=/mnt/iso/Packages</span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"built_in\">read</span> LINE </span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">cp <span class=\"variable\">$&#123;SRCDIR&#125;</span>/<span class=\"variable\">$&#123;LINE&#125;</span>.rpm <span class=\"variable\">$&#123;DSTDIR&#125;</span>/ || <span class=\"built_in\">echo</span> <span class=\"string\">\"Error: <span class=\"variable\">$&#123;LINE&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"keyword\">done</span> &lt; rpm.txt</span><br></pre></td></tr></table></figure></p>\n<p>Step 3.进入/media/iso/repodata 目录将”*-x86_64-comps.xml”文件拷贝到<code>/mnt/iso/repodata</code>路径下，并重命名成comps.xml。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 可能目录中不知一个*-x86_64-comps.xml请根据需求进行选择;</span></span><br><span class=\"line\"><span class=\"comment\"># cp /media/iso/repodata/83b61f9495b5f728989499479e928e09851199a8846ea37ce008a3eb79ad84a0-c7-minimal-x86_64-comps.xml /mnt/iso/repodata/comps.xml</span></span><br><span class=\"line\">cp /media/iso/repodata/cca56f3cffa18f1e52302dbfcf2f0250a94c8a37acd8347ed6317cb52c8369dc-c7-x86_64-comps.xml /mnt/iso/repodata/comps.xml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#PS:如果有新增或删除了Packages目录的RPM包，请重新生成comps.xml文件</span></span><br><span class=\"line\"><span class=\"comment\">#切换到/mnt/iso/路径下生成comps.xml文件</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /mnt/iso/ &amp;&amp; createrepo -g repodata/comps.xml ./</span><br><span class=\"line\"><span class=\"comment\"># Spawning worker 0 with 192 pkgs</span></span><br><span class=\"line\"><span class=\"comment\"># Spawning worker 1 with 191 pkgs</span></span><br><span class=\"line\"><span class=\"comment\"># Workers Finished</span></span><br><span class=\"line\"><span class=\"comment\"># Saving Primary metadata</span></span><br><span class=\"line\"><span class=\"comment\"># Saving file lists metadata</span></span><br><span class=\"line\"><span class=\"comment\"># Saving other metadata</span></span><br><span class=\"line\"><span class=\"comment\"># Generating sqlite DBs</span></span><br><span class=\"line\"><span class=\"comment\"># Sqlite DBs complete</span></span><br><span class=\"line\">[root@localhost iso]<span class=\"variable\">$ls</span> repodata/</span><br><span class=\"line\"><span class=\"comment\"># 499fdea70ea25eda90e3d37ce84518c41673e09c129af2a0988138b008c0138c-other.sqlite.bz2      d4de4d1e2d2597c177bb095da8f1ad794d69f76e8ac7ab1ba6340fdd0969e936-comps.xml.gz</span></span><br><span class=\"line\"><span class=\"comment\"># 7b2375dfbe14db6dc4e172df41e8a51bf3d1a2fafe7cdb2d802bf30528e7657b-filelists.sqlite.bz2  e64bcd7401a518370ce79f75713b43df01252dbbecf6d888a0e6e1c37d423640-primary.sqlite.bz2</span></span><br><span class=\"line\"><span class=\"comment\"># 83b61f9495b5f728989499479e928e09851199a8846ea37ce008a3eb79ad84a0-comps.xml             f0c55932043686281f78635817f4a98a43db3fe3ba14df2d8b64e2a52af708c9-other.xml.gz</span></span><br><span class=\"line\"><span class=\"comment\"># 89bc446b7889e2f5409c3d9ebe33043e1a5974b180d4e2362a5d517abe29cf9a-filelists.xml.gz      repomd.xml</span></span><br><span class=\"line\"><span class=\"comment\"># d163815c6cd0144b15c7bce3cb06c255aaa4c205bfe2b278517ade135e4010ef-primary.xml.gz</span></span><br></pre></td></tr></table></figure></p>\n<p>Step 4.在指定构建镜像的目录中 isolinux/isolinux.cfg 文件修改指定成ks.cfg所在目录<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ grep -a3 -n <span class=\"string\">\"append\"</span> isolinux/isolinux.cfg</span><br><span class=\"line\">61-label linux</span><br><span class=\"line\">62-  menu label ^Install CentOS 7</span><br><span class=\"line\">63-  kernel vmlinuz</span><br><span class=\"line\">64:  append initrd=initrd.img inst.ks=cdrom:/ks.cfg inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 quiet</span><br><span class=\"line\"></span><br><span class=\"line\">$ vi +64 /mnt/iso/isolinux/isolinux.cfg</span><br></pre></td></tr></table></figure></p>\n<p>Step 5.Linux安装后应答文件用于按照其内部设置进行自动化安装系统<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># minimal 最小安装 参考：/root/anaconda-ks.cfg</span></span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; /mnt/iso/ks.cfg &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\"><span class=\"comment\">#version=DEVEL</span></span><br><span class=\"line\"><span class=\"comment\"># System authorization information</span></span><br><span class=\"line\">auth --enableshadow --passalgo=sha512</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Use CDROM installation media</span></span><br><span class=\"line\">cdrom</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Use graphical install</span></span><br><span class=\"line\">graphical</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Run the Setup Agent on first boot</span></span><br><span class=\"line\">firstboot --<span class=\"built_in\">enable</span></span><br><span class=\"line\">ignoredisk --only-use=sda</span><br><span class=\"line\"><span class=\"comment\"># Keyboard layouts</span></span><br><span class=\"line\">keyboard --vckeymap=cn --xlayouts=<span class=\"string\">'cn'</span></span><br><span class=\"line\"><span class=\"comment\"># System language</span></span><br><span class=\"line\">lang zh_CN.UTF-8</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Network information</span></span><br><span class=\"line\">network  --bootproto=dhcp --device=eth0 --ipv6=auto --activate</span><br><span class=\"line\">network  --hostname=localhost.localdomain</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Root password</span></span><br><span class=\"line\"><span class=\"comment\"># password = test123</span></span><br><span class=\"line\">rootpw --iscrypted <span class=\"variable\">$6</span><span class=\"variable\">$BJIQmFkQ</span><span class=\"variable\">$TnJMVbBoWvE4fBkJ30iJlQwDLxV3wLaZ8pVqrh7N5m0mTWD</span>.vNdRw/uEs8Wu7IB.sfvzBYZUweM6Rd0M43bm61</span><br><span class=\"line\"><span class=\"comment\"># System services</span></span><br><span class=\"line\">services --enabled=<span class=\"string\">\"chronyd\"</span></span><br><span class=\"line\"><span class=\"comment\"># System timezone</span></span><br><span class=\"line\">timezone Asia/Shanghai --isUtc</span><br><span class=\"line\"><span class=\"comment\"># System bootloader configuration</span></span><br><span class=\"line\"><span class=\"comment\"># 采用 mbr 分区表</span></span><br><span class=\"line\">bootloader --append=<span class=\"string\">\" crashkernel=auto\"</span> --location=mbr --boot-drive=sda</span><br><span class=\"line\">autopart --<span class=\"built_in\">type</span>=lvm</span><br><span class=\"line\"><span class=\"comment\"># Partition clearing information</span></span><br><span class=\"line\">clearpart --none --initlabel</span><br><span class=\"line\"></span><br><span class=\"line\">%packages</span><br><span class=\"line\">@^minimal</span><br><span class=\"line\">@core</span><br><span class=\"line\">chrony</span><br><span class=\"line\">kexec-tools</span><br><span class=\"line\"></span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%addon com_redhat_kdump --<span class=\"built_in\">enable</span> --reserve-mb=<span class=\"string\">'auto'</span></span><br><span class=\"line\"></span><br><span class=\"line\">%end</span><br><span class=\"line\"></span><br><span class=\"line\">%anaconda</span><br><span class=\"line\">pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class=\"line\">pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok</span><br><span class=\"line\">pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class=\"line\">%end</span><br><span class=\"line\">END</span><br></pre></td></tr></table></figure></p>\n<p>Step 6.生成一个ISO镜像文件，便于刻录到光盘中进行安装并且生成ISO文件MD5值<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls /mnt/iso</span><br><span class=\"line\">CentOS_BuildTag  EFI  EULA  GPL  images  isolinux  ks.cfg  LiveOS  Packages  repodata  RPM-GPG-KEY-CentOS-7  RPM-GPG-KEY-CentOS-Testing-7  TRANS.TBL</span><br><span class=\"line\">$ genisoimage -joliet-long -V CentOS7 -o CentOS-7-2.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -R -J -v -cache-inodes -T -eltorito-alt-boot -e images/efiboot.img -no-emul-boot /mnt/iso</span><br><span class=\"line\"><span class=\"comment\"># Total translation table size: 107955</span></span><br><span class=\"line\"><span class=\"comment\"># Total rockridge attributes bytes: 47780</span></span><br><span class=\"line\"><span class=\"comment\"># Total directory bytes: 81920</span></span><br><span class=\"line\"><span class=\"comment\"># Path table size(bytes): 140</span></span><br><span class=\"line\"><span class=\"comment\"># Done with: The File(s)                             Block(s)    496155</span></span><br><span class=\"line\"><span class=\"comment\"># Writing:   Ending Padblock                         Start Block 496258</span></span><br><span class=\"line\"><span class=\"comment\"># Done with: Ending Padblock                         Block(s)    150</span></span><br><span class=\"line\"><span class=\"comment\"># Max brk space used 85000</span></span><br><span class=\"line\"><span class=\"comment\"># 496408 extents written (969 MB)</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ /usr/bin/implantisomd5 /mnt/iso/CentOS-minimal-7-custom.iso</span><br><span class=\"line\"><span class=\"comment\"># Inserting md5sum into iso image...</span></span><br><span class=\"line\"><span class=\"comment\"># md5 = 9e253ac2c07e857439713d29ad89473c</span></span><br><span class=\"line\"><span class=\"comment\"># Inserting fragment md5sums into iso image...</span></span><br><span class=\"line\"><span class=\"comment\"># fragmd5 = abd38349cd862634484b2b81ce84fd6b62c2af5c245f13192553e193b264</span></span><br><span class=\"line\"><span class=\"comment\"># frags = 20</span></span><br><span class=\"line\"><span class=\"comment\"># Setting supported flag to 0</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"3-UEFI-镜像自安装制作\"><a href=\"#3-UEFI-镜像自安装制作\" class=\"headerlink\" title=\"3.UEFI 镜像自安装制作\"></a>3.UEFI 镜像自安装制作</h5><p>描述:以下是制作UEFI启动安装的一些重要修改配置步骤;</p>\n<p>Step 1.UEFI 安装模式下重要文件和目录:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) EFI 目录</span></span><br><span class=\"line\"><span class=\"variable\">$tree</span> EFI/</span><br><span class=\"line\">EFI/</span><br><span class=\"line\">├── BOOT</span><br><span class=\"line\">│   ├── BOOTIA32.EFI</span><br><span class=\"line\">│   ├── BOOTX64.EFI</span><br><span class=\"line\">│   ├── fonts</span><br><span class=\"line\">│   │   ├── TRANS.TBL</span><br><span class=\"line\">│   │   └── unicode.pf2</span><br><span class=\"line\">│   ├── grub.cfg       <span class=\"comment\"># grub BootLoader引导程序修改</span></span><br><span class=\"line\">│   ├── grubia32.efi</span><br><span class=\"line\">│   ├── grubx64.efi</span><br><span class=\"line\">│   ├── mmia32.efi</span><br><span class=\"line\">│   ├── mmx64.efi</span><br><span class=\"line\">│   └── TRANS.TBL</span><br><span class=\"line\">└── TRANS.TBL</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在grub.cfg里修改引导文件指明 ks.cfg 文件位置和安装源位置</span></span><br><span class=\"line\">$ vi ./EFI/BOOT/grub.cfg</span><br><span class=\"line\"><span class=\"comment\"># 默认选择 Test this media &amp; install CentOS 7 </span></span><br><span class=\"line\"><span class=\"built_in\">set</span> default=<span class=\"string\">\"1\"</span></span><br><span class=\"line\"><span class=\"comment\"># 函数声明</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> load_video &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 载入模块</span></span><br><span class=\"line\">  insmod efi_gop</span><br><span class=\"line\">  insmod efi_uga</span><br><span class=\"line\">  insmod video_bochs</span><br><span class=\"line\">  insmod video_cirrus</span><br><span class=\"line\">  insmod all_video</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 含税调用</span></span><br><span class=\"line\">load_video</span><br><span class=\"line\"><span class=\"comment\"># 变量设置</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> gfxpayload=keep</span><br><span class=\"line\">insmod gzio</span><br><span class=\"line\">insmod part_gpt</span><br><span class=\"line\">insmod ext2</span><br><span class=\"line\"><span class=\"comment\"># 页面显示时间</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> timeout=60</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### END /etc/grub.d/00_header ###</span></span><br><span class=\"line\">search --no-floppy --<span class=\"built_in\">set</span>=root -l <span class=\"string\">'CentOS 7 x86_64'</span></span><br><span class=\"line\"><span class=\"comment\">### BEGIN /etc/grub.d/10_linux ###</span></span><br><span class=\"line\"><span class=\"comment\"># BootLoader 显示菜单 </span></span><br><span class=\"line\"><span class=\"comment\"># 静默安装: inst.ks=cdrom://ks_efi.cfg </span></span><br><span class=\"line\">menuentry <span class=\"string\">'Install CentOS 7'</span> --class fedora --class gnu-linux --class gnu --class os &#123;</span><br><span class=\"line\">        linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 inst.ks=cdrom:/ks_efi.cfg quiet</span><br><span class=\"line\">        initrdefi /images/pxeboot/initrd.img</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">menuentry <span class=\"string\">'Test this media &amp; install CentOS 7'</span> --class fedora --class gnu-linux --class gnu --class os &#123;</span><br><span class=\"line\">        linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 rd.live.check quiet</span><br><span class=\"line\">        initrdefi /images/pxeboot/initrd.img</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># Bootloader 子菜单</span></span><br><span class=\"line\">submenu <span class=\"string\">'Troubleshooting --&gt;'</span> &#123;</span><br><span class=\"line\">        menuentry <span class=\"string\">'Install CentOS 7 in basic graphics mode'</span> --class fedora --class gnu-linux --class gnu --class os &#123;</span><br><span class=\"line\">                linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 xdriver=vesa nomodeset quiet</span><br><span class=\"line\">                initrdefi /images/pxeboot/initrd.img</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        menuentry <span class=\"string\">'Rescue a CentOS system'</span> --class fedora --class gnu-linux --class gnu --class os &#123;</span><br><span class=\"line\">                linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 rescue quiet</span><br><span class=\"line\">                initrdefi /images/pxeboot/initrd.img</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 2.images目录<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (2) images目录: efiboot.img 文件是UEFI模式</span></span><br><span class=\"line\"><span class=\"variable\">$tree</span> ./images/</span><br><span class=\"line\">./images/</span><br><span class=\"line\">├── efiboot.img</span><br><span class=\"line\">├── pxeboot</span><br><span class=\"line\">│   ├── initrd.img</span><br><span class=\"line\">│   ├── TRANS.TBL</span><br><span class=\"line\">│   └── vmlinuz</span><br><span class=\"line\">└── TRANS.TBL</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 3.Packages目录软件包支持<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (3) Packages目录:UEFI模式需要有如下包支持(必须的)</span></span><br><span class=\"line\">tree Packages/ | egrep <span class=\"string\">\"grub2-efi|grub2-tools|grub2-tools-extra|grub2-tools-minimal|grub2-common|shim|mokutil|efivar-libs|efibootmgr\"</span></span><br><span class=\"line\">├── efibootmgr-17-2.el7.x86_64.rpm</span><br><span class=\"line\">├── efivar-libs-36-12.el7.x86_64.rpm</span><br><span class=\"line\">├── grub2-common-2.02-0.81.el7.centos.noarch.rpm</span><br><span class=\"line\">├── grub2-efi-ia32-2.02-0.81.el7.centos.x86_64.rpm</span><br><span class=\"line\">├── grub2-efi-x64-2.02-0.81.el7.centos.x86_64.rpm</span><br><span class=\"line\">├── grub2-tools-2.02-0.81.el7.centos.x86_64.rpm</span><br><span class=\"line\">├── grub2-tools-extra-2.02-0.81.el7.centos.x86_64.rpm</span><br><span class=\"line\">├── grub2-tools-minimal-2.02-0.81.el7.centos.x86_64.rpm</span><br><span class=\"line\">├── mokutil-15-2.el7.centos.x86_64.rpm</span><br><span class=\"line\">├── shim-x64-15-2.el7.centos.x86_64.rpm</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 4.KS文件修改legacy和UEFI模式ks文件的区别是磁盘分区(UEFI模式多了一个/boot/efi分区)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#anaconda-ks.cfg</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 5.UEFI打包方式和legacy模式不一样<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">genisoimage -v -cache-inodes -joliet-long -R -J -T \\</span><br><span class=\"line\">-o CentOS-7_x86_64-UEFI.iso -b isolinux/isolinux.bin -c isolinux/boot.cat \\</span><br><span class=\"line\">-no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot -b images/efiboot.img -no-emul-boot -input-charset</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Step 6.自此一个支持UEFI模式安装的ISO就制作完成了</p>\n<p><em>注意事项:</em></p>\n<ul>\n<li>(1) 制作对应版本的镜像建议使用对应版本的系统进行制作ISO，比如CentOS6.X不能制作CentOS7.x版本由于两者系统的genisoimage命令版本不一致; 其实最早时候Linux系统使用cdrtools工具来管理 iso 及光盘, mkisofs 是 cdrtools 里面的一个工具然后cdrtools开发者将其从GPL修改为CDDL许可开源社区又推出了一套基于 GPL 的工具<code>cdrkit</code>,kisofs 也被 genisoimage 去掉现在系统中的 mkisofs 实际是 genisoimage的软连接<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># EFI 启动参数</span></span><br><span class=\"line\">-eltorito-alt-boot -bimages/efiboot.img -no-emul-boot</span><br><span class=\"line\"><span class=\"comment\"># 6 版本</span></span><br><span class=\"line\">mkisofs -o CentOS-6.5_x86_64.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -R -J -v -T /mnt/iso</span><br><span class=\"line\"><span class=\"comment\"># 7 版本</span></span><br><span class=\"line\">genisoimage -o CentOS-minimal-7-custom.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -R -J -v -T /mnt/iso</span><br></pre></td></tr></table></figure></li>\n<li>(2) 在CentOS6.5以下系统版本不支持EFI引导方式;</li>\n<li>(3) 如果构建的自定义镜像在安装时提示找不到disc时候，是是因为iso目录内缺少隐藏文件.discinfo(<code>copy 默认会忽略拷贝.开头的文件</code>)，解决方式即复制原有的.discinfo文件。</li>\n<li>(4) 为了同时兼容mbr和efi方式，需同时创建 /boot 和 /boot/efi 分区;</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"OperationTools","path":"api/categories/OperationTools.json"},{"name":"Systeminstall","path":"api/categories/Systeminstall.json"}],"tags":[{"name":"ISO","path":"api/tags/ISO.json"}]}