{"title":"16-Kubernetes进阶之开发环境部署与配置","slug":"虚拟云容/云容器/Kubernetes/16-Kubernetes进阶之开发环境部署与配置","date":"2021-01-27T10:37:47.000Z","updated":"2022-12-18T15:27:12.895Z","url":"2021/1-27-548.html","path":"api/articles/2021/1-27-548.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>kubernetes 源码编译，分为本地二进制可执行文件编译和 docker 镜像编译两种， 之前演示的 minikube 方式或 kubeadm 方式安装，都是基于第二种 docker 镜像方式运行，当然也可以基于二进制文件方式安装，不管哪种方式，都是直接使用并不需要修改任何 k8s 代码。</p>\n<p>不过当我们有特殊需求时，比如需要修改 kube-proxy 对 service 的代理逻辑，kube-scheduler 对 pod 的调度逻辑等，这个时候就需要修改 k8s 源码了，为了让修改的代码生效，就需要对 k8s 代码执行编译了。当然 k8s 也为我们提供了 CRD 等可扩展插件，在不修改 k8s 源码的基础上实现自定义功能，但是对于一些底层逻辑策略需要修改的话，还是办不到的。</p>\n<p>kubernetes 开发者参考: <a href=\"https://github.com/kubernetes/community/blob/master/contributors/devel/development.md\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/community/blob/master/contributors/devel/development.md</a></p>\n<p>注意：因为 kubernetes 源码是由 go 语言编写的，所以要编译其源码，需要安装 go 环境，若我们想基于 docker 镜像编译 kubernetes 的话，那么还需要安装 docker 环境。</p>\n<h2 id=\"0x01-开发环境\"><a href=\"#0x01-开发环境\" class=\"headerlink\" title=\"0x01 开发环境\"></a>0x01 开发环境</h2><p>描述: kubernetes 开发依赖于Go所以它是必须的，其次是Git为了拉取官方的kubernetes项目；</p>\n<p>Kunernetes 常用开发环境安装方式:</p>\n<ul>\n<li>本地二进制可执行文件编译</li>\n<li>Docker镜像安装(Google 提供了 kube-core 但需要科学上网)</li>\n</ul>\n<h3 id=\"1-本地开发\"><a href=\"#1-本地开发\" class=\"headerlink\" title=\"1.本地开发\"></a>1.本地开发</h3><p><strong>环境准备:</strong></p>\n<ul>\n<li>Ubuntu &amp; Git<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; lsb_release -a</span><br><span class=\"line\">Distributor ID: Ubuntu</span><br><span class=\"line\">Description:    Ubuntu 20.04.1 LTS</span><br><span class=\"line\">Release:        20.04</span><br><span class=\"line\">Codename:       focal</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; uname -r</span><br><span class=\"line\">5.4.0-56-generic</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; git version</span><br><span class=\"line\">git version 2.25.</span><br></pre></td></tr></table></figure></li>\n<li>Go 语言安装<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Go官网：https://golang.org/dl/</span></span><br><span class=\"line\"><span class=\"comment\"># Go中文社区：https://studygolang.com/dl</span></span><br><span class=\"line\">wget https://dl.google.com/go/go1.15.5.linux-amd64.tar.gz </span><br><span class=\"line\">tar -zxvf go1.15.5.linux-amd64.tar.gz -C /home/weiyigeek/app/program/go/</span><br><span class=\"line\">vi /etc/profile</span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOPATH=/home/weiyigeek/app/program/go/src/   <span class=\"comment\"># GOPATH 作为 go 执行的工作路径</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOROOT=/home/weiyigeek/app/program/go        <span class=\"comment\"># go 安装目录</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> PATH=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$&#123;GOROOT&#125;</span>/bin </span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 环境验证</span></span><br><span class=\"line\">$ env | grep <span class=\"string\">\"GO\"</span></span><br><span class=\"line\">GOPATH=/home/weiyigeek/app/program/go/src/</span><br><span class=\"line\">GOROOT=/home/weiyigeek/app/program/go</span><br><span class=\"line\">$ go version</span><br><span class=\"line\">go version go1.15.5 linux/amd64</span><br></pre></td></tr></table></figure></li>\n<li>Kubernetes 项目源码 <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1: 拉取项目所有分支</span></span><br><span class=\"line\">mkdir -p <span class=\"variable\">$GOPATH</span>/src/k8s.io &amp;&amp; <span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src/k8s.io</span><br><span class=\"line\">&gt; git <span class=\"built_in\">clone</span> https://github.com/kubernetes/kubernetes.git</span><br><span class=\"line\"><span class=\"comment\"># $ git clone  https://github.com/kubernetes/kubernetes -b release-1.19.3 # 拉取Kubernetes源码指定分支</span></span><br><span class=\"line\">$ ls kubernetes</span><br><span class=\"line\"><span class=\"comment\"># api           cluster             go.mod    logo                      pkg                SUPPORT.md    WORKSPACE</span></span><br><span class=\"line\"><span class=\"comment\"># build         cmd                 go.sum    Makefile                  plugin             test</span></span><br><span class=\"line\"><span class=\"comment\"># BUILD.bazel   code-of-conduct.md  hack      Makefile.generated_files  README.md          third_party</span></span><br><span class=\"line\"><span class=\"comment\"># CHANGELOG     CONTRIBUTING.md     LICENSE   OWNERS                    SECURITY_CONTACTS  translation</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2: 拉取指定K8S版本源代码</span></span><br><span class=\"line\">K8S_VERSION=1.19.3</span><br><span class=\"line\">wget -c --no-check-certificate https://github.com/kubernetes/kubernetes/archive/v<span class=\"variable\">$&#123;K8S_VERSION&#125;</span>.tar.gz</span><br><span class=\"line\">&gt; tar -tf v1.19.3.tar.gz | more</span><br><span class=\"line\">kubernetes-1.19.3/</span><br><span class=\"line\">kubernetes-1.19.3/.bazelrc</span><br><span class=\"line\">kubernetes-1.19.3/.bazelversion</span><br><span class=\"line\">kubernetes-1.19.3/.generated_files</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"Docker-镜像安装\"><a href=\"#Docker-镜像安装\" class=\"headerlink\" title=\"Docker 镜像安装\"></a>Docker 镜像安装</h3><p>描述: 安装Docker以及加速源的配置这里不再累述了，不会的读者参考官网或者本博客中的Docker安装流程;</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 运行容器，并进入到容器内部</span><br><span class=\"line\">docker run --rm -it -v &#x2F;home&#x2F;weiyigeek&#x2F;kubernetes&#x2F;k8s-src:&#x2F;go&#x2F;src&#x2F;k8s.io&#x2F;kubernetes mirrorgooglecontainers&#x2F;kube-cross:v1.12.10-1 bash</span><br></pre></td></tr></table></figure>\n<p>复制代码</p>\n<p>vim staging/src/k8s.io/client-go/util/cert/cert.go  # kubeadm 1.14 版本之前<br>vim cmd/kubeadm/app/util/pkiutil/pki_helpers.go # kubeadm 1.14 至今<br>    const duration365d = time.Hour <em> 24 </em> 365 * 10  #设置为10年<br>    NotAfter: time.Now().Add(duration365d).UTC(),   #替换<br>make WHAT=cmd/kubeadm GOFLAGS=-v    #设置只编译kubeadm<br>cp _output/bin/kubeadm /root/kubeadm-new</p>\n<p>复制代码</p>\n<p>⒌更新 kubeadm </p>\n<p>#将kubeadm 进行替换<br>cp /usr/bin/kubeadm /usr/bin/kubeadm.old<br>cp /root/kubeadm-new /usr/bin/kubeadm<br>chmod a+x /usr/bin/kubeadm</p>\n<p>⒍更新各节点证书至Master节点</p>\n<p>cp -r /etc/kubernetes/pki /etc/kubernetes/pki.old<br>cd /etc/kubernetes/pki<br>kubeadm alpha certs renew all –config=/root/kubeadm-config.yaml<br>openssl x509 -in apiserver.crt -text -noout | grep Not</p>\n<p>⒎HA集群其余 mater节点证书更新<br>复制代码</p>\n<p>#!/bin/bash<br>masterNode=”192.168.66.20 192.168.66.21”</p>\n<p>#for host in ${masterNode}; do</p>\n<h1 id=\"scp-etc-kubernetes-pki-ca-crt-ca-key-sa-key-sa-pub-front-proxy-ca-crt-front-proxy-ca-key\"><a href=\"#scp-etc-kubernetes-pki-ca-crt-ca-key-sa-key-sa-pub-front-proxy-ca-crt-front-proxy-ca-key\" class=\"headerlink\" title=\"scp /etc/kubernetes/pki/{ca.crt,ca.key,sa.key,sa.pub,front-proxy-ca.crt,front-proxy-ca.key}\"></a>scp /etc/kubernetes/pki/{ca.crt,ca.key,sa.key,sa.pub,front-proxy-ca.crt,front-proxy-ca.key}</h1><h1 id=\"“-USER-”-host-etc-kubernetes-pki\"><a href=\"#“-USER-”-host-etc-kubernetes-pki\" class=\"headerlink\" title=\"“${USER}”@$host:/etc/kubernetes/pki/\"></a>“${USER}”@$host:/etc/kubernetes/pki/</h1><h1 id=\"scp-etc-kubernetes-pki-etcd-ca-crt-ca-key-“root”-host-etc-kubernetes-pki-etcd\"><a href=\"#scp-etc-kubernetes-pki-etcd-ca-crt-ca-key-“root”-host-etc-kubernetes-pki-etcd\" class=\"headerlink\" title=\"scp /etc/kubernetes/pki/etcd/{ca.crt,ca.key} “root”@$host:/etc/kubernetes/pki/etcd\"></a>scp /etc/kubernetes/pki/etcd/{ca.crt,ca.key} “root”@$host:/etc/kubernetes/pki/etcd</h1><h1 id=\"scp-etc-kubernetes-admin-conf-“root”-host-etc-kubernetes\"><a href=\"#scp-etc-kubernetes-admin-conf-“root”-host-etc-kubernetes\" class=\"headerlink\" title=\"scp /etc/kubernetes/admin.conf “root”@$host:/etc/kubernetes/\"></a>scp /etc/kubernetes/admin.conf “root”@$host:/etc/kubernetes/</h1><p>#done<br>for host in ${CONTROL_PLANE_IPS}; do<br>    scp /etc/kubernetes/pki/{ca.crt,ca.key,sa.key,sa.pub,front-proxy-ca.crt,front-proxy-ca.key}<br>“${USER}”@$host:/root/pki/<br>    scp /etc/kubernetes/pki/etcd/{ca.crt,ca.key} “root”@$host:/root/etcd<br>    scp /etc/kubernetes/admin.conf “root”@$host:/root/kubernetes/<br>done</p>\n<p><a href=\"https://blog.csdn.net/aixiaoyang168/article/details/87917184\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/aixiaoyang168/article/details/87917184</a></p>\n<p>weiyigeek@Ubuntu-PC:~/app/program/go/src/k8s.io/kubernetes/cmd/kubeadm</p>\n<blockquote>\n<p>go build -v .</p>\n</blockquote>\n<p>weiyigeek@Ubuntu-PC:~/app/program/go/src/k8s.io/kubernetes/cmd/kubeadm</p>\n<blockquote>\n<p>ls<br>app  BUILD  kubeadm  kubeadm.go  OWNERS  test</p>\n</blockquote>\n<p>weiyigeek@Ubuntu-PC:~/app/program/go/src/k8s.io/kubernetes/cmd/kubeadm</p>\n<blockquote>\n<p>./kubeadm version<br>kubeadm version: &amp;version.Info{Major:””, Minor:””, GitVersion:”v0.0.0-master+1e11e4a210802”, GitCommit:”1e11e4a2108024935ecfcb2912226cedeafd99df”, GitTreeState:””, BuildDate:”1970-01-01T00:00:00Z”, GoVersion:”go1.15.5”, Compiler:”gc”, Platform:”linux/amd64”}</p>\n</blockquote>\n<h2 id=\"实操1-Kubeadm-etcd证书过期或者延期处理流程\"><a href=\"#实操1-Kubeadm-etcd证书过期或者延期处理流程\" class=\"headerlink\" title=\"实操1.Kubeadm / etcd证书过期或者延期处理流程\"></a>实操1.Kubeadm / etcd证书过期或者延期处理流程</h2><p>描述: 下述操作主要用于处理<code>已过期</code>或者<code>即将过期的kubernetes集群证书</code>;</p>\n<p>Kubernetes 与 <code>Etcd 版本</code>与证书关联信息说明:</p>\n<ul>\n<li>Etcd 版本小于等于v1.9版本，etcd默认是不使用TLS连接，没有etcd相关证书，只需要更新master证书即可。</li>\n<li>Etcd 版本大于等于v1.10版本，etcd默认开启TLS，需要更新etcd证书和master证书。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/kubernetes/pki/etcd$ ls</span><br><span class=\"line\">  <span class=\"comment\"># ca.crt  ca.key  healthcheck-client.crt  healthcheck-client.key  peer.crt  peer.key  server.crt  server.key</span></span><br><span class=\"line\"></span><br><span class=\"line\">/etc/kubernetes/pki/etcd$ sudo openssl x509 -<span class=\"keyword\">in</span> server.crt -text -noout</span><br><span class=\"line\">  <span class=\"comment\"># Certificate:</span></span><br><span class=\"line\">  <span class=\"comment\">#     Data:</span></span><br><span class=\"line\">  <span class=\"comment\">#         Version: 3 (0x2)</span></span><br><span class=\"line\">  <span class=\"comment\">#         Serial Number: 4411755188724745942 (0x3d39b3f83becc6d6)</span></span><br><span class=\"line\">  <span class=\"comment\">#         Signature Algorithm: sha256WithRSAEncryption</span></span><br><span class=\"line\">  <span class=\"comment\">#         Issuer: CN = etcd-ca</span></span><br><span class=\"line\">  <span class=\"comment\">#         Validity</span></span><br><span class=\"line\">  <span class=\"comment\">#             Not Before: Nov  5 08:47:32 2020 GMT</span></span><br><span class=\"line\">  <span class=\"comment\">#             Not After : Dec 12 09:17:18 2021 GMT # 关键点</span></span><br></pre></td></tr></table></figure>\n<p>PS : 如果 Etcd 是由Kubeadm创建和托管的此时也可以通过下面的方式进行证书的续期, 如果是外部管理需要手动进行配置;</p>\n<p><strong>操作流程:</strong><br>1.采用以下命令查询证书可用时间<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># apiserver.crt (证书一年)</span></span><br><span class=\"line\">/etc/kubernetes/pki<span class=\"comment\"># openssl x509 -in apiserver.crt -text -noout</span></span><br><span class=\"line\">Certificate:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 3 (0x2)</span><br><span class=\"line\">        Serial Number: 3597153141676254659 (0x31eba7b94c4b25c3)</span><br><span class=\"line\">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class=\"line\">        Issuer: CN = kubernetes</span><br><span class=\"line\">        Validity</span><br><span class=\"line\">            Not Before: Nov  5 08:47:32 2020 GMT</span><br><span class=\"line\">            Not After : Nov  5 08:47:32 2021 GMT</span><br><span class=\"line\"><span class=\"comment\"># ca.crt (证书十年)</span></span><br><span class=\"line\">/etc/kubernetes/pki<span class=\"comment\"># openssl x509 -in ca.crt -text -noout</span></span><br><span class=\"line\">Certificate:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 3 (0x2)</span><br><span class=\"line\">        Serial Number: 0 (0x0)</span><br><span class=\"line\">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class=\"line\">        Issuer: CN = kubernetes</span><br><span class=\"line\">        Validity</span><br><span class=\"line\">            Not Before: Nov  5 08:47:32 2020 GMT</span><br><span class=\"line\">            Not After : Nov  3 08:47:32 2030 GMT</span><br><span class=\"line\">        Subject: CN = kubernetes</span><br></pre></td></tr></table></figure></p>\n<p>2.查看当前集群证书相关信息<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo kubeadm alpha certs check-expiration</span><br><span class=\"line\">  <span class=\"comment\"># [check-expiration] Reading configuration from the cluster...</span></span><br><span class=\"line\">  <span class=\"comment\"># [check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY(认证中心)   EXTERNALLY MANAGED(外部管理)</span></span><br><span class=\"line\">  <span class=\"comment\"># admin.conf                 Nov 05, 2021 08:47 UTC   328d                                    no</span></span><br><span class=\"line\">  <span class=\"comment\"># apiserver                  Nov 05, 2021 08:47 UTC   328d            ca                      no</span></span><br><span class=\"line\">  <span class=\"comment\"># apiserver-etcd-client      Nov 05, 2021 08:47 UTC   328d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># apiserver-kubelet-client   Nov 05, 2021 08:47 UTC   328d            ca                      no</span></span><br><span class=\"line\">  <span class=\"comment\"># controller-manager.conf    Nov 05, 2021 08:47 UTC   328d                                    no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-healthcheck-client    Nov 05, 2021 08:47 UTC   328d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-peer                  Nov 05, 2021 08:47 UTC   328d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-server                Nov 05, 2021 08:47 UTC   328d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># front-proxy-client         Nov 05, 2021 08:47 UTC   328d            front-proxy-ca          no</span></span><br><span class=\"line\">  <span class=\"comment\"># scheduler.conf             Nov 05, 2021 08:47 UTC   328d                                    no</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span></span><br><span class=\"line\">  <span class=\"comment\"># ca                      Nov 03, 2030 08:47 UTC   9y              no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-ca                 Nov 03, 2030 08:47 UTC   9y              no</span></span><br><span class=\"line\">  <span class=\"comment\"># front-proxy-ca          Nov 03, 2030 08:47 UTC   9y              no</span></span><br></pre></td></tr></table></figure></p>\n<p>3.采用renew子命令刷新证书的到期时间进行续期<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/.k8s$ sudo kubeadm alpha certs renew all --config=./kubeadm-init-config.yaml</span><br><span class=\"line\">  <span class=\"comment\"># W1212 17:17:16.721037 1306627 configset.go:348] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed  # 嵌入在kubeconfig文件中的证书，供管理员使用，并对kubeadm本身进行更新 (admin.conf )</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate for serving the Kubernetes API renewed   # 更新Kubernetes API服务证书</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate the apiserver uses to access etcd renewed  # 服务器访问etcd所使用的证书已更新</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate for the API server to connect to kubelet renewed  # API服务器连接到kubelet的证书已更新</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate embedded in the kubeconfig file for the controller manager to use renewed  # 证书嵌入在kubeconfig文件中，供控制器管理器使用更新 (controller-manager.conf)</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate for liveness probes to healthcheck etcd renewed   # 健康检查etcd激活探针证书续期</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate for etcd nodes to communicate with each other renewed  # 用于etcd节点之间通信的证书更新</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate for serving etcd renewed   # 续期etcd“服务证书”</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate for the front proxy client renewed  # 前代理客户端的证书更新</span></span><br><span class=\"line\">  <span class=\"comment\"># certificate embedded in the kubeconfig file for the scheduler manager to use renewed #证书嵌入在kubeconfig文件中，供调度器管理器使用更新 (scheduler.conf  )</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 补充：如果环境里中etcd不是由Kubeadm创建并托管而是外部二进制部署的就不能采用此种方式更新etcd的证书</span></span><br><span class=\"line\"><span class=\"comment\"># 更新指定集群组件进行更新集群</span></span><br><span class=\"line\">~/.k8s$ kubeadm alpha certs renew</span><br><span class=\"line\">  <span class=\"comment\"># admin.conf                apiserver                 apiserver-kubelet-client  etcd-healthcheck-client   etcd-server               scheduler.conf</span></span><br><span class=\"line\">  <span class=\"comment\"># all                       apiserver-etcd-client     controller-manager.conf   etcd-peer                 front-proxy-client</span></span><br><span class=\"line\">kubeadm alpha certs renew apiserver --config=./kubeadmin-config.yaml</span><br><span class=\"line\">kubeadm alpha certs renew apiserver-kubelet-client --config=./kubeadmin-config.yaml</span><br><span class=\"line\">kubeadm alpha certs renew front-proxy-client --config=./kubeadmin-config.yaml</span><br></pre></td></tr></table></figure></p>\n<p>4.验证刷新证书后的到期时间以及证书文件属性查看<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/.k8s$ sudo kubeadm alpha certs check-expiration</span><br><span class=\"line\">  <span class=\"comment\"># [check-expiration] Reading configuration from the cluster...</span></span><br><span class=\"line\">  <span class=\"comment\"># [check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class=\"line\">  <span class=\"comment\"># PS -&gt; 显示顺序与上面刷新证书的顺序是一致的</span></span><br><span class=\"line\">  <span class=\"comment\"># CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span></span><br><span class=\"line\">  <span class=\"comment\"># admin.conf                 Dec 12, 2021 09:17 UTC   364d                                    no</span></span><br><span class=\"line\">  <span class=\"comment\"># apiserver                  Dec 12, 2021 09:17 UTC   364d            ca                      no</span></span><br><span class=\"line\">  <span class=\"comment\"># apiserver-etcd-client      Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># apiserver-kubelet-client   Dec 12, 2021 09:17 UTC   364d            ca                      no</span></span><br><span class=\"line\">  <span class=\"comment\"># controller-manager.conf    Dec 12, 2021 09:17 UTC   364d                                    no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-healthcheck-client    Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-peer                  Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-server                Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span></span><br><span class=\"line\">  <span class=\"comment\"># front-proxy-client         Dec 12, 2021 09:17 UTC   364d            front-proxy-ca          no</span></span><br><span class=\"line\">  <span class=\"comment\"># scheduler.conf             Dec 12, 2021 09:17 UTC   364d                                    no</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span></span><br><span class=\"line\">  <span class=\"comment\"># ca                      Nov 03, 2030 08:47 UTC   9y              no</span></span><br><span class=\"line\">  <span class=\"comment\"># etcd-ca                 Nov 03, 2030 08:47 UTC   9y              no</span></span><br><span class=\"line\">  <span class=\"comment\"># front-proxy-ca          Nov 03, 2030 08:47 UTC   9y              no</span></span><br><span class=\"line\"></span><br><span class=\"line\">/etc/kubernetes/pki$ <span class=\"built_in\">stat</span> apiserver.key</span><br><span class=\"line\">  <span class=\"comment\">#   File: apiserver.key</span></span><br><span class=\"line\">  <span class=\"comment\">#   Size: 1675            Blocks: 8          IO Block: 4096   regular file</span></span><br><span class=\"line\">  <span class=\"comment\"># Device: fd00h/64768d    Inode: 2099948     Links: 1</span></span><br><span class=\"line\">  <span class=\"comment\"># Access: (0600/-rw-------)  Uid: (    0/    root)   Gid: (    0/    root)</span></span><br><span class=\"line\">  <span class=\"comment\"># Access: 2020-12-12 20:30:32.703551276 +0800  最近访问：</span></span><br><span class=\"line\">  <span class=\"comment\"># Modify: 2020-12-12 17:17:17.055077737 +0800  最近更改：</span></span><br><span class=\"line\">  <span class=\"comment\"># Change: 2020-12-12 17:17:17.055077737 +0800  最近改动：</span></span><br><span class=\"line\">  <span class=\"comment\">#  Birth: -</span></span><br><span class=\"line\">/etc/kubernetes/pki$ <span class=\"built_in\">stat</span> apiserver.crt</span><br><span class=\"line\">  <span class=\"comment\">#   File: apiserver.crt</span></span><br><span class=\"line\">  <span class=\"comment\">#   Size: 1294            Blocks: 8          IO Block: 4096   regular file</span></span><br><span class=\"line\">  <span class=\"comment\"># Device: fd00h/64768d    Inode: 2099949     Links: 1</span></span><br><span class=\"line\">  <span class=\"comment\"># Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span></span><br><span class=\"line\">  <span class=\"comment\"># Access: 2020-12-12 17:19:54.202163815 +0800</span></span><br><span class=\"line\">  <span class=\"comment\"># Modify: 2020-12-12 17:17:17.099078602 +0800</span></span><br><span class=\"line\">  <span class=\"comment\"># Change: 2020-12-12 17:17:17.099078602 +0800</span></span><br><span class=\"line\">  <span class=\"comment\"># Birth: -</span></span><br></pre></td></tr></table></figure></p>\n<p>5.基于新证书重新生成各个组件的配置文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 主Master节点上运行生成各组件的配置文件</span></span><br><span class=\"line\">kubeadm alpha kubeconfig user --org system:masters --client-name kubernetes-admin  &gt; /etc/kubernetes/admin.conf</span><br><span class=\"line\">kubeadm alpha kubeconfig user --client-name system:kube-controller-manager &gt; /etc/kubernetes/controller-manager.conf</span><br><span class=\"line\">kubeadm alpha kubeconfig user --client-name system:kube-scheduler &gt; /etc/kubernetes/scheduler.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 要开始使用您的集群，您需要运行以下作为一个常规用户:</span></span><br><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3 )复制证书和配置文件到其他master</span></span><br><span class=\"line\">scp -r /etc/kubernetes/pki/* root@master@master-01:/etc/kubernetes/pki/</span><br><span class=\"line\">scp /etc/kubernetes/scheduler.conf root@master@master-01:/etc/kubernetes/</span><br><span class=\"line\">scp /etc/kubernetes/controller-manager.conf root@master@master-01:/etc/kubernetes/</span><br><span class=\"line\">scp /etc/kubernetes/admin.conf root@master@master-01:/etc/kubernetes/</span><br></pre></td></tr></table></figure></p>\n<p>6.重启kubelet组件,其他master同样重启kubelet和3个组件docker容器<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart kubelet</span><br><span class=\"line\"><span class=\"comment\"># docker容器重启controller、scheduler、apiserver3个组件</span></span><br><span class=\"line\"><span class=\"comment\"># docker restart</span></span><br></pre></td></tr></table></figure></p>\n<p>该脚本只处理master节点上的证书：kubeadm默认配置了kubelet证书自动更新，node节点kubelet.conf所指向的证书会自动更新</p>\n<p>小于v1.17版本的master初始化节点(执行kubeadm init的节点) kubelet.conf里的证书并不会自动更新，这算是一个bug，该脚本会一并处理更新master节点的kubelet.conf所包含的证书</p>\n<p>kubeadm生成的证书有效期为为1年，该脚本可将kubeadm生成的证书有效期更新为10年</p>\n<p>Kubernetes集群版本在更新时，就会自动更新apiserver.crt证书的使用期限，这可能也是k8s官方设置这一年期限的原因 —— 为了让使用者跟上版本更新的步伐。</p>\n<p>证书修改流程<br>由于k8s是基于kubeadm安装的，所以只需修改kubeadm源码中的证书期限即可。 kubeadm是采用go语言编写，所以我们要现在本机安装go语言环境，然后将对应版本的kubeadm源码进行修改，修改后重新编译，再用新编译的kubeadm生成新证书即可。</p>\n<h3 id=\"Kubeadm-etcd证书修改可用年限\"><a href=\"#Kubeadm-etcd证书修改可用年限\" class=\"headerlink\" title=\"Kubeadm/etcd证书修改可用年限\"></a>Kubeadm/etcd证书修改可用年限</h3><p>描述: 在Vallidity节点下Kubernetes有两种机制去创建证书，有一部分是1年的(<code>apiServer.key</code>)，有1部分是10年的比如我们的(<code>CA.CERT</code>); Kubernetes集群版本在更新时，就会自动更新apiserver.crt证书的使用期限，这可能也是k8s官方设置这一年期限的原因为了让使用者跟上版本更新的步伐。但是有一些公司就会选取一个稳定版本一直使用下去，这便会使用本节所介绍的内容如何修改证书的使用年限。</p>\n<p><strong>操作流程:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kub~$ kubectl version</span><br><span class=\"line\">Client Version: version.Info&#123;Major:<span class=\"string\">\"1\"</span>, Minor:<span class=\"string\">\"19\"</span>, GitVersion:<span class=\"string\">\"v1.19.3\"</span>, GitCommit:<span class=\"string\">\"1e11e4a2108024935ecfcb2912226cedeafd99df\"</span>, GitTreeState:<span class=\"string\">\"clean\"</span>, BuildDate:<span class=\"string\">\"2020-10-14T12:50:19Z\"</span>, GoVersion:<span class=\"string\">\"go1.15.2\"</span>, Compiler:<span class=\"string\">\"gc\"</span>, Platform:<span class=\"string\">\"linux/amd64\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; git checkout -b remotes/origin/release-1.19.3 v1.19.3                                             master [2bd115e3648]</span><br><span class=\"line\">切换到一个新分支 <span class=\"string\">'remotes/origin/release-1.19.3'</span></span><br><span class=\"line\"></span><br><span class=\"line\">weiyigeek@Ubuntu-PC:~/app/program/go/src/k8s.io/kubernetes</span><br><span class=\"line\">&gt; vim staging/src/k8s.io/client-go/util/cert/cert.go                         remotes/origin/release-1.19.3 [1e11e4a2108]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">38 const duration365d = time.Hour * 24 * 365 </span><br><span class=\"line\">56 // NewSelfSignedCACert creates a CA certificate</span><br><span class=\"line\">57 func NewSelfSignedCACert(cfg Config, key crypto.Signer) (*x509.Certificate, error) &#123;</span><br><span class=\"line\">65                 NotBefore:             now.UTC(),</span><br><span class=\"line\">66                 NotAfter:              now.Add(duration365d * 10).UTC(),</span><br><span class=\"line\"></span><br><span class=\"line\">86 // GenerateSelfSignedCertKeyWithFixtures creates a self-signed certificate and key <span class=\"keyword\">for</span> the given host.</span><br><span class=\"line\">94 func GenerateSelfSignedCertKeyWithFixtures(host string, alternateIPs []net.IP, alternateDNS []string, fixtureDirector    y string) ([]byte, []byte, error) &#123;</span><br><span class=\"line\">96         maxAge := time.Hour * 24 * 365 * 10     // one year self-signed certs</span><br><span class=\"line\">123                 NotBefore: validFrom,</span><br><span class=\"line\">124                 NotAfter:  validFrom.Add(maxAge),</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// NewSignedCert creates a signed certificate using the given CA certificate and key</span><br><span class=\"line\">func NewSignedCert(cfg *CertConfig, key crypto.Signer, caCert *x509.Certificate, caKey crypto.Signer) (*x509.Certificate, error) &#123;</span><br><span class=\"line\">const duration365d = time.Hour * 24 * 365 * 10</span><br><span class=\"line\"></span><br><span class=\"line\">591                 NotBefore:    caCert.NotBefore,</span><br><span class=\"line\">592                 NotAfter:     time.Now().Add(duration365d).UTC(),</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> 结果在这里找到kubeadmconstants.CertificateValidity的定义</span><br><span class=\"line\">vim cmd/kubeadm/app/util/pkiutil/pki_helpers.go</span><br><span class=\"line\"><span class=\"comment\"># 这个方法里面看到NotAfter:     time.Now().Add(kubeadmconstants.CertificateValidity).UTC()</span></span><br><span class=\"line\"><span class=\"comment\"># 参数里面是一个常量kubeadmconstants.CertificateValidity</span></span><br><span class=\"line\"><span class=\"comment\"># 所以这里可以不修改，我去看看源码能不能找到这个常量的赋值位置</span></span><br><span class=\"line\">// CertificateValidity defines the validity <span class=\"keyword\">for</span> all the signed certificates generated by kubeadm</span><br><span class=\"line\">        CertificateValidity = time.Hour * 24 * 365 * 10</span><br><span class=\"line\">        NotBefore:    caCert.NotBefore,</span><br><span class=\"line\">        NotAfter:     time.Now().Add(kubeadmconstants.CertificateValidity).UTC(),</span><br><span class=\"line\"></span><br><span class=\"line\">vim ./cmd/kubeadm/app/constants/constants.go</span><br><span class=\"line\">const (</span><br><span class=\"line\">        // KubernetesDir is the directory Kubernetes owns <span class=\"keyword\">for</span> storing various configuration files</span><br><span class=\"line\">        KubernetesDir = <span class=\"string\">\"/etc/kubernetes\"</span></span><br><span class=\"line\">        // ManifestsSubDirName defines directory name to store manifests</span><br><span class=\"line\">        ManifestsSubDirName = <span class=\"string\">\"manifests\"</span></span><br><span class=\"line\">        // TempDirForKubeadm defines temporary directory <span class=\"keyword\">for</span> kubeadm</span><br><span class=\"line\">        // should be joined with KubernetesDir.</span><br><span class=\"line\">        TempDirForKubeadm = <span class=\"string\">\"tmp\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        // CertificateValidity defines the validity <span class=\"keyword\">for</span> all the signed certificates generated by kubeadm</span><br><span class=\"line\">        CertificateValidity = time.Hour * 24 * 365 * 10</span><br><span class=\"line\"></span><br><span class=\"line\">        // CACertAndKeyBaseName defines certificate authority base name</span><br><span class=\"line\">        CACertAndKeyBaseName = <span class=\"string\">\"ca\"</span></span><br><span class=\"line\">        // CACertName defines certificate name</span><br><span class=\"line\">        CACertName = <span class=\"string\">\"ca.crt\"</span></span><br><span class=\"line\">        // CAKeyName defines certificate name</span><br><span class=\"line\">        CAKeyName = <span class=\"string\">\"ca.key\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        // APIServerCertAndKeyBaseName defines API<span class=\"string\">'s server certificate and key base name</span></span><br><span class=\"line\"><span class=\"string\">        APIServerCertAndKeyBaseName = \"apiserver\"</span></span><br><span class=\"line\"><span class=\"string\">        // APIServerCertName defines API'</span>s server certificate name</span><br><span class=\"line\">        APIServerCertName = <span class=\"string\">\"apiserver.crt\"</span></span><br><span class=\"line\">        // APIServerKeyName defines API<span class=\"string\">'s server key name</span></span><br><span class=\"line\"><span class=\"string\">        APIServerKeyName = \"apiserver.key\"</span></span><br><span class=\"line\"><span class=\"string\">        // APIServerCertCommonName defines API'</span>s server certificate common name (CN)</span><br><span class=\"line\">        APIServerCertCommonName = <span class=\"string\">\"kube-apiserver\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        // APIServerKubeletClientCertAndKeyBaseName defines kubelet client certificate and key base name</span><br><span class=\"line\">        APIServerKubeletClientCertAndKeyBaseName = <span class=\"string\">\"apiserver-kubelet-client\"</span></span><br><span class=\"line\">        // APIServerKubeletClientCertName defines kubelet client certificate name</span><br><span class=\"line\">        APIServerKubeletClientCertName = <span class=\"string\">\"apiserver-kubelet-client.crt\"</span></span><br><span class=\"line\">        // APIServerKubeletClientKeyName defines kubelet client key name</span><br><span class=\"line\">        APIServerKubeletClientKeyName = <span class=\"string\">\"apiserver-kubelet-client.key\"</span></span><br><span class=\"line\">        // APIServerKubeletClientCertCommonName defines kubelet client certificate common name (CN)</span><br><span class=\"line\">        APIServerKubeletClientCertCommonName = <span class=\"string\">\"kube-apiserver-kubelet-client\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        // EtcdCACertAndKeyBaseName defines etcd<span class=\"string\">'s CA certificate and key base name</span></span><br><span class=\"line\"><span class=\"string\">        EtcdCACertAndKeyBaseName = \"etcd/ca\"</span></span><br><span class=\"line\"><span class=\"string\">        // EtcdCACertName defines etcd'</span>s CA certificate name</span><br><span class=\"line\">        EtcdCACertName = <span class=\"string\">\"etcd/ca.crt\"</span></span><br><span class=\"line\">        // EtcdCAKeyName defines etcd<span class=\"string\">'s CA key name</span></span><br><span class=\"line\"><span class=\"string\">        EtcdCAKeyName = \"etcd/ca.key\"</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        // EtcdServerCertAndKeyBaseName defines etcd'</span>s server certificate and key base name</span><br><span class=\"line\">        EtcdServerCertAndKeyBaseName = <span class=\"string\">\"etcd/server\"</span></span><br><span class=\"line\">        // EtcdServerCertName defines etcd<span class=\"string\">'s server certificate name</span></span><br><span class=\"line\"><span class=\"string\">        EtcdServerCertName = \"etcd/server.crt\"</span></span><br><span class=\"line\"><span class=\"string\">        // EtcdServerKeyName defines etcd'</span>s server key name</span><br><span class=\"line\">        EtcdServerKeyName = <span class=\"string\">\"etcd/server.key\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编译kubeadm, 这里主要编译kubeadm 即可</span></span><br><span class=\"line\">make WHAT=cmd/kubeadm GOFLAGS=-v</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">weiyigeek@master:~$ sudo cp /usr/bin/kubeadm&#123;,.bak&#125;</span><br><span class=\"line\">sudo cp kubeadm /usr/bin/</span><br><span class=\"line\"></span><br><span class=\"line\">weiyigeek@master:~$ kubeadm version</span><br><span class=\"line\">kubeadm version: &amp;version.Info&#123;Major:<span class=\"string\">\"\"</span>, Minor:<span class=\"string\">\"\"</span>, GitVersion:<span class=\"string\">\"v0.0.0-master+1e11e4a210802\"</span>, GitCommit:<span class=\"string\">\"1e11e4a2108024935ecfcb2912226cedeafd99df\"</span>, GitTreeState:<span class=\"string\">\"\"</span>, BuildDate:<span class=\"string\">\"1970-01-01T00:00:00Z\"</span>, GoVersion:<span class=\"string\">\"go1.15.5\"</span>, Compiler:<span class=\"string\">\"gc\"</span>, Platform:<span class=\"string\">\"linux/amd64\"</span>&#125;</span><br><span class=\"line\">weiyigeek@master:~$ kubeadm.bak version</span><br><span class=\"line\">kubeadm version: &amp;version.Info&#123;Major:<span class=\"string\">\"1\"</span>, Minor:<span class=\"string\">\"19\"</span>, GitVersion:<span class=\"string\">\"v1.19.3\"</span>, GitCommit:<span class=\"string\">\"1e11e4a2108024935ecfcb2912226cedeafd99df\"</span>, GitTreeState:<span class=\"string\">\"clean\"</span>, BuildDate:<span class=\"string\">\"2020-10-14T12:47:53Z\"</span>, GoVersion:<span class=\"string\">\"go1.15.2\"</span>, Compiler:<span class=\"string\">\"gc\"</span>, Platform:<span class=\"string\">\"linux/amd64\"</span>&#125;</span><br><span class=\"line\">weiyigeek@master:~/.k8s$ kubeadm alpha certs check-expiration</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[check-expiration] FYI: You can look at this config file with <span class=\"string\">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class=\"line\"></span><br><span class=\"line\">CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class=\"line\">admin.conf                 Dec 12, 2021 09:17 UTC   364d                                    no</span><br><span class=\"line\">apiserver                  Dec 12, 2021 09:17 UTC   364d            ca                      no</span><br><span class=\"line\">apiserver-etcd-client      Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span><br><span class=\"line\">apiserver-kubelet-client   Dec 12, 2021 09:17 UTC   364d            ca                      no</span><br><span class=\"line\">controller-manager.conf    Dec 12, 2021 09:17 UTC   364d                                    no</span><br><span class=\"line\">etcd-healthcheck-client    Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span><br><span class=\"line\">etcd-peer                  Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span><br><span class=\"line\">etcd-server                Dec 12, 2021 09:17 UTC   364d            etcd-ca                 no</span><br><span class=\"line\">front-proxy-client         Dec 12, 2021 09:17 UTC   364d            front-proxy-ca          no</span><br><span class=\"line\">scheduler.conf             Dec 12, 2021 09:17 UTC   364d                                    no</span><br><span class=\"line\"></span><br><span class=\"line\">CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class=\"line\">ca                      Nov 03, 2030 08:47 UTC   9y              no</span><br><span class=\"line\">etcd-ca                 Nov 03, 2030 08:47 UTC   9y              no</span><br><span class=\"line\">front-proxy-ca          Nov 03, 2030 08:47 UTC   9y              no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm alpha certs renew all --config=/root/kubeadm-config.yaml </span><br><span class=\"line\">weiyigeek@master:~/.k8s$ sudo kubeadm alpha certs renew all --config=kubeadm-init-config.yaml</span><br><span class=\"line\">W1213 13:42:52.803441 2059631 configset.go:348] WARNING: kubeadm cannot validate component configs <span class=\"keyword\">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class=\"line\">certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the admin to use and <span class=\"keyword\">for</span> kubeadm itself renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> serving the Kubernetes API renewed</span><br><span class=\"line\">certificate the apiserver uses to access etcd renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> the API server to connect to kubelet renewed</span><br><span class=\"line\">certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the controller manager to use renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> liveness probes to healthcheck etcd renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> etcd nodes to communicate with each other renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> serving etcd renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> the front proxy client renewed</span><br><span class=\"line\">certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the scheduler manager to use renewed</span><br><span class=\"line\">weiyigeek@master:~/.k8s$ sudo kubeadm alpha certs check-expiration</span><br><span class=\"line\">[check-expiration] Reading configuration from the cluster...</span><br><span class=\"line\">[check-expiration] FYI: You can look at this config file with <span class=\"string\">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class=\"line\"></span><br><span class=\"line\">CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class=\"line\">admin.conf                 Dec 11, 2030 05:42 UTC   9y                                      no</span><br><span class=\"line\">apiserver                  Dec 11, 2030 05:42 UTC   9y              ca                      no</span><br><span class=\"line\">apiserver-etcd-client      Dec 11, 2030 05:42 UTC   9y              etcd-ca                 no</span><br><span class=\"line\">apiserver-kubelet-client   Dec 11, 2030 05:42 UTC   9y              ca                      no</span><br><span class=\"line\">controller-manager.conf    Dec 11, 2030 05:42 UTC   9y                                      no</span><br><span class=\"line\">etcd-healthcheck-client    Dec 11, 2030 05:42 UTC   9y              etcd-ca                 no</span><br><span class=\"line\">etcd-peer                  Dec 11, 2030 05:42 UTC   9y              etcd-ca                 no</span><br><span class=\"line\">etcd-server                Dec 11, 2030 05:42 UTC   9y              etcd-ca                 no</span><br><span class=\"line\">front-proxy-client         Dec 11, 2030 05:42 UTC   9y              front-proxy-ca          no</span><br><span class=\"line\">scheduler.conf             Dec 11, 2030 05:42 UTC   9y                                      no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">openssl x509 -<span class=\"keyword\">in</span> apiserver.crt -text -noout | grep Not</span><br><span class=\"line\"></span><br><span class=\"line\">⒎HA集群其余 mater节点证书更新</span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash </span></span><br><span class=\"line\">masterNode=<span class=\"string\">\"192.168.66.20 192.168.66.21\"</span></span><br><span class=\"line\"><span class=\"comment\">#for host in $&#123;masterNode&#125;; do</span></span><br><span class=\"line\"><span class=\"comment\"># scp /etc/kubernetes/pki/&#123;ca.crt,ca.key,sa.key,sa.pub,front-proxy-ca.crt,front-proxy-ca.key&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># \"$&#123;USER&#125;\"@$host:/etc/kubernetes/pki/ </span></span><br><span class=\"line\"><span class=\"comment\"># scp /etc/kubernetes/pki/etcd/&#123;ca.crt,ca.key&#125; \"root\"@$host:/etc/kubernetes/pki/etcd </span></span><br><span class=\"line\"><span class=\"comment\"># scp /etc/kubernetes/admin.conf \"root\"@$host:/etc/kubernetes/ </span></span><br><span class=\"line\"><span class=\"comment\">#done </span></span><br><span class=\"line\"><span class=\"keyword\">for</span> host <span class=\"keyword\">in</span> <span class=\"variable\">$&#123;CONTROL_PLANE_IPS&#125;</span>; <span class=\"keyword\">do</span> </span><br><span class=\"line\">    scp /etc/kubernetes/pki/&#123;ca.crt,ca.key,sa.key,sa.pub,front-proxy-ca.crt,front-proxy-ca.key&#125; </span><br><span class=\"line\"><span class=\"string\">\"<span class=\"variable\">$&#123;USER&#125;</span>\"</span>@<span class=\"variable\">$host</span>:/root/pki/ </span><br><span class=\"line\">    scp /etc/kubernetes/pki/etcd/&#123;ca.crt,ca.key&#125; <span class=\"string\">\"root\"</span>@<span class=\"variable\">$host</span>:/root/etcd </span><br><span class=\"line\">    scp /etc/kubernetes/admin.conf <span class=\"string\">\"root\"</span>@<span class=\"variable\">$host</span>:/root/kubernetes/ </span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<p>入坑出坑</p>\n<p>问题 : Unable to connect to the server: x509: certificate has expired or is not yet valid<br>故障描述: 使用kubeadm部署的集群，在运行了一年之后今天，出现k8s api无法调取的现象，使用kubectl命令获取资源均返回如下报错<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Unable to connect to the server: x509: certificate has expired or is not yet valid</span><br></pre></td></tr></table></figure><br>故障原因: 由于默认的apiserver.crt证书有效期只有一年其错误信息表示证书到期无法正常使用；<br>解决办法: 现在证书过期的问题已经发生了，只能通过更换证书的办法解决，在github上有详细的说明 issue链接如下:<br><a href=\"https://github.com/kubernetes/kubeadm/issues/581\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/kubeadm/issues/581</a></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"k8s","path":"api/tags/k8s.json"}]}