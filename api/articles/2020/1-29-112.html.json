{"title":"企业内部NTP服务器基础安装与配置使用","slug":"系统运维/Application/Sync/企业NTP服务器基础安装与配置使用","date":"2020-01-29T05:34:30.000Z","updated":"2022-05-21T02:48:56.103Z","url":"2020/1-29-112.html","path":"api/articles/2020/1-29-112.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200514161355.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200514164454.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200115144000.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210319143801.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><h3 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h3><p>简介:NTP 是网络时间协议 (Network Time Protocol)是用来使网络中的各个计算机时间同步的一种协议。它的用途是把计算机的时钟同步到世界协调UTC，其精度在局域网内可达0.1ms，在互联网绝大多数的地方其精义可达1-50ms。</p>\n<p>例如: 您在更新数据库或者分析日志时，时间顺序对结果有很大影响。为避免在实例上运行业务时出现逻辑混乱和网络请求错误等问题，您需要统一相关实例的时区设置。另外您还可以通过NTP服务同步网络中所有服务器的本地时间。 </p>\n<p><strong>应用场景</strong></p>\n<ul>\n<li>1) 在进行Linux运维以及同步的应用安装和使用都要求，双方的时间是需要保持一致的，而常常小型的服务器群是没有自己的NTP服务器的，这时候我们就需要采用外网的NTP服务器进行时间的同步和校对;</li>\n<li>2) 一般企业出于安全或者出口带宽等各方面原因内网主机是无法直接接通外网，通过企业内部自建时间服务器可以让内网无法上网的机器同步本机时间，而本机可以通过公网同步公网的ntp源(<code>实现类似中转跳转的功能</code>)</li>\n</ul>\n<p>Tips: 简单的说就是对时间精度要求高的应用和主机需要使用到时间同步服务器;</p>\n<p><strong>名词解析</strong></p>\n<ul>\n<li>(1) 在Linux系统中存在两个时钟时间，分别是<code>硬件时钟RTC（Real Time Clock）</code>和<code>系统时钟（System Clock）</code><ul>\n<li>硬件时钟是指的在主板上的时钟设备，也就是通常可以在BIOS画面设置的时钟，即使关机状态也可以计算时间。</li>\n<li>系统时钟则是指Kernel中的时钟，其值是由1970年1月1日00:00:00 UTC时间至当前时间所经历的秒数总和。当Linux启动的时候，系统时钟会读取硬件时钟的设定，之后系统时钟独立运作。长时间运行两者可能将会产生误差。另外所有的Linux相关指令都是读取系统时钟指定的，如 date 可以使用 timedatectl  查看两者时间。</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"服务方式\"><a href=\"#服务方式\" class=\"headerlink\" title=\"服务方式\"></a>服务方式</h3><p>描述: 即 ntpd 与 Chrony 服务（CentOS上自带客户端）以及 systemd-timesyncd (Ubuntu 18.04 以上自带) 等几种服务方式的搭建与配置。</p>\n<p>Tips: NTP 是仍在使用中的最古老的网络传输协议之一（1985 年前开始）。<br>Tips: NTP服务的通信端口为UDP 123, 所以在服务之前请确保您的防火墙已经打开 <code>UDP 123</code> 端口的通信;</p>\n<p><br></p>\n<h3 id=\"公共-NTP-服务器\"><a href=\"#公共-NTP-服务器\" class=\"headerlink\" title=\"公共 NTP 服务器\"></a>公共 NTP 服务器</h3><p>描述: 阿里云提供了内网和公网NTP服务器，用于同步各网络中ECS实例的本地时间。</p>\n<p>Tips: </p>\n<ul>\n<li>China - cn.pool.ntp.org: To use this specific pool zone, add the following to your ntp.conf file:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server 0.cn.pool.ntp.org</span><br><span class=\"line\">server 1.cn.pool.ntp.org</span><br><span class=\"line\">server 2.cn.pool.ntp.org</span><br><span class=\"line\">server 3.cn.pool.ntp.org</span><br></pre></td></tr></table></figure></li>\n<li>云服务器ECS为您提供了高精度的时间参考NTP服务器，其中<code>ntp.cloud.aliyuncs.com</code>服务器在地域级别上提供原子参考钟服务，适用于金融、通讯、科研和天文等以时间精度核心的生产行业<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">阿里巴巴公共系统服务: https://developer.aliyun.com/mirror</span><br><span class=\"line\">ntp.aliyun.com</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>经典网络内网</th>\n<th>专有网络VPC内网</th>\n<th>公网</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-</td>\n<td>ntp.cloud.aliyuncs.com</td>\n<td>ntp1.aliyun.com</td>\n</tr>\n<tr>\n<td>ntp1.cloud.aliyuncs.com</td>\n<td>ntp7.cloud.aliyuncs.com</td>\n<td>ntp2.aliyun.com</td>\n</tr>\n<tr>\n<td>ntp2.cloud.aliyuncs.com</td>\n<td>ntp8.cloud.aliyuncs.com</td>\n<td>ntp3.aliyun.com</td>\n</tr>\n<tr>\n<td>ntp3.cloud.aliyuncs.com</td>\n<td>ntp9.cloud.aliyuncs.com</td>\n<td>ntp4.aliyun.com</td>\n</tr>\n<tr>\n<td>ntp4.cloud.aliyuncs.com</td>\n<td>ntp10.cloud.aliyuncs.com</td>\n<td>ntp5.aliyun.com</td>\n</tr>\n<tr>\n<td>ntp5.cloud.aliyuncs.com</td>\n<td>ntp11.cloud.aliyuncs.com</td>\n<td>ntp6.aliyun.com</td>\n</tr>\n<tr>\n<td>ntp6.cloud.aliyuncs.com</td>\n<td>ntp12.cloud.aliyuncs.com</td>\n<td>ntp7.aliyun.com</td>\n</tr>\n</tbody>\n</table>\n<p>Tips:</p>\n<ul>\n<li>腾讯云 : <a href=\"https://cloud.tencent.com/document/product/213/30392\" target=\"_blank\" rel=\"noopener\">https://cloud.tencent.com/document/product/213/30392</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server time1.cloud.tencent.com</span><br><span class=\"line\">server time2.cloud.tencent.com</span><br><span class=\"line\">server time3.cloud.tencent.com</span><br><span class=\"line\">server time4.cloud.tencent.com</span><br><span class=\"line\">server time5.cloud.tencent.com</span><br></pre></td></tr></table></figure></li>\n<li>China - 高校与网络中心<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">级\t域名\t地理位置\t负责人\t邮件\t电话</span><br><span class=\"line\">1\ts1a.time.edu.cn\t北京邮电大学\t王振华\twzhdl at bupt.edu.cn\t010-62283044-8003</span><br><span class=\"line\">1\ts1b.time.edu.cn\t清华大学\t尹惠实\tyhs at cernet.edu.cn\t010-62795818-6105</span><br><span class=\"line\">1\ts1c.time.edu.cn\t北京大学\t马皓\tmah at pku.edu.cn\t010-62753007</span><br><span class=\"line\">1\ts1d.time.edu.cn\t东南大学\t徐加羚\tjlxu at njnet.edu.cn\t025-3794342-309</span><br><span class=\"line\">1\ts1e.time.edu.cn\t清华大学\t尹惠实\tyhs at cernet.edu.cn\t010-62795818-6105</span><br><span class=\"line\">2\ts2a.time.edu.cn\t清华大学\t尹惠实\tyhs at cernet.edu.cn\t010-62795818-6105</span><br><span class=\"line\">2\ts2b.time.edu.cn\t清华大学\t尹惠实\tyhs at cernet.edu.cn\t010-62795818-6105</span><br><span class=\"line\">2\ts2c.time.edu.cn\t北京邮电大学\t王振华\twzhdl at bupt.edu.cn\t010-62283044-8003</span><br><span class=\"line\">2\ts2d.time.edu.cn\t西南地区网络中心\t董茜\tappletung at uestc.edu.cn\t028-61830330</span><br><span class=\"line\">2\ts2e.time.edu.cn\t西北地区网络中心\t丁惠宁\tdhn at xanet.edu.cn\t029-2669037</span><br><span class=\"line\">2\ts2f.time.edu.cn\t东北地区网络中心\t毛宇\tmaoy at neu.edu.cn\t024-23966854</span><br><span class=\"line\">2\ts2g.time.edu.cn\t华东南地区网络中心\t瞿庆海\tqqh at sjtu.edu.cn\t021-62932901-8101</span><br><span class=\"line\">2\ts2h.time.edu.cn\t四川大学网络管理中心\t郑炳伦\tzhengbl at scu.edu.cn\t028-85414820</span><br><span class=\"line\">2\ts2j.time.edu.cn\t大连理工大学网络中心\t于广辉\tygh at dlut.edu.cn\t0411-4708642</span><br><span class=\"line\">2\ts2k.time.edu.cn\tCERNET桂林主节点\t胡进坤\tjinkun at mailbox.gxnu.edu.cn\t0773-5845246</span><br><span class=\"line\">2\ts2m.time.edu.cn\t北京大学\t马皓\tmah at pku.edu.cn\t010-62753007</span><br></pre></td></tr></table></figure></li>\n<li>Windows自带: time.windows.com</li>\n<li>macOS自带: time.apple.com</li>\n<li>Google Public NTP : <a href=\"https://developers.google.com/time\" target=\"_blank\" rel=\"noopener\">https://developers.google.com/time</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 支持IPv6</span></span><br><span class=\"line\">time.google.com</span><br><span class=\"line\">server time1.google.com</span><br><span class=\"line\">server time2.google.com</span><br><span class=\"line\">server time3.google.com</span><br><span class=\"line\">server time4.google.com</span><br></pre></td></tr></table></figure></li>\n<li>Cloudflare: time.cloudflare.com</li>\n<li>Qualcomm® 位置 （XTRA 预测卫星数据服务）: time.izatcloud.net</li>\n</ul>\n<hr>\n<h2 id=\"0x01-服务器安装配置\"><a href=\"#0x01-服务器安装配置\" class=\"headerlink\" title=\"0x01 服务器安装配置\"></a>0x01 服务器安装配置</h2><h3 id=\"1-NTP-服务\"><a href=\"#1-NTP-服务\" class=\"headerlink\" title=\"(1) NTP 服务\"></a>(1) NTP 服务</h3><h4 id=\"Ubuntu\"><a href=\"#Ubuntu\" class=\"headerlink\" title=\"Ubuntu\"></a>Ubuntu</h4><p><strong>安装环境:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ lsb_release -a</span><br><span class=\"line\">  <span class=\"comment\"># No LSB modules are available.</span></span><br><span class=\"line\">  <span class=\"comment\"># Distributor ID: Ubuntu</span></span><br><span class=\"line\">  <span class=\"comment\"># Description:    Ubuntu 20.04.1 LTS</span></span><br><span class=\"line\">  <span class=\"comment\"># Release:        20.04</span></span><br><span class=\"line\">  <span class=\"comment\"># Codename:       focal</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>安装流程:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 防火墙配置123/udp</span></span><br><span class=\"line\">sudo ufw allow 123/udp</span><br><span class=\"line\"><span class=\"comment\"># Rules updated</span></span><br><span class=\"line\"><span class=\"comment\"># Rules updated (v6)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 安装NTP</span></span><br><span class=\"line\">sudo apt install ntp -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 设置NTP server</span></span><br><span class=\"line\">cp /etc/ntp.conf&#123;,.bak&#125;</span><br><span class=\"line\">tee /etc/ntp.conf &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">driftfile /var/lib/ntp/ntp.drift</span><br><span class=\"line\">leapfile /usr/share/zoneinfo/leap-seconds.list</span><br><span class=\"line\"></span><br><span class=\"line\">server ntp1.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp2.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp3.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\"></span><br><span class=\"line\">restrict -4 default kod notrap nomodify nopeer noquery</span><br><span class=\"line\">restrict -6 default kod notrap nomodify nopeer noquery</span><br><span class=\"line\"></span><br><span class=\"line\">restrict 192.168.12.254 nomodify notrap nopeer noquery</span><br><span class=\"line\">restrict 127.0.0.1</span><br><span class=\"line\">restrict ::1</span><br><span class=\"line\"></span><br><span class=\"line\">restrict <span class=\"built_in\">source</span> notrap nomodify noquery</span><br><span class=\"line\">restrict ntp.aliyun.com nomodify notrap  noquery</span><br><span class=\"line\">pool ntp.aliyun.com</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 重启服务&amp;查看状态&amp;开机自启</span></span><br><span class=\"line\">sudo systemctl restart ntp</span><br><span class=\"line\">sudo systemctl status ntp</span><br><span class=\"line\">  <span class=\"comment\"># ● ntp.service - Network Time Service</span></span><br><span class=\"line\">  <span class=\"comment\">#     Loaded: loaded (/lib/systemd/system/ntp.service; enabled; vendor preset: enabled)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Active: active (running) since Fri 2021-03-19 11:51:19 CST; 2s ago</span></span><br><span class=\"line\">  <span class=\"comment\">#       Docs: man:ntpd(8)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Process: 31997 ExecStart=/usr/lib/ntp/ntp-systemd-wrapper (code=exited, status=0/SUCCESS)</span></span><br><span class=\"line\">  <span class=\"comment\">#   Main PID: 32015 (ntpd)</span></span><br><span class=\"line\">  <span class=\"comment\">#       Tasks: 2 (limit: 9450)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Memory: 1.7M</span></span><br><span class=\"line\">  <span class=\"comment\">#     CGroup: /system.slice/ntp.service</span></span><br><span class=\"line\">  <span class=\"comment\">#             └─32015 /usr/sbin/ntpd -p /var/run/ntpd.pid -g -u 112:117</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Mar 19 11:51:19 dns-server ntpd[32015]: Listen and drop on 0 v6wildcard [::]:123</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 19 11:51:19 dns-server ntpd[32015]: Listen and drop on 1 v4wildcard 0.0.0.0:123</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 19 11:51:19 dns-server ntpd[32015]: Listen normally on 2 lo 127.0.0.1:123</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 19 11:51:19 dns-server ntpd[32015]: Listen normally on 3 ens160 192.168.12.254:123</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 19 11:51:19 dns-server ntpd[32015]: Listen normally on 4 lo [::1]:123</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 19 11:51:19 dns-server ntpd[32015]: Listen normally on 5 ens160 [fe80::250:56ff:fe8a:69b4%2]:123</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 19 11:51:19 dns-server ntpd[32015]: Listening on routing socket on fd #22 for interface updates</span></span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> ntpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 验证监听情况</span></span><br><span class=\"line\">~$ netstat -ulnp | grep <span class=\"string\">\":123\"</span></span><br><span class=\"line\">  <span class=\"comment\"># (Not all processes could be identified, non-owned process info</span></span><br><span class=\"line\">  <span class=\"comment\"># will not be shown, you would have to be root to see it all.)</span></span><br><span class=\"line\">  <span class=\"comment\"># udp        0      0 192.168.12.254:123      0.0.0.0:*                           -</span></span><br><span class=\"line\">  <span class=\"comment\"># udp        0      0 127.0.0.1:123           0.0.0.0:*                           -</span></span><br><span class=\"line\">  <span class=\"comment\"># udp        0      0 0.0.0.0:123             0.0.0.0:*                           -</span></span><br><span class=\"line\">  <span class=\"comment\"># udp6       0      0 fe80::250:56ff:fe8a:123 :::*                                -</span></span><br><span class=\"line\">  <span class=\"comment\"># udp6       0      0 ::1:123                 :::*                                -</span></span><br><span class=\"line\">  <span class=\"comment\"># udp6       0      0 :::123                  :::*                                -</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 测试效果</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"Asia/Shanghai\"</span> &gt; /etc/timezone</span><br><span class=\"line\">sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\">sudo hwclock --systohc  <span class=\"comment\"># 写入硬件之中</span></span><br><span class=\"line\">sudo timedatectl <span class=\"built_in\">set</span>-local-rtc 0</span><br><span class=\"line\">~$ sudo date --s=<span class=\"string\">\"2019-09-04 17:30:00\"</span></span><br><span class=\"line\">Wed 04 Sep 2019 05:30:00 PM CST</span><br><span class=\"line\">~$ systemctl restart ntp</span><br><span class=\"line\">~$ date  <span class=\"comment\"># 等待10s后会发现已同步</span></span><br><span class=\"line\">Fri 19 Mar 2021 03:25:42 PM CST</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"2-Chrony-服务\"><a href=\"#2-Chrony-服务\" class=\"headerlink\" title=\"(2) Chrony 服务\"></a>(2) Chrony 服务</h3><p>描述:由于Redhat8系列的发行版本默认采用Chrony而废弃了ntpd,所以下面主要讲解一下chrony相关的配置;<br>Chrony是NTP（<code>Network Time Protocol，网络时间协议，服务器时间同步的一种协议</code>）的另一种实现与ntpd不同，它可以更快且更准确地同步系统时钟，最大程度的减少时间和频率误差。</p>\n<p>chrony有三个时间参考：<code>硬件时钟、实时时钟以及手动同步</code>。</p>\n<p><strong>Chrony包括两个核心组件：</strong></p>\n<ul>\n<li>chronyd:一个后台运行的守护进程，用于调整内核中运行的系统时钟与NTP服务器同步(<code>它确定服务器增减时间的比率，并对此进行调整补偿</code>)</li>\n<li>chronyc:提供用户界面，用于监控性能并进行多样化的配置(<code>它可以在chronyd实例控制的服务器上工作，也可以在一台不同的远程服务器上工作</code>)</li>\n</ul>\n<p>Tips : 关于NTP客户端的替代品Chrony说明<br>答: Chrony可以更快地同步系统时钟，提高时间精度，对于一直不在线的系统尤其有用，同时chronyd较小，它使用较少的内存，只在必要时才唤醒CPU，这样可以更好地节省电能，即使网络拥塞较长时间，它也能很好地运行。</p>\n<p><br></p>\n<h4 id=\"CentOS\"><a href=\"#CentOS\" class=\"headerlink\" title=\"CentOS\"></a>CentOS</h4><p><strong>需求分析与环境:</strong><br>描述: 内网有一台NTP Server向阿里云提供的公网NTP服务器同步时间，并且作为内网NTP Server内网中的其它NTP Client服务器向其同步时间;</p>\n<table>\n<thead>\n<tr>\n<th>IP</th>\n<th>主机名</th>\n<th>时间同步方式</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.1.146</td>\n<td>ntp-server</td>\n<td>chronyd服务平滑同步</td>\n</tr>\n<tr>\n<td>192.168.1.147</td>\n<td>ntp-client1</td>\n<td>chronyd服务平滑同步</td>\n</tr>\n<tr>\n<td>&lt;!– 192.168.1.148</td>\n<td>ntp-client2</td>\n<td>crontab+ntpdate强制同步 –&gt;</td>\n</tr>\n</tbody>\n</table>\n<p><strong>补充说明:</strong></p>\n<ul>\n<li>以上基于Cent7.7以上的发行版本</li>\n<li>使用chronyd服务平滑同步时间的方式要优于crontab + ntpdate原因如下:<ul>\n<li>因为ntpdate同步时间会造成<code>时间的跳跃</code>,对一些依赖时间的程序和服务会造成影响，例如<code>sleep、timer</code>等，且chronyd服务可以在修正时间的过程中同时修正CPU tick。</li>\n</ul>\n</li>\n<li>默认开放端口<code>127.0.0.1:323-UDP</code> 注意NTP服务器的开放端口为UDP-123</li>\n</ul>\n<p><strong>基础配置流程:</strong></p>\n<ul>\n<li><p>Step1.内网 NTP Server 相关配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 0.关闭防火墙,如果不想关闭防火墙可以放通端口</span></span><br><span class=\"line\">firewall-cmd --permanent --add-port=123/udp</span><br><span class=\"line\">firewall-cmd --permanent --add-port=123/tcp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#1.主机名设置</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname ntp-server</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"192.168.1.146 ntp-server\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.重新登录终端并查看当前时间</span></span><br><span class=\"line\">hostname &amp;&amp; date</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.安装chrony由于我的机器已安装和centos8自带则可以不用自行安装</span></span><br><span class=\"line\">yum -y install chrony</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.备份原始/etc/chrony.conf文件并修改</span></span><br><span class=\"line\">mv /etc/chrony.conf&#123;,.bak&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#5.配置文件修改与说明</span></span><br><span class=\"line\">cat &gt;/etc/chrony.conf&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># 指定上层NTP服务器为阿里云提供的公网NTP服务器</span></span><br><span class=\"line\"><span class=\"comment\"># Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class=\"line\"><span class=\"comment\"># server 0.centos.pool.ntp.org iburst  #缺省默认</span></span><br><span class=\"line\">server ntp1.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp2.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp3.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp4.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp5.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp6.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp7.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 记录系统时钟获得/丢失时间的速率至drift文件中</span></span><br><span class=\"line\">driftfile /var/lib/chrony/drift</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果系统时钟的偏移量大于10秒，则允许在前三次更新中步进调整系统时钟</span></span><br><span class=\"line\">makestep 1.0 3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启用RTC（实时时钟）的内核同步</span></span><br><span class=\"line\">rtcsync</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Allow NTP client access from local network.</span></span><br><span class=\"line\"><span class=\"comment\"># 允许同步时间的客户端网段</span></span><br><span class=\"line\">allow 192.168.1.0/24</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Serve time even if not synchronized to a time source.</span></span><br><span class=\"line\"><span class=\"comment\"># 当阿里云提供的公网NTP服务器不可用时，采用本地时间作为同步标准</span></span><br><span class=\"line\"><span class=\"built_in\">local</span> stratum 10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定包含NTP验证密钥的文件:Specify file containing keys for NTP authentication.</span></span><br><span class=\"line\">keyfile /etc/chrony.keys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定存放日志文件的目录:Specify directory for log files.</span></span><br><span class=\"line\">logdir /var/<span class=\"built_in\">log</span>/chrony</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Enable hardware timestamping on all interfaces that support it.</span></span><br><span class=\"line\"><span class=\"comment\"># 在支持它的所有接口上启用硬件时间戳。</span></span><br><span class=\"line\"><span class=\"comment\">#hwtimestamp *</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Increase the minimum number of selectable sources required to adjust the system clock.</span></span><br><span class=\"line\"><span class=\"comment\"># 增加调整系统时钟所需的可选源的最小数目。</span></span><br><span class=\"line\"><span class=\"comment\">#minsources 2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 记录信息的选择:Select which information is logged.</span></span><br><span class=\"line\"><span class=\"comment\">#log measurements statistics tracking</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">备注：详细指令参数可以使用命令<span class=\"comment\"># man chrony.conf查看</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#6.启动与查看chronyd服务</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> chronyd.service &amp;&amp; systemctl restart chronyd.service &amp;&amp;  systemctl status chronyd.service</span><br><span class=\"line\">ss -tunlp | grep chronyd</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200514161355.png\" alt=\"WeiyiGeek.chronyd\" title=\"\" class=\"\">\n                <p>WeiyiGeek.chronyd</p>\n            </figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#7.查看时间同步源：</span></span><br><span class=\"line\">chronyc sources -v</span><br><span class=\"line\"><span class=\"comment\"># 210 Number of sources = 2 #来源数量</span></span><br><span class=\"line\"><span class=\"comment\">#   .-- Source mode(模式)  '^' = server, '=' = peer, '#' = local clock.</span></span><br><span class=\"line\"><span class=\"comment\">#  / .- Source state(状态) '*' = current synced, '+' = combined , '-' = not combined,</span></span><br><span class=\"line\"><span class=\"comment\"># | /   '?' = unreachable, 'x' = time may be in error, '~' = time too variable.</span></span><br><span class=\"line\"><span class=\"comment\"># ||                                                 .- xxxx [ yyyy ] +/- zzzz</span></span><br><span class=\"line\"><span class=\"comment\"># ||      Reachability register (octal) -.           |  xxxx = adjusted offset,</span></span><br><span class=\"line\"><span class=\"comment\"># || Log2(Polling interval|轮询间隔) --.  |          |  yyyy = measured offset,</span></span><br><span class=\"line\"><span class=\"comment\"># ||                                \\     |          |  zzzz = estimated error.</span></span><br><span class=\"line\"><span class=\"comment\"># ||                                 |    |           \\</span></span><br><span class=\"line\"><span class=\"comment\"># MS Name/IP address         Stratum Poll Reach LastRx Last sample</span></span><br><span class=\"line\"><span class=\"comment\"># ===============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># ^* 120.25.115.20 (正常)          2   4    17     1   -118us[+2986us] +/-   17ms</span></span><br><span class=\"line\"><span class=\"comment\"># ^- 203.107.6.88  (正常)          2   4    17     1  -7270us[-7270us] +/-   33ms</span></span><br><span class=\"line\">备注：120.25.115.20为ntp1.aliyun.com域名解析后的地址，203.107.6.88为ntp2.aliyun.com~ntp7.aliyun.com域名解析后的地址</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#8.查看时间同步源状态:</span></span><br><span class=\"line\">chronyc sourcestats -v</span><br><span class=\"line\"><span class=\"comment\"># 210 Number of sources = 2 #来源数量</span></span><br><span class=\"line\"><span class=\"comment\">#                              .- Number of sample points in measurement set.</span></span><br><span class=\"line\"><span class=\"comment\">#                             /    .- Number of residual runs with same sign.</span></span><br><span class=\"line\"><span class=\"comment\">#                            |    /    .- Length of measurement set (time).</span></span><br><span class=\"line\"><span class=\"comment\">#                            |   |    /      .- Est. clock freq error (ppm).</span></span><br><span class=\"line\"><span class=\"comment\">#                            |   |   |      /           .- Est. error in freq.</span></span><br><span class=\"line\"><span class=\"comment\">#                            |   |   |     |           /         .- Est. offset.</span></span><br><span class=\"line\"><span class=\"comment\">#                            |   |   |     |          |          |   On the -.</span></span><br><span class=\"line\"><span class=\"comment\">#                            |   |   |     |          |          |   samples. \\</span></span><br><span class=\"line\"><span class=\"comment\">#                            |   |   |     |          |          |             |</span></span><br><span class=\"line\"><span class=\"comment\"># Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># 120.25.115.20              16  11   201     -1.609     17.452  +1817us  1128us</span></span><br><span class=\"line\"><span class=\"comment\"># 203.107.6.88               16  10   201     +4.291     31.560  -3671us  2106us</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 9.设置硬件时间</span></span><br><span class=\"line\"><span class=\"comment\"># 硬件时间默认为UTC：</span></span><br><span class=\"line\">timedatectl <span class=\"built_in\">set</span>-local-rtc 0</span><br><span class=\"line\"><span class=\"comment\"># 启用NTP时间同步：</span></span><br><span class=\"line\">timedatectl <span class=\"built_in\">set</span>-ntp yes</span><br><span class=\"line\"><span class=\"comment\"># 校准时间服务器：</span></span><br><span class=\"line\">chronyc tracking</span><br></pre></td></tr></table></figure>\n<p>备注：可直接输入命令chronyc进入交互式模式详细使用方法可以使用命令# man chronyd和# man chronyc查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 常用指令说明</span></span><br><span class=\"line\">-  <span class=\"built_in\">help</span>：查看完整的命令帮助列表</span><br><span class=\"line\">-  tracking：显示系统时间信息</span><br><span class=\"line\">-  activity：检查多少NTP源在线/离线</span><br><span class=\"line\">-  add server：手动添加一台新的NTP服务器</span><br><span class=\"line\">-  delete：手动移除NTP服务器或对等服务器</span><br><span class=\"line\">-  accheck：检查NTP访问是否对特定主机可用</span><br><span class=\"line\">-  clients：在客户端报告已访问到的服务器</span><br><span class=\"line\"></span><br><span class=\"line\">$ chronyc</span><br><span class=\"line\"><span class=\"comment\"># chronyc&gt; tracking</span></span><br><span class=\"line\"><span class=\"comment\"># Reference ID    : 78197314 (120.25.115.20)</span></span><br><span class=\"line\"><span class=\"comment\"># Stratum         : 3</span></span><br><span class=\"line\"><span class=\"comment\"># Ref time (UTC)  : Thu May 14 08:19:56 2020</span></span><br><span class=\"line\"><span class=\"comment\"># System time     : 0.000818836 seconds slow of NTP time</span></span><br><span class=\"line\"><span class=\"comment\"># Last offset     : -0.000368672 seconds</span></span><br><span class=\"line\"><span class=\"comment\"># RMS offset      : 0.000605058 seconds</span></span><br><span class=\"line\"><span class=\"comment\"># Frequency       : 12.746 ppm fast</span></span><br><span class=\"line\"><span class=\"comment\"># Residual freq   : -0.245 ppm</span></span><br><span class=\"line\"><span class=\"comment\"># Skew            : 6.550 ppm</span></span><br><span class=\"line\"><span class=\"comment\"># Root delay      : 0.030892739 seconds</span></span><br><span class=\"line\"><span class=\"comment\"># Root dispersion : 0.001810989 seconds</span></span><br><span class=\"line\"><span class=\"comment\"># Update interval : 64.4 seconds</span></span><br><span class=\"line\"><span class=\"comment\"># Leap status     : Normal</span></span><br><span class=\"line\"><span class=\"comment\"># chronyc&gt; accheck</span></span><br><span class=\"line\"><span class=\"comment\"># Could not read address</span></span><br><span class=\"line\"><span class=\"comment\"># chronyc&gt; clients</span></span><br><span class=\"line\"><span class=\"comment\"># Hostname                      NTP   Drop Int IntL Last     Cmd   Drop Int  Last</span></span><br><span class=\"line\"><span class=\"comment\"># ===============================================================================</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step2.NTP Client配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装chrony</span></span><br><span class=\"line\">yum -y install chrony &amp;&amp; mv /etc/chrony.conf /etc/chrony.conf.bak</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置chrony.cnf</span></span><br><span class=\"line\">cat &gt;/etc/chrony.conf&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">server 192.168.10.254 iburst</span><br><span class=\"line\">server ntp1.aliyun.com iburst</span><br><span class=\"line\">driftfile /var/lib/chrony/drift</span><br><span class=\"line\">makestep 1.0 3</span><br><span class=\"line\"><span class=\"built_in\">local</span> stratum 10</span><br><span class=\"line\">rtcsync</span><br><span class=\"line\">logdir /var/<span class=\"built_in\">log</span>/chrony</span><br><span class=\"line\"><span class=\"comment\">#keyfile /etc/chrony.keys</span></span><br><span class=\"line\"><span class=\"comment\">#stratumweight 0.05</span></span><br><span class=\"line\"><span class=\"comment\">#noclientlog</span></span><br><span class=\"line\"><span class=\"comment\">#logchange 0.5</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动chronyd服务</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> chronyd.service &amp;&amp; systemctl restart chronyd.service &amp;&amp; ss -tunlp | grep chronyd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看时间同步源以及同步状态</span></span><br><span class=\"line\">chronyc sources -v &amp;&amp; chronyc sourcestats -v</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200514164454.png\" alt=\"WeiyiGeek.Client\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Client</p>\n            </figure>\n</li>\n</ul>\n<ul>\n<li>Step3.测试是否配置成功<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Client</span></span><br><span class=\"line\">$ date -s <span class=\"string\">'-1year'</span></span><br><span class=\"line\">$ date 012000002019.00</span><br><span class=\"line\">2019年 01月 20日 星期日 00:00:00 CST</span><br><span class=\"line\">$ systemctl restart chronyd  <span class=\"comment\">#重启后大约三秒进行时间同步</span></span><br><span class=\"line\">$ date</span><br><span class=\"line\">2019年 01月 20日 星期日 00:00:55 CST</span><br><span class=\"line\">$ date</span><br><span class=\"line\">2019年 01月 20日 星期日 00:00:57 CST</span><br><span class=\"line\">$ date</span><br><span class=\"line\">2019年 01月 20日 星期日 00:00:58 CST</span><br><span class=\"line\">$ date</span><br><span class=\"line\">2020年 05月 14日 星期四 16:58:20 CST</span><br><span class=\"line\">$ date</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#上面是手动下面我们可以将该命令写入timesync.sh加入到crond中每三分钟同步一次</span></span><br><span class=\"line\">crond -e</span><br><span class=\"line\">*/3 * * * * sh timesync.sh</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"3-systemd-timesyncd-服务\"><a href=\"#3-systemd-timesyncd-服务\" class=\"headerlink\" title=\"(3) systemd-timesyncd 服务\"></a>(3) systemd-timesyncd 服务</h3><p>描述: 在 Ubuntu 20.04 TLS中安装chrony进行时间同步时报出如下错误 <code>systemd-timesyncd provides time-daemon and is present and installed.</code>, 发现了在 ubuntu，debian，openSUSE 等系统其实自带时间同步 systemd-timesyncd 服务，下面主要针对这个进行介绍;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dpkg -i chrony_3.5-6ubuntu6.2_amd64.deb</span><br><span class=\"line\">dpkg: regarding chrony_3.5-6ubuntu6.2_amd64.deb containing chrony:</span><br><span class=\"line\"> chrony conflicts with time-daemon</span><br><span class=\"line\">  systemd-timesyncd provides time-daemon and is present and installed.</span><br><span class=\"line\">dpkg: error processing archive chrony_3.5-6ubuntu6.2_amd64.deb (--install):</span><br><span class=\"line\"> conflicting packages - not installing chrony</span><br><span class=\"line\">Errors were encountered <span class=\"keyword\">while</span> processing:</span><br><span class=\"line\"> chrony_3.5-6ubuntu6.2_amd64.deb</span><br></pre></td></tr></table></figure></p>\n<p><strong>简单介绍:</strong><br>描述: systemd-timesyncd 是一个 利用远程NTP(Network Time Protocol)服务器同步本地系统时间的系统服务。 该服务还会在每次同步成功之后， 将获取到的时间保存到磁盘上， 以尽可能保证 下一次系统启动时所获得的时间是单调递增的， 即使在一个没有电池供电RTC(real time clock)的主机上也是如此。</p>\n<p>systemd-timesyncd 仅遵守简单网络时间协议(Simple Network Time protocol)。 对于较大的时间差，此服务只会简单粗暴的将系统时钟直接设置为正确的值； 对于较小的时间差，此服务才会温和平滑的微调系统时钟到正确的值。 如果需要应对复杂场景下的时间调整， 请不要使用 systemd-timesyncd 。</p>\n<p>。我们可在/etc/systemd/timesyncd.conf 中配置你的（时间）服务器，大多数 Linux 发行版都提供了一个默认配置，它指向发行版维护的时间服务器上。</p>\n<p>Tips : systemd-timesyncd 是断点式更新时间，也就是时间不同立即更新，这样会对某些服务产生影响，所以在生产环境尽量不要用(推荐使用chrony)，在桌面环境或者是系统刚开机时来进行时间同步还是很好的。timesyncd 替代了 ntpd 的客户端的部分。默认情况下 timesyncd 会定期检测并同步时间。它还会在本地存储更新的时间，以便在系统重启时做时间单步调整。如果是虚拟机环境，应该把与主机时间同步功能关闭后在启用systemd-timesyncd，否则可能会有问题，systemd-timesyncd只能作为客户端，不能作为NTP服务器，要成为NTP服务器，可以安装chrony、ntpd或者open-ntp。</p>\n<p>Tips : systemd-timesyncd只会更改系统时间不会更改硬件时间，可以通过<code>hwclock -w</code>命令将系统时间同步到硬件时间</p>\n<p><br></p>\n<p><strong>配置与使用</strong></p>\n<ul>\n<li><p>1.systemd-timesyncd 启动时会读取 /etc/systemd/timesyncd.conf 配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /etc/systemd/timesyncd.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Time]</span><br><span class=\"line\"><span class=\"comment\"># 空格分隔的NTP服务器列表,依次尝试列表中的每个NTP服务器直到同步成功为止。</span></span><br><span class=\"line\">NTP=ntp.aliyun.com ntp1.aliyun.com</span><br><span class=\"line\"><span class=\"comment\"># 空格分隔的NTP服务器列表,用作备用NTP服务器。</span></span><br><span class=\"line\">FallbackNTP=ntp.ubuntu.com</span><br><span class=\"line\"><span class=\"comment\"># 最大可接受的\"root distance\"秒数(最大误差)</span></span><br><span class=\"line\">RootDistanceMaxSec=5</span><br><span class=\"line\"><span class=\"comment\"># NTP消息的最小/最大轮询间隔秒数(PollIntervalMinSec 必须不小于 16 秒)</span></span><br><span class=\"line\">PollIntervalMinSec=32</span><br><span class=\"line\">PollIntervalMaxSec=2048</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.修改后重启systemd-timesyncd服务生效并查看服务状态</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart systemd-timesyncd.service  &amp;&amp; systemctl status systemd-timesyncd.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.通过timedatectl命令查看时钟是否启动NTP同步，如果未开启NTP同步则采用<code>timedatectl set-ntp 1</code>进行启用。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ timedatectl</span><br><span class=\"line\">Local time: 三 2021-07-14 10:29:18 CST       <span class=\"comment\"># 本地时间</span></span><br><span class=\"line\">  Universal time: 三 2021-07-14 02:29:18 UTC <span class=\"comment\"># 协调世界时</span></span><br><span class=\"line\">        RTC time: 三 2021-07-14 02:29:18     <span class=\"comment\"># 硬件时间</span></span><br><span class=\"line\">       Time zone: Asia/Shanghai (CST, +0800) <span class=\"comment\"># 时区，我这里为东8区</span></span><br><span class=\"line\">     NTP enabled: yes                        <span class=\"comment\"># NTP时间同步是否开启，yes表示是</span></span><br><span class=\"line\">NTP synchronized: yes                        <span class=\"comment\"># 如果和远程NTP服务器成功同步，显示为yes</span></span><br><span class=\"line\"> RTC <span class=\"keyword\">in</span> <span class=\"built_in\">local</span> TZ: no                         <span class=\"comment\"># no表示硬件时钟设置为协调世界时（UTC），yes表示硬件时钟设置为本地时间</span></span><br><span class=\"line\">      DST active: n/a                        <span class=\"comment\"># 分布式时钟</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4.在systemd 239及更高版本上（例如，它在Ubuntu 18.04上不起作用，因为它使用systemd 237），您可以使用以下命令显示 systemd-timesyncd 状态 <code>timedatectl show-timesync</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 查看时间同步</span></span><br><span class=\"line\">$ timedatectl show-timesync</span><br><span class=\"line\">SystemNTPServers=192.168.10.254</span><br><span class=\"line\">FallbackNTPServers=192.168.4.254</span><br><span class=\"line\">ServerName=192.168.10.254</span><br><span class=\"line\">ServerAddress=192.168.10.254</span><br><span class=\"line\">RootDistanceMaxUSec=5s</span><br><span class=\"line\">PollIntervalMinUSec=32s</span><br><span class=\"line\">PollIntervalMaxUSec=34min 8s</span><br><span class=\"line\">PollIntervalUSec=34min 8s</span><br><span class=\"line\"><span class=\"comment\"># 同步状态</span></span><br><span class=\"line\">NTPMessage=&#123; Leap=0, Version=4, Mode=4, Stratum=3, Precision=-23, RootDelay=25.955ms, RootDispersion=25.772ms, Reference=78197314, OriginateTimestamp=Wed 2021-07-14 10:27:02 CST, ReceiveTimestamp=Wed 2021-07-14 10:27:02 CST, TransmitTimestamp=Wed 2021-07-14 10:27:02 CST, DestinationTimestamp=Wed 2021-07-14 10:27:02 CST, Ignored=no PacketCount=6, Jitter=10.499ms &#125;</span><br><span class=\"line\">Frequency=1531722</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 查看时间同步状态</span></span><br><span class=\"line\">$ timedatectl timesync-status</span><br><span class=\"line\">       Server: 192.168.10.254 (192.168.10.254)</span><br><span class=\"line\">Poll interval: 34min 8s (min: 32s; max 34min 8s)</span><br><span class=\"line\">         Leap: normal</span><br><span class=\"line\">      Version: 4</span><br><span class=\"line\">      Stratum: 3</span><br><span class=\"line\">    Reference: 78197314</span><br><span class=\"line\">    Precision: 1us (-23)</span><br><span class=\"line\">Root distance: 38.749ms (max: 5s)</span><br><span class=\"line\">       Offset: +11.983ms</span><br><span class=\"line\">        Delay: 1.304ms</span><br><span class=\"line\">       Jitter: 10.499ms</span><br><span class=\"line\"> Packet count: 6</span><br><span class=\"line\">    Frequency: +23.372ppm</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x02-NTP客户端配置\"><a href=\"#0x02-NTP客户端配置\" class=\"headerlink\" title=\"0x02 NTP客户端配置\"></a>0x02 NTP客户端配置</h2><h3 id=\"Windows-服务器\"><a href=\"#Windows-服务器\" class=\"headerlink\" title=\"Windows 服务器\"></a>Windows 服务器</h3><p>描述: 为了保证NTP服务配置成功后能正常同步时间，实例中必须开启NTP服务，Windows Server操作系统默认开启Windows Time服务</p>\n<p>1.选择 开始 &gt; 所有程序 &gt; 附件 &gt; 运行，打开运行对话框，并运行命令<code>services.msc</code>。</p>\n<p>2.在服务对话框中，找到并双击Windows Time服务，十分重要否则报错同步连接超时。</p>\n<p>3.在Windows Time的属性（本地计算机）对话框中，执行以下操作：<code>将启动类型设置为自动，确认服务状态为已启动。如果不是，单击启动。</code></p>\n<p>4.修改服务器默认NTP服务器地址为:ntp.aliyun.com</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200115144000.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br/></p>\n<p><strong>Q: 如何修改NTP服务时间同步间隔？</strong><br>答:NTP服务的时间同步间隔默认是5分钟，您可以根据业务需求自定义同步间隔;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#注册表编辑器: </span></span><br><span class=\"line\">HKEY_LOCAL_MACHINE &gt; SYSTEM &gt; CurrentControlSet &gt; services &gt; W32Time &gt; TimeProviders &gt; NtpClient </span><br><span class=\"line\">并双击SpecialPollInterval键值,填入的数值即是您需要的同步时间间隔（单位为秒）</span><br></pre></td></tr></table></figure>\n<p>Tips: 在编辑 DWORD (32 位）值对话框中，在基数栏里选择十进制，并按需要填写数值数据。</p>\n<p><br></p>\n<h3 id=\"Linux-服务器\"><a href=\"#Linux-服务器\" class=\"headerlink\" title=\"Linux 服务器\"></a>Linux 服务器</h3><p>描述: 在Linux系统中您可以<code>通过ntpdate和ntpd</code> 两种命令方式实现NTP时间同步两种方式的异同；</p>\n<ul>\n<li><code>ntpdate ntp.aliyun.com</code> 为<code>断点更新</code>，在最新安装系统的时候或者没有业务运行的情况下;</li>\n<li><code>ntpd ntp.aliyun.com</code> 为<code>步进式地</code>逐渐调整时间。对已经承载有运行中业务的实例建议您使用<code>ntpd</code>同步时间;</li>\n</ul>\n<p>以root身份打开并编辑时区配置文件:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo rm /etc/localtime  <span class=\"comment\">#删除系统里的当地时间链接</span></span><br><span class=\"line\">ls /usr/share/zoneinfo  <span class=\"comment\">#查询时区列表Shanghai为列表条目之一。</span></span><br><span class=\"line\">sudo vi /etc/sysconfig/clock <span class=\"comment\">#用vim打开并编辑配置文件/etc/sysconfig/clock。</span></span><br><span class=\"line\">输入i添加时区城市。例如添加Zone=Asia/Shanghai，按下Esc键退出编辑并输入:wq保存并退出。</span><br><span class=\"line\">sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  <span class=\"comment\">#更新时区修改内容。</span></span><br><span class=\"line\">hwclock -w  <span class=\"comment\">#更新硬件时钟（RTC）。</span></span><br><span class=\"line\"><span class=\"comment\">#验证执行命令date -R查看时区信息是否生效，未生效可按照上述步骤重新操作一遍。</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>启用NTP服务</p>\n<ol>\n<li>执行命令<code>ntpstat</code>查看是否启用了NTP服务。</li>\n<li>执行命令sudo vi /etc/ntp.conf用vim打开并编辑NTP服务配置文件。</li>\n<li>新添加一行NTP服务器信息格式为：server 您需要添加的NTP服务器 iburst</li>\n<li>执行命令<code>sudo service ntpd start</code>运行NTP服务。</li>\n<li>执行命令<code>chkconfig ntpd on</code>启用NTP服务。</li>\n<li><strong>可选：</strong> 执行命令 <code>ntpq -p</code> 可查看NTP服务对等端的列表信息执行命令<code>sudo chkconfig --list ntpd</code>可查看NTP服务的运行级别。</li>\n</ol>\n<p><br></p>\n<p>Tips: 如果计划任务有时间同步，先注释两种用法会冲突。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关闭 ntpdate 方式同步</span></span><br><span class=\"line\">$ crontab -e</span><br><span class=\"line\"><span class=\"comment\"># time sync by oldboy at 2010-2-1</span></span><br><span class=\"line\"><span class=\"comment\">#*/5 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启用 ntpd 方式同步</span></span><br><span class=\"line\">/etc/init.d/ntpd start</span><br><span class=\"line\">ntpq -p</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x04-配置解析-amp-验证\"><a href=\"#0x04-配置解析-amp-验证\" class=\"headerlink\" title=\"0x04 配置解析&amp;验证\"></a>0x04 配置解析&amp;验证</h2><h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><h4 id=\"etc-ntp-conf\"><a href=\"#etc-ntp-conf\" class=\"headerlink\" title=\"/etc/ntp.conf\"></a>/etc/ntp.conf</h4><p>描述: ntpd 根据配置文件 (<code>/etc/ntp.conf</code>) 的参数决定是要为其他服务器提供时钟服务或者是从其他服务器同步时钟。</p>\n<p><strong>配置文件:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/ntp.conf, configuration for ntpd; see ntp.conf(5) for help</span></span><br><span class=\"line\">driftfile /var/lib/ntp/ntp.drift</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 由tzdata提供的闰秒定义</span></span><br><span class=\"line\"><span class=\"comment\"># Leap seconds definition provided by tzdata</span></span><br><span class=\"line\">leapfile /usr/share/zoneinfo/leap-seconds.list</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果希望记录统计数据，请启用此选项。</span></span><br><span class=\"line\"><span class=\"comment\">#statsdir /var/log/ntpstats/</span></span><br><span class=\"line\">statistics loopstats peerstats clockstats</span><br><span class=\"line\">filegen loopstats file loopstats <span class=\"built_in\">type</span> day <span class=\"built_in\">enable</span></span><br><span class=\"line\">filegen peerstats file peerstats <span class=\"built_in\">type</span> day <span class=\"built_in\">enable</span></span><br><span class=\"line\">filegen clockstats file clockstats <span class=\"built_in\">type</span> day <span class=\"built_in\">enable</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 请指定一个或多个NTP服务器。 - Specify one or more NTP servers.</span></span><br><span class=\"line\"><span class=\"comment\"># Use servers from the NTP Pool Project. Approved by Ubuntu Technical Board</span></span><br><span class=\"line\"><span class=\"comment\"># on 2011-02-08 (LP: #104525). See http://www.pool.ntp.org/join.html for</span></span><br><span class=\"line\"><span class=\"comment\"># more information.</span></span><br><span class=\"line\"><span class=\"comment\">#pool 0.ubuntu.pool.ntp.org iburst</span></span><br><span class=\"line\"><span class=\"comment\">#pool 1.ubuntu.pool.ntp.org iburst</span></span><br><span class=\"line\"><span class=\"comment\">#pool 2.ubuntu.pool.ntp.org iburst</span></span><br><span class=\"line\"><span class=\"comment\">#pool 3.ubuntu.pool.ntp.org iburst</span></span><br><span class=\"line\">server ntp1.aliyun.com iburst</span><br><span class=\"line\">server ntp2.aliyun.com iburst</span><br><span class=\"line\">server 0.cn.pool.ntp.org iburst</span><br><span class=\"line\">server 1.cn.pool.ntp.org iburst</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用Ubuntu的ntp服务器作为后备。</span></span><br><span class=\"line\"><span class=\"comment\"># Use Ubuntu's ntp server as a fallback.</span></span><br><span class=\"line\">pool ntp.ubuntu.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Access control configuration; see /usr/share/doc/ntp-doc/html/accopt.html for</span></span><br><span class=\"line\"><span class=\"comment\"># details.  The web page &lt;http://support.ntp.org/bin/view/Support/AccessRestrictions&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># might also be helpful.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意“restrict”同时适用于服务器和客户端 所以是一个配置</span></span><br><span class=\"line\"><span class=\"comment\"># 可能会阻止来自某些客户端的请求也可能会结束</span></span><br><span class=\"line\"><span class=\"comment\"># up阻塞来自你自己的上游服务器的回复。</span></span><br><span class=\"line\"><span class=\"comment\"># 默认情况下与所有人交换时间但不允许配置。</span></span><br><span class=\"line\">restrict -4 default kod notrap nomodify nopeer noquery </span><br><span class=\"line\">restrict -6 default kod notrap nomodify nopeer noquery</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Local users may interrogate the ntp server more closely.</span></span><br><span class=\"line\"><span class=\"comment\"># 当前节点IP地址</span></span><br><span class=\"line\">restrict 192.168.10.1 nomodify notrap nopeer noquery</span><br><span class=\"line\"><span class=\"comment\">#集群所在网段的网关（Gateway），子网掩码（Genmask）</span></span><br><span class=\"line\">restrict 192.168.10.1 mask 255.255.255.0 nomodify notrap  </span><br><span class=\"line\">restrict 192.168.12.254 nomodify notrap nopeer noquery</span><br><span class=\"line\">restrict 127.0.0.1</span><br><span class=\"line\">restrict ::1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Needed for adding pool entries</span></span><br><span class=\"line\">restrict <span class=\"built_in\">source</span> notrap nomodify noquery</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Clients from this (example!) subnet have unlimited access, but only if</span></span><br><span class=\"line\"><span class=\"comment\"># cryptographically authenticated.</span></span><br><span class=\"line\"><span class=\"comment\"># restrict 192.168.123.0 mask 255.255.255.0 notrust</span></span><br><span class=\"line\"><span class=\"comment\"># 集群所在网段的网关（Gateway），子网掩码（Genmask）</span></span><br><span class=\"line\">restrict 192.168.12.61 mask 255.255.255.0 nomodify notrap </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果要为本地子网提供时间，请更改下一行。</span></span><br><span class=\"line\"><span class=\"comment\"># (Again, the address is an example only.)</span></span><br><span class=\"line\">broadcast 192.168.12.255</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果你想在你的本地子网上收听时间广播，取消注释</span></span><br><span class=\"line\"><span class=\"comment\"># next lines.  Please do this only if you trust everybody on the network!</span></span><br><span class=\"line\"><span class=\"comment\">#disable auth</span></span><br><span class=\"line\"><span class=\"comment\">#broadcastclient</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>配置文件说明：</strong></p>\n<ul>\n<li><p>restrict 选项格式</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- restrict [ 客户端IP ]  mask  [ IP掩码 ]  [参数]</span><br><span class=\"line\"><span class=\"comment\"># 操作对象:</span></span><br><span class=\"line\">“客户端IP” 和 “IP掩码” 指定了对网络中哪些范围的计算机进行控制，如果使用default关键字则表示对所有的计算机进行控制.</span><br><span class=\"line\"><span class=\"comment\"># 参数：</span></span><br><span class=\"line\">* kod： 向不安全的访问者发送 Kiss-Of-Death 报文。</span><br><span class=\"line\">* ignore：拒绝连接到NTP服务器。</span><br><span class=\"line\">* nomodify： 客户端不能更改服务端的时间参数，但是客户端可以通过服务端进行网络校时。</span><br><span class=\"line\">* noquery： 不提供客户端的时间查询。</span><br><span class=\"line\">* notrap： 不提供<span class=\"built_in\">trap</span>远程登录功能，<span class=\"built_in\">trap</span>服务是一种远程时间日志服务。</span><br><span class=\"line\">* notrust： 客户端除非通过认证，否则该客户端来源将被视为不信任子网 。</span><br><span class=\"line\">* nopeer： 提供时间服务，但不作为对等体。</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>server 选项格式</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- server host  [ key n ] [ version n ] [ prefer ] [ mode n ] [ minpoll n ] [ maxpoll n ] [ iburst ]</span><br><span class=\"line\"><span class=\"comment\"># 参数:</span></span><br><span class=\"line\">- host ：是上层NTP服务器的IP地址或域名</span><br><span class=\"line\">* key： 表示所有发往服务器的报文包含有秘钥加密的认证信息，n是32位的整数，表示秘钥号。</span><br><span class=\"line\">* version： 表示发往上层服务器的报文使用的版本号，n默认是3，可以是1或者2。</span><br><span class=\"line\">* prefer： 如果有多个server选项，具有该参数的服务器有限使用。</span><br><span class=\"line\">* mode： 指定数据报文mode字段的值。</span><br><span class=\"line\">* minpoll： 指定与查询该服务器的最小时间间隔为2的n次方秒，n默认为6，范围为4-14。</span><br><span class=\"line\">* maxpoll：  指定与查询该服务器的最大时间间隔为2的n次方秒，n默认为10，范围为4-14。</span><br><span class=\"line\">* iburst： 当初始同步请求时，采用突发方式接连发送8个报文，时间间隔为2秒。</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>fudge 选项格式:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 参数: </span></span><br><span class=\"line\">- stratum : 即层次根据上层server的层次而设定(+1) 对于提供 `network time service provider` 的主机来说 stratum 的设定要尽可能准确。而作为局域网的 `time service provider `通常将`stratum` 设置为10，其取值范围是0-15;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>补充说明:</strong><br>描述: 0 层的服务器采用的是原子钟、GPS钟等物理设备，stratum 1 与 stratum 0 是直接相连的，往后的stratum 与上一层 stratum 通过网络相连同一层的 server 也可以交互。</p>\n<p>Tips: ntpd 对下层 client 来说是 service server，对于上层 server 来说它是client。</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210319143801.png\" alt=\"WeiyiGeek.同步示意图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.同步示意图</p>\n            </figure>\n<p><br/></p>\n<p><strong>配置示例:</strong></p>\n<p>例如: 快速配置阿里巴巴 <code>OPSX NTP</code> 服务编辑文件 “/etc/ntp.conf”，根据情况修改文件内容为：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">driftfile  &#x2F;var&#x2F;lib&#x2F;ntp&#x2F;drift</span><br><span class=\"line\">pidfile   &#x2F;var&#x2F;run&#x2F;ntpd.pid</span><br><span class=\"line\">logfile &#x2F;var&#x2F;log&#x2F;ntp.log</span><br><span class=\"line\">restrict    default kod nomodify notrap nopeer noquery</span><br><span class=\"line\">restrict -6 default kod nomodify notrap nopeer noquery</span><br><span class=\"line\">restrict 127.0.0.1</span><br><span class=\"line\">server 127.127.1.0</span><br><span class=\"line\">fudge  127.127.1.0 stratum 10</span><br><span class=\"line\">server ntp.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">restrict ntp.aliyun.com nomodify notrap nopeer noquery</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>例如，腾讯云服务器中,默认的<code>/etc/ntp.conf</code>文件内容如下,注意 tencentyun.com 是内网地址。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">driftfile /var/lib/ntp/ntp.drift</span><br><span class=\"line\">statistics loopstats peerstats clockstats</span><br><span class=\"line\">filegen loopstats file loopstats <span class=\"built_in\">type</span> day <span class=\"built_in\">enable</span></span><br><span class=\"line\">filegen peerstats file peerstats <span class=\"built_in\">type</span> day <span class=\"built_in\">enable</span></span><br><span class=\"line\">filegen clockstats file clockstats <span class=\"built_in\">type</span> day <span class=\"built_in\">enable</span></span><br><span class=\"line\">restrict -4 default kod notrap nomodify nopeer noquery limited</span><br><span class=\"line\">restrict -6 default kod notrap nomodify nopeer noquery limited</span><br><span class=\"line\">restrict 127.0.0.1</span><br><span class=\"line\">restrict ::1</span><br><span class=\"line\">restrict <span class=\"built_in\">source</span> notrap nomodify noquery</span><br><span class=\"line\">server time1.tencentyun.com iburst</span><br><span class=\"line\">server time2.tencentyun.com iburst</span><br><span class=\"line\">server time3.tencentyun.com iburst</span><br><span class=\"line\">server time4.tencentyun.com iburst</span><br><span class=\"line\">server time5.tencentyun.com iburst</span><br><span class=\"line\">interface ignore wildcard</span><br><span class=\"line\">interface listen eth0</span><br></pre></td></tr></table></figure></p>\n<p>腾讯云NTP服务器外网地址:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ntp.tencent.com</span><br><span class=\"line\">ntp1.tencent.com</span><br><span class=\"line\">ntp2.tencent.com</span><br><span class=\"line\">ntp3.tencent.com</span><br><span class=\"line\">ntp4.tencent.com</span><br><span class=\"line\">ntp5.tencent.com</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>例如: 企业内部使用的ntp.conf示例(ntpd 4.2.8 )<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.漂移文件 -&gt; 其内容为3.031</span></span><br><span class=\"line\">driftfile /var/lib/ntp/ntp.drift</span><br><span class=\"line\"><span class=\"comment\"># 2.由tzdata提供的闰秒定义</span></span><br><span class=\"line\">leapfile /usr/share/zoneinfo/leap-seconds.list</span><br><span class=\"line\"><span class=\"comment\"># 3.如果希望记录统计数据请启用此选项。</span></span><br><span class=\"line\"><span class=\"comment\"># statsdir /var/log/ntpstats/</span></span><br><span class=\"line\"><span class=\"comment\"># statistics loopstats peerstats clockstats</span></span><br><span class=\"line\"><span class=\"comment\"># filegen loopstats file loopstats type day enable</span></span><br><span class=\"line\"><span class=\"comment\"># filegen peerstats file peerstats type day enable</span></span><br><span class=\"line\"><span class=\"comment\"># filegen clockstats file clockstats type day enable</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.restrict 同时适用于服务器和客户端</span></span><br><span class=\"line\">restrict -4 default kod notrap nomodify nopeer noquery </span><br><span class=\"line\">restrict -6 default kod notrap nomodify nopeer noquery</span><br><span class=\"line\"><span class=\"comment\"># 本地用户可能会更密切地询问ntp服务器。</span></span><br><span class=\"line\">restrict 192.168.12.254 nomodify notrap  noquery</span><br><span class=\"line\">restrict 127.0.0.1</span><br><span class=\"line\">restrict ::1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.请指定一个或多个NTP服务器。</span></span><br><span class=\"line\"><span class=\"comment\"># 5.1 通过网络同步时间</span></span><br><span class=\"line\">server ntp1.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp2.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server ntp3.aliyun.com iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server 0.cn.pool.ntp.org iburst minpoll 4 maxpoll 10</span><br><span class=\"line\">server 1.cn.pool.ntp.org iburst minpoll 4 maxpoll 10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.2 使用本地时间</span></span><br><span class=\"line\"><span class=\"comment\"># server自身和谁同步</span></span><br><span class=\"line\">server ntp.aliyun.com prefer</span><br><span class=\"line\"><span class=\"comment\"># 把自身的时间同步给客户端,即当没有时间同步来源的时候以自身的硬件时钟为准,此处stratum是代表层级默认是10。</span></span><br><span class=\"line\">server 127.127.1.0</span><br><span class=\"line\">fudge 127.127.1.0 stratum  10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6.需要添加池条目以及备用池</span></span><br><span class=\"line\">restrict <span class=\"built_in\">source</span> notrap nomodify noquery</span><br><span class=\"line\">restrict ntp.aliyun.com nomodify notrap noquery</span><br><span class=\"line\">pool ntp.aliyun.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7.如果要为本地子网提供时间</span></span><br><span class=\"line\"><span class=\"comment\"># broadcast 192.168.12.255</span></span><br><span class=\"line\"><span class=\"comment\"># disable auth</span></span><br><span class=\"line\"><span class=\"comment\"># broadcastclient</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tips: 补充说明允许那些网段或者IP同步，不做限制则0.0.0.0 mask 0.0.0.0.需要注意的是4.2版本的ntpd的restrict参数不要加notrust否则客户端会同步不了。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">restrict 192.168.80.0 mask 255.255.255.0 nomodify notrap</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"etc-chrony-conf\"><a href=\"#etc-chrony-conf\" class=\"headerlink\" title=\"/etc/chrony.conf\"></a>/etc/chrony.conf</h4><p>例如:对于使用 chrony 客户端的 linux 主机配置 <code>&#39;/etc/chrony.conf&#39;</code>文件的内容为：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基础示例1</span></span><br><span class=\"line\">server ntp.aliyun.com iburst</span><br><span class=\"line\">stratumweight 0</span><br><span class=\"line\">driftfile /var/lib/chrony/drift</span><br><span class=\"line\">rtcsync</span><br><span class=\"line\">makestep 10 3</span><br><span class=\"line\">bindcmdaddress 127.0.0.1</span><br><span class=\"line\">bindcmdaddress ::1</span><br><span class=\"line\">keyfile /etc/chrony.keys</span><br><span class=\"line\">commandkey 1</span><br><span class=\"line\">generatecommandkey</span><br><span class=\"line\">logchange 0.5</span><br><span class=\"line\">logdir /var/<span class=\"built_in\">log</span>/chrony</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 基础示例2</span></span><br><span class=\"line\">pool 192.168.12.254 iburst maxsources 1</span><br><span class=\"line\">pool 192.168.10.254 iburst maxsources 1</span><br><span class=\"line\">pool 192.168.4.254 iburst maxsources 1</span><br><span class=\"line\">pool ntp.aliyun.com iburst maxsources 4</span><br><span class=\"line\">keyfile /etc/chrony/chrony.keys</span><br><span class=\"line\">driftfile /var/lib/chrony/chrony.drift</span><br><span class=\"line\">logdir /var/<span class=\"built_in\">log</span>/chrony</span><br><span class=\"line\">maxupdateskew 100.0</span><br><span class=\"line\"><span class=\"comment\"># 启用实时时钟（RTC）的内核同步。</span></span><br><span class=\"line\">rtcsync</span><br><span class=\"line\">makestep 10 3</span><br></pre></td></tr></table></figure></p>\n<p>参考地址: <a href=\"https://chrony.tuxfamily.org/doc/3.5/chrony.conf.html\" target=\"_blank\" rel=\"noopener\">https://chrony.tuxfamily.org/doc/3.5/chrony.conf.html</a></p>\n<p><br></p>\n<h3 id=\"核验工具\"><a href=\"#核验工具\" class=\"headerlink\" title=\"核验工具\"></a>核验工具</h3><h4 id=\"ntpd-命令\"><a href=\"#ntpd-命令\" class=\"headerlink\" title=\"ntpd 命令\"></a>ntpd 命令</h4><p>描述: NTP守护程序</p>\n<p>语法参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ntpd - NTP daemon program - Ver. 4.2.8p12</span><br><span class=\"line\">Usage:  ntpd [ -&lt;flag&gt; [&lt;val&gt;] | --&lt;name&gt;[&#123;=| &#125;&lt;val&gt;] ]...  [ &lt;server1&gt; ... &lt;serverN&gt; ]</span><br><span class=\"line\">  Flg Arg Option-Name    Description</span><br><span class=\"line\">   -4 no  ipv4           Force IPv4 DNS name resolution</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'ipv6'</span></span><br><span class=\"line\">   -6 no  ipv6           Force IPv6 DNS name resolution</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'ipv4'</span></span><br><span class=\"line\">   -a no  authreq        Require crypto authentication</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'authnoreq'</span></span><br><span class=\"line\">   -A no  authnoreq      Do not require crypto authentication</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'authreq'</span></span><br><span class=\"line\">   -b no  bcastsync      Allow us to sync to broadcast servers</span><br><span class=\"line\">   -c Str configfile     configuration file name</span><br><span class=\"line\">   -d no  debug-level    Increase debug verbosity level</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -D Num <span class=\"built_in\">set</span>-debug-level Set the debug verbosity level</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -f Str driftfile      frequency drift file name</span><br><span class=\"line\">   -g no  panicgate      Allow the first adjustment to be Big</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -G no  force-step-once Step any initial offset correction.</span><br><span class=\"line\">   -i Str jaildir        Jail directory</span><br><span class=\"line\">   -I Str interface      Listen on an interface name or address</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -k Str keyfile        path to symmetric keys</span><br><span class=\"line\">   -l Str logfile        path to the <span class=\"built_in\">log</span> file</span><br><span class=\"line\">   -L no  novirtualips   Do not listen to virtual interfaces</span><br><span class=\"line\">   -n no  nofork         Do not fork</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'wait-sync'</span></span><br><span class=\"line\">   -N no  nice           Run at high priority</span><br><span class=\"line\">   -p Str pidfile        path to the PID file</span><br><span class=\"line\">   -P Num priority       Process priority</span><br><span class=\"line\">   -q no  quit           Set the time and quit</span><br><span class=\"line\">                                - prohibits these options:</span><br><span class=\"line\">                                saveconfigquit</span><br><span class=\"line\">                                <span class=\"built_in\">wait</span>-sync</span><br><span class=\"line\">   -r Str propagationdelay Broadcast/propagation delay</span><br><span class=\"line\">      Str saveconfigquit Save parsed configuration and quit</span><br><span class=\"line\">                                - prohibits these options:</span><br><span class=\"line\">                                quit</span><br><span class=\"line\">                                <span class=\"built_in\">wait</span>-sync</span><br><span class=\"line\">   -s Str statsdir       Statistics file location</span><br><span class=\"line\">   -t Str trustedkey     Trusted key number</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -u Str user           Run as userid (or userid:groupid)</span><br><span class=\"line\">   -U Num updateinterval interval <span class=\"keyword\">in</span> seconds between scans <span class=\"keyword\">for</span> new or dropped interfaces</span><br><span class=\"line\">      Str var            make ARG an ntp variable (RW)</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">      Str dvar           make ARG an ntp variable (RW|DEF)</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -w Num <span class=\"built_in\">wait</span>-sync      Seconds to <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> first clock sync</span><br><span class=\"line\">                                - prohibits these options:</span><br><span class=\"line\">                                nofork</span><br><span class=\"line\">                                quit</span><br><span class=\"line\">                                saveconfigquit</span><br><span class=\"line\">   -x no  slew           Slew up to 600 seconds</span><br><span class=\"line\">      opt version        output version information and <span class=\"built_in\">exit</span></span><br><span class=\"line\">   -? no  <span class=\"built_in\">help</span>           display extended usage information and <span class=\"built_in\">exit</span></span><br><span class=\"line\">   -! no  more-help      extended usage information passed thru pager</span><br></pre></td></tr></table></figure></p>\n<p>基础命令:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 通过bin目录下的脚本启动</span></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/ntp/bin/ntpd -c /etc/ntp.conf -p /tmp/ntpd.pid</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"ntpdate-命令\"><a href=\"#ntpdate-命令\" class=\"headerlink\" title=\"ntpdate 命令\"></a>ntpdate 命令</h4><p>描述: 通过NTP设置日期和时间;</p>\n<p><strong>语法参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ntpdate [-46bBdqsuv] [-a key] [-e authdelay] [-k keyfile] [-o version] [-p samples] [-t timeout] server [...]</span><br></pre></td></tr></table></figure></p>\n<p><strong>基础实例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基础调试</span></span><br><span class=\"line\">$ ntpdate -d 192.168.12.254</span><br><span class=\"line\">19 Mar 15:44:30 ntpdate[989474]: ntpdate 4.2.8p12@1.3728-o (1)</span><br><span class=\"line\">Looking <span class=\"keyword\">for</span> host 192.168.12.254 and service ntp</span><br><span class=\"line\">host found : 192.168.12.254</span><br><span class=\"line\">transmit(192.168.12.254)</span><br><span class=\"line\">receive(192.168.12.254)</span><br><span class=\"line\">....</span><br><span class=\"line\">transmit(192.168.12.254)</span><br><span class=\"line\">receive(192.168.12.254)</span><br><span class=\"line\"></span><br><span class=\"line\">server 192.168.12.254, port 123</span><br><span class=\"line\">stratum 3, precision -24, leap 00, trust 000</span><br><span class=\"line\">refid [120.25.115.20], root delay 0.034073, root dispersion 0.014389</span><br><span class=\"line\">transmitted 4, <span class=\"keyword\">in</span> filter 4</span><br><span class=\"line\">reference time:    e3fed42b.d735a7b4  Fri, Mar 19 2021 15:41:31.840</span><br><span class=\"line\">originate timestamp: e3fed4e4.d942360e  Fri, Mar 19 2021 15:44:36.848</span><br><span class=\"line\">transmit timestamp:  e3fed4e4.d9081cab  Fri, Mar 19 2021 15:44:36.847</span><br><span class=\"line\">filter delay:  0.02577  0.02576  0.02576  0.02577</span><br><span class=\"line\">         0.00000  0.00000  0.00000  0.00000</span><br><span class=\"line\">filter offset: 0.000817 0.000793 0.000781 0.000769</span><br><span class=\"line\">         0.000000 0.000000 0.000000 0.000000</span><br><span class=\"line\">delay 0.02576, dispersion 0.00000</span><br><span class=\"line\">offset 0.000793</span><br><span class=\"line\"></span><br><span class=\"line\">19 Mar 15:44:36 ntpdate[989474]: adjust time server 192.168.12.254 offset 0.000793 sec</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"ntpstat-命令-显示网络时间同步状态\"><a href=\"#ntpstat-命令-显示网络时间同步状态\" class=\"headerlink\" title=\"ntpstat 命令 - 显示网络时间同步状态\"></a>ntpstat 命令 - 显示网络时间同步状态</h4><p>描述: ntpstat将报告在本地计算机上运行的NTP守护程序（ntpd）的同步状态，如果发现本地系统与参考时间源同步，则ntpstat将报告大致的时间精度。</p>\n<p>ntpstat命令根据NTP同步返回三种状态代码详情如下：</p>\n<ul>\n<li>0：如果时钟同步，则返回0。</li>\n<li>1：如果时钟不同步，则返回1。</li>\n<li>2：如果时钟状态不确定，则返回2，例如，如果ntpd不可联系。</li>\n</ul>\n<p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.在第3层同步到NTP服务器（120.25.115.20），时间在56毫秒内纠正，每隔1024秒轮询一次服务器。</span></span><br><span class=\"line\">$ ntpstat</span><br><span class=\"line\">synchronised to NTP server (120.25.115.20) at stratum 3</span><br><span class=\"line\">   time correct to within 56 ms</span><br><span class=\"line\">   polling server every 1024 s</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"ntpq-命令-标准的NTP查询程序\"><a href=\"#ntpq-命令-标准的NTP查询程序\" class=\"headerlink\" title=\"ntpq 命令 - 标准的NTP查询程序\"></a>ntpq 命令 - 标准的NTP查询程序</h4><p>描述: 标准的NTP查询程序</p>\n<p>语法参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ntpq - standard NTP query program - Ver. 4.2.8p12</span><br><span class=\"line\">Usage:  ntpq [ -&lt;flag&gt; [&lt;val&gt;] | --&lt;name&gt;[&#123;=| &#125;&lt;val&gt;] ]... [ host ...]</span><br><span class=\"line\">  Flg Arg Option-Name    Description</span><br><span class=\"line\">   -4 no  ipv4           Force IPv4 name resolution</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'ipv6'</span></span><br><span class=\"line\">   -6 no  ipv6           Force IPv6 name resolution</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'ipv4'</span></span><br><span class=\"line\">   -c Str <span class=\"built_in\">command</span>        run a <span class=\"built_in\">command</span> and <span class=\"built_in\">exit</span></span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -d no  debug-level    Increase debug verbosity level</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -D Num <span class=\"built_in\">set</span>-debug-level Set the debug verbosity level</span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br><span class=\"line\">   -i no  interactive    Force ntpq to operate <span class=\"keyword\">in</span> interactive mode</span><br><span class=\"line\">                                - prohibits these options: <span class=\"built_in\">command</span> peers</span><br><span class=\"line\">   -n no  numeric        numeric host addresses</span><br><span class=\"line\">      no  old-rv         Always output status line with readvar</span><br><span class=\"line\">   -p no  peers          Print a list of the peers</span><br><span class=\"line\">                                - prohibits the option <span class=\"string\">'interactive'</span></span><br><span class=\"line\">   -r KWd refid          Set default display <span class=\"built_in\">type</span> <span class=\"keyword\">for</span> S2+ refids</span><br><span class=\"line\">   -w no  wide           Display the full <span class=\"string\">'remote'</span> value</span><br><span class=\"line\">      opt version        output version information and <span class=\"built_in\">exit</span></span><br><span class=\"line\">   -? no  <span class=\"built_in\">help</span>           display extended usage information and <span class=\"built_in\">exit</span></span><br><span class=\"line\">   -! no  more-help      extended usage information passed thru pager</span><br><span class=\"line\">   -&gt; opt save-opts      save the option state to a config file</span><br><span class=\"line\">   -&lt; Str load-opts      load options from a config file</span><br><span class=\"line\">                                - disabled as <span class=\"string\">'--no-load-opts'</span></span><br><span class=\"line\">                                - may appear multiple <span class=\"built_in\">times</span></span><br></pre></td></tr></table></figure></p>\n<p>基础实例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) 打印对等体的列表即查看ntp服务器与上层ntp的状态(如开启nopeer选项其它主机无法获取)</span></span><br><span class=\"line\">dns-server:~$ ntpq -p</span><br><span class=\"line\">dns-server:~$ ntpq -p 192.168.12.254</span><br><span class=\"line\">  <span class=\"comment\">#     remote           refid      st t when poll reach   delay   offset  jitter</span></span><br><span class=\"line\">  <span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">  <span class=\"comment\"># LOCAL(0)        .LOCL.           8 l  332   64   40    0.000    0.000   0.000</span></span><br><span class=\"line\">  <span class=\"comment\"># ntp.aliyun.com  .POOL.          16 p    -   64    0    0.000    0.000   0.000</span></span><br><span class=\"line\">  <span class=\"comment\"># *120.25.115.20   10.137.53.7      2 u    8   16  377   33.766   -2.872   0.170</span></span><br><span class=\"line\">  <span class=\"comment\"># +203.107.6.88    10.137.38.86     2 u    8   16  377   53.024    5.287   1.349</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数说明</span></span><br><span class=\"line\">  <span class=\"comment\"># remote：本机和上层ntp的ip或主机名，“+”表示优先，“*”表示次优先</span></span><br><span class=\"line\">  <span class=\"comment\"># refid：参考上一层ntp主机地址</span></span><br><span class=\"line\">  <span class=\"comment\"># st：stratum阶层</span></span><br><span class=\"line\">  <span class=\"comment\"># when：多少秒前曾经同步过时间</span></span><br><span class=\"line\">  <span class=\"comment\"># poll：下次更新在多少秒后</span></span><br><span class=\"line\">  <span class=\"comment\"># reach：已经向上层ntp服务器要求更新的次数</span></span><br><span class=\"line\">  <span class=\"comment\"># delay：网络延迟</span></span><br><span class=\"line\">  <span class=\"comment\"># offset：时间补偿</span></span><br><span class=\"line\">  <span class=\"comment\"># jitter：系统时间与bios时间差</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ~$ ping ntp.aliyun.com</span></span><br><span class=\"line\">  <span class=\"comment\"># PING ntp.aliyun.com (203.107.6.88)</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"chronyc命令\"><a href=\"#chronyc命令\" class=\"headerlink\" title=\"chronyc命令\"></a>chronyc命令</h4><p>描述: chronyc 客户端命令查看时间服务器的状态。</p>\n<p>语法参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">系统时钟:</span><br><span class=\"line\">tracking\t\t\t显示系统时间信息</span><br><span class=\"line\">makestep\t\t立即步进地校正时钟</span><br><span class=\"line\">makestep   \t\t配置自动时钟步进</span><br><span class=\"line\">maxupdateskew  \t修改更新频率的最大有效时滞</span><br><span class=\"line\"></span><br><span class=\"line\">waitsync [ [ [ []]]]\t\t等待，直到同步到指定的阈值内</span><br><span class=\"line\"></span><br><span class=\"line\">时间来源:</span><br><span class=\"line\">sources [-v]\t\t显示关于当前来源的信息</span><br><span class=\"line\">sourcestats [-v] \t显示有关收集测量的统计信息</span><br><span class=\"line\"></span><br><span class=\"line\">reselect\t\t\t强制重新选择同步源</span><br><span class=\"line\"></span><br><span class=\"line\">reselectdist  \t\t修改重选距离</span><br><span class=\"line\"></span><br><span class=\"line\">NTP源:</span><br><span class=\"line\">activity\t\t\t检查有多少个NTP源在线/离线</span><br><span class=\"line\">ntpdata []\t\t\t显示上次有效测量的信息</span><br><span class=\"line\">add server   [options] \t添加新的NTP服务器</span><br><span class=\"line\">add peer [options] \t\t添加新的NTP peer</span><br><span class=\"line\">delete                    移除服务器或 peer</span><br><span class=\"line\">burst / [/]               开始快速设置的测量</span><br><span class=\"line\">maxdelay             修改最大有效采样延迟</span><br><span class=\"line\">maxdelayratio      修改最大有效延迟/最小比率</span><br><span class=\"line\">maxdelaydevratio   修改最大有效延迟/偏差比率</span><br><span class=\"line\"></span><br><span class=\"line\">minpoll              修改最小轮询时间间隔</span><br><span class=\"line\">maxpoll            修改最大轮询间隔</span><br><span class=\"line\">minstratum      修改最小层级</span><br><span class=\"line\">offline [/]  \t将子网中的源设置为离线状态</span><br><span class=\"line\">online [/]   \t将子网中的源设置为在线状态</span><br><span class=\"line\">polltarget         修改投票目标</span><br><span class=\"line\">refresh            刷新IP地址</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">手动时间输入:</span><br><span class=\"line\">manual off|on|reset         \t禁用/启用/重置settime命令</span><br><span class=\"line\">manual list                 \t\t显示以前的设置时间条目</span><br><span class=\"line\">manual delete        \t\t\t删除之前的设置时间条目</span><br><span class=\"line\">settime               \t\t\t置守护进程的时间 (e.g. Sep 25, 2015 16:30:05 or 16:30:05)</span><br><span class=\"line\"></span><br><span class=\"line\">NTP访问:</span><br><span class=\"line\"></span><br><span class=\"line\">accheck                检查地址是否被允许</span><br><span class=\"line\">clients                   报告访问服务器的客户端</span><br><span class=\"line\">serverstats            显示服务器的统计信息</span><br><span class=\"line\">allow []            \t     默认允许访问子网</span><br><span class=\"line\">allow all []             默认允许访问子网和所有子节点</span><br><span class=\"line\">deny []                  默认拒绝访问子网</span><br><span class=\"line\">deny all []             默认拒绝访问子网和所有子节点</span><br><span class=\"line\"><span class=\"built_in\">local</span> [options]             \t\t\t\t在未同步的情况下也提供服务</span><br><span class=\"line\"><span class=\"built_in\">local</span> off                   \t\t\t\t\t在未同步的情况下不提供服务</span><br><span class=\"line\">smoothtime reset|activate   \t\t\t重置/激活时间平滑</span><br><span class=\"line\">smoothing                   \t\t\t\t显示当前时间平滑状态</span><br><span class=\"line\"></span><br><span class=\"line\">访问监控:</span><br><span class=\"line\">cmdaccheck                 检查地址是否被允许</span><br><span class=\"line\">cmdallow []         \t   默认允许访问子网</span><br><span class=\"line\">cmdallow all []     \t   默认允许访问子网和所有子节点</span><br><span class=\"line\">cmddeny []          \t   默认拒绝访问子网</span><br><span class=\"line\">cmddeny all []      \t  默认拒绝访问子网和所有子节点</span><br><span class=\"line\"></span><br><span class=\"line\">Real-time clock:</span><br><span class=\"line\">rtcdata                      打印当前的RTC性​​能参数</span><br><span class=\"line\">trimrtc                     \t 相对于系统时钟校正RTC</span><br><span class=\"line\">writertc                     将RTC性能参数保存到文件</span><br><span class=\"line\"></span><br><span class=\"line\">Other daemon commands:</span><br><span class=\"line\">cyclelogs                  关闭并重新打开日志文件</span><br><span class=\"line\">dump                        转储所有测量以保存文件</span><br><span class=\"line\">rekey                        重新读取密钥文件中的密钥</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Client commands:</span><br><span class=\"line\">dns -n|+n                   禁用/启用将IP地址解析为主机名</span><br><span class=\"line\">dns -4|-6|-46              将主机名解析为IPv4、IPv6或全部</span><br><span class=\"line\">timeout       \t\t  设置初始响应超时</span><br><span class=\"line\">retries            \t\t  设置最大重试次数</span><br><span class=\"line\">keygen [ [ []]]\t\t  为密钥文件生成密钥</span><br><span class=\"line\"><span class=\"built_in\">exit</span>|quit                   \t  退出程序</span><br><span class=\"line\"><span class=\"built_in\">help</span>                        \t  生成此帮助</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.验证 chrony是否安装成功，并查看有多少个服务端及结点已连接, 查看 NTP 服务器的在线和离线状态;</span></span><br><span class=\"line\">$ chronyc activity</span><br><span class=\"line\">200 OK</span><br><span class=\"line\">8 sources online</span><br><span class=\"line\">0 sources offline</span><br><span class=\"line\">0 sources doing burst (<span class=\"built_in\">return</span> to online)</span><br><span class=\"line\">0 sources doing burst (<span class=\"built_in\">return</span> to offline)</span><br><span class=\"line\">0 sources with unknown address</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.检查 Chrony 是否实际同步(主要关注 Update interval 这个参数, 说明最后两次更新的时间间隔是 64.1s。)</span></span><br><span class=\"line\"><span class=\"comment\"># 校准时间服务器，显示系统时间信息</span></span><br><span class=\"line\">$ chronyc tracking</span><br><span class=\"line\">Reference ID    : AB42617E (srcf-ntp.stanford.edu)</span><br><span class=\"line\">Stratum         : 2</span><br><span class=\"line\">Ref time (UTC)  : Thu Apr 05 18:27:33 2018</span><br><span class=\"line\">System time     : 0.000669840 seconds slow of NTP time</span><br><span class=\"line\">Last offset     : -0.000506939 seconds</span><br><span class=\"line\">RMS offset      : 0.001261410 seconds</span><br><span class=\"line\">Frequency       : 28.552 ppm slow</span><br><span class=\"line\">Residual freq   : -0.000 ppm</span><br><span class=\"line\">Skew            : 88.846 ppm</span><br><span class=\"line\">Root delay      : 0.031207338 seconds</span><br><span class=\"line\">Root dispersion : 0.001206590 seconds</span><br><span class=\"line\">Update interval : 65.2 seconds</span><br><span class=\"line\">Leap status     : Normal</span><br><span class=\"line\">sources</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果中的其它参数的含义分别是：</span></span><br><span class=\"line\">  * 引用 ID - 计算机当前同步的引用 ID 和名称。</span><br><span class=\"line\">  * Stratum - 连接参考时钟的计算机的跳数。</span><br><span class=\"line\">  * 参考时间 - 这是参考源的最后一次测量的 UTC 时间。</span><br><span class=\"line\">  * 系统时间 - 来自同步服务器的系统时钟延迟。</span><br><span class=\"line\">  * 最后一次偏移 - 上次时钟更新的估计偏移量。</span><br><span class=\"line\">  * RMS 偏移 - 偏移值的长期平均值。</span><br><span class=\"line\">  * 频率 - 如果 chronyd 没有纠正它，那么系统的时钟错误的速率。它以 ppm （百万分率）提供。</span><br><span class=\"line\">  * 残余频率 - 残余频率表示参考源的测量值与当前使用的频率之间的差异。</span><br><span class=\"line\">  * 偏斜 - 估计频率的误差界限。</span><br><span class=\"line\">  * 根延迟 - 网络路径延迟到计算机正在同步的层计算机的总和。</span><br><span class=\"line\">  * 跳跃状态 - 这是跳跃状态，可以具有以下值之一：正常、插入秒、删除秒或不同步。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.显示所有 NTP 源服务器的信息(查看时间同步源)</span></span><br><span class=\"line\">$ chronyc sources -v</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.检查 NTP 访问是否对特定主机可用</span></span><br><span class=\"line\">$ chronyc accheck 192.168.12.254</span><br><span class=\"line\"><span class=\"comment\"># 501 Not authorised</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.在客户端报告已访问到服务器</span></span><br><span class=\"line\">$ chronyc clients</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6.手动添加一台新的 NTP 服务器</span></span><br><span class=\"line\">$ chronyc add server ntp1.aliyun.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7.手动移除 NTP 服务器或对等服务器</span></span><br><span class=\"line\">$ chronyc delete server ntp1.aliyun.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 8.手动设置守护进程时间</span></span><br><span class=\"line\">$ chronyc settime</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 9.查看时间同步源状态</span></span><br><span class=\"line\">$ chronyc sourcestats -v</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 10.强制更新时间</span></span><br><span class=\"line\">chronyc -a makestep</span><br></pre></td></tr></table></figure></p>\n<p>Tips : 如果要查看 Chrony 服务的日志可以使用以下命令 <code>journalctl -u chronyd</code> </p>\n<hr>\n<h2 id=\"0x05-入坑出坑\"><a href=\"#0x05-入坑出坑\" class=\"headerlink\" title=\"0x05 入坑出坑\"></a>0x05 入坑出坑</h2><h3 id=\"问题1-ntpdate-820110-no-server-suitable-for-synchronization-found\"><a href=\"#问题1-ntpdate-820110-no-server-suitable-for-synchronization-found\" class=\"headerlink\" title=\"问题1.ntpdate[820110]: no server suitable for synchronization found\"></a>问题1.ntpdate[820110]: no server suitable for synchronization found</h3><p>描述:在ntp服务器启动之后需要一段时间才能够通过客户端进行时间的同步，所以如果这个问题是在服务器端刚启动的时候出现的是属于正常的情况，请等待一段时间在进行尝试。如果还是有问题可以查看网络或者是服务器端与客户端的配置情况。<br>问题复现：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ sudo ntpdate 192.168.12.254</span><br><span class=\"line\">19 Mar 04:50:24 ntpdate[820110]: no server suitable <span class=\"keyword\">for</span> synchronization found</span><br></pre></td></tr></table></figure><br>问题原因:</p>\n<ul>\n<li>1.防火墙未开放</li>\n<li>2.ntp服务端未配置子网时间同步获取</li>\n</ul>\n<p>解决办法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 在ntp客户端用 ntpdate –d serverIP 观察服务状态如发现以下错误</span></span><br><span class=\"line\">- 错误1.Server dropped: strata too high 并且显示 stratum 16 表示 stratum 值有误;</span><br><span class=\"line\">- 错误2.Server dropped: no data 检查`ntp`的版本如果你使用的是ntp4.2（包括4.2）之后的版本, 在restrict的定义中使用了notrust的话，会导致以上错误。</span><br><span class=\"line\"><span class=\"comment\"># (2) 禁用防火墙</span></span><br></pre></td></tr></table></figure></p>\n<p>正常状态回显:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">26 Mar 22:19:43 ntpdate[3156]: adjust time server 192.168.100.110 offset -0.001781 sec</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"问题2-ntpdate-35934-the-NTP-socket-is-in-use-exiting\"><a href=\"#问题2-ntpdate-35934-the-NTP-socket-is-in-use-exiting\" class=\"headerlink\" title=\"问题2.ntpdate[35934]: the NTP socket is in use, exiting\"></a>问题2.ntpdate[35934]: the NTP socket is in use, exiting</h3><p>描述: 在使用ntpdate进行同步时如果发现NTP端口被占用的提示，请使用ps命令查看系统是不是运行着ntp相关的服务，很多服务器安装上之后会自动的启动一些服务，之用将其关闭就可以了。<br>问题错误:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dns-server:~$ ntpdate 192.168.12.254</span><br><span class=\"line\">19 Mar 13:27:40 ntpdate[35934]: the NTP socket is <span class=\"keyword\">in</span> use, exiting</span><br></pre></td></tr></table></figure><br>问题原因: 不能在启用了ntp服务的机器上再使用ntpdata进行时间同步，需要将ntp服务停止后才能使用该命令<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dns-server:~$ ps aux | grep <span class=\"string\">\"ntp\"</span></span><br><span class=\"line\"><span class=\"comment\"># ntp        41534  0.0  0.0  74636  4124 ?        Ssl  15:32   0:00 /usr/sbin/ntpd -p /var/run/ntpd.pid -g -u 112:117</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"问题3-ntpd与ntpdate区别说明\"><a href=\"#问题3-ntpd与ntpdate区别说明\" class=\"headerlink\" title=\"问题3.ntpd与ntpdate区别说明\"></a>问题3.ntpd与ntpdate区别说明</h3><p>描述: 使用之前得弄清楚一个问题 ntpd与ntpdate在更新时间时有什么区别?</p>\n<ul>\n<li>ntpd : 它是时间同步服务器并且还可以做客户端与标准时间服务器进行同步时间(平滑同步)</li>\n<li>ntpdate : 在生产环境中慎用ntpdate(跃变同步)</li>\n</ul>\n<p>Tips: 正如此两者不可同时运行, 因为时钟的跃变，对于某些程序会导致很严重的问题。例如许多应用程序依赖连续的时钟(取得的时间是线性的)，对于数据库事务通常会地依赖这样的事实，时间不会往回跳跃。</p>\n<p><strong>Q: ntpdate使用在生产环境中的坏处?</strong></p>\n<ul>\n<li>1) 不安全: ntpdate 的设置依赖于ntp服务器的安全性，攻击者可以利用一些软件设计上的缺陷，拿下ntp服务器并令与其同步的服务器执行某些消耗性的任务。</li>\n<li>2) 不精确: 一旦ntp服务器宕机，跟随它的服务器也就会无法同步时间。与此不同ntpd不仅能够校准计算机的时间，而且能够校准计算机的时钟。</li>\n<li>3) 不够优雅: 由于是跳变，而不是使时间变快或变慢依赖时序的程序会出错, 最好的做法是使用ntpd来校准时钟，而不是调整计算机时钟上的时间；ntpd 在和时间服务器的同步过程中，<code>会把BIOS计时器的振荡频率偏差——或者说Local Clock的自然漂移(drift)一一记录下来</code>。如此即使网络有问题本机仍然能维持一个相当精确的走时。</li>\n</ul>\n<p><br/></p>\n<p><strong>参考来源</strong></p>\n<p>阿里云: <a href=\"https://developer.aliyun.com/mirror/NTP?spm=a2c6h.13651102.0.0.53322f708XGXRj\" target=\"_blank\" rel=\"noopener\">https://developer.aliyun.com/mirror/NTP?spm=a2c6h.13651102.0.0.53322f708XGXRj</a></p>\n<p><br/></p>\n<h3 id=\"问题4-验证操作系统时间同步NTP-synchronized-yes\"><a href=\"#问题4-验证操作系统时间同步NTP-synchronized-yes\" class=\"headerlink\" title=\"问题4.验证操作系统时间同步NTP synchronized: yes\"></a>问题4.验证操作系统时间同步<code>NTP synchronized: yes</code></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置时间同步</span></span><br><span class=\"line\">$ timedatectl <span class=\"built_in\">set</span>-ntp yes</span><br><span class=\"line\"><span class=\"comment\"># 查看时间同步情况</span></span><br><span class=\"line\">$ timedatectl</span><br><span class=\"line\">      Local time: 四 2021-05-06 16:09:29 CST</span><br><span class=\"line\">  Universal time: 四 2021-05-06 08:09:29 UTC</span><br><span class=\"line\">        RTC time: 四 2021-05-06 16:09:29</span><br><span class=\"line\">       Time zone: Asia/Shanghai (CST, +0800)</span><br><span class=\"line\">     NTP enabled: yes</span><br><span class=\"line\">NTP synchronized: yes  <span class=\"comment\"># 已同步</span></span><br><span class=\"line\"> RTC <span class=\"keyword\">in</span> <span class=\"built_in\">local</span> TZ: yes</span><br><span class=\"line\">      DST active: n/a</span><br></pre></td></tr></table></figure>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Linux配置","path":"api/categories/Linux配置.json"}],"tags":[{"name":"NTP","path":"api/tags/NTP.json"}]}