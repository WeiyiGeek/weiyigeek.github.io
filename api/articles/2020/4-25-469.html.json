{"title":"2-Kubernetes入门之CentOS安装部署集群","slug":"虚拟云容/云容器/Kubernetes/2-Kubernetes入门之CentOS安装部署集群","date":"2020-04-25T10:37:47.000Z","updated":"2022-04-26T08:34:23.835Z","url":"2020/4-25-469.html","path":"api/articles/2020/4-25-469.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200615163724.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200628114808.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200624000734.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200628155350.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200629171127.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200629173552.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200629203618.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h3 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h3><p>描述: 通过上一篇K8s入门体系架构学习我们初步的了解单节点的master与worker的工作部署流程，但是前面所用的是kuboard所提供的安装脚本作为测试练手安装还是可以将就的，但是在实际的生产的环境中由于业务的复杂性和多样性需要依靠集群来保证其安全可靠性;</p>\n<p>安装K8s前我们需要从集群规划的以下几方面入手准备:</p>\n<ul>\n<li>(1) 操作系统 (OS)<br>描述:在使用 CentOS 7x 系的 OS 时建议升级一下内核版本(<code>stable  &gt;= 4.19</code>)，不然在运行一些 java 容器的时候可能会遇到一些问题。前期可以在测试环境部署一些 Java 应用业务，观察是否会遇到此类问题，如果遇到此类问题可尝试通过升级内核版本来解决。</li>\n</ul>\n<blockquote>\n<p>Q:Java容器瞬间拉起的过程，整个集群都会被CPU用尽，如何解决Java CPU启动时候CPU资源互争的情况？<br>A:这个问题我们也遇到过，后来把内核升级到4.19后就不再发生了很多内存耗尽，CPU爆炸的问题我们都通过内核升级解决了。</p>\n</blockquote>\n<p>PS : 注意在Linux Kernel 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定<br>PS : 前面我们说过对于Node工作负载的节点尽可能选择物理机器，而Master节点为了便于恢复建议安装在vSphere虚拟化环境之中;</p>\n<p><br></p>\n<ul>\n<li>(2) 稳定版本选择 (VERSION)</li>\n</ul>\n<p>目前截至本文档汇总时（2020-06-20），Kubernetes 官方还在维护的 release stable 版本有 <code>1.16.x</code>、 <code>1.17.x</code> 、<code>1.18.x</code> 。<code>1.14.x</code> 和 <code>1.15.x</code> 版本的生命周期都已经接近 <code>EOL</code> ，因此不建议选择较旧版本。综合考虑，目前来讲选择 <code>4 &lt; x &lt; 10</code> 小版本中的  <code>1.17.4</code> 或 <code>1.17.5</code> 版本最为合适以及<code>1.18.3</code>。</p>\n<ul>\n<li>对于 <code>docker-ce</code> 版本，默认使用官方 yum 源中的最新版本即可，即 <code>docker-ce-19.03.9-3.el7</code>。</li>\n<li>对于 <code>harbor</code> 版本，考虑到 harbor <a href=\"https://github.com/goharbor/harbor/releases/tag/v2.0.0-rc1\" target=\"_blank\" rel=\"noopener\">v2.0.0-rc1</a> 刚刚 release ，但不建议选择使用，建议选择 <a href=\"https://github.com/goharbor/harbor/releases/tag/v1.9.4\" target=\"_blank\" rel=\"noopener\">v1.9.4</a> 版本，后续如果有遇到问题必须通过升级的方式解决，可以考虑升级到已经 release stable 版本的 <code>v2.x.x</code> 。</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">pkg</th>\n<th style=\"text-align:center\">version</th>\n<th style=\"text-align:center\">release date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">kubernetes</td>\n<td style=\"text-align:center\"><a href=\"https://github.com/kubernetes/kubernetes/releases/tag/v1.17.5\" target=\"_blank\" rel=\"noopener\">v1.17.5</a></td>\n<td style=\"text-align:center\">2020-04-16</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">docker-ce</td>\n<td style=\"text-align:center\"><a href=\"https://github.com/docker/docker-ce/releases/tag/v19.03.9\" target=\"_blank\" rel=\"noopener\">19.03.9</a></td>\n<td style=\"text-align:center\">2020-04-12</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">harbor</td>\n<td style=\"text-align:center\"><a href=\"https://github.com/goharbor/harbor/releases/tag/v1.9.4\" target=\"_blank\" rel=\"noopener\">v1.9.4</a></td>\n<td style=\"text-align:center\">2020-12-31</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p><br></p>\n<ul>\n<li>3.存储(Storage)</li>\n</ul>\n<p>在Kubernetes中数据存储一般是通过共享文件的方式，在实际的生产环境中多采用NFS/分布式文件系统GlusterFS或者光纤存储等共享存储方案，为其提供存储空间;</p>\n<p>建议采用存储服务器进行提供存储服务，并且在不考虑经费的问题上时固态无疑是最好的选择;</p>\n<p><br></p>\n<ul>\n<li>4.网络环境</li>\n</ul>\n<p>一般来说kubernetes集群在部署安装时候为了防止错误都是将防火墙进行关闭部署的，此时其它硬件或者软件防火墙显得尤为重要，并且交换机一定要划分VLAN做隔离;</p>\n<hr>\n<h3 id=\"0x01-安装部署\"><a href=\"#0x01-安装部署\" class=\"headerlink\" title=\"0x01 安装部署\"></a>0x01 安装部署</h3><p>描述:我们需要自定义安装所需组件和插件所以我们下面进行利用 <code>kubeadm</code> 进行手动部署K8S(<code>单机|集群</code>);</p>\n<h4 id=\"0-基础安装环境\"><a href=\"#0-基础安装环境\" class=\"headerlink\" title=\"0.基础安装环境\"></a>0.基础安装环境</h4><p>描述:在进行kubeadm安装的时候，不论是worker节点或者master节点都需要进行执行;<br>系统环境建议:</p>\n<p><strong>系统版本</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#OS</span></span><br><span class=\"line\">CentOS 7.x/8.x (推荐此处环境7.8),Ubuntu(18.04) </span><br><span class=\"line\"><span class=\"comment\">#Kerner</span></span><br><span class=\"line\">OS KERNER &gt;= 4.18 </span><br><span class=\"line\"><span class=\"comment\">#Docker Version: 19.03.09</span></span><br><span class=\"line\"><span class=\"comment\">#kubernetes 1.18.3</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>环境检查</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.当前节点</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname master-01</span><br><span class=\"line\">hostnamectl status</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.kubeadm会检查当前主机是否禁用了`swap`,所以这里临时关闭swap()和SELinux</span></span><br><span class=\"line\"><span class=\"comment\"># 临时关闭swap和SELinux</span></span><br><span class=\"line\">swapoff -a</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\"><span class=\"comment\"># 永久关闭swap和SELinux</span></span><br><span class=\"line\">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class=\"line\">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class=\"line\">sed -i <span class=\"string\">'s/^SELINUX=.*$/SELINUX=disabled/'</span> /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.主机名设置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"127.0.0.1 <span class=\"variable\">$(hostname)</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\">cat  &lt;&lt;EOF &gt;&gt; /etc/hosts</span><br><span class=\"line\">10.80.172.211  master-01</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.关闭防火墙</span></span><br><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> firewalld</span><br></pre></td></tr></table></figure></p>\n<p><strong>系统内核参数调整:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/sysctl.conf 进行内核参数的配置</span></span><br><span class=\"line\"><span class=\"comment\"># /etc/sysctl.d/99-kubernetes-cri.conf</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv4.ip_forward.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv4.ip_forward.*|net.ipv4.ip_forward = 1|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_forward = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-ip6tables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-ip6tables.*|net.bridge.bridge-nf-call-ip6tables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-ip6tables = 1\"</span> &gt;&gt; /etc/sysctl.conf </span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-iptables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-iptables.*|net.bridge.bridge-nf-call-iptables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-iptables = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.all.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.all.disable_ipv6.*|net.ipv6.conf.all.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.all.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.default.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.default.disable_ipv6.*|net.ipv6.conf.default.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.default.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.lo.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.lo.disable_ipv6.*|net.ipv6.conf.lo.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.lo.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.all.forwarding.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.all.forwarding.*|net.ipv6.conf.all.forwarding = 1|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.all.forwarding = 1\"</span>  &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行命令以应用</span></span><br><span class=\"line\">sysctl -p</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"1-Docker-安装配置\"><a href=\"#1-Docker-安装配置\" class=\"headerlink\" title=\"1.Docker 安装配置\"></a>1.Docker 安装配置</h4><p>描述:主要就是下载指定的Docker-ce版本以及docker-compose的下载配置,注意<code>在 master 节点和 worker 节点都要执行</code>;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 适用于:CentOS</span></span><br><span class=\"line\"><span class=\"comment\"># Docker hub 镜像加速源:在 master 节点和 worker 节点都要执行</span></span><br><span class=\"line\"><span class=\"comment\"># 最后一个参数 1.18.2 用于指定 kubenetes 版本，支持所有 1.18.x 版本的安装</span></span><br><span class=\"line\"><span class=\"comment\"># 腾讯云 docker hub 镜像</span></span><br><span class=\"line\"><span class=\"comment\"># export REGISTRY_MIRROR=\"https://mirror.ccs.tencentyun.com\"</span></span><br><span class=\"line\"><span class=\"comment\"># DaoCloud 镜像</span></span><br><span class=\"line\"><span class=\"comment\"># export REGISTRY_MIRROR=\"http://f1361db2.m.daocloud.io\"</span></span><br><span class=\"line\"><span class=\"comment\"># 阿里云 docker hub 镜像</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> REGISTRY_MIRROR=</span><br><span class=\"line\"><span class=\"comment\">#https://registry.cn-hangzhou.aliyuncs.com</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 docker</span></span><br><span class=\"line\"><span class=\"comment\"># 参考文档如下</span></span><br><span class=\"line\"><span class=\"comment\"># https://docs.docker.com/install/linux/docker-ce/centos/ </span></span><br><span class=\"line\"><span class=\"comment\"># https://docs.docker.com/install/linux/linux-postinstall/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 卸载旧版本</span></span><br><span class=\"line\">yum remove -y docker \\</span><br><span class=\"line\">docker-client \\</span><br><span class=\"line\">docker-client-latest \\</span><br><span class=\"line\">docker-common \\</span><br><span class=\"line\">docker-latest \\</span><br><span class=\"line\">docker-latest-logrotate \\</span><br><span class=\"line\">docker-logrotate \\</span><br><span class=\"line\">docker-selinux \\</span><br><span class=\"line\">docker-engine-selinux \\</span><br><span class=\"line\">docker-engine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装基础依赖</span></span><br><span class=\"line\">yum install -y yum-utils lvm2 wget</span><br><span class=\"line\"><span class=\"comment\"># 安装 nfs-utils 必须先安装 nfs-utils 才能挂载 nfs 网络存储</span></span><br><span class=\"line\">yum install -y nfs-utils</span><br><span class=\"line\"><span class=\"comment\"># 添加 docker 镜像仓库</span></span><br><span class=\"line\">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># CentOS8</span></span><br><span class=\"line\"><span class=\"comment\"># dnf -y install https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 docker</span></span><br><span class=\"line\">yum list docker-ce --showduplicates | sort -r</span><br><span class=\"line\"><span class=\"built_in\">read</span> -p <span class=\"string\">'请输入需要安装的Docker-ce的版本号(例如:19.03.9):'</span> VERSION</span><br><span class=\"line\">yum install -y docker-ce-<span class=\"variable\">$&#123;VERSION&#125;</span> docker-ce-cli-<span class=\"variable\">$&#123;VERSION&#125;</span> containerd.io</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 Docker-compose</span></span><br><span class=\"line\">curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.5/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class=\"built_in\">local</span>/bin/docker-compose</span><br><span class=\"line\">chmod +x /usr/<span class=\"built_in\">local</span>/bin/docker-compose</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 镜像源加速配置</span></span><br><span class=\"line\"><span class=\"comment\"># curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s $&#123;REGISTRY_MIRROR&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># curl -sSL https://kuboard.cn/install-script/set_mirror.sh | sh -s $&#123;REGISTRY_MIRROR&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># </span></span><br><span class=\"line\"><span class=\"comment\"># General CentOS8</span></span><br><span class=\"line\">mkdir /etc/docker/</span><br><span class=\"line\">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class=\"line\">&#123;<span class=\"string\">\"registry-mirrors\"</span>: [<span class=\"string\">\"REPLACE\"</span>]&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sed -i <span class=\"string\">\"s#REPLACE#<span class=\"variable\">$&#123;REGISTRY_MIRROR&#125;</span>#g\"</span> /etc/docker/daemon.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动docker并查看安装后的版本信息</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> docker</span><br><span class=\"line\">systemctl start docker</span><br><span class=\"line\">docker-compose -v</span><br><span class=\"line\">docker info</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"2-K8s-基础环境\"><a href=\"#2-K8s-基础环境\" class=\"headerlink\" title=\"2.K8s 基础环境\"></a>2.K8s 基础环境</h4><p>描述:以下是对于K8s基础环境的安装以及分别实现Master和Node节点初始化;</p>\n<p>k8s 环境安装设置:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubneets 版本号</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> K8SVERSION=<span class=\"string\">\"1.18.3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 卸载旧版本</span></span><br><span class=\"line\">yum remove -y kubelet kubeadm kubectl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置K8S的yum源</span></span><br><span class=\"line\">cat &lt;&lt;<span class=\"string\">'EOF'</span> &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">repo_gpgcheck=0</span><br><span class=\"line\">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class=\"line\">      http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装kubelet、kubeadm、kubectl</span></span><br><span class=\"line\"><span class=\"comment\"># 将 $&#123;1&#125; 替换为 kubernetes 版本号，例如 1.18.3</span></span><br><span class=\"line\">yum list kubeadm --showduplicates|sort -r</span><br><span class=\"line\">yum install -y  kubeadm-<span class=\"variable\">$&#123;K8SVERSION&#125;</span> kubectl-<span class=\"variable\">$&#123;K8SVERSION&#125;</span> kubelet-<span class=\"variable\">$&#123;K8SVERSION&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改docker Cgroup Driver为systemd</span></span><br><span class=\"line\"><span class=\"comment\"># # 将/usr/lib/systemd/system/docker.service文件中的这一行 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span></span><br><span class=\"line\"><span class=\"comment\"># # 修改为 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd</span></span><br><span class=\"line\"><span class=\"comment\"># 如果不修改在添加 worker 节点时可能会碰到如下错误</span></span><br><span class=\"line\"><span class=\"comment\"># [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". </span></span><br><span class=\"line\"><span class=\"comment\"># Please follow the guide at https://kubernetes.io/docs/setup/cri/    </span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g\"</span> /usr/lib/systemd/system/docker.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启 docker，并启动 kubelet</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart docker</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"3-master-主控制节点配置\"><a href=\"#3-master-主控制节点配置\" class=\"headerlink\" title=\"3.master - 主控制节点配置\"></a>3.master - 主控制节点配置</h4><p>描述:关于初始化时用到的环境变量</p>\n<ul>\n<li>APISERVER_NAME 不能是 master 的 hostname</li>\n<li>APISERVER_NAME 必须全为小写字母、数字、小数点，不能包含减号</li>\n<li>POD_SUBNET 所使用的网段不能与 master节点/worker节点 所在的网段重叠。该字段的取值为一个 CIDR 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.1/16 命令，不做修改</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubneets 版本号</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> K8SVERSION=<span class=\"string\">\"1.18.3\"</span></span><br><span class=\"line\"><span class=\"comment\"># 替换 x.x.x.x 为 master 节点的内网IP</span></span><br><span class=\"line\"><span class=\"comment\"># export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> MASTER_IP=<span class=\"variable\">$&#123;IPADDR&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># 替换 apiserver.demo 为 您想要的 dnsName</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> APISERVER_NAME=apiserver.test</span><br><span class=\"line\"><span class=\"comment\"># 阿里云 docker hub 镜像</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只在 master 节点执行</span></span><br><span class=\"line\"><span class=\"comment\"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> POD_SUBNET=10.100.0.1/16</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;MASTER_IP&#125;</span> <span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$&#123;#POD_SUBNET&#125;</span> -eq 0 ] || [ <span class=\"variable\">$&#123;#APISERVER_NAME&#125;</span> -eq 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\033[31;1m请确保您已经设置了环境变量 POD_SUBNET 和 APISERVER_NAME \\033[0m\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 当前POD_SUBNET=<span class=\"variable\">$POD_SUBNET</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 当前APISERVER_NAME=<span class=\"variable\">$APISERVER_NAME</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看完整配置选项 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</span></span><br><span class=\"line\">rm -f ./kubeadm-config.yaml</span><br><span class=\"line\">cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">kubernetesVersion: v<span class=\"variable\">$&#123;K8SVERSION&#125;</span></span><br><span class=\"line\">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class=\"line\">controlPlaneEndpoint: <span class=\"string\">\"<span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>:6443\"</span></span><br><span class=\"line\">networking:</span><br><span class=\"line\">  serviceSubnet: <span class=\"string\">\"10.99.0.0/16\"</span></span><br><span class=\"line\">  podSubnet: <span class=\"string\">\"<span class=\"variable\">$&#123;POD_SUBNET&#125;</span>\"</span></span><br><span class=\"line\">  dnsDomain: <span class=\"string\">\"cluster.local\"</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># kubeadm init</span></span><br><span class=\"line\"><span class=\"comment\"># 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span></span><br><span class=\"line\">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置 kubectl (重点如不配置将会导致kubectl无法执行)</span></span><br><span class=\"line\">rm -rf /root/.kube/</span><br><span class=\"line\">mkdir /root/.kube/</span><br><span class=\"line\">cp -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 calico 网络插件</span></span><br><span class=\"line\"><span class=\"comment\"># 参考文档 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"---安装calico-3.13.1---\"</span></span><br><span class=\"line\">rm -f calico-3.13.1.yaml</span><br><span class=\"line\">wget https://kuboard.cn/install-script/calico/calico-3.13.1.yaml</span><br><span class=\"line\">kubectl apply -f calico-3.13.1.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只在 master 节点执行</span></span><br><span class=\"line\"><span class=\"comment\"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class=\"line\">watch kubectl get pod -n kube-system -o wide</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"---等待容器组构建完成---\"</span> &amp;&amp; sleep 180</span><br><span class=\"line\"><span class=\"comment\"># 查看 master 节点初始化结果</span></span><br><span class=\"line\">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>\n<p>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 表示初始化安装kubernetes成功</span></span><br><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\">  mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">\"kubectl apply -f [podnetwork].yaml\"</span> with one of the options listed at:</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 您现在可以加入任意数量的控制平面节点(集群)，在每个节点上运行以下命令作为根:</span></span><br><span class=\"line\">kubeadm join apiserver.test:6443 --token hzlzrr.uwuegx4locpu36oc \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:4cbe428cb3503277be9fbcf3a99de82a97397a624dd94d4270c4eed1b861f951 \\</span><br><span class=\"line\">    --control-plane --certificate-key 28b178f04afae3770aa92add0206650b2359dd61424f127a6d44142dd15a280d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过在每个工作节点上作为根运行以下操作来加入任意数量的工作节点:</span></span><br><span class=\"line\">kubeadm join apiserver.test:6443 --token hzlzrr.uwuegx4locpu36oc \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:4cbe428cb3503277be9fbcf3a99de82a97397a624dd94d4270c4eed1b861f951</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200615163724.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br></p>\n<h4 id=\"4-node-工作节点配置\"><a href=\"#4-node-工作节点配置\" class=\"headerlink\" title=\"4.node - 工作节点配置\"></a>4.node - 工作节点配置</h4><p>注意，该段命令只在Worker节点执行。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 只在 worker 节点执行</span></span><br><span class=\"line\"><span class=\"built_in\">read</span> -p <span class=\"string\">\"请输入K8s的Master节点的IP地址:\"</span> MASTER_IP</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;MASTER_IP&#125;</span>  <span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\e[32m#只在 master 节点执行以下命令\\n kubeadm token create --print-join-command\\n可获取kubeadm join 命令及参数在Node节点运行即可\\n\"</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"[注意]:该 token 的有效时间为 24 个小时，24小时内，您可以使用此 token 初始化任意数量的 worker 节点\\e[0m\"</span></span><br></pre></td></tr></table></figure></p>\n<p>如下命令按照其注释的机器或者节点上执行。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Master</span></span><br><span class=\"line\">[root@ks8test ~]<span class=\"comment\"># kubeadm token create --print-join-command</span></span><br><span class=\"line\">W0616 15:10:45.622701   23160 configset.go:202] WARNING: kubeadm cannot validate component configs <span class=\"keyword\">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class=\"line\">kubeadm join apiserver.test:6443 --token 5q3zl5.4h2xllxhy7gxccx1     --discovery-token-ca-cert-hash sha256:4cbe428cb3503277be9fbcf3a99de82a97397a624dd94d4270c4eed1b861f951</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Nodes</span></span><br><span class=\"line\">[root@node-1 ~]<span class=\"comment\"># ./CentOS7-k8s_init.sh node node-1</span></span><br><span class=\"line\">请输入K8s的Master节点的IP地址:10.10.107.193</span><br><span class=\"line\"><span class=\"comment\">#只在 master 节点执行以下命令</span></span><br><span class=\"line\">kubeadm token create --<span class=\"built_in\">print</span>-join-command</span><br><span class=\"line\">可获取kubeadm join 命令及参数在Node节点运行即可</span><br><span class=\"line\"></span><br><span class=\"line\">[注意]:该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token 初始化任意数量的 worker 节点</span><br><span class=\"line\">[root@node-1 ~]<span class=\"comment\"># kubeadm join apiserver.test:6443 --token 5q3zl5.4h2xllxhy7gxccx1     --discovery-token-ca-cert-hash sha256:4cbe428cb3503277be9fbcf3a99de82a97397a624dd94d4270c4eed1b861f951</span></span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the cluster...</span><br><span class=\"line\">[preflight] FYI: You can look at this config file with <span class=\"string\">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class=\"line\">[kubelet-start] Downloading configuration <span class=\"keyword\">for</span> the kubelet from the <span class=\"string\">\"kubelet-config-1.18\"</span> ConfigMap <span class=\"keyword\">in</span> the kube-system namespace</span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">\"/var/lib/kubelet/config.yaml\"</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">\"/var/lib/kubelet/kubeadm-flags.env\"</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap...</span><br><span class=\"line\">This node has joined the cluster:</span><br><span class=\"line\">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class=\"line\">* The Kubelet was informed of the new secure connection details.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Master 运行查看加入的节点</span></span><br><span class=\"line\">Run <span class=\"string\">'kubectl get nodes'</span> on the control-plane to see this node join the cluster.</span><br><span class=\"line\">[root@ks8test ~]<span class=\"comment\"># kubectl get nodes</span></span><br><span class=\"line\">NAME      STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">ks8test   Ready    master   22h   v1.18.3</span><br><span class=\"line\">node-1    Ready    &lt;none&gt;   67s   v1.18.3</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"0x02-手动安装K8s集群-在线\"><a href=\"#0x02-手动安装K8s集群-在线\" class=\"headerlink\" title=\"0x02 手动安装K8s集群(在线)\"></a>0x02 手动安装K8s集群(在线)</h3><p>描述:安装K8s高可用集群至少需要三个Master节点和不限制节点数量的工作节点进行组成，否则会出现<code>脑裂</code>的现象；</p>\n<ul>\n<li>三个 master 组成主节点集群，通过内网 loader balancer 实现负载均衡</li>\n<li>多个 worker 组成工作节点集群，通过外网 loader balancer 实现负载均衡</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200628114808.png\" alt=\"WeiyiGeek.集群架构\" title=\"\" class=\"\">\n                <p>WeiyiGeek.集群架构</p>\n            </figure>\n<p>集群安装环境说明以及IP地址规划说明：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 操作系统</span></span><br><span class=\"line\">CentOS Linux release 7.8.2003 (Core)</span><br><span class=\"line\"><span class=\"comment\"># 内核版本</span></span><br><span class=\"line\">5.7.0-1.el7.elrepo.x86_64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 应用版本</span></span><br><span class=\"line\">docker 19.03.9</span><br><span class=\"line\">docker-compose 1.25.5</span><br><span class=\"line\">Kubernetes 1.18.4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 依赖镜像和版本</span></span><br><span class=\"line\"><span class=\"comment\"># docker images | awk -F ' ' '&#123;print $1\":\"$2&#125;'</span></span><br><span class=\"line\"><span class=\"comment\"># REPOSITORY:TAG</span></span><br><span class=\"line\">mirrorgcrio/kube-proxy:v1.18.4</span><br><span class=\"line\">mirrorgcrio/kube-apiserver:v1.18.4</span><br><span class=\"line\">mirrorgcrio/kube-controller-manager:v1.18.4</span><br><span class=\"line\">mirrorgcrio/kube-scheduler:v1.18.4</span><br><span class=\"line\">calico/node:v3.13.1</span><br><span class=\"line\">calico/pod2daemon-flexvol:v3.13.1</span><br><span class=\"line\">calico/cni:v3.13.1</span><br><span class=\"line\">calico/kube-controllers:v3.13.1</span><br><span class=\"line\">mirrorgcrio/pause:3.2</span><br><span class=\"line\">mirrorgcrio/coredns:1.6.7</span><br><span class=\"line\">mirrorgcrio/etcd:3.4.3-0</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><em>IP地址规划</em></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">IP</th>\n<th style=\"text-align:center\">主机名称</th>\n<th style=\"text-align:center\">备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">10.10.107.191</td>\n<td style=\"text-align:center\">master-01</td>\n<td style=\"text-align:center\">主Master节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.10.107.192</td>\n<td style=\"text-align:center\">master-02</td>\n<td style=\"text-align:center\">从Master节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.10.107.193</td>\n<td style=\"text-align:center\">master-03</td>\n<td style=\"text-align:center\">从Master节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.10.107.194</td>\n<td style=\"text-align:center\">worker-01</td>\n<td style=\"text-align:center\">工作节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">10.10.107.196</td>\n<td style=\"text-align:center\">worker-02</td>\n<td style=\"text-align:center\">工作节点</td>\n</tr>\n</tbody>\n</table>\n<p><br/></p>\n<p><em>ApiServer 的 Load Balancer（私网）相关:</em><br>监听连接端口：6443 / TCP<br>后端资源组：包含 master-01,master-02,master-03;<br>实现 Load Balancer 方式:<code>nginx / haproxy / keepalived / 云供应商提供的负载均衡产品</code>,这里我们暂时不涉及；</p>\n<p><br/></p>\n<p><em>特别注意:</em></p>\n<ul>\n<li>1.任意节点建议大于等于centos 版本为 7.6 或 7.7;</li>\n<li>2.任意节点 CPU 内核数量大于等于 2，且内存大于等于 4G;</li>\n<li>3.任意节点 hostname 不是 localhost，且不包含下划线、小数点、大写字母并且不能重复;</li>\n<li>4.任意节点都有固定的内网 IP 地址且为单网卡</li>\n<li>5.任意节点上 Kubelet使用的 IP 地址 可互通无需 NAT 映射即可相互访问），且没有防火墙、安全组隔离Selinux;</li>\n<li>6.任意节点上临时的swap分区将被关闭;</li>\n<li>7.任意节点上初始化时用到的环境变量APISERVER_NAME是一致的,不能是 master 的 hostname并且必须全为小写字母、数字、小数点，不能包含减号;</li>\n<li>8.任意节点上初始化时用到的环境变量 POD_SUBNET 所使用的网段不能与 master节点/worker节点 所在的网段重叠(常常是一个A类私有地址-CIDR 值)。</li>\n<li>9.任意的master节点在进行初始化的时候，如果中间出现部署步骤的配置出错，需要<code>重新初始化 master 节点</code>时请先执行 <code>kubeadm reset</code> 操作</li>\n</ul>\n<p><br/></p>\n<p><strong>操作流程:</strong></p>\n<ul>\n<li>1.全部主机都需要执行以下脚本进行<code>基础环境配置与(docker/docker-compose/kubernetes)安装</code>所以需要对其进行自定义的修改配置(主要是:<code>节点主机名称/APISERVER/APIPORT</code>);</li>\n</ul>\n<p>基础环境:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> HOSTNAME=worker-02</span><br><span class=\"line\"><span class=\"comment\"># 临时关闭swap和SELinux</span></span><br><span class=\"line\">swapoff -a &amp;&amp; setenforce 0</span><br><span class=\"line\"><span class=\"comment\"># 永久关闭swap和SELinux</span></span><br><span class=\"line\">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class=\"line\">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class=\"line\">sed -i <span class=\"string\">'s/^SELINUX=.*$/SELINUX=disabled/'</span> /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机名设置(这里主机名称安装上面的IP地址规划对应的主机名称-根据安装的主机进行变化)</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname <span class=\"variable\">$HOSTNAME</span></span><br><span class=\"line\">hostnamectl status</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机名设置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"127.0.0.1 <span class=\"variable\">$HOSTNAME</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class=\"line\">10.10.107.191 master-01</span><br><span class=\"line\">10.10.107.192 master-02</span><br><span class=\"line\">10.10.107.193 master-03</span><br><span class=\"line\">10.10.107.194 worker-01</span><br><span class=\"line\">10.10.107.196 worker-02</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 命令自动补齐</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"source &lt;(kubectl completion bash)\"</span> &gt;&gt; ~/.bashrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># DNS 设置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"nameserver 223.6.6.6\\nnameserver 192.168.10.254\"</span> &gt;&gt; /etc/resolv.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭防火墙</span></span><br><span class=\"line\">systemctl stop firewalld &amp;&amp; systemctl <span class=\"built_in\">disable</span> firewalld</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># docker 安装配置 (如果已经安装过了则可以跳过)</span></span><br><span class=\"line\"><span class=\"comment\"># 安装基础依赖</span></span><br><span class=\"line\">yum install -y yum-utils lvm2 wget</span><br><span class=\"line\"><span class=\"comment\"># 安装 nfs-utils 必须先安装 nfs-utils 才能挂载 nfs 网络存储</span></span><br><span class=\"line\">yum install -y nfs-utils</span><br><span class=\"line\"><span class=\"comment\"># 添加 docker 镜像仓库</span></span><br><span class=\"line\">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看可用Docker版本以及安装Docker</span></span><br><span class=\"line\">yum list docker-ce --showduplicates | sort -r</span><br><span class=\"line\"><span class=\"built_in\">read</span> -p <span class=\"string\">'请输入需要安装的Docker-ce的版本号(例如:19.03.9):'</span> VERSION</span><br><span class=\"line\">yum install -y docker-ce-<span class=\"variable\">$&#123;VERSION&#125;</span> docker-ce-cli-<span class=\"variable\">$&#123;VERSION&#125;</span> containerd.io</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 Docker-compose</span></span><br><span class=\"line\">curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.5/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class=\"built_in\">local</span>/bin/docker-compose</span><br><span class=\"line\">chmod +x /usr/<span class=\"built_in\">local</span>/bin/docker-compose</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 镜像源加速配置</span></span><br><span class=\"line\"><span class=\"comment\"># 如果文件夹不存在则建立/etc/docker/</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ ! -d <span class=\"string\">\"/etc/docker/\"</span> ]];<span class=\"keyword\">then</span> mkdir /etc/docker/;<span class=\"keyword\">fi</span></span><br><span class=\"line\">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class=\"line\">&#123;<span class=\"string\">\"registry-mirrors\"</span>: [<span class=\"string\">\"REPLACE\"</span>]&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sed -i <span class=\"string\">\"s#REPLACE#<span class=\"variable\">$&#123;REGISTRY_MIRROR&#125;</span>#g\"</span> /etc/docker/daemon.json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动docker并查看安装后的版本信息</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class=\"line\">docker-compose -v &amp;&amp; docker info</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改 /etc/sysctl.conf 进行内核参数的配置</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv4.ip_forward.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv4.ip_forward.*|net.ipv4.ip_forward = 1|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_forward = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-ip6tables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-ip6tables.*|net.bridge.bridge-nf-call-ip6tables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-ip6tables = 1\"</span> &gt;&gt; /etc/sysctl.conf </span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-iptables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-iptables.*|net.bridge.bridge-nf-call-iptables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-iptables = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.all.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.all.disable_ipv6.*|net.ipv6.conf.all.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.all.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.default.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.default.disable_ipv6.*|net.ipv6.conf.default.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.default.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.lo.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.lo.disable_ipv6.*|net.ipv6.conf.lo.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.lo.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.all.forwarding.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.all.forwarding.*|net.ipv6.conf.all.forwarding = 1|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.all.forwarding = 1\"</span>  &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\"><span class=\"comment\"># 使修改的内核参数立即生效</span></span><br><span class=\"line\">sysctl -p</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置K8S的yum源</span></span><br><span class=\"line\">  cat &lt;&lt;<span class=\"string\">'EOF'</span> &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">repo_gpgcheck=0</span><br><span class=\"line\">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class=\"line\">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看安装kubelet、kubeadm、kubectl 指定统一的kubernetes 版本号，例如 1.18.4</span></span><br><span class=\"line\">yum list kubelet --showduplicates | tail -n 10</span><br><span class=\"line\">yum install -y kubelet-1.18.4 kubeadm-1.18.4 kubectl-1.18.4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改docker Cgroup Driver为systemd</span></span><br><span class=\"line\"><span class=\"comment\"># # 将/usr/lib/systemd/system/docker.service文件中的这一行 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span></span><br><span class=\"line\"><span class=\"comment\"># # 修改为 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd</span></span><br><span class=\"line\"><span class=\"comment\"># 如果不修改在添加 worker 节点时可能会碰到如下错误</span></span><br><span class=\"line\"><span class=\"comment\"># [WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cgroup driver. The recommended driver is \"systemd\". </span></span><br><span class=\"line\"><span class=\"comment\"># Please follow the guide at https://kubernetes.io/docs/setup/cri/    </span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g\"</span> /usr/lib/systemd/system/docker.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启 docker，并启动 kubelet</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet</span><br><span class=\"line\">systemctl restart docker &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>2.仅在主Master节点(<code>10.10.107.191</code>)上进行Master节点初始化操作(<code>该节点也是接入集群使用的ip</code>);<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">APISERVER_IP=10.10.107.191</span><br><span class=\"line\">APISERVER_NAME=k8s.weiyigeek.top</span><br><span class=\"line\">APISERVER_PORT=6443</span><br><span class=\"line\">SERVICE_SUBNET=10.99.0.0/16</span><br><span class=\"line\"><span class=\"comment\"># calico 缺省子网</span></span><br><span class=\"line\">POD_SUBNET=10.100.0.1/16</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;APISERVER_IP&#125;</span> <span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 初始化配置(建议各个组件的版本与k8s的版本一致)</span></span><br><span class=\"line\">rm -f ./kubeadm-config.yaml</span><br><span class=\"line\">  cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">kubernetesVersion: v<span class=\"variable\">$&#123;K8SVERSION&#125;</span></span><br><span class=\"line\">imageRepository: mirrorgcrio</span><br><span class=\"line\"><span class=\"comment\">#imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class=\"line\"><span class=\"comment\">#imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class=\"line\"><span class=\"comment\">#imageRepository: gcr.azk8s.cn/google_containers</span></span><br><span class=\"line\">controlPlaneEndpoint: <span class=\"string\">\"<span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>:<span class=\"variable\">$&#123;APISERVER_PORT&#125;</span>\"</span></span><br><span class=\"line\">networking:</span><br><span class=\"line\">  serviceSubnet: <span class=\"string\">\"<span class=\"variable\">$&#123;SERVICE_SUBNET&#125;</span>\"</span></span><br><span class=\"line\">  podSubnet: <span class=\"string\">\"<span class=\"variable\">$&#123;POD_SUBNET&#125;</span>\"</span></span><br><span class=\"line\">  dnsDomain: <span class=\"string\">\"cluster.local\"</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># kubeadm init 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span></span><br><span class=\"line\">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置 kubectl否则不能执行kubectl get pods -A</span></span><br><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 calico 网络插件</span></span><br><span class=\"line\"><span class=\"comment\"># 参考文档 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span></span><br><span class=\"line\">rm -f calico-3.13.1.yaml</span><br><span class=\"line\">wget -L https://kuboard.cn/install-script/calico/calico-3.13.1.yaml</span><br><span class=\"line\">kubectl apply -f calico-3.13.1.yaml</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class=\"line\">watch kubectl get pod -n kube-system -o wide</span><br><span class=\"line\"><span class=\"comment\"># NAME                                       READY   STATUS    RESTARTS   AGE   IP              NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class=\"line\"><span class=\"comment\"># calico-kube-controllers-5b8b769fcd-ns9r4   1/1     Running   0          6m   10.100.184.65   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># calico-node-bg2g9                          1/1     Running   0          6m   10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># coredns-54f99b968c-2tqc4                   1/1     Running   0          6m   10.100.184.67   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># coredns-54f99b968c-672zn                   1/1     Running   0          6m   10.100.184.66   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># etcd-master-01                             1/1     Running   0          6m   10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-apiserver-master-01                   1/1     Running   0          6m   10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-controller-manager-master-01          1/1     Running   0          6m   10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-proxy-trg7v                           1/1     Running   0          6m   10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-scheduler-master-01                   1/1     Running   0          6m   10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 此时主节点的状态应该为Ready</span></span><br><span class=\"line\">kubectl get node -o wide</span><br><span class=\"line\"><span class=\"comment\"># NAME        STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION              CONTAINER-RUNTIME</span></span><br><span class=\"line\"><span class=\"comment\"># master-01   Ready    master   7m   v1.18.4   10.10.107.191   &lt;none&gt;        CentOS Linux 7 (Core)   5.7.0-1.el7.elrepo.x86_64   docker://19.3.9</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 下载的镜像信息</span></span><br><span class=\"line\">docker images</span><br><span class=\"line\"><span class=\"comment\"># REPOSITORY                            TAG                 IMAGE ID            CREATED             SIZE</span></span><br><span class=\"line\"><span class=\"comment\"># mirrorgcrio/kube-proxy                v1.18.4             718fa77019f2        5 days ago          117MB</span></span><br><span class=\"line\"><span class=\"comment\"># mirrorgcrio/kube-apiserver            v1.18.4             408913fc18eb        5 days ago          173MB</span></span><br><span class=\"line\"><span class=\"comment\"># mirrorgcrio/kube-scheduler            v1.18.4             c663567f869e        5 days ago          95.3MB</span></span><br><span class=\"line\"><span class=\"comment\"># mirrorgcrio/kube-controller-manager   v1.18.4             e8f1690127c4        5 days ago          162MB</span></span><br><span class=\"line\"><span class=\"comment\"># calico/node                           v3.13.1             2e5029b93d4a        3 months ago        260MB</span></span><br><span class=\"line\"><span class=\"comment\"># calico/pod2daemon-flexvol             v3.13.1             e8c600448aae        3 months ago        111MB</span></span><br><span class=\"line\"><span class=\"comment\"># calico/cni                            v3.13.1             6912ec2cfae6        3 months ago        207MB</span></span><br><span class=\"line\"><span class=\"comment\"># calico/kube-controllers               v3.13.1             3971f13f2c6c        3 months ago        56.6MB</span></span><br><span class=\"line\"><span class=\"comment\"># mirrorgcrio/pause                     3.2                 80d28bedfe5d        4 months ago        683kB</span></span><br><span class=\"line\"><span class=\"comment\"># mirrorgcrio/coredns                   1.6.7               67da37a9a360        4 months ago        43.8MB</span></span><br><span class=\"line\"><span class=\"comment\"># mirrorgcrio/etcd                      3.4.3-0             303ce5db0e90        8 months ago        288MB</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 现在应该将pod网络部署到集群部署calico 插件(安装集群网络)</span></span><br><span class=\"line\">kubectl apply -f calico-3.13.1.yaml</span><br><span class=\"line\"><span class=\"comment\"># configmap/calico-config created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span></span><br><span class=\"line\"><span class=\"comment\"># clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class=\"line\"><span class=\"comment\"># clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class=\"line\"><span class=\"comment\"># clusterrole.rbac.authorization.k8s.io/calico-node created</span></span><br><span class=\"line\"><span class=\"comment\"># clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span></span><br><span class=\"line\"><span class=\"comment\"># daemonset.apps/calico-node created</span></span><br><span class=\"line\"><span class=\"comment\"># serviceaccount/calico-node created</span></span><br><span class=\"line\"><span class=\"comment\"># deployment.apps/calico-kube-controllers created</span></span><br><span class=\"line\"><span class=\"comment\"># serviceaccount/calico-kube-controllers Created</span></span><br></pre></td></tr></table></figure></p>\n<p><span style=\"color:red\">注意：请等到所有容器组（大约9个）全部处于 Running 状态，才进行下一步</span></p>\n<ul>\n<li>3.在其余两台从Master节点上运行第二条命令便会加入到master集群之中,但是执行下面<code>(1) (2)</code>前我们需要将使用到的镜像进行下载;</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 由于国内无法访问k8s.gcr.io则在进行从master节点初始化时候会一直卡在加入控制平面节点命令后，一直到超时时间；</span></span><br><span class=\"line\"><span class=\"comment\"># 解决办法: 从Docker官方默认镜像平台拉取镜像并重新打tag的方式来绕过对 k8s.gcr.io 的访问。 </span></span><br><span class=\"line\">kubeadm config images pull --image-repository mirrorgcrio</span><br><span class=\"line\"><span class=\"comment\"># [config/images] Pulled mirrorgcrio/kube-apiserver:v1.18.4</span></span><br><span class=\"line\"><span class=\"comment\"># [config/images] Pulled mirrorgcrio/kube-controller-manager:v1.18.4</span></span><br><span class=\"line\"><span class=\"comment\"># [config/images] Pulled mirrorgcrio/kube-scheduler:v1.18.4</span></span><br><span class=\"line\"><span class=\"comment\"># [config/images] Pulled mirrorgcrio/kube-proxy:v1.18.4</span></span><br><span class=\"line\"><span class=\"comment\"># [config/images] Pulled mirrorgcrio/pause:3.2</span></span><br><span class=\"line\"><span class=\"comment\"># [config/images] Pulled mirrorgcrio/etcd:3.4.3-0</span></span><br><span class=\"line\"><span class=\"comment\"># [config/images] Pulled mirrorgcrio/coredns:1.6.7</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm config images list --image-repository mirrorgcrio &gt; gcr.io.log </span><br><span class=\"line\"><span class=\"comment\"># 重新为镜像打上tag为 k8s.gcr.io\\镜像名称:版本</span></span><br><span class=\"line\">sed -e <span class=\"string\">\"s#\\\\(/.*$\\\\)#\\1 k8s.gcr.io\\1#g\"</span> gcr.io.log &gt; gcr.io.log1</span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"built_in\">read</span> k8sgcrio;<span class=\"keyword\">do</span></span><br><span class=\"line\">  docker tag <span class=\"variable\">$&#123;k8sgcrio&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span> &lt; gcr.io.log1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除tag带有mirrorgcrio</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"built_in\">read</span> k8s;<span class=\"keyword\">do</span></span><br><span class=\"line\">  docker rmi <span class=\"variable\">$&#123;k8s&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span> &lt; gcr.io.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 最后的效果</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span> images</span><br><span class=\"line\"><span class=\"comment\"># REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE</span></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io/kube-proxy                v1.18.4             718fa77019f2        6 days ago          117MB</span></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io/kube-scheduler            v1.18.4             c663567f869e        6 days ago          95.3MB</span></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io/kube-apiserver            v1.18.4             408913fc18eb        6 days ago          173MB</span></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io/kube-controller-manager   v1.18.4             e8f1690127c4        6 days ago          162MB</span></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io/pause                     3.2                 80d28bedfe5d        4 months ago        683kB</span></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io/coredns                   1.6.7               67da37a9a360        4 months ago        43.8MB</span></span><br><span class=\"line\"><span class=\"comment\"># k8s.gcr.io/etcd                      3.4.3-0             303ce5db0e90        8 months ago        288MB</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) APIServer进行主MasterIP以及Server名称配置</span></span><br><span class=\"line\">APISERVER_IP=10.10.107.191</span><br><span class=\"line\">APISERVER_NAME=k8s.weiyigeek.top</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;APISERVER_IP&#125;</span> <span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 从Master节点加入控制平面节点(certificate-key) 两个小时后失效</span></span><br><span class=\"line\">kubeadm join k8s.weiyigeek.top:6443 --token opcpye.79zeofy6eo4h9ag6 \\</span><br><span class=\"line\">  --discovery-token-ca-cert-hash sha256:0795075090d621285dbaa4a76b9b320150f5ae3c37f5d7b92fc1c4f8942d9243 \\</span><br><span class=\"line\">  --control-plane --certificate-key 6dbee003011ac1dae15ae1fad3014ac8b568d154387aa0c43663d5fc47a109c4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 拷贝kubernetes配置文件到用户家目录中(如果不执行则kubectl get 资源会出错)</span></span><br><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200624000734.png\" alt=\"WeiyiGeek.从Master节点\" title=\"\" class=\"\">\n                <p>WeiyiGeek.从Master节点</p>\n            </figure>\n<ul>\n<li><p>4.其余两台Node节点上运行<code>kubeadm join</code>命令;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) APIServer进行主MasterIP以及Server名称配置</span></span><br><span class=\"line\">APISERVER_IP=10.10.107.191</span><br><span class=\"line\">APISERVER_NAME=k8s.weiyigeek.top</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;APISERVER_IP&#125;</span> <span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 将worker工作节点加入到受Master节点管理的集群中;</span></span><br><span class=\"line\">kubeadm join k8s.weiyigeek.top:6443 --token opcpye.79zeofy6eo4h9ag6 \\</span><br><span class=\"line\">  --discovery-token-ca-cert-hash sha256:0795075090d621285dbaa4a76b9b320150f5ae3c37f5d7b92fc1c4f8942d9243</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5.在K8s集群中配置etcd的cluster，修改etcd.yaml文件中的–initial-cluster参数保证三台Master节点机器都是加入到etcd集群中的;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 所有 Master 节点机器配置如下:</span></span><br><span class=\"line\">[root@master-01 ~]$ grep -n <span class=\"string\">\"initial-cluster\"</span> /etc/kubernetes/manifests/etcd.yaml</span><br><span class=\"line\">21:    - --initial-cluster=master-01=https://10.10.107.191:2380,master-03=https://10.10.107.193:2380,master-02=https://10.10.107.192:2380</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master-02 ~]$ grep -n <span class=\"string\">\"initial-cluster\"</span> /etc/kubernetes/manifests/etcd.yaml</span><br><span class=\"line\">21:    - --initial-cluster=master-01=https://10.10.107.191:2380,master-02=https://10.10.107.192:2380,master-03=https://10.10.107.193:2380</span><br><span class=\"line\">22:    - --initial-cluster-state=existing</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master-03 ~]$ grep -n <span class=\"string\">\"initial-cluster\"</span> /etc/kubernetes/manifests/etcd.yaml</span><br><span class=\"line\">21:    - --initial-cluster=master-01=https://10.10.107.191:2380,master-03=https://10.10.107.193:2380,master-02=https://10.10.107.192:2380</span><br><span class=\"line\">22:    - --initial-cluster-state=existing</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 其后再修改 kube-apiserver etcd 连接为集群中各个节点ip</span></span><br><span class=\"line\">[root@master-01 ~]$ grep -n <span class=\"string\">\"etcd-servers\"</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class=\"line\">25:    - --etcd-servers=https://10.10.107.191:2379,https://10.10.107.192:2379,https://10.10.107.193:2379</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master-02 ~]$ grep -n <span class=\"string\">\"etcd-servers\"</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class=\"line\">25:    - --etcd-servers=https://10.10.107.191:2379,https://10.10.107.192:2379,https://10.10.107.193:2379</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master-03 ~]$ grep -n <span class=\"string\">\"etcd-servers\"</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class=\"line\">25:    - --etcd-servers=https://10.10.107.191:2379,https://10.10.107.192:2379,https://10.10.107.193:2379</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>5.验证master集群是否部署正常<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get nodes -o wide</span><br><span class=\"line\"><span class=\"comment\"># NAME        STATUS   ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION              CONTAINER-RUNTIME</span></span><br><span class=\"line\"><span class=\"comment\"># master-01   Ready    master   5d1h    v1.18.4   10.10.107.191   &lt;none&gt;        CentOS Linux 7 (Core)   5.7.0-1.el7.elrepo.x86_64   docker://19.3.9</span></span><br><span class=\"line\"><span class=\"comment\"># master-02   Ready    master   4d13h   v1.18.4   10.10.107.192   &lt;none&gt;        CentOS Linux 7 (Core)   5.7.0-1.el7.elrepo.x86_64   docker://19.3.9</span></span><br><span class=\"line\"><span class=\"comment\"># master-03   Ready    master   4d4h    v1.18.4   10.10.107.193   &lt;none&gt;        CentOS Linux 7 (Core)   5.7.0-1.el7.elrepo.x86_64   docker://19.3.9</span></span><br><span class=\"line\"><span class=\"comment\"># worker-01   Ready    &lt;none&gt;   5d1h    v1.18.4   10.10.107.194   &lt;none&gt;        CentOS Linux 7 (Core)   5.7.0-1.el7.elrepo.x86_64   docker://19.3.9</span></span><br><span class=\"line\"><span class=\"comment\"># worker-02   Ready    &lt;none&gt;   4d14h   v1.18.4   10.10.107.196   &lt;none&gt;        CentOS Linux 7 (Core)   5.7.0-1.el7.elrepo.x86_64   docker://19.3.9</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pods -A -o wide</span><br><span class=\"line\"><span class=\"comment\"># NAMESPACE     NAME                                       READY   STATUS             RESTARTS   AGE     IP              NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class=\"line\"><span class=\"comment\"># default       helloworld                                 0/1     CrashLoopBackOff   1089       3d21h   10.100.37.193   worker-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   calico-kube-controllers-5b8b769fcd-ns9r4   1/1     Running            0          5d1h    10.100.184.65   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   calico-node-8rn2s                          1/1     Running            0          4d4h    10.10.107.193   master-03   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   calico-node-bg2g9                          1/1     Running            0          5d1h    10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   calico-node-d2vqd                          1/1     Running            0          4d13h   10.10.107.196   worker-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   calico-node-n48dt                          1/1     Running            0          4d13h   10.10.107.192   master-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   calico-node-whznq                          1/1     Running            1          5d1h    10.10.107.194   worker-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   coredns-54f99b968c-2tqc4                   1/1     Running            0          5d1h    10.100.184.67   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   coredns-54f99b968c-672zn                   1/1     Running            0          5d1h    10.100.184.66   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   etcd-master-01                             1/1     Running            0          4d2h    10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   etcd-master-02                             1/1     Running            0          4d2h    10.10.107.192   master-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   etcd-master-03                             1/1     Running            0          4d4h    10.10.107.193   master-03   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-apiserver-master-01                   1/1     Running            0          4d2h    10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-apiserver-master-02                   1/1     Running            0          4d2h    10.10.107.192   master-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-apiserver-master-03                   1/1     Running            0          4d2h    10.10.107.193   master-03   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-controller-manager-master-01          1/1     Running            3          5d1h    10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-controller-manager-master-02          1/1     Running            2          4d13h   10.10.107.192   master-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-controller-manager-master-03          1/1     Running            1          4d4h    10.10.107.193   master-03   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-proxy-5jjql                           1/1     Running            0          4d13h   10.10.107.196   worker-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-proxy-7ln9t                           1/1     Running            1          5d1h    10.10.107.194   worker-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-proxy-8x257                           1/1     Running            0          4d4h    10.10.107.193   master-03   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-proxy-gbm52                           1/1     Running            0          4d13h   10.10.107.192   master-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-proxy-trg7v                           1/1     Running            0          5d1h    10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-scheduler-master-01                   1/1     Running            1          5d1h    10.10.107.191   master-01   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-scheduler-master-02                   1/1     Running            3          4d13h   10.10.107.192   master-02   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># kube-system   kube-scheduler-master-03                   1/1     Running            2          4d4h    10.10.107.193   master-03   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 组件健康信息查看</span></span><br><span class=\"line\">[root@master-01 ~]$ kubectl get cs</span><br><span class=\"line\">NAME                 STATUS    MESSAGE             ERROR</span><br><span class=\"line\">scheduler            Healthy   ok</span><br><span class=\"line\">controller-manager   Healthy   ok</span><br><span class=\"line\">etcd-1               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\">etcd-2               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\">etcd-0               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master-02 ~]$ kubectl get cs</span><br><span class=\"line\">NAME                 STATUS    MESSAGE             ERROR</span><br><span class=\"line\">scheduler            Healthy   ok</span><br><span class=\"line\">controller-manager   Healthy   ok</span><br><span class=\"line\">etcd-2               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\">etcd-0               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\">etcd-1               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master-03 ~]$ kubectl get cs</span><br><span class=\"line\">NAME                 STATUS    MESSAGE             ERROR</span><br><span class=\"line\">controller-manager   Healthy   ok</span><br><span class=\"line\">scheduler            Healthy   ok</span><br><span class=\"line\">etcd-2               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\">etcd-1               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\">etcd-0               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置信息查看</span></span><br><span class=\"line\">kubectl get cm kubeadm-config -n kube-system -o yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#选举信息查看</span></span><br><span class=\"line\">kubectl get ep kube-controller-manager -n kube-system -o yaml</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200628155350.png\" alt=\"WeiyiGeek.选举查看\" title=\"\" class=\"\">\n                <p>WeiyiGeek.选举查看</p>\n            </figure>\n</li>\n</ul>\n<ul>\n<li><p>6.移除 worker 节点</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(1)在准备移除的 worker 节点上执行</span></span><br><span class=\"line\">kubeadm reset</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在第一个 master 节点 master-01 上执行,worker 节点的名字可以通过执行 kubectl get nodes 命令获得;</span></span><br><span class=\"line\">kubectl delete node worker-02</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>7.至此一个简单的K8s集群就搭建完毕,最后再补充一点关于token失效的问题采用以下命令搞定,<code>需要在主Master节点上运行命令</code>;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1)查看token是否失效默认是24H</span></span><br><span class=\"line\">kubeadm token list</span><br><span class=\"line\"><span class=\"comment\"># TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS</span></span><br><span class=\"line\"><span class=\"comment\"># opcpye.79zeofy6eo4h9ag6   13h         2020-06-24T12:45:29+08:00   authentication,signing   &lt;none&gt;                                                     system:bootstrappers:kubeadm:default-node-token</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 方式(1) ## </span></span><br><span class=\"line\"><span class=\"comment\"># (2)从节点的 kubeadm 加入到k8s集群之中 (推荐)，使用此命令调用init工作流的单个阶段</span></span><br><span class=\"line\">kubeadm init phase upload-certs --upload-certs</span><br><span class=\"line\"><span class=\"comment\"># [upload-certs] Using certificate key:</span></span><br><span class=\"line\"><span class=\"comment\"># 70eb87e62f052d2d5de759969d5b42f372d0ad798f98df38f7fe73efdf63a13c</span></span><br><span class=\"line\">kubeadm token create --<span class=\"built_in\">print</span>-join-command</span><br><span class=\"line\"><span class=\"comment\"># kubeadm join apiserver.demo:6443 --token bl80xo.hfewon9l5jlpmjft --discovery-token-ca-cert-hash sha256:b4d2bed371fe4603b83e7504051dcfcdebcbdcacd8be27884223c4ccc13059a4 </span></span><br><span class=\"line\"><span class=\"comment\"># 则进行组合后的第二、三个 master 节点的 join 命令如下:</span></span><br><span class=\"line\">kubeadm join apiserver.demo:6443 --token ejwx62.vqwog6il5p83uk7y \\</span><br><span class=\"line\">--discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303 \\</span><br><span class=\"line\">--control-plane --certificate-key 70eb87e62f052d2d5de759969d5b42f372d0ad798f98df38f7fe73efdf63a13c</span><br><span class=\"line\"><span class=\"comment\"># (3)工作节点加入直接执行上面打印出的token</span></span><br><span class=\"line\"> kubeadm join apiserver.demo:6443 --token bl80xo.hfewon9l5jlpmjft --discovery-token-ca-cert-hash sha256:b4d2bed371fe4603b83e7504051dcfcdebcbdcacd8be27884223c4ccc13059a4 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 方式(2) ##</span></span><br><span class=\"line\"><span class=\"comment\"># 1) 如果失效可以重新进行生成token过期后生成</span></span><br><span class=\"line\">kubeadm token create</span><br><span class=\"line\"><span class=\"comment\"># 2q41vx.w73xe9nrlqdujawu     ##此处是新token</span></span><br><span class=\"line\"><span class=\"comment\"># 2) 获取CA（证书）公钥哈希值</span></span><br><span class=\"line\">openssl x509 -pubkey -<span class=\"keyword\">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class=\"string\">'s/^ .* //'</span></span><br><span class=\"line\"><span class=\"comment\"># (stdin)= 43c8b7186efa9c68002aca3d4eed56fbc9e200c8550071a3dd1db99a10445713  ### 此处是公钥哈希值(一台机器上证书不变就一直是该sha256的值)</span></span><br><span class=\"line\"><span class=\"comment\"># (3) 节点加入集群</span></span><br><span class=\"line\">kubeadm join 192.168.80.137:6443 --token 新生成的Token填写此处 --discovery-token-ca-cert-hash sha256:获取的公钥哈希值填写此处</span><br><span class=\"line\"><span class=\"comment\">#kubeadm join apiserver.demo:6443 --token 2q41vx.w73xe9nrlqdujawu  --discovery-token-ca-cert-hash sha256:43c8b7186efa9c68002aca3d4eed56fbc9e200c8550071a3dd1db99a10445713</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><em>注意事项:</em></p>\n<ul>\n<li>1) 只有在Master节点才能执行查看node以及pod相关信息;</li>\n<li>2) 如果主Master节点在初始化时候出错需要重新配置时候请执行以下命令进行重置;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop kubelet</span><br><span class=\"line\">docker stop $(docker ps -aq)</span><br><span class=\"line\">docker rm -f $(docker ps -aq)</span><br><span class=\"line\">systemctl stop docker</span><br><span class=\"line\">kubeadm reset</span><br><span class=\"line\">sudo rm -rf <span class=\"variable\">$HOME</span>/.kube /etc/kubernetes</span><br><span class=\"line\">sudo rm -rf /var/lib/cni/ /etc/cni/ /var/lib/kubelet/* </span><br><span class=\"line\">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class=\"line\">systemctl start docker</span><br><span class=\"line\">systemctl start kubelet</span><br></pre></td></tr></table></figure></li>\n<li>3) 如果加入主master节点时一直停留在 pre-flight 状态，请在第二、三个节点上执行命令检查：<code>curl -ik https://设置APISERVER:6443/version</code><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#正常状态</span></span><br><span class=\"line\"><span class=\"variable\">$curl</span> -ik https://k8s.weiyigeek.top:6443/version</span><br><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Cache-Control: no-cache, private</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\">Date: Wed, 24 Jun 2020 02:16:23 GMT</span><br><span class=\"line\">Content-Length: 263</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"major\"</span>: <span class=\"string\">\"1\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"minor\"</span>: <span class=\"string\">\"18\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"gitVersion\"</span>: <span class=\"string\">\"v1.18.4\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"gitCommit\"</span>: <span class=\"string\">\"c96aede7b5205121079932896c4ad89bb93260af\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"gitTreeState\"</span>: <span class=\"string\">\"clean\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"buildDate\"</span>: <span class=\"string\">\"2020-06-17T11:33:59Z\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"goVersion\"</span>: <span class=\"string\">\"go1.13.9\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"compiler\"</span>: <span class=\"string\">\"gc\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"platform\"</span>: <span class=\"string\">\"linux/amd64\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h3 id=\"0x03-手动安装K8s集群-离线\"><a href=\"#0x03-手动安装K8s集群-离线\" class=\"headerlink\" title=\"0x03 手动安装K8s集群(离线)\"></a>0x03 手动安装K8s集群(离线)</h3><p>描述:离线安装K8s即在机器没有连接外网的情况进行进行K8S集群的安装；<br>安装方式两种:</p>\n<ul>\n<li>1.离线安装工具<code>sealos</code><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">纯golang开发，只需一个二进制，无任何依赖</span><br><span class=\"line\">内核本地负载，不依赖haproxy keepalived等</span><br><span class=\"line\">不依赖ansible</span><br><span class=\"line\">99年证书</span><br><span class=\"line\">支持自定义配置安装</span><br><span class=\"line\">工具与资源包分离，离线安装，安装不同版本仅需要更换不同资源包即可</span><br><span class=\"line\">支持ingress kuboard prometheus等APP（addons）安装</span><br></pre></td></tr></table></figure></li>\n<li>2.自建一个系统模板的软件仓库以及docker镜像仓库harbor;</li>\n</ul>\n<p>基础要求:</p>\n<ul>\n<li>1.系统推荐CentOS7.6以上，内核推荐4.14以上，CPU节点配置不低于2核4G；</li>\n<li>2.有机器 root 用户密码一致（如不一致也可以使用 ssh 密钥）</li>\n</ul>\n<p><br></p>\n<h4 id=\"1-半自动离线安装\"><a href=\"#1-半自动离线安装\" class=\"headerlink\" title=\"1.半自动离线安装\"></a>1.半自动离线安装</h4><p>描述:对于半自动离线进行kubernetes的安装，我们采用离线下载镜像以及搭建本地内部yum仓库服务器，我们需要进行一下的准备工作；</p>\n<ul>\n<li>(1) 基础操作系统安装镜像: CentOS Linux release 7.8.2003 (Core) - 5.7.0-1.el7.elrepo.x86_64</li>\n<li>(2) 内网yum仓库建立下载Kubernetes相关的安装包即:<code>kubelet-1.18.4 kubeadm-1.18.4 kubectl-1.18.4</code></li>\n<li>(3) Docker相关环境下载kubernetes相关功能组件进行打包（后面建议采用harbor镜像仓库）:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k8s.gcr.io/kube-apiserver:v1.18.4</span><br><span class=\"line\">k8s.gcr.io/kube-controller-manager:v1.18.4</span><br><span class=\"line\">k8s.gcr.io/kube-scheduler:v1.18.4</span><br><span class=\"line\">k8s.gcr.io/kube-proxy:v1.18.4</span><br><span class=\"line\">k8s.gcr.io/pause:3.2</span><br><span class=\"line\">k8s.gcr.io/etcd:3.4.3-0</span><br><span class=\"line\">k8s.gcr.io/coredns:1.6.7</span><br></pre></td></tr></table></figure></li>\n<li>(4) 简易的web应用:Nginx或者httpd环境</li>\n<li>(5) 准备几台相关配置的机器并且设置不同的机器名称;</li>\n</ul>\n<p>k8s.gcr.io镜像下载方法:</p>\n<ul>\n<li>1.机器不能访问<code>k8s.gcr.io</code>情况下<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 镜像下载方法（1）</span></span><br><span class=\"line\"><span class=\"comment\"># 方式1：kubeadm config images list &gt; gcr.io.log &amp;&amp; sed -i 's#k8s.gcr.io#mirrorgcrio#g' gcr.io.log</span></span><br><span class=\"line\"><span class=\"comment\"># 方式2: kubeadm config images list --image-repository mirrorgcrio &gt; gcr.io.log</span></span><br><span class=\"line\"><span class=\"comment\"># 注意该for读取行默认以空格作为结束分隔符</span></span><br><span class=\"line\"><span class=\"comment\"># for k8s in $(cat gcr.io.log);do docker pull $&#123;k8s&#125;; done  </span></span><br><span class=\"line\"><span class=\"comment\"># sed -e \"s#\\\\(/.*$\\\\)#\\1 k8s.gcr.io\\1#g\" gcr.io.log &gt; gcr.io.log1</span></span><br><span class=\"line\"><span class=\"comment\"># while read k8sgcrio;do docker tag $&#123;k8sgcrio&#125;; done &lt; gcr.io.log1</span></span><br><span class=\"line\"><span class=\"comment\"># for k8s in $(cat gcr.io.log);do docker rmi $&#123;k8s&#125;; done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 镜像下载与tag打包方法（2）- 推荐</span></span><br><span class=\"line\">K8SVERSION=1.18.5</span><br><span class=\"line\">kubeadm config images list --kubernetes-version=<span class=\"variable\">$&#123;K8SVERSION&#125;</span> 2&gt;/dev/null | sed <span class=\"string\">'s/k8s.gcr.io/docker pull mirrorgcrio/g'</span> | sudo sh</span><br><span class=\"line\">kubeadm config images list --kubernetes-version=<span class=\"variable\">$&#123;K8SVERSION&#125;</span> 2&gt;/dev/null | sed <span class=\"string\">'s/k8s.gcr.io\\(.*\\)/docker tag mirrorgcrio\\1 k8s.gcr.io\\1/g'</span> | sudo sh</span><br><span class=\"line\">kubeadm config images list --kubernetes-version=<span class=\"variable\">$&#123;K8SVERSION&#125;</span> 2&gt;/dev/null | sed <span class=\"string\">'s/k8s.gcr.io/docker image rm mirrorgcrio/g'</span> | sudo sh</span><br><span class=\"line\">docker save -o v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar $(docker images | grep -v TAG | cut -d <span class=\"string\">' '</span> -f1)</span><br><span class=\"line\">gzip v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar.gz</span><br></pre></td></tr></table></figure></li>\n<li>2.机器能访问k8s.gcr.io时建议，将所需版本的镜像 pull 下来然后 save 成 tar 包传回本地或者harbor之中。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># for: use kubeadm pull kubernetes images</span></span><br><span class=\"line\"><span class=\"comment\"># date: 2019-08-15</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> -xue</span><br><span class=\"line\">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span><br><span class=\"line\">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br><span class=\"line\">cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class=\"line\">deb https://apt.kubernetes.io/ kubernetes-xenial main</span><br><span class=\"line\">EOF</span><br><span class=\"line\">apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> version <span class=\"keyword\">in</span> 1.17.4</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">    apt install kubeadm=<span class=\"variable\">$&#123;version&#125;</span>-00</span><br><span class=\"line\">    mkdir -p <span class=\"variable\">$&#123;version&#125;</span></span><br><span class=\"line\">    kubeadm config images pull --kubernetes-version=<span class=\"variable\">$&#123;version&#125;</span></span><br><span class=\"line\">    docker save -o v<span class=\"variable\">$&#123;version&#125;</span>.tar $(docker images | grep -v TAG | grep k8s.gcr.io | cut -d <span class=\"string\">' '</span> -f1)</span><br><span class=\"line\">    gzip v<span class=\"variable\">$&#123;version&#125;</span>.tar v<span class=\"variable\">$&#123;version&#125;</span>.tar.gz</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><strong>基础流程:</strong><br>Step1.本地内部yum仓库搭建(相关环境的依赖包下载)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 全局变量</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> K8SVERSION=<span class=\"string\">\"1.18.5\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> REGISTRY_MIRROR=<span class=\"string\">\"https://xlx9erfu.mirror.aliyuncs.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 系统基础设置</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname k8s-yum-server &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"127.0.0.1 k8s-yum-server\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\">setenforce 0 &amp;&amp; getenforce &amp;&amp; hostnamectl status</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 应用基础设置</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s#keepcache=0#keepcache=1#g\"</span> /etc/yum.conf &amp;&amp; <span class=\"built_in\">echo</span> -e <span class=\"string\">\"缓存目录:\"</span> &amp;&amp; grep <span class=\"string\">\"cachedir\"</span> /etc/yum.conf </span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ ! -d <span class=\"string\">\"/etc/docker/\"</span> ]];<span class=\"keyword\">then</span> mkdir /etc/docker/;<span class=\"keyword\">fi</span></span><br><span class=\"line\">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class=\"line\">&#123;<span class=\"string\">\"registry-mirrors\"</span>: [<span class=\"string\">\"REPLACE\"</span>]&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sed -i <span class=\"string\">\"s#REPLACE#<span class=\"variable\">$&#123;REGISTRY_MIRROR&#125;</span>#g\"</span> /etc/docker/daemon.json</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart docker kubelet</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 应用安装设置</span></span><br><span class=\"line\"><span class=\"comment\"># 安装基础依赖</span></span><br><span class=\"line\">yum install -y yum-utils lvm2 wget nfs-utils</span><br><span class=\"line\"><span class=\"comment\"># 添加 docker 镜像仓库</span></span><br><span class=\"line\">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class=\"line\"></span><br><span class=\"line\">cat &lt;&lt;<span class=\"string\">'EOF'</span> &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">repo_gpgcheck=0</span><br><span class=\"line\">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class=\"line\">      http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">yum list docker-ce --showduplicates | sort -r</span><br><span class=\"line\"><span class=\"built_in\">read</span> -p <span class=\"string\">'请输入需要安装的Docker-ce的版本号(例如:19.03.9):'</span> VERSION</span><br><span class=\"line\">yum install -y docker-ce-<span class=\"variable\">$&#123;VERSION&#125;</span> docker-ce-cli-<span class=\"variable\">$&#123;VERSION&#125;</span> containerd.io</span><br><span class=\"line\"></span><br><span class=\"line\">yum list kubeadm --showduplicates | sort -r</span><br><span class=\"line\"><span class=\"comment\"># createrepo 与 httpd 是建立内部仓库必须的软件</span></span><br><span class=\"line\">yum install -y kubelet-<span class=\"variable\">$&#123;K8SVERSION&#125;</span> kubeadm-<span class=\"variable\">$&#123;K8SVERSION&#125;</span> kubectl-<span class=\"variable\">$&#123;K8SVERSION&#125;</span> httpd createrepo</span><br><span class=\"line\"><span class=\"comment\"># 安装指定版本的 docker-ce 和 kubelet、kubeadm</span></span><br><span class=\"line\"><span class=\"comment\"># yum install docker-ce-19.03.3-3.el7 kubelet-1.17.4-0 kubeadm-1.17.4-0 kubectl-1.17.4-0 --disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure></p>\n<p>Step2.下载K8s.gcr.io中的镜像到本地并且进行打包<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Docker下载K8s.gcr.io镜像</span></span><br><span class=\"line\">kubeadm config images list --kubernetes-version=<span class=\"variable\">$&#123;K8SVERSION&#125;</span> 2&gt;/dev/null | sed <span class=\"string\">'s/k8s.gcr.io/docker pull mirrorgcrio/g'</span> | sudo sh</span><br><span class=\"line\">kubeadm config images list --kubernetes-version=<span class=\"variable\">$&#123;K8SVERSION&#125;</span> 2&gt;/dev/null | sed <span class=\"string\">'s/k8s.gcr.io\\(.*\\)/docker tag mirrorgcrio\\1 k8s.gcr.io\\1/g'</span> | sudo sh</span><br><span class=\"line\">kubeadm config images list --kubernetes-version=<span class=\"variable\">$&#123;K8SVERSION&#125;</span> 2&gt;/dev/null | sed <span class=\"string\">'s/k8s.gcr.io/docker image rm mirrorgcrio/g'</span> | sudo sh</span><br><span class=\"line\">docker save -o v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar $(docker images | grep -v TAG | cut -d <span class=\"string\">' '</span> -f1)</span><br><span class=\"line\"><span class=\"comment\"># 减少镜像打包后的体积</span></span><br><span class=\"line\">gzip v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar.gz</span><br></pre></td></tr></table></figure></p>\n<p>Step3.将yum缓存下载的rpm以及k8s打包后的镜像放在httpd应用服务访问目录里即<code>/var/www/html/</code>，然后进行生成内部yum数据库和信息索引文件；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mv /etc/httpd/conf.d/welcome.conf&#123;,.bak&#125;</span><br><span class=\"line\">mkdir /var/www/html/yum/</span><br><span class=\"line\">find /var/cache/yum -name *.rpm -<span class=\"built_in\">exec</span> cp -a &#123;&#125; /var/www/html/yum/ \\;</span><br><span class=\"line\"><span class=\"comment\"># 权限非常重要否则后面下载提示权限不足</span></span><br><span class=\"line\">cp v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar.gz /var/www/html/yum/ &amp;&amp; chmod +644 /var/www/html/yum/v<span class=\"variable\">$&#123;K8SVERSION&#125;</span>.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成内部yum数据库和信息索引文件</span></span><br><span class=\"line\">createrepo -pdo /var/www/html/yum/ /var/www/html/yum/</span><br><span class=\"line\">createrepo --update /var/www/html/yum/</span><br></pre></td></tr></table></figure></p>\n<p>Step4.内部yum仓库的httpd服务启动和防火墙设置<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">firewall-cmd --add-port=80/tcp --permanent</span><br><span class=\"line\">firewall-cmd --reload</span><br><span class=\"line\">systemctl start httpd</span><br></pre></td></tr></table></figure></p>\n<p>Step5.利用模板克隆一台机器出来验证内部仓库是否配置成功可以正常进行软件安装<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"10.10.107.201 yum.weiyigeek.top\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\">cat &gt; /etc/yum.repos.d/localyumserver.repo &lt;&lt;END</span><br><span class=\"line\">[localyumserver]</span><br><span class=\"line\">name=localyumserver</span><br><span class=\"line\">baseurl=http://yum.weiyigeek.top/yum/</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">END</span><br><span class=\"line\">yum --enablerepo=localyumserver --disablerepo=base,extras,updates,epel,elrepo,docker-ce-stable list</span><br></pre></td></tr></table></figure><br>如果正常显示以下则说明创建成功，否则请参考报错信息进行相应的调整;<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200629171127.png\" alt=\"WeiyiGeek.localyumserver\" title=\"\" class=\"\">\n                <p>WeiyiGeek.localyumserver</p>\n            </figure></p>\n<ul>\n<li>Step6.在这台克隆机上进行安装K8s基础环境的设置<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> HOSTNAME=worker-03</span><br><span class=\"line\"><span class=\"comment\"># 临时关闭swap和SELinux</span></span><br><span class=\"line\">swapoff -a &amp;&amp; setenforce 0</span><br><span class=\"line\"><span class=\"comment\"># 永久关闭swap和SELinux</span></span><br><span class=\"line\">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class=\"line\">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class=\"line\">sed -i <span class=\"string\">\"s/^SELINUX=.*$/SELINUX=disabled/\"</span> /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机名设置(这里主机名称安装上面的IP地址规划对应的主机名称-根据安装的主机进行变化)</span></span><br><span class=\"line\">hostnamectl <span class=\"built_in\">set</span>-hostname <span class=\"variable\">$HOSTNAME</span></span><br><span class=\"line\">hostnamectl status</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机名设置</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"127.0.0.1 <span class=\"variable\">$HOSTNAME</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class=\"line\">10.10.107.191 master-01</span><br><span class=\"line\">10.10.107.192 master-02</span><br><span class=\"line\">10.10.107.193 master-03</span><br><span class=\"line\">10.10.107.194 worker-01</span><br><span class=\"line\">10.10.107.196 worker-02</span><br><span class=\"line\">10.20.172.200 worker-03</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改 /etc/sysctl.conf 进行内核参数的配置</span></span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv4.ip_forward.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv4.ip_forward.*|net.ipv4.ip_forward = 1|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_forward = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-ip6tables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-ip6tables.*|net.bridge.bridge-nf-call-ip6tables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-ip6tables = 1\"</span> &gt;&gt; /etc/sysctl.conf </span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.bridge.bridge-nf-call-iptables.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.bridge.bridge-nf-call-iptables.*|net.bridge.bridge-nf-call-iptables = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.bridge.bridge-nf-call-iptables = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.all.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.all.disable_ipv6.*|net.ipv6.conf.all.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.all.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.default.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.default.disable_ipv6.*|net.ipv6.conf.default.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.default.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.lo.disable_ipv6.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.lo.disable_ipv6.*|net.ipv6.conf.lo.disable_ipv6 = 1|g\"</span> /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.lo.disable_ipv6 = 1\"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\">egrep -q <span class=\"string\">\"^(#)?net.ipv6.conf.all.forwarding.*\"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class=\"string\">\"s|^(#)?net.ipv6.conf.all.forwarding.*|net.ipv6.conf.all.forwarding = 1|g\"</span>  /etc/sysctl.conf || <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv6.conf.all.forwarding = 1\"</span>  &gt;&gt; /etc/sysctl.conf</span><br><span class=\"line\"><span class=\"comment\"># 使修改的内核参数立即生效</span></span><br><span class=\"line\">sysctl -p</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 镜像加速</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> REGISTRY_MIRROR=<span class=\"string\">\"https://xlx9erfu.mirror.aliyuncs.com\"</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ ! -d <span class=\"string\">\"/etc/docker/\"</span> ]];<span class=\"keyword\">then</span> mkdir /etc/docker/;<span class=\"keyword\">fi</span></span><br><span class=\"line\">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class=\"line\">&#123;<span class=\"string\">\"registry-mirrors\"</span>: [<span class=\"string\">\"REPLACE\"</span>]&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sed -i <span class=\"string\">\"s#REPLACE#<span class=\"variable\">$&#123;REGISTRY_MIRROR&#125;</span>#g\"</span> /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Step7.利用内部yum源进行Kuberntes环境安装<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y --enablerepo=localyumserver --disablerepo=base,extras,updates,epel,elrepo,docker-ce-stable kubelet kubeadm kubectl</span><br><span class=\"line\"><span class=\"comment\"># docker启动设置</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g\"</span> /usr/lib/systemd/system/docker.service</span><br><span class=\"line\"><span class=\"comment\"># 重启 docker，并启动 kubelet</span></span><br><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl <span class=\"built_in\">enable</span> kubelet</span><br><span class=\"line\">systemctl restart docker kubelet</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200629173552.png\" alt=\"WeiyiGeek.kube相关命令安装常规\" title=\"\" class=\"\">\n                <p>WeiyiGeek.kube相关命令安装常规</p>\n            </figure></p>\n<p>Step8.将yum仓库中的镜像拉取本地部署机器上后，再使用 docker load 命令将镜像导入到宿主机 docker 镜像存储中。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget -c http://10.10.107.201/yum/v1.18.5.tar.gz </span><br><span class=\"line\">gzip -dv v1.18.5.tar.gz &amp;&amp; docker load &lt; v1.18.5.tar</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200629203618.png\" alt=\"WeiyiGeek.镜像导入结果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.镜像导入结果</p>\n            </figure></p>\n<p>Step9.将工作节点加入到集群之中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 主Master节点运行</span></span><br><span class=\"line\">[root@master-01 ~]<span class=\"variable\">$kubeadm</span> token create --<span class=\"built_in\">print</span>-join-command 2&gt;/dev/null</span><br><span class=\"line\">kubeadm join k8s.weiyigeek.top:6443 --token fvu5ei.akiiuhywibwxvdwh     --discovery-token-ca-cert-hash sha256:0795075090d621285dbaa4a76b9b320150f5ae3c37f5d7b92fc1c4f8942d9243</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 工作节点执行加入到k8s的cluster中</span></span><br><span class=\"line\">APISERVER_IP=10.10.107.191</span><br><span class=\"line\">APISERVER_NAME=k8s.weiyigeek.top</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;APISERVER_IP&#125;</span> <span class=\"variable\">$&#123;APISERVER_NAME&#125;</span>\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\">[root@worker-03 ~]<span class=\"variable\">$kubeadm</span> join k8s.weiyigeek.top:6443 --token fvu5ei.akiiuhywibwxvdwh     --discovery-token-ca-cert-hash sha256:0795075090d621285dbaa4a76b9b320150f5ae3c37f5d7b92fc1c4f8942d9243</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 主节点验证加入的worker工作节点</span></span><br><span class=\"line\"><span class=\"variable\">$kubectl</span> get nodes</span><br><span class=\"line\">NAME        STATUS   ROLES    AGE     VERSION</span><br><span class=\"line\">master-01   Ready    master   6d8h    v1.18.4</span><br><span class=\"line\">master-02   Ready    master   5d20h   v1.18.4</span><br><span class=\"line\">master-03   Ready    master   5d11h   v1.18.4</span><br><span class=\"line\">worker-01   Ready    &lt;none&gt;   6d8h    v1.18.4</span><br><span class=\"line\">worker-02   Ready    &lt;none&gt;   5d21h   v1.18.4</span><br><span class=\"line\">worker-03   Ready    &lt;none&gt;   11m     v1.18.5  <span class=\"comment\">#由于kubelet是v1.18.5版本的，在实际生产环境中一般采用稳定版本</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$kubectl</span> get pods -A -n kube-system  -o wide | grep <span class=\"string\">\"worker-03\"</span></span><br><span class=\"line\">kube-system   calico-node-f2vwk                          1/1     Running   0          2m14s   10.20.172.200   worker-03   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   kube-proxy-mwml4                           1/1     Running   0          2m5s    10.20.172.200   worker-03   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></p>\n<p>注意事项:</p>\n<ul>\n<li>1.当使用 <code>kubeadm pull</code> 相关镜像时 <code>kubeadm</code> 的版本最好和 <code>kubernetes-version=${version}</code> 版本一致，不一致的话有些版本的镜像是 pull 不下来的需要对应版本的 kubernetes 要使用对应版本的镜像才可以。</li>\n<li>2.一般来说大版本除了k8s自带的命令版本会有变化外，依赖的功能组件通常是不会变化的比如<code>pause:3.2/etcd:3.4.3-0/coredns:1.6.7</code></li>\n<li>3.成功导入 docker 镜像之后，可以使用 kubeadm init 命令来初始化 master 节点或者初始化work节点；</li>\n</ul>\n<p><br></p>\n<h4 id=\"2-离线包安装-sealos\"><a href=\"#2-离线包安装-sealos\" class=\"headerlink\" title=\"2.离线包安装(sealos)\"></a>2.离线包安装(sealos)</h4><p>描述:对于生产环境需要考虑到控制平面的高可用，在这里为了方便部署选用基于 kubeadm 的部署工具 <a href=\"https://github.com/fanux/sealos\" target=\"_blank\" rel=\"noopener\">sealos</a>安装，包含<code>安装所需的所有二进制文件，镜像文件，systemd配置，yaml配置与一些简单的启动脚本</code>;对于生产环境无需测试环境当中的一些准备工作，使用 <code>sealos</code> 会自动帮我们完成节点初始化相关工作，只需要在一台 master 节点下载 <code>sealos 二进制文件</code>和<code>离线安装包部署</code>即可。</p>\n<p>使用资源:</p>\n<ul>\n<li>1.<a href=\"http://store.lameleg.com/\" target=\"_blank\" rel=\"noopener\">kubernetes离线安装包</a></li>\n<li>2.<a href=\"https://github.com/fanux/sealos/releases\" target=\"_blank\" rel=\"noopener\">sealos二进制版本</a></li>\n</ul>\n<p>基础说明:</p>\n<ul>\n<li>1.对于 <code>1.17.0~1.17.5</code>或者<code>1.18.0~1.18.5</code>版本的离线安装包，其中只有 kubenetets 的版本镜像不同其余的插件版本都一致，因此可以选择以 <code>1.17.0/1.18.0</code> 版本为基础制作符合自己所需要的版本。例如:<a href=\"http://store.lameleg.com:8080/pro/kubernetes1.18.0?time=1593396354742&amp;referrer=null\" target=\"_blank\" rel=\"noopener\">1.18.0基础版本</a></li>\n</ul>\n<p>集群部署:</p>\n<ul>\n<li>Step1.下载最新版本的sealos二进制文件<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/latest/sealos -O /usr/bin/  &amp;&amp; chmod +x /usr/bin/sealos</span><br></pre></td></tr></table></figure></li>\n<li>Step2.sealos参数说明和使用</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数名</th>\n<th>含义</th>\n<th>示例</th>\n<th>是否必须</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>passwd</td>\n<td>服务器密码</td>\n<td>123456</td>\n<td>和私钥二选一</td>\n</tr>\n<tr>\n<td>master</td>\n<td>k8s master节点IP地址</td>\n<td>192.168.0.2</td>\n<td>必须</td>\n</tr>\n<tr>\n<td>node</td>\n<td>k8s node节点IP地址</td>\n<td>192.168.0.3</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>pkg-url</td>\n<td>离线资源包地址，支持下载到本地，或者一个远程地址</td>\n<td>/root/kube1.16.0.tar.gz</td>\n<td>必须</td>\n</tr>\n<tr>\n<td>version</td>\n<td><a href=\"http://store.lameleg.com/\" target=\"_blank\" rel=\"noopener\">资源包</a>对应的版本</td>\n<td>v1.16.0</td>\n<td>必须</td>\n</tr>\n<tr>\n<td>kubeadm-config</td>\n<td>自定义kubeadm配置文件</td>\n<td>kubeadm.yaml.temp</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>pk</td>\n<td>ssh私钥地址，免密钥时使用</td>\n<td>/root/.ssh/id_rsa</td>\n<td>和passwd二选一</td>\n</tr>\n<tr>\n<td>user</td>\n<td>ssh用户名</td>\n<td>root</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>interface</td>\n<td>机器网卡名，CNI网卡发现用</td>\n<td>eth.*</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>network</td>\n<td>CNI类型如calico flannel</td>\n<td>calico</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>podcidr</td>\n<td>pod网段</td>\n<td>100.64.0.0/10</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>repo</td>\n<td>镜像仓库,离线包通常不用配置,除非你把镜像导入到自己私有仓库了</td>\n<td>k8s.gcr.io</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>svccidr</td>\n<td>clusterip网段</td>\n<td>10.96.0.0/22</td>\n<td>可选</td>\n</tr>\n<tr>\n<td>without-cni</td>\n<td>不装cni插件，为了用户自己装别的CNI</td>\n<td></td>\n<td>可选</td>\n</tr>\n</tbody>\n</table>\n<p>将制作好的离线安装包 <code>scp</code> 到 <code>master</code> 节点的 <code>/opt</code> 目录下。<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sealos init --master 10.10.107.109 \\</span><br><span class=\"line\">    --master 10.10.107.119 \\</span><br><span class=\"line\">    --master 10.10.107.121 \\</span><br><span class=\"line\">    --node 10.10.107.123 \\</span><br><span class=\"line\">    --node 10.10.107.124 \\</span><br><span class=\"line\">    --user root \\</span><br><span class=\"line\">    --passwd weiyigeek_test \\</span><br><span class=\"line\">    --version v1.17.4 \\</span><br><span class=\"line\">    --network calico \\</span><br><span class=\"line\">    --pkg-url /opt/kube1.17.4.tar.gz</span><br></pre></td></tr></table></figure></p>\n<p>部署成功后会出现以下提示：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">15:37:35 [INFO] [ssh.go:60] [ssh][10.10.107.124:22]:</span><br><span class=\"line\">15:37:35 [INFO] [ssh.go:11] [ssh][10.10.107.124:22]exec cmd is : mkdir -p /etc/kubernetes/manifests</span><br><span class=\"line\">15:37:36 [DEBG] [ssh.go:23] [ssh][10.10.107.124:22]command result is:</span><br><span class=\"line\">15:37:36 [ALRT] [scp.go:156] [ssh][10.10.107.124:22]transfer total size is: 0MB</span><br><span class=\"line\">15:37:36 [INFO] [ssh.go:36] [ssh][10.10.107.124:22]exec cmd is : rm -rf /root/kube</span><br><span class=\"line\">15:37:36 [DEBG] [print.go:20] ==&gt;SendPackage==&gt;KubeadmConfigInstall==&gt;InstallMaster0==&gt;JoinMasters==&gt;JoinNodes</span><br><span class=\"line\">15:37:36 [INFO] [print.go:25] sealos install success.</span><br></pre></td></tr></table></figure></p>\n<p>注意事项:</p>\n<ul>\n<li>(1)注意需要修改各个节点的 hostname 不能一致，不然部署的时候会报错<code>duplicate hostnames is not allowed</code>。</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"k8s","path":"api/tags/k8s.json"}]}