{"title":"MYSQL高可用架构heartbeat和drbd实现.md","slug":"数据存储/Database-运维/MySQL/高可用/MYSQL高可用架构HD的实现","date":"2019-04-27T06:34:30.000Z","updated":"2023-01-31T02:29:07.994Z","url":"2019/4-27-90.html","path":"api/articles/2019/4-27-90.html.json","covers":["https://img.weiyigeek.top/2019/20190427210521.png","https://img.weiyigeek.top/2019/20190427210544.png","https://img.weiyigeek.top/2019/20190504140248.png","https://img.weiyigeek.top/2019/20190504110627.png","https://img.weiyigeek.top/2019/20190504111517.png","https://img.weiyigeek.top/2019/20190504223625.png","https://img.weiyigeek.top/2019/20190504194644.png","https://img.weiyigeek.top/2019/20190504211853.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h3 id=\"1-MHD组合高可用架构\"><a href=\"#1-MHD组合高可用架构\" class=\"headerlink\" title=\"(1) MHD组合高可用架构\"></a>(1) MHD组合高可用架构</h3><h4 id=\"0x00-架构实现概述\"><a href=\"#0x00-架构实现概述\" class=\"headerlink\" title=\"0x00 架构实现概述\"></a>0x00 架构实现概述</h4><p>Mysql数据库高可用涉及技术：1.mysql 主从同步 / 2. heartbeat技术 / 3. drdb 技术<br>总结：改变单一软件应用思想打组合权;</p>\n<h4 id=\"0x01-生产业务需求\"><a href=\"#0x01-生产业务需求\" class=\"headerlink\" title=\"0x01 生产业务需求\"></a>0x01 生产业务需求</h4><p>描述：一主多从得MYSQL数据架构是最常见得DB架构方法,该架构方案部署简单/维护方便/并且通过配置简单得代理或者通过程序得方法就可以实现应用服务器对主从库得读写分离,且多个从库还可以通过lvs或者haproxy等代理实现多个从库得负载均衡,分担读的压力同时排除单点问题;<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190427210521.png\" alt=\"WeiyiGeek.架构\" title=\"\" class=\"\">\n                <p>WeiyiGeek.架构</p>\n            </figure></p>\n<p><strong>正常情况说明：</strong></p>\n<ul>\n<li>Heartbeat 通过串口线或者以太网网线直连网卡对对端的服务做了健康检查,并负责执行Drbd/mysql/VIP等资源的自动切换;</li>\n<li>data-1-2作为data-1-1高可以用热备,正常情况下data-1-1提供了一个分区sdb1给mysql使用;</li>\n<li>物理磁盘做RAID10或者RAID0根据性能和冗余来选择</li>\n<li>服务器之间/服务器-交换机之间都是双千兆网卡绑定(bondding)</li>\n<li>应用服务器通过vip访问Mysql主库,通过不同的VIP访问负责均衡的从库池开始;</li>\n<li>MySQL slave1/slave2 通过vip和主库的MySQL进行同步;MySQL的数据再DRBD分区1中;</li>\n</ul>\n<p><br></p>\n<p><strong>故障切换：</strong><br>经过高可以用方案切换后的数据库架构,变成了一个常规的主从架构,此时新主库从热备变成了单点服务了。</p>\n<ul>\n<li>因此要尽快修复原来的主库或者为主库增加新的热备库,避免切换后新主库岩机对业务带来的影响;</li>\n<li>通过drbd的方式同步的数据库,以及做从库式使用和主库对外提供服务的VIP为同步VIP;当主库宕机后,VIP漂移到热备主库默认情况下再60秒内;从库就可用连接到新的VIP中,从而自动和新的主库同步;<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190427210544.png\" alt=\"WeiyiGeek.主库切换\" title=\"\" class=\"\">\n                <p>WeiyiGeek.主库切换</p>\n            </figure>\n</li>\n</ul>\n<p><em>注意事项：</em></p>\n<ul>\n<li>通过MySQL同步做双主方式,是难以做到主库宕机从库和新的主库同步的；</li>\n<li>对于mysql数据库的高可以用也可以是主主双向可用模式;</li>\n<li>对于超大流量的数据库业务,不建议用双主模式这回导致IO争用降低系统性能;</li>\n</ul>\n<h4 id=\"0x02-生产环境配置\"><a href=\"#0x02-生产环境配置\" class=\"headerlink\" title=\"0x02 生产环境配置\"></a>0x02 生产环境配置</h4><p>网络规划：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#data1</span></span><br><span class=\"line\">Master  eth1  192.168.1.100 管理IP</span><br><span class=\"line\">        eth2  192.168.2.100 心跳IP</span><br><span class=\"line\">              192.168.1.200 漂移IP (VIP)</span><br><span class=\"line\"><span class=\"comment\">#-----------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\">#data2</span></span><br><span class=\"line\">BACKUP eth1  192.168.1.100 管理IP</span><br><span class=\"line\">       eth2  192.168.2.101 心跳IP</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##############################################</span></span><br><span class=\"line\"><span class=\"comment\">#网卡得配置</span></span><br><span class=\"line\">[root@data1 network-scripts]$ cat ifcfg-eth1</span><br><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\">PROXY_METHOD=none</span><br><span class=\"line\">BROWSER_ONLY=no</span><br><span class=\"line\">BOOTPROTO=static</span><br><span class=\"line\">IPADDR=192.168.1.100</span><br><span class=\"line\">NETMASK=255.255.255.0</span><br><span class=\"line\">GATEWAY=192.168.1.1</span><br><span class=\"line\">DEFROUTE=yes</span><br><span class=\"line\">IPV4_FAILURE_FATAL=no</span><br><span class=\"line\">IPV6INIT=yes</span><br><span class=\"line\">IPV6_AUTOCONF=yes</span><br><span class=\"line\">IPV6_DEFROUTE=yes</span><br><span class=\"line\">IPV6_FAILURE_FATAL=no</span><br><span class=\"line\">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class=\"line\">NAME=eth1</span><br><span class=\"line\">UUID=ae67c9f9-383c-4270-a49a-4667977a0d6d</span><br><span class=\"line\">DEVICE=eth1</span><br><span class=\"line\">ONBOOT=yes</span><br><span class=\"line\">IPV6_PRIVACY=no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#环境配置关闭selinux / 防火墙 和升级系统</span></span><br><span class=\"line\">[root@data1 network-scripts]$ sed -i <span class=\"string\">'/SELINUX/s/enforcing/disabled/'</span> /etc/sysconfig/selinux</span><br><span class=\"line\">[root@data1 network-scripts]$ systemctl stop firewalld</span><br><span class=\"line\">[root@data1 network-scripts]$ systemctl <span class=\"built_in\">disable</span> firewalld</span><br><span class=\"line\">ntpdate -u asia.pool.ntp.org <span class=\"comment\"># 时间同步</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#系统升级与环境</span></span><br><span class=\"line\">CentOS Linux release 7.6.1810 (Core) 3.10.0-957.el7.x86_64</span><br><span class=\"line\">yum update -y &amp;&amp; yum upgrade -y</span><br><span class=\"line\"><span class=\"comment\">#rpm --import /etc/pki/rpm-gpg/xxxx</span></span><br><span class=\"line\">yum install -y epel-release.noarch gcc gcc-c++ openssl openssl-devel libaio libaio-devel ncurses ncurses-deve numactl lsof vim wget net-tools fuser</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#mysql采用二进制得 （安装方法查看MYSQL介绍安装与运维配置文章中）</span></span><br><span class=\"line\"><span class=\"comment\">#https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.16-linux-glibc2.12-x86_64.tar.xz</span></span><br><span class=\"line\"><span class=\"comment\">#mysql创建主从复制环境 (配置方法查看MYSQL多实例配置详解文章中)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#heartbeat 安装(参看前面得文章 高可用服务解决方案)</span></span><br><span class=\"line\"><span class=\"comment\">#drbd 安装(参看前面得文章 磁盘高可用解决方案)</span></span><br><span class=\"line\">安装源：http://elrepo.org/tiki/tiki-index.php</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#建立磁盘</span></span><br><span class=\"line\">data1 = 512 MB</span><br><span class=\"line\">data2 = 1024 MB </span><br><span class=\"line\">DRBD管理名称与挂载目录:  data /data</span><br><span class=\"line\">DRBD逻辑设备:           /dev/drbd0 <span class=\"comment\">#关键点</span></span><br><span class=\"line\">DRBD 存储设备：         /dev/sdb1</span><br><span class=\"line\">DRBD Meta设备：         /dev/sdb2[0]</span><br><span class=\"line\"></span><br><span class=\"line\">[root@data1 ~]$ fdisk -l</span><br><span class=\"line\">Disk /dev/sdb: 536 MB, 536870912 bytes, 1048576 sectors</span><br><span class=\"line\">[root@data2 ~]$ fdisk -l</span><br><span class=\"line\">Disk /dev/sdb: 1073 MB, 1073741824 bytes, 2097152 sectors</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"0x03-实战配置\"><a href=\"#0x03-实战配置\" class=\"headerlink\" title=\"0x03 实战配置\"></a>0x03 实战配置</h4><h5 id=\"（1）单-多实例高可用\"><a href=\"#（1）单-多实例高可用\" class=\"headerlink\" title=\"（1）单/多实例高可用\"></a>（1）单/多实例高可用</h5><p>单多实例高可用架构图：<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190504140248.png\" alt=\"WeiyiGeek.案例图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.案例图</p>\n            </figure></p>\n<p>Step1. 添加配置编辑集群资源文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#在mysql + drbd + Heratbeat 中可以进行体现 （后面还能接一些脚本 但是必须要设置 start / stop ）</span></span><br><span class=\"line\"><span class=\"comment\">#/data为mysql目录</span></span><br><span class=\"line\">$ vi /etc/ha.d/haresources</span><br><span class=\"line\">data1 IPaddr::192.168.1.200/24/eth1 drbddisk::data Filesystem::/dev/drbd0::/data::ext4 mysqld</span><br><span class=\"line\"></span><br><span class=\"line\">IPaddr::192.168.1.200/24/eth1：用IPaddr脚本配置对外服务的浮动虚拟IP</span><br><span class=\"line\">drbddisk::data：用drbddisk脚本实现DRBD主从节点资源组的挂载和卸载</span><br><span class=\"line\">Filesystem::/dev/drbd0::/mnt::ext4：用Filesystem脚本实现磁盘挂载和卸载</span><br></pre></td></tr></table></figure></p>\n<p>Step2. 添加heartbeat脚本漂移切换脚本<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#在/usr/local/heartbeat/etc/ha.d/resource.d/添加drbddisk脚本</span></span><br><span class=\"line\"><span class=\"comment\">#并且将mysqld启动配置文件放入该目录中</span></span><br><span class=\"line\">cp /etc/init.d/mysqld /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/resource.d/</span><br><span class=\"line\">【注意：】 我这里是源码编译安装,可能与yum安装的目录不同,但是配置差不多;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#将主节点的drbddisk直接复制到从机中</span></span><br><span class=\"line\">scp /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/resource.d/drbddisk root@192.168.1.101:/usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/resource.d/drbddisk</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#权限非常重要</span></span><br><span class=\"line\">$ chmod 755 /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/resource.d/drbddisk</span><br><span class=\"line\">$ chown -R root:haclient /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/resource.d/</span><br></pre></td></tr></table></figure></p>\n<p>Step3. 高可用服务的启动<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 在主/备节点上都运行开启drbd服务并监听状态</span><br><span class=\"line\">systemctl start drbd</span><br><span class=\"line\">drbdsetup /dev/drbd0 primary --force  <span class=\"comment\">#[主节点运行]</span></span><br><span class=\"line\">watch -n1 cat /proc/drbd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Every 1.0s: cat /proc/drbd    Mon Apr 29 22:11:17 2019</span></span><br><span class=\"line\"><span class=\"comment\">#  0: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----</span></span><br><span class=\"line\"><span class=\"comment\">#     ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2.在两个节点上启动HeartBeat服务,先启动data1：(data1,data2) ,注意主必须比从先启动</span><br><span class=\"line\">[root@data1 ~]$ systemctl start heartbeat</span><br><span class=\"line\">[root@data2 ~]$ systemctl start heartbeat</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3.观察VIP情况网卡情况以及drbd主从状态</span><br><span class=\"line\">[root@data1 heartbeat]$ ip addr | grep <span class=\"string\">\"192.168.1\"</span></span><br><span class=\"line\">    inet 192.168.1.100/24 brd 192.168.1.255 scope global noprefixroute eth1</span><br><span class=\"line\">    inet 192.168.1.200/24 brd 192.168.1.255 scope global secondary eth1:4</span><br><span class=\"line\">[root@data2 heartbeat]$ ip addr | grep <span class=\"string\">\"192.168.1\"</span></span><br><span class=\"line\">    inet 192.168.1.101/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\"></span><br><span class=\"line\">[root@data1 heartbeat]$ drbdadm status</span><br><span class=\"line\">data role:Primary</span><br><span class=\"line\">  disk:UpToDate</span><br><span class=\"line\">  peer role:Secondary</span><br><span class=\"line\">    replication:Established peer-disk:UpToDate</span><br><span class=\"line\"></span><br><span class=\"line\">[root@data2 heartbeat]<span class=\"variable\">$drbdadm</span> status</span><br><span class=\"line\">data role:Secondary</span><br><span class=\"line\">  disk:UpToDate</span><br><span class=\"line\">  peer role:Primary</span><br><span class=\"line\">    replication:Established peer-disk:UpToDate</span><br><span class=\"line\"></span><br><span class=\"line\">4. 磁盘挂载情况如下图</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190504110627.png\" alt=\"WeiyiGeek.启动heartbeat\" title=\"\" class=\"\">\n                <p>WeiyiGeek.启动heartbeat</p>\n            </figure></p>\n<p>5.进行测试VIP漂移<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#测试漂移脚本</span></span><br><span class=\"line\">[root@data1 heartbeat]$ /usr/<span class=\"built_in\">local</span>/heartbeat/share/heartbeat/hb_standby</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#资源接管回data1主节点 (漂移回来后如上面的图)</span></span><br><span class=\"line\">[root@data1 heartbeat]$ /usr/<span class=\"built_in\">local</span>/heartbeat/share/heartbeat/hb_takeover <span class=\"built_in\">local</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@data1 heartbeat]$ service mysqld status</span><br><span class=\"line\"> SUCCESS! MySQL running (5669)</span><br><span class=\"line\">[root@data2 heartbeat]$ service mysqld status</span><br><span class=\"line\"> ERROR! MySQL is not running</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190504111517.png\" alt=\"WeiyiGeek.测试VIP故障漂移到从机\" title=\"\" class=\"\">\n                <p>WeiyiGeek.测试VIP故障漂移到从机</p>\n            </figure></p>\n<p><br></p>\n<h5 id=\"（2）主从同步高可以用\"><a href=\"#（2）主从同步高可以用\" class=\"headerlink\" title=\"（2）主从同步高可以用\"></a>（2）主从同步高可以用</h5><p>安装多实例环境即可,注意路径的一致性,在主节点安装即可;本例实现主库VIP进行漂移而从库从能正常连接到VIP地址上服务器进行主从同步;<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190504223625.png\" alt=\"WeiyiGeek.主从同步架构\" title=\"\" class=\"\">\n                <p>WeiyiGeek.主从同步架构</p>\n            </figure><br><br></p>\n<p>Step 1. 主从多实例安装：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#主库建立</span></span><br><span class=\"line\">mkdir -vp /data/&#123;&#123;3306,3307&#125;/&#123;data,tmp,binlog,innodb_ts,innodb_log,logs&#125;,backup,scripts&#125;</span><br><span class=\"line\">touch /data/&#123;3306,3307&#125;/tmp/mysql-error.log</span><br><span class=\"line\">touch /data/&#123;3306,3307&#125;/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; /data/3306/my.cnf&lt;&lt;EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#主库</span></span><br><span class=\"line\">[client]</span><br><span class=\"line\">default-character-set=utf8   <span class=\"comment\"># 设置mysql客户端默认字符集 </span></span><br><span class=\"line\">port = 3306</span><br><span class=\"line\">socket = /data/3306/mysql.sock</span><br><span class=\"line\"><span class=\"comment\"># The MySQL server </span></span><br><span class=\"line\">[mysqld] </span><br><span class=\"line\">port = 3306</span><br><span class=\"line\">mysqlx_port = 33060 </span><br><span class=\"line\">user = mysql</span><br><span class=\"line\">server-id = 3306</span><br><span class=\"line\">socket = /data/3306/mysql.sock </span><br><span class=\"line\">mysqlx_socket=/data/3306/mysqlx.sock </span><br><span class=\"line\">pid-file = /data/3306/mysql.pid </span><br><span class=\"line\">basedir = /usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">datadir = /data/3306/data </span><br><span class=\"line\">tmpdir = /data/3306/tmp <span class=\"comment\">#非必须</span></span><br><span class=\"line\"><span class=\"built_in\">log</span>-bin = /data/3306/binlog/mysql-bin   </span><br><span class=\"line\"><span class=\"built_in\">log</span>-error = /data/3306/mysql-error.log</span><br><span class=\"line\">explicit_defaults_for_timestamp</span><br><span class=\"line\">character-set-server=utf8  <span class=\"comment\">#服务端默认字符集 </span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sed <span class=\"string\">'s/3306/3307/g'</span> /data/3306/my.cnf &gt; /data/3307/my.cnf</span><br><span class=\"line\">chown -R mysql:mysql /data/</span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf --initialize --user=mysql --basedir=/usr/<span class=\"built_in\">local</span>/mysql &amp;&amp; /usr/<span class=\"built_in\">local</span>/mysql/bin/mysqld --defaults-file=/data/3306/my.cnf --initialize --user=mysql --basedir=/usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#获取root密码</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -n <span class=\"string\">\"主3306端口mysql的root密码：\"</span> &amp;&amp;  grep <span class=\"string\">\"password\"</span> /data/3306/mysql-error.log | awk <span class=\"string\">'&#123;print $13&#125;'</span> &amp;&amp; <span class=\"built_in\">echo</span> -n <span class=\"string\">\"从3307端口mysql的root密码：\"</span>&amp;&amp; grep <span class=\"string\">\"password\"</span> /data/3307/mysql-error.log | awk <span class=\"string\">'&#123;print $13&#125;'</span></span><br><span class=\"line\"></span><br><span class=\"line\">pass3306=`grep <span class=\"string\">\"password\"</span> /data/3306/mysql-error.log | awk <span class=\"string\">'&#123;print $13&#125;'</span>`</span><br><span class=\"line\">pass3307=`grep <span class=\"string\">\"password\"</span> /data/3307/mysql-error.log | awk <span class=\"string\">'&#123;print $13&#125;'</span>`</span><br><span class=\"line\"></span><br><span class=\"line\">nohup /usr/<span class=\"built_in\">local</span>/mysql/bin/mysqld_safe --defaults-file=/data/3306/my.cnf --user=mysql &amp; </span><br><span class=\"line\">sleep 10</span><br><span class=\"line\">nohup /usr/<span class=\"built_in\">local</span>/mysql/bin/mysqld_safe --defaults-file=/data/3307/my.cnf --user=mysql &amp;</span><br><span class=\"line\">sleep 10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">$pass3306</span> <span class=\"variable\">$pass3307</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#登录数据库以及密码更改：</span></span><br><span class=\"line\">mysql -u root -p<span class=\"variable\">$pass3306</span> -S /data/3306/mysql.sock -e <span class=\"string\">\"ALTER USER 'root'@'localhost' IDENTIFIED BY 'System123@';\"</span> --connect-expired-password</span><br><span class=\"line\">mysql -u root -p<span class=\"variable\">$pass3307</span> -S /data/3307/mysql.sock -e <span class=\"string\">\"ALTER USER 'root'@'localhost' IDENTIFIED BY 'System123@';\"</span> --connect-expired-password</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#显示更改成功</span></span><br><span class=\"line\">mysql -uroot -pSystem123@ -S /data/3306/mysql.sock -e <span class=\"string\">\"status;\"</span></span><br><span class=\"line\">mysql -uroot -pSystem123@ -S /data/3307/mysql.sock -e <span class=\"string\">\"status;\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br>Step 2. 一键主从脚本搭建：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">MYUSER=<span class=\"string\">\"root\"</span></span><br><span class=\"line\">MYPASS=<span class=\"string\">\"System123@\"</span></span><br><span class=\"line\">MYSOCK=/data/3306/mysql.sock</span><br><span class=\"line\">BAKPATH=/data/backup</span><br><span class=\"line\">LOGFILE=<span class=\"variable\">$&#123;BAKPATH&#125;</span>/mysql_Binlogs_`date +%F`.<span class=\"built_in\">log</span></span><br><span class=\"line\">DATAFILE=<span class=\"variable\">$&#123;BAKPATH&#125;</span>/mysql_Backup_`date +%F`.sql</span><br><span class=\"line\"></span><br><span class=\"line\">MYSQL_HOME=/usr/<span class=\"built_in\">local</span>/mysql/bin</span><br><span class=\"line\">MYSQL_CMD=<span class=\"string\">\"<span class=\"variable\">$&#123;MYSQL_HOME&#125;</span>/mysql -u<span class=\"variable\">$MYUSER</span> -p<span class=\"variable\">$MYPASS</span> -S <span class=\"variable\">$MYSOCK</span>\"</span></span><br><span class=\"line\">MYSQL_DUMP=<span class=\"string\">\"<span class=\"variable\">$&#123;MYSQL_HOME&#125;</span>/mysqldump -u<span class=\"variable\">$MYUSER</span> -p<span class=\"variable\">$MYPASS</span> -S<span class=\"variable\">$MYSOCK</span> -A -B --flush-logs --events --master-data=2\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">[ `<span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"select user,host from mysql.user\"</span>|grep rep|wc -l` -ne 1 ] &amp;&amp; <span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"CREATE USER 'rep'@'%' IDENTIFIED BY 'System123@';\"</span> &amp;&amp;</span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"grant replication slave on *.* to 'rep'@'%';\"</span> &amp;&amp; <span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"flush privileges;\"</span> || <span class=\"built_in\">echo</span> <span class=\"string\">\"用户已建立\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"flush tables with read lock;\"</span></span><br><span class=\"line\">sleep 2</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"--------show Master status---------------\"</span> &gt; <span class=\"variable\">$LOGFILE</span></span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"show master status;\"</span>&gt;&gt; <span class=\"variable\">$LOGFILE</span></span><br><span class=\"line\"><span class=\"variable\">$MYSQL_DUMP</span> &gt; <span class=\"variable\">$DATAFILE</span></span><br><span class=\"line\">sleep 5</span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"unlock tables;\"</span></span><br><span class=\"line\">cat <span class=\"variable\">$LOGFILE</span></span><br><span class=\"line\"><span class=\"comment\">#MAIL -e \"mysql slave log\" 3333@qq.com &lt; $LOG_FILE</span></span><br></pre></td></tr></table></figure><br><br></p>\n<p>Step 3. 从库配置建立：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#从库建立</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">MYUSER=<span class=\"string\">\"root\"</span></span><br><span class=\"line\">MYPASS=<span class=\"string\">\"System123@\"</span></span><br><span class=\"line\">MYSOCK=/data/3307/mysql.sock</span><br><span class=\"line\">BAKPATH=/data/backup</span><br><span class=\"line\">MYSQL_HOME=/usr/<span class=\"built_in\">local</span>/mysql/bin</span><br><span class=\"line\">LOGFILE=<span class=\"variable\">$&#123;BAKPATH&#125;</span>/mysql_Binlogs_`date +%F`.<span class=\"built_in\">log</span></span><br><span class=\"line\">DATAFILE=<span class=\"variable\">$&#123;BAKPATH&#125;</span>/mysql_Backup_`date +%F`.sql</span><br><span class=\"line\">MYSQL_CMD=<span class=\"string\">\"<span class=\"variable\">$&#123;MYSQL_HOME&#125;</span>/mysql -u<span class=\"variable\">$MYUSER</span> -p<span class=\"variable\">$MYPASS</span> -S <span class=\"variable\">$MYSOCK</span>\"</span></span><br><span class=\"line\"><span class=\"comment\">#导入数据到从库中</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /data/backup &amp;&amp; <span class=\"variable\">$&#123;MYSQL_CMD&#125;</span> &lt; <span class=\"variable\">$&#123;DATAFILE&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#config slave</span></span><br><span class=\"line\"><span class=\"comment\">#下面为了测试填写的管理IP实际填写VIP</span></span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"CHANGE MASTER TO MASTER_HOST='192.168.1.200',MASTER_PORT=3306,MASTER_USER='rep',MASTER_PASSWORD='System123@',MASTER_LOG_FILE='mysql-bin.000010',MASTER_LOG_POS=815;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"start slave;\"</span> </span><br><span class=\"line\">sleep 5</span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"show slave status\\G;\"</span> | egrep <span class=\"string\">\"IO_Running|SQL_Running\"</span> &gt;&gt; <span class=\"variable\">$LOG_FILE</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190504194644.png\" alt=\"WeiyiGeek.主从同步搭建成功\" title=\"\" class=\"\">\n                <p>WeiyiGeek.主从同步搭建成功</p>\n            </figure></p>\n<p><br></p>\n<p>Step 4. 配置heartbeatmysql的启动脚本<br>vim /usr/local/heartbeat/etc/ha.d/resource.d/Mastermysqld<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">port=3306   <span class=\"comment\">#必须</span></span><br><span class=\"line\">mysql_user=<span class=\"string\">\"root\"</span>  <span class=\"comment\">#需求更改</span></span><br><span class=\"line\">mysql_pwd=<span class=\"string\">\"System123@\"</span>  <span class=\"comment\">#需求更改</span></span><br><span class=\"line\">CmdPath=<span class=\"string\">\"/usr/local/mysql/bin\"</span> </span><br><span class=\"line\">mysql_sock=<span class=\"string\">\"/data/<span class=\"variable\">$&#123;port&#125;</span>/mysql.sock\"</span> </span><br><span class=\"line\"><span class=\"comment\">#startup function</span></span><br><span class=\"line\">function_start_mysql()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -e <span class=\"string\">\"<span class=\"variable\">$mysql_sock</span>\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">printf</span> <span class=\"string\">\"Starting MySQL...\\n\"</span></span><br><span class=\"line\">      /bin/sh <span class=\"variable\">$&#123;CmdPath&#125;</span>/mysqld_safe --defaults-file=/data/<span class=\"variable\">$&#123;port&#125;</span>/my.cnf 2&gt;&amp;1 &gt; /dev/null &amp;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"built_in\">printf</span> <span class=\"string\">\"MySQL is running...\\n\"</span></span><br><span class=\"line\">      <span class=\"built_in\">exit</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#stop function</span></span><br><span class=\"line\">function_stop_mysql()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -e <span class=\"string\">\"<span class=\"variable\">$mysql_sock</span>\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">       <span class=\"built_in\">printf</span> <span class=\"string\">\"MySQL is stopped...\\n\"</span></span><br><span class=\"line\">       <span class=\"built_in\">exit</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">       <span class=\"built_in\">printf</span> <span class=\"string\">\"Stoping MySQL...\\n\"</span></span><br><span class=\"line\">       <span class=\"variable\">$&#123;CmdPath&#125;</span>/mysqladmin -u <span class=\"variable\">$&#123;mysql_user&#125;</span> -p<span class=\"variable\">$&#123;mysql_pwd&#125;</span> -S /data/<span class=\"variable\">$&#123;port&#125;</span>/mysql.sock shutdown</span><br><span class=\"line\">   <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#restart function</span></span><br><span class=\"line\">function_restart_mysql()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    function_stop_mysql</span><br><span class=\"line\">    sleep 2</span><br><span class=\"line\">    function_start_mysql</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"variable\">$1</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">start)</span><br><span class=\"line\">    function_start_mysql</span><br><span class=\"line\">;;</span><br><span class=\"line\">stop)</span><br><span class=\"line\">    function_stop_mysql</span><br><span class=\"line\">;;</span><br><span class=\"line\">restart)</span><br><span class=\"line\">    function_restart_mysql</span><br><span class=\"line\">;;</span><br><span class=\"line\">*)</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># heartbeat haresources 资源文件</span></span><br><span class=\"line\">data1 IPaddr::192.168.1.200/24/eth1 drbddisk::data Filesystem::/dev/drbd0::/data/3306/::ext4 Mastermysqld</span><br></pre></td></tr></table></figure></p>\n<p><br><br>Step 5. 拷贝资源配置文件到热备服务器中</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@data1 ha.d]$ scp haresources root@192.168.1.101:/usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/haresources</span><br><span class=\"line\">haresources                                                                                                      </span><br><span class=\"line\">[root@data1 ha.d]$ scp ./resource.d/Mastermysqld root@192.168.1.101:/usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/resource.d/Mastermysqld</span><br><span class=\"line\">Mastermysqld</span><br><span class=\"line\">[root@data2 ha.d]$ chown -R root:haclient /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#热备建立mysql目录(来存储drbd0中的数据)</span></span><br><span class=\"line\">$ chown mysql:mysql /data/mysql</span><br><span class=\"line\">``` </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;br&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Step 6.主从高可用的启动流程</span><br><span class=\"line\">```bash</span><br><span class=\"line\"><span class=\"comment\">#注意事项：</span></span><br><span class=\"line\"><span class=\"comment\">#（1）启动前查看文件权限是否正常</span></span><br><span class=\"line\"><span class=\"comment\"># (2) 停止主库3306的服务,从库一般不做高可用</span></span><br><span class=\"line\"><span class=\"comment\">#（3）主节点先启动heartbeat服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#data1 和 data2 分别执行</span></span><br><span class=\"line\">[data1/data2]$ service drbd start</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#将主库的文件移动到其他地方(带权限复制)</span></span><br><span class=\"line\">[root@data1 data]$ cp -PR 3306/ 3308/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动data1 heartbeat ，data2 延迟启动</span></span><br><span class=\"line\">service heartbeat start</span><br><span class=\"line\"><span class=\"variable\">$ssh</span> root@192.168.1.101 <span class=\"string\">\"service heartbeat start\"</span></span><br><span class=\"line\">Starting heartbeat (via systemctl):  [  OK  ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#data1查看drbd 磁盘挂载</span></span><br><span class=\"line\"> 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class=\"line\">/dev/drbd0               262M  166M   76M  69% /data/3306</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#主从同步状态</span></span><br><span class=\"line\">data1 - 3306 - mysql&gt; show master status;</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">| mysql-bin.000012 |      349 |              |                  |                   |</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">1 row <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#从库的状态（没问题OK）</span></span><br><span class=\"line\">data1 - 3307 - mysql&gt; show slave status\\G;</span><br><span class=\"line\">*************************** 1. row ***************************</span><br><span class=\"line\">               Slave_IO_State: Waiting <span class=\"keyword\">for</span> master to send event</span><br><span class=\"line\">                  Master_Host: 192.168.1.200</span><br><span class=\"line\">                  Master_User: rep</span><br><span class=\"line\">                  Master_Port: 3306</span><br><span class=\"line\">                Connect_Retry: 60</span><br><span class=\"line\">              Master_Log_File: mysql-bin.000012</span><br><span class=\"line\">          Read_Master_Log_Pos: 349</span><br><span class=\"line\">               Relay_Log_File: data1-relay-bin.000005</span><br><span class=\"line\">                Relay_Log_Pos: 516</span><br><span class=\"line\">        Relay_Master_Log_File: mysql-bin.000012</span><br><span class=\"line\">             Slave_IO_Running: Yes</span><br><span class=\"line\">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>Step 7. 模拟测试机器宕机<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@data1 ~]<span class=\"comment\"># /usr/local/heartbeat/share/heartbeat/hb_standby</span></span><br><span class=\"line\">Going standby [all].</span><br><span class=\"line\"><span class=\"comment\">#  /usr/local/heartbeat/share/heartbeat/hb_takeover local  #重新接管回来</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@data2 ~]<span class=\"comment\"># df -h</span></span><br><span class=\"line\">/dev/drbd0               262M  166M   76M  69% /data/3306</span><br><span class=\"line\">[root@data2 ~]<span class=\"comment\"># ls /data/3306/</span></span><br><span class=\"line\">binlog/      data/        innodb_log/  innodb_ts/   logs/        mysql.sock   mysqlx.sock  tmp/</span><br><span class=\"line\"><span class=\"comment\">#此时备服务器的drbd变成主</span></span><br><span class=\"line\">0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class=\"line\"><span class=\"comment\">#mysql服务也正常启动</span></span><br><span class=\"line\">[root@data2 ~]<span class=\"comment\"># lsof -i:3306</span></span><br><span class=\"line\">COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">mysqld  9844 mysql   39u  IPv6  33224      0t0  TCP *:mysql (LISTEN)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#测试登陆插入一些数据</span></span><br><span class=\"line\">[root@data2 ~]$ mysql -uroot -pSystem123@ -S /data/3306/mysql.sock</span><br><span class=\"line\">mysql&gt; status;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">mysql  Ver 8.0.16 <span class=\"keyword\">for</span> linux-glibc2.12 on x86_64 (MySQL Community Server - GPL)</span><br></pre></td></tr></table></figure><br><br><br>Step 8. 登陆从库查看通过状态<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#不能同步的时候采用rep 进行远程登陆</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#** VIP -DATA2 - 3306 **</span></span><br><span class=\"line\">mysql&gt; show master status;</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">| mysql-bin.000015 |      441 |              |                  |                   |</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#** 从库 -DATA1 - 3307 **</span></span><br><span class=\"line\">mysql&gt; show slave status\\G;</span><br><span class=\"line\">Master_Log_File: mysql-bin.000015</span><br><span class=\"line\">Read_Master_Log_Pos: 441</span><br><span class=\"line\">Relay_Log_File: data1-relay-bin.000009</span><br><span class=\"line\">Relay_Log_Pos: 655</span><br><span class=\"line\">Relay_Master_Log_File: mysql-bin.000015</span><br><span class=\"line\">Slave_IO_Running: Yes</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190504211853.png\" alt=\"WeiyiGeek.VIP漂移后的主从同步\" title=\"\" class=\"\">\n                <p>WeiyiGeek.VIP漂移后的主从同步</p>\n            </figure></p>\n<p><em>总括：</em><br>描述：HeartBeat是基于服务器级别的,如果要检测某项服务是否宕掉然后进行切换,就必须自己编写脚本来实时监控进程状态;然后来进行heartbeat切换;</p>\n<hr>\n\n<h4 id=\"补充\"><a href=\"#补充\" class=\"headerlink\" title=\"补充\"></a>补充</h4><p><strong>1. drbddisk 脚本</strong><br>$ vi /usr/local/heartbeat/etc/ha.d/resource.d/drbddisk<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!&#x2F;bin&#x2F;bash</span><br><span class=\"line\">#</span><br><span class=\"line\"># This script is inteded to be used as resource script by heartbeat</span><br><span class=\"line\">#</span><br><span class=\"line\"># Copright 2003-2008 LINBIT Information Technologies</span><br><span class=\"line\"># Philipp Reisner, Lars Ellenberg</span><br><span class=\"line\">#</span><br><span class=\"line\">###</span><br><span class=\"line\"> </span><br><span class=\"line\">DEFAULTFILE&#x3D;&quot;&#x2F;etc&#x2F;default&#x2F;drbd&quot;</span><br><span class=\"line\">DRBDADM&#x3D;&quot;&#x2F;sbin&#x2F;drbdadm&quot;</span><br><span class=\"line\"> </span><br><span class=\"line\">if [ -f $DEFAULTFILE ]; then</span><br><span class=\"line\"> . $DEFAULTFILE</span><br><span class=\"line\">fi</span><br><span class=\"line\"> </span><br><span class=\"line\">if [ &quot;$#&quot; -eq 2 ]; then</span><br><span class=\"line\"> RES&#x3D;&quot;$1&quot;</span><br><span class=\"line\"> CMD&#x3D;&quot;$2&quot;</span><br><span class=\"line\">else</span><br><span class=\"line\"> RES&#x3D;&quot;all&quot;</span><br><span class=\"line\"> CMD&#x3D;&quot;$1&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"> </span><br><span class=\"line\">## EXIT CODES</span><br><span class=\"line\"># since this is a &quot;legacy heartbeat R1 resource agent&quot; script,</span><br><span class=\"line\"># exit codes actually do not matter that much as long as we conform to</span><br><span class=\"line\">#  http:&#x2F;&#x2F;wiki.linux-ha.org&#x2F;HeartbeatResourceAgent</span><br><span class=\"line\"># but it does not hurt to conform to lsb init-script exit codes,</span><br><span class=\"line\"># where we can.</span><br><span class=\"line\">#  http:&#x2F;&#x2F;refspecs.linux-foundation.org&#x2F;LSB_3.1.0&#x2F;</span><br><span class=\"line\">#LSB-Core-generic&#x2F;LSB-Core-generic&#x2F;iniscrptact.html</span><br><span class=\"line\">####</span><br><span class=\"line\"> </span><br><span class=\"line\">drbd_set_role_from_proc_drbd()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">local out</span><br><span class=\"line\">if ! test -e &#x2F;proc&#x2F;drbd; then</span><br><span class=\"line\">ROLE&#x3D;&quot;Unconfigured&quot;</span><br><span class=\"line\">return</span><br><span class=\"line\">fi</span><br><span class=\"line\"> </span><br><span class=\"line\">dev&#x3D;$( $DRBDADM sh-dev $RES )</span><br><span class=\"line\">minor&#x3D;$&#123;dev#&#x2F;dev&#x2F;drbd&#125;</span><br><span class=\"line\">if [[ $minor &#x3D; *[!0-9]* ]] ; then</span><br><span class=\"line\"># sh-minor is only supported since drbd 8.3.1</span><br><span class=\"line\">minor&#x3D;$( $DRBDADM sh-minor $RES )</span><br><span class=\"line\">fi</span><br><span class=\"line\">if [[ -z $minor ]] || [[ $minor &#x3D; *[!0-9]* ]] ; then</span><br><span class=\"line\">ROLE&#x3D;Unknown</span><br><span class=\"line\">return</span><br><span class=\"line\">fi</span><br><span class=\"line\"> </span><br><span class=\"line\">if out&#x3D;$(sed -ne &quot;&#x2F;^ *$minor: cs:&#x2F; &#123; s&#x2F;:&#x2F; &#x2F;g; p; q; &#125;&quot; &#x2F;proc&#x2F;drbd); then</span><br><span class=\"line\">set -- $out</span><br><span class=\"line\">ROLE&#x3D;$&#123;5%&#x2F;**&#125;</span><br><span class=\"line\">: $&#123;ROLE:&#x3D;Unconfigured&#125; # if it does not show up</span><br><span class=\"line\">else</span><br><span class=\"line\">ROLE&#x3D;Unknown</span><br><span class=\"line\">fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">case &quot;$CMD&quot; in</span><br><span class=\"line\">   start)</span><br><span class=\"line\"># try several times, in case heartbeat deadtime</span><br><span class=\"line\"># was smaller than drbd ping time</span><br><span class=\"line\">try&#x3D;6</span><br><span class=\"line\">while true; do</span><br><span class=\"line\">$DRBDADM primary $RES &amp;&amp; break</span><br><span class=\"line\">let &quot;--try&quot; || exit 1 # LSB generic error</span><br><span class=\"line\">sleep 1</span><br><span class=\"line\">done</span><br><span class=\"line\">;;</span><br><span class=\"line\">   stop)</span><br><span class=\"line\"># heartbeat (haresources mode) will retry failed stop</span><br><span class=\"line\"># for a number of times in addition to this internal retry.</span><br><span class=\"line\">try&#x3D;3</span><br><span class=\"line\">while true; do</span><br><span class=\"line\">$DRBDADM secondary $RES &amp;&amp; break</span><br><span class=\"line\"># We used to lie here, and pretend success for anything !&#x3D; 11,</span><br><span class=\"line\"># to avoid the reboot on failed stop recovery for &quot;simple</span><br><span class=\"line\"># config errors&quot; and such. But that is incorrect.</span><br><span class=\"line\"># Don&#39;t lie to your cluster manager.</span><br><span class=\"line\"># And don&#39;t do config errors...</span><br><span class=\"line\">let --try || exit 1 # LSB generic error</span><br><span class=\"line\">sleep 1</span><br><span class=\"line\">done</span><br><span class=\"line\">;;</span><br><span class=\"line\">   status)</span><br><span class=\"line\">if [ &quot;$RES&quot; &#x3D; &quot;all&quot; ]; then</span><br><span class=\"line\">   echo &quot;A resource name is required for status inquiries.&quot;</span><br><span class=\"line\">   exit 10</span><br><span class=\"line\">fi</span><br><span class=\"line\">ST&#x3D;$( $DRBDADM role $RES )</span><br><span class=\"line\">ROLE&#x3D;$&#123;ST%&#x2F;**&#125;</span><br><span class=\"line\">case $ROLE in</span><br><span class=\"line\">Primary|Secondary|Unconfigured)</span><br><span class=\"line\"># expected</span><br><span class=\"line\">;;</span><br><span class=\"line\">*)</span><br><span class=\"line\"># unexpected. whatever...</span><br><span class=\"line\"># If we are unsure about the state of a resource, we need to</span><br><span class=\"line\"># report it as possibly running, so heartbeat can, after failed</span><br><span class=\"line\"># stop, do a recovery by reboot.</span><br><span class=\"line\"># drbdsetup may fail for obscure reasons, e.g. if &#x2F;var&#x2F;lock&#x2F; is</span><br><span class=\"line\"># suddenly readonly.  So we retry by parsing &#x2F;proc&#x2F;drbd.</span><br><span class=\"line\">drbd_set_role_from_proc_drbd</span><br><span class=\"line\">esac</span><br><span class=\"line\">case $ROLE in</span><br><span class=\"line\">Primary)</span><br><span class=\"line\">echo &quot;running (Primary)&quot;</span><br><span class=\"line\">exit 0 # LSB status &quot;service is OK&quot;</span><br><span class=\"line\">;;</span><br><span class=\"line\">Secondary|Unconfigured)</span><br><span class=\"line\">echo &quot;stopped ($ROLE)&quot;</span><br><span class=\"line\">exit 3 # LSB status &quot;service is not running&quot;</span><br><span class=\"line\">;;</span><br><span class=\"line\">*)</span><br><span class=\"line\"># NOTE the &quot;running&quot; in below message.</span><br><span class=\"line\"># this is a &quot;heartbeat&quot; resource script,</span><br><span class=\"line\"># the exit code is _ignored_.</span><br><span class=\"line\">echo &quot;cannot determine status, may be running ($ROLE)&quot;</span><br><span class=\"line\">exit 4 #  LSB status &quot;service status is unknown&quot;</span><br><span class=\"line\">;;</span><br><span class=\"line\">esac</span><br><span class=\"line\">;;</span><br><span class=\"line\">   *)</span><br><span class=\"line\">echo &quot;Usage: drbddisk [resource] &#123;start|stop|status&#125;&quot;</span><br><span class=\"line\">exit 1</span><br><span class=\"line\">;;</span><br><span class=\"line\">esac</span><br><span class=\"line\"></span><br><span class=\"line\">exit 0</span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h4 id=\"入坑\"><a href=\"#入坑\" class=\"headerlink\" title=\"入坑\"></a>入坑</h4><p><strong>（0）脚本权限问题导致heartbeat不能正常执行</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#仅限源码安装的</span></span><br><span class=\"line\">chown root:haclient /usr/lib/ocf/resource.d/heartbeat/Filesystem</span><br><span class=\"line\">chown root:haclient /usr/lib/ocf/resource.d/heartbeat/IPaddr</span><br><span class=\"line\">chown -R root:haclient /etc/ha.d/resource.d/</span><br><span class=\"line\">usermod -g haclient -G root hacluster  <span class=\"comment\">#hacluster加入到附属组 (更加实际需求)</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>（1）高可用ha-log日志Filesystem报错</strong><br>问题：找不到fuser命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ResourceManager(default)[17749]:\t2019&#x2F;04&#x2F;29_22:41:11 info: Running &#x2F;usr&#x2F;local&#x2F;heartbeat&#x2F;etc&#x2F;ha.d&#x2F;resource.d&#x2F;Filesystem &#x2F;dev&#x2F;drbd0 &#x2F;data ext4 stop</span><br><span class=\"line\">Filesystem(Filesystem_&#x2F;dev&#x2F;drbd0)[18665]:\t2019&#x2F;04&#x2F;29_22:41:11 ERROR: Setup problem: couldn&#39;t find command: fuser</span><br></pre></td></tr></table></figure><br>解决方法：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install psmisc</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>(2) 普通用户无法执行mount</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usermod -g haclient -G root hacluster  <span class=\"comment\">#hacluster加入到附属组 (更加实际需求)</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>(3) 高可用主从同步 IO_Running NO 错误</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(1) 有时候需要等待60s进行重试连接(如果这种方法不行就手动)</span><br><span class=\"line\">(2) 停止slave再启动slave即可</span><br><span class=\"line\">(3) 先利用rep登陆mysql然后再退出记可用正常同步</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Database","path":"api/categories/Database.json"},{"name":"DBA","path":"api/categories/DBA.json"},{"name":"运维","path":"api/categories/运维.json"}],"tags":[{"name":"MYSQL","path":"api/tags/MYSQL.json"}]}