{"title":"GitLab企业级私有代码仓库安装与基础使用","slug":"系统运维/自动化运维/CI-CD/Gitlab/1.GitLab企业私有代码仓库安装与基础使用","date":"2019-07-22T12:35:30.000Z","updated":"2023-01-31T02:29:10.467Z","url":"2019/7-22-98.html","path":"api/articles/2019/7-22-98.html.json","covers":["https://img.weiyigeek.top/2020/1/20200415105119.png","https://img.weiyigeek.top/2020/1/20200415105613.png","https://img.weiyigeek.top/2020/1/20200415163112.png","https://img.weiyigeek.top/2020/1/20200415173638.png","https://img.weiyigeek.top/2020/1/20200416112358.png","https://img.weiyigeek.top/2020/1/20200415214715.png","https://img.weiyigeek.top/2020/1/20200416113914.png","https://img.weiyigeek.top/2020/1/20200416131432.png","https://img.weiyigeek.top/2020/1/20200416134004.png","https://img.weiyigeek.top/2020/1/20200416151412.png","https://img.weiyigeek.top/2020/1/20200415212316.png","https://img.weiyigeek.top/2020/1/20200415172031.png","https://img.weiyigeek.top/2020/1/20200415172222.png","https://img.weiyigeek.top/2020/1/20200415201032.png","https://img.weiyigeek.top/2020/1/20200415221141.png","https://img.weiyigeek.top/2020/1/20200416162240.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>PS: 在开源世界中，是没有终结的尽头！</p>\n<p>描述:GitLab 是一个非常优秀的开源项目，基于Ruby on Rails开发的开源应用程序。它允许用户在自己的服务器上运行类似于 GitHub 的项目管理系统，实现一个自托管私有的Git项目仓库，可通过Web界面进行访问公开的或者私人的项目Gitlab能够浏览源代码，管理缺陷和注释。</p>\n<p>官网地址:<a href=\"https://about.gitlab.com/\" target=\"_blank\" rel=\"noopener\">https://about.gitlab.com/</a><br>帮助文档:<a href=\"https://about.gitlab.com/install/\" target=\"_blank\" rel=\"noopener\">https://about.gitlab.com/install/</a><br>组件参考:<a href=\"https://docs.gitlab.com/ce/development/architecture.html\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/ce/development/architecture.html</a></p>\n<p>GitLab 采用传统的开源商业模式,他们有两种产品：</p>\n<ul>\n<li>免费的开源软件，用户可以在自己的服务器上安装，以及类似于 GitHub 的托管服务。</li>\n<li>免费的社区版<code>Gitlab CE</code>和付费企业版<code>Gitlab EE</code><ul>\n<li>企业版基于社区版但附带针对企业客户的其他功能,它或多或少与 WordPress.org 或 Wordpress.com 提供的服务类似。</li>\n</ul>\n</li>\n</ul>\n<p>Q: Gitlab 优势及应用场景?</p>\n<ul>\n<li>1.开源免费，搭建简单，维护成本低，适合中小型公司;</li>\n<li>2.权限管理，能实现代码对部分人可见，确保项目的安全性；</li>\n<li>3.离线同步，保证我们不在实时依赖网络环境进行代码提交；</li>\n</ul>\n<p>Gitlab优点：</p>\n<ul>\n<li>有开源免费的版本，可以进行私有开发上传与拉取;</li>\n<li>社区版具有高度可扩展性，可以在单个服务器或群集上支持 25000 个用户</li>\n<li>GitLab 的一些功能包括：Git 仓库管理，代码评论，问题跟踪，活动源和维基</li>\n<li>它配备了 GitLab CI，用于持续集成和交付</li>\n</ul>\n<hr>\n<h2 id=\"0x01-环境安装\"><a href=\"#0x01-环境安装\" class=\"headerlink\" title=\"0x01 环境安装\"></a>0x01 环境安装</h2><h3 id=\"CentOS\"><a href=\"#CentOS\" class=\"headerlink\" title=\"CentOS\"></a>CentOS</h3><p>Gitlab 基础要求:至少4GB的空闲RAM来运行GitLab</p>\n<ul>\n<li>系统:CentOS Linux release 8.0.1905 (Core)<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GitLab 12.9.2 (ac5568eb5d8)</span><br><span class=\"line\">GitLab Shell 12.0.0</span><br><span class=\"line\">GitLab Workhorse v8.25.1</span><br><span class=\"line\">GitLab APIv 4</span><br><span class=\"line\">Ruby 2.6.5p114</span><br><span class=\"line\">Rails 6.0.2</span><br><span class=\"line\">PostgreSQL 10.12</span><br><span class=\"line\">Gitaly Servers</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Gitlab 安装方式:</p>\n<ul>\n<li>官方推荐使用Omnibus快速安装（采用rpm软件包进行安装部署（国内推荐直接镜像源下载））;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#此处以社区版本为例</span></span><br><span class=\"line\">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span><br><span class=\"line\">sudo EXTERNAL_URL=<span class=\"string\">\"https://gitlab.example.com\"</span> dnf install -y gitlab-ee</span><br></pre></td></tr></table></figure></li>\n<li>采用yum进行安装部署;</li>\n</ul>\n<p><br/></p>\n<p><strong>安装流程:</strong><br>Step1.采用rpm进行安装社区版gitlab(替换更新源自己选择即可):<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dn8 install -y curl policycoreutils openssh-server wget</span><br><span class=\"line\"><span class=\"comment\">#可以使用 wget 的方式把 rpm 包下载下来安装</span></span><br><span class=\"line\">wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el8/gitlab-ce-12.9.2-ce.0.el8.x86_64.rpm</span><br><span class=\"line\"><span class=\"comment\">#dnf install gitlab-ce-12.9.2-ce.0.el8.x86_64.rpm</span></span><br><span class=\"line\">rpm -ivh gitlab-ce-12.9.2-ce.0.el8.x86_64.rpm</span><br></pre></td></tr></table></figure></p>\n<p>Step2.安装完成后显示以下则说明安装成功:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Thank you for installing GitLab!</span></span><br><span class=\"line\"><span class=\"comment\"># GitLab was unable to detect a valid hostname for your instance.</span></span><br><span class=\"line\"><span class=\"comment\"># Please configure a URL for your GitLab instance by setting `external_url`</span></span><br><span class=\"line\"><span class=\"comment\"># configuration in /etc/gitlab/gitlab.rb file.</span></span><br><span class=\"line\"><span class=\"comment\"># Then, you can start your GitLab instance by running the following command:</span></span><br><span class=\"line\"><span class=\"comment\"># sudo gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure></p>\n<p>Step3.修改 gitlab 默认配置<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/gitlab/gitlab.rb</span><br><span class=\"line\"><span class=\"comment\"># (1) 站点域名配置，修改为你自己的域名或者 IP，是单引号，而且前面的 http 不要改 （并且将该域名加入到hosts中）</span></span><br><span class=\"line\">external_url <span class=\"string\">'http://gitlab.weiyigeek.top'</span>    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 邮件配置</span></span><br><span class=\"line\"><span class=\"comment\"># 启动 smtp</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable'</span>] = <span class=\"literal\">false</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_address'</span>] = <span class=\"string\">\"smtp.qq.com\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_port'</span>] = 587 <span class=\"comment\">#SSL</span></span><br><span class=\"line\"><span class=\"comment\"># 账户邮箱密码</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_user_name'</span>] = <span class=\"string\">\"weiyigeek\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_password'</span>] = <span class=\"string\">\"password\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_authentication'</span>] = <span class=\"string\">\":plain\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable_starttls_auto'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># gitlab_rails['smtp_tls'] =</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 发件人邮箱即显示名称</span></span><br><span class=\"line\"><span class=\"comment\"># PS:没有邮件服务器可以关闭邮件服务功能</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_enabled'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_from'</span>] = <span class=\"string\">\"master#weiyigeek.top\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_display_name'</span>] = <span class=\"string\">'GitLab-System-WeiyiGeek'</span></span><br></pre></td></tr></table></figure></p>\n<p>Step4.完成修改后需要重新加载配置然后重启即可;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gitlab-ctl reconfigure</span><br><span class=\"line\"><span class=\"comment\"># [2020-04-15T10:33:44+08:00] WARN: Please install an English UTF-8 locale for Chef to use, falling back to C locale and disabling UTF-8 support. #如果看着不舒服自己设置系统语系即可</span></span><br><span class=\"line\"><span class=\"comment\"># [2020-04-15T10:33:45+08:00] WARN: Please install an English UTF-8 locale for Chef to use, falling back to C locale and disabling UTF-8 support.</span></span><br><span class=\"line\"><span class=\"comment\"># Starting Chef Client, version 14.14.29</span></span><br><span class=\"line\"><span class=\"comment\"># resolving cookbooks for run list: [\"gitlab\"]</span></span><br><span class=\"line\"><span class=\"comment\"># Synchronizing Cookbooks:</span></span><br><span class=\"line\"><span class=\"comment\">#   - redis (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - package (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - postgresql (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - mattermost (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - consul (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - letsencrypt (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - gitlab (0.0.1)</span></span><br><span class=\"line\"><span class=\"comment\">#   - runit (4.3.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - monitoring (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - praefect (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - gitaly (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - registry (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - acme (4.1.1)</span></span><br><span class=\"line\"><span class=\"comment\">#   - nginx (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\">#   - crond (0.1.0)</span></span><br><span class=\"line\"><span class=\"comment\"># Running handlers:</span></span><br><span class=\"line\"><span class=\"comment\"># Running handlers complete</span></span><br><span class=\"line\"><span class=\"comment\"># Chef Client finished, 541/1460 resources updated in 03 minutes 14 seconds</span></span><br><span class=\"line\"><span class=\"comment\"># gitlab Reconfigured!</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ gitlab-ctl restart</span><br><span class=\"line\"><span class=\"comment\"># [2020-04-15T10:37:51+08:00] WARN: Please install an English UTF-8 locale for Chef to use, falling back to C locale and disabling UTF-8 support.</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: alertmanager: (pid 21410) 1s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: gitaly: (pid 21422) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: gitlab-exporter: (pid 21429) 1s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: gitlab-workhorse: (pid 21444) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: grafana: (pid 21463) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: logrotate: (pid 21474) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: nginx: (pid 21480) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: node-exporter: (pid 21563) 1s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: postgres-exporter: (pid 21569) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: postgresql: (pid 21580) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: prometheus: (pid 21589) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: redis: (pid 21601) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: redis-exporter: (pid 21708) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: sidekiq: (pid 21716) 0s</span></span><br><span class=\"line\"><span class=\"comment\"># ok: run: unicorn: (pid 21727) 0s</span></span><br></pre></td></tr></table></figure></p>\n<p>Step5.如果 reconfigure 失败，则需要 <code>systemctl enable gitlab-runsvdir &amp;&amp; systemctl restart gitlab-runsvdir</code> 重启一下 gitlab-runsvdir 服务</p>\n<p>Step6.打开浏览器进行初始化账户设定密码，这个密码为 root 管理员账户的密码。设置完密码之后会自动跳转到登录页面。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">应用:http://gitlab.weiyigeek.top/</span><br><span class=\"line\">账号:root</span><br><span class=\"line\">密码:WeiyiGeek <span class=\"comment\">#8位及以上</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415105119.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>Step7.登录成功的界面,是不是有种疯狂的想写代码的冲动;<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415105613.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>Step8.英文可能对英语不好的新手可能不友好，我们进行汉化（<code>注意:高于12.3.5的版本无需汉化，直接在用户设置里面进行设置自定义语言选择简体中文</code>）;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#停止gitlab</span></span><br><span class=\"line\">gitlab-ctl stop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取当前安装的版本补丁</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://gitlab.com/xhang/gitlab.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> gitlab</span><br><span class=\"line\"><span class=\"comment\"># 查看全部分支版本</span></span><br><span class=\"line\">git branch -a</span><br><span class=\"line\">gitlab_version=$(cat /opt/gitlab/embedded/service/gitlab-rails/VERSION)</span><br><span class=\"line\"><span class=\"comment\"># 比较汉化标签和原标签，导出patch用的diff文件</span></span><br><span class=\"line\"><span class=\"comment\">#git diff v$&#123;gitlab_version&#125; v$&#123;gitlab_version&#125;-zh &gt; ../$&#123;gitlab_version&#125;-zh.diff</span></span><br><span class=\"line\">git diff remotes/origin/12-3-stable remotes/origin/12-3-stable-zh &gt; ../<span class=\"variable\">$&#123;gitlab_version&#125;</span>-zh.diff</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#打补丁的时候会提示一些补丁文件不存在，一定要跳过这些文件，不然后面reconfig的时候会报错的。</span></span><br><span class=\"line\">patch -d /opt/gitlab/embedded/service/gitlab-rails -p1 &lt; ../<span class=\"variable\">$&#123;gitlab_version&#125;</span>-zh.diff</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重新编译和启动</span></span><br><span class=\"line\">gitlab-ctl reconfigure</span><br><span class=\"line\">gitlab-ctl start</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><p>描述: 采用采用一个低权限用户进行管理docker以及利用docker部署gitlab服务;</p>\n<p>环境说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$lsb_release</span> -a</span><br><span class=\"line\">Description:    Ubuntu 20.04.1 LTS</span><br><span class=\"line\">Release:        20.04</span><br><span class=\"line\">Codename:       focal</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$docker</span> version</span><br><span class=\"line\">Client: Docker Engine - Community</span><br><span class=\"line\"> Version:           19.03.13</span><br><span class=\"line\"> API version:       1.40</span><br><span class=\"line\"> Go version:        go1.13.15</span><br><span class=\"line\"> Git commit:        4484c46d9d</span><br><span class=\"line\"> Built:             Wed Sep 16 17:02:52 2020</span><br><span class=\"line\"> OS/Arch:           linux/amd64</span><br><span class=\"line\"> Experimental:      <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">Server: Docker Engine - Community</span><br><span class=\"line\"> Engine:</span><br><span class=\"line\">  Version:          19.03.13</span><br><span class=\"line\">  API version:      1.40 (minimum version 1.12)</span><br><span class=\"line\">  Go version:       go1.13.15</span><br><span class=\"line\">  Git commit:       4484c46d9d</span><br><span class=\"line\">  Built:            Wed Sep 16 17:01:20 2020</span><br><span class=\"line\">  OS/Arch:          linux/amd64</span><br><span class=\"line\">  Experimental:     <span class=\"literal\">false</span></span><br><span class=\"line\"> containerd:</span><br><span class=\"line\">  Version:          1.3.7</span><br><span class=\"line\">  GitCommit:        8fba4e9a7d01810a393d5d25a3621dc101981175</span><br><span class=\"line\"> runc:</span><br><span class=\"line\">  Version:          1.0.0-rc10</span><br><span class=\"line\">  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd</span><br><span class=\"line\"> docker-init:</span><br><span class=\"line\">  Version:          0.18.0</span><br><span class=\"line\">  GitCommit:        fec3683</span><br></pre></td></tr></table></figure></p>\n<p>操作流程:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.新建低权限用户并将该用户加入到docker组</span></span><br><span class=\"line\">sudo useradd -m -g docker WeiyiGeek-gitlab &amp;&amp; sudo passwd WeiyiGeek-gitlab</span><br><span class=\"line\">sudo gpasswd -a WeiyiGeek-gitlab docker</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.切换到低权限的WeiyiGeek-gitlab用户拉去最新社区版本的gitlab</span></span><br><span class=\"line\">WeiyiGeek-gitlab@gitlab-WeiyiGeek:~$ docker pull gitlab/gitlab-ce:13.6.3-ce.0</span><br><span class=\"line\"><span class=\"comment\"># Using default tag: latest</span></span><br><span class=\"line\"><span class=\"comment\"># latest: Pulling from gitlab/gitlab-ce</span></span><br><span class=\"line\"><span class=\"comment\"># 4f53fa4d2cf0: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># 6af7c939e38e: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># 903d0ffd64f6: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># 04feeed388b7: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># 25d5e5c7360d: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># 0cc025692f2b: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># eac308723fda: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># 2135ce2185ba: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># 3d2db784a8b0: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># d2942fac7230: Pull complete</span></span><br><span class=\"line\"><span class=\"comment\"># Digest: sha256:b7daf0c109a62e776f5f72b728a01191059a51f43b5df82c53ef997e877a784f</span></span><br><span class=\"line\"><span class=\"comment\"># Status: Downloaded newer image for gitlab/gitlab-ce:latest</span></span><br><span class=\"line\"><span class=\"comment\"># docker.io/gitlab/gitlab-ce:latest</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.设置持久化目录并运行gitlab-server</span></span><br><span class=\"line\">$ mkdir -vp ~/&#123;config,logs,data,backups&#125;</span><br><span class=\"line\"><span class=\"comment\"># mkdir: created directory '/home/WeiyiGeek-gitlab/config'</span></span><br><span class=\"line\"><span class=\"comment\"># mkdir: created directory '/home/WeiyiGeek-gitlab/logs'</span></span><br><span class=\"line\"><span class=\"comment\"># mkdir: created directory '/home/WeiyiGeek-gitlab/data'</span></span><br><span class=\"line\">$ docker run -d -p 443:443 -p 80:80 -p 22:22 --name gitlab-server --restart always -v /home/WeiyiGeek-gitlab/config:/etc/gitlab -v /home/WeiyiGeek-gitlab/config/backups:/var/opt/gitlab/backups -v /home/WeiyiGeek-gitlab/logs:/var/<span class=\"built_in\">log</span>/gitlab -v /home/WeiyiGeek-gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:13.6.3-ce.0</span><br><span class=\"line\">docker run -d -p 443:443 -p 80:80 -p 22:22 --name gitlab-server --restart always -v /home/weiyigeek/config:/etc/gitlab -v /home/weiyigeek/config/backups:/var/opt/gitlab/backups -v /home/weiyigeek/logs:/var/<span class=\"built_in\">log</span>/gitlab -v /home/weiyigeek/data:/var/opt/gitlab gitlab/gitlab-ce:13.6.3-ce.0</span><br><span class=\"line\">512c45077bafaf1c617ddd6e43f4b8a9a147ca3c8b9e8e889b14d58f151647fe</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.利用docker logs查看gitlab 初始化是否完成</span></span><br><span class=\"line\">WeiyiGeek-gitlab@gitlab-WeiyiGeek:~$ docker logs -f --tail 100 512c</span><br><span class=\"line\">==&gt; /var/<span class=\"built_in\">log</span>/gitlab/puma/puma_stdout.log &lt;==</span><br><span class=\"line\">&#123;<span class=\"string\">\"timestamp\"</span>:<span class=\"string\">\"2020-10-10T06:14:37.385Z\"</span>,<span class=\"string\">\"pid\"</span>:767,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"PumaWorkerKiller: Consuming 3219.65625 mb with master and 4 workers.\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.主机名称配置</span></span><br><span class=\"line\">sudo tee /etc/hosts &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">192.168.10.222 gitlab.weiyigeek.top</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>PS: 配置文件地址<code>/etc/WeiyiGeek-gitlab/config</code>如何配置请参考下面文章，此处不再多做叙述;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改的键值对</span></span><br><span class=\"line\">sudo egrep -v <span class=\"string\">\"^#|^$\"</span> /home/WeiyiGeek-gitlab/config/gitlab.rb</span><br><span class=\"line\">[sudo] password <span class=\"keyword\">for</span> WeiyiGeek:</span><br><span class=\"line\"></span><br><span class=\"line\">external_url <span class=\"string\">'http://gitlab.WeiyiGeek.top'</span></span><br><span class=\"line\">user[<span class=\"string\">'git_user_name'</span>] = <span class=\"string\">\"Gitlab\"</span></span><br><span class=\"line\">user[<span class=\"string\">'git_user_email'</span>] = <span class=\"string\">\"gitlab@WeiyiGeek.top\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_ssh_host'</span>] = <span class=\"string\">'gitlab.WeiyiGeek.top'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_shell_ssh_port'</span>] = 2222</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_shell_git_timeout'</span>] = 800</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'time_zone'</span>] = <span class=\"string\">'Asia/Shanghai'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_enabled'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_from'</span>] = <span class=\"string\">'gitlab@WeiyiGeek.top'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_display_name'</span>] = <span class=\"string\">'Gitlab'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_reply_to'</span>] = <span class=\"string\">'weiyigeek@WeiyiGeek.top'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_subject_suffix'</span>] = <span class=\"string\">'WeiyiGeek-IT'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'enabled'</span>] = <span class=\"literal\">false</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'connection'</span>] = &#123;&#125;</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'storage_options'</span>] = &#123;&#125;</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'proxy_download'</span>] = <span class=\"literal\">false</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'objects'</span>][<span class=\"string\">'artifacts'</span>][<span class=\"string\">'bucket'</span>] = nil</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'objects'</span>][<span class=\"string\">'external_diffs'</span>][<span class=\"string\">'bucket'</span>] = nil</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'objects'</span>][<span class=\"string\">'lfs'</span>][<span class=\"string\">'bucket'</span>] = nil</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'objects'</span>][<span class=\"string\">'uploads'</span>][<span class=\"string\">'bucket'</span>] = nil</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'objects'</span>][<span class=\"string\">'packages'</span>][<span class=\"string\">'bucket'</span>] = nil</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'objects'</span>][<span class=\"string\">'dependency_proxy'</span>][<span class=\"string\">'bucket'</span>] = nil</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'object_store'</span>][<span class=\"string\">'objects'</span>][<span class=\"string\">'terraform_state'</span>][<span class=\"string\">'bucket'</span>] = nil</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_address'</span>] = <span class=\"string\">\"smtp.exmail.qq.com\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_port'</span>] = 465</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_user_name'</span>] = <span class=\"string\">\"gitlab@WeiyiGeek.top\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_password'</span>] = <span class=\"string\">\"Hm595Yb\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_domain'</span>] = <span class=\"string\">\"WeiyiGeek.com.top\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_authentication'</span>] = <span class=\"string\">\"login\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_tls'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改后重启gitlab容器即可</span></span><br><span class=\"line\">$ docker restart gitlab</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x02-操作说明\"><a href=\"#0x02-操作说明\" class=\"headerlink\" title=\"0x02 操作说明\"></a>0x02 操作说明</h2><p>Gitlab相关操作及说明：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#查看Gitlab版本</span></span><br><span class=\"line\">cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</span><br><span class=\"line\"></span><br><span class=\"line\">/etc/gitlab/gitlab.rb          <span class=\"comment\">#gitlab配置文件</span></span><br><span class=\"line\">/opt/gitlab                    <span class=\"comment\">#gitlab的程序安装目录</span></span><br><span class=\"line\">/var/opt/gitlab                <span class=\"comment\">#gitlab目录数据目录(通过gitlab.rb修改的子模块配置文件存放的)</span></span><br><span class=\"line\">/var/opt/gitlab/git-data       <span class=\"comment\">#存放仓库数据</span></span><br><span class=\"line\">/var/opt/gitlab/backups        <span class=\"comment\">#默认备份目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Gitlab的服务构成：</span></span><br><span class=\"line\">gitlab-shell:用于处理Git命令和修改authorized keys列表</span><br><span class=\"line\">gitlab-workhorse:轻量级的反向代理服务器</span><br><span class=\"line\">logrotate:日志文件管理工具</span><br><span class=\"line\">nginx:静态web服务器</span><br><span class=\"line\">postgresql:数据库</span><br><span class=\"line\">redis:缓存数据库</span><br><span class=\"line\">sidekiq:用于在后台执行队列任务(异步执行)</span><br><span class=\"line\">unicorn:GitLab Rails应用是托管在这个服务器上面的。</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"gitlab-ctl-命令\"><a href=\"#gitlab-ctl-命令\" class=\"headerlink\" title=\"gitlab-ctl 命令\"></a>gitlab-ctl 命令</h3><p>基础命令:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#常用命令</span></span><br><span class=\"line\">gitlab-ctl reconfigure         <span class=\"comment\">#生成配置并重新启动服务</span></span><br><span class=\"line\">gitlab-ctl start               <span class=\"comment\">#启动所有 gitlab 组件：</span></span><br><span class=\"line\">gitlab-ctl status              <span class=\"comment\">#查看当前gitlab所有服务运行状态</span></span><br><span class=\"line\">gitlab-ctl stop                <span class=\"comment\">#停止gitlab服务</span></span><br><span class=\"line\">gitlab-ctl pg-upgrade          <span class=\"comment\">#升级PostgreSQL最新版本</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#单独启动|停止|重启某个服务</span></span><br><span class=\"line\">gitlab-ctl start nginx            <span class=\"comment\">#启动nginx组件</span></span><br><span class=\"line\">gitlab-ctl stop postgresql        <span class=\"comment\">#停止所有 gitlab postgresql 组件：</span></span><br><span class=\"line\">gitlab-ctl restart unicorn        <span class=\"comment\">#重启相关数据连接服务</span></span><br><span class=\"line\">gitlab-ctl restart sidekiq        <span class=\"comment\">#重启相关数据连接服务</span></span><br><span class=\"line\">gitlab-ctl restart  gitlab-workhorse <span class=\"comment\"># 重启所有 gitlab gitlab-workhorse 组件：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#日志管理</span></span><br><span class=\"line\">gitlab-ctl tail         <span class=\"comment\">#查看所有服务的日志</span></span><br><span class=\"line\">gitlab-ctl tail redis   <span class=\"comment\">#实时检查redis的日志（延伸某个服务也是一样得）</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"gitlab-rails-命令\"><a href=\"#gitlab-rails-命令\" class=\"headerlink\" title=\"gitlab-rails 命令\"></a>gitlab-rails 命令</h3><p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#gitlab重置密码</span></span><br><span class=\"line\">gitlab-rails console </span><br><span class=\"line\">&gt; u=User.where(id:1).first        <span class=\"comment\">#这个是管理员的，也可以用email等</span></span><br><span class=\"line\">&gt; u.password = <span class=\"string\">'your_password'</span>    <span class=\"comment\">#密码有格式限制，我只知道8位以上否则会保存失败</span></span><br><span class=\"line\">&gt; u.password_confirmation = <span class=\"string\">'your_password'</span></span><br><span class=\"line\">&gt; u.save</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"gitlab-rake-命令\"><a href=\"#gitlab-rake-命令\" class=\"headerlink\" title=\"gitlab-rake 命令\"></a>gitlab-rake 命令</h3><p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-rake gitlab:check SANITIZE=<span class=\"literal\">true</span> --trace <span class=\"comment\"># 检查gitlab</span></span><br><span class=\"line\">gitlab-rake db:migrate <span class=\"comment\"># 数据库关系升级</span></span><br><span class=\"line\">gitlab-rake cache:clear <span class=\"comment\"># 清理redis缓存</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"release-cli-命令\"><a href=\"#release-cli-命令\" class=\"headerlink\" title=\"release-cli 命令\"></a>release-cli 命令</h3><p>描述: release-cli 一个与GitLab发布API交互的CLI工具。</p>\n<p>官方文档: <a href=\"https://gitlab.com/gitlab-org/release-cli/-/blob/master/docs/index.md#usage\" target=\"_blank\" rel=\"noopener\">https://gitlab.com/gitlab-org/release-cli/-/blob/master/docs/index.md#usage</a><br>参考地址: <a href=\"https://docs.gitlab.com/ee/api/releases/\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/ee/api/releases/</a></p>\n<p><strong>语法基参 &amp; Syntax</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># USAGE</span></span><br><span class=\"line\"><span class=\"built_in\">help</span> [global options] <span class=\"built_in\">command</span> [<span class=\"built_in\">command</span> options] [arguments...]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># GLOBAL OPTIONS:</span></span><br><span class=\"line\">--server-url value     The base URL of the GitLab instance, including protocol and port, <span class=\"keyword\">for</span> example https://gitlab.example.com:8080 [<span class=\"variable\">$CI_SERVER_URL</span>]</span><br><span class=\"line\">--job-token value      Job token used <span class=\"keyword\">for</span> authenticating with the GitLab Releases API [<span class=\"variable\">$CI_JOB_TOKEN</span>]</span><br><span class=\"line\">--project-id value     The current project unique ID; used by GitLab CI internally [<span class=\"variable\">$CI_PROJECT_ID</span>]</span><br><span class=\"line\">--timeout value        HTTP client timeout <span class=\"keyword\">in</span> Go duration format https://golang.org/pkg/time/<span class=\"comment\">#ParseDuration (default: 30s) [$RELEASE_CLI_TIMEOUT]</span></span><br><span class=\"line\">--private-token value  Private token used <span class=\"keyword\">for</span> authenticating with the GitLab Releases API, requires api scope https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html, overrides job-token [<span class=\"variable\">$GITLAB_PRIVATE_TOKEN</span>]</span><br><span class=\"line\">--<span class=\"built_in\">help</span>, -h             Show <span class=\"built_in\">help</span> (default: <span class=\"literal\">false</span>)</span><br><span class=\"line\">--version, -v          Print the version (default: <span class=\"literal\">false</span>)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>基本命令 - COMMANDS</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create: Create a Release using GitLab Releases API https://docs.gitlab.com/ee/api/releases/<span class=\"comment\">#create-a-release</span></span><br><span class=\"line\">USAGE:</span><br><span class=\"line\">  <span class=\"built_in\">help</span> create [<span class=\"built_in\">command</span> options] [arguments...]</span><br><span class=\"line\">OPTIONS:</span><br><span class=\"line\">  --name value               <span class=\"comment\"># 发布名称例如 app_Version-1.14</span></span><br><span class=\"line\">  --description value        <span class=\"comment\"># 用来读取描述内容的文件，必须存在于工作目录内;如果它包含任何空格，它将被视为字符串</span></span><br><span class=\"line\">  --tag-name value           <span class=\"comment\"># 发布版本将从中创建的标记[$CI_COMMIT_TAG] 例如v1.14</span></span><br><span class=\"line\">  --ref value                <span class=\"comment\"># 它可以是一个提交SHA、另一个标记名或一个分支名 [$CI_COMMIT_SHA]</span></span><br><span class=\"line\">  --assets-links-name value  <span class=\"comment\"># DEPRECATED</span></span><br><span class=\"line\">  --assets-links-url value   <span class=\"comment\"># DEPRECATEDe.g. --assets-links-name \"asset 1\" --assets-links-url \"https://example.com/url/1\" --assets-links-name \"asset 2\" --assets-links-url \"https://example.com/url/2\")</span></span><br><span class=\"line\">  --assets-link value        <span class=\"comment\"># JSON字符串表示的资产链接用于替代--assets-links-name/url ( e.g. --assets-link='&#123;\"name\": \"Asset1\", \"url\":\"https://&lt;domain&gt;/some/location/1\", \"type\": \"other\", \"filepath\": \"xzy\" &#125;'</span></span><br><span class=\"line\">  --milestone value          <span class=\"comment\"># 与发行版相关的每个里程碑的标题列表 (里程碑必须存在)</span></span><br><span class=\"line\">  --released-at value        <span class=\"comment\"># 他标明了发行的日期;默认为当前时间;期望ISO 8601格式 (2019-03-15T08:00:00Z)</span></span><br><span class=\"line\">  --<span class=\"built_in\">help</span>, -h                 Show <span class=\"built_in\">help</span> (default: <span class=\"literal\">false</span>)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>简单示例 - Example</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.命令行发布</span></span><br><span class=\"line\">release-cli --server-url https://gitlab.com --job-token=SOME_JOB_TOKEN --project-id 12345 create <span class=\"built_in\">help</span></span><br><span class=\"line\">release-cli --server-url https://gitlab.mydomain.com --private-token <span class=\"string\">\"my-private-token\"</span> create --name <span class=\"string\">\"My Release\"</span> --description <span class=\"string\">\"This is a new release for my amazing tool\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.Gitlab-CI 发布</span></span><br><span class=\"line\">release-branch:</span><br><span class=\"line\">  stage: release</span><br><span class=\"line\">  image: registry.gitlab.com/gitlab-org/release-cli</span><br><span class=\"line\">  when: manual</span><br><span class=\"line\">  <span class=\"comment\"># We recommend the use of `rules` to prevent these pipelines</span></span><br><span class=\"line\">  <span class=\"comment\"># from running. See the notes section below for details.</span></span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    - <span class=\"keyword\">if</span>: <span class=\"variable\">$CI_COMMIT_TAG</span></span><br><span class=\"line\">      when: never</span><br><span class=\"line\">  script:</span><br><span class=\"line\">    - &gt;</span><br><span class=\"line\">      release-cli create --name release-branch-<span class=\"variable\">$CI_JOB_ID</span> --description release-branch-<span class=\"variable\">$CI_COMMIT_REF_NAME</span>-<span class=\"variable\">$CI_JOB_ID</span></span><br><span class=\"line\">      --tag-name job-<span class=\"variable\">$CI_JOB_ID</span> --ref <span class=\"variable\">$CI_COMMIT_SHA</span></span><br><span class=\"line\">      --assets-link <span class=\"string\">'&#123;\"name\":\"Asset1\",\"url\":\"https://&lt;domain&gt;/some/location/1\",\"link_type\":\"other\",\"filepath\":\"xzy\"&#125;'</span></span><br><span class=\"line\">      --assets-link <span class=\"string\">'&#123;\"name\":\"Asset2\",\"url\":\"https://&lt;domain&gt;/some/location/2\"&#125;'</span></span><br><span class=\"line\">      --milestone <span class=\"string\">\"v1.0.0\"</span> --milestone <span class=\"string\">\"v1.0.0-rc\"</span></span><br><span class=\"line\">      --released-at <span class=\"string\">\"2020-06-30T07:00:00Z\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 综合实践</span></span><br><span class=\"line\">$ release-cli create \\ </span><br><span class=\"line\">  --name <span class=\"string\">\"Release <span class=\"variable\">$CI_COMMIT_TAG</span>\"</span> \\</span><br><span class=\"line\">  --description <span class=\"string\">\"Notes: <span class=\"variable\">$EXTRA_DESCRIPTION</span>\"</span> \\</span><br><span class=\"line\">  --tag-name <span class=\"variable\">$CI_COMMIT_TAG</span> --ref <span class=\"variable\">$CI_COMMIT_SHA</span> \\</span><br><span class=\"line\">  --assets-link <span class=\"string\">'&#123;\"name\":\"Asset1\",\"url\":\"https://&lt;domain&gt;/some/location/1\",\"link_type\":\"other\",\"filepath\":\"xzy\"&#125;'</span> \\</span><br><span class=\"line\">  --assets-link <span class=\"string\">'&#123;\"name\":\"Asset2\",\"url\":\"https://&lt;domain&gt;/some/location/2\"&#125;'</span> --milestone <span class=\"string\">\"m1\"</span> --milestone <span class=\"string\">\"m2\"</span> --released-at <span class=\"string\">\"2020-08-20T6:42:00Z\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>基础实例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 描述信息</span></span><br><span class=\"line\">~ $ release-cli --server-url http://gitlab.weiyigeek.top --private-token <span class=\"string\">\"fYyHzos-zEPPP8PDsxLa\"</span>  --project-id 45 create create --name <span class=\"string\">\"My Release\"</span> --description <span class=\"string\">\"This is a new release for my amazing tool\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 指定版本</span></span><br><span class=\"line\">~ $ release-cli --server-url http://gitlab.weiyigeek.top --private-token <span class=\"string\">\"fYyHzos-zEPPP8PDsxLa\"</span>  --project-id 45 create --tag-name <span class=\"string\">\"v1.15\"</span> --name <span class=\"string\">\"My Release\"</span> --description <span class=\"string\">\"This is a new release for my amazing tool\"</span></span><br><span class=\"line\"><span class=\"comment\"># INFO[0000] Creating Release...  </span></span><br><span class=\"line\"><span class=\"comment\"># cli=release-cli command=create name=\"My Release\" project-id=45 ref= server-url=\"http://gitlab.weiyigeek.top\" tag-name=v1.15 version=0.6.0</span></span><br><span class=\"line\"><span class=\"comment\"># Tag: v1.15</span></span><br><span class=\"line\"><span class=\"comment\"># Name: My Release</span></span><br><span class=\"line\"><span class=\"comment\"># Description: This is a new release for my amazing tool</span></span><br><span class=\"line\"><span class=\"comment\"># Created At: 2021-02-10 14:52:17.08 +0800 CST</span></span><br><span class=\"line\"><span class=\"comment\"># Released At: 2021-02-10 14:52:17.08 +0800 CST</span></span><br><span class=\"line\"><span class=\"comment\"># See all available releases here: /-/releases</span></span><br><span class=\"line\"><span class=\"comment\"># INFO[0001] release created successfully!  </span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># （3）指定RELEASE的外部URL</span></span><br><span class=\"line\">~ $ release-cli --server-url http://gitlab.weiyigeek.top --private-token <span class=\"string\">\"fYyHzos-zEPPP8PDsxLa\"</span>  --project-id 45 create --tag-name <span class=\"string\">\"v1.14\"</span> --name <span class=\"string\">\"v1.15\"</span> --description <span class=\"string\">\"This is a new release for my amazing tool\"</span> --assets-link <span class=\"string\">'&#123;\"name\":</span></span><br><span class=\"line\"><span class=\"string\">\"info-student-rebuid\",\"url\":\"http://192.168.12.107:30001/job/HelloWorld/19/artifact/target/info-student-rebuild-0.0.2-SNAPSHOT.jar\",\"link_type\":\"other\",\"filepath\":\"/binaries/linux-amd64\"&#125;'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># INFO[0000] Creating Release... </span></span><br><span class=\"line\"><span class=\"comment\"># cli=release-cli command=create name=v1.15 project-id=45 ref= server-url=\"http://gitlab.weiyigeek.top\" tag-name=v1.14 version=0.6.0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Tag: v1.14</span></span><br><span class=\"line\"><span class=\"comment\"># Name: v1.15</span></span><br><span class=\"line\"><span class=\"comment\"># Description: This is a new release for my amazing tool</span></span><br><span class=\"line\"><span class=\"comment\"># Created At: 2021-02-10 14:57:07.358 +0800 CST</span></span><br><span class=\"line\"><span class=\"comment\"># Released At: 2021-02-10 14:57:07.358 +0800 CST</span></span><br><span class=\"line\"><span class=\"comment\"># Asset::Link::Name: info-student-rebuid</span></span><br><span class=\"line\"><span class=\"comment\"># Asset::Link::URL: http://192.168.12.107:30001/job/HelloWorld/19/artifact/target/info-student-rebuild-0.0.2-SNAPSHOT.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># See all available releases here: /-/releases</span></span><br><span class=\"line\"><span class=\"comment\"># INFO[0002] release created successfully!  </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 指定RELEASE的多个外部URL</span></span><br><span class=\"line\">~ $ /usr/<span class=\"built_in\">local</span>/bin/release-cli --server-url http://gitlab.weiyigeek.top --private-token <span class=\"string\">\"fYyHzos-zEPPP8PDsxLa\"</span>  --project-id 45 create --tag-name <span class=\"string\">\"v1.12\"</span> --name <span class=\"string\">\"v1.12\"</span> --description <span class=\"string\">\"This is a new release for my amazing tool\"</span> --assets-link <span class=\"string\">'&#123;\"name\":</span></span><br><span class=\"line\"><span class=\"string\">\"info-student-rebuid\",\"url\":\"http://192.168.12.107:30001/job/HelloWorld/19/artifact/target/info-student-rebuild-0.0.2-SNAPSHOT.jar\",\"link_type\":\"other\"&#125;'</span> --assets-link <span class=\"string\">'&#123;\"name\":\"Asset2\",\"url\":\"http://192.168.12.107:30001/job/HelloWor</span></span><br><span class=\"line\"><span class=\"string\">ld/19/artifact/target/info-student-rebuild-0.0.1-SNAPSHOT.jar\"&#125;'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># INFO[0000] Creating Release</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Tag: v1.12</span></span><br><span class=\"line\"><span class=\"comment\"># Name: v1.12</span></span><br><span class=\"line\"><span class=\"comment\"># Description: This is a new release for my amazing tool</span></span><br><span class=\"line\"><span class=\"comment\"># Created At: 2021-02-10 15:06:23.059 +0800 CST</span></span><br><span class=\"line\"><span class=\"comment\"># Released At: 2021-02-10 15:06:23.059 +0800 CST</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Asset::Link::Name: Asset2</span></span><br><span class=\"line\"><span class=\"comment\"># Asset::Link::URL: http://192.168.12.107:30001/job/HelloWorld/19/artifact/target/info-student-rebuild-0.0.1-SNAPSHOT.jar</span></span><br><span class=\"line\"><span class=\"comment\"># Asset::Link::Name: info-student-rebuid</span></span><br><span class=\"line\"><span class=\"comment\"># Asset::Link::URL: http://192.168.12.107:30001/job/HelloWorld/19/artifact/target/info-student-rebuild-0.0.2-SNAPSHOT.jar</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># See all available releases here: /-/releases</span></span><br><span class=\"line\"><span class=\"comment\"># INFO[0002] release created successfully!                 </span></span><br><span class=\"line\"><span class=\"comment\"># cli=release-cli command=create name=v1.12 project-id=45 ref= server-url=\"http://gitlab.weiyigeek.top\" tag-name=v1.12 version=0.6.0</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>补充说明:</strong></p>\n<ul>\n<li><p>1) 发布的版本列表按released_at排序。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -s --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases\"</span> | jq .[].tag_name</span><br><span class=\"line\"><span class=\"string\">\"v1.12\"</span></span><br><span class=\"line\"><span class=\"string\">\"v1.14\"</span></span><br><span class=\"line\"><span class=\"string\">\"v1.15\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  验证发布版本的 evidence (释放) </span></span><br><span class=\"line\"><span class=\"comment\">#  Create Evidence for an existing Release. </span></span><br><span class=\"line\">$ curl -s --request POST  --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases/v1.12/evidence\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2) 查看发布的指定版本的release的信息</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -s --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases/v1.12\"</span> | jq <span class=\"string\">'.assets.links[] | select (.id == 5 or .id == 4) | .url'</span></span><br><span class=\"line\"><span class=\"string\">\"http://192.168.12.107:30001/job/HelloWorld/19/artifact/target/info-student-rebuild-0.0.1-SNAPSHOT.jar\"</span></span><br><span class=\"line\"><span class=\"string\">\"http://192.168.12.107:30001/job/HelloWorld/19/artifact/target/info-student-rebuild-0.0.2-SNAPSHOT.jar\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li><p>3) 利用http请求创建一个版本。<br>描述: 创建发布需要开发人员对项目的访问。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl --header <span class=\"string\">'Content-Type: application/json'</span> --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> \\</span><br><span class=\"line\">  --data <span class=\"string\">'&#123; \"name\": \"New release\", \"tag_name\": \"v1.13\", \"description\": \"Super nice release\", \"milestones\": [\"v1.13\", \"v1.13-rc\"], \"assets\": &#123; \"links\": [&#123; \"name\": \"hoge\", \"url\": \"https://google.com\", \"filepath\": \"/binaries/linux-amd64\", \"link_type\":\"other\" &#125;] &#125; &#125;'</span> \\</span><br><span class=\"line\">  --request POST <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>4) 更新已发布的 release 版本 (基础信息)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改前</span></span><br><span class=\"line\">$ curl -s --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases/v1.12\"</span> | jq .<span class=\"string\">\"description\"</span></span><br><span class=\"line\"><span class=\"string\">\"This is a new release for my amazing tool\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">$  curl -s --header <span class=\"string\">'Content-Type: application/json'</span> --request PUT --data <span class=\"string\">'&#123;\"name\": \"Release - v1.12\", \"description\": \"更新测试\", \"milestones\": [\"v1.12\"]&#125;'</span> --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases/v1.12\"</span> | jq .</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"Release - v1.12\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"tag_name\"</span>: <span class=\"string\">\"v1.12\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"description\"</span>: <span class=\"string\">\"更新测试\"</span>,</span><br><span class=\"line\">....</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改后</span></span><br><span class=\"line\">~$ curl -s --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases/v1.12\"</span> | jq .<span class=\"string\">\"description\"</span></span><br><span class=\"line\"><span class=\"string\">\"更新测试\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>5) 删除一个发布的版本。<br>描述: 删除一个版本并不会删除相关的标签, 注意删除一个版本需要<code>对项目的维护者级别的访问</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ curl --request DELETE --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases/v1.12\"</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"name\"</span>:<span class=\"string\">\"Release - v1.12\"</span>,<span class=\"string\">\"tag_name\"</span>:<span class=\"string\">\"v1.12\"</span>,<span class=\"string\">\"description\"</span>:<span class=\"string\">\"更新测试\"</span>,<span class=\"string\">\"description_html\"</span>:<span class=\"string\">\"\\u003cp data-sourcepos=\\\"1:1-1:12\\\" dir=\\\"auto\\\"\\u003e更新测试\\u003c/p\\u003e\"</span>,<span class=\"string\">\"created_at\"</span>:<span class=\"string\">\"2021-02-10T15:06:23.059+08:00\"</span>,<span class=\"string\">\"released_at\"</span>:<span class=\"string\">\"2021-02-10T15:06:23.059+08:00\"</span>,<span class=\"string\">\"author\"</span>:&#123;<span class=\"string\">\"id\"</span>:11,<span class=\"string\">\"name\"</span>:<span class=\"string\">\"weiyigeek\"</span>,<span class=\"string\">\"username\"</span>:<span class=\"string\">\"weiyigeek\"</span>,<span class=\"string\">\"state\"</span>:<span class=\"string\">\"active\"</span>,<span class=\"string\">\"avatar_url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/uploads/-/system/user/avatar/11/avatar.png\"</span>,<span class=\"string\">\"web_url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek\"</span>&#125;,<span class=\"string\">\"commit\"</span>:&#123;<span class=\"string\">\"id\"</span>:<span class=\"string\">\"334c630d2944461ac271a2d92f49496dcf30f443\"</span>,<span class=\"string\">\"short_id\"</span>:<span class=\"string\">\"334c630d\"</span>,<span class=\"string\">\"created_at\"</span>:<span class=\"string\">\"2021-02-02T13:34:45.000+08:00\"</span>,<span class=\"string\">\"parent_ids\"</span>:[<span class=\"string\">\"f1d2cd8126c8f181b66bc562f94ffff0a4460067\"</span>],<span class=\"string\">\"title\"</span>:<span class=\"string\">\"RELEASE v1.12 jenkins\"</span>,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"RELEASE v1.12 jenkins\\n\"</span>,<span class=\"string\">\"author_name\"</span>:<span class=\"string\">\"WeiyiGeek\"</span>,<span class=\"string\">\"author_email\"</span>:<span class=\"string\">\"1564362804@qq.com\"</span>,<span class=\"string\">\"authored_date\"</span>:<span class=\"string\">\"2021-02-02T13:34:45.000+08:00\"</span>,<span class=\"string\">\"committer_name\"</span>:<span class=\"string\">\"WeiyiGeek\"</span>,<span class=\"string\">\"committer_email\"</span>:<span class=\"string\">\"1564362804@qq.com\"</span>,<span class=\"string\">\"committed_date\"</span>:<span class=\"string\">\"2021-02-02T13:34:45.000+08:00\"</span>,<span class=\"string\">\"web_url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/commit/334c630d2944461ac271a2d92f49496dcf30f443\"</span>&#125;,<span class=\"string\">\"upcoming_release\"</span>:<span class=\"literal\">false</span>,<span class=\"string\">\"commit_path\"</span>:<span class=\"string\">\"/weiyigeek/helloworld/-/commit/334c630d2944461ac271a2d92f49496dcf30f443\"</span>,<span class=\"string\">\"tag_path\"</span>:<span class=\"string\">\"/weiyigeek/helloworld/-/tags/v1.12\"</span>,<span class=\"string\">\"assets\"</span>:&#123;<span class=\"string\">\"count\"</span>:4,<span class=\"string\">\"sources\"</span>:[&#123;<span class=\"string\">\"format\"</span>:<span class=\"string\">\"zip\"</span>,<span class=\"string\">\"url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/archive/v1.12/helloworld-v1.12.zip\"</span>&#125;,&#123;<span class=\"string\">\"format\"</span>:<span class=\"string\">\"tar.gz\"</span>,<span class=\"string\">\"url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/archive/v1.12/helloworld-v1.12.tar.gz\"</span>&#125;,&#123;<span class=\"string\">\"format\"</span>:<span class=\"string\">\"tar.bz2\"</span>,<span class=\"string\">\"url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/archive/v1.12/helloworld-v1.12.tar.bz2\"</span>&#125;,&#123;<span class=\"string\">\"format\"</span>:<span class=\"string\">\"tar\"</span>,<span class=\"string\">\"url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/archive/v1.12/helloworld-v1.12.tar\"</span>&#125;],<span class=\"string\">\"links\"</span>:[]&#125;,<span class=\"string\">\"evidences\"</span>:[],<span class=\"string\">\"_links\"</span>:&#123;<span class=\"string\">\"self\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/releases/v1.12\"</span>,<span class=\"string\">\"edit_url\"</span>:<span class=\"string\">\"http://gitlab.weiyigeek.top/weiyigeek/helloworld/-/releases/v1.12/edit\"</span>&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">~$ curl --request DELETE --header <span class=\"string\">\"PRIVATE-TOKEN: fYyHzos-zEPPP8PDsxLa\"</span> <span class=\"string\">\"http://gitlab.weiyigeek.top/api/v4/projects/45/releases/v1.12\"</span></span><br><span class=\"line\">&#123;<span class=\"string\">\"message\"</span>:<span class=\"string\">\"403 Forbidden\"</span>&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x03-基础配置\"><a href=\"#0x03-基础配置\" class=\"headerlink\" title=\"0x03 基础配置\"></a>0x03 基础配置</h2><h3 id=\"Gitlab初始化设置\"><a href=\"#Gitlab初始化设置\" class=\"headerlink\" title=\"Gitlab初始化设置\"></a>Gitlab初始化设置</h3><p><strong>0) 用户主题与语言设置</strong><br>流程:右上角个人头像-&gt;settings-&gt;Preferences-&gt;<code>主题设置|语法高亮主题|自定义语言和区域相关设置</code></p>\n<p><strong>1) 关闭Gravatar头像功能进行网络加速</strong><br>Setting -&gt; Gravatar enabled(展开Expand) -&gt; <code>not Checked Gravatar enabled</code> -&gt; Sava Changes</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415163112.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><strong>2) 用户管理与注册相关设置</strong><br>描述:是否用户自己进行注册以及设置密码策略和注册邮箱域名(白|黑名单)等信息,如果关闭后首页将不显示注册;<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415173638.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<ul>\n<li>创建用户:<code>Admin Area</code>-&gt; User -&gt; New User -&gt; 项目限制(创建得数量默认即可) -&gt;  <code>Can create group</code>(企业内部建议取消) -&gt;  创建用户 (用户邮箱将会收到一份注册邮件)</li>\n<li>模仿用户 impersonate: 可以模仿用户登录，不用退出再登录;<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416112358.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n<p>Q: Gitlab 的用户 、组、项目之间的关系;</p>\n<blockquote>\n<p>1.项目：可分配到组 或者 指定用户<br>2.组: 可与包含指定用户，而拥有该组的用户拥有相同的权限；(推荐创建利用组来配对应的项目设置人员的相应权限)<br>3.用户: 我们的注册人员包括开发者、运维、主管等</p>\n</blockquote>\n<p>组与项目绑定流程:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.先创建组;</span><br><span class=\"line\">2.创建项目并让该项目隶属于该组;</span><br><span class=\"line\">3.创建用户并添加组并分配权限</span><br></pre></td></tr></table></figure></p>\n<p>Q: 如果有新成员需要加入该项目怎么办?</p>\n<blockquote>\n<p>1.先给新成员创建用户组；<br>2.再将成员加入组，此时该用户就能看到对应的项目；<br>3.添加公钥，然后使用<code>git clone</code>测试是否能拉取代码;<br>4.最后更新内容，测试能否进行任务提交;</p>\n</blockquote>\n<p><strong>3) 代码推送提醒功能</strong><br>描述:添加一个项目有代码提交后发邮件给指定的邮箱提醒通知，这个对于代码审核还是有帮助的，至少知道谁什么时候推送新代码了，更新了哪些内容等；</p>\n<p>管理员登陆到gitlab界面 <code>Admin area-&gt; Service Templates -&gt; Emails on push</code>, 勾选Active，Recipients填写本项目更新需要推送知晓的人员，多个用空格或者逗号隔开;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415214715.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><strong>4) 设置ssh shell的端口</strong><br>用于处理Git命令和修改authorized keys列表<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_shell_ssh_port'</span>] = 9022</span><br></pre></td></tr></table></figure></p>\n<p><strong>5) 修改gitlab的仓库(repositories)存放目录</strong><br>描述:安装好后要将仓库(repositories)放在一个大硬盘上，所以需要修改仓库对应的目录。<br>(注：我是先将所以的repositories删除再作以下操作的，还把 <code>/var/opt/gitlab/git-data/repositories/用户名</code> 目录下所有用户名下的文件全删除，目录删的只剩下空文件夹）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#查看磁盘空间大小(可以根据您自己添加的磁盘进行操作)</span></span><br><span class=\"line\"><span class=\"variable\">$df</span> -h</span><br><span class=\"line\">/dev/mapper/cl-home   24G  954M   24G    4% /home</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#新建新仓库目录</span></span><br><span class=\"line\"><span class=\"variable\">$mkdir</span> -p /home/gitlab/git-data</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置gitlab的数据存储位置为/home目录下</span></span><br><span class=\"line\"><span class=\"variable\">$vi</span> /etc/gitlab/gitlab.rb</span><br><span class=\"line\">git_data_dirs(&#123; <span class=\"string\">\"default\"</span> =&gt; &#123; <span class=\"string\">\"path\"</span> =&gt; <span class=\"string\">\"/home/gitlab/git-data\"</span> &#125; &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重新加载配置</span></span><br><span class=\"line\"><span class=\"variable\">$sudo</span> gitlab-ctl reconfigure</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重载后发现我们更改的仓库地址下面有数据存放了</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> /home/gitlab/git-data/</span><br><span class=\"line\">repositories</span><br></pre></td></tr></table></figure></p>\n<p><strong>6) 创建一个开发组</strong><br>在Gitlab登录后的主页面上点击<code>Create a group</code>-&gt;输入相关组信息创建即可；<br>邀请成员加入到组:<code>Members</code>-&gt;<code>Group members</code>-&gt;<code>Invite memeber</code> -&gt; 选择用户加入到刚创建的组以及角色权限；</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416113914.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><strong>7) 项目创建与初始化</strong><br>Gitlab的git地址组成与github是一致(别告诉我您不知道): <code>gitlab地址+用户/群组+自定义名字</code></p>\n<p>Gitlab项目的可见类型有三种级别。</p>\n<ul>\n<li>Private project: 该级别是只有项目拥有者或者已经得到授权的人可以访问该项目，或者这些人是该项目组的成员。</li>\n<li>Internal project: 只要有用户名和密码，<code>可以登陆该项目所在的Gitlab服务器的</code>，均可访问该项目。</li>\n<li>public projects: 只要知道该项目的具体位置就是路径，都可以访问该项目, <code>它们默认的使用的是guest权限</code>。</li>\n</ul>\n<p>比如我们在上面的开发组项目中进行创建项目操作流程如下:<br>1.进入开发组-&gt;New Project-&gt;设置项目名称-&gt;创建项目<br>2.建议添加SSH密钥到Gitlab中免密码推送与拉取<a href=\"mailto:`git@gitlab.weiyigeek.top\">`git@gitlab.weiyigeek.top</a>:newproject/secopsdev.git`:Setting -&gt; SSH;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls ~/.ssh/</span><br><span class=\"line\">id_ed25519  id_ed25519.pub  id_rsa  id_rsa.pub  known_hosts</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416131432.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>3.项目的初始化:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基础设置(前提你需要下载git)</span></span><br><span class=\"line\">git config --global user.name <span class=\"string\">\"WeiyiGeek\"</span></span><br><span class=\"line\">git config --global user.email <span class=\"string\">\"weiyigeek@qq.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建一个新的存储库</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> git@gitlab.weiyigeek.top:newproject/secopsdev.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> secopsdev</span><br><span class=\"line\">touch README.md</span><br><span class=\"line\">git add README.md</span><br><span class=\"line\">git commit -m <span class=\"string\">\"add README\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#推送现有文件夹</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> existing_folder</span><br><span class=\"line\">git init</span><br><span class=\"line\">git remote add origin http://gitlab.weiyigeek.top/newproject/secopsdev.git</span><br><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m <span class=\"string\">\"Initial commit\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#推动现有的Git存储库</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> existing_repo</span><br><span class=\"line\">git remote rename origin old-origin  <span class=\"comment\">#将本地分支改名</span></span><br><span class=\"line\">git remote add origin http://gitlab.weiyigeek.top/newproject/secopsdev.git</span><br></pre></td></tr></table></figure></p>\n<p>4.需要注意默认是无法进行提交的这是由于Master主分支被保护所导致的,如果想直接对主分支进行更改而又不想创建子分支可以采用以下方式，前提是必须采用<code>Maintainers的用户上传Master分支后进行设置</code>;<br>Project -&gt; Settings -&gt; Repository -&gt; Brach (<code>分支权限设置</code>) 或者 删除保护;<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416134004.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><strong>8) 用户项目权限控制</strong><br>权限管理理解：</p>\n<ul>\n<li>(1).新建用户的时候选择一个普通权限和管理员权限之分即可</li>\n<li>(2).建git库的时候可以关联一个组或者一个成员</li>\n<li>(3).添加到组里面的人员可以设定Guest Reporter Developer Master Owner</li>\n<li>(4).不同git库里面的关联同一个成员可以设置不同权限</li>\n<li>(5).不同git库里面的关联同一个组无法设置不同权限</li>\n<li>(6).一个git库只能关联一个组成员</li>\n<li>(7).一个组成员可以被多个git库关联，且权限一样</li>\n<li>(8).一个成员可以被多个git库或组成员关联，且权限可以不一样</li>\n<li>(9).Reporter以上才有下代码权限</li>\n<li>(10).企业权限控制:<ul>\n<li>开发人员：developer权限</li>\n<li>代码审核MDE：master权限</li>\n</ul>\n</li>\n</ul>\n<p>项目组&amp;x项目权限管理:</p>\n<ul>\n<li>Project Name -&gt; Memebers-&gt; 用户成员与<code>Choose a role permission</code> -&gt; 以及失效日期设置<br><a href=\"http://gitlab.com/help/user/permissions#project-members-permissions\" target=\"_blank\" rel=\"noopener\">参考官方文档网站</a>列出了<code>Guest,Reporter,Developer,Maintainer(Master),Owner</code>对应的权限,比如上面我们设置的Dev默认对保护分支是没有push权限的;</li>\n</ul>\n<p><strong>9) 广播信息设置</strong><br>描述: 广播信息会显示给全部用户，可以用于通知用户系统定期维护、近期计划升级等信息，<code>在用户登陆界面以及用户提交代码的时候会有显示</code>。<br>Area Admin -&gt; Messages -&gt; Broadcast Information (设置即可)</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416151412.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br/></p>\n<h3 id=\"Gitlab成员权限说明\"><a href=\"#Gitlab成员权限说明\" class=\"headerlink\" title=\"Gitlab成员权限说明\"></a>Gitlab成员权限说明</h3><p>基础概念: 用户具有不同的能力，具体取决于他们在特定组或项目中的访问级别。如果用户同时在组的项目和项目本身中，则使用最高权限级别。在公共和内部项目中，不会强制实施Guest角色, 所有用户都可以创建问题，发表评论，克隆或下载项目代码。当成员离开团队时，将自动取消分配所有分配的问题和合并请求。</p>\n<p>Tips ：Gitlab用户在组中有五种权限：Guest、Reporter、Developer、<code>Master (在 11.0 版本中已重命名为 Maintainer) - 维护者</code>、Owner</p>\n<p><strong>成员权限说明:</strong></p>\n<ul>\n<li>Guest：可以创建issue、发表评论，不能读写版本库</li>\n<li>Reporter：可以克隆代码，不能提交，QA、PM可以赋予这个权限</li>\n<li>Developer：可以克隆代码、开发、提交、push，RD可以赋予这个权限</li>\n<li>Maintainer：可以创建项目、添加tag、保护分支、添加项目成员、编辑项目，核心RD负责人可以赋予这个权限</li>\n<li>Owner：可以设置项目访问权限 - Visibility Level、删除项目、迁移项目、管理组成员，开发组leader可以赋予这个权限</li>\n<li>Gitlab中的组和项目有三种访问权限：Private、Internal、Public</li>\n</ul>\n<p><strong>项目权限说明:</strong><br>Private：只有组成员才能看到<br>Internal：只要登录的用户就能看到,<code>开源项目和组设置的是Internal</code><br>Public：所有人都能看到</p>\n<p>参考地址: <a href=\"https://docs.gitlab.com/ee/user/permissions.html\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/ee/user/permissions.html</a></p>\n<hr>\n<h2 id=\"0x04-基础使用\"><a href=\"#0x04-基础使用\" class=\"headerlink\" title=\"0x04 基础使用\"></a>0x04 基础使用</h2><h3 id=\"Gitlab添加发信邮箱\"><a href=\"#Gitlab添加发信邮箱\" class=\"headerlink\" title=\"Gitlab添加发信邮箱\"></a>Gitlab添加发信邮箱</h3><p>邮件找回密码:<br>1)因为gitlab一直都在运行着，所以要修改前记录备份一下配置文件；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp /etc/gitlab/gitlab.rb&#123;,.bak&#125;</span><br></pre></td></tr></table></figure><br>2)修改配置文件：/etc/gitlab/gitlab.rb 这里使用公司的企业邮箱来发邮件；</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$egrep</span> -v <span class=\"string\">\"^$|^#\"</span> /etc/gitlab/gitlab.rb </span><br><span class=\"line\">external_url <span class=\"string\">'http://gitlab.weiyigeek.top'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'time_zone'</span>] = <span class=\"string\">'Asia/Shanghai'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_enabled'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_from'</span>] = <span class=\"string\">'public@weiyigeek.top'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_display_name'</span>] = <span class=\"string\">'Gitlab CE'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'gitlab_email_reply_to'</span>] = <span class=\"string\">'gitlab@weiyigeek.top'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_address'</span>] = <span class=\"string\">\"smtp.exmail.qq.com\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_port'</span>] = 465</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_user_name'</span>] = <span class=\"string\">\"public@weiyigeek.top\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_password'</span>] = <span class=\"string\">\"邮箱密码\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_domain'</span>] = <span class=\"string\">\"weiyigeek.top\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_authentication'</span>] = <span class=\"string\">\"login\"</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_enable_starttls_auto'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_tls'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\">user[<span class=\"string\">'git_user_email'</span>] = <span class=\"string\">\"public@weiyigeek.top\"</span></span><br></pre></td></tr></table></figure>\n<p>3)保存修改，更新配置；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#只是把修改过的配置文件信息，刷新到配置文件中</span></span><br><span class=\"line\">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><br>其实上面修改一个配置文件gitlab.rb 它里面的配置会被此命令调用编写成多个配置文件到安装目录下：<code>/var/opt/gitlab/gitlab-rails/etc/</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ls</span> /var/opt/gitlab/gitlab-rails/etc/</span><br><span class=\"line\">database.yml         gitlab_shell_secret      gitlab.yml      resque.yml   smtp_settings.rb <span class=\"comment\">#也可以直接修改</span></span><br><span class=\"line\">gitlab_pages_secret  gitlab_workhorse_secret  rack_attack.rb  secrets.yml  unicorn.rb</span><br></pre></td></tr></table></figure><br>如果直接修改<code>smtp_settings.rb</code>文件就只要重启一下<code>gitlab-ctl restart</code>即可。</p>\n<p>4)控制台查看配置与测试发信<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$gitlab</span>-rails console</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\"> GitLab:       12.9.2 (ac5568eb5d8) FOSS</span><br><span class=\"line\"> GitLab Shell: 12.0.0</span><br><span class=\"line\"> PostgreSQL:   10.12</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">Loading production environment (Rails 6.0.2)</span><br><span class=\"line\"></span><br><span class=\"line\">irb(main):001:0&gt; ActionMailer::Base.delivery_method</span><br><span class=\"line\">=&gt; :smtp</span><br><span class=\"line\"></span><br><span class=\"line\">irb(main):002:0&gt; ActionMailer::Base.smtp_settings</span><br><span class=\"line\">=&gt; &#123;:authentication=&gt;:login, :address=&gt;<span class=\"string\">\"smtp.exmail.qq.com\"</span>, :port=&gt;465, :user_name=&gt;<span class=\"string\">\"public@weiyigeek.top\"</span>, :password=&gt;<span class=\"string\">\"Pa****20\"</span>, :domain=&gt;<span class=\"string\">\"weiyigeek.top\"</span>, :enable_starttls_auto=&gt;<span class=\"literal\">true</span>, :tls=&gt;<span class=\"literal\">true</span>, :ca_file=&gt;<span class=\"string\">\"/opt/gitlab/embedded/ssl/certs/cacert.pem\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">irb(main):003:0&gt; Notify.test_email(<span class=\"string\">'291238737@qq.com'</span>, <span class=\"string\">'GitLab测试邮件'</span>, <span class=\"string\">'GitLab 页面信息'</span>).deliver_now</span><br><span class=\"line\">Notify<span class=\"comment\">#test_email: processed outbound mail in 2.0ms</span></span><br><span class=\"line\">Delivered mail 5e9708455a809_6b023fce629dd99085b8@Developement.mail (1543.7ms)</span><br><span class=\"line\">Date: Wed, 15 Apr 2020 21:12:37 +0800</span><br><span class=\"line\">From: Gitlab CE &lt;public@weiyigeek.top&gt;</span><br><span class=\"line\">Reply-To: Gitlab CE &lt;noreply@gitlab.weiyigeek.top&gt;</span><br></pre></td></tr></table></figure></p>\n<p>完成上面操作后，回到登陆页面，选择Forgot your password? 输入你帐号的邮箱地址即可收到邮件，根据邮件地址修改新密码即可；</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415212316.png\" alt=\"WeiyiGeek.sendemail\" title=\"\" class=\"\">\n                <p>WeiyiGeek.sendemail</p>\n            </figure>\n<p><em>补充说明:</em></p>\n<ul>\n<li>在某些ECS专有网络主机上配置了一个gitlab仓库，因为默认这些专有网络的ECS主机都是禁用了25端口的，所以这个gitlab.rb的配置就有做相应的改变，使用465协议。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#只修改以下两行即可，修改完要更新配置</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_port'</span>] = 25  </span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'smtp_tls'</span>] = <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"Gitlab添加LDAP认证\"><a href=\"#Gitlab添加LDAP认证\" class=\"headerlink\" title=\"Gitlab添加LDAP认证\"></a>Gitlab添加LDAP认证</h3><p>LDAP配置说明:<a href=\"http://gitlab.weiyigeek.top/help/administration/auth/ldap\" target=\"_blank\" rel=\"noopener\">http://gitlab.weiyigeek.top/help/administration/auth/ldap</a></p>\n<p>Step1.修改gitlab配置文件设置连接LDAP服务器参数即DN于bindPass<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/gitlab/gitlab.rb</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'ldap_enabled'</span>] = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># gitlab_rails['prevent_ldap_sign_in'] = false</span></span><br><span class=\"line\"><span class=\"comment\">#! **remember to close this block with 'EOS' below**</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'ldap_servers'</span>] = YAML.load &lt;&lt;-<span class=\"string\">'EOS'</span></span><br><span class=\"line\">   main: <span class=\"comment\"># 'main' is the GitLab 'provider ID' of this LDAP server</span></span><br><span class=\"line\">     label: <span class=\"string\">'LDAP'</span></span><br><span class=\"line\">     host: <span class=\"string\">'10.10.107.245'</span></span><br><span class=\"line\">     port: 389</span><br><span class=\"line\">     timeout: 10</span><br><span class=\"line\">     uid: <span class=\"string\">'uid'</span></span><br><span class=\"line\">     bind_dn: <span class=\"string\">'cn=admin,dc=WeiyiGeek,dc=com,dc=cn'</span></span><br><span class=\"line\">     password: <span class=\"string\">'WeiyiGeek'</span></span><br><span class=\"line\">     encryption: <span class=\"string\">'plain'</span> <span class=\"comment\"># \"start_tls\" or \"simple_tls\" or \"plain\"</span></span><br><span class=\"line\">     verify_certificates: <span class=\"literal\">false</span></span><br><span class=\"line\">     smartcard_auth: <span class=\"literal\">false</span></span><br><span class=\"line\">     active_directory: <span class=\"literal\">true</span></span><br><span class=\"line\">     allow_username_or_email_login: <span class=\"literal\">true</span></span><br><span class=\"line\">     lowercase_usernames: <span class=\"literal\">false</span></span><br><span class=\"line\">     block_auto_created_users: <span class=\"literal\">false</span></span><br><span class=\"line\">     base: <span class=\"string\">'dc=WeiyiGeek,dc=com,dc=cn'</span></span><br><span class=\"line\">     <span class=\"comment\">#user_filter: '(&amp;(objectclass=inetOrgPerson)(memberof=cn=gitlab,ou=Group,dc=WeiyiGeek,dc=com,dc=cn))'</span></span><br><span class=\"line\">     attribute:</span><br><span class=\"line\">       username: [<span class=\"string\">'uid'</span>]</span><br><span class=\"line\">       email: [<span class=\"string\">'mail'</span>]</span><br><span class=\"line\">       name: <span class=\"string\">'cn'</span></span><br><span class=\"line\">       first_name: [<span class=\"string\">'sn'</span>]</span><br><span class=\"line\">EOS</span><br></pre></td></tr></table></figure></p>\n<p>Step2.LDAP建立<code>groupOfUniqueNames属性</code>得用户组以及绑定用户;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dn: cn=gitlab,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">uniqueMember: uid=gituser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\">dn: uid=gituser,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: organizationalPerson</span><br><span class=\"line\">objectClass: person</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">homeDirectory: /home/gituser</span><br><span class=\"line\">userPassword:: e1NTSEF9UGVyM21xc1dJcnV3K1d2bWRiVmVpd3RWZHVVeVN6Tks=</span><br><span class=\"line\">uid: gituser</span><br><span class=\"line\">cn: gituser</span><br><span class=\"line\">uidNumber: 10000</span><br><span class=\"line\">gidNumber: 10000</span><br><span class=\"line\">sn: gituser</span><br><span class=\"line\">mail: gituser@weiyigeek.top</span><br></pre></td></tr></table></figure></p>\n<p>Step3.登陆测试如果LDAP用户不存在或者filter的条目不存在会报错<code>Could not authenticate you from Ldapmain because &quot;Invalid credentials for jenkuser&quot;.</code></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415172031.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>Step4.登陆成功界面如下:</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415172222.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br/></p>\n<h3 id=\"Gitlab备份升级迁移恢复\"><a href=\"#Gitlab备份升级迁移恢复\" class=\"headerlink\" title=\"Gitlab备份升级迁移恢复\"></a>Gitlab备份升级迁移恢复</h3><p>描述：GitLab作为公司项目代码的版本管理系统，数据非常重要所以必须做好备份。</p>\n<p>使用Gitlab 备份恢复与迁移也非常简单. 使用一条命令即可创建完整的Gitlab备份:<code>gitlab-rake gitlab:backup:create</code></p>\n<p>使用以上命令默认会在<code>/var/opt/gitlab/backups</code>目录下创建一个名称类似为<code>1481598919_gitlab_backup.tar</code>的压缩包, 这个压缩包就是Gitlab整个的完整部分, 其中开头的1481598919是备份创建的日期</p>\n<p>Gitlab提供了两种备份:</p>\n<ul>\n<li>本地备份: 采用gitlab-rake gitlab:backup:create</li>\n<li>远程备份: 实际是远程机器连接到gitlab服务器上进行脚本的执行;</li>\n</ul>\n<p>关键性配置文件备份:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/gitlab/gitlab.rb 配置文件须备份</span><br><span class=\"line\">/var/opt/gitlab/nginx/conf nginx配置文件</span><br><span class=\"line\">/etc/postfix/main.cfpostfix 邮件配置备份</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>本地备份</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.GitLab备份的默认目录是 </span></span><br><span class=\"line\">/var/opt/gitlab/backups </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.修改改备份目录</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/gitlab/gitlab.rb</span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'manage_backup_path'</span>] = <span class=\"literal\">false</span>   <span class=\"comment\"># 如不需远程来手动管理备份则设置为false</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'backup_path'</span>] = <span class=\"string\">'/home/backups'</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">'backup_keep_time'</span>] = 604800    <span class=\"comment\"># 备份保留7天 2419200</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.修改配置后重载配置</span></span><br><span class=\"line\"><span class=\"variable\">$gitlab</span>-ctl reconfigure</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.执行备份命令</span></span><br><span class=\"line\"><span class=\"variable\">$gitlab</span>-rake gitlab:backup:create </span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:52 +0800 -- Dumping database ...</span></span><br><span class=\"line\"><span class=\"comment\"># Dumping PostgreSQL database gitlabhq_production ... [DONE]</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- done</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- Dumping repositories ...</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- done</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- Dumping uploads ...</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- done</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- Dumping builds ...</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- done</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- Dumping artifacts ...</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- done</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- Dumping pages ...</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- done</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- Dumping lfs objects ...</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- done</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- Dumping container registry images ...</span></span><br><span class=\"line\"><span class=\"comment\"># 2020-04-16 09:44:53 +0800 -- [DISABLED]</span></span><br><span class=\"line\"><span class=\"comment\"># Creating backup archive: 1587001493_2020_04_16_12.9.2_gitlab_backup.tar ... done</span></span><br><span class=\"line\"><span class=\"comment\"># Uploading backup archive to remote storage  ... skipped</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#5.查看备份文件,压缩包包括GitLab整个的完整部分,大概格式xxxxxxxx_gitlab_backup.tar</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> /var/opt/gitlab/backups</span><br><span class=\"line\">1587001493_2020_04_16_12.9.2_gitlab_backup.tar</span><br></pre></td></tr></table></figure></p>\n<p><strong>补充说明:</strong></p>\n<ul>\n<li>(1) 通过任务计划crontab 实现自动备份<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 每天凌晨两点进行一次自动备份;</span></span><br><span class=\"line\">sudo crontab -e  </span><br><span class=\"line\">0 2 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启服务</span></span><br><span class=\"line\">systemctl restart crond</span><br></pre></td></tr></table></figure></li>\n<li>(2) 值得注意的是由于<code>gitlab.rb and gitlab-secrets.json</code>包含敏感数据，采用上面备份的形式不能将它们进行备份，只能通过<code>手动备份</code>的方式;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data</span><br><span class=\"line\">and are not included <span class=\"keyword\">in</span> this backup. You will need these files to restore a backup.</span><br><span class=\"line\">Please back them up manually.</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>远程备份</strong><br>描述:实际上就是在gitlab服务器上添加备份服务器的pub公钥，然后备份服务器访问Gitlab服务器进行拉取，当然您也可以采用rsync进行备份；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#假设环境如下:</span></span><br><span class=\"line\"><span class=\"comment\">#备份服务器: 192.168.1.2</span></span><br><span class=\"line\"><span class=\"comment\">#GitLab服务器: 192.168.1.250</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#1.备份服务器创建authorized_keys文件</span></span><br><span class=\"line\">mkdir -p /root/.ssh</span><br><span class=\"line\">touch /root/.ssh/authorized_keys </span><br><span class=\"line\">chmod 400 /root/.ssh/authorized_keys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.Gitlab服务器生成rsa公钥并将证书上传到备份服务器（实际环境中建议最小权限用户）</span></span><br><span class=\"line\"><span class=\"variable\">$ssh</span>-keygen -t rsa -C <span class=\"string\">\"gitlab@weiyigeek.top\"</span></span><br><span class=\"line\"><span class=\"comment\"># Enter file in which to save the key (/root/.ssh/id_rsa):  报错路径</span></span><br><span class=\"line\"><span class=\"comment\"># Enter passphrase (empty for no passphrase): 公钥密码</span></span><br><span class=\"line\"><span class=\"comment\"># Enter same passphrase again: 验证密码</span></span><br><span class=\"line\"><span class=\"comment\"># Your public key has been saved in /root/.ssh/id_rsa.pub. #保存路径</span></span><br><span class=\"line\"><span class=\"comment\"># The key fingerprint is:</span></span><br><span class=\"line\"><span class=\"comment\"># SHA256:YahioDs7XZ9No********RS9jWX1NNXo04i4ZHOLY WeiyiGeek@weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\"># The key's randomart image is:</span></span><br><span class=\"line\"><span class=\"comment\"># +---[RSA 2048]----+</span></span><br><span class=\"line\"><span class=\"comment\"># |         .   . ++|</span></span><br><span class=\"line\"><span class=\"comment\"># |       .+ . o o.+|</span></span><br><span class=\"line\"><span class=\"comment\"># |.    o.oo= . +  .|</span></span><br><span class=\"line\"><span class=\"comment\"># |..  ..=.E.+ +    |</span></span><br><span class=\"line\"><span class=\"comment\"># |o o..+ oS= . .   |</span></span><br><span class=\"line\"><span class=\"comment\"># |.=+.+ o . .      |</span></span><br><span class=\"line\"><span class=\"comment\"># |+*.. = +         |</span></span><br><span class=\"line\"><span class=\"comment\"># |oo= o o .        |</span></span><br><span class=\"line\"><span class=\"comment\"># |.o.+             |</span></span><br><span class=\"line\"><span class=\"comment\"># +----[SHA256]-----+</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$ls</span> /root/.ssh/</span><br><span class=\"line\">id_rsa  id_rsa.pub</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$scp</span> /root/.ssh/id_rsa.pub root@192.168.1.2:/root/.ssh/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.备份服务器将id_rsa.pub文件内容追加到authorized_keys 文件中，并且修改authorized_keys文件的权限</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /root/.ssh/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.gitlab备份脚本(主要执行权限呼吁)将备份文件拷贝到服务器端</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> &gt; /home/gitlab/auto_backup_to_remote.sh&lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">DATE=`date +<span class=\"string\">\"%Y_%m_%d\"</span>`</span><br><span class=\"line\">BackupIP=192.168.1.2</span><br><span class=\"line\">BackupUser=root</span><br><span class=\"line\">BackupPATH=/var/opt/gitlab/backups</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#删除本地7天前得备份</span></span><br><span class=\"line\">find <span class=\"variable\">$&#123;BackupPATH&#125;</span> -<span class=\"built_in\">type</span> f -mtime +7 -name <span class=\"string\">'*.tar'</span> -<span class=\"built_in\">exec</span> rm &#123;&#125; \\;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#如果不需要备份文件您也可以备份仓房目录</span></span><br><span class=\"line\">find <span class=\"variable\">$&#123;BackupPATH&#125;</span> -name *<span class=\"variable\">$&#123;DATE&#125;</span>* -<span class=\"built_in\">exec</span> scp -r &#123;&#125; <span class=\"variable\">$&#123;root&#125;</span>@<span class=\"variable\">$&#123;BackupIP&#125;</span>:/tmp/ \\;</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$chmod</span> +x /home/gitlab/auto_backup_to_remote.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#5.添加定时计划(每天凌晨1点执行)，重启crond服务</span></span><br><span class=\"line\">cat &gt;&gt; /etc/crontab &lt;&lt;ENDtop</span><br><span class=\"line\">0 1 * * * /home/gitlab/auto_backup_to_remote.sh</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl restart crond</span><br></pre></td></tr></table></figure></p>\n<p>PS : 在Docker 容器中利用exec命令执行备份命令<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"built_in\">exec</span> -it gitlab-server sh -c <span class=\"string\">\"/opt/gitlab/bin/gitlab-rake gitlab:backup:create\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Gitlab恢复</strong><br>比如:上面我们得备份:<code>/var/opt/gitlab/backups/1587001493_2020_04_16_12.9.2_gitlab_backup.tar</code>;<br>操作流程如下:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#停止相关数据连接服务（保证数据库没有新的连接不会有写数据情况）</span></span><br><span class=\"line\">gitlab-ctl stop unicorn</span><br><span class=\"line\">gitlab-ctl stop sidekiq</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定恢复文件会自动去备份目录找格式`1587001493_2020_04_16_12.9.2`</span></span><br><span class=\"line\"><span class=\"comment\"># 注意不加_gitlab_backup.tar</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /var/opt/gitlab/backups/ &amp;&amp; chmod -R 777 *</span><br><span class=\"line\">gitlab-rake gitlab:backup:restore BACKUP=1587001493_2020_04_16_12.9.2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动Gitlab</span></span><br><span class=\"line\">gitlab-ctl restart</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Gitlab迁移</strong><br>描述: 迁移如同备份与恢复的步骤一样, 只需要将老服务器<code>/var/opt/gitlab/backups目录下的备份文件拷贝到新服务器上的/var/opt/gitlab/backups</code>即可(如果你没修改过默认备份目录的话).</p>\n<p style=\"color:red\"> PS : 但是需要注意的是新服务器上的Gitlab的版本必须与创建备份时的Gitlab版本号相同. 比如新服务器安装的是最新的10.8.3版本的Gitlab那么迁移之前, 最好将老服务器的Gitlab升级为10.8.3，基于最新版本的状态在进行备份。 </p>\n\n<p>关键文件:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/gitlab/gitlab.rb <span class=\"comment\">#gitlab 配置文件须迁移,迁移后需要调整数据存放目录</span></span><br><span class=\"line\">/var/opt/gitlab/nginx/conf <span class=\"comment\">#nginx 配置文件目录须迁移</span></span><br></pre></td></tr></table></figure></p>\n<p>将旧机器上的备份文件同步过来后的操作步骤:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-ctl stop unicorn</span><br><span class=\"line\"><span class=\"comment\"># ok: down: unicorn: 0s, normally up</span></span><br><span class=\"line\">gitlab-ctl stop sidekiq</span><br><span class=\"line\"><span class=\"comment\"># ok: down: sidekiq: 0s, normally up</span></span><br><span class=\"line\">chmod 777 /var/opt/gitlab/backups/1528102291_2018_06_04_10.8.3_gitlab_backup.tar</span><br><span class=\"line\">gitlab-rake gitlab:backup:restore BACKUP=1528102291_2018_06_04_10.8.3</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Gitlab升级</strong><br>1.关闭gitlab服务<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-ctl stop unicorn</span><br><span class=\"line\">gitlab-ctl stop sidekiq</span><br><span class=\"line\">gitlab-ctl stop nginx</span><br></pre></td></tr></table></figure></p>\n<p>2.备份gitlab<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure></p>\n<p>3.下载gitlab的RPM包并进行升级<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//直接安装高版本</span><br><span class=\"line\">yum install gitlab-ce-8.12.13-ce.0.el7.x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">//报错.</span><br><span class=\"line\">Error executing action `run` on resource <span class=\"string\">'ruby_block[directory resource: /var/opt/gitlab/git-data/repositories]'</span></span><br><span class=\"line\"></span><br><span class=\"line\">//解决方法:</span><br><span class=\"line\">chmod 2770 /var/opt/gitlab/git-data/repositories</span><br></pre></td></tr></table></figure></p>\n<p>4.启动并查看gitlab版本信息<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-ctl reconfigure</span><br><span class=\"line\">gitlab-ctl restart</span><br><span class=\"line\">head -1 /opt/gitlab/version-manifest.txt</span><br><span class=\"line\">gitlab-ce 10.8.3</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"Gitlab更改默认Nginx\"><a href=\"#Gitlab更改默认Nginx\" class=\"headerlink\" title=\"Gitlab更改默认Nginx\"></a>Gitlab更改默认Nginx</h3><p>描述: 更换gitlab自带Nginx, 使用自行安装的Nginx来管理gitlab服务。</p>\n<p>1.编辑gitlab配置文件禁用自带Nignx服务器<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/gitlab/gitlab.rb</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"comment\">#设置nginx为false,关闭自带Nginx</span></span><br><span class=\"line\">nginx[<span class=\"string\">'enable'</span>] = <span class=\"literal\">false</span></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure></p>\n<p>2.检查默认nginx配置文件，并迁移至新Nginx服务<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/var/opt/gitlab/nginx/conf/nginx.conf          <span class=\"comment\">#nginx配置文件,包含gitlab-http.conf文件</span></span><br><span class=\"line\">/var/opt/gitlab/nginx/conf/gitlab-http.conf    <span class=\"comment\">#gitlab核心nginx配置文件</span></span><br></pre></td></tr></table></figure></p>\n<p>3.重启nginx、gitlab服务<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@gitlab-ce ~]<span class=\"comment\"># gitlab-ctl reconfigure</span></span><br><span class=\"line\">[root@gitlab-ce ~]<span class=\"comment\"># systemctl start nginx</span></span><br></pre></td></tr></table></figure></p>\n<p>异常解决: 访问报 502 原因是nginx用户无法访问 gitlab 用户的socket文件,此时需要重启gitlab并需要重新授权<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod -R o+x /var/opt/gitlab/gitlab-rails</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x05-入坑解决\"><a href=\"#0x05-入坑解决\" class=\"headerlink\" title=\"0x05 入坑解决\"></a>0x05 入坑解决</h2><p><strong>(0) 用户pull与push代码到gitlab常见错误</strong></p>\n<ul>\n<li>错误1:<code>The requested URL returned error: 403</code><ul>\n<li>原因:表示我们没有权限来pull/push相关代码需要修改相关gitlab账号的权限为<code>Development或者Maintianer</code>;</li>\n</ul>\n</li>\n<li>错误2:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">To gitlab.weiyigeek.top:newproject/secopsdev.git</span><br><span class=\"line\"> ! [remote rejected] master -&gt; master (pre-receive hook declined)</span><br><span class=\"line\">error: failed to push some refs to <span class=\"string\">'git@gitlab.weiyigeek.top:newproject/secopsdev.git'</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>原因:由于上传代码的gitlab用户权限为开发者而默认创建的是私有的项目，默认是对master分支开启了保护机制，需要对其项目的Branch分支设置 <code>Allowed to merge | Allowed to push</code>为Development+Maintiner;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#最终主分支以及dev分支都测试上次成功</span></span><br><span class=\"line\">remote:</span><br><span class=\"line\">To gitlab.weiyigeek.top:newproject/secopsdev.git</span><br><span class=\"line\"> * [new branch]      dev -&gt; dev</span><br><span class=\"line\">Branch <span class=\"string\">'dev'</span> <span class=\"built_in\">set</span> up to track remote branch <span class=\"string\">'dev'</span> from <span class=\"string\">'origin'</span>.</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>(1) gitlab密码忘记找回重置方法</strong></p>\n<ul>\n<li><p>方式1:通过gitlab-rails进行重置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$gitlab</span>-rails console </span><br><span class=\"line\">Loading production environment (Rails 6.0.2)</span><br><span class=\"line\">&gt; u=User.where(id:1).first        <span class=\"comment\">#这个是管理员的，也可以用email等</span></span><br><span class=\"line\">&gt; u.password = <span class=\"string\">'your_password'</span>    <span class=\"comment\">#密码有格式限制，我只知道8位以上否则会保存失败</span></span><br><span class=\"line\">&gt; u.password_confirmation = <span class=\"string\">'your_password'</span></span><br><span class=\"line\">&gt; u.save</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>方式2:通过初始化设置邮件进行找回管理员或者在本地 postfix 中查看未发送得邮件，此处以root用户的<a href=\"mailto:admin@example.com\">admin@example.com</a>为例，一般默认都没改(只是一种方式实际中没多大意义);</p>\n</li>\n</ul>\n<p>此处假设服务不能链接到外网之中(为了复现下列操作);<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#（1）查看无法发送出去的邮件队列</span></span><br><span class=\"line\"><span class=\"variable\">$postqueue</span> -p</span><br><span class=\"line\">-Queue ID-  --Size-- ----Arrival Time---- -Sender/Recipient-------</span><br><span class=\"line\"><span class=\"comment\">#因为不存在此地址就无法发送出去，只能停留在邮件的列队中。</span></span><br><span class=\"line\">908DCCAC62     6871 Wed Apr 15 19:54:32  gitlab@gitlab.weiyigeek.top <span class=\"comment\">#(实际就是我们找回密码邮件)</span></span><br><span class=\"line\">(Host or domain name not found. Name service error <span class=\"keyword\">for</span> name=example.com <span class=\"built_in\">type</span>=MX: Host not found, try again)</span><br><span class=\"line\">admin@example.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#（2）邮件队列存储位置</span></span><br><span class=\"line\"><span class=\"variable\">$postconf</span> -d | grep queue_directory  <span class=\"comment\">#默认情况下是没有修改的</span></span><br><span class=\"line\">queue_directory = /var/spool/postfix</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#（3）进到目录下，查找上面那封邮件的队列ID号</span></span><br><span class=\"line\"><span class=\"variable\">$find</span> /var/spool/postfix/ -name 908DCCAC62</span><br><span class=\"line\">/var/spool/postfix/defer/9/908DCCAC62</span><br><span class=\"line\">/var/spool/postfix/deferred/9/908DCCAC62</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 利用postfix自带的工具查看邮件的内容，找到修改密码的地</span></span><br><span class=\"line\"><span class=\"variable\">$postcat</span> /var/spool/postfix/deferred/9/908DCCAC62</span><br><span class=\"line\">*** ENVELOPE RECORDS /var/spool/postfix/deferred/9/908DCCAC62 ***</span><br><span class=\"line\">message_size:            6871             274               1               0            6871               0</span><br><span class=\"line\">message_arrival_time: Wed Apr 15 19:54:32 2020</span><br><span class=\"line\">create_time: Wed Apr 15 19:54:32 2020</span><br><span class=\"line\">named_attribute: rewrite_context=<span class=\"built_in\">local</span></span><br><span class=\"line\">sender: gitlab@gitlab.weiyigeek.top</span><br><span class=\"line\">named_attribute: dsn_orig_rcpt=rfc822;admin@example.com</span><br><span class=\"line\">original_recipient: admin@example.com</span><br><span class=\"line\">.....</span><br><span class=\"line\">If you did not perform this request, you can safely ignore this email.</span><br><span class=\"line\">Otherwise, click the link below to complete the process:</span><br><span class=\"line\"><span class=\"comment\">#找到如下密码修改连接，并将其复制出来到浏览器中重置密码</span></span><br><span class=\"line\">http://gitlab.weiyigeek.top/users/password/edit?reset_password_token=gd9MyL7FaSt5R2F3_qA_</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415201032.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br/></p>\n<p><strong>(2)GitLab数据库引起的502错误问题及解决方案</strong><br>描述:打开GitLab的主页地址http:/gitlab.weiyigeek.top/报错502,重启或检查状态发现都正常<code>sudo gitlab-ctl status</code>,并且检查了端口号并没被占用,检查刷新配置<code>gitlab-ctl reconfigure</code>发现了错误;</p>\n<p>错误信息如下：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#gitlab-ctl reconfigure </span></span><br><span class=\"line\">Running handlers:</span><br><span class=\"line\">There was an error running gitlab-ctl reconfigure:</span><br><span class=\"line\"></span><br><span class=\"line\">bash[migrate gitlab-rails database] (gitlab::database_migrations line 51) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to <span class=\"built_in\">exit</span> with [0], but received <span class=\"string\">'1'</span></span><br><span class=\"line\">---- Begin output of <span class=\"string\">\"bash\"</span>  <span class=\"string\">\"/tmp/chef-script20190308-65247-12ck9rp\"</span> ----</span><br><span class=\"line\">STDOUT: rake aborted!</span><br><span class=\"line\">PG::ConnectionBad: could not connect to server: No such file or directory</span><br><span class=\"line\"> Is the server running locally and accepting</span><br><span class=\"line\"> connections on Unix domain socket <span class=\"string\">\"/var/opt/gitlab/postgresql/.s.PGSQL.5432\"</span>?</span><br><span class=\"line\">/opt/gitlab/embedded/service/gitlab-rails/lib/tasks/gitlab/db.rake:52:<span class=\"keyword\">in</span> `block (3 levels) <span class=\"keyword\">in</span> &lt;top (required)&gt;</span><br><span class=\"line\">/opt/gitlab/embedded/bin/bundle:23:<span class=\"keyword\">in</span> `load<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">/opt/gitlab/embedded/bin/bundle:23:in `&lt;main&gt;'</span></span><br><span class=\"line\">Tasks: TOP =&gt; gitlab:db:configure</span><br><span class=\"line\">(See full trace by running task with --trace)</span><br><span class=\"line\">STDERR:</span><br><span class=\"line\">---- End output of <span class=\"string\">\"bash\"</span>  <span class=\"string\">\"/tmp/chef-script20190308-65247-12ck9rp\"</span> ----</span><br><span class=\"line\">Ran <span class=\"string\">\"bash\"</span>  <span class=\"string\">\"/tmp/chef-script20190308-65247-12ck9rp\"</span> returned 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gitlab-ctl tail</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200415221141.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<p><strong>(3) gitlab-ce版本升级记录</strong><br>我们为了保证数据安全，一步步来慢慢升级,使用官方的源可能比较慢，可以使用国内的源（采用Omnibus方式进行升级直接rpm包部署）：<a href=\"https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum\" target=\"_blank\" rel=\"noopener\">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum</a> </p>\n<p>升级方法：先升级到当前大版本最后一版(这里是我的建议，一般差不多最后几版就可以了)，接下来就是跨大版本的升级，先从大版本的低版升级，再到最后版本升级，以此类推； 因为我中间尝试过直接跨太多个版本升级，出现过异常，其实主要是数据库的数据导入备份问题，如果新版本跟旧版相关太大的话就会报错了。</p>\n<p>比如我的升级过程很长，同时也做了简单的测试<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#升级版本</span></span><br><span class=\"line\">8.3.1--&gt;8.3.7--&gt;8.8.5--&gt;8.17.4--&gt;9.5.6--&gt;10.0.6--&gt;10.8.5--&gt;11.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#停止服务</span></span><br><span class=\"line\">gitlab-ctl stop unicorn</span><br><span class=\"line\">gitlab-ctl stop sidekiq</span><br><span class=\"line\">gitlab-ctl stop nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建数据备份，防止更新失败(非常重要)</span></span><br><span class=\"line\">gitlab-rake gitlab:backup:create</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装升级包</span></span><br><span class=\"line\"><span class=\"comment\">#yum update gitlab-ce # 升级GitLab-ce 版本(不建议采用此种方式)</span></span><br><span class=\"line\">rpm -Uvh gitlab-7.4.2_omnibus-1.el6.x86_64.rpm </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重新加载配置&amp;重启Gitlab服务</span></span><br><span class=\"line\">gitlab-ctl reconfigure</span><br><span class=\"line\">gitlab-ctl restart</span><br></pre></td></tr></table></figure><br>比如：项目备份的数据的是否有异常，用户信息，响应速度等等，个人认为还是比较靠普的。</p>\n<p>其实只要我们之前有升级过就不会现在这样了，一下子从这么低的版本升级上来。一般建议保持在相同的大版本号就好了。太新可能也会有Bug，太旧了也会有很多历史遗留的问题。</p>\n<p>升级完成后你会发现多了好几个进程。可能会对系统硬件要求更高了，比如内存会要求更高了。<br>建议：如果非必要的功能需求，只是简单的要一个代码仓库的话，个人建立使用在<code>11.x.-12.3.x</code>之间也不错了。</p>\n<p><br></p>\n<p><strong>(4) gitlab-rails database初始化失败</strong><br>环境说明<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Centos7: 3.10.0-327.el7.x86_64</span><br><span class=\"line\">gitlab版本：原来是8.8.5版本现升级到较新的版本;</span><br></pre></td></tr></table></figure></p>\n<p>问题：在同一台Centos7机器上卸载了旧版本的gitlab后，接着又重新安装新版本的gitlab-ce 在安装完后修改配置，初始化配置时出现以下错误：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Running handlers:</span><br><span class=\"line\">There was an error running gitlab-ctl reconfigure:</span><br><span class=\"line\"></span><br><span class=\"line\">bash[migrate gitlab-rails database] (gitlab::database_migrations line 49) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to <span class=\"built_in\">exit</span> with [0], but received <span class=\"string\">'1'</span></span><br><span class=\"line\">---- Begin output of <span class=\"string\">\"bash\"</span>  <span class=\"string\">\"/tmp/chef-script20190628-7065-vx17en\"</span> ----</span><br><span class=\"line\">STDOUT: rake aborted!</span><br><span class=\"line\">PG::ConnectionBad: could not connect to server: No such file or directory</span><br><span class=\"line\">    Is the server running locally and accepting</span><br><span class=\"line\">    connections on Unix domain socket <span class=\"string\">\"/var/opt/gitlab/postgresql/.s.PGSQL.5432\"</span>?</span><br><span class=\"line\">/opt/gitlab/embedded/service/gitlab-rails/lib/tasks/gitlab/db.rake:49:<span class=\"keyword\">in</span> `block (3 levels) <span class=\"keyword\">in</span> &lt;top (required)&gt;<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">/opt/gitlab/embedded/bin/bundle:23:in `load'</span></span><br><span class=\"line\">/opt/gitlab/embedded/bin/bundle:23:<span class=\"keyword\">in</span> `&lt;main&gt;<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">Tasks: TOP =&gt; gitlab:db:configure</span></span><br><span class=\"line\"><span class=\"string\">(See full trace by running task with --trace)</span></span><br><span class=\"line\"><span class=\"string\">STDERR:</span></span><br><span class=\"line\"><span class=\"string\">---- End output of \"bash\"  \"/tmp/chef-script20190628-7065-vx17en\" ----</span></span><br><span class=\"line\"><span class=\"string\">Ran \"bash\"  \"/tmp/chef-script20190628-7065-vx17en\" returned 1</span></span><br></pre></td></tr></table></figure></p>\n<p>原因:因为在卸载旧版本的时候没有把旧的数据删除，所以直接安装时，程序检测到配置文件，数据文件时就会跳过没有覆盖，新版本使用旧版本的数据文件[因为版本相差太多了]就会无法识别导致。</p>\n<p>解决方法:卸载完旧版本后，记得删除旧的安装数据<code>配置文件，安装目录，数据目录等</code>，重新安装新版的gitlab-ce即可正常启动。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf /var/opt/gitlab/ /opt/gitlab/ /etc/gitlab/</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>(5) Gitlab的数据库postgresql更新帐号信息</strong><br>问题描述:由于内部的Ldap认证服务器硬盘坏掉了，导致在上面跑的Ldap服务无法对Jenkins和Gitlab平台做集中认证了，导致在Gitlab上的帐号无法登陆到平台上，也就无法提交拉取代码了。</p>\n<p><em>解决思路：</em></p>\n<ul>\n<li>方法一、重新配置一个Ldap服务把之前的数据库导进来，迁移到新的机器上然后修改Gitlab的认证服务地址。</li>\n<li>方法二、直接修改Gitlab的数据库，对帐号的认证方式修改。</li>\n</ul>\n<p>此处选择方式2进行操作其流程如下:</p>\n<ul>\n<li>Step1.修改gitlab的数据库配置，开启远程访问(默认本机访问)<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.修改配置文件添加最后两行</span></span><br><span class=\"line\">egrep -v <span class=\"string\">\"^#|^$\"</span> /var/opt/gitlab/postgresql/data/pg_hba.conf</span><br><span class=\"line\"><span class=\"built_in\">local</span>   all         all                               peer map=gitlab</span><br><span class=\"line\">host    all             all             127.0.0.1/32            trust</span><br><span class=\"line\">host    all             all             0.0.0.0/0               trust</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.修改postgresql配置文件将listen_addresses把它改成*号</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /var/opt/gitlab/postgresql/data/postgresql.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#------------------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># CONNECTIONS AND AUTHENTICATION</span></span><br><span class=\"line\"><span class=\"comment\">#------------------------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># - Connection Settings -</span></span><br><span class=\"line\">listen_addresses = <span class=\"string\">'*'</span>    <span class=\"comment\"># what IP address(es) to listen on;</span></span><br><span class=\"line\">          <span class=\"comment\"># comma-separated list of addresses;</span></span><br><span class=\"line\">          <span class=\"comment\"># defaults to 'localhost', '*' = all</span></span><br><span class=\"line\">          <span class=\"comment\"># (change requires restart)</span></span><br><span class=\"line\">port = 5432        <span class=\"comment\"># (change requires restart)</span></span><br><span class=\"line\">max_connections = 200      <span class=\"comment\"># (change requires restart)</span></span><br><span class=\"line\"><span class=\"comment\"># Note:  Increasing max_connections costs ~400 bytes of shared memory per</span></span><br><span class=\"line\"><span class=\"comment\"># connection slot, plus lock space (see max_locks_per_transaction).</span></span><br><span class=\"line\"><span class=\"comment\">#superuser_reserved_connections = 3 # (change requires restart)</span></span><br><span class=\"line\">unix_socket_directories = <span class=\"string\">'/var/opt/gitlab/postgresql'</span>   <span class=\"comment\"># (change requires restart)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.重启postgresql服务</span></span><br><span class=\"line\">gitlab-ctl restart postgresql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.使用Navicat工具连postgresql接数据库，下边的初始数据库gitlabhq_production和用户名都是默认的，密码为空</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>连接上后找到对应的identities表修改对应的字段，其实就是把字段中的user_id修改掉，我这里做法就是把用户的user_id改成了负数，这样在Ldap认证时就找不到了，从而走标准认证（这是在不重启Gitlab的情况下进行）。<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200416162240.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>补充说明:</p>\n<ul>\n<li>更新后如果用户还存在登陆不了的问题，这时候可以让用户自己去Web端登陆gitlab，选择忘记密码，通过忘记密码来重新设置一个密码。(前提是你实现了密码找回功能)</li>\n<li>完成所有操作后记得要把远程的配置注释掉或者删除了，然后重启postgresql服务即可。</li>\n</ul>\n<p><br></p>\n<p><strong>(5) Gitlab 配置中关闭 Promethes / grafana</strong><br>描述: 关闭 Prometheus / Grafana 解决的问题当主机内存较小时可以将其关闭，但是现在服务器内存一般都是够用的;<br>配置关键项: /etc/gitlab/gitlab.rb<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Prometheus</span></span><br><span class=\"line\">prometheus[<span class=\"string\">'enable'</span>] = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\">#  gitlab_monitor['enable'] = false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Grafana</span></span><br><span class=\"line\">grafana[<span class=\"string\">'enable'</span>] = <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure></p>\n<p>PS : 修改配置文件后一定要重新初始化Gitlab服务并启动其服务执行 <code>gitlab-ctl reconfigure &amp;&amp; gitlab-ctl start</code> 命令;</p>\n<p><strong>(6) sidekiq_cluster has been deprecated since 13.6 and will be removed in 14.0</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Deprecations:</span><br><span class=\"line\">* sidekiq_cluster[<span class=\"string\">'experimental_queue_selector'</span>] has been deprecated since 13.6 and will be removed <span class=\"keyword\">in</span> 14.0. The experimental_queue_selector option is now called queue_selector.</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x06-补充附录\"><a href=\"#0x06-补充附录\" class=\"headerlink\" title=\"0x06 补充附录\"></a>0x06 补充附录</h2><h3 id=\"安装配置脚本\"><a href=\"#安装配置脚本\" class=\"headerlink\" title=\"安装配置脚本\"></a>安装配置脚本</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#Desc: Gitlab代码服务器自动化部署</span></span><br><span class=\"line\"><span class=\"comment\">#Author:WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\">#SupportOS:CentOS7 / CentOS8</span></span><br><span class=\"line\"></span><br><span class=\"line\">GITLAB_BASEDOMAIN=weiyigeek.top</span><br><span class=\"line\">GITLAB_VERSION=12.9.2</span><br><span class=\"line\">GITlABOS7=gitlab-ce-<span class=\"variable\">$&#123;GITLAB_VERSION&#125;</span>-ce.0.el7.x86_64.rpm</span><br><span class=\"line\">GITlABOS8=gitlab-ce-<span class=\"variable\">$&#123;GITLAB_VERSION&#125;</span>-ce.0.el8.x86_64.rpm</span><br><span class=\"line\"></span><br><span class=\"line\">GITLABRUNNER_VERSION=12.9.0-1</span><br><span class=\"line\">GITLABRUNNER_NAME=gitlab-runner-<span class=\"variable\">$&#123;GITLABRUNNER_VERSION&#125;</span>.x86_64.rpm\t</span><br><span class=\"line\">CheckOSVersion=$(uname -r | grep -c el8)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## [镜像源设置]</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">repoChange</span></span>()&#123;</span><br><span class=\"line\">  mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.$(date +<span class=\"string\">\"%Y%m%d\"</span>).backup</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$CheckOSVersion</span> -eq 1 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"comment\"># CentOS8 源</span></span><br><span class=\"line\">    curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class=\"line\">    <span class=\"comment\"># 安装 epel 配置包并地址替换为阿里云镜像站地址</span></span><br><span class=\"line\">    dnf install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm</span><br><span class=\"line\">    sed -i <span class=\"string\">'s|^#baseurl=https://download.fedoraproject.org/pub|baseurl=https://mirrors.aliyun.com|'</span> /etc/yum.repos.d/epel*</span><br><span class=\"line\">    sed -i <span class=\"string\">'s|^metalink|#metalink|'</span> /etc/yum.repos.d/epel*</span><br><span class=\"line\">    dnf clean all</span><br><span class=\"line\">    dnf makecache</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"comment\"># CentOS7 源</span></span><br><span class=\"line\">    curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class=\"line\">    sed -i -e <span class=\"string\">'/mirrors.cloud.aliyuncs.com/d'</span> -e <span class=\"string\">'/mirrors.aliyuncs.com/d'</span> /etc/yum.repos.d/CentOS-Base.repo</span><br><span class=\"line\">    wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class=\"line\"><span class=\"comment\">#添加信任 GitLab 里的 GPG 公钥</span></span><br><span class=\"line\">sudo cat &gt; /etc/yum.repos.d/gitlab-ce.repo &lt;&lt;EOF</span><br><span class=\"line\">[gitlab-ce]</span><br><span class=\"line\">name=Gitlab CE Repository</span><br><span class=\"line\">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgkey=https://packages.gitlab.com/gpg.key</span><br><span class=\"line\">EOF</span><br><span class=\"line\">  yum clean all</span><br><span class=\"line\">  yum makecache</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[yum 方式安装]</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">yumInstall</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"comment\"># 查看可用的版本neng'b</span></span><br><span class=\"line\">  yum list gitlab-ce --showduplicates</span><br><span class=\"line\">  <span class=\"comment\"># 默认安装最新的版本</span></span><br><span class=\"line\">  yum install -y gitlab-ce</span><br><span class=\"line\">  <span class=\"comment\"># 安装指定版本 12.3.5</span></span><br><span class=\"line\">  <span class=\"comment\"># yum install gitlab-ce-12.3.5-ce.0.el7.x86_64.rpm</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[rpm 方式安装-推荐方式]</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">OmnibusInstall</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$CheckOSVersion</span> -eq 1 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    wget -O <span class=\"variable\">$GITlABOS8</span> https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el8/<span class=\"variable\">$&#123;GITlABOS8&#125;</span></span><br><span class=\"line\">    rpm -i <span class=\"variable\">$GITlABOS8</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    wget -O <span class=\"variable\">$GITlABOS7</span> https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/<span class=\"variable\">$&#123;GITlABOS7&#125;</span></span><br><span class=\"line\">    rpm -i  <span class=\"variable\">$GITlABOS7</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">gitlabSetting</span></span>()&#123;</span><br><span class=\"line\">  sed -i <span class=\"string\">\"s#example.com#<span class=\"variable\">$&#123;GITLAB_BASEDOMAIN&#125;</span>#g\"</span> /etc/gitlab/gitlab.rb</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"127.0.0.1 gitlab.<span class=\"variable\">$&#123;GITLAB_BASEDOMAIN&#125;</span>\"</span> &gt; /etc/hosts</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">useage</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\e[32m# Description: Gitlab 自动化安装部署脚本\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"usage: <span class=\"variable\">$0</span> [rpm|yum] #指定rpm安装还是yum安装\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"Author:WeiyiGeek\\e[0m\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[低于 12.3.x 版本的才进行设置]</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Chinesization</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"comment\">#停止gitlab</span></span><br><span class=\"line\">  gitlab-ctl stop</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#获取当前安装的版本补丁</span></span><br><span class=\"line\">  git <span class=\"built_in\">clone</span> https://gitlab.com/xhang/gitlab.git</span><br><span class=\"line\">  <span class=\"built_in\">cd</span> gitlab</span><br><span class=\"line\">  gitlab_version=$(cat /opt/gitlab/embedded/service/gitlab-rails/VERSION)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 生成对应版本补丁文件</span></span><br><span class=\"line\">  git diff remotes/origin/12-3-stable remotes/origin/12-3-stable-zh &gt; ../<span class=\"variable\">$&#123;gitlab_version&#125;</span>-zh.diff</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 打补丁的时候会提示一些补丁文件不存在，一定要跳过这些文件，不然后面reconfig的时候会报错的。</span></span><br><span class=\"line\">  patch -d /opt/gitlab/embedded/service/gitlab-rails -p1 &lt; ../<span class=\"variable\">$&#123;gitlab_version&#125;</span>-zh.diff</span><br><span class=\"line\">  gitlab-ctl reconfigure</span><br><span class=\"line\">  gitlab-ctl restart</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## [安装配置脚本入口函数]</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">main</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"comment\">#关闭Sellinux</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"当前Selinux: <span class=\"variable\">$(getenforce)</span>\"</span></span><br><span class=\"line\">  setenforce 0</span><br><span class=\"line\">  sed -i <span class=\"string\">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"设置Selinux: <span class=\"variable\">$(getenforce)</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#环境依赖安装</span></span><br><span class=\"line\">  repoChange</span><br><span class=\"line\">  sudo yum install -y curl policycoreutils openssh-server wget postfix git htop ncdu net-tools</span><br><span class=\"line\">  systemctl <span class=\"built_in\">enable</span> postfix</span><br><span class=\"line\">  systemctl start postfix</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#防护墙设置</span></span><br><span class=\"line\">  sudo firewall-cmd --permanent --add-service=http</span><br><span class=\"line\">  sudo firewall-cmd --permanent --add-service=https</span><br><span class=\"line\">  sudo systemctl reload firewalld</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#选择安装方式</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$1</span> == <span class=\"string\">\"rpm\"</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    OmnibusInstall</span><br><span class=\"line\">  <span class=\"keyword\">elif</span> [ <span class=\"variable\">$1</span> == <span class=\"string\">\"yum\"</span> ];<span class=\"keyword\">then</span> </span><br><span class=\"line\">    yumInstall</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    usage</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">  gitlabSetting</span><br><span class=\"line\">  gitlab-ctl reconfigure</span><br><span class=\"line\">  gitlab-ctl start</span><br><span class=\"line\">  gitlab-ctl status</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[参数验证]</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$#</span> -ne 1 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">  usage</span><br><span class=\"line\"><span class=\"keyword\">else</span> </span><br><span class=\"line\">  main <span class=\"variable\">$1</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Git","path":"api/categories/Git.json"},{"name":"代码仓库","path":"api/categories/代码仓库.json"}],"tags":[{"name":"gitlab","path":"api/tags/gitlab.json"}]}