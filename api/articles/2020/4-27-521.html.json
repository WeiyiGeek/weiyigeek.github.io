{"title":"4-Kubernetes入门基础之Pod介绍","slug":"虚拟云容/云容器/Kubernetes/4-Kubernetes入门基础之Pod介绍","date":"2020-04-27T10:37:47.000Z","updated":"2023-01-31T02:29:10.471Z","url":"2020/4-27-521.html","path":"api/articles/2020/4-27-521.html.json","covers":["https://img.weiyigeek.top/2020/2/20201108213611.png","https://img.weiyigeek.top/2021/1/20210120152027.png"],"content":"<p>[toc]</p>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>前面简单的介绍了Kubernetes基础知识以及单节点和高可以用集群的搭建, 本章将从实操来介绍Kubernetes概念和术语以及控制器，便于各位读者进行学习;</p>\n<p><br></p>\n<h2 id=\"0x01-资源清单\"><a href=\"#0x01-资源清单\" class=\"headerlink\" title=\"0x01 资源清单\"></a>0x01 资源清单</h2><p><strong>Q: 什么是资源?</strong></p>\n<blockquote>\n<p>答: K8s中所有的内容都抽象为资源在资源实例化(<code>容器被执行</code>)之后叫做对象;</p>\n</blockquote>\n<p><strong>Q: 什么是Kubernetes对象?</strong></p>\n<blockquote>\n<p>答：Kubernetes对象指的是Kubernetes系统的持久化实体，所有这些对象合起来代表了你集群的实际情况。创建一个k8s对象就是告诉Kubernetes，您需要的集群中的工作负载是什么（集群的目标状态）, 因为一个Kubernetes对象代表着用户的一个意图（a record of intent），一旦您创建了一个Kubernetes对象，Kubernetes将持续工作以尽量实现此用户的意图。</p>\n</blockquote>\n<p>常规的应用里我们把应用程序的数据存储在数据库中，Kubernetes将其数据以Kubernetes对象的形式通过 <code>api server</code> 存储在 etcd 中；<br>Kubernetes对象数据描述的信息:</p>\n<ul>\n<li>集群中运行了哪些容器化应用程序（以及在哪个节点上运行）</li>\n<li>集群中对应用程序可用的资源</li>\n<li>应用程序相关的策略定义，例如，重启策略、升级策略、容错策略</li>\n<li>其他Kubernetes管理应用程序时所需要的信息</li>\n</ul>\n<p><strong>如何进行Kubernetes对象的CURD呢?</strong></p>\n<blockquote>\n<p>答:自带的kubectl命令或者一些管理k8s的图形化界面工具比如Kuboard或者Kubedash;</p>\n</blockquote>\n<p>PS: kubectl、kuboard 最终都通过调用 kubernetes API 来实现对 Kubernetes 对象的操作。您也可以直接在自己的程序中调用 Kubernetes API，此时您可能要有用到 Client Libraries </p>\n<p><br></p>\n<p><strong>基础补充:</strong></p>\n<ul>\n<li><p>1.名称空间级别资源 (Namespace Level): 仅在此名称空间下生效<code>k8s的系统组件是默认放在kube-system名称空间下</code>的，而kubectl get pod等价于kubectl get pod -n default，因此查看不到k8s的系统组件。</p>\n<ul>\n<li><p>工作负载型资源(workload)：Pod、ReplicaSet(调度器控制器通过标签保证Pod的副本数以及创建Pod)、Deployment、StatefulSet(有状态服务的控制器)、DaemonSet(可以在每个节点都运行一个Pod的组件)、Job、CronJob(ReplicationController在v1.11版本被废弃)</p>\n</li>\n<li><p>服务发现及负载均衡型资源(Service Discovery LoadBalance):Service、Ingress、…</p>\n</li>\n<li><p>配置与存储型资源：Volume(存储卷)、CSI(容器存储接口可以扩展各种各样的第三方存储卷)</p>\n</li>\n<li><p>特殊类型的存储卷：ConfigMap(当配置中心来使用的资源类型可以达到热更新)、Secret(保存敏感数据)、DownwardAPI(把外部环境中的信息输出给容器)</p>\n</li>\n</ul>\n</li>\n<li><p>2.集群级资源：不管在任何名称空间下定义，在其他的名称空间下都能看得到，在定义的时候无需指定名称空间</p>\n<ul>\n<li>Namespace、Node、Role、ClusterRole、RoleBinding、ClusterRoleBinding</li>\n</ul>\n</li>\n<li><p>3.元数据型资源：提供一个指标，不像是名称空间类型又不像集群级别，本质上更像是在两者之间，但是它有自己的特点，所以更应该作为一个单独的分类，例如HPA【通过cpu的利用率进行平滑扩展】就是一个很明显的元数据类型，通过指标进行操作。</p>\n<ul>\n<li>HPA、PodTemplate、LimitRange(根据指标进行相对应的操作)</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<p><strong>Q: 什么是资源清单?</strong></p>\n<blockquote>\n<p>答: 您可以将其理解为剧本，里面规定了每一步如何操作，Kubernets只需要按照要求去做即可;<br>在 K8s 中一般使用Yaml格式或者Json格式的文件来创建符合我们预期期望的Pod，该yaml文件我们称为资源清单;</p>\n</blockquote>\n<p><br></p>\n<p><strong>Q: 如何编辑资源清单?</strong></p>\n<blockquote>\n<p>答: 在编写清单时候必须对Kubernetes定义Pod以及控制器(Controller)的常用字段有一定的了解, 如果忘记对象的资源清单字段可以通过explain命令查看相对应的控制清单编写字段;</p>\n</blockquote>\n<p>资源清单编写帮助: 获取资源的apiVersion的版本信息(以pod为例)，该命令同时输出属性设置帮助文档<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl explain pod</span><br><span class=\"line\">  <span class=\"comment\"># KIND:     Pod</span></span><br><span class=\"line\">  <span class=\"comment\"># VERSION:  v1</span></span><br><span class=\"line\">  <span class=\"comment\"># DESCRIPTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tPod is a collection of containers that can run on a host. This resource is</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tcreated by clients and scheduled onto hosts.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># FIELDS: </span></span><br><span class=\"line\">  <span class=\"comment\"># \tapiVersion   &lt;string&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tAPIVersion defines the versioned schema of this representation of an</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tobject. Servers should convert recognized schemas to the latest internal</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tvalue, and may reject unrecognized values. More info:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\thttps://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># \tkind &lt;string&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tKind is a string value representing the REST resource this object</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\trepresents. Servers may infer this from the endpoint the client submits</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\trequests to. Cannot be updated. In CamelCase. More info:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\thttps://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># \tmetadata     &lt;Object&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tStandard object's metadata. More info:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\thttps://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># \tspec &lt;Object&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tSpecification of the desired behavior of the pod. More info:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\thttps://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># \tstatus       &lt;Object&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tMost recently observed status of the pod. This data may not be up to date.</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tPopulated by the system. Read-only. More info:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\thttps://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl explain pod.apiVersion <span class=\"comment\">#查看指定属性说明</span></span><br><span class=\"line\">  <span class=\"comment\"># KIND:     Pod</span></span><br><span class=\"line\">  <span class=\"comment\"># VERSION:  v1</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># FIELD:    apiVersion &lt;string&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># DESCRIPTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tAPIVersion defines the versioned schema of this representation of an</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tobject. Servers should convert recognized schemas to the latest internal</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\tvalue, and may reject unrecognized values. More info:</span></span><br><span class=\"line\">  <span class=\"comment\"># \t\thttps://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br></pre></td></tr></table></figure></p>\n<p>查看k8s中有对象可用那些资源的API版本（1.19.6）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl api-versions</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#常用</span></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\"><span class=\"comment\"># API版本</span></span><br><span class=\"line\">apps/v1</span><br><span class=\"line\">v1</span><br><span class=\"line\">admissionregistration.k8s.io/v1</span><br><span class=\"line\">admissionregistration.k8s.io/v1beta1</span><br><span class=\"line\">apiextensions.k8s.io/v1</span><br><span class=\"line\">apiextensions.k8s.io/v1beta1</span><br><span class=\"line\">apiregistration.k8s.io/v1</span><br><span class=\"line\">apiregistration.k8s.io/v1beta1</span><br><span class=\"line\">authentication.k8s.io/v1</span><br><span class=\"line\">authentication.k8s.io/v1beta1</span><br><span class=\"line\">authorization.k8s.io/v1</span><br><span class=\"line\">authorization.k8s.io/v1beta1</span><br><span class=\"line\">autoscaling/v1</span><br><span class=\"line\">autoscaling/v2beta1</span><br><span class=\"line\">autoscaling/v2beta2</span><br><span class=\"line\">batch/v1</span><br><span class=\"line\">batch/v1beta1</span><br><span class=\"line\">certificates.k8s.io/v1beta1</span><br><span class=\"line\">coordination.k8s.io/v1</span><br><span class=\"line\">coordination.k8s.io/v1beta1</span><br><span class=\"line\">crd.projectcalico.org/v1</span><br><span class=\"line\">discovery.k8s.io/v1beta1</span><br><span class=\"line\">events.k8s.io/v1beta1</span><br><span class=\"line\">extensions/v1beta1</span><br><span class=\"line\">networking.k8s.io/v1</span><br><span class=\"line\">networking.k8s.io/v1beta1</span><br><span class=\"line\">node.k8s.io/v1beta1</span><br><span class=\"line\">policy/v1beta1</span><br><span class=\"line\">rbac.authorization.k8s.io/v1</span><br><span class=\"line\">rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">scheduling.k8s.io/v1</span><br><span class=\"line\">scheduling.k8s.io/v1beta1</span><br><span class=\"line\">storage.k8s.io/v1</span><br><span class=\"line\">storage.k8s.io/v1beta1</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"1-对象字段\"><a href=\"#1-对象字段\" class=\"headerlink\" title=\"(1) 对象字段\"></a>(1) 对象字段</h3><p>描述: 每个K8s控制器对象都包含了两个重要的字段，即 <code>spec</code> 和 <code>status</code> 字段, Kubernetes通过对应的控制器，不断地使实际状态趋向于您期望的目标状态。</p>\n<ul>\n<li>spec 必须由您来提供，描述了您对该对象所<code>期望</code>的 目标状态</li>\n<li>status 只能由 Kubernetes 系统来修改，描述了该对象在 Kubernetes 系统中的 <code>实际状态</code></li>\n</ul>\n<p>例如,一个 Kubernetes Deployment 对象可以代表一个应用程序在集群中的运行状态。当您创建 Deployment 对象时，您可以通过 Deployment 的 spec 字段指定需要运行应用程序副本数（replicas假设为3）。Kubernetes 从 Deployment 的 spec 中读取这些信息，并为您创建指定容器化应用程序的 3 个副本，再将实际的状态更新到 Deployment 的 status 字段。Kubernetes 系统将不断地比较 实际状态 staus 和 目标状态 spec 之间的差异，并根据差异做出对应的调整。<br>例如,如果任何一个副本运行失败了，Kubernetes 将启动一个新的副本，以替代失败的副本。</p>\n<h4 id=\"apiVersion-必须\"><a href=\"#apiVersion-必须\" class=\"headerlink\" title=\"apiVersion - 必须\"></a>apiVersion - 必须</h4><p>描述: 用来创建对象时所使用的Kubernetes API版本,可通过<code>kubectl api-versions</code>命令查询可用API版本;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl api-versions</span><br><span class=\"line\">admissionregistration.k8s.io/v1</span><br><span class=\"line\">apiextensions.k8s.io/v1</span><br><span class=\"line\">apiregistration.k8s.io/v1</span><br><span class=\"line\">apps/v1</span><br><span class=\"line\">authentication.k8s.io/v1</span><br><span class=\"line\">authorization.k8s.io/v1</span><br><span class=\"line\">autoscaling/v1</span><br><span class=\"line\">autoscaling/v2</span><br><span class=\"line\">autoscaling/v2beta1</span><br><span class=\"line\">autoscaling/v2beta2</span><br><span class=\"line\">batch/v1</span><br><span class=\"line\">batch/v1beta1</span><br><span class=\"line\">certificates.k8s.io/v1</span><br><span class=\"line\">coordination.k8s.io/v1</span><br><span class=\"line\">crd.projectcalico.org/v1</span><br><span class=\"line\">discovery.k8s.io/v1</span><br><span class=\"line\">discovery.k8s.io/v1beta1</span><br><span class=\"line\">events.k8s.io/v1</span><br><span class=\"line\">events.k8s.io/v1beta1</span><br><span class=\"line\">flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class=\"line\">flowcontrol.apiserver.k8s.io/v1beta2</span><br><span class=\"line\">networking.k8s.io/v1</span><br><span class=\"line\">node.k8s.io/v1</span><br><span class=\"line\">node.k8s.io/v1beta1</span><br><span class=\"line\">policy/v1</span><br><span class=\"line\">policy/v1beta1</span><br><span class=\"line\">rbac.authorization.k8s.io/v1</span><br><span class=\"line\">scheduling.k8s.io/v1</span><br><span class=\"line\">storage.k8s.io/v1</span><br><span class=\"line\">storage.k8s.io/v1beta1</span><br><span class=\"line\">v1</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"kind-必须\"><a href=\"#kind-必须\" class=\"headerlink\" title=\"kind - 必须\"></a>kind - 必须</h4><p>描述:被创建对象的类型常用的有<code>Deployment(部署)、Service(服务端口)</code></p>\n<p><br></p>\n<h4 id=\"metadata-必须\"><a href=\"#metadata-必须\" class=\"headerlink\" title=\"metadata - 必须\"></a>metadata - 必须</h4><p>描述:用于唯一确定该对象的元数据,包括 <code>name</code> 和 <code>namespace</code>，如果 namespace 为空，则默认值为 default;<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-deployment</span>   <span class=\"comment\"># 创建的资源对象名称</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">nginx-app</span>     <span class=\"comment\"># 设置指定的名称空间，默认为default</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"Annotation-注解\"><a href=\"#Annotation-注解\" class=\"headerlink\" title=\"Annotation - 注解\"></a>Annotation - 注解</h4><p>描述: 从Annotation字面意思理解其用途就是注解,或者有一些小伙伴看到过它，它类使用前面所提到的Label其也是采用Key/Value键值对进行表示;<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  annotation:</span></span><br><span class=\"line\"><span class=\"attr\">    key1:</span> <span class=\"string\">value1</span></span><br><span class=\"line\"><span class=\"attr\">    key2:</span> <span class=\"string\">value2</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>Q: Annotation 与 Lables 不同之处?</strong></p>\n<blockquote>\n<p>答: Lable 具有更为严格的命令规则，主要用于定义资源对象的元数据(Metadata)并且被Label Seletor使用<br>Annotation 是用户任意定义的附加信息，便于外部工具查找;</p>\n</blockquote>\n<p><strong>Q: Annotation 记录的信息?</strong></p>\n<blockquote>\n<p>A: Build 信息、Release 信息、Docker Image 信息、Docker Registry地址<br>A: 开发环境信息、工具名称、版本号等<br>A: 团队开发信息、电话号码、负责人、以及网站等</p>\n</blockquote>\n<p><br></p>\n<h4 id=\"spec-必须\"><a href=\"#spec-必须\" class=\"headerlink\" title=\"spec - 必须\"></a>spec - 必须</h4><p>描述:您对该对象的期望状态但是需注意不同类型的 Kubernetes，其 spec 对象的格式不同（含有不同的内嵌字段），通过 <a href=\"https://kubernetes.io/docs/reference/#api-reference\" target=\"_blank\" rel=\"noopener\">API 手册</a> 可以查看 Kubernetes 对象的字段和描述;</p>\n<p>例如，假设您想了解 Pod 的 spec 定义，可以在 <a href=\"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#podspec-v1-core\" target=\"_blank\" rel=\"noopener\">这里</a> 找到，Deployment 的 spec 定义可以在 <a href=\"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#deploymentspec-v1-apps\" target=\"_blank\" rel=\"noopener\">这里</a> 找到;</p>\n<p><br></p>\n<p><strong>资源清单常用的字段描述:</strong></p>\n<ul>\n<li><p>1.必须存在的属性【创建资源清单的时候没有这些属性的存在它是不允许被执行的】</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#参数名称 \t字段类型 \t说明</span></span><br><span class=\"line\">version \tString \t这里是指的是K8SAPI的版本，目前基本上是v1，可以用 `kubectl api-version` 命令查询</span><br><span class=\"line\">kind \tString \t    这里指的是yam文件定义的资源类型和角色，比如：Pod</span><br><span class=\"line\">metadata \tObject \t元数据对象，固定值就写metadata</span><br><span class=\"line\">metadata.name \tString \t元数据对象的名字，这里由我们编写，比如命名Pod的名字</span><br><span class=\"line\">metadata.namespace \tString \t元数据对象的命名空间，由我们自身定义，如果不定义的话则默认是default名称空间</span><br><span class=\"line\">Spec \tObject \t详细定义对象，固定值就写Spec</span><br><span class=\"line\">spec.containers[] \tList \t这里是Spec对象的容器列表定义，是个列表</span><br><span class=\"line\">spec.containers[].name \tString \t这里定义容器的名字</span><br><span class=\"line\">spec.containers[].image \tString \t这里定义要用到的镜像名称</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.主要属性【这些属性比较重要，如果不指定的话系统会自动补充默认值】</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#参数名称 \t字段类型 \t说明</span></span><br><span class=\"line\">spec.containers[].name \tString \t这里定义容器的名字</span><br><span class=\"line\">spec.containers[].image \tString \t这里定义要用到的镜像名称</span><br><span class=\"line\">spec.containers[].imagePullPolicy \tString \t定义镜像拉取策略，有Always、Never、 IfNotPresent三个值可选（1）Always:意思是每次都尝试重新拉取镜像（2）Never:表示仅使用本地镜像（3）lfNotPresent:如果本地有镜像就使用本地镜像，没有就拉取在线镜像。上面三个值都没设置的话，默认是Always。</span><br><span class=\"line\">spec.containers[].<span class=\"built_in\">command</span>[] \tList \t指定容器启动命令，因为是数组可以指定多个，不指定则使用镜像打包时使用的启动命令。</span><br><span class=\"line\">spec.containers[].args[] \tList \t指定容器启动命令参数，因为是数组可以指定多个。</span><br><span class=\"line\">spec.containers[].workingDir \tString \t指定容器的工作目录，进入容器时默认所在的目录</span><br><span class=\"line\">spec.containers[].volumeMounts[] \tList \t指定容器内部的存储卷配置</span><br><span class=\"line\">spec.containers[].volumeMounts[].name \tString \t指定可以被容器挂载的存储卷的名称</span><br><span class=\"line\">spec.containers[].volumeMounts[].mountPath \tString \t指定可以被容器挂载的存储卷的路径</span><br><span class=\"line\">spec.containers[].volumeMounts[].readOnly \tString \t设置存储卷路经的读写模式，<span class=\"literal\">true</span>或者<span class=\"literal\">false</span>，默认为读写模式</span><br><span class=\"line\">spec.containers[].ports[] \tList \t指定容器需要用到的端口列表</span><br><span class=\"line\">spec.containers[].ports[].name \tString \t指定端口名称</span><br><span class=\"line\">spec.containers[].ports[].containerPort \tString \t指定容器需要监听的端口号</span><br><span class=\"line\">spec.containers[].ports[].hostPort \tString \t指定容器所在主机需要监听的端口号，默认跟上面containerPort相同，注意设置了hostPort同一台主机无法启动该容器的相同副本（因为主机的端口号不能相同，这样会冲突)</span><br><span class=\"line\">spec.containers[].ports[].protocol \tString \t指定端口协议，支持TCP和UDP，默认值为 TCP</span><br><span class=\"line\">spec.containers[].env[] \tList \t指定容器运行前需设置的环境变量列表</span><br><span class=\"line\">spec.containers[].env[].name \tString \t指定环境变量名称</span><br><span class=\"line\">spec.containers[].env[].value \tString \t指定环境变量值</span><br><span class=\"line\">spec.containers[].resources \tObject \t指定资源限制和资源请求的值（这里开始就是设置容器的资源上限）</span><br><span class=\"line\">spec.containers[].resources.limits \tObject \t指定设置容器运行时资源的运行上限</span><br><span class=\"line\">spec.containers[].resources.limits.cpu \tString \t指定CPU的限制，单位为core数，将用于docker run --cpu-shares参数这里前面文章 Pod资源限制有讲过）</span><br><span class=\"line\">spec.containers[].resources.limits.memory \tString \t指定MEM内存的限制，单位为MlB、GiB </span><br><span class=\"line\">spec.containers[].resources.requests \tObject \t指定容器启动和调度时的限制设置</span><br><span class=\"line\">spec.containers[].resources.requests.cpu \tString \tCPU请求，单位为core数，容器启动时初始化可用数量</span><br><span class=\"line\">spec.containers[].resources.requests.memory \tString \t内存请求，单位为MIB、GiB，容器启动的初始化可用数量</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.额外的参数项</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参数名称 \t字段类型 \t说明</span><br><span class=\"line\">spec.restartPolicy \t String \t定义Pod的重启策略，可选值为Always、OnFailure、Never 默认值为Always。1.Always:Pod一旦终止运行，则无论容器是如何终止的，kubelet服务都将重启它。2.OnFailure:只有Pod以非零退出码终止时，kubelet才会重启该容器。如果容器正常结束（退出码为0），则kubelet将不会重启它。3.Never:Pod终止后，kubelet将退出码报告给Master，不会重启该Pod。</span><br><span class=\"line\">spec.nodeSelector \tObject \t定义Node的Label过滤标签，以key:value格式指定，选择node节点去运行</span><br><span class=\"line\">spec.imagePullSecrets \tObject \t定义pull镜像时使用secret名称，以name:secretkey格式指定</span><br><span class=\"line\">spec.hostNetwork \tBoolean \t定义是否使用主机网络模式，默认值为<span class=\"literal\">false</span>。设置<span class=\"literal\">true</span>表示使用宿主机网络，不使用docker网桥，同时设置了<span class=\"literal\">true</span>将无法在同一台宿主机上启动第二个副本。</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>资源清单格式:</strong><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">group/apiversion</span> <span class=\"comment\">#定义对象的版本模式; 如果没有给定group名称，那么默认为core可以使用kubectlapi-versions命令获取当前k8s版本上所有的apiversion版本信息（每个版本可能不同）</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span>     <span class=\"comment\">#资源类别: 该对象表示的REST资源</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span> <span class=\"comment\">#资源元数据</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span>    <span class=\"comment\">#资源自定义名称</span></span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"comment\">#资源所属的名称空间</span></span><br><span class=\"line\"><span class=\"attr\"> lables:</span>    <span class=\"comment\">#资源</span></span><br><span class=\"line\"><span class=\"attr\"> annotations:</span> <span class=\"comment\">#注解:主要目的是方便用户阅读查找</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span>   <span class=\"comment\">#期望的状态（disired state)</span></span><br><span class=\"line\"><span class=\"attr\">status:</span> <span class=\"comment\">#当前状态，本字段由Kubernetes自身维护，用户不能去定义</span></span><br></pre></td></tr></table></figure></p>\n<p>示例：以下是创建Pod所定义清单文件内容<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\"> name:</span> <span class=\"string\">pod-demo</span> </span><br><span class=\"line\"><span class=\"attr\"> namespace:</span> <span class=\"string\">default</span> </span><br><span class=\"line\"> <span class=\"number\">1</span><span class=\"attr\">abels:</span></span><br><span class=\"line\"><span class=\"attr\">  app:</span><span class=\"string\">myapp</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\"> containers:</span></span><br><span class=\"line\"><span class=\"attr\"> - name:</span> <span class=\"string\">myapp-1</span> </span><br><span class=\"line\"><span class=\"attr\">   image:</span> <span class=\"string\">harbor.weiyigeek.top/1ibrary/myapp:v1</span>    <span class=\"comment\"># 支持多个容器运行在同一个Pod之中</span></span><br><span class=\"line\"><span class=\"attr\"> - name:</span> <span class=\"string\">busybox-1</span> </span><br><span class=\"line\"><span class=\"attr\">   image:</span> <span class=\"attr\">busybox:latest</span> </span><br><span class=\"line\"><span class=\"attr\">   command:</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span> <span class=\"string\">\"/bin/sh\"</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span> <span class=\"string\">\"-c\"</span></span><br><span class=\"line\"><span class=\"bullet\">   -</span> <span class=\"string\">\"sleep 3600\"</span></span><br></pre></td></tr></table></figure></p>\n<p>PS: 创建pod时如发生错误可以通过<code>kubectl describe pod myapp-pod-name</code>和<code>kubectl logs myapp-pod-name</code>命令查看pod相关信息(注意如果有名称空间则需要加上);<br>PS: 一个Pod内支持多个容器运行所以在定义资源清单的时候，可以在<code>spec.containers</code>数组中指定多个运行的容器及其镜像;</p>\n<hr>\n<h2 id=\"0x02-NameSpace-名称空间\"><a href=\"#0x02-NameSpace-名称空间\" class=\"headerlink\" title=\"0x02 NameSpace - 名称空间\"></a>0x02 NameSpace - 名称空间</h2><p>描述: Namespace即名称空间，您可能在<code>c++</code>或者<code>c#</code>中听说它, 它也是K8s系统中非常重要的一个概念;</p>\n<p>Tips : 由于创建多个集群会导致集群资源使用碎片化以及更多的维护成本，可以通过Kubernetes的NameSpace对不同工作组的需求隔离。</p>\n<p><strong>Q: namespace 有何作用?</strong></p>\n<blockquote>\n<p>A: 它可以通过不同的资源对象调度到不同的Namespace中, 从逻辑上形成不同项目、小组或用户组，便于不同的分组之间能够共享使用整个集群的资源同时还能分别管理;<br>简而言之: namespace 能够帮助不同的租户(多租户管理)共享一个k8s集群的资源，使得整个集群的配置非常灵、方便。</p>\n</blockquote>\n<p><strong>Q: namespace 命名规则?</strong></p>\n<blockquote>\n<p>A: 只能包括<code>[a-z0-9]</code>并且最大长度为63位;</p>\n</blockquote>\n<p>Tips : 默认情况下k8s集群会创建一个默认的名称空间即Default, 如果采用资源对象未指定namespace时，则用户所创建的所有资源对象<code>如Pod、RC、RS、Deployment、Service</code>都将被分配到default的namespace之中;</p>\n<p><br></p>\n<h3 id=\"namespace-创建查看\"><a href=\"#namespace-创建查看\" class=\"headerlink\" title=\"namespace 创建查看\"></a>namespace 创建查看</h3><ul>\n<li><p>Step 1.名称空间创建的两种方式命令行、yaml配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1</span></span><br><span class=\"line\">kubectl create namespace dev-ops</span><br><span class=\"line\"><span class=\"comment\"># namespace/dev-ops created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dev-ops</span><br><span class=\"line\"></span><br><span class=\"line\">kubecrl create -f namespace-create.yaml</span><br><span class=\"line\"><span class=\"comment\"># namespace/dev-ops created</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 2.查看名称空间</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ kubectl get ns</span><br><span class=\"line\">  <span class=\"comment\"># NAME                   STATUS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># default                Active   89d</span></span><br><span class=\"line\">  <span class=\"comment\"># dev-ops                Active   16s</span></span><br><span class=\"line\"></span><br><span class=\"line\">~$ kubectl describe ns dev-ops</span><br><span class=\"line\">  <span class=\"comment\"># Name:         dev-ops</span></span><br><span class=\"line\">  <span class=\"comment\"># Labels:       &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># Annotations:  &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># Status:       Active</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># No resource quota.  # 后续讲解资源配额</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># No LimitRange resource.</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.删除名称空间(非常注意删除名称空间是非常注意是该namespace下存在<code>pvc/deployment/rc</code>等资源对象, 否则删除名称空间后其资源将被销毁)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl delete namespace dev-ops <span class=\"comment\"># 慎用 -force,-f 选项;</span></span><br><span class=\"line\">kubectl delete -f namespace-create.yaml</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"namespace-配额\"><a href=\"#namespace-配额\" class=\"headerlink\" title=\"namespace 配额\"></a>namespace 配额</h3><p>描述: 默认情况下创建的namespace并不会对资源进行配额,如果需要对某一个Namespace配额则需要配合<code>ResourceQuota</code>使用;</p>\n<p>基础示例: ResourceQuota 配额管理<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 创建名称空间</span></span><br><span class=\"line\">kubectl create namespace dev-ops</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) resource-quote-demo.yaml | 资源清单yaml文件</span></span><br><span class=\"line\">cat &gt; K8s/Day1/resource-quote-demo.yaml &lt;&lt;<span class=\"string\">'end'</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ResourceQuota</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: resource-quote-demo</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hard:</span><br><span class=\"line\">    <span class=\"comment\"># 表示全部Container的内存requests总和不能超过1G，而内存Limits的总和不能超过2GiB (CPU 与之相同)</span></span><br><span class=\"line\">    requests.cpu: <span class=\"string\">\"1\"</span></span><br><span class=\"line\">    requests.memory: 1Gi</span><br><span class=\"line\">    limits.cpu: <span class=\"string\">\"2\"</span></span><br><span class=\"line\">    limits.memory: 2Gi</span><br><span class=\"line\">end</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 创建ResourceQuota并为其指定名称空间</span></span><br><span class=\"line\">~/K8s/Day1$ kubectl create -f resource-quote-demo.yaml -n dev-ops</span><br><span class=\"line\">  <span class=\"comment\"># resourcequota/resource-quote-demo created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 获取名称空间的配额信息</span></span><br><span class=\"line\">~/K8s/Day1$ kubectl get resourcequota -n dev-ops  <span class=\"comment\"># -o yaml 可以查看到使用的情况</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                  AGE   REQUEST                                     LIMIT</span></span><br><span class=\"line\">  <span class=\"comment\"># resource-quote-demo   73s   requests.cpu: 0/1, requests.memory: 0/1Gi   limits.cpu: 0/2, limits.memory: 0/2Gi</span></span><br><span class=\"line\">~/K8s/Day1$ kubectl describe resourcequota -n dev-ops</span><br><span class=\"line\">  <span class=\"comment\"># Name:            resource-quote-demo</span></span><br><span class=\"line\">  <span class=\"comment\"># Namespace:       dev-ops</span></span><br><span class=\"line\">  <span class=\"comment\"># Resource         Used  Hard</span></span><br><span class=\"line\">  <span class=\"comment\"># --------         ----  ----</span></span><br><span class=\"line\">  <span class=\"comment\"># limits.cpu       0     2</span></span><br><span class=\"line\">  <span class=\"comment\"># limits.memory    0     2Gi</span></span><br><span class=\"line\">  <span class=\"comment\"># requests.cpu     0     1</span></span><br><span class=\"line\">  <span class=\"comment\"># requests.memory  0     1Gi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 如果在该名称空间中创建Pod并设置了resource，则 通过 -o yaml 可以查看到该名称空间使用的情况</span></span><br><span class=\"line\">~/K8s/Day1$ kubectl get resourcequota -n dev-ops -o yaml </span><br><span class=\"line\"><span class=\"comment\"># status:</span></span><br><span class=\"line\"><span class=\"comment\">#   hard:</span></span><br><span class=\"line\"><span class=\"comment\">#     limits.cpu: \"2\"</span></span><br><span class=\"line\"><span class=\"comment\">#     limits.memory: 2Gi</span></span><br><span class=\"line\"><span class=\"comment\">#     requests.cpu: \"1\"</span></span><br><span class=\"line\"><span class=\"comment\">#     requests.memory: 1Gi</span></span><br><span class=\"line\"><span class=\"comment\">#   used:</span></span><br><span class=\"line\"><span class=\"comment\">#     limits.cpu: \"1\"</span></span><br><span class=\"line\"><span class=\"comment\">#     limits.memory: \"1.5Gi\"</span></span><br><span class=\"line\"><span class=\"comment\">#     requests.cpu: \"800m\"</span></span><br><span class=\"line\"><span class=\"comment\">#     requests.memory: \"700Mi\"</span></span><br></pre></td></tr></table></figure></p>\n<p>Tips : 如果此时再创建一个Pod并设置<code>resources.requests.memory</code>的值为700Mi。则会显示错误由于请求700Mi已经超出剩余的剩余的Memoryquota的值，所以新创建Pod的请求将会被终止;</p>\n<p>Tips : 非常建议每个Container设置CPU/Memory的request与limit值(涉及到Qos后文讲述)</p>\n<p>Tips ：我们不单单可以对Namespace做名称空间资源限制还可以通过其对应Container、Pod数量配额(副本数)、API对象的配额等;</p>\n<hr>\n<h2 id=\"0x03-Pod-基础-amp-进阶\"><a href=\"#0x03-Pod-基础-amp-进阶\" class=\"headerlink\" title=\"0x03 Pod 基础&amp;进阶\"></a>0x03 Pod 基础&amp;进阶</h2><p>我们知道 Pod 是Kubernetes里最小单元，部署在节点之上包含一组<code>容器(Container)和卷(Volume)</code>, 同一个Pod中的容器共享同一个网络命名空间即可以通过localhost进行相互通信;<br>简单的说 Pod 是一组可以在主机上运行的容器，该资源由客户端创建并调度到主机上。</p>\n<p>先来提出几个问题&amp;回答:</p>\n<ul>\n<li>(1) 如果Pod生命周期是短暂的那么如何才能持久化容器数据,即使在Pod被销毁或者重启到其它机器上存在?<ul>\n<li>答: k8s支持(Volume，Persistent Volumes)的概念所以可以使用持久化的卷类型;</li>\n</ul>\n</li>\n<li>(2) 如何创建大批量的实例副本?<ul>\n<li>答: 建议采用 <code>Replication Controller / Replica Set / Deployment / StateSetful</code> 使用Pod模板创建多份拷贝;</li>\n</ul>\n</li>\n<li>(3) 如果Pod生命周期是短暂的那么重建pod后意味着IP地址可能会发生变化,那如何才能从前端容器正确可靠的指向后端容器?<ul>\n<li>答: 使用 Service 服务发现对象</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<p><strong>Pod 分类</strong></p>\n<ul>\n<li>自助式pod 只要pod退出了，此类型的pod不会被重建，该pod没有管理者，死亡后不会被拉起。</li>\n<li>控制器管理的pod【生产环境中大多数都是选择控制器去管理pod】 在控制器的生命周期里始终要维持pod的副本数目</li>\n</ul>\n<p><em>自助式pod与控制器管理的pod有何区别?</em></p>\n<blockquote>\n<p>答: 其<code>生命周期</code>被管理的机制不太一致</p>\n</blockquote>\n<p><br></p>\n<h3 id=\"1-Pod-Template-amp-Controller\"><a href=\"#1-Pod-Template-amp-Controller\" class=\"headerlink\" title=\"(1) Pod Template &amp; Controller\"></a>(1) Pod Template &amp; Controller</h3><p>描述: 我们一般不会在k8s中直接创建单个Pod，因为其的生命周期是短暂的（即用后即焚的实体），当Pod被创建后都会被k8s调度到集群的Node之上, 直到Pod进程终止被删除, 因为缺少资源而被驱逐或者Node故障之前这个Pod都会一直保持在那个Node上;</p>\n<p>注意事项:</p>\n<ul>\n<li>1.重启Pod中的容器和重启Pod是两种概念，因为Pod只提供容器运行环境并保持容器的运行状态所有重启容器并不会导致Pod重启, 最外层还有个Pause容器在运行；</li>\n<li>2.自助式Pod并不会自愈，如果当Pod运行的Node节点故障或者调度器本身故障该Pod就会被删除，同样的如果Pod所在Node缺少资源或者Pod处于维护状态也将会被驱逐，所以常常使用Controller来管理Pod的。</li>\n</ul>\n<p>Controller 可以创建和管理多个Pod并且提供副本管理、滚动升级和集群级别的自愈能力；<br>例如：当一个Node故障Controller就能自动将该节点上的Pod调度到其他健康的Node上;</p>\n<p><br></p>\n<p><strong>常用于创建Pod的控制器列表:</strong><br>一般来说Pod并不会自动消失，除非是特意将它们进行销毁如人为操作或者控制器操作, 该规则唯一例外的是成功或者失败的Phase超过一段时间（由Master确定操作）的Pod将过期并被自动销毁；<br>如下列控制器:</p>\n<ul>\n<li>Replication Controller</li>\n<li>Delopyment</li>\n<li>StatefulSet</li>\n<li>DaemonSet</li>\n<li>Job</li>\n</ul>\n<p>Tips : 通常Controller会通过<code>Pod Template</code>来创建相应的Pod, 而又为什么建议使用控制器创建Pod而非直接创建呢?;</p>\n<blockquote>\n<p>答: 因为单独的Pod在机器故障的情况下没有办法自动复原而控制器则可以按照期望副本数进行构建复原;</p>\n</blockquote>\n<p><br/></p>\n<p><strong>什么是Pod模板?</strong><br>答: Pod 模板是包含了其他对象(例如RC、Jobs和DeamonSets)中的Pod定义。Controller 控制器使用 Pod模板 以及 selector选择器 来创建实际需要的Pod;</p>\n<p><br></p>\n<p><strong>(1) Pod 资源配额与限额</strong><br>描述: 每个Pod都可以对其能使用的服务器上的计算机资源比如CPU和Memory进行设置限额，值得注意的是CPU的资源单位为CPU(Core)的数量是一个绝对值而非相对值，同样Memory也是一个绝对值;</p>\n<p>在Kubernets中CPU常以千分之一的CPU配额作为最小的单元通常用<code>m</code>表示，而Memory配额单位是内存字节数通常用<code>Mi</code>表示；<br>例如: 通常一个容器的配额被定义为100~300m即占用0.1~0.3个CPU，由于CPU配额是个绝对值所以说无论是1C或者48C的机器上100m代表的配额都是一样的;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">resources:</span><br><span class=\"line\">  <span class=\"comment\"># 限制</span></span><br><span class=\"line\">  limits:</span><br><span class=\"line\">    cpu: 500m</span><br><span class=\"line\">    memory: 500Mi</span><br><span class=\"line\">  <span class=\"comment\"># 请求(依赖)</span></span><br><span class=\"line\">  requests:</span><br><span class=\"line\">    cpu: 500m</span><br><span class=\"line\">    memory: 6Gi</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>示例.Pod Template &amp; Pod resources<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span>        <span class=\"comment\"># apiserver版本</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span>           <span class=\"comment\"># 绑定动作</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-deployment</span>   <span class=\"comment\"># 应用 + 绑定类型 </span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">nginx-app</span>     <span class=\"comment\"># 名称空间</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span>      <span class=\"comment\"># 选择器，匹配Pod模板中的标签才知道运行了几个副本实例;</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">      role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">      tier:</span> <span class=\"string\">backend</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span>    <span class=\"comment\"># 运行 2 个容器化应用程序副本</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span>      <span class=\"comment\"># Pod 模板</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        role:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">        tier:</span> <span class=\"string\">backend</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">nginx:1.7.9</span></span><br><span class=\"line\"><span class=\"attr\">        resources:</span></span><br><span class=\"line\"><span class=\"attr\">          requests:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"number\">100</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"number\">100</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">          limits:</span></span><br><span class=\"line\"><span class=\"attr\">            cpu:</span> <span class=\"number\">800</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">            memory:</span> <span class=\"number\">800</span><span class=\"string\">Mi</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">8080</span>  <span class=\"comment\"># 暴露的端口</span></span><br></pre></td></tr></table></figure></p>\n<p>Yaml 配置文件相关操作:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.使用 kube apply 命令可以创建该 .yaml 文件中的 Deployment 对象</span></span><br><span class=\"line\">kubectl apply -f deployment.yaml</span><br><span class=\"line\">kubectl apply -f https://weiyigeek.top/k8s/deployment.yaml</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Tips : 可以采用直接 RUN 创建Pod, 实际上不加port也能通过服务进行发现实际工作中一定要加上为了后期问题的排查<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl run nginx --image nginx:latest --port=80 --replicas=2</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"2-Static-Pod-静态\"><a href=\"#2-Static-Pod-静态\" class=\"headerlink\" title=\"(2) Static Pod (静态)\"></a>(2) Static Pod (静态)</h3><p>Q: 什么是静态Pod?</p>\n<blockquote>\n<p>答: 在 k8s 中由kubelet创建并运行的Pod, 该种类型的Pod可以在某个节点上长期运行（即静态Pod）。<br>简单说静态 pod 是由 kubelet 创建和管理的只在特定node上存在的 pod，并且只在kubelet所在的Node上运行。</p>\n</blockquote>\n<p><br></p>\n<p><strong>静态Pod特点:</strong></p>\n<ul>\n<li>1.静态 pod 总是由某个节点上的 kubelet 创建和管理的, 即不能通过 api-server 来管理,所以无法和 <code>RC，RS，Deployment 或者 DaemonSet控制器</code>进行关联。</li>\n<li>2.kubelet 无法对 静态 pod 进行健康检查。</li>\n</ul>\n<ul>\n<li>3.如果把 pod 的yaml描述文件放到这个目录中，等kubelet扫描到文件，会自动在本机创建出来 pod；</li>\n<li>4.如果把 pod 的yaml文件更改了，kubelet也会识别到，会自动更新 pod；</li>\n<li>5.如果把 pod 的yaml文件删除了，kubelet会自动删除掉pod；</li>\n</ul>\n<ul>\n<li>6.如果当 kubelet 发现静态Pod停止掉时候，将会重新启动静态Pod;</li>\n</ul>\n<p>Tips: 因为静态 pod 不能被 api-server 直接管理，所以它的更新删除操作不能由 kubectl 来执行，只能直接修改或删除文本文件。</p>\n<p><strong>静态Pod创建的两种方式:</strong></p>\n<ul>\n<li>1.HTTP： kubelet 周期地从采用 <code>--manifest-url</code> 参数指定的地址下载文件，并且将它翻译成JSON/YAML格式的Pod定义(实际与下面差距不大只是增加了下账的步骤)</li>\n<li>2.配置文件：kubelet 启动时采用 <code>--pod-manifest-path=/etc/kubernetes/manifests</code> 指定yaml文件存放目录 会定期扫描这个目录，并根据这个目录下的 .yaml 或 .json 文件进行创建和更新操作 </li>\n</ul>\n<p>例如将static-nginx-web.yaml文件加入到该文件夹之中, 重启 Kubelet 服务或者等待几秒即可创建静态 Pod;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tee /etc/kubernetes/manifests/static-pod.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: static-nginx-web</span><br><span class=\"line\">  lables:</span><br><span class=\"line\">    app: nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name : web</span><br><span class=\"line\">    image: nginx:latest</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - name: nginx-port</span><br><span class=\"line\">        containerPort: 80</span><br><span class=\"line\">        protocol: TCP</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p><strong>操作流程:</strong></p>\n<ul>\n<li><p>(1) 写入到<code>/etc/kubernetes/manifests/</code>目录后查看kubelet状态</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ systemctl status kubelet</span><br><span class=\"line\"><span class=\"comment\"># ● kubelet.service - kubelet: The Kubernetes Node Agent</span></span><br><span class=\"line\"><span class=\"comment\">#      Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)</span></span><br><span class=\"line\"><span class=\"comment\">#     Drop-In: /etc/systemd/system/kubelet.service.d</span></span><br><span class=\"line\"><span class=\"comment\">#              └─10-kubeadm.conf</span></span><br><span class=\"line\"><span class=\"comment\">#      Active: active (running) since Wed 2021-01-20 03:18:21 UTC; 1h 24min ago</span></span><br><span class=\"line\"><span class=\"comment\">#        Docs: https://kubernetes.io/docs/home/</span></span><br><span class=\"line\"><span class=\"comment\">#    Main PID: 1436080 (kubelet)</span></span><br><span class=\"line\"><span class=\"comment\">#       Tasks: 19 (limit: 9450)</span></span><br><span class=\"line\"><span class=\"comment\">#      Memory: 50.7M</span></span><br><span class=\"line\"><span class=\"comment\">#      CGroup: /system.slice/kubelet.service</span></span><br><span class=\"line\"><span class=\"comment\">#              └─1436080 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --network-plugin=cni --pod-infra-container-image=</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>(2) 静态 Pod 查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls /etc/kubernetes/manifests</span><br><span class=\"line\">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml  static-pod.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get pod -o wide | grep <span class=\"string\">\"static\"</span></span><br><span class=\"line\"><span class=\"comment\"># static-nginx-web-weiyigeek-107   1/1  Running   0   82m  172.16.0.197  weiyigeek-107   &lt;none&gt;  &lt;none&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>(3) 移除静态 Pod</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意:移除静态Pod虽然用api server可以删除静态Pod，但他很快自动重新生成Pod,所以通过删除静态Pod的yaml配置资源文件则完成移除静态Pod;</span></span><br><span class=\"line\">$ rm /etc/kubernetes/manifests/static-pod.yaml</span><br><span class=\"line\">$ kubectl get pod</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"3-Pod-生命周期\"><a href=\"#3-Pod-生命周期\" class=\"headerlink\" title=\"(3) Pod 生命周期\"></a>(3) Pod 生命周期</h3><p><strong>Q: 主要通过以下层面了解Pod的声明周期;</strong></p>\n<ol>\n<li>在Pod被创建后经历的过程及其状态;</li>\n<li>Pod中容器探测纠察;</li>\n</ol>\n<p><em>Pod 创建过程与各对象生命周期流程图：</em><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/2/20201108213611.png\" alt=\"WeiyiGeek.k8s中Pod创建过程与生命周期\" title=\"\" class=\"\">\n                <p>WeiyiGeek.k8s中Pod创建过程与生命周期</p>\n            </figure></p>\n<p><br></p>\n<p><strong>简单说明:</strong></p>\n<ul>\n<li>1.前面我们讲解了Kubectl、KubeAPI-Server、ETCD、Kubelet、CRI等组件此处不在累述;</li>\n<li>2.Pause 容器: Pod 创建之初的创建它是Pod里容器共享网络栈以及存储卷必备的;</li>\n<li>3.Init C(初始化容器): Pod 能够具有一个或多个容器，应用运行在容器里面，但是它也可能有一个或多个先于应用容器启动的Init容器。<ul>\n<li>2.1 Init容器与普通的容器区别: Init容器总是运行到成功完成为止，每个Init容器都必须在下一个Init容器启动之前成功完成（<code>有一定的顺序</code>）。</li>\n<li>2.2 如果Pod的Init容器失败 Kubernetes会不断地重启该Pod，直到Init容器成功为止。但是如果 Pod 对应的 <code>restartPolicy【默认为Always】 设置为Never</code>，它将不会重新启动。</li>\n</ul>\n</li>\n<li>4.Mian C(主容器 ): 在Pod中可以运行一个多个容器它们都有各自的生命周期, 当Pod中主容器结束退出时Pod将结束;</li>\n<li>5.Start / Stop : 在容器启动或者停止时候执行的脚本</li>\n<li>6.Readiness : 在主容器启动后进行其应用进程探测，完成后容器的状态将改变成Running;</li>\n<li>7.Liveness : 在主容器的生命周期都有它的身影，其作用是在主容器的进程与其检测结果不一致的情况下将执行重启或者删除容器;</li>\n</ul>\n<p><br/></p>\n<h4 id=\"Pod-Phase\"><a href=\"#Pod-Phase\" class=\"headerlink\" title=\"Pod Phase\"></a>Pod Phase</h4><p>描述: Pod的status字段是保存在一个PodStatus对象中，该 PodStatus 中有一个 phase 字段。<br>Pod的相位（phase) 是 Pod 在其生命周期中的简单宏观概述。</p>\n<p>PS : 该阶段并不是对容器或Pod的综合汇总，也不是为了做为综合状态机, 并且Pod相位的数量和含义是严格指定的。<br>PS : 除了本文档中列举的状态外不应该在假定Pod有其他的phase值 </p>\n<p><strong>Pod phase 可能存在的几种状态值:</strong></p>\n<ul>\n<li>挂起（Pending）：Pod 已被 Kubernetes系统接受，但有一个或者多个容器镜像尚未创建。等待时间包括调度Pod的时间和通过网络下载镜像的时间，这可能需要花点时间</li>\n<li>运行中（Running）：该Pod 已经绑定到了一个节点上，Pod中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态</li>\n<li>成功（Succeeded）：Pod中的所有容器都被成功终止，并且不会再重启</li>\n<li>失败（Failed)：Pod中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说容器以非0状态退出或者被系统终止</li>\n<li>未知（Unknown）：因为某些原因无法取得Pod的状态，通常是因为与Pod所在主机通信失败</li>\n</ul>\n<p><br><br>Pod 的生命周期示意图（从图中可以看到Pod状态的变化）</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210120152027.png\" alt=\"WeiyiGeek.Pod 的生命周期示意图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Pod 的生命周期示意图</p>\n            </figure>\n<p><br></p>\n<p>示例1.Pod Phase 与 Pod 运行状态查看<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get  pod redis-cluster-operator-6669898858-rwm7s -o yaml  | grep <span class=\"string\">\" phase\"</span></span><br><span class=\"line\">  phase: Running</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl describe pod redis-cluster-operator-6669898858-rwm7s | grep <span class=\"string\">\"^Status\"</span></span><br><span class=\"line\">  Status: Running</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"Pod-重启策略\"><a href=\"#Pod-重启策略\" class=\"headerlink\" title=\"Pod 重启策略\"></a>Pod 重启策略</h4><p>描述: 当 Pod 中某一个 Container 处于退出状态(Exited)时, Kubelet 会根据 Pod Sepc 中 restartPolicy 字段的取值(<code>Always [缺省]、OnFailure和Never</code> 进行相应的操作;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl explain statefulset.spec.template.spec | grep <span class=\"string\">\"restartPolicy\"</span></span><br><span class=\"line\">  restartPolicy. The name <span class=\"keyword\">for</span> an init container or normal container must be</span><br><span class=\"line\">  restartPolicy &lt;string&gt; <span class=\"comment\"># only Support Always</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p><strong>重启策略说明:</strong></p>\n<ul>\n<li>Always : 默认重启策略只要有一个Container处于Exited时，即会重启</li>\n<li>OnFailure : 当容器异常退出或退出状态不为0时，即会重启</li>\n<li>Never : 无论如何都不重启</li>\n</ul>\n<p><br/></p>\n<p><strong>补充说明:</strong></p>\n<ul>\n<li><p>(1) 当一个pod设置重启策略<code>restartPolicy</code>则适用于Pod 中的所有容器, 触发规则时通过同一节点上的kubelet重新启动容器。<br>restartPolicy 仅指, 失败的容器<code>由 kubelet 以五分钟为上限的指数退避延迟（10秒，20秒，40秒...) 重新启动</code>，并在成功执行十分钟后重置。</p>\n</li>\n<li><p>(2) 不同控制器对不同Pod重启策略的处理机制是不一样的例如</p>\n<ul>\n<li>2.1 使用 Job 控制器创建POD运行预期会终止, 如批量计算此时Job仅适用于重启策略为 OnFailure 或 Never 的 Pod;</li>\n<li>2.2 使用 RC、RS、Deployment、StatefulSet控制器创建的Pod预期是不会终止的，如Web服务器注意RC仅适用于具有 RestartPolicy 为 Always 的Pod。</li>\n<li>2.3 使用 DeamonSet 控制器创建的Pod将会在每台工作节点上运行，提供特定于机器的系统服务;</li>\n</ul>\n</li>\n</ul>\n<p>Tips : 如Pod文档中所述一旦绑定到一个节点，Pod将永远不会重新绑定到另一个节点。</p>\n<p><br/></p>\n<p><strong>Pod状态示例</strong></p>\n<ul>\n<li><p>⒈Pod 中只有一个容器并且正在运行，容器成功退出 </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">·记录事件完成 </span><br><span class=\"line\">·如果restartPolicy为： </span><br><span class=\"line\">　Always：重启容器；   <span class=\"comment\">#Pod phase 仍为 Running </span></span><br><span class=\"line\">  OnFailure:         <span class=\"comment\">#Pod phase 变成 Succeeded </span></span><br><span class=\"line\">　Never:              <span class=\"comment\">#Pod phase 变成 Succeeded</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>⒉Pod 中只有一个容器并且正在运行,容器退出失败</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">·记录失败事件</span><br><span class=\"line\">·如果restartPolicy为：</span><br><span class=\"line\">  Always:重启容器；    <span class=\"comment\">#Pod phase 仍为 Running</span></span><br><span class=\"line\">  OnFailure：重启容器；<span class=\"comment\">#Pod phase 仍为 Running</span></span><br><span class=\"line\">  Never:              <span class=\"comment\">#Pod phase 变成 Failed</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>⒊Pod 中有两个容器并且正在运行。<br>如果容器1退出失败</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">记录失败事件·</span><br><span class=\"line\">如果restartPolicy为：</span><br><span class=\"line\">  Always：重启容器；   <span class=\"comment\">#Pod phase仍为Running </span></span><br><span class=\"line\">  OnFailure：重启容器；<span class=\"comment\">#Pod phase仍为Running</span></span><br><span class=\"line\">  Never：不重启容器；  <span class=\"comment\">#Pod phase仍为Running</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li><p>4.如果有容器1没有处于运行状态并且容器2退出：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">记录失败事件</span><br><span class=\"line\">如果restartPolicy为：</span><br><span class=\"line\">  Always：重启容器；     <span class=\"comment\">#Pod phase仍为Running</span></span><br><span class=\"line\">  OnFailure：重启容器；  <span class=\"comment\">#Pod phase仍为Running</span></span><br><span class=\"line\">  Never：               <span class=\"comment\">#Pod phase变成Failed</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>⒌Pod 中只有一个容器并处于运行状态。容器运行时内存超出限制</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">·容器以失败状态终止记录0OM事件</span><br><span class=\"line\">·如果restartPolicy为：</span><br><span class=\"line\">  Always:重启容器；   <span class=\"comment\">#Pod phase仍为Running </span></span><br><span class=\"line\">  OnFailure:重启容器；<span class=\"comment\">#Pod phase仍为Running</span></span><br><span class=\"line\">  Never：记录失败事件；<span class=\"comment\">#Pod phase仍为Failed</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>⒍Pod 正在运行磁盘故障</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">·杀掉所有容器，记录适当事件</span><br><span class=\"line\">·Pod phase 变成 Failed</span><br><span class=\"line\">·如果使用控制器来运行 Pod 将在其他节点重建</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>⒎Pod 正在运行，其节点被分段<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">·节点控制器等待直到超时</span><br><span class=\"line\">·节点控制器将Pod phase设置为Failed</span><br><span class=\"line\">·如果是用控制器来运行，Pod 将在别处重建</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<BR>\n\n<h4 id=\"Pod-Init-容器\"><a href=\"#Pod-Init-容器\" class=\"headerlink\" title=\"Pod Init 容器\"></a>Pod Init 容器</h4><p><strong>Q: 什么是 Init Container?</strong><br>描述: 一个Pod中可以有一个或者多个 Init Container 即初始化容器操作, 其启动顺序受yaml文件中描述顺序影响进行启动（串行方式）, 这表示了每个容器必须在下一个容器启动之前成功退出，否则将会阻止后续的 init Container 与 app Container 服务启动，例如 <code>init Container 1 -&gt;  init Container 2 .. -&gt;  init Container n -&gt; app Container</code>;</p>\n<p><br/></p>\n<p><strong>Q: Init容器的作用有那些?</strong></p>\n<blockquote>\n<p>答: 因为Init容器具有与应用程序容器分离的单独镜像，所以利用其特征主要作为<code>服务依赖处理</code>, 例如某个服务A需依赖db或者Memcached, 那么可以利用服务A pod的Init Container判断dbdb或者Memcached是否正常提供服务，如果启动服务失败或者工作异常，则设置init 容器也将启动失败并且pod中的app 容器也将不会运行。</p>\n</blockquote>\n<p>所以它们的启动相关代码具有其它优势：</p>\n<blockquote>\n<p>(1) 它们可以包含并运行实用工具，但是出于安全考虑，是不建议在应用程序容器镜像中包含这些实用工具的<br>(2) 它们可以包含使用工具和定制化代码来安装，但是不能出现在应用程序镜像中。例如创建镜像没必要FROM另一个镜像，只需要在安装过程中使用类似sed、awk、python或dig这样的工具。<br>(3) 应用程序镜像可以分离出创建和部署的角色，而没有必要联合它们构建一个单独的镜像。<br>(4) Init 容器使用Linux Namespace，所以相对应用程序容器来说具有不同的文件系统视图。因此它们能够具有访问Secret的权限而应用程序容器则不能(<code>简单的说 Init Container也可被授权访问应用Container无权访问的内容</code>)。<br>(5) 它们必须在应用程序容器启动之前运行完成，而<code>应用程序容器是并行运行的</code>，所以Init容器能够提供了一种简单的阻塞或延迟应用容器的启动的方法，直到满足了一组先决条件。</p>\n</blockquote>\n<p><br></p>\n<p><strong>init 容器补充说明:</strong></p>\n<ul>\n<li><p>在Pod启动过程中Init 容器会按顺序在网络和数据卷初始化之后启动【即在pause启动之后启动，pod第一个启动的容器并不是Init而是pause, 但pause仅仅只负责初始化网络和数据卷其它什么操作都不能做，我们可操作的空间几乎为0因此不做描述】。</p>\n</li>\n<li><p>如果由于运行时或失败退出，将导致容器启动失败，它会根据Pod的<code>restart Policy</code>指定的策略进行重试。然而，如果Pod的restartPolicy设置为Always，Init 容器失败时会使用RestartPolicy 策略</p>\n</li>\n<li><p>从上面<code>Pod 创建过程与各对象生命周期流程图</code>中可知<code>Init Container</code>必须要在Pod状态变成Ready之前完成(其不需要readiness), 以及在资源的request和limits与app container 有些许差别，除以上两种init 容器 与 app 容器 大致相同；</p>\n</li>\n<li><p>在所有的Init容器没有成功之前，Pod将不会变成Ready状态。Init容器的端口将不会在Service中进行聚集。正在初始化中的Pod处于Pending状态，但应该会将Initializing状态设置为true</p>\n</li>\n<li><p>如果Pod 重启，所有Init容器必须重新执行，因此Init容器应该配置为幂等的状态。</p>\n</li>\n<li><p>Init 容器具有应用容器的所有字段。除了readiness Probe因为Init容器无法定义不同于完成（completion)的就绪（readiness)之外的其他状态(<code>会在验证过程中强制执行</code>)</p>\n</li>\n<li><p>在 Pod 中的每个app和Init容器的名称必须唯一；与任何其它容器共享同一个名称，会在验证时抛出错误；当然你可以加上一个名称空间来防止冲突;</p>\n</li>\n</ul>\n<ul>\n<li>对Init容器spec的修改被限制在容器image字段，修改其他字段都不会生效。更改Init容器的image字段，等价于重启该Pod<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl edit -n <span class=\"built_in\">test</span> pod myapp-pod</span><br><span class=\"line\">......</span><br><span class=\"line\"><span class=\"comment\"># 以一个 init C 容器 为例</span></span><br><span class=\"line\">initContainers:</span><br><span class=\"line\">  - <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - sh</span><br><span class=\"line\">    - -c</span><br><span class=\"line\">    - until nslookup myservice;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> waiting <span class=\"keyword\">for</span> myservice;sleep 2; <span class=\"keyword\">done</span>;</span><br><span class=\"line\">    image: busybox  <span class=\"comment\"># 表明的意思是只有在更改镜像名称时 Init 容器才会重新执行init C阶段, 修改其他字段无任何效果;</span></span><br><span class=\"line\">    imagePullPolicy: Always</span><br><span class=\"line\">    name: init-myservice</span><br><span class=\"line\">    resources: &#123;&#125;</span><br><span class=\"line\">    terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">    terminationMessagePolicy: File</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class=\"line\">      name: default-token-bk9vl</span><br><span class=\"line\">      readOnly: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>Init 容器使用简单示例:</strong></p>\n<ul>\n<li>Pod资源清单<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; ~/K8s/Day3/initC.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># 名称空间的创建</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:   </span><br><span class=\"line\">  name: <span class=\"built_in\">test</span>     <span class=\"comment\"># 创建的名称空间的名称(注意建议和labels保持一致并且为小写)</span></span><br><span class=\"line\">  labels:     </span><br><span class=\"line\">    name: <span class=\"built_in\">test</span></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: Pod         <span class=\"comment\"># 对象的REST资源类型注意首字母必须大小(坑)</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: myapp-pod  <span class=\"comment\"># pod的名称</span></span><br><span class=\"line\">  namespace: <span class=\"built_in\">test</span>  <span class=\"comment\"># 该Pod加入的名称空间</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: myapp     <span class=\"comment\">#该pod所拥有的标签</span></span><br><span class=\"line\">    version: v1    </span><br><span class=\"line\">    author: weiyigeek</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:       <span class=\"comment\"># 要运行容器的列表</span></span><br><span class=\"line\">  - name: myapp-main-container </span><br><span class=\"line\">    image: busybox </span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">'sh'</span>,<span class=\"string\">'-c'</span>,<span class=\"string\">'echo The app is running!&amp;&amp; sleep 3600'</span>] </span><br><span class=\"line\">  initContainers:   <span class=\"comment\"># 在Main C容器创建前运行的Init C容器，注意安装定义的顺序依次执行;</span></span><br><span class=\"line\">  - name: init-myservice   <span class=\"comment\"># 阶段1.以简单的探测服务是否存再来运行主容器以达到容器间依赖问题的解决;</span></span><br><span class=\"line\">    image: busybox </span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">'sh'</span>,<span class=\"string\">'-c'</span>,<span class=\"string\">'until nslookup myservice;do echo waiting for myservice;sleep 2; done;'</span>]  <span class=\"comment\"># 返回为0时候进入下一init C容器阶段</span></span><br><span class=\"line\">  - name: init-mydb        <span class=\"comment\"># 阶段2</span></span><br><span class=\"line\">    image: busybox  </span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">'sh'</span>,<span class=\"string\">'-c'</span>,<span class=\"string\">'until nslookup mydb;do echo waiting for mydb;sleep 2;done;'</span>]</span><br><span class=\"line\">  - name: init-serverA</span><br><span class=\"line\">    images: busybox</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">'sh'</span>,<span class=\"string\">'-c'</span>,<span class=\"string\">\"curl --connect-timeout 3 --max-time 5 --retry 10 --retry-delay 5 --retry-max-time 60 http://serverB:port/Path/\"</span>]</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></li>\n<li>Service 资源清单<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; ~/K8s/Day3/dependService.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\"> name: myservice</span><br><span class=\"line\"> namespace: <span class=\"built_in\">test</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\"> selector:</span><br><span class=\"line\">    app: myapp</span><br><span class=\"line\"> ports:</span><br><span class=\"line\">  - protocol: TCP</span><br><span class=\"line\">    port: 80 </span><br><span class=\"line\">    targetPort: 9376</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: Service </span><br><span class=\"line\">apiVersion: v1 </span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mydb</span><br><span class=\"line\">  namespace: <span class=\"built_in\">test</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\"> selector:</span><br><span class=\"line\">    author: weiyigeek</span><br><span class=\"line\"> ports:</span><br><span class=\"line\">  - protocol: TCP </span><br><span class=\"line\">    port: 80 </span><br><span class=\"line\">    targetPort: 9377</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>执行部署:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 0.部署测试init C的pod资源清单</span></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day3$ kubectl create -f initC.yaml</span><br><span class=\"line\">  <span class=\"comment\"># namespace/test created</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/myapp-pod created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.查看 名称空间与Pod 状态(此时可以看见Init0/2还未通过则该Pod的状态为Not Ready, 是由于Init 容器检测未通过)</span></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day3$ kubectl get pod -n <span class=\"built_in\">test</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME        READY   STATUS     RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># myapp-pod   0/1     Init:0/3   0          33s</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.部署测试init C的Service资源清单</span></span><br><span class=\"line\">kubectl create -f dependService.yaml</span><br><span class=\"line\">  <span class=\"comment\"># service/myservice created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/mydb created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查其容器运行流程日志以及状态</span></span><br><span class=\"line\">weiyigeek@ubuntu:~$ kubectl describe pod -n <span class=\"built_in\">test</span> myapp-pod</span><br><span class=\"line\">  <span class=\"comment\"># Init Containers:</span></span><br><span class=\"line\">  <span class=\"comment\">#   init-myservice:  # 阶段1</span></span><br><span class=\"line\">  <span class=\"comment\">#     Container ID:  docker://70ab169e9359e448c55267ff818f210a54b0348dc436cd4abd2b4db27fc4932c</span></span><br><span class=\"line\">  <span class=\"comment\">#     Image:         busybox</span></span><br><span class=\"line\">  <span class=\"comment\">#     Image ID:      docker-pullable://busybox@sha256:a9286defaba7b3a519d585ba0e37d0b2cbee74ebfe590960b0b1d6a5e97d1e1d</span></span><br><span class=\"line\">  <span class=\"comment\">#     Port:          &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">#     Host Port:     &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">#     Command:</span></span><br><span class=\"line\">  <span class=\"comment\">#       sh</span></span><br><span class=\"line\">  <span class=\"comment\">#       -c</span></span><br><span class=\"line\">  <span class=\"comment\">#       until nslookup myservice;do echo waiting for myservice;sleep 2; done;</span></span><br><span class=\"line\">  <span class=\"comment\">#     State:          Terminated</span></span><br><span class=\"line\">  <span class=\"comment\">#       Reason:       Completed</span></span><br><span class=\"line\">  <span class=\"comment\">#       Exit Code:    0    # 正常退出</span></span><br><span class=\"line\">  <span class=\"comment\">#       Started:      Sun, 08 Nov 2020 22:49:58 +0800</span></span><br><span class=\"line\">  <span class=\"comment\">#       Finished:     Sun, 08 Nov 2020 22:51:06 +0800</span></span><br><span class=\"line\">  <span class=\"comment\">#     Ready:          True  # 容器状态</span></span><br><span class=\"line\">  <span class=\"comment\">#     Restart Count:  0</span></span><br><span class=\"line\">  <span class=\"comment\">#     Environment:    &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">#     Mounts:</span></span><br><span class=\"line\">  <span class=\"comment\">#       /var/run/secrets/kubernetes.io/serviceaccount from default-token-bk9vl (ro)</span></span><br><span class=\"line\">  <span class=\"comment\">#   init-mydb:       # 阶段2 </span></span><br><span class=\"line\">  <span class=\"comment\">#     Container ID:  docker://306e36d57d75c92f3df10756140f3901dbcc22c1fd89439b8e365a348ca4cb6b</span></span><br><span class=\"line\">  <span class=\"comment\">#     Image:         busybox</span></span><br><span class=\"line\">  <span class=\"comment\">#     Image ID:      docker-pullable://busybox@sha256:a9286defaba7b3a519d585ba0e37d0b2cbee74ebfe590960b0b1d6a5e97d1e1d</span></span><br><span class=\"line\">  <span class=\"comment\">#     Port:          &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">#     Host Port:     &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">#     Command:</span></span><br><span class=\"line\">  <span class=\"comment\">#       sh</span></span><br><span class=\"line\">  <span class=\"comment\">#       -c</span></span><br><span class=\"line\">  <span class=\"comment\">#       until nslookup mydb;do echo waiting for mydb;sleep 2;done;</span></span><br><span class=\"line\">  <span class=\"comment\">#     State:          Terminated</span></span><br><span class=\"line\">  <span class=\"comment\">#       Reason:       Completed</span></span><br><span class=\"line\">  <span class=\"comment\">#       Exit Code:    0</span></span><br><span class=\"line\">  <span class=\"comment\">#       Started:      Sun, 08 Nov 2020 22:51:12 +0800</span></span><br><span class=\"line\">  <span class=\"comment\">#       Finished:     Sun, 08 Nov 2020 22:51:17 +0800</span></span><br><span class=\"line\">  <span class=\"comment\">#     Ready:          True</span></span><br><span class=\"line\">  <span class=\"comment\">#     Restart Count:  0</span></span><br><span class=\"line\">  <span class=\"comment\">#     Environment:    &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">#     Mounts:</span></span><br><span class=\"line\">  <span class=\"comment\">#       /var/run/secrets/kubernetes.io/serviceaccount from default-token-bk9vl (ro)</span></span><br><span class=\"line\">...</span><br><span class=\"line\">Events:  <span class=\"comment\"># Pod 创建 以及 容器创建的事件过程</span></span><br><span class=\"line\">  Type    Reason     Age   From               Message</span><br><span class=\"line\">  ----    ------     ----  ----               -------</span><br><span class=\"line\">  Normal  Scheduled  113s  default-scheduler  Successfully assigned <span class=\"built_in\">test</span>/myapp-pod to k8s-node-4</span><br><span class=\"line\"></span><br><span class=\"line\">  Normal  Pulling    113s  kubelet            Pulling image <span class=\"string\">\"busybox\"</span></span><br><span class=\"line\">  Normal  Pulled     108s  kubelet            Successfully pulled image <span class=\"string\">\"busybox\"</span> <span class=\"keyword\">in</span> 4.499850144s</span><br><span class=\"line\">  Normal  Created    108s  kubelet            Created container init-myservice</span><br><span class=\"line\">  Normal  Started    108s  kubelet            Started container init-myservice</span><br><span class=\"line\"></span><br><span class=\"line\">  Normal  Pulling    40s   kubelet            Pulling image <span class=\"string\">\"busybox\"</span></span><br><span class=\"line\">  Normal  Pulled     34s   kubelet            Successfully pulled image <span class=\"string\">\"busybox\"</span> <span class=\"keyword\">in</span> 5.078096509s</span><br><span class=\"line\">  Normal  Created    34s   kubelet            Created container init-mydb</span><br><span class=\"line\">  Normal  Started    34s   kubelet            Started container init-mydb</span><br><span class=\"line\"></span><br><span class=\"line\">  Normal  Pulling    28s   kubelet            Pulling image <span class=\"string\">\"busybox\"</span></span><br><span class=\"line\">  Normal  Pulled     25s   kubelet            Successfully pulled image <span class=\"string\">\"busybox\"</span> <span class=\"keyword\">in</span> 3.215811094s</span><br><span class=\"line\">  Normal  Created    25s   kubelet            Created container myapp-main-container</span><br><span class=\"line\">  Normal  Started    25s   kubelet            Started container myapp-main-container</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.在Init C容器启动完毕后，Main C进行启动正常后状态为Runing</span></span><br><span class=\"line\">weiyigeek@ubuntu:~$ kubectl get pod -n <span class=\"built_in\">test</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME        READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># myapp-pod   1/1     Running   0          2m8s</span></span><br></pre></td></tr></table></figure></p>\n<p>Tips : 如Pod重启了所有的Init Container将会重新运行，由于K8s禁止init Container使用 <code>readiness</code> 探针, 则可以使用Pod定义 activeDeadineSeconds (<code>包含 init Container 启动时间</code>) 和 Container 的 <code>livenessProbe</code> 防止 init 容器重复失败</p>\n<p><br/></p>\n<h4 id=\"Pod-容器探针\"><a href=\"#Pod-容器探针\" class=\"headerlink\" title=\"Pod 容器探针\"></a>Pod 容器探针</h4><p><strong>Q: 什么是容器探针(Probe)?</strong></p>\n<blockquote>\n<p>答: 探针是由各个节点(Node)的kubelet对容器执行的定期诊断，而执行诊断时kubelet需调用由容器实现的<code>Handler 处理程序</code>, 注意它不是在<code>Main C</code>之内这是为了便于减少主容器运行压力。</p>\n</blockquote>\n<p><br></p>\n<p><strong>Q: 为什么需要探针?</strong></p>\n<blockquote>\n<p>答: 对于线上业务来说保证服务的正常是稳定是重中之重,而对故障服务的及时处理避免影响业务以及快速恢复一直是开发运维的难点。而采用 K8s 提供的两种探针方式（readiness Probe、Liveness Probe）进行健康检查服务，如检测到故障服务将会被及时下线及通过重启服务的方式使服务自动恢复;</p>\n</blockquote>\n<p><br></p>\n<p><strong>Q: readiness Probe<code>英 /ˈredinəs/(准备就绪) 英 /prəʊb/</code> 与 liveness Probe<code>/laivnis/(生存)</code> 探测方式?</strong></p>\n<ul>\n<li><p><code>readiness Probe</code>【就绪指针或叫就绪探针-针对于服务】: 指示判断容器是否准备好<code>服务</code>请求。如果就绪探测失败（服务未加载或工作加载异常），端点控制器将从与 Pod 所匹配的Service 的端点中删除该Pod的IP地址。</p>\n<ul>\n<li>简单的说当服务没有Ready时会将其从服务的Load Balancer中移除，并不会再接受或者响应任何请求; </li>\n<li>如果容器不提供就绪探针, 则默认状态为Success；初始延迟之前的就绪状态默认为Failure。</li>\n</ul>\n</li>\n<li><p><code>liveness Probe</code>【存活指针或叫存活探针-针对于容器】: 指示判断<code>容器</code>是否正在运行。如果存活探测失败(服务Crash或者死锁等情况发送时)，则kubelet会杀死容器，而容器将受到其重启策略(<code>spec.restartPolicy: Always</code>)的影响进行重启容器或者分发到其它机器上进行运行;</p>\n<ul>\n<li>如果容器不提供存活探针, 则默认状态为Success;</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<p><strong>Q: 探针如何实现服务可用性与自动恢复?</strong></p>\n<blockquote>\n<p>1) 如服务的 Readiness Probe 健康检查失败, 则故障服务实例从Service Endpoint中剔除，外部请求将不会转发到该故障服务实例中;<br>2) 如对该故障服务实例设置了 Liveness 的探针将会失效， 并且该Container会被Kill掉，然后根据restartPolicy策略将会在当前节点重启容器或者其它可用节点重建容器;</p>\n</blockquote>\n<p>Tips : 如此时服务自我恢复了(网络问题导致)，其将会自动重新加入<code>Service Endpoint</code>对外提供服务, 基于上述机制整个服务实现了自身可用与自动恢复;</p>\n<p><br></p>\n<p><strong>Probe 探测反馈结果</strong></p>\n<blockquote>\n<p>成功(Success)：容器通过了诊断。<br>失败(Failure)：容器未通过诊断。<br>未知(Unknown)：诊断失败因此不会采取任何行动【这将导致容器挂死，因为探针不执行成功的话容器会一直在等待】</p>\n</blockquote>\n<p><br></p>\n<p><strong>Probe 监控检查方式</strong><br>Probe Handler 处理程序类型:</p>\n<blockquote>\n<p>ExecAction：在容器 Container 内执行指定 Shell 命令。 <code>如果命令退出时返回码为0则认为诊断成功。</code><br>TCPSocketAction: 对指定端口上的容器 Container 的IP地址、端口进行TCP检查。<code>如果端口打开则诊断被认为是成功的。</code><br>HTTPGetAction: 对指定的端口和路径上的容器 Container 的IP地址、端口、Path路径执行HTTPGet请求。<code>如果响应的状态码大于等于200且小于400 [2xx：成功，3xx：跳转] 则诊断被认为是成功的;</code></p>\n</blockquote>\n<p><br></p>\n<p><strong>Probe 使用建议</strong></p>\n<blockquote>\n<p>1.建议对全部服务实例同时设置 <code>服务 Readiness 探针</code> 和 <code>容器 Liveiness 探针</code>进行健康检查;<br>2.在对端口TCPSocketAction检测的同时一般建议使用ExecAction或者HTTPGetAction去进行健康检查;<br>3.无论采用哪种类型探针建议Readiness 探针的时间短于 Liveiness 探针时间，当然您也可以设置一致其目的都是为了将故障服务下线并等待恢复;</p>\n</blockquote>\n<p><br/></p>\n<p><strong>Probe 使用示例</strong></p>\n<ul>\n<li>(1) 就绪指针 or 就绪探针<br>readinessProbe字段: 定期检查集装箱<code>服务</code>准备情况(运行状态)<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl explain pod.spec.containers.readinessProbe | egrep <span class=\"string\">\"FIELDS|&gt;\"</span></span><br><span class=\"line\">RESOURCE: readinessProbe &lt;Object&gt;</span><br><span class=\"line\">FIELDS:</span><br><span class=\"line\">   <span class=\"built_in\">exec</span> &lt;Object&gt;</span><br><span class=\"line\">   httpGet      &lt;Object&gt;</span><br><span class=\"line\">   tcpSocket    &lt;Object&gt;</span><br><span class=\"line\">   initialDelaySeconds  &lt;<span class=\"built_in\">integer</span>&gt;</span><br><span class=\"line\">   periodSeconds        &lt;<span class=\"built_in\">integer</span>&gt;</span><br><span class=\"line\">   timeoutSeconds       &lt;<span class=\"built_in\">integer</span>&gt;</span><br><span class=\"line\">   failureThreshold     &lt;<span class=\"built_in\">integer</span>&gt;</span><br><span class=\"line\">   successThreshold     &lt;<span class=\"built_in\">integer</span>&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>简单实例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) httpGet 检测方案 </span></span><br><span class=\"line\">cat &gt; readinessProbe-httpget.yaml&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: v1 </span><br><span class=\"line\">kind: Pod </span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: readiness-httpget-pod </span><br><span class=\"line\">  namespace: <span class=\"built_in\">test</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: readiness-httpget-container </span><br><span class=\"line\">    image: harbor.weiyigeek.top/<span class=\"built_in\">test</span>/nginx:v2.2</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent <span class=\"comment\">#镜像下载策略如果存在则不下载</span></span><br><span class=\"line\">    readinessProbe: <span class=\"comment\"># 就绪探针</span></span><br><span class=\"line\">      httpGet:      <span class=\"comment\"># 检测方案</span></span><br><span class=\"line\">        port: 80             <span class=\"comment\"># 请求端口</span></span><br><span class=\"line\">        path: /index1.html   <span class=\"comment\"># 请求路径</span></span><br><span class=\"line\">      initialDelaySeconds: 1 <span class=\"comment\"># 初始化检测延时（1秒以后）</span></span><br><span class=\"line\">      timeoutSeconds: 1      <span class=\"comment\"># 请求等待超时时间 （1秒以后）</span></span><br><span class=\"line\">      periodSeconds: 3       <span class=\"comment\"># 重试的检测时间（3秒以后）</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 部署资源清单</span></span><br><span class=\"line\">~/K8s/Day4$ kubectl create -f readinessProbe-httpget.yaml</span><br><span class=\"line\">pod/readiness-httpget-pod created</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 查看 &amp; 结果</span></span><br><span class=\"line\">~/K8s/Day4$ kubectl get pod -n <span class=\"built_in\">test</span> | grep <span class=\"string\">\"readiness-httpget-pod\"</span></span><br><span class=\"line\">NAME                    READY   STATUS    RESTARTS   AGE   IP            NODE         NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">readiness-httpget-pod   1/1     Running   0          40m   10.244.1.14   k8s-node-4   &lt;none&gt;  &lt;none&gt;  <span class=\"comment\"># 可以看见READY不是就绪的 </span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">~/K8s/Day4$ kubectl describe -n <span class=\"built_in\">test</span> pod readiness-httpget-pod</span><br><span class=\"line\">  <span class=\"comment\"># Events:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Type     Reason     Age                      From               Message</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----     ------     ----                     ----               -------</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Scheduled  7m35s                    default-scheduler  Successfully assigned test/readiness-httpget-pod to k8s-node-4</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Pulling    7m35s                    kubelet            Pulling image \"harbor.weiyigeek.top/test/nginx:v2.2\"</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Pulled     7m35s                    kubelet            Successfully pulled image \"harbor.weiyigeek.top/test/nginx:v2.2\" in 179.781569ms</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Created    7m34s                    kubelet            Created container readiness-httpget-container</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Started    7m34s                    kubelet            Started container readiness-httpget-container</span></span><br><span class=\"line\">  Warning  Unhealthy  2m32s (x101 over 7m32s)  kubelet            Readiness probe failed: HTTP probe failed with statuscode: 404  <span class=\"comment\"># 关键点</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 进入容器中创建index1.html文件</span></span><br><span class=\"line\">~/K8s/Day4$ kubectl <span class=\"built_in\">exec</span> -n <span class=\"built_in\">test</span> readiness-httpget-pod -it sh</span><br><span class=\"line\">  <span class=\"comment\"># echo \"readiness-httpget-pod\" &gt; /usr/share/nginx/html/index1.html</span></span><br><span class=\"line\">  <span class=\"comment\"># ls /usr/share/nginx/html/</span></span><br><span class=\"line\">  <span class=\"comment\"># 50x.html  host.html  index.html  index1.html</span></span><br><span class=\"line\"></span><br><span class=\"line\">~/K8s/Day4$ curl http://10.244.1.14/index1.html</span><br><span class=\"line\"><span class=\"comment\"># readiness-httpget-pod</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 添加文件后容器状态的转变</span></span><br><span class=\"line\">~/K8s/Day4$ kubectl get pod -n <span class=\"built_in\">test</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                    READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># readiness-httpget-pod   1/1     Running   0          9m28s  # 此时可以看见READY已经就绪</span></span><br><span class=\"line\"></span><br><span class=\"line\">~/K8s/Day4$  kubectl logs -n <span class=\"built_in\">test</span> readiness-httpget-pod</span><br><span class=\"line\">  <span class=\"comment\"># 2020/11/09 08:37:06 [error] 9#9: *128 open() \"/usr/share/nginx/html/index1.html\" failed (2: No such file or directory), client: 10.244.1.1, server: localhost, request: \"GET /index1.html HTTP/1.1\", host: \"10.244.1.14:80\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 10.244.1.1 - - [09/Nov/2020:08:37:06 +0000] \"GET /index1.html HTTP/1.1\" 404 153 \"-\" \"kube-probe/1.19\" \"-\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 10.244.1.1 - - [09/Nov/2020:08:37:09 +0000] \"GET /index1.html HTTP/1.1\" 200 22 \"-\" \"kube-probe/1.19\" \"-\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<ul>\n<li>(2) 存活指针 or 存活探针<br>HttpGet方式: 即 通过 Http 请求的方式验证应用服务或者Pod容器是否正常运行;<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">liveness-httpget-pod</span> </span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">default</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">liveness-httpget-container</span> </span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">harbor.weiyigeek.top/test/nginx:v2.2</span></span><br><span class=\"line\"><span class=\"attr\">    imagePu11Policy:</span> <span class=\"string\">IfNotPresent</span> </span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">http</span> </span><br><span class=\"line\"><span class=\"attr\">      containerPort:</span> <span class=\"number\">80</span> </span><br><span class=\"line\">    <span class=\"number\">1</span><span class=\"attr\">ivenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">      httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span> <span class=\"string\">http</span> </span><br><span class=\"line\"><span class=\"attr\">        path:</span> <span class=\"string\">/index.html</span> </span><br><span class=\"line\"><span class=\"attr\">        httpHeaders:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">X-Custom-Header</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">WeiyiGeek</span></span><br><span class=\"line\"><span class=\"attr\">      initialDelaySeconds:</span> <span class=\"number\">1</span>  <span class=\"comment\"># 延迟1秒以后开始检测</span></span><br><span class=\"line\"><span class=\"attr\">      timeoutSeconds:</span> <span class=\"number\">10</span>      <span class=\"comment\"># 每次访问时最大的超时时间</span></span><br><span class=\"line\"><span class=\"attr\">      periodSeconds:</span> <span class=\"number\">3</span>        <span class=\"comment\"># 每3秒重复检测一次</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p>Exec方式: 即通过验证容器中服务正常启动后的标志性文件是被存在创建;<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">liveness-exec-pod</span> </span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">test</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">liveness-exec-container</span> </span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">hub.coreqi.cn/1ibrary/busybox</span> </span><br><span class=\"line\"><span class=\"attr\">    imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span> </span><br><span class=\"line\"><span class=\"attr\">    command:</span> <span class=\"string\">[\"/bin/sh\",\"-c\",\"touch</span> <span class=\"string\">/tmp/live;sleep</span> <span class=\"number\">60</span><span class=\"string\">;rm</span> <span class=\"bullet\">-rf</span> <span class=\"string\">/tmp/live;sleep</span> <span class=\"number\">3600</span><span class=\"string\">\"] </span></span><br><span class=\"line\"><span class=\"string\">    livenessProbe:  #探活指针</span></span><br><span class=\"line\"><span class=\"string\">      exec: #执行命令</span></span><br><span class=\"line\"><span class=\"string\">        command: [\"</span><span class=\"string\">test\",\"-e\",\"/tmp/live\"]</span> <span class=\"comment\">#检测文件是否存在</span></span><br><span class=\"line\"><span class=\"attr\">      initialDelaySeconds:</span> <span class=\"number\">1</span>     <span class=\"comment\"># 容器启动1秒后执行</span></span><br><span class=\"line\"><span class=\"attr\">      periodSeconds:</span> <span class=\"number\">3</span>           <span class=\"comment\"># 重试的循环时间为3秒</span></span><br></pre></td></tr></table></figure></p>\n<p>Tcp方式: 我们以此方式进行演示上面与下面的操作与之类似;<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ~/K8s/Day4/livenessProbe-tcpSocket.yaml &lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">livenessprobe-tcpsocket</span>  <span class=\"comment\"># 注意只能小写</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">nginx</span> </span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">harbor.weiyigeek.top/test/nginx:v2.2</span></span><br><span class=\"line\"><span class=\"attr\">    livenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">      tcpSocket:</span></span><br><span class=\"line\"><span class=\"attr\">        port:</span> <span class=\"number\">81</span>             <span class=\"comment\"># 检测 81 端口 (实际启动的端口是80所以它会一直重试检测)</span></span><br><span class=\"line\"><span class=\"attr\">      initialDelaySeconds:</span> <span class=\"number\">5</span> <span class=\"comment\"># 初始化后5s执行 </span></span><br><span class=\"line\"><span class=\"attr\">      timeoutSeconds:</span> <span class=\"number\">1</span>      <span class=\"comment\"># 连接超时</span></span><br><span class=\"line\"><span class=\"attr\">      periodSeconds:</span> <span class=\"number\">3</span>       <span class=\"comment\"># 重试间隔3s </span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p>操作步骤:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.部署资源清单</span></span><br><span class=\"line\">~/K8s/Day4$ kubectl create -f livenessProbe-tcpSocket.yaml</span><br><span class=\"line\">  <span class=\"comment\"># pod/livenessprobe-tcpsocket created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.结果查看(关键点)</span></span><br><span class=\"line\">~/K8s/Day4$ kubectl get pod -n <span class=\"built_in\">test</span> -o wide</span><br><span class=\"line\">  <span class=\"comment\"># NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class=\"line\">  <span class=\"comment\"># livenessprobe-tcpsocket   1/1     Running   0   起初       23s     10.244.1.15   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">~/K8s/Day4$  kubectl get pod -n <span class=\"built_in\">test</span> -o wide -w  <span class=\"comment\">#  生命周期内探测为满足条件退出 重启 </span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class=\"line\">  <span class=\"comment\"># livenessprobe-tcpsocket   1/1     Running   2  关键点   91s     10.244.1.15   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># ....</span></span><br><span class=\"line\">  <span class=\"comment\"># livenessprobe-tcpsocket   1/1     Running   3          2m7s    10.244.1.15   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># .... 5次重启后探测还未通过，返回崩溃循环 并且此时状态NotReady  </span></span><br><span class=\"line\">  <span class=\"comment\"># livenessprobe-tcpsocket   0/1     CrashLoopBackOff   5   4m13s   10.244.1.15   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># livenessprobe-tcpsocket   1/1     Running            6   5m42s   10.244.1.15   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># livenessprobe-tcpsocket   0/1     CrashLoopBackOff   6   6m26s   10.244.1.15   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.Pod 运行事件查看详细信息</span></span><br><span class=\"line\">~/K8s/Day4$ kubectl describe pod -n <span class=\"built_in\">test</span> livenessprobe-tcpsocket</span><br><span class=\"line\">  <span class=\"comment\"># Events:  # 通过Eventsxiang详细描述信息可知Contianer liveness不健康，其将被Kill掉重新生成。</span></span><br><span class=\"line\">  <span class=\"comment\">#   Type     Reason     Age                    From               Message</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----     ------     ----                   ----               -------</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Scheduled  8m7s                   default-scheduler  Successfully assigned test/livenessprobe-tcpsocket to k8s-node-4</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Killing    6m30s (x3 over 7m54s)  kubelet            Container nginx failed liveness probe, will be restarted</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Pulled     6m (x4 over 8m6s)      kubelet            Container image \"harbor.weiyigeek.top/test/nginx:v2.2\" already present on machine</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Created    6m (x4 over 8m6s)      kubelet            Created container nginx</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal   Started    6m (x4 over 8m6s)      kubelet            Started container nginx</span></span><br><span class=\"line\">  <span class=\"comment\">#  Liveness probe 检测信息</span></span><br><span class=\"line\">  <span class=\"comment\"># Warning  Unhealthy  5m54s (x10 over 8m)    kubelet            Liveness probe failed: dial tcp 10.244.1.15:81: connect: connection refused</span></span><br><span class=\"line\">  <span class=\"comment\"># Warning  BackOff    3m5s (x6 over 3m54s)   kubelet            Back-off restarting failed container</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Init Container 使用示例: 一个用来检查 redis 是否启动成功，另外一个用来检查 mysql 是否启动成功，开始部署的时候，首先会通过 nslookup 检查 redis 是否成功启动，检测到 redis 启动了之后，域名解析也就会成功，然后会检查 mysql 的状态 mysql 也成功启动之后才会开始启动 <code>reservation-server</code> container。<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">myapp-pod</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">reservation-server</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">weiyigeek/activityreservation:dev</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">        containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">    livenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">        httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/health</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">        initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\"><span class=\"attr\">        periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">    readinessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">        httpGet:</span></span><br><span class=\"line\"><span class=\"attr\">            path:</span> <span class=\"string\">/api/notice</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">        initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\"><span class=\"attr\">        periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"attr\">  initContainers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">init-redis</span></span><br><span class=\"line\"><span class=\"attr\">      image:</span> <span class=\"attr\">busybox:1.31</span></span><br><span class=\"line\"><span class=\"attr\">      command:</span> <span class=\"string\">['sh',</span> <span class=\"string\">'-c'</span><span class=\"string\">,</span> <span class=\"string\">'until nslookup redis-server; do echo waiting for redis; sleep 2; done;'</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">init-mysql</span></span><br><span class=\"line\"><span class=\"attr\">      image:</span> <span class=\"attr\">busybox:1.31</span></span><br><span class=\"line\"><span class=\"attr\">      command:</span> <span class=\"string\">['sh',</span> <span class=\"string\">'-c'</span><span class=\"string\">,</span> <span class=\"string\">'until nslookup mysql-server; do echo waiting for mysql; sleep 2; done;'</span><span class=\"string\">]</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"Pod-Hook\"><a href=\"#Pod-Hook\" class=\"headerlink\" title=\"Pod Hook\"></a>Pod Hook</h4><p>描述: Pod hook（钩子）是由Kubernetes管理的kubelet发起的，它在Pod生命周期（Pod Lifecycle）内提供两种钩子 (Hook) 分别在容器中的<code>进程启动前 (postStart)</code>或<code>者容器中的进程终止之前 (preStop)</code>运行，可以同时为Pod中的所有容器都配置 hook, 它们包含在容器的生命周期之中。</p>\n<p><strong>Hook 事件分类:</strong></p>\n<ul>\n<li>1) PostStart: 在容器创建启动之后PostStart Hook将会被立即执行，值得注意的是容器里的Entrypoint 和 Poststart的执行顺序前后并不确定</li>\n<li>2) PreStart: 在容器被终止之前执行采用一种阻塞式的方式，即在PreStop Hook执行完毕之后销毁容器的动作才会执行;</li>\n</ul>\n<p><br/></p>\n<p><strong>Hook Handler 分类：</strong><br>描述: 容器通过实现和注册一个Handler来实现对Hook的访问有两种类型的 <code>Hook Handlers</code>;</p>\n<ul>\n<li>exec: 执行 一个 Shell命令</li>\n<li>http：向 一个endpoint 发送HTTP请求</li>\n</ul>\n<p>Tips : 如果 <code>PostStart</code> 或 <code>PreStop</code> hook 执行失败容器将会被Kill掉;</p>\n<p><br/></p>\n<p>简单实例: 在 Pod 生存周期内在容器创建或者在容器结束时, 指定执行的命令或者脚本;</p>\n<ul>\n<li><p>1.将镜像上传到Harbor仓库之中</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker tag nginx:latest harbor.weiyigeek.top/<span class=\"built_in\">test</span>/nginx:latest</span><br><span class=\"line\">$ docker push harbor.weiyigeek.top/<span class=\"built_in\">test</span>/nginx:latest</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.Pod资源清单的编写</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">kubectl</span> <span class=\"string\">explain</span> <span class=\"string\">Pod.spec.containers.lifecycle</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ~/K8s/Day4/lifecycle-demoStartStop.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">lifecycle-demo</span> </span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span> </span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">lifecycle-demo-container</span> </span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">harbor.weiyigeek.top/test/nginx</span></span><br><span class=\"line\"><span class=\"attr\">    imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">    lifecycle:</span>    <span class=\"comment\"># [重点生存周期] </span></span><br><span class=\"line\"><span class=\"attr\">      postStart:</span>  <span class=\"comment\"># 启动时运行</span></span><br><span class=\"line\"><span class=\"attr\">        exec:</span></span><br><span class=\"line\"><span class=\"attr\">          command:</span> <span class=\"string\">[\"/bin/sh\",\"-c\",\"echo</span> <span class=\"string\">$&#123;HOSTNAME&#125;,$&#123;NGINX_VERSION&#125;&gt;</span> <span class=\"string\">/usr/share/nginx/html/info.html\"]</span> </span><br><span class=\"line\"><span class=\"attr\">      preStop:</span>    <span class=\"comment\"># 退出时运行(需要正常退出防止数据损坏)</span></span><br><span class=\"line\"><span class=\"attr\">        exec:</span> </span><br><span class=\"line\"><span class=\"attr\">          command:</span> <span class=\"string\">[\"/usr/sbin/nginx\",\"-s\",\"quit\"]</span></span><br><span class=\"line\"><span class=\"attr\">  restartPolicy:</span> <span class=\"string\">OnFailure</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.部署资源清单与部署信息查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 执行部署</span></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day4$ kubectl create -f lifecycle-demoStartStop.yaml</span><br><span class=\"line\">  <span class=\"comment\"># pod/lifecycle-demo created</span></span><br><span class=\"line\"></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day4$ kubectl get pod -n <span class=\"built_in\">test</span> -o wide | grep <span class=\"string\">\"lifecycle-demo\"</span></span><br><span class=\"line\">  <span class=\"comment\"># lifecycle-demo   1/1     Running   0          41s   10.244.1.13   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day4$ kubectl logs -n <span class=\"built_in\">test</span> lifecycle-demo</span><br><span class=\"line\">  <span class=\"comment\"># /docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span></span><br><span class=\"line\">  <span class=\"comment\"># /docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/</span></span><br><span class=\"line\">  <span class=\"comment\"># /docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span></span><br><span class=\"line\">  <span class=\"comment\"># 10-listen-on-ipv6-by-default.sh: Getting the checksum of /etc/nginx/conf.d/default.conf</span></span><br><span class=\"line\">  <span class=\"comment\"># 10-listen-on-ipv6-by-default.sh: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf</span></span><br><span class=\"line\">  <span class=\"comment\"># /docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span></span><br><span class=\"line\">  <span class=\"comment\"># /docker-entrypoint.sh: Configuration complete; ready for start up</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 访问查看</span></span><br><span class=\"line\">~/K8s/Day4$ curl http://10.244.1.13/info.html</span><br><span class=\"line\">  <span class=\"comment\"># lifecycle-demo,1.19.4</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 停止主容器然后删除Pod</span></span><br><span class=\"line\">kubectl delete -f lifecycle-demoStartStop.yaml</span><br><span class=\"line\">  <span class=\"comment\"># pod \"lifecycle-demo\" deleted</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p> 命令补充说明<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 删除Deployment创建的所有Pod</span></span><br><span class=\"line\">~$ kubectl get deployment</span><br><span class=\"line\">  NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">  nginx-deployment   3/3     3            3           2d14h</span><br><span class=\"line\"></span><br><span class=\"line\">~$ kubectl delete deployment --all <span class=\"comment\"># 先删除deployment</span></span><br><span class=\"line\">  deployment.apps <span class=\"string\">\"nginx-deployment\"</span> deleted</span><br><span class=\"line\"></span><br><span class=\"line\">~$ kubectl delete pod --all</span><br><span class=\"line\">  pod <span class=\"string\">\"nginx-deployment-7f5d9779c6-dr5h8\"</span> deleted</span><br><span class=\"line\">  pod <span class=\"string\">\"nginx-deployment-7f5d9779c6-hhl7k\"</span> deleted</span><br><span class=\"line\">  pod <span class=\"string\">\"nginx-deployment-7f5d9779c6-sk2f4\"</span> deleted</span><br><span class=\"line\"></span><br><span class=\"line\">~$ kubectl delete svc nginx-deployment</span><br><span class=\"line\"></span><br><span class=\"line\">~$ kubectl <span class=\"built_in\">exec</span> nginx-deployment-7f5d9779c6-dr5h8 -it -- /bin/sh env</span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_SERVICE_PORT=443</span></span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_PORT=tcp://10.96.0.1:443</span></span><br><span class=\"line\">  <span class=\"comment\"># HOSTNAME=nginx-deployment-7f5d9779c6-dr5h8</span></span><br><span class=\"line\">  <span class=\"comment\"># HOME=/root</span></span><br><span class=\"line\">  <span class=\"comment\"># PKG_RELEASE=1~buster</span></span><br><span class=\"line\">  <span class=\"comment\"># TERM=xterm</span></span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1</span></span><br><span class=\"line\">  <span class=\"comment\"># NGINX_VERSION=1.19.4</span></span><br><span class=\"line\">  <span class=\"comment\"># PATH=/usr/local/nginx/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_PORT_443_TCP_PORT=443</span></span><br><span class=\"line\">  <span class=\"comment\"># NJS_VERSION=0.4.4</span></span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_PORT_443_TCP_PROTO=tcp</span></span><br><span class=\"line\">  <span class=\"comment\"># IMAGE_VERSION=2.2</span></span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_SERVICE_PORT_HTTPS=443</span></span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_PORT_443_TCP=tcp://10.96.0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建pod的Init容器查看</span></span><br><span class=\"line\">kubectl get pod</span><br><span class=\"line\">kubecrl describe pod</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":null,"categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"k8s","path":"api/tags/k8s.json"}]}