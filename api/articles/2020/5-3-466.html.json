{"title":"Dockerå®¹å™¨é•œåƒä»“åº“å­˜å‚¨åŸç†(å‰ä¸–ä»Šèº«)ä¸æ¬è¿æŠ€å·§","slug":"è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Docker/å¥‡æŠ€æ·«å·§/2.Dockerå®¹å™¨é•œåƒä»“åº“å­˜å‚¨åŸç†ä¸æŠ€å·§","date":"2020-05-03T06:36:30.000Z","updated":"2023-01-31T02:29:10.643Z","url":"2020/5-3-466.html","path":"api/articles/2020/5-3-466.html.json","covers":["https://img.weiyigeek.top/2020/1/20200805172819.png","https://img.weiyigeek.top/2021/5/20220122222420.png","https://img.weiyigeek.top/2020/1/20200801101456.png","https://img.weiyigeek.top/2020/1/20200803161619.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-é•œåƒå¦‚ä½•ç‚¼æˆ\"><a href=\"#0x00-é•œåƒå¦‚ä½•ç‚¼æˆ\" class=\"headerlink\" title=\"0x00 é•œåƒå¦‚ä½•ç‚¼æˆ\"></a>0x00 é•œåƒå¦‚ä½•ç‚¼æˆ</h4><p>åœ¨æ·±å…¥å­¦ä¹ é•œåƒä¹‹å‰æˆ‘ä»¬éœ€è¦çŸ¥é“é•œåƒæ˜¯å¦‚ä½•<code>(ç‚¼åˆ¶/æ“)</code>æˆçš„(ç­‰åŒäºæ„å»ºé•œåƒ)ï¼Œå½“ç„¶æ˜¯é€šè¿‡æˆ‘ä»¬DockerFileä¸€æ¡æ¡æŒ‡ä»¤ä¸ºé•œåƒç”Ÿæˆæ¯ä¸€å±‚ï¼ŒæŒ‰ç…§æ‰§è¡Œé¡ºåºé•œåƒæ–‡ä»¶ç³»ç»Ÿå¤å†™å°è£…ä»ä¸‹åˆ°ä¸Š;</p>\n<h5 id=\"1-OCI-æ ‡å‡†åè®®\"><a href=\"#1-OCI-æ ‡å‡†åè®®\" class=\"headerlink\" title=\"1.OCI æ ‡å‡†åè®®\"></a>1.OCI æ ‡å‡†åè®®</h5><p>å…³äºå®¹å™¨é•œåƒçš„OCIæ ‡å‡†åè®®ï¼Œé‚£ä»€ä¹ˆåˆæ˜¯OCIæ ‡å‡†åè®®?</p>\n<blockquote>\n<p>ç­”: Open Container Initiative(æ‰“å¼€é›†è£…ç®±å€¡è®®)æ—¨åœ¨å›´ç»•å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ¶å®šä¸€ä¸ªå¼€æ”¾çš„å·¥ä¸šåŒ–æ ‡å‡†; </p>\n<p>å‚è€ƒåœ°å€ï¼š<a href=\"https://wilhelmguo.cn/blog/post/william/%E5%AE%B9%E5%99%A8%E5%BC%80%E6%94%BE%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83%EF%BC%88CRI-OCI%EF%BC%89-2\" target=\"_blank\" rel=\"noopener\">å®¹å™¨å¼€æ”¾æ¥å£è§„èŒƒ(CRI OCI)</a></p>\n</blockquote>\n<p> Docker å…¬å¸ä¸ CoreOS å’Œ Google å…±åŒåˆ›å»ºäº† OCI (Open Container Initial)ï¼Œå¹¶æä¾›äº†ä¸‰ç§è§„èŒƒ</p>\n<ul>\n<li>é•œåƒè§„èŒƒ image-spec : åˆ¶å®šé•œåƒæ ¼å¼ã€æ“ä½œç­‰ (<a href=\"https://github.com/opencontainers/image-spec\" target=\"_blank\" rel=\"noopener\">https://github.com/opencontainers/image-spec</a>)</li>\n<li>è¿è¡Œæ—¶è§„èŒƒ runtime-spec :  æè¿°å¦‚ä½•è¿è¡Œfilesystem bundle (<a href=\"https://github.com/opencontainers/runtime-spec\" target=\"_blank\" rel=\"noopener\">https://github.com/opencontainers/runtime-spec</a>)</li>\n<li>é•œåƒä»“åº“è§„èŒƒ distribution-spec (<code>ä¸å¸¸è§</code>)</li>\n</ul>\n<p><br></p>\n<p>å…³äº OCI è§„èŒƒçš„ä½œç”¨è¯´æ˜:</p>\n<ul>\n<li>1.åˆ¶å®šå®¹å™¨æ ¼å¼æ ‡å‡†çš„å®—æ—¨å°±æé«˜é•œåƒé€šç”¨æ€§ä»¥ä¾¿<code>ä¸é™äºæŸç§ç‰¹å®šæ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ã€CPUæ¶æ„ã€å…¬æœ‰äº‘</code>ç­‰; æ¦‚æ‹¬æ¥è¯´å°±æ˜¯<code>ä¸å—ä¸Šå±‚ç»“æ„çš„ç»‘å®šï¼Œå¦‚ç‰¹å®šçš„å®¢æˆ·ç«¯ã€ç¼–æ’æ ˆ</code>ç­‰</li>\n<li>2.ä¸¤ä¸ªåè®®é€šè¿‡ <code>OCI runtime filesytem bundle</code>çš„æ ‡å‡†æ ¼å¼è¿æ¥åœ¨ä¸€èµ·ï¼ŒOCI é•œåƒå¯ä»¥é€šè¿‡å·¥å…·è½¬æ¢æˆbundleç„¶åOCIå®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨, å…¶ä¼˜ç‚¹å¦‚ä¸‹;<ul>\n<li>æ“ä½œæ ‡å‡†åŒ–ï¼šå®¹å™¨çš„æ ‡å‡†åŒ–æ“ä½œåŒ…æ‹¬ä½¿ç”¨æ ‡å‡†å®¹å™¨åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å®¹å™¨ï¼Œä½¿ç”¨æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿå·¥å…·å¤åˆ¶å’Œåˆ›å»ºå®¹å™¨å¿«ç…§ï¼Œä½¿ç”¨æ ‡å‡†åŒ–ç½‘ç»œå·¥å…·è¿›è¡Œä¸‹è½½å’Œä¸Šä¼ ã€‚</li>\n<li>å†…å®¹æ— å…³ï¼šå†…å®¹æ— å…³æŒ‡ä¸ç®¡é’ˆå¯¹çš„å…·ä½“å®¹å™¨å†…å®¹æ˜¯ä»€ä¹ˆï¼Œå®¹å™¨æ ‡å‡†æ“ä½œæ‰§è¡Œåéƒ½èƒ½äº§ç”ŸåŒæ ·çš„æ•ˆæœã€‚å¦‚å®¹å™¨å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼ä¸Šä¼ ã€å¯åŠ¨ï¼Œä¸ç®¡æ˜¯PHPåº”ç”¨è¿˜æ˜¯MySQLæ•°æ®åº“æœåŠ¡ã€‚</li>\n<li>åŸºç¡€è®¾æ–½æ— å…³ï¼šæ— è®ºæ˜¯ä¸ªäººçš„ç¬”è®°æœ¬ç”µè„‘è¿˜æ˜¯AWS S3ï¼Œäº¦æˆ–æ˜¯OpenStackï¼Œæˆ–è€…å…¶å®ƒåŸºç¡€è®¾æ–½ï¼Œéƒ½åº”è¯¥å¯¹æ”¯æŒå®¹å™¨çš„å„é¡¹æ“ä½œã€‚</li>\n<li>ä¸ºè‡ªåŠ¨åŒ–é‡èº«å®šåˆ¶ï¼šåˆ¶å®šå®¹å™¨ç»Ÿä¸€æ ‡å‡†ï¼Œæ˜¯çš„æ“ä½œå†…å®¹æ— å…³åŒ–ã€å¹³å°æ— å…³åŒ–çš„æ ¹æœ¬ç›®çš„ä¹‹ä¸€ï¼Œå°±æ˜¯ä¸ºäº†å¯ä»¥ä½¿å®¹å™¨æ“ä½œå…¨å¹³å°è‡ªåŠ¨åŒ–ã€‚</li>\n<li>å·¥ä¸šçº§äº¤ä»˜ï¼šåˆ¶å®šå®¹å™¨æ ‡å‡†ä¸€å¤§ç›®æ ‡ï¼Œå°±æ˜¯ä½¿è½¯ä»¶åˆ†å‘å¯ä»¥è¾¾åˆ°å·¥ä¸šçº§äº¤ä»˜æˆä¸ºç°å®</li>\n</ul>\n</li>\n</ul>\n<p>å‚è€ƒæ¥æº:</p>\n<ul>\n<li>1.OCI é•œåƒè§„èŒƒçš„ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ª markdown æ–‡ä»¶ç»„æˆï¼š<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â”œâ”€â”€ annotations.md         <span class=\"comment\"># æ³¨è§£è§„èŒƒ</span></span><br><span class=\"line\">â”œâ”€â”€ config.md              <span class=\"comment\"># image config æ–‡ä»¶è§„èŒƒ</span></span><br><span class=\"line\">â”œâ”€â”€ considerations.md      <span class=\"comment\"># æ³¨æ„äº‹é¡¹</span></span><br><span class=\"line\">â”œâ”€â”€ conversion.md          <span class=\"comment\"># è½¬æ¢ä¸º OCI è¿è¡Œæ—¶</span></span><br><span class=\"line\">â”œâ”€â”€ descriptor.md          <span class=\"comment\"># OCI Content Descriptors å†…å®¹æè¿°</span></span><br><span class=\"line\">â”œâ”€â”€ image-index.md         <span class=\"comment\"># manifest list æ–‡ä»¶</span></span><br><span class=\"line\">â”œâ”€â”€ image-layout.md        <span class=\"comment\"># é•œåƒçš„å¸ƒå±€</span></span><br><span class=\"line\">â”œâ”€â”€ implementations.md     <span class=\"comment\"># ä½¿ç”¨ OCI è§„èŒƒçš„é¡¹ç›®</span></span><br><span class=\"line\">â”œâ”€â”€ layer.md               <span class=\"comment\"># é•œåƒå±‚ layer è§„èŒƒ</span></span><br><span class=\"line\">â”œâ”€â”€ manifest.md            <span class=\"comment\"># manifest è§„èŒƒ</span></span><br><span class=\"line\">â”œâ”€â”€ media-types.md         <span class=\"comment\"># æ–‡ä»¶ç±»å‹</span></span><br><span class=\"line\">â”œâ”€â”€ README.md              <span class=\"comment\"># README æ–‡æ¡£</span></span><br><span class=\"line\">â”œâ”€â”€ spec.md                <span class=\"comment\"># OCI é•œåƒè§„èŒƒçš„æ¦‚è§ˆ</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<ul>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/master/manifest.md\" target=\"_blank\" rel=\"noopener\">Image Manifest</a> - a document describing the components that make up a container image | æè¿°äº†æ„æˆå®¹å™¨çš„å›¾åƒçš„éƒ¨ä»¶çš„æ–‡æ¡£</li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/master/image-index.md\" target=\"_blank\" rel=\"noopener\">Image Index</a> - an annotated index of image manifests | å›¾åƒæ¸…å•çš„å¸¦æ³¨é‡Šç´¢å¼•</li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/master/image-layout.md\" target=\"_blank\" rel=\"noopener\">Image Layout</a> - a filesystem layout representing the contents of an image | è¡¨ç¤ºå›¾åƒçš„å†…å®¹çš„æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€</li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/master/layer.md\" target=\"_blank\" rel=\"noopener\">Filesystem Layer</a> - a changeset that describes a containerâ€™s filesystem | æè¿°ä¸€ä¸ªå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„å˜æ›´</li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/master/config.md\" target=\"_blank\" rel=\"noopener\">Image Configuration</a> - a document determining layer ordering and configuration of the image suitable for translation into a <a href=\"https://github.com/opencontainers/runtime-spec\" target=\"_blank\" rel=\"noopener\">runtime bundle</a> | æ–‡æ¡£ç¡®å®šå±‚çš„æ’åºå’Œé€‚åˆç¿»è¯‘çš„å›¾åƒçš„é…ç½®åˆ°è¿è¡Œæ—¶çš„æŸ</li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/master/conversion.md\" target=\"_blank\" rel=\"noopener\">Conversion</a> - a document describing how this translation should occur | æè¿°åº”è¯¥æ˜¯å¦‚ä½•å‘ç”Ÿè¿™ç§è½¬æ¢çš„æ–‡æ¡£</li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/master/descriptor.md\" target=\"_blank\" rel=\"noopener\">Descriptor</a> - a reference that describes the type, metadata and content address of referenced content | æè¿°çš„ç±»å‹ï¼Œå…ƒæ•°æ®å’Œå¼•ç”¨çš„å†…å®¹çš„å†…å®¹åœ°å€çš„å¼•ç”¨</li>\n</ul>\n</blockquote>\n<ul>\n<li>2.OCI è§„èŒƒæ˜¯å…è´¹çš„å“¦ï¼Œä¸åƒå¤§å¤šæ•° ISO è§„èŒƒè¿˜è¦äº¤é’±æ‰èƒ½çœ‹ï¼ˆï¸¶^ï¸¶ï¼‰å“¼ã€‚</li>\n</ul>\n<p><br></p>\n<h6 id=\"image-spec-é•œåƒè§„èŒƒ\"><a href=\"#image-spec-é•œåƒè§„èŒƒ\" class=\"headerlink\" title=\"image-spec - é•œåƒè§„èŒƒ\"></a>image-spec - é•œåƒè§„èŒƒ</h6><p>æè¿°:å®ƒå†³å®šäº†æˆ‘ä»¬é•œåƒ<code>æŒ‰ç…§ä»€ä¹ˆæ ‡å‡†æ¥æ„å»º</code>ï¼Œä»¥åŠ<code>æ„å»ºå®Œé•œåƒä¹‹åå¦‚ä½•å­˜æ”¾</code>ï¼Œæ¥ç€ä¸‹æ–‡æåˆ°çš„ Dockerfile åˆ™å†³å®šäº†é•œåƒçš„ layer å†…å®¹ä»¥åŠé•œåƒçš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ã€‚</p>\n<p>ç›´ç™½çš„è¯´ä¸€ä¸ªé•œåƒè§„èŒƒ image-spec å’Œä¸€ä¸ª Dockerfile å°±æŒ‡å¯¼ç€æˆ‘ä»¬æ„å»ºä¸€ä¸ªé•œåƒ;</p>\n<p>æ€»ç»“ä»¥ä¸Šå‡ ä¸ª markdown æ–‡ä»¶ OCI å®¹å™¨é•œåƒè§„èŒƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ å—å†…å®¹:</p>\n<ul>\n<li><p>Layer : Docker ä»¥ layer (é•œåƒå±‚) ä¿å­˜çš„æ–‡ä»¶ç³»ç»Ÿä»¥åŠæ¯ä¸ªLayerä¿å­˜ä¸ä¸Šå±‚ä¹‹é—´å˜åŒ–éƒ¨åˆ†ï¼Œä»¥åŠå¯¹ä¿å­˜å“ªäº›æ–‡ä»¶ï¼Œæ€ä¹ˆè¡¨ç¤ºå¢åŠ ã€ä¿®æ”¹å’Œåˆ é™¤çš„æ–‡ä»¶ç­‰è¿›è¡Œæè¿°;</p>\n</li>\n<li><p>Image-Config : ä¿å­˜äº†æ–‡ä»¶ç³»ç»Ÿçš„å±‚çº§ä¿¡æ¯ï¼ˆ<code>æ¯ä¸ªå±‚çº§çš„ hash å€¼ï¼Œä»¥åŠå†å²ä¿¡æ¯</code>ï¼‰ä»¥åŠå®¹å™¨è¿è¡Œæ—¶éœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼ˆæ¯”å¦‚ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€å‘½ä»¤å‚æ•°ã€mount åˆ—è¡¨ï¼‰ï¼ŒæŒ‡å®šäº†é•œåƒåœ¨æŸä¸ªç‰¹å®šå¹³å°å’Œç³»ç»Ÿçš„é…ç½®:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ¯”è¾ƒæ¥è¿‘æˆ‘ä»¬ä½¿ç”¨ docker inspect &lt;image|id&gt; çœ‹åˆ°çš„å†…å®¹</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"architecture\"</span>: <span class=\"string\">\"amd64\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"User\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdout\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStderr\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Env\"</span>: [<span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span>],</span><br><span class=\"line\">    <span class=\"string\">\"Cmd\"</span>: [<span class=\"string\">\"bash\"</span>],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Volumes\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"WorkingDir\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Entrypoint\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"OnBuild\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"Labels\"</span>: null</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"container\"</span>: <span class=\"string\">\"38501d5aa48c080884f4dc6fd4b1b6590ff1607d9e7a12e1cef1d86a3fdc32df\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"container_config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"38501d5aa48c\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"User\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdout\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStderr\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Env\"</span>: [<span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span>],</span><br><span class=\"line\">    <span class=\"string\">\"Cmd\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"/bin/sh\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"-c\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"#(nop) \"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"CMD [\\\"bash\\\"]\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Volumes\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"WorkingDir\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Entrypoint\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"OnBuild\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"Labels\"</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2020-06-07T01:59:47.348924716Z\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"docker_version\"</span>: <span class=\"string\">\"19.03.5\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"history\"</span>: [&#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2020-06-07T01:59:46.877600299Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop) ADD file:a82014afc29e7b364ac95223b22ebafad46cc9318951a85027a49f9ce1a99461 in / \"</span></span><br><span class=\"line\">      &#125;,&#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2020-06-07T01:59:47.348924716Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop)  CMD [\\\"bash\\\"]\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"empty_layer\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;],</span><br><span class=\"line\">  <span class=\"string\">\"os\"</span>: <span class=\"string\">\"linux\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"rootfs\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span>: <span class=\"string\">\"layers\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"diff_ids\"</span>: [<span class=\"string\">\"sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956\"</span>]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>manifest : é•œåƒçš„configæ–‡ä»¶ç´¢å¼•åŒ…æ‹¬äº†<code>Layer/Annotation</code>å…¶æ–‡ä»¶ä¸­ä¿å­˜äº†å¾ˆå¤šå’Œ<code>å½“å‰å¹³å°æœ‰å…³ä¿¡æ¯å­˜æ”¾äºåœ¨ registry ä¸­</code>ã€‚<br>æ‚¨å¯ä»¥åœ¨é•œåƒä»“åº“ä¸­é€šè¿‡Registry APIè¯·æ±‚è·å–é•œåƒManifestä¸­çš„ä¿¡æ¯, å½“æˆ‘ä»¬æ‹‰å–é•œåƒçš„æ—¶å€™ä¼šæ ¹æ®è¯¥æ–‡ä»¶æ‹‰å–ç›¸åº”çš„ layer,æ¯”å¦‚åé¢å®ç°çš„ä¸è§£å‹é•œåƒæ‹·è´;</p>\n<ul>\n<li>é•œåƒçš„ manifest æ–‡ä»¶(å›¾åƒæ¸…å•è§„èŒƒ)ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªç›®æ ‡:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ç¬¬ä¸€ä¸ªç›®æ ‡æ˜¯å†…å®¹å¯å¯»å€çš„å›¾åƒï¼Œé€šè¿‡æ”¯æŒçš„å›¾åƒæ¨¡å‹ï¼Œå…¶ä¸­æ‰€è¿°å›¾åƒçš„é…ç½®å¯è¢«æ•£åˆ—ä»¥ç”Ÿæˆå›¾åƒå’Œå®ƒçš„ç»„ä»¶çš„å”¯ä¸€IDã€‚</span><br><span class=\"line\">ç¬¬äºŒä¸ªç›®æ ‡æ˜¯è®©å¤šæ¶æ„çš„å›¾åƒï¼Œé€šè¿‡â€œmainfestâ€ï¼Œè¿™å¯¹äºå›¾åƒçš„ç‰¹å®šäºå¹³å°çš„ç‰ˆæœ¬å‚è€ƒå›¾åƒæ¸…å•ã€‚åœ¨OCIï¼Œè¿™æ˜¯åœ¨å›¾åƒç´¢å¼•ç¼–å…¥ã€‚</span><br><span class=\"line\">ç¬¬ä¸‰ä¸ªç›®æ ‡æ˜¯è¦ç¿»è¯‘åˆ°OCIè¿è¡Œè§„èŒƒã€‚</span><br></pre></td></tr></table></figure></li>\n<li>ç‰ˆæœ¬: ç›®å‰ä¸»æµçš„ç‰ˆæœ¬æ˜¯ Manifest Version 2, Schema 2 <a href=\"https://github.com/docker/distribution/blob/master/docs/spec/manifest-v2-2.md\" target=\"_blank\" rel=\"noopener\">å®˜æ–¹å‚è€ƒè¯´æ˜</a></li>\n<li>æ³¨æ„: manifest ä¸­çš„ layer å’Œ config ä¸­çš„ layer è¡¨è¾¾çš„è™½ç„¶éƒ½æ˜¯é•œåƒçš„ layer ï¼Œä½†äºŒè€…ä»£è¡¨çš„æ„ä¹‰ä¸å¤ªä¸€æ ·;</li>\n<li>æ³¨æ„: <code>registry ä¸­ä¼šæœ‰ä¸ª Manifest List æ–‡ä»¶</code>ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸ºä¸åŒå¤„ç†å™¨ä½“ç³»æ¶æ„è€Œè®¾è®¡çš„ï¼Œé€šè¿‡è¯¥æ–‡ä»¶æŒ‡å‘ä¸è¯¥å¤„ç†å™¨ä½“ç³»æ¶æ„ç›¸å¯¹åº”çš„ Image Manifest;</li>\n<li>æ€»ç»“: å®¹å™¨é•œåƒçš„ Configï¼Œå’Œ Layers ä¸­çš„æ¯ä¸€å±‚ï¼Œéƒ½æ˜¯ä»¥ Blob çš„æ–¹å¼å­˜å‚¨åœ¨é•œåƒä»“åº“ä¸­çš„ï¼Œå®ƒä»¬çš„ digest ä½œä¸º Key å­˜åœ¨ã€‚å› æ­¤åœ¨è¯·æ±‚åˆ°é•œåƒçš„ Manifest åï¼Œ<code>Docker ä¼šåˆ©ç”¨ digest å¹¶è¡Œä¸‹è½½æ‰€æœ‰çš„ Blobs</code>ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ Config å’Œæ‰€æœ‰çš„ Layersã€‚<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//Manifest List</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"schemaVersion\"</span>: <span class=\"number\">2</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.list.v2+json\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"manifests\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"size\"</span>: <span class=\"number\">7143</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"digest\"</span>: <span class=\"string\">\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"platform\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"architecture\"</span>: <span class=\"string\">\"ppc64le\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"os\"</span>: <span class=\"string\">\"linux\"</span>,</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"size\"</span>: <span class=\"number\">7682</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"digest\"</span>: <span class=\"string\">\"sha256:5b0bcabd1ed22e9fb1310cf6c2dec7cdef19f0ad69efa1f392e94a4333501270\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"platform\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"architecture\"</span>: <span class=\"string\">\"amd64\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"os\"</span>: <span class=\"string\">\"linux\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"features\"</span>: [</span><br><span class=\"line\">          <span class=\"string\">\"sse4\"</span></span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// Image Manifest :  å¯é€šè¿‡ Registry  API è¯·æ±‚æŸ¥çœ‹åˆ°;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">// Manifest Version 2, Schema 2</span><br><span class=\"line\">  \"schemaVersion\": 2,</span><br><span class=\"line\">  \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",</span><br><span class=\"line\">// å…¶å®šä¹‰åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ Config å’Œ Layers ä¸”éƒ½åŒ…å«ä¸‰ä¸ªå­—æ®µåˆ†åˆ«æ˜¯ digestã€mediaType å’Œ size</span><br><span class=\"line\">// Config æ˜¯ä¸€ä¸ª JSON å¯¹è±¡</span><br><span class=\"line\">  \"config\": &#123;</span><br><span class=\"line\">    // å†…å®¹ç±»å‹</span><br><span class=\"line\">    // é•œåƒçš„å…ƒæ•°æ®: å…³äºå®¹å™¨é•œåƒçš„é…ç½®ï¼Œé€šå¸¸å®ƒä¼šè¢«é•œåƒä»“åº“ç”¨æ¥åœ¨ UI ä¸­å±•ç¤ºä¿¡æ¯ï¼Œä»¥åŠåŒºåˆ†ä¸åŒæ“ä½œç³»ç»Ÿçš„æ„å»ºç­‰ã€‚</span><br><span class=\"line\">    \"mediaType\": \"application/vnd.docker.container.image.v1+json\",</span><br><span class=\"line\">    // å†…å®¹çš„å¤§å°</span><br><span class=\"line\">    \"size\": 1509,</span><br><span class=\"line\">    // å¯¹è±¡çš„ ID</span><br><span class=\"line\">    \"digest\": \"sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e\"</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">// Layers æ˜¯ä¸€ä¸ªç”± JSON å¯¹è±¡ç»„æˆçš„æ•°ç»„</span><br><span class=\"line\">  \"layers\": [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      // ä¼—æ‰€å‘¨çŸ¥ï¼Œå®¹å™¨é•œåƒæ˜¯åˆ†å±‚æ„å»ºçš„ï¼Œæ¯ä¸€å±‚å°±å¯¹åº”ç€ Layers ä¸­çš„ä¸€ä¸ªå¯¹è±¡ã€‚</span><br><span class=\"line\">      \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\",  // å¸¸è§å½¢å¼</span><br><span class=\"line\">      \"size\": 5844992,</span><br><span class=\"line\">      \"digest\": \"sha256:50644c29ef5a27c9a40c393a73ece2479de78325cae7d762ef3cdc19bf42dd0a\"</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>Image manifest index - OCIå›¾åƒç´¢å¼•è§„èŒƒ<br>æè¿°:åœ¨ docker çš„ distribution ä¸­ç§°ä¹‹ä¸º Manifest List åœ¨ OCI ä¸­å°±å«<code>OCI Image Index Specification</code>,å®é™…ä¸Šä¸¤è€…æ˜¯æŒ‡çš„åŒä¸€ä¸ªæ–‡ä»¶ï¼Œç”šè‡³ä¸¤è€… GitHub ä¸Šæ–‡æ¡£ç»™çš„ example éƒ½ä¸€ä¸€æ¨¡æ ·ğŸ¤£ï¼Œåº”è¯¥æ˜¯ OCI å¤åˆ¶ç²˜è´´ Docker çš„æ–‡æ¡£;<br>index æ–‡ä»¶æ˜¯ä¸ªå¯é€‰çš„æ–‡ä»¶ï¼ŒåŒ…å«ç€ä¸€ä¸ªåˆ—è¡¨ä¸ºåŒä¸€ä¸ªé•œåƒä¸åŒçš„å¤„ç†å™¨ arch æŒ‡å‘ä¸åŒå¹³å°çš„ manifest æ–‡ä»¶ï¼Œ<code>å®ƒä¿è¯ä¸€ä¸ªé•œåƒå¯ä»¥è·¨å¹³å°ä½¿ç”¨</code>ï¼Œå³æ¯ä¸ªå¤„ç†å™¨ arch å¹³å°æ‹¥æœ‰ä¸åŒçš„ manifest æ–‡ä»¶ï¼Œä½¿ç”¨ index ä½œä¸ºç´¢å¼•ã€‚<br>å½“æˆ‘ä»¬ä½¿ç”¨ arm æ¶æ„çš„å¤„ç†å™¨æ—¶è¦é¢å¤–æ³¨æ„ï¼Œåœ¨æ‹‰å–é•œåƒçš„æ—¶å€™è¦æ‹‰å– arm æ¶æ„çš„é•œåƒï¼Œä¸€èˆ¬å¤„ç†å™¨çš„æ¶æ„éƒ½æ¥åœ¨é•œåƒçš„ tag åé¢ï¼Œé»˜è®¤ latest tag çš„é•œåƒæ˜¯ x86 çš„ï¼Œåœ¨ arm å¤„ç†å™¨çš„æœºå™¨è¿™äº›é•œåƒä¸Šæ˜¯è·‘ä¸èµ·æ¥çš„ã€‚</li>\n</ul>\n<p><br></p>\n<h6 id=\"runtime-spec-è¿è¡Œæ—¶è§„èŒƒ\"><a href=\"#runtime-spec-è¿è¡Œæ—¶è§„èŒƒ\" class=\"headerlink\" title=\"runtime-spec è¿è¡Œæ—¶è§„èŒƒ\"></a>runtime-spec è¿è¡Œæ—¶è§„èŒƒ</h6><p>åœ¨æ·±å…¥å­¦ä¹ DockeråŸç†è¿‡ç¨‹ä¸­å‘ç°Docker infoä¸­çš„Runtimeså­—æ®µï¼Œç”±äºä¸ªäººé˜…å†æœ‰é™ä¸å¾—ä¸Googleä¸€ä¸‹æ‰€ä»¥æœ‰äº†ä»¥ä¸‹å†…å®¹;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$docker</span> info | grep -i <span class=\"string\">\"runtime\"</span></span><br><span class=\"line\"><span class=\"comment\"># Dockerã€Googleç­‰å…¬å¸å¼€æºäº†ç”¨äºè¿è¡Œå®¹å™¨çš„å·¥å…·å’Œåº“ runcï¼Œåœ¨æ­¤ä¹‹åï¼Œå„ç§è¿è¡Œæ—¶å·¥å…·å’Œåº“ä¹Ÿæ…¢æ…¢å‡ºç°ï¼Œä¾‹å¦‚ rktã€containerdã€cri-o ç­‰ï¼Œç„¶è€Œè¿™äº›å·¥å…·æ‰€æ‹¥æœ‰çš„åŠŸèƒ½å´ä¸å°½ç›¸åŒï¼Œæœ‰çš„åªæœ‰è¿è¡Œå®¹å™¨(runcã€lxc)ï¼Œè€Œæœ‰çš„é™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥å¯¹é•œåƒè¿›è¡Œç®¡ç†(containerdã€cri-o)ã€‚</span></span><br><span class=\"line\">Runtimes: runc </span><br><span class=\"line\">Default Runtime: runc</span><br></pre></td></tr></table></figure></p>\n<p>Q: ä»€ä¹ˆæ˜¯runtimes?</p>\n<blockquote>\n<p>ç­”:ä»å­—é¢ç†è§£Runtimesæˆ‘ä»¬çŸ¥é“å…¶ä¸ºè¿è¡Œæ—¶å®é™…å®ƒæ˜¯Dockerå®¹å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€ä¸ªå‘¨æœŸç­‰ï¼›<br>ç®€å•çš„è¯´å°±æ˜¯å®¹å™¨è¿è¡Œæ—¶ï¼Œä¼ ç»Ÿæ„ä¹‰ä¸Šæ¥è¯´å°±æ˜¯ä»£è¡¨å®¹å™¨ä»æ‹‰å–é•œåƒåˆ°å¯åŠ¨è¿è¡Œå†åˆ°ä¸­æ­¢çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ</p>\n</blockquote>\n<p>å®¹å™¨åœ¨è¿è¡Œæ—¶åˆ†ä¸ºä¸¤ç±»:</p>\n<ul>\n<li>1) low-level runtime : å…³æ³¨å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿäº¤äº’ï¼Œåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ï¼Œä½¿ç”¨ namespace å’Œ cgroup å®ç°èµ„æºéš”ç¦»å’Œé™åˆ¶,ç›®å‰å¸¸è§çš„ low-level runtimeæœ‰ï¼š<ul>\n<li>lmctfy â€“ æ˜¯Googleçš„ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæ˜¯Borgä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶</li>\n<li>runc â€“ ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„å®¹å™¨è¿è¡Œæ—¶ã€‚</li>\n<li>rkt â€“ CoreOSå¼€å‘çš„Docker/runcçš„ä¸€ä¸ªæµè¡Œæ›¿ä»£æ–¹æ¡ˆï¼Œæä¾›äº†å…¶ä»– low-level runtimes (å¦‚runc)æ‰€æä¾›çš„æ‰€æœ‰ç‰¹æ€§ã€‚</li>\n</ul>\n</li>\n<li>2) high-level runtime : æŒ‡åŒ…å«äº†æ›´å¤šä¸Šå±‚åŠŸèƒ½ï¼Œä¾‹å¦‚ grpcè°ƒç”¨ï¼Œé•œåƒå­˜å‚¨ç®¡ç†ç­‰ï¼Œç›®å‰ä¸»æµçš„ high-level runtime æœ‰ï¼š<ul>\n<li>docker</li>\n<li>containerd</li>\n<li>rkt</li>\n</ul>\n</li>\n</ul>\n<p>å…¶ä¸¤è€…çš„åŒºåˆ«æ˜¯:</p>\n<ul>\n<li>High-level runtimesç›¸è¾ƒäºlow-level runtimesä½äºå †æ ˆçš„ä¸Šå±‚</li>\n<li>low-level runtimesè´Ÿè´£å®é™…è¿è¡Œå®¹å™¨ï¼Œè€ŒHigh-level runtimesè´Ÿè´£ä¼ è¾“å’Œç®¡ç†å®¹å™¨é•œåƒã€è§£å‹é•œåƒï¼Œå¹¶ä¼ é€’ç»™low-level runtimesæ¥è¿è¡Œå®¹å™¨ã€‚</li>\n</ul>\n<p><br></p>\n<p>Q: ä»ä¸Šé¢çš„è¡¨è¾¾ä¸­æˆ‘ä»¬çŸ¥é“runcæ˜¯ä¸€ä¸ªlow-level è¿è¡Œæ—¶ï¼Œé‚£å®ƒä¸Dockeræœ‰ä½•å…³ç³»?</p>\n<blockquote>\n<p>ç­”: runCæ˜¯ä¸€ä¸ªæ ¹æ®OCIæ ‡å‡†åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLI toolï¼‰, runCæ˜¯dockerä¸­æœ€ä¸ºæ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®¹å™¨çš„åˆ›å»ºï¼Œè¿è¡Œï¼Œé”€æ¯ç­‰ç­‰æ“ä½œæœ€ç»ˆéƒ½å°†é€šè¿‡è°ƒç”¨runcå®Œæˆã€‚<br>è€ŒrunCä¹Ÿæœ‰è‡ªå·±çš„å®¢æˆ·ç«¯ï¼Œåæ¥è¢«æå–å‡ºæ¥ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å·¥å…·å’Œåº“ã€‚å…¶å®ç°äº† OCI è§„èŒƒï¼ŒåŒ…å«config.jsonæ–‡ä»¶å’Œå®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p>\n</blockquote>\n<p><br></p>\n<h6 id=\"distribution-spec-é•œåƒä»“åº“è§„èŒƒ\"><a href=\"#distribution-spec-é•œåƒä»“åº“è§„èŒƒ\" class=\"headerlink\" title=\"distribution-spec é•œåƒä»“åº“è§„èŒƒ\"></a>distribution-spec é•œåƒä»“åº“è§„èŒƒ</h6><p>æè¿°:è¯¥è§„èŒƒå®šä¹‰ç€å®¹å™¨é•œåƒå¦‚ä½•å­˜å‚¨åœ¨è¿œç«¯çš„Registryä¸Š,ä½¿ç”¨è§„èŒƒçš„å¥½å¤„æ˜¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠŠè¿™äº›é•œåƒæŒ‰ç…§çº¦å®šä¿—æˆçš„æ ¼å¼æ¥å­˜æ”¾å³æ–¹ä¾¿ç¬¬ä¸‰æ–¹å·¥å…·çš„å­˜å–;</p>\n<p>ç›®å‰å®ç°è¯¥è§„èŒƒçš„ registry å°± docker å®¶çš„ registry ä½¿ç”¨çš„å¤šä¸€äº›ã€‚å…¶ä»–çš„ registry æ¯”å¦‚ harbor ã€ quay.io ä½¿ç”¨çš„ä¹Ÿæ¯”è¾ƒå¤šã€‚</p>\n<p><br></p>\n<h5 id=\"2-Dockerfile\"><a href=\"#2-Dockerfile\" class=\"headerlink\" title=\"2.Dockerfile\"></a>2.Dockerfile</h5><p>æè¿°:ç›¸ä¿¡è¯»è€…å¦‚æœå¯¹dockeræœ‰ä¸ªåŸºç¡€äº†è§£ä»¥åŠçœ‹äº†æˆ‘å‰é¢çš„æ–‡ç« ï¼Œæƒ³å¿…å¯¹å®ƒä¸æ„Ÿåˆ°é™Œç”Ÿå§ï¼›ä¼—æ‰€å‘¨çŸ¥ docker é•œåƒéœ€è¦ä¸€ä¸ª Dockerfile æ¥æ„å»ºè€Œæˆï¼›<br>å½“æˆ‘ä»¬å¯¹ OCI é•œåƒè§„èŒƒæœ‰äº†ä¸ªå¤§è‡´è§£ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ‹¿ç€ Dockerfile è¿™ä¸ª â€œå›¾çº¸â€ å»ä¸€æ­¥æ­¥æ„å»ºé•œåƒã€‚</p>\n<p>æ­¤å¤„ä¸å†è¯¦ç»†DockerFileçš„è¯¦ç»†ä¹¦å†™ä»¥åŠæœ€ä½³ä¼˜åŒ–æŠ€å·§ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å‚çœ‹å‰é¢çš„æ–‡ç« ;</p>\n<p>ä¸‹é¢æˆ‘ä»¬åŸºäº<code>docker build test-image</code>è¿›ä¸€æ­¥ç†è§£ç›®å½•ç»“æ„;<br><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> alpine</span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"bash\"> name=<span class=\"string\">\"test-image\"</span></span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> apk -v add --no-cache bash </span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> apk -v add --no-cache curl</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> ./startService.sh /</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [<span class=\"string\">\"/bin/bash\"</span>, <span class=\"string\">\"/startService.sh\"</span>]</span></span><br></pre></td></tr></table></figure><br>æ„å»ºè¿‡ç¨‹è¾“å‡ºå¦‚ä¸‹:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$docker</span> build -t <span class=\"built_in\">test</span>-image .</span><br><span class=\"line\">Sending build context to Docker daemon  3.072kB</span><br><span class=\"line\">Step 1/6 : FROM alpine</span><br><span class=\"line\"> ---&gt; 3f53bb00af94</span><br><span class=\"line\">Step 2/6 : LABEL name=<span class=\"string\">\"test-image\"</span></span><br><span class=\"line\"> ---&gt; Running <span class=\"keyword\">in</span> 3bd6320fc291</span><br><span class=\"line\">Removing intermediate container 3bd6320fc291</span><br><span class=\"line\"> ---&gt; bb97dd1fb1a1</span><br><span class=\"line\">Step 3/6 : RUN apk -v add --no-cache bash</span><br><span class=\"line\"> ---&gt; Running <span class=\"keyword\">in</span> f9987ff57ad7</span><br><span class=\"line\">fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">(1/5) Installing ncurses-terminfo-base (6.1_p20180818-r1)</span><br><span class=\"line\">(2/5) Installing ncurses-terminfo (6.1_p20180818-r1)</span><br><span class=\"line\">(3/5) Installing ncurses-libs (6.1_p20180818-r1)</span><br><span class=\"line\">(4/5) Installing readline (7.0.003-r0)</span><br><span class=\"line\">(5/5) Installing bash (4.4.19-r1)</span><br><span class=\"line\">Executing bash-4.4.19-r1.post-install</span><br><span class=\"line\">Executing busybox-1.28.4-r2.trigger</span><br><span class=\"line\">OK: 18 packages, 136 <span class=\"built_in\">dirs</span>, 2877 files, 13 MiB</span><br><span class=\"line\">Removing intermediate container f9987ff57ad7</span><br><span class=\"line\"> ---&gt; a5635f1b1d00</span><br><span class=\"line\">Step 4/6 : RUN apk -v add --no-cache curl</span><br><span class=\"line\"> ---&gt; Running <span class=\"keyword\">in</span> c49fb2e4b311</span><br><span class=\"line\">fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">(1/5) Installing ca-certificates (20171114-r3)</span><br><span class=\"line\">(2/5) Installing nghttp2-libs (1.32.0-r0)</span><br><span class=\"line\">(3/5) Installing libssh2 (1.8.0-r3)</span><br><span class=\"line\">(4/5) Installing libcurl (7.61.1-r1)</span><br><span class=\"line\">(5/5) Installing curl (7.61.1-r1)</span><br><span class=\"line\">Executing busybox-1.28.4-r2.trigger</span><br><span class=\"line\">Executing ca-certificates-20171114-r3.trigger</span><br><span class=\"line\">OK: 23 packages, 141 <span class=\"built_in\">dirs</span>, 3040 files, 15 MiB</span><br><span class=\"line\">Removing intermediate container c49fb2e4b311</span><br><span class=\"line\"> ---&gt; 9156d1521a2f</span><br><span class=\"line\">Step 5/6 : COPY ./startService.sh /</span><br><span class=\"line\"> ---&gt; 704626646baf</span><br><span class=\"line\">Step 6/6 : CMD [<span class=\"string\">\"/bin/bash\"</span>, <span class=\"string\">\"/startService.sh\"</span>]</span><br><span class=\"line\"> ---&gt; Running <span class=\"keyword\">in</span> 1c5e6e861264</span><br><span class=\"line\">Removing intermediate container 1c5e6e861264</span><br><span class=\"line\"> ---&gt; 6cd0a66e83f1</span><br><span class=\"line\">Successfully built 6cd0a66e83f1</span><br><span class=\"line\">Successfully tagged <span class=\"built_in\">test</span>-image:latest</span><br></pre></td></tr></table></figure></p>\n<p>æ„å»ºè¿‡ç¨‹å¦‚å›¾æ‰€ç¤º:<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200805172819.png\" alt=\"WeiyiGeek.docker\" title=\"\" class=\"\">\n                <p>WeiyiGeek.docker</p>\n            </figure></p>\n<p><br></p>\n<h5 id=\"3-åŸºç¡€é•œåƒ\"><a href=\"#3-åŸºç¡€é•œåƒ\" class=\"headerlink\" title=\"3.åŸºç¡€é•œåƒ\"></a>3.åŸºç¡€é•œåƒ</h5><p>æè¿°:é€šè¿‡å‰é¢çš„åŸºç¡€å­¦ä¹ æˆ‘ä»¬çŸ¥é“Docker æ˜¯ä¸€ä¸ªå…¸å‹çš„ C/S æ¶æ„çš„åº”ç”¨ï¼Œåˆ†ä¸º <code>Docker å®¢æˆ·ç«¯ï¼ˆå³å¹³æ—¶æ•²çš„ docker å‘½ä»¤ï¼‰</code> å’Œ <code>Docker æœåŠ¡ç«¯ï¼ˆdockerd å®ˆæŠ¤è¿›ç¨‹ï¼‰</code>ã€‚</p>\n<p>ä¸»è¦ç‰¹å¾:</p>\n<ul>\n<li>1) Docker å®¢æˆ·ç«¯é€šè¿‡ REST API å’ŒæœåŠ¡ç«¯è¿›è¡Œäº¤äº’ï¼Œå³å®¢æˆ·ç«¯æ¯å‘é€ä¸€æ¡æŒ‡ä»¤ï¼Œåº•å±‚éƒ½ä¼šè½¬åŒ–æˆ REST API è°ƒç”¨çš„å½¢å¼å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å¹¶ç»™å‡ºå“åº”ã€‚</li>\n<li>2) Docker é•œåƒçš„æ„å»ºã€å®¹å™¨åˆ›å»ºã€å®¹å™¨è¿è¡Œç­‰å·¥ä½œéƒ½æ˜¯ Docker æœåŠ¡ç«¯æ¥å®Œæˆçš„ï¼ŒDocker å®¢æˆ·ç«¯åªæ˜¯æ‰¿æ‹…å‘é€æŒ‡ä»¤çš„è§’è‰²ã€‚</li>\n<li>3) Docker å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯ä»¥åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„å®¿ä¸»æœº;<ul>\n<li>å¦‚æœåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºçš„è¯ï¼ŒDocker å®¢æˆ·ç«¯é»˜è®¤é€šè¿‡ UNIX å¥—æ¥å­—<code>(/var/run/docker.sock)</code>å’ŒæœåŠ¡ç«¯é€šä¿¡;</li>\n<li>å¦‚æœä¸åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºçš„åŒ–ï¼ŒDockerå®¢æˆ·ç«¯åˆ™é€šè¿‡TCPé€šé“<code>(tcp://xxx.xx.xx.xx:2375)</code>è¿›è¡Œä¸æœåŠ¡ç«¯é€šä¿¡ã€‚</li>\n</ul>\n</li>\n</ul>\n<p>å¦‚æœè¯´ç‚¼åˆ¶é•œåƒä¹Ÿéœ€è¦ä¸ªå·¥å‚çš„è¯ï¼Œé‚£ä¹ˆ dockerd å®ˆæŠ¤è¿›ç¨‹å°±æ˜¯ä¸ªç”Ÿäº§é•œåƒçš„å·¥å‚ã€‚</p>\n<p>Tips: é•œåƒå·¥å‚ä¸æ­¢Dockerä¸€å®¶è¿˜æœ‰Redhatå®¶çš„Buildahä¹Ÿèƒ½ç”Ÿäº§é•œåƒ,ä¸¤è€…åŒºåˆ«å¦‚ä¸‹:</p>\n<ul>\n<li>1.Docker æ„å»ºé•œåƒæ—¶å€™éœ€è¦ROOTæƒé™ï¼Œè€ŒBuildahåˆ™å¯ä»¥é‡‡ç”¨éROOTæƒé™æ„å»ºé•œåƒ</li>\n<li>2.Docker é•œåƒå…¼å®¹æ€§ç›¸å¯¹äºBuildahè¾ƒå¥½;</li>\n<li>3.Docker æ„å»ºé•œåƒä½¿ç”¨å æ¯”æ¯”Buildahå¤š;</li>\n</ul>\n<p>æ„å»ºé•œåƒ<code>docker build</code>çš„æµç¨‹:</p>\n<ul>\n<li>1) åœ¨Docker Cli æ‰§è¡Œé•œåƒæ„å»ºå‘½ä»¤å¹¶ä¸”ä½¿ç”¨-få‚æ•°æ¥æŒ‡å®šDockerfileæ–‡ä»¶ï¼Œ-t æŒ‡å®šæ„å»ºå‡ºçš„é•œåƒæ ‡ç­¾ä¿¡æ¯;</li>\n<li>2) Docker Cli ä¼šå°†æ„å»ºå‘½ä»¤åé¢æŒ‡å®šçš„è·¯å¾„(.)ä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œå¹¶å‘é€ç»™ Docker æœåŠ¡ç«¯;</li>\n<li>3) Docker Deamon æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ tar åŒ…å¹¶è§£å‹,æ ¹æ® Dockerfile é‡Œé¢çš„æŒ‡ä»¤è¿›è¡Œé•œåƒçš„åˆ†å±‚æ„å»º;</li>\n<li>4) Docker ä¸‹è½½ FROM è¯­å¥ä¸­æŒ‡å®šçš„åŸºç¡€é•œåƒï¼Œç„¶åå°†åŸºç¡€é•œåƒçš„ layer è”åˆæŒ‚è½½ä¸ºä¸€å±‚å¹¶åœ¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªç©ºç›®å½•ï¼›</li>\n<li>5) æ­¤æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„å®¹å™¨å¹¶åœ¨ chroot ä¸­å¯åŠ¨ä¸€ä¸ª bash, è¿è¡Œ RUN è¯­å¥ä¸­çš„å‘½ä»¤ï¼š<code>RUN: chroot . /bin/bash -c &quot;apt get updateâ€¦â€¦&quot;</code>ï¼›\\</li>\n<li>6) åœ¨RUNå‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œä¼šå°†å½“å‰å±‚ç›®å½•è¿›è¡Œå‹ç¼©ä»è€Œå½¢æˆæ–°é•œåƒä¸­çš„æ–°çš„ä¸€å±‚, åŒæ—¶ä¸ºä¸‹ä¸€å±‚æä¾›åŸºç¡€é•œåƒ;</li>\n<li>7) å¦‚æœ Dockerfile ä¸­åŒ…å«å…¶å®ƒå‘½ä»¤ï¼Œå°±ä»¥ä¹‹å‰æ„å»ºçš„å±‚æ¬¡ä¸ºåŸºç¡€ï¼Œä»ç¬¬äºŒæ­¥å¼€å§‹é‡å¤åˆ›å»ºæ–°å±‚ï¼Œç›´åˆ°å®Œæˆæ‰€æœ‰è¯­å¥åé€€å‡ºï¼›</li>\n<li>8) åœ¨ Dockerfile ä¸­åŒ…å«çš„æ‰€æœ‰æŒ‡ä»¤å‘½ä»¤æ‰§è¡Œå®Œæ¯•åé•œåƒæ„å»ºå®Œæˆï¼Œå¹¶ä¸ºè¯¥é•œåƒæ‰“ä¸ŠTag;</li>\n</ul>\n<p>Tips: æˆ‘ä»¬å¯ä»¥é‡‡ç”¨<code>docker history &lt;imageName:Tag&gt;</code>å‘½ä»¤æ¥é€†å‘æ¨ç®—å‡º docker build çš„è¿‡ç¨‹ã€‚</p>\n<p>ç°åœ¨æœ‰ä¸ªé—®é¢˜æ¥äº†åŸºç¡€é•œåƒæ˜¯å¦‚ä½•ç”Ÿæˆ?æ€»ä¸ä¼šæ˜¯å‡­ç©ºæé€ çš„å§!</p>\n<blockquote>\n<p>ç­”: å®é™…ä¸Šå®ƒä¹Ÿæ˜¯é€šè¿‡Dockerfileä¸­çš„æŒ‡ä»¤æ¥æ„å»ºçš„, æ¯”å¦‚ä»¥<code>debian:buster</code>è¯¥åŸºç¡€é•œåƒä¸ºä¾‹çœ‹ä¸€ä¸‹åŸºç¡€é•œåƒæ˜¯å¦‚ä½•ç‚¼æˆçš„;</p>\n</blockquote>\n<p>Base Image Dockerfile<br><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è‡ªä» docker 1.5 ç‰ˆæœ¬å¼€å§‹åœ¨ Dockerfile ä¸­ FROM scratch æŒ‡ä»¤å¹¶ä¸è¿›è¡Œä»»ä½•æ“ä½œä¹Ÿå°±æ˜¯ä¸ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚ï¼›</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> scratch</span><br><span class=\"line\"><span class=\"comment\"># ADDæŒ‡ä»¤æŠŠ rootfs.tar.xz è§£å‹åˆ° / ç›®å½•ä¸‹ï¼Œç”±æ­¤äº§ç”Ÿçš„ä¸€å±‚é•œåƒå°±æ˜¯æœ€ç»ˆæ„å»ºçš„é•œåƒçœŸå®çš„ layer å†…å®¹</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> rootfs.tar.xz /</span></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šè¿™é•œåƒåœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œä¸€èˆ¬åŸºç¡€é•œåƒçš„ CMD é»˜è®¤ä¸º bash æˆ–è€… sh ã€‚</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [<span class=\"string\">\"bash\"</span>]</span></span><br></pre></td></tr></table></figure></p>\n<p>æ³¨æ„äº‹é¡¹:</p>\n<ul>\n<li>1) ä¸Šè¿°ä¸­çš„scratché•œåƒå¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œå½“æ‚¨ä½¿ç”¨docker pullå‘½ä»¤ä¸‹è½½å®ƒæ—¶å€™ä¼šæç¤º<code>Error response from daemon: &#39;scratch&#39; is a reserved name</code>;</li>\n<li>2) ä¸Šè¿°ä¸­çš„<code>rootfs.tar.xz</code>æ˜¯å‘è¡Œç‰ˆæºç ç¼–è¯‘çš„å¯ä»¥åœ¨<a href=\"https://github.com/debuerreotype/docker-debian-artifacts\" target=\"_blank\" rel=\"noopener\">docker-debian-artifacts</a>ä¸­æ‰¾åˆ°å®ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªæ“å‡ºæ¥çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ;<ul>\n<li>å¦‚æœå¯¹äºå…¶æºç æ„å»ºæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒdebian åŸºç¡€é•œåƒçš„ Jenkins æµæ°´çº¿ä»»åŠ¡<a href=\"https://doi-janky.infosiftr.net/job/tianon/job/debuerreotype/\" target=\"_blank\" rel=\"noopener\">debuerreotype</a></li>\n<li>æ„å¤–å‘ç° Debian å®˜æ–¹æ˜¯å°†æ‰€æœ‰ arch å’Œæ‰€æœ‰ç‰ˆæœ¬çš„ <code>rootfs.tar.xz</code> éƒ½æ”¾åœ¨è¿™ä¸ª repo é‡Œçš„ï¼Œä»¥è‡³äºè¿™ä¸ª repo çš„å¤§å°æ¥è¿‘ 2.88 GiB;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># rootfs.tar.xz Repo ä¸‹è½½</span></span><br><span class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/debuerreotype/docker-debian-artifacts</span><br><span class=\"line\">Receiving objects: 100% (660/660), 2.88 GiB | 16.63 MiB/s, <span class=\"keyword\">done</span>.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># rootfs.tar.xz è§£å‹åæŸ¥çœ‹æˆ‘æ‰€è¯´çš„ä»–æ˜¯ä¸€ä¸ªLinuxæ ¹æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ†æ”¯åˆ‡æ¢</span></span><br><span class=\"line\">git checkout dist-amd64</span><br><span class=\"line\"><span class=\"built_in\">cd</span> buster &amp;&amp; tar -xvf rootfs.tar.xz -C !$</span><br><span class=\"line\"><span class=\"comment\"># ä¸åŒäºæˆ‘ä»¬å®‰è£…CentOSç³»ç»Ÿçš„é‚£ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class=\"line\">ls rootfs/</span><br><span class=\"line\">bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class=\"line\"><span class=\"comment\"># è¯¥æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç»è¿‡ä¸€ç³»åˆ—è£å‰ªå»æ‰å®¹å™¨ä¸­å¿…è¦çš„æ–‡ä»¶ï¼Œä½¿ä¹‹æ›´åŠ è½»é‡é€‚ç”¨äºå®¹å™¨è¿è¡Œåœºæ™¯å…¶ä½“ç§¯å¤§å°å¤§æ¦‚ä¸º125MB</span></span><br><span class=\"line\">125M    rootfs</span><br><span class=\"line\"><span class=\"comment\"># å¦‚æœä½¿ç”¨slimçš„rootfs.tar.xzä¼šæ›´å°ä¸€äº›;</span></span><br><span class=\"line\">du -sh slim/rootfs</span><br><span class=\"line\">76M     slim/rootfs</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>3) æ­¤æ—¶åœ¨ä¸Šè¿°ç¯å¢ƒä¸­æˆ‘ä»¬éå¸¸æ–¹ä¾¿çš„è‡ªå·±æ„å»ºdebian:buster åŸºç¡€é•œåƒ<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨ buster ç›®å½•ä¸­è¿›è¡Œæ‰§è¡Œé•œåƒæ„å»ºå‘½ä»¤</span></span><br><span class=\"line\">docker build -t debian:buster .</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¸‹é¢å°±æ˜¯æ„å»º Debian åŸºç¡€é•œåƒçš„è¿‡ç¨‹ï¼Œæ­£å¦‚ Dockerfile ä¸­çš„é‚£æ ·ï¼Œæœ€ç»ˆåªäº§ç”Ÿäº†ä¸€å±‚é•œåƒã€‚</span></span><br><span class=\"line\">Sending build context to Docker daemon  30.12MB</span><br><span class=\"line\"><span class=\"comment\"># Step 1/3 : FROM scratch</span></span><br><span class=\"line\"><span class=\"comment\"># Step 2/3 : ADD rootfs.tar.xz /</span></span><br><span class=\"line\"><span class=\"comment\">#  1756d6a585ae</span></span><br><span class=\"line\"><span class=\"comment\"># Step 3/3 : CMD [\"bash\"]</span></span><br><span class=\"line\"><span class=\"comment\">#  Running in c86a8b6deb3d</span></span><br><span class=\"line\"><span class=\"comment\"># Removing intermediate container c86a8b6deb3d</span></span><br><span class=\"line\"><span class=\"comment\">#  04948daa3c2e</span></span><br><span class=\"line\">Successfully built 04948daa3c2e</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h4 id=\"0x01-é•œåƒå­˜å‚¨åŸç†\"><a href=\"#0x01-é•œåƒå­˜å‚¨åŸç†\" class=\"headerlink\" title=\"0x01 é•œåƒå­˜å‚¨åŸç†\"></a>0x01 é•œåƒå­˜å‚¨åŸç†</h4><h5 id=\"æœ¬åœ°å­˜å‚¨-Local\"><a href=\"#æœ¬åœ°å­˜å‚¨-Local\" class=\"headerlink\" title=\"æœ¬åœ°å­˜å‚¨ - Local\"></a>æœ¬åœ°å­˜å‚¨ - Local</h5><p>æè¿°: Docker åœ¨æ„å»ºå®Œé•œåƒåä¼šå°†å…¶å­˜å‚¨åœ¨Docker æœ¬åœ°å­˜å‚¨å®¶ç›®å½•ä¸­ï¼Œé»˜è®¤æƒ…å†µå³<code>/var/lib/docker</code>, å¦‚æœä¿®æ”¹äº†Docker ROOT Dir ç›®å½•çš„å¯ä»¥é€šè¿‡<code>docker info  | grep &quot;Docker Root Dir&quot;</code>å‘½ä»¤æŸ¥çœ‹;</p>\n<p>å¯¹äºé•œåƒå­˜å‚¨è·¯å¾„æœ€é‡è¦çš„ image å’Œ overlay2 è¿™ä¸ªä¸¤ä¸ªç›®å½•ï¼Œå®¹å™¨çš„å…ƒæ•°æ®å­˜æ”¾åœ¨ image ç›®å½•ä¸‹ï¼Œå®¹å™¨çš„ layer æ•°æ®åˆ™å­˜æ”¾åœ¨ overlay2 ç›®å½•ä¸‹ã€‚<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é•œåƒå…ƒæ•°æ®ç›®å½•</span></span><br><span class=\"line\">/var/lib/docker/image</span><br><span class=\"line\"><span class=\"comment\"># overlay2 è¡¨ç¤ºæœ¬åœ°ä½¿ç”¨çš„å­˜å‚¨å¼•æ“</span></span><br><span class=\"line\">/var/lib/docker/image/overlay2/</span><br><span class=\"line\"><span class=\"comment\"># è¯¥æ–‡ä»¶å­˜å‚¨é•œåƒå…ƒæ•°æ®ä¿¡æ¯å³ç”±image name å’Œ digest è¿›è¡Œç»„åˆ, è€ŒDigeståˆä¸Image ID å¯¹åº”</span></span><br><span class=\"line\"><span class=\"comment\"># å½“æˆ‘ä»¬ docker run ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™ä¹Ÿç”¨åˆ°è¿™ä¸ªæ–‡ä»¶å»ç´¢å¼•æœ¬åœ°æ˜¯å¦å­˜åœ¨è¯¥é•œåƒï¼Œæ²¡æœ‰é•œåƒçš„è¯å°±è‡ªåŠ¨å» pull è¿™ä¸ªé•œåƒã€‚</span></span><br><span class=\"line\">/var/lib/docker/image/overlay2/repositories.json</span><br><span class=\"line\"><span class=\"comment\"># &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#   \"Repositories\": &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"debian\": &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#       \"debian:v1\": \"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d\",</span></span><br><span class=\"line\"><span class=\"comment\">#       \"debian:v2\": \"sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df\"</span></span><br><span class=\"line\"><span class=\"comment\">#     &#125;,</span></span><br><span class=\"line\"><span class=\"comment\">#   &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é•œåƒ layer çš„å­˜å‚¨ç›®å½•</span></span><br><span class=\"line\">/var/lib/docker/overlay2</span><br><span class=\"line\"><span class=\"comment\"># diff çš„ä¸Šçº§ç›®å½•å°±æ˜¯ä»¥é•œåƒ layer çš„ digest ä¸ºåçš„ç›®å½•</span></span><br><span class=\"line\"><span class=\"comment\"># overlay2</span></span><br><span class=\"line\"><span class=\"comment\"># â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚   â””â”€â”€ diff</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ bin</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ dev</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ etc</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ home</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ lib</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ media</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ mnt</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ opt</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ proc</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ root</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ run</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ sbin</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ srv</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ sys</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ tmp</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â”œâ”€â”€ usr</span></span><br><span class=\"line\"><span class=\"comment\"># â”‚       â””â”€â”€ var</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é•œåƒLayerç»‘å®šçš„Linksåç§°</span></span><br><span class=\"line\"><span class=\"variable\">$more</span> /var/lib/docker/overlay2/30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/link</span><br><span class=\"line\">IEBGN75T7KVLDOEHY5COAGEWQ2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å…¶ä¸­è¿˜æœ‰ä¸ª l æ–‡ä»¶å¤¹ï¼ˆLinksï¼‰ä¸‹é¢æœ‰ä¸€å¨å¨çš„ç¡¬é“¾æ¥æ–‡ä»¶æŒ‡å‘ä¸Šçº§ç›®å½•çš„ layer ç›®å½•(ä¾¿äºmountç”±äºdigestä¸º256é•¿åº¦å¤ªé•¿)</span></span><br><span class=\"line\">tree /var/lib/docker/overlay2/l/</span><br><span class=\"line\"><span class=\"comment\"># â””â”€ l</span></span><br><span class=\"line\"><span class=\"comment\">#   â”œâ”€â”€ PCIS4FYUJP4X2D4RWB7ETFL6K2 -&gt; ../259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff/diff</span></span><br><span class=\"line\"><span class=\"comment\">#   â””â”€â”€ XK5IA4BWQ2CIS667J3SXPXGQK5 -&gt; ../e8f6e78aa1afeb96039c56f652bb6cd4bbd3daad172324c2172bad9b6c0a968d/diff</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> -lha l/ | grep <span class=\"string\">\"IEBGN75T7KVLDOEHY5COAGEWQ2\"</span></span><br><span class=\"line\">lrwxrwxrwx.  1 root root   72 6æœˆ  29 14:41 IEBGN75T7KVLDOEHY5COAGEWQ2 -&gt; ../30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/diff</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20220122222420.png\" alt=\"WeiyiGeek.é•œåƒåœ¨æœ¬åœ°çš„å­˜å‚¨\" title=\"\" class=\"\">\n                <p>WeiyiGeek.é•œåƒåœ¨æœ¬åœ°çš„å­˜å‚¨</p>\n            </figure>\n<p><br></p>\n<h5 id=\"é•œåƒä»“åº“-Registry\"><a href=\"#é•œåƒä»“åº“-Registry\" class=\"headerlink\" title=\"é•œåƒä»“åº“ - Registry\"></a>é•œåƒä»“åº“ - Registry</h5><p>æè¿°:é•œåƒä»“åº“ä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨å’Œåˆ†å‘é•œåƒçš„ï¼Œå¹¶å¯¹å¤–æä¾›ä¸€å¥— HTTP API V2ã€‚<br>é•œåƒä»“åº“ä¸­çš„æ‰€æœ‰é•œåƒéƒ½æ˜¯ä»¥<code>æ•°æ®å— (Blob) çš„æ–¹å¼å­˜å‚¨</code>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ æ”¯æŒå¤šç§æ–‡ä»¶ç³»ç»Ÿï¼Œä¸»è¦åŒ…æ‹¬<code>filesystemï¼ŒS3ï¼ŒSwiftï¼ŒOSS</code>ç­‰ã€‚ </p>\n<p>ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼Œé•œåƒçš„æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦‚ä½•å­˜å‚¨åœ¨é•œåƒä»“åº“çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„?</p>\n<p>ä¸ºäº†åˆ†æé•œåƒå¦‚ä½•å­˜æ”¾åœ¨Registryä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°dockerç¯å¢ƒä¸­å¯åŠ¨registryå®¹å™¨æ¥å®éªŒå³å¯ï¼Œæ‰€ä»¥åœ¨è¿™ç§åœºæ™¯ä¸‹ä¸å¤ªåˆé€‚ç”¨Harborè¿™ç§é‡é‡çº§çš„Registryé•œåƒä»“åº“å®è·µ;</p>\n<ul>\n<li><p>Step1.Registry é•œåƒå®¹å™¨å¯åŠ¨</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ‹‰å–å¹¶è¿è¡Œ registry å®¹å™¨,æ³¨æ„æ­¤å¤„ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºæ²¡å¯¹Registryè®¾ç½®å®‰å…¨è®¤è¯è®¾ç½®åœ¨å®é™…ç¯å¢ƒä¸­å¿…é¡»è¿›è¡Œè®¾ç½®</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span> run -d --name registry -p 9188:5000 -v /var/lib/registry:/var/lib/registry registry</span><br><span class=\"line\"><span class=\"variable\">$docker</span> run -d --name registry -p 5000:5000 -v /var/lib/registry:/var/lib/registry registry</span><br><span class=\"line\">335ea763a2fa4508ebf3ec6f8b11f3b620a11bdcaa0ab43176b781427e0beee6</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step2.ä¸Šä¼ æœ¬åœ°é•œåƒåˆ° Registry ä»“åº“</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) åˆ—å‡ºæœ¬åœ°é•œåƒ</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span> images</span><br><span class=\"line\">REPOSITORY                           TAG                        IMAGE ID            CREATED             SIZE</span><br><span class=\"line\">go-hello                             scratch                    cb05b87d0012        5 days ago          2.07MB</span><br><span class=\"line\">go-hello                             stage                      5934753f8f4f        5 days ago          73.9MB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2) å°†é•œåƒæ ‡ç­¾é‡æ–°å‘½åä¸ºregistryåœ°å€+é•œåƒåç§°+ç‰ˆæœ¬</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span> tag  go-hello:scratch  127.0.0.1:5000/go-hello:scratch</span><br><span class=\"line\"><span class=\"variable\">$docker</span> push 127.0.0.1:5000/go-hello:scratch</span><br><span class=\"line\"><span class=\"comment\"># The push refers to repository [127.0.0.1:5000/go-hello]</span></span><br><span class=\"line\"><span class=\"comment\"># a3586d882361: Pushed</span></span><br><span class=\"line\"><span class=\"comment\"># scratch: digest: sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e size: 528</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$docker</span> tag go-hello:stage 127.0.0.1:5000/go-hello:stage</span><br><span class=\"line\"><span class=\"variable\">$docker</span> push 127.0.0.1:5000/go-hello:stage</span><br><span class=\"line\"><span class=\"comment\"># The push refers to repository [127.0.0.1:5000/go-hello]</span></span><br><span class=\"line\"><span class=\"comment\"># f5c12d3201a7: Pushed</span></span><br><span class=\"line\"><span class=\"comment\"># 095624243293: Pushed</span></span><br><span class=\"line\"><span class=\"comment\"># a37e74863e72: Pushed</span></span><br><span class=\"line\"><span class=\"comment\"># 8eeb4a14bcb4: Pushed</span></span><br><span class=\"line\"><span class=\"comment\"># ce3011290956: Pushed</span></span><br><span class=\"line\"><span class=\"comment\"># stage: digest: sha256:b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c size: 1360</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step3.å½“æˆ‘ä»¬åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª registry å®¹å™¨ä¹‹åï¼Œå®¹å™¨å†…é»˜è®¤çš„å­˜å‚¨ä½ç½®ä¸º <code>/var/lib/registry</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree -d /var/lib/registry/docker/registry</span><br><span class=\"line\">registry</span><br><span class=\"line\">â””â”€â”€ v2</span><br><span class=\"line\">    â”œâ”€â”€ blobs</span><br><span class=\"line\">    â”‚Â Â  â””â”€â”€ sha256</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ 0e</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ 0e83886eae4fa0f68c7212e4667e030f8c95aa3669f68257a0fa45bf233492b6</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ 32</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ 323d0d660b6a7da8df08a01dbc7250f38cfa2161db00c7c27c0b20be07a8236a</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ 3f</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ 3ff22d22a8554f746f90a78b501da38d56a46f2ddba0dfec8b260aebaa61b3ba</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ 53</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ 5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â      â””â”€â”€ layer</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ 59</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ 5934753f8f4f23efdff6e5108997385f17c3b0b25426fe54eb373fb2f1112d87</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ 8d</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ 8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ b7</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ b7f616834fd07522cbfd33f0dfa848903599320b5c7191b59fe9aa7562f956a1</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ b9</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c</span><br><span class=\"line\">    â”‚Â Â      â”œâ”€â”€ cb</span><br><span class=\"line\">    â”‚Â Â      â”‚Â Â  â””â”€â”€ cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209</span><br><span class=\"line\">    â”‚Â Â      â””â”€â”€ e7</span><br><span class=\"line\">    â”‚Â Â          â””â”€â”€ e7cb79d19722c46b9c0829811d7a5a0ae82c8771ab7f2f68e7d3a3ed6bd5d5d0</span><br><span class=\"line\">    â””â”€â”€ repositories</span><br><span class=\"line\">        â””â”€â”€ go-hello</span><br><span class=\"line\">            â”œâ”€â”€ _layers</span><br><span class=\"line\">            â”‚Â Â  â””â”€â”€ sha256</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ 0e83886eae4fa0f68c7212e4667e030f8c95aa3669f68257a0fa45bf233492b6</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ 323d0d660b6a7da8df08a01dbc7250f38cfa2161db00c7c27c0b20be07a8236a</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ 3ff22d22a8554f746f90a78b501da38d56a46f2ddba0dfec8b260aebaa61b3ba</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ 5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ 5934753f8f4f23efdff6e5108997385f17c3b0b25426fe54eb373fb2f1112d87</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ b7f616834fd07522cbfd33f0dfa848903599320b5c7191b59fe9aa7562f956a1</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209</span><br><span class=\"line\">            â”‚Â Â      â””â”€â”€ e7cb79d19722c46b9c0829811d7a5a0ae82c8771ab7f2f68e7d3a3ed6bd5d5d0</span><br><span class=\"line\">            â”œâ”€â”€ _manifests</span><br><span class=\"line\">            â”‚Â Â  â”œâ”€â”€ revisions</span><br><span class=\"line\">            â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class=\"line\">            â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">            â”‚Â Â  â”‚Â Â      â””â”€â”€ b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c</span><br><span class=\"line\">            â”‚Â Â  â””â”€â”€ tags</span><br><span class=\"line\">            â”‚Â Â      â”œâ”€â”€ scratch</span><br><span class=\"line\">            â”‚Â Â      â”‚Â Â  â”œâ”€â”€ current</span><br><span class=\"line\">            â”‚Â Â      â”‚Â Â  â””â”€â”€ index</span><br><span class=\"line\">            â”‚Â Â      â”‚Â Â      â””â”€â”€ sha256</span><br><span class=\"line\">            â”‚Â Â      â”‚Â Â          â””â”€â”€ 8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">            â”‚Â Â      â””â”€â”€ stage</span><br><span class=\"line\">            â”‚Â Â          â”œâ”€â”€ current</span><br><span class=\"line\">            â”‚Â Â          â””â”€â”€ index</span><br><span class=\"line\">            â”‚Â Â              â””â”€â”€ sha256</span><br><span class=\"line\">            â”‚Â Â                  â””â”€â”€ b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c</span><br><span class=\"line\">            â””â”€â”€ _uploads</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç›®å½•è¯´æ˜</span></span><br><span class=\"line\">blobs ç›®å½•: å­˜å‚¨é•œåƒçš„Layer æ•°æ®ä»¥åŠ Manifest å’Œ Image Configï¼Œè¿™äº›æ–‡ä»¶éƒ½æ˜¯ä»¥ data ä¸ºåçš„æ–‡ä»¶å­˜æ”¾åœ¨äºè¯¥å±‚Layer sha256 ç›¸å¯¹åº”çš„ç›®å½•ä¸‹ï¼›<span class=\"built_in\">cd</span>..</span><br><span class=\"line\">  - æ–‡ä»¶æœ€å¤§çš„ data æ–‡ä»¶å®é™…æ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œåœ¨Dockeræ‹‰å–é•œåƒæ—¶å€™ä¼šä¸‹è½½è¯¥dataæ–‡ä»¶ï¼Œç­‰å¾…å®Œæˆådocker-untarè¿›ç¨‹å°†ä¼šæŠŠdataæ–‡ä»¶è§£å‹åˆ°`/var/lib/docker/overlay2/<span class=\"variable\">$&#123;digest&#125;</span>/diff`ç›®å½•ä¸‹</span><br><span class=\"line\">  - æ–‡ä»¶æœ€å°çš„ data æ–‡ä»¶å®é™…æ˜¯Manifestï¼Œå®ƒè®°å½•äº†ä¸€ä¸ªé•œåƒæ‰€åŒ…å«çš„ layer ä¿¡æ¯ï¼Œå½“æˆ‘ä»¬ pull é•œåƒçš„æ—¶å€™ä¼šä½¿ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶ï¼›</span><br><span class=\"line\">  - æ–‡ä»¶ä»‹äºæœ€å¤§å’Œæœ€å° çš„dataæ–‡ä»¶å®é™…æ˜¯ Image Config å­˜å‚¨é•œåƒç›¸å…³ä¿¡æ¯(æ¶æ„ã€å®¹å™¨é…ç½®ã€åˆ›å»ºå®é™…) å³ `docker inspect image_id` å‘½ä»¤æ‰€çœ‹åˆ°çš„ä¸€äº›ä¿¡æ¯ï¼š</span><br><span class=\"line\"></span><br><span class=\"line\">repositories ç›®å½•: å­˜å‚¨é•œåƒåœ¨ä»“åº“ç›¸å…³çš„ä¿¡æ¯ï¼Œå®ƒä»¬ä¸ºäº†ä½¿ç”¨ä»¥å†…å®¹å¯»å€çš„ sha256 æ•£åˆ—å­˜å‚¨æ–¹ä¾¿ç´¢å¼•æ–‡ä»¶;</span><br><span class=\"line\">  - _uploads: å®ƒæ˜¯ä¸´æ—¶æ–‡ä»¶å¤¹ä¸»è¦ç”¨æ¥å­˜æ”¾ push é•œåƒè¿‡ç¨‹ä¸­çš„æ–‡ä»¶æ•°æ®ï¼Œå¹¶ä¸”å½“é•œåƒ layer ä¸Šä¼ å®Œæˆä¹‹åä¼šæ¸…ç©ºè¯¥æ–‡ä»¶å¤¹; å…¶ä¸­çš„ data æ–‡ä»¶ä¸Šä¼ å®Œæ¯•åä¼šç§»åŠ¨åˆ° blobs ç›®å½•ä¸‹ï¼Œå¹¶æ ¹æ®è¯¥æ–‡ä»¶çš„ sha256 å€¼æ¥è¿›è¡Œæ•£åˆ—å­˜å‚¨åˆ°ç›¸åº”çš„ç›®å½•ä¸‹ã€‚</span><br><span class=\"line\">  - _manifests: è¯¥æ–‡ä»¶å¤¹æ˜¯é•œåƒä¸Šä¼ å®Œæˆä¹‹åç”±Registryæ¥ç”Ÿæˆçš„ï¼Œåœ¨è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªåä¸ºlinkçš„æ–‡æœ¬æ–‡ä»¶å…¶å€¼æŒ‡å‘blobsç›®å½•ä¸‹ä¸ä¹‹å¯¹åº”çš„ç›®å½•;åœ¨è¯¥ç›®å½•ä¸­åŒ…å«é•œåƒçš„tags å’Œ revisions ä¿¡æ¯ï¼Œæ¯ä¸€ä¸ªé•œåƒçš„æ¯ä¸€ä¸ªTagå¯¹åº”ç€äºtagåç§°ç›¸åŒçš„ç›®å½•;</span><br><span class=\"line\">    <span class=\"comment\"># - _revisions ç›®å½•é‡Œå­˜æ”¾äº†è¯¥ repository å†å²ä¸Šä¸Šä¼ ç‰ˆæœ¬çš„æ‰€æœ‰ sha256 ç¼–ç ä¿¡æ¯ã€‚</span></span><br><span class=\"line\">    <span class=\"comment\"># - tags/current ç›®å½•ä¸‹çš„ link æ–‡ä»¶ä¿å­˜äº†è¯¥ tag ç›®å‰çš„ manifest æ–‡ä»¶çš„ sha256 ç¼–ç å¯¹åº”åœ¨ blobs ä¸­çš„ sha256 ç›®å½•ä¸‹çš„ data æ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"comment\"># - tags/index ç›®å½•åˆ™åˆ—å‡ºäº†è¯¥ tag å†å²ä¸Šä¼ çš„æ‰€æœ‰ç‰ˆæœ¬çš„ sha256 ç¼–ç ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step4.å½“æˆ‘ä»¬ pull é•œåƒçš„æ—¶å€™å¦‚æœä¸æŒ‡å®šé•œåƒçš„ tagåé»˜è®¤å°±æ˜¯ latest, registry ä¼šä» HTTP è¯·æ±‚ä¸­è§£æåˆ°è¿™ä¸ªtagåï¼Œç„¶å<code>æ ¹æ®tagåç›®å½•ä¸‹çš„ link æ–‡ä»¶æ‰¾åˆ°è¯¥é•œåƒçš„ manifestçš„ä½ç½®è¿”å›ç»™å®¢æˆ·ç«¯</code>ï¼Œå®¢æˆ·ç«¯æ¥ç€å»è¯·æ±‚è¿™ä¸ªmanifest æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¿™ä¸ª manifest æ–‡ä»¶æ¥ pull ç›¸åº”çš„é•œåƒ layer ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ‰¾åˆ°Manifestä½ç½®</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /var/lib/registry/docker/registry/v2/repositories/go-hello/_manifests/tags/scratch/current/link</span><br><span class=\"line\">sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿›å…¥æŸ¥çœ‹Manifestå†…å®¹</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> -lah /var/lib/registry/docker/registry/v2/blobs/sha256/8d/8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e/</span><br><span class=\"line\">æ€»ç”¨é‡ 4.0K</span><br><span class=\"line\">drwxr-xr-x. 2 root root  18 8æœˆ   2 09:58 .</span><br><span class=\"line\">drwxr-xr-x. 3 root root  78 8æœˆ   2 09:58 ..</span><br><span class=\"line\">-rw-r--r--. 1 root root 528 8æœˆ   2 09:58 data</span><br><span class=\"line\"><span class=\"variable\">$cat</span> /var/lib/registry/docker/registry/v2/blobs/sha256/8d/8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e/data</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">   <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,</span><br><span class=\"line\">   <span class=\"comment\"># é•œåƒæ‹‰å–æ—¶é•œåƒImage Configæ–‡ä»¶åœ°å€</span></span><br><span class=\"line\">   <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.container.image.v1+json\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 1472,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209\"</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"comment\"># é•œåƒæ‹‰å–æ—¶ä¸‹è½½å¹¶åˆ©ç”¨docker-untarçº¿ç¨‹è§£å‹</span></span><br><span class=\"line\">   <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"size\"</span>: 1106793,</span><br><span class=\"line\">         <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><strong>æ€»ç»“æ€æƒ³:</strong></p>\n<ul>\n<li>1.åŒä¸€é•œåƒåœ¨ä¸åŒRegistryé•œåƒä»“åº“ä¸­ï¼Œå­˜å‚¨çš„æ–¹å¼ã€ä½ç½®å’Œå†…å®¹å®Œå…¨ä¸€æ ·å› ä¸ºå®ƒä»¬çš„Layer digeståœ¨ä»“åº“ä¸­å”¯ä¸€ã€‚<ul>\n<li>é€šè¿‡ Registry API è·å¾—çš„ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯å®Œå…¨ç›¸åŒã€‚</li>\n<li>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚</li>\n<li>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ blob ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚</li>\n</ul>\n</li>\n<li>2.registry å­˜å‚¨ç›®å½•é‡Œå¹¶ä¸ä¼šå­˜å‚¨ä¸è¯¥ registry ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æˆ‘ä»¬pushé•œåƒæ—¶ç»™é•œåƒåŠ ä¸Š 127.0.0.1:5000 å‰ç¼€; æ‰€ä»¥æˆ‘ä»¬åœ¨è¿ç§»ä¸€ä¸ªå¤§çš„Registryé•œåƒä»“åº“æ—¶å€™æœ€å¿«æ·çš„æ–¹æ³•å°±æ˜¯æ‰“åŒ…(tar -cvf - ä¸éœ€è¦åŠ zå‚æ•°æµªè´¹ CPU æ—¶é—´å¾—ä¸å¿å¤±)è¯¥registryå­˜å‚¨ç„¶åå°†å…¶taråŒ…rsyncåˆ°å…¶å®ƒæœºå™¨å³å¯;</li>\n</ul>\n<hr>\n<h4 id=\"0x02-é•œåƒæ¬è¿\"><a href=\"#0x02-é•œåƒæ¬è¿\" class=\"headerlink\" title=\"0x02 é•œåƒæ¬è¿\"></a>0x02 é•œåƒæ¬è¿</h4><p>æè¿°: å½“æˆ‘ä»¬åœ¨æœ¬åœ°æ„å»ºå®Œæˆä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚ä½•ä¼ é€’ç»™ä»–äººå‘¢ï¼Ÿæ­¤æ—¶ä¸‹é¢çš„æ–‡ç« æˆ–è€…æŠ€å·§èƒ½æ›´å¥½å¸®åŠ©æ‚¨;</p>\n<p>è¿™é‡Œéœ€è¦åˆ©ç”¨GitHub(git)è¿›è¡Œåšç±»æ¯”ï¼Œå®é™…ä¸Šæ¬è¿é•œåƒçš„æµç¨‹å°±åƒåœ¨Githubä¸Šæ¬è¿ä»£ç ä¸€æ ·;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Github ä»£ç ä»“åº“ == Docker registryé•œåƒä»“åº“(Harbor-å…¬å…±/ç§æœ‰çš„é•œåƒ) </span><br><span class=\"line\"><span class=\"comment\"># Registry: https://index.docker.io/v1/</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span>|pull == docker pull  <span class=\"comment\"># æ‹‰å–</span></span><br><span class=\"line\">git push == docker push  <span class=\"comment\"># æ¨é€</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h5 id=\"pull-é•œåƒæ‹‰å–\"><a href=\"#pull-é•œåƒæ‹‰å–\" class=\"headerlink\" title=\"pull - é•œåƒæ‹‰å–\"></a>pull - é•œåƒæ‹‰å–</h5><p>æè¿°:ä¸ºäº†æ–¹ä¾¿ç†è§£docker fullæ‹‰å–é•œåƒæµç¨‹å¯ä»¥å‚çœ‹OCI Registryè§„èŒƒä¸­çš„<a href=\"https://github.com/opencontainers/distribution-spec/blob/master/spec.md#pulling-an-image\" target=\"_blank\" rel=\"noopener\">æ–‡æ¡£åœ°å€</a>,ä¸‹é¢æ˜¯ç»“åˆå¤§ä½¬çš„åšå®¢ç®€å•æ¢³ç†ä¸€ä¸‹ pull ä¸€ä¸ªé•œåƒçš„å¤§è‡´æµç¨‹ï¼š<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200801101456.png\" alt=\"WeiyiGeek.å‘å¤§ä½¬å€Ÿçš„å›¾\" title=\"\" class=\"\">\n                <p>WeiyiGeek.å‘å¤§ä½¬å€Ÿçš„å›¾</p>\n            </figure></p>\n<p>ç»“åˆä¸Šå›¾å¤§è‡´çš„æµç¨‹ï¼Œæˆ‘å°†è¿œç¨‹çš„é•œåƒä»“åº“æ‹‰å–åˆ°æœ¬åœ°æ¥ç»™å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><p>Step1.é…ç½®Registryé•œåƒä»“åº“çš„authè®¤è¯ä¿¡æ¯</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Auth è®¤è¯ä¿¡æ¯é…ç½®åœ¨Docker pullæ—¶å€™ä¼šå‘registryè¿›è¡Œé‰´æƒéšåä¼šå–å¾—çš„token;</span></span><br><span class=\"line\"><span class=\"comment\"># åœ¨éšåçš„HTTPè¯·æ±‚ä¸­éƒ½è¦åŒ…å«è¯¥Tokenæ‰èƒ½æœ‰æƒé™è¿›è¡Œæ“ä½œ;</span></span><br><span class=\"line\">cat ~/.docker/config.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"auths\"</span>: &#123; <span class=\"string\">\"https://registry.k8s.li/v2/\"</span>: &#123;<span class=\"string\">\"auth\"</span>: <span class=\"string\">\"d2VicH855828WM7bSVsslJFpmQE43Sw==\"</span>&#125;&#125;,</span><br><span class=\"line\">  <span class=\"string\">\"HttpHeaders\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"User-Agent\"</span>: <span class=\"string\">\"Docker-Client/19.03.5 (linux)\"</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"experimental\"</span>: <span class=\"string\">\"enabled\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step2.dockerd å®ˆæŠ¤è¿›ç¨‹è§£æ docker å®¢æˆ·ç«¯å‚æ•°ç”±<code>é•œåƒå + tag</code>æ„æˆå‘ registry è¯·æ±‚Manifest æ–‡ä»¶ï¼Œ</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># registry ä¸­ä¸€ä¸ªé•œåƒæœ‰å¤šä¸ª tag æˆ–è€…å¤šä¸ªå¤„ç†å™¨ä½“ç³»æ¶æ„çš„é•œåƒï¼Œåˆ™æ ¹æ®è¿™ä¸ª tag æ¥è¿”å›ç»™å®¢æˆ·ç«¯ä¸ä¹‹å¯¹åº”çš„ manifest æ–‡ä»¶ï¼›</span></span><br><span class=\"line\"><span class=\"comment\"># HTTP è¯·æ±‚ä¸ºGET /v2/&lt;name&gt;/manifests/&lt;reference&gt; ä¸‹é¢å‚æ•°çš„è§£é‡Šä¸ä¸Šé¢çš„Manifestè§£é‡Šå¯¹åº”</span></span><br><span class=\"line\">GET /v2/&lt;name&gt;/manifests/&lt;reference&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   <span class=\"string\">\"annotations\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"com.example.key1\"</span>: <span class=\"string\">\"value1\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"com.example.key2\"</span>: <span class=\"string\">\"value2\"</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"comment\"># éªŒè¯å·²ä¸‹è½½çš„å±‚ä½¿ç”¨</span></span><br><span class=\"line\">   <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.config.v1+json\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 452</span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"comment\"># ä¸‹è½½æ‹‰å–ä½¿ç”¨</span></span><br><span class=\"line\">   <span class=\"string\">\"layers\"</span>: [&#123;</span><br><span class=\"line\">         <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.layer.v1.tar+gzip\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"size\"</span>: 78343</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   ],</span><br><span class=\"line\">   <span class=\"string\">\"schemaVersion\"</span>: 2</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step3.docker å®ˆæŠ¤è¿›ç¨‹è§£æè¿™ä¸ª Manifest æ–‡ä»¶è·å–é•œåƒçš„ layer çš„ä¿¡æ¯ï¼›ç„¶ådockerdå®ˆæŠ¤è¿›ç¨‹å¹¶è¡Œä¸‹è½½å„ layer ï¼ŒHTTP è¯·æ±‚ä¸º<code>GET /v2/&lt;name&gt;/blobs/&lt;digest&gt;</code>ã€‚</p>\n</li>\n<li><p>Step4.dockerd èµ·ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ docker-untar æ¥ gzip è§£å‹ç¼©å·²ç»ä¸‹è½½å®Œæˆçš„ layer æ–‡ä»¶ï¼›æ³¨æ„å¯¹äºæœ‰äº›æ¯”è¾ƒå¤§çš„é•œåƒï¼ˆæ¯”å¦‚å‡ å GB çš„é•œåƒï¼‰ï¼Œå¾€å¾€é•œåƒçš„ layer å·²ç»ä¸‹è½½å®Œæˆäº†ï¼Œä½†è¿˜æ²¡æœ‰è§£å‹å®Œ;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ls</span> /var/lib/docker/overlay2/30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/diff/</span><br><span class=\"line\">bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é»˜è®¤è¯¥å‘½ä»¤ä¸å­˜åœ¨çš„</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span>-untar /var/lib/docker/overlay2/30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/diff/</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step5.éªŒè¯ image config ä¸­çš„ <code>RootFS.DiffIDs</code> æ˜¯å¦ä¸ä¸‹è½½ï¼ˆè§£å‹åï¼‰hash ç›¸åŒï¼›</p>\n</li>\n<li><p>Step6.è§£æ Manifest è·å–é•œåƒ Configurationï¼ŒéªŒè¯é•œåƒæ˜¯å¦æ­£ç¡®ã€‚</p>\n</li>\n</ul>\n<p><br/></p>\n<h5 id=\"push-æ¨é€é•œåƒ\"><a href=\"#push-æ¨é€é•œåƒ\" class=\"headerlink\" title=\"push - æ¨é€é•œåƒ\"></a>push - æ¨é€é•œåƒ</h5><p>æè¿°: é‡‡ç”¨ docker push æ¨é€ä¸€ä¸ªé•œåƒåˆ°è¿œç¨‹çš„Registryæµç¨‹æ°å¥½ä¸docker pullæ‹‰å–é•œåƒåˆ°æœ¬åœ°æµç¨‹ç›¸åï¼›<br>å®ƒå…ˆè·å–è¦ä¸Šä¼ é•œåƒçš„Layerä¿¡æ¯æ¨é€åˆ°Registry,å½“é•œåƒçš„æ‰€æœ‰layerä¸Šä¼ å®Œæ¯•åå†push Image Manifest åˆ°Registry;</p>\n<p>å…·ä½“æµç¨‹:</p>\n<ul>\n<li><p>Step1.push é•œåƒåˆ°Registryä»“åº“ä¸­éœ€è¦è¿›è¡Œé‰´æƒåŒæ—¶è¿”å›ä¸€ä¸ªToken(åç»­åˆ©ç”¨å®ƒä½œä¸ºèº«ä»½éªŒè¯);</p>\n</li>\n<li><p>Step2.å‘Registryå‘èµ·è¯·æ±‚<code>POST /v2/&lt;name&gt;/blobs/uploads/</code>ï¼Œregistry è¿”å›ä¸€ä¸ªä¸Šä¼ é•œåƒ layer æ—¶è¦åº”åˆ°çš„ URLï¼›</p>\n</li>\n<li><p>Step3.å®¢æˆ·ç«¯é€šè¿‡<code>HEAD /v2/&lt;name&gt;/blobs/&lt;digest&gt;</code>è¯·æ±‚æ£€æŸ¥ registry ä¸­æ˜¯å¦å·²ç»å­˜åœ¨é•œåƒçš„ layerã€‚</p>\n</li>\n<li><p>Step4.å®¢æˆ·ç«¯é€šè¿‡URL ä½¿ç”¨ POST æ–¹æ³•æ¥å®æ—¶ä¸Šä¼  layer æ•°æ®å³ä¸Šä¼ é•œåƒï¼Œä½†æ˜¯ä¸Šä¼ é•œåƒ layer åˆ†ä¸º <code>Monolithic Upload ï¼ˆæ•´ä½“ä¸Šä¼ ï¼‰</code>å’Œ<code>Chunked Uploadï¼ˆåˆ†å—ä¸Šä¼ ï¼‰</code>ä¸¤ç§æ–¹å¼ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.Monolithic Upload</span></span><br><span class=\"line\">PUT /v2/&lt;name&gt;/blobs/uploads/&lt;session_id&gt;?digest=&lt;digest&gt;</span><br><span class=\"line\">Content-Length: &lt;size of layer&gt;</span><br><span class=\"line\">Content-Type: application/octet-stream</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;Layer Binary Data&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.Chunked Upload</span></span><br><span class=\"line\">PATCH /v2/&lt;name&gt;/blobs/uploads/&lt;session_id&gt;</span><br><span class=\"line\">Content-Length: &lt;size of chunk&gt;</span><br><span class=\"line\">Content-Range: &lt;start of range&gt;-&lt;end of range&gt;</span><br><span class=\"line\">Content-Type: application/octet-stream</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;Layer Chunk Binary Data&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step5.é•œåƒçš„ layer ä¸Šä¼ å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯éœ€è¦å‘ registry å‘é€ä¸€ä¸ª PUT HTTP è¯·æ±‚å‘ŠçŸ¥è¯¥ layer å·²ç»ä¸Šä¼ å®Œæ¯•ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /v2/&lt;name&gt;/blobs/uploads/&lt;session_id&gt;?digest=&lt;digest&gt;</span><br><span class=\"line\">Content-Length: &lt;size of chunk&gt;</span><br><span class=\"line\">Content-Range: &lt;start of range&gt;-&lt;end of range&gt;</span><br><span class=\"line\">Content-Type: application/octet-stream</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;Last Layer Chunk Binary Data&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step6.æœ€åå½“æ‰€æœ‰çš„ layer ä¸Šä¼ å®Œä¹‹åå®¢æˆ·ç«¯å† PUT è¯·æ±‚å°† manifest æ¨é€ä¸Šå»å°±å®Œäº‹å„¿äº†ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /v2/&lt;name&gt;/manifests/&lt;reference&gt;</span><br><span class=\"line\">Content-Type: &lt;manifest media <span class=\"built_in\">type</span>&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   <span class=\"string\">\"annotations\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"com.example.key1\"</span>: <span class=\"string\">\"value1\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"com.example.key2\"</span>: <span class=\"string\">\"value2\"</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.config.v1+json\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 452</span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.layer.v1.tar+gzip\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"size\"</span>: 78343</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   ],</span><br><span class=\"line\">   <span class=\"string\">\"schemaVersion\"</span>: 2</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h5 id=\"python-Docker-dray\"><a href=\"#python-Docker-dray\" class=\"headerlink\" title=\"python Docker-dray\"></a>python Docker-dray</h5><p>æè¿°: å®ƒæ˜¯ä¸€ä¸ªPythonè„šæœ¬å®ƒä½¿ç”¨Requeståº“è¯·æ±‚Registry APIæ¥ä»é•œåƒä»“åº“ä¸­æ‹‰å»é•œåƒå¹¶ä¿å­˜ä¸ºtaråŒ…, æ‹‰å–å®Œæˆåä½¿ç”¨Docker loadåŠ è½½åˆ°æœ¬åœ°dockeré•œåƒä¸­;</p>\n<p>å®ƒä¸docker pull ä»¥åŠ Skopeo copyæœ‰ç›¸ä¼¼åŸç†,ç›¸åŒçš„æ˜¯å®ƒä»¬éƒ½ä¼šå»è°ƒç”¨Registry API;</p>\n<p>Install &amp;&amp; Usage:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Download docker-dray</span></span><br><span class=\"line\">wget https://raw.githubusercontent.com/NotGlop/docker-drag/master/docker_pull.py</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Syntax </span></span><br><span class=\"line\">python3 docker_pull.py [image name]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Usage </span></span><br><span class=\"line\"><span class=\"variable\">$python3</span> docker_pull.py nginx</span><br><span class=\"line\">Creating image structure <span class=\"keyword\">in</span>: tmp_nginx_latest</span><br><span class=\"line\">afb6ec6fdc1c: Pull complete [27098756]</span><br><span class=\"line\">dd3ac8106a0b: Pull complete [26210578]                                       ]</span><br><span class=\"line\">8de28bdda69b: Pull complete [538]</span><br><span class=\"line\">a2c431ac2669: Pull complete [900]</span><br><span class=\"line\">e070d03fd1b5: Pull complete [669]</span><br><span class=\"line\">Docker image pulled: library_nginx.tar</span><br><span class=\"line\"><span class=\"variable\">$docker</span> load -i library_nginx.tar</span><br><span class=\"line\">ffc9b21953f4: Loading layer [==================================================&gt;]  72.49MB/72.49MB</span><br><span class=\"line\">d9c0b16c8d5b: Loading layer [==================================================&gt;]  63.81MB/63.81MB</span><br><span class=\"line\">8c7fd6263c1f: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class=\"line\">077ae58ac205: Loading layer [==================================================&gt;]  4.096kB/4.096kB</span><br><span class=\"line\">787328500ad5: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class=\"line\">Loaded image: nginx:latest</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"skopeo-é•œåƒæ¬è¿ç¥å™¨\"><a href=\"#skopeo-é•œåƒæ¬è¿ç¥å™¨\" class=\"headerlink\" title=\"skopeo - é•œåƒæ¬è¿ç¥å™¨\"></a>skopeo - é•œåƒæ¬è¿ç¥å™¨</h5><p>æè¿°: Skopeoç”±Redhat çº¢å¸½å¼€å‘çš„ï¼Œå®ƒä¸Podmanå’ŒBuildah ç®€ç§°(PSB)ä¸‹ä¸€ä»£å®¹å™¨æ¶æ„ä¸­çš„ä¸€å‘˜;<br>çº¢å¸½å®¶çš„Podmanæ¨å‡ºæ˜¯æƒ³è¦å–ä»£Dockerå’ŒContainerdå®¹å™¨è¿è¡Œæ—¶ï¼Œè™½ç„¶å®ƒç¬¦åˆOCIè§„èŒƒä½†æ˜¯å¯¹ç°åœ¨ä¼ä¸šæ¥è®²åŸºæœ¬é‡‡ç”¨Dockerå¹¶ä¸”ä¹Ÿå·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¹‹ä¸­äº†,æ›¿æ¢çš„æˆæœ¬å¹¶ä¸å€¼å¾—ä»–ä»¬å»æ¢åˆ° PSB ä¸Šå»; </p>\n<p>Q: ä½†æ˜¯ä¸æ¯«ä¸å½±å“æˆ‘ä»¬ä½¿ç”¨Skopeoé•œåƒæ¬è¿å·¥å…·ï¼Œä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸€ä¸ªç¥å™¨å‘¢?</p>\n<blockquote>\n<p>ç­”: å› ä¸ºå®ƒå¯ä»¥é’ˆå¯¹ä¸åŒå­˜åœ¨æ–¹å¼çš„é•œåƒLayeråŒæ­¥æˆ–è€…å¤åˆ¶åˆ°æŒ‡å®šé•œåƒä»“åº“ä¸­ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å…å»äº†åƒ <code>docker pull â€“&gt; docker tag â€“&gt; docker push</code> é‚£æ · pull é•œåƒå¯¹é•œåƒè¿›è¡Œè§£å‹ç¼©ï¼Œpush é•œåƒè¿›è¡Œå‹ç¼©ã€‚å°¤å…¶æ˜¯åœ¨æ¬è¿ä¸€äº›è¾ƒå¤§çš„é•œåƒï¼ˆå‡ GB æˆ–è€…å‡ å GBçš„é•œåƒï¼Œæ¯”å¦‚ nvidia/cuda ï¼‰ï¼Œä½¿ç”¨ skopeo copy çš„åŠ é€Ÿæ•ˆæœååˆ†æ˜æ˜¾ã€‚<br>æ¯”å¦‚åœ¨CI/CDæµæ°´çº¿ä¸­æ¬è¿ä¸¤ä¸ªé•œåƒä»“åº“è€Œä¸å¿…æ‰“åŒ…ç„¶åå†åˆ†åˆ«pushåˆ°é•œåƒä¹‹ä¸­;</p>\n</blockquote>\n<p>ä¾‹å¦‚ï¼Œç”¨ skopeo inspect å‘½ä»¤å¯ä»¥å¾ˆæ–¹æ–¹ä¾¿åœ°é€šè¿‡ registry çš„ API æ¥æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ï¼Œä»¥å‰æˆ‘éƒ½æ˜¯ç”¨ curl å‘½ä»¤çš„ï¼Œè¦ token è¿˜è¦åŠ ä¸€å †å‚æ•°ï¼Œæ‰€ä»¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥åæ¥å°±ç”¨ä¸Šäº† skopeo inspect<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@deploy:/root <span class=\"comment\"># skopeo inspect docker://index.docker.io/webpsh/webps:latest --raw</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">   <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,</span><br><span class=\"line\">   <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.container.image.v1+json\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 2534,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:30d9679b0b1ca7e56096eca0cdb7a6eedc29b63968f25156ef60dec27bc7d206\"</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"size\"</span>: 2813316,</span><br><span class=\"line\">         <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08\"</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"size\"</span>: 8088920,</span><br><span class=\"line\">         <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:54335262c2ed2d4155e62b45b187a1394fbb6f39e0a4a171ab8ce0c93789e6b0\"</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"size\"</span>: 262,</span><br><span class=\"line\">         <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:31555b34852eddc7c01f26fa9c0e5e577e36b4e7ccf1b10bec977eb4593a376b\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x03-é•œåƒä½¿ç”¨\"><a href=\"#0x03-é•œåƒä½¿ç”¨\" class=\"headerlink\" title=\"0x03 é•œåƒä½¿ç”¨\"></a>0x03 é•œåƒä½¿ç”¨</h4><p>Q:å½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚æœç”¨å®ƒæ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨å‘¢ï¼Ÿ</p>\n<blockquote>\n<p>ç­”:å®¹å™¨è¿è¡Œæ—¶é€šè¿‡ä¸€ä¸ªå« OCI runtime filesytem bundle çš„æ ‡å‡†æ ¼å¼å°† OCI é•œåƒé€šè¿‡å·¥å…·è½¬æ¢ä¸º bundle ç„¶å<code>OCI å®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨</code>ã€‚<br>æ­¤å¤„æ¶‰åŠåˆ°äº† OCI è§„èŒƒä¸­çš„å¦ä¸€ä¸ªè§„èŒƒå³è¿è¡Œæ—¶è§„èŒƒ runtime-spec;</p>\n</blockquote>\n<p><br/></p>\n<p>filesystem bundle æ˜¯ä¸ªç›®å½•ï¼Œç”¨äºç»™ runtime æä¾›å¯åŠ¨å®¹å™¨å¿…å¤‡çš„é…ç½®æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿ;<br>æ ‡å‡†çš„å®¹å™¨ bundle åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>\n<ul>\n<li>config.json: è¯¥æ–‡ä»¶åŒ…å«äº†å®¹å™¨è¿è¡Œçš„é…ç½®ä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ bundle çš„æ ¹ç›®å½•ï¼Œä¸”åå­—å¿…é¡»ä¸º config.json</li>\n<li>å®¹å™¨çš„æ ¹ç›®å½•å¯ä»¥ç”± config.json ä¸­çš„ root.path æŒ‡å®š</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  OCI Image</span><br><span class=\"line\">      |</span><br><span class=\"line\">download unpack</span><br><span class=\"line\">      |</span><br><span class=\"line\">OCI Runtime Filesystem Bundle  &lt;---run---&gt; OCI Runtime</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p><strong>æµç¨‹è¯´æ˜:</strong></p>\n<ul>\n<li><p>Step1.å½“æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå®¹å™¨ä¹‹åæˆ‘ä»¬ä½¿ç”¨Treeå‘½ä»¤æ¥åˆ†æOverlay2ä¼šå‘ç°ï¼Œå®¹å™¨docker run å¯åŠ¨åè¾ƒä¹‹å‰çš„overlay2ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª merged çš„æ–‡ä»¶å¤¹å¹¶ä¸”è¯¥æ–‡ä»¶å¤¹åœ¨å®¹å™¨ä¸­å¯è§;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â•­â”€root@sg-02 /var/lib/docker</span><br><span class=\"line\">â•°â”€<span class=\"comment\"># tree overlay2 -d -L 3</span></span><br><span class=\"line\">overlay2</span><br><span class=\"line\">â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff</span><br><span class=\"line\">â”‚   â””â”€â”€ diff</span><br><span class=\"line\">â”‚       â”œâ”€â”€ bin</span><br><span class=\"line\">|</span><br><span class=\"line\">â”‚       â””â”€â”€ var</span><br><span class=\"line\">â”œâ”€â”€ 27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805</span><br><span class=\"line\">â”‚   â”œâ”€â”€ diff</span><br><span class=\"line\">â”‚   â””â”€â”€ work</span><br><span class=\"line\">â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844</span><br><span class=\"line\">â”‚   â”œâ”€â”€ diff</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ var</span><br><span class=\"line\">â”‚   â”œâ”€â”€ merged</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ bin</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ dev</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ etc</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ home</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ lib</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ media</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ mnt</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ proc</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ root</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ run</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ sbin</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ srv</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ sys</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ tmp</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ usr</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ var</span><br><span class=\"line\">â”‚   â””â”€â”€ work</span><br><span class=\"line\">â”‚       â””â”€â”€ work</span><br><span class=\"line\">â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844-init</span><br><span class=\"line\">â”‚   â”œâ”€â”€ diff</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ dev</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ etc</span><br><span class=\"line\">â”‚   â””â”€â”€ work</span><br><span class=\"line\">â”‚       â””â”€â”€ work</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step2.Docker é€šè¿‡ overlayfs è”åˆæŒ‚è½½çš„æŠ€æœ¯å°†é•œåƒçš„å¤šå±‚ layer æŒ‚è½½ä¸ºä¸€å±‚ï¼Œè¿™å±‚çš„å†…å®¹å°±æ˜¯å®¹å™¨é‡Œæ‰€çœ‹åˆ°çš„ä¹Ÿå°±æ˜¯ merged æ–‡ä»¶å¤¹ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$mount</span> -l</span><br><span class=\"line\">overlay on / <span class=\"built_in\">type</span> overlay (rw,relatime,lowerdir=/opt/docker/overlay2/l/4EPD2X5VF62FH5PZOZHZDKAKGL:/opt/docker/overlay2/l/MYRYBGZRI4I76MJWQHN7VLZXLW:/opt/docker/overlay2/l/5RZOXYR35NSGAWTI36CVUIRW7U:/opt/docker/overlay2/l/LBWRL4ZXGBWOTN5JDCDZVNOY7H:/opt/docker/overlay2/l/526XCHXRJMZXRIHN4YWJH2QLPY:/opt/docker/overlay2/l/XK5IA4BWQ2CIS667J3SXPXGQK5,upperdir=/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/diff,workdir=/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/work)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>ä» docker å®˜æ–¹æ–‡æ¡£ <code>Use the OverlayFS storage driver</code> é‡Œå·æ¥çš„ä¸€å¼ å›¾ç‰‡åˆ†åˆ«ä»‹ç»å„ Dir çš„ä½œç”¨<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿™äº›æ˜¯è¦†ç›–æ–‡ä»¶ç³»ç»Ÿçš„åªè¯»å±‚ã€‚å¯¹äºdockerè¿™äº›æ˜¯æŒ‰é¡ºåºç»„è£…çš„å›¾åƒå±‚ã€‚</span></span><br><span class=\"line\">LowerDir: these are the <span class=\"built_in\">read</span>-only layers of an overlay filesystem. For docker, these are the image layers assembled <span class=\"keyword\">in</span> order.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿™æ˜¯è¦†ç›–æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™å±‚ã€‚å¯¹äºdockerï¼Œè¿™ç›¸å½“äºå®¹å™¨ç‰¹å®šå±‚ï¼Œè¯¥å±‚åŒ…å«å®¹å™¨æ‰€åšçš„æ›´æ”¹ã€‚</span></span><br><span class=\"line\">UpperDir: this is the <span class=\"built_in\">read</span>-write layer of an overlay filesystem. For docker, that is the equivalent of the container specific layer that contains changes made by that container.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿™æ˜¯ä¸€ä¸ªéœ€è¦çš„ç›®å½•è¦†ç›–ï¼Œå®ƒéœ€è¦ä¸€ä¸ªç©ºçš„ç›®å½•å†…éƒ¨ä½¿ç”¨ã€‚</span></span><br><span class=\"line\">WorkDir: this is a required directory <span class=\"keyword\">for</span> overlay, it needs an empty directory <span class=\"keyword\">for</span> internal use.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Dockeråœ¨è¿è¡Œå®¹å™¨æ—¶æœ‰æ•ˆåœ°å°†æ ¹ç›®å½•chrootåˆ°è¿™ä¸ªç›®å½•ä¸­ã€‚</span></span><br><span class=\"line\">MergedDir: this is the result of the overlay filesystem. Docker effectively chrootâ€™s into this directory when running the container.</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200803161619.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>Step 3.å¦‚æœæƒ³å¯¹ overlayfs æ–‡ä»¶ç³»ç»Ÿæœ‰è¯¦ç»†çš„äº†è§£ï¼Œå¯ä»¥å‚è€ƒ Linux å†…æ ¸å®˜ç½‘ä¸Šçš„è¿™ç¯‡æ–‡æ¡£ <a href=\"https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt\" target=\"_blank\" rel=\"noopener\">overlayfs.txt</a> ã€‚</li>\n</ul>\n<p><strong>å‚è€ƒæ¥æº:</strong> æœ¨å­(<a href=\"https://blog.k8s.li/Exploring-container-image.html\" target=\"_blank\" rel=\"noopener\">https://blog.k8s.li/Exploring-container-image.html</a>)</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"Docker","path":"api/tags/Docker.json"}]}