<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 5.Dockeråº•å±‚å®ç°åŸç†äº†è§£|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Docker">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>5.Dockeråº•å±‚å®ç°åŸç†äº†è§£</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">5.Dockeråº•å±‚å®ç°åŸç†äº†è§£</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-06-03T06:36:30.000Z" itemprop="datePublished" class="page-time">
  2019-06-03
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Docker/5.Dockeråº•å±‚å®ç°åŸç†äº†è§£"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">5.Dockeråº•å±‚å®ç°åŸç†äº†è§£</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-06-03 14:36:30" datetime="2019-06-03T06:36:30.000Z"  itemprop="datePublished">2019-06-03</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-Dockeræ¶æ„ä¸åº•å±‚å®ç°åŸç†æµ…æ"><a href="#0x00-Dockeræ¶æ„ä¸åº•å±‚å®ç°åŸç†æµ…æ" class="headerlink" title="0x00 Dockeræ¶æ„ä¸åº•å±‚å®ç°åŸç†æµ…æ"></a>0x00 Dockeræ¶æ„ä¸åº•å±‚å®ç°åŸç†æµ…æ</h2><p>é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åŸºæœ¬æŒæ¡äº†Dockerçš„é…ç½®ä½¿ç”¨ï¼Œç°åœ¨æˆ‘ä»¬ä»¥ Docker åŸºç¡€æ¶æ„æ¥æ¢ç©¶Dockeåº•å±‚çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œç®€å•çš„åŒ…æ‹¬:</p>
<ul>
<li>Linux ä¸Šçš„å‘½åç©ºé—´ï¼ˆNamespacesï¼‰</li>
<li>æ§åˆ¶ç»„ï¼ˆControl groupsï¼‰</li>
<li>Union æ–‡ä»¶ç³»ç»Ÿï¼ˆUnion file systemsï¼‰</li>
<li>å®¹å™¨æ ¼å¼ï¼ˆContainer formatï¼‰</li>
<li>å®¹å™¨ç½‘ç»œ (Container network) </li>
<li>å®¹å™¨å­˜å‚¨é©±åŠ¨  (Container Storage)</li>
</ul>
<p><br></p>
<h3 id="1-åŸºæœ¬æ¶æ„"><a href="#1-åŸºæœ¬æ¶æ„" class="headerlink" title="1.åŸºæœ¬æ¶æ„"></a>1.åŸºæœ¬æ¶æ„</h3><ul>
<li>C/S æ¶æ„ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯,æ—¢å¯ä»¥è¿è¡Œåœ¨ä¸€ä¸ªæœºå™¨ä¸Šï¼Œä¹Ÿå¯é€šè¿‡ socket æˆ–è€… RESTful API æ¥è¿›è¡Œé€šä¿¡ã€‚</li>
<li>Docker å®ˆæŠ¤è¿›ç¨‹ ï¼ˆDaemonï¼‰ä¸€èˆ¬åœ¨å®¿ä¸»ä¸»æœºåå°è¿è¡Œï¼Œä½œä¸ºæœåŠ¡ç«¯æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å¤„ç†è¿™äº›è¯·æ±‚ï¼ˆåˆ›å»ºã€è¿è¡Œã€åˆ†å‘å®¹å™¨ï¼‰</li>
<li>Docker å®¢æˆ·ç«¯åˆ™ä¸ºç”¨æˆ·æä¾›ä¸€ç³»åˆ—å¯æ‰§è¡Œå‘½ä»¤å¦‚docker run / ï¼Œç”¨æˆ·ç”¨è¿™äº›å‘½ä»¤å®ç°è·Ÿ Docker å®ˆæŠ¤è¿›ç¨‹äº¤äº’ã€‚</li>
</ul>
<p><a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190603221034.png" target="_blank" title="WeiyiGeek.DockeråŸºç¡€æ¶æ„" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190603221034.png" alt="WeiyiGeek.DockeråŸºç¡€æ¶æ„"></a></p>
<p><em>ä¼ ç»Ÿè™šæ‹Ÿæœºç‰¹ç‚¹ï¼š</em><br>ä¼ ç»Ÿçš„è™šæ‹Ÿæœºé€šè¿‡åœ¨å®¿ä¸»ä¸»æœºä¸­è¿è¡Œ hypervisor æ¥æ¨¡æ‹Ÿä¸€æ•´å¥—å®Œæ•´çš„ç¡¬ä»¶ç¯å¢ƒæä¾›ç»™è™šæ‹Ÿæœºçš„æ“ä½œç³»ç»Ÿï¼Œè™šæ‹Ÿæœºç³»ç»Ÿçœ‹åˆ°çš„ç¯å¢ƒæ˜¯å¯é™åˆ¶çš„ï¼Œä¹Ÿæ˜¯å½¼æ­¤éš”ç¦»çš„ï¼Œå®ç°äº†å¯¹èµ„æºæœ€å®Œæ•´çš„å°è£…ä½†æ˜¯æ„å‘³ç€ç³»ç»Ÿèµ„æºçš„æµªè´¹;</p>
<p><em>æ“ä½œç³»ç»Ÿä¸èµ„æºå…±äº«</em><br>æ“ä½œç³»ç»Ÿä¸­åŒ…æ‹¬å†…æ ¸ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€PIDã€UIDã€IPCã€å†…å­˜ã€ç¡¬ç›˜ã€CPU ç­‰ç­‰ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½æ˜¯åº”ç”¨è¿›ç¨‹ç›´æ¥å…±äº«çš„</p>
<p>ä¾‹å¦‚ï¼Œä»¥å®¿ä¸»æœºå’Œè™šæ‹Ÿæœºç³»ç»Ÿéƒ½ä¸º Linux ç³»ç»Ÿä¸ºä¾‹ï¼Œè™šæ‹Ÿæœºä¸­è¿è¡Œçš„åº”ç”¨å…¶å®å¯ä»¥åˆ©ç”¨å®¿ä¸»æœºç³»ç»Ÿä¸­çš„è¿è¡Œç¯å¢ƒï¼ˆdockerä¹Ÿæ˜¯åŸºäºæ­¤ï¼‰ã€‚</p>
<p>å®ç°è™šæ‹ŸåŒ–çš„è¦æ±‚ï¼š</p>
<ul>
<li>å®ç°å¯¹å†…å­˜memory(ä¸å¯å‹ç¼©)ã€CPUï¼ˆå¯å‹ç¼©ï¼‰ã€ç½‘ç»œIOã€ç¡¬ç›˜IOã€å­˜å‚¨ç©ºé—´ç­‰çš„é™åˆ¶å¤–</li>
<li>å®ç°æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€PIDã€UIDã€IPCç­‰ç­‰çš„ç›¸äº’éš”ç¦»</li>
</ul>
<p><strong>Memory</strong></p>
<ul>
<li>OOME ä»‹ç»:åœ¨linuxä¸»æœºä¸­å¦‚æœkernelç›‘æµ‹åˆ°å½“å‰å®¿ä¸»æœºæ²¡æœ‰å……è¶³çš„å†…å­˜ç”¨äºå®ç°ç³»ç»ŸæŸäº›é‡è¦çš„åŠŸèƒ½ï¼Œå°±ä¼šæŠ›å‡ºOOMEå¼‚å¸¸(Out<br>Of Memory Exception)åŒæ—¶killæ‰ä¸€äº›è¿›ç¨‹;<ul>
<li>ä¸€æ—¦å‘ç”ŸOOMEä»»ä½•è¿›ç¨‹éƒ½æœ‰å¯èƒ½è¢«æ€æ­»,åŒ…æ‹¬docker daemonåœ¨å†…,ä¸ºæ­¤Dockerç‰¹å®šè°ƒæ•´dockerdaemonçš„ä¼˜å…ˆçº§ä»¥å…è¢«è¯¯æ€,ä½†æ˜¯å®¹å™¨çš„ä¼˜å…ˆçº§æœªè¢«è°ƒæ•´;</li>
<li>æ ¹æ®å„ç§å¤æ‚çš„ç®—æ³•æ¥ç®—å‡ºè¿›ç¨‹çš„oom-scoreæ•°è¶Šå¤šå°±ä¼šè¢«killæ‰,æœ‰äº›æ‚¨ä¸æƒ³killæ‰çš„å®¹å™¨éœ€è¦é‡‡ç”¨oom_odjé”®æ¥åˆå§‹åŒ–æŒ‡å®šå³(â€“oom-kill-disable / â€“oom-score-adj int)</li>
<li>è®¾ç½®é™åˆ¶å®¹å™¨ä¸­å†…å­˜å¤§å°çš„å‚æ•°ï¼šâ€“memory ä¸ â€“memory-swap N ,å…¶ä¸­å†…å­˜åˆè¢«åˆ†ä¸ºRAMã€SWAP;å¿…é¡»å…ˆè®¾ç½®å‰åˆ™æ‰èƒ½ä½¿ç”¨â€“memory-swap<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190606131046.png" target="_blank" title="WeiyiGeek.memory-swap" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190606131046.png" alt="WeiyiGeek.memory-swap" title="" class=""></a>
                <p>WeiyiGeek.memory-swap</p>
            </figure>
</li>
</ul>
</li>
</ul>
<p><br></p>
<p><strong>CPU</strong></p>
<ul>
<li>CFS scheduler : å®Œå…¨å…¬å¹³è°ƒåº¦ç³»ç»Ÿåœ¨docker1.3ä»¥å‰ä½¿ç”¨,åœ¨1.3åŠä»¥åä½¿ç”¨çš„æ˜¯realtimeå®æ—¶æ€§çš„;<ul>
<li>æ™®é€šè¿›ç¨‹ä¼˜å…ˆçº§è°ƒåº¦æ˜¯éå®æ—¶çš„/å†…æ ¸çº§è¿›ç¨‹ä¸€èˆ¬éƒ½æ˜¯å®æ—¶çš„;</li>
<li>ä¼˜å…ˆçº§ï¼šCPUå¯†é›†å‹ã€IOå¯†é›†å‹</li>
<li>é™åˆ¶CPUçš„å‚æ•°ï¼šâ€“cpus æ ¸æ•° / â€“cpu-shares (éœ€è¦åˆ™æŒ‰ç…§æ¯”ä¾‹è¿›è¡Œåˆ†é…)</li>
</ul>
</li>
</ul>
<p>ä½¿ç”¨dockerçš„stressé•œåƒå‹æµ‹å®ç°èµ„æºé™åˆ¶ï¼š<br>æˆ‘çš„æœºå™¨æ˜¯1æ ¸çš„ï¼šæ‰€ä»¥CPUç™¾åˆ†æ¯”è¶…è¿‡100%ï¼ŒRange of CPUs is from 0.01 to 1.00, as there are only 1 CPUs available.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$docker</span> pull lorel/docker-stress-ng</span><br><span class="line">lorel/docker-stress-ng   latest              1ae56ccafe55        3 years ago         8.1MB</span><br><span class="line"></span><br><span class="line"><span class="variable">$docker</span> run --name stress -it --rm lorel/docker-stress-ng:latest stress -<span class="built_in">help</span> <span class="comment">#æŸ¥çœ‹é•œåƒå‹åŠ›æµ‹è¯•å¸®åŠ©</span></span><br><span class="line">Example: stress-ng --cpu 8 --io 4 --vm 2 --vm-bytes 128M --fork 4 --timeout 10s</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¼”ç¤º1.é™åˆ¶è™šæ‹Ÿå†…æœ€å¤§ä¸èƒ½è—256MB</span></span><br><span class="line">[root@izwz9biz2m4sd3bb3k38pgz ~]<span class="comment"># docker run --name stress -it -m 256m --rm lorel/docker-stress-ng:latest stress --vm 2</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$docker</span> stats  </span><br><span class="line">CONTAINER ID        NAME                CPU %               MEM USAGE / LIMIT  MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">36a41704053f        stress              98.57%              140MiB / 256MiB (å…³é”®ç‚¹)    54.69%              0B / 0B             0B / 0B             5</span><br><span class="line"></span><br><span class="line"><span class="comment">#æµ‹è¯•cpuçš„æ€§èƒ½ï¼š</span></span><br><span class="line"><span class="variable">$docker</span> run --name stress -it -m 256m --rm lorel/docker-stress-ng:latest stress --cpu 8 --io 4             <span class="comment">#ä½¿ç”¨å…¨éƒ¨CPUå 100%</span></span><br><span class="line"><span class="variable">$docker</span> run --name stress --cpus 0.5 -it -m 256m --rm lorel/docker-stress-ng:latest stress --cpu 8 --io 4  <span class="comment">#ä½¿ç”¨åŠä¸ªCPU ä¸è¶…è¿‡50% ä¸Šä¸‹è¯¯å·®+/-5</span></span><br><span class="line"><span class="variable">$docker</span> run --name stress --cpuset-cpus 0 -it --rm lorel/docker-stress-ng:latest stress --cpu 8   <span class="comment">#ä½¿ç”¨ç¬¬</span></span><br><span class="line">CONTAINER ID        NAME                CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">6d6cc81d6e26        stress              50.99%              15.93MiB / 256MiB   6.22%               0B / 0B             0B / 143kB          13</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="2-I-Oè®¾å¤‡ç®€è¿°"><a href="#2-I-Oè®¾å¤‡ç®€è¿°" class="headerlink" title="2.I/Oè®¾å¤‡ç®€è¿°"></a>2.I/Oè®¾å¤‡ç®€è¿°</h3><p>æè¿°:Linuxä¸­I/Oè®¾å¤‡åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»,ä¸¤ç§è®¾å¤‡æœ¬èº«æ²¡æœ‰ä¸¥æ ¼é™åˆ¶ï¼Œä½†æ˜¯åŸºäºä¸åŒçš„åŠŸèƒ½è¿›è¡Œåˆ†ç±»;</p>
<ul>
<li>å­—ç¬¦è®¾å¤‡: æä¾›è¿ç»­çš„æ•°æ®æµ<code>æ”¯æŒæŒ‰å­—èŠ‚ã€å­—ç¬¦æ¥è¯»å†™æ•°æ®</code>ï¼Œåº”ç”¨ç¨‹åºéœ€è¦æŒ‰é¡ºåºè¿›è¡Œè¯»å–ï¼Œæ‰€ä»¥é€šå¸¸ä¸æ”¯æŒéšæœºå­˜å–; æ¯”å¦‚:<code>è°ƒåˆ¶è§£è°ƒå™¨å°±æ˜¯å…¸å‹çš„å­—ç¬¦è®¾å¤‡</code>;</li>
<li>å—è®¾å¤‡: åº”ç”¨ç¨‹åºå¯ä»¥éšæœºè®¿é—®è®¾å¤‡æ•°æ®ï¼Œå¹¶ä¸”ç¨‹åºè‡ªå·±ç¡®å®šè¯»å–æ•°æ®çš„ä½ç½®ï¼›æ¯”å¦‚ç£ç›˜å°±æ˜¯å…¸å‹çš„å—è®¾å¤‡;</li>
</ul>
<p>Q: å­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡çš„åŒºåˆ«?<br>ç­”ï¼š<code>å‰è€…é¡ºåºè¯»å–å†™å…¥ï¼Œåè€…é€šè¿‡å¯»å€ç£ç›˜ä¸Šçš„ä»»ä½•ä½ç½®è¿›è¡Œè¯»å–å†™å…¥</code>ï¼Œæ³¨æ„<code>å—è®¾å¤‡æ•°æ®çš„è¯»å†™åªèƒ½ä»¥å—(é€šå¸¸æ˜¯512B)çš„å€æ•°</code>è¿›è¡Œï¼Œä¸å­—ç¬¦è®¾å¤‡å¦å¤–ä¸€ä¸ªåŒºåˆ«å°±æ˜¯<code>å—è®¾å¤‡å¹¶ä¸æ”¯æŒåŸºäºå­—ç¬¦çš„å¯»å€</code>;</p>
<p>Linux çš„è®¾å¤‡ç®¡ç†å’Œæ–‡ä»¶ç³»ç»Ÿæ˜¯ç´§å¯†ç›¸å…³çš„ï¼ˆä¸€åˆ‡çš†æ–‡ä»¶ï¼‰ï¼Œä»¥æ–‡ä»¶çš„æ ¼å¼å­˜æ”¾äº/dev/ç›®å½•ä¹‹ä¸‹ç§°ä¸ºè®¾å¤‡æ–‡ä»¶ã€‚<br>åº”ç”¨ç¨‹åºå¯ä»¥æ‰“å¼€ã€å…³é—­ã€è¯»å†™è¿™äº›è®¾å¤‡æ–‡ä»¶ï¼Œå®Œæˆå¯¹è®¾å¤‡çš„æ“ä½œå°±åƒæ“ä½œæ™®é€šæ•°æ®æ–‡ä»¶ä¸€æ ·ï¼Œå¹¶ä¸”ä¸ºäº†ä¾¿äºç®¡ç†è®¾å¤‡ç³»ç»Ÿä¸ºå„ä¸ªè®¾å¤‡è¿›è¡Œç¼–å·ï¼Œæ¯ä¸ªè®¾å¤‡å·åˆ†ä¸ºä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼›</p>
<p>å¯¹äºå¸¸ç”¨è®¾å¤‡Linuxæœ‰çº¦å®šä¿—ç§°çš„ç¼–å·ï¼Œå¦‚ç£ç›˜çš„ä¸»è®¾å¤‡å·æ˜¯3ï¼›å¹¶ä¸”ä¸€ä¸ªå­—ç¬¦è®¾å¤‡æˆ–è€…å—è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼ˆ<code>ç»Ÿç§°ä¸ºè®¾å¤‡å·</code>ï¼‰ï¼›</p>
<p>Q: ä»€ä¹ˆæ˜¯ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼Ÿ<br>ç­”: ä¸»è®¾å¤‡å·è¡¨ç¤ºä¸€ä¸ªç‰¹å®šçš„é©±åŠ¨ç¨‹åºï¼Œç”¨æ¥åŒºåˆ†ä¸åŒç§ç±»çš„è®¾å¤‡ï¼›<br>æ¬¡è®¾å¤‡å·è¡¨ç¤ºä½¿ç”¨è¯¥é©±åŠ¨ç¨‹åºçš„å„è®¾å¤‡ï¼Œç”¨æ¥åŒºåˆ†åŒä¸€ç§ç±»(ç±»å‹)çš„å¤šä¸ªè®¾å¤‡ï¼›</p>
<hr>
<h3 id="3-åº•å±‚åŸç†æµ…æ"><a href="#3-åº•å±‚åŸç†æµ…æ" class="headerlink" title="3.åº•å±‚åŸç†æµ…æ"></a>3.åº•å±‚åŸç†æµ…æ</h3><h5 id="1-å‘½åç©ºé—´"><a href="#1-å‘½åç©ºé—´" class="headerlink" title="1.å‘½åç©ºé—´"></a>1.å‘½åç©ºé—´</h5><p>æè¿°:å®¹å™¨ï¼ˆContainerï¼‰åˆ©ç”¨Linuxä¸­å†…æ ¸(&gt;=2.4.19)å‘½åç©ºé—´æ¥åš<code>æƒé™çš„éš”ç¦»æ§åˆ¶</code>å³å°†æŸä¸ªç‰¹å®šçš„å…¨å±€ç³»ç»Ÿèµ„æºé€šè¿‡æŠ½è±¡çš„æ–¹æ³•ä½¿å¾—namespaceä¸­çš„è¿›ç¨‹çœ‹èµ·æ¥æ‹¥æœ‰ä»–ä»¬è‡ªå·±çš„éš”ç¦»çš„å…¨å±€ç³»ç»Ÿèµ„æºï¼Œå¹¶ä¸”è”åˆåˆ©ç”¨ <code>cgroups æ¥åšèµ„æºåˆ†é…é™åˆ¶</code>ã€‚</p>
<p>Docker å®¹å™¨å’Œ LXC å®¹å™¨å¾ˆç›¸ä¼¼,å‘½åç©ºé—´æä¾›äº†æœ€åŸºç¡€ä¹Ÿæ˜¯æœ€ç›´æ¥çš„éš”ç¦»ï¼Œåœ¨å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ä¸ä¼šè¢«è¿è¡Œåœ¨ä¸»æœºä¸Šçš„è¿›ç¨‹å’Œå…¶å®ƒå®¹å™¨å‘ç°å’Œä½œç”¨ã€‚éšç€ Linux ç³»ç»Ÿå¯¹äºå‘½åç©ºé—´åŠŸèƒ½çš„å®Œå–„å®ç°ï¼Œç¨‹åºå‘˜å·²ç»å¯ä»¥å®ç°ä¸Šé¢çš„æ‰€æœ‰éœ€æ±‚ï¼Œè®©æŸäº›è¿›ç¨‹åœ¨å½¼æ­¤éš”ç¦»çš„å‘½åç©ºé—´ä¸­è¿è¡Œã€‚å¤§å®¶è™½ç„¶éƒ½å…±ç”¨ä¸€ä¸ªå†…æ ¸å’ŒæŸäº›è¿è¡Œæ—¶ç¯å¢ƒï¼ˆä¾‹å¦‚ä¸€äº›ç³»ç»Ÿå‘½ä»¤å’Œç³»ç»Ÿåº“ï¼‰ï¼Œä½†æ˜¯å½¼æ­¤å´çœ‹ä¸åˆ°éƒ½ä»¥ä¸ºç³»ç»Ÿä¸­åªæœ‰è‡ªå·±çš„å­˜åœ¨</p>
<p>å½“ä½¿ç”¨docker runå¯åŠ¨ä¸€ä¸ªå®¹å™¨æ—¶å€™,åå°Dockerä¼šä¸ºå®¹å™¨åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´å’Œæ§åˆ¶ç»„é›†åˆ;æ¯ä¸ªå®¹å™¨éƒ½æœ‰èµ„æºç‹¬æœ‰ç½‘ç»œ,æ„å‘³ç€ä»–ä»¬ä¸èƒ½è®¿é—®å…¶ä»–å®¹å™¨çš„socketsæˆ–æ¥å£ã€‚ä½†èƒ½é€šè¿‡â€“linksæ¥è¿æ¥ 2 ä¸ªå®¹å™¨æ—¶æˆ–è€…â€“netæ¥è‡ªå®šä¹‰Dockerå®¹å™¨ç½‘ç»œï¼ˆç½‘æ¡¥æ¥å£ç›¸äº’é€šä¿¡ï¼‰,å®¹å™¨å°±å¯ä»¥ç›¸äº’é€šä¿¡äº†ï¼ˆå¯ä»¥æ ¹æ®é…ç½®æ¥é™åˆ¶é€šä¿¡çš„ç­–ç•¥ï¼‰;</p>
<p>å‘½åç©ºé—´ï¼ˆnamespaceï¼‰åœ¨<code>Dockerå®¹å™¨å…·ä½“å®ç°</code>è¯´æ˜å¦‚ä¸‹:</p>
<ul>
<li><p>(1)å…ˆæ¥çœ‹ä¸€ä¸ªç¤ºä¾‹1ï¼Œå½“å‰Linuxå®¿ä¸»æœºç»ˆç«¯è¿›ç¨‹å¯¹åº”çš„namespaceä¿¡æ¯:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ls</span> -l /proc/$$/ns</span><br><span class="line">æ€»ç”¨é‡ 0</span><br><span class="line">lrwxrwxrwx. 1 root root 0 7æœˆ   4 23:27 ipc -&gt; ipc:[4026531839]</span><br><span class="line">lrwxrwxrwx. 1 root root 0 7æœˆ   4 23:27 mnt -&gt; mnt:[4026531840]</span><br><span class="line">lrwxrwxrwx. 1 root root 0 7æœˆ   4 23:27 net -&gt; net:[4026531956]</span><br><span class="line">lrwxrwxrwx. 1 root root 0 7æœˆ   4 23:27 pid -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx. 1 root root 0 7æœˆ   4 23:27 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx. 1 root root 0 7æœˆ   4 23:27 uts -&gt; uts:[4026531838]</span><br></pre></td></tr></table></figure>
</li>
<li><p>ï¼ˆ2ï¼‰Dockerå®¹å™¨ä¸­Namespace</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Namespace</th>
<th style="text-align:left">éš”ç¦»çš„å…¨å±€ç³»ç»Ÿèµ„æº</th>
<th style="text-align:left">å®¹å™¨éš”ç¦»æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">UTS (UNIX Time-sharing System )</td>
<td style="text-align:left">ä¸»æœºåä¸åŸŸå</td>
<td style="text-align:left">æ¯ä¸ªå®¹å™¨æ‹¥æœ‰ç‹¬ç«‹çš„ hostname å’Œ domain name, ä½¿å…¶åœ¨ç½‘ç»œä¸Šå¯ä»¥è¢«è§†ä½œä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è€Œéä¸»æœºä¸Šçš„ä¸€ä¸ªè¿›ç¨‹ã€‚</td>
</tr>
<tr>
<td style="text-align:center">User</td>
<td style="text-align:left">ç”¨æˆ·å’Œç”¨æˆ·ç»„</td>
<td style="text-align:left">æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰ä¸åŒçš„ç”¨æˆ·uidå’Œç»„gid, å¯ä»¥åœ¨å®¹å™¨å†…ç”¨å®¹å™¨å†…éƒ¨çš„ç”¨æˆ·æ‰§è¡Œç¨‹åºè€Œéå®¿ä¸»ä¸»æœºä¸Šçš„ç”¨æˆ·ã€‚</td>
</tr>
<tr>
<td style="text-align:center">IPC (Inter-Process Communication)</td>
<td style="text-align:left">ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—(POSIX message queues)ä»¥åŠå…±äº«å†…å­˜</td>
<td style="text-align:left">æ¯ä¸ªå®¹å™¨æœ‰å…¶è‡ªå·±çš„System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œä»è€Œåªæœ‰åœ¨åŒä¸€ä¸ªIPC namespaceçš„è¿›ç¨‹ä¹‹é—´æ‰èƒ½äº’ç›¸é€šä¿¡; <br> æ³¨æ„:å®¹å™¨çš„è¿›ç¨‹é—´äº¤äº’å®é™…ä¸Šè¿˜æ˜¯ host ä¸Šå…·æœ‰ç›¸åŒ pid å‘½åç©ºé—´ä¸­çš„è¿›ç¨‹é—´äº¤äº’ã€‚å› æ­¤éœ€è¦åœ¨ IPC èµ„æº(<code>æœ‰å”¯ä¸€çš„32ä½id</code>)ç”³è¯·æ—¶åŠ å…¥å‘½åç©ºé—´ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td style="text-align:center">PID</td>
<td style="text-align:left">è¿›ç¨‹ç¼–å·</td>
<td style="text-align:left">æ¯ä¸ªåç§°ç©ºé—´ä¸­pidä¸­çš„è¿›ç¨‹å¯ä»¥æœ‰å…¶ç‹¬ç«‹çš„PIDï¼Œå³ä¸åŒç”¨æˆ·çš„è¿›ç¨‹é€šè¿‡ pid å‘½åç©ºé—´éš”ç¦»å¼€çš„ï¼Œä¸”ä¸åŒå‘½åç©ºé—´ä¸­å¯ä»¥æœ‰ç›¸åŒ pidå·; æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰å…¶PIDä¸º1çš„rootè¿›ç¨‹ï¼Œä¹Ÿä½¿å¾—å®¹å™¨å¯ä»¥åœ¨ä¸åŒçš„hostä¹‹é—´è¿›è¡Œè¿ç§»(å› ä¸ºnamespaceä¸­çš„è¿›ç¨‹IDå’Œhostä¸æ˜¯å¼ºç»‘å®šï¼Œä½¿å¾—å®¹å™¨ä¸­çš„æ¯ä¸ªè¿›ç¨‹æœ‰ä¸¤ä¸ªPIDå³å®¹å™¨ä¸­PIDå’Œhostä¸Šçš„PID);</td>
</tr>
<tr>
<td style="text-align:center">Network</td>
<td style="text-align:left">ç½‘ç»œè®¾å¤‡ã€ç½‘ç»œæ ˆã€ç«¯å£ç­‰</td>
<td style="text-align:left">æ¯ä¸ª net å‘½åç©ºé—´æœ‰ç‹¬ç«‹çš„ç½‘ç»œè®¾å¤‡ã€IPåœ°å€ã€è·¯ç”±è¡¨ã€/proc/netç›®å½•ã€ç«¯å£å·ç­‰ç­‰ï¼Œè¿™ä¹Ÿä½¿å¾—ä¸€ä¸ªhostä¸Šå¤šä¸ªå®¹å™¨å†…çš„åŒä¸€ä¸ªåº”ç”¨éƒ½ç»‘å®šåˆ°å„è‡ªçš„80ç«¯å£ä¸Š,Docker é»˜è®¤é‡‡ç”¨ veth çš„æ–¹å¼ï¼Œå°†å®¹å™¨ä¸­çš„è™šæ‹Ÿç½‘å¡åŒ host ä¸Šçš„ä¸€ ä¸ªDocker ç½‘æ¡¥ docker0 è¿æ¥åœ¨ä¸€èµ·ã€‚</td>
</tr>
<tr>
<td style="text-align:center">Mount (mnt)</td>
<td style="text-align:left">æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹</td>
<td style="text-align:left">ç±»ä¼¼ chrootå°†ä¸€ä¸ªè¿›ç¨‹æ”¾åˆ°ä¸€ä¸ªç‰¹å®šçš„ç›®å½•æ‰§è¡Œ,ä¸ chroot ä¸åŒæ˜¯æ¯ä¸ªå‘½åç©ºé—´ä¸­çš„å®¹å™¨åœ¨ /proc/mounts çš„ä¿¡æ¯åªåŒ…å«æ‰€åœ¨å‘½åç©ºé—´çš„ mount point,å…è®¸ä¸åŒå‘½åç©ºé—´çš„è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç»“æ„ä¸åŒ,ä½¿å¾—è¿›ç¨‹é—´æ–‡ä»¶ç›®å½•éš”ç¦»å¼€æ¥ã€‚</td>
</tr>
</tbody>
</table>
<p>åŸºç¡€ç¤ºä¾‹1-mnt:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä½¿ç”¨tmpfsè¿™ç§åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿæ¥æ¨¡æ‹ŸæŒ‚è½½</span></span><br><span class="line">mkdir /tmp/mnt_isolation</span><br><span class="line"><span class="comment"># 2.ä½¿ç”¨unshare(å†…ç½®å‘½ä»¤åšä½œç”¨æ˜¯ä¸å¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹å°±å¯ä»¥èµ·åˆ°éš”ç¦»æ•ˆæœï¼Œç›¸å½“äºè·³å‡ºåŸå…ˆçš„namespace)éš”ç¦»mnt namespace</span></span><br><span class="line">unshare --mount /bin/bash</span><br><span class="line"><span class="comment"># 3.æŒ‚è½½æˆ‘ä»¬çš„tmpfs</span></span><br><span class="line">mount -t tmpfs tmpfs /tmp/mnt_isolation</span><br><span class="line"><span class="comment"># 4.ç„¶åè¿›å…¥/tmp/mnt_isolationåˆ›å»ºæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cd</span> /tmp/mnt_isolation &amp;&amp; touch linux-mnt-&#123;1..10&#125;</span><br><span class="line"><span class="comment"># 5.æ–°å»ºç«‹ä¸€ä¸ªshellç»ˆç«¯å‘ç°å¹¶æ²¡æœ‰åˆ›å»ºæ–‡ä»¶ï¼›</span></span><br><span class="line">[root@localhost mnt_isolation]$ ls <span class="comment">#ç»ˆç«¯1</span></span><br><span class="line">linux-mnt-1   linux-mnt-2  linux-mnt-4  linux-mnt-6  linux-mnt-8</span><br><span class="line">linux-mnt-10  linux-mnt-3  linux-mnt-5  linux-mnt-7  linux-mnt-9</span><br><span class="line"></span><br><span class="line">[root@localhost mnt_isolation]$ ls /tmp/mnt_isolation/ <span class="comment">#ç»ˆç«¯2</span></span><br><span class="line"><span class="comment">#è¾“å‡ºä¸ºç©º</span></span><br></pre></td></tr></table></figure></p>
<p>åŸºç¡€ç¤ºä¾‹2-ipc:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">$ ipcmk --queue</span><br><span class="line">æ¶ˆæ¯é˜Ÿåˆ— idï¼š0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æŸ¥çœ‹åˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">$ ipcs</span><br><span class="line"><span class="comment"># --------- æ¶ˆæ¯é˜Ÿåˆ— -----------</span></span><br><span class="line"><span class="comment"># é”®        msqid      æ‹¥æœ‰è€…  æƒé™     å·²ç”¨å­—èŠ‚æ•° æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"># 0x651dbb47 0          root       644        0            0</span></span><br><span class="line"><span class="comment"># ------------ å…±äº«å†…å­˜æ®µ --------------</span></span><br><span class="line"><span class="comment"># é”®        shmid      æ‹¥æœ‰è€…  æƒé™     å­—èŠ‚     nattch     çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------- ä¿¡å·é‡æ•°ç»„ -----------</span></span><br><span class="line"><span class="comment"># é”®        semid      æ‹¥æœ‰è€…  æƒé™     nsems</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.ä½¿ç”¨unshareå‘½ä»¤è¿›è¡Œéš”ç¦»IPC namespace</span></span><br><span class="line"><span class="variable">$echo</span> $$</span><br><span class="line">78285</span><br><span class="line"><span class="variable">$unshare</span> --ipc /bin/bash  </span><br><span class="line"><span class="variable">$echo</span> $$  <span class="comment">#æ­¤æ—¶å·²ç»åˆ‡æ¢åˆ°æ–°çš„è¿›ç¨‹</span></span><br><span class="line">78468</span><br><span class="line"><span class="variable">$ps</span> aux | grep -E <span class="string">"78468|78285"</span></span><br><span class="line">root      78285  0.0  0.1 117460  3980 pts/1    Ss   00:01   0:00 -bash</span><br><span class="line">root      78468  0.0  0.1 117408  3956 pts/1    S    00:04   0:00 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.å†æ¬¡æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—å‘ç°ä¸ºç©ºï¼Œæ‰€ä»¥è¯å®äº†åœ¨éš”ç¦»çš„Namespaceä¸­åˆ›å»ºçš„å†…å®¹å¤–éƒ¨æ— æ³•çœ‹åˆ°</span></span><br><span class="line">ipcs</span><br><span class="line"><span class="comment"># --------- æ¶ˆæ¯é˜Ÿåˆ— -----------</span></span><br><span class="line"><span class="comment"># é”®        msqid      æ‹¥æœ‰è€…  æƒé™     å·²ç”¨å­—èŠ‚æ•° æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"># ------------ å…±äº«å†…å­˜æ®µ --------------</span></span><br><span class="line"><span class="comment"># é”®        shmid      æ‹¥æœ‰è€…  æƒé™     å­—èŠ‚     nattch     çŠ¶æ€</span></span><br><span class="line"><span class="comment"># --------- ä¿¡å·é‡æ•°ç»„ -----------</span></span><br><span class="line"><span class="comment"># é”®        semid      æ‹¥æœ‰è€…  æƒé™     nsems</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="2-æ§åˆ¶ç»„"><a href="#2-æ§åˆ¶ç»„" class="headerlink" title="2.æ§åˆ¶ç»„"></a>2.æ§åˆ¶ç»„</h5><p>æè¿°:æ§åˆ¶ç»„ï¼ˆControl Groupï¼‰æ˜¯  Linux å†…æ ¸(2.6.24)çš„ä¸€ä¸ªç‰¹æ€§ä¹Ÿæ˜¯å®¹å™¨æœºåˆ¶çš„å¦å¤–ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œä¸»è¦ç”¨æ¥å¯¹å…±äº«èµ„æº(<code>å†…å­˜ã€CPUã€ç£ç›˜ IO ç­‰èµ„æº</code>)è¿›è¡Œéš”ç¦»ã€é™åˆ¶ã€å®¡è®¡ç­‰ï¼ˆç”¨äº<code>èµ„æºæ§åˆ¶</code>ï¼‰ã€‚<br>ç®€å•çš„è¯´Cgroupæ˜¯Linuxå†…æ ¸çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå°†ä»»æ„è¿›ç¨‹è¿›è¡Œåˆ†ç»„åŒ–ç®¡ç†å…·ä½“èµ„æºç®¡ç†å°±æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„ï¼Œå…·ä½“çš„èµ„æºç®¡ç†åŠŸèƒ½ç§°ä¸º<code>Cgroupå­ç³»ç»Ÿæˆ–æ§åˆ¶å™¨</code>ï¼Œå®ƒå¯ä»¥æ§åˆ¶å†…å­˜çš„Memoryæ§åˆ¶å™¨ã€æ§åˆ¶è¿›ç¨‹è°ƒåº¦çš„CPUæ§åˆ¶å™¨å¹¶ä¸”è¿è¡Œä¸­çš„å†…æ ¸å¯ä»¥ä½¿ç”¨Cgroupå­ç³»ç»Ÿ<code>åˆ©ç”¨/proc/cgroupæ¥ç®¡ç†</code>;</p>
<p>å®ç°åŸç†:å°†ä¸€ç»„è¿›ç¨‹æ”¾åœ¨ä¸€ä¸ªæ§åˆ¶ç»„é‡Œï¼Œé€šè¿‡ç»™è¿™ä¸ªæ§åˆ¶ç»„åˆ†é…æŒ‡å®šçš„å¯ç”¨èµ„æºï¼Œè¾¾åˆ°æ§åˆ¶è¿™ä¸€ç»„è¿›ç¨‹å¯ç”¨èµ„æºçš„ç›®çš„ã€‚æ‰€ä»¥<code>åªæœ‰èƒ½æ§åˆ¶åˆ†é…åˆ°å®¹å™¨çš„èµ„æºï¼Œæ‰èƒ½é¿å…å½“å¤šä¸ªå®¹å™¨åŒæ—¶è¿è¡Œæ—¶çš„å¯¹ç³»ç»Ÿèµ„æºçš„ç«äº‰</code>ã€‚<br>å®ç°è§’åº¦: Cgroupå®ç°äº†ä¸€ä¸ªé€šç”¨çš„è¿›ç¨‹åˆ†ç»„çš„æ¶æ„ï¼Œè€Œä¸åŒèµ„æºçš„å…·ä½“ç®¡ç†åˆ™æ˜¯ç”±å„ä¸ªCgroupå­ç³»ç»Ÿå®ç°çš„ã€‚<br>å®ç°æ–¹å¼: cgroupfs <code>Cgroup Driver: cgroupfs</code> æˆ–è€… systemd <code>Cgroup Driver: systemd</code>;</p>
<p>å‘å±•å†å²:</p>
<ul>
<li>åœ¨Cgroupå‡ºç°ä¹‹å‰ï¼Œåªèƒ½é’ˆå¯¹ä¸€ä¸ªè¿›ç¨‹åšä¸€äº›èµ„æºçš„æ§åˆ¶ï¼Œä¾‹å¦‚é€šè¿‡shed_setaffinityç³»ç»Ÿè°ƒç”¨é™å®šä¸€ä¸ªè¿›ç¨‹çš„CPUäº²å’Œæ€§ï¼Œæˆ–è€…ç”¨ulimit<code>é™åˆ¶ä¸€ä¸ªè¿›ç¨‹çš„æ–‡ä»¶ä¸Šé™ã€é™å¤§å°</code>ç­‰;</li>
<li>åœ¨Cgroupå‡ºç°ä¹‹åï¼Œå¯ä»¥å¯¹è¿›ç¨‹è¿›è¡Œäººå‘˜çš„åˆ†ç»„è¿™æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œä¾‹å¦‚å®‰å“çš„åº”ç”¨åˆ†ä¸ºå‰å°ä¸åå°åº”ç”¨ï¼›</li>
</ul>
<p>æ³¨æ„:ä¸åŒå†…æ ¸ç‰ˆæœ¬Cgroupä¸­å®ç°çš„å­ç³»ç»Ÿæœ‰äº›è®¸ä¸åŒï¼Œå½“ç”¨docker runå¯åŠ¨ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„åç§°ç©ºé—´å’Œæ§åˆ¶ç»„é›†åˆï¼›<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3.10.0-1062.18.1.el7.x86_64</span></span><br><span class="line">grep cgroup /proc/mounts | awk -F <span class="string">" "</span> <span class="string">'&#123;print $2 " = " $4&#125;'</span></span><br><span class="line">/sys/fs/cgroup = ro,seclabel,nosuid,nodev,noexec,mode=755</span><br><span class="line">/sys/fs/cgroup/systemd = rw,seclabel,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd</span><br><span class="line">/sys/fs/cgroup/freezer = rw,seclabel,nosuid,nodev,noexec,relatime,freezer</span><br><span class="line">/sys/fs/cgroup/net_cls,net_prio = rw,seclabel,nosuid,nodev,noexec,relatime,net_prio,net_cls</span><br><span class="line">/sys/fs/cgroup/cpu,cpuacct = rw,seclabel,nosuid,nodev,noexec,relatime,cpuacct,cpu</span><br><span class="line">/sys/fs/cgroup/cpuset = rw,seclabel,nosuid,nodev,noexec,relatime,cpuset</span><br><span class="line">/sys/fs/cgroup/perf_event = rw,seclabel,nosuid,nodev,noexec,relatime,perf_event</span><br><span class="line">/sys/fs/cgroup/hugetlb = rw,seclabel,nosuid,nodev,noexec,relatime,hugetlb</span><br><span class="line">/sys/fs/cgroup/pids = rw,seclabel,nosuid,nodev,noexec,relatime,pids</span><br><span class="line">/sys/fs/cgroup/memory = rw,seclabel,nosuid,nodev,noexec,relatime,memory</span><br><span class="line">/sys/fs/cgroup/blkio = rw,seclabel,nosuid,nodev,noexec,relatime,blkio</span><br><span class="line">/sys/fs/cgroup/devices = rw,seclabel,nosuid,nodev,noexec,relatime,devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.7.0-1.el7.elrepo.x86_64</span></span><br><span class="line">grep cgroup /proc/mounts | awk -F <span class="string">" "</span> <span class="string">'&#123;print $2 " = " $4&#125;'</span></span><br><span class="line">/sys/fs/cgroup = ro,nosuid,nodev,noexec,mode=755</span><br><span class="line">/sys/fs/cgroup/systemd = rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd</span><br><span class="line">/sys/fs/cgroup/cpu,cpuacct = rw,nosuid,nodev,noexec,relatime,cpu,cpuacct</span><br><span class="line">/sys/fs/cgroup/memory = rw,nosuid,nodev,noexec,relatime,memory</span><br><span class="line">/sys/fs/cgroup/devices = rw,nosuid,nodev,noexec,relatime,devices  <span class="comment">#ä¸»æœºè®¾å¤‡è¯»å†™èŠ‚ç‚¹åˆ›å»ºæ§åˆ¶</span></span><br><span class="line">/sys/fs/cgroup/blkio = rw,nosuid,nodev,noexec,relatime,blkio</span><br><span class="line">/sys/fs/cgroup/net_cls,net_prio = rw,nosuid,nodev,noexec,relatime,net_cls,net_prio</span><br><span class="line">/sys/fs/cgroup/freezer = rw,nosuid,nodev,noexec,relatime,freezer</span><br><span class="line">/sys/fs/cgroup/rdma = rw,nosuid,nodev,noexec,relatime,rdma  <span class="comment"># å†…æ ¸æ–°å¢</span></span><br><span class="line">/sys/fs/cgroup/hugetlb = rw,nosuid,nodev,noexec,relatime,hugetlb</span><br><span class="line">/sys/fs/cgroup/perf_event = rw,nosuid,nodev,noexec,relatime,perf_event</span><br><span class="line">/sys/fs/cgroup/cpuset = rw,nosuid,nodev,noexec,relatime,cpuset</span><br><span class="line">/sys/fs/cgroup/pids = rw,nosuid,nodev,noexec,relatime,pids</span><br></pre></td></tr></table></figure></p>
<p>ç”±ä¸Šé¢å¯çŸ¥cgroupsåˆ†ä¸ºå¤šä¸ªå­ç³»ç»Ÿï¼Œæ¯ä¸ªç³»ç»Ÿä»£è¡¨ä¸€ç§è®¾æ–½æˆ–è€…è¯´æ˜¯èµ„æºæ§åˆ¶å™¨ï¼Œç”¨æ¥è°ƒåº¦æŸä¸€ç±»çš„èµ„æºä½¿ç”¨ï¼ˆcpu,å†…å­˜,å—è®¾å¤‡ï¼‰ï¼Œåœ¨å®ç°ä¸Šcgroupså¹¶æ²¡æœ‰å¢åŠ æ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯è¡¨ç°ä¸ºä¸€ä¸ªcgroupæ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥æŠŠä¸€ä¸ªæˆ–è€…å¤šä¸ªå­ç³»ç»ŸæŒ‚è½½åˆ°æŸä¸€ä¸ªç›®å½•ä¹‹ä¸­;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‚è½½cpuå­ç³»ç»Ÿåˆ° /sys/fs/cgroup/cpu</span></span><br><span class="line">mount -t cgroup -o cpu cpu /sys/fs/cgroup/cpu</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹</span></span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,cpuset)</span><br></pre></td></tr></table></figure></p>
<p>åŸºç¡€å®ä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç¤ºä¾‹1.åˆ†é…å’Œé™åˆ¶å†…å­˜å’ŒCPUä½¿ç”¨</span></span><br><span class="line">docker run -itd --cpus=<span class="string">"1.5"</span> --cpuset-cpus=<span class="string">"0-1"</span> --cpuset-mems=<span class="string">"0"</span> busybox sleep 6000  <span class="comment">#å¸¸è§„åˆ†é…æŒ‡å®šcpuèŠ‚ç‚¹</span></span><br><span class="line">docker run -itd --memory 512m --memory-swap 1g busybox sleep 6000     <span class="comment">#åˆ†é…æŒ‡å®šå†…å­˜ -m.--memory 512m</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¤ºä¾‹2.ä¸ºå®¹å™¨æ·»åŠ ä¸€ä¸ªä¸»æœºè®¾å¤‡</span></span><br><span class="line">docker run -itd --name=demo --device=/dev/sda3 busybox sleep 6000</span><br><span class="line">docker <span class="built_in">exec</span> -it demo ls /dev/sda3</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®ä¾‹3.CPUè°ƒåº¦ä¸èµ„æºé™åˆ¶</span></span><br><span class="line">docker run -itd calico/cni -c 512 --cpuset-cpus=<span class="string">"0"</span>   <span class="comment"># -c cpuæƒé‡ </span></span><br><span class="line">docker run -itd busybox -c 1024 --cpuset-cpus=<span class="string">"1,2"</span>   <span class="comment"># è®©ä¸€ä¸ªcgroupä½¿ç”¨cpuçš„1/3,åŒæ—¶å¦å¤–ä¸€ä¸ªcgroupä½¿ç”¨è¯¥cpuçš„2/3(æ ¹æ®cgroupç»„æ¥åˆ’åˆ†)</span></span><br><span class="line">docker run -itd calico/cni --memory 512m --memory-swap 1g --cpu-period=1000000 --cpu-quota=950000 <span class="comment"># docker 1.12 åŠå…¶ä¹‹å‰ç‰ˆæœ¬</span></span><br><span class="line">docker run -itd calico/cni --memory 512m --memory-swap 1g --cpu-rt-runtime 950000               <span class="comment"># å®Œå…¨å…¬å¹³è°ƒåº¦ CFS scheduler</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h6 id="å­ç³»ç»Ÿä¹‹Devices"><a href="#å­ç³»ç»Ÿä¹‹Devices" class="headerlink" title="å­ç³»ç»Ÿä¹‹Devices"></a>å­ç³»ç»Ÿä¹‹Devices</h6><p>æè¿°:å…¶ä½œç”¨äºæ§åˆ¶Cgroupçš„è¿›ç¨‹å¯¹é‚£äº›è®¾å¤‡å…·æœ‰è®¿é—®çš„æƒé™;<br>æ¥å£å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¨å±€</span></span><br><span class="line">cat /sys/fs/cgroup/devices/devices.list</span><br><span class="line"><span class="comment"># a *:* rwm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker åº”ç”¨å…¨å±€</span></span><br><span class="line">cat /sys/fs/cgroup/devices/docker/devices.list</span><br><span class="line"><span class="comment"># a *:* rwm</span></span><br><span class="line">ls -l /sys/fs/cgroup/devices/devices.allow</span><br><span class="line">--w-------. 1 root root 0 6æœˆ  15 09:46 /sys/fs/cgroup/devices/devices.allow</span><br><span class="line">ls -l /sys/fs/cgroup/devices/devices.deny</span><br><span class="line">--w-------. 1 root root 0 6æœˆ  15 09:46 /sys/fs/cgroup/devices/devices.deny</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker å®¹å™¨è®¾ç½®</span></span><br><span class="line"><span class="variable">$docker</span> ps</span><br><span class="line">25d2d645bfc9        test1               <span class="string">"top -b -d 2"</span>       2 weeks ago   </span><br><span class="line">cat /sys/fs/cgroup/devices/docker/25d2d645bfc9e6530039d6aac890f69dd9af33f8f966adc2d7287b74964678e3/devices.list</span><br><span class="line">c 1:5 rwm</span><br><span class="line">c 1:3 rwm</span><br><span class="line">c 1:9 rwm</span><br><span class="line">c 1:8 rwm <span class="comment">#brw-rw----. 1 root disk 8, 0 6æœˆ  15 09:46 /dev/sda</span></span><br><span class="line">c 5:0 rwm</span><br><span class="line">c 5:1 rwm</span><br><span class="line">c *:* m</span><br><span class="line">b *:* m</span><br><span class="line">c 1:7 rwm <span class="comment">#lrwxrwxrwx. 1 root root 7 6æœˆ  15 09:46 /dev/mapper/centos-app -&gt; ../dm-2</span></span><br><span class="line">c 136:* rwm</span><br><span class="line">c 5:2 rwm</span><br><span class="line">c 10:200 rwm</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰‹åŠ¨åˆ›å»ºDevices</span></span><br><span class="line">mkdir /sys/fs/cgroup/devices/testgroup <span class="comment">#åˆ›å»ºä¸€ä¸ªæ§åˆ¶ç»„</span></span><br><span class="line">ls /sys/fs/cgroup/devices/testgroup  <span class="comment">#é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„æ§åˆ¶ç»„å¯ä»¥è®¿é—®å…¨éƒ¨è®¾å¤‡</span></span><br><span class="line"><span class="comment"># cgroup.clone_children  cgroup.procs   devices.deny  notify_on_release</span></span><br><span class="line"><span class="comment"># cgroup.event_control   devices.allow  devices.list  tasks</span></span><br><span class="line">cat devices.list</span><br><span class="line"><span class="comment"># a *:* rwm</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">'c 1:3 rwm'</span> &gt; /sys/fs/cgroup/devices/testgroup/devices.deny <span class="comment">#å¯¹testgroupç»„ç¦æ­¢å­—ç¬¦è®¾å¤‡/dev/null è¯»å†™ä»¥åŠåˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="built_in">echo</span> $$ &gt; /sys/fs/cgroup/devices/testgroup/tasks <span class="comment">#å°†å½“å‰è¿›ç¨‹å·åŠ å…¥ä»»åŠ¡ä¸­</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"hello world"</span> &gt; /dev/null  <span class="comment">#ç”±äºç»„è®¾ç½®äº†å¯¹å­—ç¬¦è®¾å¤‡/dev/nullè¿›è¡Œå†™é™åˆ¶ï¼Œæ‰€ä»¥ä¸‹é¢å†™è¯·æ±‚å¤±è´¥</span></span><br><span class="line"><span class="comment"># -bash: /dev/null: ä¸å…è®¸çš„æ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $$ è¡¨ç¤ºå½“å‰bashè¿›ç¨‹çš„PIDç­‰ä»·äº$BASHPID</span></span><br><span class="line">cat /sys/fs/cgroup/devices/testgroup/tasks</span><br><span class="line"><span class="comment"># 123453</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$BASHPID</span></span><br><span class="line"><span class="comment"># 123453</span></span><br></pre></td></tr></table></figure><br>æ¥å£è¯´æ˜:</p>
<ul>
<li>(1) devices.list: åªè¯»æ–‡ä»¶ä¸‹è½½å½“å‰å…è®¸è¢«è®¿é—®çš„è®¾å¤‡åˆ—è¡¨ï¼ˆæ¯ä¸ªæ¡æ¯æœ‰ä¸‰ä¸ªåŸŸï¼‰<ul>
<li>ç±»å‹: a(æ‰€æœ‰è®¾å¤‡)ï¼Œbï¼ˆå—è®¾å¤‡ï¼‰ï¼Œcï¼ˆå­—ç¬¦è®¾å¤‡ï¼‰</li>
<li>è®¾å¤‡å·: æ ¼å¼ä¸ºmajor:minorè®¾å¤‡å·</li>
<li>æƒé™: r w m(åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹mknod)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç¤ºä¾‹æ¼”ç¤º</span></span><br><span class="line">a *:* rwm <span class="comment">#è¡¨ç¤ºæ‰€æœ‰è®¾å¤‡éƒ½å¯ä»¥è®¿é—®</span></span><br><span class="line">c 1:3 r   <span class="comment">#è¡¨ç¤ºå­—ç¬¦è®¾å¤‡åªæœ‰ä¸€ä¸ªè¯»æƒé™</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>(2) devices.allowï¼šåªå†™æ–‡ä»¶ä¸èƒ½è¯»å–ï¼Œå…è®¸æŒ‡å®šçš„è®¾å¤‡è®¿é—®æƒé™;</li>
<li>(3) devices.deny: ä¸ä¸Šå‘¨ä½œç”¨ç›¸åï¼Œç¦æ­¢æŒ‡å®šè®¾å¤‡çš„è®¿é—®æƒé™;</li>
</ul>
<p><br></p>
<h6 id="å­ç³»ç»Ÿä¹‹cpuset"><a href="#å­ç³»ç»Ÿä¹‹cpuset" class="headerlink" title="å­ç³»ç»Ÿä¹‹cpuset"></a>å­ç³»ç»Ÿä¹‹cpuset</h6><p>æè¿°:å…¶ä½œç”¨äºåˆ†é…æŒ‡å®šçš„CPUå’Œå†…å­˜èŠ‚ç‚¹ä»¥æ­¤æ¥é™å®šè¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„cpuæ ¸å¿ƒå’Œå†…å­˜èŠ‚ç‚¹ï¼Œç°å¹¿æ³›ç”¨äºKVMåœºæ™¯ä¹‹ä¸­ï¼›</p>
<p>åŸºç¡€å®ä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#(1) åˆ›å»ºä¸€ä¸ªæ§åˆ¶ç»„</span></span><br><span class="line">mkdir /sys/fs/cgroup/cpuset/testgroup</span><br><span class="line"><span class="comment">#(2) é™åˆ¶æ§åˆ¶ç»„åªèƒ½ä½¿ç”¨å†…å­˜èŠ‚ç‚¹0å’Œcpu0ä¸cpu1(ä¸æ‚¨cpuæ ¸å¿ƒæ•°æœ‰å…³ `grep "processor" /proc/cpuinfo`)</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/fs/cgroup/cpuset/testgroup/cpuset.mems</span><br><span class="line"><span class="built_in">echo</span> 0,1 &gt; /sys/fs/cgroup/cpuset/testgroup/cpuset.cpus</span><br><span class="line"><span class="comment">#(3) åŒæ ·å°†å½“å‰è¿›ç¨‹åŠ å…¥æ§åˆ¶ç»„ä¸­</span></span><br><span class="line"><span class="built_in">echo</span> $$ &gt; /sys/fs/cgroup/cpuset/testgroup/tasks</span><br><span class="line"><span class="comment">#(4) éªŒè¯é…ç½®ç»“æœ</span></span><br><span class="line">cat /proc/$$/status | grep <span class="string">"_allowed_list"</span></span><br><span class="line">Cpus_allowed_list:      0-1</span><br><span class="line">Mems_allowed_list:      0</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h6 id="å­ç³»ç»Ÿä¹‹cpu"><a href="#å­ç³»ç»Ÿä¹‹cpu" class="headerlink" title="å­ç³»ç»Ÿä¹‹cpu"></a>å­ç³»ç»Ÿä¹‹cpu</h6><p>æè¿°:å…¶ä½œç”¨æ˜¯é™åˆ¶æ¯ä¸ªè¿›ç¨‹èƒ½å¤Ÿå ç”¨CPUå¤šé•¿æ—¶é—´è¿›è¡Œè®¾ç½®ï¼›æ¯”å¦‚åœ¨æœºå™¨ä¸Šè¿è¡Œå¤šä¸ªå¯èƒ½ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æºçš„è¿›ç¨‹æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å‡ºç°æŸä¸ªç¨‹åºå æ®æ‰€æœ‰çš„ç³»ç»Ÿèµ„æºè€Œå¯¼è‡´å…¶å®ƒç¨‹åºè¿›ç¨‹æ— æ³•æ‰§è¡Œï¼Œä»è€Œå¯¼è‡´ç¨‹åºå‡æ­»çš„çŠ¶æ€,æ­¤æ—¶ä½¿ç”¨<code>cgroupå¯¹CPUçš„è·å–é‡</code>ä¾¿å¯ä»¥æœ‰æ•ˆçš„è¿›è¡Œæ§åˆ¶;<br>æˆ‘ä»¬åœ¨å­¦æ“ä½œç³»ç»ŸåŸç†çš„æ—¶å€™æˆ‘ä»¬çŸ¥é“æ“ä½œç³»ç»Ÿä¸­æœ‰å¤šç§è°ƒåº¦ç­–ç•¥ï¼Œå„ç§è°ƒåº¦ç­–ç•¥é€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯;</p>
<p>å¸¸ç”¨çš„è°ƒåº¦ç¨‹åº:</p>
<ul>
<li>(1) å®Œå…¨å…¬å¹³è°ƒåº¦ Completely Fair Scheduler (CFS): æŒ‰ç…§æ¯”ä¾‹åˆ†é…è°ƒåº¦ç¨‹åºï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§/æƒé‡æˆ–è€…cgroupè·å¾—ä»½é¢ï¼Œåœ¨ä»»åŠ¡ç¾¤ç»„(cgroup)é—´æŒ‰æ¯”ä¾‹åˆ†é…CPUæ—¶é—´(cpuå¸¦å®½)</li>
<li>(2) å®æ—¶è°ƒåº¦ Real-Time Scheduler (RT)ï¼šä»»åŠ¡è°ƒåº¦ç¨‹åºï¼Œå¯ä»¥å¯¹å®æ—¶ä»»åŠ¡ä½¿ç”¨CPUçš„æ—¶é—´è¿›è¡Œé™å®š</li>
</ul>
<p>cpuå­ç³»ç»Ÿæ¥å£ä¸€è§ˆ:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- cpu.shares: èµ„æºç»„çš„CPUä½¿ç”¨æƒé‡å®ƒä¸é™åˆ¶è¿›ç¨‹ä½¿ç”¨ç»å¯¹çš„CPUè€Œæ˜¯æ§åˆ¶å„ç»„ä¹‹é—´çš„é…é¢,é»˜è®¤æƒ…å†µä¸‹Dockerå®¹å™¨ä¸­cpu sharesæƒé‡éƒ½ä¸º1024;</span><br><span class="line"><span class="built_in">echo</span> 512 &gt; /sys/fs/cgroup/cpu/testgroup/cpu.shares</span><br><span class="line"><span class="built_in">echo</span> 1024 &gt; /sys/fs/cgroup/cpu/testgroup1/cpu.shares</span><br><span class="line"></span><br><span class="line">- cpu.cfs_period_us: å®Œå…¨å…¬å¹³è°ƒåº¦ç­–ç•¥ï¼Œç”¨äºç»Ÿè®¡CPUä½¿ç”¨çš„æ—¶é—´å‘¨æœŸï¼ˆæ—¶é—´ç‰‡ä»½æ•°ï¼‰å®ƒå¯ä»¥è®¾å®šé‡æ–°åˆ†é…cgroupçš„å¯ç”¨CPUèµ„æºçš„æ—¶é—´é—´éš”ï¼Œå•ä½ä¸ºå¾®ç§’us(å€¼èŒƒå›´:1000us~1s);</span><br><span class="line">- cpu.cfs_quota_us: å®Œå…¨å…¬å¹³è°ƒåº¦ç­–ç•¥ï¼Œç”¨äºæŸå‘¨æœŸå†…å ç”¨CPUçš„æ—¶é—´(æŒ‡å•æ ¸çš„æ—¶é—´ï¼Œå¤šæ ¸ç€éœ€è¦è®¾ç½®æ—¶ç´¯åŠ )ï¼Œæ­¤å‚æ•°è®¾å®šåŸºäºæ—¶é—´ç‰‡ä»½æ•°æŸä¸ªcgroupä¸­æ‰€æœ‰ä»»åŠ¡å¯è¿è¡Œçš„æ—¶é—´æ€»é‡,å•ä½ä¸ºå¾®ç§’us(é»˜è®¤å€¼ä¸º-1);</span><br><span class="line"><span class="comment">#æ¯”å¦‚:cpu.cfs_period_usè®¾ç½®ä¸º1000000è€Œcpu.cfs_quota_usè®¾ç½®ä¸º200000è¡¨ç¤ºcgroupæ§åˆ¶çš„ä»»åŠ¡ä¸­åœ¨æ¯1ç§’é’Ÿçš„0.2ç§’å¯å•ç‹¬å¯¹CPUè¿›è¡Œå­˜å–;</span></span><br><span class="line"><span class="comment">#æ¯”å¦‚:cpu.cfs_quota_usè®¾ç½®æˆä¸º-1åˆ™è¡¨ç¤ºcgroupä¸éœ€è¦éµå¾ªä»»ä½•CPUæ—¶é—´é™åˆ¶ï¼Œè¿™ä¹Ÿæ˜¯æ¯ä¸ªcgroupçš„é»˜è®¤å€¼ï¼›</span></span><br><span class="line">ç®€å•æ¥è¯´:åœ¨CFSè°ƒåº¦ä¸‹periodè®¾ç½®ä¸º1så¹¶ä¸”quotaè®¾ç½®ä¸º0.5sï¼Œé‚£ä¹ˆåœ¨cgroupè¿›ç¨‹ä¸­æœ€å¤šå¯ä»¥è¿è¡Œ0.5sç„¶åè¢«å¼ºåˆ¶ä¼‘çœ åªèƒ½ç­‰å¾…ä¸‹ä¸€ç§’æ‰èƒ½ç»§ç»­è¿è¡Œ;</span><br><span class="line"><span class="comment">#ç¤ºä¾‹:å‡è®¾CPU&gt;=4æ ¸å¿ƒè¡¨ç¤ºè¿™ä¸ªç»„åœ¨ä¸€ä¸ªä½¿ç”¨å‘¨æœŸ(1s)å†…å¯ä»¥è·‘æ»¡4æ ¸èµ„æºï¼›</span></span><br><span class="line"><span class="built_in">echo</span> 1000000 &gt; /sys/fs/cgroup/cpu/testgroup/cpu.cfs_period_us</span><br><span class="line"><span class="built_in">echo</span> 1000000 &gt; /sys/fs/cgroup/cpu/testgroup/cpu.cfs_quota_us</span><br><span class="line"></span><br><span class="line">- cpu.rt_period_us: å®æ—¶è°ƒåº¦ç­–ç•¥ï¼Œè®¾ç½®æŸä¸ªæ—¶é—´æ®µä¸­æ¯éš”å¤šä¹…cgroupå¯¹CPUèµ„æºçš„å­˜å‚¨å°±è¦é‡æ–°åˆ†é…ï¼Œå•ä½ä¸ºå¾®ç§’ï¼ˆæ³¨æ„:åªå¯ä»¥ç”¨äºå®æ—¶è°ƒåº¦çš„ç¨‹åºï¼‰</span><br><span class="line">- cpu.rt_runtime_us: å®æ—¶è°ƒåº¦ç­–ç•¥ï¼Œè®¾ç½®æŸä¸ªæ—¶é—´æ®µå†…cgroupä¸­ä»»åŠ¡å¯¹CPUèµ„æºçš„æœ€é•¿è¿ç»­è®¿é—®æ—¶é—´ï¼Œå•ä½ä¸ºå¾®ç§’ï¼ˆæ³¨æ„:åªå¯ä»¥ç”¨äºå®æ—¶è°ƒåº¦çš„ç¨‹åºï¼‰</span><br><span class="line"><span class="comment">#æ¯”å¦‚:æˆ‘ä»¬å®¿ä¸»æœºä¸­çš„å†…æ ¸å‚æ•°è®¾ç½®å¦‚ä¸‹ï¼Œè¡¨ç¤ºå®æ—¶è¿›ç¨‹åœ¨è¿è¡Œæ—¶å€™å¹¶ä¸æ˜¯å®Œå…¨å ç”¨CPUçš„ï¼Œè¿™æ ·è®¾ç½®çš„å¥½å¤„æ˜¯å³ä¸ä¼šå¯¹å®æ—¶ä»»åŠ¡å“åº”æ—¶é—´å¯¼è‡´å¤§çš„å½±å“ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†å®æ—¶ä»»åŠ¡å¡ä½æ—¶å¯¼è‡´æ•´ä¸ªç³»ç»Ÿæ— å“åº”;</span></span><br><span class="line">sysctl -a | grep <span class="string">"sched_rt"</span></span><br><span class="line">kernel.sched_rt_period_us = 1000000</span><br><span class="line">kernel.sched_rt_runtime_us = 950000</span><br></pre></td></tr></table></figure></p>
<p><strong>FAQè¡¥å……:</strong><br>Q:#RTè°ƒåº¦ä¸CFSè°ƒåº¦åŒºåˆ«ï¼Ÿ<br>ç­”:ä¸¤åˆ™å¼ºåˆ¶ä¸Šé™ç±»ä¼¼ï¼Œä½†RTåªæ˜¯é™åˆ¶å®æ—¶ä»»åŠ¡ï¼ˆå¯¹å“åº”æ—¶é—´é«˜è¦æ±‚çš„è¿›ç¨‹ï¼‰å¯¹cpuçš„å­˜å–ï¼Œè¿™ç±»è¿›ç¨‹éœ€è¦åœ¨é™å®šçš„æ—¶é—´å†…å¤„ç†å¹¶å®Œæˆç”¨æˆ·çš„è¯·æ±‚ï¼Œå› æ­¤åœ¨é™å®šçš„æ—¶é—´å†…æ‰€å ç”¨çš„CPUèµ„æºä¸èƒ½è¢«å…¶å®ƒè¿›ç¨‹æ‰“æ–­æˆ–è€…å ç”¨; å¦‚æœæ­¤æ—¶å®æ—¶è¿›ç¨‹ä¸­å‡ºç°ç±»ä¼¼æ­»å¾ªç¯ä¹‹ç±»çš„æƒ…å†µä¸‹å°±ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿæ— å“åº”ï¼Œå› ä¸ºå®æ—¶è¿›ç¨‹ä¸­CPUæƒé™æœ€é«˜å¹¶ä¸”åœ¨æœªå®Œæˆä»»åŠ¡å‰ä¸ä¼šé‡Šæ”¾CPUèµ„æº;</p>
<p><br></p>
<h6 id="å­ç³»ç»Ÿä¹‹cpuacct"><a href="#å­ç³»ç»Ÿä¹‹cpuacct" class="headerlink" title="å­ç³»ç»Ÿä¹‹cpuacct"></a>å­ç³»ç»Ÿä¹‹cpuacct</h6><p>æè¿°:CPUç»Ÿè®¡(CPU accounting)å­ç³»ç»Ÿä¼šè‡ªåŠ¨ç”ŸæˆæŠ¥å‘Šæ¥æ˜¾ç¤ºcgroupä»»åŠ¡æ‰€ä½¿ç”¨çš„cpuèµ„æºï¼Œå…¶ä¸­åŒ…æ‹¬å­ç¾¤ç»„ä»»åŠ¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ls /sys/fs/cgroup/cpu,cpuacct | grep <span class="string">"cpuacct"</span></span><br><span class="line">cpuacct.stat    <span class="comment"># æŠ¥å‘Šæ­¤cgroupä¸­æ‰€æœ‰ä»»åŠ¡ï¼ˆåŒ…æ‹¬å±‚çº§ä¸­çš„ä½ç«¯ä»»åŠ¡-ä¸‹åŒï¼‰ä¸­ç”¨æˆ·(ç”¨æˆ·æ¨¡å¼)å’Œç³»ç»Ÿï¼ˆkelnelæ¨¡å¼ï¼‰ä½¿ç”¨çš„CPUæ—¶é—´</span></span><br><span class="line"><span class="comment"># user 350140</span></span><br><span class="line"><span class="comment"># system 344690</span></span><br><span class="line"></span><br><span class="line">cpuacct.usage   <span class="comment"># æŠ¥å‘Šæ­¤cgroupä¸­æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨CPUçš„æ€»æ—¶é—´</span></span><br><span class="line"><span class="comment"># 13713389123644</span></span><br><span class="line"></span><br><span class="line">cpuacct.usage_percpu <span class="comment">#æŠ¥å‘Šcgroupä¸­æ‰€æœ‰ä»»åŠ¡æ¯ä¸ªCPUä½¿ç”¨æ—¶é—´ï¼ˆå•ä½çº³ç§’ï¼‰</span></span><br><span class="line"><span class="comment"># 6911595096356 6801848202718</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h6 id="å­ç³»ç»Ÿä¹‹memory"><a href="#å­ç³»ç»Ÿä¹‹memory" class="headerlink" title="å­ç³»ç»Ÿä¹‹memory"></a>å­ç³»ç»Ÿä¹‹memory</h6><p>æè¿°:å…¶ä½œç”¨æ˜¯ç”¨æ¥é™åˆ¶Cgroupç»„æ‰€èƒ½ä½¿ç”¨çš„å†…å­˜ï¼Œä¸»è¦æ¥å£:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ls /sys/fs/cgroup/memory | grep <span class="string">"memory."</span></span><br><span class="line"></span><br><span class="line">memory.kmem.limit_in_bytes  <span class="comment">#è®¾ç½®å†…å­˜ä½¿ç”¨ä¸Šçº¿ï¼Œå•ä½å¯ä»¥ä½¿ç”¨k/K,m/M,g/GDç­‰;</span></span><br><span class="line">memory.memsw.limit_in_bytes <span class="comment">#è®¾ç½®å†…å­˜åŠ ä¸Šäº¤æ¢åˆ†åŒºçš„ä½¿ç”¨æ€»é‡ï¼Œé˜²æ­¢è¿›ç¨‹æŠŠäº¤æ¢åˆ†åŒºè€—å…‰;</span></span><br><span class="line">memory.stat         <span class="comment">#æ±‡æŠ¥å†…å­˜ä½¿ç”¨ä¿¡æ¯åŒ…æ‹¬å½“å‰èµ„æºæ€»é‡ï¼Œä½¿ç”¨é‡ï¼Œæ¢é¡µæ¬¡æ•°ï¼Œæ´»åŠ¨é¡µæ•°é‡ç­‰ç­‰;</span></span><br><span class="line">memory.oom_control  <span class="comment">#ç”¨æ¥å†³å®šä¸€ä¸ªè¿›ç¨‹åœ¨ç”³è¯·å†…å­˜è¶…é™æ—¶å€™ï¼Œæ˜¯å¦ä¼šè¢«ç³»ç»Ÿkillæ‰ï¼Œé‡‡ç”¨0æˆ–1æ¥å¼€å¯æˆ–è€…å…³é—­cgroupçš„OOM killeré»˜è®¤å¼€å¯ï¼ˆoom_kill_disable 0ï¼‰;</span></span><br><span class="line"><span class="comment"># - 0 å¦‚æœå¼€å¯ä»»åŠ¡è¿›ç¨‹å°è¯•ç”³è¯·å†…å­˜è¶…è¿‡å…è®¸ï¼Œå°±ä¼šè¢«ç³»ç»ŸOOM Killerç»ˆæ­¢;</span></span><br><span class="line"><span class="comment"># - 1 å¦‚æœå…³é—­ä»»åŠ¡è¿›ç¨‹å°è¯•ç”³è¯·å†…å­˜è¶…è¿‡å…è®¸ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«æš‚åœï¼Œç›´åˆ°é¢å¤–çš„å†…å­˜è¢«é‡Šæ”¾;</span></span><br><span class="line">memory.swappiness  <span class="comment">#è®¾ç½®å†…å­˜äº¤æ¢æ¡ä»¶ï¼Œå¯¹äºä½¿ç”¨swapç©ºé—´æœ‰å¾ˆå¤§çš„é‡è¦æ€§;</span></span><br><span class="line">memory.failcnt</span><br><span class="line">memory.force_empty</span><br><span class="line">memory.kmem.failcnt</span><br><span class="line">memory.kmem.max_usage_in_bytes</span><br><span class="line">memory.kmem.slabinfo</span><br><span class="line">memory.kmem.tcp.failcnt</span><br><span class="line">memory.kmem.tcp.limit_in_bytes</span><br><span class="line">memory.kmem.tcp.max_usage_in_bytes</span><br><span class="line">memory.kmem.tcp.usage_in_bytes</span><br><span class="line">memory.kmem.usage_in_bytes</span><br><span class="line">memory.limit_in_bytes</span><br><span class="line">memory.max_usage_in_bytes</span><br><span class="line">memory.memsw.failcnt</span><br><span class="line">memory.memsw.max_usage_in_bytes</span><br><span class="line">memory.memsw.usage_in_bytes</span><br><span class="line">memory.move_charge_at_immigrate</span><br><span class="line">memory.numa_stat</span><br><span class="line">memory.pressure_level</span><br><span class="line">memory.soft_limit_in_bytes</span><br><span class="line">memory.usage_in_bytes</span><br><span class="line">memory.use_hierarchy</span><br></pre></td></tr></table></figure></p>
<p>åŸºç¡€ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.åˆ›å»ºæ§åˆ¶ç»„</span></span><br><span class="line">mkdir  /sys/fs/cgroup/memory/testcagroup</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.è®¾ç½®æ§åˆ¶ç»„ä½¿ç”¨çš„å†…å­˜ä¸Šé™ä½100Mï¼Œä¸”å†…å­˜ä¸swapçš„æ€»é‡ä¸º200M</span></span><br><span class="line"><span class="built_in">echo</span> 100M &gt; /sys/fs/cgroup/memory/testcagroup/memory.limit_in_bytes</span><br><span class="line"><span class="built_in">echo</span> 200M &gt; /sys/fs/cgroup/memory/testcagroup/memory.memsw.limit_in_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.è®¾ç½®æ§åˆ¶ç»„ä¸­å¦‚æœæœ‰è¿›ç¨‹å°è¯•ç”³è¯·å†…å­˜è¶…è¿‡å…è®¸ï¼Œå°±ä¼šè¢«ç³»ç»ŸOOM killeræ‰</span></span><br><span class="line">cat /sys/fs/cgroup/memory/testcagroup/memory.oom_control</span><br><span class="line">oom_kill_disable 1</span><br><span class="line">under_oom 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#4.æŸ¥çœ‹memory.statå› ä¸ºæ§åˆ¶ç»„å†…æ²¡æœ‰æ·»åŠ è¿›ç¨‹ï¼Œæ‰€ä»¥statçš„ä¿¡æ¯ä¸ºç©ºå°†å½“å‰è¿›ç¨‹åŠ å…¥cgroupç»„å†…</span></span><br><span class="line"><span class="variable">$echo</span> $$ &gt; /sys/fs/cgroup/memory/testcagroup/tasks</span><br><span class="line"><span class="variable">$cat</span> memory.stat</span><br><span class="line">cache 0</span><br><span class="line">rss 225280</span><br><span class="line">rss_huge 0</span><br><span class="line">mapped_file 0</span><br><span class="line">swap 0</span><br><span class="line">pgpgin 108</span><br><span class="line">pgpgout 53</span><br><span class="line">pgfault 584</span><br><span class="line">pgmajfault 0</span><br><span class="line">inactive_anon 0</span><br><span class="line">active_anon 200704</span><br><span class="line">inactive_file 0</span><br><span class="line">active_file 0</span><br><span class="line">unevictable 0</span><br><span class="line">hierarchical_memory_limit 104857600</span><br><span class="line">hierarchical_memsw_limit 209715200</span><br><span class="line">total_cache 0</span><br><span class="line">total_rss 225280</span><br><span class="line">total_rss_huge 0</span><br><span class="line">total_mapped_file 0</span><br><span class="line">total_swap 0</span><br><span class="line">total_pgpgin 108</span><br><span class="line">total_pgpgout 53</span><br><span class="line">total_pgfault 584</span><br><span class="line">total_pgmajfault 0</span><br><span class="line">total_inactive_anon 0</span><br><span class="line">total_active_anon 200704</span><br><span class="line">total_inactive_file 0</span><br><span class="line">total_active_file 0</span><br><span class="line">total_unevictable 0</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h6 id="å­ç³»ç»Ÿä¹‹blkio-å—-I-O"><a href="#å­ç³»ç»Ÿä¹‹blkio-å—-I-O" class="headerlink" title="å­ç³»ç»Ÿä¹‹blkio(å— I/O)"></a>å­ç³»ç»Ÿä¹‹blkio(å— I/O)</h6><p>æè¿°:å…¶å­ç³»ç»Ÿå¯ä»¥æ§åˆ¶å¹¶ç›‘æ§cgroupä¸­ä»»åŠ¡å¯¹å—è®¾å¤‡I/Oå­˜å–ï¼Œå¯¹ä¸€äº›ä¼ªæ–‡ä»¶å†™å…¥å€¼å¯ä»¥é™åˆ¶å­˜å–æ¬¡æ•°æˆ–è€…å¸¦å®½ï¼Œä»ä¼ªæ–‡ä»¶ä¸­è¯»å–å€¼å¯ä»¥è·å¾—å…³äºI/Oæ“ä½œç³»ç»Ÿä¿¡æ¯ã€‚</p>
<p>å— I/O blkioå­ç³»ç»Ÿç»™å‡ºä¸¤ç§æ–¹å¼æ¥æ§åˆ¶å¯¹I/Oçš„å­˜å–:</p>
<ul>
<li>æƒé‡åˆ†é…: ç”¨äºå®Œå…¨å…¬å¹³åˆ—é˜ŸI/Oè°ƒåº¦ç¨‹åº(Completely Fair Queuing I/O Sheduler), ç”¨æ­¤æ–¹æ³•å¯ä»¥ç»™æŒ‡å®šçš„cgroupè®¾ç½®æƒé‡ï¼›æ„å‘³ç€æ¯ä¸ªcgroupéƒ½æœ‰ä¸€ä¸ªé¢„ç•™çš„I/Oæ“ä½œè®¾å®šæ¯”ä¾‹(å³æƒé‡)</li>
<li>I/O èŠ‚æµä¸Šé™: å½“ä¸€ä¸ªæŒ‡å®šè®¾å¤‡æ‰§è¡ŒI/Oæ“ä½œæ—¶ï¼Œç”¨æ­¤æ–¹æ³•å¯ä¸ºå…¶æ“ä½œæ¬¡æ•°è®¾å®šä¸Šé™ï¼›æ„å‘³ç€ä¸€ä¸ªè®¾å¤‡çš„è¯»æˆ–è€…å†™çš„æ“ä½œæ¬¡æ•°æ˜¯å¯ä»¥é™å®šçš„;</li>
</ul>
<p>åŸºæœ¬ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤æƒé‡ä¸º1000</span></span><br><span class="line">cat /sys/fs/cgroup/blkio/blkio.weight</span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º2ä¸ªæ§åˆ¶ç»„å¹¶è®¾ç½®æƒé‡</span></span><br><span class="line">mkdir/sys/fs/cgroup/blkio/mygroup&#123;1,2&#125;</span><br><span class="line"><span class="built_in">echo</span> 500 &gt; /sys/fs/cgroup/blkio/mygroup1/blkio.weight</span><br><span class="line"><span class="built_in">echo</span> 100 &gt; /sys/fs/cgroup/blkio/mygroup2/blkio.weight</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶ç¦»cgexecå‘½ä»¤åœ¨æ¸…ç©ºç¼“å­˜åé‡‡ç”¨ddè¯»å†™ï¼ˆå¯ä»¥ä»¥æ­¤åŒºåˆ«ä¸¤ä¸ªæ§åˆ¶ç»„çš„è¯»å†™æ¯”ä¾‹åœ¨5:1å·¦å³ï¼‰</span></span><br><span class="line">cgexec -g <span class="string">"blkio:mygroup1"</span> dd bs=1M count=4096 <span class="keyword">if</span>=file1 of=/dev/null</span><br><span class="line">cgexec -g <span class="string">"blkio:mygroup2"</span> dd bs=1M count=4096 <span class="keyword">if</span>=file1 of=/dev/null</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="3-Union-æ–‡ä»¶ç³»ç»Ÿ"><a href="#3-Union-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="3.Union æ–‡ä»¶ç³»ç»Ÿ"></a>3.Union æ–‡ä»¶ç³»ç»Ÿ</h5><p>è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnionFSï¼‰æ˜¯ä¸€ç§åˆ†å±‚ã€è½»é‡çº§å¹¶ä¸”é«˜æ€§èƒ½çš„æ–‡ä»¶ç³»ç»Ÿä¹Ÿæ˜¯ Docker é•œåƒçš„åŸºç¡€ï¼Œå®ƒæ”¯æŒå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ä½œä¸ºä¸€æ¬¡æäº¤æ¥ä¸€å±‚å±‚çš„å åŠ ï¼ŒåŒæ—¶å¯ä»¥å°†ä¸åŒç›®å½•æŒ‚è½½åˆ°åŒä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹(unite several directories into a single virtual filesystem)ã€‚</p>
<p>Docker ç›®å‰æ”¯æŒçš„è”åˆæ–‡ä»¶ç³»ç»ŸåŒ…æ‹¬ OverlayFS, AUFS, Btrfs, VFS, ZFS å’Œ Device Mapper,åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œæ¨èä½¿ç”¨ <code>overlay2 å­˜å‚¨é©±åŠ¨</code>å®ƒæ˜¯ç›®å‰ Docker é»˜è®¤çš„å­˜å‚¨é©±åŠ¨;</p>
<p><em>ä½¿ç”¨çš„å¥½å¤„ï¼š</em><br>é•œåƒå¯ä»¥é€šè¿‡åˆ†å±‚æ¥è¿›è¡Œç»§æ‰¿ï¼ˆå¯¹äºä¿®æ”¹é‡‡ç”¨åˆ†å±‚å­˜å‚¨ï¼‰ï¼ŒåŸºäºåŸºç¡€é•œåƒï¼ˆæ²¡æœ‰çˆ¶é•œåƒï¼‰ï¼Œå¯ä»¥åˆ¶ä½œå„ç§å…·ä½“çš„åº”ç”¨é•œåƒã€‚å¦å¤–ä¸åŒ Docker å®¹å™¨å°±å¯ä»¥å…±äº«ä¸€äº›åŸºç¡€çš„æ–‡ä»¶ç³»ç»Ÿå±‚ï¼ŒåŒæ—¶å†åŠ ä¸Šè‡ªå·±ç‹¬æœ‰çš„æ”¹åŠ¨å±‚ï¼Œå¤§å¤§æé«˜äº†å­˜å‚¨çš„æ•ˆç‡ã€‚</p>
<p>Docker ä¸­ä½¿ç”¨çš„ AUFSï¼ˆAnotherUnionFSï¼‰å°±æ˜¯ä¸€ç§è”åˆæ–‡ä»¶ç³»ç»Ÿã€‚ </p>
<ul>
<li>AUFS æ”¯æŒä¸ºæ¯ä¸€ä¸ªæˆå‘˜ç›®å½•ï¼ˆç±»ä¼¼ Git çš„åˆ†æ”¯ï¼‰è®¾å®šåªè¯»ï¼ˆreadonlyï¼‰ã€è¯»å†™ï¼ˆreadwriteï¼‰å’Œå†™å‡ºï¼ˆwhiteout-ableï¼‰æƒé™, </li>
<li>åŒæ—¶ AUFS é‡Œæœ‰ä¸€ä¸ªç±»ä¼¼åˆ†å±‚çš„æ¦‚å¿µ, å¯¹åªè¯»æƒé™çš„åˆ†æ”¯å¯ä»¥é€»è¾‘ä¸Šè¿›è¡Œå¢é‡åœ°ä¿®æ”¹(ä¸å½±å“åªè¯»éƒ¨åˆ†çš„)ã€‚</li>
</ul>
<p><br></p>
<h5 id="4-å®¹å™¨æ ¼å¼"><a href="#4-å®¹å™¨æ ¼å¼" class="headerlink" title="4.å®¹å™¨æ ¼å¼"></a>4.å®¹å™¨æ ¼å¼</h5><p>æœ€åˆï¼ŒDocker é‡‡ç”¨äº† LXC ä¸­çš„å®¹å™¨æ ¼å¼ã€‚<br>ä» 0.7 ç‰ˆæœ¬ä»¥åå¼€å§‹å»é™¤ LXCï¼Œè½¬è€Œä½¿ç”¨è‡ªè¡Œå¼€å‘çš„ libcontainerï¼Œä» 1.11 å¼€å§‹ï¼Œåˆ™è¿›ä¸€æ­¥æ¼”è¿›ä¸ºä½¿ç”¨ runC å’Œ containerdã€‚</p>
<p><em>Docker ä¸ LXCï¼ˆLinux Containerï¼‰æœ‰ä½•ä¸åŒï¼Ÿ</em><br>*ç­”ï¼šLXC åˆ©ç”¨ Linux ä¸Šç›¸å…³æŠ€æœ¯å®ç°äº†å®¹å™¨ï¼ŒDocker åˆ™åœ¨å¦‚ä¸‹çš„å‡ ä¸ªæ–¹é¢è¿›è¡Œäº†æ”¹è¿›ï¼š</p>
<ul>
<li>ç§»æ¤æ€§ï¼šé€šè¿‡æŠ½è±¡å®¹å™¨é…ç½®ï¼Œå®¹å™¨å¯ä»¥å®ç°ä»ä¸€ä¸ªå¹³å°ç§»æ¤åˆ°å¦ä¸€ä¸ªå¹³å°ï¼›</li>
<li>é•œåƒç³»ç»Ÿï¼šåŸºäº AUFS çš„é•œåƒç³»ç»Ÿä¸ºå®¹å™¨çš„åˆ†å‘å¸¦æ¥äº†å¾ˆå¤šçš„ä¾¿åˆ©ï¼ŒåŒæ—¶å…±åŒçš„é•œåƒå±‚åªéœ€è¦å­˜å‚¨ä¸€ä»½ï¼Œå®ç°é«˜æ•ˆç‡çš„å­˜å‚¨ï¼›</li>
<li>ç‰ˆæœ¬ç®¡ç†ï¼šç±»ä¼¼äºGitçš„ç‰ˆæœ¬ç®¡ç†ç†å¿µï¼Œç”¨æˆ·å¯ä»¥æ›´æ–¹ä¾¿çš„åˆ›å»ºã€ç®¡ç†é•œåƒæ–‡ä»¶ï¼›</li>
<li>ä»“åº“ç³»ç»Ÿï¼šä»“åº“ç³»ç»Ÿå¤§å¤§é™ä½äº†é•œåƒçš„åˆ†å‘å’Œç®¡ç†çš„æˆæœ¬ï¼›</li>
<li>å‘¨è¾¹å·¥å…·ï¼šå„ç§ç°æœ‰å·¥å…·ï¼ˆé…ç½®ç®¡ç†ã€äº‘å¹³å°ï¼‰å¯¹ Docker çš„æ”¯æŒï¼Œä»¥åŠåŸºäº Dockerçš„ PaaSã€CI ç­‰ç³»ç»Ÿï¼Œè®© Docker çš„åº”ç”¨æ›´åŠ æ–¹ä¾¿å’Œå¤šæ ·åŒ–ã€‚</li>
</ul>
<p><br></p>
<p><em>Docker ä¸ Vagrant æœ‰ä½•ä¸åŒï¼Ÿ</em><br>ç­”ï¼šä¸¤è€…çš„å®šä½å®Œå…¨ä¸åŒã€‚</p>
<ul>
<li>Vagrant ç±»ä¼¼ Boot2Dockerï¼ˆä¸€æ¬¾è¿è¡Œ Docker çš„æœ€å°å†…æ ¸ï¼‰ï¼Œæ˜¯ä¸€å¥—è™šæ‹Ÿæœºçš„ç®¡ç†ç¯å¢ƒã€‚Vagrant å¯ä»¥åœ¨å¤šç§ç³»ç»Ÿä¸Šå’Œè™šæ‹Ÿæœºè½¯ä»¶ä¸­è¿è¡Œï¼Œå¯ä»¥åœ¨ Windowsï¼ŒMac ç­‰é Linux å¹³å°ä¸Šä¸º Docker æä¾›æ”¯æŒï¼Œè‡ªèº«å…·æœ‰è¾ƒå¥½çš„åŒ…è£…æ€§å’Œç§»æ¤æ€§ã€‚</li>
<li>åŸç”Ÿçš„ Docker è‡ªèº«åªèƒ½è¿è¡Œåœ¨ Linux å¹³å°ä¸Šï¼Œä½†å¯åŠ¨å’Œè¿è¡Œçš„æ€§èƒ½éƒ½æ¯”è™šæ‹Ÿæœºè¦å¿«ï¼Œå¾€å¾€æ›´é€‚åˆå¿«é€Ÿå¼€å‘å’Œéƒ¨ç½²åº”ç”¨çš„åœºæ™¯ã€‚</li>
</ul>
<p><em>ç®€å•è¯´ï¼š</em></p>
<ul>
<li>Docker ä¸æ˜¯è™šæ‹Ÿæœºï¼Œè€Œæ˜¯è¿›ç¨‹éš”ç¦»ï¼Œå¯¹äºèµ„æºçš„æ¶ˆè€—å¾ˆå°‘ï¼Œä½†æ˜¯ç›®å‰éœ€è¦ Linux ç¯å¢ƒæ”¯æŒã€‚</li>
<li>Vagrant æ˜¯è™šæ‹Ÿæœºä¸Šåšçš„å°è£…ï¼Œè™šæ‹Ÿæœºæœ¬èº«ä¼šæ¶ˆè€—èµ„æºã€‚</li>
<li>ä¸€å¥è¯ï¼šVagrant é€‚åˆç”¨æ¥ç®¡ç†è™šæ‹Ÿæœºï¼Œè€Œ Docker é€‚åˆç”¨æ¥ç®¡ç†åº”ç”¨ç¯å¢ƒã€‚</li>
</ul>
<p><br></p>
<h5 id="5-ç½‘ç»œå®ç°"><a href="#5-ç½‘ç»œå®ç°" class="headerlink" title="5.ç½‘ç»œå®ç°"></a>5.ç½‘ç»œå®ç°</h5><p>æè¿°:Docker çš„ç½‘ç»œå®ç°å…¶å®å°±æ˜¯åˆ©ç”¨äº† Linux ä¸Šçš„ç½‘ç»œå‘½åç©ºé—´å’Œè™šæ‹Ÿç½‘ç»œè®¾å¤‡veth(Vritual Enternet Device)ï¼Œvethä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†è·¨NetWork Namespaceä¹‹é—´æä¾›ä¸€ç§ç±»ä¼¼äºLinuxè¿›ç¨‹é—´é€šä¿¡æŠ€æœ¯ï¼Œæ‰€ä»¥vethæ€»æ•°æˆå¯¹å‡ºç°è¿›è¡Œé€šä¿¡å…¶<code>å·¥ä½œåœ¨L2æ•°æ®é“¾è·¯å±‚</code>ï¼Œæ¯”å¦‚veth0ä¸veth1ä»–ä»¬<code>åˆ†åˆ«åœ¨ä¸åŒçš„Network Namespace</code>ï¼Œå…¶ä¸­ä¸€ç«¯Vethè®¾å¤‡ä»»æ„ä¸€ç«¯ä¸ŠRXåˆ°çš„æ•°æ®éƒ½ä¼šåœ¨å¦å¤–ä¸€ç«¯ä¸Šä»¥Txçš„æ–¹å¼å‘é€å‡ºå»ï¼›</p>
<p>å‰é¢æˆ‘ä»¬è¯´è¿‡Linuxä¸‹çš„Dockerå®¹å™¨ç½‘ç»œé€šè¿‡Network Namespaceæœºåˆ¶(<code>/proc/net, IPåœ°å€, ç½‘å¡, è·¯ç”±</code>)å®ç°éš”ç¦»ç½‘ç»œèµ„æºï¼Œä¸åŒçš„Network Namespaceæœ‰å„è‡ªçš„ç½‘ç»œè®¾å¤‡,åè®®æ ˆ,è·¯ç”±å™¨ä»¥åŠé˜²ç«å¢™ï¼ŒåŒä¸€ä¸ªNamepsaceä¸‹çš„è¿›ç¨‹å…±äº«åŒä¸€ä¸ªç½‘ç»œè§†å›¾ï¼›æ‰€ä»¥veth-pairè®¾å¤‡æ¥å£å®ƒåœ¨æœ¬åœ°ä¸»æœºå’Œå®¹å™¨å†…åˆ†åˆ«åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ¥å£(<code>å³:åœ¨ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ä¸­åˆ›å»ºé€šé“</code>)ï¼Œå¹¶è®©å®ƒä»¬å½¼æ­¤è¿é€šå®ç°ç½‘ç»œé€šä¿¡ï¼Œè¯¥è®¾å¤‡åœ¨è½¬å‘æ•°æ®åŒ…è¿‡ç¨‹ä¸­å¹¶ä¸ç¯¡æ”¹æ•°æ®åŒ…å†…å®¹;</p>
<p><strong>åŸºæœ¬åŸç†ï¼š</strong><br>ä¸ºäº†å®ç°Dockerç½‘ç»œä¸­å„ä¸ªå®¹å™¨é€šä¿¡ï¼Œéœ€è¦veth-pairè®¾å¤‡åœ¨æœ¬åœ°ä¸»æœºå’Œå®¹å™¨å†…åˆ†åˆ«åˆ›å»ºè™šæ‹Ÿæ¥å£(<code>Docker ä¸­çš„ç½‘ç»œæ¥å£é»˜è®¤éƒ½æ˜¯è™šæ‹Ÿçš„æ¥å£</code>), ç„¶åLinux é€šè¿‡åœ¨å†…æ ¸ä¸­è¿›è¡Œæ•°æ®å¤åˆ¶æ¥å®ç°è™šæ‹Ÿæ¥å£ä¹‹é—´çš„æ•°æ®è½¬å‘ï¼Œ<code>å‘é€æ¥å£çš„å‘é€ç¼“å­˜ä¸­çš„æ•°æ®åŒ…è¢«ç›´æ¥å¤åˆ¶åˆ°æ¥æ”¶æ¥å£çš„æ¥æ”¶ç¼“å­˜ä¸­</code>ï¼Œå¹¶ä¸”å¯¹äºæœ¬åœ°ç³»ç»Ÿå’Œå®¹å™¨å†…ç³»ç»Ÿçœ‹æ¥å°±åƒæ˜¯ä¸€ä¸ªæ­£å¸¸çš„ä»¥å¤ªç½‘å¡ï¼Œåªæ˜¯å®ƒä¸éœ€è¦çœŸæ­£åŒå¤–éƒ¨ç½‘ç»œè®¾å¤‡é€šä¿¡ï¼Œæ‰€ä»¥é€Ÿåº¦è¦å¿«å¾ˆå¤šåˆ™è½¬å‘æ•ˆç‡è¾ƒé«˜ï¼›æ­¤å¤–å¦‚æœä¸åŒå­ç½‘ä¹‹é—´è¦è¿›è¡Œé€šä¿¡ï¼Œè¿˜éœ€è¦è·¯ç”±æœºåˆ¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.ç½‘æ¡¥å·¥å…·å®‰è£…brctl</span></span><br><span class="line">yum install -y bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.æŸ¥çœ‹ç½‘æ¡¥è¿æ¥ä¿¡æ¯</span></span><br><span class="line"><span class="variable">$brctl</span> show</span><br><span class="line"><span class="comment"># bridge name     bridge id               STP enabled     interfaces</span></span><br><span class="line"><span class="comment"># br-fa08aa7db7a6 8000.0242fb5007f1       no              veth842b243</span></span><br><span class="line"><span class="comment"># docker0         8000.024245b206ce       no              veth985cbf0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.æœºå™¨ç½‘å¡ä¿¡æ¯</span></span><br><span class="line"><span class="variable">$ip</span> addr | grep <span class="string">"BROADCAST"</span></span><br><span class="line"><span class="comment"># 2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span></span><br><span class="line"><span class="comment"># 3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment"># 5: br-fa08aa7db7a6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment"># 57: veth985cbf0@if56: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span></span><br><span class="line"><span class="comment"># 71: veth842b243@if70: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-fa08aa7db7a6 state UP group default</span></span><br></pre></td></tr></table></figure>
<p>å½“é€šè¿‡docker runåˆ›å»ºä¸€ä¸ªå®¹å™¨çš„æ—¶å€™ä¾¿<code>æœ‰äº†å•ç‹¬çš„ç½‘ç»œå‘½åç©ºé—´</code>ï¼Œå®¹å™¨ç½‘ç»œåˆå§‹åŒ–æµç¨‹ï¼š</p>
<ul>
<li>1.åˆ›å»ºä¸€å¯¹è™šæ‹Ÿæ¥å£ï¼Œåˆ†åˆ«æ”¾åˆ°æœ¬åœ°ä¸»æœºå’Œæ–°å®¹å™¨ä¸­ï¼›</li>
<li>2.æœ¬åœ°ä¸»æœºä¸€ç«¯æ¡¥æ¥åˆ°é»˜è®¤çš„ docker0 æˆ–æŒ‡å®šç½‘æ¡¥ä¸Šï¼Œå¹¶å…·æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼Œå¦‚ veth985cbf0@if56ï¼›</li>
<li>3.å®¹å™¨ä¸€ç«¯æ”¾åˆ°æ–°å®¹å™¨ä¸­ï¼Œå¹¶ä¿®æ”¹åå­—ä½œä¸º eth0ï¼Œè¿™ä¸ªæ¥å£åªåœ¨å®¹å™¨çš„å‘½åç©ºé—´å¯è§ï¼›</li>
<li>4.ä»ç½‘æ¡¥å¯ç”¨åœ°å€æ®µä¸­è·å–ä¸€ä¸ªç©ºé—²åœ°å€åˆ†é…ç»™å®¹å™¨çš„ eth0@if57 <code>ç½‘å¡åç§°@è™šæ‹Ÿæ¥å£åºå·</code>ï¼Œå¹¶é…ç½®é»˜è®¤è·¯ç”±åˆ°æ¡¥æ¥ç½‘å¡ veth985cbf0@if56(57)<br>å®Œæˆè¿™äº›ä¹‹åï¼Œå®¹å™¨å°±å¯ä»¥ä½¿ç”¨ eth0 è™šæ‹Ÿç½‘å¡æ¥è¿æ¥å…¶ä»–å®¹å™¨å’Œå…¶ä»–ç½‘ç»œã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç®€å•æè¿°</span></span><br><span class="line">ens192|eth0 &lt;-&gt; docker0 &lt;-&gt; veth985cbf0@56(è™šæ‹Ÿç½‘å¡) &lt;-&gt; eth0@if57(å®¹å™¨å†…éƒ¨)ç½‘å¡</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨å†…éƒ¨ç½‘å¡ä¿¡æ¯</span></span><br><span class="line">docker <span class="built_in">exec</span> -it test1 sh -c ip addr</span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># 56: eth0@if57: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</span></span><br><span class="line"><span class="comment">#     link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#     inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190604143208.png" target="_blank" title="WeiyiGeek.è™šæ‹Ÿæ¥å£åŸç†å›¾" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190604143208.png" alt="WeiyiGeek.è™šæ‹Ÿæ¥å£åŸç†å›¾" title="" class=""></a>
                <p>WeiyiGeek.è™šæ‹Ÿæ¥å£åŸç†å›¾</p>
            </figure>
</li>
</ul>
<p>Docker ä¸­ç½‘ç»œæä¾›äº†äº”ç§æ¨¡å¼ï¼š</p>
<ul>
<li>Bridge æ¨¡å¼</li>
<li>Host æ¨¡å¼</li>
<li>Container æ¨¡å¼(å³:æŒ‡å®šå®¹å™¨ä¹‹é—´é€šä¿¡çš„ç½‘ç»œ)</li>
<li>None æ¨¡å¼</li>
<li>Overtlay</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) Docker network æŸ¥çœ‹</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="comment"># NETWORK ID          NAME                DRIVER(é©±åŠ¨æ¨¡å¼)              SCOPE</span></span><br><span class="line"><span class="comment"># 3448511628ee        bridge              bridge              local</span></span><br><span class="line"><span class="comment"># 5baa8b9f47c3        host                host                local</span></span><br><span class="line"><span class="comment"># afd58da3d80f        none                null                local</span></span><br><span class="line"><span class="comment"># fa08aa7db7a6        opt_default         bridge              local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) ç½‘ç»œåç§°ä¿¡æ¯è¯¦ç»†</span></span><br><span class="line">docker network inspect $(docker network ls -q)</span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         "Name": "bridge",</span></span><br><span class="line"><span class="comment">#         "Id": "3448511628ee3de59985bfa8251a8731148265417530fba645d1f5cca6464ccf",</span></span><br><span class="line"><span class="comment">#         "Created": "2020-07-02T11:21:02.785207578+08:00",</span></span><br><span class="line"><span class="comment">#         "Scope": "local",</span></span><br><span class="line"><span class="comment">#         "Driver": "bridge",</span></span><br><span class="line"><span class="comment">#         "EnableIPv6": false,</span></span><br><span class="line"><span class="comment">#         "IPAM": &#123;</span></span><br><span class="line"><span class="comment">#             "Driver": "default",</span></span><br><span class="line"><span class="comment">#             "Options": null,</span></span><br><span class="line"><span class="comment">#             "Config": [</span></span><br><span class="line"><span class="comment">#                 &#123;</span></span><br><span class="line"><span class="comment">#                     "Subnet": "172.17.0.0/16",</span></span><br><span class="line"><span class="comment">#                     "Gateway": "172.17.0.1"</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             ]</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         "Internal": false,</span></span><br><span class="line"><span class="comment">#         "Attachable": false,</span></span><br><span class="line"><span class="comment">#         "Ingress": false,</span></span><br><span class="line"><span class="comment">#         "ConfigFrom": &#123;</span></span><br><span class="line"><span class="comment">#             "Network": ""</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         "ConfigOnly": false,</span></span><br><span class="line"><span class="comment">#         "Containers": &#123;</span></span><br><span class="line"><span class="comment">#             "25d2d645bfc9e6530039d6aac890f69dd9af33f8f966adc2d7287b74964678e3": &#123;</span></span><br><span class="line"><span class="comment">#                 "Name": "test1",</span></span><br><span class="line"><span class="comment">#                 "EndpointID": "6c825cb11f084e85afddbc993937e6061b2e36ea7dfaa30792b2ea6d0eb414a1",</span></span><br><span class="line"><span class="comment">#                 "MacAddress": "02:42:ac:11:00:02",</span></span><br><span class="line"><span class="comment">#                 "IPv4Address": "172.17.0.2/16",</span></span><br><span class="line"><span class="comment">#                 "IPv6Address": ""</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         "Options": &#123;</span></span><br><span class="line"><span class="comment">#             "com.docker.network.bridge.default_bridge": "true",</span></span><br><span class="line"><span class="comment">#             "com.docker.network.bridge.enable_icc": "true",</span></span><br><span class="line"><span class="comment">#             "com.docker.network.bridge.enable_ip_masquerade": "true",</span></span><br><span class="line"><span class="comment">#             "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",</span></span><br><span class="line"><span class="comment">#             "com.docker.network.bridge.name": "docker0",</span></span><br><span class="line"><span class="comment">#             "com.docker.network.driver.mtu": "1500"</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         "Labels": &#123;&#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br></pre></td></tr></table></figure>
<p><strong>Tips:</strong></p>
<ul>
<li>(1)é€šè¿‡ â€“net å‚æ•°æ¥æŒ‡å®šå®¹å™¨çš„ç½‘ç»œé…ç½®ï¼Œæœ‰4ä¸ªå¯é€‰å€¼ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--net=bridge è¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œè¿æ¥åˆ°é»˜è®¤çš„ç½‘æ¡¥ã€‚</span><br><span class="line">--net=host å‘Šè¯‰Dockerä¸è¦å°†å®¹å™¨ç½‘ç»œæ”¾åˆ°éš”ç¦»çš„å‘½åç©ºé—´ä¸­ï¼Œå³ä¸è¦å®¹å™¨åŒ–å®¹å™¨å†…çš„ç½‘ç»œ</span><br><span class="line">  - æ­¤æ—¶å®¹å™¨ä½¿ç”¨æœ¬åœ°ä¸»æœºçš„ç½‘ç»œï¼Œå®ƒæ‹¥æœ‰å®Œå…¨çš„æœ¬åœ°ä¸»æœºæ¥å£è®¿é—®æƒï¼ˆä¸å®‰å…¨ï¼‰,</span><br><span class="line">  - å¦‚æœè¿›ä¸€æ­¥çš„ä½¿ç”¨ --privileged=<span class="literal">true</span>ï¼Œå®¹å™¨ä¼šè¢«å…è®¸ç›´æ¥é…ç½®ä¸»æœºçš„ç½‘ç»œå †æ ˆã€‚</span><br><span class="line">--net=container:NAME_or_ID  è®©Dockerå°†æ–°å»ºå®¹å™¨çš„è¿›ç¨‹æ”¾åˆ°ä¸€ä¸ªå·²å­˜åœ¨å®¹å™¨çš„ç½‘ç»œæ ˆä¸­ï¼Œæ–°å®¹å™¨è¿›ç¨‹æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨å’Œèµ„æºé™åˆ¶ï¼Œä½†ä¼šå’Œå·²å­˜åœ¨çš„å®¹å™¨å…±äº« IP åœ°å€å’Œç«¯å£ç­‰ç½‘ç»œèµ„æºï¼Œä¸¤è€…è¿›ç¨‹å¯ä»¥ç›´æ¥é€šè¿‡ lo ç¯å›æ¥å£é€šä¿¡ã€‚</span><br><span class="line">--net=none è®© Docker å°†æ–°å®¹å™¨æ”¾åˆ°éš”ç¦»çš„ç½‘ç»œæ ˆä¸­ï¼Œä½†æ˜¯ä¸è¿›è¡Œç½‘ç»œé…ç½®ã€‚ä¹‹åç”¨æˆ·å¯ä»¥è‡ªå·±è¿›è¡Œé…ç½®ã€‚</span><br><span class="line">  - ç”¨æˆ·å¯ä»¥ä½¿ç”¨ ip netns <span class="built_in">exec</span> å‘½ä»¤æ¥åœ¨æŒ‡å®šç½‘ç»œå‘½åç©ºé—´ä¸­è¿›è¡Œé…ç½®ï¼Œä»è€Œé…ç½®å®¹å™¨å†…çš„ç½‘ç»œã€‚</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h6 id="Bridge-æ¨¡å¼"><a href="#Bridge-æ¨¡å¼" class="headerlink" title="Bridge æ¨¡å¼"></a>Bridge æ¨¡å¼</h6><p>æè¿°: è¯¥æ¨¡å¼æ˜¯Dockeré»˜è®¤çš„ä¸€ç§ç½‘ç»œé€šè®¯æ¨¡å¼;</p>
<p>Bridge ç½‘ç»œæ¨¡å¼åŸç†:</p>
<blockquote>
<p>ç­”:Docker Daemon é¦–æ¬¡å¯åŠ¨æ—¶å€™ï¼Œä¼šåœ¨å…¶æ‰€åœ¨çš„å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºDocker0çš„è™šæ‹Ÿç½‘æ¡¥ï¼Œç„¶ååˆ©ç”¨<code>veth pairæŠ€æœ¯åˆ›å»ºä¸€å¯¹è™šæ‹Ÿç½‘ç»œæ¥å£</code>åˆ†åˆ«æ¥å…¥åˆ°Docker0ç½‘æ¡¥ä¸­å’Œç›¸å…³å®¹å™¨çš„Network Namespaceä¹‹ä¸­,å³<code>Docker0 &lt;-&gt; veth pair &lt;-&gt; Container[Namespace]</code>;<br>å®¹å™¨åœ¨å»ºç«‹ä¹‹åˆDocker0ç½‘æ¡¥ä¼šä¸ºå…¶è®¾ç½®ä¸€ä¸ªIPåœ°å€åŠå…¶ç½‘å…³(å³Docker0æ¥å£åœ°å€), åœ¨é€šè¿‡iptablesæ§åˆ¶å®¹å™¨ä¸ç½‘ç»œé€šä¿¡ä»¥åŠå®¹å™¨é—´é€šä¿¡çš„, å®é™…ä¸ŠDocker0é€šè¿‡iptablesä¸­é…ç½®ä¸å®¿ä¸»æœºä¸Šçš„ç‰©ç†ç½‘å¡é“¾æ¥ï¼Œå¹¶ä¸”ç¬¦åˆæ¡ä»¶çš„è¯·æ±‚å°†ä¼šé€šè¿‡iptablesè½¬å‘åˆ°ç½‘æ¡¥docker0ä¸­ï¼Œä¹‹åå†åˆ†å‘ç»™å¯¹åº”çš„æœºå™¨ï¼›</p>
</blockquote>
<p>ç½‘ç»œå›¾ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----------           ----------   </span><br><span class="line">|Container|          |Container|</span><br><span class="line">|eth0@if57|          |eth0@if70|     <span class="comment">#veth pair@ å¯¹åº”å®¿ä¸»æœºä¸Šè™šæ‹Ÿç½‘å¡å· $ip addr å¯æŸ¥çœ‹</span></span><br><span class="line">----------           ----------</span><br><span class="line">    |                   |</span><br><span class="line">------------------------------------</span><br><span class="line">veth985cbf0@if56   veth842b243@if69  <span class="comment">#veth pair:@ åå¯¹åº”ç€å®¹å™¨å†…éƒ¨ç½‘ç»œå·  $ip addr å¯æŸ¥çœ‹</span></span><br><span class="line">|      docker0 ï¼ˆbridgeï¼‰          |</span><br><span class="line">------------------------------------</span><br><span class="line">              | ipv4_ip_forward (iptales)</span><br><span class="line">         (eth0|ens192)</span><br></pre></td></tr></table></figure></p>
<p>åŸºç¡€å®ä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) å®¹å™¨ test1 çš„ç½‘ç»œä¿¡æ¯</span></span><br><span class="line"><span class="variable">$docker</span> <span class="built_in">exec</span> -it test1 ip addr</span><br><span class="line">56: eth0@if57: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) æŸ¥çœ‹iptablesä¸­å…³äºtest1å®¹å™¨çš„NATè½¬å‘è§„åˆ™</span></span><br><span class="line"><span class="variable">$iptables</span> -t nat -L   <span class="comment"># é»˜è®¤å››æ¡é“¾+åˆ›å»ºçš„Dockeré“¾</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL  <span class="comment">#ç½‘æ¡¥</span></span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">DOCKER     all  --  anywhere            !loopback/8           ADDRTYPE match dst-type LOCAL   <span class="comment">#ç½‘æ¡¥</span></span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">MASQUERADE  all  --  172.18.0.0/16       anywhere</span><br><span class="line">MASQUERADE  tcp  --  172.18.0.2          172.18.0.2           tcp dpt(destination port):http                    <span class="comment">#è¿è¡Œé€šè¿‡çš„ç›®æ ‡IPåè®®ä¸åº”ç”¨</span></span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">RETURN     all  --  anywhere             anywhere</span><br><span class="line">RETURN     all  --  anywhere             anywhere</span><br><span class="line">DNAT       tcp  --  anywhere             anywhere             tcp dpt:tproxy to:172.18.0.2:80  <span class="comment">#å°†æŒ‡å®šå®¹å™¨çš„IPå’Œç«¯å£è¿›è¡Œè½¬å‘</span></span><br><span class="line"><span class="comment"># ä¸Šè¿°è§„åˆ™ç®€è¦è¯´æ˜:</span></span><br><span class="line"><span class="comment"># ä»ä»»æ„æºå‘é€å½“å‰æœºå™¨çš„80ç«¯å£çš„TCPè½¬å‘åˆ°å®¹å™¨åœ°å€ä¸º 172.18.0.2:80 çš„å†…éƒ¨åº”ç”¨ä¸Š;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) å…·ä½“æµç¨‹</span></span><br><span class="line"><span class="comment"># è®¿é—®å®¿ä¸»æœºçš„80ç«¯å£ï¼Œç„¶åç»è¿‡iptablesçš„NAT PREROUTINGå°†IPé‡å®šå‘åˆ°172.18.0.2, ä¹‹åé‡å®šå‘çš„æ•°æ®åŒ…é€šè¿‡iptablesä¸­çš„FILTERé…ç½®ï¼Œæœ€ç»ˆåœ¨NAT POSTROUTINGé˜¶æ®µå°†IPåœ°å€ä¼ªè£…æˆä¸º127.0.0.1ï¼Œæ­¤æ—¶è®¿é—®å®¿ä¸»æœºä¸Šæ˜ å°„åˆ°å®¹å™¨ä¸­ç«¯å£ï¼Œæ‰€æœ‰çš„è¯·æ±‚ä¾¿ä¼šè½¬å‘åˆ°å®¹å™¨ä¸­;</span></span><br><span class="line">127.0.0.1:80 -&gt;  NAT PREROUTING -&gt; 172.18.0.2:80 -&gt; FILTER FORWARD -&gt; ACCEPT -&gt; NAT POSTROUTING</span><br></pre></td></tr></table></figure></p>
<p>Bridgeç½‘ç»œä¸­å®¹å™¨ä¸å®¿ä¸»æœºé€šä¿¡ç¤ºæ„å›¾:<br><figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200708232154.png" target="_blank" title="WeiyiGeek.å®¹å™¨å®¿ä¸»æœº" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200708232154.png" alt="WeiyiGeek.å®¹å™¨å®¿ä¸»æœº" title="" class=""></a>
                <p>WeiyiGeek.å®¹å™¨å®¿ä¸»æœº</p>
            </figure></p>
<p><strong>æ€»ç»“è¯´æ˜:</strong></p>
<ul>
<li>1) Veth-PairæŠ€æœ¯åœ¨<code>å®¿ä¸»æœºDocker0ç½‘æ¡¥ä¸Šä¸å®¹å™¨çš„æ‰€å±çš„ç½‘ç»œå‘½åç©ºé—´(Network Namespace)ä¸Šåˆ†åˆ«åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘ç»œæ¥å£</code>å³<code>veth985cbf0@if56 &lt;---&gt; eth0@if57</code>ï¼Œå®ƒä¿è¯äº†æ— è®ºå“ªä¸€ä¸ªæ¥å£æ¥æ”¶åˆ°ç½‘ç»œæŠ¥æ–‡ï¼Œéƒ½ä¼šæ— æ¡ä»¶çš„è½¬å‘åˆ°å¦å¤–ä¸€æ–¹ä¹‹ä¸Š;</li>
<li>2) é»˜è®¤æƒ…å†µä¸‹å®¹å™¨å¯ä»¥è®¿é—®å¤–éƒ¨ç½‘ç»œ(<code>ä¸€èˆ¬éƒ½ä¼šæ·»åŠ æœ¬åœ°ç³»ç»Ÿè½¬å‘æ”¯æŒ</code>)é‡‡ç”¨æ˜¯NATP(ç½‘ç»œåœ°å€ç«¯å£è½¬æ¢)çš„æ–¹å¼å…¶åŒ…å«ä¸¤ç§è½¬æ¢æ–¹å¼<code>SNAT(æºåœ°å€) å’Œ DNAT(ç›®çš„åœ°å€)</code>ï¼Œå®¹å™¨è¿æ¥å¤–ç½‘æ˜¯é€šè¿‡æºNATåœ°å€è½¬æ¢å®ç°çš„ï¼Œä½†æ˜¯å¤–éƒ¨ç½‘ç»œå´æ— æ³•è®¿é—®åˆ°å®¹å™¨å®ƒä¹Ÿéœ€è¦é€šè¿‡ç›®çš„NATè½¬æ¢(<code>æ•°æ®åŒ…çš„ç›®çš„åœ°å€</code>)æ‰èƒ½ä¸å®¹å™¨è¿›è¡Œé€šä¿¡;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) å†…æ ¸è½¬å‘å‚æ•°æŸ¥çœ‹</span></span><br><span class="line"><span class="variable">$sysctl</span> -a | grep <span class="string">"ip_forward"</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># PS:æ‰‹åŠ¨å¼€å¯è½¬å‘ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼‰</span></span><br><span class="line">sysctl -w net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># å¯åŠ¨docker deamonæŒ‡å®šä»¥ä¸‹å‚æ•°ä¹Ÿå¯ä»¥å®ç°æœ¬åœ°è½¬å‘</span></span><br><span class="line">dockerd  -h | grep <span class="string">"ip_forward"</span></span><br><span class="line">--ip-forward  Enable net.ipv4.ip_forward (default <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) å®¿ä¸»æœºä»¥å¤–çš„ä¸–ç•Œéœ€è¦è®¿é—®å®¹å™¨æ—¶å€™ï¼Œåˆ©ç”¨DNATä¿®æ”¹æ•°æ®åŒ…çš„ç›®çš„åœ°å€ï¼Œæ•°æ®åŒ…çš„æµå‘å¦‚ä¸‹</span></span><br><span class="line"><span class="comment"># å®¿ä¸»æœºä¸Šçš„dokcer0ç½‘æ¡¥é‡‡ç”¨iptableè¯†åˆ«åˆ°æœ‰è¯·æ±‚è®¿é—®å®¹å™¨IPå’Œç«¯å£æ—¶ï¼Œå°†æ•°æ®åŒ…å‘é€é™„åŠ åˆ°docker0ç½‘æ¡¥ä¸Šçš„veth985cbf0@if56æ¥å£ä¸­ï¼Œè¯¥æ¥å£ç”±äºveth-pairç‰¹æ€§ä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…æ— æ¡ä»¶çš„å‘é€ç»™å®¹å™¨å†…éƒ¨çš„ eth0@if57 ï¼Œå®¹å™¨æ¥æ”¶åˆ°æ•°æ®åŒ…å¹¶åšå‡ºå“åº”;</span></span><br><span class="line">              |------------------------------------------------|</span><br><span class="line">æ•°æ®åŒ…(å¤–ç•Œ) -&gt; Eth0 &lt;-&lt;- DNAT -&gt;-&gt; Docker0 â€”&gt; veth985cbf0@if56 -&gt; eth0@if57(å®¹å™¨å†…éƒ¨)</span><br><span class="line">              |                 å®¿ä¸»æœº                         |</span><br><span class="line">              |------------------------------------------------|</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) å½“å®¹å™¨å†…éƒ¨éœ€è¦è®¿é—®å®¿ä¸»æœºä»¥å¤–çš„ä¸–ç•Œæ—¶å€™ï¼Œåˆ©ç”¨SNATä¿®æ”¹æ•°æ®åŒ…çš„æºåœ°å€ï¼ˆæ­¤æ—¶å®¹å™¨å¯¹ä¸å¤–éƒ¨ç½‘ç»œæ˜¯é€æ˜çš„ï¼‰ï¼Œæ•°æ®åŒ…æµå‘ä¸ºä¸‹æ‰€ç¤º</span></span><br><span class="line"><span class="comment"># æµç¨‹ä¸ä¸Šé¢ç›¸ä¼¼æ–¹å‘ç›¸åï¼Œåªæ˜¯è½¬å‘é‡‡ç”¨SNATæ–¹å¼;</span></span><br><span class="line">æ•°æ®åŒ…[eth0@if57](å®¹å™¨) -&gt; veth985cbf0@if56 -&gt; Docker0 &lt;-&lt;- SNAT -&gt;-&gt; Eth0 -&gt; å¤–ç•Œç½‘ç»œ</span><br><span class="line">                        |--------------------å®¿ä¸»æœº------------------------|</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h6 id="Host-æ¨¡å¼"><a href="#Host-æ¨¡å¼" class="headerlink" title="Host æ¨¡å¼"></a>Host æ¨¡å¼</h6><p>æè¿°:è¯¥ç½‘ç»œæ¨¡å¼ä¸Bridgeæ¡¥æ¥çš„ç½‘ç»œæ¨¡å¼å­˜åœ¨ä¸€å®šçš„å·®å¼‚ï¼Œæœ€å¤§å·®å¼‚æ˜¯æ²¡æœ‰ä¸ºå®¹å™¨åˆ›å»ºä¸€ä¸ª<code>éš”ç¦»çš„ç½‘ç»œç¯å¢ƒ</code>, å¹¶ä¸”å› ä¸ºè¯¥hostç½‘ç»œæ¨¡å¼ä¸‹çš„Dockerå®¹å™¨ä¸å®¿ä¸»æœº<code>å…±äº«ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´(namepace)</code>ï¼Œæ‹¥æœ‰ç›¸åŒçš„ç½‘ç»œè®¾æ–½å¹¶ä¸”å®¹å™¨çš„IPå³ä¸ºå®¿ä¸»æœºIPèƒ½ç›´æ¥ä¸å¤–ç•Œè¿›è¡Œé€šä¿¡;<br>ç”±äºDokerå®¹å™¨çš„hostç½‘ç»œæ¨¡å¼åœ¨å®ç°è¿‡ç¨‹ä¹‹ä¸­ï¼Œç”±äºä¸éœ€è¦é¢å¤–çš„ç½‘æ¡¥ä»¥åŠè™šæ‹Ÿç½‘å¡ã€æ•…è€Œä¸æ¶‰åŠdocker0ç½‘æ¡¥ä»¥åŠveth-pairè™šæ‹Ÿç½‘å¡å¯¹ï¼›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Docker Container](host æ¨¡å¼) -&gt; å®¿ä¸»æœº (eth0) -&gt; å¤–ç•Œç½‘ç»œ</span><br></pre></td></tr></table></figure>
<p><strong>Hostç½‘ç»œæ¨¡å¼ä¼˜ç¼ºç‚¹:</strong></p>
<ul>
<li>1)ä¼˜ç‚¹: æ•ˆç‡é«˜(ç›´æ¥é‡‡ç”¨å®¿ä¸»æœºIPä¸å¤–ç•Œé€šä¿¡ä¸ç»è¿‡NATPè½¬æ¢)ã€ç«¯å£å…¬ç”¨(å®¹å™¨å¯ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç«¯å£)</li>
<li>2)ç¼ºç‚¹: å®‰å…¨æ€§å·®(å®¹å™¨ä¸åœ¨æ‹¥æœ‰éš”ç¦»çš„å’Œç‹¬ç«‹çš„ç½‘ç»œæ ˆ)ã€ç«¯å£é™åˆ¶(å®¿ä¸»æœºå ç”¨æˆ–è€…Bridgeç½‘ç»œæ¨¡å¼ä¸»æœºå ç”¨çš„ç«¯å£ä¸èƒ½è¢«ä½¿ç”¨ï¼Œå³ä¸åœ¨æ‹¥æœ‰å®¹å™¨ä¸­å…¨éƒ¨ç«¯å£)</li>
</ul>
<p>åŸºç¡€å®ä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) åˆ›å»ºHostç½‘ç»œæ¨¡å¼çš„åŒæœŸï¼Œå¯ä»¥é€šè¿‡ip addr å‘½ä»¤æŸ¥çœ‹ç½‘å¡ä¿¡æ¯ï¼Œå› ä¸ºç›´æ¥åˆ©ç”¨å®¿ä¸»æœºçš„ç½‘ç»œæ ˆï¼Œæ‰€æœ‰æ‰“å°å‡ºçš„ç›´æ¥æ˜¯å®¿ä¸»æœºçš„ç½‘å¡æ¥å£ä¿¡æ¯;</span></span><br><span class="line">docker run -it --net=host busybox ip addr</span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></span><br><span class="line"><span class="comment"># 2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq qlen 1000</span></span><br><span class="line"><span class="comment"># 3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line"><span class="comment"># 5: br-fa08aa7db7a6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line"><span class="comment"># 57: veth985cbf0@if56: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue master docker0</span></span><br><span class="line"><span class="comment"># 71: veth842b243@if70: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue master br-fa08aa7db7a6</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h6 id="Container-æ¨¡å¼"><a href="#Container-æ¨¡å¼" class="headerlink" title="Container æ¨¡å¼"></a>Container æ¨¡å¼</h6><p>æè¿°: è¯¥æ¨¡å¼é€šå¸¸ç”¨äºè‡ªå®šä¹‰ç½‘ç»œæ ˆæ—¶å€™ä½¿ç”¨ï¼Œå®ƒä¼šé‡ç”¨å¦å¤–ä¸€ä¸ªå®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´(ä¾‹å¦‚Bridge)ï¼›æ¯”å¦‚Kubernetesä¹Ÿæ˜¯ä½¿ç”¨è¯¥æ¨¡å¼è¿›è¡Œå†…éƒ¨åˆ†å¸ƒå¼åº”ç”¨é€šä¿¡;<br>å®é™…ä¸Šï¼Œé‡‡ç”¨Containeræ¨¡å¼çš„ä¸¤ä¸ªå®¹å™¨å…±äº«ç›¸åŒçš„1ä¸ªNetwork Namespace;</p>
<p>Container ç½‘ç»œæ¨¡å¼ç¤ºæ„å›¾:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Docker Container  &lt;-&gt;  Docker Container</span><br><span class="line">                       |   eth0@if57   | </span><br><span class="line">                       -----------------</span><br><span class="line">                              |</span><br><span class="line">  Docker0 (Bridge) &lt;-&gt; [veth985cbf0@if56]                                </span><br><span class="line">    | (ipv4.ip_forward)</span><br><span class="line">  eth0</span><br></pre></td></tr></table></figure></p>
<p>åŸºç¡€å®ä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºä¸€ä¸ªbridgeç½‘ç»œæ¨¡å¼çš„å®¹å™¨</span></span><br><span class="line">docker run -d -P --net=bridge --name nginx nginx:latest</span><br><span class="line"><span class="comment"># 2.æŸ¥çœ‹å…¶å®¹å™¨çš„ip ä¿¡æ¯</span></span><br><span class="line">docker inspect nginx | grep <span class="string">"IPAddress"</span></span><br><span class="line">docker inspect nginx | grep <span class="string">"IPAddress"</span></span><br><span class="line"><span class="string">"SecondaryIPAddresses"</span>: null,</span><br><span class="line"><span class="string">"IPAddress"</span>: <span class="string">"172.17.0.3"</span>,</span><br><span class="line"><span class="comment"># 3.æ„å»ºä¸€ä¸ªé‡‡ç”¨Containerç½‘ç»œæ¨¡å¼çš„å®¹å™¨</span></span><br><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨è¿æ¥åˆ°å·²é”®å®¹å™¨çš„ç½‘ç»œä¹‹ä¸­ï¼Œæ¯”å¦‚é‡‡ç”¨container:å®¹å™¨åç§°è¿›è¡Œåˆ¶å®šç½‘ç»œ;</span></span><br><span class="line">docker run -d --name busybox --net=container:nginx busybox:latest top</span><br><span class="line"><span class="comment"># 13d274350a2855c1295e3c93fd4e6a166b6e34cfc71a91e1396ca8b4a75f67e2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.æ­¤æ—¶æ‚¨ä¼šå‘ç°å…¶IPåœ°å€ä¸é“¾æ¥åˆ°å®¹å™¨ä¸­çš„ç½‘ç»œIPåœ°å€ä¸€æ ·å‡ä¸º172.17.0.3</span></span><br><span class="line"><span class="variable">$docker</span> ps</span><br><span class="line">CONTAINER ID        IMAGE                    COMMAND                  CREATED             STATUS                PORTS                   NAMES</span><br><span class="line">13d274350a28        busybox:latest           <span class="string">"top"</span>                    3 seconds ago       Up 2 seconds                                  busybox</span><br><span class="line">04074e2e85b4        nginx:latest             <span class="string">"/docker-entrypoint.â€¦"</span>   4 minutes ago       Up 3 minutes          0.0.0.0:32768-&gt;80/tcp   nginx</span><br><span class="line"><span class="variable">$docker</span> <span class="built_in">exec</span> -it busybox ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">72: eth0@if73: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h6 id="none-æ¨¡å¼"><a href="#none-æ¨¡å¼" class="headerlink" title="none æ¨¡å¼"></a>none æ¨¡å¼</h6><p>æè¿°: è¯¥æ¨¡å¼ä¸ä¸ºDockerå®¹å™¨æä¾›ä»»ä½•çš„ç½‘ç»œç¯å¢ƒå¯ä»¥è¯´è¯¥æ¨¡å¼åªæ˜¯å¯¹å®¹å™¨åšäº†æå°‘çš„è®¾å®šï¼Œä¸€æ—¦è®¾ç½®noneç½‘ç»œæ¨¡å¼å®¹å™¨å†…éƒ¨å°±åªèƒ½ä½¿ç”¨loopbackè®¾å¤‡ï¼Œä¸ä¼šå†æœ‰å…¶å®ƒçš„ç½‘ç»œèµ„æºç¯å¢ƒ;</p>
<p>è¯¥æ¨¡å¼ä¸‹æ–¹ä¾¿dockerå¼€å‘è€…åŸºäºæ­¤åšå‡ºå…¶ä»–å¯èƒ½çš„ç½‘ç»œå®šåˆ¶å¼€å‘, å®é™…ä¸Šè¯¥æ¨¡å¼å…³é—­äº†å®¹å™¨çš„ç½‘ç»œåŠŸèƒ½ï¼Œåº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼›</p>
<ul>
<li>å®¹å™¨å¹¶ä¸éœ€è¦ç½‘ç»œ(ä¾‹å¦‚åªéœ€è¦å†™ç£ç›˜å·çš„æ‰¹å¤„ç†ä»»åŠ¡)</li>
<li>å¸Œæœ›è‡ªå®šä¹‰ç½‘ç»œ</li>
</ul>
<p>åŸºç¡€å®ä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºä¸€ä¸ªç½‘ç»œæ¨¡å¼ä¸ºnoneçš„å®¹å™¨</span></span><br><span class="line">docker run -itd --net=none --name=busybox-none busybox top</span><br><span class="line"><span class="comment"># 2.æŸ¥çœ‹åˆ›å»ºçš„å®¹å™¨çš„ipåœ°å€ï¼Œåªèƒ½çœ‹è§ä¸€ä¸ªå›ç¯åœ°å€</span></span><br><span class="line">docker <span class="built_in">exec</span> -it busybox-none ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h6 id="Overlay-æ¨¡å¼"><a href="#Overlay-æ¨¡å¼" class="headerlink" title="Overlay æ¨¡å¼"></a>Overlay æ¨¡å¼</h6><p>æè¿°:Overlayæ¨¡å¼æ˜¯DockeråŸç”Ÿçš„è·¨ä¸»æœºç½‘ç»œæ–¹æ¡ˆ(å…¶ä»–ä¸€äº›æ–¹æ¡ˆ:Flannel/Weaveå’Œ<code>Calico K8så·²é»˜è®¤ä½¿ç”¨</code>)ï¼Œè€ŒDocker åˆé€šè¿‡Libnetworkä»¥åŠCNMå°†ä¸Šè¿°å„ç§æ–¹æ¡ˆä¸dockeré›†æˆåœ¨ä¸€èµ·;</p>
<p>Q: ä»€ä¹ˆæ˜¯Libnetworkåº“?</p>
<blockquote>
<p>ç­”: ä»–æ˜¯Dockerå®¹å™¨çš„ç½‘ç»œåº“ï¼Œå…¶æ ¸å¿ƒå†…å®¹æ˜¯å…¶å®šä¹‰çš„<code>Container Network Model (CNM)å®¹å™¨ç½‘ç»œæ¨¡å‹</code> ä»–å¯¹å®¹å™¨ç½‘ç»œè¿›è¡Œäº†æŠ½è±¡;</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                     | -&gt; Native Drivers(None, Bridge, Overlay, Macvlan) <span class="comment">#åŸç”Ÿ</span></span><br><span class="line">Docker -&gt; Libnetwork | -&gt;</span><br><span class="line">                     | -&gt; Remote Drivers(Flannel, Weave, Calico)  <span class="comment">#ç¬¬ä¸‰æ–¹ç½‘ç»œæ’ä»¶</span></span><br></pre></td></tr></table></figure>
<p>CNM ç”±ä»¥ä¸‹ä¸‰ç±»ç»„ä»¶ç»„æˆ:</p>
<ul>
<li>Sandbox: <code>Linux Network Namespace</code> æ˜¯åŸºäº Sandboxçš„æ ‡å‡†å®ç°ï¼Œå®ƒæ˜¯å®¹å™¨çš„ç½‘ç»œæ ˆå…¶å›Šæ‹¬<code>Interface, è·¯ç”±å™¨ å’Œ DNS è®¾ç½®</code>,ä¹Ÿå°±æ˜¯è¯´Sandboxå°†ä¸€ä¸ªå®¹å™¨ä¸å¦å¤–å®¹å™¨é€šè¿‡Namespaceè¿›è¡Œéš”ç¦»ï¼Œä¸€ä¸ªå®¹å™¨åŒ…å«ä¸€ä¸ªSandboxï¼Œå®ƒå¯ä»¥åŒ…å«æ¥è‡ªä¸åŒçš„Networkçš„Endpointï¼Œå³<code>æ¯ä¸ªSandboxå¯ä»¥æœ‰å¤šä¸ªEndpoint</code>éš¶å±äºä¸åŒçš„ç½‘ç»œ;</li>
<li>Endpoint: å°†Sandboxæ¥å…¥åˆ°Networkä¹‹ä¸­ï¼Œä¸€ä¸ªEndpointåªèƒ½å±äºä¸€ä¸ªç½‘ç»œä¸ä¸€ä¸ªSandboxï¼Œä¾‹å¦‚ Veth-pair çš„å®ç°;</li>
<li>Network: åŒ…å«ä¸€ç»„Endpointï¼ŒåŒä¸€ä¸ªNetworkçš„Endpointå¯ä»¥ç›´æ¥é€šä¿¡ï¼Œå…¶å®ç°å¯ä»¥æ˜¯Linux bridge vlanç­‰</li>
</ul>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200711231356.png" target="_blank" title="WeiyiGeek.CNM" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200711231356.png" alt="WeiyiGeek.CNM" title="" class=""></a>
                <p>WeiyiGeek.CNM</p>
            </figure>
<p>æ€»ç»“: </p>
<ul>
<li>(1) Sandbox ä¸ Endpoint æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼ŒEndpointå°†Sandboxç»‘å®šåˆ°Networkä¹‹ä¸­ï¼Œå¹¶ä¸”åŒä¸€ä¸ªNetworké—´çš„Endpointå¯ä»¥ç›´æ¥é€šä¿¡;</li>
</ul>
<p><strong>Overlayç½‘ç»œåŸç†</strong><br>æè¿°:Docker overlayç½‘ç»œéœ€è¦ä¸€ä¸ªK-Væ•°æ®åº“ç”¨äºä¿å­˜çŠ¶æ€ç›¸å…³ä¿¡æ¯(åŒ…æ‹¬CNMç½‘ç»œç»„ä»¶Networkï¼ŒEndpointä»¥åŠIP)ï¼Œå¯é€‰æ–¹æ¡ˆæœ‰Consul/Etc/Zokeeperç­‰ï¼Œæ­¤å¤„ä»¥Consulä¸€ç§K-Væ•°æ®åº“ä¸ºä¾‹è¿›è¡Œæ¼”ç¤ºï¼Œæ­¤å¤„æˆ‘ä»¬å¹¶ä¸éœ€è¦å†™ä»»ä½•ä»£ç åªéœ€è¦æŒ‰ç…§Consulå³å¯ï¼›</p>
<p>åŸºç¡€å®è·µ:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åœ¨Docker Deamonå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä¸­æ‹‰å–å¹¶è¿è¡ŒConsulé•œåƒ</span></span><br><span class="line">docker run -d -p 8500:8500 -h consul --name consul-net-overlay progrium/consul -server -bootstrap**docker run -d -p 8500:8500 -h consul --name consul-net-overlay progrium/consul -server -bootstrap</span><br><span class="line"><span class="comment"># Status: Downloaded newer image for progrium/consul:latest</span></span><br><span class="line"><span class="comment"># 86d9d93384034b19acad56dfdebed754da060125b534b240fd87f79e18a2bfcd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.ç„¶åå†å„ä¸ªDockerèŠ‚ç‚¹çš„Deamonä¸Šè¿›è¡Œé…ç½®Consulå‘ç°: /etc/systemd/system/docker.service å†å…¶ååŠ ä¸Šå¦‚ä¸‹å‚æ•°</span></span><br><span class="line">--cluster-store=consul://10.10.107.245:8500 --cluster-advertise=ens192:2376</span><br><span class="line">$ systemctl cat docker</span><br><span class="line"><span class="comment"># /usr/lib/systemd/system/docker.service</span></span><br><span class="line"><span class="comment"># ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd --cluster-store=consul://10.10.107.245:8500 (consulè¿è¡ŒèŠ‚ç‚¹) --cluster-advertise=ens192:2376(å½“å‰èŠ‚ç‚¹ç½‘å¡æˆ–è€…IPå³Docker DeamonæœåŠ¡)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.systemdå®ˆæŠ¤è¿›ç¨‹é‡å¯ä¸é‡å¯docker</span></span><br><span class="line">[root@worker-03 ~]$ systemctl daemon-reload</span><br><span class="line">[root@worker-03 ~]$ systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.åˆ›å»ºoverlay ç½‘ç»œä¸åˆ›å»ºbridgeç½‘ç»œåŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯åœ¨-då‚æ•°æ—¶å€™æœ‰äº›è®¸ä¸åŒ</span></span><br><span class="line">docker network create -d overlay overlay-net </span><br><span class="line">docker network create -d overlay overlay-net-sub --subnet 172.25.0.0/24 --gateway 172.25.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.åˆ›å»ºè¿è¡Œå®¹å™¨æ—¶å€™æŒ‡å®š-networkå‚æ•°ï¼ŒåŠæ—¶åœ¨ä¸åŒçš„dockerä¸»æœºä¸‹åˆ›å»ºçš„å®¹å™¨åªè¦--networkä¸ºoveylay-netå®ƒä»¬ä¹‹é—´éƒ½èƒ½ç›¸äº’è®¿é—®ï¼›</span></span><br><span class="line"><span class="comment"># ä»¥ç®€å•ä½¿ç”¨ â€“net=host æ–¹å¼ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼</span></span><br><span class="line">docker run --network overlay-net busybox sleep 6000</span><br><span class="line">docker run --network overlay-net busybox sleep 6000</span><br><span class="line"><span class="variable">$docker</span> ps</span><br><span class="line"><span class="comment"># CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS               NAMES</span></span><br><span class="line"><span class="comment"># 430ec4450df4        busybox                 "sleep 6000"             6 minutes ago       Up 6 minutes                            cranky_curie</span></span><br><span class="line"><span class="comment"># 0902833f9a63        busybox                 "sleep 6000"             12 minutes ago      Up 11 minutes                           intelligent_chaplygin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.Docker ç½‘ç»œæŸ¥çœ‹</span></span><br><span class="line"><span class="variable">$docker</span> network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">5de5f196afda        bridge              bridge              <span class="built_in">local</span></span><br><span class="line">23d95a1bd969        docker_gwbridge     bridge              <span class="built_in">local</span></span><br><span class="line">3a700c6af892        host                host                <span class="built_in">local</span></span><br><span class="line">93a5b381ef0d        none                null                <span class="built_in">local</span></span><br><span class="line">e437f4650c96        overlay-net         overlay             global</span><br><span class="line"><span class="variable">$docker</span> network inspect docker_gwbridge -f <span class="string">"&#123;&#123;.IPAM.Config&#125;&#125;"</span></span><br><span class="line"><span class="comment"># [&#123;172.18.0.0/16  172.18.0.1 map[]&#125;]</span></span><br><span class="line"><span class="variable">$docker</span> network inspect overlay-net -f <span class="string">"&#123;&#123;.IPAM.Config&#125;&#125;"</span></span><br><span class="line"><span class="comment"># [&#123;10.0.0.0/24  10.0.0.1 map[]&#125;]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.åˆ›å»ºå®¹å™¨çš„IPåœ°å€æŸ¥çœ‹</span></span><br><span class="line">[root@worker-03 ~]<span class="variable">$docker</span> <span class="built_in">exec</span> -it 090 ip addr</span><br><span class="line">22: eth0@if23: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue</span><br><span class="line">    link/ether 02:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.2/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">25: eth1@if26: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@worker-03 ~]<span class="variable">$docker</span> <span class="built_in">exec</span> -it 430 ip addr</span><br><span class="line">27: eth0@if28: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue</span><br><span class="line">    link/ether 02:42:0a:00:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.3/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">29: eth1@if30: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.3/16 brd 172.18.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">[root@worker-03 ~]<span class="variable">$docker</span> <span class="built_in">exec</span> -it 090 sh</span><br><span class="line">/ <span class="comment"># ip addr</span></span><br><span class="line">/ <span class="comment"># ping 10.0.0.1</span></span><br><span class="line">PING 10.0.0.1 (10.0.0.1): 56 data bytes</span><br><span class="line">64 bytes from 10.0.0.1: seq=0 ttl=64 time=0.540 ms</span><br><span class="line">/ <span class="comment"># ping 10.0.0.2</span></span><br><span class="line">PING 10.0.0.2 (10.0.0.2): 56 data bytes</span><br><span class="line">64 bytes from 10.0.0.2: seq=0 ttl=64 time=0.055 ms</span><br><span class="line">/ <span class="comment"># ping 10.0.0.3 #å¯ä»¥çœ‹åˆ°æ˜¯æ­£å¸¸é€šä¿¡çš„</span></span><br><span class="line">PING 10.0.0.3 (10.0.0.3): 56 data bytes</span><br><span class="line">64 bytes from 10.0.0.3: seq=0 ttl=64 time=0.110 ms</span><br></pre></td></tr></table></figure><br>è®¿é—®ConsulæŸ¥çœ‹ç©¶ç«Ÿå­˜åœ¨ä»€ä¹ˆä¸œè¥¿:<code>http://10.10.107.245:8500/ui/#/dc1/kv/docker/network/v1.0/</code></p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200712000034.png" target="_blank" title="WeiyiGeek.Consul-docker-kv-network" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200712000034.png" alt="WeiyiGeek.Consul-docker-kv-network" title="" class=""></a>
                <p>WeiyiGeek.Consul-docker-kv-network</p>
            </figure>
<p><br/></p>
<p><strong>æ€»ç»“:</strong><br>ä»ä¸Šé¢çš„å®é™…æ“ä½œä¸­æˆ‘ä»¬å¯ä»¥çœ‹è§å½“åˆ›å»ºå®Œoverlayç½‘ç»œåï¼ŒæŸ¥çœ‹dockerç½‘ç»œä¼šå‘ç°ç½‘ç»œä¸­å¤šäº†ä¸ª overlay-net (ç±»å‹ä¸ºOverlayï¼ŒScopeä¸ºGlobal)ä¸ docker_gwbridge (ç±»å‹ä¸ºBridgeï¼ŒScopeä¸ºlocal)ï¼Œä¸ºä»€ä¹ˆä¼šå¤šå‡ºæ¥ä¸€ä¸ª docker_gwbridgeç½‘ç»œå‘¢?<br>ç­”:å®é™…ä¸Šè¿™å°±æ˜¯Overlayå·¥ä½œåŸç†ä¹‹æ‰€åœ¨ï¼›<br>å¯ä»¥é€šè¿‡<code>yum install -y bridge-utils &amp;&amp; brctl show</code> è¿›è¡ŒæŸ¥çœ‹å¾—å‡ºç»“æœ, å½“æ¯åˆ›å»ºä¸€ä¸ªç½‘ç»œç±»å‹ä¸ºOverlayçš„å®¹å™¨ï¼Œdocker_gwbridge ä¸‹ä¾¿ä¼šæŒ‚è½½ä¸€ä¸ªveth***ï¼Œè¿™è¯´æ˜oveylayå®¹å™¨æ˜¯é€šè¿‡æ­¤ç½‘æ¡¥æ¥è¿›è¡Œå¯¹å¤–è¿æ¥çš„;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bridge name           bridge id               STP enabled     interfaces</span><br><span class="line">docker0               8000.024274c0c574       no</span><br><span class="line">docker_gwbridge       8000.02422e73bb62       no              vethae1f217</span><br><span class="line">                                                              vethec87cb3</span><br></pre></td></tr></table></figure></p>
<p>ç®€å•çš„è¯´overlayç½‘ç»œæ•°æ®è¿˜æ˜¯ä»Bridgeç½‘ç»œdocker_gwbridgeç½‘æ¡¥å‡ºå»çš„ï¼Œç”±äºConsulçš„ä½œç”¨è®°å½•leoverlayç½‘ç»œçš„<code>CNMä¸‰å¤§ç»„ä»¶çš„ä¿¡æ¯</code>ï¼Œä½¿å¾—å…¶å®ƒä¸»æœºdockerçŸ¥é“æ­¤ç½‘ç»œç±»å‹ä¸ºoveylayï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¯¥ç½‘ç»œä¸‹ä¸åŒä¸»æœºä¹‹é—´è¿›è¡Œç›¸äº’çš„é€šä¿¡è®¿é—®,ä½†æ˜¯å®é™…ä¸Šå‡ºå£è¿˜æ˜¯Docker_gwbridge;</p>
<p><br></p>
<h5 id="6-å­˜å‚¨é©±åŠ¨"><a href="#6-å­˜å‚¨é©±åŠ¨" class="headerlink" title="6.å­˜å‚¨é©±åŠ¨"></a>6.å­˜å‚¨é©±åŠ¨</h5><p>æè¿°:Dockeræœ€å¼€å§‹é‡‡ç”¨AUFSä½œä¸ºæ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå¾—ç›ŠäºAUFSåˆ†å±‚çš„æ¦‚å¿µï¼Œå®ç°äº†å¤šä¸ªContainerå¯ä»¥å…±äº«åŒä¸€ä¸ªimageï¼›Dockeræ”¯æŒçš„å­˜å‚¨é©±åŠ¨ç±»å‹æœ‰<code>overlay2ã€AUFSã€Btrfsã€Device mapperã€OverlayFSã€ZFS</code>äº”ç§å­˜å‚¨é©±åŠ¨ï¼Œæ‰€æœ‰é©±åŠ¨éƒ½ç”¨åˆ°å†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰çš„æŠ€æœ¯ã€‚</p>
<p>[2020å¹´6æœˆ19æ—¥] - ç›®å‰æœ€æ–°ç‰ˆæœ¬çš„ docker é»˜è®¤ä¼˜å…ˆé‡‡ç”¨ overlay2 çš„å­˜å‚¨é©±åŠ¨ï¼Œå¯¹äºå·²æ”¯æŒè¯¥é©±åŠ¨çš„ Linux å‘è¡Œç‰ˆï¼Œä¸éœ€è¦ä»»ä½•è¿›è¡Œä»»ä½•é¢å¤–çš„é…ç½®ã€‚devicemapper å­˜å‚¨é©±åŠ¨å·²ç»åœ¨ docker 18.09 ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒï¼Œdocker å®˜æ–¹æ¨èä½¿ç”¨ overlay2 æ›¿ä»£devicemapperã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br><span class="line"> Server Version: 19.03.3</span><br><span class="line"> Storage Driver: overlay2</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li>å†™æ—¶å¤åˆ¶(CoW)<br><em>ä»€ä¹ˆæ˜¯å†™æ—¶å¤åˆ¶?</em><br>ç­”:å†™æ—¶å¤åˆ¶(CoW)å°±æ˜¯copy-on-writeï¼Œè¡¨ç¤ºåªåœ¨éœ€è¦å†™æ—¶æ‰å»å¤åˆ¶ï¼Œè¿™ä¸ªæ˜¯é’ˆå¯¹å·²æœ‰æ–‡ä»¶çš„ä¿®æ”¹åœºæ™¯ã€‚CoWæŠ€æœ¯å¯ä»¥è®©æ‰€æœ‰çš„å®¹å™¨å…±äº«imageçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€æœ‰æ•°æ®éƒ½ä»imageä¸­è¯»å–ï¼Œåªæœ‰å½“è¦å¯¹æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œæ‰ä»imageé‡ŒæŠŠè¦å†™çš„æ–‡ä»¶å¤åˆ¶åˆ°è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œä¿®æ”¹ã€‚</li>
</ul>
<p>æ‰€ä»¥æ— è®ºæœ‰å¤šå°‘ä¸ªå®¹å™¨å…±äº«åŒä¸€ä¸ªimageï¼Œæ‰€åšçš„å†™æ“ä½œéƒ½æ˜¯å¯¹ä»imageä¸­å¤åˆ¶åˆ°è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„å¤æœ¬ä¸Šè¿›è¡Œï¼Œå¹¶ä¸ä¼šä¿®æ”¹imageçš„æºæ–‡ä»¶ï¼Œä¸”å¤šä¸ªå®¹å™¨æ“ä½œåŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¼šåœ¨æ¯ä¸ªå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿé‡Œç”Ÿæˆä¸€ä¸ªå¤æœ¬ï¼Œæ¯ä¸ªå®¹å™¨ä¿®æ”¹çš„éƒ½æ˜¯è‡ªå·±çš„å¤æœ¬ï¼Œç›¸äº’éš”ç¦»ï¼Œç›¸äº’ä¸å½±å“ã€‚ä½¿ç”¨CoWå¯ä»¥æœ‰æ•ˆçš„æé«˜ç£ç›˜çš„åˆ©ç”¨ç‡ã€‚</p>
<ul>
<li>ç”¨æ—¶åˆ†é…ï¼ˆallocate-on-demandï¼‰<br>åªæœ‰åœ¨è¦æ–°å†™å…¥ä¸€ä¸ªæ–‡ä»¶æ—¶æ‰åˆ†é…ç©ºé—´ï¼Œè¿™æ ·å¯ä»¥æé«˜å­˜å‚¨èµ„æºçš„åˆ©ç”¨ç‡ã€‚æ¯”å¦‚å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶ä¸ä¼šä¸ºè¿™ä¸ªå®¹å™¨é¢„åˆ†é…ä¸€äº›ç£ç›˜ç©ºé—´ï¼Œè€Œæ˜¯å½“æœ‰æ–°æ–‡ä»¶å†™å…¥æ—¶ï¼Œæ‰æŒ‰éœ€åˆ†é…æ–°ç©ºé—´ã€‚</li>
</ul>
<h6 id="AUFS"><a href="#AUFS" class="headerlink" title="AUFS"></a>AUFS</h6><p><em>ä»€ä¹ˆæ˜¯AUFSï¼Ÿ</em><br>ç­”:AUFSï¼ˆAnotherUnionFSï¼‰æ˜¯ä¸€ç§Union FSï¼Œæ˜¯æ–‡ä»¶çº§çš„å­˜å‚¨é©±åŠ¨ã€‚<br>AUFSèƒ½é€æ˜è¦†ç›–ä¸€æˆ–å¤šä¸ªç°æœ‰æ–‡ä»¶ç³»ç»Ÿçš„å±‚çŠ¶æ–‡ä»¶ç³»ç»Ÿï¼ŒæŠŠå¤šå±‚åˆå¹¶æˆæ–‡ä»¶ç³»ç»Ÿçš„å•å±‚è¡¨ç¤ºã€‚æ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä¸€å±‚ä¸€å±‚åœ°å åŠ ä¿®æ”¹æ–‡ä»¶,ä½†æ˜¯æ— è®ºåº•ä¸‹æœ‰å¤šå°‘å±‚éƒ½æ˜¯read only,åªæœ‰æœ€ä¸Šå±‚çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯å¯å†™çš„;<br>å½“éœ€è¦ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼ŒAUFSåˆ›å»ºè¯¥æ–‡ä»¶çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œä½¿ç”¨CoWå°†æ–‡ä»¶ä»åªè¯»å±‚å¤åˆ¶åˆ°å¯å†™å±‚è¿›è¡Œä¿®æ”¹ï¼Œç»“æœä¹Ÿä¿å­˜åœ¨å¯å†™å±‚;<br>åœ¨Dockerä¸­åº•ä¸‹çš„åªè¯»å±‚å°±æ˜¯imageï¼Œå¯å†™å±‚å°±æ˜¯Container;</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119230432.png" target="_blank" title="WeiyiGeek.AUFS" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119230432.png" alt="WeiyiGeek.AUFS" title="" class=""></a>
                <p>WeiyiGeek.AUFS</p>
            </figure>
<p><br></p>
<h6 id="Overlay-å½“å‰dockeré»˜è®¤çš„å­˜å‚¨é©±åŠ¨"><a href="#Overlay-å½“å‰dockeré»˜è®¤çš„å­˜å‚¨é©±åŠ¨" class="headerlink" title="Overlay - å½“å‰dockeré»˜è®¤çš„å­˜å‚¨é©±åŠ¨"></a>Overlay - å½“å‰dockeré»˜è®¤çš„å­˜å‚¨é©±åŠ¨</h6><p>æè¿°:Overlayæ˜¯Linuxå†…æ ¸3.18åæ”¯æŒçš„,å®ƒä¹Ÿæ˜¯ä¸€ç§UnionFSä¸AUFSä¸åŒçš„æ˜¯Overlayåªæœ‰ä¸¤å±‚ï¼šä¸€ä¸ªupperæ–‡ä»¶ç³»ç»Ÿå’Œä¸€ä¸ªloweræ–‡ä»¶ç³»ç»Ÿï¼Œåˆ†åˆ«ä»£è¡¨Dockerçš„é•œåƒå±‚å’Œå®¹å™¨å±‚ã€‚<br>å½“éœ€è¦ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä½¿ç”¨CoWå°†æ–‡ä»¶ä»åªè¯»çš„lowerå¤åˆ¶åˆ°å¯å†™çš„upperè¿›è¡Œä¿®æ”¹ï¼Œç»“æœä¹Ÿä¿å­˜åœ¨upperå±‚ã€‚</p>
<p>åŒæ ·åœ¨Dockerä¸­åº•ä¸‹çš„åªè¯»å±‚å°±æ˜¯imageï¼Œå¯å†™å±‚å°±æ˜¯Containerï¼›<br><figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119230740.png" target="_blank" title="WeiyiGeek.Overlay" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119230740.png" alt="WeiyiGeek.Overlay" title="" class=""></a>
                <p>WeiyiGeek.Overlay</p>
            </figure></p>
<p>ä¸‹å›¾å±•ç¤ºäº†overlayFSçš„ä¸¤ä¸ªç‰¹å¾ï¼š<code>ä¸Šä¸‹åˆå¹¶ã€åŒåé®ç›–</code><br><figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200810161727.png" target="_blank" title="WeiyiGeek.overlay-Upper-Lower" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200810161727.png" alt="WeiyiGeek.overlay-Upper-Lower" title="" class=""></a>
                <p>WeiyiGeek.overlay-Upper-Lower</p>
            </figure></p>
<p>é‡‡ç”¨ä¸€ä¸ªæŒ‚è½½OverlayFSå°ä¾‹å­æ·±å…¥ç†è§£å…¶å­˜å‚¨é©±åŠ¨:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) common.txtåˆ†åˆ«å­˜æ”¾ä¸åŒçš„å†…å®¹</span></span><br><span class="line">æ¯”å¦‚lower1ä¸‹é¢common.txtå†…å®¹æ˜¯lower1ï¼Œlower2ä¸‹é¢common.txtå†…å®¹æ˜¯lower2ï¼Œlower3ä¸‹é¢common.txtå†…å®¹æ˜¯lower3ï¼Œupperç›®å½•æœ‰ä¸ªå’Œlower2/ower2.shåŒåçš„ç›®å½•</span><br><span class="line"><span class="variable">$tree</span> -L 2</span><br><span class="line">â”œâ”€â”€ lower1</span><br><span class="line">â”‚   â”œâ”€â”€ common.txt</span><br><span class="line">â”‚   â””â”€â”€ ower1.sh</span><br><span class="line">â”œâ”€â”€ lower2</span><br><span class="line">â”‚   â”œâ”€â”€ common.txt</span><br><span class="line">â”‚   â””â”€â”€ ower2.sh</span><br><span class="line">â”œâ”€â”€ lower3</span><br><span class="line">â”‚   â”œâ”€â”€ common.txt</span><br><span class="line">â”‚   â””â”€â”€ ower3.sh</span><br><span class="line">â”œâ”€â”€ merged</span><br><span class="line">â”œâ”€â”€ upper</span><br><span class="line">â”‚   â”œâ”€â”€ ower2.sh</span><br><span class="line">â”‚   â””â”€â”€ up.txt</span><br><span class="line">â””â”€â”€ work</span><br><span class="line">    â””â”€â”€ work</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒæŒ‚è½½</span></span><br><span class="line">* lowerdir: ä»£è¡¨lowerå±‚ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œä¼˜å…ˆçº§ä¾æ¬¡é™ä½ï¼Œä¹Ÿå°±æ˜¯è¯´`lower1 &gt; lower2 &gt; lower3`</span><br><span class="line">* upperdir: ä»£è¡¨upperå±‚,ä¼šè¦†ç›–lowerå±‚</span><br><span class="line">* workdir: å·¥ä½œç›®å½•,ç”¨äºå­˜æ”¾ä¸´æ—¶æ–‡ä»¶</span><br><span class="line">* merged: æŒ‚è½½ç‚¹,æˆ‘ä»¬çœ‹çœ‹æ“ä½œä¹‹åçš„ç›®å½•</span><br><span class="line"></span><br><span class="line"><span class="variable">$mount</span> -t overlay overlay -o lowerdir=lower1:lower2:lower3,upperdir=upper,workdir=work merged</span><br><span class="line"><span class="comment"># (3) æŒ‚è½½åçš„æ“ä½œç›®å½•`mergedæŒ‚è½½ç‚¹`.</span></span><br><span class="line">â”œâ”€â”€ lower1</span><br><span class="line">â”‚   â”œâ”€â”€ common.txt</span><br><span class="line">â”‚   â””â”€â”€ ower1.sh</span><br><span class="line">â”œâ”€â”€ lower2</span><br><span class="line">â”‚   â”œâ”€â”€ common.txt</span><br><span class="line">â”‚   â””â”€â”€ ower2.sh</span><br><span class="line">â”œâ”€â”€ lower3</span><br><span class="line">â”‚   â”œâ”€â”€ common.txt</span><br><span class="line">â”‚   â””â”€â”€ ower3.sh</span><br><span class="line">â”œâ”€â”€ merged        <span class="comment">#æ˜¯ä¸æ˜¯çœ‹å‡ºäº†ä»€ä¹ˆå¥¥ç§˜ï¼Œå¾ˆæ¸…æ™°çš„è¯´æ˜äº†overlayFSçš„ä¸Šé¢ä¸¤ä¸ªç‰¹å¾</span></span><br><span class="line">â”‚   â”œâ”€â”€ common.txt</span><br><span class="line">â”‚   â”œâ”€â”€ ower1.sh</span><br><span class="line">â”‚   â”œâ”€â”€ ower2.sh</span><br><span class="line">â”‚   â”œâ”€â”€ ower3.sh</span><br><span class="line">â”‚   â””â”€â”€ up.txt</span><br><span class="line">â”œâ”€â”€ upper</span><br><span class="line">â”‚   â”œâ”€â”€ ower2.sh</span><br><span class="line">â”‚   â””â”€â”€ up.txt</span><br><span class="line">â””â”€â”€ work</span><br><span class="line">    â””â”€â”€ work</span><br></pre></td></tr></table></figure></p>
<p>æ­£å¦‚å‰é¢ä»‹ç»çš„COW(å†™æ—¶å¤åˆ¶)åœ¨overlayFSä¸­ä¹Ÿæ˜¯åªå¯¹äºåªè¯»çš„lowerå±‚çš„æ“ä½œï¼Œå½“ç”¨åˆ°å®ƒæ—¶å€™ä¼šæŠŠå®ƒå¤åˆ¶åˆ°upperå±‚ç„¶åå†å¯¹upperçš„è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬æ¼”ç¤ºå‡ ä¸ªå¯¹æŒ‚è½½åçš„ç›®å½•çš„æ“ä½œï¼Œå°±èƒ½å¾ˆæ˜ç™½è¿™ä¸ªè¿‡ç¨‹äº†ï¼š</p>
<ul>
<li>1.åˆ é™¤çš„æ–‡ä»¶æ˜¯upperçš„ï¼Œå¹¶ä¸”è¿™ä¸ªæ–‡ä»¶åœ¨lowerå±‚ä¸å­˜åœ¨ï¼ˆup.txtï¼‰ ç›´æ¥åˆ é™¤å°±è¡Œäº†</li>
<li>2.åˆ é™¤çš„æ–‡ä»¶æ¥è‡ªäºlowerå±‚è€Œupperå±‚æ²¡æœ‰å¯¹åº”çš„æ–‡ä»¶ï¼ˆower3.shï¼‰, overlayFSé€šè¿‡ä¸€ç§å«whiteoutçš„æœºåˆ¶å®ƒå¯ä»¥ç”¨äºå±è”½åº•å±‚çš„åŒåæ–‡ä»¶ï¼Œåœ¨upperå±‚åˆ›å»ºä¸€ä¸ª<code>ä¸»æ¬¡è®¾å¤‡å·ï¼ˆmknod c 0 0ï¼‰éƒ½æ˜¯0çš„è®¾å¤‡</code>ï¼Œå½“åœ¨mergeå±‚å»æ‰¾çš„æ—¶å€™ï¼ŒoverlayFSä¼šè‡ªåŠ¨è¿‡æ»¤æ‰å’Œwhiteoutæ–‡ä»¶è‡ªèº«ä»¥åŠå’Œä»–åŒåçš„lowerå±‚çš„æ–‡ä»¶ï¼Œä»è€Œè¾¾åˆ°éšè—çš„ç›®çš„;</li>
<li>3.åˆ é™¤çš„æ˜¯upperè¦†ç›–lowerçš„æ–‡ä»¶ï¼ˆower2.shï¼‰ ä¾ç„¶åˆ›å»ºä¸€ä¸ªwhiteoutæ–‡ä»¶;</li>
<li>4.åˆ›å»ºä¸€ä¸ªupperå’Œloweréƒ½æ²¡æœ‰çš„ç›®å½• ç›´æ¥åœ¨upperä¸­æ–°å¢ä¸€ä¸ª;</li>
<li>5.åˆ›å»ºä¸€ä¸ªåœ¨lowerå±‚å·²ç»å­˜åœ¨ä¸”åœ¨upperå±‚æœ‰whiteoutæ–‡ä»¶çš„åŒåæ–‡ä»¶å¹¶åˆ äº†whiteoutæ–‡ä»¶ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ª;</li>
<li>6.åˆ›å»ºä¸€ä¸ªlowerå±‚å­˜åœ¨å¹¶ä¸”upperå±‚å·²ç»æœ‰å¯¹åº”whiteoutæ–‡ä»¶çš„ç›®å½•,å¦‚æœè¿™ä¸ªæ—¶å€™å•çº¯çš„åˆ é™¤whiteoutæ–‡ä»¶ï¼Œé‚£ä¹ˆlowerå±‚å¯¹åº”ç›®å½•é‡Œé¢çš„æ–‡ä»¶å°±ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚</li>
</ul>
<p>overlayFSå¼•å…¥äº†ä¸€ç§Opaque(<code>ä¸é€æ˜çš„</code>)çš„å±æ€§ï¼Œé€šè¿‡è®¾ç½®upperå±‚ä¸Šå¯¹åº”çš„ç›®å½•ä¸Šè®¾ç½®<code>&quot;trusted.overlay.opaque&quot;</code>ä¸ºyæ¥å®ç°ï¼ˆå‰ææ˜¯upperæ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿæ”¯æŒxattrå±æ€§ï¼‰ï¼ŒoverlayFSåœ¨è¯»å–ä¸Šä¸‹å±‚å­˜åœ¨åŒåç›®å½•çš„æ—¶å€™ï¼Œå¦‚æœupperå±‚çš„ç›®å½•è¢«è®¾ç½®äº†Opaqueçš„å±æ€§ï¼Œä»–ä¼šå¿½è¿™ä¸ªç›®å½•ä¸‹å±‚çš„æ‰€æœ‰åŒåç›®å½•é¡¹æ¥ä¿è¯æ–°å»ºçš„æ˜¯ä¸ªç©ºç›®å½•ã€‚<br><figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200810174847.png" target="_blank" title="WeiyiGeek.Opaqueå±æ€§" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200810174847.png" alt="WeiyiGeek.Opaqueå±æ€§" title="" class=""></a>
                <p>WeiyiGeek.Opaqueå±æ€§</p>
            </figure></p>
<p><br></p>
<h6 id="æ˜ å°„å™¨-Device-mapper-å·²ç»åœ¨-docker-18-09-ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒ"><a href="#æ˜ å°„å™¨-Device-mapper-å·²ç»åœ¨-docker-18-09-ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒ" class="headerlink" title="æ˜ å°„å™¨ (Device mapper) - å·²ç»åœ¨ docker 18.09 ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒ."></a>æ˜ å°„å™¨ (Device mapper) - å·²ç»åœ¨ docker 18.09 ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒ.</h6><p>æè¿°:Device mapperæ˜¯Linuxå†…æ ¸2.6.9åæ”¯æŒçš„ï¼Œæä¾›çš„ä¸€ç§ä»é€»è¾‘è®¾å¤‡åˆ°ç‰©ç†è®¾å¤‡çš„æ˜ å°„æ¡†æ¶æœºåˆ¶ï¼Œåœ¨è¯¥æœºåˆ¶ä¸‹ï¼Œç”¨æˆ·å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ ¹æ®è‡ªå·±çš„éœ€è¦åˆ¶å®šå®ç°å­˜å‚¨èµ„æºçš„ç®¡ç†ç­–ç•¥;<br>æ³¨æ„ç‚¹:AUFSå’ŒOverlayFSéƒ½æ˜¯æ–‡ä»¶çº§å­˜å‚¨ï¼Œè€ŒDevice mapperæ˜¯å—çº§å­˜å‚¨ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯ç›´æ¥å¯¹å—è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯æ–‡ä»¶ã€‚</p>
<p>Device mapperé©±åŠ¨ä¼šå…ˆåœ¨å—è®¾å¤‡ä¸Šåˆ›å»ºä¸€ä¸ªèµ„æºæ± ï¼Œç„¶ååœ¨èµ„æºæ± ä¸Šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬è®¾å¤‡ï¼Œæ‰€æœ‰é•œåƒéƒ½æ˜¯è¿™ä¸ªåŸºæœ¬è®¾å¤‡çš„å¿«ç…§ï¼Œè€Œ<code>å®¹å™¨åˆ™æ˜¯é•œåƒçš„å¿«ç…§</code>ã€‚æ‰€ä»¥åœ¨å®¹å™¨é‡Œçœ‹åˆ°æ–‡ä»¶ç³»ç»Ÿæ˜¯èµ„æºæ± ä¸ŠåŸºæœ¬è®¾å¤‡çš„æ–‡ä»¶ç³»ç»Ÿçš„å¿«ç…§ï¼Œå¹¶ä¸æœ‰ä¸ºå®¹å™¨åˆ†é…ç©ºé—´ã€‚å½“è¦å†™å…¥ä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œåœ¨å®¹å™¨çš„é•œåƒå†…ä¸ºå…¶åˆ†é…æ–°çš„å—å¹¶å†™å…¥æ•°æ®(å†™æ—¶åˆ†é…)</p>
<p>Device mapperå­˜å‚¨é©±åŠ¨é»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ª100Gçš„æ–‡ä»¶åŒ…å«é•œåƒå’Œå®¹å™¨(å…¶å®å°±æ˜¯èµ„æºå­˜å‚¨æ± )ã€‚æ¯ä¸€ä¸ªå®¹å™¨è¢«é™åˆ¶åœ¨10Gå¤§å°çš„å·å†…ï¼Œå¯ä»¥è‡ªå·±é…ç½®è°ƒæ•´ã€‚å®ƒä¼šé»˜è®¤ä¼šåœ¨<code>/var/lib/docker/devicemapper/devicemapper</code>ç›®å½•ä¸‹ç”Ÿæˆdataå’Œmetadataä¸¤ä¸ªç¨€ç–æ–‡ä»¶ï¼Œå¹¶å°†ä¸¤ä¸ªæ–‡ä»¶æŒ‚ä¸ºloopè®¾å¤‡ä½œä¸ºå—è®¾å¤‡æ¥ä½¿ç”¨(é»˜è®¤æ¨¡å¼)ï¼Œå®ƒä½¿ç”¨ç©ºé—²æ–‡ä»¶æ¥æ„å»ºå­˜å‚¨æ± ï¼Œæ€§èƒ½éå¸¸ä½ã€‚</p>
<p>æ³¨æ„äº‹é¡¹:</p>
<ul>
<li><p>1.å½“è¦ä¿®æ”¹å·²æœ‰æ–‡ä»¶æ—¶ï¼Œå†ä½¿ç”¨CoWä¸ºå®¹å™¨å¿«ç…§åˆ†é…å—ç©ºé—´ï¼Œå°†è¦ä¿®æ”¹çš„æ•°æ®å¤åˆ¶åˆ°åœ¨å®¹å™¨å¿«ç…§ä¸­æ–°çš„å—é‡Œå†è¿›è¡Œä¿®æ”¹,æ³¨æ„æŒ‚è½½åçš„ç£ç›˜UUIDå˜åŒ–ååˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ”¹deviceset-metadataæ¥æŒ‡å®šBaseDeviceUUID;</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119231700.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119231700.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
</li>
<li><p>2.åœ¨18.09ç‰ˆæœ¬ä¹‹å‰åœ¨Dockeråˆå§‹åŒ–æ—¶å€™å¯ä»¥æŒ‡å®š<code>--storage-opt dm.loopdatasize=500G --storage-opt dm.loopmetadatasize=4G</code>,å°†å›æ”¶ç¯å¢ƒè®¾å¤‡å¤§å°è®¾ç½®ä¸º500G(æ•°æ®å­˜å‚¨)ï¼Œå…ƒæ•°æ®æ–‡ä»¶å¤§å°ä¸º4G(ç¨€ç–æ–‡ä»¶),ç„¶ååˆ†åˆ«é™„åŠ åˆ°å›ç¯è®¾å¤‡/dev/loop0å’Œ/dev/loop1ï¼Œå…¶æ¬¡å†åŸºäºå›ç¯å—è®¾å¤‡åˆ›å»ºThin Pool;</p>
</li>
</ul>
<h6 id="Btrfs"><a href="#Btrfs" class="headerlink" title="Btrfs"></a>Btrfs</h6><p>æè¿°:Btrfsè¢«ç§°ä¸ºä¸‹ä¸€ä»£å†™æ—¶å¤åˆ¶æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶å…¥Linuxå†…æ ¸ä¹Ÿæ˜¯æ–‡ä»¶çº§çº§å­˜å‚¨ï¼Œä½†å¯ä»¥åƒDevice mapperä¸€ç›´æ¥æ“ä½œåº•å±‚è®¾å¤‡ã€‚</p>
<p>BtrfsæŠŠæ–‡ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†é…ç½®ä¸ºä¸€ä¸ªå®Œæ•´çš„å­æ–‡ä»¶ç³»ç»Ÿï¼Œç§°ä¹‹ä¸ºsubvolume ã€‚é‚£ä¹ˆé‡‡ç”¨ subvolumeï¼Œä¸€ä¸ªå¤§çš„æ–‡ä»¶ç³»ç»Ÿå¯ä»¥è¢«åˆ’åˆ†ä¸ºå¤šä¸ªå­æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™äº›å­æ–‡ä»¶ç³»ç»Ÿå…±äº«åº•å±‚çš„è®¾å¤‡ç©ºé—´ï¼Œåœ¨éœ€è¦ç£ç›˜ç©ºé—´æ—¶ä¾¿ä»åº•å±‚è®¾å¤‡ä¸­åˆ†é…ï¼Œç±»ä¼¼åº”ç”¨ç¨‹åºè°ƒç”¨ malloc()åˆ†é…å†…å­˜ä¸€æ ·ã€‚ä¸ºäº†çµæ´»åˆ©ç”¨è®¾å¤‡ç©ºé—´ï¼ŒBtrfs å°†ç£ç›˜ç©ºé—´åˆ’åˆ†ä¸ºå¤šä¸ªchunk ã€‚æ¯ä¸ªchunkå¯ä»¥ä½¿ç”¨ä¸åŒçš„ç£ç›˜ç©ºé—´åˆ†é…ç­–ç•¥ã€‚æ¯”å¦‚æŸäº›chunkåªå­˜æ”¾metadataï¼ŒæŸäº›chunkåªå­˜æ”¾æ•°æ®</p>
<p>æ¨¡å‹ä¼˜ç‚¹:Btrfsæ”¯æŒåŠ¨æ€æ·»åŠ è®¾å¤‡,ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­å¢åŠ æ–°çš„ç£ç›˜ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨Btrfsçš„å‘½ä»¤å°†è¯¥è®¾å¤‡æ·»åŠ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>
<p>BtrfsæŠŠä¸€ä¸ªå¤§çš„æ–‡ä»¶ç³»ç»Ÿå½“æˆä¸€ä¸ªèµ„æºæ± ï¼Œé…ç½®æˆå¤šä¸ªå®Œæ•´çš„å­æ–‡ä»¶ç³»ç»Ÿï¼Œè¿˜å¯ä»¥å¾€èµ„æºæ± é‡ŒåŠ æ–°çš„å­æ–‡ä»¶ç³»ç»Ÿï¼Œè€ŒåŸºç¡€é•œåƒåˆ™æ˜¯å­æ–‡ä»¶ç³»ç»Ÿçš„å¿«ç…§ï¼Œæ¯ä¸ªå­é•œåƒå’Œå®¹å™¨éƒ½æœ‰è‡ªå·±çš„å¿«ç…§ï¼Œè¿™äº›å¿«ç…§åˆ™éƒ½æ˜¯<code>subvolume</code>çš„å¿«ç…§ã€‚</p>
<ul>
<li>å½“å†™å…¥ä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œä¸ºåœ¨å®¹å™¨çš„å¿«ç…§é‡Œä¸ºå…¶åˆ†é…ä¸€ä¸ªæ–°çš„æ•°æ®å—ï¼Œæ–‡ä»¶å†™åœ¨è¿™ä¸ªç©ºé—´é‡Œï¼Œè¿™ä¸ªå«ç”¨æ—¶åˆ†é…</li>
<li>å½“è¦ä¿®æ”¹å·²æœ‰æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨CoWå¤åˆ¶åˆ†é…ä¸€ä¸ªæ–°çš„åŸå§‹æ•°æ®å’Œå¿«ç…§ï¼Œåœ¨è¿™ä¸ªæ–°åˆ†é…çš„ç©ºé—´å˜æ›´æ•°æ®ï¼Œå˜ç»“æŸå†æ›´æ–°ç›¸å…³çš„æ•°æ®ç»“æ„æŒ‡å‘æ–°å­æ–‡ä»¶ç³»ç»Ÿå’Œå¿«ç…§ï¼ŒåŸæ¥çš„åŸå§‹æ•°æ®å’Œå¿«ç…§æ²¡æœ‰æŒ‡é’ˆæŒ‡å‘ï¼Œè¢«è¦†ç›–ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119232215.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119232215.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<h6 id="ZFS"><a href="#ZFS" class="headerlink" title="ZFS"></a>ZFS</h6><p>æè¿°:ZFS æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªé©å‘½æ€§çš„å…¨æ–°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä»æ ¹æœ¬ä¸Šæ”¹å˜äº†æ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†æ–¹å¼ï¼ŒZFS å®Œå…¨æŠ›å¼ƒäº†â€å·ç®¡ç†â€ï¼Œä¸å†åˆ›å»ºè™šæ‹Ÿçš„å·ï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰è®¾å¤‡é›†ä¸­åˆ°ä¸€ä¸ªå­˜å‚¨æ± ä¸­æ¥è¿›è¡Œç®¡ç†ï¼Œç”¨â€å­˜å‚¨æ± â€çš„æ¦‚å¿µæ¥ç®¡ç†ç‰©ç†å­˜å‚¨ç©ºé—´ã€‚ä»¥å‰æ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯æ„å»ºåœ¨ç‰©ç†è®¾å¤‡ä¹‹ä¸Šçš„ã€‚ä¸ºäº†ç®¡ç†è¿™äº›ç‰©ç†è®¾å¤‡ï¼Œå¹¶ä¸ºæ•°æ®æä¾›å†—ä½™ï¼Œâ€å·ç®¡ç†â€çš„æ¦‚å¿µæä¾›äº†ä¸€ä¸ªå•è®¾å¤‡çš„æ˜ åƒã€‚è€ŒZFSåˆ›å»ºåœ¨è™šæ‹Ÿçš„ï¼Œè¢«ç§°ä¸ºâ€zpoolsâ€çš„å­˜å‚¨æ± ä¹‹ä¸Šã€‚æ¯ä¸ªå­˜å‚¨æ± ç”±è‹¥å¹²è™šæ‹Ÿè®¾å¤‡ï¼ˆvirtual devicesï¼Œvdevsï¼‰ç»„æˆã€‚è¿™äº›è™šæ‹Ÿè®¾å¤‡å¯ä»¥æ˜¯åŸå§‹ç£ç›˜ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªRAID1é•œåƒè®¾å¤‡ï¼Œæˆ–æ˜¯éæ ‡å‡†RAIDç­‰çº§çš„å¤šç£ç›˜ç»„ã€‚äºæ˜¯zpoolä¸Šçš„æ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä½¿ç”¨è¿™äº›è™šæ‹Ÿè®¾å¤‡çš„æ€»å­˜å‚¨å®¹é‡ã€‚</p>
<ul>
<li>å½“è¦å†™ä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ä½¿ç”¨æŒ‰éœ€åˆ†é…ï¼Œä¸€ä¸ªæ–°çš„æ•°æ®å¿«ä»zpoolé‡Œç”Ÿæˆï¼Œæ–°çš„æ•°æ®å†™å…¥è¿™ä¸ªå—ï¼Œè€Œè¿™ä¸ªæ–°ç©ºé—´å­˜äºå®¹å™¨ï¼ˆZFSçš„å…‹éš†ï¼‰é‡Œã€‚</li>
<li>å½“è¦ä¿®æ”¹ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡ä»¶æ—¶ä½¿ç”¨å†™æ—¶å¤åˆ¶WoCï¼Œåˆ†é…ä¸€ä¸ªæ–°ç©ºé—´å¹¶æŠŠåŸå§‹æ•°æ®å¤åˆ¶åˆ°æ–°ç©ºé—´å®Œæˆä¿®æ”¹ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119232651.png" target="_blank" title="WeiyiGeek.ZFS" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119232651.png" alt="WeiyiGeek.ZFS" title="" class=""></a>
                <p>WeiyiGeek.ZFS</p>
            </figure>
<p>é¦–å…ˆä»zpoolé‡Œåˆ†é…ä¸€ä¸ªZFSæ–‡ä»¶ç³»ç»Ÿç»™é•œåƒçš„åŸºç¡€å±‚ï¼Œè€Œå…¶ä»–é•œåƒå±‚åˆ™æ˜¯è¿™ä¸ªZFSæ–‡ä»¶ç³»ç»Ÿå¿«ç…§çš„å…‹éš†ï¼Œå¿«ç…§æ˜¯åªè¯»çš„ï¼Œè€Œå…‹éš†æ˜¯å¯å†™çš„ï¼Œå½“å®¹å™¨å¯åŠ¨æ—¶åˆ™åœ¨é•œåƒçš„æœ€é¡¶å±‚ç”Ÿæˆä¸€ä¸ªå¯å†™å±‚ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119232756.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119232756.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><br></p>
<p><strong>å­˜å‚¨é©±åŠ¨çš„å¯¹æ¯”åŠé€‚åº”åœºæ™¯</strong></p>
<ul>
<li><p>AUFS VS Overlay<br>AUFSå’ŒOverlayéƒ½æ˜¯è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œä½†AUFSæœ‰å¤šå±‚ï¼Œè€ŒOverlayåªæœ‰ä¸¤å±‚ï¼Œæ‰€ä»¥åœ¨åšå†™æ—¶å¤åˆ¶æ“ä½œæ—¶ï¼Œå¦‚æœæ–‡ä»¶æ¯”è¾ƒå¤§ä¸”å­˜åœ¨æ¯”è¾ƒä½çš„å±‚ï¼Œåˆ™AUSFå¯èƒ½ä¼šæ…¢ä¸€äº›ã€‚è€Œä¸”Overlayå¹¶å…¥äº†linux kernel mainlineï¼ŒAUFSæ²¡æœ‰ï¼Œæ‰€ä»¥å¯èƒ½ä¼šæ¯”AUFSå¿«ã€‚ä½†Overlayè¿˜å¤ªå¹´è½»ï¼Œè¦è°¨æ…åœ¨ç”Ÿäº§ä½¿ç”¨ã€‚è€ŒAUFSåšä¸ºdockerçš„ç¬¬ä¸€ä¸ªå­˜å‚¨é©±åŠ¨ï¼Œå·²ç»æœ‰å¾ˆé•¿çš„å†å²ï¼Œæ¯”è¾ƒçš„ç¨³å®šï¼Œä¸”åœ¨å¤§é‡çš„ç”Ÿäº§ä¸­å®è·µè¿‡ï¼Œæœ‰è¾ƒå¼ºçš„ç¤¾åŒºæ”¯æŒã€‚ç›®å‰å¼€æºçš„DC/OSæŒ‡å®šä½¿ç”¨Overlayã€‚</p>
</li>
<li><p>Overlay VS Device mapper<br>Overlayæ˜¯æ–‡ä»¶çº§å­˜å‚¨ï¼ŒDevice mapperæ˜¯å—çº§å­˜å‚¨ï¼Œå½“æ–‡ä»¶ç‰¹åˆ«å¤§è€Œä¿®æ”¹çš„å†…å®¹å¾ˆå°ï¼ŒOverlayä¸ç®¡ä¿®æ”¹çš„å†…å®¹å¤§å°éƒ½ä¼šå¤åˆ¶æ•´ä¸ªæ–‡ä»¶ï¼Œå¯¹å¤§æ–‡ä»¶è¿›è¡Œä¿®æ”¹æ˜¾ç¤ºè¦æ¯”å°æ–‡ä»¶è¦æ¶ˆè€—æ›´å¤šçš„æ—¶é—´ï¼Œè€Œå—çº§æ— è®ºæ˜¯å¤§æ–‡ä»¶è¿˜æ˜¯å°æ–‡ä»¶éƒ½åªå¤åˆ¶éœ€è¦ä¿®æ”¹çš„å—ï¼Œå¹¶ä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹æ˜¾ç„¶device mapperè¦å¿«ä¸€äº›ã€‚å› ä¸ºå—çº§çš„æ˜¯ç›´æ¥è®¿é—®é€»è¾‘ç›˜ï¼Œé€‚åˆIOå¯†é›†çš„åœºæ™¯ã€‚è€Œå¯¹äºç¨‹åºå†…éƒ¨å¤æ‚ï¼Œå¤§å¹¶å‘ä½†å°‘IOçš„åœºæ™¯ï¼ŒOverlayçš„æ€§èƒ½ç›¸å¯¹è¦å¼ºä¸€äº›ã€‚</p>
</li>
</ul>
<ul>
<li>Device mapper VS Btrfs Driver VS ZFS<br>Device mapperå’ŒBtrfséƒ½æ˜¯ç›´æ¥å¯¹å—æ“ä½œï¼Œéƒ½ä¸æ”¯æŒå…±äº«å­˜å‚¨ï¼Œè¡¨ç¤ºå½“æœ‰å¤šä¸ªå®¹å™¨è¯»åŒä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œéœ€è¦ç”Ÿæ´»å¤šä¸ªå¤æœ¬ï¼Œæ‰€ä»¥è¿™ç§å­˜å‚¨é©±åŠ¨ä¸é€‚åˆåœ¨é«˜å¯†åº¦å®¹å™¨çš„PaaSå¹³å°ä¸Šä½¿ç”¨ã€‚è€Œä¸”åœ¨å¾ˆå¤šå®¹å™¨å¯åœçš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´ç£ç›˜æº¢å‡ºï¼Œé€ æˆä¸»æœºä¸èƒ½å·¥ä½œã€‚Device mapperä¸å»ºè®®åœ¨ç”Ÿäº§ä½¿ç”¨ã€‚Btrfsåœ¨docker buildå¯ä»¥å¾ˆé«˜æ•ˆã€‚<br>ZFSæœ€åˆæ˜¯ä¸ºæ‹¥æœ‰å¤§é‡å†…å­˜çš„SalarisæœåŠ¡å™¨è®¾è®¡çš„ï¼Œæ‰€åœ¨åœ¨ä½¿ç”¨æ—¶å¯¹å†…å­˜ä¼šæœ‰å½±å“ï¼Œé€‚åˆå†…å­˜å¤§çš„ç¯å¢ƒã€‚ZFSçš„COWä½¿ç¢ç‰‡åŒ–é—®é¢˜æ›´åŠ ä¸¥é‡ï¼Œå¯¹äºé¡ºåºå†™ç”Ÿæˆçš„å¤§æ–‡ä»¶ï¼Œå¦‚æœä»¥åéšæœºçš„å¯¹å…¶ä¸­çš„ä¸€éƒ¨åˆ†è¿›è¡Œäº†æ›´æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶åœ¨ç¡¬ç›˜ä¸Šçš„ç‰©ç†åœ°å€å°±å˜å¾—ä¸å†è¿ç»­ï¼Œæœªæ¥çš„é¡ºåºè¯»ä¼šå˜å¾—æ€§èƒ½æ¯”è¾ƒå·®ã€‚ZFSæ”¯æŒå¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªç¼“å­˜å—ï¼Œé€‚åˆPaaSå’Œé«˜å¯†åº¦çš„ç”¨æˆ·åœºæ™¯ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233210.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233210.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><strong>IOæ€§èƒ½å¯¹æ¯”</strong><br>æµ‹è¯•å·¥å…·ï¼šIOzoneï¼ˆæ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„benchmarkå·¥å…·ï¼Œå¯ä»¥æµ‹è¯•ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™æ€§èƒ½ï¼‰<br>æµ‹è¯•åœºæ™¯ï¼šä»4Kåˆ°1Gæ–‡ä»¶çš„é¡ºåºå’ŒéšæœºIOæ€§èƒ½<br>æµ‹è¯•æ–¹æ³•ï¼šåŸºäºä¸åŒçš„å­˜å‚¨é©±åŠ¨å¯åŠ¨å®¹å™¨ï¼Œåœ¨å®¹å™¨å†…å®‰è£…IOzoneï¼Œæ‰§è¡Œå‘½ä»¤<code>./iozone -a -n 4k -g 1g -i 0 -i 1 -i 2 -f /root/test.rar -Rb ./iozone.xls</code></p>
<p>æµ‹è¯•é¡¹çš„å®šä¹‰å’Œè§£é‡Š</p>
<ul>
<li>Writeï¼šæµ‹è¯•å‘ä¸€ä¸ªæ–°æ–‡ä»¶å†™å…¥çš„æ€§èƒ½ã€‚</li>
<li>Re-writeï¼šæµ‹è¯•å‘ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡ä»¶å†™å…¥çš„æ€§èƒ½ã€‚</li>
<li>Readï¼šæµ‹è¯•è¯»ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡ä»¶çš„æ€§èƒ½ã€‚</li>
<li>Re-Readï¼šæµ‹è¯•è¯»ä¸€ä¸ªæœ€è¿‘è¯»è¿‡çš„æ–‡ä»¶çš„æ€§èƒ½ã€‚</li>
<li>Random Readï¼šæµ‹è¯•è¯»ä¸€ä¸ªæ–‡ä»¶ä¸­çš„éšæœºåç§»é‡çš„æ€§èƒ½ã€‚</li>
<li>Random Writeï¼šæµ‹è¯•å†™ä¸€ä¸ªæ–‡ä»¶ä¸­çš„éšæœºåç§»é‡çš„æ€§èƒ½ã€‚</li>
</ul>
<p>æµ‹è¯•æ•°æ®å¯¹æ¯”ç»“æœ:</p>
<ul>
<li><p>Write</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233814.png" target="_blank" title="WeiyiGeek.Write" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233814.png" alt="WeiyiGeek.Write" title="" class=""></a>
                <p>WeiyiGeek.Write</p>
            </figure>
</li>
<li><p>Re-write</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233842.png" target="_blank" title="WeiyiGeek.Re-write" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233842.png" alt="WeiyiGeek.Re-write" title="" class=""></a>
                <p>WeiyiGeek.Re-write</p>
            </figure>
</li>
<li><p>Read</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233929.png" target="_blank" title="WeiyiGeek.Read" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233929.png" alt="WeiyiGeek.Read" title="" class=""></a>
                <p>WeiyiGeek.Read</p>
            </figure>
</li>
<li><p>Re-Read</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233946.png" target="_blank" title="WeiyiGeek.Re-Read" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119233946.png" alt="WeiyiGeek.Re-Read" title="" class=""></a>
                <p>WeiyiGeek.Re-Read</p>
            </figure>
</li>
<li><p>Random Read</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119234114.png" target="_blank" title="WeiyiGeek.Random Read" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119234114.png" alt="WeiyiGeek.Random Read" title="" class=""></a>
                <p>WeiyiGeek.Random Read</p>
            </figure>
</li>
<li><p>Random Write</p>
<figure class="image-box">
                <a rel=5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119234143.png" target="_blank" title="WeiyiGeek.Random Write" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200119234143.png" alt="WeiyiGeek.Random Write" title="" class=""></a>
                <p>WeiyiGeek.Random Write</p>
            </figure>
</li>
</ul>
<p>é€šè¿‡ä»¥ä¸Šçš„æ€§èƒ½æ•°æ®å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>AUFSåœ¨è¯»çš„æ–¹é¢æ€§èƒ½ç›¸æ¯”Overlayè¦å·®ä¸€äº›ï¼Œä½†åœ¨å†™çš„æ–¹é¢æ€§èƒ½æ¯”Overlayè¦å¥½ã€‚</li>
<li>device mapperåœ¨512Mä»¥ä¸Šæ–‡ä»¶çš„è¯»å†™æ€§èƒ½éƒ½éå¸¸çš„å·®ï¼Œä½†åœ¨512Mä»¥ä¸‹çš„æ–‡ä»¶è¯»å†™æ€§èƒ½éƒ½æ¯”è¾ƒå¥½ã€‚</li>
<li>btrfsåœ¨512Mä»¥ä¸Šçš„æ–‡ä»¶è¯»å†™æ€§èƒ½éƒ½éå¸¸å¥½ï¼Œä½†åœ¨512Mä»¥ä¸‹çš„æ–‡ä»¶è¯»å†™æ€§èƒ½ç›¸æ¯”å…¶ä»–çš„å­˜å‚¨é©±åŠ¨éƒ½æ¯”è¾ƒå·®ã€‚</li>
<li>ZFSæ•´ä½“çš„è¯»å†™æ€§èƒ½ç›¸æ¯”å…¶ä»–çš„å­˜å‚¨é©±åŠ¨éƒ½è¦å·®ä¸€äº›</li>
</ul>
<p><em>æ³¨æ„äº‹é¡¹:</em></p>
<ul>
<li>Centosç³»ç»Ÿä¸Šï¼ˆé»˜è®¤ä¸æ”¯æŒaufséœ€è¦æŸ¥çœ‹AUFSæ˜¯å¦åŠ å…¥Linuxå†…æ ¸ï¼‰ï¼Œæ¨èä½¿ç”¨overlayfså­˜å‚¨é©±åŠ¨;</li>
<li>devicemapperé»˜è®¤ä¼šåœ¨/var/lib/docker/devicemapper/devicemapperç›®å½•ä¸‹ç”Ÿæˆdataå’Œmetadataä¸¤ä¸ªç¨€ç–æ–‡ä»¶ï¼Œå¹¶å°†ä¸¤ä¸ªæ–‡ä»¶æŒ‚ä¸ºloopè®¾å¤‡ä½œä¸ºå—è®¾å¤‡æ¥ä½¿ç”¨ã€‚</li>
<li>Directå’ŒLVMçš„æœ€å¤§ä¸åŒæ˜¯åˆ›å»ºDM thin poolçš„ä¸å†æ˜¯é€šè¿‡losetupæŒ‚è½½çš„ä¸¤ä¸ªç¨€ç–æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸¤ä¸ªè£¸çš„çœŸæ­£çš„å—è®¾å¤‡ã€‚ç”±äºdirect lvmçš„è¯»å†™æ€§èƒ½è¡¨ç°æ›´åŠ ç¨³å®šï¼Œæ¨èç”Ÿäº§ç¯å¢ƒä¸Šä½¿ç”¨direct-lvmæ¨¡å¼;</li>
</ul>
<p><br></p>
<h5 id="7-æ•°æ®å…±äº«ä¸æŒä¹…åŒ–"><a href="#7-æ•°æ®å…±äº«ä¸æŒä¹…åŒ–" class="headerlink" title="7.æ•°æ®å…±äº«ä¸æŒä¹…åŒ–"></a>7.æ•°æ®å…±äº«ä¸æŒä¹…åŒ–</h5><p>æè¿°:Docker æ•°æ®å·æ˜¯è¢«ç”¨äºå…±äº«å’ŒæŒä¹…åŒ–æ•°æ®çš„ï¼Œè€Œä¸”å®ƒçš„å£°æ˜å‘¨æœŸæ˜¯ç‹¬ç«‹äºå®¹å™¨çš„ï¼Œæ‰€ä»¥å½“å®¹å™¨å®•æ‰æˆ–è€…åˆ é™¤å¹¶ä¸ä¼šå¯¼è‡´æ•°æ®å·ä¸­çš„æ•°æ®ä¸¢å¤±;</p>
<p>Q: æ•°æ®å·çš„å®ç°åŸç†?<br>ç­”: ç®€å•çš„è¯´å·å…¶å®å°±æ˜¯æ–‡ä»¶æˆ–è€…ç›®å½•ï¼Œé€šè¿‡æŒ‚è½½çš„æ–¹å¼ï¼Œç”±Docker DaemonæŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼Œä¸å±äºè”åˆç³»ç»Ÿ;</p>
<p>Docker æä¾›çš„å‡ ç§æ•°æ®å·çš„å®ç°æ–¹å¼:</p>
<ul>
<li>1.æ•°æ®å·<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) å®¿ä¸»æœºéšæœºç›®å½•,æŒ‡å®šçš„ç›®å½•å¦‚æœæ²¡æœ‰ä¸å­˜åœ¨å°†ä¼šè¢«åˆ›å»º</span></span><br><span class="line">docker run -itd -v /tmp/container/folder --name data-volume busybox top</span><br><span class="line">docker inspect data-volume -f <span class="string">'Source:&#123;&#123;(index .Mounts 0).Source&#125;&#125;&#123;&#123;println&#125;&#125;Destination:&#123;&#123;(index .Mounts 0).Destination&#125;&#125;'</span></span><br><span class="line"><span class="comment"># å³è¡¨ç¤ºå®¹å™¨ä¸­çš„/tmp/container/folderç›®æ ‡è¢«æŒ‚è½½åˆ°å®¿ä¸»æœºçš„éšæœºç›®å½•;</span></span><br><span class="line"><span class="comment"># Source:/var/lib/docker/volumes/1a035d81e56447cd314faf560754b1808234645785f1b61a2c17199b16a7cf27/_data</span></span><br><span class="line"><span class="comment"># Destination:/tmp/container/folder</span></span><br><span class="line"><span class="variable">$docker</span> <span class="built_in">exec</span> -it data-volume sh</span><br><span class="line"><span class="variable">$ls</span> /tmp/container/folder/ls^C</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) å®¿ä¸»æœºæŒ‡å®šç›®å½•</span></span><br><span class="line">docker run -itd -v /tmp/mnt_isolation:/tmp/tar/tmp/container/folder --name data-volume-1 busybox top</span><br><span class="line">docker inspect data-volume-1 -f <span class="string">'Source:&#123;&#123;(index .Mounts 0).Source&#125;&#125;&#123;&#123;println&#125;&#125;Destination:&#123;&#123;(index .Mounts 0).Destination&#125;&#125;'</span></span><br><span class="line"><span class="comment"># æŒ‡å®šäº†å®¿ä¸»æœºæ˜ å°„çš„ç›®å½•ï¼ˆä¸‹é¢æŸ¥çœ‹æºã€ç›®çš„åœ°å€çš„ç›®å½•ï¼‰</span></span><br><span class="line"><span class="comment"># Source:/tmp/mnt_isolation</span></span><br><span class="line"><span class="comment"># Destination:/tmp/tar/tmp/container/folder</span></span><br></pre></td></tr></table></figure></li>
<li><p>2.æ•°æ®å·å®¹å™¨:æ”¯æŒå¤šä¸ªå®¹å™¨é€šè¿‡æŸä¸€ä¸ªå®¹å™¨è¿›è¡Œæ•°æ®å·¥ç¨‹ï¼ŒPS:k8sæ˜¯Podé‡‡ç”¨çš„å°±æ˜¯è¿™ç§å…±äº«æ–¹å¼ï¼›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (3) è¿æ¥å·²ç»å­˜åœ¨çš„æ•°æ®å·ï¼Œé€šè¿‡--volumes-fromå°†ä¸Šé¢çš„æ•°æ®å·data-volumeè¿›è¡ŒæŒ‚è½½èµ·æ¥</span></span><br><span class="line">docker run -itd --volumes-from data-volume --name data-volume-2 busybox top </span><br><span class="line"><span class="comment"># 91bfdb9c9ca88571faebf6f2409105b1e55d24866fe30a4ea7c2f750031c8baf</span></span><br><span class="line">docker run -itd --volumes-from data-volume --name data-volume-3 busybox top </span><br><span class="line"><span class="comment"># f601713d75277e6255e9a52a30046f1e38c169d7674f3ef2dd287bdb444820d1</span></span><br><span class="line"><span class="comment"># è¿›å…¥data-volume-3å®¹å™¨ä¸­åœ¨å…¶æ•°æ®å·ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$docker</span> <span class="built_in">exec</span> -it data-volume-3 touch /tmp/container/folder/$$.txt</span><br><span class="line"><span class="comment"># åˆ†åˆ«æŸ¥çœ‹å‡ ä¸ªå®¹å™¨å…±äº«çš„æ•°æ®å·æ˜¯å¦ä¸€è‡´</span></span><br><span class="line"><span class="variable">$docker</span> <span class="built_in">exec</span> -it data-volume-3 ls -alh /tmp/container/folder/</span><br><span class="line">-rw-r--r--    1 root     root           0 Jul  6 13:50 3758.txt</span><br><span class="line"><span class="variable">$docker</span> <span class="built_in">exec</span> -it data-volume-2 ls -alh /tmp/container/folder/</span><br><span class="line">-rw-r--r--    1 root     root           0 Jul  6 13:50 3758.txt</span><br><span class="line"><span class="variable">$docker</span> <span class="built_in">exec</span> -it data-volume ls -alh /tmp/container/folder/</span><br><span class="line">-rw-r--r--    1 root     root           0 Jul  6 13:50 3758.txt</span><br><span class="line"><span class="comment"># åˆ é™¤æ•°æ®å·å®¹å™¨ç›®å½•æ—¶éœ€è¦åŠ ä¸Š-våˆ™åˆ é™¤ä¸€ä¸ªåœæ­¢çš„å®¹å™¨å¹¶ä¸”å…¶æ•°æ®å·ä¸­çš„å†…å®¹</span></span><br><span class="line"><span class="variable">$docker</span> stop data-volume data-volume-2 data-volume-3</span><br><span class="line"><span class="variable">$docker</span> rm -v data-volume data-volume-2 data-volume-3   <span class="comment">#éœ€è¦åˆ é™¤å…¨éƒ¨çš„æ•°æ®å·å­˜å‚¨çš„æ•°æ®æ‰ä¼šå…¨éƒ¨æ¶ˆå¤±</span></span><br><span class="line">data-volume</span><br><span class="line"><span class="comment">#è¡¥å……:docker volume prune æ¸…é™¤å·²åœæ­¢çš„æ•°æ®å·</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>3.æ•°æ®å·æ’ä»¶<br>æè¿°:Dockeræœ‰å¤šç§å­˜å‚¨é©±åŠ¨æ¯”å¦‚aufsã€devicemapperç­‰ï¼Œå¯¹äºDockerçš„å­˜å‚¨å·ä¸€èˆ¬å°±æ˜¯ç”¨å®Œå°†ä¼šè¢«ä¸¢å¼ƒï¼Œå¾ˆéš¾è¢«æœ¬æœºæˆ–è€…å…¶å®ƒæœºå™¨çš„å®¹å™¨å¤ç”¨ï¼Œåœ¨å­˜å‚¨æ’ä»¶å‡ºç°ä¹‹å‰å¤ç”¨çš„å­˜å‚¨å·çš„å”¯ä¸€æ–¹å¼æ˜¯åœ¨docker run å‘½ä»¤ä¸­ï¼Œé€šè¿‡æ˜ å°„å®¿ä¸»æœºç›®å½•çš„æ–¹å¼(<code>-v æºå®¿ä¸»æœº:ç›®æ ‡å®¹å™¨</code>)ï¼Œå°†å·ä¸­ä¿å­˜çš„æ•°æ®ä¿å­˜åœ¨å®¿ä¸»æœºä¸Šï¼Œé€šè¿‡Volume Pluginæœºåˆ¶èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„æ•´åˆç¬¬ä¸‰æ–¹å­˜å‚¨ä¸ºDockeræä¾›Volume;</p>
</li>
</ul>
<p>Q: ä»€ä¹ˆæ˜¯å­˜å‚¨æ’ä»¶?<br>ç­”: é€šè¿‡ä½¿ç”¨Dockerå­˜å‚¨å·æ’ä»¶ï¼Œä¸ºå®¹å™¨æä¾›äº†æŒä¹…åŒ–å·å­˜å‚¨;</p>
<p>Q: å­˜å‚¨æ’ä»¶æœ‰å“ªäº›ï¼Ÿå¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§æ’ä»¶:</p>
<ul>
<li>Rancher Convoy å…¶åç«¯æ”¯æŒdevicemapperï¼ŒNFS, EBS ç­‰å®ç°å®¹å™¨è·¨ä¸»æœºå…±äº«æ•°æ®,å¹¶ä¸”æ”¯æŒå·çš„å¢é‡å¤‡ä»½å¿«ç…§ï¼Œå¤‡ä»½æ¢å¤ï¼Œè€Œä¸”ç”¨æˆ·ä¹Ÿå¯ä»¥æ–¹ä¾¿åœ¨ä¸åŒçš„å®¿ä¸»æœºä¸Šå…±äº«å·ï¼Œä»¥åŠå·çš„è¿ç§»,å®é™…å®ç°åŸç†è¿˜æ˜¯å°†ä¸»æœºç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¹‹ä¸­;</li>
</ul>
<p>Q: é‡‡ç”¨å“ªäº›æ–¹å¼è¿›è¡Œå®¹å™¨æ•°æ®å¤‡ä»½ï¼Ÿ</p>
<ul>
<li>1) é€šè¿‡å·æ’ä»¶ï¼Œåœ¨å®¿ä¸»æœºä¸Šé‡‡ç”¨æ‰‹å·¥çš„æ–¹å¼å°†åˆ†å¸ƒå¼ç³»ç»ŸæŒ‚è½½åˆ°æœ¬åœ°;</li>
<li>2) é€šè¿‡å®¹å™¨å†…éƒ¨æˆ–è€…å¤–éƒ¨æ•°æ®æ”¶é›†ç¨‹åº(<code>fluentdæˆ–filebeat</code>)å°†å­˜å‚¨äºå®¿ä¸»æœºä¸Šçš„æ•°æ®è¿›è¡Œå®æ—¶æ”¶é›†ä»è€Œå‡å°‘å®¹å™¨é”€æ¯å¯¼è‡´çš„æ•°æ®ä¸¢å¤±å¸¦æ¥çš„æŸå¤±;</li>
</ul>

        </div>
        
  <hr>
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>

  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ï¼Œè½¬ä¸ªå‘ã€‘(äººé—´äº”å¤§æƒ…)</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œè°¢è°¢ï¼ã€‚</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="æ‰«æVisit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-03-29T05:39:03.676Z" itemprop="dateUpdated">2022-03-29 13:39:03</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Docker/5.Dockeråº•å±‚å®ç°åŸç†äº†è§£.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Docker/5.Dockeråº•å±‚å®ç°åŸç†äº†è§£.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2019/6-3-459.html" target="_blank" rel="external">https://blog.weiyigeek.top/2019/6-3-459.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">ğŸ‘ é’Ÿæ„ä½œè€…</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/6-3-459.html&title=ã€Š5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/6-3-459.html&title=ã€Š5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/6-3-459.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/6-3-459.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/6-3-459.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2019/6-3-463.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">n3.Dockerä¹‹Win10å’ŒServerä½¿ç”¨å®ä¾‹</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/6-3-76.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">VNCè¿œç¨‹è¿æ¥æœåŠ¡å®‰è£…ä¸é…ç½®</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-Dockeræ¶æ„ä¸åº•å±‚å®ç°åŸç†æµ…æ"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 Dockeræ¶æ„ä¸åº•å±‚å®ç°åŸç†æµ…æ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-åŸºæœ¬æ¶æ„"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.åŸºæœ¬æ¶æ„</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-I-Oè®¾å¤‡ç®€è¿°"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.I&#x2F;Oè®¾å¤‡ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-åº•å±‚åŸç†æµ…æ"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.åº•å±‚åŸç†æµ…æ</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¿˜è¯·æ”¯æŒä¸€ä¸‹åšä¸»å“Ÿ, è°¢è°¢å„ä½çœ‹å‹â™¥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½æœ‹å‹,å¯ä»¥å…³ä¸ªæ³¨å—? â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">ä¸ªäººGithub</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">ä¸ªäººGitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">ä¸ªäººçŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘+äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/6-3-459.html&title=ã€Š5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/6-3-459.html&title=ã€Š5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/6-3-459.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š5.Dockeråº•å±‚å®ç°åŸç†äº†è§£ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/6-3-459.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/6-3-459.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMElEQVR42u3aQXLEMAhE0bn/pZ2qbB3hbpCmYvhapTKOrDcLAoLPR17X71r9/r5Wf3V/Rv90w4IBA8ZrGVe4Vs/cD6qTVjx9zz+oMGDAGMCIg6wbUuOvSTm6fjYYMGDAiJ+JU7ocEgYMGDDqjIcUTS5Hc0kkDBgwJjNyJageavVAfLwWhwEDxgsZbmPgmz8f7G/AgAHjJYzLXPUg6LY5pVPBgAGjNcO99M+lkidCv5ThwoABowVDCZq5kYs4vLoXdg+XbjBgwBjD0IvYXIKYe5c0oAYDBowBDD28SuHPbD3Ggd4oX2HAgDGAoTQm3SZlPfkzilgYMGA0ZSjbVS7u9YTPLZiNxgAMGDDaMewwl2ow6C0EpaCFAQNGb4ZSUrqDEfpQhcuwr9tgwIDRgpGrAfUkcldjwAjWMGDAaMrIFaXuayqDGlI7AQYMGE0Z7jiXGyKVQ1fGL2DAgDGBoWznBsc4iLs7G81OGDBgNGXoG+VGLhTkhjEOGDBgtGa4ZaTeANBHvty3L8EwYMBoynAHwnIp44ZgGu8GAwaMYQy3VekG1vrQ2DLDhQEDRlPGrqs3vXDdVQzDgAFjDuMyl5vA6X/rPiOlhjBgwGjB0Jd+OD0EH+zKwoABox0j1wCotAEqQXmJhAEDxgBGpWR1v47KfwAYMGDA0NPBSgPS/RQGDBgwcoxkAldgPKShMGDAGMDIFbH1hE9PHw9et8GAAePfMyqlo95WzL0414SAAQNGI8YP14Id80wXz6EAAAAASUVORK5CYII=" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
