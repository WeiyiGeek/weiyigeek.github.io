<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Prometheus">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-04-28T11:39:47.000Z" itemprop="datePublished" class="page-time">
  2021-04-28
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/">monitor</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/">kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/OperationTools/">OperationTools</a></li></ul></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Prometheus/7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-04-28 19:39:47" datetime="2021-04-28T11:39:47.000Z"  itemprop="datePublished">2021-04-28</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/">monitor</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/">kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/OperationTools/">OperationTools</a></li></ul></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-æµ‹æ§ä¸å®¢æˆ·ç«¯"><a href="#0x00-æµ‹æ§ä¸å®¢æˆ·ç«¯" class="headerlink" title="0x00 æµ‹æ§ä¸å®¢æˆ·ç«¯"></a>0x00 æµ‹æ§ä¸å®¢æˆ·ç«¯</h2><h3 id="1-å‰è¨€ç®€è¿°"><a href="#1-å‰è¨€ç®€è¿°" class="headerlink" title="1.å‰è¨€ç®€è¿°"></a>1.å‰è¨€ç®€è¿°</h3><p>æè¿°: Prometheus å¯ä»¥é€šè¿‡ç›´æ¥<code>æµ‹æ§æˆ–è€…å®¢æˆ·ç«¯åº“</code>æ¥æµ‹æ§ä¸šåŠ¡æˆ–è€…åº”ç”¨ï¼Œç›®å‰æˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¤šç§ä¸åŒè¯­è¨€ç¼–å†™å®¢æˆ·ç«¯åº“åŒ…æ‹¬<code>(GO/Python/Java/Ruby)</code>ç­‰å®¢æˆ·ç«¯ï¼›</p>
<p>Tips : åº”ç”¨ç¨‹åºç›‘æ§æŒ‡æ ‡çš„æœ€é‡è¦çš„ä¸‰ä¸ªéƒ¨åˆ†æ˜¯å¯¼å…¥æ¨¡å—ã€æŒ‡æ ‡æŒ‡å®šä»¥åŠæµ‹æ§å¯¹è±¡ã€‚</p>
<p>Tips : æŒ‡æ ‡çš„åç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä¸€èˆ¬çš„ä¸ºé¿å…æ­¤ç§æƒ…å†µåœ¨æ–‡ä»¶çº§åˆ«å®šä¹‰ä½ çš„æŒ‡æ ‡ï¼Œè€Œä¸æ˜¯åœ¨ç±»ã€å‡½æ•°æˆ–è€…æ–¹æ³•çº§åˆ«ã€‚</p>
<p><br></p>
<h3 id="2-ç¯å¢ƒå‡†å¤‡"><a href="#2-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.ç¯å¢ƒå‡†å¤‡"></a>2.ç¯å¢ƒå‡†å¤‡</h3><p>æè¿°: åœ¨ Python 3 å®‰è£…å’Œä½¿ç”¨Prometheuså®¢æˆ·ç«¯åº“ä»¥åŠFlaskæ¨¡å—, åœ¨åé¢çš„æ¼”ç¤ºä¸­æ³¨æ„é‡‡ç”¨Pythonè¿›è¡Œå®ç°ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install prometheus_client</span><br><span class="line">pip install flask</span><br></pre></td></tr></table></figure></p>
<p>Tips : åœ¨åŸºç¡€å¾—æ¼”ç¤ºé˜¶æ®µæˆ‘å¯ä»¥ä½¿ç”¨Python3è‡ªå¸¦çš„<code>http.server</code>æ¨¡å—å¯åŠ¨ä¸€ä¸ªç®€æ˜“Webå®¹å™¨ã€‚</p>
<p><br></p>
<h3 id="3-å¿«é€Ÿå…¥é—¨"><a href="#3-å¿«é€Ÿå…¥é—¨" class="headerlink" title="3.å¿«é€Ÿå…¥é—¨"></a>3.å¿«é€Ÿå…¥é—¨</h3><h4 id="3-1-Python-å±•ç¤ºPrometheusæŒ‡æ ‡"><a href="#3-1-Python-å±•ç¤ºPrometheusæŒ‡æ ‡" class="headerlink" title="3.1 Python å±•ç¤ºPrometheusæŒ‡æ ‡"></a>3.1 Python å±•ç¤ºPrometheusæŒ‡æ ‡</h4><p>æè¿°: åºŸè¯ä¸å¤šè¯´ä¸Šä»£ç </p>
<p><strong>æ–¹å¼1.python</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author:WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: Hello World å®ä¾‹é‡‡ç”¨Pythonæš´éœ²Prometheus</span></span><br><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> start_http_server</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(http.server.BaseHTTPRequestHandler)</span>:</span> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.send_response(<span class="number">200</span>,<span class="string">'ok'</span>)</span><br><span class="line">    self.end_headers()</span><br><span class="line">    self.wfile.write(<span class="string">b"Hello World! - Python Promethus_Client!"</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  print(<span class="string">"Hello World, Start Prometheus Client Server!"</span>)</span><br><span class="line">  start_http_server(<span class="number">8000</span>)</span><br><span class="line">  server = http.server.HTTPServer((<span class="string">'0.0.0.0'</span>,<span class="number">8001</span>),Hello)</span><br><span class="line">  server.serve_forever()</span><br></pre></td></tr></table></figure></p>
<p><strong>æ‰§è¡Œç»“æœ:</strong> æµ‹è¯•è®¿é—®:<code>127.0.0.1:8001</code>URLå¯ä»¥çœ‹åˆ°<code>Hello World! - Python Promethus_Client</code>è¾“å‡º,è®¿é—®<code>http://127.0.0.1:8000/metrics</code>æŸ¥çœ‹é»˜è®¤çš„æŒ‡æ ‡<br><figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210609223137.png" target="_blank" title="WeiyiGeek.HelloWorld" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210609223137.png" alt="WeiyiGeek.HelloWorld" title="" class=""></a>
                <p>WeiyiGeek.HelloWorld</p>
            </figure></p>
<p><br></p>
<p><strong>æ–¹å¼2.Python WSGI</strong><br>æè¿°: <code>Web Server Gateway Interface</code>(WSGI)æ˜¯ä¸€ä¸ªæ ‡å‡†çš„Pythonçš„Webåº”ç”¨,åœ¨Pythonå®¢æˆ·ç«¯æä¾›äº†ä¸€ä¸ªWSGIåº”ç”¨,é€šè¿‡é“¾æ¥WSGIåº”ç”¨ä½ å¯ä»¥æ·»åŠ èº«ä»½éªŒè¯ç­‰ä¸­é—´ä»¶ã€‚</p>
<p>æè¿°: åœ¨Python WSGI ä¸­é…ç½®æ¼”ç¤ºå³ä¸ç”¨å¼€å¯ä¸¤ä¸ªç«¯å£æœåŠ¡æ¥é…åˆprometheusæ•°æ®æ‹‰å–å’Œæ•°æ®ç”Ÿæˆã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author:WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: Hello World å®ä¾‹é‡‡ç”¨ prometheus_client WSGI æš´éœ²Prometheus</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> make_wsgi_app</span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"></span><br><span class="line">metrics_app = make_wsgi_app()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">HelloWSGI</span><span class="params">(environ, start_fn)</span>:</span></span><br><span class="line">  <span class="comment"># æ³¨æ„æ­¤/metricså¯ä»¥è‡ªå®šä¹‰æ§åˆ¶</span></span><br><span class="line">  <span class="keyword">if</span> environ[<span class="string">'PATH_INFO'</span>] == <span class="string">'/metrics'</span>:</span><br><span class="line">    <span class="keyword">return</span> metrics_app(environ, start_fn)</span><br><span class="line"></span><br><span class="line">  start_fn(<span class="string">'200 OK'</span>, [])</span><br><span class="line">  <span class="keyword">return</span> [<span class="string">b'Hello World! - Python Promethus_Client WSGI!'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  print(<span class="string">"Hello World!, Start Prometheus Client Server!"</span>)</span><br><span class="line">  httpd = make_server(<span class="string">'0.0.0.0'</span>, <span class="number">8000</span>, HelloWSGI)</span><br><span class="line">  httpd.serve_forever()</span><br></pre></td></tr></table></figure></p>
<p>æ•ˆæœç¤ºä¾‹:<br><figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610165953.png" target="_blank" title="WeiyiGeek.prometheus_client-WSGI" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610165953.png" alt="WeiyiGeek.prometheus_client-WSGI" title="" class=""></a>
                <p>WeiyiGeek.prometheus_client-WSGI</p>
            </figure></p>
<p><br></p>
<h4 id="3-2-Prometheus-å››ç§æ•°æ®ç±»å‹æµ‹æ§æ¼”ç¤º"><a href="#3-2-Prometheus-å››ç§æ•°æ®ç±»å‹æµ‹æ§æ¼”ç¤º" class="headerlink" title="3.2 Prometheus å››ç§æ•°æ®ç±»å‹æµ‹æ§æ¼”ç¤º"></a>3.2 Prometheus å››ç§æ•°æ®ç±»å‹æµ‹æ§æ¼”ç¤º</h4><p><strong>Counter æ•°æ®ç±»å‹</strong><br>æè¿°: è¯¥æ•°æ®ç±»å‹åœ¨æµ‹æ§ä¸­æ˜¯ä½¿ç”¨æœ€é¢‘ç¹çš„æ•°æ®ç±»å‹ï¼Œå…¶ç”¨äºè®°å½•äº‹ä»¶çš„æ•°é‡æˆ–è€…å¤§å°ï¼Œå¹¶é€šå¸¸ç”¨æ¥è·Ÿè¸ªæŸä¸ªç‰¹å®šä»£ç è·¯å¾„è¢«æ‰§è¡Œé¢‘ç‡å’Œè®°å½•æ•°ã€æœåŠ¡çš„å­—èŠ‚æ•°ä»¥åŠã€‚</p>
<p>no code,no bi bi;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: æ¼”ç¤ºåœ¨æµ‹æ§ä¸­ä½¿ç”¨ Counter æ•°æ®ç±»å‹è®°å½•æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> start_http_server,Counter</span><br><span class="line"></span><br><span class="line"><span class="comment"># REQUESTS è®°å½•è¯·æ±‚ / è¿”å›çš„æ¬¡æ•°(æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ³¨é‡Š)</span></span><br><span class="line">REQUESTS = Counter(<span class="string">'http_server_total'</span>, <span class="string">'http server requested frequency count.'</span>)</span><br><span class="line"><span class="comment"># EXCEPTIONS ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¯¹å¼‚å¸¸æƒ…å†µè¿›è¡Œæ¬¡æ•°</span></span><br><span class="line">EXCEPTION = Counter(<span class="string">'http_server_execption_total'</span>, <span class="string">'http server requested execption frequency count.'</span>)</span><br><span class="line">EXCEPTIONS = Counter(<span class="string">'http_server_execptions_total'</span>, <span class="string">'http server requested execptions frequency count.'</span>)</span><br><span class="line"><span class="comment"># MONEYS ç»Ÿè®¡ä»¥æ¬§å…ƒç»“ç®—çš„é”€å”®é¢</span></span><br><span class="line">MONEYS = Counter(<span class="string">'http_server_euro_moneys_total'</span>,<span class="string">'Euros made serving Http Server.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(http.server.BaseHTTPRequestHandler)</span>:</span> </span><br><span class="line">  <span class="comment"># ä½œä¸ºå‡½æ•°çš„è£…é¥°å™¨</span></span><br><span class="line"><span class="meta">  @EXCEPTIONS.count_exceptions()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># è®°å½•æ¯è¯·æ±‚ä¸€æ¬¡ä¾¿ä¼š+1</span></span><br><span class="line">    REQUESTS.inc()</span><br><span class="line">    <span class="comment"># æ¨¡å—ä¸­è‡ªå¸¦å¼‚å¸¸è®¡æ•°åŠŸèƒ½, å®ƒä¸ä¼šå¹²æ‰°åº”ç”¨ç¨‹åºçš„é€»è¾‘(å»ºè®®é‡‡ç”¨ä¿®é¥°å™¨çš„æ–¹å¼)</span></span><br><span class="line">    <span class="comment"># with EXCEPTIONS.count_exceptions():</span></span><br><span class="line">    <span class="comment">#   if random.randint(0,10) &lt; 1:</span></span><br><span class="line">    <span class="comment">#     raise Exception</span></span><br><span class="line">    <span class="comment"># ä»¥æ¬§å…ƒç»“ç®—çš„é”€å”®é¢</span></span><br><span class="line">    euros = random.randint(<span class="number">999</span>,<span class="number">9999</span>)</span><br><span class="line">    MONEYS.inc(euros)</span><br><span class="line">    self.send_response(<span class="number">200</span>)</span><br><span class="line">    self.end_headers()</span><br><span class="line">    self.wfile.write(<span class="string">"Hello World! Prometheus Counter Example for &#123;&#125; euros."</span>.format(euros).encode())</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  print(<span class="string">"Hello World, Start Prometheus Client /metrics Server Port 8000!"</span>)</span><br><span class="line">  start_http_server(<span class="number">8000</span>)</span><br><span class="line">  server = http.server.HTTPServer((<span class="string">'0.0.0.0'</span>,<span class="number">8001</span>),Hello)</span><br><span class="line">  server.serve_forever()</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>æ‰§è¡Œç»“æœ:</strong> è®¿é—®<code>http://127.0.0.1:8000/metrics</code>æŸ¥çœ‹ä¸Šè¿°å®šä¹‰å’Œç›‘æ§çš„æŒ‡æ ‡ã€‚<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP http_server_total http server requested frequency count.</span></span><br><span class="line"><span class="comment"># TYPE http_server_total counter</span></span><br><span class="line">http_server_total <span class="number">23.0</span></span><br><span class="line"><span class="comment"># HELP http_server_created http server requested frequency count.</span></span><br><span class="line"><span class="comment"># TYPE http_server_created gauge</span></span><br><span class="line">http_server_created <span class="number">1.6232518107397504</span>e+<span class="number">09</span></span><br><span class="line"><span class="comment"># HELP http_server_execption_total http server requested execption frequency count.</span></span><br><span class="line"><span class="comment"># TYPE http_server_execption_total counter</span></span><br><span class="line">http_server_execption_total <span class="number">0.0</span></span><br><span class="line"><span class="comment"># HELP http_server_execption_created http server requested execption frequency count.</span></span><br><span class="line"><span class="comment"># TYPE http_server_execption_created gauge</span></span><br><span class="line">http_server_execption_created <span class="number">1.6232518107397504</span>e+<span class="number">09</span></span><br><span class="line"><span class="comment"># HELP http_server_execptions_total http server requested execptions frequency count.</span></span><br><span class="line"><span class="comment"># TYPE http_server_execptions_total counter</span></span><br><span class="line">http_server_execptions_total <span class="number">4.0</span></span><br><span class="line"><span class="comment"># HELP http_server_execptions_created http server requested execptions frequency count.</span></span><br><span class="line"><span class="comment"># TYPE http_server_execptions_created gauge</span></span><br><span class="line">http_server_execptions_created <span class="number">1.6232518107397504</span>e+<span class="number">09</span></span><br><span class="line"><span class="comment"># HELP http_server_euro_moneys_total Euros made serving Http Server.</span></span><br><span class="line"><span class="comment"># TYPE http_server_euro_moneys_total counter</span></span><br><span class="line">http_server_euro_moneys_total <span class="number">90706.0</span></span><br><span class="line"><span class="comment"># HELP http_server_euro_moneys_created Euros made serving Http Server.</span></span><br><span class="line"><span class="comment"># TYPE http_server_euro_moneys_created gauge</span></span><br><span class="line">http_server_euro_moneys_created <span class="number">1.6232518107397504</span>e+<span class="number">09</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : æˆ‘ä»¬é‡‡ç”¨<code>Prometheus</code>è¿›è¡Œç›‘æ§æˆ‘ä»¬åˆ›å»ºçš„æµ‹æ§åº”ç”¨;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">- job_name: control</span><br><span class="line">  honor_timestamps: <span class="literal">true</span></span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  scrape_timeout: 10s</span><br><span class="line">  metrics_path: /metrics</span><br><span class="line">  scheme: http</span><br><span class="line">  follow_redirects: <span class="literal">true</span></span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 100.201.12.103:8000</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610105511.png" target="_blank" title="WeiyiGeek.Counter" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610105511.png" alt="WeiyiGeek.Counter" title="" class=""></a>
                <p>WeiyiGeek.Counter</p>
            </figure>
<p><br></p>
<p><strong>Gauge æ•°æ®ç±»å‹</strong><br>æè¿°: å®ƒå­˜æ”¾çš„æ˜¯ä¸€äº›å½“å‰çŠ¶æ€çš„å¿«ç…§å…¶å€¼æ˜¯å¯ä»¥åŠ¨æ€æ”¹å˜çš„å› æ­¤å¯ä»¥å°†è´Ÿæ•°ä¼ ç»™è¯¥ç±»å‹çš„incæ–¹æ³•, ä¾‹å¦‚å¸¸ç”¨äºé˜Ÿåˆ—ä¸­å…ƒç´ çš„ä¸ªæ•°ã€å†…å­˜ä»¥åŠç£ç›˜çš„ä½¿ç”¨ç‡ã€æ´»è·ƒçš„çº¿ç¨‹æ•°æˆ–è€…å›è°ƒæŒ‡å®šçš„å…¶å®ƒå‡½æ•°ã€‚</p>
<p>æ¼”ç¤ºä»£ç :<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: æ¼”ç¤ºåœ¨æµ‹æ§ä¸­ä½¿ç”¨ Counter æ•°æ®ç±»å‹è®°å½•æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Gauge, start_http_server</span><br><span class="line"></span><br><span class="line"><span class="comment"># INPROGRESS / LAST è·Ÿè¸ªæ­£åœ¨å¤„ç†ä¸­çš„è¯·æ±‚è°ƒç”¨æ•°ç›®ä»¥åŠæœ€åä¸€ä¸ªè°ƒç”¨å®Œæˆæ—¶é—´.</span></span><br><span class="line">INPROGRESS = Gauge(<span class="string">'app_inprogress'</span>, <span class="string">'number of http server in progress'</span>)</span><br><span class="line">LAST = Gauge(<span class="string">'app_last_seconds'</span>, <span class="string">'The last time a app was Served'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># INPROGRESS_Modify æ­¤ç§æ–¹å¼ä¹Ÿå¯è·Ÿè¸ªæ­£åœ¨å¤„ç†ä¸­çš„è¯·æ±‚å…¶è°ƒç”¨å®Œæˆæ—¶é—´.</span></span><br><span class="line">INPROGRESSMODIFY = Gauge(<span class="string">'app_inprogress_modify'</span>, <span class="string">'number of http server in progress modify'</span>)</span><br><span class="line">LASTTIME = Gauge(<span class="string">'app_last_time_seconds'</span>, <span class="string">'The last time a app was Served'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TIME å›è°ƒå‡½æ•°ä½¿ç”¨, ä¾‹å¦‚ç”¨æ¥è¿”å›å½“å‰æ—¶é—´å¸¦æœ‰`set_functiuon()`ç®€å•ç¤ºä¾‹</span></span><br><span class="line">TIME = Gauge(<span class="string">'current_time_seconds'</span>,<span class="string">'The Current Time'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(http.server.BaseHTTPRequestHandler)</span>:</span> </span><br><span class="line"><span class="meta">  @INPROGRESSMODIFY.track_inprogress()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">    INPROGRESS.inc(<span class="number">3</span>)  <span class="comment"># +3</span></span><br><span class="line">    self.send_response(<span class="number">200</span>)</span><br><span class="line">    self.end_headers()</span><br><span class="line">    self.wfile.write(<span class="string">b"Hello World! Prometheus Gauge Type Example"</span>)</span><br><span class="line">    LAST.set(time.time())</span><br><span class="line">    LASTTIME.set_to_current_time()</span><br><span class="line">    <span class="comment"># æ¯æ¬¡éƒ½ä¼šè¿›è¡Œå˜åŒ–</span></span><br><span class="line">    TIME.set_function(<span class="keyword">lambda</span>: time.time())</span><br><span class="line">    INPROGRESS.dec()  <span class="comment"># -1</span></span><br><span class="line">    print(<span class="string">"End Time: &#123;&#125;"</span>.format(time.asctime(time.localtime(time.time()))))</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  print(<span class="string">"Hello World, Start Prometheus Client /metrics Server!\nServer: 127.0.0.1:8000/metrics "</span>)</span><br><span class="line">  start_http_server(<span class="number">8000</span>)</span><br><span class="line">  server = http.server.HTTPServer((<span class="string">'0.0.0.0'</span>,<span class="number">8001</span>),Hello)</span><br><span class="line">  server.serve_forever()</span><br></pre></td></tr></table></figure><br>ç»“æœæ¼”ç¤º: <a href="http://127.0.0.1:8000/metrics" target="_blank" rel="noopener">http://127.0.0.1:8000/metrics</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP app_inprogress number of http server in progress</span></span><br><span class="line"><span class="comment"># TYPE app_inprogress gauge</span></span><br><span class="line">app_inprogress 2.0    <span class="comment"># æ¯æ¬¡è®¿é—® (+3-1)</span></span><br><span class="line"><span class="comment"># HELP app_last_seconds The last time a app was Served</span></span><br><span class="line"><span class="comment"># TYPE app_last_seconds gauge</span></span><br><span class="line">app_last_seconds 1.6233011413151145e+09</span><br><span class="line"><span class="comment"># HELP app_inprogress_modify number of http server in progress modify</span></span><br><span class="line"><span class="comment"># TYPE app_inprogress_modify gauge</span></span><br><span class="line">app_inprogress_modify 0.0</span><br><span class="line"><span class="comment"># HELP app_last_time_seconds The last time a app was Served</span></span><br><span class="line"><span class="comment"># TYPE app_last_time_seconds gauge</span></span><br><span class="line">app_last_time_seconds 1.6233011413151145e+09</span><br><span class="line"><span class="comment"># HELP current_time_seconds The Current Time</span></span><br><span class="line"><span class="comment"># TYPE current_time_seconds gauge</span></span><br><span class="line">current_time_seconds 1.6233011425841126e+09</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>Summary æ•°æ®ç±»å‹</strong><br>æè¿°: è¯¥æ•°æ®ç±»å‹ä¸»è¦é’ˆå¯¹äºç³»ç»Ÿæ€§èƒ½çš„ç›‘æµ‹(å¹³å‡å»¶è¿Ÿæ•°æ®)ï¼Œä¾‹å¦‚é™¤äº†åç«¯çš„å»¶æ—¶ä½ å¯èƒ½ä¹Ÿå¸Œæœ›è·Ÿè¸ªæ”¶åˆ°çš„åç«¯å“åº”ä½“çš„å¤§å°ï¼ŒæŒ‡æ ‡åç§°å³<code>æŒ‡æ ‡_count ä¸ æŒ‡æ ‡_sum</code>åˆ†åˆ«ä»£è¡¨è°ƒç”¨æ•°é‡å’Œæµ‹æ§å€¼å¾—æ€»å’Œã€‚</p>
<p>ä»£ç æ¼”ç¤º:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: æ¼”ç¤ºåœ¨æµ‹æ§ä¸­ä½¿ç”¨ Summary æ•°æ®ç±»å‹è®°å½•æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Summary,start_http_server</span><br><span class="line"></span><br><span class="line"><span class="comment"># LATENCY è·Ÿè¸ªappç¨‹åºçš„è€—æ—¶ã€‚</span></span><br><span class="line">LATENCY = Summary(<span class="string">'app_latency_seconds'</span>,<span class="string">'app ç¨‹åºè€—æ—¶ç»Ÿè®¡å•ä½ç§’'</span>)</span><br><span class="line"><span class="comment"># LATENCYMODIFY é‡‡ç”¨ä¿®é¥°å™¨æ¥è·Ÿè¸ªappç¨‹åºçš„è€—æ—¶ã€‚</span></span><br><span class="line">LATENCYMODIFY = Summary(<span class="string">'app_latencymodify_seconds'</span>,<span class="string">'é‡‡ç”¨ä¿®é¥°å™¨æ¥éªŒè¯ app ç¨‹åºè€—æ—¶ç»Ÿè®¡å•ä½ç§’'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(http.server.BaseHTTPRequestHandler)</span>:</span></span><br><span class="line"><span class="meta">  @LATENCYMODIFY.time()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># ç¨‹åºèµ·å§‹æ—¶é—´</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    self.send_response(<span class="number">200</span>)</span><br><span class="line">    self.end_headers()</span><br><span class="line">    self.wfile.write(<span class="string">b"Hello World! Prometheus Summary Example!"</span>)</span><br><span class="line">    LATENCY.observe(time.time() - start)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  print(<span class="string">"Hello World, Start Prometheus Client /metrics Server!\nServer: 127.0.0.1:8000/metrics"</span>)</span><br><span class="line">  start_http_server(<span class="number">8000</span>)</span><br><span class="line">  server = http.server.HTTPServer((<span class="string">'0.0.0.0'</span>,<span class="number">8001</span>),Hello)</span><br><span class="line">  server.serve_forever()</span><br></pre></td></tr></table></figure></p>
<p>ç»“æœè¯´æ˜: é»˜è®¤æ˜¯æŒ‡æ ‡ =&gt; <code>æŒ‡æ ‡åç§°_count ä¸ æŒ‡æ ‡åç§°_sum</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP app_latency_seconds app ç¨‹åºè€—æ—¶ç»Ÿè®¡å•ä½ç§’</span></span><br><span class="line"><span class="comment"># TYPE app_latency_seconds summary</span></span><br><span class="line">app_latency_seconds_count 15.0                <span class="comment"># app é¡µé¢è¯·æ±‚çš„æ¬¡æ•°</span></span><br><span class="line">app_latency_seconds_sum 0.005997180938720703  <span class="comment"># æ¯æ¬¡ app é¡µé¢ç”Ÿæˆåˆ°å±•ç¤ºçš„æ—¶é—´ä¹‹å’Œ</span></span><br><span class="line"><span class="comment"># HELP app_latency_seconds_created app ç¨‹åºè€—æ—¶ç»Ÿè®¡å•ä½ç§’</span></span><br><span class="line"><span class="comment"># TYPE app_latency_seconds_created gauge</span></span><br><span class="line">app_latency_seconds_created 1.6233078021234589e+09</span><br><span class="line"><span class="comment"># HELP app_latencymodify_seconds é‡‡ç”¨ä¿®é¥°å™¨æ¥éªŒè¯ app ç¨‹åºè€—æ—¶ç»Ÿè®¡å•ä½ç§’</span></span><br><span class="line"><span class="comment"># TYPE app_latencymodify_seconds summary</span></span><br><span class="line">app_latencymodify_seconds_count 15.0</span><br><span class="line">app_latencymodify_seconds_sum 0.006268700000005012</span><br><span class="line"><span class="comment"># HELP app_latencymodify_seconds_created é‡‡ç”¨ä¿®é¥°å™¨æ¥éªŒè¯ app ç¨‹åºè€—æ—¶ç»Ÿè®¡å•ä½ç§’</span></span><br><span class="line"><span class="comment"># TYPE app_latencymodify_seconds_created gauge</span></span><br><span class="line">app_latencymodify_seconds_created 1.6233078021234589e+09</span><br></pre></td></tr></table></figure></p>
<p>Tips ï¼šåœ¨<code>Prometheus</code>ä¸­è·å¾—æœ€åä¸€åˆ†é’Ÿçš„å¹³å‡å»¶æ—¶,PromQLæŸ¥è¯¢è¯­å¥<code>rate(app_latency_seconds_sum{job=&quot;control&quot;}[1m])  / rate (app_latency_seconds_count{job=&quot;control&quot;}[1m])</code>ã€‚</p>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610150812.png" target="_blank" title="WeiyiGeek.app_latency_seconds_sum" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610150812.png" alt="WeiyiGeek.app_latency_seconds_sum" title="" class=""></a>
                <p>WeiyiGeek.app_latency_seconds_sum</p>
            </figure>
<p><br></p>
<p><strong>Histogram æ•°æ®ç±»å‹</strong><br>æè¿°: è¯¥ç±»å‹ä¸»è¦æ˜¯ç”¨äºå‘Šè¯‰ä½ ä½äºæŸä¸€ä¸ªå€¼å¾—äº‹ä»¶ä¸ªæ•°(<code>åˆ†ä½æ•°</code>), ä¾‹å¦‚0.95åˆ†ä½æ•°ä¸º300msä»£è¡¨95%å¾—è¯·æ±‚è€—æ—¶å°äº300msã€‚<br>Histogram æ•°æ®ç±»å‹æŒ‡æ ‡æ˜¯ç”±<code>_count,_sum,_bukect</code>ç»„æˆã€‚</p>
<p>å…³é”®è¯´æ˜ï¼šæ¡¶(Bucket)å®ƒæ˜¯ä¸€ä¸ªcounteræ•°æ®ç±»å‹çš„æ—¶åºé›†åˆ(å¿…é¡»æœ‰åº),ä½†æ˜¯æ¡¶çš„æ•°é‡å½±å“ç€æ€§èƒ½æˆ‘ä»¬å¯ä»¥é‡‡ç”¨Prometheusä¸­metric_relable_configsæ¥ä¸¢å¼ƒä¸€äº›æ— å…³çš„æ¡¶ã€‚ä¾‹å¦‚ä¸€ç»„æ¡¶<code>(1ms, 10ms, 25ms)</code>ç”¨æ¥è·Ÿè¸ªè½å…¥æ¯ä¸ªæ¡¶ä¸­çš„äº‹ä»¶ä¸ªæ•°ã€‚</p>
<p>ä»£ç æ¼”ç¤º:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: æ¼”ç¤ºåœ¨æµ‹æ§ä¸­ä½¿ç”¨ Histogram æ•°æ®ç±»å‹è®°å½•æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Histogram,start_http_server</span><br><span class="line"></span><br><span class="line"><span class="comment"># LATENCYTIME ä½¿ç”¨æ—¶é—´å‡½æ•°æ¥è·Ÿè¸ªå»¶æ—¶(Histogram)</span></span><br><span class="line">LATENCYTIME = Histogram(<span class="string">'app_latency_time_seconds'</span>,<span class="string">'app ç¨‹åºè®¿é—®å»¶è¿Ÿæ—¶é—´ç»Ÿè®¡'</span>,buckets=[<span class="number">0.0001</span> * (<span class="number">2</span>**x) <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>)])</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(http.server.BaseHTTPRequestHandler)</span>:</span></span><br><span class="line"><span class="meta">  @LATENCYTIME.time()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.send_response(<span class="number">200</span>)</span><br><span class="line">    self.end_headers()</span><br><span class="line">    self.wfile.write(<span class="string">b"Hello World! Prometheus Histogram Example!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  print(<span class="string">"Hello World, Start Prometheus Client /metrics Server!\nServer: 127.0.0.1:8000/metrics"</span>)</span><br><span class="line">  start_http_server(<span class="number">8000</span>)</span><br><span class="line">  server = http.server.HTTPServer((<span class="string">'0.0.0.0'</span>,<span class="number">8001</span>),Hello)</span><br><span class="line">  server.serve_forever()</span><br></pre></td></tr></table></figure></p>
<p>ç»“æœè¯´æ˜:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP app_latency_time_seconds app ç¨‹åºè®¿é—®å»¶è¿Ÿæ—¶é—´ç»Ÿè®¡</span></span><br><span class="line"><span class="comment"># TYPE app_latency_time_seconds histogram</span></span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0002"</span>&#125; 0.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0004"</span>&#125; 31.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0008"</span>&#125; 51.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0016"</span>&#125; 56.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0032"</span>&#125; 57.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0064"</span>&#125; 57.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0128"</span>&#125; 57.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0256"</span>&#125; 57.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0512"</span>&#125; 57.0</span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"+Inf"</span>&#125; 57.0</span><br><span class="line">app_latency_time_seconds_count 57.0</span><br><span class="line">app_latency_time_seconds_sum 0.027456399999900682</span><br><span class="line"><span class="comment"># HELP app_latency_time_seconds_created app ç¨‹åºè®¿é—®å»¶è¿Ÿæ—¶é—´ç»Ÿè®¡</span></span><br><span class="line"><span class="comment"># TYPE app_latency_time_seconds_created gauge</span></span><br><span class="line">app_latency_time_seconds_created 1.6233113814601374e+09</span><br></pre></td></tr></table></figure></p>
<p>Tips : åˆ†ä½æ•°ä¸ç™¾åˆ†ä½çš„é€‰æ‹©æˆ‘ä»¬çŸ¥é“95%æ˜¯0.95åˆ†ä½æ•°,ç”±äºæ›´å–œæ¬¢åŸºæœ¬å•ä½æ‰€æœ‰Prometheusé»˜è®¤é€‰æ‹©åˆ†ä½æ•°è¿›è¡Œå±•ç¤º,è€Œåœ¨Grafanaä¸­è¡¨ç¤ºæ¯”ä¾‹æ—¶å¸¸å¸¸ä½¿ç”¨ç™¾åˆ†ä½ã€‚<br>Tips : æ³¨æ„å¦‚æœæ˜¯ Histogram æ•°æ®ç±»å‹å…¶å¿…é¡»æ˜¯æœ‰æ ‡ç­¾çš„,å¹¶ä¸” +Inf åˆ†æ¡¶æ˜¯å¿…éœ€çš„ä¸åº”è¯¥ä¸¢å¼ƒ,ã€‚<br>Tips : æˆ‘ä»¬å¯ä»¥é‡‡ç”¨PromQLä¸­çš„å‡½æ•°æ¿€ç´ é‚£æ¡¶ä¸­çš„åˆ†ä½æ•°ï¼Œä¾‹å¦‚0.95åˆ†ä½æ•°(ç¬¬95ä¸ªç™¾åˆ†ä½æ•°)å…¶è¡¨è¾¾å¼å¦‚ä¸‹<code>histogram_quantile(0.95, rate(app_latency_time_seconds_bucket[1m]))</code>;<br>Tips : æœåŠ¡ç­‰çº§åè®®(Service-Level Agreements,SLA) æ˜¾å¼æŒ‡å®šä¸€ä¸ªç”¨æ¥è®°å½•å»¶è¿Ÿçš„æ¡¶ï¼Œä¾‹å¦‚åœ¨ histogram ä¸­æœ‰ä¸€ä¸ª0.0016sçš„æ¡¶,å¯é€šè¿‡ä»¥ä¸‹å‡†ç¡®çš„è®¡ç®—å‡ºè€—æ—¶è¶…è¿‡0.0016sçš„è¯·æ±‚ä»è€Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°SLAè¦æ±‚ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app_latency_time_seconds_bucket&#123;le="0.0016"&#125; 56.0</span></span><br><span class="line"><span class="comment"># app_latency_time_seconds_bucket&#123;le="+Inf"&#125; 57.0</span></span><br><span class="line">app_latency_time_seconds_bucket&#123;le=<span class="string">"0.0016"</span>&#125; / ignoring(le) app_latency_time_seconds_bucket&#123;le=<span class="string">"+Inf"</span>&#125;   </span><br><span class="line">&#123;instance=<span class="string">"10.20.172.103:8000"</span>, job=<span class="string">"control"</span>&#125;	0.9824561403508771  <span class="comment"># =&gt; 56 / 57</span></span><br></pre></td></tr></table></figure><br>Tips : åŒæ ·æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸‹é¢çš„è¡¨è¾¾å¼å…¬å¼è¿›è¡Œè®¡ç®—æœ€å30åˆ†é’Ÿçš„å»¶è¿Ÿ<code>rate(app_latency_time_seconds_sum{job=&quot;control&quot;}[30m]) / rate (app_latency_time_seconds_count{job=&quot;control&quot;}[30m])</code></p>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610161127.png" target="_blank" title="WeiyiGeek.histogram_quantile" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210610161127.png" alt="WeiyiGeek.histogram_quantile" title="" class=""></a>
                <p>WeiyiGeek.histogram_quantile</p>
            </figure>
<p><br></p>
<h4 id="3-3-Python-Prometheus-åº“å®è·µ"><a href="#3-3-Python-Prometheus-åº“å®è·µ" class="headerlink" title="3.3 Python Prometheus åº“å®è·µ"></a>3.3 Python Prometheus åº“å®è·µ</h4><p>å‚è€ƒåœ°å€: <a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank" rel="noopener">https://prometheus.io/docs/instrumenting/clientlibs/</a></p>
<ul>
<li><strong>Counter</strong> : è®¡æ•°å™¨ä¸Šå‡å¹¶åœ¨è¿›ç¨‹é‡æ–°å¯åŠ¨æ—¶é‡ç½®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from prometheus_client import Counter</span><br><span class="line">c = Counter(<span class="string">'my_failures'</span>, <span class="string">'Description of counter'</span>)</span><br><span class="line">c.inc()     <span class="comment"># Increment by 1</span></span><br><span class="line">c.inc(1.6)  <span class="comment"># Increment by given value</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : Counter æŒ‡æ ‡ç±»å‹åªèƒ½å¢åŠ ï¼Œé‡å¯æ—¶ç½®é›¶ï¼Œå¯ä»¥ä½¿ç”¨è®¡æ•°å™¨æ¥è¡¨ç¤ºæ‰€æœåŠ¡çš„è¯·æ±‚æ•°ï¼Œå·²å®Œæˆçš„ä»»åŠ¡æˆ–é”™è¯¯ã€‚</p>
<ul>
<li><strong>Gauge</strong> : ä»ªè¡¨å¯ä»¥å‡é™ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example</span></span><br><span class="line">from prometheus_client import Gauge</span><br><span class="line">g = Gauge(<span class="string">'my_inprogress_requests'</span>, <span class="string">'Description of gauge'</span>)</span><br><span class="line">g.inc()      <span class="comment"># Increment by 1</span></span><br><span class="line">g.dec(10)    <span class="comment"># Decrement by given value</span></span><br><span class="line">g.set(4.2)   <span class="comment"># Set to a given value</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½® Labels</span></span><br><span class="line">from prometheus_client import Counter</span><br><span class="line">c = Counter(<span class="string">'my_requests_total'</span>, <span class="string">'HTTP Failures'</span>, [<span class="string">'method'</span>, <span class="string">'endpoint'</span>])</span><br><span class="line">c.labels(<span class="string">'get'</span>, <span class="string">'/'</span>).inc()</span><br><span class="line">c.labels(<span class="string">'post'</span>, <span class="string">'/submit'</span>).inc()</span><br><span class="line"><span class="comment"># Labels can also be passed as keyword-arguments:</span></span><br><span class="line">from prometheus_client import Counter</span><br><span class="line">c = Counter(<span class="string">'my_requests_total'</span>, <span class="string">'HTTP Failures'</span>, [<span class="string">'method'</span>, <span class="string">'endpoint'</span>])</span><br><span class="line">c.labels(method=<span class="string">'get'</span>, endpoint=<span class="string">'/'</span>).inc()</span><br><span class="line">c.labels(method=<span class="string">'post'</span>, endpoint=<span class="string">'/submit'</span>).inc()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Gauge example:</span></span><br><span class="line">from prometheus_client import Gauge</span><br><span class="line">g = Gauge(<span class="string">'my_inprogress_requests'</span>, <span class="string">'Description of gauge'</span>,[<span class="string">'mylabelname'</span>])</span><br><span class="line">g.labels(mylabelname=<span class="string">'labelname'</span>).<span class="built_in">set</span>(30)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : Gauge æŒ‡æ ‡ç±»å‹è¡¨ç¤ºå•ä¸ªæ•°å€¼ï¼Œå¯ä»¥ä»»æ„åœ°ä¸Šå‡å’Œä¸‹é™çš„åº¦é‡ã€‚é€šå¸¸ç”¨äºæµ‹é‡å€¼ï¼Œå¦‚æ¸©åº¦æˆ–å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µã€‚</p>
<p>Tips : Gauge æŒ‡æ ‡ä¸èƒ½ä½¿ç”¨<code>rateï¼Œirate</code>ç­‰å¢é•¿ç‡ç»Ÿè®¡è¡¨è¾¾å¼</p>
<p><br/></p>
<ul>
<li><strong>Summaryã€Histogram</strong>: ä¸¤ç§æŒ‡æ ‡ç±»å‹ä½¿ç”¨è¾ƒå°‘ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import psutil</span><br><span class="line">import socket</span><br><span class="line">from prometheus_client import Gauge,start_http_server</span><br><span class="line">from time import sleep</span><br><span class="line"></span><br><span class="line">g = Gauge(<span class="string">'cup_use_percent_test_metric'</span>, <span class="string">'Description of gauge'</span>,[<span class="string">'hostip'</span>])</span><br><span class="line">host_ip = socket.gethostbyname(socket.getfqdn(socket.gethostname()))      <span class="comment"># è·å–æœ¬æœºIP</span></span><br><span class="line"></span><br><span class="line">def get_cup_use():</span><br><span class="line">    cup_use_percent = psutil.cpu_percent(0.5)      <span class="comment"># è·å–CPUä½¿ç”¨ç‡</span></span><br><span class="line">    g.labels(hostip=host_ip).<span class="built_in">set</span>(cup_use_percent)  <span class="comment"># æœ¬æœºIPä¼ å…¥labelsï¼ŒCPUä½¿ç”¨ç‡ä¼ å…¥value</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  start_http_server(8006)                          <span class="comment"># å¯åŠ¨8006ç«¯å£</span></span><br><span class="line">  <span class="keyword">while</span> True:</span><br><span class="line">    get_cup_use()</span><br><span class="line">    sleep(10)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<p><strong>Python prometheus-client å®‰è£…ä¸ä½¿ç”¨</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">pip install prometheus-client</span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) Python å°è£…</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">from prometheus_client import Counter, Gauge, Summary</span><br><span class="line">from prometheus_client.core import CollectorRegistry</span><br><span class="line">from prometheus_client.exposition import choose_encoder</span><br><span class="line"></span><br><span class="line">class Monitor:</span><br><span class="line">    def __init__(self):</span><br><span class="line">    <span class="comment"># æ³¨å†Œæ”¶é›†å™¨&amp;æœ€å¤§è€—æ—¶map</span></span><br><span class="line">    self.collector_registry = CollectorRegistry(auto_describe=False)</span><br><span class="line">    self.request_time_max_map = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¥å£è°ƒç”¨summaryç»Ÿè®¡</span></span><br><span class="line">    self.http_request_summary = Summary(name=<span class="string">"http_server_requests_seconds"</span>,</span><br><span class="line">                                   documentation=<span class="string">"Num of request time summary"</span>,</span><br><span class="line">                                   labelnames=(<span class="string">"method"</span>, <span class="string">"code"</span>, <span class="string">"uri"</span>),</span><br><span class="line">                                   registry=self.collector_registry)</span><br><span class="line">    <span class="comment"># æ¥å£æœ€å¤§è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    self.http_request_max_cost = Gauge(name=<span class="string">"http_server_requests_seconds_max"</span>,</span><br><span class="line">                                  documentation=<span class="string">"Number of request max cost"</span>,</span><br><span class="line">                                  labelnames=(<span class="string">"method"</span>, <span class="string">"code"</span>, <span class="string">"uri"</span>),</span><br><span class="line">                                  registry=self.collector_registry)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¯·æ±‚å¤±è´¥æ¬¡æ•°ç»Ÿè®¡</span></span><br><span class="line">    self.http_request_fail_count = Counter(name=<span class="string">"http_server_requests_error"</span>,</span><br><span class="line">                                      documentation=<span class="string">"Times of request fail in total"</span>,</span><br><span class="line">                                      labelnames=(<span class="string">"method"</span>, <span class="string">"code"</span>, <span class="string">"uri"</span>),</span><br><span class="line">                                      registry=self.collector_registry)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¨¡å‹é¢„æµ‹è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    self.http_request_predict_cost = Counter(name=<span class="string">"http_server_requests_seconds_predict"</span>,</span><br><span class="line">                                        documentation=<span class="string">"Seconds of prediction cost in total"</span>,</span><br><span class="line">                                        labelnames=(<span class="string">"method"</span>, <span class="string">"code"</span>, <span class="string">"uri"</span>),</span><br><span class="line">                                        registry=self.collector_registry)</span><br><span class="line">    <span class="comment"># å›¾ç‰‡ä¸‹è½½è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    self.http_request_download_cost = Counter(name=<span class="string">"http_server_requests_seconds_download"</span>,</span><br><span class="line">                                         documentation=<span class="string">"Seconds of download cost in total"</span>,</span><br><span class="line">                                         labelnames=(<span class="string">"method"</span>, <span class="string">"code"</span>, <span class="string">"uri"</span>),</span><br><span class="line">                                         registry=self.collector_registry)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–/metricsç»“æœ</span></span><br><span class="line">    def get_prometheus_metrics_info(self, handler):</span><br><span class="line">        encoder, content_type = choose_encoder(handler.request.headers.get(<span class="string">'accept'</span>))</span><br><span class="line">        handler.set_header(<span class="string">"Content-Type"</span>, content_type)</span><br><span class="line">        handler.write(encoder(self.collector_registry))</span><br><span class="line">        self.reset_request_time_max_map()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># summaryç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_summary(self, handler):</span><br><span class="line">        self.http_request_summary.labels(handler.request.method, handler.get_status(), handler.request.path).observe(handler.request.request_time())</span><br><span class="line">        self.set_prometheus_request_max_cost(handler)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰summaryç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_summary_customize(self, method, status, path, cost_time):</span><br><span class="line">        self.http_request_summary.labels(method, status, path).observe(cost_time)</span><br><span class="line">        self.set_prometheus_request_max_cost_customize(method, status, path, cost_time)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤±è´¥ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_fail_count(self, handler, amount=1.0):</span><br><span class="line">        self.http_request_fail_count.labels(handler.request.method, handler.get_status(), handler.request.path).inc(amount)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰å¤±è´¥ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_fail_count_customize(self, method, status, path, amount=1.0):</span><br><span class="line">        self.http_request_fail_count.labels(method, status, path).inc(amount)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æœ€å¤§è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_max_cost(self, handler):</span><br><span class="line">        requset_cost = handler.request.request_time()</span><br><span class="line">        <span class="keyword">if</span> self.check_request_time_max_map(handler.request.path, requset_cost):</span><br><span class="line">            self.http_request_max_cost.labels(handler.request.method, handler.get_status(), handler.request.path).<span class="built_in">set</span>(requset_cost)</span><br><span class="line">            self.request_time_max_map[handler.request.path] = requset_cost</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰æœ€å¤§è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_max_cost_customize(self, method, status, path, cost_time):</span><br><span class="line">        <span class="keyword">if</span> self.check_request_time_max_map(path, cost_time):</span><br><span class="line">            self.http_request_max_cost.labels(method, status, path).<span class="built_in">set</span>(cost_time)</span><br><span class="line">            self.request_time_max_map[path] = cost_time</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é¢„æµ‹è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_predict_cost(self, handler, amount=1.0):</span><br><span class="line">        self.http_request_predict_cost.labels(handler.request.method, handler.get_status(), handler.request.path).inc(amount)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰é¢„æµ‹è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_predict_cost_customize(self, method, status, path, cost_time):</span><br><span class="line">        self.http_request_predict_cost.labels(method, status, path).inc(cost_time)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸‹è½½è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_download_cost(self, handler, amount=1.0):</span><br><span class="line">        self.http_request_download_cost.labels(handler.request.method, handler.get_status(), handler.request.path).inc(amount)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰ä¸‹è½½è€—æ—¶ç»Ÿè®¡</span></span><br><span class="line">    def set_prometheus_request_download_cost_customize(self, method, status, path, cost_time):</span><br><span class="line">        self.http_request_download_cost.labels(method, status, path).inc(cost_time)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ ¡éªŒæ˜¯å¦èµ‹å€¼æœ€å¤§è€—æ—¶map</span></span><br><span class="line">    def check_request_time_max_map(self, uri, cost):</span><br><span class="line">        <span class="keyword">if</span> uri not <span class="keyword">in</span> self.request_time_max_map:</span><br><span class="line">            <span class="built_in">return</span> True</span><br><span class="line">        <span class="keyword">if</span> self.request_time_max_map[uri] &lt; cost:</span><br><span class="line">            <span class="built_in">return</span> True</span><br><span class="line">        <span class="built_in">return</span> False</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é‡ç½®æœ€å¤§è€—æ—¶map</span></span><br><span class="line">    def reset_request_time_max_map(self):</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> self.request_time_max_map:</span><br><span class="line">            self.request_time_max_map[key] = 0.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) å°è£…è°ƒç”¨</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">import tornado</span><br><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.web</span><br><span class="line">import tornado.gen</span><br><span class="line">from datetime import datetime</span><br><span class="line">from tools.monitor import Monitor</span><br><span class="line"></span><br><span class="line">global g_monitor</span><br><span class="line"></span><br><span class="line">class ClassifierHandler(tornado.web.RequestHandler):</span><br><span class="line">    def post(self):</span><br><span class="line">        <span class="comment"># TODO Something you need</span></span><br><span class="line">        <span class="comment"># work....</span></span><br><span class="line">        <span class="comment"># ç»Ÿè®¡Summaryï¼ŒåŒ…æ‹¬è¯·æ±‚æ¬¡æ•°å’Œæ¯æ¬¡è€—æ—¶</span></span><br><span class="line">        g_monitor.set_prometheus_request_summary(self)</span><br><span class="line">        self.write(<span class="string">"OK"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class PingHandler(tornado.web.RequestHandler):</span><br><span class="line">    def head(self):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'INFO'</span>, datetime.now(), <span class="string">"/ping Head."</span>)</span><br><span class="line">        g_monitor.set_prometheus_request_summary(self)</span><br><span class="line">        self.write(<span class="string">"OK"</span>)</span><br><span class="line"></span><br><span class="line">    def get(self):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'INFO'</span>, datetime.now(), <span class="string">"/ping Get."</span>)</span><br><span class="line">        g_monitor.set_prometheus_request_summary(self)</span><br><span class="line">        self.write(<span class="string">"OK"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MetricsHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'INFO'</span>, datetime.now(), <span class="string">"/metrics Get."</span>)</span><br><span class="line">    g_monitor.set_prometheus_request_summary(self)</span><br><span class="line">    <span class="comment"># é€šè¿‡Metricsæ¥å£è¿”å›ç»Ÿè®¡ç»“æœ</span></span><br><span class="line">    	g_monitor.get_prometheus_metrics_info(self)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">def make_app():</span><br><span class="line">    <span class="built_in">return</span> tornado.web.Application([</span><br><span class="line">        (r<span class="string">"/ping?"</span>, PingHandler),</span><br><span class="line">        (r<span class="string">"/metrics?"</span>, MetricsHandler),</span><br><span class="line">        (r<span class="string">"/work?"</span>, ClassifierHandler)</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    g_monitor = Monitor()</span><br><span class="line">  </span><br><span class="line">  app = make_app()</span><br><span class="line">    app.listen(port)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<!-- ### 4.ç»¼åˆå®è·µ
#### 4.1 é‡‡ç”¨Javaç¨‹åºè¿›è¡Œå£°æ˜æµ‹æ§å’Œå±•ç¤º
åç»­è¡¥å……é‡‡ç”¨ simpleclient å®è·µã€‚ -->
<hr>
<h2 id="0x01-PushGateway-ä½¿ç”¨å®è·µ"><a href="#0x01-PushGateway-ä½¿ç”¨å®è·µ" class="headerlink" title="0x01 PushGateway ä½¿ç”¨å®è·µ"></a>0x01 PushGateway ä½¿ç”¨å®è·µ</h2><p>æè¿°: PushGateway ä½œä¸º Prometheus ç”Ÿæ€ä¸­çš„ä¸€ä¸ªé‡è¦ä¸€å‘˜ï¼Œå®ƒå…è®¸ä»»ä½•å®¢æˆ·ç«¯å‘å…¶ Push ç¬¦åˆè§„èŒƒçš„è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡å†ç»“åˆ Prometheus ç»Ÿä¸€æ”¶é›†ç›‘æ§ã€‚</p>
<h3 id="1-åŸºç¡€è¯´æ˜"><a href="#1-åŸºç¡€è¯´æ˜" class="headerlink" title="1.åŸºç¡€è¯´æ˜"></a>1.åŸºç¡€è¯´æ˜</h3><p>æˆ‘ä»¬å¸¸å¸¸å¯ä»¥åœ¨ä»¥ä¸‹ä¸¤ç§åœºæ™¯ä¸­ä½¿ç”¨:</p>
<ul>
<li>1) åœºæ™¯1: Prometheus é‡‡ç”¨å®šæ—¶ Pull æ¨¡å¼ï¼Œå¯èƒ½ç”±äºå­ç½‘ç»œæˆ–è€…é˜²ç«å¢™çš„åŸå› ï¼Œä¸èƒ½ç›´æ¥æ‹‰å–å„ä¸ª Target çš„æŒ‡æ ‡æ•°æ®ï¼Œæ­¤æ—¶å¯ä»¥é‡‡ç”¨å„ä¸ª get å¾€ PushGateway ä¸Š Push æ•°æ®ï¼Œç„¶å Prometheus å» PushGateway ä¸Šå®šæ—¶ pullã€‚</li>
<li>2) åœºæ™¯2: åœ¨ä¼ä¸šå†…éƒ¨éœ€è¦ç›‘æ§å¤šä¸ªä¸šåŠ¡æ•°æ®å¹¶ä¸”éœ€è¦å°†å„ä¸ªä¸åŒçš„ä¸šåŠ¡æ•°æ®è¿›è¡Œç»Ÿä¸€æ±‡æ€»æ—¶ä¹Ÿå¯ä»¥é‡‡ç”¨PushGateway æ¥ç»Ÿä¸€æ”¶é›†ï¼Œç„¶å Prometheus æ¥ç»Ÿä¸€æ‹‰å–ã€‚</li>
</ul>
<p><strong>å®éªŒç›®çš„ï¼š</strong><br>æè¿°: å®ç°Pushgatewayç»„ä»¶å¤šç§å°†é‡‡é›†æ•°æ®å‘ˆç°ç»™Prometheusï¼Œé€šè¿‡Pythonå’ŒCurlè¿›è¡Œä¸Šä¼ æŒ‡æ ‡æ•°æ®åˆ°Pushgatewayä¹‹ä¸­ã€‚</p>
<p><strong>å®éªŒç¯å¢ƒ:</strong><br>Prometheus â€“&gt; V2.27.1<br>Pushgateway â€“&gt; V1.4.1</p>
<p>Tips ï¼š Pushgatewayä¸æ˜¯å°†Prometheusä»æ‹‰å–æ¨¡å¼è½¬ä¸ºæ¨é€æ¨¡å¼çš„æ–¹æ¡ˆã€‚</p>
<p><br></p>
<h3 id="2-å®æˆ˜é…ç½®"><a href="#2-å®æˆ˜é…ç½®" class="headerlink" title="2.å®æˆ˜é…ç½®"></a>2.å®æˆ˜é…ç½®</h3><p>æè¿°: å‡è®¾æ‚¨å·²ç»å®‰è£…å¥½PrometheusæœåŠ¡ç«¯ç¯å¢ƒåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šè¿›è¡Œå¦‚ä¸‹é…ç½®ã€‚</p>
<ul>
<li>Step 1.<a href="https://github.com/prometheus/pushgateway" target="_blank" rel="noopener">ä¸‹è½½å®‰è£…Pushgateway</a>å¹¶æ³¨å†Œä¸ºç³»ç»ŸæœåŠ¡åœ°å€ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo tee /usr/lib/systemd/system/pushgateway.service &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus pushgateway Server Systemd</span><br><span class="line">Documentation=https://prometheus.io</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">StandardError=journal</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/pushgateway/pushgateway --web.listen-address=:9091</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=3s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload &amp;&amp; systemctl restart pushgateway.service</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210614161122.png" target="_blank" title="WeiyiGeek.éªŒè¯PushgatewayæœåŠ¡" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210614161122.png" alt="WeiyiGeek.éªŒè¯PushgatewayæœåŠ¡" title="" class=""></a>
                <p>WeiyiGeek.éªŒè¯PushgatewayæœåŠ¡</p>
            </figure>
<p><br/></p>
<ul>
<li>Step 2.åœ¨Prometheus.ymlé…ç½®æ–‡ä»¶ä¸­è®¾ç½®æŠ“å–æœ¬åœ°å®‰è£…pushgatewayçš„IPåŠå…¶ç«¯å£é…ç½®ã€‚<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- job_name:</span> <span class="string">'pushgateway'</span></span><br><span class="line"><span class="attr">    honor_labels:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">['localhost:9091']</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips: è®¾ç½®<code>honor_labels: true</code>æ˜¯å› ä¸ºprometheusé…ç½®pushgateway çš„æ—¶å€™,ä¹Ÿä¼šæŒ‡å®šjobå’Œinstance,ä½†æ˜¯å®ƒåªè¡¨ç¤ºpushgatewayå®ä¾‹,ä¸èƒ½çœŸæ­£è¡¨è¾¾æ”¶é›†æ•°æ®çš„å«ä¹‰ã€‚æ‰€ä»¥é…ç½®pushgatewayéœ€è¦æ·»åŠ honor_labels:true,é¿å…æ”¶é›†æ•°æ®æœ¬èº«çš„jobå’Œinstanceè¢«è¦†ç›–ã€‚</p>
<ul>
<li>Step 3.æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å°†æ•°æ®æ¨é€åˆ°Pushgatewayä¹‹ä¸­ï¼Œæœ€å¸¸ç”¨å°±æ˜¯å®˜ç½‘æä¾›çš„Python libraryæ¨¡å—ä»¥åŠCurl POSTæŒ‡æ ‡æ•°æ®ä¸Šä¼ ã€‚<br>æè¿°: åœ¨Pythonå®¢æˆ·ç«¯prometheusæ¨¡å—ä¹‹ä¸­ä¸»è¦é‡‡ç”¨ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°ä»¥åŠé‡‡ç”¨requestæ¨¡å—è¿›è¡ŒPOSTæŒ‡æ ‡æ¨é€ï¼Œå®˜ç½‘å¸®åŠ©: <a href="https://github.com/prometheus/client_pythonï¼›" target="_blank" rel="noopener">https://github.com/prometheus/client_pythonï¼›</a><ul>
<li>push_to_gateway : é¦–å…ˆç§»é™¤æ‰€æœ‰è·Ÿè¿™ä¸ªä½œä¸šç›¸å…³çš„æŒ‡æ ‡å¹¶è®°å½•ä¸‹åˆšæ¨é€çš„æ•°æ®(<code>å®é™…é‡‡ç”¨çš„æ˜¯HTTPçš„PUTæ–¹æ³•å®ç°</code>)</li>
<li>pushadd_to_gateway : è¦†ç›–å·²ç»é‡åçš„æŒ‡æ ‡è€Œä¹‹å‰åˆ›å»ºä¸åŒåçš„æŒ‡æ ‡å°†ä¿æŒä¸å˜(<code>å®é™…é‡‡ç”¨çš„æ˜¯HTTPçš„POSTæ–¹æ³•å®ç°</code>)</li>
<li>delete_from_gateway : åˆ é™¤æ‰€æœ‰ä¸è¯¥ä½œä¸šç›¸å…³çš„æŒ‡æ ‡(<code>å®é™…é‡‡ç”¨çš„æ˜¯HTTPçš„DELETEæ–¹æ³•å®ç°</code>)</li>
</ul>
</li>
</ul>
<p>ç»¼åˆå®è·µ:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: æ¼”ç¤ºåœ¨æµ‹æ§ä¸­ä½¿ç”¨Pythonè‡ªå®šä¹‰æŒ‡æ ‡å¹¶å°†é‡‡é›†çš„æ•°æ®æ¨é€åˆ°Pushgatewayä¸Š</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests,random,pprint</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> CollectorRegistry, Gauge, pushadd_to_gateway, registry</span><br><span class="line"></span><br><span class="line">pushgateway_ip = <span class="string">"10.10.107.249"</span></span><br><span class="line">pushgateway_port = <span class="string">"9091"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼1.åˆ›å»ºä¸€ä¸ªæµ‹æ§æ‰¹å¤„ç†ä»»åŠ¡å¹¶ä¸”å°†æŒ‡æ ‡æ•°æ®æ¨é€ç»™Pushgatewayã€‚</span></span><br><span class="line">registry = CollectorRegistry()</span><br><span class="line">durationtime = Gauge(<span class="string">'app_job_duration_time_seconds'</span>,<span class="string">'duration of my batch in seconds'</span>, registry=registry)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  <span class="keyword">with</span> durationtime.time():</span><br><span class="line">    <span class="comment"># Guage(metric_name,HELP,labels_name,registry=registry)</span></span><br><span class="line">    suc = Gauge(<span class="string">'app_job_sucess_seconds'</span>,<span class="string">'Last time my job successfully finished'</span>,[<span class="string">'dst_ip'</span>,<span class="string">'name'</span>],registry=registry)</span><br><span class="line">    suc.labels(<span class="string">'192.168.1.1'</span>,<span class="string">'app'</span>).set(random.randrange(<span class="number">999</span>,<span class="number">9999</span>))</span><br><span class="line">    suc.labels(<span class="string">'192.168.1.11'</span>,<span class="string">'weblogic'</span>).dec(<span class="number">2</span>)  <span class="comment">#decé€’å‡2</span></span><br><span class="line">    suc.labels(<span class="string">'192.168.1.12'</span>,<span class="string">'nginx'</span>).inc()  <span class="comment">#incé€’å¢ï¼Œé»˜è®¤å¢1</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">  pushadd_to_gateway(pushgateway_ip+<span class="string">":"</span>+pushgateway_port,job=<span class="string">'app'</span>,registry=registry)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2.é‡‡ç”¨requestæ¨¡å—è¿›è¡ŒæŒ‡æ ‡æ•°æ®ä¸Šä¼ ã€‚</span></span><br><span class="line">quota = <span class="string">"""</span></span><br><span class="line"><span class="string"># TYPE test_metric counter</span></span><br><span class="line"><span class="string">test_metric&#123;label="test"&#125; %s</span></span><br><span class="line"><span class="string"># TYPE another_metric gauge</span></span><br><span class="line"><span class="string"># HELP another_metric Just an example.</span></span><br><span class="line"><span class="string">another_metric&#123;label="prod"&#125; %s</span></span><br><span class="line"><span class="string">"""</span>%(random.randrange(<span class="number">1</span>,<span class="number">100</span>),random.random())</span><br><span class="line"><span class="comment"># quota_bin = binascii.hexlify(quota)</span></span><br><span class="line">res = requests.post(url=<span class="string">"http://"</span>+pushgateway_ip+<span class="string">":"</span>+pushgateway_port+<span class="string">"/metrics/job/app/custom_instance/test_instance"</span>,data=quota,headers=&#123;<span class="string">'Content-Type'</span>: <span class="string">'application/octet-stream'</span>&#125;)</span><br><span class="line">pprint.pprint(res)</span><br><span class="line">pprint.pprint(res.status_code)</span><br><span class="line"></span><br><span class="line"><span class="comment"># -- æ‰§è¡Œç»“æœ ---</span></span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210614170019.png" target="_blank" title="WeiyiGeek.pushadd_to_gateway" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210614170019.png" alt="WeiyiGeek.pushadd_to_gateway" title="" class=""></a>
                <p>WeiyiGeek.pushadd_to_gateway</p>
            </figure></p>
<ul>
<li>Step 4.æˆ‘ä»¬é‡‡ç”¨Linuxä¸­çš„curlè¿›è¡Œä¸Šä¼ æŒ‡æ ‡æ•°æ®åˆ°Pushgatewayä¹‹ä¸­ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 1.æ¨é€å•ä¸ªæˆ–è€…å¤šä¸ªç›‘æ§æŒ‡æ ‡åˆ°ç½‘å…³</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"name_count 1"</span> | curl --data-binary @- http://10.10.107.249:9091/metrics/job/curl_job</span><br><span class="line">cat &lt;&lt;EOF | curl --data-binary @- http://10.10.107.249:9091/metrics/job/curl_job/app/weiyigeek</span><br><span class="line"><span class="comment"># TYPE app_init_total counter</span></span><br><span class="line"><span class="comment"># HELP This is app initialization count </span></span><br><span class="line">app_init_total 1314</span><br><span class="line"><span class="comment"># TYPE app_init_metric gauge</span></span><br><span class="line"><span class="comment"># HELP app_init_metric Just an example.</span></span><br><span class="line">app_init_metric 1024.16</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># -2.æŠŠå¤šä¸ªæŒ‡æ ‡å†™å…¥åˆ°æ–‡ä»¶é‡Œé€šè¿‡curlçš„@è¯»å–æ–‡ä»¶æ¥ä¸Šä¼ æŒ‡æ ‡</span></span><br><span class="line">tee metrics &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">http_request_total&#123;code=<span class="string">"200"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 276683</span><br><span class="line">http_request_total&#123;code=<span class="string">"400"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 0</span><br><span class="line">http_request_total&#123;code=<span class="string">"408"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 7</span><br><span class="line">http_request_total&#123;code=<span class="string">"401"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 0</span><br><span class="line">http_request_total&#123;schema=<span class="string">"http"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 277725</span><br><span class="line">http_request_total&#123;schema=<span class="string">"https"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 0</span><br><span class="line">http_request_time&#123;code=<span class="string">"total"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 76335.809000</span><br><span class="line">http_request_uniqip&#123;domain=<span class="string">"weiyigeek.top"</span>&#125; 216944</span><br><span class="line">http_request_maxip&#123;clientip=<span class="string">"172.27.0.12"</span>,domain=<span class="string">"weiyigeek.top"</span>&#125; 81</span><br><span class="line">EOF</span><br><span class="line">curl -XPOST --data-binary @metrics http://10.10.107.249:9091/metrics/job/curl_job/app/my_blog/site/weiyigeek.top</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210614223940.png" target="_blank" title="WeiyiGeek.curl-post" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210614223940.png" alt="WeiyiGeek.curl-post" title="" class=""></a>
                <p>WeiyiGeek.curl-post</p>
            </figure>
<p><br></p>
<ul>
<li>Step 5.æµ‹æ§è¿›è¡ŒæŒ‡æ ‡çš„å¤šæ ‡ç­¾ç”Ÿæˆå®ä¾‹æ¼”ç¤º</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># Desc: æ¼”ç¤ºåœ¨æµ‹æ§ä¸­ä¸ºæŒ‡æ ‡è®¾ç½®å¤šä¸ªæ ‡ç­¾</span></span><br><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Gauge, Summary, start_http_server,Counter</span><br><span class="line"></span><br><span class="line"><span class="comment"># - REQUESTS è®°å½•ç½‘ç«™å„è®¿é—®è·¯å¾„ä¸è¯·æ±‚æ–¹æ³•åˆè®¡æ¬¡æ•°(å¤šæ ‡ç­¾)</span></span><br><span class="line">REQUESTS = Counter(<span class="string">'http_requested_total'</span>, <span class="string">'ç½‘ç«™å„è®¿é—®è·¯å¾„ä¸è¯·æ±‚æ–¹æ³•åˆè®¡'</span>,[<span class="string">'path'</span>, <span class="string">'method'</span>])</span><br><span class="line"><span class="comment"># - ENUM è®°å½•æšä¸¾å€¼å‡ºç°æ¬¡æ•°(å¤šæ ‡ç­¾)</span></span><br><span class="line">ENUM = Counter(<span class="string">'http_enum_total'</span>, <span class="string">'è¯·æ±‚ç½‘ç«™åæšä¸¾å€¼çš„æ­¤æ—¶'</span>,[<span class="string">'index'</span>,<span class="string">'name'</span>])</span><br><span class="line">DEMO_ARAAY = [<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"there"</span>,<span class="string">"four"</span>]</span><br><span class="line"><span class="comment"># - MODIFIER ä½¿ç”¨å¸¦æœ‰æ ‡ç­¾çš„ä¿®é¥°å™¨(å¤šæ ‡ç­¾)</span></span><br><span class="line">MODIFIER = Summary(<span class="string">'http_modifier_seconds'</span>, <span class="string">'è¯·æ±‚ç½‘ç«™ä¸­ä½¿ç”¨å¸¦æœ‰æ ‡ç­¾çš„ä¿®é¥°å™¨'</span>, [<span class="string">'index'</span>,<span class="string">'name'</span>])</span><br><span class="line">modifier = MODIFIER.labels(<span class="string">'MODIFIER'</span>,<span class="string">'weiyigeek'</span>)</span><br><span class="line"><span class="comment"># - DEMOINFO - æš´éœ²æŒ‡æ ‡çš„æŒ‡å®šä¿¡æ¯</span></span><br><span class="line">python_info = &#123; <span class="string">"implementation"</span>: <span class="string">"CPython"</span>, <span class="string">"major"</span>: <span class="string">"3"</span>, <span class="string">"minor"</span>: <span class="string">"7"</span>, <span class="string">"patchlevel"</span>: <span class="string">"0"</span>, <span class="string">"version"</span>: <span class="string">"3.8.0"</span> &#125;</span><br><span class="line">DEMOINFO = Gauge(<span class="string">'demo_info'</span>,<span class="string">'æš´éœ²æŒ‡æ ‡çš„æŒ‡å®šä¿¡æ¯'</span>,labelnames=python_info.keys())</span><br><span class="line">DEMOINFO.labels(**python_info).set(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(http.server.BaseHTTPRequestHandler)</span>:</span> </span><br><span class="line"><span class="meta">  @modifier.time()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">    REQUESTS.labels(self.path, self.command).inc()</span><br><span class="line">    ENUM.labels(DEMO_ARAAY[random.randint(<span class="number">0</span>,DEMO_ARAAY.__len__() - <span class="number">1</span>)], <span class="string">'ENUM'</span>).inc()</span><br><span class="line">    self.send_response(<span class="number">200</span>)</span><br><span class="line">    self.end_headers()</span><br><span class="line">    self.wfile.write(<span class="string">b"Hello World! Multi label Example!"</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  print(<span class="string">"Start Prometheus Client /metrics Server!"</span>)</span><br><span class="line">  start_http_server(<span class="number">8000</span>)</span><br><span class="line">  server = http.server.HTTPServer((<span class="string">'0.0.0.0'</span>,<span class="number">8001</span>),Hello)</span><br><span class="line">  server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP http_requested_total ç½‘ç«™å„è®¿é—®è·¯å¾„ä¸è¯·æ±‚æ–¹æ³•åˆè®¡</span></span><br><span class="line"><span class="comment"># TYPE http_requested_total counter</span></span><br><span class="line">http_requested_total&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/number"</span>&#125; 4.0</span><br><span class="line">http_requested_total&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/favicon.ico"</span>&#125; 7.0</span><br><span class="line">http_requested_total&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/result"</span>&#125; 1.0</span><br><span class="line">http_requested_total&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/"</span>&#125; 2.0</span><br><span class="line">http_requested_total&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/"</span>&#125; 5.0</span><br><span class="line"><span class="comment"># HELP http_requested_created ç½‘ç«™å„è®¿é—®è·¯å¾„ä¸è¯·æ±‚æ–¹æ³•åˆè®¡</span></span><br><span class="line"><span class="comment"># TYPE http_requested_created gauge</span></span><br><span class="line">http_requested_created&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/number"</span>&#125; 1.623854061065871e+09</span><br><span class="line">http_requested_created&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/favicon.ico"</span>&#125; 1.6238540611298337e+09</span><br><span class="line">http_requested_created&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/result"</span>&#125; 1.6238540711289563e+09</span><br><span class="line">http_requested_created&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/"</span>&#125; 1.6238540782242467e+09</span><br><span class="line">http_requested_created&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/"</span>&#125; 1.6238541072589352e+09</span><br><span class="line"><span class="comment"># HELP http_enum_total è¯·æ±‚ç½‘ç«™åæšä¸¾å€¼çš„æ­¤æ—¶</span></span><br><span class="line"><span class="comment"># TYPE http_enum_total counter</span></span><br><span class="line">http_enum_total&#123;index=<span class="string">"two"</span>,name=<span class="string">"ENUM"</span>&#125; 4.0</span><br><span class="line">http_enum_total&#123;index=<span class="string">"there"</span>,name=<span class="string">"ENUM"</span>&#125; 4.0</span><br><span class="line">http_enum_total&#123;index=<span class="string">"one"</span>,name=<span class="string">"ENUM"</span>&#125; 6.0</span><br><span class="line">http_enum_total&#123;index=<span class="string">"four"</span>,name=<span class="string">"ENUM"</span>&#125; 5.0</span><br><span class="line"><span class="comment"># HELP http_enum_created è¯·æ±‚ç½‘ç«™åæšä¸¾å€¼çš„æ­¤æ—¶</span></span><br><span class="line"><span class="comment"># TYPE http_enum_created gauge</span></span><br><span class="line">http_enum_created&#123;index=<span class="string">"two"</span>,name=<span class="string">"ENUM"</span>&#125; 1.623854061065871e+09</span><br><span class="line">http_enum_created&#123;index=<span class="string">"there"</span>,name=<span class="string">"ENUM"</span>&#125; 1.6238540611298337e+09</span><br><span class="line">http_enum_created&#123;index=<span class="string">"one"</span>,name=<span class="string">"ENUM"</span>&#125; 1.623854061224779e+09</span><br><span class="line">http_enum_created&#123;index=<span class="string">"four"</span>,name=<span class="string">"ENUM"</span>&#125; 1.6238540614066763e+09</span><br><span class="line"><span class="comment"># HELP http_modifier_seconds è¯·æ±‚ç½‘ç«™ä¸­ä½¿ç”¨å¸¦æœ‰æ ‡ç­¾çš„ä¿®é¥°å™¨</span></span><br><span class="line"><span class="comment"># TYPE http_modifier_seconds summary</span></span><br><span class="line">http_modifier_seconds_count&#123;index=<span class="string">"MODIFIER"</span>,name=<span class="string">"weiyigeek"</span>&#125; 19.0</span><br><span class="line">http_modifier_seconds_sum&#123;index=<span class="string">"MODIFIER"</span>,name=<span class="string">"weiyigeek"</span>&#125; 0.008954100000021725</span><br><span class="line"><span class="comment"># HELP http_modifier_seconds_created è¯·æ±‚ç½‘ç«™ä¸­ä½¿ç”¨å¸¦æœ‰æ ‡ç­¾çš„ä¿®é¥°å™¨</span></span><br><span class="line"><span class="comment"># TYPE http_modifier_seconds_created gauge</span></span><br><span class="line">http_modifier_seconds_created&#123;index=<span class="string">"MODIFIER"</span>,name=<span class="string">"weiyigeek"</span>&#125; 1.6238540450573144e+09</span><br><span class="line"><span class="comment"># HELP demo_info æš´éœ²æŒ‡æ ‡çš„æŒ‡å®šä¿¡æ¯</span></span><br><span class="line"><span class="comment"># TYPE demo_info gauge</span></span><br><span class="line">demo_info&#123;implementation=<span class="string">"CPython"</span>,major=<span class="string">"3"</span>,minor=<span class="string">"7"</span>,patchlevel=<span class="string">"0"</span>,version=<span class="string">"3.8.0"</span>&#125; 1.0</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li>Step 6.ä¸Šä¼ æˆ‘ä»¬åˆ é™¤çš„æŒ‡æ ‡ï¼Œåˆ é™¤æ ‡è¯†çš„ç»„ä¸­çš„æ‰€æœ‰æŒ‡æ ‡<code>{job=&quot;curl_job&quot;}</code>è¯·æ³¨æ„ï¼Œè¿™ä¸åŒ…æ‹¬<code>{job=&quot;curl_job&quot;,instance=&quot;some_instance&quot;}</code>ä¸­çš„æŒ‡æ ‡ ï¼Œå³ä½¿è¿™äº›æŒ‡æ ‡å…·æœ‰ç›¸åŒçš„ job æ ‡ç­¾ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 1.åªä¼šåˆ é™¤æ ‡ç­¾åªæœ‰job="curl_job"çš„æŒ‡æ ‡</span></span><br><span class="line">curl -X DELETE http://10.10.107.249:9091/metrics/job/curl_job/</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 2.åˆ é™¤æŒ‡å®šå·¥ä½œä»»åŠ¡åä»¥åŠæŒ‡æ ‡æ ‡ç­¾çš„æŒ‡æ ‡</span></span><br><span class="line">curl -X DELETE http://10.10.107.249:9091/metrics/job/curl_job/app/weiyigeek</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 3.å½“pushgatewayå¯åŠ¨æ—¶è®¾ç½®--web.enable-admin-apiå‚æ•°å°±å¯ä»¥ä¸€é”®æ¸…ç©ºæ‰€æœ‰æŒ‡æ ‡äº†</span></span><br><span class="line">curl -X PUT http://10.10.107.249:9091/api/v1/admin/wipe</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : æ³¨æ„åœ¨ä¸€æ¬¡æ¨é€åå¦‚æœæ‚¨ä¸è¿›è¡Œæ¸…é™¤åˆ™è¯¥ç»„ä¿¡æ¯ä¼šæ°¸è¿œçš„ä¿å­˜åœ¨Pushgatewayï¼Œåœ¨åœç”¨æŸä¸ªæ‰¹å¤„ç†ä½œä¸šæ—¶ä¸€å®šè¦æŠŠå­˜å‚¨åœ¨pushgatewayçš„æŒ‡æ ‡è¿›è¡Œæ¸…é™¤ã€‚</p>
<hr>
<h2 id="0X02-Blackbox-ä½¿ç”¨å®è·µ"><a href="#0X02-Blackbox-ä½¿ç”¨å®è·µ" class="headerlink" title="0X02 Blackbox ä½¿ç”¨å®è·µ"></a>0X02 Blackbox ä½¿ç”¨å®è·µ</h2><h3 id="1-åŸºç¡€è¯´æ˜-1"><a href="#1-åŸºç¡€è¯´æ˜-1" class="headerlink" title="1.åŸºç¡€è¯´æ˜"></a>1.åŸºç¡€è¯´æ˜</h3><p>æè¿°: æˆ‘ä»¬å¯ä»¥é€šè¿‡ Blackbox é»‘ç›’å¯¼å‡ºå™¨æ¥ç›‘æ§ç›®æ ‡<code>HTTP, HTTPS, DNS, TCP and ICMP</code>ç­‰åè®®æœåŠ¡ï¼Œä¸»è¦ç”¨äºé‚£äº›ä¸èƒ½ç›´æ¥å†åº”ç”¨å®ä¾‹ä¸­è¿è¡Œå¯¼å‡ºå™¨çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p>
<p>ä¾‹å¦‚: æˆ‘ä»¬å¯ä»¥ç›‘æ§WebæœåŠ¡æ˜¯å¦å¯ä»¥æ­£å¸¸ä¸ºç”¨æˆ·æä¾›æœåŠ¡ï¼Œé€šå¸¸æ˜¯é€šè¿‡è®¿é—®è´Ÿè½½å‡è¡¡æˆ–è€…VIPåœ°å€æ¥ç›‘æ§è¯¥æœåŠ¡ã€‚</p>
<p><strong>Blackbox exporter configuration</strong>: <a href="https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md" target="_blank" rel="noopener">https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - é€šç”¨å ä½ç¬¦å®šä¹‰å¦‚ä¸‹ï¼š</span></span><br><span class="line">  * &lt;boolean&gt;: a boolean that can take the values <span class="literal">true</span> or <span class="literal">false</span></span><br><span class="line">  * &lt;int&gt;: a regular <span class="built_in">integer</span></span><br><span class="line">  * &lt;duration&gt;: a duration matching the regular expression [0-9]+(ms|[smhdwy])</span><br><span class="line">  * &lt;filename&gt;: a valid path <span class="keyword">in</span> the current working directory</span><br><span class="line">  * &lt;string&gt;: a regular string</span><br><span class="line">  * &lt;secret&gt;: a regular string that is a secret, such as a password</span><br><span class="line">  * &lt;regex&gt;: a regular expression</span><br><span class="line"></span><br><span class="line"><span class="comment"># - exporter configuration file format</span></span><br><span class="line">Module</span><br><span class="line">  <span class="comment"># The protocol over which the probe will take place (http, tcp, dns, icmp).</span></span><br><span class="line">  prober: &lt;prober_string&gt;</span><br><span class="line">  <span class="comment"># How long the probe will wait before giving up.</span></span><br><span class="line">  [ timeout: &lt;duration&gt; ]</span><br><span class="line">  <span class="comment"># The specific probe configuration - at most one of these should be specified.</span></span><br><span class="line">  [ http: &lt;http_probe&gt; ]</span><br><span class="line">  [ tcp: &lt;tcp_probe&gt; ]</span><br><span class="line">  [ dns: &lt;dns_probe&gt; ]</span><br><span class="line">  [ icmp: &lt;icmp_probe&gt; ]</span><br></pre></td></tr></table></figure></p>
<p>å®˜æ–¹ç¤ºä¾‹: <a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml" target="_blank" rel="noopener">https://github.com/prometheus/blackbox_exporter/blob/master/example.yml</a></p>
<p><br></p>
<h3 id="2-å®è·µæ“ä½œ"><a href="#2-å®è·µæ“ä½œ" class="headerlink" title="2.å®è·µæ“ä½œ"></a>2.å®è·µæ“ä½œ</h3><ul>
<li><p>Step 1.å‡†å¤‡ BlackBox Configure yaml File åˆ†åˆ«è¿›è¡Œimcpã€Tcpã€Httpã€Httpsã€Dnsæ¢æµ‹å®è·µ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/blackbox</span><br><span class="line">tee /usr/<span class="built_in">local</span>/blackbox/blackbox.yml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">modules:</span><br><span class="line">  icmp_example:</span><br><span class="line">    prober: icmp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    icmp:</span><br><span class="line">      preferred_ip_protocol: <span class="string">"ip4"</span></span><br><span class="line"><span class="comment">#     source_ip_address: "127.0.0.1"  # å¤šå¼ ç½‘å¡æ—¶æŒ‡å®š</span></span><br><span class="line">  tcp_example:</span><br><span class="line">    prober: tcp</span><br><span class="line">    timeout: 5s</span><br><span class="line">  tcp_ssh_example: </span><br><span class="line">    prober: tcp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - expect: <span class="string">"^SSH-2.0-"</span>               <span class="comment"># éªŒè¯ç›‘æ§ç«¯æ˜¯å¦ä»¥SSHè¿›è¡Œå“åº” </span></span><br><span class="line">  tcp_tls_example:</span><br><span class="line">    prober: tcp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    tcp:</span><br><span class="line">      tls: <span class="literal">true</span></span><br><span class="line">  http_example:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      valid_http_versions: [<span class="string">"HTTP/1.1"</span>, <span class="string">"HTTP/2.0"</span>]</span><br><span class="line">      valid_status_codes: []  <span class="comment"># Defaults to 2xx</span></span><br><span class="line">      method: GET</span><br><span class="line">      headers:</span><br><span class="line">        User-Agent: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0"</span></span><br><span class="line">      <span class="comment"># å¦‚æœå­˜åœ¨SSLï¼Œåˆ™æ¢æµ‹å¤±è´¥ã€‚</span></span><br><span class="line">      fail_if_ssl: <span class="literal">false</span></span><br><span class="line">      tls_config:</span><br><span class="line">        insecure_skip_verify: <span class="literal">false</span></span><br><span class="line">      preferred_ip_protocol: <span class="string">"ip4"</span> <span class="comment"># defaults to "ip6"</span></span><br><span class="line">  https_example:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      valid_http_versions: [<span class="string">"HTTP/1.1"</span>, <span class="string">"HTTP/2.0"</span>]</span><br><span class="line">      valid_status_codes: []  <span class="comment"># Defaults to 2xx</span></span><br><span class="line">      method: GET</span><br><span class="line">      headers:</span><br><span class="line">        User-Agent: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0"</span></span><br><span class="line">      <span class="comment"># å¦‚æœä¸å­˜åœ¨SSLï¼Œåˆ™æ¢æµ‹å¤±è´¥ã€‚</span></span><br><span class="line">      fail_if_not_ssl: <span class="literal">false</span> </span><br><span class="line">      tls_config:</span><br><span class="line">        insecure_skip_verify: <span class="literal">false</span></span><br><span class="line">      preferred_ip_protocol: <span class="string">"ip4"</span> <span class="comment"># defaults to "ip6"</span></span><br><span class="line">      ip_protocol_fallback: <span class="literal">false</span>  <span class="comment"># no fallback to "ip6"</span></span><br><span class="line">  dns_example:</span><br><span class="line">    prober: dns</span><br><span class="line">    dns:</span><br><span class="line">      query_name: <span class="string">"www.weiyigeek.top"</span></span><br><span class="line">      query_type: <span class="string">"A"</span></span><br><span class="line">      valid_rcodes:</span><br><span class="line">      - NOERROR</span><br><span class="line">  dns_tcp_example:</span><br><span class="line">    prober: dns</span><br><span class="line">    dns:</span><br><span class="line">      transport_protocol: <span class="string">"tcp"</span>    <span class="comment"># defaults to "udp"</span></span><br><span class="line">      preferred_ip_protocol: <span class="string">"ip4"</span> <span class="comment"># defaults to "ip6"</span></span><br><span class="line">      query_name: <span class="string">"www.prometheus.io"</span></span><br><span class="line">  dns_mx_example:</span><br><span class="line">    prober: dns</span><br><span class="line">    dns:</span><br><span class="line">      query_name: <span class="string">"weiyigeek.top"</span></span><br><span class="line">      query_type: <span class="string">"MX"</span></span><br><span class="line">      validate_answer_rrs:</span><br><span class="line">        fail_if_not_matches_regexp:</span><br><span class="line">        - <span class="string">".+"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.æˆ‘ä»¬é‡‡ç”¨ Docker å®¹å™¨å¯åŠ¨ BlackBox Exporter æ–¹ä¾¿æµ‹è¯•ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -d -p 9115:9115 --name blackbox_exporter -v /usr/<span class="built_in">local</span>/blackbox:/config prom/blackbox-exporter:master --config.file=/config/blackbox.yml</span><br><span class="line">d571d7587a031d01fabd82c780d8bb90bba4c88a06834e5e8b6f081a99442db9</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210704232101.png" target="_blank" title="WeiyiGeek.BlackBox Exporter" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210704232101.png" alt="WeiyiGeek.BlackBox Exporter" title="" class=""></a>
                <p>WeiyiGeek.BlackBox Exporter</p>
            </figure>
<ul>
<li>Step 3.imcpæ¨¡å—ä¹‹ç›‘æ§ç›®æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®<code>http://weiyigeek.top:9115/probe?target=223.6.6.6&amp;module=icmp_example</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - ç»“æœè¯´æ˜</span></span><br><span class="line"><span class="comment"># HELP probe_dns_lookup_time_seconds Returns the time taken for probe dns lookup in seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_dns_lookup_time_seconds gauge</span></span><br><span class="line">probe_dns_lookup_time_seconds 2.5798e-05</span><br><span class="line"><span class="comment"># HELP probe_duration_seconds Returns how long the probe took to complete in seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_duration_seconds gauge</span></span><br><span class="line">probe_duration_seconds 0.006506971  <span class="comment"># æ•´ä¸ªæ¢æµ‹èŠ±è´¹æ—¶é—´åŒ…æ‹¬DNSè§£ææ—¶é—´</span></span><br><span class="line"><span class="comment"># HELP probe_icmp_duration_seconds Duration of icmp request by phase</span></span><br><span class="line"><span class="comment"># TYPE probe_icmp_duration_seconds gauge</span></span><br><span class="line">probe_icmp_duration_seconds&#123;phase=<span class="string">"resolve"</span>&#125; 2.5798e-05  </span><br><span class="line">probe_icmp_duration_seconds&#123;phase=<span class="string">"rtt"</span>&#125; 0.00625726</span><br><span class="line">probe_icmp_duration_seconds&#123;phase=<span class="string">"setup"</span>&#125; 0.000126281</span><br><span class="line"><span class="comment"># HELP probe_icmp_reply_hop_limit Replied packet hop limit (TTL for ipv4)</span></span><br><span class="line"><span class="comment"># TYPE probe_icmp_reply_hop_limit gauge</span></span><br><span class="line">probe_icmp_reply_hop_limit 113</span><br><span class="line"><span class="comment"># HELP probe_ip_addr_hash Specifies the hash of IP address. It's useful to detect if the IP address changes.</span></span><br><span class="line"><span class="comment"># TYPE probe_ip_addr_hash gauge</span></span><br><span class="line">probe_ip_addr_hash 2.372708602e+09  <span class="comment"># ç›‘æµ‹ç›®æ ‡åœ°å€Hash</span></span><br><span class="line"><span class="comment"># HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6</span></span><br><span class="line"><span class="comment"># TYPE probe_ip_protocol gauge</span></span><br><span class="line">probe_ip_protocol 4  <span class="comment"># ä½¿ç”¨IPåè®®ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># HELP probe_success Displays whether or not the probe was a success</span></span><br><span class="line"><span class="comment"># TYPE probe_success gauge</span></span><br><span class="line">probe_success 1      <span class="comment"># æˆåŠŸè¿”å›1ï¼Œå¦åˆ™è¿”å›0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : Target ä¹Ÿå¯ä»¥ä¸ºåŸŸåå½¢å¼ <code>/probe?module=icmp_example&amp;target=www.weiyigeek.top</code> è¿”å›æŒ‡æ ‡ä¹Ÿæ˜¯ä¸€æ ·ã€‚</p>
<p><br></p>
<ul>
<li>Step 4.tcpæ¨¡å—ä¹‹ç›‘æ§ç›®æ ‡æ¢æµ‹</li>
</ul>
<p>TCP å¸¸è§„ç«¯å£æ¢æµ‹: /probe?module=tcp_example&amp;target=192.168.12.185:80<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TYPE probe_failed_due_to_regex gauge</span></span><br><span class="line">probe_failed_due_to_regex 0</span><br><span class="line"><span class="comment"># TYPE probe_success gauge</span></span><br><span class="line">probe_success 1   <span class="comment"># æˆåŠŸ</span></span><br></pre></td></tr></table></figure></p>
<p>TCP SSH ç«¯å£æ¢æµ‹ï¼ˆæŒ‡å®šåŒ¹é…è§„åˆ™ï¼‰: /probe?module=tcp_ssh_example&amp;target=10.20.172.248:22<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6</span></span><br><span class="line"><span class="comment"># TYPE probe_ip_protocol gauge</span></span><br><span class="line">probe_ip_protocol 4</span><br><span class="line"><span class="comment"># HELP probe_success Displays whether or not the probe was a success</span></span><br><span class="line"><span class="comment"># TYPE probe_success gauge</span></span><br><span class="line">probe_success 1   <span class="comment"># åŒ¹é…æˆåŠŸ</span></span><br></pre></td></tr></table></figure></p>
<p>TCP SSL ç«¯å£æ¢æµ‹: /probe?module=tcp_tls_example&amp;target=<a href="http://www.baidu.com:443" target="_blank" rel="noopener">www.baidu.com:443</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP probe_ssl_earliest_cert_expiry Returns earliest SSL cert expiry date</span></span><br><span class="line"><span class="comment"># TYPE probe_ssl_earliest_cert_expiry gauge</span></span><br><span class="line">probe_ssl_earliest_cert_expiry 1.627277462e+09   <span class="comment"># TLS/SSLè¯ä¹¦åˆ°æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment"># HELP probe_ssl_last_chain_expiry_timestamp_seconds Returns last SSL chain expiry in unixtime</span></span><br><span class="line"><span class="comment"># TYPE probe_ssl_last_chain_expiry_timestamp_seconds gauge</span></span><br><span class="line">probe_ssl_last_chain_expiry_timestamp_seconds 1.627277462e+09    <span class="comment"># è¿”å›unixtimeä¸­æœ€åä¸€ä¸ªSSLé“¾åˆ°æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment"># HELP probe_ssl_last_chain_info Contains SSL leaf certificate information</span></span><br><span class="line"><span class="comment"># TYPE probe_ssl_last_chain_info gauge</span></span><br><span class="line">probe_ssl_last_chain_info&#123;fingerprint_sha256=<span class="string">"2ed189349f818f3414132ebea309e36f620d78a0507a2fa523305f275062d73c"</span>&#125; 1  <span class="comment"># è¯ä¹¦é“¾ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># HELP probe_success Displays whether or not the probe was a success</span></span><br><span class="line"><span class="comment"># TYPE probe_success gauge</span></span><br><span class="line">probe_success 1   <span class="comment"># æˆåŠŸæ ‡å¿—</span></span><br><span class="line"><span class="comment"># HELP probe_tls_version_info Returns the TLS version used, or NaN when unknown</span></span><br><span class="line"><span class="comment"># TYPE probe_tls_version_info gauge</span></span><br><span class="line">probe_tls_version_info&#123;version=<span class="string">"TLS 1.2"</span>&#125; 1  <span class="comment"># è¯ä¹¦ç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>Step 5.httpæ¨¡æ¿ä¹‹ç›‘æ§ç›®æ ‡æ¢æµ‹åŒ…æ‹¬httpåè®®å’Œhttpsåè®®<br>http åè®®: /probe?module=http_example&amp;target=blog.weiyigeek.top<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP probe_dns_lookup_time_seconds Returns the time taken for probe dns lookup in seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_dns_lookup_time_seconds gauge</span></span><br><span class="line">probe_dns_lookup_time_seconds 0.186725698</span><br><span class="line"><span class="comment"># HELP probe_failed_due_to_regex Indicates if probe failed due to regex</span></span><br><span class="line"><span class="comment"># TYPE probe_failed_due_to_regex gauge</span></span><br><span class="line">probe_failed_due_to_regex 0</span><br><span class="line"><span class="comment"># HELP probe_http_content_length Length of http content response</span></span><br><span class="line"><span class="comment"># TYPE probe_http_content_length gauge</span></span><br><span class="line">probe_http_content_length -1</span><br><span class="line"><span class="comment"># HELP probe_duration_seconds Returns how long the probe took to complete in seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_duration_seconds gauge</span></span><br><span class="line">probe_duration_seconds 2.142812294</span><br><span class="line"><span class="comment"># HELP probe_http_duration_seconds Duration of http request by phase, summed over all redirects</span></span><br><span class="line"><span class="comment"># TYPE probe_http_duration_seconds gauge</span></span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"connect"</span>&#125; 1.209361663</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"processing"</span>&#125; 0.250921647</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"resolve"</span>&#125; 0.186725698</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"tls"</span>&#125; 0</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"transfer"</span>&#125; 0.495566665</span><br><span class="line"><span class="comment"># HELP probe_http_redirects The number of redirects</span></span><br><span class="line"><span class="comment"># TYPE probe_http_redirects gauge</span></span><br><span class="line">probe_http_redirects 0</span><br><span class="line"><span class="comment"># HELP probe_http_ssl Indicates if SSL was used for the final redirect</span></span><br><span class="line"><span class="comment"># TYPE probe_http_ssl gauge</span></span><br><span class="line">probe_http_ssl 0</span><br><span class="line"><span class="comment"># HELP probe_http_status_code Response HTTP status code</span></span><br><span class="line"><span class="comment"># TYPE probe_http_status_code gauge</span></span><br><span class="line">probe_http_status_code 200</span><br><span class="line"><span class="comment"># HELP probe_http_uncompressed_body_length Length of uncompressed response body</span></span><br><span class="line"><span class="comment"># TYPE probe_http_uncompressed_body_length gauge</span></span><br><span class="line">probe_http_uncompressed_body_length 22279</span><br><span class="line"><span class="comment"># HELP probe_http_version Returns the version of HTTP of the probe response</span></span><br><span class="line"><span class="comment"># TYPE probe_http_version gauge</span></span><br><span class="line">probe_http_version 1.1  <span class="comment"># HTTP åè®®ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># HELP probe_ip_addr_hash Specifies the hash of IP address. It's useful to detect if the IP address changes.</span></span><br><span class="line"><span class="comment"># TYPE probe_ip_addr_hash gauge</span></span><br><span class="line">probe_ip_addr_hash 2.341618423e+09</span><br><span class="line"><span class="comment"># HELP probe_ip_protocol Specifies whether probe ip protocol is IP4 or IP6</span></span><br><span class="line"><span class="comment"># TYPE probe_ip_protocol gauge</span></span><br><span class="line">probe_ip_protocol 4</span><br><span class="line"><span class="comment"># HELP probe_success Displays whether or not the probe was a success</span></span><br><span class="line"><span class="comment"># TYPE probe_success gauge</span></span><br><span class="line">probe_success 1          <span class="comment"># æ¢æµ‹ç»“æœ</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>https åè®®: /probe?target=prometheus.io&amp;module=https_example<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP probe_duration_seconds Returns how long the probe took to complete in seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_duration_seconds gauge</span></span><br><span class="line">probe_duration_seconds 3.301450584</span><br><span class="line"><span class="comment"># HELP probe_http_duration_seconds Duration of http request by phase, summed over all redirects</span></span><br><span class="line"><span class="comment"># TYPE probe_http_duration_seconds gauge</span></span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"connect"</span>&#125; 0.35759203100000003</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"processing"</span>&#125; 0.39931457400000003</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"resolve"</span>&#125; 2.334050778</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"tls"</span>&#125; 0.196995271</span><br><span class="line">probe_http_duration_seconds&#123;phase=<span class="string">"transfer"</span>&#125; 0.012739035</span><br><span class="line"><span class="comment"># HELP probe_http_redirects The number of redirects</span></span><br><span class="line"><span class="comment"># TYPE probe_http_redirects gauge</span></span><br><span class="line">probe_http_redirects 1</span><br><span class="line"><span class="comment"># HELP probe_http_ssl Indicates if SSL was used for the final redirect</span></span><br><span class="line"><span class="comment"># TYPE probe_http_ssl gauge</span></span><br><span class="line">probe_http_ssl 1</span><br><span class="line"><span class="comment"># HELP probe_http_status_code Response HTTP status code</span></span><br><span class="line"><span class="comment"># TYPE probe_http_status_code gauge</span></span><br><span class="line">probe_http_status_code 200</span><br><span class="line"><span class="comment"># HELP probe_http_uncompressed_body_length Length of uncompressed response body</span></span><br><span class="line"><span class="comment"># TYPE probe_http_uncompressed_body_length gauge</span></span><br><span class="line">probe_http_uncompressed_body_length 16377</span><br><span class="line"><span class="comment"># HELP probe_http_version Returns the version of HTTP of the probe response</span></span><br><span class="line"><span class="comment"># TYPE probe_http_version gauge</span></span><br><span class="line">probe_http_version 2</span><br><span class="line"><span class="comment"># HELP probe_ssl_earliest_cert_expiry Returns earliest SSL cert expiry in unixtime</span></span><br><span class="line"><span class="comment"># TYPE probe_ssl_earliest_cert_expiry gauge</span></span><br><span class="line">probe_ssl_earliest_cert_expiry 1.628424e+09</span><br><span class="line"><span class="comment"># HELP probe_ssl_last_chain_expiry_timestamp_seconds Returns last SSL chain expiry in timestamp seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_ssl_last_chain_expiry_timestamp_seconds gauge</span></span><br><span class="line">probe_ssl_last_chain_expiry_timestamp_seconds 1.628424e+09</span><br><span class="line"><span class="comment"># HELP probe_ssl_last_chain_info Contains SSL leaf certificate information</span></span><br><span class="line"><span class="comment"># TYPE probe_ssl_last_chain_info gauge</span></span><br><span class="line">probe_ssl_last_chain_info&#123;fingerprint_sha256=<span class="string">"44c9e62838db98e79918c841e4b72529849e2e7e6654e337a32a74ec502edaa7"</span>&#125; 1</span><br><span class="line"><span class="comment"># HELP probe_success Displays whether or not the probe was a success</span></span><br><span class="line"><span class="comment"># TYPE probe_success gauge</span></span><br><span class="line">probe_success 1</span><br><span class="line"><span class="comment"># HELP probe_tls_version_info Contains the TLS version used</span></span><br><span class="line"><span class="comment"># TYPE probe_tls_version_info gauge</span></span><br><span class="line">probe_tls_version_info&#123;version=<span class="string">"TLS 1.3"</span>&#125; 1</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Step 6.dnsæ¨¡æ¿ä¹‹æ£€æµ‹ç›®æ ‡Aè®°å½•ï¼Œä»¥åŠæµ‹è¯•DNSæœåŠ¡å™¨æ˜¯å¦å¯é€šè¿‡TCPè¿›è¡Œå“åº”ã€‚(æ³¨æ„DNSé€šå¸¸ä½¿ç”¨UDP)</li>
</ul>
<p>Aè®°å½•è§£ææ¢æµ‹: /probe?module=dns_example&amp;target=8.8.8.8<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP probe_dns_additional_rrs Returns number of entries in the additional resource record list</span></span><br><span class="line"><span class="comment"># TYPE probe_dns_additional_rrs gauge</span></span><br><span class="line">probe_dns_additional_rrs 0      <span class="comment"># è¿”å›é™„åŠ èµ„æºè®°å½•åˆ—è¡¨ä¸­çš„æ¡ç›®æ•°</span></span><br><span class="line"><span class="comment"># HELP probe_dns_answer_rrs Returns number of entries in the answer resource record list</span></span><br><span class="line"><span class="comment"># TYPE probe_dns_answer_rrs gauge</span></span><br><span class="line">probe_dns_answer_rrs 2            <span class="comment"># DNS å›ç­”å“åº”æ¡ç›®</span></span><br><span class="line"><span class="comment"># HELP probe_dns_authority_rrs Returns number of entries in the authority resource record list</span></span><br><span class="line"><span class="comment"># TYPE probe_dns_authority_rrs gauge</span></span><br><span class="line">probe_dns_authority_rrs 0        <span class="comment"># è¿”å›æƒé™èµ„æºè®°å½•åˆ—è¡¨ä¸­çš„æ¡ç›®æ•°</span></span><br><span class="line"><span class="comment"># HELP probe_dns_duration_seconds Duration of DNS request by phase</span></span><br><span class="line"><span class="comment"># TYPE probe_dns_duration_seconds gauge</span></span><br><span class="line">probe_dns_duration_seconds&#123;phase=<span class="string">"connect"</span>&#125; 7.9269e-05</span><br><span class="line">probe_dns_duration_seconds&#123;phase=<span class="string">"request"</span>&#125; 0.072951973</span><br><span class="line">probe_dns_duration_seconds&#123;phase=<span class="string">"resolve"</span>&#125; 2.9612e-05</span><br><span class="line"><span class="comment"># HELP probe_dns_lookup_time_seconds Returns the time taken for probe dns lookup in seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_dns_lookup_time_seconds gauge</span></span><br><span class="line">probe_dns_lookup_time_seconds 2.9612e-05  <span class="comment"># è¿”å›æ¢æµ‹dnsæŸ¥æ‰¾æ‰€ç”¨çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰</span></span><br><span class="line"><span class="comment"># HELP probe_duration_seconds Returns how long the probe took to complete in seconds</span></span><br><span class="line"><span class="comment"># TYPE probe_duration_seconds gauge</span></span><br><span class="line">probe_duration_seconds 0.073247895   <span class="comment"># è¿”å›ä»¥ç§’ä¸ºå•ä½å®Œæˆæ¢æµ‹æ‰€ç”¨çš„æ—¶é—´</span></span><br><span class="line"><span class="comment"># HELP probe_success Displays whether or not the probe was a success</span></span><br><span class="line"><span class="comment"># TYPE probe_success gauge</span></span><br><span class="line">probe_success 1</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>DNCä»¥TCPå“åº”æ¢æµ‹è®°å½•: /probe?module=dns_tcp_example&amp;target=8.8.8.8<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP probe_dns_answer_rrs Returns number of entries in the answer resource record list</span></span><br><span class="line">probe_dns_answer_rrs 1</span><br><span class="line"><span class="comment"># HELP probe_success Displays whether or not the probe was a success</span></span><br><span class="line">probe_success 1</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>DNSæ¢æµ‹å™¨æ£€æŸ¥MXè®°å½•æ˜¯å¦å·²æ¶ˆå¤±: /probe?module=dns_mx_example&amp;target=223.6.6.6<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">probe_dns_answer_rrs 2</span><br><span class="line">probe_success 1</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210704234931.png" target="_blank" title="WeiyiGeek.DNSæ¢æµ‹å™¨æ£€æŸ¥MXè®°å½•" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210704234931.png" alt="WeiyiGeek.DNSæ¢æµ‹å™¨æ£€æŸ¥MXè®°å½•" title="" class=""></a>
                <p>WeiyiGeek.DNSæ¢æµ‹å™¨æ£€æŸ¥MXè®°å½•</p>
            </figure></p>
<ul>
<li>Step 7.é‡‡ç”¨PrometheusæŠ“å–Blackboxç›¸åº”æ¨¡å—ä¸å¯¹åº”targetå‚æ•°çš„æŒ‡æ ‡å€¼,ä¿®æ”¹yamlé…ç½®æ–‡ä»¶åé‡æ–°Prometheus_serverå³å¯åœ¨targetæŸ¥çœ‹ç›‘æ§çš„ç«™ç‚¹ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus.yml</span></span><br><span class="line">- job_name: <span class="string">'blackbox'</span></span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  params:</span><br><span class="line">    module: [https_example]  <span class="comment"># Look for a HTTP 200 response.</span></span><br><span class="line">  static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - http://weiyigeek.top    <span class="comment"># Target to probe with http.</span></span><br><span class="line">      - https://prometheus.io   <span class="comment"># Target to probe with https.</span></span><br><span class="line">  relabel_configs:</span><br><span class="line">    - source_labels: [__address__]</span><br><span class="line">      target_label: __param_target</span><br><span class="line">    - source_labels: [__param_target]</span><br><span class="line">      target_label: instance</span><br><span class="line">    - target_label: __address__</span><br><span class="line">      replacement: 192.168.12.107:9115  <span class="comment"># The blackbox exporter's real hostname:port.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>è¡¥å……è¯´æ˜: æˆ‘ä»¬å¯ä»¥å°†static_configsæ¢æˆfile_sd_configså°†ç›‘æ§ç›®æ ‡å†™åœ¨fileæ–‡ä»¶ä¸­ï¼Œè®¾ç½®æŒ‡å®šçš„æ ‡ç­¾å€¼ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - prometheus.yml</span></span><br><span class="line">  file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/conf.d/discovery/blackbox.yaml</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line"></span><br><span class="line"><span class="comment"># - blackbox.yaml</span></span><br><span class="line">- targets: [ <span class="string">'http://weiyigeek.top'</span>,<span class="string">'https://blog.weiyigeek.top'</span>]</span><br><span class="line">  labels: &#123;<span class="string">'env'</span>: <span class="string">'prod'</span>, <span class="string">'appname'</span>: <span class="string">'mySite'</span>, <span class="string">'label'</span>: <span class="string">'blog'</span>&#125;</span><br><span class="line">- targets: [ <span class="string">'https://prometheus.io'</span>]</span><br><span class="line">  labels: &#123;<span class="string">'env'</span>: <span class="string">'test'</span>, <span class="string">'appname'</span>: <span class="string">'prometheuså®˜ç½‘'</span>, <span class="string">'label'</span>: <span class="string">'officialwebiste'</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>Tips : æˆ‘ä»¬åœ¨Prometheusé…ç½®çš„Blackboxå¯¼å‡ºå™¨çš„stateå€¼ä¸ºUPå¹¶ä¸æ„å‘³ç€å…¶æ¢æµ‹æˆåŠŸï¼Œåªæ˜¯è¡¨ç¤ºæŠ“å–æˆåŠŸä½ éœ€è¦æ£€æŸ¥probe_successæ˜¯å¦ä¸º1ï¼Œå…¶PromQLè¯­æ³•ä¸º<code>probe_success{env=&quot;prod&quot;}</code>ã€‚</p>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705212749.png" target="_blank" title="WeiyiGeek.Blackbox" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705212749.png" alt="WeiyiGeek.Blackbox" title="" class=""></a>
                <p>WeiyiGeek.Blackbox</p>
            </figure>
<ul>
<li>Step 8.Prometheus ä¸­ Alertmanager è­¦æŠ¥è§„åˆ™ç¼–å†™å¹¶éªŒè¯æŠ¥è­¦ä¿¡æ¯ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: normal</span><br><span class="line">  rules:</span><br><span class="line">  - alert: web_request</span><br><span class="line">    expr: probe_success == 0</span><br><span class="line">    <span class="keyword">for</span>: 30s</span><br><span class="line">    labels:</span><br><span class="line">      severity: <span class="string">'critical'</span></span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">"ç«™ç‚¹ [ &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; ] , åº”ç”¨åç§°: &#123;&#123; <span class="variable">$labels</span>.appname &#125;&#125;, æ ‡ç­¾æ¥è‡ª: &#123;&#123; <span class="variable">$labels</span>.label&#125;&#125;"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705221356.png" target="_blank" title="WeiyiGeek.Blackbox&Alertmanager" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705221356.png" alt="WeiyiGeek.Blackbox&Alertmanager" title="" class=""></a>
                <p>WeiyiGeek.Blackbox&Alertmanager</p>
            </figure>
<p>Tips: Prometheus æ¯æ¬¡æŠ“å–çš„æ—¶å€™å‘é€ä¸€ä¸ªåä¸ºX-Prometheus-Scrape-Timeout-Secondsçš„HTTPè¯·æ±‚å¤´ï¼ŒBlackboxä½¿ç”¨å®ƒæ¥è®¾ç½®è¶…æ—¶è€Œä¸æ˜¯ç¼“å†²åŒºã€‚</p>
<p><br></p>
<h3 id="3-åˆ©ç”¨Prometheuså®ç°å¤–ç½‘ç½‘å…³åŠç½‘ç«™çŠ¶æ€ç›‘æµ‹-ä¼ä¸šå®æˆ˜"><a href="#3-åˆ©ç”¨Prometheuså®ç°å¤–ç½‘ç½‘å…³åŠç½‘ç«™çŠ¶æ€ç›‘æµ‹-ä¼ä¸šå®æˆ˜" class="headerlink" title="3.åˆ©ç”¨Prometheuså®ç°å¤–ç½‘ç½‘å…³åŠç½‘ç«™çŠ¶æ€ç›‘æµ‹(ä¼ä¸šå®æˆ˜)"></a>3.åˆ©ç”¨Prometheuså®ç°å¤–ç½‘ç½‘å…³åŠç½‘ç«™çŠ¶æ€ç›‘æµ‹(ä¼ä¸šå®æˆ˜)</h3><p>æè¿°: æœ‰äº†ä¸Šé¢çš„BlockboxåŸºç¡€å­¦ä¹ å®è·µï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä¸Šæ‰‹ã€‚</p>
<ul>
<li>Step 1.æ­¤å¤„é‡‡ç”¨ Blackbox_exporter äºŒè¿›åˆ¶ï¼ˆ<code>0.19.0 / 2021-05-10</code>ï¼‰æŒ‰å®‰è£…æ–¹å¼è¿›è¡Œè®¾ç½®ï¼Œä¸‹è½½åœ°å€: <a href="https://github.com/prometheus/blackbox_exporter/releases" target="_blank" rel="noopener">https://github.com/prometheus/blackbox_exporter/releases</a> ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blackbox_exporter ä¸‹è½½</span></span><br><span class="line">wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.19.0/blackbox_exporter-0.19.0.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf blackbox_exporter-0.19.0.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">mv /usr/<span class="built_in">local</span>/blackbox_exporter-0.19.0.linux-amd64   /usr/<span class="built_in">local</span>/blackbox_exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç‰ˆæœ¬ä¿¡æ¯æŸ¥çœ‹</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/blackbox_exporter</span><br><span class="line">./blackbox_exporter --version</span><br><span class="line">blackbox_exporter, version 0.19.0 (branch: HEAD, revision: 5d575b88eb12c65720862e8ad2c5890ba33d1ed0)</span><br><span class="line">  build user:       root@2b0258d5a55a</span><br><span class="line">  build date:       20210510-12:56:44</span><br><span class="line">  go version:       go1.16.4</span><br><span class="line">  platform:         linux/amd6</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 2.æŸ¥çœ‹é»˜è®¤çš„ BlackBox Configure yaml File æ–‡ä»¶.å¹¶æŒ‰ç…§éœ€è¦çš„æ·»åŠ å¯¹è±¡ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ ls /usr/<span class="built_in">local</span>/blackbox_exporter &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/blackbox_exporter</span><br><span class="line">blackbox_exporter  blackbox.yml  LICENSE  NOTICE</span><br><span class="line"></span><br><span class="line"><span class="comment"># - ä¿®æ”¹å¹¶æ·»åŠ è‡ªå®šä¹‰çš„å¯¹è±¡åçš„BlackBox.yml.</span></span><br><span class="line">$ tee /usr/<span class="built_in">local</span>/blackbox_exporter/blackbox.yml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">modules:</span><br><span class="line">  icmp:</span><br><span class="line">    prober: icmp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    icmp:</span><br><span class="line">      preferred_ip_protocol: <span class="string">"ip4"</span></span><br><span class="line">  tcp:</span><br><span class="line">    prober: tcp</span><br><span class="line">    timeout: 5s</span><br><span class="line">  tcp_tls:</span><br><span class="line">    prober: tcp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    tcp:</span><br><span class="line">      tls: <span class="literal">true</span></span><br><span class="line">  http_2xx:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      valid_http_versions: [<span class="string">"HTTP/1.1"</span>, <span class="string">"HTTP/2.0"</span>]</span><br><span class="line">      valid_status_codes: []      <span class="comment"># Defaults to 2xx</span></span><br><span class="line">      method: GET</span><br><span class="line">      headers:</span><br><span class="line">        User-Agent: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0"</span></span><br><span class="line">      tls_config:</span><br><span class="line">        insecure_skip_verify: <span class="literal">false</span></span><br><span class="line">      preferred_ip_protocol: <span class="string">"ip4"</span> <span class="comment"># Defaults to "ip6"</span></span><br><span class="line">  http_post:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      valid_http_versions: [<span class="string">"HTTP/1.1"</span>, <span class="string">"HTTP/2.0"</span>]</span><br><span class="line">      valid_status_codes: []       <span class="comment"># Defaults to 2xx</span></span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        User-Agent: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0"</span></span><br><span class="line">        Content-Type: application/json</span><br><span class="line">      body: <span class="string">'&#123;&#125;'</span></span><br><span class="line">      fail_if_not_ssl: <span class="literal">false</span> </span><br><span class="line">      tls_config:</span><br><span class="line">        insecure_skip_verify: <span class="literal">false</span></span><br><span class="line">      preferred_ip_protocol: <span class="string">"ip4"</span> <span class="comment"># defaults to "ip6"</span></span><br><span class="line">      ip_protocol_fallback: <span class="literal">false</span>  <span class="comment"># no fallback to "ip6"</span></span><br><span class="line">  http_basic_auth_example:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Host: <span class="string">"login.example.com"</span></span><br><span class="line">      basic_auth:</span><br><span class="line">        username: <span class="string">"username"</span></span><br><span class="line">        password: <span class="string">"mysecret"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 3.åˆ›å»ºblackbox_exporterçš„systemdæœåŠ¡ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo tee /usr/lib/systemd/system/blackbox_exporter.service &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=blackbox_exporter</span><br><span class="line">Documentation=https://prometheus.io</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">StandardError=journal</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/blackbox_exporter/blackbox_exporter --config.file=/usr/<span class="built_in">local</span>/blackbox_exporter/blackbox.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=3s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 4.å¯åŠ¨å¹¶åŠ å…¥å¼€æœºå¯åŠ¨æœåŠ¡åºåˆ—ï¼Œå¹¶å¯¹æœåŠ¡å’Œç«¯å£è¿è¡ŒçŠ¶æ€è¿›è¡ŒéªŒè¯ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - è‡ªåŠ¨é‡å¯</span></span><br><span class="line">sudo systemctl daemon-reload &amp;&amp; systemctl restart blackbox_exporter.service</span><br><span class="line">systemctl status blackbox_exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># - ç›‘å¬è¿›ç¨‹æŸ¥çœ‹</span></span><br><span class="line">ss -lnpt | grep 9115</span><br><span class="line">  <span class="comment"># LISTEN     0      128       [::]:9115                  [::]:*                   users:(("blackbox_export",pid=1738,fd=3))</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 5.åœ¨Prometheusé…ç½®æ–‡ä»¶åŠ å…¥blackbox_exporterï¼Œä¸‹é¢æˆ‘ä»¬ç¼–è¾‘prometheusé…ç½®æ–‡ä»¶æ¥ç›‘æµ‹å¤–ç½‘ç½‘å…³å­˜æ´»çŠ¶æ€ã€‚<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vi</span> <span class="string">/usr/local/prometheus/prometheus.yml</span></span><br><span class="line"><span class="comment"># - åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¤–ç½‘ç½‘å…³å­˜æ´»çŠ¶æ€çš„jobä¿¡æ¯</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'ICMP-Ping'</span></span><br><span class="line"><span class="attr">    scrape_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">    metrics_path:</span> <span class="string">/probe</span></span><br><span class="line"><span class="attr">    params:</span></span><br><span class="line"><span class="attr">      module:</span> <span class="string">[icmp]</span></span><br><span class="line"><span class="attr">    file_sd_configs:</span></span><br><span class="line"><span class="attr">    - refresh_interval:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">      files:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/etc/prometheus/backbox_icmp.yml</span></span><br><span class="line"><span class="attr">    relabel_configs:</span></span><br><span class="line"><span class="attr">    - source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line"><span class="attr">      regex:</span> <span class="string">(.*)(:80)?</span></span><br><span class="line"><span class="attr">      target_label:</span> <span class="string">__param_target</span></span><br><span class="line"><span class="attr">      replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line"><span class="attr">    - source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line"><span class="attr">      regex:</span> <span class="string">(.*)</span></span><br><span class="line"><span class="attr">      target_label:</span> <span class="string">ping</span></span><br><span class="line"><span class="attr">      replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line"><span class="attr">    - source_labels:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">      regex:</span> <span class="string">.*</span></span><br><span class="line"><span class="attr">      target_label:</span> <span class="string">__address__</span></span><br><span class="line"><span class="attr">      replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'HTTP-Check'</span></span><br><span class="line"><span class="attr">    scrape_interval:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">    metrics_path:</span> <span class="string">/probe</span></span><br><span class="line"><span class="attr">    params:</span></span><br><span class="line"><span class="attr">      module:</span> <span class="string">[http_2xx]</span></span><br><span class="line"><span class="attr">    file_sd_configs:</span></span><br><span class="line"><span class="attr">    - refresh_interval:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">      files:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/etc/prometheus/backbox_http.yml</span></span><br><span class="line"><span class="attr">    relabel_configs:</span></span><br><span class="line"><span class="attr">    - source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line"><span class="attr">      regex:</span> <span class="string">(.*)(:80)?</span></span><br><span class="line"><span class="attr">      target_label:</span> <span class="string">__param_target</span></span><br><span class="line"><span class="attr">      replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line"><span class="attr">    - source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line"><span class="attr">      regex:</span> <span class="string">(.*)</span></span><br><span class="line"><span class="attr">      target_label:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line"><span class="attr">    - source_labels:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">      regex:</span> <span class="string">.*</span></span><br><span class="line"><span class="attr">      target_label:</span> <span class="string">__address__</span></span><br><span class="line"><span class="attr">      replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9115</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ æ–‡ä»¶çš„å½¢å¼ è¿›è¡Œç›®æ ‡å‘ç°ã€‚</span></span><br><span class="line"><span class="comment"># icmp åè®®ç›‘æ§ç›®æ ‡å¯¹è±¡è®¾ç½®ä»¥åŠå…¶æ ‡ç­¾è®¾ç½®</span></span><br><span class="line"><span class="string">tee</span> <span class="string">/etc/prometheus/backbox_icmp.yml</span> <span class="string">&lt;&lt;'EOF'</span></span><br><span class="line"><span class="attr">- targets:</span> <span class="string">[</span> <span class="string">'183.230.37.209'</span><span class="string">,'117.59.89.218']</span></span><br><span class="line"><span class="attr">  labels:</span> <span class="string">&#123;'env':</span> <span class="string">'prod'</span><span class="string">,'BusinessType':</span> <span class="string">'Gateway'</span><span class="string">,'site':'www.weiyigeek.top','msg':</span> <span class="string">'å®˜ç½‘å‡ºå£IPåœ°å€'</span><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># http åè®®ç›‘æ§ç›®æ ‡å¯¹è±¡è®¾ç½®ä»¥åŠå…¶æ ‡ç­¾è®¾ç½®</span></span><br><span class="line"><span class="string">tee</span> <span class="string">/etc/prometheus/backbox_http.yml</span> <span class="string">&lt;&lt;'EOF'</span></span><br><span class="line"><span class="attr">- targets:</span> <span class="string">[</span> <span class="string">'http://www.weiyigeek.top'</span> <span class="string">]</span></span><br><span class="line"><span class="attr">  labels:</span> <span class="string">&#123;'env':</span> <span class="string">'prod'</span><span class="string">,'BusinessType':</span> <span class="string">'Web'</span><span class="string">,'site':</span> <span class="string">'ä¸ªäººå®˜ç½‘-www.weiyigeek.top'</span><span class="string">,'msg':</span> <span class="string">'A10-Load Balance-VIP åœ°å€'</span><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 6.æˆ‘ä»¬å¯ä»¥åˆ©ç”¨promtoolå·¥å…·æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦ä¹¦å†™æ­£ç¡®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/prometheus/promtool check config /usr/<span class="built_in">local</span>/prometheus/prometheus.yml</span><br><span class="line">Checking prometheus.yml</span><br><span class="line">  SUCCESS: 2 rule files found</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œçƒ­åŠ è½½Prometheusæˆ–è€…BlackBoxã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - åŠ¨æ€é‡è½½blackboxé…ç½®</span></span><br><span class="line">curl -XPOST http://127.0.0.1:9115/-/reload</span><br><span class="line"><span class="comment"># - çƒ­åŠ è½½Prometheus</span></span><br><span class="line">curl -XPOST http://127.0.0.1:9090/-/reload</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li>Step 7.ç„¶åè®¿é—®<code>Blackbox Exporter</code>æ¥æŸ¥çœ‹éªŒè¯è¯·æ±‚ä»¥åŠåœ¨Prometheusä¸­æŸ¥çœ‹ç›‘æ§å¯¹è±¡çŠ¶æ€ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210712144034.png" target="_blank" title="WeiyiGeek.Blackbox Exporter" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210712144034.png" alt="WeiyiGeek.Blackbox Exporter" title="" class=""></a>
                <p>WeiyiGeek.Blackbox Exporter</p>
            </figure>
<p><br></p>
<ul>
<li>Step 8.æœ‰äº†Prometheusæ‹‰å–çš„æ•°æ®æˆ‘ä»¬å°±å¯ä»¥,åœ¨Grafanaæ·»åŠ blackbox_exporterç›‘æµ‹æ•°æ®, æ­¤å¤„æˆ‘ä»¬é‡‡ç”¨ <a href="https://grafana.com/grafana/dashboards/9965" target="_blank" rel="noopener">blackbox_exporter çš„ Grafana Dashbord æ¨¡æ¿</a> æ¨¡å—å®‰è£…æ–¹å¼ä¸å†ç´¯è¿°ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tips: æ­¤æ¨¡æ¿éœ€è¦ä¸‹è½½é¥¼çŠ¶å›¾æ’ä»¶ã€‚</span></span><br><span class="line">wget -nv https://grafana.com/api/plugins/grafana-piechart-panel/versions/latest/download -O /tmp/grafana-piechart-panel.zip</span><br><span class="line">grafana-cli plugins install grafana-piechart-panel</span><br><span class="line">systemctl grafana-server restart</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210712182604.png" target="_blank" title="WeiyiGeek.blackbox_exporter-Grafanaâ€”Dashbord" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210712182604.png" alt="WeiyiGeek.blackbox_exporter-Grafanaâ€”Dashbord" title="" class=""></a>
                <p>WeiyiGeek.blackbox_exporter-Grafanaâ€”Dashbord</p>
            </figure>

        </div>
        <!-- Google å¹¿å‘Š -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-03-29T05:39:03.652Z" itemprop="dateUpdated">2022-03-29 13:39:03</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Prometheus/7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/åŠŸèƒ½ç»„ä»¶/Prometheus/7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2021/4-28-578.html" target="_blank" rel="external">https://blog.weiyigeek.top/2021/4-28-578.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Prometheus/" rel="tag">Prometheus</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/4-28-578.html&title=ã€Š7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/4-28-578.html&title=ã€Š7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/4-28-578.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/4-28-578.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/4-28-578.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/4-28-579.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">8.Prometheusç›‘æ§ä¹‹æ‰€é‡é—®é¢˜è§£å†³æ€»ç»“</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/4-27-556.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">6.Prometheusç›‘æ§å…¥é—¨ä¹‹ä¼ä¸šç›‘æ§å®æˆ˜è­¦æŠ¥å‘é€</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-æµ‹æ§ä¸å®¢æˆ·ç«¯"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 æµ‹æ§ä¸å®¢æˆ·ç«¯</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.å‰è¨€ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-ç¯å¢ƒå‡†å¤‡"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.ç¯å¢ƒå‡†å¤‡</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-å¿«é€Ÿå…¥é—¨"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.å¿«é€Ÿå…¥é—¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-1-Python-å±•ç¤ºPrometheusæŒ‡æ ‡"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">3.1 Python å±•ç¤ºPrometheusæŒ‡æ ‡</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-2-Prometheus-å››ç§æ•°æ®ç±»å‹æµ‹æ§æ¼”ç¤º"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">3.2 Prometheus å››ç§æ•°æ®ç±»å‹æµ‹æ§æ¼”ç¤º</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-3-Python-Prometheus-åº“å®è·µ"><span class="post-toc-number">1.3.3.</span> <span class="post-toc-text">3.3 Python Prometheus åº“å®è·µ</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-PushGateway-ä½¿ç”¨å®è·µ"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 PushGateway ä½¿ç”¨å®è·µ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-åŸºç¡€è¯´æ˜"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.åŸºç¡€è¯´æ˜</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-å®æˆ˜é…ç½®"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.å®æˆ˜é…ç½®</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0X02-Blackbox-ä½¿ç”¨å®è·µ"><span class="post-toc-number">3.</span> <span class="post-toc-text">0X02 Blackbox ä½¿ç”¨å®è·µ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-åŸºç¡€è¯´æ˜-1"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.åŸºç¡€è¯´æ˜</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-å®è·µæ“ä½œ"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.å®è·µæ“ä½œ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-åˆ©ç”¨Prometheuså®ç°å¤–ç½‘ç½‘å…³åŠç½‘ç«™çŠ¶æ€ç›‘æµ‹-ä¼ä¸šå®æˆ˜"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.åˆ©ç”¨Prometheuså®ç°å¤–ç½‘ç½‘å…³åŠç½‘ç«™çŠ¶æ€ç›‘æµ‹(ä¼ä¸šå®æˆ˜)</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½æœ‹å‹,å¯ä»¥å…³ä¸ªæ³¨å—? â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/4-28-578.html&title=ã€Š7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/4-28-578.html&title=ã€Š7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/4-28-578.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š7.Prometheusç›‘æ§è¿›é˜¶ä¹‹è‡ªå®šä¹‰ç›‘æ§ä¸šåŠ¡åº”ç”¨ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/4-28-578.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/4-28-578.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMUlEQVR42u3a0W7DIBAEwPz/T7uvrVq7u+BEMgxPVWpjxpEucHevVzyOX+Psv8n136+5nufmgYGB8VjGcTmuF5pjzu76/fn16zilYmBgbMDIpx4LxNfXzLAxMDAw2mvGPpl5LgYGBkay3Ot58rs+GnAxMDAeyEgOscmGL0+0JXe95SyOgYHxQEaedf/832+pb2BgYDyKcZQjP8QmW8mZlfyYEwMDY2lGHuCSzeLYoqMDajIDBgbGloy8CaxdaJu2i1J7GBgYizLyFFubuG+T/m2xM9rhYmBgLMRoU//51nC+YBn9GGBgYCzNyIsB7RLzu+ZfBAYGxg6MNiyOpeHGri++AQwMjEUZbdDMw/FdxYDoLgwMjA0YedvoKxhtEi3/vMgaYmBgLMTIN2H5UpKC5dsTbRgYGEszkjDXpuTGEm35C8LAwFibce/D8uTdzWvAwMDYhjEWfMeaKtpnFb8PGBgYizLadop26WNtqcU2EQMDY2nGXVPPJPfbGf75TjAwMDZgtGEuL3/mZYYjGH+sCgMDYwPGTIKsDawzpdPTl4uBgbENow2RbRitGyaC3BoGBsbajKMceVEhLznMvCYMDIwdGGONYmNtZPmWMd8m1hgMDIzHMurE1tCD29ReG7IxMDB2YOSLK87HQ9vEwdYxDAwMjLKE2QbcvMHi9KVgYGBglC1cedhNTtjXJAwMjH0YySF2PkS2ZYa3pNswMDAeyJjq1BgqLSRlhrbwgIGBsSjjC3eAIuDS03+qAAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>