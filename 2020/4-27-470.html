<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="k8s">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                å­¦ä¹ ä¹‹è·¯
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-04-27T10:37:47.000Z" itemprop="datePublished" class="page-time">
  2020-04-27
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-04-27 18:37:47" datetime="2020-04-27T10:37:47.000Z"  itemprop="datePublished">2020-04-27</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[toc]</p>
<h2 id="0x00-å‰è¨€ç®€è¿°"><a href="#0x00-å‰è¨€ç®€è¿°" class="headerlink" title="0x00 å‰è¨€ç®€è¿°"></a>0x00 å‰è¨€ç®€è¿°</h2><p>æè¿°: ä¸ºäº†æ›´å¥½çš„å­¦ä¹ kubernetesä»¥åŠå¯¹ç…§å…¶åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¹‹ä¸‹ä½¿ç”¨çš„æ€§èƒ½ä»¥åŠå·®å¼‚è¿›è¡Œå­¦ä¹ æ‰©å®¹ï¼Œä¸‹é¢å°†ä½¿ç”¨Ubuntuè¿›è¡ŒK8sé›†ç¾¤çš„å®‰è£…ï¼›</p>
<p>è¯´æ˜: åœ¨ä¸Šä¸€ç« ä¹‹ä¸­æˆ‘ä»¬é‡‡ç”¨ <code>CentOS7 + KUbernetes 1.18.x</code>ç‰ˆæœ¬è¿›è¡Œäº†å®‰è£…æ¼”ç¤ºï¼Œæœ¬ç« å°†ä½¿ç”¨<code>Ubuntu 20.04 + Kubernetes 1.19.xç‰ˆæœ¬ + IPVS + Ansible</code>ç­‰ç»„åˆå·¥å…·è¿›è¡Œå®‰è£…æ¼”ç¤º;</p>
<p>PS : è™½ç„¶K8s 1.20ç‰ˆæœ¬å®£å¸ƒå°†åœ¨1.24ç‰ˆæœ¬ä¹‹åå°†ä¸å†ç»´æŠ¤dockershimï¼Œæ„å‘³ç€K8så°†ä¸ç›´æ¥æ”¯æŒDockerï¼Œä¸è¿‡å¤§å®¶ä¸å¿…è¿‡äºæ‹…å¿ƒã€‚</p>
<ul>
<li>ä¸€æ˜¯åœ¨1.24ç‰ˆæœ¬ä¹‹å‰æˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨Dockerï¼Œ</li>
<li>äºŒæ˜¯dockershimè‚¯å®šä¼šæœ‰äººæ¥ç›˜ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨Dockerï¼Œå½“å‰ã€2022å¹´4æœˆ18æ—¥ 09:46:03ã€‘ç°å·²å¯ä»¥ä½¿ç”¨containerdæ›¿ä»£ockershim</li>
<li>ä¸‰æ˜¯dockeråˆ¶ä½œçš„é•œåƒä»ç„¶å¯ä»¥åœ¨å…¶ä»–Runtimeç¯å¢ƒä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥å¤§å®¶ä¸å¿…è¿‡äºææ…Œã€‚</li>
</ul>
<p>Tips : ç»è¿‡æµ‹è¯•å‘ç°æœ¬æ–‡æ–¹æ³•åœ¨ docker(19.03.15 - 19.x) ä»¥åŠ kubernetes(v1.19.10) æ„å»ºé›†ç¾¤æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ã€‚</p>
<hr>
<h2 id="0x01-åŸºç¡€ç¯å¢ƒå‡†å¤‡"><a href="#0x01-åŸºç¡€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="0x01 åŸºç¡€ç¯å¢ƒå‡†å¤‡"></a>0x01 åŸºç¡€ç¯å¢ƒå‡†å¤‡</h2><p>æè¿°: æœ‰äº†<code>2-Kuberneteså…¥é—¨ä¹‹CentOSå®‰è£…éƒ¨ç½²é›†ç¾¤.md</code>çš„åŸºç¡€è¿›è¡Œå¯¹ç…§åœ¨Ubuntuä¸‹å®‰è£…K8sçš„ä¸åŒ</p>
<h3 id="1-ç¯å¢ƒè¯´æ˜"><a href="#1-ç¯å¢ƒè¯´æ˜" class="headerlink" title="1.ç¯å¢ƒè¯´æ˜"></a>1.ç¯å¢ƒè¯´æ˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­¤å¤„æ˜¯åœ¨VMwareè¿›è¡Œå®é™…çš„</span></span><br><span class="line">Ubuntu 20.04 TLS =&gt; 5.4.0-56-generic <span class="comment"># å¤šå° Ubuntu 20.04 TLS ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœº(å®‰è£…æµç¨‹è¯·è‡ªè¡Œç™¾åº¦)æ­¤å¤„å·²åšåŸºç¡€å®‰å…¨åŠ å›º(è„šæœ¬å‚è€ƒ)</span></span><br><span class="line">kubernetes 1.19.6</span><br><span class="line">  - kubectl 1.19.6</span><br><span class="line">  - kubeadm 1.19.6</span><br><span class="line">  - kubelet 1.19.6</span><br><span class="line">Docker: 19.03.14</span><br><span class="line"><span class="comment"># Master èŠ‚ç‚¹ä¸­ä¸€å°æœºå™¨å®‰è£…</span></span><br><span class="line">Ansible 2.9.6 </span><br><span class="line"><span class="comment"># å‡è®¾æ‚¨æ‰€æœ‰èŠ‚ç‚¹éƒ½ä»¥åšå®‰å…¨åŠ å›º(SSHç«¯å£ä¿®æ”¹ä¸º20211)</span></span><br></pre></td></tr></table></figure>
<p>ä¸»æœºè¯´æ˜:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master</span></span><br><span class="line">weiyigek-107 </span><br><span class="line">weiyigek-108</span><br><span class="line">weiyigek-109</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker</span></span><br><span class="line">weiyigek-223</span><br><span class="line">weiyigek-224</span><br><span class="line">weiyigek-225</span><br><span class="line">weiyigek-226</span><br></pre></td></tr></table></figure></p>
<p>K8s å®‰è£…ç¯å¢ƒåŸºç¡€è¦æ±‚:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* æ¯å°æœºå™¨ 2 GB æˆ–æ›´å¤šçš„ RAM (å¦‚æœå°‘äºè¿™ä¸ªæ•°å­—å°†ä¼šå½±å“æ‚¨åº”ç”¨çš„è¿è¡Œå†…å­˜)</span><br><span class="line">* æ¯å°æœºå™¨ 2 CPU æ ¸æˆ–æ›´å¤š</span><br><span class="line">* é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨çš„ç½‘ç»œå½¼æ­¤å‡èƒ½ç›¸äº’è¿æ¥(å…¬ç½‘å’Œå†…ç½‘éƒ½å¯ä»¥)</span><br><span class="line">* ä¿è¯æœºå™¨ä¸»æœºå/ç½‘å¡UUIDå’ŒIPåœ°å€ä»¥åŠMacåœ°å€å”¯ä¸€</span><br></pre></td></tr></table></figure></p>
<p>PS : æ³¨æ„Masterä¸Nodeåœ¨ä¸€è‡´çš„æƒ…å†µä¸‹è¿›è¡Œä¸‹åˆ—å®‰è£…(æˆ‘ä»¬å·²åšè¿‡å®‰å…¨åŠ å›º)å¯èƒ½å®‰è£…è¿‡ç¨‹ä¸­ï¼Œè¯»è€…å®è·µéƒ¨ç½²çš„æ—¶å€™æœ‰ä¸€å®šçš„å‡ºå…¥(ä¸€èˆ¬æ˜¯ä¾èµ–çš„è½¯ä»¶æœªå®‰è£…);</p>
<p><br></p>
<h3 id="2-ç¯å¢ƒæ“ä½œ"><a href="#2-ç¯å¢ƒæ“ä½œ" class="headerlink" title="2.ç¯å¢ƒæ“ä½œ"></a>2.ç¯å¢ƒæ“ä½œ</h3><p>Tips æ³¨æ„: æ‰€æœ‰ä¸»æœºéƒ½éœ€è¦æŒ‰ç…§ä»¥ä¸‹æ“ä½œæµç¨‹</p>
<ul>
<li><p>Step 1.å„Masterä¸å·¥ä½œèŠ‚ç‚¹çš„æœºå™¨åç§°åŠå…¶è®¾ç½®;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># *- IP åœ°å€ä¿®æ”¹ -* &amp; *- ä¸»æœº åç§°ä¿®æ”¹ -*</span></span><br><span class="line">mkdir ~/init/</span><br><span class="line">tee ~/init/network.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">CURRENT_IP=$(hostname -I | cut -f 1 -d <span class="string">" "</span>)</span><br><span class="line">GATEWAY=$(hostname -I | cut -f 1,2,3 -d <span class="string">"."</span>)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> -lt 3 ]];<span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> IP Gateway Hostname"</span></span><br><span class="line">  <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"IP:<span class="variable">$&#123;1&#125;</span> # GATEWAY:<span class="variable">$&#123;2&#125;</span> # HOSTNAME:<span class="variable">$&#123;3&#125;</span>"</span></span><br><span class="line">sudo sed -i <span class="string">"s#<span class="variable">$&#123;CURRENT_IP&#125;</span>#<span class="variable">$&#123;1&#125;</span>#g"</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">sudo sed -i <span class="string">"s#<span class="variable">$&#123;GATEWAY&#125;</span>.1#<span class="variable">$&#123;2&#125;</span>#g"</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">sudo hostnamectl <span class="built_in">set</span>-hostname <span class="variable">$&#123;3&#125;</span> </span><br><span class="line">sudo netplan apply</span><br><span class="line">EOF</span><br><span class="line">chmod +x ~/init/network.sh </span><br><span class="line">sudo ~/init/network.sh 192.168.1.107 192.168.1.1 weiyigeek-107</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.å®‰è£…ä¾èµ–è½¯ä»¶ä»¥åŠå…³é—­åœç”¨ä¸éœ€è¦ä½¿ç”¨çš„è½¯ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) å¸è½½ç³»ç»Ÿä¸­è‡ªå¸¦çš„ snapd è½¯ä»¶ </span></span><br><span class="line"><span class="comment"># sudo systemctl stop snapd snapd.socket </span></span><br><span class="line"><span class="comment"># sudo apt autoremove --purge -y snapd </span></span><br><span class="line"><span class="comment"># sudo apt install -y linux-modules-extra-5.4.0-52-generic linux-headers-5.4.0-52</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) å…³é—­è‡ªå¯å’Œåœæ­¢ä¸ç”¨çš„è½¯ä»¶  (Ubuntu server 20.04 æœ€å°å®‰è£…ä¸å­˜åœ¨)</span></span><br><span class="line"><span class="comment"># sudo systemctl stop postfix</span></span><br><span class="line"><span class="comment"># sudo systemctl disable postfix</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 3.å„Masterä¸å·¥ä½œèŠ‚ç‚¹çš„æœºå™¨ç³»ç»Ÿæ—¶é—´çš„åŒæ­¥ä¸æ—¶åŒºè®¾ç½®<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®ç³»ç»Ÿæ—¶åŒºä¸ºä¸­å›½/ä¸Šæµ·</span></span><br><span class="line">sudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai</span><br><span class="line">sudo bash -c <span class="string">"echo 'Asia/Shanghai' &gt; /etc/timezone"</span></span><br><span class="line">sudo ntpdate ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å½“å‰çš„ UTC æ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</span></span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-local-rtc 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡</span></span><br><span class="line">sudo systemctl restart rsyslog.service cron.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line">date -R</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 4.è™šæ‹Ÿå†…å­˜swapåˆ†åŒºå…³é—­<br>Q: ä»€ä¹ˆå®‰è£…K8séœ€è¦å…³é—­SWAPè™šæ‹Ÿå†…å­˜?<blockquote>
<p>ç­”: ç”±äºKubeadmåœ¨è¿›è¡ŒK8så®‰è£…initåˆå§‹åŒ–æ—¶å€™ä¼šæ£€æµ‹ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨swapå¦‚æœå­˜åœ¨ä¼šåœ¨å®‰è£…æ—¶å€™æœ‰ä¸€ä¸ªè­¦å‘Šï¼Œå°½ç®¡æ‚¨å¯ä»¥åˆ©ç”¨ingoreæ¥å¿½ç•¥å®ƒä½†æ˜¯ç¡®å®å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼›<br>ä¾‹å¦‚æœ‰å¯èƒ½æˆ‘ä»¬åˆ›å»ºçš„Podè¿è¡Œåœ¨è™šæ‹Ÿå†…å­˜ä¸Šé¢ä¸è¿è¡Œåœ¨ç‰©ç†å†…å­˜ä¸­Podä¸ç®¡æ˜¯RWæ•ˆç‡éƒ½æ¯”è¾ƒä½;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a &amp;&amp; sudo sed -i <span class="string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab &amp;&amp; free  <span class="comment"># CentOS</span></span><br><span class="line">sudo swapoff -a &amp;&amp; sudo sed -i <span class="string">'s/^\/swap.img\(.*\)$/#\/swap.img \1/g'</span> /etc/fstab &amp;&amp; free  <span class="comment">#Ubuntu</span></span><br><span class="line"><span class="comment"># ä¸åŒç‚¹: Ubuntu æ²¡æœ‰ CentOS ä¸­çš„ selinux æ‰€ä»¥æ— éœ€å…³é—­</span></span><br><span class="line"><span class="comment"># setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config </span></span><br><span class="line"><span class="comment"># root@weiyigeek-107:~# free</span></span><br><span class="line"><span class="comment">#               total        used        free      shared  buff/cache   available</span></span><br><span class="line"><span class="comment"># Mem:        8151900      223192     7684708         880      244000     7674408</span></span><br><span class="line"><span class="comment"># Swap:       4194300           0     4194300</span></span><br><span class="line"><span class="comment"># root@weiyigeek-107:~# swapoff -a &amp;&amp; sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span></span><br><span class="line"><span class="comment"># root@weiyigeek-107:~# free</span></span><br><span class="line"><span class="comment">#               total        used        free      shared  buff/cache   available</span></span><br><span class="line"><span class="comment"># Mem:        8151900      223312     7684356         880      244232     7674256</span></span><br><span class="line"><span class="comment"># Swap:             0           0           0</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 5.ä¸ºäº†èƒ½åœ¨ kube-proxy å¼€å¯å¹¶ä½¿ç”¨ ipvs æˆ‘ä»¬éœ€è¦åŠ è½½ä»¥ä¸‹æ¨¡å—(æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ);<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) å®‰è£… ipvs ä»¥åŠ è´Ÿè½½å‡è¡¡ç›¸å…³ä¾èµ–</span></span><br><span class="line">sudo apt -y install ipvsadm ipset sysstat conntrack </span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) ipvs å†…æ ¸æ¨¡å—æ‰‹åŠ¨åŠ è½½ï¼ˆæ‰€æœ‰èŠ‚ç‚¹é…ç½®ï¼‰</span></span><br><span class="line">mkdir ~/k8s-init/</span><br><span class="line">tee ~/k8s-init/ipvs.modules &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_lc</span><br><span class="line">modprobe -- ip_vs_lblc</span><br><span class="line">modprobe -- ip_vs_lblcr</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- ip_vs_dh</span><br><span class="line">modprobe -- ip_vs_fo</span><br><span class="line">modprobe -- ip_vs_nq</span><br><span class="line">modprobe -- ip_vs_sed</span><br><span class="line">modprobe -- ip_vs_ftp</span><br><span class="line">modprobe -- ip_tables</span><br><span class="line">modprobe -- ip_set</span><br><span class="line">modprobe -- ipt_set</span><br><span class="line">modprobe -- ipt_rpfilter</span><br><span class="line">modprobe -- ipt_REJECT</span><br><span class="line">modprobe -- ipip</span><br><span class="line">modprobe -- xt_set</span><br><span class="line">modprobe -- br_netfilter</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) åŠ è½½å†…æ ¸é…ç½®ï¼ˆä¸´æ—¶|æ°¸ä¹…ï¼‰æ³¨æ„ç®¡ç†å‘˜æ‰§è¡Œ</span></span><br><span class="line">chmod 755 ~/k8s-init/ipvs.modules &amp;&amp; sudo bash ~/k8s-init/ipvs.modules</span><br><span class="line">sudo cp ~/k8s-init/ipvs.modules /etc/profile.d/ipvs.modules.sh</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line"><span class="comment"># ip_vs_ftp              16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_sed              16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_nq               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_fo               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_dh               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_sh               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_wrr              16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_rr               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_lblcr            16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_lblc             16384  0</span></span><br><span class="line"><span class="comment"># ip_vs_lc               16384  0</span></span><br><span class="line"><span class="comment"># ip_vs                 155648  22 ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp</span></span><br><span class="line"><span class="comment"># nf_nat                 40960  3 iptable_nat,xt_MASQUERADE,ip_vs_ftp</span></span><br><span class="line"><span class="comment"># nf_conntrack          139264  5 xt_conntrack,nf_nat,nf_conntrack_netlink,xt_MASQUERADE,ip_vs</span></span><br><span class="line"><span class="comment"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span></span><br><span class="line"><span class="comment"># libcrc32c              16384  5 nf_conntrack,nf_nat,btrfs,raid456,ip_vs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) ä¸‹é¢çš„æ–¹å¼ Ubuntu ä¸èƒ½æ­£ç¡®æ‰§è¡Œï¼‰</span></span><br><span class="line"><span class="comment"># ls /etc/modules-load.d/</span></span><br><span class="line"><span class="comment"># sudo systemctl enable --now systemd-modules-load.service</span></span><br><span class="line"></span><br><span class="line">PS : kube-proxy æ˜¯å¼€å¯ä½¿ç”¨IPVSçš„å‰ææ¡ä»¶å¿…é¡»æ­£å¸¸å®‰è£…;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 6.é›†ç¾¤å„ä¸»æœºèŠ‚ç‚¹å†…æ ¸Kernelå‚æ•°çš„è°ƒæ•´( Kubernetes å®‰è£…å‰çš„å¿…é¡»è¿›è¡Œè¯¥å†…æ ¸å‚æ•°ä¼˜åŒ–&amp;é…ç½®)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.Kernel å‚æ•°è°ƒæ•´</span></span><br><span class="line">mkdir ~/k8s-init/</span><br><span class="line">cat &gt; ~/k8s-init/kubernetes-sysctl.conf &lt;&lt;EOF</span><br><span class="line"><span class="comment"># iptables ç½‘æ¡¥æ¨¡å¼å¼€å¯</span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨ ipv6 åè®®</span></span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨ipv4è½¬å‘</span></span><br><span class="line">net.ipv4.ip_forward=1 </span><br><span class="line"><span class="comment"># net.ipv4.tcp_tw_recycle=0 #Ubuntu æ²¡æœ‰å‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ</span></span><br><span class="line">vm.swappiness=0</span><br><span class="line"><span class="comment"># ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line"><span class="comment"># ä¸å¯ OOM</span></span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶ç³»ç»Ÿé€šçŸ¥æ•°(æ ¹æ®å†…å­˜å¤§å°å’Œç©ºé—´å¤§å°é…ç½®)</span></span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä»¶æ‰“å¼€å¥æŸ„æ•°</span></span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcp keepalive ç›¸å…³å‚æ•°é…ç½®</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line"><span class="comment"># net.ipv4.ip_conntrack_max = 65536 # Ubuntu æ²¡æœ‰å‚æ•°</span></span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">EOF</span><br><span class="line">sudo cp ~/k8s-init/kubernetes-sysctl.conf  /etc/sysctl.d/99-kubernetes.conf</span><br><span class="line">sudo sysctl -p /etc/sysctl.d/99-kubernetes.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.nftables æ¨¡å¼åˆ‡æ¢</span></span><br><span class="line"><span class="comment"># åœ¨ Linux ä¸­ nftables å½“å‰å¯ä»¥ä½œä¸ºå†…æ ¸ iptables å­ç³»ç»Ÿçš„æ›¿ä»£å“,è¯¥å·¥å…·å¯ä»¥å……å½“å…¼å®¹æ€§å±‚å…¶è¡Œä¸ºç±»ä¼¼äº iptables ä½†å®é™…ä¸Šæ˜¯åœ¨é…ç½® nftablesã€‚</span></span><br><span class="line">$ apt list | grep <span class="string">"nftables/focal"</span></span><br><span class="line"><span class="comment"># nftables/focal 0.9.3-2 amd64</span></span><br><span class="line"><span class="comment"># python3-nftables/focal 0.9.3-2 amd64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables æ—§æ¨¡å¼åˆ‡æ¢ (nftables åç«¯ä¸å½“å‰çš„ kubeadm è½¯ä»¶åŒ…ä¸å…¼å®¹, å®ƒä¼šå¯¼è‡´é‡å¤é˜²ç«å¢™è§„åˆ™å¹¶ç ´å kube-proxy, æ‰€åˆ™éœ€è¦æŠŠ iptables å·¥å…·åˆ‡æ¢åˆ°â€œæ—§ç‰ˆâ€æ¨¡å¼æ¥é¿å…è¿™äº›é—®é¢˜)</span></span><br><span class="line">sudo update-alternatives --<span class="built_in">set</span> iptables /usr/sbin/iptables-legacy</span><br><span class="line">sudo update-alternatives --<span class="built_in">set</span> ip6tables /usr/sbin/ip6tables-legacy</span><br><span class="line"><span class="comment"># sudo update-alternatives --set arptables /usr/sbin/arptables-legacy  # PS: # Ubuntu 20.04 TLS æ— è¯¥æ¨¡å—</span></span><br><span class="line"><span class="comment"># sudo update-alternatives --set ebtables /usr/sbin/ebtables-legacy    # PS: # Ubuntu 20.04 TLS æ— è¯¥æ¨¡å—</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 7.ä¸»æœºåç§°è®¾ç½®ä¸hostsæ–‡ä»¶æ·»åŠ <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸»æœºåç§° ä»¥åŠ å…¶ä»–èŠ‚ç‚¹nodeä¸»æœºç»‘å®š</span></span><br><span class="line"><span class="comment"># hostnamectl set-hostname weiyigeek-107</span></span><br><span class="line">sudo tee -a /etc/hosts &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># dev &amp; test  - master</span></span><br><span class="line">192.168.1.107 weiyigeek-107</span><br><span class="line">192.168.1.108 weiyigeek-108</span><br><span class="line">192.168.1.109 weiyigeek-109</span><br><span class="line"></span><br><span class="line"><span class="comment"># dev &amp; test  - work</span></span><br><span class="line">192.168.1.223 weiyigeek-223</span><br><span class="line">192.168.1.224 weiyigeek-224</span><br><span class="line">192.168.1.225 weiyigeek-225</span><br><span class="line">192.168.1.226 weiyigeek-226</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes-vip (å¦‚æœä¸æ˜¯é«˜å¯ç”¨é›†ç¾¤ï¼Œè¯¥IPä¸ºMaster01çš„IP)</span></span><br><span class="line">192.168.1.110 weiyigeek-lb-vip.k8s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 8.è®¾ç½® rsyslogd å’Œ systemd journald è®°å½•<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -pv /var/<span class="built_in">log</span>/journal/ /etc/systemd/journald.conf.d/</span><br><span class="line">sudo tee /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Journal]</span><br><span class="line"><span class="comment"># æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜</span></span><br><span class="line">Storage=persistent</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‹ç¼©å†å²æ—¥å¿—</span></span><br><span class="line">Compress=yes</span><br><span class="line"></span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€å¤§å ç”¨ç©ºé—´ 10G</span></span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"></span><br><span class="line"><span class="comment"># å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 100M</span></span><br><span class="line">SystemMaxFileSize=100M</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨</span></span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å°†æ—¥å¿—è½¬å‘åˆ°syslog</span></span><br><span class="line">ForwardToSyslog=no</span><br><span class="line">EOF</span><br><span class="line">cp /etc/systemd/journald.conf.d/99-prophet.conf ~/k8s-init/journald-99-prophet.conf</span><br><span class="line">sudo systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 9.åœ¨å„ä¸ªä¸»æœºä¸­å®‰è£… dockerè½¯ä»¶<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å¸è½½æ—§ç‰ˆæœ¬ </span></span><br><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.æ›´æ–°aptåŒ…ç´¢å¼•å¹¶å®‰è£…åŒ…ä»¥å…è®¸aptåœ¨HTTPSä¸Šä½¿ç”¨å­˜å‚¨åº“</span></span><br><span class="line">sudo apt-get install -y \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates \</span><br><span class="line">  curl \</span><br><span class="line">  gnupg-agent \</span><br><span class="line">  software-properties-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥ # -fsSL</span></span><br><span class="line">curl https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.é€šè¿‡æœç´¢æŒ‡çº¹çš„æœ€å8ä¸ªå­—ç¬¦è¿›è¡Œå¯†é’¥éªŒè¯</span></span><br><span class="line">sudo apt-key fingerprint 0EBFCD88</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.è®¾ç½®ç¨³å®šå­˜å‚¨åº“</span></span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">  <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">  stable"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.Install Docker Engine é»˜è®¤æœ€æ–°ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line">sudo apt-get install -y docker-ce=5:19.03.15~3-0~ubuntu-focal docker-ce-cli=5:19.03.15~3-0~ubuntu-focal containerd.io</span><br><span class="line"><span class="comment"># 7.å®‰è£…ç‰¹å®šç‰ˆæœ¬çš„Dockerå¼•æ“ï¼Œè¯·åœ¨repoä¸­åˆ—å‡ºå¯ç”¨çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># $apt-cache madison docker-ce</span></span><br><span class="line"><span class="comment"># docker-ce | 5:20.10.2~3-0~ubuntu-focal | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># docker-ce | 5:18.09.1~3-0~ubuntu-xenial | https://download.docker.com/linux/ubuntu  xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¬¬äºŒåˆ—ä¸­çš„ç‰ˆæœ¬å­—ç¬¦ä¸²å®‰è£…ç‰¹å®šçš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚:5:18.09.1~3-0~ubuntu-xenialã€‚</span></span><br><span class="line"><span class="comment"># $sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#8.å°†å½“å‰ç”¨æˆ·åŠ å…¥dockerç”¨æˆ·ç»„ç„¶åé‡æ–°ç™»é™†å½“å‰ç”¨æˆ·ä½¿å¾—ä½æƒé™ç”¨æˆ·</span></span><br><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker</span><br><span class="line">sudo gpasswd -a weiyigeek docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#9.åŠ é€Ÿå™¨å»ºç«‹</span></span><br><span class="line">mkdir -vp /etc/docker/</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://xlx9erfu.mirror.aliyuncs.com"</span>],</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"live-restore"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"dns"</span>: [<span class="string">"192.168.12.254"</span>],</span><br><span class="line">  <span class="string">"insecure-registries"</span>: [<span class="string">"harbor.weiyigeek.top"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># PS : ç§æœ‰ä»“åº“é…ç½® insecure_registries</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.è‡ªå¯ä¸å¯åŠ¨</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now docker </span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.é€€å‡ºç™»é™†ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 10.å…ˆåœ¨ <code>WeiyiGeek-107</code> æœºå™¨ä¸­ä¸‹è½½ kubernetes é›†ç¾¤ç›¸å…³çš„è½¯ä»¶åŒ…å¹¶å‡†å¤‡å®‰è£…;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) gpg ç­¾åä¸‹è½½å¯¼å…¥</span></span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># (2) Kubernetes å®‰è£…æº</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list </span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) è½¯ä»¶åŒ…ç´¢å¼•æ›´æ–°ä»¥åŠåªä¸‹è½½ä¾èµ–åŒ…ä¸å®‰è£…kubernetes(æ³¨æ„æ­¤å¤„å»ºè®®é‡‡ç”¨æŒ‡å®šç‰ˆæœ¬ä¸‹è½½ )</span></span><br><span class="line">apt-cache madison kubelet kubeadm kubectl <span class="comment"># æŸ¥çœ‹å¯ç”¨çš„ kubernetes ç‰ˆæœ¬ æœ€æ–° 1.20.1</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt -d install kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line">kubelet --version</span><br><span class="line"><span class="comment"># Kubernetes v1.20.1</span></span><br><span class="line">kubeadm version</span><br><span class="line"><span class="comment"># kubeadm version: &amp;version.Info&#123;Major:"1", Minor:"20", GitVersion:"v1.20.1", GitCommit:"c4d752765b3bbac2237bf87cf0b1c2e307844666", GitTreeState:"clean", BuildDate:"2020-12-18T12:07:13Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line">kubectl version</span><br><span class="line"><span class="comment"># Client Version: version.Info&#123;Major:"1", Minor:"20", GitVersion:"v1.20.1", GitCommit:"c4d752765b3bbac2237bf87cf0b1c2e307844666", GitTreeState:"clean", BuildDate:"2020-12-18T12:09:25Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥æŒ‡å®šç‰ˆæœ¬ä¸‹è½½(ls /var/cache/apt/archives/  # ç¼“å­˜ç›®å½•) </span></span><br><span class="line"><span class="comment"># sudo apt -d install kubelet=1.19.10-00  kubeadm=1.19.10-00 kubectl=1.19.10-00</span></span><br><span class="line"><span class="comment"># å¦‚æœåªæ˜¯ä¸‹è½½debç›¸å…³åŒ…ä»¥ä¾›ç¦»çº¿å®‰è£…å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å®‰è£…</span></span><br><span class="line">sudo dpkg -i k8s-1.19.3/*.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) systemd å®ˆæŠ¤è¿›ç¨‹é‡å¯</span></span><br><span class="line">sudo systemctl daemon-reload  </span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) Kubeletæ˜¯ä»¥PODçš„æ–¹å¼è¿è¡Œåœ¨å®¹å™¨ä¹‹ä¸­ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now kubelet.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) é‡å¯ docker</span></span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 11.å…³æœºæ­¤æ—¶å…‹éš†æ­¤Masteræœºå™¨ä¸ºä¸¤å°æ–°çš„è™šæ‹Ÿæœºæœºå™¨;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) æŒ‰ç…§ä¸Šé¢çš„æ¸…å•è®¾ç½®ä¸»æœºåç§°ä»¥åŠIPåœ°å€</span></span><br><span class="line">./network.sh 192.168.1.108 192.168.1.1 weiyigeek-108</span><br><span class="line">./network.sh 192.168.1.109 192.168.1.1 weiyigeek-109</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h2 id="0x02-å•å®ä¾‹K8sé›†ç¾¤éƒ¨ç½²-v1-20-1"><a href="#0x02-å•å®ä¾‹K8sé›†ç¾¤éƒ¨ç½²-v1-20-1" class="headerlink" title="0x02 å•å®ä¾‹K8sé›†ç¾¤éƒ¨ç½²(v1.20.1)"></a>0x02 å•å®ä¾‹K8sé›†ç¾¤éƒ¨ç½²(v1.20.1)</h2><h3 id="1-Master-èŠ‚ç‚¹åˆå§‹åŒ–"><a href="#1-Master-èŠ‚ç‚¹åˆå§‹åŒ–" class="headerlink" title="1.Master èŠ‚ç‚¹åˆå§‹åŒ–"></a>1.Master èŠ‚ç‚¹åˆå§‹åŒ–</h3><ul>
<li>Step 1.å•å®ä¾‹ Master èŠ‚ç‚¹åˆå§‹åŒ–ä»¥åŠé›†ç¾¤èµ„æºæ¸…å•é…ç½®(æ³¨æ„åœ¨å‰é¢çš„ç¯å¢ƒä¹‹ä¸‹)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) åœ¨ WeiyiGeek-107 Master èŠ‚ç‚¹ä¸Šè¿è¡Œ `kubeadm config print init-defaults` æŸ¥çœ‹åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line"><span class="comment"># æ–¹å¼1.ç®€å•å‘½ä»¤</span></span><br><span class="line">kubeadm init --kubernetes-version=1.20.1 --apiserver-advertise-address=192.168.1.201 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.2.0.0/16 --pod-network-cidr=10.3.0.0/16</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼2.yamlæ–¹å¼ç”±äºæ­¤å¤„æ²¡åšé«˜å¯ä»¥ç”¨åˆ™APISERVERæŒ‡å‘é›†ç¾¤çš„MasterèŠ‚ç‚¹å³weiyigeek-107æœºå™¨</span></span><br><span class="line">K8SVERSION=1.20.1</span><br><span class="line">k8SIMAGEREP=<span class="string">"registry.cn-hangzhou.aliyuncs.com/google_containers"</span></span><br><span class="line">APISERVER_IP=192.168.1.107</span><br><span class="line">APISERVER_NAME=weiyigeek.k8s</span><br><span class="line">APISERVER_PORT=6443</span><br><span class="line">SERVICE_SUBNET=10.244.0.0/16  <span class="comment"># Flannel ç½‘ç»œæ’ä»¶é»˜è®¤ç½‘æ®µ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„ç‚¹Tokençš„æ ¼å¼</span></span><br><span class="line">cat &lt;&lt;EOF &gt; ~/k8s-init/kubeadm-init-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: 123456.httpweiyigeektop</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line"><span class="comment"># API Server åœ°å€ä¸ç«¯å£</span></span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: <span class="variable">$&#123;APISERVER_IP&#125;</span></span><br><span class="line">  bindPort: <span class="variable">$&#123;APISERVER_PORT&#125;</span></span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: ubuntu</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: <span class="variable">$&#123;k8SIMAGEREP&#125;</span></span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v<span class="variable">$&#123;K8SVERSION&#125;</span></span><br><span class="line">controlPlaneEndpoint: <span class="string">"<span class="variable">$&#123;APISERVER_NAME&#125;</span>:<span class="variable">$&#123;APISERVER_PORT&#125;</span>"</span></span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: <span class="variable">$&#123;SERVICE_SUBNET&#125;</span></span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1    </span><br><span class="line">kind: KubeProxyConfiguration    </span><br><span class="line">featureGates:      </span><br><span class="line">  SupportIPVSProxyMode: <span class="literal">true</span>    </span><br><span class="line">mode: ipvs</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>k8s é›†ç¾¤åˆ›å»ºåˆå§‹å‘½ä»¤:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init --upload-certs --config=/home/weiyigeek/k8s-init/kubeadm-init-config.yaml -v 5 | tee kubeadm_init.log</span><br><span class="line"><span class="comment"># W1104 21:29:36.119447  198575 configset.go:348] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span></span><br><span class="line"><span class="comment"># [init] Using Kubernetes version: v1.20.1</span></span><br><span class="line"><span class="comment"># [preflight] Running pre-flight checks</span></span><br><span class="line"><span class="comment"># [preflight] Pulling images required for setting up a Kubernetes cluster</span></span><br><span class="line"><span class="comment"># [preflight] This might take a minute or two, depending on the speed of your internet connection</span></span><br><span class="line"><span class="comment"># [preflight] You can also perform this action in beforehand using 'kubeadm config images pull'</span></span><br><span class="line"><span class="comment"># [certs] Using certificateDir folder "/etc/kubernetes/pki"</span></span><br><span class="line"><span class="comment"># .....</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace</span></span><br><span class="line"><span class="comment"># [kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: CoreDNS</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Your Kubernetes control-plane has initialized successfully!  # è¡¨ç¤ºæ§åˆ¶åŒ–å¹³é¢åˆå§‹åŒ–æˆåŠŸ</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="2-é›†ç¾¤ç®¡ç†"><a href="#2-é›†ç¾¤ç®¡ç†" class="headerlink" title="2.é›†ç¾¤ç®¡ç†"></a>2.é›†ç¾¤ç®¡ç†</h3><p>æè¿°: é›†ç¾¤ç®¡ç†é…ç½®æ§åˆ¶å¹³é¢<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) è¦å¼€å§‹ä½¿ç”¨é›†ç¾¤ï¼Œæ‚¨éœ€è¦ä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½è¿è¡Œåœ¨ Master èŠ‚ç‚¹ æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">grep <span class="string">"KUBECONFIG"</span> ~/.profile || <span class="built_in">echo</span> <span class="string">"export KUBECONFIG=~/.kube/config"</span> &gt;&gt; ~/.profile</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="3-é›†ç¾¤ç½‘ç»œæ’ä»¶å®‰è£…"><a href="#3-é›†ç¾¤ç½‘ç»œæ’ä»¶å®‰è£…" class="headerlink" title="3.é›†ç¾¤ç½‘ç»œæ’ä»¶å®‰è£…"></a>3.é›†ç¾¤ç½‘ç»œæ’ä»¶å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²é›†ç¾¤ pod ç½‘ç»œå¯ä»¥é€‰æ‹© flannel </span></span><br><span class="line"><span class="comment"># Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span></span><br><span class="line"><span class="comment">#   https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚ å®‰è£… flannel ç½‘ç»œæ’ä»¶</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">podsecuritypolicy.policy/psp.flannel.unprivileged created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.apps/kube-flannel-ds created</span><br></pre></td></tr></table></figure>
<p><br/></p>
<h3 id="4-å·¥ä½œèŠ‚ç‚¹åŠ å…¥"><a href="#4-å·¥ä½œèŠ‚ç‚¹åŠ å…¥" class="headerlink" title="4.å·¥ä½œèŠ‚ç‚¹åŠ å…¥"></a>4.å·¥ä½œèŠ‚ç‚¹åŠ å…¥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) ä½ ç°åœ¨å¯ä»¥ä»¥rootèº«ä»½åŠ å…¥ä»»æ„æ•°é‡çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤:</span></span><br><span class="line">  kubeadm join weiyigeek.k8s:6443 --token 123456.httpweiyigeektop \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:95e1bb846a09a4523be6c1ee6d3860eec1dcfdd16200efec5177ff25a1de49a6 \</span><br><span class="line">    --control-plane --certificate-key e05180fc473a8b89e4616412dac61b95cf02808fe1a27f9f72c2be921acc63f8</span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted <span class="keyword">in</span> two hours; If necessary, you can use</span><br><span class="line"><span class="string">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) ä½ å¯ä»¥åŠ å…¥ä»»æ„æ•°é‡çš„workerèŠ‚ç‚¹ï¼Œåœ¨æ¯ä¸ªworkerèŠ‚ç‚¹ä¸Šä»¥rootç”¨æˆ·è¿è¡Œå¦‚ä¸‹å‘½ä»¤:</span></span><br><span class="line">sudo kubeadm join weiyigeek.k8s:6443 --token 123456.httpweiyigeektop --discovery-token-ca-cert-hash sha256:95e1bb846a09a4523be6c1ee6d3860eec1dcfdd16200efec5177ff25a1de49a6</span><br><span class="line">[sudo] password <span class="keyword">for</span> weiyigeek:</span><br><span class="line">[preflight] Reading configuration from the cluster...</span><br><span class="line">[preflight] FYI: You can look at this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">"/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap...</span><br><span class="line"></span><br><span class="line"><span class="comment"># This node has joined the cluster:  # è¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»åŠ å…¥åˆ°é›†ç¾¤ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<h3 id="4-Token-å¤±æ•ˆé‡ç”Ÿæˆ"><a href="#4-Token-å¤±æ•ˆé‡ç”Ÿæˆ" class="headerlink" title="4.Token å¤±æ•ˆé‡ç”Ÿæˆ"></a>4.Token å¤±æ•ˆé‡ç”Ÿæˆ</h3><ul>
<li>Step 1.å¦‚æœè¶…è¿‡24å°æ—¶ token å¤±æ•ˆéœ€è¦é‡æ–°ç”Ÿæˆ<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) Token ç”Ÿæˆ</span></span><br><span class="line">kubeadm token create</span><br><span class="line"><span class="comment"># 2q41vx.w73xe9nrlqdujawu     ##æ­¤å¤„æ˜¯æ–°token</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) è·å–CAï¼ˆè¯ä¹¦ï¼‰å…¬é’¥å“ˆå¸Œå€¼</span></span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="string">'s/^ .* //'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) kubernetes è¯ä¹¦ç›®å½•</span></span><br><span class="line">$ ls /etc/kubernetes/pki</span><br><span class="line">apiserver.crt              apiserver-etcd-client.key  apiserver-kubelet-client.crt  ca.crt  etcd                front-proxy-ca.key      front-proxy-client.key  sa.pub</span><br><span class="line">apiserver-etcd-client.crt  apiserver.key              apiserver-kubelet-client.key  ca.key  front-proxy-ca.crt  front-proxy-client.crt  sa.key</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h3 id="5-èŠ‚ç‚¹é‡ç½®"><a href="#5-èŠ‚ç‚¹é‡ç½®" class="headerlink" title="5.èŠ‚ç‚¹é‡ç½®"></a>5.èŠ‚ç‚¹é‡ç½®</h3><ul>
<li>Step 1.å½“ Kuberneters é›†ç¾¤éœ€è¦æ¸…ç†é‡æ„å»ºéœ€æˆ–è€…èŠ‚ç‚¹è„±ç¦»é›†ç¾¤æ—¶å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ“ä½œè¿›è¡Œ:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - Master å·¥ä½œè´Ÿè½½ç§»é™¤æŒ‡å®šé›†ç¾¤ ä¾‹å¦‚åˆ é™¤ weiyigeek-223 weiyigeek-222 å·¥ä½œèŠ‚ç‚¹</span></span><br><span class="line">kubectl cordon weiyigeek-223 weiyigeek-222 </span><br><span class="line">kubectl delete node weiyigeek-223 weiyigeek-222 </span><br><span class="line"><span class="comment"># é‡‡ç”¨ ipvs è¿›è¡Œè´Ÿè½½çš„æ—¶å€™éœ€è¦æ¸…ç†`ipvsadm --clear`</span></span><br><span class="line">sudo kubeadm reset</span><br><span class="line">sudo rm -rf /etc/cni/net.d/*</span><br><span class="line">sudo rm -rf /etc/kubernetes/pki/*</span><br><span class="line">sudo rm -rf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># - Node å·¥ä½œèŠ‚ç‚¹ç§»é™¤k8sé›†ç¾¤</span></span><br><span class="line">sudo kubeadm reset</span><br><span class="line">sudo rm -rf /etc/cni/net.d/*</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<p><em>è¡¥å……è¯´æ˜</em>: å¦‚æœæ˜¯åœ¨å•masterèŠ‚ç‚¹è®¾ç½®ä½¿ç”¨ calico ä¸º k8s çš„CNIç½‘ç»œæ’ä»¶æ—¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">K8SVERSION=1.20.1</span><br><span class="line">APISERVER_IP=192.168.1.107</span><br><span class="line">APISERVER_NAME=k8s.weiyigeek.top</span><br><span class="line">APISERVER_PORT=6443</span><br><span class="line">SERVICE_SUBNET=10.99.0.0/16</span><br><span class="line">POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;APISERVER_IP&#125;</span> <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–é…ç½®(å»ºè®®å„ä¸ªç»„ä»¶çš„ç‰ˆæœ¬ä¸k8sçš„ç‰ˆæœ¬ä¸€è‡´)</span></span><br><span class="line">rm -f ./kubeadm-config.yaml</span><br><span class="line">cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v<span class="variable">$&#123;K8SVERSION&#125;</span></span><br><span class="line">imageRepository: mirrorgcrio</span><br><span class="line"><span class="comment">#imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="comment">#imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="comment">#imageRepository: gcr.azk8s.cn/google_containers</span></span><br><span class="line">controlPlaneEndpoint: <span class="string">"<span class="variable">$&#123;APISERVER_NAME&#125;</span>:<span class="variable">$&#123;APISERVER_PORT&#125;</span>"</span></span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: <span class="string">"<span class="variable">$&#123;SERVICE_SUBNET&#125;</span>"</span></span><br><span class="line">  podSubnet: <span class="string">"<span class="variable">$&#123;POD_SUBNET&#125;</span>"</span></span><br><span class="line">  dnsDomain: <span class="string">"cluster.local"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeadm init æ ¹æ®æ‚¨æœåŠ¡å™¨ç½‘é€Ÿçš„æƒ…å†µï¼Œæ‚¨éœ€è¦ç­‰å€™ 3 - 10 åˆ†é’Ÿ</span></span><br><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x03-é«˜å¯ç”¨K8sé›†ç¾¤éƒ¨ç½²-v1-19-6"><a href="#0x03-é«˜å¯ç”¨K8sé›†ç¾¤éƒ¨ç½²-v1-19-6" class="headerlink" title="0x03 é«˜å¯ç”¨K8sé›†ç¾¤éƒ¨ç½²(v1.19.6)"></a>0x03 é«˜å¯ç”¨K8sé›†ç¾¤éƒ¨ç½²(v1.19.6)</h2><h3 id="Step-1-é«˜å¯ç”¨ç»„ä»¶å®‰è£…æ‰€æœ‰MasterèŠ‚ç‚¹é€šè¿‡aptå®‰è£…HAProxyå’ŒKeepAlived"><a href="#Step-1-é«˜å¯ç”¨ç»„ä»¶å®‰è£…æ‰€æœ‰MasterèŠ‚ç‚¹é€šè¿‡aptå®‰è£…HAProxyå’ŒKeepAlived" class="headerlink" title="Step 1.é«˜å¯ç”¨ç»„ä»¶å®‰è£…æ‰€æœ‰MasterèŠ‚ç‚¹é€šè¿‡aptå®‰è£…HAProxyå’ŒKeepAlived"></a>Step 1.é«˜å¯ç”¨ç»„ä»¶å®‰è£…æ‰€æœ‰MasterèŠ‚ç‚¹é€šè¿‡aptå®‰è£…HAProxyå’ŒKeepAlived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PS: æ­¤æ—¶åªä¸‹è½½ä¸å®‰è£…(æ–¹ä¾¿ä¼ åˆ°æ²¡æœ‰ç½‘ç»œçš„masterèŠ‚ç‚¹ä¸Š)</span></span><br><span class="line">sudo apt -d install keepalived haproxy</span><br><span class="line"><span class="comment"># ~/k8s-init$ scp -P 20211 /home/weiyigeek/k8s-init/High-Availability/* weiyigeek@192.168.1.108:~/k8s-init/</span></span><br><span class="line"><span class="comment"># ~/k8s-init$ scp -P 20211 /home/weiyigeek/k8s-init/High-Availability/* weiyigeek@192.168.1.109:~/k8s-init/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ dpkg å‘½ä»¤ å®‰è£… ä¸Šä¸€æ­¥ä¸‹è½½çš„ debåŒ…</span></span><br><span class="line">/var/cache/apt/archives$ dpkg -i *.deb</span><br><span class="line"><span class="comment"># ~/k8s-init$ ssh -p20211 weiyigeek@192.168.1.108 "sudo -S dpkg -i ~/k8s-init/*.deb"</span></span><br><span class="line"><span class="comment"># ~/k8s-init$ ssh -p20211 weiyigeek@192.168.1.109 "sudo -S dpkg -i ~/k8s-init/*.deb"</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-2-æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®HAProxy"><a href="#Step-2-æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®HAProxy" class="headerlink" title="Step 2.æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®HAProxy"></a>Step 2.æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®HAProxy</h3><p>PS : è¯¦ç»†é…ç½®å‚è€ƒHAProxyæ–‡æ¡£ï¼Œæ‰€æœ‰MasterèŠ‚ç‚¹çš„HAProxyé…ç½®ç›¸åŒ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu haproxy é…ç½®æ–‡ä»¶ç›®å½•</span></span><br><span class="line"><span class="variable">$ls</span> /etc/haproxy/</span><br><span class="line">errors/      haproxy.cfg</span><br><span class="line"></span><br><span class="line"><span class="variable">$sudo</span> vim /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span>    local0</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span>    local1 notice</span><br><span class="line">  chroot /var/lib/haproxy</span><br><span class="line">  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br><span class="line">  stats timeout 30s</span><br><span class="line">  user haproxy</span><br><span class="line">  group haproxy</span><br><span class="line">  daemon</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default SSL material locations</span></span><br><span class="line">  ca-base /etc/ssl/certs</span><br><span class="line">  crt-base /etc/ssl/private</span><br><span class="line"></span><br><span class="line">  <span class="comment"># See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.0.3&amp;config=intermediate</span></span><br><span class="line">  ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><br><span class="line">  ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256</span><br><span class="line">  ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  <span class="built_in">log</span>     global</span><br><span class="line">  mode    http</span><br><span class="line">  option  httplog</span><br><span class="line">  option  dontlognull</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  errorfile 400 /etc/haproxy/errors/400.http</span><br><span class="line">  errorfile 403 /etc/haproxy/errors/403.http</span><br><span class="line">  errorfile 408 /etc/haproxy/errors/408.http</span><br><span class="line">  errorfile 500 /etc/haproxy/errors/500.http</span><br><span class="line">  errorfile 502 /etc/haproxy/errors/502.http</span><br><span class="line">  errorfile 503 /etc/haproxy/errors/503.http</span><br><span class="line">  errorfile 504 /etc/haproxy/errors/504.http</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: 16443 ä¸ºVIPçš„Apiserver-æ§åˆ¶å¹³é¢ç«¯å£</span></span><br><span class="line">frontend k8s-master</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:16443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:16443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: Master èŠ‚ç‚¹çš„é»˜è®¤apiserveræ˜¯6443ç«¯å£</span></span><br><span class="line">backend k8s-master</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server weiyigeek-107 192.168.1.107:6443  check</span><br><span class="line">  server weiyigeek-108 192.168.1.108:6443  check</span><br><span class="line">  server weiyigeek-109 192.168.1.109:6443  check</span><br></pre></td></tr></table></figure></p>
<p>æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®KeepAlivedï¼Œé…ç½®ä¸ä¸€æ ·ï¼Œ<code>æ³¨æ„åŒºåˆ†æ³¨æ„æ¯ä¸ªèŠ‚ç‚¹çš„IPå’Œç½‘å¡ï¼ˆinterfaceå‚æ•°ï¼‰</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /etc/keepalived</span><br><span class="line"><span class="comment"># weiyigeek-107 Master 1</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.1.107</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#    track_script &#123;</span></span><br><span class="line"><span class="comment">#       chk_apiserver</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># weiyigeek-108 Master 2 =&gt; Backup</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.1.108</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#    track_script &#123;</span></span><br><span class="line"><span class="comment">#       chk_apiserver</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># weiyigeek-108 Master 3 =&gt; Backup</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.1.109</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">      auth_type PASS</span><br><span class="line">      auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      192.168.1.110</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#    track_script &#123;</span></span><br><span class="line"><span class="comment">#       chk_apiserver</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="Step-3-é…ç½®KeepAlivedå¥åº·æ£€æŸ¥æ–‡ä»¶"><a href="#Step-3-é…ç½®KeepAlivedå¥åº·æ£€æŸ¥æ–‡ä»¶" class="headerlink" title="Step 3.é…ç½®KeepAlivedå¥åº·æ£€æŸ¥æ–‡ä»¶"></a>Step 3.é…ç½®KeepAlivedå¥åº·æ£€æŸ¥æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo tee /etc/keepalived/check_apiserver.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(seq 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  check_code=$(pgrep haproxy)</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line">    err=$(expr <span class="variable">$err</span> + 1)</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    err=0</span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">"0"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"systemctl stop keepalived"</span></span><br><span class="line">  /usr/bin/systemctl stop keepalived</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line">sudo chmod +x /etc/keepalived/check_apiserver.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡ä»½é«˜å¯ç”¨ç›¸å…³é…ç½®æ–‡ä»¶</span></span><br><span class="line">mkdir ~/k8s-init/haproxy &amp;&amp; cp /etc/haproxy/haproxy.cfg ~/k8s-init/haproxy </span><br><span class="line">mkdir ~/k8s-init/keepalived &amp;&amp; cp /etc/keepalived/keepalived.conf /etc/keepalived/check_apiserver.sh ~/k8s-init/keepalived</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-4-å¯åŠ¨haproxyå’Œkeepalivedä»¥åŠæµ‹è¯•VIP"><a href="#Step-4-å¯åŠ¨haproxyå’Œkeepalivedä»¥åŠæµ‹è¯•VIP" class="headerlink" title="Step 4.å¯åŠ¨haproxyå’Œkeepalivedä»¥åŠæµ‹è¯•VIP"></a>Step 4.å¯åŠ¨haproxyå’Œkeepalivedä»¥åŠæµ‹è¯•VIP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è‡ªå¯åŠ¨å¹¶ç«‹å³å¯åŠ¨</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now haproxy</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># VIP æ¼‚ç§»æµ‹è¯•</span></span><br><span class="line">~$ ps aux | grep <span class="string">"haproxy"</span></span><br><span class="line">root         892  0.0  0.1  15600  9236 ?        Ss   10:39   0:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -S /run/haproxy-master.sock</span><br><span class="line">haproxy      893  0.0  0.0 531724  3480 ?        Sl   10:39   0:02 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -S /run/haproxy-master.sock</span><br><span class="line"></span><br><span class="line">weiyigeek-107:$ ip addr</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:8a:e8:db brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.107/24 brd 192.168.1.255 scope global ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.110/32 scope global ens160  <span class="comment"># å¯ä»¥çœ‹è§è¯¥VIPåœ¨weiyigeek-107</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">weiyigeek-107:~$ systemctl stop keepalived.service  <span class="comment"># ç°åœ¨ weiyigeek-107 åœæ­¢ keepalived.service</span></span><br><span class="line">weiyigeek-107:~$ ip addr | grep <span class="string">"192.168.1.110"</span>    <span class="comment"># æ­¤æ—¶ä¼šå‘ç° weiyigeek-107 å·²ç»ä¸å­˜åœ¨è¯¥VIPäº†</span></span><br><span class="line">weiyigeek-107:~$ ssh -p20211 weiyigeek@192.168.1.109 <span class="string">"ip addr | grep '192.168.1.110'"</span> <span class="comment"># ä¼šå‘ç°æ¼‚ç§»åˆ°weiyigeek-109çš„masterèŠ‚ç‚¹çš„æœºå™¨ä¸Š</span></span><br><span class="line">  inet 192.168.1.110/32 scope global ens160</span><br><span class="line">weiyigeek-107:~$ ping 192.168.1.110               <span class="comment"># ping é€šä¿¡æ­£å¸¸</span></span><br><span class="line"><span class="comment"># PING 192.168.1.110 (192.168.1.110) 56(84) bytes of data.</span></span><br><span class="line"><span class="comment"># 64 bytes from 192.168.1.110: icmp_seq=1 ttl=64 time=0.218 ms</span></span><br></pre></td></tr></table></figure>
<p>PS : è‡³æ­¤åŸºäºHaproxyä¸keepaliveå®ç°çš„é«˜å¯ç”¨å·²ç»OKäº†;</p>
<p><br></p>
<h3 id="Step-5-é›†ç¾¤å®‰è£…å…¶å®ƒæŒ‡å®šç‰ˆæœ¬"><a href="#Step-5-é›†ç¾¤å®‰è£…å…¶å®ƒæŒ‡å®šç‰ˆæœ¬" class="headerlink" title="Step 5.é›†ç¾¤å®‰è£…å…¶å®ƒæŒ‡å®šç‰ˆæœ¬"></a>Step 5.é›†ç¾¤å®‰è£…å…¶å®ƒæŒ‡å®šç‰ˆæœ¬</h3><p>PS : åœ¨åŸºç¡€ç¯å¢ƒçš„å®‰è£…ä¸­æˆ‘ä»¬é‡‡ç”¨äº† <code>docker 1.20.x ä»¥åŠ kubernetes 1.20.x</code>è€ƒè™‘åˆ° k8s åœ¨ 1.23.x ç‰ˆæœ¬ä¹‹åå°†ä¼šä¸¢å¼ƒdockerè€Œä½¿ç”¨å…¶å®ƒçš„CRI-O, æ­¤å¤„ä¸ºäº†é›†ç¾¤ç¯å¢ƒçš„ç¨³å®šæ€§å°†åŸæœ¬dockerä»¥åŠkubernetesç‰ˆæœ¬åˆ é™¤ï¼Œåˆ†åˆ«å®‰è£…1.19.xç‰ˆæœ¬;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) åœæ­¢æœåŠ¡</span></span><br><span class="line">sudo systemctl stop docker.service kubelet.service docker.socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) docker å®¹å™¨å¸è½½ &amp;&amp; K8s å¸è½½</span></span><br><span class="line">sudo apt-get remove docker-ce docker-ce-cli containerd.io kubectl kubeadm kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) æŸ¥çœ‹ docker ä»¥åŠ k8s ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison docker-ce docker-ce-cli kubelet</span><br><span class="line"><span class="comment"># sudo apt-get -d install docker-ce=5:19.03.14~3-0~ubuntu-focal docker-ce-cli=5:19.03.14~3-0~ubuntu-focal containerd.io  # Download complete and in download only mode</span></span><br><span class="line"><span class="comment"># sudo dpkg -i /var/cache/apt/archives/*.deb</span></span><br><span class="line">sudo apt-get install docker-ce=5:19.03.14~3-0~ubuntu-focal docker-ce-cli=5:19.03.14~3-0~ubuntu-focal containerd.io -y</span><br><span class="line">sudo apt install kubelet=1.19.6-00 kubeadm=1.19.6-00 kubectl=1.19.6-00 -y</span><br><span class="line">$ kubeadm version</span><br><span class="line"><span class="comment"># kubeadm version: &amp;version.Info&#123;Major:"1", Minor:"19", GitVersion:"v1.19.6", GitCommit:"1e11e4a2108024935ecfcb2912226cedeafd99df", GitTreeState:"clean", BuildDate:"2020-10-14T12:47:53Z", GoVersion:"go1.15.2", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line">$ kubelet --version</span><br><span class="line"><span class="comment"># Kubernetes v1.19.6</span></span><br><span class="line">$ kubectl version</span><br><span class="line"><span class="comment"># Client Version: version.Info&#123;Major:"1", Minor:"19", GitVersion:"v1.19.6", GitCommit:"1e11e4a2108024935ecfcb2912226cedeafd99df", GitTreeState:"clean", BuildDate:"2020-10-14T12:50:19Z", GoVersion:"go1.15.2", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) è‡ªå¯å¹¶å¯åŠ¨æœåŠ¡</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now docker </span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line">sudo systemctl restart docker kubelet</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="Step-6-é›†ç¾¤åˆå§‹åŒ–çš„yamlæ–‡ä»¶"><a href="#Step-6-é›†ç¾¤åˆå§‹åŒ–çš„yamlæ–‡ä»¶" class="headerlink" title="Step 6.é›†ç¾¤åˆå§‹åŒ–çš„yamlæ–‡ä»¶"></a>Step 6.é›†ç¾¤åˆå§‹åŒ–çš„yamlæ–‡ä»¶</h3><p>æè¿°: kubeadm å¯ä»¥æ‰“å°å‡ºåˆå§‹åŒ–ä»¥åŠèŠ‚ç‚¹åŠ å…¥çš„é…ç½®æ¨¡æ¿;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) åˆå§‹åŒ–</span></span><br><span class="line">$ kubeadm config <span class="built_in">print</span> init-defaults</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 1.2.3.4</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: ubuntu</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.19.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) èŠ‚ç‚¹åŠ å…¥</span></span><br><span class="line">$ kubeadm config <span class="built_in">print</span> join-defaults</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">caCertPath: /etc/kubernetes/pki/ca.crt</span><br><span class="line">discovery:</span><br><span class="line">  bootstrapToken:</span><br><span class="line">    apiServerEndpoint: kube-apiserver:6443</span><br><span class="line">    token: abcdef.0123456789abcdef</span><br><span class="line">    unsafeSkipCAVerification: <span class="literal">true</span></span><br><span class="line">  timeout: 5m0s</span><br><span class="line">  tlsBootstrapToken: abcdef.0123456789abcdef</span><br><span class="line">kind: JoinConfiguration</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: ubuntu</span><br><span class="line">  taints: null</span><br></pre></td></tr></table></figure></p>
<p>K8s é›†ç¾¤åˆå§‹åŒ–é…ç½®æ–‡ä»¶(<code>~/k8s-init/kubeadm-init-config.yaml</code>)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) æ³¨æ„ : Tokençš„æ ¼å¼ä»¥åŠPodå­ç½‘çš„ç½‘æ®µ (Calico)å’Œipvsçš„æ”¯æŒ</span></span><br><span class="line">K8SVERSION=1.19.6</span><br><span class="line">k8SIMAGEREP=<span class="string">"registry.cn-hangzhou.aliyuncs.com/google_containers"</span></span><br><span class="line">APISERVER_NAME=weiyigeek-lb-vip.k8s</span><br><span class="line">APISERVER_IP=192.168.1.110</span><br><span class="line">APISERVER_PORT=16443</span><br><span class="line">LOCALAPIVERVER_NAME=weiyigeek-107</span><br><span class="line">LOCALAPISERVER_IP=192.168.1.107</span><br><span class="line">LOCALAPISERVER_PORT=6443</span><br><span class="line">SERVICE_SUBNET=172.16.0.0/16</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; ~/k8s-init/kubeadm-init-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: 20w21w.httpweiyigeektop</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: <span class="variable">$&#123;LOCALAPISERVER_IP&#125;</span></span><br><span class="line">  bindPort: <span class="variable">$&#123;LOCALAPISERVER_PORT&#125;</span></span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: <span class="variable">$&#123;LOCALAPIVERVER_NAME&#125;</span></span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - <span class="variable">$&#123;APISERVER_IP&#125;</span></span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: <span class="variable">$&#123;k8SIMAGEREP&#125;</span></span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v<span class="variable">$&#123;K8SVERSION&#125;</span></span><br><span class="line">controlPlaneEndpoint: <span class="variable">$&#123;APISERVER_NAME&#125;</span>:<span class="variable">$&#123;APISERVER_PORT&#125;</span></span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: <span class="variable">$&#123;SERVICE_SUBNET&#125;</span></span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1    </span><br><span class="line">kind: KubeProxyConfiguration    </span><br><span class="line">featureGates:      </span><br><span class="line">  SupportIPVSProxyMode: <span class="literal">true</span>    </span><br><span class="line">mode: ipvs</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) åˆå§‹åŒ–MasterèŠ‚ç‚¹æ§åˆ¶å¹³é¢ä»¥åŠWorkeråŠ å…¥çš„å‚æ•°ç”Ÿæˆ(# æ ¹æ®æ‚¨æœåŠ¡å™¨ç½‘é€Ÿçš„æƒ…å†µï¼Œæ‚¨éœ€è¦ç­‰å€™ 3 - 10 åˆ†é’Ÿå»ºè®®é‡‡ç”¨ä¸‹é¢å¤‡æ³¨ä¸­çš„æ“ä½œ)</span></span><br><span class="line">sudo kubeadm init --config=/home/weiyigeek/k8s-init/kubeadm-init-config.yaml --upload-certs | tee kubeadm_init.log</span><br><span class="line"><span class="comment"># [certs] Using certificateDir folder "/etc/kubernetes/pki"</span></span><br><span class="line"><span class="comment"># [certs] Generating "ca" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "apiserver" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] apiserver serving cert is signed for DNS names [weiyigeek-107 weiyigeek-lb-vip.k8s kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.1.107 192.168.1.110]</span></span><br><span class="line"><span class="comment"># [certs] Generating "apiserver-kubelet-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "front-proxy-ca" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "front-proxy-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/ca" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/server" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] etcd/server serving cert is signed for DNS names [weiyigeek-107 localhost] and IPs [192.168.1.107 127.0.0.1 ::1]</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/peer" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] etcd/peer serving cert is signed for DNS names [weiyigeek-107 localhost] and IPs [192.168.1.107 127.0.0.1 ::1]</span></span><br><span class="line"><span class="comment"># [certs] Generating "etcd/healthcheck-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "apiserver-etcd-client" certificate and key</span></span><br><span class="line"><span class="comment"># [certs] Generating "sa" key and public key</span></span><br><span class="line"><span class="comment"># [kubeconfig] Using kubeconfig folder "/etc/kubernetes"</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "admin.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "kubelet.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "controller-manager.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [kubeconfig] Writing "scheduler.conf" kubeconfig file</span></span><br><span class="line"><span class="comment"># [kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line"><span class="comment"># [kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"</span></span><br><span class="line"><span class="comment"># [kubelet-start] Starting the kubelet</span></span><br><span class="line"><span class="comment"># [control-plane] Using manifest folder "/etc/kubernetes/manifests"</span></span><br><span class="line"><span class="comment"># [control-plane] Creating static Pod manifest for "kube-apiserver"</span></span><br><span class="line"><span class="comment"># [control-plane] Creating static Pod manifest for "kube-controller-manager"</span></span><br><span class="line"><span class="comment"># [control-plane] Creating static Pod manifest for "kube-scheduler"</span></span><br><span class="line"><span class="comment"># [etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"</span></span><br><span class="line"><span class="comment"># [wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s</span></span><br><span class="line"><span class="comment"># [apiclient] All control plane components are healthy after 21.750931 seconds</span></span><br><span class="line"><span class="comment"># [upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace</span></span><br><span class="line"><span class="comment"># [kubelet] Creating a ConfigMap "kubelet-config-1.19" in namespace kube-system with the configuration for the kubelets in the cluster</span></span><br><span class="line"><span class="comment"># [upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace</span></span><br><span class="line"><span class="comment"># [upload-certs] Using certificate key:</span></span><br><span class="line"><span class="comment"># bb5b2f0b287d35e179ef4efawwww9f61a38f62343a9b06fc143e3b</span></span><br><span class="line"><span class="comment"># [mark-control-plane] Marking the node weiyigeek-107 as control-plane by adding the label "node-role.kubernetes.io/master=''"</span></span><br><span class="line"><span class="comment"># [mark-control-plane] Marking the node weiyigeek-107 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Using token: 2021wq.httpweiyigeektop</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span><br><span class="line"><span class="comment"># [bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span></span><br><span class="line"><span class="comment"># [bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace</span></span><br><span class="line"><span class="comment"># [kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: CoreDNS</span></span><br><span class="line"><span class="comment"># [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="comment"># [addons] Applied essential addon: kube-proxy</span></span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br></pre></td></tr></table></figure></p>
<p>PS : å°†è¯¥yamlæ–‡ä»¶å¤åˆ¶åˆ°å…¶ä»–masterèŠ‚ç‚¹ï¼Œä¹‹åæ‰€æœ‰MasterèŠ‚ç‚¹æå‰ä¸‹è½½é•œåƒï¼Œå¯ä»¥èŠ‚çœåˆå§‹åŒ–æ—¶é—´ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1.é…ç½®æ–‡ä»¶ä¸Šä¼ åˆ°å…¶ä»–masterèŠ‚ç‚¹</span></span><br><span class="line">scp -P 20211 /home/weiyigeek/k8s-init/kubeadm-init-config.yaml weiyigeek@192.168.1.108:~/k8s-init/kubeadm-init-config.yaml</span><br><span class="line">kubeadm config images pull --config /home/weiyigeek/k8s-init/kubeadm-init-config.yaml</span><br><span class="line"><span class="comment"># W0111 11:24:15.905316    5481 configset.go:348] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.19.6</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.13-0</span></span><br><span class="line"><span class="comment"># [config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.7.0</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="Step-7-Kubernetes-é›†ç¾¤è®¿é—®é…ç½®"><a href="#Step-7-Kubernetes-é›†ç¾¤è®¿é—®é…ç½®" class="headerlink" title="Step 7.Kubernetes é›†ç¾¤è®¿é—®é…ç½®"></a>Step 7.Kubernetes é›†ç¾¤è®¿é—®é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) æ™®é€šç”¨æˆ·å¯¹é›†ç¾¤è®¿é—®é…ç½®æ–‡ä»¶è®¾ç½®</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) è‡ªåŠ¨è¿è¡Œè®¾ç½® KUBECONFIG ç¯å¢ƒä»¥åŠk8så‘½ä»¤è‡ªåŠ¨è¡¥é½</span></span><br><span class="line">grep <span class="string">"export KUBECONFIG"</span> ~/.profile | <span class="built_in">echo</span> <span class="string">"export KUBECONFIG=<span class="variable">$HOME</span>/.kube/config"</span> &gt;&gt; ~/.profile</span><br><span class="line">tee -a ~/.profile &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"><span class="built_in">source</span> &lt;(kubeadm completion bash)</span><br><span class="line"><span class="comment"># source &lt;(kubelet completion bash)</span></span><br><span class="line"><span class="comment"># source &lt;(helm completion bash)</span></span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">source</span> ~/.profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€å’Œkube-systemå‘½åç©ºé—´å†…PodçŠ¶æ€</span></span><br><span class="line">~$ kubectl get node</span><br><span class="line"><span class="comment"># NAME       STATUS     ROLES    AGE   VERSION</span></span><br><span class="line"><span class="comment"># weiyigeek-107   NotReady   master   45m   v1.19.6   # æ­¤å¤„NotReady æ˜¯ç”±äºæˆ‘ä»¬çš„calicoç½‘ç»œæ’ä»¶æœªé…ç½®å¥½</span></span><br><span class="line">~$ kubectl get pod -n kube-system</span><br><span class="line"><span class="comment"># NAME                               READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="comment"># coredns-6c76c8bb89-6cl4d           0/1     Pending   0          45m</span></span><br><span class="line"><span class="comment"># coredns-6c76c8bb89-xzkms           0/1     Pending   0          45m</span></span><br><span class="line"><span class="comment"># etcd-weiyigeek-107                      1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-apiserver-weiyigeek-107            1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-controller-manager-weiyigeek-107   1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-proxy-l7bp6                   1/1     Running   0          45m</span></span><br><span class="line"><span class="comment"># kube-scheduler-weiyigeek-107            1/1     Running   0          45m</span></span><br></pre></td></tr></table></figure>
<p>PS : å½“æ²¡æœ‰å®‰è£…ç¬¬ä¸‰æ–¹çš„ <code>flannelæˆ–è€…calicoç½‘ç»œæ’ä»¶</code> æ—¶å€™ï¼Œé€šè¿‡kubectl get node æŸ¥çœ‹åˆ°èŠ‚ç‚¹çŠ¶æ€æ˜¯ NotReady ï¼Œå½“å®‰è£…å®Œæˆæ‰å¹³åŒ–ç½‘ç»œæ’ä»¶å, å¦‚æœæ²¡æœ‰å…¶å®ƒæ„å¤–åˆ™æ˜¾ç¤ºReady</p>
<p><br></p>
<h3 id="Step-8-ç°åœ¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤-æ­¤å¤„é€‰ç”¨calicoç½‘ç»œæ’ä»¶è€Œéä½¿ç”¨flannelæ’ä»¶"><a href="#Step-8-ç°åœ¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤-æ­¤å¤„é€‰ç”¨calicoç½‘ç»œæ’ä»¶è€Œéä½¿ç”¨flannelæ’ä»¶" class="headerlink" title="Step 8.ç°åœ¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤,æ­¤å¤„é€‰ç”¨calicoç½‘ç»œæ’ä»¶è€Œéä½¿ç”¨flannelæ’ä»¶"></a>Step 8.ç°åœ¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤,æ­¤å¤„é€‰ç”¨calicoç½‘ç»œæ’ä»¶è€Œéä½¿ç”¨flannelæ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span></span><br><span class="line"><span class="comment"># https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… calico ç½‘ç»œæ’ä»¶(æ­¤å¤„å®‰è£…æœ€æ–°çš„v3.17.1ç‰ˆæœ¬ä¸é‡‡ç”¨kuboardè„šæœ¬)</span></span><br><span class="line"><span class="comment"># å‚è€ƒæ–‡æ¡£ https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span></span><br><span class="line"><span class="comment"># wget https://kuboard.cn/install-script/calico/calico-3.13.1.yaml</span></span><br><span class="line"><span class="comment"># kubectl apply -f calico-3.13.1.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) Install Calico with Kubernetes API datastore, 50 nodes or less</span></span><br><span class="line"><span class="comment"># curl https://docs.projectcalico.org/manifests/calico.yaml -O</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) Install Calico with etcd datastore (ä½¿ç”¨etcdæ•°æ®å­˜å‚¨å®‰è£…Calico) </span></span><br><span class="line">curl https://docs.projectcalico.org/manifests/calico-etcd.yaml -O</span><br><span class="line"></span><br><span class="line"><span class="comment"># calico-etcd ç½‘ç»œä¸etcé›†ç¾¤è¿æ¥ä¿®æ”¹(æ­¤å¤„æŒ‡å®špodå­ç½‘åœ°å€)</span></span><br><span class="line">ETCD_CA=`cat /etc/kubernetes/pki/etcd/ca.crt | base64 | tr -d <span class="string">'\n'</span>`</span><br><span class="line">ETCD_CERT=`cat /etc/kubernetes/pki/etcd/server.crt | base64 | tr -d <span class="string">'\n'</span>`</span><br><span class="line">ETCD_KEY=`sudo cat /etc/kubernetes/pki/etcd/server.key | base64 | tr -d <span class="string">'\n'</span>`</span><br><span class="line">POD_SUBNET=`sudo cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= <span class="string">'&#123;print $NF&#125;'</span>`</span><br><span class="line">sed -i <span class="string">"s@# etcd-key: null@etcd-key: <span class="variable">$&#123;ETCD_KEY&#125;</span>@g; s@# etcd-cert: null@etcd-cert: <span class="variable">$&#123;ETCD_CERT&#125;</span>@g; s@# etcd-ca: null@etcd-ca: <span class="variable">$&#123;ETCD_CA&#125;</span>@g"</span> calico-etcd.yaml</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s#etcd_ca: ""#etcd_ca: "/calico-secrets/etcd-ca"#g; s#etcd_cert: ""#etcd_cert: "/calico-secrets/etcd-cert"#g; s#etcd_key: "" #etcd_key: "/calico-secrets/etcd-key" #g'</span> calico-etcd.yaml</span><br><span class="line">sed -i <span class="string">'s#etcd_endpoints: "http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;"#etcd_endpoints: "https://192.168.12.107:2379,https://192.168.12.108:2379,https://192.168.12.109:2379"#g'</span> calico-etcd.yaml</span><br><span class="line">sed -i <span class="string">'s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: "192.168.0.0/16"@  value: '</span><span class="string">"<span class="variable">$&#123;POD_SUBNET&#125;</span>"</span><span class="string">'@g'</span> calico-etcd.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) éƒ¨ç½²åˆ°é›†ç¾¤ä¸­</span></span><br><span class="line">kubectl apply -f calico-etcd.yaml</span><br><span class="line"><span class="comment"># secret/calico-etcd-secrets created</span></span><br><span class="line"><span class="comment"># configmap/calico-config created</span></span><br><span class="line"><span class="comment"># clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># clusterrole.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="comment"># daemonset.apps/calico-node created</span></span><br><span class="line"><span class="comment"># serviceaccount/calico-node created</span></span><br><span class="line"><span class="comment"># deployment.apps/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># serviceaccount/calico-kube-controllers created</span></span><br><span class="line"><span class="comment"># poddisruptionbudget.policy/calico-kube-controllers created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç­‰å¾… 3-10 åˆ†é’Ÿï¼Œç›´åˆ°æ‰€æœ‰çš„å®¹å™¨ç»„å¤„äº Running çŠ¶æ€</span></span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"---ç­‰å¾…å®¹å™¨ç»„æ„å»ºå®Œæˆ---"</span> &amp;&amp; sleep 180</span><br><span class="line">kubectl get nodes -o wide       <span class="comment"># æŸ¥çœ‹ master èŠ‚ç‚¹åˆå§‹åŒ–ç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) å„èŠ‚ç‚¹ç½‘å¡åœ°å€å·²ç»æœªè®¾ç½®çš„PODå­ç½‘åœ°å€</span></span><br><span class="line">~$ route</span><br><span class="line"><span class="comment"># Kernel IP routing table</span></span><br><span class="line"><span class="comment"># Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span></span><br><span class="line"><span class="comment"># default         _gateway        0.0.0.0         UG    0      0        0 ens160</span></span><br><span class="line"><span class="comment"># default         _gateway        0.0.0.0         UG    0      0        0 ens160</span></span><br><span class="line"><span class="comment"># 172.16.0.192    0.0.0.0         255.255.255.192 U     0      0        0 *</span></span><br><span class="line"><span class="comment"># 172.16.0.193    0.0.0.0         255.255.255.255 UH    0      0        0 calib6c39f0a1d5</span></span><br><span class="line"><span class="comment"># 172.16.0.194    0.0.0.0         255.255.255.255 UH    0      0        0 calic77cbbaf4da</span></span><br><span class="line"><span class="comment"># 172.16.24.192   weiyigeek-223        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.100.64   weiyigeek-224        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.135.192  weiyigeek-108        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.182.192  weiyigeek-226        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.183.64   weiyigeek-225        255.255.255.192 UG    0      0        0 tunl0</span></span><br><span class="line"><span class="comment"># 172.16.243.64   weiyigeek-109        255.255.255.192 UG    0      0        0 tunl0</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-9-é«˜å¯ç”¨Masteråˆå§‹åŒ–ï¼Œå°†å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ§åˆ¶å¹³é¢"><a href="#Step-9-é«˜å¯ç”¨Masteråˆå§‹åŒ–ï¼Œå°†å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ§åˆ¶å¹³é¢" class="headerlink" title="Step 9.é«˜å¯ç”¨Masteråˆå§‹åŒ–ï¼Œå°†å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ§åˆ¶å¹³é¢"></a>Step 9.é«˜å¯ç”¨Masteråˆå§‹åŒ–ï¼Œå°†å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ§åˆ¶å¹³é¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm join weiyigeek-lb-vip.k8s:16443 --token 20w21w.httpweiyigeektop \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:7ea900ef214c98aef6d7daf1380320d0a43f666f2d4b6b7469077bd51790118e \</span><br><span class="line">  --control-plane --certificate-key 8327482265975b7a60f3549222f1093353ecaa148a3404cd10c605d4111566fc</span><br><span class="line"></span><br><span class="line">PS : ä½œä¸ºå®‰å…¨æªæ–½ï¼Œä¸Šä¼ çš„è¯ä¹¦å°†åœ¨ä¸¤å°æ—¶å†…è¢«åˆ é™¤; å¦‚æœéœ€è¦æ‚¨å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤é‡æ–°åŠ è½½è¯ä¹¦ã€‚</span><br><span class="line"><span class="string">"kubeadm init phase upload-certs --upload-certs"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ Token </span></span><br><span class="line">~/k8s-init$ kubectl get secret</span><br><span class="line">  <span class="comment"># NAME                  TYPE                                  DATA   AGE</span></span><br><span class="line">  <span class="comment"># default-token-xzcbz   kubernetes.io/service-account-token   3      17m</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-10-å·¥ä½œèŠ‚ç‚¹æˆ–è€…è´Ÿè½½åŠ å…¥åˆ°é›†ç¾¤ä¸­"><a href="#Step-10-å·¥ä½œèŠ‚ç‚¹æˆ–è€…è´Ÿè½½åŠ å…¥åˆ°é›†ç¾¤ä¸­" class="headerlink" title="Step 10.å·¥ä½œèŠ‚ç‚¹æˆ–è€…è´Ÿè½½åŠ å…¥åˆ°é›†ç¾¤ä¸­"></a>Step 10.å·¥ä½œèŠ‚ç‚¹æˆ–è€…è´Ÿè½½åŠ å…¥åˆ°é›†ç¾¤ä¸­</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) ä¸ºäº†ä¾¿äºå·¥ä½œèŠ‚ç‚¹å¿«é€Ÿæ¥å…¥åˆ°é›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å…ˆæŠŠmasterä¸­çš„é•œåƒå¯¼å…¥åˆ°å·¥ä½œèŠ‚ç‚¹</span></span><br><span class="line">docker save -o v1.19.6.tar $(docker images | grep -v TAG | cut -d <span class="string">' '</span> -f1)  <span class="comment"># å¯¼å‡º</span></span><br><span class="line">docker load -i v1.19.6.tar   <span class="comment"># åŠ è½½</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) ç„¶åä½ å¯ä»¥åŠ å…¥ä»»æ„æ•°é‡çš„workerèŠ‚ç‚¹ï¼Œåœ¨æ¯ä¸ªworkerèŠ‚ç‚¹ä¸Šä»¥rootç”¨æˆ·è¿è¡Œå¦‚ä¸‹å‘½ä»¤:</span></span><br><span class="line">sudo kubeadm join weiyigeek-lb-vip.k8s:16443 --token 20w21w.httpweiyigeektop \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:7ea900ef214c98aef6d7daf1380320d0a43f666f2d4b6b7469077bd51790118e</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Step-11-é›†ç¾¤çŠ¶æ€æŸ¥çœ‹-amp-é•œåƒæŸ¥çœ‹"><a href="#Step-11-é›†ç¾¤çŠ¶æ€æŸ¥çœ‹-amp-é•œåƒæŸ¥çœ‹" class="headerlink" title="Step 11.é›†ç¾¤çŠ¶æ€æŸ¥çœ‹ &amp; é•œåƒæŸ¥çœ‹"></a>Step 11.é›†ç¾¤çŠ¶æ€æŸ¥çœ‹ &amp; é•œåƒæŸ¥çœ‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) Master é›†ç¾¤çŠ¶æ€</span></span><br><span class="line">weiyigeek-107:~$ kubectl get node -o wide</span><br><span class="line">NAME       STATUS   ROLES    AGE    VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class="line">weiyigeek-107   Ready    master   25m    v1.19.6   192.168.1.107   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class="line">weiyigeek-108   Ready    master   15m    v1.19.6   192.168.1.108   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class="line">weiyigeek-109   Ready    master   100s   v1.19.6   192.168.1.109   &lt;none&gt;        Ubuntu 20.04.1 LTS   5.4.0-60-generic   docker://19.3.14</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) K8s é›†ç¾¤ SVC ä¿¡æ¯æŸ¥çœ‹</span></span><br><span class="line">~$ kubectl get svc -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   32m   &lt;none&gt;</span><br><span class="line">~$ kubectl get svc -o wide -n kube-system</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE   SELECTOR</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   31m   k8s-app=kube-dns</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) ä¸ºäº†å¯ä»¥èŠ‚çœèµ„æºå°†å…¶ä½™ä¸¤å°MasterèŠ‚ç‚¹å…³é—­æ±¡ç‚¹</span></span><br><span class="line">kubectl taint node weiyigeek-108 node-role.kubernetes.io/master=:NoSchedule-</span><br><span class="line">kubectl taint node weiyigeek-109 node-role.kubernetes.io/master=:NoSchedule-</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="0x04-é«˜å¯ç”¨é›†ç¾¤ä½¿ç”¨åˆä½“éªŒ"><a href="#0x04-é«˜å¯ç”¨é›†ç¾¤ä½¿ç”¨åˆä½“éªŒ" class="headerlink" title="0x04 é«˜å¯ç”¨é›†ç¾¤ä½¿ç”¨åˆä½“éªŒ"></a>0x04 é«˜å¯ç”¨é›†ç¾¤ä½¿ç”¨åˆä½“éªŒ</h2><p>æè¿°: ç®€å•å¯¹nginxåº”ç”¨ä»é•œåƒæ‰“åŒ…åˆ°éƒ¨ç½²åˆ°k8sé›†ç¾¤ä¸­ä½¿ç”¨æµç¨‹è¿›è¡Œæ¼”ç¤º</p>
<ul>
<li>Step 1.ç¼–å†™dockerfileå’Œç›¸å…³è„šæœ¬<br>$ cat dockerfile<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx</span><br><span class="line">LABEL maintainer=<span class="string">"Nginx Test Demo , Authorr: weiyigeek, Version: 2.2"</span></span><br><span class="line">ENV PATH /usr/<span class="built_in">local</span>/nginx/sbin:<span class="variable">$PATH</span></span><br><span class="line">ENV IMAGE_VERSION 2.2</span><br><span class="line">COPY ./host.sh /</span><br><span class="line">RUN chmod a+x /host.sh</span><br><span class="line">ENTRYPOINT [<span class="string">"/host.sh"</span>]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>$ cat host.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hostname: <span class="variable">$HOSTNAME</span>"</span> &gt; /usr/share/nginx/html/host.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Image Version: <span class="variable">$IMAGE_VERSION</span>"</span> &gt;&gt; /usr/share/nginx/html/host.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx Version: <span class="variable">$NGINX_VERSION</span>"</span> &gt;&gt; /usr/share/nginx/html/host.html</span><br><span class="line">sh -c <span class="string">"nginx -g 'daemon off;'"</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>Step 2.é•œåƒæ„å»º &amp; ä¸Šä¼ åˆ°ç§æœ‰å¾—Harborä»“åº“:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2 .</span><br><span class="line">$ docker images | grep <span class="string">"v2.2"</span></span><br><span class="line">  <span class="comment"># harbor.weiyigeek.top/test/nginx                                  v2.2                b8a212b2bc88        10 hours ago        133MB</span></span><br><span class="line">$ docker push harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2</span><br><span class="line">  <span class="comment"># The push refers to repository [harbor.weiyigeek.top/test/nginx]</span></span><br><span class="line">  <span class="comment"># v2.2: digest: sha256:4c49fc25d52e5331146699ff605561f59fb326505074c0474a3ce4898f0fcb02 size: 1776</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 3.éƒ¨ç½²é•œåƒ &amp; æŸ¥çœ‹:</li>
</ul>
<p><strong>æ–¹å¼1</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1.ä¸æ¨è(é…ç½®æ ‡ç­¾ä»¥åŠæ ‡ç­¾é€‰æ‹©éœ€è¦æ·»åŠ å‚æ•°ï¼Œæ¯”è¾ƒéº»çƒ¦)</span></span><br><span class="line">$ kubectl run nginx-deployment --image=harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2 --port=80</span><br><span class="line">  <span class="comment"># pod/nginx-deployment created</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">  <span class="comment"># NAME               READY   STATUS    RESTARTS   AGE    IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment   1/1     Running   0          108s   10.244.1.2   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨podSubnetè¿›è¡ŒæŸ¥çœ‹</span></span><br><span class="line">weiyigeek@ubuntu:~$ curl http://10.244.1.2/host.html</span><br><span class="line">  <span class="comment"># Hostname: nginx-deployment</span></span><br><span class="line">  <span class="comment"># Image Version: 2.2</span></span><br><span class="line">  <span class="comment"># Nginx Version: 1.19.4</span></span><br></pre></td></tr></table></figure></p>
<p><strong>æ–¹å¼2</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; nginx-deployment.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion: apps/v1	<span class="comment">#ä¸k8sé›†ç¾¤ç‰ˆæœ¬æœ‰å…³ï¼Œä½¿ç”¨ kubectl api-versions å³å¯æŸ¥çœ‹å½“å‰é›†ç¾¤æ”¯æŒçš„ç‰ˆæœ¬</span></span><br><span class="line">kind: Deployment   	<span class="comment">#è¯¥é…ç½®çš„ç±»å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Deployment</span></span><br><span class="line">metadata:	          <span class="comment">#è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³ Deployment çš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯</span></span><br><span class="line">  name: nginx-deployment	<span class="comment">#Deployment çš„åç§°</span></span><br><span class="line">  namespace: default </span><br><span class="line">  labels:	      <span class="comment">#æ ‡ç­¾å¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„ï¼Œç›®å‰ä¸éœ€è¦ç†è§£</span></span><br><span class="line">    app: nginx	<span class="comment">#ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾</span></span><br><span class="line">spec:	          <span class="comment">#è¿™æ˜¯å…³äºè¯¥Deploymentçš„æè¿°ï¼Œå¯ä»¥ç†è§£ä¸ºä½ æœŸå¾…è¯¥Deploymentåœ¨k8sä¸­å¦‚ä½•ä½¿ç”¨</span></span><br><span class="line">  replicas: 1  	<span class="comment">#ä½¿ç”¨è¯¥Deploymentåˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹</span></span><br><span class="line">  selector:	    <span class="comment">#æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸ä¸Šé¢çš„æ ‡ç­¾å…±åŒä½œç”¨ï¼Œç›®å‰ä¸éœ€è¦ç†è§£</span></span><br><span class="line">    matchLabels: <span class="comment">#é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„èµ„æº</span></span><br><span class="line">      app: nginx</span><br><span class="line">  template:	     <span class="comment">#è¿™æ˜¯é€‰æ‹©æˆ–åˆ›å»ºçš„Podçš„æ¨¡æ¿</span></span><br><span class="line">    metadata:	   <span class="comment">#Podçš„å…ƒæ•°æ®</span></span><br><span class="line">      labels:    <span class="comment">#Podçš„æ ‡ç­¾ï¼Œä¸Šé¢çš„selectorå³é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„Pod</span></span><br><span class="line">        app: nginx</span><br><span class="line">    spec:	        <span class="comment">#æœŸæœ›Podå®ç°çš„åŠŸèƒ½(å³åœ¨podä¸­éƒ¨ç½²)</span></span><br><span class="line">      containers:	<span class="comment">#ç”Ÿæˆcontainerï¼Œä¸dockerä¸­çš„containeræ˜¯åŒä¸€ç§</span></span><br><span class="line">      - name: nginx	<span class="comment">#containerçš„åç§°</span></span><br><span class="line">        image: harbor.weiyigeek.top/<span class="built_in">test</span>/nginx:v2.2 	<span class="comment">#ä½¿ç”¨é•œåƒnginxæœ€æ–°ç‰ˆæœ¬åˆ›å»ºcontainerï¼Œè¯¥containeré»˜è®¤80ç«¯å£å¯è®¿é—®</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-deployment.yaml</span><br><span class="line">  <span class="comment"># deployment.apps/nginx-deployment created</span></span><br><span class="line"></span><br><span class="line">$ kubectl get deployment</span><br><span class="line">  <span class="comment"># NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line">  <span class="comment"># nginx-deployment   1/1     1            1           87s</span></span><br><span class="line">  <span class="comment"># weiyigeek@ubuntu:~/nginx$ kubectl get pod</span></span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-flmsf   1/1     Running   0          92s</span></span><br><span class="line">  <span class="comment"># weiyigeek@ubuntu:~/nginx$ kubectl get pod -o wide</span></span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-flmsf   1/1     Running   0          99s   10.244.1.4   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">~/nginx$ curl http://10.244.1.4/host.html</span><br><span class="line">  <span class="comment"># Hostname: nginx-deployment-7f5d9779c6-flmsf</span></span><br><span class="line">  <span class="comment"># Image Version: 2.2</span></span><br><span class="line">  <span class="comment"># Nginx Version: 1.19.4</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>Step 4.Pod å‰¯æœ¬ &amp; æ”¶ç¼© &amp; ç«¯å£æ˜ å°„</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod nginx-deployment-7f5d9779c6-flmsf</span><br><span class="line">  <span class="comment"># pod "nginx-deployment-7f5d9779c6-flmsf" deleted</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-hhl7k   1/1     Running   0          60s   10.244.1.5   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">$ kubectl scale --replicas=3 deployment/nginx-deployment</span><br><span class="line">  <span class="comment"># deployment.apps/nginx-deployment scaled</span></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">  <span class="comment"># NAME                                READY   STATUS    RESTARTS   AGE    IP           NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-dr5h8   1/1     Running   0          4s     10.244.1.7   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-hhl7k   1/1     Running   0          109s   10.244.1.5   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># nginx-deployment-7f5d9779c6-sk2f4   1/1     Running   0          4s     10.244.1.6   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">$ kubectl edit svc nginx-deployment  <span class="comment"># ç¬¬ä¸€ç« ä¸­æœ‰ä»‹ç» SVCï¼Œä¸çŸ¥é“å›å»çœ‹ä¸€å“ˆ</span></span><br><span class="line">$ kubectl expose -f nginx-controller.yaml --port=80 --target-port=8000 --protocol=TCP --<span class="built_in">type</span>=NodePort --node-port=31855  <span class="comment"># åç»­éªŒè¯</span></span><br><span class="line">$ kubectl expose svc nginx-deployment --port=80 --target-port=8000 --protocol=TCP --<span class="built_in">type</span>=NodePort</span><br><span class="line">  <span class="comment"># type: NodePort</span></span><br><span class="line">$ kubectl get svc</span><br><span class="line">  <span class="comment"># NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)           AGE</span></span><br><span class="line">  <span class="comment"># kubernetes         ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP           2d22h</span></span><br><span class="line">  <span class="comment"># nginx-deployment   NodePort    10.99.90.247   &lt;none&gt;        30000:31855/TCP   39h</span></span><br><span class="line"></span><br><span class="line">$ sudo netstat -anpt | grep <span class="string">"31855"</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:31855           0.0.0.0:*               LISTEN      1931726/kube-proxy</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.IPVS è´Ÿè½½å‡è¡¡å’Œrrè½®è¯¢æœºåˆ¶æŸ¥çœ‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ipvsadm -Ln</span><br><span class="line">  # IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">  # Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  #   -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">  # TCP  10.10.107.202:31855 rr</span><br><span class="line">  #   -&gt; 10.244.1.5:80                Masq    1      0          1</span><br><span class="line">  #   -&gt; 10.244.1.6:80                Masq    1      1          1</span><br><span class="line">  #   -&gt; 10.244.1.7:80                Masq    1      0          1</span><br><span class="line">  # TCP  10.96.0.1:443 rr</span><br><span class="line">  #   -&gt; 10.10.107.202:6443           Masq    1      3          0</span><br><span class="line">  # TCP  10.96.0.10:53 rr</span><br><span class="line">  #   -&gt; 10.244.0.4:53                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.0.5:53                Masq    1      0          0</span><br><span class="line">  # TCP  10.96.0.10:9153 rr</span><br><span class="line">  #   -&gt; 10.244.0.4:9153              Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.0.5:9153              Masq    1      0          0</span><br><span class="line">  # TCP  10.99.90.247:30000 rr</span><br><span class="line">  #   -&gt; 10.244.1.5:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.6:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.7:80                Masq    1      0          0</span><br><span class="line">  # TCP  127.0.0.1:31855 rr</span><br><span class="line">  #   -&gt; 10.244.1.5:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.6:80                Masq    1      0          0</span><br><span class="line">  #   -&gt; 10.244.1.7:80                Masq    1      0          0</span><br><span class="line"></span><br><span class="line"># åŸºäºRRè½®è®­è´Ÿè½½</span><br><span class="line">Hostname: nginx-deployment-7f5d9779c6-dr5h8 Image Version: 2.2 Nginx Version: 1.19.4 </span><br><span class="line">Hostname: nginx-deployment-7f5d9779c6-sk2f4 Image Version: 2.2 Nginx Version: 1.19.4 </span><br><span class="line">Hostname: nginx-deployment-7f5d9779c6-hhl7k Image Version: 2.2 Nginx Version: 1.19.4</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201107003214.png" target="_blank" title="WeiyiGeek.rrè½®ä¼‘æœºåˆ¶" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201107003214.png" alt="WeiyiGeek.rrè½®ä¼‘æœºåˆ¶" title="" class=""></a>
                <p>WeiyiGeek.rrè½®ä¼‘æœºåˆ¶</p>
            </figure>

        </div>
        <!-- Google å¹¿å‘Š -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-06-15T03:03:27.124Z" itemprop="dateUpdated">2022-06-15 11:03:27</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2020/4-27-470.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/4-27-470.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=ã€Š3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=ã€Š3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤ã€‹ â€” WeiyiGeek Blog&source=WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ª..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/4-27-470.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/4-28-203.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Ubuntu-20.04-LTS(æ¡Œé¢ä¸æœåŠ¡å™¨)ç‰ˆåŸºç¡€é…ç½®</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/4-27-530.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">11-Kubernetesè¿›é˜¶ä¹‹åŸç†æ¶æ„å­¦ä¹ åŠæ“ä½œé…ç½®</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 å‰è¨€ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-åŸºç¡€ç¯å¢ƒå‡†å¤‡"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 åŸºç¡€ç¯å¢ƒå‡†å¤‡</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-ç¯å¢ƒè¯´æ˜"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.ç¯å¢ƒè¯´æ˜</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-ç¯å¢ƒæ“ä½œ"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.ç¯å¢ƒæ“ä½œ</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-å•å®ä¾‹K8sé›†ç¾¤éƒ¨ç½²-v1-20-1"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 å•å®ä¾‹K8sé›†ç¾¤éƒ¨ç½²(v1.20.1)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Master-èŠ‚ç‚¹åˆå§‹åŒ–"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.Master èŠ‚ç‚¹åˆå§‹åŒ–</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-é›†ç¾¤ç®¡ç†"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.é›†ç¾¤ç®¡ç†</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-é›†ç¾¤ç½‘ç»œæ’ä»¶å®‰è£…"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.é›†ç¾¤ç½‘ç»œæ’ä»¶å®‰è£…</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-å·¥ä½œèŠ‚ç‚¹åŠ å…¥"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.å·¥ä½œèŠ‚ç‚¹åŠ å…¥</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-Token-å¤±æ•ˆé‡ç”Ÿæˆ"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">4.Token å¤±æ•ˆé‡ç”Ÿæˆ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-èŠ‚ç‚¹é‡ç½®"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">5.èŠ‚ç‚¹é‡ç½®</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-é«˜å¯ç”¨K8sé›†ç¾¤éƒ¨ç½²-v1-19-6"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 é«˜å¯ç”¨K8sé›†ç¾¤éƒ¨ç½²(v1.19.6)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-1-é«˜å¯ç”¨ç»„ä»¶å®‰è£…æ‰€æœ‰MasterèŠ‚ç‚¹é€šè¿‡aptå®‰è£…HAProxyå’ŒKeepAlived"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Step 1.é«˜å¯ç”¨ç»„ä»¶å®‰è£…æ‰€æœ‰MasterèŠ‚ç‚¹é€šè¿‡aptå®‰è£…HAProxyå’ŒKeepAlived</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-2-æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®HAProxy"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">Step 2.æ‰€æœ‰MasterèŠ‚ç‚¹é…ç½®HAProxy</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-3-é…ç½®KeepAlivedå¥åº·æ£€æŸ¥æ–‡ä»¶"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Step 3.é…ç½®KeepAlivedå¥åº·æ£€æŸ¥æ–‡ä»¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-4-å¯åŠ¨haproxyå’Œkeepalivedä»¥åŠæµ‹è¯•VIP"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">Step 4.å¯åŠ¨haproxyå’Œkeepalivedä»¥åŠæµ‹è¯•VIP</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-5-é›†ç¾¤å®‰è£…å…¶å®ƒæŒ‡å®šç‰ˆæœ¬"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">Step 5.é›†ç¾¤å®‰è£…å…¶å®ƒæŒ‡å®šç‰ˆæœ¬</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-6-é›†ç¾¤åˆå§‹åŒ–çš„yamlæ–‡ä»¶"><span class="post-toc-number">4.6.</span> <span class="post-toc-text">Step 6.é›†ç¾¤åˆå§‹åŒ–çš„yamlæ–‡ä»¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-7-Kubernetes-é›†ç¾¤è®¿é—®é…ç½®"><span class="post-toc-number">4.7.</span> <span class="post-toc-text">Step 7.Kubernetes é›†ç¾¤è®¿é—®é…ç½®</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-8-ç°åœ¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤-æ­¤å¤„é€‰ç”¨calicoç½‘ç»œæ’ä»¶è€Œéä½¿ç”¨flannelæ’ä»¶"><span class="post-toc-number">4.8.</span> <span class="post-toc-text">Step 8.ç°åœ¨åº”è¯¥å°†podç½‘ç»œéƒ¨ç½²åˆ°é›†ç¾¤,æ­¤å¤„é€‰ç”¨calicoç½‘ç»œæ’ä»¶è€Œéä½¿ç”¨flannelæ’ä»¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-9-é«˜å¯ç”¨Masteråˆå§‹åŒ–ï¼Œå°†å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ§åˆ¶å¹³é¢"><span class="post-toc-number">4.9.</span> <span class="post-toc-text">Step 9.é«˜å¯ç”¨Masteråˆå§‹åŒ–ï¼Œå°†å…¶ä»–masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ§åˆ¶å¹³é¢</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-10-å·¥ä½œèŠ‚ç‚¹æˆ–è€…è´Ÿè½½åŠ å…¥åˆ°é›†ç¾¤ä¸­"><span class="post-toc-number">4.10.</span> <span class="post-toc-text">Step 10.å·¥ä½œèŠ‚ç‚¹æˆ–è€…è´Ÿè½½åŠ å…¥åˆ°é›†ç¾¤ä¸­</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Step-11-é›†ç¾¤çŠ¶æ€æŸ¥çœ‹-amp-é•œåƒæŸ¥çœ‹"><span class="post-toc-number">4.11.</span> <span class="post-toc-text">Step 11.é›†ç¾¤çŠ¶æ€æŸ¥çœ‹ &amp; é•œåƒæŸ¥çœ‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-é«˜å¯ç”¨é›†ç¾¤ä½¿ç”¨åˆä½“éªŒ"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 é«˜å¯ç”¨é›†ç¾¤ä½¿ç”¨åˆä½“éªŒ</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½çœ‹å‹,æ¬¢è¿å…³æ³¨åšä¸»å¾®ä¿¡å…¬ä¼—å·å“Ÿ! â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘å³å¯å…³é—­ç»§ç»­æµè§ˆæ–‡ç« .<br>  <b style="color:red;"> æ¸©é¦¨æç¤º: æœªè§£é”çš„ç”¨æˆ·ä¸èƒ½ç²˜è´´å¤åˆ¶æ–‡ç« å†…å®¹å“Ÿ!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=ã€Š3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/4-27-470.html&title=ã€Š3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤ã€‹ â€” WeiyiGeek Blog&source=WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ª..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š3-Kuberneteså…¥é—¨ä¹‹Ubuntuå®‰è£…éƒ¨ç½²é›†ç¾¤ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/4-27-470.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/4-27-470.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKUlEQVR42u3aQXLjMAwEwPz/09rrVm1FmQFtZ0U2TyonFtk6wBCAr694XX+t5K/XP+u7b+W7vGBhYGA8lnHdrnyD5FsJ6f5xfHsSDAyMAxj5re8fQfKA7ndp2RgYGBgtIznW/Z0xMDAw1hlFuha8oP5awMXAwHggIwmds3RwpTz3lndxDAyMBzLyqvvnr9/S38DAwHgU4yrXZ/qG9akwMDC2ZuQBbpbMrYxu1MMfGBgYRzKS19TZQfMCXP4JBgbGrow2HcwL923Rv2121hkuBgbGYxl52jfbYL1hWfwYYGBgbMpItmnHL5JSWh6aozNgYGBszZgV+tsxrzy5zJFLTU0MDIxHMdqgOQOvNwN++BYGBsYBjOSIbWszL6Lln0dVQwwMjO0Ys6Tt/tZt0vmCeiEGBsYxjBaW8FYKbe2gGAYGxq6MtjHZstsC3LD9iYGBcQxj1irIRzFmexW/DBgYGFszZhllfvSVkbLobBgYGFsz8nRtpRDWltjaEQ0MDIxzGMMwVxbdZsE6ehAYGBgHMJICWf76OivV5dcYGBgnM/Km4yyMDgcm2pdYDAyMjRhXuVYYbZAtWqoYGBhbM141IpZfJ0eZ3Q0DA2NvxqxAlrcKZtX7PD3FwMA4h5EHvvUG5GxA7QckBgYGRtk8aANui49mRjAwMDDKQlgyxtH+z4cCLgYGxn/DaJsBeSl/Jby+pdyGgYHxQMbKpMbKy+dKkW7YyMTAwHge4w/LxdE/xIKo6QAAAABJRU5ErkJggg==" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// ç«™ç‚¹è¿è¡Œæ—¶é—´
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "å¤©" + RunHours + "æ—¶" + RunMinutes + "åˆ†" + RunSeconds + "ç§’";
  document.getElementById(id).innerHTML = "ç½‘ç«™å·²åœ¨é£é›¨ä¸­å‹‰å‹‰å¼ºå¼ºè¿è¡Œäº†ã€" + RunTime + "ã€‘";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>