{"title":"5.Jenkins进阶之分布式架构扩充知识","slug":"系统运维/自动化运维/CI-CD/Jenkins/5.Jenkins进阶之分布式架构扩充知识","date":"2020-12-31T04:34:30.000Z","updated":"2023-02-02T06:16:34.174Z","url":"2020/12-31-533.html","path":"api/articles/2020/12-31-533.html.json","covers":["https://img.weiyigeek.top/2021/1/20210207131120.png","https://img.weiyigeek.top/2021/1/20210330173121.png","https://img.weiyigeek.top/2021/1/20210208155114.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>描述: 有了上一章的基础<code>&quot;4.Jenkins进阶之分布式架构环境配置&quot;</code>介绍，本章主要介绍Kubernetes 的插件使用实例, 以及自定义 Slave 的 Jenkins-Jnlp 容器镜像模板(重点)，在进行K8s动态节点生成时拉取使用，极大的节约了系统资源。</p>\n<hr>\n<h2 id=\"0x01-Kubernetes-plugin-使用\"><a href=\"#0x01-Kubernetes-plugin-使用\" class=\"headerlink\" title=\"0x01 Kubernetes-plugin 使用\"></a>0x01 Kubernetes-plugin 使用</h2><p>描述: 前面已经对Jenkins集成Kubernetes进行部署和配置，本章将进行介绍与实践如何使用该插件以及帮助文档的记录;</p>\n<p>说明: Kubernetes-plugin 它是在Kubernetes集群中运行动态代理的Jenkins插件, 该插件为每个启动的代理创建一个Kubernetes Pod，由Docker映像定义运行，并在每次构建后停止。</p>\n<p>备注: 代理是使用JNLP启动的，因此预期图像会自动连接到Jenkins主机，以下是重要的环境变量（我们说过不建议使用自己jnlp覆盖默认的jnlp容器）。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># jenkins/inbound-agent </span></span><br><span class=\"line\">JENKINS_URL: Jenkins web interface url</span><br><span class=\"line\">JENKINS_SECRET: the secret key <span class=\"keyword\">for</span> authentication</span><br><span class=\"line\">JENKINS_AGENT_NAME: the name of the Jenkins agent</span><br><span class=\"line\">JENKINS_NAME: the name of the Jenkins agent (Deprecated. Only here <span class=\"keyword\">for</span> backwards compatibility)</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>插件地址: <a href=\"https://github.com/jenkinsci/kubernetes-plugin\" target=\"_blank\" rel=\"noopener\">https://github.com/jenkinsci/kubernetes-plugin</a></li>\n<li>自定义jnlp容器模板镜像地址: <a href=\"https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp</a></li>\n</ul>\n<p>该镜像是Jenkins自定义jnlp容器模板，主要用于Jenkins工作节点容器化使用，主要包含Gitlab_release发布、 docker 容器管理、kubectl 集群管理功能。我们可以直接在docker 的环境中 <code>docker pull weiyigeek/alpine-jenkins-jnlp</code>下来</p>\n<p><br></p>\n<h3 id=\"环境依赖\"><a href=\"#环境依赖\" class=\"headerlink\" title=\"环境依赖\"></a>环境依赖</h3><ul>\n<li><p><strong>1.先决条件</strong></p>\n<ul>\n<li>正在运行的Kubernetes集群1.14或更高版本。对于OpenShift用户，这意味着OpenShift容器平台4.x。</li>\n<li>安装了一个Jenkins实例</li>\n<li>已安装Jenkins Kubernetes插件</li>\n</ul>\n</li>\n<li><p><strong>2.填写Kubernetes插件配置</strong></p>\n<ul>\n<li>您将打开Jenkins UI并导航至Manage Jenkins-&gt; Configure System-&gt; Cloud-&gt; Kubernetes并输入相应的Kubernetes URL和Jenkins URL，除非Jenkins在Kubernetes中运行否则默认工作（参考上一章）。</li>\n</ul>\n</li>\n<li><p><strong>3.支持的凭证</strong></p>\n<ul>\n<li>Username/password - 用户名密码</li>\n<li>Secret File (kubeconfig file) - 秘密文件（kubeconfig文件）</li>\n<li>Secret text (Token-based authentication) (OpenShift) - 秘密文本（基于令牌的身份验证）（OpenShift）</li>\n<li>Google Service Account from private key (GKE authentication) - 来自私钥的Google服务帐户（GKE身份验证）</li>\n<li>X.509 Client Certificate - X.509客户端证书</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"插件参数\"><a href=\"#插件参数\" class=\"headerlink\" title=\"插件参数\"></a>插件参数</h3><h4 id=\"podTemplate-Pod和容器模板\"><a href=\"#podTemplate-Pod和容器模板\" class=\"headerlink\" title=\"podTemplate - Pod和容器模板\"></a>podTemplate - Pod和容器模板</h4><p>描述: podTemplate 是用于创建代理的pod的模板可以通过<code>用户界面或管道进行配置</code>, 无论哪种方式它都可以访问以下字段：</p>\n<ul>\n<li>1) cloud ：在Jenkins设置中定义的云的名称。默认为kubernetes</li>\n<li>2) name : Pod 名称</li>\n<li>3) namespace : 名称空间设置</li>\n<li>4) label : 标签值可以设置为唯一的值，以避免跨构建冲突，或省略，并在步骤中定义POD_LABEL。</li>\n<li>5) yaml : 资源清单声明</li>\n<li>6) yamlFile : 指定资源清单的文件</li>\n<li>7) yamlMergeStrategy : 控制yaml定义是覆盖还是与从用声明的pod模板继承的yaml定义合并inheritFrom。默认为override()。</li>\n<li>8) showRawYaml : 启用或禁用原始Yaml文件的输出默认为true (后续实践)</li>\n<li>8) serviceAccount : k8s中创建的服务帐户</li>\n<li>9) nodeSelector ：节点选择器</li>\n<li>10) nodeUsageMode : 节点调用模式(NORMAL它控制Jenkins是只调度标签表达式匹配的作业，EXCLUSIVE尽可能多地使用该节点。)</li>\n<li>11) volumes ：为pod定义各种类型的卷并在所有容器中挂载卷</li>\n<li>12) envVars ：应用于所有容器的环境变量(<code>envVar 环境变量其值是内联定义的, secretEnvVar 一个环境变量其值是从Kubernetes机密派生的。</code>)</li>\n<li>13) imagePullSecrets : 从私有的镜像仓库中拉取镜像的凭据</li>\n<li>14) annotations : Pod 注解</li>\n<li>15) InheritFrom ：继承的一个或多个Pod模板的列表</li>\n<li>16) slaveConnectTimeout : 代理程序联机超时时间（单位s）</li>\n<li>17) podRetention ：控制保留代理Pod的行为(<code>Can be &#39;never()&#39;, &#39;onFailure()&#39;, &#39;always()&#39;, or &#39;default()&#39;</code>),如果为空则按照下面的active Deadline Seconds参数进行。</li>\n<li>18) activeDeadlineSeconds ： pod将在这个截止日期过后被删除。</li>\n<li>19) idleMinutes : 允许Pod保持活动状态以供重用，直到在执行最后一步以来经过了配置的分钟数为止。</li>\n<li>20) runAsUser : 用户ID，用于将pod中的所有容器运行为。</li>\n<li>21) runAsGroup : 组ID，用于将Pod中的所有容器运行为。</li>\n<li>22) hostNetwork : 使用主机网络。</li>\n<li>23) container  : 用于创建pod容器的容器模板 (见下文) - (重点)。</li>\n<li>24) defaultContainer : 指定Pod中默认容器则在stages中不用加入container进行指定选择;</li>\n</ul>\n<p><br></p>\n<h4 id=\"container-容器模板的定义\"><a href=\"#container-容器模板的定义\" class=\"headerlink\" title=\"container - 容器模板的定义\"></a>container - 容器模板的定义</h4><p>描述: containerTemplate 是一个将被添加到pod中的容器模板它属于container中数组对象。同样它可以通过用户界面或管道进行配置，并允许你设置以下字段:</p>\n<p><strong>containerTemplate - 容器模板</strong></p>\n<ul>\n<li>name  : 容器的名称。</li>\n<li>image : 容器的图像。</li>\n<li>envVars : 应用于容器的环境变量（<code>补充和覆盖在pod级别设置的env var</code>）。<ul>\n<li>envVar 环境变量，其值是内联定义的。</li>\n<li>secretEnvVar 一个环境变量，其值是从Kubernetes机密派生的。</li>\n</ul>\n</li>\n<li>workingDir : 工作空间目录</li>\n<li>command : 容器将执行的命令。</li>\n<li>args    : 传递给命令的参数。</li>\n<li>ttyEnabled : 标记以指示应启用tty。</li>\n<li>livenessProbe : 要添加到容器中的exec liveness探针的参数（不支持httpGet liveness探针）</li>\n<li>ports : 暴露容器上的端口。</li>\n<li>alwaysPullImage : 容器在启动时将拉出图像。</li>\n<li>runAsUser : 用于运行容器的用户ID。</li>\n<li>runAsGroup : 运行容器的组ID。</li>\n</ul>\n<p><br/></p>\n<p><strong>Liveness Probe Usage</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">containerTemplate(</span><br><span class=\"line\">  name: <span class=\"string\">'busybox'</span>, </span><br><span class=\"line\">  image: <span class=\"string\">'busybox'</span>,</span><br><span class=\"line\">  ttyEnabled: <span class=\"literal\">true</span>, </span><br><span class=\"line\">  <span class=\"built_in\">command</span>: <span class=\"string\">'cat'</span>, </span><br><span class=\"line\">  livenessProbe: containerLivenessProbe( </span><br><span class=\"line\">    execArgs: <span class=\"string\">'some --command'</span>, </span><br><span class=\"line\">    initialDelaySeconds: 30, </span><br><span class=\"line\">    timeoutSeconds: 1, </span><br><span class=\"line\">    failureThreshold: 3, </span><br><span class=\"line\">    periodSeconds: 10, </span><br><span class=\"line\">    successThreshold: 1</span><br><span class=\"line\">  )</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure></p>\n<p>Tips : 默认情况下<code>代理连接超时设置为100秒</code>。在某些情况下您想要设置一个不同的值，如果可以可以将system属性设置<code>org.csanchez.jenkins.plugins.kubernetes.PodTemplate.connectionTimeout</code>为一个不同的值</p>\n<hr>\n<h3 id=\"Pipeline-Support-实践示例\"><a href=\"#Pipeline-Support-实践示例\" class=\"headerlink\" title=\"Pipeline Support 实践示例\"></a>Pipeline Support 实践示例</h3><h4 id=\"Scripted-Pipeline\"><a href=\"#Scripted-Pipeline\" class=\"headerlink\" title=\"Scripted Pipeline\"></a>Scripted Pipeline</h4><p>描述： Scripted Pipeline 示例参考: </p>\n<ul>\n<li><a href=\"https://github.com/jenkinsci/kubernetes-plugin/tree/master/examples\" target=\"_blank\" rel=\"noopener\">https://github.com/jenkinsci/kubernetes-plugin/tree/master/examples</a></li>\n<li><a href=\"https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline\" target=\"_blank\" rel=\"noopener\">https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline</a></li>\n</ul>\n<p><br></p>\n<p><strong>(1) containerTemplate</strong><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">podTemplate(</span><br><span class=\"line\"><span class=\"symbol\">  cloud:</span> <span class=\"string\">'kubernetes'</span>,</span><br><span class=\"line\"><span class=\"symbol\">  name:</span> <span class=\"string\">'jenkins-slave'</span>,</span><br><span class=\"line\"><span class=\"symbol\">  namespace:</span> <span class=\"string\">'devops'</span>,</span><br><span class=\"line\"><span class=\"symbol\">  label:</span> <span class=\"string\">'k8s-slave'</span>,</span><br><span class=\"line\">  <span class=\"comment\">// 容器及容器模板定义</span></span><br><span class=\"line\"><span class=\"symbol\">  containers:</span> [</span><br><span class=\"line\">    containerTemplate(</span><br><span class=\"line\"><span class=\"symbol\">      name:</span> <span class=\"string\">'maven'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      image:</span> <span class=\"string\">'maven:3.6-jdk-8-alpine'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      ttyEnabled:</span> <span class=\"literal\">true</span>,</span><br><span class=\"line\"><span class=\"symbol\">      command:</span> <span class=\"string\">'cat'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      privileged:</span> <span class=\"literal\">false</span>,</span><br><span class=\"line\"><span class=\"symbol\">      alwaysPullImage:</span> <span class=\"literal\">false</span>,</span><br><span class=\"line\"><span class=\"symbol\">      workingDir:</span> <span class=\"string\">'/home/jenkins/agent'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      resourceRequestCpu:</span> <span class=\"string\">'100m'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      resourceLimitCpu:</span> <span class=\"string\">'500m'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      resourceRequestMemory:</span> <span class=\"string\">'100Mi'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      resourceLimitMemory:</span> <span class=\"string\">'500Mi'</span>,</span><br><span class=\"line\"><span class=\"symbol\">      envVars:</span> [</span><br><span class=\"line\">        envVar(<span class=\"string\">key:</span> <span class=\"string\">'MYSQL_ALLOW_EMPTY_PASSWORD'</span>, <span class=\"string\">value:</span> <span class=\"string\">'true'</span>)</span><br><span class=\"line\">       <span class=\"comment\">//, secretEnvVar(key: 'MYSQL_PASSWORD', secretName: 'mysql-secret', secretKey: 'password')</span></span><br><span class=\"line\">      ]</span><br><span class=\"line\">      <span class=\"comment\">//,ports: [portMapping(name: 'mysql', containerPort: 3306, hostPort: 3306)]</span></span><br><span class=\"line\">    )</span><br><span class=\"line\">    <span class=\"comment\">//     ),</span></span><br><span class=\"line\">    <span class=\"comment\">// containerTemplate(</span></span><br><span class=\"line\">    <span class=\"comment\">//         name: 'jnlp',</span></span><br><span class=\"line\">    <span class=\"comment\">//         image: 'registry.cn-hangzhou.aliyuncs.com/google-containers/jnlp-slave:alpine',</span></span><br><span class=\"line\">    <span class=\"comment\">//         args: '$&#123;computer.jnlpmac&#125; $&#123;computer.name&#125;',</span></span><br><span class=\"line\">    <span class=\"comment\">//         command: ''</span></span><br><span class=\"line\">    <span class=\"comment\">//     )</span></span><br><span class=\"line\">  ]</span><br><span class=\"line\">  ,<span class=\"string\">volumes:</span> [</span><br><span class=\"line\">    hostPathVolume(<span class=\"string\">hostPath:</span> <span class=\"string\">'/nfsdisk-31/appstorage/mavenRepo'</span>, <span class=\"string\">mountPath:</span> <span class=\"string\">'/home/jenkins'</span>),</span><br><span class=\"line\">    hostPathVolume(<span class=\"string\">hostPath:</span> <span class=\"string\">'/var/run/docker.sock'</span>, <span class=\"string\">mountPath:</span> <span class=\"string\">'/var/run/docker.sock'</span>),</span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    emptyDirVolume(mountPath: '/etc/mount1', memory: false),</span></span><br><span class=\"line\"><span class=\"comment\">    secretVolume(mountPath: '/etc/mount2', secretName: 'my-secret'),</span></span><br><span class=\"line\"><span class=\"comment\">    configMapVolume(mountPath: '/etc/mount3', configMapName: 'my-config'),</span></span><br><span class=\"line\"><span class=\"comment\">    hostPathVolume(mountPath: '/etc/mount4', hostPath: '/mnt/my-mount'),</span></span><br><span class=\"line\"><span class=\"comment\">    nfsVolume(mountPath: '/etc/mount5', serverAddress: '127.0.0.1', serverPath: '/', readOnly: true),</span></span><br><span class=\"line\"><span class=\"comment\">    persistentVolumeClaim(mountPath: '/home/jenkins', claimName: 'jenkins', readOnly: false),</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\"><span class=\"symbol\">  annotations:</span> [</span><br><span class=\"line\">    podAnnotation(<span class=\"string\">key:</span> <span class=\"string\">\"maven-pod\"</span>, <span class=\"string\">value:</span> <span class=\"string\">\"Kubernetes-jenkins-Test\"</span>)</span><br><span class=\"line\">  ],</span><br><span class=\"line\"><span class=\"symbol\">  showRawYaml:</span> <span class=\"string\">'flase'</span></span><br><span class=\"line\">  <span class=\"comment\">//,defaultContainer: 'maven'   # scripted pipeline 不支持该参数</span></span><br><span class=\"line\">  <span class=\"comment\">//,imagePullSecrets: [ 'pull-secret' ]</span></span><br><span class=\"line\">)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> <span class=\"comment\">// 注意此次node中则为Pod模板名称</span></span><br><span class=\"line\"> node (<span class=\"string\">'k8s-slave'</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// container 中指定Pod中容器名称</span></span><br><span class=\"line\">    container(<span class=\"string\">'maven'</span>) &#123;</span><br><span class=\"line\">      stage(<span class=\"string\">'maven'</span>) &#123;</span><br><span class=\"line\">        container(<span class=\"string\">'maven'</span>) &#123;</span><br><span class=\"line\">          sh <span class=\"string\">\"hostname &amp;&amp; ip addr\"</span></span><br><span class=\"line\">          sh (<span class=\"string\">\"mvn -version\"</span>)</span><br><span class=\"line\">          sh <span class=\"string\">\"env\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>运行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Still waiting to schedule task</span></span><br><span class=\"line\"><span class=\"comment\"># Waiting for next available executor on 'jenkins-slave-09vf0-sf3k6' </span></span><br><span class=\"line\"><span class=\"comment\"># 等待下一个可用的执行器启动</span></span><br><span class=\"line\"></span><br><span class=\"line\">Created Pod: kubernetes devops/jenkins-slave-rtjxx-q3nhn</span><br><span class=\"line\">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Scheduled] Successfully assigned devops/jenkins-slave-rtjxx-q3nhn to work-223</span><br><span class=\"line\"></span><br><span class=\"line\">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Pulled] Container image <span class=\"string\">\"maven:3.6-jdk-8-alpine\"</span> already present on machine</span><br><span class=\"line\">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Created] Created container maven | Started container maven</span><br><span class=\"line\"></span><br><span class=\"line\">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Pulled] Container image <span class=\"string\">\"jenkins/inbound-agent:4.3-4\"</span> already present on machine</span><br><span class=\"line\">[Normal][devops/jenkins-slave-rtjxx-q3nhn][Created] Created container jnlp | Started container jnlp</span><br><span class=\"line\"></span><br><span class=\"line\">Agent jenkins-slave-rtjxx-q3nhn is provisioned from template jenkins-slave-rtjxx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----------------------------------</span></span><br><span class=\"line\">apiVersion: <span class=\"string\">\"v1\"</span></span><br><span class=\"line\">kind: <span class=\"string\">\"Pod\"</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    maven-pod: <span class=\"string\">\"Kubernetes-jenkins-Test\"</span>   <span class=\"comment\"># 我们添加的注解</span></span><br><span class=\"line\">    buildUrl: <span class=\"string\">\"http://jenkins.devops.svc.cluster.local:8080/job/Kubernetes-jenkins-slave/23/\"</span></span><br><span class=\"line\">    runUrl: <span class=\"string\">\"job/Kubernetes-jenkins-slave/23/\"</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    jenkins: <span class=\"string\">\"slave\"</span></span><br><span class=\"line\">    jenkins/label-digest: <span class=\"string\">\"823e2bb3db243573786b7a360a483f1acc7a0f96\"</span></span><br><span class=\"line\">    jenkins/label: <span class=\"string\">\"k8s-slave\"</span></span><br><span class=\"line\">  name: <span class=\"string\">\"jenkins-slave-rtjxx-q3nhn\"</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - <span class=\"string\">\"cat\"</span>   <span class=\"comment\"># 运行的命令</span></span><br><span class=\"line\">    env:</span><br><span class=\"line\">    - name: <span class=\"string\">\"MYSQL_ALLOW_EMPTY_PASSWORD\"</span>  <span class=\"comment\"># 运行的环境变量</span></span><br><span class=\"line\">      value: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    image: <span class=\"string\">\"maven:3.6-jdk-8-alpine\"</span></span><br><span class=\"line\">    imagePullPolicy: <span class=\"string\">\"IfNotPresent\"</span>    <span class=\"comment\"># 镜像拉取策略</span></span><br><span class=\"line\">    name: <span class=\"string\">\"maven\"</span>                      <span class=\"comment\"># 容器名称</span></span><br><span class=\"line\">    resources: </span><br><span class=\"line\">      limits:</span><br><span class=\"line\">        memory: <span class=\"string\">\"500Mi\"</span></span><br><span class=\"line\">        cpu: <span class=\"string\">\"500m\"</span></span><br><span class=\"line\">      requests:</span><br><span class=\"line\">        memory: <span class=\"string\">\"100Mi\"</span></span><br><span class=\"line\">        cpu: <span class=\"string\">\"100m\"</span></span><br><span class=\"line\">    tty: <span class=\"literal\">true</span></span><br><span class=\"line\">    volumeMounts:                      <span class=\"comment\"># 卷挂载情况</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"volume-0\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/var/run/docker.sock\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"volume-1\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    workingDir: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">  - env:                                   <span class=\"comment\"># jnlp 环境变量</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_SECRET\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"********\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_AGENT_NAME\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"jenkins-slave-rtjxx-q3nhn\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_NAME\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"jenkins-slave-rtjxx-q3nhn\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_AGENT_WORKDIR\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_URL\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"http://jenkins.devops.svc.cluster.local:8080/\"</span></span><br><span class=\"line\">    image: <span class=\"string\">\"jenkins/inbound-agent:4.3-4\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"jnlp\"</span>                         <span class=\"comment\"># jenkins-jnlp 容器的名称 </span></span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      limits: &#123;&#125;</span><br><span class=\"line\">      requests:</span><br><span class=\"line\">        memory: <span class=\"string\">\"256Mi\"</span></span><br><span class=\"line\">        cpu: <span class=\"string\">\"100m\"</span></span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"volume-0\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/var/run/docker.sock\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"volume-1\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">  nodeSelector:</span><br><span class=\"line\">    kubernetes.io/os: <span class=\"string\">\"linux\"</span></span><br><span class=\"line\">  restartPolicy: <span class=\"string\">\"Never\"</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - hostPath:</span><br><span class=\"line\">      path: <span class=\"string\">\"/nfsdisk-31/appstorage/mavenRepo\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"volume-0\"</span></span><br><span class=\"line\">  - hostPath:</span><br><span class=\"line\">      path: <span class=\"string\">\"/var/run/docker.sock\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"volume-1\"</span></span><br><span class=\"line\">  - emptyDir:</span><br><span class=\"line\">      medium: <span class=\"string\">\"\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ------------------------------</span></span><br><span class=\"line\">+ hostname</span><br><span class=\"line\">  <span class=\"comment\"># jenkins-slave-rtjxx-q3nhn</span></span><br><span class=\"line\"></span><br><span class=\"line\">+ ip addr</span><br><span class=\"line\">  <span class=\"comment\"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span></span><br><span class=\"line\">  <span class=\"comment\">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class=\"line\">  <span class=\"comment\">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class=\"line\">  <span class=\"comment\">#        valid_lft forever preferred_lft forever</span></span><br><span class=\"line\">  <span class=\"comment\"># 2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN qlen 1000</span></span><br><span class=\"line\">  <span class=\"comment\">#     link/ipip 0.0.0.0 brd 0.0.0.0</span></span><br><span class=\"line\">  <span class=\"comment\"># 4: eth0@if162: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1480 qdisc noqueue state UP </span></span><br><span class=\"line\">  <span class=\"comment\">#     link/ether de:c6:df:23:e1:7f brd ff:ff:ff:ff:ff:ff</span></span><br><span class=\"line\">  <span class=\"comment\">#     inet 172.16.24.220/32 brd 172.16.24.220 scope global eth0</span></span><br><span class=\"line\">  <span class=\"comment\">#        valid_lft forever preferred_lft forever</span></span><br><span class=\"line\">+ mvn -version</span><br><span class=\"line\">  <span class=\"comment\"># Apache Maven 3.6.1 (d66c9c0b3152b2e69ee9bac180bb8fcc8e6af555; 2019-04-04T19:00:29Z)</span></span><br><span class=\"line\">  <span class=\"comment\"># Maven home: /usr/share/maven</span></span><br><span class=\"line\">  <span class=\"comment\"># Java version: 1.8.0_212, vendor: IcedTea, runtime: /usr/lib/jvm/java-1.8-openjdk/jre</span></span><br><span class=\"line\">  <span class=\"comment\"># Default locale: en_US, platform encoding: UTF-8</span></span><br><span class=\"line\">  <span class=\"comment\"># OS name: \"linux\", version: \"5.4.0-42-generic\", arch: \"amd64\", family: \"unix\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">+ env</span><br><span class=\"line\">  <span class=\"comment\"># JENKINS_HOME=/var/jenkins_home</span></span><br><span class=\"line\">  <span class=\"comment\"># POD_CONTAINER=maven</span></span><br><span class=\"line\">  <span class=\"comment\"># STAGE_NAME=maven</span></span><br><span class=\"line\">  <span class=\"comment\"># KUBERNETES_SERVICE_PORT=443</span></span><br><span class=\"line\">  <span class=\"comment\"># JAVA_VERSION=8u212</span></span><br><span class=\"line\">  <span class=\"comment\"># MAVEN_HOME=/usr/share/maven</span></span><br><span class=\"line\">  <span class=\"comment\"># MAVEN_CONFIG=/root/.m2</span></span><br></pre></td></tr></table></figure></p>\n<p>Tips : 在PodTemplate模板中设置 <code>showRawYaml: &#39;flase&#39;</code> 则将不会显示资源清单在日志中;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210207131120.png\" alt=\"WeiyiGeek.脚本式流水线k8s插件使用\" title=\"\" class=\"\">\n                <p>WeiyiGeek.脚本式流水线k8s插件使用</p>\n            </figure>\n<p>Tips : 要使用 secretEnvVar 我们必须在 <code>Dashboard -&gt; 凭据 -&gt; 系统 -&gt; 全局凭据 (unrestricted)</code> 进行添加一个Secret-text凭据(未能成功复现);<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Secret text\t4fc93636-d8f1-4051-8011-d852873fc740\tmysql-secret\tSecret text\tmysql-secret</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"Declarative-Pipeline\"><a href=\"#Declarative-Pipeline\" class=\"headerlink\" title=\"Declarative Pipeline\"></a>Declarative Pipeline</h4><p>描述: 声明式管道支持需要Jenkins 2.66+, 在Declarative Pipeline使用的 kubernetes 选项说明;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">options are [activeDeadlineSeconds, cloud, containerTemplate, containerTemplates, customWorkspace, defaultContainer, idleMinutes, inheritFrom, instanceCap, label, namespace, nodeSelector, podRetention, serviceAccount, slaveConnectTimeout, supplementalGroups, workingDir, workspaceVolume, yaml, yamlFile, yamlMergeStrategy]</span><br></pre></td></tr></table></figure></p>\n<p>示例帮助: <a href=\"https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/samples\" target=\"_blank\" rel=\"noopener\">https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/samples</a></p>\n<p><br></p>\n<p><strong>示例1.通过yaml文件资源清单创建</strong><br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent &#123;</span><br><span class=\"line\">    kubernetes &#123;</span><br><span class=\"line\">      cloud <span class=\"string\">'kubernetes'</span></span><br><span class=\"line\">      namespace <span class=\"string\">'devops'</span></span><br><span class=\"line\">      workingDir <span class=\"string\">'/home/jenkins/agent'</span></span><br><span class=\"line\">      <span class=\"comment\">// 继承模板</span></span><br><span class=\"line\">      inheritFrom <span class=\"string\">'jenkins-slave'</span></span><br><span class=\"line\">      defaultContainer <span class=\"string\">'maven'</span> </span><br><span class=\"line\">      <span class=\"comment\">// yamlFile 'KubernetesPod.yaml'</span></span><br><span class=\"line\">      yaml <span class=\"string\">\"\"\"\\</span></span><br><span class=\"line\"><span class=\"string\">apiVersion:</span></span><br><span class=\"line\"><span class=\"string\">kind: Pod</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    jenkins: \"slave\"</span></span><br><span class=\"line\"><span class=\"string\">    jenkins/label: 'k8s-slave'</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  containers:</span></span><br><span class=\"line\"><span class=\"string\">  - name: 'maven'</span></span><br><span class=\"line\"><span class=\"string\">    image: 'maven:3.6-jdk-8-alpine'</span></span><br><span class=\"line\"><span class=\"string\">    imagePullPolicy: 'IfNotPresent'     # 镜像拉取策略</span></span><br><span class=\"line\"><span class=\"string\">    command:</span></span><br><span class=\"line\"><span class=\"string\">    - cat</span></span><br><span class=\"line\"><span class=\"string\">    tty: true</span></span><br><span class=\"line\"><span class=\"string\">    \"\"\"</span>.stripIndent()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage (<span class=\"string\">'declarative Pipeline - kubernetes'</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        echo <span class=\"string\">\"declarative Pipeline - kubernetes\"</span></span><br><span class=\"line\">        container (<span class=\"string\">'maven'</span>) &#123;</span><br><span class=\"line\">          sh <span class=\"string\">\"echo $&#123;POD_CONTAINER&#125;\"</span></span><br><span class=\"line\">          sh <span class=\"string\">\"mvn -version\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Pipeline] Start of Pipeline</span><br><span class=\"line\">[Pipeline] podTemplate</span><br><span class=\"line\">[Pipeline] &#123;</span><br><span class=\"line\">[Pipeline] node</span><br><span class=\"line\"><span class=\"comment\"># 'kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8' is offline</span></span><br><span class=\"line\"><span class=\"comment\"># Agent kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8 is provisioned from template Kubernetes-jenkins-slave_49-fcd1s-m3n3q</span></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: <span class=\"string\">\"Pod\"</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    buildUrl: <span class=\"string\">\"http://jenkins.devops.svc.cluster.local:8080/job/Kubernetes-jenkins-slave/49/\"</span></span><br><span class=\"line\">    runUrl: <span class=\"string\">\"job/Kubernetes-jenkins-slave/49/\"</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    jenkins: <span class=\"string\">\"slave\"</span></span><br><span class=\"line\">    jenkins/label: <span class=\"string\">\"Kubernetes-jenkins-slave_49-fcd1s\"</span></span><br><span class=\"line\">    jenkins/label-digest: <span class=\"string\">\"95508e0ca05226ba84989959dc886ad4011cf125\"</span></span><br><span class=\"line\">  name: <span class=\"string\">\"kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8\"</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - <span class=\"string\">\"cat\"</span></span><br><span class=\"line\">    image: <span class=\"string\">\"maven:3.6-jdk-8-alpine\"</span></span><br><span class=\"line\">    imagePullPolicy: <span class=\"string\">\"IfNotPresent\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"maven\"</span></span><br><span class=\"line\">    tty: <span class=\"literal\">true</span></span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">  - env:</span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_SECRET\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"********\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_AGENT_NAME\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_NAME\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_AGENT_WORKDIR\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_URL\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"http://jenkins.devops.svc.cluster.local:8080/\"</span></span><br><span class=\"line\">    image: <span class=\"string\">\"jenkins/inbound-agent:4.3-4\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"jnlp\"</span></span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      limits: &#123;&#125;</span><br><span class=\"line\">      requests:</span><br><span class=\"line\">        memory: <span class=\"string\">\"256Mi\"</span></span><br><span class=\"line\">        cpu: <span class=\"string\">\"100m\"</span></span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins/.m2\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"volume-0\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">  hostNetwork: <span class=\"literal\">false</span></span><br><span class=\"line\">  nodeSelector:</span><br><span class=\"line\">    kubernetes.io/os: <span class=\"string\">\"linux\"</span></span><br><span class=\"line\">  restartPolicy: <span class=\"string\">\"Never\"</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - hostPath:</span><br><span class=\"line\">      path: <span class=\"string\">\"/nfsdisk-31/appstorage/mavenRepo\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"volume-0\"</span></span><br><span class=\"line\">  - emptyDir:</span><br><span class=\"line\">      medium: <span class=\"string\">\"\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">Running on kubernetes-jenkins-slave-49-fcd1s-m3n3q-t33d8 <span class=\"keyword\">in</span> /home/jenkins/agent/workspace/Kubernetes-jenkins-slave</span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#123;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] container</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#123;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] stage</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#123; (declarative Pipeline - kubernetes)</span></span><br><span class=\"line\">[Pipeline] <span class=\"built_in\">echo</span></span><br><span class=\"line\">declarative Pipeline - kubernetes</span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] container</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#123;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] sh</span></span><br><span class=\"line\">+ <span class=\"built_in\">echo</span> maven</span><br><span class=\"line\">maven</span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] sh</span></span><br><span class=\"line\">+ mvn -version</span><br><span class=\"line\">Apache Maven 3.6.1 (d66c9c0b3152b2e69ee9bac180bb8fcc8e6af555; 2019-04-04T19:00:29Z)</span><br><span class=\"line\">Maven home: /usr/share/maven</span><br><span class=\"line\">Java version: 1.8.0_212, vendor: IcedTea, runtime: /usr/lib/jvm/java-1.8-openjdk/jre</span><br><span class=\"line\">Default locale: en_US, platform encoding: UTF-8</span><br><span class=\"line\">OS name: <span class=\"string\">\"linux\"</span>, version: <span class=\"string\">\"5.4.0-42-generic\"</span>, arch: <span class=\"string\">\"amd64\"</span>, family: <span class=\"string\">\"unix\"</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#125;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] // container</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#125;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] // stage</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#125;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] // container</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#125;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] // node</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] &#125;</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] // podTemplate</span></span><br><span class=\"line\">  <span class=\"comment\"># [Pipeline] End of Pipeline</span></span><br><span class=\"line\">Finished: SUCCESS</span><br></pre></td></tr></table></figure></p>\n<p>Tips :默认情况下在容器中运行步骤, 步骤将嵌套在隐式container（name）{…}块中，而不是在jnlp容器中执行。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">defaultContainer <span class=\"string\">'maven'</span></span><br></pre></td></tr></table></figure></p>\n<p>Tips : 您也可以使用yamlFile将pod模板保存在单独的KubernetesPod.yaml文件中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent &#123;</span><br><span class=\"line\">    kubernetes &#123;</span><br><span class=\"line\">      yamlFile <span class=\"string\">'KubernetesPod.yaml'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">     ...</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x02-自定义Jenkins工作节点之jnlp-slave镜像模板构建\"><a href=\"#0x02-自定义Jenkins工作节点之jnlp-slave镜像模板构建\" class=\"headerlink\" title=\"0x02 自定义Jenkins工作节点之jnlp-slave镜像模板构建\"></a>0x02 自定义Jenkins工作节点之jnlp-slave镜像模板构建</h2><h3 id=\"Dockerfile-构建依赖\"><a href=\"#Dockerfile-构建依赖\" class=\"headerlink\" title=\"Dockerfile 构建依赖\"></a>Dockerfile 构建依赖</h3><p>描述: 下述相关脚本以及文件下载地址请在<code>WeiyiGeek</code>微信公众号回复<code>jenkins-jnlp-dockerfile</code>关键字获取; </p>\n<p>自定义的jnlp容器模板主要实现功能: </p>\n<ul>\n<li>用户权限控制(sudo)</li>\n<li>ssh 远程连接</li>\n<li>git 代码版本控制</li>\n<li>docker 容器管理</li>\n<li>kubectl 集群管理</li>\n<li>Java 运行环境</li>\n<li>Maven 运行环境</li>\n<li>SonarQube 扫描环境</li>\n<li>Gitlab_release 上传环境</li>\n<li>中文环境支持</li>\n<li>时区更改配置</li>\n</ul>\n<p><br></p>\n<p>Tips: 在K8s集群中测试alpine镜像执行相应的安装(需要在Alpine调试新安装软件时使用):<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alpine-app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: alpine-app</span><br><span class=\"line\">    image: alpine:latest</span><br><span class=\"line\">    args:</span><br><span class=\"line\">    - sleep</span><br><span class=\"line\">    - <span class=\"string\">\"100000\"</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">pod/alpine-app created</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get pods -o wide</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                       READY   STATUS    RESTARTS   AGE    IP              NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class=\"line\">  <span class=\"comment\"># alpine-app                                 1/1     Running   0          116s   10.100.37.194   worker-02   &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Dockerfile</strong></p>\n<p>自定义jnlp容器模板镜像地址: <a href=\"https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/weiyigeek/alpine-jenkins-jnlp</a></p>\n<p>该镜像是Jenkins自定义jnlp容器模板，主要用于Jenkins工作节点容器化使用，主要包含Gitlab_release发布、 docker 容器管理、kubectl 集群管理功能。我们可以直接在docker 的环境中 <code>docker pull weiyigeek/alpine-jenkins-jnlp</code>下来</p>\n<p>说明: 镜像构建文件<br><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#----------------------------------------------------------------------#</span></span><br><span class=\"line\"><span class=\"comment\"># Title: Base in Alpine Images Create Custom Jenkins Kubernetes jnlp Images</span></span><br><span class=\"line\"><span class=\"comment\"># Author: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\"># WebSite: https://weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\"># MainFunction:</span></span><br><span class=\"line\"><span class=\"comment\">#   Install ssh-server docker git openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm jq</span></span><br><span class=\"line\"><span class=\"comment\">#   Install JDK8</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://github.com/sgerrand/alpine-pkg-glibc/releases/</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub</span></span><br><span class=\"line\"><span class=\"comment\">#   Install jnlp</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting/</span></span><br><span class=\"line\"><span class=\"comment\">#   Install Maven</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://apache.osuosl.org/maven/maven-3/$&#123;MAVEN_VERSION&#125;/binaries</span></span><br><span class=\"line\"><span class=\"comment\">#   Install SonarqubeScan</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.5.0.2216-linux.zip</span></span><br><span class=\"line\"><span class=\"comment\">#   Install Gitlab Release Version: 0.0.6</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://gitlab.com/gitlab-org/release-cli/-/releases</span></span><br><span class=\"line\"><span class=\"comment\">#   Install kubernetes cli</span></span><br><span class=\"line\"><span class=\"comment\">#   - kubectl Version: 1.19.3</span></span><br><span class=\"line\"><span class=\"comment\"># Version: alpine-3.13.1</span></span><br><span class=\"line\"><span class=\"comment\"># Release: v1.10</span></span><br><span class=\"line\"><span class=\"comment\"># ChangeLog:</span></span><br><span class=\"line\"><span class=\"comment\"># v1.9 -  增加 中文环境</span></span><br><span class=\"line\"><span class=\"comment\"># v1.10 - 增加 node.js 环境支持</span></span><br><span class=\"line\"><span class=\"comment\">#-------------------------------------------------#</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> alpine:<span class=\"number\">3.13</span>.<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span>  Jenkins Custom Work Node Jnlp Container - &lt;master@weiyigeek.top&gt; - WeiyiGeek</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> USERNAME=jenkins \\</span><br><span class=\"line\">    AGENT_WORKDIR=/home/jenkins \\</span><br><span class=\"line\">    BASE_DIR=/usr/local  \\</span><br><span class=\"line\">    BASE_BIN=/usr/local/bin  \\</span><br><span class=\"line\">    BASE_URL=http://<span class=\"number\">192.168</span>.<span class=\"number\">12.107</span>:<span class=\"number\">8080</span>  \\</span><br><span class=\"line\">    LOCALE=locale.md \\</span><br><span class=\"line\">    JDK_NAME=jdk-<span class=\"number\">8</span>u281-linux-x64   \\</span><br><span class=\"line\">    JDK_DIR=/usr/local/jdk1.<span class=\"number\">8.0</span>_281  \\</span><br><span class=\"line\">    GLIBC_NAME=glibc-<span class=\"number\">2.32</span>-r0.apk \\</span><br><span class=\"line\">    GLIBC_BIN_NAME=glibc-bin-<span class=\"number\">2.32</span>-r0.apk \\</span><br><span class=\"line\">    GLIBC_I18N_NAME=glibc-i18n-<span class=\"number\">2.32</span>-r0.apk \\</span><br><span class=\"line\">    MAVEN_NAME=apache-maven-<span class=\"number\">3.6</span>.<span class=\"number\">3</span>-bin \\</span><br><span class=\"line\">    MAVEN_DIR=/usr/local/apache-maven-<span class=\"number\">3.6</span>.<span class=\"number\">3</span> \\</span><br><span class=\"line\">    SONAR_SCANNER_NAME=sonar-scanner-cli-<span class=\"number\">4.5</span>.<span class=\"number\">0.2216</span>-linux \\</span><br><span class=\"line\">    SONAR_SCANNER_DIR=/usr/local/sonar-scanner-<span class=\"number\">4.5</span>.<span class=\"number\">0.2216</span>-linux \\</span><br><span class=\"line\">    GITLAB_CLI=release-cli-<span class=\"number\">0.6</span>.<span class=\"number\">0</span>-linux-amd64 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> LANG=en_US.UTF-<span class=\"number\">8</span> \\</span><br><span class=\"line\">    LC_ALL=en_US.UTF-<span class=\"number\">8</span> \\</span><br><span class=\"line\">    JAVA_HOME=/usr/local/jdk8  \\ </span><br><span class=\"line\">    JRE_HOME=/usr/local/jdk8/jre \\ </span><br><span class=\"line\">    MAVEN_HOME=/usr/local/maven \\ </span><br><span class=\"line\">    MAVEN_RPEO=/home/jenkins/.m2 \\</span><br><span class=\"line\">    SONAR_SCANNER_HOME=/usr/local/sonar-scanner \\</span><br><span class=\"line\">    NODEJS_MODULES=/usr/lib/node_modules</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用户ROOT切换</span></span><br><span class=\"line\"><span class=\"keyword\">USER</span> root</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Shell 命令 - 此种方式极大减少了构建的镜像大小;</span></span><br><span class=\"line\"><span class=\"comment\"># 请根据网络情况选择 Alpine 镜像源 mirrors.aliyun.com 、mirror.tuna.tsinghua.edu.cn</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> sed -i <span class=\"string\">'s/dl-cdn.alpinelinux.org/mirror.tuna.tsinghua.edu.cn/g'</span> /etc/apk/repositories \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; apk update \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; apk add --no-cache openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm jq \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; chmod 4755 /bin/busybox \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; addgroup -g 1000 -S <span class=\"variable\">$&#123;USERNAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; adduser <span class=\"variable\">$&#123;USERNAME&#125;</span> -D -g <span class=\"variable\">$&#123;USERNAME&#125;</span> -G root -u 1000 -s /bin/sh \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"jenkins   ALL=(root) NOPASSWD:ALL\"</span> &gt;&gt; /etc/sudoers \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; mkdir -p <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span>/agent <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span>/.ssh <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span>/.m2 \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;GLIBC_NAME&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GLIBC_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;GLIBC_BIN_NAME&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GLIBC_BIN_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;GLIBC_I18N_NAME&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GLIBC_I18N_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /etc/apk/keys/sgerrand.rsa.pub <span class=\"variable\">$&#123;BASE_URL&#125;</span>/sgerrand.rsa.pub \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;LOCALE&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;LOCALE&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;JDK_NAME&#125;</span>.tar.gz <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;JDK_NAME&#125;</span>.tar.gz \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O <span class=\"variable\">$&#123;BASE_BIN&#125;</span>/agent.jar <span class=\"variable\">$&#123;BASE_URL&#125;</span>/agent.jar \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o <span class=\"variable\">$&#123;BASE_BIN&#125;</span>/jenkins-agent.sh <span class=\"variable\">$&#123;BASE_URL&#125;</span>/jenkins-agent.sh \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /tmp/<span class=\"variable\">$&#123;MAVEN_NAME&#125;</span>.tar.gz <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;MAVEN_NAME&#125;</span>.tar.gz \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /tmp/<span class=\"variable\">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /usr/<span class=\"built_in\">local</span>/bin/release-cli <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GITLAB_CLI&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /usr/<span class=\"built_in\">local</span>/bin/kubectl <span class=\"variable\">$&#123;BASE_URL&#125;</span>/kubectl \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; sed -i <span class=\"string\">\"s/#PermitRootLogin.*/PermitRootLogin yes/g\"</span> /etc/ssh/sshd_config \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; sed -i <span class=\"string\">\"s/^#\\s*StrictHostKeyChecking ask/StrictHostKeyChecking no/g\"</span> /etc/ssh/ssh_config \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t dsa -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_dsa_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t rsa -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_rsa_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t ecdsa -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_ecdsa_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t ed25519 -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_ed25519_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t ed25519 -P <span class=\"string\">\"\"</span> -C <span class=\"string\">\"master@weiyigeek.top\"</span> -f /home/jenkins/.ssh/id_ed25519 \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; apk add /tmp/<span class=\"variable\">$&#123;GLIBC_NAME&#125;</span> /tmp/<span class=\"variable\">$&#123;GLIBC_BIN_NAME&#125;</span> /tmp/<span class=\"variable\">$&#123;GLIBC_I18N_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; tar -zxf /tmp/<span class=\"variable\">$&#123;JDK_NAME&#125;</span>.tar.gz -C <span class=\"variable\">$&#123;BASE_DIR&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; mv <span class=\"variable\">$&#123;JDK_DIR&#125;</span> <span class=\"variable\">$&#123;JAVA_HOME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; tar -zxf /tmp/<span class=\"variable\">$&#123;MAVEN_NAME&#125;</span>.tar.gz -C <span class=\"variable\">$&#123;BASE_DIR&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; mv <span class=\"variable\">$&#123;MAVEN_DIR&#125;</span> <span class=\"variable\">$&#123;MAVEN_HOME&#125;</span> \\ </span></span><br><span class=\"line\">    &amp;&amp; unzip /tmp/$&#123;SONAR_SCANNER_NAME&#125;.zip -d $&#123;BASE_DIR&#125; \\</span><br><span class=\"line\">    &amp;&amp; mv $&#123;SONAR_SCANNER_DIR&#125; $&#123;SONAR_SCANNER_HOME&#125; \\</span><br><span class=\"line\">    &amp;&amp; npm config set registry https://registry.npmmirror.com \\</span><br><span class=\"line\">    &amp;&amp; chmod a+x $&#123;BASE_BIN&#125;/* \\</span><br><span class=\"line\">    &amp;&amp; chown -R jenkins:jenkins $&#123;BASE_DIR&#125;/ $&#123;AGENT_WORKDIR&#125;/ $&#123;NODEJS_MODULES&#125;/ \\</span><br><span class=\"line\">    &amp;&amp; echo <span class=\"string\">\"root:WeiyiGeek\"</span> | chpasswd \\</span><br><span class=\"line\">    &amp;&amp; echo <span class=\"string\">\"jenkins:WeiyiGeek\"</span> | chpasswd \\</span><br><span class=\"line\">    &amp;&amp; cat /tmp/$&#123;LOCALE&#125; | xargs -i /usr/glibc-compat/bin/localedef -i &#123;&#125; -f UTF-<span class=\"number\">8</span> &#123;&#125;.UTF-<span class=\"number\">8</span> \\</span><br><span class=\"line\">    &amp;&amp; sed -i <span class=\"string\">\"s#use_embedded_jre=true#use_embedded_jre=false#g\"</span> $&#123;SONAR_SCANNER_HOME&#125;/bin/sonar-scanner \\</span><br><span class=\"line\">    &amp;&amp; rm -rf /var/cache/apk/* /tmp/* $&#123;SONAR_SCANNER_HOME&#125;/jre/* \\</span><br><span class=\"line\">    &amp;&amp; cd $&#123;JAVA_HOME&#125; \\</span><br><span class=\"line\">    &amp;&amp; rm -rf COPYRIGHT LICENSE README release THIRDPARTYLICENSEREADME-JAVAFX.txt THIRDPARTYLICENSEREADME.txt Welcome.html javafx-src.zip src.zip \\</span><br><span class=\"line\">    lib/plugin.jar \\</span><br><span class=\"line\">    lib/ext/jfxrt.jar \\</span><br><span class=\"line\">    bin/javaws \\</span><br><span class=\"line\">    lib/javaws.jar \\</span><br><span class=\"line\">    lib/desktop \\</span><br><span class=\"line\">    plugin \\</span><br><span class=\"line\">    lib/deploy* \\</span><br><span class=\"line\">    lib/*javafx* \\</span><br><span class=\"line\">    lib/*jfx* \\</span><br><span class=\"line\">    lib/amd64/libdecora_sse.so \\</span><br><span class=\"line\">    lib/amd64/libprism_*.so \\</span><br><span class=\"line\">    lib/amd64/libfxplugins.so \\</span><br><span class=\"line\">    lib/amd64/libglass.so \\</span><br><span class=\"line\">    lib/amd64/libgstreamer-lite.so \\</span><br><span class=\"line\">    lib/amd64/libjavafx*.so \\</span><br><span class=\"line\">    lib/amd64/libjfx*.so</span><br><span class=\"line\">    &amp;&amp; echo <span class=\"string\">\"export LANG=zh_CN.UTF-8\"</span> &gt; /etc/profile.d/locale.sh </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">USER</span> jenkins </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"bash\"> <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib/dt.jar:$&#123;JAVA_HOME&#125;/lib/tools.jar \\</span><br><span class=\"line\">    PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;MAVEN_HOME&#125;/bin:$&#123;SONAR_SCANNER_HOME&#125;/bin:$PATH</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"bash\"> [<span class=\"string\">\"/usr/local/bin/jenkins-agent.sh\"</span>]</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>local.md</strong><br>描述：让alpine操作系统中文字符支持;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee local.md &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">en_AG</span><br><span class=\"line\">en_AU</span><br><span class=\"line\">en_BW</span><br><span class=\"line\">en_CA</span><br><span class=\"line\">en_DK</span><br><span class=\"line\">en_GB</span><br><span class=\"line\">en_HK</span><br><span class=\"line\">en_IE</span><br><span class=\"line\">en_IN</span><br><span class=\"line\">en_NG</span><br><span class=\"line\">en_NZ</span><br><span class=\"line\">en_PH</span><br><span class=\"line\">en_SG</span><br><span class=\"line\">en_US</span><br><span class=\"line\">en_ZA</span><br><span class=\"line\">en_ZM</span><br><span class=\"line\">en_ZW</span><br><span class=\"line\">zh_CN</span><br><span class=\"line\">zh_HK</span><br><span class=\"line\">zh_SG</span><br><span class=\"line\">zh_TW</span><br><span class=\"line\">zu_ZA</span><br><span class=\"line\">END</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>jenkins-agent.sh</strong><br>描述: 容器启动时与<code>jenkins</code>利用Java jnlp 进行连接的脚本;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"comment\"># Usage jenkins-agent.sh [options] -url http://jenkins [SECRET] [AGENT_NAME]</span></span><br><span class=\"line\"><span class=\"comment\"># Optional environment variables :</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_TUNNEL : HOST:PORT for a tunnel to route TCP traffic to jenkins host, when jenkins can't be directly accessed over network</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_URL : alternate jenkins URL</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_SECRET : agent secret, if not set as an argument</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_AGENT_NAME : agent name, if not set as an argument</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_AGENT_WORKDIR : agent work directory, if not set by optional parameter -workDir</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_WEB_SOCKET: true if the connection should be made via WebSocket rather than TCP</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_DIRECT_CONNECTION: Connect directly to this TCP agent port, skipping the HTTP(S) connection parameter download.</span></span><br><span class=\"line\"><span class=\"comment\">#                              Value: \"&lt;HOST&gt;:&lt;PORT&gt;\"</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_INSTANCE_IDENTITY: The base64 encoded InstanceIdentity byte array of the Jenkins master. When this is set,</span></span><br><span class=\"line\"><span class=\"comment\">#                              the agent skips connecting to an HTTP(S) port for connection info.</span></span><br><span class=\"line\"><span class=\"comment\"># * JENKINS_PROTOCOLS:         Specify the remoting protocols to attempt when instanceIdentity is provided.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$#</span> -eq 1 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"comment\"># if `docker run` only has one arguments, we assume user is running alternate command like `bash` to inspect the image</span></span><br><span class=\"line\">        <span class=\"built_in\">exec</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"comment\"># if -tunnel is not provided, try env vars</span></span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">                *<span class=\"string\">\"-tunnel \"</span>*) ;;</span><br><span class=\"line\">                *)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> [ ! -z <span class=\"string\">\"<span class=\"variable\">$JENKINS_TUNNEL</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                  TUNNEL=<span class=\"string\">\"-tunnel <span class=\"variable\">$JENKINS_TUNNEL</span>\"</span></span><br><span class=\"line\">                <span class=\"keyword\">fi</span> ;;</span><br><span class=\"line\">        <span class=\"keyword\">esac</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># if -workDir is not provided, try env vars</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ ! -z <span class=\"string\">\"<span class=\"variable\">$JENKINS_AGENT_WORKDIR</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">                        *<span class=\"string\">\"-workDir\"</span>*) <span class=\"built_in\">echo</span> <span class=\"string\">\"Warning: Work directory is defined twice in command-line arguments and the environment variable\"</span> ;;</span><br><span class=\"line\">                        *)</span><br><span class=\"line\">                        WORKDIR=<span class=\"string\">\"-workDir <span class=\"variable\">$JENKINS_AGENT_WORKDIR</span>\"</span> ;;</span><br><span class=\"line\">                <span class=\"keyword\">esac</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$JENKINS_URL</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                URL=<span class=\"string\">\"-url <span class=\"variable\">$JENKINS_URL</span>\"</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$JENKINS_NAME</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                JENKINS_AGENT_NAME=<span class=\"string\">\"<span class=\"variable\">$JENKINS_NAME</span>\"</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$JENKINS_WEB_SOCKET</span>\"</span> = <span class=\"literal\">true</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                WEB_SOCKET=-webSocket</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$JENKINS_PROTOCOLS</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                PROTOCOLS=<span class=\"string\">\"-protocols <span class=\"variable\">$JENKINS_PROTOCOLS</span>\"</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$JENKINS_DIRECT_CONNECTION</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                DIRECT=<span class=\"string\">\"-direct <span class=\"variable\">$JENKINS_DIRECT_CONNECTION</span>\"</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$JENKINS_INSTANCE_IDENTITY</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                INSTANCE_IDENTITY=<span class=\"string\">\"-instanceIdentity <span class=\"variable\">$JENKINS_INSTANCE_IDENTITY</span>\"</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># if java home is defined, use it</span></span><br><span class=\"line\">        JAVA_BIN=<span class=\"string\">\"java\"</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$JAVA_HOME</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                JAVA_BIN=<span class=\"string\">\"<span class=\"variable\">$JAVA_HOME</span>/bin/java\"</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># if both required options are defined, do not pass the parameters</span></span><br><span class=\"line\">        OPT_JENKINS_SECRET=<span class=\"string\">\"\"</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$JENKINS_SECRET</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">                        *<span class=\"string\">\"<span class=\"variable\">$&#123;JENKINS_SECRET&#125;</span>\"</span>*) <span class=\"built_in\">echo</span> <span class=\"string\">\"Warning: SECRET is defined twice in command-line arguments and the environment variable\"</span> ;;</span><br><span class=\"line\">                        *)</span><br><span class=\"line\">                        OPT_JENKINS_SECRET=<span class=\"string\">\"<span class=\"variable\">$&#123;JENKINS_SECRET&#125;</span>\"</span> ;;</span><br><span class=\"line\">                <span class=\"keyword\">esac</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        OPT_JENKINS_AGENT_NAME=<span class=\"string\">\"\"</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -n <span class=\"string\">\"<span class=\"variable\">$JENKINS_AGENT_NAME</span>\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">                        *<span class=\"string\">\"<span class=\"variable\">$&#123;JENKINS_AGENT_NAME&#125;</span>\"</span>*) <span class=\"built_in\">echo</span> <span class=\"string\">\"Warning: AGENT_NAME is defined twice in command-line arguments and the environment variable\"</span> ;;</span><br><span class=\"line\">                        *)</span><br><span class=\"line\">                        OPT_JENKINS_AGENT_NAME=<span class=\"string\">\"<span class=\"variable\">$&#123;JENKINS_AGENT_NAME&#125;</span>\"</span> ;;</span><br><span class=\"line\">                <span class=\"keyword\">esac</span></span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">#<span class=\"doctag\">TODO:</span> Handle the case when the command-line and Environment variable contain different values.</span></span><br><span class=\"line\">        <span class=\"comment\">#It is fine it blows up for now since it should lead to an error anyway.</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"built_in\">exec</span> <span class=\"variable\">$JAVA_BIN</span> <span class=\"variable\">$JAVA_OPTS</span> -cp /usr/<span class=\"built_in\">local</span>/bin/agent.jar hudson.remoting.jnlp.Main -headless <span class=\"variable\">$TUNNEL</span> <span class=\"variable\">$URL</span> <span class=\"variable\">$WORKDIR</span> <span class=\"variable\">$WEB_SOCKET</span> <span class=\"variable\">$DIRECT</span> <span class=\"variable\">$PROTOCOLS</span> <span class=\"variable\">$INSTANCE_IDENTITY</span> <span class=\"variable\">$OPT_JENKINS_SECRET</span> <span class=\"variable\">$OPT_JENKINS_AGENT_NAME</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>镜像构建所需软件</strong><br>备注: 在Jenkins 2.277版本中添加一个新的节点中获取匹配当前版本的 agent.jar, 或者是在 jenkins 官网 <a href=\"https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting\" target=\"_blank\" rel=\"noopener\">https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting</a> 进行下载;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/k8s/jenkins/jnlp-slave$ ls</span><br><span class=\"line\">agent.jar                      build              jdk-8u281-linux-x64.tar.gz  Jenkins.zip  release-cli-0.6.0-linux-amd64  sonar-scanner-cli-4.5.0.2216-linux.zip</span><br><span class=\"line\">apache-maven-3.6.3-bin.tar.gz  glibc-2.32-r0.apk  jenkins-agent.sh            kubectl      sgerrand.rsa.pub</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"Dockerfile-构建操作\"><a href=\"#Dockerfile-构建操作\" class=\"headerlink\" title=\"Dockerfile 构建操作\"></a>Dockerfile 构建操作</h3><p><strong>操作流程</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 启动一个临时的web服务器（`存放上面的镜像构建所需软件`-非常重要-否则将会导致构建失败）</span></span><br><span class=\"line\">~/k8s/jenkins/jnlp-slave$ python3 -m http.server 8080</span><br><span class=\"line\">Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...</span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /glibc-2.32-r0.apk HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /glibc-bin-2.32-r0.apk HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /glibc-i18n-2.32-r0.apk HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /sgerrand.rsa.pub HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /locale.md HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /jdk-8u281-linux-x64.tar.gz HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /agent.jar HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /jenkins-agent.sh HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /apache-maven-3.6.3-bin.tar.gz HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /sonar-scanner-cli-4.5.0.2216-linux.zip HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /release-cli-0.6.0-linux-amd64 HTTP/1.1\" 200 -</span></span><br><span class=\"line\"><span class=\"comment\"># 172.17.0.4 - - [30/Mar/2021 17:32:00] \"GET /kubectl HTTP/1.1\" 200 -</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 镜像构建 (建议带上构建平台)</span></span><br><span class=\"line\">docker build -t weiyigeek/alpine-jenkins-jnlp --platform linux/amd64 .</span><br><span class=\"line\">  <span class=\"comment\"># Successfully built b47b6581b712</span></span><br><span class=\"line\">  <span class=\"comment\"># Successfully tagged weiyigeek/alpine-jenkins-jnlp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看构建信息</span></span><br><span class=\"line\">docker images weiyigeek/alpine-jenkins-jnlp --all</span><br><span class=\"line\">  <span class=\"comment\"># REPOSITORY                               TAG           IMAGE ID       CREATED             SIZE</span></span><br><span class=\"line\">  <span class=\"comment\"># harbor.weiyigeek.top/devops/jenkins-jnlp   3.13.1-alpine   b47b6581b712   About an hour ago   715MB</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 推送镜像</span></span><br><span class=\"line\">docker push weiyigeek/alpine-jenkins-jnlp</span><br><span class=\"line\">  <span class=\"comment\"># The push refers to repository [harbor.weiyigeek.top/devops/jenkins-jnlp]</span></span><br><span class=\"line\">  <span class=\"comment\"># 059ea3fbd3b3: Pushed</span></span><br><span class=\"line\">  <span class=\"comment\"># 1119ff37d4a9: Layer already exists</span></span><br><span class=\"line\">  <span class=\"comment\"># 3.13.1-alpine: digest: sha256:1f869c553340c9399c7db9072169600a17ddb0ec41d41d3a4365b8c1571fc201 size: 741</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 采用Ansible各节点拉取镜像</span></span><br><span class=\"line\">ansible node -m shell -a <span class=\"string\">\"docker pull weiyigeek/alpine-jenkins-jnlp\"</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210330173121.png\" alt=\"WeiyiGeek.DockerFile构建自定义Jnlp容器\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DockerFile构建自定义Jnlp容器</p>\n            </figure>\n<p><br></p>\n<h3 id=\"自定义-jenkins-jnlp-slave-镜像的使用\"><a href=\"#自定义-jenkins-jnlp-slave-镜像的使用\" class=\"headerlink\" title=\"自定义 jenkins-jnlp-slave 镜像的使用\"></a>自定义 jenkins-jnlp-slave 镜像的使用</h3><p>描述: 此处还是利用Jenkins的kubernetes插件，让jenkins在进job时动态的生成工作节点(Pod)，并在结束后销毁容器。</p>\n<ul>\n<li><p>Step 1.创建流水线 <code>Kubernetes-jenkins-slave</code> Job 在流水线中采用Pipeline Script脚本</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent &#123;</span><br><span class=\"line\">    kubernetes &#123;</span><br><span class=\"line\">      cloud <span class=\"string\">'kubernetes'</span></span><br><span class=\"line\">      namespace <span class=\"string\">'devops'</span></span><br><span class=\"line\">      inheritFrom <span class=\"string\">'jenkins-slave'</span></span><br><span class=\"line\">      workingDir <span class=\"string\">'/home/jenkins/agent'</span></span><br><span class=\"line\">      <span class=\"comment\">// yamlFile 'KubernetesPod.yaml'</span></span><br><span class=\"line\">      yaml <span class=\"string\">\"\"\"\\</span></span><br><span class=\"line\"><span class=\"string\">apiVersion:</span></span><br><span class=\"line\"><span class=\"string\">kind: Pod</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    jenkins: \"slave\"</span></span><br><span class=\"line\"><span class=\"string\">    jenkins/label: 'k8s-slave'</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  containers:</span></span><br><span class=\"line\"><span class=\"string\">  - name: 'jnlp'</span></span><br><span class=\"line\"><span class=\"string\">    image: 'weiyigeek/alpine-jenkins-jnlp'</span></span><br><span class=\"line\"><span class=\"string\">    imagePullPolicy: 'IfNotPresent'                                     # 镜像拉取策略</span></span><br><span class=\"line\"><span class=\"string\">    command: [\"/bin/sh\",\"-c\",\"/usr/local/bin/jenkins-agent.sh &amp;&amp; cat\"]  # 重点测试的时候(心酸累)希望读者体验一哈</span></span><br><span class=\"line\"><span class=\"string\">    tty: true</span></span><br><span class=\"line\"><span class=\"string\">    volumeMounts:</span></span><br><span class=\"line\"><span class=\"string\">    - mountPath: \"/home/jenkins/.m2\"</span></span><br><span class=\"line\"><span class=\"string\">      name: \"volume-0\"</span></span><br><span class=\"line\"><span class=\"string\">    - mountPath: \"/var/run/docker.sock\"</span></span><br><span class=\"line\"><span class=\"string\">      name: \"volume-1\"</span></span><br><span class=\"line\"><span class=\"string\">    \"\"\"</span>.stripIndent()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage (<span class=\"string\">'declarative Pipeline - kubernetes'</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        echo <span class=\"string\">\"declarative Pipeline - kubernetes\"</span></span><br><span class=\"line\">        sh <span class=\"string\">\"mvn -version\"</span></span><br><span class=\"line\">        sh <span class=\"string\">\"release-cli -v\"</span></span><br><span class=\"line\">        sh <span class=\"string\">\"sonar-scanner -v\"</span></span><br><span class=\"line\">        sh <span class=\"string\">\"kubectl version\"</span></span><br><span class=\"line\">        sh <span class=\"string\">\"docker --version &amp;&amp; sudo docker ps\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 2.配置<code>Pod Templates</code>模板如下因为我们需要继承一哈</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">名称：jenkins-slave</span><br><span class=\"line\">命名空间: devops</span><br><span class=\"line\">标签列表: k8s-slave</span><br><span class=\"line\">添加主机卷: </span><br><span class=\"line\"> - 主机: /nfsdisk-31/appstorage/mavenRepo</span><br><span class=\"line\"> - Pod 挂载路径: /home/jenkins/.m2</span><br><span class=\"line\"> - 主机: /var/run/docker.sock</span><br><span class=\"line\"> - Pod 挂载路径: /var/run/docker.sock</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.在BlueOcen中运行并查看结果</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 可以看见当进行调度时k8s会动态的拉取镜像并运行，当任务结束后会自动销毁Pod</span></span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Pending   0          0s</span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Pending   0          0s</span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     ContainerCreating   0          0s</span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   1/1     Running             0          3s</span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   1/1     Terminating         0          13s</span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Terminating         0          45s</span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Terminating         0          46s</span><br><span class=\"line\">kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5   0/1     Terminating         0          46s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 动态创建的slave启动的Pod脚本</span></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: <span class=\"string\">\"Pod\"</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    buildUrl: <span class=\"string\">\"http://jenkins.devops.svc.cluster.local:8080/job/Kubernetes-jenkins-slave/63/\"</span></span><br><span class=\"line\">    runUrl: <span class=\"string\">\"job/Kubernetes-jenkins-slave/63/\"</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    jenkins: <span class=\"string\">\"slave\"</span></span><br><span class=\"line\">    jenkins/label: <span class=\"string\">\"Kubernetes-jenkins-slave_63-01h9j\"</span></span><br><span class=\"line\">    jenkins/label-digest: <span class=\"string\">\"0fe6224168b9ce0350e7db8678c10953c2e6f533\"</span></span><br><span class=\"line\">  name: <span class=\"string\">\"kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5\"</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - <span class=\"string\">\"/bin/sh\"</span></span><br><span class=\"line\">    - <span class=\"string\">\"-c\"</span></span><br><span class=\"line\">    - <span class=\"string\">\"/usr/local/bin/jenkins-agent.sh &amp;&amp; cat\"</span></span><br><span class=\"line\">    env:</span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_SECRET\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"********\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_AGENT_NAME\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_NAME\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_AGENT_WORKDIR\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">    - name: <span class=\"string\">\"JENKINS_URL\"</span></span><br><span class=\"line\">      value: <span class=\"string\">\"http://jenkins.devops.svc.cluster.local:8080/\"</span></span><br><span class=\"line\">    image: <span class=\"string\">\"weiyigeek/alpine-jenkins-jnlp\"</span></span><br><span class=\"line\">    imagePullPolicy: <span class=\"string\">\"IfNotPresent\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"jnlp\"</span></span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      limits: &#123;&#125;</span><br><span class=\"line\">      requests:</span><br><span class=\"line\">        memory: <span class=\"string\">\"256Mi\"</span></span><br><span class=\"line\">        cpu: <span class=\"string\">\"100m\"</span></span><br><span class=\"line\">    tty: <span class=\"literal\">true</span></span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins/.m2\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"volume-0\"</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/var/run/docker.sock\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"volume-1\"</span></span><br><span class=\"line\">    - mountPath: <span class=\"string\">\"/home/jenkins/agent\"</span></span><br><span class=\"line\">      name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\">      readOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">  hostNetwork: <span class=\"literal\">false</span></span><br><span class=\"line\">  nodeSelector:</span><br><span class=\"line\">    kubernetes.io/os: <span class=\"string\">\"linux\"</span></span><br><span class=\"line\">  restartPolicy: <span class=\"string\">\"Never\"</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - hostPath:</span><br><span class=\"line\">      path: <span class=\"string\">\"/nfsdisk-31/appstorage/mavenRepo\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"volume-0\"</span></span><br><span class=\"line\">  - hostPath:</span><br><span class=\"line\">      path: <span class=\"string\">\"/var/run/docker.sock\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"volume-1\"</span></span><br><span class=\"line\">  - emptyDir:</span><br><span class=\"line\">      medium: <span class=\"string\">\"\"</span></span><br><span class=\"line\">    name: <span class=\"string\">\"workspace-volume\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Running on kubernetes-jenkins-slave-63-01h9j-txdgn-cdwb5 in /home/jenkins/agent/workspace/Kubernetes-jenkins-slave</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 脚本反馈</span></span><br><span class=\"line\">declarative Pipeline - kubernetes</span><br><span class=\"line\">+ mvn -version</span><br><span class=\"line\">  Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)</span><br><span class=\"line\">  Maven home: /usr/<span class=\"built_in\">local</span>/maven</span><br><span class=\"line\">  Java version: 1.8.0_281, vendor: Oracle Corporation, runtime: /usr/<span class=\"built_in\">local</span>/jdk8/jre</span><br><span class=\"line\">  Default locale: en_US, platform encoding: ANSI_X3.4-1968</span><br><span class=\"line\">  OS name: <span class=\"string\">\"linux\"</span>, version: <span class=\"string\">\"5.4.0-42-generic\"</span>, arch: <span class=\"string\">\"amd64\"</span>, family: <span class=\"string\">\"unix\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">+ release-cli -v</span><br><span class=\"line\">     version 0.6.0</span><br><span class=\"line\"></span><br><span class=\"line\">+ sonar-scanner -v</span><br><span class=\"line\">  INFO: Scanner configuration file: /usr/<span class=\"built_in\">local</span>/sonar-scanner/conf/sonar-scanner.properties</span><br><span class=\"line\">  INFO: Project root configuration file: NONE</span><br><span class=\"line\">  INFO: SonarScanner 4.5.0.2216</span><br><span class=\"line\">  INFO: Java 1.8.0_281 Oracle Corporation (64-bit)</span><br><span class=\"line\">  INFO: Linux 5.4.0-42-generic amd64</span><br><span class=\"line\"></span><br><span class=\"line\">+ kubectl version</span><br><span class=\"line\">  Client Version: version.Info&#123;Major:<span class=\"string\">\"1\"</span>, Minor:<span class=\"string\">\"19\"</span>, GitVersion:<span class=\"string\">\"v1.19.6\"</span>, GitCommit:<span class=\"string\">\"fbf646b339dc52336b55d8ec85c181981b86331a\"</span>, GitTreeState:<span class=\"string\">\"clean\"</span>, BuildDate:<span class=\"string\">\"2020-12-18T12:09:30Z\"</span>, GoVersion:<span class=\"string\">\"go1.15.5\"</span>, Compiler:<span class=\"string\">\"gc\"</span>, Platform:<span class=\"string\">\"linux/amd64\"</span>&#125;</span><br><span class=\"line\">  Server Version: version.Info&#123;Major:<span class=\"string\">\"1\"</span>, Minor:<span class=\"string\">\"19\"</span>, GitVersion:<span class=\"string\">\"v1.19.6\"</span>, GitCommit:<span class=\"string\">\"fbf646b339dc52336b55d8ec85c181981b86331a\"</span>, GitTreeState:<span class=\"string\">\"clean\"</span>, BuildDate:<span class=\"string\">\"2020-12-18T12:01:36Z\"</span>, GoVersion:<span class=\"string\">\"go1.15.5\"</span>, Compiler:<span class=\"string\">\"gc\"</span>, Platform:<span class=\"string\">\"linux/amd64\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">+ docker --version</span><br><span class=\"line\">  Docker version 20.10.3, build 48d30b5b32e99c932b4ea3edca74353feddd83ff</span><br><span class=\"line\"></span><br><span class=\"line\">+ sudo docker ps  <span class=\"comment\"># 非常注意权限</span></span><br><span class=\"line\">CONTAINER ID   IMAGE                                                           COMMAND                  CREATED              STATUS          PORTS     NAMES</span><br><span class=\"line\">bd9948326a78   harbor.weiyigeek.top/devops/jenkins-jnlp                          <span class=\"string\">\"/bin/sh -c '/usr/lo…\"</span>   39 seconds ago       Up 32 seconds             k8s_jnlp_kubernetes-jenkins-slave-68-91jbw-svtg2-3vq9b_devops_6d4bc0d2-b34f-46fc-9c9d-65537cb2bff8_0</span><br><span class=\"line\">84538d2017c2   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2   <span class=\"string\">\"/pause\"</span>                 About a minute ago   Up 58 seconds             k8s_POD_kubernetes-jenkins-slave-68-91jbw-svtg2-3vq9b_devops_6d4bc0d2-b34f-46fc-9c9d-65537cb2bff8_0</span><br><span class=\"line\"></span><br><span class=\"line\">Finished: SUCCESS</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/1/20210208155114.png\" alt=\"WeiyiGeek.custom-jenkins-jnlp\" title=\"\" class=\"\">\n                <p>WeiyiGeek.custom-jenkins-jnlp</p>\n            </figure>\n<p><br></p>\n<h3 id=\"Dockerfile-迭代更新\"><a href=\"#Dockerfile-迭代更新\" class=\"headerlink\" title=\"Dockerfile 迭代更新\"></a>Dockerfile 迭代更新</h3><ul>\n<li>截止于【2021年5月17日 16:41:37】最新更新的Dockerfile<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#----------------------------------------------------------------------#</span></span><br><span class=\"line\"><span class=\"comment\"># Title: Base in Alpine Images Create Custom Jenkins Kubernetes jnlp Images</span></span><br><span class=\"line\"><span class=\"comment\"># Author: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\"># WebSite: https://weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\"># Email: mastr@weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\"># Release: v1.11</span></span><br><span class=\"line\"><span class=\"comment\"># Image Version: alpine-3.13.1</span></span><br><span class=\"line\"><span class=\"comment\"># MainFunction:</span></span><br><span class=\"line\"><span class=\"comment\">#   Install ssh-server docker git openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm jq</span></span><br><span class=\"line\"><span class=\"comment\">#   Install JDK8 Version: 1.8.0_281</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://github.com/sgerrand/alpine-pkg-glibc/releases/</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub</span></span><br><span class=\"line\"><span class=\"comment\">#   Install jnlp Version: 4.11.2 (两钟方式都可以下载agent)</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting/</span></span><br><span class=\"line\"><span class=\"comment\">#   - http://youjenkins-domainname/jnlpJars/agent.jar</span></span><br><span class=\"line\"><span class=\"comment\">#   Install Maven Version: 3.8.4</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://apache.osuosl.org/maven/maven-3/$&#123;MAVEN_VERSION&#125;/binaries</span></span><br><span class=\"line\"><span class=\"comment\">#   Install SonarqubeScan Version: 4.5.0</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.5.0.2216-linux.zip</span></span><br><span class=\"line\"><span class=\"comment\">#   Install Gitlab Release Version: 0.10.0</span></span><br><span class=\"line\"><span class=\"comment\">#   - https://gitlab.com/gitlab-org/release-cli/-/releases</span></span><br><span class=\"line\"><span class=\"comment\">#   Install kubernetes cli</span></span><br><span class=\"line\"><span class=\"comment\">#   - kubectl Version: 1.23.1</span></span><br><span class=\"line\"><span class=\"comment\">#   Install docker cli</span></span><br><span class=\"line\"><span class=\"comment\">#   - kubectl Version: 20.10.3</span></span><br><span class=\"line\"><span class=\"comment\"># ChangeLog:</span></span><br><span class=\"line\"><span class=\"comment\"># v1.8 - 增加 docker</span></span><br><span class=\"line\"><span class=\"comment\"># v1.9 -  增加 中文环境</span></span><br><span class=\"line\"><span class=\"comment\"># v1.10 - 增加 node.js 环境支持</span></span><br><span class=\"line\"><span class=\"comment\"># v1.11 - 更新依赖软件版本及其agent.jar版本</span></span><br><span class=\"line\"><span class=\"comment\">#-------------------------------------------------#</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> alpine:<span class=\"number\">3.13</span>.<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span>  Jenkins Custom Work Node Jnlp Container - &lt;master@weiyigeek.top&gt; - WeiyiGeek</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> USERNAME=jenkins \\</span><br><span class=\"line\">    AGENT_WORKDIR=/home/jenkins \\</span><br><span class=\"line\">    BASE_DIR=/usr/local  \\</span><br><span class=\"line\">    BASE_BIN=/usr/local/bin  \\</span><br><span class=\"line\">    BASE_URL=http://<span class=\"number\">192.168</span>.<span class=\"number\">12.107</span>:<span class=\"number\">8080</span>  \\</span><br><span class=\"line\">    LOCALE=locale.md \\</span><br><span class=\"line\">    JDK_NAME=jdk-<span class=\"number\">8</span>u281-linux-x64   \\</span><br><span class=\"line\">    JDK_DIR=/usr/local/jdk1.<span class=\"number\">8.0</span>_281  \\</span><br><span class=\"line\">    GLIBC_NAME=glibc-<span class=\"number\">2.32</span>-r0.apk \\</span><br><span class=\"line\">    GLIBC_BIN_NAME=glibc-bin-<span class=\"number\">2.32</span>-r0.apk \\</span><br><span class=\"line\">    GLIBC_I18N_NAME=glibc-i18n-<span class=\"number\">2.32</span>-r0.apk \\</span><br><span class=\"line\">    MAVEN_NAME=apache-maven-<span class=\"number\">3.8</span>.<span class=\"number\">4</span>-bin \\</span><br><span class=\"line\">    MAVEN_DIR=/usr/local/apache-maven-<span class=\"number\">3.8</span>.<span class=\"number\">4</span> \\</span><br><span class=\"line\">    SONAR_SCANNER_NAME=sonar-scanner-cli-<span class=\"number\">4.5</span>.<span class=\"number\">0.2216</span>-linux \\</span><br><span class=\"line\">    SONAR_SCANNER_DIR=/usr/local/sonar-scanner-<span class=\"number\">4.5</span>.<span class=\"number\">0.2216</span>-linux \\</span><br><span class=\"line\">    GITLAB_CLI=release-cli-<span class=\"number\">0.10</span>.<span class=\"number\">0</span>-linux-amd64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> LANG=en_US.UTF-<span class=\"number\">8</span> \\</span><br><span class=\"line\">    LC_ALL=en_US.UTF-<span class=\"number\">8</span> \\</span><br><span class=\"line\">    JAVA_HOME=/usr/local/jdk8  \\</span><br><span class=\"line\">    JRE_HOME=/usr/local/jdk8/jre \\</span><br><span class=\"line\">    MAVEN_HOME=/usr/local/maven \\</span><br><span class=\"line\">    MAVEN_RPEO=/home/jenkins/.m2 \\</span><br><span class=\"line\">    SONAR_SCANNER_HOME=/usr/local/sonar-scanner \\</span><br><span class=\"line\">    NODEJS_MODULES=/usr/lib/node_modules</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用户ROOT切换</span></span><br><span class=\"line\"><span class=\"keyword\">USER</span> root</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Shell 命令 - 此种方式极大减少了构建的镜像大小;</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> sed -i <span class=\"string\">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; apk update \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; apk add --no-cache openssh tzdata curl tar sudo git ca-certificates wget unzip docker zlib nodejs npm bash jq \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; chmod 4755 /bin/busybox \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; addgroup -g 1000 -S <span class=\"variable\">$&#123;USERNAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; adduser <span class=\"variable\">$&#123;USERNAME&#125;</span> -D -g <span class=\"variable\">$&#123;USERNAME&#125;</span> -G root -u 1000 -s /bin/sh \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"jenkins   ALL=(root) NOPASSWD:ALL\"</span> &gt;&gt; /etc/sudoers \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; mkdir -p <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span>/agent <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span>/.ssh <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span>/.m2 \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;GLIBC_NAME&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GLIBC_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;GLIBC_BIN_NAME&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GLIBC_BIN_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;GLIBC_I18N_NAME&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GLIBC_I18N_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /etc/apk/keys/sgerrand.rsa.pub <span class=\"variable\">$&#123;BASE_URL&#125;</span>/sgerrand.rsa.pub \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;LOCALE&#125;</span> <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;LOCALE&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O /tmp/<span class=\"variable\">$&#123;JDK_NAME&#125;</span>.tar.gz <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;JDK_NAME&#125;</span>.tar.gz \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; wget -q -O <span class=\"variable\">$&#123;BASE_BIN&#125;</span>/agent.jar <span class=\"variable\">$&#123;BASE_URL&#125;</span>/agent.jar \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o <span class=\"variable\">$&#123;BASE_BIN&#125;</span>/jenkins-agent.sh <span class=\"variable\">$&#123;BASE_URL&#125;</span>/jenkins-agent.sh \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /tmp/<span class=\"variable\">$&#123;MAVEN_NAME&#125;</span>.tar.gz <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;MAVEN_NAME&#125;</span>.tar.gz \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /tmp/<span class=\"variable\">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /usr/<span class=\"built_in\">local</span>/bin/release-cli <span class=\"variable\">$&#123;BASE_URL&#125;</span>/<span class=\"variable\">$&#123;GITLAB_CLI&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /usr/<span class=\"built_in\">local</span>/bin/kubectl <span class=\"variable\">$&#123;BASE_URL&#125;</span>/kubectl \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; curl -fsSL -o /usr/<span class=\"built_in\">local</span>/bin/docker <span class=\"variable\">$&#123;BASE_URL&#125;</span>/docker \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; sed -i <span class=\"string\">\"s/#PermitRootLogin.*/PermitRootLogin yes/g\"</span> /etc/ssh/sshd_config \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; sed -i <span class=\"string\">\"s/^#\\s*StrictHostKeyChecking ask/StrictHostKeyChecking no/g\"</span> /etc/ssh/ssh_config \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t dsa -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_dsa_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t rsa -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_rsa_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t ecdsa -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_ecdsa_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t ed25519 -P <span class=\"string\">\"\"</span> -f /etc/ssh/ssh_host_ed25519_key \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; ssh-keygen -t ed25519 -P <span class=\"string\">\"\"</span> -C <span class=\"string\">\"master@weiyigeek.top\"</span> -f /home/jenkins/.ssh/id_ed25519 \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; apk add /tmp/<span class=\"variable\">$&#123;GLIBC_NAME&#125;</span> /tmp/<span class=\"variable\">$&#123;GLIBC_BIN_NAME&#125;</span> /tmp/<span class=\"variable\">$&#123;GLIBC_I18N_NAME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; tar -zxf /tmp/<span class=\"variable\">$&#123;JDK_NAME&#125;</span>.tar.gz -C <span class=\"variable\">$&#123;BASE_DIR&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; mv <span class=\"variable\">$&#123;JDK_DIR&#125;</span> <span class=\"variable\">$&#123;JAVA_HOME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; tar -zxf /tmp/<span class=\"variable\">$&#123;MAVEN_NAME&#125;</span>.tar.gz -C <span class=\"variable\">$&#123;BASE_DIR&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; mv <span class=\"variable\">$&#123;MAVEN_DIR&#125;</span> <span class=\"variable\">$&#123;MAVEN_HOME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; unzip /tmp/<span class=\"variable\">$&#123;SONAR_SCANNER_NAME&#125;</span>.zip -d <span class=\"variable\">$&#123;BASE_DIR&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; mv <span class=\"variable\">$&#123;SONAR_SCANNER_DIR&#125;</span> <span class=\"variable\">$&#123;SONAR_SCANNER_HOME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; npm config <span class=\"built_in\">set</span> registry https://registry.npmmirror.com \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; chmod a+x <span class=\"variable\">$&#123;BASE_BIN&#125;</span>/* \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; chown -R jenkins:jenkins <span class=\"variable\">$&#123;BASE_DIR&#125;</span>/ <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span>/ <span class=\"variable\">$&#123;NODEJS_MODULES&#125;</span>/ \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"root:WeiyiGeek\"</span> | chpasswd \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"jenkins:WeiyiGeek\"</span> | chpasswd \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; cat /tmp/<span class=\"variable\">$&#123;LOCALE&#125;</span> | xargs -i /usr/glibc-compat/bin/localedef -i &#123;&#125; -f UTF-8 &#123;&#125;.UTF-8 \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; sed -i <span class=\"string\">\"s#use_embedded_jre=true#use_embedded_jre=false#g\"</span> <span class=\"variable\">$&#123;SONAR_SCANNER_HOME&#125;</span>/bin/sonar-scanner \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; rm -rf /var/cache/apk/* /tmp/* <span class=\"variable\">$&#123;SONAR_SCANNER_HOME&#125;</span>/jre/* \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; <span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;JAVA_HOME&#125;</span> \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; rm -rf COPYRIGHT LICENSE README release THIRDPARTYLICENSEREADME-JAVAFX.txt THIRDPARTYLICENSEREADME.txt Welcome.html  javafx-src.zip src.zip \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/plugin.jar \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/ext/jfxrt.jar \\</span></span><br><span class=\"line\"><span class=\"bash\">    bin/javaws \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/javaws.jar \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/desktop \\</span></span><br><span class=\"line\"><span class=\"bash\">    plugin \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/deploy* \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/*javafx* \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/*jfx* \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/amd64/libdecora_sse.so \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/amd64/libprism_*.so \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/amd64/libfxplugins.so \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/amd64/libglass.so \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/amd64/libgstreamer-lite.so \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/amd64/libjavafx*.so \\</span></span><br><span class=\"line\"><span class=\"bash\">    lib/amd64/libjfx*.so \\</span></span><br><span class=\"line\"><span class=\"bash\">    &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">\"export LANG=zh_CN.UTF-8\"</span> &gt; /etc/profile.d/locale.sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">USER</span> jenkins</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"bash\"> <span class=\"variable\">$&#123;AGENT_WORKDIR&#125;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib/dt.jar:$&#123;JAVA_HOME&#125;/lib/tools.jar \\</span><br><span class=\"line\">    PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;MAVEN_HOME&#125;/bin:$&#123;SONAR_SCANNER_HOME&#125;/bin:$PATH</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"bash\"> [<span class=\"string\">\"/usr/local/bin/jenkins-agent.sh\"</span>]</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"DevOps","path":"api/categories/DevOps.json"},{"name":"CI-CD","path":"api/categories/CI-CD.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"}]}