{"title":"Ingress-Nginx 服务暴露基础学习与实践","slug":"虚拟云容/云容器/Kubernetes/功能组件/Ingress-Nginx/Ingress-Nginx基础学习与实践","date":"2020-05-27T10:37:47.000Z","updated":"2022-07-13T09:01:50.075Z","url":"2020/5-27-529.html","path":"api/articles/2020/5-27-529.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201115110119.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210718191523.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201114224006.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201115130307.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210716144446.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210716151525.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210717123656.png"],"content":"<p>[TOC]</p>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>描述： 到目前为止我们了解kubernetes常用的三种暴露服务的方式：LoadBlancer Service、 NodePort Service、Ingress</p>\n<ul>\n<li>LoadBlancer Service 是kubernetes结合云平台的组件，如国外的GCE，AWS，国内阿里云等等。使用它项使用的底层云平台申请创建负载均衡器来实现，对使用云平台的集群比较方便，但有局限，费用高。</li>\n<li>NodePort Service 是kubernetes在每个节点上暴露一个相同的端口(默认:30000-32000)但是由于安全和易用方面（服务多了就乱了还有端口冲突问题）且对主机安全性存在一定风险（内网环境，问题不大），所以实际使用并不多，当然对于小规模的集群服务，还是比较不错的。</li>\n<li>Ingress 是 kubernetes 中对外暴露服务的一种方式，它是使用Nginx进行反代应用来实现，其特点是安全以及方便统一管理等。</li>\n</ul>\n<p>Tips : 此外externalIPs也可以使各类service对外提供服务，但是当集群服务很多的时候，NodePort方式最大的缺点是会占用很多集群机器的端口；LB方式最大的缺点则是每个service一个LB又有点浪费和麻烦，并且需要k8s之外的支持； 而ingress则只需要一个NodePort或者一个LB就可以满足所有service对外服务的需求(便于管理)。<br>92</p>\n<p><br></p>\n<h3 id=\"Ingress-基础介绍\"><a href=\"#Ingress-基础介绍\" class=\"headerlink\" title=\"Ingress 基础介绍\"></a>Ingress 基础介绍</h3><p><strong>Q: 什么是负载均衡Ingress?</strong><br>描述：Ingress 其实就是集群外部访问的一个入口(在kubernetes v1.1时加入)，将外部的请求转发到不同的 Server 上，其实就相当于 <code>Nginx、Haproxy</code> 等负载均衡器。<br>即: Nginx-Ingress 是 Kubernetes 使用 NGINX 作为反向代理和负载平衡器的入口控制器。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> internet</span><br><span class=\"line\">    |</span><br><span class=\"line\">[ Ingress ]</span><br><span class=\"line\">--|-----|--</span><br><span class=\"line\">[ Services ]</span><br></pre></td></tr></table></figure>\n<p>Tips : 对于k8s传统的svc来说它仅支持4层代理, 如果需要做七层代理就需要使用k8s官方在1.11中推出了ingress api接口，通过ingress达到7层代理的效果我对于ingress来说必须要绑定一个域名因为它是基于7层代理的</p>\n<p>Tips : ingress调度的是后端的service而不是pod.</p>\n<p><br></p>\n<p><strong>NGINX 配置</strong><br>描述: Ingress 控制器的目标是组装一个配置文件(nginx.conf), 当修改配置文件发生任何更改后需要重新加载 NGINX。</p>\n<p><br></p>\n<p><strong>NGINX 模型与构建</strong><br>描述: Kubernetes 控制器使用同步循环模式来检查控制器中的所需状态是否已更新或是否需要更改。为此，我们需要使用集群中的不同对象构建模型，特别是（无特殊顺序）<code>Ingresses、Services、Endpoints、Secrets 和 Configmaps</code> 以生成反映集群状态的时间点配置文件.</p>\n<p>描述: 建立模型是一项昂贵的操作，因此必须使用同步循环。通过使用工作队列，可以不丢失更改并删除使用sync.Mutex来强制同步循环的单次执行，此外还可以在同步循环的开始和结束之间创建一个时间窗口，允许我们丢弃不必要的更新。</p>\n<p>Tips: NGINX 配置的最终表示是从Go 模板生成的，使用新模型作为模板所需变量的输入。</p>\n<p><br></p>\n<p><strong>Q: ingress-nginx解决了生产环境中哪些问题?</strong></p>\n<ul>\n<li><p>1）动态配置服务：如果按照传统方式，当新增加一个服务时，我们可能需要在流量入口加一个反向代理指向我们新的服务，而使用ingress，只需要配置好ingress，当服务启动时，会自动注册到ingress当中，不需要额外的操作。</p>\n</li>\n<li><p>2）减少不必要的Port暴露（安全，端口容易管理）: 我们知道部署k8s时，是需要关闭防火墙的，主要原因是k8s的很多服务会以nodeport方式映射出去，这样对于宿主机来说是非常的不安全的，而ingress可以避免这个问题，只需要将ingress自身服务映射出去，就可代理后端所有的服务，则后端服务不需要映射出去。</p>\n</li>\n</ul>\n<p><br></p>\n<p><strong>Q: ingress-Nginx和ingress-Nginx-Controller的区别?</strong></p>\n<ul>\n<li>ingress-Nginx: 是每个服务自己创建的ingress,就是nginx的转发规则,生成Nginx的配置文件</li>\n<li>ingress-Nginx-Controller: 相当于Nginx的服务,监听API Server,根据用户编写的ingress-nginx规则(ingress.yaml文件),动态的去更改Nginx服务的配置文件,并且reload使其生效,此过程是自动化的通过lua实现</li>\n</ul>\n<p><br></p>\n<h3 id=\"Ingress-实现原理\"><a href=\"#Ingress-实现原理\" class=\"headerlink\" title=\"Ingress 实现原理\"></a>Ingress 实现原理</h3><p>描述: Ingress 实际上是通过服务发现的功能进行实现，通过它来提供路由信息的刷新, <code>Ingress controller</code>可以理解为一个监视器，不断监听 <code>kube-apiserver</code> 实时感知service、Pod的变化，其再结合Ingress的配置，更新反向代理负载均衡器，达到服务发现的作用。</p>\n<p>Ingress 公开了从集群外部到集群内服务的 HTTP 和 HTTPS 路由，流量路由由 Ingress 资源上定义的规则控制,可以将 Ingress 配置为服务提供外部可访问的 URL、负载均衡流量、终止 SSL/TLS，以及提供基于名称的虚拟主机访问。</p>\n<p>Tips: Ingress 控制器通常负责通过负载均衡器来实现 Ingress，尽管它也可以配置边缘路由器或其他前端来帮助处理流量，并且ingress不暴露任何端口或协议。</p>\n<p><br></p>\n<p><strong>组件组成</strong><br>描述: 从下图可以看出<code>Ingress-nginx</code>一般由三个组件组成<code>反向代理负载均衡器 , Ingress Controller, Ingress</code></p>\n<ul>\n<li><p>1）反向代理负载均衡器：通常以service的port方式运行，接收并按照ingress定义的规则进行转发，常用的有nginx，Haproxy，Traefik等，本文中使用的就是nginx。</p>\n</li>\n<li><p>2）ingress-nginx-Controller： 监听APIServer，根据用户编写的ingress规则（编写ingress的yaml文件），动态地去更改nginx服务的配置文件，并且reload重载使其生效，此过程是自动化的（通过lua脚本来实现）。</p>\n</li>\n<li><p>3）Ingress：将nginx的配置抽象成一个Ingress对象，当用户每添加一个新的服务，只需要编写一个新的ingress的yaml文件即可。</p>\n</li>\n</ul>\n<p><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201115110119.png\" alt=\"WeiyiGeek.Ingress-Nginx流程与实现原理\"></p>\n<p><br/></p>\n<p><strong>工作流程</strong></p>\n<ul>\n<li><p>1）ingress controller通过和kubernetes api交互，动态的去感知集群中ingress规则变化。</p>\n</li>\n<li><p>2）然后读取它，按照自定义的规则，规则就是写明了那个域名对应哪个service，生成一段nginx配置。</p>\n</li>\n<li><p>3）在写到nginx-ingress-controller的pod里，这个Ingress controller的pod里运行着一个Nginx服务，控制器会把生成的nginx配置写入/etc/nginx.conf文件中。</p>\n</li>\n<li><p>4）最后 reload 一下使配置生效，以此达到分配和动态更新问题。</p>\n</li>\n</ul>\n<p>注意：写入 nginx.conf 的不是service的地址，而是service backend 的 pod 的地址，避免在 service 在增加一层负载均衡转发</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210718191523.png\" alt=\"WeiyiGeek.工作流程\" title=\"\" class=\"\">\n                <p>WeiyiGeek.工作流程</p>\n            </figure>\n<p><br/></p>\n<p>Tips : 目前可以提供Ingress controller有很多比如<code>traefik、nginx-ingress、Kubernetes Ingress Cpmtrper for Kong、HAProxy Ingress controller</code>等。</p>\n<p>Tips : 目前常见的负载均衡有<code>Ingress-Nginx</code>和<code>Ingress-Traefik</code>等。</p>\n<p>Tips: 如果多个 Ingress 为同一主机定义了路径，则 Ingress 控制器会合并这些定义。</p>\n<p>Tips: 入口控制器第一次启动时，两个作业创建了准入 Webhook 使用的 SSL 证书。因此，在可以创建和验证 Ingress 定义之前，会有最多两分钟的初始延迟。</p>\n<p>Tips: admission webhook 需要Kubernetes API服务器和入口控制器之间的连接,请保证防火墙允许8443端口通信。</p>\n<p><br></p>\n<p><strong>名词解析复习</strong></p>\n<ul>\n<li>节点： Kubernetes 集群中的服务器</li>\n<li>集群： Kubernetes 管理的一组服务器集合</li>\n<li>边界路由器： 为局域网和 Internet 路由数据包的路由器，执行防火墙保护局域网络</li>\n<li>集群网络： 遵循 Kubernetes 网络模型实现集群内的通信的具体实现，比如 Flannel 和 Calico</li>\n<li><p>服务： Kubernetes 的服务 (Service) 是使用标签选择器标识的一组 Pod Service (Deployment)。 除非另有说明，否则服务的虚拟 IP 仅可在集群内部访问</p>\n</li>\n<li><p>NodePort: 服务是引导外部流量到你的服务的最原始方式。</p>\n</li>\n<li>LoadBalancer: 服务是暴露服务到 Internet 的标准方式。</li>\n<li>Ingress: 事实上不是一种服务类型。Ingress 可能是暴露服务的最强大方式，但同时也是最复杂的。Ingress 控制器有各种类型，包括 Google Cloud Load Balancer，Nginx，Contour，Istio等等。</li>\n</ul>\n<hr>\n<h2 id=\"0x01-Ingress-安装配置\"><a href=\"#0x01-Ingress-安装配置\" class=\"headerlink\" title=\"0x01 Ingress 安装配置\"></a>0x01 Ingress 安装配置</h2><p>描述: Ingress-Nginx本质上是创建了一个Nginx的Node pod，只不过这个无需手写Nginx的配置文件而是通过自动生成的方式实现;</p>\n<p><strong>帮助参考</strong><br>Ingress-Nginx 官方网站：<a href=\"https://kubernetes.github.io/ingress-nginx/\" target=\"_blank\" rel=\"noopener\">https://kubernetes.github.io/ingress-nginx/</a><br>Ingress-Nginx Github地址：<a href=\"https://github.com/kubernetes/ingress-nginx\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/ingress-nginx</a><br>版本查看: <a href=\"https://github.com/kubernetes/ingress-nginx/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/ingress-nginx/releases</a></p>\n<p><strong>版本支持说明</strong>: <a href=\"https://github.com/kubernetes/ingress-nginx/#support-versions-table\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/ingress-nginx/#support-versions-table</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ingress-nginx version\t| k8s supported version| Alpine Version | Nginx Version</span><br><span class=\"line\">v1.0.0-alpha.2\t1.22, 1.21, 1.20, 1.19\t3.13.5\t1.20.1</span><br><span class=\"line\">v1.0.0-alpha.1\t1.21, 1.20, 1.19\t3.13.5\t1.20.1</span><br><span class=\"line\">v0.48.1\t1.21, 1.20, 1.19\t3.13.5\t1.20.1</span><br><span class=\"line\">v0.47.0\t1.21, 1.20, 1.19\t3.13.5\t1.20.1</span><br><span class=\"line\">v0.46.0\t1.21, 1.20, 1.19\t3.13.2\t1.19.6</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h3 id=\"配置指南\"><a href=\"#配置指南\" class=\"headerlink\" title=\"配置指南\"></a>配置指南</h3><p>描述: 默认配置监视来自所有命名空间的Ingress 对象。要更改此行为，请使用标志<code>--watch-namespace</code>将范围限制为特定命名空间。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">wait</span> --namespace ingress-nginx \\</span><br><span class=\"line\">  --<span class=\"keyword\">for</span>=condition=ready pod \\</span><br><span class=\"line\">  --selector=app.kubernetes.io/component=controller \\</span><br><span class=\"line\">  --timeout=120s</span><br></pre></td></tr></table></figure>\n<p><strong>定制NGINX有三种方式:</strong> 参考地址(<a href=\"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/\" target=\"_blank\" rel=\"noopener\">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/</a>)</p>\n<ul>\n<li>ConfigMap: 使用ConfigMap在NGINX中设置全局配置。</li>\n<li>Annotations: 如果您需要特定入口规则的特定配置，请使用此选项。</li>\n<li>Custom template: 当需要更具体的设置（如打开文件缓存）时，将侦听选项调整为rcvbuf或当无法通过ConfigMap更改配置时。</li>\n</ul>\n<p><br/></p>\n<p><strong>sysctl 调优</strong><br>描述: 在演示使用 Init Container 来调整 sysctl 默认值 kubectl patch, <code>(1) 积压队列设置net.core.somaxconn从128到32768, (2) 临时端口设置net.ipv4.ip_local_port_range从32768 60999到1024 65000</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl patch deployment -n ingress-nginx nginx-ingress-controller \\</span><br><span class=\"line\">  --patch=<span class=\"string\">\"<span class=\"variable\">$(curl https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/docs/examples/customization/sysctl/patch.json)</span>\"</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h3 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h3><p><strong>Ingress-Nginx 基础环境部署流程</strong></p>\n<ul>\n<li>(1) 使用 NodePort : <a href=\"https://kubernetes.github.io/ingress-nginx/deploy/\" target=\"_blank\" rel=\"noopener\">https://kubernetes.github.io/ingress-nginx/deploy/</a></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.47.0/deploy/static/provider/baremetal/deploy.yaml</span><br></pre></td></tr></table></figure>\n<ul>\n<li>(2) 镜像拉取</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看依赖的镜像</span></span><br><span class=\"line\">~/K8s/Day7/demo1$ cat deploy.yaml | grep <span class=\"string\">\"image:\"</span> | sort | uniq</span><br><span class=\"line\">  <span class=\"comment\"># image: docker.io/jettech/kube-webhook-certgen:v1.5.0</span></span><br><span class=\"line\">  <span class=\"comment\"># image: k8s.gcr.io/ingress-nginx/controller:v0.47.0@sha256:1f4f402b9c14f3ae92b11ada1dfe9893a88f0faeb0b2f4b903e2c67a0c3bf0de</span></span><br><span class=\"line\"><span class=\"comment\"># 拉取所需镜像: 如果您有国外的VPS可以直接进行拉取或者提花替换 k8s.gcr.io镜像站点;</span></span><br><span class=\"line\"><span class=\"comment\"># ingress-nginx-controll 版本稍微延迟: https://hub.docker.com/r/pollyduan/ingress-nginx-controller</span></span><br><span class=\"line\"><span class=\"comment\"># sed -i \"s|k8s.gcr.io/ingress-nginx/controller\\S.*$|pollyduan/ingress-nginx-controller:v0.47.0|g\" deploy.yaml</span></span><br><span class=\"line\">docker pull pollyduan/ingress-nginx-controller:v0.47.0</span><br><span class=\"line\">docker pull docker.io/jettech/kube-webhook-certgen:v1.5.0</span><br></pre></td></tr></table></figure>\n<ul>\n<li>(3) 更改Tag上传到私有仓库中</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/K8s/Day7/demo1$ docker login harbor.weiyigeek.top</span><br><span class=\"line\">~/K8s/Day7/demo1$ docker tag docker.io/jettech/kube-webhook-certgen:v1.5.0 harbor.weiyigeek.top/<span class=\"built_in\">test</span>/kube-webhook-certgen:v1.5.0</span><br><span class=\"line\">~/K8s/Day7/demo1$ docker tag pollyduan/ingress-nginx-controller:v0.41.0 harbor.weiyigeek.top/<span class=\"built_in\">test</span>/ingress-nginx-controller:v0.41.0</span><br><span class=\"line\">  <span class=\"comment\"># docker push harbor.weiyigeek.top/test/kube-webhook-certgen:v1.5.0</span></span><br><span class=\"line\">  <span class=\"comment\"># docker push harbor.weiyigeek.top/test/ingress-nginx-controller:v0.41.0</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>(4) 部署清单修改与部署</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将官方的镜像更改为私有镜像Tag方便在私有仓库中进行拉取</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s#docker.io/jettech/kube-webhook-certgen:v1.5.0#harbor.weiyigeek.top/test/kube-webhook-certgen:v1.5.0#g\"</span> deploy.yaml</span><br><span class=\"line\">sed -i <span class=\"string\">\"s#k8s.gcr.io/ingress-nginx/controller:v0.47.0@sha256:1f4f402b9c14f3ae92b11ada1dfe9893a88f0faeb0b2f4b903e2c67a0c3bf0de#harbor.weiyigeek.top/test/ingress-nginx-controller:v0.41.0#g\"</span> deploy.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">~/K8s/Day7/demo1$ kubectl apply -f deploy.yaml</span><br><span class=\"line\">  <span class=\"comment\"># namespace/ingress-nginx created</span></span><br><span class=\"line\">  <span class=\"comment\"># serviceaccount/ingress-nginx created</span></span><br><span class=\"line\">  <span class=\"comment\"># configmap/ingress-nginx-controller created</span></span><br><span class=\"line\">  <span class=\"comment\"># clusterrole.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class=\"line\">  <span class=\"comment\"># clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class=\"line\">  <span class=\"comment\"># role.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class=\"line\">  <span class=\"comment\"># rolebinding.rbac.authorization.k8s.io/ingress-nginx created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/ingress-nginx-controller-admission created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/ingress-nginx-controller created</span></span><br><span class=\"line\">  <span class=\"comment\"># deployment.apps/ingress-nginx-controller created</span></span><br><span class=\"line\">  <span class=\"comment\"># validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created</span></span><br><span class=\"line\">  <span class=\"comment\"># serviceaccount/ingress-nginx-admission created</span></span><br><span class=\"line\">  <span class=\"comment\"># clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class=\"line\">  <span class=\"comment\"># clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class=\"line\">  <span class=\"comment\"># role.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class=\"line\">  <span class=\"comment\"># rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span></span><br><span class=\"line\">  <span class=\"comment\"># job.batch/ingress-nginx-admission-create created</span></span><br><span class=\"line\">  <span class=\"comment\"># job.batch/ingress-nginx-admission-patch created</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>(5) 验证查看</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get ns | grep <span class=\"string\">\"ingress\"</span> <span class=\"comment\"># 名称空间查看</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx     Active   59s</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get svc -n ingress-nginx   <span class=\"comment\"># Service 服务查看</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller             NodePort    10.96.183.29    &lt;none&gt;        80:32268/TCP,443:30499/TCP   22m</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller-admission   ClusterIP   10.98.154.140   &lt;none&gt;        443/TCP                      22m</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get deployment -n ingress-nginx -o wide <span class=\"comment\"># deployment 控制器</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                       READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                                                       SELECTOR</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller   1/1     1            1           2m14s   controller   harbor.weiyigeek.top/test/ingress-nginx-controller:v0.41.0   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx</span></span><br><span class=\"line\">$ kubectl get rs -n ingress-nginx -o wide  <span class=\"comment\"># ReplicaSet 控制器</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                  DESIRED   CURRENT   READY   AGE    CONTAINERS   IMAGES                                                       SELECTOR</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller-849d675ffc   1         1         1       115s   controller   harbor.weiyigeek.top/test/ingress-nginx-controller:v0.41.0   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx,pod-template-hash=849d675ffc</span></span><br><span class=\"line\">$ kubectl get pod -n ingress-nginx -o wide --show-labels  <span class=\"comment\">#Pod 资源控制器</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                        READY   STATUS      RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES   LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-admission-create-ds8b5        0/1     Completed   0          11m   10.244.1.110   k8s-node-4   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/component=admission-webhook,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/version=0.47.0,controller-uid=2d63785a-c26d-413a-9d9d-d68ba255f0cd,helm.sh/chart=ingress-nginx-3.10.1,job-name=ingress-nginx-admission-create</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-admission-patch-kzx2v         0/1     Completed   1          11m   10.244.1.111   k8s-node-4   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/component=admission-webhook,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/version=0.47.0,controller-uid=c5ac4231-dc89-4699-996c-a1ea657cd7e7,helm.sh/chart=ingress-nginx-3.10.1,job-name=ingress-nginx-admission-patch</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller-849d675ffc-7ftvt   1/1     Running     0          11m   10.244.1.114   k8s-node-4   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx,pod-template-hash=849d675ffc</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>(6) 运行的Pod过程查看</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/K8s/Day7/demo1$ kubectl describe -n ingress-nginx pod ingress-nginx-admission-patch-kzx2v</span><br><span class=\"line\">  <span class=\"comment\"># Name:         ingress-nginx-admission-patch-kzx2v</span></span><br><span class=\"line\">  <span class=\"comment\"># Namespace:    ingress-nginx</span></span><br><span class=\"line\">  <span class=\"comment\"># Events:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Type    Reason          Age                  From               Message</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----    ------          ----                 ----               -------</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  Scheduled       4m6s                 default-scheduler  Successfully assigned ingress-nginx/ingress-nginx-admission-patch-kzx2v to k8s-node-4</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  Pulling         4m5s                 kubelet            Pulling image \"harbor.weiyigeek.top/test/kube-webhook-certgen:v1.5.0\"</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  Pulled          4m4s                 kubelet            Successfully pulled image \"harbor.weiyigeek.top/test/kube-webhook-certgen:v1.5.0\" in 788.689782ms</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  Created         4m1s (x2 over 4m3s)  kubelet            Created container patch</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  Started         4m1s (x2 over 4m3s)  kubelet            Started container patch</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  Pulled          4m1s                 kubelet            Container image \"harbor.weiyigeek.top/test/kube-webhook-certgen:v1.5.0\" already present on machine</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  SandboxChanged  3m59s                kubelet            Pod sandbox changed, it will be killed and re-created.</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"基础示例\"><a href=\"#基础示例\" class=\"headerlink\" title=\"基础示例\"></a>基础示例</h3><p>官方示例参考: <a href=\"https://kubernetes.github.io/ingress-nginx/examples/\" target=\"_blank\" rel=\"noopener\">https://kubernetes.github.io/ingress-nginx/examples/</a></p>\n<h4 id=\"示例1-Ingress-常规使用方案\"><a href=\"#示例1-Ingress-常规使用方案\" class=\"headerlink\" title=\"示例1.Ingress 常规使用方案\"></a>示例1.Ingress 常规使用方案</h4><p>Ingress HTTP 代理访问资源清单的编写</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; dep-svc-nginx-http-v1.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"># Deployment 控制器</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-dm</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span>                  <span class=\"comment\"># 选择器</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span>  </span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">nginx-ingress-v1</span>  <span class=\"comment\"># 匹配的Pod标签非常重要</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">nginx-ingress-v1</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx</span> </span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">harbor.weiyigeek.top/test/nginx:v1.0</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span> </span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Service 控制器</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-ingress-v1-svc</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">80</span> </span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">80</span> </span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span> </span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">nginx-ingress-v1</span>               <span class=\"comment\"># 【重点】用于关联Pod所以标签与Deployment定义的标签一种</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ingress-nginx-http-v1.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"># Ingress 扩展</span></span><br><span class=\"line\"><span class=\"string\"># Warning: extensions/v1beta1 Ingress is deprecated in v1.14+, unavailable in v1.22+; use networking.k8s.io/v1 Ingress</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span>         <span class=\"comment\"># 注意点否则将报上面的预警</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">nginx-ingress-http</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">web.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">        - pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/</span> </span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">           service:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">nginx-ingress-v1-svc</span>   <span class=\"comment\">#【重点】关联Service控制器所以与Service定义的源数据名称一致</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span></span><br><span class=\"line\"><span class=\"attr\">              number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p><strong>操作流程:</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 部署 Deployment 与 Service</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl create -f dep-svc-nginx-http-v1.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># PS: 如果出现错误则需要在进行ingress创建的时候需要将Webhook删了才能正常创建ingress。</span></span><br><span class=\"line\"><span class=\"comment\"># ~/K8s/Day7/demo2$ kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission</span></span><br><span class=\"line\">  <span class=\"comment\"># validatingwebhookconfiguration.admissionregistration.k8s.io \"ingress-nginx-admission\" deleted</span></span><br><span class=\"line\">  </span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl create -f ingress-nginx-http-v1.yaml</span><br><span class=\"line\">  <span class=\"comment\"># ingress.networking.k8s.io/nginx-ingress-http created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看</span></span><br><span class=\"line\">$ kubectl get svc -n ingress-nginx <span class=\"comment\"># 查看服务端口</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller             NodePort    10.96.183.29    &lt;none&gt;        80:32268/TCP,443:30499/TCP   8h</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller-admission   ClusterIP   10.98.154.140   &lt;none&gt;        443/TCP                      8h</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl get ingress</span><br><span class=\"line\"><span class=\"comment\"># Warning: extensions/v1beta1 Ingress is deprecated in v1.14+, unavailable in v1.22+; use networking.k8s.io/v1 Ingress  # 我们已使用`networking.k8s.io/v1`</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                 CLASS    HOSTS               ADDRESS         PORTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx-ingress-http   &lt;none&gt;   web.weiyigeek.top   10.10.107.214(绑定的节点地址)   80      8h</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl get pod -o wide</span><br><span class=\"line\">  <span class=\"comment\"># NAME                        READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx-dm-7654c987b4-s5cj2   1/1     Running   0          8h    10.244.1.125   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx-dm-7654c987b4-wgfm2   1/1     Running   0          8h    10.244.1.126   k8s-node-4   &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 访问端设置本地DNS解析 &amp; 在浏览器中进行HTTP访问</span></span><br><span class=\"line\"><span class=\"comment\"># /etc/hosts</span></span><br><span class=\"line\">10.10.107.214 web.weiyigeek.top </span><br><span class=\"line\"><span class=\"comment\"># PS: 这里访问的是Node节点映射出的端口而非直接访问的80端口</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ curl web.weiyigeek.top:32268/host.html</span><br><span class=\"line\">  <span class=\"comment\"># Hostname: nginx-dm-7654c987b4-wgfm2  &lt;br&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># Image Version: &lt;u&gt; 1.0 &lt;/u&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># Nginx Version: 1.19.4</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ curl web.weiyigeek.top:32268/host.html</span><br><span class=\"line\">  <span class=\"comment\"># Hostname: nginx-dm-7654c987b4-s5cj2  &lt;br&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># Image Version: &lt;u&gt; 1.0 &lt;/u&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># Nginx Version: 1.19.4</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 验证</span></span><br><span class=\"line\">/K8s/Day7/demo2$ sudo ipvsadm -Ln</span><br><span class=\"line\">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class=\"line\">Prot LocalAddress:Port Scheduler Flags</span><br><span class=\"line\">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class=\"line\">TCP  172.17.0.1:30499 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:443             Masq    1      0          0</span><br><span class=\"line\">TCP  172.17.0.1:32268 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:80              Masq    1      0          0</span><br><span class=\"line\">TCP  172.18.0.1:30499 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:443             Masq    1      0          0</span><br><span class=\"line\">TCP  172.18.0.1:32268 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:80              Masq    1      0          0</span><br><span class=\"line\">TCP  172.18.0.1:32306 rr</span><br><span class=\"line\">  -&gt; 10.244.1.107:80              Masq    1      0          0</span><br><span class=\"line\">  -&gt; 10.244.1.108:80              Masq    1      0          0</span><br><span class=\"line\">  -&gt; 10.244.1.109:80              Masq    1      0          0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Node(节点)</span></span><br><span class=\"line\">TCP  10.10.107.202:30499 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:443             Masq    1      0          0</span><br><span class=\"line\">TCP  10.10.107.202:32268 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:80   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># NodePort</span></span><br><span class=\"line\">TCP  10.96.183.29:80 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:80              Masq    1      0          0</span><br><span class=\"line\">TCP  10.96.183.29:443 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:443             Masq    1      0          0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># CluterPort</span></span><br><span class=\"line\">TCP  10.98.154.140:443 rr</span><br><span class=\"line\">  -&gt; 10.244.1.124:8443            Masq    1      0          0</span><br><span class=\"line\">TCP  10.102.158.47:80 rr</span><br><span class=\"line\">  -&gt; 10.244.1.125:80              Masq    1      0          0</span><br><span class=\"line\">  -&gt; 10.244.1.126:80              Masq    1      0          0</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h4 id=\"示例2-Ingress-HTTPS-代理访问\"><a href=\"#示例2-Ingress-HTTPS-代理访问\" class=\"headerlink\" title=\"示例2.Ingress HTTPS 代理访问\"></a>示例2.Ingress HTTPS 代理访问</h4><p>描述: TLS 证书配置参考地址(<a href=\"https://kubernetes.github.io/ingress-nginx/user-guide/tls/),注意创建自建证书（主：浏览器不认可的）。默认得Ingress-nginx配置了SSL会自动跳转到https网页。\" target=\"_blank\" rel=\"noopener\">https://kubernetes.github.io/ingress-nginx/user-guide/tls/),注意创建自建证书（主：浏览器不认可的）。默认得Ingress-nginx配置了SSL会自动跳转到https网页。</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#指示位置部分是否仅可访问SSL（当Ingress包含证书默认为True) bool, 当设置为false时禁用https强制跳转。</span></span><br><span class=\"line\">nginx.ingress.kubernetes.io/ssl-redirect    </span><br><span class=\"line\">nginx.ingress.kubernetes.io/force-ssl-redirect <span class=\"comment\"># 即使lngress未启用TLS，也强制重定向到HTTPS bool</span></span><br></pre></td></tr></table></figure>\n<p>资源清单示例:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Deployment &amp; Service</span></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; dep-ingress-nginx-https-v3.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-nginx-https</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span> </span><br><span class=\"line\"><span class=\"attr\">  selector:</span>                          <span class=\"comment\"># 选择器</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span>  </span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">ingress-nginx-https-v3</span>  <span class=\"comment\"># 匹配的Pod标签非常重要</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        name:</span> <span class=\"string\">ingress-nginx-https-v3</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">ingress-nginx-https-v3</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">harbor.weiyigeek.top/test/nginx:v3.0</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span> </span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-nginx-https-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">80</span> </span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">80</span> </span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span> </span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">ingress-nginx-https-v3</span>   <span class=\"comment\"># 关联指定标签的Pod</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Ingress</span></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ingress-nginx-https-v3.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-nginx-https</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  tls:</span></span><br><span class=\"line\"><span class=\"attr\">    - hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">www3.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">      secretName:</span> <span class=\"string\">tls-secret</span> </span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">www3.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">        - pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/</span> </span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">            service:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">ingress-nginx-https-svc</span>   <span class=\"comment\">#【重点】 关联Service控制器所以与Service定义的源数据名称一致</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span></span><br><span class=\"line\"><span class=\"attr\">                number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p><strong>操作流程：</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 创建 Pod 与 Service</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl create -f dep-ingress-nginx-https-v3.yaml</span><br><span class=\"line\">  <span class=\"comment\"># deployment.apps/ingress-nginx-https created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/ingress-nginx-https-svc created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 创建证书及cert存储方式</span></span><br><span class=\"line\">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class=\"string\">\"/CN=www3.weiyigeek.top/O=www3.weiyigeek.top\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Generating a RSA private key</span></span><br><span class=\"line\">  <span class=\"comment\"># ..+++++</span></span><br><span class=\"line\">  <span class=\"comment\"># ........................+++++</span></span><br><span class=\"line\">  <span class=\"comment\"># writing new private key to 'tls.key'</span></span><br><span class=\"line\">  <span class=\"comment\"># -----</span></span><br><span class=\"line\">kubectl create secret tls tls-secret --key tls.key --cert tls.crt <span class=\"comment\"># 后续讲解</span></span><br><span class=\"line\">  <span class=\"comment\"># secret/tls-secret created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 创建 ingress-nginx https </span></span><br><span class=\"line\">kubectl create -f ingress-nginx-https-v3.yaml</span><br><span class=\"line\">  <span class=\"comment\"># ingress.networking.k8s.io/ingress-nginx-https created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 查看</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl get ingress</span><br><span class=\"line\">  <span class=\"comment\"># Warning: extensions/v1beta1 Ingress is deprecated in v1.14+, unavailable in v1.22+; use networking.k8s.io/v1 Ingress</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                  CLASS    HOSTS                ADDRESS         PORTS     AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-https   &lt;none&gt;   www3.weiyigeek.top   10.10.107.214   80, 443   117s</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl get svc -n ingress-nginx  <span class=\"comment\"># ingress-nginx 的 SVC 信息里面有Nodeport暴露的端口</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller             NodePort    10.96.183.29    &lt;none&gt;        80:32268/TCP,443:30499/TCP   9h</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller-admission   ClusterIP   10.98.154.140   &lt;none&gt;        443/TCP                      9h</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 验证</span></span><br><span class=\"line\"><span class=\"comment\"># http访问: https://www3.weiyigeek.top/</span></span><br><span class=\"line\">无法访问  <span class=\"comment\"># 由于配置了https会导致http无法正常访问(在后续实验中会将http访问的流量强制转到https之中)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># https访问: https://www3.weiyigeek.top:30499/host.html</span></span><br><span class=\"line\">Hostname: ingress-nginx-https-55bb4cd6fd-4rmpm ,Image Version: 3.0, Nginx Version: 1.19.4</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201114224006.png\" alt=\"WeiyiGeek.ingress-nginx-https\" title=\"\" class=\"\">\n                <p>WeiyiGeek.ingress-nginx-https</p>\n            </figure>\n<p><br/></p>\n<p>PS : 实际上我们通过Ingress资源清单添加的域名绑定主机时被写入到 <code>ingress-nginx-controller</code> Pod 中的nginx.conf 文件之中，这才能让我们通过自定义域名的方式访问虚拟主机;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/K8s/Day7/demo2$ kubectl <span class=\"built_in\">exec</span> -n ingress-nginx ingress-nginx-controller-849d675ffc-6rxlm -it -- /bin/sh</span><br><span class=\"line\">/etc/nginx $ ls</span><br><span class=\"line\"><span class=\"comment\"># fastcgi.conf            koi-utf                 modsecurity             owasp-modsecurity-crs   uwsgi_params.default</span></span><br><span class=\"line\"><span class=\"comment\"># fastcgi.conf.default    koi-win                 modules                 scgi_params             win-utf</span></span><br><span class=\"line\"><span class=\"comment\"># fastcgi_params          lua                     nginx.conf              scgi_params.default</span></span><br><span class=\"line\"><span class=\"comment\"># fastcgi_params.default  mime.types              nginx.conf.default      template</span></span><br><span class=\"line\"><span class=\"comment\"># geoip                   mime.types.default      opentracing.json        uwsgi_params</span></span><br><span class=\"line\"></span><br><span class=\"line\">/etc/nginx $ cat nginx.conf | grep <span class=\"string\">\"www3.weiyigeek.top\"</span> -n</span><br><span class=\"line\">  <span class=\"comment\"># 551:    ## start server www3.weiyigeek.top</span></span><br><span class=\"line\">  <span class=\"comment\"># 553:            server_name www3.weiyigeek.top ;</span></span><br><span class=\"line\">  <span class=\"comment\"># 679:    ## end server www3.weiyigeek.top</span></span><br></pre></td></tr></table></figure>\n<p>Ingress-Nginx-Https配置示例:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 下面可以帮助我们认是ingress-nginx实现https是如何进行配置的;</span><br><span class=\"line\">## start server www3.weiyigeek.top</span><br><span class=\"line\">        server &#123;</span><br><span class=\"line\">                server_name www3.weiyigeek.top ;</span><br><span class=\"line\"></span><br><span class=\"line\">                listen 80  ;</span><br><span class=\"line\">                listen 443  ssl http2 ;</span><br><span class=\"line\"></span><br><span class=\"line\">                set $proxy_upstream_name &quot;-&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">                ssl_certificate_by_lua_block &#123;</span><br><span class=\"line\">                        certificate.call()</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                location &#x2F; &#123;</span><br><span class=\"line\">                        set $namespace      &quot;default&quot;;</span><br><span class=\"line\">                        set $ingress_name   &quot;ingress-nginx-https&quot;;</span><br><span class=\"line\">                        set $service_name   &quot;ingress-nginx-https-svc&quot;;</span><br><span class=\"line\">                        set $service_port   &quot;80&quot;;</span><br><span class=\"line\">                        set $location_path  &quot;&#x2F;&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">                        rewrite_by_lua_block &#123;</span><br><span class=\"line\">                                lua_ingress.rewrite(&#123;</span><br><span class=\"line\">                                        force_ssl_redirect &#x3D; false,</span><br><span class=\"line\">                                        ssl_redirect &#x3D; true,</span><br><span class=\"line\">                                        force_no_ssl_redirect &#x3D; false,</span><br><span class=\"line\">                                        use_port_in_redirects &#x3D; false,</span><br><span class=\"line\">                                        path_type &#x3D; &quot;Prefix&quot;,</span><br><span class=\"line\">                                &#125;)</span><br><span class=\"line\">                                balancer.rewrite()</span><br><span class=\"line\">                                plugins.run()</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        # be careful with &#96;access_by_lua_block&#96; and &#96;satisfy any&#96; directives as satisfy any</span><br><span class=\"line\">                        # will always succeed when there&#39;s &#96;access_by_lua_block&#96; that does not have any lua code doing &#96;ngx.exit(ngx.DECLINED)&#96;</span><br><span class=\"line\">                        # other authentication method such as basic auth or external auth useless - all requests will be allowed.</span><br><span class=\"line\">                        #access_by_lua_block &#123;</span><br><span class=\"line\">                        #&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        header_filter_by_lua_block &#123;</span><br><span class=\"line\">                                lua_ingress.header()</span><br><span class=\"line\">                                plugins.run()</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        body_filter_by_lua_block &#123;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        log_by_lua_block &#123;</span><br><span class=\"line\">                                balancer.log()</span><br><span class=\"line\"></span><br><span class=\"line\">                                monitor.call()</span><br><span class=\"line\"></span><br><span class=\"line\">                                plugins.run()</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        port_in_redirect off;</span><br><span class=\"line\"></span><br><span class=\"line\">                        set $balancer_ewma_score -1;</span><br><span class=\"line\">                        set $proxy_upstream_name &quot;default-ingress-nginx-https-svc-80&quot;;</span><br><span class=\"line\">                        set $proxy_host          $proxy_upstream_name;</span><br><span class=\"line\">                        set $pass_access_scheme  $scheme;</span><br><span class=\"line\"></span><br><span class=\"line\">                        set $pass_server_port    $server_port;</span><br><span class=\"line\"></span><br><span class=\"line\">                        set $best_http_host      $http_host;</span><br><span class=\"line\">                        set $pass_port           $pass_server_port;</span><br><span class=\"line\"></span><br><span class=\"line\">                        set $proxy_alternative_upstream_name &quot;&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">                        client_max_body_size                    1m;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_set_header Host                   $best_http_host;</span><br><span class=\"line\"></span><br><span class=\"line\">                        # Pass the extracted client certificate to the backend</span><br><span class=\"line\"></span><br><span class=\"line\">                        # Allow websocket connections</span><br><span class=\"line\">                        proxy_set_header                        Upgrade           $http_upgrade;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_set_header                        Connection        $connection_upgrade;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_set_header X-Request-ID           $req_id;</span><br><span class=\"line\">                        proxy_set_header X-Real-IP              $remote_addr;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_set_header X-Forwarded-For        $remote_addr;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_set_header X-Forwarded-Host       $best_http_host;</span><br><span class=\"line\">                        proxy_set_header X-Forwarded-Port       $pass_port;</span><br><span class=\"line\">                        proxy_set_header X-Forwarded-Proto      $pass_access_scheme;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_set_header X-Scheme               $pass_access_scheme;</span><br><span class=\"line\"></span><br><span class=\"line\">                        # Pass the original X-Forwarded-For</span><br><span class=\"line\">                        proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;</span><br><span class=\"line\"></span><br><span class=\"line\">                        # mitigate HTTPoxy Vulnerability</span><br><span class=\"line\">                        # https:&#x2F;&#x2F;www.nginx.com&#x2F;blog&#x2F;mitigating-the-httpoxy-vulnerability-with-nginx&#x2F;</span><br><span class=\"line\">                        proxy_set_header Proxy                  &quot;&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">                        # Custom headers to proxied server</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_connect_timeout                   5s;</span><br><span class=\"line\">                        proxy_send_timeout                      60s;</span><br><span class=\"line\">                        proxy_read_timeout                      60s;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_buffering                         off;</span><br><span class=\"line\">                        proxy_buffer_size                       4k;</span><br><span class=\"line\">                        proxy_buffers                           4 4k;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_max_temp_file_size                1024m;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_request_buffering                 on;</span><br><span class=\"line\">                        proxy_http_version                      1.1;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_cookie_domain                     off;</span><br><span class=\"line\">                        proxy_cookie_path                       off;</span><br><span class=\"line\"></span><br><span class=\"line\">                        # In case of errors try the next upstream server before returning an error</span><br><span class=\"line\">                        proxy_next_upstream                     error timeout;</span><br><span class=\"line\">                        proxy_next_upstream_timeout             0;</span><br><span class=\"line\">                        proxy_next_upstream_tries               3;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_pass http:&#x2F;&#x2F;upstream_balancer;</span><br><span class=\"line\"></span><br><span class=\"line\">                        proxy_redirect                          off;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ## end server www3.weiyigeek.top</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"示例3-Ingress-Rewrite-重写重定向访问\"><a href=\"#示例3-Ingress-Rewrite-重写重定向访问\" class=\"headerlink\" title=\"示例3.Ingress Rewrite 重写重定向访问\"></a>示例3.Ingress Rewrite 重写重定向访问</h4><p>描述: 以下是Ingress-Nginx 重写<code>annotations</code>的相关属性</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">名称 \t描述 \t值类型</span><br><span class=\"line\">nginx.ingress.kubernetes.io/use-regex       <span class=\"comment\"># 指示Ingress上定义的路径是否使用正则表达式 \tbool</span></span><br><span class=\"line\">nginx.ingress.kubernetes.io/rewrite-target  <span class=\"comment\"># 必须重定向流量的目标URI \tstring</span></span><br><span class=\"line\">nginx.ingress.kubernetes.io/app-root        <span class=\"comment\"># 定义Controller必须重定向的应用程序根，如果它在‘/’上下文中 \tstring</span></span><br><span class=\"line\">nginx.ingress.kubernetes.io/ssl-redirect    <span class=\"comment\"># 指示位置部分是否仅可访问SSL（当Ingress包含证书默认为True) bool</span></span><br><span class=\"line\">nginx.ingress.kubernetes.io/force-ssl-redirect <span class=\"comment\"># 即使lngress未启用TLS，也强制重定向到HTTPS \tbool</span></span><br><span class=\"line\"></span><br><span class=\"line\">annotations:</span><br><span class=\"line\">  <span class=\"comment\"># 指定 Ingress Controller 的类型</span></span><br><span class=\"line\">  kubernetes.io/ingress.class: <span class=\"string\">\"nginx\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 指定我们的 rules 的 path 可以使用正则表达式</span></span><br><span class=\"line\">  nginx.ingress.kubernetes.io/use-regex: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 连接超时时间，默认为 5s</span></span><br><span class=\"line\">  nginx.ingress.kubernetes.io/proxy-connect-timeout: <span class=\"string\">\"600\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 后端服务器回转数据超时时间，默认为 60s</span></span><br><span class=\"line\">  nginx.ingress.kubernetes.io/proxy-send-timeout: <span class=\"string\">\"600\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 后端服务器响应超时时间，默认为 60s</span></span><br><span class=\"line\">  nginx.ingress.kubernetes.io/proxy-read-timeout: <span class=\"string\">\"600\"</span></span><br><span class=\"line\">  <span class=\"comment\"># 客户端上传文件，最大大小，默认为 20m</span></span><br><span class=\"line\">  nginx.ingress.kubernetes.io/proxy-body-size: <span class=\"string\">\"10m\"</span></span><br><span class=\"line\">  <span class=\"comment\"># URL 重写</span></span><br></pre></td></tr></table></figure>\n<p>Ingress Rewrite 资源清单示例:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; ingress-nginx-http-rewrite-https-v3.yaml&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress </span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-nginx-http-rewrite-https</span><br><span class=\"line\">  annotations:  <span class=\"comment\"># 注释</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/rewrite-target: https://www3.weiyigeek.top:30499</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    - host: go.weiyigeek.top</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">        - pathType: Prefix</span><br><span class=\"line\">          path: / </span><br><span class=\"line\">          backend:</span><br><span class=\"line\">            service:</span><br><span class=\"line\">              name: ingress-nginx-https-svc   <span class=\"comment\">#【重点】 关联Service控制器所以与Service定义的源数据名称一致</span></span><br><span class=\"line\">              port:</span><br><span class=\"line\">                number: 80</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>操作流程:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 创建 Ingress 对象</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl create -f ingress-nginx-http-rewrite-https-v3.yaml</span><br><span class=\"line\"><span class=\"comment\"># ingress.networking.k8s.io/ingress-nginx-http-rewrite-https created</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl get ingress</span><br><span class=\"line\">  <span class=\"comment\"># NAME                               CLASS    HOSTS                ADDRESS         PORTS     AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-http-rewrite-https   &lt;none&gt;   go.weiyigeek.top     10.10.107.214   80        7s</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-https                &lt;none&gt;   www3.weiyigeek.top   10.10.107.214   80, 443   31m</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx-ingress-http                 &lt;none&gt;   web.weiyigeek.top    10.10.107.214   80        9h</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl get svc -n ingress-nginx</span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller  NodePort  10.96.183.29  80:32268/TCP,443:30499/TCP </span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 访问验证(注意将域名指向节点地址) </span></span><br><span class=\"line\">~/K8s/Day7/demo2$ curl -I http://go.weiyigeek.top:32268 <span class=\"comment\"># 强制转换到https</span></span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 302 Moved Temporarily</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Sat, 14 Nov 2020 15:14:00 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 138</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># Location: https://www3.weiyigeek.top:30499/</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>补充说明:</strong> Ingress-nginx 的前后端分离<code>(Rewrite)</code>演示</p>\n<ul>\n<li>资源清单</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">ingress-rewrite.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-rewrite</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class=\"string\">/$2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">rewrite.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">        - path:</span> <span class=\"string\">/weiyigeek(/|$)(.*)</span></span><br><span class=\"line\"><span class=\"attr\">          pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">            service:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">backend-svc</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span></span><br><span class=\"line\"><span class=\"attr\">                number:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>部署验证</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl create -f ingress-rewrite.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl describe ing -n demo ingress-rewrite</span><br><span class=\"line\"><span class=\"comment\"># Rules:</span></span><br><span class=\"line\"><span class=\"comment\">#   Host                   Path  Backends</span></span><br><span class=\"line\"><span class=\"comment\">#   ----                   ----  --------</span></span><br><span class=\"line\"><span class=\"comment\">#   rewrite.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\">#                          /weiyigeek(/|$)(.*)   backend-svc:8080 (192.168.109.90:8080,192.168.109.93:8080)</span></span><br><span class=\"line\"><span class=\"comment\"># Annotations:             nginx.ingress.kubernetes.io/rewrite-target: /$2</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ curl http://10.10.107.221 -H <span class=\"string\">'host: rewrite.weiyigeek.top'</span> -k</span><br><span class=\"line\">  <span class=\"comment\"># &lt;html&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;body&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;/body&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;/html&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ curl -v http://10.10.107.221/weiyigeek/ -H <span class=\"string\">'host: rewrite.weiyigeek.top'</span> -k  <span class=\"comment\"># 匹配指定路径进行访问</span></span><br><span class=\"line\">hostname-web-backend-1-WeiyiGeek-Tomcat</span><br><span class=\"line\"></span><br><span class=\"line\">$ curl  http://10.10.107.221/weiyigeek/<span class=\"built_in\">test</span> -H <span class=\"string\">'host: rewrite.weiyigeek.top'</span> -k <span class=\"comment\"># 后端应用存在test目录以及文件方可，否则显示应用程序自动的错误。</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h4 id=\"示例4-Ingress-VirtualHost-虚拟主机访问\"><a href=\"#示例4-Ingress-VirtualHost-虚拟主机访问\" class=\"headerlink\" title=\"示例4.Ingress VirtualHost 虚拟主机访问\"></a>示例4.Ingress VirtualHost 虚拟主机访问</h4><p>描述: 我们知道Ingress-Nginx是基于Nginx的所以其也支持虚拟主机进行绑定访问，实现以不同的域名访问同一个web界面;</p>\n<p><strong>Ingress 资源清单示例:</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) 采用 networking.k8s.io/v1 APIVERSION</span></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ingress-nginx-virtual-host.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-nginx-virtual-host</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  defaultBackend:</span></span><br><span class=\"line\"><span class=\"attr\">    service:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">nginx-ingress-v1-svc</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span></span><br><span class=\"line\"><span class=\"attr\">        number:</span> <span class=\"number\">80</span> </span><br><span class=\"line\"><span class=\"attr\">  rules:</span> </span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">host.weiyigeek.top</span> <span class=\"comment\"># 以同一主机根据路径访问不同的Pod</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">        - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">          pathType:</span> <span class=\"string\">Prefix</span> <span class=\"comment\"># 【坑呀】supported values: \"Exact\", \"ImplementationSpecific\", \"Prefix\"</span></span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">            service:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">nginx-ingress-v1-svc</span>   <span class=\"comment\">#【重点】 关联Service控制器所以与Service定义的源数据名称一致</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span></span><br><span class=\"line\"><span class=\"attr\">                number:</span> <span class=\"number\">80</span>   </span><br><span class=\"line\"><span class=\"attr\">        - path:</span> <span class=\"string\">/v3</span></span><br><span class=\"line\"><span class=\"attr\">          pathType:</span> <span class=\"string\">Prefix</span> <span class=\"comment\"># 【坑呀】supported values: \"Exact\", \"ImplementationSpecific\", \"Prefix\"</span></span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">            service:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">ingress-nginx-https-svc</span>   <span class=\"comment\">#【重点】 关联Service控制器所以与Service定义的源数据名称一致</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span></span><br><span class=\"line\"><span class=\"attr\">                number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">ingress.test2.com</span>   <span class=\"comment\">#只需要在rules字段下添加另一个host字段即可，这里只实现httpd的，如果有需求可以添加上tomcat的。</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">        - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">            serviceName:</span> <span class=\"string\">httpd-svc</span>   <span class=\"comment\">#注意，serviceName所有虚拟主机必须保持一致</span></span><br><span class=\"line\"><span class=\"attr\">            servicePort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2) 采用 extensions/v1beta1 APIVERSION (旧版本-将会被弃用)</span></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ingress-nginx-virtual-host.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">path-ingress</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - host:</span> <span class=\"string\">host.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">    http:</span></span><br><span class=\"line\"><span class=\"attr\">      paths:</span></span><br><span class=\"line\"><span class=\"attr\">      - path:</span> <span class=\"string\">/v1</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          serviceName:</span> <span class=\"string\">nginx-ingress-v1-svc</span></span><br><span class=\"line\"><span class=\"attr\">          servicePort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      - path:</span> <span class=\"string\">/v2</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          serviceName:</span> <span class=\"string\">ingress-nginx-https-svc</span></span><br><span class=\"line\"><span class=\"attr\">          servicePort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">  - host:</span> <span class=\"string\">ingress.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">    http:</span></span><br><span class=\"line\"><span class=\"attr\">      paths:</span></span><br><span class=\"line\"><span class=\"attr\">      - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          serviceName:</span> <span class=\"string\">httpd-svc</span></span><br><span class=\"line\"><span class=\"attr\">          servicePort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p><strong>操作流程：</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 资源清单编写一览表</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl explain --api-version=networking.k8s.io/v1 ingress.spec.rules.http.paths</span><br><span class=\"line\"> kubectl explain --api-version=networking.k8s.io/v1beta1 ingress.spec.rules.http.paths</span><br><span class=\"line\">  <span class=\"comment\"># KIND:     Ingress</span></span><br><span class=\"line\">  <span class=\"comment\"># VERSION:  networking.k8s.io/v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 创建Ingresss对象 </span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl create -f ingress-nginx-virtual-host.yaml</span><br><span class=\"line\">  <span class=\"comment\"># ingress.networking.k8s.io/ingress-nginx-virtual-host created</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看 ingress</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ kubectl get ingress | grep <span class=\"string\">\"virtual\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-virtual-host   &lt;none&gt;   host.weiyigeek.top, ingress.weiyigeek.top   10.10.107.214   80   102s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 设置/etc/hosts与该域名绑定</span></span><br><span class=\"line\">10.10.107.214 host.weiyigeek.top </span><br><span class=\"line\">10.10.107.214 ingress.weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 查看 ingress-nginx-virtual-host Pod 信息</span></span><br><span class=\"line\">$ kubectl describe ingress-nginx-virtual-host</span><br></pre></td></tr></table></figure>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><br></h2><h4 id=\"示例5-Ingress-BasicAuth（基础认证）功能\"><a href=\"#示例5-Ingress-BasicAuth（基础认证）功能\" class=\"headerlink\" title=\"示例5.Ingress BasicAuth（基础认证）功能\"></a>示例5.Ingress BasicAuth（基础认证）功能</h4><p>描述:因为Ingress的实现方案采用的是Nginx的软件，所以Nginx的相关特性Ingress都支持, 下面我们利用 Nginx 的 BasicAuth 实现基础认证演示</p>\n<p>Ingress 资源清单:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&gt; ingress-nginx-auth.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-nginx-auth</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/auth-type:</span> <span class=\"string\">basic</span> </span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/auth-secret:</span> <span class=\"string\">basic-auth</span> </span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/auth-realm:</span> <span class=\"string\">'Authentication Required - WeiyiGeek'</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span> </span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">auth.weiyigeek.top</span>   <span class=\"comment\"># 后端应用通过该域名进行访问以同一主机根据路径访问不同的Pod</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">        - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">          pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">            service:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">nginx-ingress-v1-svc</span>   <span class=\"comment\">#【重点】 关联Service控制器所以与Service定义的源数据名称一致</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span></span><br><span class=\"line\"><span class=\"attr\">                number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">  defaultBackend:</span></span><br><span class=\"line\"><span class=\"attr\">    service:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">nginx-ingress-v1-svc</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span></span><br><span class=\"line\"><span class=\"attr\">        number:</span> <span class=\"number\">80</span>   </span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p>操作流程:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 先安装Apache的模块 : Nginx的认证方案所需</span></span><br><span class=\"line\">$ apt search htpasswd</span><br><span class=\"line\">  <span class=\"comment\"># Sorting... Done</span></span><br><span class=\"line\">  <span class=\"comment\"># Full Text Search... Done</span></span><br><span class=\"line\">  <span class=\"comment\"># apache2-utils/focal-security,focal-updates 2.4.41-4ubuntu3.1 amd64</span></span><br><span class=\"line\">  <span class=\"comment\">#   Apache HTTP Server (utility programs for web servers)</span></span><br><span class=\"line\">  <span class=\"comment\"># ... 下面还有其他的包这里旧不看了</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo apt install apache2-utils</span><br><span class=\"line\">$ htpasswd -c auth weiyigeek  <span class=\"comment\">#创建密钥文件文件名为auth，用户名为weiyigeek</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 把该文件以secret方式进行保存，类型为generic</span></span><br><span class=\"line\"><span class=\"comment\"># -rw-r--r-- 1 weiyigeek weiyigeek   48 Nov 15 12:48 auth</span></span><br><span class=\"line\">$ kubectl create secret generic basic-auth --from-file=auth</span><br><span class=\"line\">  <span class=\"comment\"># secret/basic-auth created</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 部署上面Ingress资源清单</span></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day7/demo2$ kubectl create -f ingress-nginx-auth.yaml</span><br><span class=\"line\">  <span class=\"comment\"># ingress.networking.k8s.io/ingress-nginx-auth configured</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 查看</span></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day7/demo2$ kubectl get ingress</span><br><span class=\"line\">  <span class=\"comment\"># NAME                               CLASS    HOSTS                ADDRESS         PORTS     AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-auth                 &lt;none&gt;   auth.weiyigeek.top   10.10.107.214   80        2m26s</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-http-rewrite-https   &lt;none&gt;   go.weiyigeek.top     10.10.107.214   80        13h</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-https                &lt;none&gt;   www3.weiyigeek.top   10.10.107.214   80, 443   14h</span></span><br><span class=\"line\">  <span class=\"comment\"># nginx-ingress-http                 &lt;none&gt;   web.weiyigeek.top    10.10.107.214   80        23h</span></span><br><span class=\"line\">  <span class=\"comment\"># path-ingress                       &lt;none&gt;   host.weiyigeek.top   10.10.107.214   80        26m</span></span><br><span class=\"line\"></span><br><span class=\"line\">weiyigeek@ubuntu:~/K8s/Day7/demo2$ kubectl describe ingress ingress-nginx-auth</span><br><span class=\"line\">  <span class=\"comment\"># Name:             ingress-nginx-auth</span></span><br><span class=\"line\">  <span class=\"comment\"># Namespace:        default</span></span><br><span class=\"line\">  <span class=\"comment\"># Address:          10.10.107.214</span></span><br><span class=\"line\">  <span class=\"comment\"># Default backend:  nginx-ingress-v1-svc:80   10.244.1.125:80,10.244.1.126:80)</span></span><br><span class=\"line\">  <span class=\"comment\"># Rules:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Host                Path  Backends</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----                ----  --------</span></span><br><span class=\"line\">  <span class=\"comment\">#   auth.weiyigeek.top</span></span><br><span class=\"line\">  <span class=\"comment\">#                       /   nginx-ingress-v1-svc:80   10.244.1.125:80,10.244.1.126:80)</span></span><br><span class=\"line\">  <span class=\"comment\"># Annotations:          nginx.ingress.kubernetes.io/auth-realm: Authentication Required - WeiyiGeek</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/auth-secret: basic-auth</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/auth-type: basic</span></span><br><span class=\"line\">  <span class=\"comment\"># Events:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Type    Reason  Age                  From                      Message</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----    ------  ----                 ----                      -------</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  Sync    22s (x3 over 2m36s)  nginx-ingress-controller  Scheduled for sync</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 访问验证</span></span><br><span class=\"line\">~/K8s/Day7/demo2$ curl -I http://auth.weiyigeek.top:32268</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 401 Unauthorized</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Sun, 15 Nov 2020 05:00:42 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 172</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># WWW-Authenticate: Basic realm=\"Authentication Required - WeiyiGeek\"</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201115130307.png\" alt=\"WeiyiGeek.WWW-Authenticate\" title=\"\" class=\"\">\n                <p>WeiyiGeek.WWW-Authenticate</p>\n            </figure>\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a><br></h2><h4 id=\"示例6-Ingress-Redirect-域名重定向功能\"><a href=\"#示例6-Ingress-Redirect-域名重定向功能\" class=\"headerlink\" title=\"示例6.Ingress Redirect 域名重定向功能\"></a>示例6.Ingress Redirect 域名重定向功能</h4><p>描述: 我们可以利用Ingress中的域名重定向<code>(Redirect)</code>注解来实现访问重定向。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 简单格式:</span></span><br><span class=\"line\">annotations:</span><br><span class=\"line\">  nginx.ingress.kubernetes.io/permanent-redirect: <span class=\"string\">'https://blog.weiyigeek.top'</span></span><br></pre></td></tr></table></figure>\n<p>Ingress 规则配置清单示例:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee Ingress-Redirect.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress </span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-redirect</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/permanent-redirect: <span class=\"string\">'https://blog.weiyigeek.top'</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules: </span><br><span class=\"line\">    - host: redirect.weiyigeek.top</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">        - path: /</span><br><span class=\"line\">          pathType: Prefix</span><br><span class=\"line\">          backend:</span><br><span class=\"line\">            service:</span><br><span class=\"line\">              name: front-svc</span><br><span class=\"line\">              port:</span><br><span class=\"line\">                number: 80</span><br><span class=\"line\">  defaultBackend:</span><br><span class=\"line\">    service:</span><br><span class=\"line\">      name: front-svc</span><br><span class=\"line\">      port:</span><br><span class=\"line\">        number: 80   </span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>部署资源清单以及查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建 Ingress 资源对象</span></span><br><span class=\"line\">kubectl create -f Ingress-Redirect.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看Ingress控制器下面创建的应用信息以及详细信息</span></span><br><span class=\"line\">kubectl get ing -n demo ingress-redirect &amp;&amp; kubectl describe ing -n demo ingress-redirect</span><br><span class=\"line\">  <span class=\"comment\"># NAME               CLASS    HOSTS                    ADDRESS   PORTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-redirect   &lt;none&gt;   redirect.weiyigeek.top             80      23s</span></span><br><span class=\"line\">  ....</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证重定向观察设置的虚拟主机的域名与未设置虚拟主机域名之间的不同</span></span><br><span class=\"line\">curl -v http://10.10.107.221 -H <span class=\"string\">'host: redirect.weiyigeek.top'</span> -k  <span class=\"comment\"># 重定向到我们指定的域名</span></span><br><span class=\"line\">curl -v http://10.10.107.221 -H <span class=\"string\">'host: r.weiyigeek.top'</span> -k         <span class=\"comment\"># 不存在的虚拟主机名称则访问默认 defaultBackend 服务。</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210716144446.png\" alt=\"WeiyiGeek.redirect\" title=\"\" class=\"\">\n                <p>WeiyiGeek.redirect</p>\n            </figure>\n<p><br></p>\n<h4 id=\"示例7-Ingress-黑白名单访问限制\"><a href=\"#示例7-Ingress-黑白名单访问限制\" class=\"headerlink\" title=\"示例7.Ingress 黑白名单访问限制\"></a>示例7.Ingress 黑白名单访问限制</h4><p>描述: 某些内部系统可能只允许某些IP地址访问时，可利用 Ingress-nginx 的黑白名单，其实现的方式有如下两个。</p>\n<ul>\n<li>Annotations(注解) ：只对指定的ingress生效<code>nginx.ingress.kubernetes.io/whitelist-source-range</code></li>\n<li>ConfigMap(配置文件) ：全局生效</li>\n</ul>\n<p>Tips: 建议黑名单可以使用ConfigMap去配置，白名单建议使用Annotations去配置。</p>\n<p><br/></p>\n<ul>\n<li>Step 1.添加白名单的方式可以直接写<code>annotation</code>也可以配置在ConfigMap中。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.annotation方式</span></span><br><span class=\"line\">tee ingress-whilte-annotation.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-whilte</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/service-weight: <span class=\"string\">'1'</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/whitelist-source-range: 10.20.172.103,10.10.107.220</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules: </span><br><span class=\"line\">    - host: whilte.weiyigeek.top</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">        - path: /</span><br><span class=\"line\">          pathType: ImplementationSpecific</span><br><span class=\"line\">          backend:</span><br><span class=\"line\">            service:</span><br><span class=\"line\">              name: front-svc</span><br><span class=\"line\">              port:</span><br><span class=\"line\">                number: 80</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.ConfigMap方式</span></span><br><span class=\"line\">tee ingress-whilte-ConfigMap.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-whilte</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">data:</span><br><span class=\"line\">  whitelist-source-range: 10.10.107.0/24</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建 Ingress 资源对象</span></span><br><span class=\"line\">$ kubectl create -f ingress-whilte-annotation.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get ingress -n demo ingress-whilte</span><br><span class=\"line\">  <span class=\"comment\"># NAME             CLASS    HOSTS                  ADDRESS   PORTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-whilte   &lt;none&gt;   whilte.weiyigeek.top             80      75s</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl describe ingress -n demo ingress-whilte</span><br><span class=\"line\">  <span class=\"comment\"># Rules:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Host                  Path  Backends</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----                  ----  --------</span></span><br><span class=\"line\">  <span class=\"comment\">#   whilte.weiyigeek.top</span></span><br><span class=\"line\">  <span class=\"comment\">#                         /   front-svc:80 (192.168.109.91:80,192.168.109.92:80)</span></span><br><span class=\"line\">  <span class=\"comment\"># Annotations:            nginx.ingress.kubernetes.io/service-weight: 1</span></span><br><span class=\"line\">  <span class=\"comment\">#                         nginx.ingress.kubernetes.io/whitelist-source-range: 10.20.172.103,10.10.107.220</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机: 10.10.107.220 (拥有访问权限时正常返回数据)</span></span><br><span class=\"line\">10.10.107.220 $ curl http://10.10.107.221/ -H <span class=\"string\">'host: whilte.weiyigeek.top'</span> -k -i</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 200 OK</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Fri, 16 Jul 2021 07:47:00 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 37</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># Last-Modified: Thu, 15 Jul 2021 12:24:55 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># ETag: \"60f02917-25\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Accept-Ranges: bytes</span></span><br><span class=\"line\"><span class=\"comment\"># hostname-web-front-0-WeiyiGeek-Nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主机: 10.10.107.221 (无访问权限则显示403)</span></span><br><span class=\"line\">10.10.107.221 $ curl http://10.10.107.221/ -H <span class=\"string\">'host: whilte.weiyigeek.top'</span> -k -i</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 403 Forbidden</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Fri, 16 Jul 2021 07:47:54 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 146</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\"><span class=\"comment\"># &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<ul>\n<li>Step 2.黑名单的方式也可以在annotations与ConfigMap中配置。<br>描述: 我们可以在注解中加入<code>nginx.ingress.kubernetes.io/server-snippet: |-</code>则可以加入自定义片段。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - Annotation</span></span><br><span class=\"line\">tee ingress-black-annotation.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-black</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/server-snippet: |-</span><br><span class=\"line\">      deny 10.10.107.220;</span><br><span class=\"line\">      deny 10.20.172.103;</span><br><span class=\"line\">      allow all;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules: </span><br><span class=\"line\">    - host: black.weiyigeek.top</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">        - path: /</span><br><span class=\"line\">          pathType: ImplementationSpecific</span><br><span class=\"line\">          backend:</span><br><span class=\"line\">            service:</span><br><span class=\"line\">              name: backend-svc</span><br><span class=\"line\">              port:</span><br><span class=\"line\">                number: 8080</span><br><span class=\"line\">status:</span><br><span class=\"line\">  loadBalancer: &#123;&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - ConfigMap</span></span><br><span class=\"line\">tee ingress-black-ConfigMap.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-black</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">data:</span><br><span class=\"line\">  whitelist-source-range: 10.20.172.0/24</span><br><span class=\"line\">  block-cidrs: 10.10.107.220</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 创建 Ingress 对象</span></span><br><span class=\"line\">kubectl apply -f ingress-black-annotation.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 查看与详细 Ingress 对象</span></span><br><span class=\"line\">kubectl get ing -n demo ingress-black &amp;&amp; kubectl describe ing -n demo ingress-black</span><br><span class=\"line\">  <span class=\"comment\"># NAME            CLASS    HOSTS                 ADDRESS   PORTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-black   &lt;none&gt;   black.weiyigeek.top             80      20s</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Rules:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Host                 Path  Backends</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----                 ----  --------</span></span><br><span class=\"line\">  <span class=\"comment\">#   black.weiyigeek.top  /     backend-svc:8080 (192.168.109.90:8080,192.168.109.93:8080)</span></span><br><span class=\"line\">  <span class=\"comment\"># Annotations:           nginx.ingress.kubernetes.io/server-snippet:</span></span><br><span class=\"line\">  <span class=\"comment\">#                          deny 10.10.107.220;</span></span><br><span class=\"line\">  <span class=\"comment\">#                          deny 10.20.172.103;</span></span><br><span class=\"line\">  <span class=\"comment\">#                          allow all;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证 Ingress 代理的后端应用</span></span><br><span class=\"line\"><span class=\"comment\"># (1) 10.10.107.220 (黑名单无法访问)</span></span><br><span class=\"line\">curl http://10.10.107.221/ -H <span class=\"string\">'host: black.weiyigeek.top'</span> -k -i</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 403 Forbidden</span></span><br><span class=\"line\">  <span class=\"comment\"># ......................</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 10.10.107.221 (未在黑名单之内则可以访问)  </span></span><br><span class=\"line\">curl http://10.10.107.221/ -H <span class=\"string\">'host: black.weiyigeek.top'</span> -k -i</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 200</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Fri, 16 Jul 2021 13:23:36 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 40</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># Accept-Ranges: bytes</span></span><br><span class=\"line\">  <span class=\"comment\"># ETag: W/\"40-1626351895000\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Last-Modified: Thu, 15 Jul 2021 12:24:55 GMT</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-front-0-WeiyiGeek-Nginx</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h4 id=\"示例8-Ingress-Header-请求头匹配\"><a href=\"#示例8-Ingress-Header-请求头匹配\" class=\"headerlink\" title=\"示例8.Ingress Header 请求头匹配\"></a>示例8.Ingress Header 请求头匹配</h4><p>描述: Ingress-nginx 的 匹配请求头，可以采用<code>nginx.ingress.kubernetes.io/server-snippet</code>注解。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 资源清单</span></span><br><span class=\"line\">tee ingress-header-request.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-header</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/server-snippet: |-</span><br><span class=\"line\">      <span class=\"built_in\">set</span> <span class=\"variable\">$agentflag</span> 0;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable\">$http_user_agent</span> ~* <span class=\"string\">\"(Firefox)\"</span> )&#123;</span><br><span class=\"line\">        <span class=\"built_in\">set</span> <span class=\"variable\">$agentflag</span> 1;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable\">$agentflag</span> = 1) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 301 https://www.weiyigeek.top;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules: </span><br><span class=\"line\">    - host: header.weiyigeek.top</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">        - path: /</span><br><span class=\"line\">          pathType: ImplementationSpecific</span><br><span class=\"line\">          backend:</span><br><span class=\"line\">            service:</span><br><span class=\"line\">              name: backend-svc</span><br><span class=\"line\">              port:</span><br><span class=\"line\">                number: 8080</span><br><span class=\"line\">status:</span><br><span class=\"line\">  loadBalancer: &#123;&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 创建查看 Ingress 资源对象</span></span><br><span class=\"line\">kubectl create -f ingress-header-request.yaml</span><br><span class=\"line\">kubectl get ing -n demo ingress-header &amp;&amp; kubectl describe ing -n demo ingress-header</span><br><span class=\"line\">  <span class=\"comment\"># Rules:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Host                  Path  Backends</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----                  ----  --------</span></span><br><span class=\"line\">  <span class=\"comment\">#   header.weiyigeek.top  /     backend-svc:8080 (192.168.109.90:8080,192.168.109.93:8080)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 验证 Ingress 资源对象</span></span><br><span class=\"line\"><span class=\"comment\"># (1) 指定 User-Agent 请求头 包含 Firefox</span></span><br><span class=\"line\">$ curl http://10.10.107.221/ -H <span class=\"string\">'host: header.weiyigeek.top'</span> -H <span class=\"string\">'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0'</span> -k -i</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 301 Moved Permanently</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Fri, 16 Jul 2021 14:00:04 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 162</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># Location: https://www.weiyigeek.top</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># &lt;html&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;body&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;/body&gt;</span></span><br><span class=\"line\">  <span class=\"comment\"># &lt;/html&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 指定 User-Agent 请求头 不包含 Firefox </span></span><br><span class=\"line\">$ curl http://10.10.107.221/ -H <span class=\"string\">'host: header.weiyigeek.top'</span> -H <span class=\"string\">'User-Agent: Mozilla/5.0'</span> -k -i</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 200</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Fri, 16 Jul 2021 14:03:29 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 40</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># Accept-Ranges: bytes</span></span><br><span class=\"line\">  <span class=\"comment\"># ETag: W/\"40-1626351892000\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Last-Modified: Thu, 15 Jul 2021 12:24:52 GMT</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-backend-0-WeiyiGeek-Tomcat</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h4 id=\"示例9-Ingress-灰度金丝雀发布\"><a href=\"#示例9-Ingress-灰度金丝雀发布\" class=\"headerlink\" title=\"示例9.Ingress 灰度金丝雀发布\"></a>示例9.Ingress 灰度金丝雀发布</h4><p>描述: 在某些情况下，您可能希望通过向与生产服务不同的服务发送少量请求来“金丝雀”一组新的更改。金丝雀注解使 Ingress 规范能够根据应用的规则充当路由请求的替代服务,在<code>nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code>设置后可以启用以下用于配置金丝雀的注释：。</p>\n<p>Nginx Annotations 支持以下 4 种 Canary 规则:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* nginx.ingress.kubernetes.io/canary-weight：基于服务权重的流量切分，适用于蓝绿部署，权重范围 0 - 100 按百分比将请求路由到 Canary Ingress 中指定的服务。权重为 0 意味着该金丝雀规则不会向 Canary 入口的服务发送任何请求。权重为 100 意味着所有请求都将被发送到 Canary 入口。</span><br><span class=\"line\">* nginx.ingress.kubernetes.io/canary-by-header：基于 Request Header 的流量切分，适用于灰度发布以及 A/B 测试。当 Request Header 设置为 always时，请求将会被一直发送到 Canary 版本；当 Request Header 设置为 never时，请求不会被发送到 Canary 入口；对于任何其他 Header 值，将忽略 Header，并通过优先级将请求与其他金丝雀规则进行优先级的比较。</span><br><span class=\"line\">* nginx.ingress.kubernetes.io/canary-by-header-value：要匹配的 Request Header 的值，用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务。当 Request Header 设置为此值时，它将被路由到 Canary 入口。该规则允许用户自定义 Request Header 的值，必须与上一个 annotation (即：canary-by-header）一起使用。</span><br><span class=\"line\">* nginx.ingress.kubernetes.io/canary-by-header-pattern：这与canary-by-header-valuePCRE 正则表达式匹配的工作方式相同。请注意，canary-by-header-value设置此注释时将被忽略。当给定的 Regex 在请求处理过程中导致错误时，该请求将被视为不匹配。</span><br><span class=\"line\">* nginx.ingress.kubernetes.io/canary-by-cookie：基于 Cookie 的流量切分，适用于灰度发布与 A/B 测试。用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务的cookie。当 cookie 值设置为 always时，它将被路由到 Canary 入口；当 cookie 值设置为 never时，请求不会被发送到 Canary 入口；对于任何其他值，将忽略 cookie 并将请求与其他金丝雀规则进行优先级的比较。 定义两个版本的代码。</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>Tips : 金丝雀规则是按优先顺序计算的。优先级如下：<code>canary by header-&gt;canary by cookie-&gt;canary weight</code></p>\n<p>Tips : 注意当您将入口标记为 Canary 时，除<code>nginx.ingress.kubernetes.io/load-balanceand</code>之外的所有其他非 Canary 注释都将被忽略（从相应的主入口继承）<code>nginx.ingress.kubernetes.io/upstream-hash-by</code>。`</p>\n<p><br></p>\n<p><strong>资源配置清单:</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 默认访问前端</span></span><br><span class=\"line\">tee ingress-canary-v1.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-canary-v1</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary-by-header: canary</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary-by-header-value: v1</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary-weight: <span class=\"string\">\"50\"</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules: </span><br><span class=\"line\">    - host: canary.weiyigeek.top</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">        - path: /</span><br><span class=\"line\">          pathType: ImplementationSpecific</span><br><span class=\"line\">          backend:</span><br><span class=\"line\">            service:</span><br><span class=\"line\">              name: front-svc</span><br><span class=\"line\">              port:</span><br><span class=\"line\">                number: 80</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 利用金丝雀访问后端</span></span><br><span class=\"line\">tee ingress-canary-v2.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-canary-v2</span><br><span class=\"line\">  namespace: demo</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary-by-header: canary</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary-by-header-value: v2</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/canary-weight: <span class=\"string\">\"50\"</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules: </span><br><span class=\"line\">    - host: canary.weiyigeek.top</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">        - path: /</span><br><span class=\"line\">          pathType: ImplementationSpecific</span><br><span class=\"line\">          backend:</span><br><span class=\"line\">            service:</span><br><span class=\"line\">              name: backend-svc</span><br><span class=\"line\">              port:</span><br><span class=\"line\">                number: 8080</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">~/k8s/ingress/demo1<span class=\"comment\"># kubectl create -f ingress-canary-v1.yaml</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress.networking.k8s.io/ingress-canary-v1 created</span></span><br><span class=\"line\">~/k8s/ingress/demo1<span class=\"comment\"># kubectl create -f ingress-canary-v2.yaml</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress.networking.k8s.io/ingress-canary-v2 created</span></span><br><span class=\"line\"></span><br><span class=\"line\">~/k8s/ingress/demo1<span class=\"comment\"># kubectl get ing -n demo ingress-canary-v1 ingress-canary-v2</span></span><br><span class=\"line\">  <span class=\"comment\"># NAME                CLASS    HOSTS                  ADDRESS   PORTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-canary-v1   &lt;none&gt;   canary.weiyigeek.top             80      3m12s</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-canary-v2   &lt;none&gt;   canary.weiyigeek.top             80      3m4s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证金丝雀 Ingress 对象应用</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> &#123;1..3&#125;;<span class=\"keyword\">do</span> curl http://10.10.107.221/ -H <span class=\"string\">'host: canary.weiyigeek.top'</span> -i;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> &#123;1..3&#125;;<span class=\"keyword\">do</span> curl http://10.10.107.221/ -H <span class=\"string\">'host: canary.weiyigeek.top'</span> -H <span class=\"string\">'weiyigeek: v2'</span> -i;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h4 id=\"示例10-Ingress-相关配置补充\"><a href=\"#示例10-Ingress-相关配置补充\" class=\"headerlink\" title=\"示例10.Ingress 相关配置补充\"></a>示例10.Ingress 相关配置补充</h4><ul>\n<li><strong>(1) 自定义错误页面</strong><br>参考地址: <a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/customization/custom-errors/custom-default-backend.yaml\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/customization/custom-errors/custom-default-backend.yaml</a></li>\n</ul>\n<p><br/></p>\n<p>描述: 可以修改 deploy.yaml 中指定 nginx-ingress-controller 运行的参数，在此处添加<code>- --default-backend-service=名称空间/SVC名称</code>参数</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ grep -A 3 -n <span class=\"string\">\"/nginx-ingress\"</span> deploy.yaml</span><br><span class=\"line\">332:            - /nginx-ingress-controller</span><br><span class=\"line\">333-            - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class=\"line\">334-            - --election-id=ingress-controller-leader</span><br><span class=\"line\">335-            - --ingress-class=nginx</span><br><span class=\"line\">                - --default-backend-service=demo/error-svc</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<ul>\n<li><strong>(2) 连接和传输速率限制</strong><br>描述: 下述注释定义了对连接和传输速率的限制，这些可以用来减轻DDoS攻击。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">*</span> <span class=\"string\">nginx.ingress.kubernetes.io/limit-connections：单个IP地址允许的并发连接数。超出此限制时，将返回503错误。</span></span><br><span class=\"line\"><span class=\"string\">*</span> <span class=\"string\">nginx.ingress.kubernetes.io/limit-rps：每秒从给定IP接受的请求数。突发限制设置为此限制乘以突发乘数，默认乘数为5。当客户端超过此限制时，将</span> <span class=\"string\">返回limit-req-status-code默认值：</span> <span class=\"number\">503</span><span class=\"string\">。</span></span><br><span class=\"line\"><span class=\"string\">*</span> <span class=\"string\">nginx.ingress.kubernetes.io/limit-rpm：每分钟从给定IP接受的请求数。突发限制设置为此限制乘以突发乘数，默认乘数为5。当客户端超过此限制时，将</span> <span class=\"string\">返回limit-req-status-code默认值：</span> <span class=\"number\">503</span><span class=\"string\">。</span></span><br><span class=\"line\"><span class=\"string\">*</span> <span class=\"string\">nginx.ingress.kubernetes.io/limit-burst-multiplier：突发大小限制速率的倍数。默认的脉冲串乘数为5，此注释将覆盖默认的乘数。当客户端超过此限制时，将</span> <span class=\"string\">返回limit-req-status-code默认值：</span> <span class=\"number\">503</span><span class=\"string\">。</span></span><br><span class=\"line\"><span class=\"string\">*</span> <span class=\"string\">nginx.ingress.kubernetes.io/limit-rate-after：最初的千字节数，在此之后，对给定连接的响应的进一步传输将受到速率的限制。必须在启用代理缓冲的情况下使用此功能。</span></span><br><span class=\"line\"><span class=\"string\">*</span> <span class=\"string\">nginx.ingress.kubernetes.io/limit-rate：每秒允许发送到给定连接的千字节数。零值禁用速率限制。必须在启用代理缓冲的情况下使用此功能。</span></span><br><span class=\"line\"><span class=\"string\">*</span> <span class=\"string\">nginx.ingress.kubernetes.io/limit-whitelist：客户端IP源范围要从速率限制中排除。该值是逗号分隔的CIDR列表。</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p><strong>示例说明:</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 资源清单配置:</span></span><br><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">ingress-limit.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-limit</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/limit-rate:</span> <span class=\"string\">\"100K\"</span>               <span class=\"comment\"># 限制客户端每秒传输的字节数</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/limit-whitelist:</span> <span class=\"string\">\"10.10.107.220\"</span> <span class=\"comment\"># 白名单中的IP不限速</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/limit-rps:</span> <span class=\"number\">1</span>                     <span class=\"comment\"># 单个IP每秒的连接数</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/limit-rpm:</span> <span class=\"number\">30</span>                    <span class=\"comment\"># 单个IP每分钟的连接数</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span> </span><br><span class=\"line\"><span class=\"attr\">    - host:</span> <span class=\"string\">limit.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">      http:</span></span><br><span class=\"line\"><span class=\"attr\">        paths:</span></span><br><span class=\"line\"><span class=\"attr\">        - path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">          pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\"><span class=\"attr\">          backend:</span></span><br><span class=\"line\"><span class=\"attr\">            service:</span></span><br><span class=\"line\"><span class=\"attr\">              name:</span> <span class=\"string\">backend-svc</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span></span><br><span class=\"line\"><span class=\"attr\">                number:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"attr\">status:</span></span><br><span class=\"line\"><span class=\"attr\">  loadBalancer:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<ul>\n<li><strong>(3) ConfigMap在Ingress Controller中实战</strong><br>描述: 前面我们说到我们除了可以采用annotations方式配置ingress规则外也可以通过ConfigMap来存储相应的Ingress规则;</li>\n</ul>\n<p>Tips : 通过<a href=\"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/\" target=\"_blank\" rel=\"noopener\"> Ingress ConfigMaps </a> 查看详细的配置参数。</p>\n<p>Ingress 规则存储配置清单：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --configmap=</span></span><br><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">nginx-config.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-nginx-controller</span>  <span class=\"comment\"># 注意此ConfigMap名称与/nginx-ingress-controller 中 `--configmap=$(POD_NAMESPACE)/ingress-nginx-controller` 对应</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"attr\">  proxy-connect-timeout:</span> <span class=\"string\">\"15\"</span>   <span class=\"comment\">#这里有个坑，到家一定要注意是'-'不是'_'</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --tcp-services-configmap=</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">tcp-services</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/part-of:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --udp-services-configmap</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">udp-services</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/part-of:</span> <span class=\"string\">ingress-nginx</span></span><br></pre></td></tr></table></figure>\n<p>nginx-ingress-controller 使用 Configmap 作为配置存在控制器:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 可以在 nginx-ingress-controller 部署资源清单中看见`--configmap=`参数</span></span><br><span class=\"line\">vim +328 deploy.yaml</span><br><span class=\"line\"> containers:</span><br><span class=\"line\">        - name: controller</span><br><span class=\"line\">          image: pollyduan/ingress-nginx-controller:v0.47.0</span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          lifecycle:</span><br><span class=\"line\">            preStop:</span><br><span class=\"line\">              <span class=\"built_in\">exec</span>:</span><br><span class=\"line\">                <span class=\"built_in\">command</span>:</span><br><span class=\"line\">                  - /<span class=\"built_in\">wait</span>-shutdown</span><br><span class=\"line\">          args:</span><br><span class=\"line\">            - /nginx-ingress-controller</span><br><span class=\"line\">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller</span><br><span class=\"line\">            - --election-id=ingress-controller-leader</span><br><span class=\"line\">            - --ingress-class=nginx</span><br><span class=\"line\">            - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller   <span class=\"comment\"># 使用 confimap 配置文件</span></span><br><span class=\"line\">            - --validating-webhook=:8443</span><br><span class=\"line\">            - --validating-webhook-certificate=/usr/<span class=\"built_in\">local</span>/certificates/cert</span><br><span class=\"line\">            - --validating-webhook-key=/usr/<span class=\"built_in\">local</span>/certificates/key</span><br></pre></td></tr></table></figure>\n<p>查看ingress-nginx名称空间中的ConfigMap配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f nginx-config.yaml</span><br><span class=\"line\">  <span class=\"comment\"># configmap/ingress-nginx-controller configured</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get cm -n ingress-nginx</span><br><span class=\"line\">  <span class=\"comment\"># NAME                              DATA   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-controller-leader-nginx   0      2d8h</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller          0      2d8h</span></span><br><span class=\"line\">  <span class=\"comment\"># kube-root-ca.crt                  1      2d8h</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl describe cm -n ingress-nginx ingress-nginx-controller</span><br><span class=\"line\">  <span class=\"comment\"># Name:         ingress-nginx-controller</span></span><br><span class=\"line\">  <span class=\"comment\"># Namespace:    ingress-nginx</span></span><br><span class=\"line\">  <span class=\"comment\"># Labels:       app.kubernetes.io/component=controller</span></span><br><span class=\"line\">  <span class=\"comment\">#               app.kubernetes.io/instance=ingress-nginx</span></span><br><span class=\"line\">  <span class=\"comment\">#               app.kubernetes.io/managed-by=Helm</span></span><br><span class=\"line\">  <span class=\"comment\">#               app.kubernetes.io/name=ingress-nginx</span></span><br><span class=\"line\">  <span class=\"comment\">#               app.kubernetes.io/version=0.47.0</span></span><br><span class=\"line\">  <span class=\"comment\">#               helm.sh/chart=ingress-nginx-3.33.0</span></span><br><span class=\"line\">  <span class=\"comment\"># Annotations:  &lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Data</span></span><br><span class=\"line\">  <span class=\"comment\"># ====</span></span><br><span class=\"line\">  <span class=\"comment\"># proxy-connect-timeout:</span></span><br><span class=\"line\">  <span class=\"comment\"># ----</span></span><br><span class=\"line\">  <span class=\"comment\"># 15</span></span><br><span class=\"line\">  <span class=\"comment\"># Events:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Type    Reason  Age   From                      Message</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----    ------  ----  ----                      -------</span></span><br><span class=\"line\">  <span class=\"comment\">#   Normal  UPDATE  25s   nginx-ingress-controller  ConfigMap ingress-nginx/ingress-nginx-controller</span></span><br></pre></td></tr></table></figure>\n<p>验证是否在ingress-nginx-controller中配置生效:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                        READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller-5df4f79b95-6p8rr   1/1     Running   0          2d8h</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在 ingress-nginx-controller-5df4f79b95-6p8r 的 Pod 中 查看 nginx.conf 文件中 proxy_connect_timeout 参数是否为 15s</span></span><br><span class=\"line\">root@k8s-master-1:~/k8s/ingress/deployment<span class=\"comment\"># kubectl -n ingress-nginx exec -it ingress-nginx-controller-5df4f79b95-6p8rr bash</span></span><br><span class=\"line\">bash-5.1$ grep <span class=\"string\">\"proxy_connect_timeout\"</span> nginx.conf</span><br><span class=\"line\">          proxy_connect_timeout                   15s;   <span class=\"comment\">#</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h3 id=\"企业实战\"><a href=\"#企业实战\" class=\"headerlink\" title=\"企业实战\"></a>企业实战</h3><h4 id=\"1-利用Ingress访问后端的Nginx-Web和Tomcat后端综合实践。\"><a href=\"#1-利用Ingress访问后端的Nginx-Web和Tomcat后端综合实践。\" class=\"headerlink\" title=\"1.利用Ingress访问后端的Nginx Web和Tomcat后端综合实践。\"></a>1.利用Ingress访问后端的Nginx Web和Tomcat后端综合实践。</h4><p><strong>实验目标:</strong></p>\n<ul>\n<li>1) 在腾讯云创建<code>test.weiyigeek.top</code>以及<code>demo.weiyigeek.top</code>证书以供Ingress使用。</li>\n<li>2) 分别在kubernetes集群中创建<code>Nginx Web</code>与<code>Tomcat 后端</code>应用。</li>\n<li>3) 分别使用Ingress控制器创建以SSL访问<code>/</code>为NginxWeb而<code>/tomcat</code>Tomcat 后端需要BasicAuth（基础认证）访问功能</li>\n</ul>\n<p><br></p>\n<p><strong>详细流程:</strong></p>\n<ul>\n<li>Step 1.在腾讯云中申请免费的SSL证书(TrustAsia TLS)有效期一年,验证时需要设置域名的TXT解析, 申请地址:<a href=\"https://console.cloud.tencent.com/ssl。\" target=\"_blank\" rel=\"noopener\">https://console.cloud.tencent.com/ssl。</a></li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210716151525.png\" alt=\"WeiyiGeek.SSL证书申请\" title=\"\" class=\"\">\n                <p>WeiyiGeek.SSL证书申请</p>\n            </figure>\n<p><br/></p>\n<ul>\n<li>Step 2.分别在kubernetes集群中创建<code>Nginx Web</code>与<code>Tomcat 后端</code>应用以及创建名称空间。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">sts-svc-nginx-tomcat.yaml&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Service 服务创建(服务是软件服务的命名抽象)。</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl api-resources | grep \"service\"</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">front-svc</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/part-of:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">nginx-web</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">80</span> </span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">80</span> </span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span> </span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">backend-svc</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"string\">app.kubernetes.io/part-of:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">tomcat-web</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">8080</span> </span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">  sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">web-front</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">front-svc</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">nginx-web</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">nginx-web</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      initContainers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">init-html</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">busybox:latest</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span> <span class=\"string\">['sh',</span> <span class=\"string\">'-c'</span><span class=\"string\">,</span> <span class=\"string\">\"echo hostname-$&#123;HOSTNAME&#125;-$&#123;MSG&#125; &gt; /usr/share/nginx/html/index.html\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MSG</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"WeiyiGeek-Nginx\"</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/share/nginx/html\"</span></span><br><span class=\"line\"><span class=\"attr\">        securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">          privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx</span>   </span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">nginx:latest</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"Asia/Shanghai\"</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/share/nginx/html\"</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">web</span> </span><br><span class=\"line\"><span class=\"attr\">        emptyDir:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">web-backend</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">backend-svc</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">tomcat-web</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">tomcat-web</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      initContainers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">init-html</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">busybox:latest</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span> <span class=\"string\">['sh',</span> <span class=\"string\">'-c'</span><span class=\"string\">,</span> <span class=\"string\">\"echo hostname-$&#123;HOSTNAME&#125;-$&#123;MSG&#125; &gt; /usr/local/tomcat/webapps/ROOT/index.html\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MSG</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">WeiyiGeek-Tomcat</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/local/tomcat/webapps/ROOT/\"</span></span><br><span class=\"line\"><span class=\"attr\">        securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">          privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">nginx</span>   </span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"string\">\"tomcat:8.5.69-jdk8-openjdk-slim-buster\"</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\"><span class=\"attr\">          value:</span> <span class=\"string\">\"Asia/Shanghai\"</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">          containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">\"/usr/local/tomcat/webapps/ROOT/\"</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">web</span> </span><br><span class=\"line\"><span class=\"attr\">        emptyDir:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 利用资源清单进行创建nginx、Tomcat应用</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"bullet\">-f</span> <span class=\"string\">sts-svc-nginx-tomcat.yaml</span></span><br><span class=\"line\">  <span class=\"comment\"># namespace/demo created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/front-svc created</span></span><br><span class=\"line\">  <span class=\"comment\"># service/backend-svc created</span></span><br><span class=\"line\">  <span class=\"comment\"># statefulset.apps/web-front created</span></span><br><span class=\"line\">  <span class=\"comment\"># statefulset.apps/web-backend created</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<ul>\n<li>Step 3.验证SVC服务负载均衡和请求查看创建的应用</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看 Service 控制器对象</span></span><br><span class=\"line\">$ kubectl get svc -n demo -o wide</span><br><span class=\"line\">  <span class=\"comment\"># NAME          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE   SELECTOR</span></span><br><span class=\"line\">  <span class=\"comment\"># backend-svc   ClusterIP   None         &lt;none&gt;        8080/TCP   12m   name=tomcat-web</span></span><br><span class=\"line\">  <span class=\"comment\"># front-svc     ClusterIP   None         &lt;none&gt;        80/TCP     12m   name=nginx-web</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 StatefulSet 控制器对象</span></span><br><span class=\"line\">$ kubectl get sts -n demo -o wide</span><br><span class=\"line\">  <span class=\"comment\"># NAME          READY   AGE   CONTAINERS   IMAGES</span></span><br><span class=\"line\">  <span class=\"comment\"># web-backend   2/2     13m   nginx        tomcat:8.5.69-jdk8-openjdk-slim-buster</span></span><br><span class=\"line\">  <span class=\"comment\"># web-front     2/2     13m   nginx        nginx:latest</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 nginx 与 tomcat 相关 Pod 信息</span></span><br><span class=\"line\">$ kubectl get pod -n demo -o wide --show-labels</span><br><span class=\"line\">  <span class=\"comment\"># NAME            READY   STATUS    RESTARTS   AGE   IP               NODE        LABELS</span></span><br><span class=\"line\">  <span class=\"comment\"># web-backend-0   1/1     Running   0          13m   192.168.109.90   k8s-node-1  app=tomcat-web,controller-revision-hash=web-backend-776459fc9d,statefulset.kubernetes.io/pod-name=web-backend-0</span></span><br><span class=\"line\">  <span class=\"comment\"># web-backend-1   1/1     Running   0          13m   192.168.109.93   k8s-node-1  app=tomcat-web,controller-revision-hash=web-backend-776459fc9d,statefulset.kubernetes.io/pod-name=web-backend-1</span></span><br><span class=\"line\">  <span class=\"comment\"># web-front-0     1/1     Running   0          13m   192.168.109.91   k8s-node-1  app=nginx-web,controller-revision-hash=web-front-89f7fcc75,statefulset.kubernetes.io/pod-name=web-front-0</span></span><br><span class=\"line\">  <span class=\"comment\"># web-front-1     1/1     Running   0          13m   192.168.109.92   k8s-node-1  app=nginx-web,controller-revision-hash=web-front-89f7fcc75,statefulset.kubernetes.io/pod-name=web-front-1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 SVC 服务发现利用CoreDNS进行域名解析</span></span><br><span class=\"line\">$ nslookup front-svc.demo.svc.cluster.local. 10.96.0.10</span><br><span class=\"line\">  <span class=\"comment\"># Server:         10.96.0.10</span></span><br><span class=\"line\">  <span class=\"comment\"># Address:        10.96.0.10#53</span></span><br><span class=\"line\">  <span class=\"comment\"># Name:   front-svc.demo.svc.cluster.local</span></span><br><span class=\"line\">  <span class=\"comment\"># Address: 192.168.109.91</span></span><br><span class=\"line\">  <span class=\"comment\"># Name:   front-svc.demo.svc.cluster.local</span></span><br><span class=\"line\">  <span class=\"comment\"># Address: 192.168.109.92</span></span><br><span class=\"line\">$ nslookup backend-svc.demo.svc.cluster.local. 10.96.0.10</span><br><span class=\"line\">  <span class=\"comment\"># ...</span></span><br><span class=\"line\">  <span class=\"comment\"># Name:   backend-svc.demo.svc.cluster.local</span></span><br><span class=\"line\">  <span class=\"comment\"># Address: 192.168.109.90</span></span><br><span class=\"line\">  <span class=\"comment\"># Name:   backend-svc.demo.svc.cluster.local</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 请求查看 Nginx 与 Tomcat 应用回显。</span></span><br><span class=\"line\">~/k8s/ingress/demo<span class=\"comment\"># curl front-svc.demo.svc.cluster.local</span></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-front-0-WeiyiGeek-Nginx</span></span><br><span class=\"line\">~/k8s/ingress/demo<span class=\"comment\"># curl front-svc.demo.svc.cluster.local</span></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-front-1-WeiyiGeek-Nginx</span></span><br><span class=\"line\">~/k8s/ingress/demo<span class=\"comment\"># curl backend-svc.demo.svc.cluster.local:8080</span></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-backend-1-WeiyiGeek-Tomcat</span></span><br><span class=\"line\">~/k8s/ingress/demo<span class=\"comment\"># curl backend-svc.demo.svc.cluster.local:8080</span></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-backend-0-WeiyiGeek-Tomcat</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<ul>\n<li>Step 4.采用 secrets 存储我们创建的证书, 参考地址：<a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#tls-certificates\" target=\"_blank\" rel=\"noopener\">https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#tls-certificates</a></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Tips:  kubectl api-resources  | grep \"secret\" 可查看apiversions以及namespace是否支持</span></span><br><span class=\"line\"><span class=\"comment\"># 假设你已经将证书上传到k8s集群目录中并解压</span></span><br><span class=\"line\">$ ls</span><br><span class=\"line\">demo.weiyigeek.top.zip  test.weiyigeek.top.zip</span><br><span class=\"line\"></span><br><span class=\"line\">$ unzip demo.weiyigeek.top.zip -d demo.weiyigeek.top</span><br><span class=\"line\">$ unzip test.weiyigeek.top.zip -d test.weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建 tls 类型的 secret</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /tmp/demo.weiyigeek.top/Nginx</span><br><span class=\"line\">kubectl -n demo create secret tls demoweiyigeektop --key 2_demo.weiyigeek.top.key --cert 1_demo.weiyigeek.top_bundle.crt</span><br><span class=\"line\">  <span class=\"comment\"># secret/demoweiyigeektop created</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> /tmp/test.weiyigeek.top/Nginx</span><br><span class=\"line\">kubectl -n demo create secret tls testweiyigeektop --key 2_test.weiyigeek.top.key --cert 1_test.weiyigeek.top_bundle.crt</span><br><span class=\"line\">  <span class=\"comment\"># secret/testweiyigeektop created</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>Step 4.创建Ingress控制器的配置清单文件及Ingress对应规则。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">ingress-demo.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">ingress-demo</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\">    <span class=\"comment\"># 指定 Ingress Controller 的类型</span></span><br><span class=\"line\">    <span class=\"string\">kubernetes.io/ingress.class:</span> <span class=\"string\">\"nginx\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 指定我们的 rules 的 path 可以使用正则表达式</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/use-regex:</span> <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 连接超时时间，默认为 5s</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/proxy-connect-timeout:</span> <span class=\"string\">\"600\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 后端服务器回转数据超时时间，默认为 60s</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class=\"string\">\"600\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 后端服务器响应超时时间，默认为 60s</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class=\"string\">\"600\"</span></span><br><span class=\"line\">    <span class=\"comment\"># 客户端上传文件，最大大小，默认为 20m</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class=\"string\">\"10m\"</span></span><br><span class=\"line\">    <span class=\"comment\"># URL 重写</span></span><br><span class=\"line\">    <span class=\"string\">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"comment\"># 默认后端服务指定</span></span><br><span class=\"line\"><span class=\"attr\">  defaultBackend:</span></span><br><span class=\"line\"><span class=\"attr\">    service:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">front-svc</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span></span><br><span class=\"line\"><span class=\"attr\">        number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">  tls:</span></span><br><span class=\"line\"><span class=\"attr\">  - hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">test.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">    secretName:</span> <span class=\"string\">testweiyigeektop</span></span><br><span class=\"line\"><span class=\"attr\">  - hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">demo.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">    secretName:</span> <span class=\"string\">demoweiyigeektop</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - host:</span> <span class=\"string\">test.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">    http:</span></span><br><span class=\"line\"><span class=\"attr\">      paths:</span></span><br><span class=\"line\"><span class=\"attr\">      - pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\"><span class=\"attr\">        path:</span> <span class=\"string\">/tomcat</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          service:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">backend-svc</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span></span><br><span class=\"line\"><span class=\"attr\">              number:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"attr\">      - pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\"><span class=\"attr\">        path:</span> <span class=\"string\">/nginx</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          service:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">front-svc</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span></span><br><span class=\"line\"><span class=\"attr\">              number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">  - host:</span> <span class=\"string\">demo.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">    http:</span></span><br><span class=\"line\"><span class=\"attr\">      paths:</span></span><br><span class=\"line\"><span class=\"attr\">      - pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\"><span class=\"attr\">        path:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">        backend:</span></span><br><span class=\"line\"><span class=\"attr\">          service:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">front-svc</span></span><br><span class=\"line\"><span class=\"attr\">            port:</span></span><br><span class=\"line\"><span class=\"attr\">              number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<ul>\n<li>Step 5.创建Ingress并查看相关信息</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl create -f ingress-demo.yaml</span><br><span class=\"line\">  <span class=\"comment\"># ingress.networking.k8s.io/ingress-demo created  </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 ingress-nginx 的 SVC </span></span><br><span class=\"line\">kubectl get svc -n ingress-nginx</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller             LoadBalancer   10.104.171.212   &lt;pending&gt;     80:31122/TCP,443:32155/TCP   24h</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-nginx-controller-admission   ClusterIP      10.99.168.221    &lt;none&gt;        443/TCP                      24h</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 ingress-demo 对象相关信息</span></span><br><span class=\"line\">$ kubectl get ing -n demo ingress-demo</span><br><span class=\"line\">  <span class=\"comment\"># NAME           CLASS    HOSTS                                   ADDRESS   PORTS     AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># ingress-demo   &lt;none&gt;   test.weiyigeek.top,demo.weiyigeek.top             80, 443   24h</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl describe ing -n demo ingress-demo</span><br><span class=\"line\">  <span class=\"comment\"># Name:             ingress-demo</span></span><br><span class=\"line\">  <span class=\"comment\"># Namespace:        demo</span></span><br><span class=\"line\">  <span class=\"comment\"># Address:</span></span><br><span class=\"line\">  <span class=\"comment\"># Default backend:  front-svc:80 (192.168.109.91:80,192.168.109.92:80)</span></span><br><span class=\"line\">  <span class=\"comment\"># TLS:</span></span><br><span class=\"line\">  <span class=\"comment\">#   testweiyigeektop terminates test.weiyigeek.top</span></span><br><span class=\"line\">  <span class=\"comment\">#   demoweiyigeektop terminates demo.weiyigeek.top</span></span><br><span class=\"line\">  <span class=\"comment\"># Rules:</span></span><br><span class=\"line\">  <span class=\"comment\">#   Host                Path  Backends</span></span><br><span class=\"line\">  <span class=\"comment\">#   ----                ----  --------</span></span><br><span class=\"line\">  <span class=\"comment\">#   test.weiyigeek.top /tomcat   backend-svc:8080 (192.168.109.90:8080,192.168.109.93:8080)</span></span><br><span class=\"line\">  <span class=\"comment\">#   demo.weiyigeek.top /         front-svc:80 (192.168.109.91:80,192.168.109.92:80)</span></span><br><span class=\"line\">  <span class=\"comment\"># Annotations:          kubernetes.io/ingress.class: nginx</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/proxy-body-size: 10m</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/proxy-connect-timeout: 600</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/proxy-read-timeout: 600</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/proxy-send-timeout: 600</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/rewrite-target: /</span></span><br><span class=\"line\">  <span class=\"comment\">#                       nginx.ingress.kubernetes.io/use-regex: true</span></span><br><span class=\"line\">  <span class=\"comment\"># Events:               &lt;none&gt;</span></span><br></pre></td></tr></table></figure>\n<p><br></p>\n<ul>\n<li>Step 6.验证Ingress规则配置的应用分别访问 <code>https://demo.weiyigeek.top</code> 与 <code>https://test.weiyigeek.top</code> 站点。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl <span class=\"string\">'https://10.10.107.221'</span> -H <span class=\"string\">'host: demo.weiyigeek.top'</span> -i -k</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/2 200</span></span><br><span class=\"line\">  <span class=\"comment\"># date: Sat, 17 Jul 2021 04:39:37 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># content-type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># content-length: 37</span></span><br><span class=\"line\">  <span class=\"comment\"># last-modified: Thu, 15 Jul 2021 12:24:55 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># etag: \"60f02917-25\"</span></span><br><span class=\"line\">  <span class=\"comment\"># accept-ranges: bytes</span></span><br><span class=\"line\">  <span class=\"comment\"># strict-transport-security: max-age=15724800; includeSubDomains</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-front-1-WeiyiGeek-Nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ curl <span class=\"string\">'https://10.10.107.221/tomcat'</span> -H <span class=\"string\">'host: test.weiyigeek.top'</span> -i -k</span><br><span class=\"line\">  <span class=\"comment\"># HTTP/2 200</span></span><br><span class=\"line\">  <span class=\"comment\"># date: Sat, 17 Jul 2021 04:39:50 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># content-type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># content-length: 40</span></span><br><span class=\"line\">  <span class=\"comment\"># accept-ranges: bytes</span></span><br><span class=\"line\">  <span class=\"comment\"># etag: W/\"40-1626351892000\"</span></span><br><span class=\"line\">  <span class=\"comment\"># last-modified: Thu, 15 Jul 2021 12:24:52 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># strict-transport-security: max-age=15724800; includeSubDomains</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># hostname-web-backend-0-WeiyiGeek-Tomcat</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210717123656.png\" alt=\"WeiyiGeek.Ingress 应用\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Ingress 应用</p>\n            </figure>\n","comments":true,"excerpt":null,"categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"负载均衡","path":"api/categories/负载均衡.json"}],"tags":[{"name":"k8s","path":"api/tags/k8s.json"},{"name":"ingress-nginx","path":"api/tags/ingress-nginx.json"}]}