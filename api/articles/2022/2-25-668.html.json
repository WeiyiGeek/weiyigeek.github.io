{"title":"使用Kubernetes容器快速部署常用服务","slug":"系统运维/快速部署/K8S快速部署常用服务","date":"2022-02-25T02:39:30.000Z","updated":"2022-07-17T08:53:32.961Z","url":"2022/2-25-668.html","path":"api/articles/2022/2-25-668.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220714161757.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"快速搭建-grafana-可视化平台\"><a href=\"#快速搭建-grafana-可视化平台\" class=\"headerlink\" title=\"快速搭建 grafana 可视化平台\"></a>快速搭建 grafana 可视化平台</h2><p>项目地址: <a href=\"https://github.com/grafana/grafana/\" target=\"_blank\" rel=\"noopener\">https://github.com/grafana/grafana/</a><br>官方地址: <a href=\"https://grafana.com\" target=\"_blank\" rel=\"noopener\">https://grafana.com</a> </p>\n<p><strong>安装部署</strong></p>\n<p>步骤 01.资源清单（granana.ini）与 （Deployment）部署资源清单。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee grafana.ini &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[server]</span><br><span class=\"line\">domain = devops.weiyigeek.top</span><br><span class=\"line\">root_url = %(protocol)s://%(domain)s:%(http_port)s/grafana/</span><br><span class=\"line\">serve_from_sub_path = <span class=\"literal\">true</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">tee grafana-deploy.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana-pvc</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 2Gi</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: grafana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      securityContext:</span><br><span class=\"line\">        fsGroup: 472</span><br><span class=\"line\">        supplementalGroups:</span><br><span class=\"line\">          - 0</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: grafana</span><br><span class=\"line\">          image: grafana/grafana:9.0.2</span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 3000</span><br><span class=\"line\">              name: http-grafana</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /robots.txt</span><br><span class=\"line\">              port: 3000</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            initialDelaySeconds: 10</span><br><span class=\"line\">            periodSeconds: 30</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 2</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            initialDelaySeconds: 30</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            tcpSocket:</span><br><span class=\"line\">              port: 3000</span><br><span class=\"line\">            timeoutSeconds: 1</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 512m</span><br><span class=\"line\">              memory: 1024Mi</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: /var/lib/grafana</span><br><span class=\"line\">              name: grafana-pv</span><br><span class=\"line\">            - mountPath: /etc/grafana/grafana.ini</span><br><span class=\"line\">              name: ge-config</span><br><span class=\"line\">              subPath: grafana.ini</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: grafana-pv</span><br><span class=\"line\">          persistentVolumeClaim:</span><br><span class=\"line\">            claimName: grafana-pvc</span><br><span class=\"line\">        - name: ge-config</span><br><span class=\"line\">          configMap:</span><br><span class=\"line\">            name: ge-config</span><br><span class=\"line\">            items:</span><br><span class=\"line\">            - key: grafana.ini</span><br><span class=\"line\">              path: grafana.ini</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 3000</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: http-grafana</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: LoadBalancer</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>步骤 02.创建 grafana.ini 的 configmap 以及部署 grafana 到集群中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap ge-config --from-file=grafana.ini --namespace dashboard</span><br><span class=\"line\">kubectl create -f grafana-deploy.yaml --namespace dashboard</span><br></pre></td></tr></table></figure></p>\n<p>步骤 03.部署情况与日志情况查看。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs -f --tail 50 -n dashboard -l app=grafana</span><br><span class=\"line\">  <span class=\"comment\"># 关键日志:</span></span><br><span class=\"line\">  <span class=\"comment\"># logger=http.server t=2022-07-14T07:24:25.409774065Z level=info msg=\"HTTP Server Listen\" address=[::]:3000 protocol=http subUrl=/grafana socket=</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 04.配置 grafana ingress 的资源清单我们便可通过<code>域名+grafana目录</code>的方式进行访问。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    ingressclass.kubernetes.io/is-default-class: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/client-body-buffer-size: 50m</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-body-size: 50m</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-buffer-size: 50m</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-buffering: <span class=\"string\">\"on\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-buffers-number: <span class=\"string\">\"4\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-connect-timeout: 60s</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-read-timeout: 120s</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-send-timeout: 120s</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/rewrite-target: /<span class=\"variable\">$2</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: devops</span><br><span class=\"line\">    ref: devops</span><br><span class=\"line\">    url: devops.weiyigeek.top</span><br><span class=\"line\">  name: devops-weiyigeek</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ingressClassName: nginx</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - host: devops.weiyigeek.top</span><br><span class=\"line\">    http:</span><br><span class=\"line\">      paths:</span><br><span class=\"line\">      - backend:</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: grafana</span><br><span class=\"line\">            port:</span><br><span class=\"line\">              number: 3000</span><br><span class=\"line\">        path: /grafana(/|$)(.*)</span><br><span class=\"line\">        pathType: ImplementationSpecific</span><br><span class=\"line\">  tls:</span><br><span class=\"line\">  - hosts:</span><br><span class=\"line\">    - devops.weiyigeek.top</span><br><span class=\"line\">    secretName: weiyigeek.top</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 在进行前面操作完毕后我们便可通过<code>https://devops.weiyigeek.top/grafana/login</code>域名地址进行访问，默认密码 admin。</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220714161757.png\" alt=\"WeiyiGeek.Grafana之serve_from_sub_path设置\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Grafana之serve_from_sub_path设置</p>\n            </figure>","comments":true,"excerpt":"[TOC]","categories":[{"name":"部署运维","path":"api/categories/部署运维.json"},{"name":"环境快速搭建","path":"api/categories/环境快速搭建.json"}],"tags":[{"name":"Kubernetes","path":"api/tags/Kubernetes.json"}]}