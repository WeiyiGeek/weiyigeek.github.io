<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 Windows认证原理解析基础入门|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="协议">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
        
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                学习之路
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>Windows认证原理解析基础入门</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">Windows认证原理解析基础入门</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-03-06T05:35:30.000Z" itemprop="datePublished" class="page-time">
  2020-03-06
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Windows%E5%8E%9F%E7%90%86/">Windows原理</a></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap" style="display: none;">
  <article id="post-基础知识/操作系统/Windows底层/Windows认证原理解析基础入门"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">Windows认证原理解析基础入门</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-03-06 13:35:30" datetime="2020-03-06T05:35:30.000Z"  itemprop="datePublished">2020-03-06</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Windows%E5%8E%9F%E7%90%86/">Windows原理</a></li></ul>



            

            


            
        </div>
        <span class="post-href" style="display: none;">|</span>
        <!-- 微信公众号关注/文章版权复制 -->
        
          <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好看友,欢迎关注博主微信公众号哟! ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】即可关闭继续浏览文章.<br>  <b style="color:red;"> 温馨提示: 未解锁的用户不能粘贴复制文章内容哟!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
            
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h4 id="0x01-前言简介"><a href="#0x01-前言简介" class="headerlink" title="0x01 前言简介"></a>0x01 前言简介</h4><p>本文借鉴安全界各位大佬所写的Windows认证入门科普（它们的站点我附在来源）对其中的知识点做了一个整理总结，同时复现里面的算法方便以后自己理解以及在其他域渗透/内网渗透方式中提供基础知识，这篇文章很适合小白入门Windows认证协议简单明了;</p>
<p>本文实验模拟在<code>Windows 7 、Windows 10</code> 下进行验证主要内容:</p>
<ul>
<li>Windows用户认证基础介绍</li>
<li>LM/NTLM Hashes 版本优缺</li>
<li>LM/NTLM Hashes 生成原理</li>
<li>LM/NTLM Hashes 加密流程实践</li>
<li>LM/NTLM 挑战和响应(C/R)机制原理</li>
<li>LM/NTLM C/R 协议分析</li>
<li>学习总结</li>
</ul>
<p><br></p>
<h4 id="0x02-基本介绍"><a href="#0x02-基本介绍" class="headerlink" title="0x02 基本介绍"></a>0x02 基本介绍</h4><p>描述:Hashes(散列)直接音译为“哈希-Hash”,是把任意长度的输入（又叫做预映射，pre-image），通过散列算法，变换成固定长度的输出，该输出就是散列值。这种转换是一种压缩映射，也就是散列值的空间通常远小于输入的空间，不同的输入可能会散列成相同的输出，而不可能从散列值来唯一的确定输入值。<br>简单的说就是一种<code>将任意长度的消息压缩到某一固定长度的消息摘要的函数</code>。</p>
<p>回归到正题之中，有这样一个场景在您忘记您电脑密码的时候，我们常用的就是两种方式；</p>
<ul>
<li>1.采用PE系统进行跳过原始系统用户密码进行登录;</li>
<li>2.进行PE系统中读取系统目录中SAM文件然后进行重新设置用户密码;</li>
</ul>
<p>那SAM是什么呢?</p>
<blockquote>
<p>SAM(Security Account Manage)是Windows系统中存放系统用户及密码的一种文件并采用Syskey（系统密钥）加密保护<br>而LM/NTLM 哈希存储在安全帐户管理器(SAM)数据库和域控制器的NTDS.dit数据库中<br>简单流程:用户登录的时候采用用户输入的密码进行NTLM Hashes加密然后与系统中SAM文件中存储的NTLM Hashes进行比对;</p>
</blockquote>
<p><br></p>
<p>在这里不得不说一哈我们常用的NTLM Hashes的加密方式:<br>NTLM Hashes它采用的MD4加密方式，目前应用最广泛的Hashes算法 MD5 和 SHA1 它们也都是参考MD4加密原理为基础设计的，下面简单说一下：</p>
<ul>
<li><p>1）MD4: (RFC 1320)是 MIT (麻省理工学院)的 Ronald L. Rivest 在 1990 年设计的，它是一种用来测试信息完整性的密码散列函数的实行。其MD(Message Digest)摘要长度为128位，一般128位长的MD4散列被表示为32位的十六进制数字。它适用在32位字长的处理器上用高速软件实现，它是基于 32 位操作数的位操作来实现的。</p>
</li>
<li><p>2）MD5: (RFC 1321)是 Rivest于1991年对MD4的改进版本。它仍以512位分组来输入，其输出是4个32位字的级联，与 MD4 相同。MD5比MD4来得复杂，并且速度较之要慢一点，但更安全，在抗分析和抗差分方面表现更好</p>
</li>
<li><p>3）SHA1: 由NIST NSA设计为同DSA一起使用的，它对长度小于264的输入，产生长度为160bit的散列值，因此抗穷举(brute-force)性更好。SHA-1 设计时基于和MD4相同原理，并且模仿了该算法。</p>
</li>
</ul>
<p><br></p>
<p>回到正题由于当前PC常使用的系统版本基本都是<code>Windows 7 / Windows 10</code>,所以下认证情况都是基于该系统版本来说明的(作一个简单的了解):</p>
<h5 id="1-本地登录认证"><a href="#1-本地登录认证" class="headerlink" title="1.本地登录认证"></a>1.本地登录认证</h5><p>描述:当我们在本地登录认证时输入密码凭据登陆系统会首先将输入的凭据转换加密成NTLM Hashes(<code>NT LAN Manager</code>) 进行存储，这是由于Windows本身不存储用户的明文密码它将用户的明文密码经过加密算法后存储在SAM数据库(<code>%SystemRoot%\System32\config\sam</code>)中，此时操作系统会自动地读取Windows系统中的SAM文件中的对应用户的NTLM hashes值进行与我们凭据生成的NTLM Hashes进行比对认证，认证完成则登录成功否则提示账号或者密码错误;</p>
<p><br/></p>
<p>Windows本地登录验证流程:</p>
<ul>
<li>1.在我们注销或开机后将会弹出输入账号密码的界面用于接受用户输入由本地winlogon.exe进程进行管理;<ul>
<li>本地进程<code>winlogon.exe</code>将账号密码给lsass.exe进程进行处理并将密码缓存在进程中；</li>
<li>本地进程<code>lsass.exe</code>将我们输入密码凭据转换为NTML Hashes读取SAM数据库与用户名进行比较；</li>
</ul>
</li>
<li>2.若比较结果相同则将<code>User SID与Group SID</code>发给winlogon.exe，并准备登陆界面；若比较结果不同则登陆失败提示账号或者密码错误。</li>
</ul>
<p>简单流程:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Windows Logon Process winlogon.exe是 Windows NT 用户登陆程序用于管理用户登录和退出。</span></span><br><span class="line"><span class="comment">#Lsass.exe 是 用于微软Windows系统的安全机制它用于本地/远程安全和登陆策略，它会与我们SAM进行相互作用将本地或者远程身份认证的用户信息都会保存在其内存地址中。</span></span><br><span class="line">winlogon.exe -&gt; 接收用户输入 -&gt; lsass.exe -&gt; <span class="keyword">if</span> (认证) &#123; 登录成功 &#125;<span class="keyword">else</span>&#123; 登录失败 &#125;</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="2-网络登录认证"><a href="#2-网络登录认证" class="headerlink" title="2.网络登录认证"></a>2.网络登录认证</h5><p>局域网工作组：缺少信托机构(银行：两者之间进行交易所必须信任的中间人) </p>
<ul>
<li>工作组的环境是一个逻辑上的网络环境(工作区) ，隶属于工作组的机器之间无法互相建立一个完美的信任机制，只能点对点，是较为落后的认证方式没有信托机构。</li>
<li>假设A主机与B主机在一个工作主组环境，A想要访问B主机上的资源，需要将一个存在于B主机上的账户凭证发送至B主机，经过认证才能访问B主机上的资源。传输数据由协议来规范数据如何传递，最常见的服务：SMB服务端口445 / RPC服务(Remote Procedure Call，远程过程调用) 135端口。</li>
</ul>
<p><br></p>
<h4 id="0x03-LM-NTLM-版本优缺"><a href="#0x03-LM-NTLM-版本优缺" class="headerlink" title="0x03 LM/NTLM 版本优缺"></a>0x03 LM/NTLM 版本优缺</h4><p>Windows用户认证LM/NTLM Hashes发展流程:<br><strong>1) LM Hashes</strong></p>
<blockquote>
<p>IBM设计的LM Hash算法在Windows XP 或 Windows Server 2003 等系统发行版本以及以下采用的加密方式(基本已经被淘汰了);</p>
</blockquote>
<p><em>LM Hashes版本系列说明:</em></p>
<ul>
<li>LM Hashes</li>
<li>LM :完整名称(<code>LAN Manager Challenge/Response</code>) 挑战和验证机制主要用于网络身份认证;</li>
</ul>
<p><br></p>
<p><strong>2) NTLM Hashes</strong></p>
<blockquote>
<p> NTLM简称<code>NT LAN Manager</code>，由于LM Hashes脆弱性和Windows认证需要协议来规范，以及微软在保持向后兼容性的同时提出了<code>WindowsNT挑战/响应验证机</code>此时NTLM Hash便应运而生。<br>在Windows Vista 与 Windows Server 2008 以上版本默认采用的加密方式, NTLM Hashes算法的前身是LM Hashes</p>
</blockquote>
<p><em>NTLM Hashes版本系列说明:</em></p>
<ul>
<li>NTLM Hashes (<code>也称为 NT Hashes</code>) 主要用于本地认证;</li>
<li>NTLMv1 Hashes (<code>也称为Net-NTLMv1 Hashes</code>) 运用了WindowsNT挑战与响应验证机制结合，主要用于网络身份认证;</li>
<li>NTLMv2 Hashes (<code>也称为Net-NTLMv2 Hashes</code>) 主要用于网络身份认证并且使用广泛;</li>
<li>NTLM session 用于在没有NTLMv2身份验证的情况下协商NTLM2会话安全性时</li>
</ul>
<p>说明:为了后面方便引用C/R验证机制的时候统一采用NTLMv1 Hashes 、NTLMv2 Hashes 进行说明;</p>
<p><br></p>
<p>LM / NTLM Hashes 两者之间优缺点比较:</p>
<ul>
<li>1.LM-Hashes<ul>
<li>缺点:安全问题密码不区分大小写(因为最开始会把密码统一转换为大写) 、密码最长为14位(2*7B==112bit)、可通过加密后的值反推加密前的密码位数、DES加密强度较弱等。</li>
</ul>
</li>
<li>2.NTLM-Hashes / Net-NTLM<ul>
<li>缺点:可以用来获取不区分大小写的密码，以及用于查找NTLM响应使用的区分大小写密码的试错法，特别是NTLMv1版本容易被彩虹表进行碰撞检测得出密码的NTLM Hashes。</li>
</ul>
</li>
</ul>
<p><br></p>
<p>LM / NTLM / Net-NTLM Hashes 格式:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#(1) LM哈希（16B = 32字符 ） : NTLM哈希（16B = 32位）</span></span><br><span class="line">aad3b435b51404eeaad3b435b51404ee : e19ccf75ee54e06b06a5907af13cef42</span><br><span class="line"></span><br><span class="line"><span class="comment">#(2) LM Pesponse(24B = 48位)</span></span><br><span class="line">ca1200723c41d577ab18c764c6def34fa61bfa0671ea5fc8</span><br><span class="line"></span><br><span class="line"><span class="comment">#(3) NetNTLMv1 / NetNTLMv1+ESS</span></span><br><span class="line">NTLM Server Challenge: f9c7fc816b991824</span><br><span class="line">Lan Manager Response: c67ee888f6b41a4400000000000000000000000000000000</span><br><span class="line">NTLM Response: 293b99da834c86c6e37c37a20920b41581be32740a5e062e</span><br><span class="line"></span><br><span class="line"><span class="comment">#(4) NET-NTLMv2（又名NTLMv2）哈希的示例</span></span><br><span class="line">NTLM Server Challenge: f12d21c3e60843cc</span><br><span class="line">Lan Manager Response: 000000000000000000000000000000000000000000000000</span><br><span class="line">LMv2 Client Challenge: 0000000000000000</span><br><span class="line">NTLMv2 Hashes: 6061d067efff612ae4f1c704f1a44f08 <span class="comment">#(16 = 32位)</span></span><br><span class="line">NTProofStr: 32a48adf53baf6ef888482d94e222001</span><br><span class="line">NTLMv2 Response: 32a48adf53baf6ef888482d94e2220010101000000000000...<span class="comment">#(128bit)</span></span><br></pre></td></tr></table></figure></p>
<hr/>

<h4 id="0x04-LM-NTLM-生成原理"><a href="#0x04-LM-NTLM-生成原理" class="headerlink" title="0x04 LM/NTLM 生成原理"></a>0x04 LM/NTLM 生成原理</h4><h5 id="1-LM-Hashes-生成实例"><a href="#1-LM-Hashes-生成实例" class="headerlink" title="1.LM-Hashes 生成实例"></a>1.LM-Hashes 生成实例</h5><p>注意:如果需要复现需要将系统策略进行更改支持LM存储:<code>控制面板&gt;所有控制面板项&gt;管理工具&gt;本地安全策略(gpedit.msc)&gt;本地策略&gt;安全选项&gt;网络安全:在下一次更改密码时不存储LAN管理器哈希值(LM) 设置禁用</code>;</p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200310145405.png" target="_blank" title="WeiyiGeek.在下一次更改密码时不存储LAN管理器哈希值(LM)" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200310145405.png" alt="WeiyiGeek.在下一次更改密码时不存储LAN管理器哈希值(LM)" title="" class=""></a>
                <p>WeiyiGeek.在下一次更改密码时不存储LAN管理器哈希值(LM)</p>
            </figure>
<p><br></p>
<p>LM-Hashes生成原理三步骤详解:</p>
<ul>
<li>Step0.由于这种密码生成规则要求用户的密码最多仅能为14个字符即<code>14*8B=11bit</code>长度</li>
<li>Step1.明文口令转换为其大写形式(Upper case)在有字母的情况下进行否者直接进行第二步</li>
<li>Step2.将转换后的口令进行转成Hex编码</li>
<li>Step3.生存的Hex编码如果不足<code>112bit/8bit=14</code>个字符要求用0补全</li>
<li>Step4.将补全后的14个字符112bit的数据<code>分成2组每组7字节/B(56 bit)</code></li>
<li>Step5.将每组的十六进制转换成为二进制并且在转换后长度不足56bit使用0在左边补齐长度,再将二进制数据<code>分7bit为一组</code>末尾加0组成新的编码此时成为每组8B(64bit);</li>
<li>Step6.将上步得到的两组8B字节编码分别作为单向DES加密Key魔术字符串<code>KGS!@#$%</code>转换成为Hex(<code>4B47532140232425</code>)数据然后得到两组密文;</li>
<li>Step7.将两组DES加密后的数据进行拼接得到LM-Hash值;</li>
</ul>
<p><br></p>
<p><strong>实例验证LM-Hashes生成:</strong><br>服务器密码:123456<br>LM-HASH值为:44EFCE164AB921CAAAD3B435B51404EE</p>
<ul>
<li>1.由于服务器密码是纯数字转换任然为本身进行步骤跳过;</li>
<li>2.转换成为16进制的ASCII码不足14B采用0补齐并将补全结果分为两个7 Bytes部分即:<code>31323334353600 00000000000000</code>;</li>
<li>3.分别将两组7Bytes数据转换成为二进制进行补0操作后再分7bit一组在末尾+0,形成每组8B长度再将其转换成为16进制:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#二进制</span></span><br><span class="line">第一组:31323334353600 == 110001001100100011001100110100001101010011011000000000</span><br><span class="line">第二组:00000000000000 == 54 x 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#左边补0(2bit)</span></span><br><span class="line">第一组:00110001001100100011001100110100001101010011011000000000</span><br><span class="line">第二组:56 x 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#再分7bit为一组末尾加0 (形成每组8B)</span></span><br><span class="line"><span class="comment">#第一组 / #第二组(全为0) 0000000 0 x 7 </span></span><br><span class="line">0011000 0</span><br><span class="line">1001100 0</span><br><span class="line">1000110 0</span><br><span class="line">0110011 0</span><br><span class="line">0100001 0</span><br><span class="line">1010100 0</span><br><span class="line">1101100 0</span><br><span class="line">0000000 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#对此时的密码字符串对应的8字节16进制编码（str_to_key()函数处理）</span></span><br><span class="line">30988C6642A8D800</span><br><span class="line">0000000000000000</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>4.将以上步骤得到的两组16进制字符串，分别作为DES加密key为魔术字符串KGS!@#$%(Hex:<code>4b47532140232425</code>)进行加密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">44EFCE164AB921CA</span><br><span class="line">AAD3B435B51404EE</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200310162024.png" target="_blank" title="WeiyiGeek.DES加密" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200310162024.png" alt="WeiyiGeek.DES加密" title="" class=""></a>
                <p>WeiyiGeek.DES加密</p>
            </figure>
</li>
<li><p>5.拼接得到的密码即形成LM-Hashes:<code>44EFCE164AB921CAAAD3B435B51404EE</code></p>
</li>
</ul>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200310162206.png" target="_blank" title="WeiyiGeek.LM-Hashes" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200310162206.png" alt="WeiyiGeek.LM-Hashes" title="" class=""></a>
                <p>WeiyiGeek.LM-Hashes</p>
            </figure>
<p><br></p>
<p>Python3实现LM-HASH脚本(需要安装pyDes模块):<br>运行:LM-Hashes.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment"># Build Version: Python3</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pyDes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DesEncrypt</span><span class="params">(str, Des_Key)</span>:</span></span><br><span class="line">    k = des(Des_Key, ECB, pad=<span class="literal">None</span>)</span><br><span class="line">    EncryptStr = k.encrypt(str)</span><br><span class="line">    <span class="keyword">return</span> binascii.b2a_hex(EncryptStr)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Zero_padding</span><span class="params">(str)</span>:</span></span><br><span class="line">    b = []</span><br><span class="line">    l = len(str)</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(l):</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">8</span>) <span class="keyword">and</span> n % <span class="number">7</span> == <span class="number">0</span>:</span><br><span class="line">            b.append(str[n:n + <span class="number">7</span>] + <span class="string">'0'</span>)</span><br><span class="line">            num = num + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="comment">#将输入值进行Bytes转换</span></span><br><span class="line">      print(<span class="string">"Password : "</span>+sys.argv[<span class="number">1</span>])</span><br><span class="line">      test_str = sys.argv[<span class="number">1</span>].encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">      print(<span class="string">"Usage:Python LM-Hashes.py Password"</span>)</span><br><span class="line">      print(<span class="string">"[*] Error:"</span>+str(e))</span><br><span class="line">      sys.exit()</span><br><span class="line">    <span class="comment"># 用户的密码转换为大写,并转换为16进制ASCCI;</span></span><br><span class="line">    test_str = test_str.upper()</span><br><span class="line">    test_str = binascii.b2a_hex(test_str).decode();</span><br><span class="line">    print(<span class="string">"Hex: "</span>+test_str)</span><br><span class="line">    str_len = len(test_str)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 密码不足14字节将会用0来补全</span></span><br><span class="line">    <span class="keyword">if</span> str_len &lt; <span class="number">28</span>:</span><br><span class="line">        test_str = test_str.ljust(<span class="number">28</span>, <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 固定长度的密码被分成两个7byte部分</span></span><br><span class="line">    t_1 = test_str[<span class="number">0</span>:<span class="number">14</span>]</span><br><span class="line">    t_2 = test_str[<span class="number">14</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(t_1 + " " + t_2)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度</span></span><br><span class="line">    t_1 = bin(int(t_1, <span class="number">16</span>)).lstrip(<span class="string">'0b'</span>).rjust(<span class="number">56</span>, <span class="string">'0'</span>)</span><br><span class="line">    t_2 = bin(int(t_2, <span class="number">16</span>)).lstrip(<span class="string">'0b'</span>).rjust(<span class="number">56</span>, <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 再分7bit为一组末尾加0，组成新的编码</span></span><br><span class="line">    t_1 = Zero_padding(t_1)</span><br><span class="line">    t_2 = Zero_padding(t_2)</span><br><span class="line">    <span class="comment">#print(t_1)</span></span><br><span class="line">    t_1 = hex(int(t_1, <span class="number">2</span>))</span><br><span class="line">    t_2 = hex(int(t_2, <span class="number">2</span>))</span><br><span class="line">    t_1 = t_1[<span class="number">2</span>:].rstrip(<span class="string">'L'</span>)</span><br><span class="line">    t_2 = t_2[<span class="number">2</span>:].rstrip(<span class="string">'L'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'0'</span> == t_2:</span><br><span class="line">        t_2 = <span class="string">"0000000000000000"</span></span><br><span class="line">    t_1 = binascii.a2b_hex(t_1)</span><br><span class="line">    t_2 = binascii.a2b_hex(t_2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 上步骤得到的8byte二组，分别作为DES key为"KGS!@#$%"进行加密。</span></span><br><span class="line">    LM_1 = DesEncrypt(<span class="string">"KGS!@#$%"</span>, t_1)</span><br><span class="line">    LM_2 = DesEncrypt(<span class="string">"KGS!@#$%"</span>, t_2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将二组DES加密后的编码拼接，得到最终LM HASH值。</span></span><br><span class="line">    LM = LM_1 + LM_2</span><br><span class="line">    print(<span class="string">"LM-Hashse Lower: "</span>+LM.decode()+ <span class="string">"\nLM-Hashes Upper: "</span>+LM.decode().upper())</span><br></pre></td></tr></table></figure></p>
<p>执行结果:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@WeiyiGeek F:\]$ Python LM-Hashes.py 123456</span><br><span class="line">Password : 123456</span><br><span class="line">Hex: 313233343536</span><br><span class="line">31323334353600 00000000000000</span><br><span class="line">0011000010011000100011000110011001000010101010001101100000000000</span><br><span class="line">0x30988c6642a8d800 0x0</span><br><span class="line">LM-Hashse Lower: 44efce164ab921caaad3b435b51404ee</span><br><span class="line">LM-Hashes Upper: 44EFCE164AB921CAAAD3B435B51404EE</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h5 id="2-NTLM-Hashes-生成实例"><a href="#2-NTLM-Hashes-生成实例" class="headerlink" title="2.NTLM-Hashes 生成实例"></a>2.NTLM-Hashes 生成实例</h5><p>NTLM-Hashes 生成原理步骤详解:</p>
<ul>
<li>Step1：明文口令转换成16进制ASCII编码(Hex)                   </li>
<li>Step2：Unicode编码(ASCII转Unicode) <code>原本是在每个Hex编码前加上0x00nn</code>,但是由于Window操作使用的是小端存储，所以得注意这里采用的是UTF-16小端序编码(LE,Little Endian|)即<code>在每个字节之后添加00</code>;</li>
<li>Step3：对Unicode字符串使用MD4消息摘要算法得到16字节的值即NTML-Hash          <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NT_Hash(password) = MD4(UTF-16-LE(password))</span><br><span class="line">NT_Hash(<span class="string">"pass1"</span>) = <span class="string">"8D7A851DDE3E7BED903A41D686CD33BE"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><em>补充知识点:</em><br>大端序（Big-Endian，大尾序）：高位字节放在内存的低地址，低位字节放在内存的高地址, 低地址 <code>0x12 0x34 0x56 0x78</code> 高地址， 可以看见是符合人们常规得理解顺序。<br>小端序（Little-Endian，小尾序）：低位字节放在内存的低地址，高位字节放在内存的高地址<code>0x78 0x56 0x34 0x12</code>，笑话:计算机说我也要由自己得理解顺序。</p>
<p><strong>实例验证NTLM-Hases生成:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.查看lsass.exe进程信息;</span></span><br><span class="line"><span class="variable">$tasklist</span> | findstr <span class="string">"lsass.exe"</span></span><br><span class="line">lsass.exe                      676 Services                   0     35,172 K</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.该程序在内存中的信息</span></span><br><span class="line"><span class="variable">$procdump64</span>.exe -ma -t 676</span><br><span class="line">ProcDump v9.0 - Sysinternals process dump utility</span><br><span class="line">Process:               lsass.exe (676)</span><br><span class="line">Process image:         C:\Windows\system32\lsass.exe</span><br><span class="line">CPU threshold:         n/a</span><br><span class="line">Performance counter:   n/a</span><br><span class="line">Commit threshold:      n/a</span><br><span class="line">Threshold seconds:     n/a</span><br><span class="line">Hung window check:     Disabled</span><br><span class="line">Log debug strings:     Disabled</span><br><span class="line">Exception monitor:     Disabled</span><br><span class="line">Exception filter:      [Includes]</span><br><span class="line">                       *</span><br><span class="line">                       [Excludes]</span><br><span class="line">Terminate monitor:     Enabled</span><br><span class="line">Cloning <span class="built_in">type</span>:          Disabled</span><br><span class="line">Concurrent <span class="built_in">limit</span>:      n/a</span><br><span class="line">Avoid outage:          n/a</span><br><span class="line">Number of dumps:       1</span><br><span class="line">Dump folder:           C:\Users\Administrator\Downloads\Procdump\</span><br><span class="line">Dump filename/mask:    PROCESSNAME_YYMMDD_HHMMSS</span><br><span class="line">Queue to WER:          Disabled</span><br><span class="line">Kill after dump:       Disabled</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.下载该应用程序在内存之中数据导出到本地以供mimikatz使用</span></span><br><span class="line"><span class="variable">$procdump64</span>.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line">[22:45:02] Dump 1 initiated: lsass.dmp</span><br><span class="line">[22:45:05] Dump 1 writing: Estimated dump file size is 35 MB.</span><br><span class="line">[22:45:05] Dump 1 complete: 36 MB written <span class="keyword">in</span> 3.5 seconds</span><br><span class="line">[22:45:06] Dump count reached.</span><br><span class="line"></span><br><span class="line"><span class="comment">#4.获取lsass.dmp文件内容并用mimikatz查看账户密码的NTML HASH值</span></span><br><span class="line"><span class="variable">$mimikatz</span>.exe <span class="string">"sekurlsa::minidump lsass.dmp"</span> <span class="string">"sekurlsa::logonPasswords full"</span> <span class="built_in">exit</span> &gt;pass.txt</span><br><span class="line"></span><br><span class="line"><span class="variable">$type</span> pass.txt</span><br><span class="line">mimikatz(commandline) <span class="comment"># sekurlsa::minidump lsass.dmp</span></span><br><span class="line">Switch to MINIDUMP : <span class="string">'lsass.dmp'</span></span><br><span class="line">mimikatz(commandline) <span class="comment"># sekurlsa::logonPasswords full</span></span><br><span class="line">Opening : <span class="string">'lsass.dmp'</span> file <span class="keyword">for</span> minidump...</span><br><span class="line">Logon Time        : 2020/3/8 11:30:23</span><br><span class="line">User Name         : Test</span><br><span class="line">SID              :S-1-5-21-1802160877-2963370050-2309095339-500</span><br><span class="line">msv :	</span><br><span class="line">[00010000] CredentialKeys</span><br><span class="line">* NTLM     : 26b5936a9a6b7cd2d589abd4c6c126de</span><br><span class="line">* SHA1     : fa6fe7fab3f9920f1e97ebd148767776e07e55b6</span><br></pre></td></tr></table></figure></p>
<p><strong>手动实现密码加密:</strong><br>根据NTML HASH的生成原理推算也同样得到7b86d7692a8b1de47817434f08671229；<br>第一步：将WeiyiGeek进行十六进制的转换后输出结果如下；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WeiyiGeek = 57 65 69 79 69 47 65 65 6b</span><br></pre></td></tr></table></figure></p>
<p>第二步：将ASCII转码为Unicode（小端序）得到结果如下；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意:如果是使用UltraEdit进行转换成Unicode会带有FF FE，开头的FF FE用于标识此文本文件为Unicode编码</span></span><br><span class="line">String to Hex Unicode :770065006900790069006700650065006b00</span><br></pre></td></tr></table></figure></p>
<p>第三步：将570065006900790069004700650065006b00(注意需要进行设置为Hex String)进行MD4加密后得到结果如下；<br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200309021744.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200309021744.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure></p>
<p>第四步：与上面内存中的NTLM HASH进行比较验证完成,自己拿取了大佬们写的JS库写的一个小Demo演示(在线加密的有很多，自己只是学习了解其中的算法思路才写的):<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>MD4 加密 <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://nf404.github.io/crypto-api/crypto-api.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./md4.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>请输入需要加密成NTLM的明文密码:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"src"</span>&gt;</span>明文密码:<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">"src"</span>&gt;</span> &amp;nbsp; &amp;nbsp; </span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"转换"</span> <span class="attr">onclick</span>=<span class="string">"ntlm_encoder()"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>转换结果:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"result"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">ntlm_encoder</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> str = <span class="built_in">document</span>.getElementById(<span class="string">"src"</span>).value;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> hex = <span class="string">""</span>;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;str.length;i++)&#123;</span></span><br><span class="line"><span class="actionscript">                hex += str.charCodeAt(i).toString(<span class="number">16</span>)+<span class="string">"00"</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="actionscript">            resultASCII=CryptoApi.hash(<span class="string">'md4'</span>, hex)</span></span><br><span class="line"><span class="actionscript">            resultUnicode=hex_md4(str); <span class="comment">//采用16位 bits per input character 编码</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">"result"</span>).innerHTML=<span class="string">"&lt;mark&gt; String to Hex Unicode :"</span>+ hex + <span class="string">"&lt;br&gt; MD4 Text String : "</span>+resultASCII+<span class="string">"&lt;br&gt; MD4 Hex String [NTLM]: "</span>+resultUnicode+<span class="string">"&lt;/mark&gt;"</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200309021919.png" target="_blank" title="WeiyiGeek.Demo演示" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200309021919.png" alt="WeiyiGeek.Demo演示" title="" class=""></a>
                <p>WeiyiGeek.Demo演示</p>
            </figure></p>
<hr/>

<h4 id="0x05-LM-NTLM-挑战和响应机制原理"><a href="#0x05-LM-NTLM-挑战和响应机制原理" class="headerlink" title="0x05 LM/NTLM 挑战和响应机制原理"></a>0x05 LM/NTLM 挑战和响应机制原理</h4><p>问什么是挑战/响应模式（鉴权协议）?</p>
<blockquote>
<p>答:鉴权协议如下的鉴权协议又被称作挑战(认证模式)，使用明文口令模式时，网络上传输的就是明文口令本身很容易被Sniffer捕获。而挑战/响应模式在传输信道也是是可被侦听Sniffer，但不可被篡改的情况下并且对密码进行分段加密，这是一种简单而安全的方法。</p>
</blockquote>
<p><br></p>
<h5 id="1-LAN-Manager-Challenge-Response"><a href="#1-LAN-Manager-Challenge-Response" class="headerlink" title="1.LAN Manager Challenge/Response"></a>1.LAN Manager Challenge/Response</h5><p>描述:LM验证机制方案比NTLM响应时间更早，安全性更低。</p>
<p><em>以SMB通讯A(Client)/B(Server)访问请求为例:</em><br>Step1.协商:通信连接请求TCP三次握手,采用SMB协议获取信息请求;<br>Step2.质询:质询的完整过程</p>
<ul>
<li>(1) A向B发送需要登录的用户验证是否存在,存在则继续否则失败</li>
<li>(2) B找到该用户的缓存的LM-Hash密码并且随机生成8B(16位)的挑战数，随后发送给A;</li>
<li>(3) A收到该16位挑战数(<code>LM Challenge</code>)并且将输入的密码转换成为LM-Hashes(Client A缓存输入密码的哈希值，原始密码会被丢弃，“原始密码在任何情况下都不能被缓存”，这是一条基本的安全准则)</li>
<li>(4) A将LM-Hashes(16B = 32字符) 加上5B(0X00)凑成21B(42个字符)然后划分成三组每组7字节,之后再对每组7字节做为参数传递给str_to_key()函数，最终得到三组DESKEY得到每组8字节的<code>Hex数据</code>;</li>
<li>(5) A分别采用上面所得24B数据(3组*8B)依次对Challenge(8B)进行标准DES加密并将其进行拼接最终得到一个24字节的响应数据(这就是我们所说的<code>LM Response</code>),随后发送给B;</li>
<li>(6) B也是根据4-6步骤生成本地的<code>LM Pesponse</code><br>Step3.响应验证:</li>
<li>(7) B收到A发送的Response后与本地生成的<code>本地 LM Response</code>进行比对,是则验证成功否则失败;</li>
</ul>
<p>LM Challenge / Response 身份验证过程:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.假设我们登录的账户是admin密码是weiyigeek(此时B机器上存在admin账户正确密码的LM-Hashes值)</span></span><br><span class="line">[root@WeiyiGeek F:\]$ python LM-Hashes.py weiyigeek</span><br><span class="line">Password : weiyigeek</span><br><span class="line">LM-Hashse Lower: 623e80a2f48abcf1b3a121027af9fe24</span><br><span class="line">LM-Hashes Upper: 623E80A2F48ABCF1B3A121027AF9FE24</span><br><span class="line"></span><br><span class="line">LM-Hashes(<span class="string">"weiyigeek"</span>) = 623e80a2f48abcf1b3a121027af9fe24;</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.B确认了Admin账户存在后之后生成8B的挑战并且向A进行发送;</span></span><br><span class="line">LM Challenge = 0001020304050607</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.A收到B发送的Challenge开始进行一些列生成LM Response流程</span></span><br><span class="line"><span class="comment">## 3.1 A输入的密码生成的LM-Hashse(16)+5B(0x00) = 21B</span></span><br><span class="line">623e80a2f48abcf1b3a121027af9fe24 0000000000</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.2 将上步生成的21B数据平均分成三组（7B）</span></span><br><span class="line">623e80a2f48abc f1b3a121027af9 fe240000000000</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.3 每组7字节做为参数传递给str_to_key()函数[就是将前面三组分别转成二进制然后7bit一组在后+0,最终形成8B数据再转回16进制]最终得到三组DESKEY</span></span><br><span class="line">DESKEY 1 : 621ea0142ea42a78</span><br><span class="line">DESKEY 2 : f0d8e8241012eaf2</span><br><span class="line">DESKEY 3 : fe12000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.4 然后采用上面三组Key对进行Challenga加密后得到3组Hex字符拼接即可</span></span><br><span class="line">DESKEY 1 : 621ea0142ea42a78 -&gt; 对Challenge 0001020304050607 进行标准DES加密 -&gt; 5df3066f953edbd7</span><br><span class="line">DESKEY 2 : f0d8e8241012eaf2 -&gt; 对Challenge 0001020304050607 进行标准DES加密 -&gt; c1573fddf1430e6f</span><br><span class="line">DESKEY 3 : fe12000000000000 -&gt; 对Challenge 0001020304050607 进行标准DES加密 -&gt; 2d124c5b2022bb6b</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.5得到最终的Response同时发送给B，B服务端采用相同的方式生成的Local LM Response进行比对，如果匹配则身份验证通过否则失败</span></span><br><span class="line">Response Result : 5df3066f953edbd7c1573fddf1430e6f2d124c5b2022bb6b</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311135919.png" target="_blank" title="WeiyiGeek.LM Response" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311135919.png" alt="WeiyiGeek.LM Response" title="" class=""></a>
                <p>WeiyiGeek.LM Response</p>
            </figure>
<h5 id="2-NTLM-Challenge-Response"><a href="#2-NTLM-Challenge-Response" class="headerlink" title="2.NTLM Challenge/Response"></a>2.NTLM Challenge/Response</h5><p>描述:NTLMv1 / NTLMv2 Hashes 是一种Challenge/Response 验证机制，由三种消息组成：通常称为类型1（协商），类型2（质询）和类型3（身份验证）。</p>
<ul>
<li>NTLM版本1（“NTLMv1”）该方案解决了LM响应中的一些缺陷，但是同时自身由于NTLM响应几乎总是与LM响应一起发送所以比较薄弱(逆向推倒)，在控制Challenge后可以在短时间内通过彩虹表还原出用户的ntlm hash;</li>
<li>NTLM版本2（“NTLMv2”）被用来解决NTLM中存在的安全问题。当启用NTLMv2时，NTLM响应被替换为NTLMv2响应，并且LM响应被替换为LMv2响应。</li>
</ul>
<p><br></p>
<p><strong>它们基本工作流程</strong><br>Step1.协商:客户端向服务器发送类型1消息,确认协议版本是V1还是V2？<br>Step2.质询:质询的完整过程服务器进行响应(重点:进行响应)</p>
<ul>
<li>(1) 服务器判断用户是否存在：<ul>
<li>客户端向服务器端发送用户主机信息(必须包含用户名)，服务器用客户端请求的用户名来判断服务器内是否有这个用户；</li>
<li>若没有这个用户那么认证过程就是失败的；若有则继续：</li>
</ul>
</li>
<li>(2) 服务器生成16位Challenge：<ul>
<li>服务器接受到请求之后生成一个16位随机数Challenge，服务器使用登录用户名对应的NTLM HASH；</li>
</ul>
</li>
<li>(3) 服务器生成Net NTLM HASH便于比对：<ul>
<li>服务器用本机SAM文件数据库内NTLM HASH 加密 16位随机数 Challenge生成<code>本地Response 即“Net-NTML HASH”</code>；</li>
</ul>
</li>
<li>(4) 服务器返回16位Challenge：<ul>
<li>服务器将之前生成的16位随机数Challenge再发送给客户端；</li>
</ul>
</li>
<li>(5) 客户端生成传送给服务端的Response：<ul>
<li>客户端接受到Challenge之后，使用将要登陆到账户对应的NTLM HASH加密Challenge生成Response，然后将Response发送到服务端 ；</li>
</ul>
</li>
</ul>
<p>Step3.类型验证:(最关键的部分因为它们向服务器证明客户端用户知道帐户密码)</p>
<ul>
<li>(6) 服务端比对Response是否等于Net NTLM HASH：<br>比对服务器端收到客户端的Response后，比对NET NTLM HASH与Response是否相等，相等则通过。 </li>
</ul>
<p><a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200308004330.png" target="_blank" title="WeiyiGeek.验证流程" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200308004330.png" alt="WeiyiGeek.验证流程"></a></p>
<p><br></p>
<p><strong>1）NTLMv1 响应计算</strong><br>Step1.首先本地生成输入密码的对应NTLM Hashes值;<br>Step2.其次与LM C/R响应的计算方式是相同的(<code>只是生产LM / NTLM Hashes不同而已</code>),也是将16字节(32个字符)的NTLM散列填充为21个字节，<br>Step3.分别将21Bytes分成3组7bit再将每组7字节做为参数传递给str_to_key()函数最终得到三组DESKEY(8bytes)<br>Step4.将从服务器端接收的Challenge(质询消息的挑战)分别采用上面三组DESKEY进行加密得到三组DES加密的结果;<br>Step5.将上面生成三组Des加密的结果进行拼接形成形成一个24字节的值这就是响应(<code>Response</code>)</p>
<p>说明:由于生成Response与LM C/R 一致所以这里不演示了，具体参考LM Challenge / Response 身份验证过程;</p>
<p><br></p>
<p><strong>2）NTLMv2 响应计算</strong><br>Step1.计算获取NTLM密码的Hashes参考前面<code>实例验证NTLM-Hases生成</code>;<br>Step2.计算NTLMv2哈希值流程;</p>
<ul>
<li>1.先将用户名转换为大写然后和目标拼接在一起（<code>目标为 domain or server name 的值，且区分大小写</code>）组成字符串;</li>
<li><p>2.然后计算这个字符串的Unicode十六进制字符串，使用Step1中的16字节NTLM散列作为密钥;</p>
</li>
<li><p>3.将HMAC-MD5消息认证码算法应用于Unicode十六进制字符串，得到16字节的值即为NTLMv2-HASH</p>
</li>
<li><p>4.使用16字节NTLMv2散列作为密钥，将HMAC-MD5消息认证码算法应用于质询消息的挑战(Challenge)与blob连接字符串，此时会产生一个16字节的HASH输出值，然后该值与blob连接以形成NTLMv2响应(Response)。</p>
</li>
</ul>
<p>构建被称为“blob”的数据块其简述如下：</p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311230352.png" target="_blank" title="WeiyiGeek.blob" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311230352.png" alt="WeiyiGeek.blob" title="" class=""></a>
                <p>WeiyiGeek.blob</p>
            </figure>
<p>在抓包中的关键字段是Blob目</p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200312004126.png" target="_blank" title="WeiyiGeek.Blob" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200312004126.png" alt="WeiyiGeek.Blob" title="" class=""></a>
                <p>WeiyiGeek.Blob</p>
            </figure>
<p><em>实际流程验证:</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">目标DOMAIN:HACKONE</span><br><span class="line">用户名称:WeiyiGeek</span><br><span class="line">密码NTLM:fc348d696833ec7ea33e121e8c41b69c (我直接采用上面的NTLM工具生成Hashes)</span><br><span class="line">Challenge:a47b80ee3b16910e</span><br><span class="line">Blob:01010000000000009b09b1969ef7d50166ce6f7781f3d3670000000002001e004400450053004b0054004f0050002d004f004600510031004d0055004e0001001e004400450053004b0054004f0050002d004f004600510031004d0055004e0004001e004400450053004b0054004f0050002d004f004600510031004d0055004e0003001e004400450053004b0054004f0050002d004f004600510031004d0055004e00070008009b09b1969ef7d5010600040002000000080030003000000000000000000000000030000013b5d33a3c720a8cf7789ac2bfb7d9ef82d7d476d546a70be02087c0e11c979d0a001000000000000000000000000000000000000900200063006900660073002f003100390032002e003100360038002e0031002e003500000000000000000000000000</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>1.计算NTLMv2 Hashes值将用户名转换成为大写并且与domain(区分大小写)进行拼接,然后计算这个字符串的Unicode十六进制字符串(同样是小端序);</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WEIYIGEEKHACKONE</span><br><span class="line">570045004900590049004700450045004b004800410043004b004f004e004500</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.将密码NTLM Hashes作为密匙将HMAC-MD5消息认证码算法应用于Unicode十六进制字符串(运用于User+Domain)得到16字节的NTLMv2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意这里都必须将Unicode转换Hex String获取的值才可以否则这将是个坑(怎么都复现不了)</span></span><br><span class="line">6061d067efff612ae4f1c704f1a44f08</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.连接质询消息的挑战Challenge与blob得到字符串</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a47b80ee3b16910e01010000000000009b09b1969ef7d50166ce6f7781f3d3670000000002001e004400450053004b0054004f0050002d004f004600510031004d0055004e0001001e004400450053004b0054004f0050002d004f004600510031004d0055004e0004001e004400450053004b0054004f0050002d004f004600510031004d0055004e0003001e004400450053004b0054004f0050002d004f004600510031004d0055004e00070008009b09b1969ef7d5010600040002000000080030003000000000000000000000000030000013b5d33a3c720a8cf7789ac2bfb7d9ef82d7d476d546a70be02087c0e11c979d0a001000000000000000000000000000000000000900200063006900660073002f003100390032002e003100360038002e0031002e003500000000000000000000000000</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.将上面的NTLMv2散列作为密匙，将HMAC-MD5消息认证码算法应用于此字符串(Blob值与Challenge)消息产生一个16字节的HASH输出值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">379a24c5f7fb068a140397f6ca2fd3d5</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200312010335.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200312010335.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<ul>
<li>4.将上步生成的Hash值与blob连接进行拼接形成NTLMv2响应:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">379a24c5f7fb068a140397f6ca2fd3d501010000000000009b09b1969ef7d50166ce6f7781f3d3670000000002001e004400450053004b0054004f0050002d004f004600510031004d0055004e0001001e004400450053004b0054004f0050002d004f004600510031004d0055004e0004001e004400450053004b0054004f0050002d004f004600510031004d0055004e0003001e004400450053004b0054004f0050002d004f004600510031004d0055004e00070008009b09b1969ef7d5010600040002000000080030003000000000000000000000000030000013b5d33a3c720a8cf7789ac2bfb7d9ef82d7d476d546a70be02087c0e11c979d0a001000000000000000000000000000000000000900200063006900660073002f003100390032002e003100360038002e0031002e003500000000000000000000000000</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>我们可以与下面NTLMv2协议抓包的Response进行对比:</p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200312010553.png" target="_blank" title="WeiyiGeek.Responses" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200312010553.png" alt="WeiyiGeek.Responses" title="" class=""></a>
                <p>WeiyiGeek.Responses</p>
            </figure>
<p><br></p>
<p>附录:小工具Console直接执行即可unicode转换:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">script.src = <span class="string">"https://nf404.github.io/crypto-api/crypto-api.js"</span>; <span class="comment">//支持HMAC-MD5但是仅仅传入的是字符串(而非Bytes);</span></span><br><span class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>].appendChild(script);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hostname=<span class="string">"HACKONE"</span>;</span><br><span class="line"><span class="keyword">var</span> username=<span class="string">"WeiyiGeek"</span>;</span><br><span class="line"><span class="keyword">var</span> ntlmhashes=<span class="string">"fc348d696833ec7ea33e121e8c41b69c"</span>;</span><br><span class="line"><span class="keyword">var</span> str = username.toUpperCase()+hostname;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringtoHex</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> uhex=<span class="string">''</span>;</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;str.length;i++)&#123;</span><br><span class="line">      uhex += str.charCodeAt(i).toString(<span class="number">16</span>)+<span class="string">"00"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uhex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(stringtoHex(str));</span><br></pre></td></tr></table></figure></p>
<hr>

<h4 id="0x06-LM-NTLM-C-R-协议分析"><a href="#0x06-LM-NTLM-C-R-协议分析" class="headerlink" title="0x06 LM/NTLM C/R 协议分析"></a>0x06 LM/NTLM C/R 协议分析</h4><h5 id="1-NTLMv1-C-R"><a href="#1-NTLMv1-C-R" class="headerlink" title="1.NTLMv1 C/R"></a>1.NTLMv1 C/R</h5><p>描述:自Windows Vista/Server2008开始，系统默认禁用Net-NTLMv1如果使用Net-NTLMv2仅修改客户端即可服务器不用修改;</p>
<p>修改注册表开启Net-NTLMv1:<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ /v lmcompatibilitylevel /t REG_DWORD /d <span class="number">0</span> /f</span><br></pre></td></tr></table></figure></p>
<p>以下采用协议抓的包进行简单的分析,同样采用smb关键字进行过滤<code>smb and ip.addr==192.168.199.210</code>,做个大概的说明其实与NTLMv2流程差别不大，仅仅是加密算法以及C/R位数不同（所以主要的还是看NTLMv2为主）;</p>
<p><br></p>
<p><strong>1) 协商消息示例</strong></p>
<p>NTLM Message Type: NTLMSSP_NEGOTIATE (0x00000001)</p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200312013207.png" target="_blank" title="WeiyiGeek.NTLMv1" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200312013207.png" alt="WeiyiGeek.NTLMv1" title="" class=""></a>
                <p>WeiyiGeek.NTLMv1</p>
            </figure>
<p><br></p>
<p><strong>2) 质询消息示例</strong><br>NTLM Message Type: NTLMSSP_CHALLENGE (0x00000002)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NTLM Server Challenge: f9c7fc816b991824</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200312013350.png" target="_blank" title="WeiyiGeek.NTLMv2" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200312013350.png" alt="WeiyiGeek.NTLMv2" title="" class=""></a>
                <p>WeiyiGeek.NTLMv2</p>
            </figure></p>
<p>备注:在许多的文章中都会说到NTLMv1生成的是8位的Challenge而NTLMv2生成的是16位的Challenge但是根据实际抓包的情况来看都是8Bytes(16位)的挑战;</p>
<p><br></p>
<p><strong>3) 身份验证消息示例</strong><br>NTLM Message Type: NTLMSSP_AUTH (0x00000003)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Lan Manager Response: c67ee888f6b41a4400000000000000000000000000000000  <span class="comment">#如果采用了NTLMv2版本LM Response全为0</span></span><br><span class="line">NTLM Response: 293b99da834c86c6e37c37a20920b41581be32740a5e062e</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200312014202.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200312014202.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure></p>
<p>备注:这里是区别采用是NTLMv1与NTLMv2版本进行认证的，值得注意一下;</p>
<p><br></p>
<h5 id="2-NTLMv2-C-R"><a href="#2-NTLMv2-C-R" class="headerlink" title="2.NTLMv2 C/R"></a>2.NTLMv2 C/R</h5><p>描述:NTLM响应由较新的客户端发送且NTLMv2为当前使用最为广泛的协议版本;</p>
<p>考虑到网络认证协议有多个版本以及现有的环境下面此处以NTLMv2为例进行实际分析<br>环境说明:<br>192.168.1.6 A客户端<br>192.168.1.5 B服务器</p>
<p><br></p>
<p><strong>1) 协商消息示例</strong><br>描述:协商消息从客户端发送到服务器以启动NTLM身份验证,其主要目的是通过FLAG指明支持的选项来建立认证的“基本规则”。(此处参考:来源3)</p>
<p>名称解释:</p>
<blockquote>
<p>NTLMSSP: Microsoft NTLM Security Support Provider;</p>
</blockquote>
<p><br></p>
<p>Wrieshark抓取协商消息数据包过滤条件(<code>smb2 and ip.addr==192.168.1.5</code>)，查找关键字段<code>NTLM Message Type: NTLMSSP_NEGOTIATE (0x00000001)</code></p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311210304.png" target="_blank" title="WeiyiGeek.协商消息数据包" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311210304.png" alt="WeiyiGeek.协商消息数据包" title="" class=""></a>
                <p>WeiyiGeek.协商消息数据包</p>
            </figure>
<p><br></p>
<p>协商消息示例(十六进制)：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4e544c4d53535000 -- NTLMSSP签名(不会变化)</span><br><span class="line">01000000 - NTLM消息类型1(谈判)</span><br><span class="line"></span><br><span class="line">mechToken: 4e544c4d5353500001000000978208e2000000000000000000000000000000000601b11d0000000f</span><br></pre></td></tr></table></figure></p>
<p>示例说明:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#茜さす大佬的Hex我确实对应不上不知道是系统版本问题还是抓包工具不同的原因(求解-有知道的大佬可以在下面留个言)</span></span><br><span class="line">4e544c4d53535000010000000732000006000600330000000b000b0028000000050093080000000f574f524b53544154494f4e444f4d41494e</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311205317.png" target="_blank" title="WeiyiGeek.分解" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311205317.png" alt="WeiyiGeek.分解" title="" class=""></a>
                <p>WeiyiGeek.分解</p>
            </figure></p>
<p><br></p>
<p><strong>2) 质询消息示例</strong><br>描述:质询消息由服务器发送到客户端以响应客户端的协商消息;它用于完成与客户的选择的谈判，并且向客户提供挑战,<code>它可以选择包含有关认证目标的信息</code>。</p>
<p>关键字段:<code>NTLM Message Type: NTLMSSP_CHALLENGE (0x00000002)</code><br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311211324.png" target="_blank" title="WeiyiGeek.质询消息数据库包" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311211324.png" alt="WeiyiGeek.质询消息数据库包" title="" class=""></a>
                <p>WeiyiGeek.质询消息数据库包</p>
            </figure></p>
<p>质询消息示例(主要参数):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">responseToken:</span><br><span class="line">0x4e544c4d535350000 -- NTLMSSP签名(不会变化)</span><br><span class="line">0x02000000 -- NTLM消息类型2(挑战)</span><br><span class="line">0x15828ae2 -- 谈判标志</span><br><span class="line">0x0a47b80ee3b16910e -- 服务器发的挑战</span><br><span class="line"></span><br><span class="line"><span class="comment">#Security Blob</span></span><br><span class="line">a182010b30820107a0030a0101a10c060a2b06010401823702020aa281f10481ee4e544c4d53535000020000001e001e003800000015828ae2a47b80ee3b16910e000000000000000098009800560000000a00ba470000000f4400450053004b0054004f0050002d004f004600510031004d0055004e0002001e004400450053004b0054004f0050002d004f004600510031004d0055004e0001001e004400450053004b0054004f0050002d004f004600510031004d0055004e0004001e004400450053004b0054004f0050002d004f004600510031004d0055004e0003001e004400450053004b0054004f0050002d004f004600510031004d0055004e00070008009b09b1969ef7d50100000000</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>3) 身份验证消息示例</strong><br>该消息包含客户端对上一步挑战的响应，这表明客户知道账户密码而不直接发送密码;并且还指示<code>身份验证目标（域或服务器名称）和身份验证帐户的用户名以及客户端工作站</code>名称。</p>
<p>关键字段:<code>NTLM Message Type: NTLMSSP_AUTH (0x00000003)</code>,此处根据<code>NTLMv2 Response</code>字段能判断出采用v2协议:<br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311213826.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311213826.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure></p>
<p><br></p>
<p>身份验证消息结构示例(主要参数):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">responseToken:</span><br><span class="line">4e544c4d53535000 -- NTLMSSP签名(不会变化)</span><br><span class="line">03000000 -- NTLM消息类型3(认证)</span><br><span class="line">000000000000000000000000000000000000000000000000 -- Lan Manager Response(对于老式系统认证使用)</span><br><span class="line">0000000000000000 -- NTLMv2 Client Challenge:</span><br><span class="line"></span><br><span class="line"><span class="comment">#NTLM Response / NTLMv2 Response</span></span><br><span class="line">379a24c5f7fb068a140397f6ca2fd3d501010000000000009b09b1969ef7d50166ce6f7781f3d3670000000002001e004400450053004b0054004f0050002d004f004600510031004d0055004e0001001e004400450053004b0054004f0050002d004f004600510031004d0055004e0004001e004400450053004b0054004f0050002d004f004600510031004d0055004e0003001e004400450053004b0054004f0050002d004f004600510031004d0055004e00070008009b09b1969ef7d5010600040002000000080030003000000000000000000000000030000013b5d33a3c720a8cf7789ac2bfb7d9ef82d7d476d546a70be02087c0e11c979d0a001000000000000000000000000000000000000900200063006900660073002f003100390032002e003100360038002e0031002e003500000000000000000000000000</span><br><span class="line"></span><br><span class="line">66ce6f7781f3d367 -- NTLMv2 Client Challenge</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311213357.png" target="_blank" title="WeiyiGeek.身份验证消息" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311213357.png" alt="WeiyiGeek.身份验证消息" title="" class=""></a>
                <p>WeiyiGeek.身份验证消息</p>
            </figure></p>
<p>从上面身份验证消息结构示例可以看到A客户端创建一个或多个挑战的响应，大概有六种类型的回应:</p>
<ul>
<li>1.LM（LAN Manager）响应 - 由大多数较早的客户端发送，这是“原始”响应类型。</li>
<li>2.NTLM 响应 - 这是由基于NT的客户端发送的，包括Windows 2000和XP。</li>
<li>3.NTLMv2 响应 - 在Windows NT Service Pack 4中引入的一种较新的响应类型。它替换启用了NTLM版本2的系统上的NTLM响应。</li>
<li>4.LMv2响应 - 替代NTLM版本2系统上的LM响应。</li>
<li>5.NTLM2会话响应 - 用于在没有NTLMv2身份验证的情况下协商NTLM2会话安全性时，此方案会更改LM和NTLM响应的语义。</li>
<li>5.匿名响应 - 当匿名上下文正在建立时使用; 没有提供实际的证书，也没有真正的身份验证。“存根”字段显示在类型3消息中。</li>
</ul>
<p><br></p>
<p><strong>4) 认证成功与失败示例</strong></p>
<figure class="image-box">
                <a rel=Windows认证原理解析基础入门 href="https://img.weiyigeek.top/2020/1/20200311222125.png" target="_blank" title="WeiyiGeek.Auth_Error" data-fancybox="images"><img src="https://img.weiyigeek.top/2020/1/20200311222125.png" alt="WeiyiGeek.Auth_Error" title="" class=""></a>
                <p>WeiyiGeek.Auth_Error</p>
            </figure>
<p><br></p>
<h4 id="0x07-学习总结"><a href="#0x07-学习总结" class="headerlink" title="0x07 学习总结"></a>0x07 学习总结</h4><p>描述:通过上面的学习以及加密原理的了解，可以针对于LM/NTLM有一个简单的入门了解，当我们在进行PTH攻击以及理解的时候是非常有用，并且有助于我们了解其他的Windows认证协议;</p>
<p><em>Net认证的Hash比较总结:</em></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>LM-Hashes</th>
<th>NTLMv1</th>
<th>NTLMv2</th>
</tr>
</thead>
<tbody>
<tr>
<td>密码区分大小写</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>散列密钥长度</td>
<td>56 bit + 56 bit(112)</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>密码散列算法</td>
<td>DES(mode=ECB)</td>
<td>MD4</td>
<td>MD4</td>
</tr>
<tr>
<td>散列值的长度</td>
<td>64+64=128bit</td>
<td>128 bit</td>
<td>128 bit</td>
</tr>
<tr>
<td>C/R 密钥长度</td>
<td>56bit + 56bit + 18bit</td>
<td>56bit + 56bit + 18bit</td>
<td>128 bit</td>
</tr>
<tr>
<td>C/R 算法</td>
<td>DES(mode=ECB)</td>
<td>DES(mode=ECB)</td>
<td>HMAC_MD5</td>
</tr>
<tr>
<td>C/R 长度</td>
<td>64bit + 64bit + 64bit</td>
<td>64bit + 64bit + 64bit</td>
<td>128 bit</td>
</tr>
</tbody>
</table>
<hr/>

<h4 id="0x08-参考来源"><a href="#0x08-参考来源" class="headerlink" title="0x08 参考来源"></a>0x08 参考来源</h4><p><strong>1) 参考资料</strong></p>
<ul>
<li>1.<a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-ntlm" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-ntlm</a></li>
<li>2.<a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos</a> </li>
<li>3.<a href="https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html" target="_blank" rel="noopener">https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html</a></li>
<li>4.<a href="https://www.insecurity.be/blog/2018/01/21/retrieving-ntlm-hashes-and-what-changed-technical-writeup/" target="_blank" rel="noopener">https://www.insecurity.be/blog/2018/01/21/retrieving-ntlm-hashes-and-what-changed-technical-writeup/</a></li>
<li>5.<a href="https://xz.aliyun.com/t/2445" target="_blank" rel="noopener">https://xz.aliyun.com/t/2445</a></li>
<li>6.<a href="https://3gstudent.github.io/3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-Net-NTLMv1%E4%BB%8B%E7%BB%8D/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-Net-NTLMv1%E4%BB%8B%E7%BB%8D/</a></li>
</ul>
<p><br></p>
<p><strong>2) 文中工具</strong></p>
<ul>
<li>1.进程内存数据提取:<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump</a></li>
<li>2.MD4加密:<a href="https://nf404.github.io/crypto-api/crypto-api.min.js" target="_blank" rel="noopener">https://nf404.github.io/crypto-api/crypto-api.min.js</a></li>
<li>3.DEC编码加密:<a href="http://www.slavasoft.com/hashcalc/" target="_blank" rel="noopener">http://www.slavasoft.com/hashcalc/</a></li>
<li>4.JS之MD4加密编码算法:<a href="https://www.iteye.com/blog/neil-yang-703462" target="_blank" rel="noopener">https://www.iteye.com/blog/neil-yang-703462</a></li>
<li>5.LM-NTLM脚本: <a href="https://xz.aliyun.com/t/2445" target="_blank" rel="noopener">https://xz.aliyun.com/t/2445</a></li>
<li>6.Hashcat-Hashes破解格式:<a href="https://hashcat.net/wiki/doku.php?id=example_hashes" target="_blank" rel="noopener">https://hashcat.net/wiki/doku.php?id=example_hashes</a></li>
<li>7.自己: <a href="https://github.com/WeiyiGeek/SecOpsDev/tree/master/Cryption/DES/Python" target="_blank" rel="noopener">https://github.com/WeiyiGeek/SecOpsDev/tree/master/Cryption/DES/Python</a></li>
</ul>

        </div>
        
        <!-- Google 广告 -->
          

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2023-01-31T02:29:10.676Z" itemprop="dateUpdated">2023-01-31 10:29:10</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/基础知识/操作系统/Windows底层/Windows认证原理解析基础入门.md" target="_blank" rel="noopener noreferrer">_posts/基础知识/操作系统/Windows底层/Windows认证原理解析基础入门.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2020/3-6-20.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/3-6-20.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%8F%E8%AE%AE/" rel="tag">协议</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/3-6-20.html&title=《Windows认证原理解析基础入门》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/3-6-20.html&title=《Windows认证原理解析基础入门》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/3-6-20.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Windows认证原理解析基础入门》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/3-6-20.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/3-6-20.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/3-7-305.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">JSP开发简单实例演示</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/3-3-212.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Linux发行版和容器镜像网站及开源软件收集</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x01-前言简介"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x01 前言简介</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-基本介绍"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x02 基本介绍</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x03-LM-NTLM-版本优缺"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x03 LM&#x2F;NTLM 版本优缺</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x04-LM-NTLM-生成原理"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x04 LM&#x2F;NTLM 生成原理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x05-LM-NTLM-挑战和响应机制原理"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x05 LM&#x2F;NTLM 挑战和响应机制原理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x06-LM-NTLM-C-R-协议分析"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x06 LM&#x2F;NTLM C&#x2F;R 协议分析</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x07-学习总结"><span class="post-toc-number">7.</span> <span class="post-toc-text">0x07 学习总结</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x08-参考来源"><span class="post-toc-number">8.</span> <span class="post-toc-text">0x08 参考来源</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    

    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="/img/share-wechat.jpg" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">博主Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">博主Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">墨天轮</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">西瓜视频</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2023 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/3-6-20.html&title=《Windows认证原理解析基础入门》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/3-6-20.html&title=《Windows认证原理解析基础入门》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/3-6-20.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Windows认证原理解析基础入门》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/3-6-20.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/3-6-20.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACIUlEQVR42u3a247CMAwFQP7/p7vSvu62HNsFqcn0CUFFM0Ey8eX1iq/j9zp75+/rv/effXqcXK9PXBgYGI9lHJdXsujkO5MnXm/KGyoGBsYGjOsgmywliYTJU/JtwsDAwEgeMAnQve3DwMDAyNPUPLDmaepX/zcwMDAeyEgCaL6Uaqnuq7k4BgbGAxnVxsA3X3+wv4GBgfEQxtG6ooNaMaCP1oOBgbE0Iync5+3JyUInCS0GBsbajE+ki8n91QD9BomBgbE0o/oV+WhFftTLy3CFzcLAwFiO0RuhyMcjqu3P3vZhYGDsw5g87K42QJL6YmBg7MNoDmAVS2/zY+j1XwIGBsYOjLxANhkIu62PcVY1xMDA2IaRBM3ePb2EOTpQYmBgLM2oppe9xmRSvOsF/X9+EwwMjOUYeZJZTixbB8cmFQMDY0tG78DXa3necLrDwMDYjJEPsFaHvapjYYWNxsDAWJoxCX/VUdRJWzRqjmJgYGzASMLiJLBW09Q83GNgYOzGyN+pjoXlYT0Jx+XqIAYGxkKM6rjDXUfAyYgYBgbGDozqg6ukSeMzXwMGBsaqjHvTzvzT+eAFBgbGPozJWWs+YNEb6cDAwNiTUQ2yk0GuZP/yUY/y9AcGBsbDGb0l5qWxeRHtDQ8DAwPj1td52L3+S8DAwMDoFfcnhbNR5o2BgbEBo7qganG/1wzAwMDAmDQGqi3MuxbdG9HAwMB4LOMH6dlLqXLWPyQAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  





<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// 站点运行时间
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "天" + RunHours + "时" + RunMinutes + "分" + RunSeconds + "秒";
  document.getElementById(id).innerHTML = "网站已在风雨中勉勉强强运行了【" + RunTime + "】";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>