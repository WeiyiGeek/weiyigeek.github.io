{"title":"域控安全基础.md","slug":"网安防御/Win安全与防御/域控安全/域控安全基础","date":"2019-04-10T07:36:30.000Z","updated":"2023-01-31T02:29:10.669Z","url":"2019/4-10-433.html","path":"api/articles/2019/4-10-433.html.json","covers":["https://img.weiyigeek.top/2019/20190410085516.png","https://img.weiyigeek.top/2019/20190410192401.png","https://img.weiyigeek.top/2019/20190428213342.png","https://img.weiyigeek.top/2019/20190428213148.png"],"content":"<p>[TOC]<br><b style=\"color:red\">注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。</b><br><a id=\"more\"></a></p>\n<p>如果做过大型服务器的windows运维的朋友可能会了解到域控,使用它方便我们对域内主机的进行安全统一的管理;(想要更深入了解请百度百科)</p>\n<p>AD的基础概念:</p>\n<ol>\n<li>AD是微软实现的目录服务,基于X.500工作在应用层,AD使用”Kerberos”认证用户以及使用LDAP来递归目录信息</li>\n<li>DC控制所有用户,用户信息,计算机,以及策略.主要工作就是认证用户</li>\n<li>在AD中所有网络资源都叫对象(Object),包括计算机,用户,打印机等等</li>\n<li>域(Domain)是安全的边界.域内的对象可以彼此共享数据,所有对象的信息存储在DC中(ntds.dit)</li>\n<li>Domain 域 -&gt;tree 树-&gt;Forest 森林 </li>\n</ol>\n<p><em>注意：</em> 下面都是win系统自带的命令,有的时候windows Server 版本不同，有的命令会不存在，所以多一种方法多一种成功的可能性，实际渗透自行根据目标环境变换;</p>\n<p>学习参考：<a href=\"https://pentestlab.blog/tag/ntds-dit/\" target=\"_blank\" rel=\"noopener\">https://pentestlab.blog/tag/ntds-dit/</a><br><a href=\"http://carnal0wnage.attackresearch.com/2015/12/more-with-smbclient-smbget-enum4linux.html\" target=\"_blank\" rel=\"noopener\">http://carnal0wnage.attackresearch.com/2015/12/more-with-smbclient-smbget-enum4linux.html</a></p>\n<h4 id=\"0x00-域信息收集\"><a href=\"#0x00-域信息收集\" class=\"headerlink\" title=\"0x00 域信息收集\"></a>0x00 域信息收集</h4><h5 id=\"1-判断域\"><a href=\"#1-判断域\" class=\"headerlink\" title=\"1.判断域\"></a>1.判断域</h5><p>首先要判断所控主机是否在域内:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net share  <span class=\"comment\">#查看是否存在syslog</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> <span class=\"built_in\">log</span>    <span class=\"comment\">#判断当前登陆服务器 LOGONSERVER=\\\\DESKTOP-OVF3TEN</span></span><br><span class=\"line\">net time /domain        <span class=\"comment\">#存在域不确定，但当前用户不是域用户 存在域，且当前用户是域用户会从域控返回当前时间</span></span><br><span class=\"line\">net config workstation  <span class=\"comment\">#查看是否有域</span></span><br><span class=\"line\">systeminfo              <span class=\"comment\">#域及登陆服务器项</span></span><br><span class=\"line\">ipconfig /all           <span class=\"comment\">#注意DNS是否是内网的地址</span></span><br><span class=\"line\">netsh interface ipv4 show dnsservers   <span class=\"comment\">#也可以在本地连接中查看(效果同上)</span></span><br><span class=\"line\">servermanagercmd -query    <span class=\"comment\">##server中查看是不是安装域控制器 </span></span><br><span class=\"line\"><span class=\"comment\">##转移架构主机角色</span></span><br><span class=\"line\">    依次单击开始和运行，在打开框中键入 mmc，然后单击确定。</span><br><span class=\"line\">    在文件菜单上，单击“添加/删除管理单元”。</span><br><span class=\"line\">    单击添加。</span><br><span class=\"line\">    依次单击 Active Directory 架构、添加、关闭和确定。</span><br><span class=\"line\">    在控制台树中，右键单击 Active Directory 架构，然后单击更改域控制器。</span><br><span class=\"line\">    单击指定名称，键入将成为新角色持有者的域控制器名称，然后单击确定。</span><br><span class=\"line\">    在控制台树中，右键单击 Active Directory 架构，然后单击操作主机。</span><br><span class=\"line\">    单击更改。</span><br><span class=\"line\">    单击确定以确认您要转移该角色，然后单击关闭。</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190410085516.png\" alt=\"WeiyiGeek.workstation\" title=\"\" class=\"\">\n                <p>WeiyiGeek.workstation</p>\n            </figure></p>\n<p><br></p>\n<h5 id=\"2-域信息\"><a href=\"#2-域信息\" class=\"headerlink\" title=\"2.域信息\"></a>2.域信息</h5><p>判断存在域后通过以下操作进行域内信息搜集<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#我们拿到机器权限的时候有两种可能: 本地用户与域用户</span></span><br><span class=\"line\">&gt; whoami</span><br><span class=\"line\">win-03\\administrator   <span class=\"comment\">#本地用户 不能直接提升为 ntauthority\\system，SYSTEM用户权限(受到域管理)</span></span><br><span class=\"line\">WeiyiGeek\\administator  <span class=\"comment\">#域用户</span></span><br><span class=\"line\"><span class=\"comment\">##注意：</span></span><br><span class=\"line\">1. 本质上所有查询都是通过ldap协议去域控制器上查询,但是查询需要经过权限认证,只有域用户才有这个权限。</span><br><span class=\"line\">2. 当域用户运行查询命令时，会自动使用kerberos协议认证，无需额外输入账号密码。</span><br><span class=\"line\">3. SYSTEM用户的情况比较特殊，在域中除了普通用户外，所有机器都有一个机器用户，用户名是机器名后加$，本质上机器上的SYSTEM用户对应的就是域里面的机器用户，所以SYSTEM权限是可以运行查询命令的;(最高权限的存在)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; net view /domain    <span class=\"comment\">#查看有几个域</span></span><br><span class=\"line\">&gt; net user /domain      <span class=\"comment\">#查看域用户 常常存在krbtgt用户</span></span><br><span class=\"line\">&gt; net view /domain:XXX   <span class=\"comment\">#查看此域内电脑</span></span><br><span class=\"line\">&gt; net group /domain       <span class=\"comment\">#查看是不是存在域组账户</span></span><br><span class=\"line\">&gt; net group <span class=\"string\">\"domain computers\"</span> /domain <span class=\"comment\">#查看加入到域内的所有计算机名</span></span><br><span class=\"line\">&gt; net group <span class=\"string\">\"domain admins\"</span> /domain  <span class=\"comment\">#查看管理员登陆时间，密码过期时间，是否有登陆脚本，组分配等信息</span></span><br><span class=\"line\">&gt; net group <span class=\"string\">\"domain controllers\"</span> /domain <span class=\"comment\"># 查看域控制器 (注意通过该指令得到的机器名后面会多一个$符号)</span></span><br><span class=\"line\">&gt; net user zhangsan /domain       <span class=\"comment\">#获得指定账户的详细信息</span></span><br><span class=\"line\">&gt; net accounts /domain  <span class=\"comment\">#获得域密码策略设置/密码长短/错误锁定等信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; nslookup -<span class=\"built_in\">type</span>=SRV _ldap._tcp.corp  <span class=\"comment\">##通过srv记录</span></span><br><span class=\"line\">  Server: dj0116w-dc03.motor.csr.com</span><br><span class=\"line\">  Address: 10.169.0.36</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在域中时定位域控</span></span><br><span class=\"line\">&gt; nltest /dsgetdc:域名      <span class=\"comment\"># 定位域控</span></span><br><span class=\"line\">&gt; nltest /dclist:domain<span class=\"_\">-a</span>  <span class=\"comment\">#或者使用dc列表其中pdc是主域控</span></span><br><span class=\"line\">&gt; nltest /domain_trusts  可以列出域之间的信任关系</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; dsquery server         <span class=\"comment\">#得到域控制器的IP：</span></span><br><span class=\"line\">&gt; dsQuery Server -domain corp  <span class=\"comment\">##使用dsquery查询 </span></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; netdom query pdc  <span class=\"comment\">##使用netdom查询</span></span><br><span class=\"line\"><span class=\"comment\">#返回的信息</span></span><br><span class=\"line\">  Primary domain controller <span class=\"keyword\">for</span> the domain:</span><br><span class=\"line\">  DJ0116W-DC01</span><br><span class=\"line\">  The <span class=\"built_in\">command</span> completed successfully.</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190410192401.png\" alt=\"WeiyiGeek.dsquery-server\" title=\"\" class=\"\">\n                <p>WeiyiGeek.dsquery-server</p>\n            </figure></p>\n<p><br></p>\n<h5 id=\"3-域控连接\"><a href=\"#3-域控连接\" class=\"headerlink\" title=\"3.域控连接\"></a>3.域控连接</h5><p>IPC$的正确连接姿势:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Windows</span></span><br><span class=\"line\">net use \\\\172.31.4.212\\ipc$ “password<span class=\"string\">\" /user:corp.pentest.lab\\administrator</span></span><br><span class=\"line\"><span class=\"string\">net use \\\\172.31.4.212\\ipc$ “password\"</span> /user:administrator</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Linux</span></span><br><span class=\"line\">sudo apt install smbclient</span><br><span class=\"line\">$ smbclient -L 172.31.4.212 -U administrator</span><br><span class=\"line\">$ smbclient \\\\\\\\172.31.4.212\\\\C$ -U administrator</span><br><span class=\"line\">$ smbclient -L 172.31.4.212 -U corp.pentest.lab/administrator</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#命令参考</span></span><br><span class=\"line\">http://carnal0wnage.attackresearch.com/2015/12/more-with-smbclient-smbget-enum4linux.html</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ rpcclient -U corp.pentest.lab/administrator 172.31.4.212</span><br><span class=\"line\">rpcclient $&gt; enumdomusers</span><br><span class=\"line\">user:[Administrator] rid:[0x1f4]</span><br><span class=\"line\">user:[Guest] rid:[0x1f5]</span><br><span class=\"line\">user:[krbtgt] rid:[0x1f6]</span><br><span class=\"line\">user:[employeeA] rid:[0x454]</span><br><span class=\"line\">rpcclient $&gt; queryuser 0x1f4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#命令参考</span></span><br><span class=\"line\">https://bitvijays.github.io/LFF-IPS-P3-Exploitation.html<span class=\"comment\">#active-directory-reconnaissance</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在OSX上找DC的方法(当前机器已经加入了DOMAIN)</span></span><br><span class=\"line\">dsconfigad -show | awk <span class=\"string\">'/Active Directory Domain/&#123;print $NF&#125;'</span></span><br><span class=\"line\">corp.pentest.lab</span><br><span class=\"line\"></span><br><span class=\"line\">$ host -av _ldap._tcp.corp.pentest.lab</span><br><span class=\"line\">dc-CN-02.corp.pentest.lab. 384\tIN\tA\t172.1.0.201</span><br><span class=\"line\">dc-CN-01.corp.pentest.lab. 780\tIN\tA\t172.1.227.69</span><br><span class=\"line\">dc-APCN-02.acorp.pentest.lab. 691\tIN\tA\t172.1.227.12</span><br><span class=\"line\"></span><br><span class=\"line\">一键导出当前域的所有用户信息</span><br><span class=\"line\">$ ldapsearch -h 172.31.4.212 -p 389 -x -b <span class=\"string\">\"cn=sers,dc=corp,dc=pentest,dc=lab\"</span> -W -D administrator</span><br><span class=\"line\">Enter LDAP Password: </span><br><span class=\"line\">对于用户多的域环境,慎用该命令,输出文件会非常大*</span><br><span class=\"line\"></span><br><span class=\"line\">执行AD远程帐号破解时,了解账户策略很重要</span><br><span class=\"line\">配置AD帐号策略以及AD远程帐号破解</span><br><span class=\"line\">C:\\Users\\Administrator&gt;net accounts /domain</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"4-域安全\"><a href=\"#4-域安全\" class=\"headerlink\" title=\"4.域安全\"></a>4.域安全</h5><p>Runas /netonly 妙用蜜罐来防止域控被攻击并进行预警：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\&gt;runas /netonly /user:corp.pentest.lab\\administrator cmd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#建立蜜罐账户和Mimikatz的使用</span></span><br><span class=\"line\">runas /netonly /user:corp.pentest.lab\\honeypot cmd</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190428213342.png\" alt=\"WeiyiGeek.蜜罐\" title=\"\" class=\"\">\n                <p>WeiyiGeek.蜜罐</p>\n            </figure></p>\n<p>使用runas得好处:</p>\n<ol>\n<li>可以在一台机器上产生多个用户上下文的CMD窗口</li>\n<li>只有在有网络连接的时候才产生身份CHECK</li>\n<li>在加入域和没加入域的主机上都可以运行</li>\n<li>通过设置蜜罐用户和登录日志排查,可以检测当前网络是否有人运行了类似Mimikatz的工具DUMP了用户的HASH<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190428213148.png\" alt=\"WeiyiGeek.runas\" title=\"\" class=\"\">\n                <p>WeiyiGeek.runas</p>\n            </figure>\n</li>\n</ol>\n<h4 id=\"0x01-学习参考网站-Reference\"><a href=\"#0x01-学习参考网站-Reference\" class=\"headerlink\" title=\"0x01 学习参考网站(Reference)\"></a>0x01 学习参考网站(Reference)</h4><p><a href=\"https://adsecurity.org/\" target=\"_blank\" rel=\"noopener\">https://adsecurity.org/</a><br><a href=\"https://attack.mitre.org/\" target=\"_blank\" rel=\"noopener\">https://attack.mitre.org/</a><br><a href=\"https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections\" target=\"_blank\" rel=\"noopener\">https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections</a></p>\n","comments":true,"excerpt":"[TOC]<br>注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。<br>","categories":[{"name":"Windows","path":"api/categories/Windows.json"},{"name":"Security","path":"api/categories/Security.json"}],"tags":[{"name":"内网渗透","path":"api/tags/内网渗透.json"},{"name":"域控","path":"api/tags/域控.json"}]}