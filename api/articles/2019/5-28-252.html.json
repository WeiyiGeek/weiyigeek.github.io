{"title":"Win系统安装部署流程与工具","slug":"系统运维/Windows/系统安装/Win系统安装部署流程与工具","date":"2019-05-28T04:34:30.000Z","updated":"2023-01-31T02:29:10.468Z","url":"2019/5-28-252.html","path":"api/articles/2019/5-28-252.html.json","covers":["https://img.weiyigeek.top/2019/20190530104158.png","https://img.weiyigeek.top/2019/20190530104504.png","https://img.weiyigeek.top/2019/20190530102128.png","https://img.weiyigeek.top/2019/20190530102613.png","https://img.weiyigeek.top/2019/20190530103114.png","https://img.weiyigeek.top/2019/20190530103334.png","https://img.weiyigeek.top/2019/20190530151410.png","https://img.weiyigeek.top/2019/20190530153803.png","https://img.weiyigeek.top/2019/20190530153917.png","https://img.weiyigeek.top/2019/20190530154731.png","https://img.weiyigeek.top/2019/20190530170306.png","https://img.weiyigeek.top/2019/20190530155003.png","https://img.weiyigeek.top/2019/20190530155228.png","https://img.weiyigeek.top/2019/20190530155358.png","https://img.weiyigeek.top/2019/20190530171917.png","https://img.weiyigeek.top/2019/20190530165718.png","https://img.weiyigeek.top/2019/20190530171917.png","https://img.weiyigeek.top/2019/20190530172200.png","https://img.weiyigeek.top/2019/20190530172336.png","https://img.weiyigeek.top/2019/20190711103346.png","https://img.weiyigeek.top/2019/20190711103353.png","https://img.weiyigeek.top/2019/20190711103851.png","https://img.weiyigeek.top/2019/20190530171518.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-WDS-Win部署服务\"><a href=\"#0x00-WDS-Win部署服务\" class=\"headerlink\" title=\"0x00 WDS|Win部署服务\"></a>0x00 WDS|Win部署服务</h4><p>描述：Windows Deployment Service即windows部署服务,我们可以通过windows server自带的部署服务通过网络将操作系统部署到每台计算机上，并且可以通过WDS来管理多版本映像以及无人参与安装脚本，和网刻非常相似不过这个更简单操作更方便</p>\n<p><strong>Q：什么是PXE？:</strong><br>答：PXE(preboot execute environment-预启动执行环境)是由Intel公司开发的最新技术，工作于Client/Server的网络模式，支持工作站通过网络从远端服务器下载映像，并由此支持通过网络启动操作系统，在启动过程中终端要求服务器分配IP地址，再用TFTP（trivial file transfer protocol）或MTFTP(multicast trivial file transfer protocol)协议下载一个启动软件包到本机内存中执行，由这个启动软件包完成终端（客户端）基本软件设置，从而引导预先安装在服务器中的终端操作系统。</p>\n<p><em>环境配置：</em><br>虚拟机：Virtualbox<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Windows servers 2016：</span></span><br><span class=\"line\">2张网卡(外网/内网) ：</span><br><span class=\"line\">- NAT 模式：可以上外网 (DHCP)</span><br><span class=\"line\">- INTERNAL 模式：连接虚拟机之间通信 (IP：192.168.1.1/网关：192.168.1.254)</span><br><span class=\"line\"></span><br><span class=\"line\">添加一块SATA控制器的磁盘格式为NTFS</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#角色基础功能安装WDS/DHCP作用域</span></span><br><span class=\"line\">配置DHCP地址池：</span><br><span class=\"line\">192.168.1.1~192.168.1.100</span><br><span class=\"line\">占用不使用：</span><br><span class=\"line\">192.168.1.1~192.168.1.10</span><br><span class=\"line\">路由器网关：</span><br><span class=\"line\">192.168.1.254 </span><br><span class=\"line\"><span class=\"comment\">#其他的默认下一步即可</span></span><br></pre></td></tr></table></figure></p>\n<p><em>配置流程</em>：</p>\n<ul>\n<li>配置基础环境比如网卡以及INTERNAL模式网卡IP</li>\n<li>联机磁盘并进行格式化分区(注意分区格式:NTFS)</li>\n<li>在服务器管理器中添加角色选择[DHCP服务]和[Windows部署服务]</li>\n<li>配置DHCP服务建立作用域,重启服务;</li>\n<li>配置WINDOWS部署服务进行配置服务器参数,导入映像文件与启动文件</li>\n<li>配置WINDOWS部署服务的启动项、DHCP、多播等参数,最后启动部署服务;</li>\n<li>新建立一台虚拟机从网络启动并且会向DHCP服务器发起请求获取租用IP,然后向WDS服务器发起请求进行拉取启动镜像,最后完成安装;</li>\n</ul>\n<p><br/></p>\n<h5 id=\"1-磁盘分区格式化\"><a href=\"#1-磁盘分区格式化\" class=\"headerlink\" title=\"1. 磁盘分区格式化\"></a>1. 磁盘分区格式化</h5><p>我们在运行中执行磁盘管理工具diskmgmt.msc，之后将我们添加的磁盘进行联机然后初始化,新建简单卷进行向导即可(注意分区格式:NTFS)<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530104158.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>修改完成后格式化分区：<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530104504.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br/></p>\n<h5 id=\"2-搭建WDS环境与配置\"><a href=\"#2-搭建WDS环境与配置\" class=\"headerlink\" title=\"2. 搭建WDS环境与配置\"></a>2. 搭建WDS环境与配置</h5><p><em>Step1. 安装Windows部署工具：</em></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530102128.png\" alt=\"WeiyiGeek.服务器管理器-仪表盘\" title=\"\" class=\"\">\n                <p>WeiyiGeek.服务器管理器-仪表盘</p>\n            </figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安装类型：基于角色或者功能的安装</span><br><span class=\"line\">服务器选择：从服务器此中选择服务器(即：WindowsServers本身)</span><br><span class=\"line\">服务器角色：选中Windows部署服务/DHCP服务器</span><br><span class=\"line\">功能/WDS/角色服务:默认即可,确认安装</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530102613.png\" alt=\"WeiyiGeek.安装\" title=\"\" class=\"\">\n                <p>WeiyiGeek.安装</p>\n            </figure>\n<p><br></p>\n<p><em>Step 2. 安装成功后打开windows部署工具：</em><br>注意：此处有坑需要在WDS中选择windows部署工具：</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530103114.png\" alt=\"WeiyiGeek.打开部署工具\" title=\"\" class=\"\">\n                <p>WeiyiGeek.打开部署工具</p>\n            </figure>\n<p>1) 右键选择服务-配置服务器-选择【独立服务】以及【响应所有客户端计算机】完成Windows部署服务的配置。</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530103334.png\" alt=\"WeiyiGeek.选择独立服务\" title=\"\" class=\"\">\n                <p>WeiyiGeek.选择独立服务</p>\n            </figure>\n<p>2) 按照提示设置远程安装文件的位置(需要注意是单独的磁盘不能是在系统分区内),需要您进行建立文件夹 mkdir E:\\RemoteInstall;<br>3) 配置代理DHCP的DHCP选项：选择最后一项即可<br>4) PXE服务器初始设置：选择响应所有的客户端机器（已知未知）下一步进行部署安装</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530151410.png\" alt=\"WeiyiGeek.windows部署安装\" title=\"\" class=\"\">\n                <p>WeiyiGeek.windows部署安装</p>\n            </figure>\n<p><br></p>\n<p><em>Step 3. 载入镜像进行配置</em><br>1) 为了加快速度建议把镜像文件上传到服务器里,并且将要安装的系统加载到光驱;<br>2) 在 [Windows部署服务] 进行添加安装映像，光盘中的source目录中install.wim就是安装映像了</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530153803.png\" alt=\"WeiyiGeek.添加映像文件\" title=\"\" class=\"\">\n                <p>WeiyiGeek.添加映像文件</p>\n            </figure>\n<p>3) 现在需要安装的版本名称比如专业版/家庭版/企业版(使用过dism朋友应该知道),然后下一步、等待加载映像即可;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530153917.png\" alt=\"WeiyiGeek.选择安装版本\" title=\"\" class=\"\">\n                <p>WeiyiGeek.选择安装版本</p>\n            </figure>\n<p>4) 加载完成后就能看见我们的镜像文件,然后我们需要配置启动映像soutce目录下的boot是启动映像(win10的启动映像有网卡驱动)</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530154731.png\" alt=\"WeiyiGeek.启动映像\" title=\"\" class=\"\">\n                <p>WeiyiGeek.启动映像</p>\n            </figure>\n<p>5) 当然如果是我们自己封装的ISO镜像,还可能要进行配置驱动程序包<br><br></p>\n<p><em>Step 4. DHCP/WDS参数配置</em><br>这里主要进行配置服务器的启动项、DHCP、多播等参数<br>0) DHCP 设置作用域：<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530170306.png\" alt=\"WeiyiGeek.DHCP作用域\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DHCP作用域</p>\n            </figure></p>\n<p>1) 右击【Windows部署服务器】在弹出的对话框中单击【属性】按钮-选择启动项<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530155003.png\" alt=\"WeiyiGeek.设置启动项\" title=\"\" class=\"\">\n                <p>WeiyiGeek.设置启动项</p>\n            </figure></p>\n<p>2) DHCP配置：如果是dhcp在一台服务器上就需要勾选(配置DHCP选项-其实我们上面都已经配置过了),否则不勾选；然后再配置多播IP地址从DHCP服务获取IP地址;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530155228.png\" alt=\"WeiyiGeek.多播IP地址\" title=\"\" class=\"\">\n                <p>WeiyiGeek.多播IP地址</p>\n            </figure>\n<p>3) 最后启用WIndows部署服务<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530155358.png\" alt=\"WeiyiGeek.启用部署服务\" title=\"\" class=\"\">\n                <p>WeiyiGeek.启用部署服务</p>\n            </figure></p>\n<p><br></p>\n<p><em>Step 5.安装测试</em><br>1) 新建立一台虚拟机或者一台物理机,通过交换机连接保证在同一局域网内,使用virtualBox和VM的需要注意选择网络类型（自行百度-只要能相互通信即可）;<br>2) 建议启用安装前将Windows防火墙进行关闭;<br>3) 然后设置从网络/pxe机器启动即可,从下面可以看见连接到DHCPPROXY中分配的IP地址;</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530171917.png\" alt=\"WeiyiGeek.DHCP\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DHCP</p>\n            </figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530165718.png\" alt=\"WeiyiGeek.DHCP\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DHCP</p>\n            </figure>\n<p>4) 获取到DHCP响应后进行拉取boot.wim映像文件</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530171917.png\" alt=\"WeiyiGeek.启动从WDS服务器拉取镜像\" title=\"\" class=\"\">\n                <p>WeiyiGeek.启动从WDS服务器拉取镜像</p>\n            </figure>\n<p>5) 需要使用WDS账号密码进行登录拉取install.wim映像文件</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530172200.png\" alt=\"WeiyiGeek.登录WDS\" title=\"\" class=\"\">\n                <p>WeiyiGeek.登录WDS</p>\n            </figure>\n<p>6) 输入完成后进行系统安装,到此完成批量系统安装(启动一台安装一台)</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530172336.png\" alt=\"WeiyiGeek.安装系统\" title=\"\" class=\"\">\n                <p>WeiyiGeek.安装系统</p>\n            </figure>\n<p><br></p>\n<h5 id=\"3-安装ghost镜像系统\"><a href=\"#3-安装ghost镜像系统\" class=\"headerlink\" title=\"3. 安装ghost镜像系统\"></a>3. 安装ghost镜像系统</h5><p>描述：同样可以利用此方法来安装Ghost系统镜像,此种方法前提最好是磁盘已经分区;<br>环境准备：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">windows 2016 server <span class=\"comment\">#上面的环境（还需开启共享服务即smb服务）</span></span><br><span class=\"line\">windows10PE - 参考[COBBLER批量安装Windows系统] 中的映像制作</span><br><span class=\"line\">windows10的ghost系统镜像 windows10.gho</span><br><span class=\"line\">x64位的Symantec Ghost.exe</span><br></pre></td></tr></table></figure></p>\n<p>项目流程步骤：</p>\n<ul>\n<li>配置好基础环境(smb/wds/dhcp),将windows10PE中的boot.wim导入到WDS中启动镜像中（只需要这个）</li>\n<li>将需要安装系统的电脑连接到同一局域网（即同一交换机上）,在bios上配置PXE启动;</li>\n<li>进入OOBE界面后出现cmd.EXE命令执行窗口,并且会利用winpe.bat来启动startnet.cmd脚本</li>\n<li>连接到我们smb服务上执行ghost.exe选择ghost映像安装即可;</li>\n<li>如果磁盘未分区采用ghost即可分区 <code>Local -&gt; Disk &gt; From Image</code> , 然后选择ghost镜像文件</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190711103346.png\" alt=\"WeiyiGeek.diskfromimage\" title=\"\" class=\"\">\n                <p>WeiyiGeek.diskfromimage</p>\n            </figure>\n<ul>\n<li>之后回询问您是选择GPT分区还是MBR分区。Y = GPT / N = MBR</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190711103353.png\" alt=\"WeiyiGeek.选择分区\" title=\"\" class=\"\">\n                <p>WeiyiGeek.选择分区</p>\n            </figure>\n<ul>\n<li>调整磁盘分区大小，类似于 DiskGenius.exe 工具</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190711103851.png\" alt=\"WeiyiGeek.调整磁盘分区大小\" title=\"\" class=\"\">\n                <p>WeiyiGeek.调整磁盘分区大小</p>\n            </figure>\n<p>总结：</p>\n<ul>\n<li>建议机器/交换机是千兆的网卡(全双工),如果是百兆的建议您还是手动比较好;</li>\n</ul>\n<p><br></p>\n<h5 id=\"4-PE启动配置\"><a href=\"#4-PE启动配置\" class=\"headerlink\" title=\"4. PE启动配置\"></a>4. PE启动配置</h5><p>描述:我们可以采用WDS加载PE镜像中的wim文件,方便我们以网络的方式启动PE极大的节约我们的时刻;</p>\n<p>操作流程:</p>\n<ul>\n<li>1.提取PE镜像ISO文件中的WIM文件:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 例如</span></span><br><span class=\"line\">/WEPE/WEPE64.WIM</span><br><span class=\"line\">/BOOT/10PEx64.wim</span><br></pre></td></tr></table></figure></li>\n<li>2.将提取出的文件上传到WDS中启动映像中(具体流程详见上面)</li>\n</ul>\n<p><br></p>\n<h5 id=\"5-深坑\"><a href=\"#5-深坑\" class=\"headerlink\" title=\"5. 深坑\"></a>5. 深坑</h5><p><strong>建议1：DHCP服务器与网络模式</strong><br>答：配置DHCP服务器的时候需要注意虚拟机网卡模式,最好设置为只有虚拟机之间才能相互通信的网卡模式并且关闭该模式的DHCP分配服务,因为同一个段不允许有两台DHCP服务器,会发生错误</p>\n<p><br></p>\n<p><strong>建议2：服务搭建过程排查错误</strong></p>\n<p>可以参考服务管理器中事件提示：<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190530171518.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"OperationTools","path":"api/categories/OperationTools.json"},{"name":"Systeminstall","path":"api/categories/Systeminstall.json"}],"tags":[{"name":"Windows","path":"api/tags/Windows.json"}]}