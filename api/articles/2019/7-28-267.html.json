{"title":"Ansible自动化运维学习笔记2","slug":"系统运维/自动化运维/Ansible/Ansible自动化运维学习笔记2","date":"2019-07-28T06:34:30.000Z","updated":"2022-03-29T05:39:06.298Z","url":"2019/7-28-267.html","path":"api/articles/2019/7-28-267.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729164637.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190730093410.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190730144557.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x04-variable变量\"><a href=\"#0x04-variable变量\" class=\"headerlink\" title=\"0x04 variable变量\"></a>0x04 variable变量</h4><p>前言：在ansible中使用变量，能让我们的工作变得更加灵活，在ansible中变量的使用方式有很多种</p>\n<p><em>ansible变量规则：</em></p>\n<ul>\n<li>变量名应该由字母、数字、下划线组成</li>\n<li>变量名需要以字母开头</li>\n<li>ansible内置的关键字不能作为变量名</li>\n</ul>\n<p>下面是优先级从最小到最大的顺序(最后列出的变量赢得优先级):</p>\n<ul>\n<li>command line values (eg “-u user”)</li>\n<li>role defaults [1]</li>\n<li>inventory file or script group vars [2]</li>\n<li>inventory group_vars/all [3]</li>\n<li>playbook group_vars/all [3]</li>\n<li>inventory group_vars/* [3]</li>\n<li>playbook group_vars/* [3]</li>\n<li>inventory file or script host vars [2]</li>\n<li>inventory host_vars/* [3]</li>\n<li>playbook host_vars/* [3]</li>\n<li>host facts / cached set_facts [4]</li>\n<li>play vars</li>\n<li>play vars_prompt</li>\n<li>play vars_files</li>\n<li>role vars (defined in role/vars/main.yml)</li>\n<li>block vars (only for tasks in block)</li>\n<li>task vars (only for the task)</li>\n<li>include_vars</li>\n<li>set_facts / registered vars</li>\n<li>role (and include_role) params</li>\n<li>include params</li>\n<li>extra vars (always win precedence)</li>\n</ul>\n<p><br></p>\n<h5 id=\"1-vars-配置定义-playbook\"><a href=\"#1-vars-配置定义-playbook\" class=\"headerlink\" title=\"(1) vars 配置定义 (playbook)\"></a>(1) vars 配置定义 (playbook)</h5><p>在play中定义变量的几种形式：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.可定义单个变量或者多个变量（常规）</span></span><br><span class=\"line\">vars:</span><br><span class=\"line\">  tvar1: testfile</span><br><span class=\"line\">  tvar2: testfile</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.使用YAML的块序列语法也可以定义变量</span></span><br><span class=\"line\">vars:</span><br><span class=\"line\">  - testvar1: testfile1</span><br><span class=\"line\">  - testvar2: testfile2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.能够以类似\"属性\"的方式定义变量 （推荐方法）</span></span><br><span class=\"line\">vars:</span><br><span class=\"line\">  nginx:</span><br><span class=\"line\">    conf80: /etc/nginx/conf.d/80.conf</span><br><span class=\"line\">    conf8080: /etc/nginx/conf.d/8080.conf</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>变量引用的几种方式：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1：上面1/2案例变量调用</span></span><br><span class=\"line\"><span class=\"string\">\"&#123;&#123; tvar1 &#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"string\">\"&#123;&#123; testvar1 &#125;&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2. 上面3案例变量调用(由于是对象)</span></span><br><span class=\"line\"><span class=\"string\">\"&#123;&#123;nginx.conf80&#125;&#125;\"</span>  <span class=\"comment\">#方式1</span></span><br><span class=\"line\"><span class=\"string\">\"&#123;&#123;nginx['conf8080']&#125;&#125;\"</span> <span class=\"comment\">#方式2</span></span><br></pre></td></tr></table></figure></p>\n<p>上例中我在引用变量时使用了双引号，而在本文的第一个示例中引用变量时却没有使用双引号，这是因为第一个示例中的变量在被引用时，并没有处于”开头的位\\”，第一个示例中变量被引用时如下：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">path: /testdir/&#123;&#123; testvar1 &#125;&#125;  <span class=\"comment\">#当 \"不处于开头位置\" 相当于是拼接路径可以不使用\"\"包含</span></span><br><span class=\"line\">path: <span class=\"string\">\"&#123;&#123;nginx.conf80&#125;&#125;\"</span>  <span class=\"comment\">#变量被引用时如下，处于\"开头的位置\"必须使用双引号引起被引用的变量，否则会报语法错误。</span></span><br></pre></td></tr></table></figure><br>上述情况也有例外,当在playbook中为模块的参数赋值时，可以使用”冒号”，也可以使用”等号”，当使用”等号”为模块的参数赋值时，则不用考虑引用变量时是否使用”引号”的问题，<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file:</span><br><span class=\"line\">  path=&#123;&#123;nginx.conf80&#125;&#125;</span><br><span class=\"line\">  path=&#123;&#123;nginx[<span class=\"string\">'conf8080'</span>]&#125;&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"2-vars-files-独立yml文件定义\"><a href=\"#2-vars-files-独立yml文件定义\" class=\"headerlink\" title=\"(2) vars_files 独立yml文件定义\"></a>(2) vars_files 独立yml文件定义</h5><p>在某些场景中我们还可以在某个文件中定义变量,然后再在playbook中引入对应的文件,引入文件后playbook即可使用文件中定义的变量,即可使用文件中定义的变量</p>\n<p><em>你可能会问为什么要多此一举呢？</em></p>\n<ul>\n<li>某些工作场景中需要你想要让别人阅读你的playbook，却不想让别人看到某些值只能看到引入的变量名，但是看不到变量对应的值，这种将变量分离到某个文件中的做法叫做”变量文件分离”</li>\n<li>“变量文件分离”：能够隐藏某些值,将不同类的信息放在不同的文件,变量信息与剧本分离(方便修改)</li>\n</ul>\n<p><em>“变量文件分离”之变量定义</em><br>建立nginx.yml在文件中定义变量时，不要使用vars关键字，直接定义变量即可，定义变量的语法与在playbook中定义变量的几种语法相同<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#语法一示例：</span></span><br><span class=\"line\"><span class=\"attr\">  testvar1:</span> <span class=\"string\">testfile</span></span><br><span class=\"line\"><span class=\"attr\">  testvar2:</span> <span class=\"string\">testfile2</span></span><br><span class=\"line\"><span class=\"comment\">#语法二示例：</span></span><br><span class=\"line\"><span class=\"attr\">  - testvar1:</span> <span class=\"string\">testfile</span></span><br><span class=\"line\"><span class=\"attr\">  - testvar2:</span> <span class=\"string\">testfile2</span></span><br><span class=\"line\"><span class=\"comment\">#语法三示例：</span></span><br><span class=\"line\"><span class=\"attr\">nginx:</span></span><br><span class=\"line\"><span class=\"attr\">  conf80:</span> <span class=\"string\">/etc/nginx/conf.d/80.conf</span></span><br><span class=\"line\"><span class=\"attr\">  conf8080:</span> <span class=\"string\">/etc/nginx/conf.d/8080.conf</span></span><br></pre></td></tr></table></figure></p>\n<p><em>“变量文件分离”之变量包含引用</em><br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#单个变量文件引入</span></span><br><span class=\"line\"><span class=\"attr\">vars_files:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">/testdir/ansible/nginx.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#也可以引入多个变量文件，每个被引入的文件都需要以\\\"- \\\"开头，示例如下</span></span><br><span class=\"line\"><span class=\"attr\">vars_files:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">/testdir/ansible/nginx_vars.yml</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">/testdir/ansible/other_vars.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#\"vars\"关键字和\"vars_files\"关键字可以同时使用</span></span><br><span class=\"line\"><span class=\"attr\">vars:</span></span><br><span class=\"line\"><span class=\"attr\">  - conf90:</span> <span class=\"string\">/etc/nginx/conf.d/90.conf</span></span><br><span class=\"line\"><span class=\"attr\">vars_files:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">/testdir/ansible/nginx_vars.yml</span></span><br></pre></td></tr></table></figure></p>\n<p>基础示例：实现变量文件分离引用与命令模块文件模块使用<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#var.yml</span></span><br><span class=\"line\"><span class=\"attr\">create:</span></span><br><span class=\"line\"><span class=\"attr\">  directory:</span> <span class=\"string\">Love</span></span><br><span class=\"line\"><span class=\"attr\">  filename:</span> <span class=\"string\">Ansible.sh</span></span><br><span class=\"line\"><span class=\"attr\">  context:</span> <span class=\"string\">\"insert file a talk about \\b \\t \\n\"</span>  <span class=\"comment\">#建议对于字符串一定要添加双引号，可使用转义字符;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#variable.yml</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span> <span class=\"comment\">#关键点1-直接在play文件中定义变量</span></span><br><span class=\"line\"><span class=\"attr\">    - dirRoot:</span> <span class=\"string\">/tmp/</span></span><br><span class=\"line\"><span class=\"attr\">  vars_files:</span> <span class=\"comment\">#关键点2-包含外部设定的变量文件</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/root/var.yml</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">Create</span> <span class=\"string\">directory</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span> </span><br><span class=\"line\"><span class=\"attr\">        path:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;dirRoot&#125;&#125;</span><span class=\"template-variable\">&#123;&#123;create.directory&#125;&#125;</span>\"</span>  <span class=\"comment\">#关键点3</span></span><br><span class=\"line\"><span class=\"attr\">        state:</span> <span class=\"string\">directory</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">touch</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">      file:</span></span><br><span class=\"line\">        <span class=\"string\">path=&#123;&#123;dirRoot&#125;&#125;&#123;&#123;create.directory&#125;&#125;/&#123;&#123;create['filename']&#125;&#125;</span>  <span class=\"comment\">#关键点4 - 特殊字符可以直接拼接（实际使用时候不建议这样）</span></span><br><span class=\"line\">        <span class=\"string\">state=touch</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">insert</span> <span class=\"string\">context</span></span><br><span class=\"line\"><span class=\"attr\">      lineinfile:</span></span><br><span class=\"line\">        <span class=\"string\">path=\"&#123;&#123;dirRoot&#125;&#125;&#123;&#123;create.directory&#125;&#125;/&#123;&#123;create.filename&#125;&#125;\"</span>  <span class=\"comment\">#关键点5 - 推荐方法采用单双引号包含里面可拼接字符</span></span><br><span class=\"line\">        <span class=\"string\">line=&#123;&#123;create['context']&#125;&#125;</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729164637.png\" alt=\"WeiyiGeek.变量分离案例\" title=\"\" class=\"\">\n                <p>WeiyiGeek.变量分离案例</p>\n            </figure></p>\n<p><br></p>\n<h5 id=\"3-变量相关使用方法\"><a href=\"#3-变量相关使用方法\" class=\"headerlink\" title=\"(3) 变量相关使用方法\"></a>(3) 变量相关使用方法</h5><p>描述：这篇文章所涉及到的内容需要借助两个模块，所以在详细的总结变量的相关使用方法之前会先描述一下这两个模块的用法:<code>setup模块/debug模块</code>。</p>\n<p>当我们运行一个playbook时自动<code>调用了setup模块从而执行了&quot;[Gathering Facts]&quot;任务</code>，通过这个默认任务收集远程主机的相关信息（<code>例如远程主机的IP地址，主机名，系统版本，硬件配置等信息</code>）;<br>其实这些被收集到的远程主机信息会保存在对应的变量中，当我们要使用这些信息时就可以获取对应的变量；</p>\n<p>其实这些远程主机的变量信息不仅仅能够用于输出，我们通常会获取到信息以后<code>对这些信息的值进行判断</code>，判断是否符合我们的要求然后再执行下一步动作，比如先获取到远程主机的系统发行版信息然后判断发行版是centos6还是centos7:</p>\n<ul>\n<li>如果是centos6，我们就将准备好的A文件拷贝到远程主机中</li>\n<li>如果是centos7，我们就将准备好的B文件拷贝到远程主机中</li>\n</ul>\n<p>演示案例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ansible</span> <span class=\"built_in\">local</span> -m setup | more</span><br><span class=\"line\"><span class=\"built_in\">local</span> | SUCCESS =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"ansible_facts\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"ansible_all_ipv4_addresses\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"10.10.107.222\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"192.168.1.99\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"ansible_all_ipv6_addresses\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"fe80::9738:2d26:820f:2d50\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"fe80::dfc:592e:b4a4:9877\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"ansible_apparmor\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"status\"</span>: <span class=\"string\">\"disabled\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"ansible_architecture\"</span>: <span class=\"string\">\"x86_64\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"ansible_bios_date\"</span>: <span class=\"string\">\"09/21/2015\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"ansible_bios_version\"</span>: <span class=\"string\">\"6.00\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"ansible_cmdline\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"BOOT_IMAGE\"</span>: <span class=\"string\">\"/vmlinuz-3.10.0-957.12.2.el7.x86_64\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"LANG\"</span>: <span class=\"string\">\"zh_CN.UTF-8\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"crashkernel\"</span>: <span class=\"string\">\"auto\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"quiet\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">            <span class=\"string\">\"rd.lvm.lv\"</span>: <span class=\"string\">\"centos/swap\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"rhgb\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">            <span class=\"string\">\"ro\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">            <span class=\"string\">\"root\"</span>: <span class=\"string\">\"/dev/mapper/centos-root\"</span></span><br><span class=\"line\">        &#125;,</span><br></pre></td></tr></table></figure></p>\n<p>执行上述命令后远程主机local的相关信息将会输出到ansible主机的控制台上，为了方便你阅读返回的信息的格式是json格式</p>\n<p>ansible已经将格式化后的json信息返回到了控制台中比如：</p>\n<ul>\n<li>“ansible_all_ipv4_addresses” 表示远程主机中的所有ipv4地址，从其对应的值可以看出，local主机上一共有3个ipv4地址。</li>\n<li>“ansible_distribution” 表示远程主机的系统发行版，从其对应的值可以看出local主机的系统发行版为centos</li>\n<li>“ansible_distribution_version” 表示远程主机的系统版本号，从其对应的值与  “ansible_distribution” 的值可以看出local主机的系统版本为centos7.4</li>\n<li>“ansible_ens35” 表示远程主机ens35网卡的相关信息，细心如你一定也发现了，我还有两个名为”ens33”和”ens34”的网卡，只不过为了方便示例，这两个网卡的信息被我省略了。</li>\n<li>“ansible_memory_mb” 表示远程主机的内存配置信息。</li>\n</ul>\n<p>我们还可以通过关键字对信息进行过滤还能使用通配符进行相对模糊的过滤:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#比如我只是想要查看远程主机的内存配置信息</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m setup -a <span class=\"string\">'filter=ansible_memory_mb'</span>  <span class=\"comment\">#通过setup模块的filter参数可以指定需要过滤的关键字</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#相对模糊的过滤</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m setup -a <span class=\"string\">\"filter=*mb*\"</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190730093410.png\" alt=\"WeiyiGeek.set模块\" title=\"\" class=\"\">\n                <p>WeiyiGeek.set模块</p>\n            </figure></p>\n<p>其实除了这些信息以外还能够在远程主机中写入一些自定义的信息，这些自定义信息也可以被setup模块收集到。<br><em>那么我们应该在哪里定义这些信息呢？该怎样定义这些信息呢？</em><br>答：ansible 默认会去目标主机的 /etc/ansible/facts.d 目录下查找主机中的自定义信息，并且规定自定义信息需要写在以\\”.fact\\”为后缀的文件中，同时这些以”.fact”为后缀的文件中的<code>内容需要是INI格式或者是json格式的</code>。</p>\n<p>当setup收集远程主机的”local facts”时，默认会查找远程主机的<code>/etc/ansible/facts.d</code>目录，如果你<code>把&quot;local facts&quot;信息文件放在了其他自定义路径</code>，在使用setup模块时，需要使用”fact_path”参数指定对应的路径；</p>\n<p>那么我们来创建一个测试文件路径为local主机的 <code>/etc/ansible/facts.d/testinfo.fact</code> 在文件中写入如下INI格式的信息。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$cat</span> testinfo.fact</span><br><span class=\"line\"><span class=\"comment\">#INI风格的内容我在\"[testmsg]\"配置段中配置了两条自定义信息，msg1与msg2。  </span></span><br><span class=\"line\">[testmsg]</span><br><span class=\"line\">msg1 = This is a demo1</span><br><span class=\"line\">msg2 = This is a demo2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#我们也可以使用json格式进行配置,只是书写格式不同 /tmp/info.fact  ansible_local</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   <span class=\"string\">\"testmsg\"</span>:&#123;</span><br><span class=\"line\">       <span class=\"string\">\"msg1\"</span>:<span class=\"string\">\"This is the first custom test message\"</span>,</span><br><span class=\"line\">       <span class=\"string\">\"msg2\"</span>:<span class=\"string\">\"This is the second custom test message\"</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>通过上述方式在目标主机的本地自定义信息被称为”local facts”，当我们运行setup模块时，<code>远程主机的&quot;local facts&quot;信息也会被收集</code>，我们可以通过”ansible_local”关键字过滤远程主机的”local facts”信息</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#获取本地自定义信息 (从默认目录)</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m setup -a <span class=\"string\">\"filter=ansible_local\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#假设我把\".fact\"文件放在了目标主机的\"/tmp\"目录下</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m setup -a <span class=\"string\">\"filter=ansible_local fact_path=/tmp\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行结果</span></span><br><span class=\"line\"><span class=\"built_in\">local</span> | SUCCESS =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"ansible_facts\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"ansible_local\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"testinfo\"</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">\"testmsg\"</span>: &#123;</span><br><span class=\"line\">                    <span class=\"string\">\"msg1\"</span>: <span class=\"string\">\"This is a demo1\"</span>,</span><br><span class=\"line\">                    <span class=\"string\">\"msg2\"</span>: <span class=\"string\">\"This is a demo2\"</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">local</span> | SUCCESS =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"ansible_facts\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"ansible_local\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"info\"</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">\"testmsg\"</span>: &#123;</span><br><span class=\"line\">                    <span class=\"string\">\"msg1\"</span>: <span class=\"string\">\"This is the first custom test message\"</span>,</span><br><span class=\"line\">                    <span class=\"string\">\"msg2\"</span>: <span class=\"string\">\"This is the second custom test message\"</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>除了上面的setup模块我们还能采用，debug模块的作用就是帮助我们进行调试并且把信息输出到ansible控制台上，以便我们能够定位问题；debug模块除了能够使用msg参数输出自定义的信息，还能够通过debug模块直接输出变量信息需要使用var参数</p>\n<p>那么我们先来看一个debug模块的playbook小示例如下：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    testvar:</span> <span class=\"string\">value</span> <span class=\"string\">of</span> <span class=\"string\">test</span> <span class=\"string\">variable</span> <span class=\"number\">1024</span>   <span class=\"comment\">#关键1</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">touch</span> <span class=\"string\">testfile</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/tmp/testfile</span></span><br><span class=\"line\"><span class=\"attr\">      state:</span> <span class=\"string\">touch</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">debug</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span>  <span class=\"comment\">#msg中的变量值需要使用引号引起，因为&#123;&#123;testvar&#125;&#125;变量前包含\"冒号\"，如果不使用引号会报语法错误</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"this is debug info , <span class=\"template-variable\">&#123;&#123;testvar&#125;&#125;</span> \"</span> <span class=\"comment\">#输出自定义debug字符串    #关键2</span></span><br><span class=\"line\">      <span class=\"comment\">#var: testvar  #通过debug的var参数输出了这个变量的内容              #关键3 (与msg不能同时使用)</span></span><br><span class=\"line\"><span class=\"string\">```</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">play解析：我们先在local主机上touch了对应的文件,使用debug的msg参数时也可以引用变量的值并且输出，然后利用debug模块在控制台中输出变量的名称以及变量的值:</span></span><br><span class=\"line\"><span class=\"string\">```bash</span></span><br><span class=\"line\"><span class=\"comment\">#执行结果(1) - msg</span></span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[debug</span> <span class=\"string\">demo]</span></span><br><span class=\"line\"><span class=\"attr\">ok:</span> <span class=\"string\">[local]</span> <span class=\"string\">=&gt;</span> <span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"attr\">    \"msg\":</span> <span class=\"string\">\"this is debug info , value of test variable 1024 \"</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行结果(2)- var</span></span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[debug</span> <span class=\"string\">demo]</span> </span><br><span class=\"line\"><span class=\"attr\">ok:</span> <span class=\"string\">[local]</span> <span class=\"string\">=&gt;</span> <span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"attr\">    \"testvar\":</span> <span class=\"string\">\"value of test variable 1024\"</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>playbook在运行时默认运行”[Gathering Facts]”任务会收集远程主机的相关信息，这些信息会保存在对应的变量中，我们在playbook中可以使用这些变量，从而利用这些信息，<em>那么我们怎样在playbook获取到这些变量的值呢？</em></p>\n<p>在setup模块的示例中我们可以通过<code>&quot;ansible_memory_mb&quot;</code>关键字获取远程主机的内存信息，其实在playbook中也可以直接调用”ansible_memory_mb”变量名;<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    test:</span> <span class=\"string\">\"Test: \"</span>  <span class=\"comment\">#关键点</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">debug</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;test&#125;&#125;</span> Remote host memory swap information: <span class=\"template-variable\">&#123;&#123;ansible_memory_mb['swap']&#125;&#125;</span> \\n, ip addrs info: <span class=\"template-variable\">&#123;&#123;ansible_all_ipv4_addresses&#125;&#125;</span>\"</span>  <span class=\"comment\">#关键点</span></span><br></pre></td></tr></table></figure><br>我们自定义的信息中包含了变量内容,远程主机的内存信息/IP地址信息同时被输出了,执行结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TASK [debug demo] </span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"Test: Remote host memory swap information: &#123;u'cached': 0, u'total': 2047, u'free': 2047, u'used': 0&#125; \\n, ip addrs info: [u'10.10.107.222', u'192.168.1.99']\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>如上述返回信息所示，”ansible_memory_mb”中其实包含了<code>&quot;nocache&quot;、&quot;real&quot;、 &quot;swap&quot;</code>三个部分的信息，如果我们只想获得\\”real\\”部分的信息，在playbook中引用变量时可以使用如下两种语法。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">语法一示例：</span><br><span class=\"line\">debug:</span><br><span class=\"line\">     msg: <span class=\"string\">\"Remote host memory information : &#123;&#123;ansible_memory_mb.real&#125;&#125;\"</span></span><br><span class=\"line\">语法二示例：</span><br><span class=\"line\">debug:</span><br><span class=\"line\">     msg: <span class=\"string\">\"Remote host memory information : &#123;&#123;ansible_memory_mb['real']&#125;&#125;\"</span></span><br></pre></td></tr></table></figure></p>\n<p><em>总结：</em></p>\n<ul>\n<li>其实setup模块返回的这些信息都存在了对应的变量中，我们可以通过引用变量从而使用对应的信息;</li>\n<li>其实debug模块常常用来调试playbook,输出自定义异常以及setup信息收集的变量输出;</li>\n</ul>\n<p><br></p>\n<h5 id=\"4-register-注册变量\"><a href=\"#4-register-注册变量\" class=\"headerlink\" title=\"(4) register 注册变量\"></a>(4) register 注册变量</h5><p>描述：ansible的模块在运行之后其实都会返回一些”返回值”，只是默认情况下这些”返回值”并不会显示而已，我们可以把这些返回值写入到某个变量中,然后通过引用对应的变量从而获取到这些返回值,<code>这种将模块的返回值写入到变量中的方法被称为&quot;注册变量&quot;</code>;</p>\n<p>这些返回值不仅仅能够用于输出通常我们会利用到这些返回值，比如通过模块的返回值决定之后的一些动作，所以注册变量在playbook中还是会被经常用到的;</p>\n<p>基础示例：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#执行命令返回结果利用 debug 查看</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    cmd1:</span> <span class=\"string\">whoami</span></span><br><span class=\"line\"><span class=\"attr\">    cmd2:</span> <span class=\"string\">hostname</span> <span class=\"bullet\">-I</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">execute</span> <span class=\"string\">whoami</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;cmd1&#125;&#125;</span>\"</span> </span><br><span class=\"line\"><span class=\"attr\">    register:</span> <span class=\"string\">who</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">execute</span> <span class=\"string\">hostname</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;cmd2&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">    register:</span> <span class=\"string\">hostname</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">execute</span> <span class=\"string\">echo</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">\"echo test &gt; /tmp/testshellfile\"</span></span><br><span class=\"line\"><span class=\"attr\">    register:</span> <span class=\"string\">echovar</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Debug</span> <span class=\"string\">shell</span> <span class=\"string\">module</span> <span class=\"string\">return</span> <span class=\"string\">values</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span> </span><br><span class=\"line\"><span class=\"attr\">      var:</span> <span class=\"string\">who,hostname,echovar</span>   <span class=\"comment\">#可以输出多个变量采用\",\"号进行分割</span></span><br></pre></td></tr></table></figure><br>执行结果：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TASK [Debug shell module return values] </span><br><span class=\"line\">ok: [local] =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"who,hostname,echovar\"</span>: <span class=\"string\">\"(</span></span><br><span class=\"line\"><span class=\"string\">    &#123;'stderr_lines': [],</span></span><br><span class=\"line\"><span class=\"string\">     u'changed': True,    #操作标识!</span></span><br><span class=\"line\"><span class=\"string\">     u'end': u'2019-07-30 11:31:13.821710',</span></span><br><span class=\"line\"><span class=\"string\">     'failed': False,     #执行状态</span></span><br><span class=\"line\"><span class=\"string\">     u'stdout': u'root',  #执行结果</span></span><br><span class=\"line\"><span class=\"string\">     u'cmd': u'whoami',   #执行命令</span></span><br><span class=\"line\"><span class=\"string\">     u'rc': 0, </span></span><br><span class=\"line\"><span class=\"string\">     u'start': </span></span><br><span class=\"line\"><span class=\"string\">     u'2019-07-30 11:31:13.818264',</span></span><br><span class=\"line\"><span class=\"string\">     u'stderr': u'', </span></span><br><span class=\"line\"><span class=\"string\">     u'delta': u'0:00:00.003446', 'stdout_lines': [u'root']&#125;,</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     &#123;'stderr_lines': [], u'changed': True, u'end': u'2019-07-30 11:31:14.111808', 'failed': False, u'stdout': u'10.10.107.222 192.168.1.99 ', u'cmd': u'hostname -I', u'rc': 0, u'start': u'2019-07-30 11:31:14.108345', u'stderr': u'', u'delta': u'0:00:00.003463', 'stdout_lines': [u'10.10.107.222 192.168.1.99 ']&#125;, </span></span><br><span class=\"line\"><span class=\"string\">     </span></span><br><span class=\"line\"><span class=\"string\">     &#123;'stderr_lines': [], u'changed': True, u'end': u'2019-07-30 11:31:14.367277', 'failed': False, u'stdout': u'', u'cmd': u'echo test &gt; /tmp/testshellfile', u'rc': 0, u'start': u'2019-07-30 11:31:14.364389', u'stderr': u'', u'delta': u'0:00:00.002888', 'stdout_lines': []&#125;)\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>假设我只是想要获取到上述返回信息中cmd的值则可以使用如下两种语法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例的返回信息为shell模块的返回值</span></span><br><span class=\"line\"><span class=\"comment\">#语法一</span></span><br><span class=\"line\">  - name: shell module <span class=\"built_in\">return</span> values</span><br><span class=\"line\">    debug:</span><br><span class=\"line\">      msg: <span class=\"string\">\"&#123;&#123;testvar.cmd&#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\">#语法二</span></span><br><span class=\"line\">  - name: shell module <span class=\"built_in\">return</span> values</span><br><span class=\"line\">    debug:</span><br><span class=\"line\">      msg: <span class=\"string\">\"&#123;&#123;testvar['cmd']&#125;&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#输出可采用debug模块的msg进行过滤调用输出,更加的简洁方便;</span></span><br></pre></td></tr></table></figure></p>\n<p><em>参考来源：</em></p>\n<ul>\n<li>Ansible2.8[返回值含义] - <a href=\"https://docs.ansible.com/ansible/latest/reference_appendices/common_return_values.html\" target=\"_blank\" rel=\"noopener\">https://docs.ansible.com/ansible/latest/reference_appendices/common_return_values.html</a></li>\n</ul>\n<p><br></p>\n<h5 id=\"5-prompt-提示输入写入变量\"><a href=\"#5-prompt-提示输入写入变量\" class=\"headerlink\" title=\"(5) prompt 提示输入写入变量\"></a>(5) prompt 提示输入写入变量</h5><p>描述：在某些交换式操作的时候,脚本会提示用户输入一些信息，脚本需要根据用户输入的信息决定下一步的动作</p>\n<p><em>那么在playbook中该怎样实现这种交互呢？</em><br>答:我们可以这样做提示用户输入信息，然后将用户输入的信息存入到指定的变量中，当我们需要使用这些”输入的信息”时，只要引用对应的变量即可。</p>\n<p>示例解析：使用<code>&quot;vars_prompt&quot;</code>关键字创建了两个变量，两个变量的名称分别为”your_name” 和 “your_age”,当用户输入后字符串将被存入变量之中;</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars_prompt:</span> </span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">\"Username\"</span>               <span class=\"comment\">#变量名称</span></span><br><span class=\"line\"><span class=\"attr\">      prompt:</span> <span class=\"string\">\"What is your name\"</span>   <span class=\"comment\">#交互式输入提示</span></span><br><span class=\"line\"><span class=\"attr\">      private:</span> <span class=\"literal\">no</span>                     <span class=\"comment\">#是否隐秘：默认Yes(不显示输入)/no(显示输入))</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">\"Password\"</span></span><br><span class=\"line\"><span class=\"attr\">      prompt:</span> <span class=\"string\">\"What is your password\"</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">\"Sex\"</span>                    <span class=\"comment\">#多选项选项</span></span><br><span class=\"line\"><span class=\"attr\">      prompt:</span> <span class=\"string\">\"Choose the you Sex \\n</span></span><br><span class=\"line\"><span class=\"string\">      m: Man\\n</span></span><br><span class=\"line\"><span class=\"string\">      w: Woman\\n</span></span><br><span class=\"line\"><span class=\"string\">      o: other\\n\"</span></span><br><span class=\"line\"><span class=\"attr\">      private:</span> <span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">      default:</span> <span class=\"string\">o</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">\"PayPass\"</span>               <span class=\"comment\">#加密输入以哈希密码输出 (可以直接创建linux系统用户和设置密码)</span></span><br><span class=\"line\"><span class=\"attr\">      prompt:</span> <span class=\"string\">\"Enter Pay PassWord\"</span></span><br><span class=\"line\"><span class=\"attr\">      private:</span> <span class=\"literal\">no</span>                    <span class=\"comment\">#可查看输入</span></span><br><span class=\"line\"><span class=\"attr\">      unsafe:</span> <span class=\"literal\">yes</span>                    <span class=\"comment\">#支持输入特殊字符 比如： &#123; % 等ansbile含义符号 - 2.8 add</span></span><br><span class=\"line\"><span class=\"attr\">      encrypt:</span> <span class=\"string\">\"sha512_crypt\"</span>        <span class=\"comment\">#关键点-encrypt关键字表示对用户输入的信息进行哈希</span></span><br><span class=\"line\"><span class=\"attr\">      confirm:</span> <span class=\"literal\">yes</span>   <span class=\"comment\">#关键点-通过\"confirm\"关键字就能实现需要输入两次完全相同的密码，才能够设置成功</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">output</span> <span class=\"string\">prompt</span> <span class=\"string\">vars</span>   <span class=\"comment\">#任务名称</span></span><br><span class=\"line\"><span class=\"attr\">     debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"Username = <span class=\"template-variable\">&#123;&#123;Username&#125;&#125;</span> , Password = <span class=\"template-variable\">&#123;&#123;Password&#125;&#125;</span>,  Sex = <span class=\"template-variable\">&#123;&#123;Sex&#125;&#125;</span>, Pay Password = <span class=\"template-variable\">&#123;&#123;PayPass&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">   - name:</span> <span class=\"string\">create</span> <span class=\"string\">user</span>    <span class=\"comment\">#创建用户</span></span><br><span class=\"line\"><span class=\"attr\">     user:</span></span><br><span class=\"line\"><span class=\"attr\">       name:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;Username&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">       password:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;PayPass&#125;&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#未安装passlib支持的 encrypt 加密方式  2.7 版本新增</span></span><br><span class=\"line\"><span class=\"string\">bcrypt</span> <span class=\"bullet\">-</span> <span class=\"string\">BCrypt</span></span><br><span class=\"line\"><span class=\"string\">md5_crypt</span> <span class=\"bullet\">-</span> <span class=\"string\">MD5</span> <span class=\"string\">Crypt</span></span><br><span class=\"line\"><span class=\"string\">sha256_crypt</span> <span class=\"bullet\">-</span> <span class=\"string\">SHA-256</span> <span class=\"string\">Crypt</span></span><br><span class=\"line\"><span class=\"string\">sha512_crypt</span> <span class=\"bullet\">-</span> <span class=\"string\">SHA-512</span> <span class=\"string\">Crypt</span></span><br></pre></td></tr></table></figure>\n<p>执行结果：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$ansible-playbook</span> <span class=\"string\">prompt.yml</span></span><br><span class=\"line\"><span class=\"string\">What</span> <span class=\"string\">is</span> <span class=\"string\">your</span> <span class=\"attr\">name:</span> <span class=\"string\">Weiyegeek</span></span><br><span class=\"line\"><span class=\"string\">What</span> <span class=\"string\">is</span> <span class=\"string\">your</span> <span class=\"attr\">password:</span></span><br><span class=\"line\"><span class=\"string\">Choose</span> <span class=\"string\">the</span> <span class=\"string\">you</span> <span class=\"attr\">Sex:</span></span><br><span class=\"line\"><span class=\"attr\"> m:</span> <span class=\"string\">Man</span></span><br><span class=\"line\"><span class=\"attr\"> w:</span> <span class=\"string\">Woman</span></span><br><span class=\"line\"><span class=\"attr\"> o:</span> <span class=\"string\">other</span></span><br><span class=\"line\"> <span class=\"string\">[o]:</span> <span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"string\">Enter</span> <span class=\"string\">Pay</span> <span class=\"attr\">PassWord:</span> <span class=\"string\">Wei123456</span></span><br><span class=\"line\"><span class=\"string\">confirm</span> <span class=\"string\">Enter</span> <span class=\"string\">Pay</span> <span class=\"attr\">PassWord:</span> <span class=\"string\">Wei123456</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">PLAY</span> <span class=\"string\">[local]</span> </span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[Gathering</span> <span class=\"string\">Facts]</span></span><br><span class=\"line\"><span class=\"attr\">ok:</span> <span class=\"string\">[local]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[output</span> <span class=\"string\">prompt</span> <span class=\"string\">vars]</span> </span><br><span class=\"line\"><span class=\"attr\">ok:</span> <span class=\"string\">[local]</span> <span class=\"string\">=&gt;</span> <span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"attr\">    \"msg\":</span> <span class=\"string\">\"Username = Weiyegeek , Password = weiyegeek,  Sex = m, Pay Password = $6$WDmSQbaDomZyzbbm$MHXVXALnaZ4oKkptiFi/CYlQJWxrUD4xxHmvSjvZSKqr/4hvmaA/h/JKLIUZL.YZDQXx53EAOp.BgJLPltnxw1\"</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[create</span> <span class=\"string\">user]</span> </span><br><span class=\"line\"><span class=\"attr\">changed:</span> <span class=\"string\">[local]</span></span><br><span class=\"line\"><span class=\"string\">PLAY</span> <span class=\"string\">RECAP</span> </span><br><span class=\"line\"><span class=\"string\">local</span> <span class=\"string\">:</span> <span class=\"string\">ok=3</span>  <span class=\"string\">changed=1</span>  <span class=\"string\">unreachable=0</span>  <span class=\"string\">failed=0</span>  <span class=\"string\">skipped=0</span>  <span class=\"string\">rescued=0</span>  <span class=\"string\">ignored=0</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190730144557.png\" alt=\"WeiyiGeek.prompt-createuser\" title=\"\" class=\"\">\n                <p>WeiyiGeek.prompt-createuser</p>\n            </figure>\n<p><em>注意事项：</em></p>\n<ul>\n<li>当使用”encrypt”关键字对字符串进行哈希时，ansible需要依赖Python的passlib库完成哈希操作，<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -m pip install passlib  <span class=\"comment\"># 或者 pip install passlib</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装后可使用的加密方式</span></span><br><span class=\"line\">des_crypt - DES Crypt</span><br><span class=\"line\">bsdi_crypt - BSDi Crypt</span><br><span class=\"line\">bigcrypt - BigCrypt</span><br><span class=\"line\">crypt16 - Crypt16</span><br><span class=\"line\">md5_crypt - MD5 Crypt</span><br><span class=\"line\">bcrypt - BCrypt</span><br><span class=\"line\">sha1_crypt - SHA<span class=\"number\">-1</span> Crypt</span><br><span class=\"line\">sun_md5_crypt - Sun MD5 Crypt</span><br><span class=\"line\">sha256_crypt - SHA<span class=\"number\">-256</span> Crypt</span><br><span class=\"line\">sha512_crypt - SHA<span class=\"number\">-512</span> Crypt</span><br><span class=\"line\">apr_md5_crypt - Apache’s MD5-Crypt variant</span><br><span class=\"line\">phpass - PHPass’ Portable Hash</span><br><span class=\"line\">pbkdf2_digest - Generic PBKDF2 Hashes</span><br><span class=\"line\">cta_pbkdf2_sha1 - Cryptacular’s PBKDF2 hash</span><br><span class=\"line\">dlitz_pbkdf2_sha1 - Dwayne Litzenberger’s PBKDF2 hash</span><br><span class=\"line\">scram - SCRAM Hash</span><br><span class=\"line\">bsd_nthash - FreeBSD’s MCF-compatible nthash encoding</span><br></pre></td></tr></table></figure></li>\n<li>官方文档[prompt]：<a href=\"https://docs.ansible.com/ansible/latest/user_guide/playbooks_prompts.html\" target=\"_blank\" rel=\"noopener\">https://docs.ansible.com/ansible/latest/user_guide/playbooks_prompts.html</a></li>\n</ul>\n<p><br></p>\n<h5 id=\"6-–extra-vars-命令行传递变量\"><a href=\"#6-–extra-vars-命令行传递变量\" class=\"headerlink\" title=\"(6) –extra-vars 命令行传递变量\"></a>(6) –extra-vars 命令行传递变量</h5><p>描述：除了上面定义变量的方法，我们还能够在执行playbook时直接传入需要使用的变量;</p>\n<p>比如下面再playbook中并没有定义变量但我们可以在调用playbook时直接从命令行传入变量,果在调用playbook时也没有传入变量则会报错，其实我们也可以先在playbook中定义好变量，然后在执行playbook时以传入变量覆盖playbook中的变量值（前提是命令行中的变量与play中的变量重名）：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cat extravars.yml</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    verify:</span> <span class=\"string\">\"123456\"</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"Passing Variables On The Command Line\"</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;ip&#125;&#125;</span> - <span class=\"template-variable\">&#123;&#123;Port&#125;&#125;</span> - <span class=\"template-variable\">&#123;&#123;service&#125;&#125;</span> , Verify: <span class=\"template-variable\">&#123;&#123;verify&#125;&#125;</span>\"</span>  <span class=\"comment\">#</span></span><br></pre></td></tr></table></figure><br>执行结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#三种方式效果相同</span></span><br><span class=\"line\">ansible-playbook extravars.yml --extra-vars <span class=\"string\">'ip=\"192.168.1.1\" Port=\"8080\" service=\"nginx\" verify=\"888888\"'</span></span><br><span class=\"line\">ansible-playbook extravars.yml -e <span class=\"string\">'ip=\"192.168.1.1\" Port=\"8080\" service=\"nginx\" verify=\"888888\"'</span></span><br><span class=\"line\">ansible-playbook extravars.yml -e <span class=\"string\">'&#123;\"ip\":\"192.168.1.1\",\"Port\":\"8080\",\"service\":\"nginx\",\"verify\":\"888888\"&#125;'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行结果：</span></span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"192.168.1.1 - 8080 - nginx , Verify: 888888\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>命令行传入变量文件</strong><br>描述:命令行<code>不仅能够传入变量还能传入变量文件</code>，变量文件中的变量都会一并被传入，变量文件可以是json格式的/YAML格式的，此处使用YAML格式的变量文件进行示例<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat &gt; filevars.yml &lt;&lt;end</span></span><br><span class=\"line\"><span class=\"attr\">testvar:</span> <span class=\"string\">testvarinfile</span></span><br><span class=\"line\"><span class=\"attr\">countlist:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">one</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">two</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">three</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">four</span></span><br><span class=\"line\"><span class=\"string\">end</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#playbook的内容如下</span></span><br><span class=\"line\"><span class=\"comment\">#cat &gt; filevariable.yml &lt;&lt;END</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"Passing Variables On The Command Line\"</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;testvar&#125;&#125;</span> <span class=\"template-variable\">&#123;&#123;countlist[0]&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"string\">END</span></span><br></pre></td></tr></table></figure></p>\n<p><em>那么我们怎样从命令行中将变量文件中的变量传入playbook呢？</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#使用\"@\"符号加上变量文件的路径，即可在命令行中传入对应的变量文件，变量文件中的所有变量都可以在playbook中引用</span></span><br><span class=\"line\">ansible-playbook filevariable.yml -e <span class=\"string\">\"@/root/filevars.yml\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行结果</span></span><br><span class=\"line\">TASK [Passing Variables On The Command Line]</span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"testvarinfile one\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>总结：</strong></p>\n<ul>\n<li>命令行传入的变量的优先级要高于playbook中的变量，通过这种方法我们就能够更加灵活的指定变量的值了。</li>\n<li>命令行传入json字符串来设置变量<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#通过json格式传入两个变量</span></span><br><span class=\"line\">ansible-playbook cmdvar.yml -e <span class=\"string\">'&#123;\"testvar\":\"test\",\"testvar1\":\"test1\"&#125;'</span></span><br><span class=\"line\">ansible-playbook cmdvar.yml -e <span class=\"string\">'&#123;\"countlist\":[\"one\",\"two\",\"three\",\"four\"]&#125;'</span> <span class=\"comment\">#使用两种语法引用变量 &#123;&#123;countlist[0]&#125;&#125; 或者 &#123;&#123;countlist.0&#125;&#125;</span></span><br></pre></td></tr></table></figure></li>\n<li>命令行可以传入单个或者多个变量也能传入变量文本文件采用-e选项直接搞定;</li>\n</ul>\n<p><br></p>\n<h5 id=\"7-变量使用方法-set-fact\"><a href=\"#7-变量使用方法-set-fact\" class=\"headerlink\" title=\"(7) 变量使用方法 set_fact\"></a>(7) 变量使用方法 set_fact</h5><p>描述：在清单中配置变量，我们知道可以在清单中配置需要被管理的远程主机，也可以将部分远程主机分为一组，其实在配置清单时还<code>可以为主机或主机组设置变量</code>;</p>\n<p><strong>主机变量</strong><br>在清单中配置远程主机时，可以同时为主机配置对应的变量，当操作这个主机时即可直接使用对应的变量。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#/etc/ansible/hosts</span></span><br><span class=\"line\"><span class=\"comment\">#[ini] 格式</span></span><br><span class=\"line\"><span class=\"comment\">#示例1.只要在定义主机时将变量名和变量值写在主机配置的后面即可，可以为一个主机定义多个主机变量，用空格隔开即可</span></span><br><span class=\"line\"><span class=\"built_in\">local</span> ansible_host=10.1.1.70 testhostvar=test70_host_var testvar1=testvar1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[yaml] 格式</span></span><br><span class=\"line\">all:</span><br><span class=\"line\"> hosts:</span><br><span class=\"line\">   test70:</span><br><span class=\"line\">     ansible_host: 10.1.1.70</span><br><span class=\"line\">     ansible_port: 22</span><br><span class=\"line\">     testhostvar: test70_host_var</span><br><span class=\"line\">     testhostvar1: test70_host_var1</span><br><span class=\"line\">     testhostvar2:</span><br><span class=\"line\">       thv1: demo1</span><br><span class=\"line\">       thv2: demo2</span><br></pre></td></tr></table></figure><br>执行结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible <span class=\"built_in\">local</span> -m shell -a <span class=\"string\">\"echo -e Testhostvar = &#123;&#123;testhostvar&#125;&#125;, \\n Testhostvar1 = &#123;&#123;testhostvar1&#125;&#125; , testhostvar2.thv1 = &#123;&#123;testhostvar2['thv2']&#125;&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># local | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># Testhostvar = testhostvar2048, n Testhostvar1 = testvar1024 , testhostvar2.thv1 = demo2</span></span><br></pre></td></tr></table></figure></p>\n<p><em>注意：</em> 主机变量的生效范围只限于对应的主机</p>\n<p><br></p>\n<p><strong>主机组变量</strong><br>在清单中我们能将多个主机分为一组方便我们成批的操作远程主机，同样我也可以将变量配置是到组里面;使用vars关键字可以指定组变量，vars关键字位于对应组的下一级<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#[ini] 格式</span></span><br><span class=\"line\">[testB]</span><br><span class=\"line\">test70 ansible_host=10.1.1.70</span><br><span class=\"line\">test71 anisble_host=10.1.1.71</span><br><span class=\"line\"> </span><br><span class=\"line\">[testB:vars]</span><br><span class=\"line\">test_group_var1=<span class=\"string\">'group var test'</span></span><br><span class=\"line\">test_group_var2=<span class=\"string\">'group var test2'</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[YAML] 格式</span></span><br><span class=\"line\">all:</span><br><span class=\"line\"> children:</span><br><span class=\"line\">   testB:</span><br><span class=\"line\">     hosts:</span><br><span class=\"line\">       test70:</span><br><span class=\"line\">         ansible_host: 10.1.1.70</span><br><span class=\"line\">         ansible_port: 22</span><br><span class=\"line\">       test71:</span><br><span class=\"line\">         ansible_host: 10.1.1.71</span><br><span class=\"line\">         ansible_port: 22</span><br><span class=\"line\">     vars:</span><br><span class=\"line\">       test_group_var1: <span class=\"string\">'group var test1'</span></span><br><span class=\"line\">       test_group_var2: <span class=\"string\">'group var test2'</span></span><br></pre></td></tr></table></figure><br>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ansible</span> ops -m shell -a <span class=\"string\">\"echo -e test_group_var1= &#123;&#123;test_group_var1&#125;&#125;, \\n test_group_var2 = &#123;&#123;test_group_var2&#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\"># 10.20.172.179 | CHANGED | rc=0 &gt;&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># test_group_var1=group var test1, test_group_var2 =group var test2</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>set_fact定义变量</strong><br>描述：set_fact是一个模块，我们可以通过set_fact模块在tasks中定义变量,并且与register的功能很相似，也是将值赋值给变量。它更像shell中变量的赋值方式，可以将某个变量的值赋值给另一个变量，也可以将字符串赋值给变量。</p>\n<p>其实通过set_fact模块创建的变量还有一个特殊性，通过set_fact创建的变量就像主机上的facts信息一样<code>可以在之后的play中被引用</code>,而直接在play中采用vars设置变量只能在当前主机</p>\n<p>基础示例：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat &gt; setfact.yml&lt;&lt;end</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    testvar1:</span> <span class=\"string\">tv1</span>    <span class=\"comment\">#关键点-只能在当前主机中使用</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"test shell return variable\"</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">\"echo setfact module\"</span></span><br><span class=\"line\"><span class=\"attr\">    register:</span> <span class=\"string\">revar</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">setfact</span> <span class=\"string\">moudle</span> <span class=\"string\">setting</span></span><br><span class=\"line\"><span class=\"attr\">    set_fact:</span></span><br><span class=\"line\"><span class=\"attr\">      testvar2:</span> <span class=\"string\">tv2</span>  <span class=\"comment\">#关键点-可以在随后的play中任意主机调用使用</span></span><br><span class=\"line\"><span class=\"attr\">      testvar3:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;revar.cmd&#125;&#125;</span>\"</span>  <span class=\"comment\">#关键点-变量给变量赋值</span></span><br><span class=\"line\"><span class=\"attr\">      cacheable:</span> <span class=\"literal\">yes</span>  <span class=\"comment\">#示例设置事实，以便它们将保留在事实缓存中</span></span><br><span class=\"line\"><span class=\"attr\">  - debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"Local host : <span class=\"template-variable\">&#123;&#123;testvar1&#125;&#125;</span> - <span class=\"template-variable\">&#123;&#123;testvar2&#125;&#125;</span> -  <span class=\"template-variable\">&#123;&#123;testvar3&#125;&#125;</span> - <span class=\"template-variable\">&#123;&#123;revar.cmd&#125;&#125;</span>\"</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"other play get testvar2\"</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;testvar2&#125;&#125;</span>\"</span>  <span class=\"comment\">#有set_fact模块创建可以被第二个play引用</span></span><br><span class=\"line\">  <span class=\"comment\"># - name: \"other play get testvar1\"   </span></span><br><span class=\"line\">  <span class=\"comment\">#   debug:</span></span><br><span class=\"line\">  <span class=\"comment\">#     msg: \"&#123;&#123;testvar1&#125;&#125;\"   #不能被第二play引用会报错(所以这里注释一哈)</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"other play get testvar3\"</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;testvar3&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"show execute command\"</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;revar.cmd&#125;&#125;</span>\"</span>   <span class=\"comment\">#注册的变量也能在第二个play中使用</span></span><br><span class=\"line\"><span class=\"string\">end</span></span><br></pre></td></tr></table></figure><br>执行结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ansible</span>-playbook setfact.yml</span><br><span class=\"line\"><span class=\"comment\"># TASK [debug]</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"Local host : tv1 - tv2 -  echo setfact module - echo setfact module\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># TASK [other play get testvar2] </span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"tv2\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># TASK [other play get testvar3] </span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"echo setfact module\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ok: [local] </span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"echo setfact modu</span></span><br></pre></td></tr></table></figure></p>\n<p><em>总结：</em></p>\n<ul>\n<li>shell模块注册变量在全局play中皆可用,但是不是变量自定义信息;</li>\n<li>set_fact模块中建立的变量或者引用的变量在全局中即可用</li>\n<li>补充参考：<a href=\"https://www.cnblogs.com/f-ck-need-u/p/7571974.html#1\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/f-ck-need-u/p/7571974.html#1</a></li>\n</ul>\n<p><br></p>\n<h5 id=\"8-内置变量\"><a href=\"#8-内置变量\" class=\"headerlink\" title=\"(8) 内置变量\"></a>(8) 内置变量</h5><p>ansible中还有一些内置变量可供我们使用，内置变量的变量名是被ansible保留的，当我们定义变量时不能使用这些变量名。</p>\n<p><em>内置变量一览表：</em></p>\n<ul>\n<li>1.ansible_version : 获取到ansible的版本号</li>\n<li>2.inventory_dir : 获取到ansible主机中清单文件的存放路径，ansible默认的清单文件/etc/ansible/hosts</li>\n<li>3.inventory_hostname: 获取到被操作的当前主机的主机名称(对应主机在清单中配置的名称)</li>\n<li>4.inventory_hostname_short : 与内置变量inventory_hostname类似但是这个名称更加简短；</li>\n<li>5.groups : 获取到清单中”所有分组”的”分组信息”</li>\n<li>6.group_names : 获取到当前主机所在分组的组名</li>\n<li>7.hostvars : 帮助我们在操作当前主机时获取到其他主机中的信息</li>\n<li>8.play_hosts : 获取到当前play所操作的所有主机的主机名列表</li>\n</ul>\n<p>内置变量使用案例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1.直接采用ansible命令行输出内置变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#-----ansible_version------</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m debug -a <span class=\"string\">\"msg='当前Ansible版本号: &#123;&#123;ansible_version&#125;&#125;'\"</span></span><br><span class=\"line\"><span class=\"comment\"># local | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"Ansible Version :  &#123;'major': 2, 'full': '2.8.1', 'string': '2.8.1', 'minor': 8, 'revision': 1&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#-----inventory_dir------</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m debug -a <span class=\"string\">\"msg='Current Hosts Configure: &#123;&#123;inventory_dir&#125;&#125;'\"</span></span><br><span class=\"line\"><span class=\"comment\"># local | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"Current Hosts Configure: /etc/ansible\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#-----inventory_hostname*------</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span> <span class=\"built_in\">local</span> -m debug -a <span class=\"string\">\"msg=&#123;&#123;inventory_hostname&#125;&#125;\"</span>   <span class=\"comment\">#主机清单中的长主机名称</span></span><br><span class=\"line\"><span class=\"comment\"># local | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"local\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># local | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"local\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\">#无论是IP还是别名，如果清单的主机名称中包含\".\"，inventory_hostname_short都会取得主机名中第一\".\"之前的字符作为主机的简短名称。</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span> testA -m debug -a <span class=\"string\">\"msg=&#123;&#123;inventory_hostname&#125;&#125;\"</span> </span><br><span class=\"line\"><span class=\"comment\"># 10.10.107.221 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"10.10.107.221\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span> testA -m debug -a <span class=\"string\">\"msg=&#123;&#123;inventory_hostname_short&#125;&#125;\"</span> <span class=\"comment\">#主机清单中的短主机名称</span></span><br><span class=\"line\"><span class=\"comment\"># 10.10.107.221 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": \"10\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#-----groups*------</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m debug -a <span class=\"string\">\"msg=&#123;&#123;groups&#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\"># local | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#         \"all\": [</span></span><br><span class=\"line\"><span class=\"comment\">#             \"local\",</span></span><br><span class=\"line\"><span class=\"comment\">#             \"10.10.107.221\",</span></span><br><span class=\"line\"><span class=\"comment\">#             \"10.20.172.179\"</span></span><br><span class=\"line\"><span class=\"comment\">#         ],</span></span><br><span class=\"line\"><span class=\"comment\">#         \"ops\": [</span></span><br><span class=\"line\"><span class=\"comment\">#             \"10.10.107.221\",</span></span><br><span class=\"line\"><span class=\"comment\">#             \"10.20.172.179\"</span></span><br><span class=\"line\"><span class=\"comment\">#         ],</span></span><br><span class=\"line\"><span class=\"comment\">#         \"testA\": [</span></span><br><span class=\"line\"><span class=\"comment\">#             \"10.10.107.221\"</span></span><br><span class=\"line\"><span class=\"comment\">#         ],</span></span><br><span class=\"line\"><span class=\"comment\">#         \"testB\": [</span></span><br><span class=\"line\"><span class=\"comment\">#             \"10.20.172.179\"</span></span><br><span class=\"line\"><span class=\"comment\">#         ],</span></span><br><span class=\"line\"><span class=\"comment\">#         \"ungrouped\": [</span></span><br><span class=\"line\"><span class=\"comment\">#             \"local\"</span></span><br><span class=\"line\"><span class=\"comment\">#         ]</span></span><br><span class=\"line\"><span class=\"comment\">#     &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m debug -a <span class=\"string\">\"msg=&#123;&#123;groups.testA&#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\"># local | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": [</span></span><br><span class=\"line\"><span class=\"comment\">#         \"10.10.107.221\"</span></span><br><span class=\"line\"><span class=\"comment\">#     ]</span></span><br><span class=\"line\">ansible ops -m debug -a <span class=\"string\">\"msg=&#123;&#123;groups['ungrouped']&#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\"># 10.10.107.221 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": [</span></span><br><span class=\"line\"><span class=\"comment\">#         \"local\"</span></span><br><span class=\"line\"><span class=\"comment\">#     ]</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># 10.20.172.179 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": [</span></span><br><span class=\"line\"><span class=\"comment\">#         \"local\"</span></span><br><span class=\"line\"><span class=\"comment\">#     ]</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#-----group_names------</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m debug -a <span class=\"string\">\"msg=&#123;&#123;group_names&#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\"># local | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": [</span></span><br><span class=\"line\"><span class=\"comment\">#         \"ungrouped\"</span></span><br><span class=\"line\"><span class=\"comment\">#     ]</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">ansible testA -m debug -a <span class=\"string\">\"msg=&#123;&#123;group_names&#125;&#125;\"</span></span><br><span class=\"line\"><span class=\"comment\"># 10.10.107.221 | SUCCESS =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     \"msg\": [</span></span><br><span class=\"line\"><span class=\"comment\">#         \"ops\",</span></span><br><span class=\"line\"><span class=\"comment\">#         \"testA\"</span></span><br><span class=\"line\"><span class=\"comment\">#     ]</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br></pre></td></tr></table></figure></p>\n<p><em>重点介绍：hostvars 变量内置</em><br>描述：通过”set_fact”结合”hostvars”的方式，实现了跨play获取其他主机中的变量信息的功能还是很方便的，并且通过gather_facts关键字来控制当前play是否收集对应主机的facts信息[yes|no]</p>\n<p>实际案例1：hostvars 与 play_hosts内置变量联合使用<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat &gt; gatherfcats.yml &lt;&lt;end</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">\"Play1 : Gather facts of local\"</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">local,testB</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"show play hosts\"</span></span><br><span class=\"line\"><span class=\"attr\">    debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"Play1 -&gt; play include hosts : <span class=\"template-variable\">&#123;&#123;play_hosts&#125;&#125;</span>\"</span>  <span class=\"comment\">#当前play包含的hosts</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">\"Play2: Gather facts\"</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">testA,testB</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - debug:</span> </span><br><span class=\"line\"><span class=\"attr\">     msg:</span> <span class=\"string\">\"Play2 -&gt; Local IP : <span class=\"template-variable\">&#123;&#123;hostvars['local'].ansible_default_ipv4&#125;&#125;</span>\"</span>  <span class=\"comment\">#调用Gather中收集local主机中的IP地址信息</span></span><br><span class=\"line\"><span class=\"attr\">  - debug:</span> </span><br><span class=\"line\"><span class=\"attr\">     msg:</span> <span class=\"string\">\"Play2 -&gt; Local interface : <span class=\"template-variable\">&#123;&#123;hostvars['local'].ansible_default_ipv4.interface&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"string\">end</span></span><br></pre></td></tr></table></figure></p>\n<p>执行结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#关键点1</span></span><br><span class=\"line\">TASK [Gathering Facts] </span><br><span class=\"line\">ok: [10.20.172.179]</span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>] </span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"Play1 -&gt; play include hosts : [u'local', u'10.20.172.179']\"</span></span><br><span class=\"line\">ok: [10.20.172.179]</span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"Play1 -&gt; play include hosts : [u'local', u'10.20.172.179']\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts]</span><br><span class=\"line\">ok: [10.20.172.179]</span><br><span class=\"line\">ok: [10.10.107.221]</span><br><span class=\"line\"></span><br><span class=\"line\">ok: [10.10.107.221] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"Play2 -&gt; Local IP : &#123;u'macaddress': u'00:50:56:b3:dc:b4', u'network': u'10.10.107.0', u'mtu': 1500, u'broadcast': u'10.10.107.255', u'alias': u'ens192', u'netmask': u'255.255.255.0', u'address': u'10.10.107.222', u'interface': u'ens192', u'type': u'ether', u'gateway': u'10.10.107.1'&#125;\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">.....</span><br><span class=\"line\"></span><br><span class=\"line\">ok: [10.20.172.179] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"Play2 -&gt; Local interface : ens192\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure></p>\n<p>使用”gather_facts”关键字可以控制play是否进行Gathering Facts主机的信息收集;</p>\n<ul>\n<li>第一个play中的”gather_facts: no”表示设置当前play不收集对应主机的信息，无法获取到local主机中的facts信息，原因是local的facts信息并未被收集过，所以调用其他主机的facts信息的前提是对应主机的facts信息已经被收集过。</li>\n<li>其实除了facts信息，我们还能够利用hostvars内置变量从别的主机中获取到其他类型的一些变量信息，比如其他主机的注册变量、主机变量、组变量等信息，还有就是注册变量<code>并不用像facts信息那样需要事先收集</code>，即可直接通过hostvars跨主机被引用到；</li>\n</ul>\n<p>实际案例2：hostvars 与 gather_fcats 与 set_fact模块案例：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat &gt; gatherfcats1.yml &lt;&lt;end</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">\"Play 1 - local\"</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  gather_facts:</span> <span class=\"literal\">no</span>  <span class=\"comment\">#由于不进行信息收集其他play无法调用该主机的facts信息，执行速度有所提升;</span></span><br><span class=\"line\"><span class=\"attr\">  vars:</span></span><br><span class=\"line\"><span class=\"attr\">    testvar:</span> <span class=\"string\">\"通过vars关键字定义的变量方法是无法被跨主机引用的\"</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"setfact module settting\"</span></span><br><span class=\"line\"><span class=\"attr\">    set_fact:</span>  <span class=\"comment\">#但是可以通过set_fact模块与hostvars来进行跨主机引用(重要)(与gather_facts关键字无关)</span></span><br><span class=\"line\"><span class=\"attr\">      var1:</span> <span class=\"string\">\"gather_facts settting no\"</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"show set_fact\"</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">\"echo <span class=\"template-variable\">&#123;&#123;var1&#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">    register:</span> <span class=\"string\">shellrst</span> <span class=\"comment\">#注册变量也能进行hostvars跨主机调用(与gather_facts关键字无关)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">\"Play 2 - testA \"</span></span><br><span class=\"line\"><span class=\"attr\">  hosts:</span> <span class=\"string\">testA</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"Play 1 hostvars : <span class=\"template-variable\">&#123;&#123;hostvars.local.var1&#125;&#125;</span> , Play 1 register shell command: <span class=\"template-variable\">&#123;&#123;hostvars.local.shellrst['cmd']&#125;&#125;</span>\"</span>  <span class=\"comment\">#但是可以采用hostvars来进行跨主机引用set_fact模块设置的变量</span></span><br><span class=\"line\">      <span class=\"comment\">#msg: \"play 1 中的 &#123;hostvars['local'].ansible_default_ipv4 不能被调用由于根本没有进行gathering facts主机信息收集\"</span></span><br><span class=\"line\">      <span class=\"comment\">#msg: \"play 1 中的 testvar 变量不能被引用 &#123;&#123;testvar&#125;&#125; \"</span></span><br><span class=\"line\"><span class=\"string\">end</span></span><br></pre></td></tr></table></figure><br>执行结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TASK [debug]</span><br><span class=\"line\">ok: [10.10.107.221] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"Play 1 hostvars : gather_facts settting no , Play 1 register shell command: echo gather_facts settting no\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"9-include-vars-更新变量文件\"><a href=\"#9-include-vars-更新变量文件\" class=\"headerlink\" title=\"(9) include_vars 更新变量文件\"></a>(9) include_vars 更新变量文件</h5><p>描述：前面我们学习了var_files也知道了它的应用场景,但是使用var_files有一个缺点,就是当变量文件动态的被添加变量的时候,其后的playbook并不能读取变化增加的变量值;</p>\n<p>但是我们可以依靠<code>include_vars模块</code>能够在任务执行过程中，随时的引入变量文件，以便动态的获取到最新的变量文件内容;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#两种语法方式(模块参数介绍请参考Ansible模块介绍)</span></span><br><span class=\"line\">- include_vars:</span><br><span class=\"line\">    file: /testdir/ansible/testfile</span><br><span class=\"line\">- include_vars: <span class=\"string\">\"/testdir/ansible/testfile\"</span></span><br></pre></td></tr></table></figure></p>\n<p>基础示例：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat &gt; include_vars_demo.yml&lt;&lt;END</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\"><span class=\"attr\">  vars_files:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">/tmp/ansible/demo1/var.yml</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;test1&#125;&#125;</span> <span class=\"template-variable\">&#123;&#123;test2&#125;&#125;</span>\"</span>  <span class=\"comment\">#由于testvar2已经加入到了变量文件中,所有显示OK</span></span><br><span class=\"line\"><span class=\"attr\">  - lineinfile:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/tmp/ansible/demo1/var.yml</span> <span class=\"comment\">#修改添加变量文件</span></span><br><span class=\"line\"><span class=\"attr\">      line:</span> <span class=\"string\">\"testvar4: add\"</span></span><br><span class=\"line\"><span class=\"attr\">  - include_vars:</span> </span><br><span class=\"line\"><span class=\"attr\">      file:</span> <span class=\"string\">/tmp/ansible/demo1/var.yml</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">trans_var</span>  <span class=\"comment\">#关键点将变量文件中变量全部赋值给另外trans_var变量</span></span><br><span class=\"line\">  <span class=\"comment\">#'include_vars'模块重新加载了变量文件</span></span><br><span class=\"line\"><span class=\"attr\">  - debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"include_vars - <span class=\"template-variable\">&#123;&#123;trans_var.testvar4&#125;&#125;</span>\"</span>  <span class=\"comment\"># 成功调用了trans_var.testvar4变量</span></span><br><span class=\"line\"><span class=\"attr\">  - include_vars:</span> </span><br><span class=\"line\"><span class=\"attr\">      dir:</span> <span class=\"string\">/tmp/ansible/demo2/</span>   <span class=\"comment\">#夹杂这个文件中为.yaml / yml / json </span></span><br><span class=\"line\"><span class=\"attr\">      files_matching:</span> <span class=\"string\">\"^var.*\"</span> <span class=\"comment\">#加载指定目录中以\\\"var_\\\"开头的变量文件</span></span><br><span class=\"line\"><span class=\"attr\">      ignore_files:</span> <span class=\"string\">[\"^var_.*\",varintest.yaml]</span> <span class=\"comment\">#明确指定需要忽略的变量文件名称的列表</span></span><br><span class=\"line\"><span class=\"attr\">      extensions:</span> <span class=\"string\">[yaml,yml,json,varfile]</span> <span class=\"comment\">#允许的扩展</span></span><br><span class=\"line\"><span class=\"attr\">      depth:</span> <span class=\"number\">1</span> <span class=\"comment\">#递归深度</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">var</span>  <span class=\"comment\">#关键点将变量文件中变量全部赋值给另外</span></span><br><span class=\"line\"><span class=\"attr\">    register:</span> <span class=\"string\">returnval</span></span><br><span class=\"line\"><span class=\"attr\">  - debug:</span></span><br><span class=\"line\"><span class=\"attr\">      msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123;var&#125;&#125;</span> -&gt; <span class=\"template-variable\">&#123;&#123;returnval.ansible_included_var_files&#125;&#125;</span>\"</span>  <span class=\"comment\"># 调用var重新赋值的变量;</span></span><br><span class=\"line\"><span class=\"string\">END</span></span><br></pre></td></tr></table></figure><br>执行结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#TASK [debug]</span></span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>] =&gt; &#123;<span class=\"string\">\"msg\"</span>: <span class=\"string\">\"qixi happy\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#TASK [lineinfile]</span></span><br><span class=\"line\">changed: [<span class=\"built_in\">local</span>]</span><br><span class=\"line\"><span class=\"comment\">#TASK [include_vars] </span></span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#TASK [debug]</span></span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>] =&gt; &#123;<span class=\"string\">\"msg\"</span>: <span class=\"string\">\"include_vars - add\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#TASK [include_vars] </span></span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>]</span><br><span class=\"line\"><span class=\"comment\">#TASK [debug]</span></span><br><span class=\"line\">ok: [<span class=\"built_in\">local</span>] =&gt; &#123; <span class=\"string\">\"msg\"</span>: <span class=\"string\">\"&#123;u'test3': u'include_varDemo', u'test4': u'WeiyiGeek'&#125; -&gt; [u'/tmp/ansible/demo2/var.yml']\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#PLAY RECAP </span></span><br><span class=\"line\"><span class=\"built_in\">local</span>                      : ok=6    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"自动化运维","path":"api/categories/自动化运维.json"},{"name":"运维基础","path":"api/categories/运维基础.json"}],"tags":[{"name":"Ansible","path":"api/tags/Ansible.json"}]}