{"title":"Grafana基础介绍与可视化快速入门","slug":"数据分析/可视化工具/Grafana基础介绍与可视化快速入门","date":"2019-05-17T11:34:30.000Z","updated":"2023-01-31T02:29:10.675Z","url":"2019/5-17-39.html","path":"api/articles/2019/5-17-39.html.json","covers":["https://img.weiyigeek.top/2019/20190516170734.png","https://img.weiyigeek.top/2021/5/20210506144815.png","https://img.weiyigeek.top/2021/5/20210506165636.png","https://img.weiyigeek.top/2021/5/20210626213014.png","https://img.weiyigeek.top/2021/5/20210626222101.png","https://img.weiyigeek.top/2021/5/20210626214737.png","https://img.weiyigeek.top/2022/5/20220717112327.png","https://img.weiyigeek.top/2022/5/20220717105805.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><h3 id=\"1-Grafana-介绍\"><a href=\"#1-Grafana-介绍\" class=\"headerlink\" title=\"1) Grafana 介绍\"></a>1) Grafana 介绍</h3><p>描述: Grafana是一个用Javascript写的开源的(Dashboard)可视化面板，能齐全的度量仪表盘和图形编辑器和漂亮的布局展示，并且支持Graphite、elasticsearch、zabbix等的数据可视化的实现，可以给你的数据换个皮肤，使你的数据展示更加直观和漂亮。</p>\n<p><br></p>\n<h3 id=\"2-Grafana-专有术语介绍\"><a href=\"#2-Grafana-专有术语介绍\" class=\"headerlink\" title=\"2) Grafana 专有术语介绍\"></a>2) Grafana 专有术语介绍</h3><ul>\n<li>仪表盘面板: Grafana 数据展示的界面，里面的面板是包含图形、表格或其它可视信息的矩形区域。</li>\n<li>数据源: Grafana 从数据源中获取用来绘图的信息，它目前支持主流开箱即用的数据源，例如<code>OpenTSDB、PostgreSQL</code>，我们的Prometheus就是采用TSDB时序数据库。</li>\n</ul>\n<p><br></p>\n<h3 id=\"3-Grafana-学习参考\"><a href=\"#3-Grafana-学习参考\" class=\"headerlink\" title=\"3) Grafana 学习参考\"></a>3) Grafana 学习参考</h3><p>Grafana官网链接，内含各种官方文档(包括仪表盘设置等)：<br><a href=\"http://docs.grafana.org/installation/rpm/\" target=\"_blank\" rel=\"noopener\">http://docs.grafana.org/installation/rpm/</a></p>\n<p>项目地址: <a href=\"https://github.com/grafana/grafana/\" target=\"_blank\" rel=\"noopener\">https://github.com/grafana/grafana/</a><br>官方地址: <a href=\"https://grafana.com\" target=\"_blank\" rel=\"noopener\">https://grafana.com</a> </p>\n<hr>\n<h2 id=\"0x01-安装部署\"><a href=\"#0x01-安装部署\" class=\"headerlink\" title=\"0x01 安装部署\"></a>0x01 安装部署</h2><h3 id=\"1-CentOS7安装Grafana\"><a href=\"#1-CentOS7安装Grafana\" class=\"headerlink\" title=\"1.CentOS7安装Grafana\"></a>1.CentOS7安装Grafana</h3><p><strong>安装环境：</strong><br>CentOS Linux release 7.6.1810 (Core) 3.10.0-957.10.1.el7.x86_64</p>\n<p><br/></p>\n<p><strong>安装实践</strong></p>\n<ul>\n<li><p>1.yum方式安装grafana最新版本6.1.6</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm</span><br><span class=\"line\">sudo yum localinstall grafana-6.1.6-1.x86_64.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装好后守护进程重启</span></span><br><span class=\"line\">$ systemctl daemon-reload</span><br><span class=\"line\">$ systemctl start grafana-server</span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> grafana-server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#初始化插件安装</span></span><br><span class=\"line\">$ yum -y install fontconfig freetype* urw-fonts  <span class=\"comment\">#服务器端图像是一项可选功能</span></span><br><span class=\"line\">$ systemctl start grafana-server</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.docker方式安装,注意默认安装最新版本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --name=grafana -p 3000:3000 grafana/grafana </span><br><span class=\"line\"></span><br><span class=\"line\">tee docker-compose.yml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">version: <span class=\"string\">'3.2'</span></span><br><span class=\"line\">services:</span><br><span class=\"line\">  grafana:</span><br><span class=\"line\">    image: grafana/grafana:7.5.5</span><br><span class=\"line\">    container_name: grafana</span><br><span class=\"line\">    user: <span class=\"string\">\"472\"</span></span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - TZ=Asia/Shanghai</span><br><span class=\"line\">      - GF_SECURITY_ADMIN_PASSWORD=weiyigeek</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - /nfsdisk-31/monitor/grafana/data:/var/lib/grafana</span><br><span class=\"line\">      - /etc/localtime:/etc/localtime</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - <span class=\"string\">'3000:3000'</span></span><br><span class=\"line\">    restart: always</span><br><span class=\"line\">    dns:</span><br><span class=\"line\">      - 223.6.6.6</span><br><span class=\"line\">      - 192.168.12.254</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>3.二进制方式安装Grafana,安装完成后访问主机的3000端口即可,<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.3.2.linux-x64.tar.gz </span><br><span class=\"line\">tar -zxvf grafana-4.3.2.linux-x64.tar.gz</span><br><span class=\"line\">mv grafana-4.3.2 grafana</span><br><span class=\"line\"><span class=\"built_in\">cd</span> grafana/bin/</span><br><span class=\"line\"><span class=\"comment\">#查看可以安装的插件</span></span><br><span class=\"line\">./grafana-cli plugins list-remote</span><br><span class=\"line\"><span class=\"comment\">#安装zabbix插件</span></span><br><span class=\"line\">./grafana-cli plugins install alexanderzobnin-zabbix-app</span><br><span class=\"line\"><span class=\"comment\">#安装饼图插件</span></span><br><span class=\"line\">./grafana-cli plugins install grafana-piechart-panel</span><br><span class=\"line\"><span class=\"comment\">#启动，并后台运行</span></span><br><span class=\"line\">./grafana-server -homepath /opt/grafana/grafana &amp;</span><br></pre></td></tr></table></figure>\n温馨提示: 第一次登陆默认密码为admin/admin<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190516170734.png\" alt=\"WeiyiGeek.grafana登陆\" title=\"\" class=\"\">\n                <p>WeiyiGeek.grafana登陆</p>\n            </figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>4.以 Kubernetes 集群中安装部署 Grafana 可视化 (补充时间2022年6月1日 15:03:11)<br>安装参考: <a href=\"https://grafana.com/docs/grafana/latest/installation/kubernetes/#create-grafana-kubernetes-manifest\" target=\"_blank\" rel=\"noopener\">https://grafana.com/docs/grafana/latest/installation/kubernetes/#create-grafana-kubernetes-manifest</a></li>\n</ul>\n<p><strong>资源清单方式:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /app/grafana &amp;&amp; chown -R 472:0 /app/grafana</span><br><span class=\"line\">tee grafana.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: grafana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      securityContext:</span><br><span class=\"line\">        fsGroup: 472</span><br><span class=\"line\">        supplementalGroups: 0</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: grafana</span><br><span class=\"line\">          image: grafana/grafana:8.5.4</span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 3000</span><br><span class=\"line\">              name: http-grafana</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /robots.txt</span><br><span class=\"line\">              port: 3000</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            initialDelaySeconds: 10</span><br><span class=\"line\">            periodSeconds: 30</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 2</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            initialDelaySeconds: 30</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            tcpSocket:</span><br><span class=\"line\">              port: 3000</span><br><span class=\"line\">            timeoutSeconds: 1</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 250m</span><br><span class=\"line\">              memory: 750Mi</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">          - mountPath: /var/lib/grafana</span><br><span class=\"line\">            name: grafana-pv</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: grafana-pv</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /app/grafana</span><br><span class=\"line\">          <span class=\"built_in\">type</span>: DirectoryOrCreate</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 3000</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: http-grafana</span><br><span class=\"line\">      nodePort: 30002</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f grafana.yaml</span><br><span class=\"line\">kubectl get pod</span><br><span class=\"line\">  <span class=\"comment\"># NAME                      READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># grafana-f6799b947-rl47d   1/1     Running   0          45m</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"2-Ubuntu-20-04安装Grafana\"><a href=\"#2-Ubuntu-20-04安装Grafana\" class=\"headerlink\" title=\"2.Ubuntu 20.04安装Grafana\"></a>2.Ubuntu 20.04安装Grafana</h3><p><br/></p>\n<p><strong>1) 资源清单部署方式</strong></p>\n<p>步骤 01.资源清单（granana.ini）与 （Deployment）部署资源清单。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee grafana.ini &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[server]</span><br><span class=\"line\">domain = devops.weiyigeek.top</span><br><span class=\"line\">root_url = %(protocol)s://%(domain)s:%(http_port)s/grafana/</span><br><span class=\"line\">serve_from_sub_path = <span class=\"literal\">true</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">tee grafana-deploy.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana-pvc</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 2Gi</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: grafana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      securityContext:</span><br><span class=\"line\">        fsGroup: 472</span><br><span class=\"line\">        supplementalGroups:</span><br><span class=\"line\">          - 0</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: grafana</span><br><span class=\"line\">          image: grafana/grafana:9.0.2</span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 3000</span><br><span class=\"line\">              name: http-grafana</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /robots.txt</span><br><span class=\"line\">              port: 3000</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            initialDelaySeconds: 10</span><br><span class=\"line\">            periodSeconds: 30</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 2</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            initialDelaySeconds: 30</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            tcpSocket:</span><br><span class=\"line\">              port: 3000</span><br><span class=\"line\">            timeoutSeconds: 1</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 512m</span><br><span class=\"line\">              memory: 1024Mi</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: /var/lib/grafana</span><br><span class=\"line\">              name: grafana-pv</span><br><span class=\"line\">            - mountPath: /etc/grafana/grafana.ini</span><br><span class=\"line\">              name: ge-config</span><br><span class=\"line\">              subPath: grafana.ini</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: grafana-pv</span><br><span class=\"line\">          persistentVolumeClaim:</span><br><span class=\"line\">            claimName: grafana-pvc</span><br><span class=\"line\">        - name: ge-config</span><br><span class=\"line\">          configMap:</span><br><span class=\"line\">            name: ge-config</span><br><span class=\"line\">            items:</span><br><span class=\"line\">            - key: grafana.ini</span><br><span class=\"line\">              path: grafana.ini</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 3000</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: http-grafana</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: LoadBalancer</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>步骤 02.创建 grafana.ini 的 configmap 以及部署 grafana 到集群中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap ge-config --from-file=grafana.ini --namespace dashboard</span><br><span class=\"line\">kubectl create -f grafana-deploy.yaml --namespace dashboard</span><br></pre></td></tr></table></figure></p>\n<p>步骤 03.部署情况与日志情况查看。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs -f --tail 50 -n dashboard -l app=grafana</span><br><span class=\"line\">  <span class=\"comment\"># 关键日志:</span></span><br><span class=\"line\">  <span class=\"comment\"># logger=http.server t=2022-07-14T07:24:25.409774065Z level=info msg=\"HTTP Server Listen\" address=[::]:3000 protocol=http subUrl=/grafana socket=</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 04.配置 grafana ingress 的资源清单我们便可通过<code>域名+grafana目录</code>的方式进行访问。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    ingressclass.kubernetes.io/is-default-class: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/client-body-buffer-size: 50m</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-body-size: 50m</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-buffer-size: 50m</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-buffering: <span class=\"string\">\"on\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-buffers-number: <span class=\"string\">\"4\"</span></span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-connect-timeout: 60s</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-read-timeout: 120s</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-send-timeout: 120s</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/rewrite-target: /<span class=\"variable\">$2</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: devops</span><br><span class=\"line\">    ref: devops</span><br><span class=\"line\">    url: devops.weiyigeek.top</span><br><span class=\"line\">  name: devops-weiyigeek</span><br><span class=\"line\">  namespace: dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ingressClassName: nginx</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - host: devops.weiyigeek.top</span><br><span class=\"line\">    http:</span><br><span class=\"line\">      paths:</span><br><span class=\"line\">      - backend:</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: grafana</span><br><span class=\"line\">            port:</span><br><span class=\"line\">              number: 3000</span><br><span class=\"line\">        path: /grafana(/|$)(.*)</span><br><span class=\"line\">        pathType: ImplementationSpecific</span><br><span class=\"line\">  tls:</span><br><span class=\"line\">  - hosts:</span><br><span class=\"line\">    - devops.weiyigeek.top</span><br><span class=\"line\">    secretName: weiyigeek.top</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 在进行前面操作完毕后我们便可通过<code>https://devops.weiyigeek.top/grafana/login</code>域名地址进行访问，默认密码 admin。</p>\n<p><br/></p>\n<p><strong>helm3 方式安装</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm repo add grafana https://grafana.github.io/helm-charts</span><br><span class=\"line\">helm repo update</span><br><span class=\"line\">helm search repo grafana</span><br><span class=\"line\">helm show values grafana/grafana --version 6.29.5 &gt; granfa-values.yaml   <span class=\"comment\"># 指定chat版本的granfa相关部署参数</span></span><br><span class=\"line\">helm install grafana grafana/grafana --version 6.29.5 --<span class=\"built_in\">set</span> nodeSelector=<span class=\"string\">\"kubernetes\\.io/hostname=node-223\"</span>,service.type=NodePort,persistence.enabled=True,persistence.storageClassName=<span class=\"string\">\"managed-nfs-storage\"</span>,persistence.size=5Gi,persistence.accessModes=ReadWriteOnce -n devops --debug  <span class=\"comment\"># 安装指定chat版本以及部署参数</span></span><br><span class=\"line\">helm upgrade grafana grafana/grafana --version 6.29.5 --<span class=\"built_in\">set</span> nodeSelector=<span class=\"string\">\"kubernetes\\.io/hostname=node-223\"</span>,service.type=NodePort,persistence.enabled=True,persistence.storageClassName=<span class=\"string\">\"managed-nfs-storage\"</span>,persistence.size=5Gi,persistence.accessModes=ReadWriteOnce -n devops --debug  <span class=\"comment\"># 更新指定chat版本以及部署参数</span></span><br><span class=\"line\">helm list -n devops</span><br><span class=\"line\">  <span class=\"comment\"># NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span></span><br><span class=\"line\">  <span class=\"comment\"># grafana devops          1               2022-06-01 13:53:51.751609203 +0800 CST deployed        grafana-6.29.5  8.5.3</span></span><br></pre></td></tr></table></figure></p>\n<p>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NOTES:</span><br><span class=\"line\">1. Get your <span class=\"string\">'admin'</span> user password by running:</span><br><span class=\"line\">  kubectl get secret --namespace devops grafana -o jsonpath=<span class=\"string\">\"&#123;.data.admin-password&#125;\"</span> | base64 --decode ; <span class=\"built_in\">echo</span>  </span><br><span class=\"line\">  <span class=\"comment\"># 例如: Y0GW80b6tsMhqO223zRfh0ONx2O8BovtYg3JAKHa</span></span><br><span class=\"line\"></span><br><span class=\"line\">2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster: grafana.devops.svc.cluster.local</span><br><span class=\"line\">  Get the Grafana URL to visit by running these commands <span class=\"keyword\">in</span> the same shell:</span><br><span class=\"line\">    <span class=\"built_in\">export</span> POD_NAME=$(kubectl get pods --namespace devops -l <span class=\"string\">\"app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana\"</span> -o jsonpath=<span class=\"string\">\"&#123;.items[0].metadata.name&#125;\"</span>)</span><br><span class=\"line\">    kubectl --namespace devops port-forward <span class=\"variable\">$POD_NAME</span> --address 0.0.0.0 30002:3000</span><br><span class=\"line\">3. Login with the password from step 1 and the username: admin</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x02-Granafa-入门使用\"><a href=\"#0x02-Granafa-入门使用\" class=\"headerlink\" title=\"0x02 Granafa 入门使用\"></a>0x02 Granafa 入门使用</h2><h3 id=\"1-基础配置\"><a href=\"#1-基础配置\" class=\"headerlink\" title=\"1) 基础配置\"></a>1) 基础配置</h3><h4 id=\"1-1-添加数据源\"><a href=\"#1-1-添加数据源\" class=\"headerlink\" title=\"1.1 添加数据源\"></a>1.1 添加数据源</h4><p>描述: 例如此次添加一个Prometheus数据源到Grafana，注意最后一定要点击<code>Save&amp;Test</code>来保证Grafana可以正常访问我们的Prometheus。</p>\n<p>操作步骤: 侧边栏 -&gt; Congiguration -&gt; Data Sources</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210506144815.png\" alt=\"WeiyiGeek.添加数据源\" title=\"\" class=\"\">\n                <p>WeiyiGeek.添加数据源</p>\n            </figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210506165636.png\" alt=\"WeiyiGeek.Prometheus监控数据源\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Prometheus监控数据源</p>\n            </figure>\n<p><br></p>\n<h3 id=\"2-仪表盘模板与面板\"><a href=\"#2-仪表盘模板与面板\" class=\"headerlink\" title=\"2) 仪表盘模板与面板\"></a>2) 仪表盘模板与面板</h3><h4 id=\"2-1-模板变量\"><a href=\"#2-1-模板变量\" class=\"headerlink\" title=\"2.1 模板变量\"></a>2.1 模板变量</h4><p>描述: 我们可以使用模板变量来切换到详细监控主机的相关信息，这个功能非常Nice也非常实用。</p>\n<ul>\n<li><p>Step 1.创建一个新的仪表盘，点击 + &gt; Create Dashboard -&gt; Add an empty Panel -&gt; 测试出现一个初始面板界面 -&gt; 点击Setting(右上角的齿轮) 。</p>\n</li>\n<li><p>Step 2.进入后点击 Varibales -&gt; 点击+add variable进行添加一个模板变量 -&gt; 设置变量名称OSRELEASE -&gt; Prometheus PromQL 为<code>node_uname_info</code> -&gt; 正则表达式来获取标签中的内核版本 -&gt; <code>.*release=&quot;(.*?)&quot;.*</code> -&gt; 点击update，我们可以仿照添加一个节点名称的变量以及网卡名称<code>node_network_receive_bytes_total</code> -&gt; <code>.*device=&quot;(docker.*?|eno.*?|ens.*?)&quot;.*</code>。</p>\n</li>\n<li><p>Step 3.回到Panel首页可以看到OSRELEASE 与 NODENAME 模板变量的下拉列表-&gt;最后点击 Save Dashboard (保存面板)。</p>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210626213014.png\" alt=\"WeiyiGeek.模板变量\" title=\"\" class=\"\">\n                <p>WeiyiGeek.模板变量</p>\n            </figure>\n<ul>\n<li>Step 4.使用模板变量，需要新建一个面板-&gt;输入<code>rate(node_network_receive_bytes_total{device=&quot;$Device&quot;}[5m])</code> -&gt; Legend 设置为 <code></code> Title 设置 Bytes/Received ，其中数据速率下的Unit 设置为bytes/sec，最后点击保存。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210626222101.png\" alt=\"WeiyiGeek.使用模板变量\" title=\"\" class=\"\">\n                <p>WeiyiGeek.使用模板变量</p>\n            </figure>\n<p><br></p>\n<h4 id=\"2-1-图形Panel\"><a href=\"#2-1-图形Panel\" class=\"headerlink\" title=\"2.1 图形Panel\"></a>2.1 图形Panel</h4><p>描述: 如其名称其主要用于显示图表。</p>\n<ul>\n<li><p>Step 1.进入面板编辑器点<code>Panel Title -&gt; 点击 Edit (快捷键e)</code> -&gt; 在metrics中输入查询表达式<code>node_memory_Active_bytes</code> .</p>\n</li>\n<li><p>Step 2.配置自定义图例标题和轴单位的内存使用情况。</p>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210626214737.png\" alt=\"WeiyiGeek.简单图表\" title=\"\" class=\"\">\n                <p>WeiyiGeek.简单图表</p>\n            </figure>\n<p><br></p>\n<h4 id=\"3-1-单一统计Panel\"><a href=\"#3-1-单一统计Panel\" class=\"headerlink\" title=\"3.1 单一统计Panel\"></a>3.1 单一统计Panel</h4><p>描述: 显示单个时间序列的值。</p>\n<ul>\n<li>Step 1.点击图表添加图表 -&gt; 添加单一统计Panel</li>\n</ul>\n<h3 id=\"3-基础控件\"><a href=\"#3-基础控件\" class=\"headerlink\" title=\"3) 基础控件\"></a>3) 基础控件</h3><h4 id=\"3-1-时间控件\"><a href=\"#3-1-时间控件\" class=\"headerlink\" title=\"3.1 时间控件\"></a>3.1 时间控件</h4><p>描述: 它可以选择时间范围和刷新频率，它适用于整个仪表盘但你也可以在每个Panel上覆盖配置。</p>\n<p>Tips: 当图表刷新时即使基础数据没有改变，但你也会注意到形状可能发生变化，这个情况被称为混叠的信号处理效果。</p>\n<hr>\n<h2 id=\"0x03-进阶扩展配置\"><a href=\"#0x03-进阶扩展配置\" class=\"headerlink\" title=\"0x03 进阶扩展配置\"></a>0x03 进阶扩展配置</h2><h3 id=\"0-Email-告警配置\"><a href=\"#0-Email-告警配置\" class=\"headerlink\" title=\"0.Email 告警配置\"></a>0.Email 告警配置</h3><p>描述: 在 Grafana 中提供了多种告警方式，其中最常用的就是邮箱告警, 下面我们来简单实践在Grafana中实现邮件告警。</p>\n<p>步骤 01.在 grafana 的主配置文件 grafana.ini 中开启 smtp 并配置相关参数（此处我采用了企业邮箱）：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat grafana.ini</span><br><span class=\"line\">....</span><br><span class=\"line\"><span class=\"section\">[smtp]</span></span><br><span class=\"line\">  enabled = true</span><br><span class=\"line\">  host = smtp.exmail.qq.com:465</span><br><span class=\"line\">  user = monitor@weiyigeek.top</span><br><span class=\"line\">  password = weiyigeek.top</span><br><span class=\"line\">  from_address = monitor@weiyigeek.top</span><br><span class=\"line\">  from_name = Grafana</span><br><span class=\"line\">  ehlo_identity = devops.weiyigeek.top</span><br></pre></td></tr></table></figure></p>\n<p>步骤 02.修改 grafana.ini 后便可重启 grafana 登陆其Dashboard ，点左菜单栏中🔔 (Alerting) -&gt;  Contact points (联络人) -&gt; 编辑 <code>grafana-default-email</code> 告警对象 -&gt; 选择触发对象为<code>email</code> -&gt; 输入测试邮箱 -&gt; 测试发信</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220717112327.png\" alt=\"WeiyiGeek.测试Email发信\" title=\"\" class=\"\">\n                <p>WeiyiGeek.测试Email发信</p>\n            </figure>\n<p>步骤 03.发信后你将会在其输入指定邮箱中，看到 Grafana 发送到你邮箱的告警信息。</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20220717105805.png\" alt=\"WeiyiGeek.Email告警配置验证\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Email告警配置验证</p>\n            </figure>\n<p><br></p>\n<hr>\n<h3 id=\"1-LDAP-认证配置\"><a href=\"#1-LDAP-认证配置\" class=\"headerlink\" title=\"1.LDAP 认证配置\"></a>1.LDAP 认证配置</h3><p>在 grafana 的主配置文件 grafana.ini 中开启 LDAP 认证：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[auth.ldap]</span></span><br><span class=\"line\"><span class=\"attr\">enabled</span> = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">config_file</span> = /etc/grafana/ldap.toml</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>config_file</code>指定grafana的ldap配置文件ldap.toml的具体位置 ldap.toml 配置文件的内容如下</li>\n</ul>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[[servers]]</span></span><br><span class=\"line\"><span class=\"attr\">host</span> = <span class=\"string\">\"127.0.0.1\"</span></span><br><span class=\"line\"><span class=\"attr\">port</span> = <span class=\"number\">389</span></span><br><span class=\"line\"><span class=\"attr\">use_ssl</span> = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">start_tls</span> = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">ssl_skip_verify</span> = <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">bind_dn</span> = <span class=\"string\">\"cn=Manager,dc=frognew,dc=com\"</span></span><br><span class=\"line\"><span class=\"attr\">bind_password</span> = <span class=\"string\">'thepassword'</span></span><br><span class=\"line\"><span class=\"attr\">search_filter</span> = <span class=\"string\">\"(cn=%s)\"</span></span><br><span class=\"line\"><span class=\"attr\">search_base_dns</span> = [<span class=\"string\">\"ou=People,dc=frognew,dc=com\"</span>]</span><br><span class=\"line\"><span class=\"attr\">group_search_base_dns</span> = [<span class=\"string\">\"ou=Group,dc=frognew,dc=com\"</span>]</span><br><span class=\"line\"><span class=\"attr\">group_search_filter</span> = <span class=\"string\">\"(&amp;(objectClass=posixGroup)(memberUid=%s))\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[servers.attributes]</span></span><br><span class=\"line\"><span class=\"attr\">name</span> = <span class=\"string\">\"givenName\"</span></span><br><span class=\"line\"><span class=\"attr\">surname</span> = <span class=\"string\">\"sn\"</span></span><br><span class=\"line\"><span class=\"attr\">username</span> = <span class=\"string\">\"cn\"</span></span><br><span class=\"line\"><span class=\"attr\">member_of</span> = <span class=\"string\">\"cn\"</span></span><br><span class=\"line\"><span class=\"attr\">email</span> =  <span class=\"string\">\"email\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[[servers.group_mappings]]</span></span><br><span class=\"line\"><span class=\"attr\">group_dn</span> = <span class=\"string\">\"grafana-admin\"</span></span><br><span class=\"line\"><span class=\"attr\">org_role</span> = <span class=\"string\">\"Admin\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[[servers.group_mappings]]</span></span><br><span class=\"line\"><span class=\"attr\">group_dn</span> = <span class=\"string\">\"grafana-editor\"</span></span><br><span class=\"line\"><span class=\"attr\">org_role</span> = <span class=\"string\">\"Editor\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[[servers.group_mappings]]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">group_dn</span> = <span class=\"string\">\"grafana-viewer\"</span></span><br><span class=\"line\"><span class=\"attr\">org_role</span> = <span class=\"string\">\"Viewer\"</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>host</code>和<code>port</code>指定LDAP Server的地址和端口</li>\n<li>因为我们使用的OpenLDAP，是没有memberOf属性的POSIX schema，所以获取用户的Group信息时需要另外一个查询，通过<code>group_search_base_dns</code>和<code>group_search_filter</code>，同事需要设置<code>member_of = &quot;cn&quot;</code></li>\n<li>servers.group_mappings中指定LDAP中Group和Grafan中<code>org_role</code>的对应关系，注意这里需要和配置成LDAP中Group的cn，这里配置的是<code>grafana-admin</code>、<code>grafana-editor</code>、<code>grafana-viewer</code>，这点和官方文档<a href=\"http://docs.grafana.org/installation/ldap/\" target=\"_blank\" rel=\"noopener\">Grafana LDAP Authentication</a>中给的例子是不一样的。</li>\n</ul>\n<hr>\n<h2 id=\"0x04-grafana-cli-命令\"><a href=\"#0x04-grafana-cli-命令\" class=\"headerlink\" title=\"0x04 grafana-cli 命令\"></a>0x04 grafana-cli 命令</h2><p><strong>常用命令：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看可以安装的插件</span></span><br><span class=\"line\">grafana-cli plugins list-remote</span><br><span class=\"line\">grafana-cli plugins install grafana-piechart-panel alexanderzobnin-zabbix-app <span class=\"comment\">#安装zabbix插件和饼图插件</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x0n-入坑-amp-出坑\"><a href=\"#0x0n-入坑-amp-出坑\" class=\"headerlink\" title=\"0x0n 入坑&amp;出坑\"></a>0x0n 入坑&amp;出坑</h2><h3 id=\"问题1-采用-Docker-安装-Grafana-时报-mkdir-can’t-create-directory-‘-var-lib-grafana-plugins’-I-O-error-错误\"><a href=\"#问题1-采用-Docker-安装-Grafana-时报-mkdir-can’t-create-directory-‘-var-lib-grafana-plugins’-I-O-error-错误\" class=\"headerlink\" title=\"问题1: 采用 Docker 安装 Grafana 时报 mkdir: can’t create directory ‘/var/lib/grafana/plugins’: I/O error 错误\"></a>问题1: 采用 Docker 安装 Grafana 时报 mkdir: can’t create directory ‘/var/lib/grafana/plugins’: I/O error 错误</h3><ul>\n<li>错误信息:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker logs --tail grafana</span><br><span class=\"line\">  <span class=\"comment\"># grafana         | GF_PATHS_DATA='/var/lib/grafana' is not writable.</span></span><br><span class=\"line\">  <span class=\"comment\"># grafana         | You may have issues with file permissions, more information here: http://docs.grafana.org/installation/docker/#migrate-to-v51-or-later</span></span><br><span class=\"line\">  <span class=\"comment\"># grafana         | mkdir: can't create directory '/var/lib/grafana/plugins': I/O error</span></span><br><span class=\"line\">  <span class=\"comment\"># grafana         | GF_PATHS_DATA='/var/lib/grafana' is not writable.</span></span><br></pre></td></tr></table></figure></li>\n<li>问题原因: 从以前的Docker容器版本迁移问题针对<code>/var/lib/grafana</code>目录权限有所变化，所以在我们持久化该目录时应设置对应的uid、gid。</li>\n<li>解决办法: <a href=\"https://grafana.com/docs/grafana/latest/installation/docker/#migrate-to-v51-or-later\" target=\"_blank\" rel=\"noopener\">https://grafana.com/docs/grafana/latest/installation/docker/#migrate-to-v51-or-later</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 用户ID更改与Grafana版本对应</span></span><br><span class=\"line\">Version \tUser \tUser ID \tGroup \tGroup ID</span><br><span class=\"line\">&lt; 5.1 \tgrafana \t104 \tgrafana \t107</span><br><span class=\"line\">&gt;= 5.1 \tgrafana \t472 \tgrafana \t472</span><br><span class=\"line\">&gt;= 7.3 \tgrafana \t472 \troot \t0</span><br></pre></td></tr></table></figure></li>\n<li>解决流程<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.映射的持久化目录的权限</span></span><br><span class=\"line\">chown -R 472:0 /data/grafana</span><br><span class=\"line\"><span class=\"comment\"># 2.以其他用户身份运行Docker</span></span><br><span class=\"line\">docker run --user 472 --volume <span class=\"string\">\"/data/grafana:/var/lib/grafana\"</span> grafana/grafana</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<h3 id=\"问题2-使用Kubernetes集群搭建Grafana其POD会不停的重启错误\"><a href=\"#问题2-使用Kubernetes集群搭建Grafana其POD会不停的重启错误\" class=\"headerlink\" title=\"问题2.使用Kubernetes集群搭建Grafana其POD会不停的重启错误.\"></a>问题2.使用Kubernetes集群搭建Grafana其POD会不停的重启错误.</h3><ul>\n<li>错误信息:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pod -n devops</span><br><span class=\"line\">  NAME                       READY   STATUS    RESTARTS      AGE</span><br><span class=\"line\">  grafana-6fb4d77ddc-s7xl5   0/1     Running   4 (18s ago)   11m</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 不断执行 Starting DB migrations </span></span><br><span class=\"line\">$ kubectl logs -f --tail 50 -n devops grafana-6fb4d77ddc-s7xl5</span><br><span class=\"line\">  logger=migrator t=2022-06-01T03:11:30.93+0000 lvl=info msg=<span class=\"string\">\"Starting DB migrations\"</span></span><br><span class=\"line\">  logger=migrator t=2022-06-01T03:11:35.85+0000 lvl=info msg=<span class=\"string\">\"Executing migration\"</span> id=<span class=\"string\">\"delete stars for deleted dashboards\"</span></span><br><span class=\"line\">  logger=migrator t=2022-06-01T03:11:42+0000 lvl=info msg=<span class=\"string\">\"Executing migration\"</span> id=<span class=\"string\">\"Add index for dashboard_is_folder\"</span></span><br><span class=\"line\">  logger=migrator t=2022-06-01T03:11:46.9+0000 lvl=info msg=<span class=\"string\">\"Executing migration\"</span> id=<span class=\"string\">\"create data_source table\"</span></span><br><span class=\"line\">  logger=migrator t=2022-06-01T03:11:52.87+0000 lvl=info msg=<span class=\"string\">\"Executing migration\"</span> id=<span class=\"string\">\"add index data_source.account_id\"</span></span><br><span class=\"line\">  logger=migrator t=2022-06-01T03:11:58.46+0000 lvl=info msg=<span class=\"string\">\"Executing migration\"</span> id=<span class=\"string\">\"add unique index data_source.account_id_name\"</span></span><br></pre></td></tr></table></figure></li>\n<li>问题可能原因:<blockquote>\n<p>1.提高限制内存减少触发OOM, 即 resource 字段设置<code>resources: {}</code>。<br>2.持久化数据persistence卷性能问题导致写过慢。</p>\n</blockquote>\n</li>\n</ul>\n<p><br/></p>\n<h3 id=\"问题3-使用Docker搭建Grafana其POD会不停的重启错误\"><a href=\"#问题3-使用Docker搭建Grafana其POD会不停的重启错误\" class=\"headerlink\" title=\"问题3.使用Docker搭建Grafana其POD会不停的重启错误.\"></a>问题3.使用Docker搭建Grafana其POD会不停的重启错误.</h3><ul>\n<li>问题错误: 在 docker 运行 grafana:7.0.3 版本时，grafana不断重启日志如下<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run -d -p 3000:3000 -e TZ=<span class=\"string\">\"Asia/Shanghai\"</span> --link=prometheus -v /data/grafana:/var/lib/grafana -v /data/grafana.ini:/etc/grafana/grafana.ini --name=grafana grafana/grafana:7.0.3</span><br><span class=\"line\"></span><br><span class=\"line\">$ docker logs -f --tail 50 grafana</span><br><span class=\"line\">t=2020-06-04T11:26:22+0800 lvl=info msg=<span class=\"string\">\"HTTP Server Listen\"</span> logger=http.server address=[::]:3000 protocol=http subUrl= socket=</span><br><span class=\"line\">t=2020-06-04T11:27:02+0800 lvl=info msg=<span class=\"string\">\"Shutdown started\"</span> logger=server reason=<span class=\"string\">\"System signal: terminated\"</span></span><br><span class=\"line\">t=2020-06-04T11:27:02+0800 lvl=info msg=<span class=\"string\">\"Stopped Stream Manager\"</span></span><br></pre></td></tr></table></figure></li>\n<li>解决办法: 尝试docker修改各种命令启动后发现，当命令中 –name=grafana 时才会出现此问题，修改成其他name即可正常启动</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"数据分析","path":"api/categories/数据分析.json"}],"tags":[{"name":"Grafana","path":"api/tags/Grafana.json"}]}