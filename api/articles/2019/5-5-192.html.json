{"title":"zabbix模块配置学习","slug":"系统运维/Linux/系统监控/Zabbix/zabbix模块配置学习","date":"2019-05-05T05:34:30.000Z","updated":"2023-01-31T02:29:09.225Z","url":"2019/5-5-192.html","path":"api/articles/2019/5-5-192.html.json","covers":["https://img.weiyigeek.top/2019/20190507111224.png","https://img.weiyigeek.top/2019/20190507113005.png","https://img.weiyigeek.top/2019/20190507153427.png","https://img.weiyigeek.top/2019/20190507152941.png","https://img.weiyigeek.top/2019/20190507153114.png","https://img.weiyigeek.top/2019/20190507153221.png","https://img.weiyigeek.top/2019/20190507100254.png","https://img.weiyigeek.top/2019/20190507100519.png","https://img.weiyigeek.top/2019/20190507101944.png","https://img.weiyigeek.top/2019/20190507102334.png","https://img.weiyigeek.top/2019/20190507103500.png","https://img.weiyigeek.top/2019/20190507103901.png","https://img.weiyigeek.top/2019/20190507104743.png","https://img.weiyigeek.top/2019/20190507104909.png","https://img.weiyigeek.top/2019/20190507105801.png","https://img.weiyigeek.top/2019/20190507110117.png","https://img.weiyigeek.top/2019/20190507110340.png","https://img.weiyigeek.top/2019/20190507110621.png","https://img.weiyigeek.top/2019/20190515230515.png","https://img.weiyigeek.top/2019/20190515235511.png","https://img.weiyigeek.top/2019/20190515235616.png","https://img.weiyigeek.top/2019/20190516003859.png","https://img.weiyigeek.top/2019/20190513223519.png","https://img.weiyigeek.top/2019/20190513230624.png","https://img.weiyigeek.top/2019/20190515160233.png","https://img.weiyigeek.top/2019/20190516165406.png"],"content":"<p>[TOC]<br><a id=\"more\"></a></p>\n<h4 id=\"0x00-Zabbix监控Windows\"><a href=\"#0x00-Zabbix监控Windows\" class=\"headerlink\" title=\"0x00 Zabbix监控Windows\"></a>0x00 Zabbix监控Windows</h4><p><strong>(1) Windows Agent下载安装配置</strong><br>Agent下载地址：<a href=\"https://www.zabbix.com/download_agents\" target=\"_blank\" rel=\"noopener\">https://www.zabbix.com/download_agents</a><br>选择我们对应的版本:4.2.1/Windows/amd64/OpenSSL<br><a href=\"https://www.zabbix.com/downloads/4.2.1/zabbix_agents-4.2.1-win-amd64-openssl.zip\" target=\"_blank\" rel=\"noopener\">https://www.zabbix.com/downloads/4.2.1/zabbix_agents-4.2.1-win-amd64-openssl.zip</a><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507111224.png\" alt=\"WeiyiGeek.根据系统位数选择\" title=\"\" class=\"\">\n                <p>WeiyiGeek.根据系统位数选择</p>\n            </figure></p>\n<p>Step 0. 这里监控windows我采用了宿主机与virtual中Zabbix主机进行通信,需要设置虚拟网卡为HOST-ONLY模式,注意HOST-only网卡需要设置自动获取<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#重启网卡</span></span><br><span class=\"line\">ifdown eth2</span><br><span class=\"line\">ifup eth2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#系统中C:\\Windows\\System32\\drivers\\etc\\hosts文件指向我们zabbix服务器</span></span><br><span class=\"line\">192.168.56.101 zabbix.weiyigeek.com</span><br><span class=\"line\"></span><br><span class=\"line\">[root@WeiyiGeek C:\\zabbix\\bin]<span class=\"comment\"># route ADD 192.168.56.101 MASK 255.255.255.255 19</span></span><br><span class=\"line\">2.168.56.102 METRIC 3 IF 15</span><br><span class=\"line\"> 操作完成!</span><br><span class=\"line\"> </span><br><span class=\"line\">route ADD 192.168.56.200 MASK 255.255.255.255 192.168.56.101 METRIC 3 IF 15</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@WeiyiGeek C:\\zabbix\\bin]<span class=\"comment\"># route PRINT</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507113005.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure><br><br><br>Step 1. 下载解压文件 -&gt; 打开并配置conf/zabbix_agentd.conf 里面的配置比较详细<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LogFile=c:\\zabbix_agentd.log</span><br><span class=\"line\">EnableRemoteCommands=1           <span class=\"comment\">#允许在本地执行远程命令</span></span><br><span class=\"line\">LogRemoteCommands=1               <span class=\"comment\">#执行远程命令是否保存操作日志</span></span><br><span class=\"line\">DebugLevel=3</span><br><span class=\"line\">Server=192.168.56.101</span><br><span class=\"line\">ListenPort=10050</span><br><span class=\"line\">ServerActive=192.168.56.101</span><br><span class=\"line\">Hostname=Windows7  <span class=\"comment\">#一定要与zabbix创建的主机一致,缺省就是IP地址</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br>Step 2. 启动zabbix的 bin注册服务到系统<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\zabbix\\bin\\zabbix_agentd.exe -i -c C:\\zabbix\\conf\\zabbix_agentd.conf     <span class=\"comment\">#安装zabbix客户端</span></span><br><span class=\"line\">zabbix_agentd.exe [11700]: service [Zabbix Agent] installed successfully</span><br><span class=\"line\">zabbix_agentd.exe [11700]: event <span class=\"built_in\">source</span> [Zabbix Agent] installed successfully</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\zabbix\\bin\\zabbix_agentd.exe -s -c C:\\zabbix\\conf\\zabbix_agentd.conf     <span class=\"comment\">#启动zabbix服务</span></span><br><span class=\"line\">zabbix_agentd.exe [10756]: service [Zabbix Agent] started successfully</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\zabbix\\zabbix_agentd.exe -d -c  C:\\zabbix\\conf\\zabbix_agentd.conf    <span class=\"comment\">#必须先停止服务再删除zabbix客户端操作</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br>Step 3. 查看服务是在系统的服务列表中或者services命令查看<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@WeiyiGeek C:\\Users\\Administrator]<span class=\"variable\">$sc</span> qc <span class=\"string\">\"Zabbix Agent\"</span></span><br><span class=\"line\">[SC] QueryServiceConfig 成功</span><br><span class=\"line\"></span><br><span class=\"line\">SERVICE_NAME: Zabbix Agent</span><br><span class=\"line\">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class=\"line\">        START_TYPE         : 2   AUTO_START</span><br><span class=\"line\">        ERROR_CONTROL      : 1   NORMAL</span><br><span class=\"line\">        BINARY_PATH_NAME   : <span class=\"string\">\"C:\\zabbix\\bin\\zabbix_agentd.exe\"</span> --config <span class=\"string\">\"C:\\zabbix\\conf\\zabbix_agentd.conf\"</span></span><br><span class=\"line\">        LOAD_ORDER_GROUP   :</span><br><span class=\"line\">        TAG                : 0</span><br><span class=\"line\">        DISPLAY_NAME       : Zabbix Agent</span><br><span class=\"line\">        DEPENDENCIES       :</span><br><span class=\"line\">        SERVICE_START_NAME : LocalSystem</span><br></pre></td></tr></table></figure></p>\n<p>Step 4. 可通过zabbix_agentd.log日志和zabbix主机选项卡中看到连接成功 -&gt; 监控 -&gt; 拓扑图 -&gt; 编辑拓扑图<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507153427.png\" alt=\"WeiyiGeek.拓扑图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.拓扑图</p>\n            </figure></p>\n<p>Step 5. 尝试执行远程命令脚本 管理 -&gt; 脚本 -&gt; 添加选项选择主机群组<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507152941.png\" alt=\"WeiyiGeek.shutdown\" title=\"\" class=\"\">\n                <p>WeiyiGeek.shutdown</p>\n            </figure></p>\n<p>Step 6. 之后可以在网络拓扑中选择主机进行命令执行<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507153114.png\" alt=\"WeiyiGeek.拓扑图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.拓扑图</p>\n            </figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507153221.png\" alt=\"WeiyiGeek.成功执行\" title=\"\" class=\"\">\n                <p>WeiyiGeek.成功执行</p>\n            </figure>\n<p><br></p>\n<h4 id=\"0x01-Zabbix监控Linux\"><a href=\"#0x01-Zabbix监控Linux\" class=\"headerlink\" title=\"0x01 Zabbix监控Linux\"></a>0x01 Zabbix监控Linux</h4><p><strong>(1)Zabbix自带模板监控</strong><br>监控：Linux主机 CPU、内存、硬盘、网卡等等,以及设置图像化界面;<br>执行流程：<br>Step 1. 配置 -&gt; 主机 -&gt; 添加主机 -&gt; 群组选择[Linux Server] -&gt; 设置agent代理程序的接口 -&gt; 添加即可<br>Step 2. 配置 -&gt; 主机 -&gt; data2-模板 -&gt; 添加模板 -&gt; 链接指示器[寻找Template OS Linux] -&gt; 添加后更新(否则不生效)<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507100254.png\" alt=\"WeiyiGeek.链接指示器选择群组模板\" title=\"\" class=\"\">\n                <p>WeiyiGeek.链接指示器选择群组模板</p>\n            </figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507100519.png\" alt=\"WeiyiGeek.添加完成后会自动添加图形\" title=\"\" class=\"\">\n                <p>WeiyiGeek.添加完成后会自动添加图形</p>\n            </figure></p>\n<p>Step 3. 配置 -&gt; 主机 -&gt; 选择指定主机 -&gt; 更新即可 -&gt; ZBX正常连接</p>\n<p>Step 4. 配置 -&gt; 主机 -&gt; 选择主机图像 -&gt; 创建图形 -&gt; 选择模板中监控项 -&gt; 添加即可<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507101944.png\" alt=\"WeiyiGeek.创建图像\" title=\"\" class=\"\">\n                <p>WeiyiGeek.创建图像</p>\n            </figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507102334.png\" alt=\"WeiyiGeek.配置图像监控项\" title=\"\" class=\"\">\n                <p>WeiyiGeek.配置图像监控项</p>\n            </figure></p>\n<p><br><br><strong>(2)Zabbix聚合图像</strong><br>Step 1. 监测 -&gt; 聚合图像 -&gt; 所有聚合图像 -&gt; 创建聚合图形 -&gt; 设置所有者和名称[ Linuxgeneral] -&gt; 添加即可<br>Step 2. 点击设置聚合图像名称[Linuxgeneral] -&gt; 编辑聚合图像 -&gt; 更改 -&gt; 选择显示的类型 -&gt; 选择图像或者监控项</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507103500.png\" alt=\"WeiyiGeek.编辑聚合图像\" title=\"\" class=\"\">\n                <p>WeiyiGeek.编辑聚合图像</p>\n            </figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507103901.png\" alt=\"WeiyiGeek.添加图像到面板\" title=\"\" class=\"\">\n                <p>WeiyiGeek.添加图像到面板</p>\n            </figure>\n<p><br><br><strong>(3)Zabbix设置自动发现添加主机功能</strong><br>Step 1. 配置 -&gt; 自动发放 -&gt; 创建自动发现规则 -&gt; 监测方式设置 -&gt; 监测IP段<br>Step 2. 配置 -&gt; 动作 —&gt; 事件源[自动发现] -&gt; 设置动作条件 -&gt; 启用即可</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507104743.png\" alt=\"WeiyiGeek.动作\" title=\"\" class=\"\">\n                <p>WeiyiGeek.动作</p>\n            </figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507104909.png\" alt=\"WeiyiGeek.自动发现\" title=\"\" class=\"\">\n                <p>WeiyiGeek.自动发现</p>\n            </figure>\n<p>Step 3. 选择指定自动发现检查条件,就是选择自动发现规则名称;<br>配置 -&gt; 动作 -&gt; 选择创建的发现规则 -&gt; 选择操作 -&gt; 设置操作细节：<br>动作：添加主机 、 添加到主机群组: Windows General 、链接到模板: Template OS Windows    -&gt; 添加即可</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507105801.png\" alt=\"WeiyiGeek.自动发现检查\" title=\"\" class=\"\">\n                <p>WeiyiGeek.自动发现检查</p>\n            </figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507110117.png\" alt=\"WeiyiGeek.自动发现操作\" title=\"\" class=\"\">\n                <p>WeiyiGeek.自动发现操作</p>\n            </figure>\n<p>Step 4. 我们就能在主机群组发现我们检测到的主机</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507110340.png\" alt=\"WeiyiGeek.WindowsGeneral\" title=\"\" class=\"\">\n                <p>WeiyiGeek.WindowsGeneral</p>\n            </figure>\n<p>Step 5. 之后我们能在配置 -&gt; 主机 -&gt; 选择群组 -&gt; 查看添加到zabbix 监控的主机 -&gt; 注意次数ZBX未启动 -&gt; 需要在监控端安装agent;<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190507110621.png\" alt=\"WeiyiGeek.测试自动发现添加到主机中\" title=\"\" class=\"\">\n                <p>WeiyiGeek.测试自动发现添加到主机中</p>\n            </figure></p>\n<p><br></p>\n<h4 id=\"0x02-Zabbix分布式安装\"><a href=\"#0x02-Zabbix分布式安装\" class=\"headerlink\" title=\"0x02 Zabbix分布式安装\"></a>0x02 Zabbix分布式安装</h4><p>Zabbix为IT基础设施提供有效和可用的分布式监控,代理(proxies)可用于代替Zabbix server本地收集数据,然后将数据报告给server服务器。<br>zabbix proxy 是一个数据收集器,它不计算触发器、不处理事件、不发送报警</p>\n<p><em>zabbix proxy 使用场景:</em></p>\n<ul>\n<li>监控远程区域设备</li>\n<li>监控本地网络不稳定区域</li>\n<li>当zabbix监控上千设备时,使用它来减轻 server 的压力</li>\n<li>简化分布式监控的维护</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190515230515.png\" alt=\"WeiyiGeek.zabbix\" title=\"\" class=\"\">\n                <p>WeiyiGeek.zabbix</p>\n            </figure>\n<p>执行过程：proxy 收集到数据之后，首先将数据缓存在本地,然后在一定得时间之后传递给 zabbix server，这样就不会因为服务器的任何临时通信问题而丢失数据。</p>\n<p><em>如何选择proxy模式？</em></p>\n<ul>\n<li>主动式 - proxy将连接到Zabbix server并请求配置数据</li>\n<li>被动式 - Zabbix server连接到代理proxy<br>注意:当使用active proxy，未加密通信（敏感）proxy配置数据可用于访问Zabbix server trapper端口。如果不进行身份验证，任何人都可以伪装成active proxy并请求配置数据。 </li>\n</ul>\n<p>我们这里采用共享秘钥（PSK）方式加密通信：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#共享密钥一致性 \t共享密钥身份字符串</span></span><br><span class=\"line\">如：ZABBIXPROXY</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#共享密钥（PSK） \t共享密钥(16进制)</span></span><br><span class=\"line\"><span class=\"comment\">#使用openssl生成psk密钥并将生成的openssl写入到enc/文件中</span></span><br><span class=\"line\">[root@container1 etc]$ openssl rand -hex 32  &gt; /var/lib/zabbix/zabbix_proxy.psk</span><br></pre></td></tr></table></figure></p>\n<p>zabbix-proxy重要参数：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">egrep -v <span class=\"string\">'^#'</span> /etc/zabbix/zabbix_proxy.conf</span><br><span class=\"line\"><span class=\"comment\">#默认主动模式</span></span><br><span class=\"line\">Server=192.168.1.200</span><br><span class=\"line\">ServerPort=10051</span><br><span class=\"line\">Hostname=ZabbixProxy</span><br><span class=\"line\">LogFile=/var/<span class=\"built_in\">log</span>/zabbix/zabbix_proxy.log</span><br><span class=\"line\">LogFileSize=0</span><br><span class=\"line\">PidFile=/var/run/zabbix/zabbix_proxy.pid</span><br><span class=\"line\">SocketDir=/var/run/zabbix</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#proxy-mysql数据库注意需要单只建库</span></span><br><span class=\"line\">DBHost=192.168.1.200</span><br><span class=\"line\">DBName=zabbix_proxy</span><br><span class=\"line\">DBUser=zabbix_proxy</span><br><span class=\"line\">DBPassword=123456</span><br><span class=\"line\">DBPort=3306</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#缓存大小</span></span><br><span class=\"line\">ProxyLocalBuffer=10</span><br><span class=\"line\">ProxyOfflineBuffer=10</span><br><span class=\"line\"><span class=\"comment\">#高可用切换</span></span><br><span class=\"line\">HeartbeatFrequency=60</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#代理从Zabbix服务器检索配置数据的频率</span></span><br><span class=\"line\">ConfigFrequency=30</span><br><span class=\"line\"><span class=\"comment\">#发送采集的监控数据到服务器端，默认是1秒，我们一分钟发送一次</span></span><br><span class=\"line\">DataSenderFrequency=60  </span><br><span class=\"line\"></span><br><span class=\"line\">SNMPTrapperFile=/var/<span class=\"built_in\">log</span>/snmptrap/snmptrap.log</span><br><span class=\"line\">Timeout=4</span><br><span class=\"line\">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class=\"line\">LogSlowQueries=3000</span><br><span class=\"line\">StatsAllowedIP=127.0.0.1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加密认证（/etc/zabbix/）</span></span><br><span class=\"line\">TLSConnect=psk</span><br><span class=\"line\">TLSAccept=psk</span><br><span class=\"line\">TLSPSKIdentity=ZABBIXPROXY</span><br><span class=\"line\">TLSPSKFile=etc/zabbix/zabbix_proxy.psk</span><br></pre></td></tr></table></figure></p>\n<p>然后启动zabbix-proxy和观察连接日志：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@Szabbix ~]<span class=\"variable\">$service</span> zabbix-proxy restart</span><br><span class=\"line\">[root@Szabbix ~]<span class=\"variable\">$cat</span> /var/<span class=\"built_in\">log</span>/zabbix/zabbix_proxy.log  <span class=\"comment\">#查看zabbix——proxy日志</span></span><br><span class=\"line\">4733:20190516:000542.753 using configuration file: /etc/zabbix/zabbix_proxy.c</span><br><span class=\"line\">4733:20190516:000542.768 current database version (mandatory/optional): 04020</span><br><span class=\"line\">4733:20190516:000542.768 required mandatory version: 04020000</span><br><span class=\"line\">4733:20190516:000542.793 proxy <span class=\"comment\">#0 started [main process]</span></span><br><span class=\"line\">4735:20190516:000542.795 proxy <span class=\"comment\">#1 started [configuration syncer #1]</span></span><br><span class=\"line\">4737:20190516:000542.800 proxy <span class=\"comment\">#3 started [data sender #1]</span></span><br><span class=\"line\">4736:20190516:000542.803 proxy <span class=\"comment\">#2 started [heartbeat sender #1]</span></span><br><span class=\"line\">4740:20190516:000542.806 proxy <span class=\"comment\">#6 started [discoverer #1]</span></span><br><span class=\"line\">4742:20190516:000542.817 proxy <span class=\"comment\">#8 started [history syncer #2]</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置连接zabbix-agent的agent主机</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/hosts   <span class=\"comment\">#配置hostname</span></span><br><span class=\"line\">hostname zabbixagent <span class=\"comment\">#agent配置文件中也需要一样</span></span><br><span class=\"line\"><span class=\"variable\">$service</span> zabbix-agent start</span><br><span class=\"line\">cat /var/<span class=\"built_in\">log</span>/zabbix/zabbix_agentd.log   <span class=\"comment\">#查看agent日志</span></span><br></pre></td></tr></table></figure><br>在zabbix-web中设置agent代理程序：<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190515235511.png\" alt=\"WeiyiGeek.设置agent代理程序\" title=\"\" class=\"\">\n                <p>WeiyiGeek.设置agent代理程序</p>\n            </figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190515235616.png\" alt=\"WeiyiGeek.加密agent代理程序\" title=\"\" class=\"\">\n                <p>WeiyiGeek.加密agent代理程序</p>\n            </figure></p>\n<p>注意：接入成功后需要建立应用集ZBX才能进行显示绿色(注意这里的主机名称需要与配置文件对应)<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190516003859.png\" alt=\"WeiyiGeek.proxy接入\" title=\"\" class=\"\">\n                <p>WeiyiGeek.proxy接入</p>\n            </figure></p>\n<p><em>注意：</em> zabbix proxy 数据库必须和 server 分开,否则数据会被破坏;</p>\n<p><br></p>\n<h4 id=\"0x03-Zabbix使用钉钉进行预警\"><a href=\"#0x03-Zabbix使用钉钉进行预警\" class=\"headerlink\" title=\"0x03 Zabbix使用钉钉进行预警\"></a>0x03 Zabbix使用钉钉进行预警</h4><p>群机器人是钉钉群的高级扩展功能,群机器人可以将第三方服务的信息聚合到群聊中,实现自动化的信息同步；<br>登录钉钉客户端-&gt;创建一个群-&gt;然后点击群右上角的”群机器人”-&gt;”添加机器人”-&gt;”自定义”,记录该机器人的webhook值!<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190513223519.png\" alt=\"WeiyiGeek.webhook\" title=\"\" class=\"\">\n                <p>WeiyiGeek.webhook</p>\n            </figure></p>\n<p>修改后钉钉zabbix监控脚本：<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat dingding.py </span><br><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\">#coding:utf-8</span></span><br><span class=\"line\"><span class=\"comment\">#zabbix钉钉报警</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> json,sys,os,datetime</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#机器人的webhook地址及其@收信人电话信息</span></span><br><span class=\"line\">webhook=<span class=\"string\">\"https://oapi.dingtalk.com/robot/send?access_token=e633c24593e06b207af5ef099b300f7b6f68a6ff086a74837f094638d51c52a2\"</span></span><br><span class=\"line\">username=sys.argv[<span class=\"number\">1</span>]</span><br><span class=\"line\">text=sys.argv[<span class=\"number\">3</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#构造post数据包</span></span><br><span class=\"line\">data=&#123;</span><br><span class=\"line\">    <span class=\"string\">\"msgtype\"</span>: <span class=\"string\">\"text\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"text\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"content\"</span>: text</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"at\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"atMobiles\"</span>: [</span><br><span class=\"line\">            username</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"isAtAll\"</span>: <span class=\"literal\">False</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">headers = &#123;<span class=\"string\">'Content-Type'</span>: <span class=\"string\">'application/json'</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#利用request模块进行post请求</span></span><br><span class=\"line\">request=urllib2.Request(url=webhook,data=json.dumps(data),headers=headers)</span><br><span class=\"line\">reponse=urllib2.urlopen(request)</span><br><span class=\"line\">result = reponse.read()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#再钉钉中记录成功或者失败</span></span><br><span class=\"line\">filename=<span class=\"string\">\"/var/log/zabbix/log/dingding.log\"</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> os.path.exists(filename):</span><br><span class=\"line\">    f=open(filename,<span class=\"string\">\"a+\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    f=open(filename,<span class=\"string\">\"w+\"</span>)</span><br><span class=\"line\">f.write(<span class=\"string\">\"\\n\"</span>+<span class=\"string\">\"--\"</span>*<span class=\"number\">30</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解析返回的json</span></span><br><span class=\"line\">x = json.loads(result)</span><br><span class=\"line\"><span class=\"keyword\">print</span> x[<span class=\"string\">\"errmsg\"</span>]</span><br><span class=\"line\"><span class=\"keyword\">if</span> x[<span class=\"string\">\"errcode\"</span>] == <span class=\"number\">0</span>:</span><br><span class=\"line\">    f.write(<span class=\"string\">\"\\n\"</span>+str(datetime.datetime.now())+<span class=\"string\">\" \"</span>+str(username)+<span class=\"string\">\"  \"</span>+<span class=\"string\">\"发送成功\"</span>+<span class=\"string\">\"\\n\"</span>+str(text))</span><br><span class=\"line\">    f.close()</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    f.write(<span class=\"string\">\"\\n\"</span>+str(datetime.datetime.now()) + <span class=\"string\">\" \"</span> + str(username) + <span class=\"string\">\" \"</span> + <span class=\"string\">\"发送失败\"</span> + <span class=\"string\">\"\\n\"</span> + str(text))</span><br><span class=\"line\">    f.close()</span><br></pre></td></tr></table></figure><br><br></p>\n<p>执行流程：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#赋予脚本执行权限放入server的JavaScript指定目录中</span></span><br><span class=\"line\">chmod +x dingding.py</span><br><span class=\"line\"><span class=\"comment\">#创建上面脚本中的日志路径</span></span><br><span class=\"line\">mkdir -vp /var/<span class=\"built_in\">log</span>/zabbix/<span class=\"built_in\">log</span>/</span><br><span class=\"line\">chown zabbix.zabbix /var/<span class=\"built_in\">log</span>/zabbix/<span class=\"built_in\">log</span>/dingding.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#手动测试脚本是否可以正常发送消息这个条文档记录的测试信息,</span></span><br><span class=\"line\">./dingding.py 1842 gaojing <span class=\"string\">\"测试报警\"</span></span><br></pre></td></tr></table></figure></p>\n<p><em>zabbix web界面配置流程：</em><br>Step1. 创建报警媒介<br>脚本参数：ALERT.SENDTO      ALERT.SUBJECT      ALERT.MESSAGE<br>Step2. 给用户添加报警媒介<br>说明：收件人是钉钉上的手机号码，我这里使用的是Admin管理员用户<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190513230624.png\" alt=\"WeiyiGeek.添加报警媒介\" title=\"\" class=\"\">\n                <p>WeiyiGeek.添加报警媒介</p>\n            </figure><br>Step3. 点击配置–&gt;动作–&gt;创建动作-&gt;触发器<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#默认信息里：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"from\"</span>: <span class=\"string\">\"&#123;HOSTNAME1&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"time\"</span>: <span class=\"string\">\"&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"level\"</span>: <span class=\"string\">\"&#123;TRIGGER.SEVERITY&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"&#123;TRIGGER.NAME&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"key\"</span>: <span class=\"string\">\"&#123;TRIGGER.KEY1&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"value\"</span>: <span class=\"string\">\"&#123;ITEM.VALUE&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"now\"</span>: <span class=\"string\">\"&#123;ITEM.LASTVALUE&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"id\"</span>: <span class=\"string\">\"&#123;EVENT.ID&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"ip\"</span>: <span class=\"string\">\"&#123;HOST.IP&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"color\"</span>:<span class=\"string\">\"FFE61A1A\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"age\"</span>:<span class=\"string\">\"&#123;EVENT.AGE&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"status\"</span>:<span class=\"string\">\"&#123;EVENT.STATUS&#125;\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">　　　　　　</span><br><span class=\"line\"><span class=\"comment\">#恢复默认信息：</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"from\"</span>: <span class=\"string\">\"&#123;HOSTNAME1&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"time\"</span>: <span class=\"string\">\"&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"level\"</span>: <span class=\"string\">\"&#123;TRIGGER.SEVERITY&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"&#123;TRIGGER.NAME&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"key\"</span>: <span class=\"string\">\"&#123;TRIGGER.KEY1&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"value\"</span>: <span class=\"string\">\"&#123;ITEM.VALUE&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"now\"</span>: <span class=\"string\">\"&#123;ITEM.LASTVALUE&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"id\"</span>: <span class=\"string\">\"&#123;EVENT.ID&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"ip\"</span>: <span class=\"string\">\"&#123;HOST.IP&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"color\"</span>:<span class=\"string\">\"FF4A934A\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"age\"</span>:<span class=\"string\">\"&#123;EVENT.AGE&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"recoveryTime\"</span>:<span class=\"string\">\"&#123;EVENT.RECOVERY.DATE&#125; &#123;EVENT.RECOVERY.TIME&#125;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"status\"</span>:<span class=\"string\">\"&#123;EVENT.RECOVERY.STATUS&#125;\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>Step4. 等待事件触发<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190515160233.png\" alt=\"WeiyiGeek.测试\" title=\"\" class=\"\">\n                <p>WeiyiGeek.测试</p>\n            </figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2019/20190516165406.png\" alt=\"WeiyiGeek.钉钉报警\" title=\"\" class=\"\">\n                <p>WeiyiGeek.钉钉报警</p>\n            </figure></p>\n","comments":true,"excerpt":"[TOC]<br>","categories":[{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"Zabbix","path":"api/tags/Zabbix.json"}]}