<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Containerd">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-06-27T06:36:30.000Z" itemprop="datePublished" class="page-time">
  2021-06-27
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Containerd/1.åŸºäºContainerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-06-27 14:36:30" datetime="2021-06-27T06:36:30.000Z"  itemprop="datePublished">2021-06-27</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<hr>
<h2 id="0x00-å‰è¨€ç®€è¿°"><a href="#0x00-å‰è¨€ç®€è¿°" class="headerlink" title="0x00 å‰è¨€ç®€è¿°"></a>0x00 å‰è¨€ç®€è¿°</h2><p>æè¿°: ç›®å‰Dockeræ˜¯Kubernetesé»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰, ç”±äºk8såœ¨2020å¹´å®£å¸ƒ1.20ç‰ˆæœ¬ä¹‹åå°†å¼ƒç”¨ dockershim (å…¶ä¸­ä¹Ÿæœ‰kubernetesä¸Dockerçˆ±æ¨æƒ…ä»‡)æ—¶ï¼Œæ‰æŠŠcontainerdæ‹‰å›å¤§ä¼—çš„è§†é‡ä¹‹ä¸­ï¼Œæ‰€ä»¥æœ¬ç« ä¸»è¦è®²è§£containerdåŸºç¡€å…¥é—¨ã€‚</p>
<h3 id="1-åŸºç¡€ä»‹ç»"><a href="#1-åŸºç¡€ä»‹ç»" class="headerlink" title="1.åŸºç¡€ä»‹ç»"></a>1.åŸºç¡€ä»‹ç»</h3><p><strong>Q: ä»€ä¹ˆæ˜¯Containerd?</strong></p>
<blockquote>
<p>ç­”: Containerdæ˜¯ä»Dockerä¸­åˆ†ç±»å‡ºçš„å®¹å™¨è¿è¡Œæ—¶ä¸runcä¸€æ ·è¢«åˆ†è§£ä¸ºDockeçš„é«˜çº§è¿è¡Œæ—¶éƒ¨åˆ†,å®ƒæ”¯æŒ OCI çš„é•œåƒæ ‡å‡†ã€å¯ä»¥å®ç°æ‹‰å–å’Œæ¨é€é•œåƒã€ç®¡ç†æ“ä½œé•œåƒè´Ÿè´£å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚<br>ä¾‹å¦‚å½“å®ƒéœ€è¦è¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶,å®ƒä¼šå°†æ˜ åƒè§£å‹åˆ°ä¸€ä¸ªOCIè¿è¡Œæ—¶åŒ…ä¸­,å¹¶å°†å…¶å‘é€ç»™runcæ¥è¿è¡Œå®ƒï¼ŒContainerdè¿˜æä¾›äº†ä¸€ä¸ªAPIå’Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå¯ä»¥ç”¨æ¥ä¸ä¹‹äº¤äº’ï¼Œcontainerdå‘½ä»¤è¡Œå®¢æˆ·ç«¯æ˜¯ctrå‘½ä»¤ã€‚<br>å®˜æ–¹ä»‹ç»: An industry-standard container runtime with an emphasis on simplicity, robustness and portability - ä¸šç•Œæ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå¼ºè°ƒç®€å•æ€§ã€å¥å£®æ€§å’Œå¯ç§»æ¤æ€§ã€‚</p>
</blockquote>
<p><strong>Q: Containerd æœ‰ä½•ç‰¹ç‚¹?</strong></p>
<ul>
<li>OCI Image Spec support - OCIå›¾åƒè§„èŒƒæ”¯æŒ</li>
<li>OCI Runtime Spec support - OCIè¿è¡Œæ—¶è§„èŒƒæ”¯æŒ</li>
<li>Image push and pull support - å›¾åƒæ¨æ‹‰æ”¯æŒ</li>
<li>Container runtime and lifecycle support - å®¹å™¨è¿è¡Œæ—¶å’Œç”Ÿå‘½å‘¨æœŸæ”¯æŒ</li>
<li>Network primitives for creation, modification, and deletion of interfaces - ç”¨äºåˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤æ¥å£çš„ç½‘ç»œåŸè¯­</li>
<li>Management of network namespaces containers to join existing namespaces - ç®¡ç†è¿æ¥ç°æœ‰åç§°ç©ºé—´çš„ç½‘ç»œåç§°ç©ºé—´å®¹å™¨</li>
<li>Multi-tenant supported with CAS storage for global images - CASå­˜å‚¨æ”¯æŒç”¨äºå…¨å±€æ˜ åƒçš„å¤šç§Ÿæˆ·</li>
</ul>
<p><br></p>
<p><strong>å‘å±•å†å²</strong>: ï¼ˆ Containerd å’Œ Docker çš„å‰ä¸–ä»Šç”Ÿä»¥åŠçˆ±æ¨æƒ…ä»‡ï¼‰<br>åœ¨å‡ å¹´ä¹‹å‰ Docker å…¬å¸åœ¨å®¹å™¨æŠ€æœ¯é¢†åŸŸå¼ºåŠ¿å´›èµ·ä¸€å®¶ç‹¬å¤§ï¼ŒGoogleã€RedHat è¿™æ ·çš„å·¨å¤´ä»¬éƒ½äº§ç”Ÿäº†å¾ˆå¤§çš„å±æœºæ„Ÿï¼Œå› æ­¤ä»–ä»¬æƒ³ä¸ Docker å…¬å¸ä¸€èµ·è”åˆç ”å‘æ¨è¿›ä¸€ä¸ªå¼€æºçš„å®¹å™¨è¿è¡Œæ—¶ä½œä¸º Docker æŠ€æœ¯çš„æ ¸å¿ƒä¾èµ–ã€‚ç„¶é¹… Docker å…¬å¸å¾ˆé«˜å†·çš„è¡¨ç¤ºï¼šæˆ‘ä¸å¹²ï¼å·¨å¤´ä»¬å¬åˆ°è¿™ä¸ªåé¦ˆå°±å¾ˆä¸çˆ½å•Šï¼Œå› æ­¤é€šè¿‡ä¸€äº›æ‰‹æ®µå¯¹ Docker å…¬å¸è½¯ç¡¬å…¼æ–½ï¼Œä½¿å…¶å°† libcontainer æç»™äº†å¼€æºç¤¾åŒºï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„ runcï¼Œä¸€ä¸ª low level çš„å®¹å™¨è¿è¡Œæ—¶ã€‚æ­¤å¤–å·¨å¤´ä»¬åˆæˆç«‹äº† CNCF å»å¯¹æŠ— Docker å…¬å¸çš„ä¸€å®¶ç‹¬å¤§ï¼ŒCNCF æˆç«‹çš„æ€è·¯å¾ˆæ˜ç¡®ï¼šåœ¨å®¹å™¨é¢†åŸŸå¹²ä¸è¿‡ Dockerï¼Œé‚£å°±æå®¹å™¨ä¸Šå±‚çš„å»ºè®¾â€”â€”å®¹å™¨ç¼–æ’ï¼Œä»æ­¤ K8s è¯ç”Ÿäº†ã€‚è™½ç„¶ Docker å…¬å¸ä¹Ÿå°è¯•ä½¿ç”¨ Swarm å»å¯¹æŠ— K8sä½†æœ€ç»ˆä¹Ÿå¤±è´¥äº†ã€‚</p>
<p><br></p>
<p>è‡ªæ­¤K8sæ…¢æ…¢æˆä¸ºäº‘åŸç”Ÿé¢†åŸŸçš„æ ‡é…ï¼Œå…¶ç”Ÿæ€ä¹Ÿè¶Šåšè¶Šå¤§ã€è¶Šåšè¶Šå®Œå–„ã€‚Docker å…¬å¸ä¸ºäº†èå…¥ç”Ÿæ€ï¼Œå¼€æºäº† Docker çš„æ ¸å¿ƒä¾èµ– containerd ã€‚2019å¹´2æœˆ28æ—¥containerdæ­£å¼æˆä¸ºäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š(Cloud Native Computing Foundation -CNCF)çš„ä¸€ä¸ªæ¯•ä¸šé¡¹ç›®,ç´§éš<code>Kubernetesã€Prometheusã€Envoyå’ŒCoreDNS</code>ä¹‹å,åœ¨ä»containerd1.5å¼€å§‹ï¼ŒKuberneteså®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰çš„containerdæ’ä»¶å·²ç»åˆå¹¶åˆ°containerdä¸­ã€‚ã€‚</p>
<p><br></p>
<p>æ­¤å¤– K8s ä¸ºäº†å¯¹æ¥ä¸‹ä¸€å±‚çš„å®¹å™¨ï¼Œä¹Ÿå› ä¸ºå…¶ä¸­ç«‹æ€§æäº†ä¸€ä¸ªè¿è¡Œæ—¶æ¥å£ï¼Œä¹Ÿå°±æ˜¯ <code>CRI(Container Runtime Interface)</code>ï¼Œruncã€containerd ç­‰è¿è¡Œæ—¶éƒ½å»æ”¯æŒæ­¤æ¥å£ã€‚ç”±äºå½“æ—¶ç¡®å®æ²¡æœ‰å•¥ high level çš„ runtimeï¼Œoci-o è™½ç„¶æ”¯æŒ CRI æ¥å£ï¼Œä½†å…¶åŠŸèƒ½å¤ªå¼±ï¼›containerd ä¹Ÿå°šæœªæˆç†Ÿï¼Œè€Œä¸”å…¶å½“æ—¶çš„å®šä½æ˜¯åµŒå…¥åˆ°ç³»ç»Ÿä¸­ï¼Œå¹¶éç»™ç»ˆç«¯ç”¨æˆ·ä½¿ç”¨ï¼›rkt æœ‰è‡ªå·±çš„ä¸€å¥—ä½“ç³»åæ¥è¿™ä¸ªé¡¹ç›®ä¹Ÿå¤±è´¥äº†ã€‚åªèƒ½æš‚æ—¶ä¸ºäº†é€‚é… Docker æäº†ä¸ª shimï¼Œå°† CRI è½¬æ¢ä¸º Docker APIã€‚K8s å’Œ Docker è¿›å…¥äº†å†·é™æœŸï¼ŒåŒæ–¹éƒ½åœ¨å„è‡ªä¼˜åŒ–è‡ªå·±ï¼Œäº’ä¸å¹²æ‰°ã€‚ç„¶è€Œå¹³é™ä¹‹ä¸‹ä»æ˜¯æš—æ½®æ±¹æ¶Œï¼ŒCNCF ç¤¾åŒºä¸€ç›´åœ¨ä¸æ–­å®Œå–„ containerdï¼Œå…¶å®šä½ä¹Ÿå‘ç”Ÿäº†æ”¹å˜ï¼Œç”±åŸæ¥çš„ç³»ç»ŸåµŒå…¥ç»„ä»¶ï¼Œå˜æˆäº†ä»Šå¤©çš„<code>&quot;å·¥ä¸šæ ‡å‡†å®¹å™¨è¿è¡Œæ—¶&quot;</code>ï¼Œå¹¶æä¾›ç»™ç»ˆç«¯ç”¨æˆ·ä½¿ç”¨ã€‚ç›´åˆ°2020å¹´12æœˆ K8s å®£å¸ƒåºŸå¼ƒä½¿ç”¨ Dockerï¼Œè€Œæ”¹ç”¨ Containerdã€‚</p>
<p>æ€»ç»“: å…¶å®kuberneteså®£å¸ƒåºŸå¼ƒdockershim,ä¸€æ–¹é¢æ˜¯å› ä¸ºå•†ä¸šå› ç´ ,è€Œå¦ä¸€æ–¹é¢ K8s å·²ç»æä¾›äº†æ ‡å‡†æ¥å£å¯¹æ¥åº•å±‚å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸å†æƒ³å•ç‹¬ç»´æŠ¤ä¸€ä¸ªç±»ä¼¼äº<code>Dockershim</code>çš„é€‚é…å±‚å»è¿åˆä¸åŒçš„è¿è¡Œæ—¶ã€‚</p>
<p><strong>Q: é‚£ä»€ä¹ˆæ˜¯dockershim?</strong><br>æè¿°: dockershim æ˜¯ Kubernetes çš„ä¸€ä¸ªç»„ä»¶ï¼Œå…¶ä½œç”¨æ˜¯ä¸ºäº†æ“ä½œDockerã€‚Dockeræ˜¯åœ¨2013å¹´é¢ä¸–çš„è€ŒKubernetesæ˜¯åœ¨2016å¹´ï¼Œæ‰€ä»¥Dockeråˆšå¼€å§‹å¹¶æ²¡æœ‰æƒ³åˆ°ç¼–æ’ï¼Œä¹Ÿä¸ä¼šçŸ¥é“ä¼šå‡ºç°Kubernetesè¿™ä¸ªåºç„¶å¤§ç‰©ï¼ˆå®ƒè¦æ˜¯çŸ¥é“ï¼Œä¹Ÿä¸ä¼šè´¥çš„é‚£ä¹ˆå¿«ï¼‰ã€‚ä½†æ˜¯Kubernetesåœ¨åˆ›å»ºçš„æ—¶å€™å°±æ˜¯ä»¥Dockerä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œå¾ˆå¤šæ“ä½œé€»è¾‘éƒ½æ˜¯é’ˆå¯¹çš„Dockerï¼Œéšç€ç¤¾åŒºè¶Šæ¥è¶Šå¥å£®ï¼Œä¸ºäº†å…¼å®¹æ›´å¤šçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰å°†Dockerçš„ç›¸å…³é€»è¾‘ç‹¬ç«‹å‡ºæ¥ç»„æˆäº†dockershimã€‚</p>
<p>æ­£å› ä¸ºè¿™æ ·ï¼Œåªè¦Kubernetesçš„ä»»ä½•å˜åŠ¨æˆ–è€…Dockerçš„ä»»ä½•å˜åŠ¨ï¼Œéƒ½å¿…é¡»ç»´æŠ¤dockershimï¼Œè¿™æ ·æ‰èƒ½ä¿è¯è¶³å¤Ÿçš„æ”¯æŒï¼Œä½†æ˜¯é€šè¿‡dockershimæ“ä½œDockerï¼Œå…¶æœ¬è´¨è¿˜æ˜¯æ“ä½œDockerçš„åº•å±‚è¿è¡Œæ—¶Containerdï¼Œè€Œä¸”Containerdè‡ªèº«ä¹Ÿæ˜¯æ”¯æŒCRIï¼ˆContainer Runtime Interfaceï¼‰äº¤äº’ï¼Œæ‰€ä»¥æ­£å¦‚å‰é¢æ‰€è¯´åªæ˜¯kubernetesä¸æƒ³å•ç‹¬ç»´æŠ¤ä¸€ä¸ªç±»ä¼¼äº<code>Dockershim</code>çš„é€‚é…å±‚å»è¿åˆä¸åŒçš„è¿è¡Œæ—¶ã€‚</p>
<p><br/></p>
<p><strong>ç›¸å…³å‚è€ƒ</strong><br>Containerd å®˜ç½‘: <a href="https://containerd.io/" target="_blank" rel="noopener">https://containerd.io/</a><br>Containerd å¸®åŠ©æ–‡æ¡£: <a href="https://containerd.io/docs/" target="_blank" rel="noopener">https://containerd.io/docs/</a><br>CNI ç½‘ç»œé¡¹ç›®: <a href="https://github.com/containernetworking" target="_blank" rel="noopener">https://github.com/containernetworking</a></p>
<p><em>Tips: åœ¨githubå­˜å‚¨åº“ä¸­çš„ containerd åŸºæœ¬é¡¹ç›®çº§ä¿¡æ¯:</em></p>
<ul>
<li>containerd/containerd ï¼šcontainerdçš„ä¸»è¦é¡¹ç›®repoï¼ŒåŒ…æ‹¬containerè¿è¡Œæ—¶ä»¥åŠä»containerd 1.5å¼€å§‹ï¼Œç”¨äº<a href="https://kubernetes.io/docs/setup/cri" target="_blank" rel="noopener">Kuberneteså®¹å™¨è¿è¡Œæ—¶æ¥å£(CRI)</a>å·²å¹¶å…¥containerdã€‚</li>
<li>containerd/containerd.io : ç”¨äºæ„å»ºcontainerdç½‘ç«™å’Œæ–‡æ¡£çš„èµ„äº§ï¼ˆå³æ‚¨å½“å‰æ­£åœ¨é˜…è¯»çš„å†…å®¹ï¼‰</li>
<li>containerd/project : è·¨containerdå­˜å‚¨åº“ä½¿ç”¨çš„å®ç”¨ç¨‹åºï¼Œå¦‚è„šæœ¬ã€å…¬å…±æ–‡ä»¶å’Œæ ¸å¿ƒæ–‡æ¡£</li>
<li>containerd/ttrpc : containerdä½¿ç”¨çš„gRPCç‰ˆæœ¬ï¼ˆä¸ºä½å†…å­˜ç¯å¢ƒè®¾è®¡ï¼‰</li>
</ul>
<p><br></p>
<h3 id="2-ä¸“ä¸šæœ¯è¯­"><a href="#2-ä¸“ä¸šæœ¯è¯­" class="headerlink" title="2.ä¸“ä¸šæœ¯è¯­"></a>2.ä¸“ä¸šæœ¯è¯­</h3><p>æè¿°: åœ¨ä»‹ç»å®¹å™¨è¿è¡Œæ—¶ç›¸å…³æ¦‚å¿µåŠç»„ä»¶åŸç†ï¼Œæ¢³ç†ä¸‹æˆ‘ä»¬å¸¸å¬åˆ°çš„ OCIã€runcã€containerd ç­‰åè¯ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><strong>OCI</strong><br>Docker å…¬å¸ä¸ CoreOS å’Œ Google å…±åŒåˆ›å»ºäº† <code>OCI (Open Container Initial)</code> å¹¶æä¾›äº†ä¸¤ç§è§„èŒƒï¼š</p>
<ul>
<li>1) é•œåƒè§„èŒƒ (<a href="https://github.com/opencontainers/image-spec" target="_blank" rel="noopener">https://github.com/opencontainers/image-spec</a>) é•œåƒè§„èŒƒå®šä¹‰äº†OCIé•œåƒçš„æ ‡å‡†ï¼Œhigh level è¿è¡Œæ—¶å°†ä¼šä¸‹è½½ä¸€ä¸ªOCI é•œåƒï¼Œå¹¶æŠŠå®ƒè§£å‹æˆOCI è¿è¡Œæ—¶æ–‡ä»¶ç³»ç»ŸåŒ…ï¼ˆfilesystem bundleï¼‰ï¼Œä¾‹å¦‚ åˆ¶å®šé•œåƒæ ¼å¼ã€æ“ä½œç­‰</li>
<li>2) è¿è¡Œæ—¶è§„èŒƒ (<a href="https://github.com/opencontainers/runtime-spec)" target="_blank" rel="noopener">https://github.com/opencontainers/runtime-spec)</a>: æè¿°äº†å¦‚ä½•ä»OCI è¿è¡Œæ—¶æ–‡ä»¶ç³»ç»ŸåŒ…è¿è¡Œå®¹å™¨ç¨‹åºï¼Œå¹¶ä¸”å®šä¹‰å®ƒçš„é…ç½®ã€è¿è¡Œç¯å¢ƒå’Œç”Ÿå‘½å‘¨æœŸï¼Œå¦‚ä½•ä¸ºæ–°å®¹å™¨è®¾ç½®å‘½åç©ºé—´ï¼ˆnamepsacesï¼‰å’Œæ§åˆ¶ç»„ï¼ˆcgroupsï¼‰ï¼Œä»¥åŠæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿç­‰ç­‰æ“ä½œï¼Œéƒ½æ˜¯åœ¨è¿™é‡Œå®šä¹‰çš„ã€‚å®ƒçš„ä¸€ä¸ªå‚è€ƒå®ç°æ˜¯runC(<code>ä½å±‚çº§è¿è¡Œæ—¶- Low-level Runtime</code>)é™¤å®ƒä»¥å¤–ä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–çš„è¿è¡Œæ—¶éµå¾ªOCIæ ‡å‡†,ä¾‹å¦‚kata-runtimeã€‚</li>
</ul>
<p>Tips: <code>æ–‡ä»¶ç³»ç»ŸæŸ(filesystem bundle)</code>: å®šä¹‰äº†ä¸€ç§å°†å®¹å™¨ç¼–ç ä¸ºæ–‡ä»¶ç³»ç»ŸæŸçš„æ ¼å¼ï¼Œå³ä»¥æŸç§æ–¹å¼ç»„ç»‡çš„ä¸€ç»„æ–‡ä»¶ï¼Œå¹¶åŒ…å«æ‰€æœ‰ç¬¦åˆè¦æ±‚çš„è¿è¡Œæ—¶å¯¹å…¶æ‰§è¡Œæ‰€æœ‰æ ‡å‡†æ“ä½œçš„å¿…è¦æ•°æ®å’Œå…ƒæ•°æ®ï¼Œå³ config.json ä¸ æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p>Tips: <code>CRI(Container Runtime Interface,å®¹å™¨è¿è¡Œæ—¶æ¥å£)</code> : å®ƒæ˜¯ä¸ºäº†è§£å†³è¿™äº›å®¹å™¨è¿è¡Œæ—¶å’ŒKubernetesçš„é›†æˆé—®é¢˜åœ¨Kubernetes 1.5ç‰ˆæœ¬ä¸­æ¨å‡ºã€‚</p>
<p><br></p>
<p>Dockerã€Google ç­‰å¼€æºäº†ç”¨äºè¿è¡Œå®¹å™¨çš„å·¥å…·å’Œåº“ runC ä½œä¸º OCI çš„ä¸€ç§å®ç°å‚è€ƒ, éšåå„ç§è¿è¡Œæ—¶å’Œåº“ä¹Ÿæ…¢æ…¢å‡ºç°ä¾‹å¦‚ <code>rktã€containerd(ä»Šå¤©çš„ä¸»è§’)ã€cri-o</code>ï¼Œç„¶è€Œè¿™äº›å·¥å…·æ‰€æ‹¥æœ‰çš„åŠŸèƒ½å´ä¸å°½ç›¸åŒï¼Œæœ‰çš„åªæœ‰è¿è¡Œå®¹å™¨(runcã€lxc)ï¼Œè€Œæœ‰çš„é™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥å¯¹é•œåƒè¿›è¡Œç®¡ç†(containerdã€cri-o), æŒ‰ç…§å‰é¢å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œåˆ†ä¸ºä¸¤ç±», å…¶ä¸åŒå®¹å™¨è¿è¡Œæ—¶å·¥å…·åˆ†ç±»å…³ç³»å›¾å¦‚ä¸‹ã€‚</p>
<p><strong>Runtime</strong></p>
<ul>
<li><p>1) å®¹å™¨è¿è¡Œæ—¶(Container Runtime): è¿è¡ŒäºDockeræˆ–è€…Kubernetesé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸­, è´Ÿè´£å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬æ„å»ºã€åˆ›å»ºã€è¿è¡Œã€ç®¡ç†ã€åˆ é™¤ç­‰å¯¹å®¹å™¨çš„æ“ä½œã€‚å…¶ä¸­Dockeræ˜¯ç›®å‰åº”ç”¨æœ€å¹¿çš„ï¼Œéšç€å®¹å™¨äº‘çš„å‘å±•ï¼Œè¶Šæ¥è¶Šå¤šçš„å®¹å™¨è¿è¡Œæ—¶æ¶Œç°ã€‚</p>
</li>
<li><p>2) å®¹å™¨è¿è¡Œæ—¶åˆ†æˆäº† <code>low-level</code> å’Œ <code>high-level</code> ä¸¤ç±»ã€‚</p>
<ul>
<li>(1) low-level : æŒ‡çš„æ˜¯ä»…å…³æ³¨è¿è¡Œå®¹å™¨çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿï¼Œä½¿ç”¨ namespace å’Œ cgroup å®ç°èµ„æºéš”ç¦»å’Œé™åˆ¶</li>
<li>(2) high-level :æŒ‡åŒ…å«äº†æ›´å¤šä¸Šå±‚åŠŸèƒ½ï¼Œä¾‹å¦‚ grpcè°ƒç”¨ï¼Œé•œåƒå­˜å‚¨ç®¡ç†ç­‰ã€‚</li>
</ul>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629142203.png" target="_blank" title="WeiyiGeek.ä¸åŒè¿è¡Œæ—¶å·¥å…·é—´å…³ç³»" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629142203.png" alt="WeiyiGeek.ä¸åŒè¿è¡Œæ—¶å·¥å…·é—´å…³ç³»" title="" class=""></a>
                <p>WeiyiGeek.ä¸åŒè¿è¡Œæ—¶å·¥å…·é—´å…³ç³»</p>
            </figure>
<p><br></p>
<blockquote>
<p>(1) <code>low-level runtime</code> : ä¸»è¦å…³æ³¨å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿèµ„æºäº¤äº’å’Œåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ã€‚ç›®å‰å¸¸è§çš„ low-level runtimeæœ‰ï¼š</p>
<ul>
<li>lmctfy â€“ Googleçš„ä¸€ä¸ªé¡¹ç›®å®ƒæ˜¯Borgä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ã€‚</li>
<li>runc â€“ ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„å®¹å™¨è¿è¡Œæ—¶ã€‚å®ƒæœ€åˆæ˜¯ä½œä¸ºDockerçš„ä¸€éƒ¨åˆ†å¼€å‘çš„ï¼Œåæ¥è¢«æå–å‡ºæ¥ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å·¥å…·å’Œåº“, å…¶å®ç°äº† OCI è§„èŒƒåŒ…å«config.jsonæ–‡ä»¶å’Œå®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</li>
<li>rkt â€“ CoreOSå¼€å‘çš„Docker/runcçš„ä¸€ä¸ªæµè¡Œæ›¿ä»£æ–¹æ¡ˆï¼Œæä¾›äº†å…¶ä»– low-level runtimes (å¦‚runc)æ‰€æä¾›çš„æ‰€æœ‰ç‰¹æ€§ã€‚</li>
</ul>
</blockquote>
<blockquote>
<p>(2) <code>high-level runtime</code> : ä¸»è¦è´Ÿè´£ä¼ è¾“å’Œç®¡ç†å®¹å™¨é•œåƒï¼Œè§£å‹é•œåƒï¼Œå¹¶ä¼ é€’ç»™low-level runtimesæ¥è¿è¡Œå®¹å™¨ã€‚ç›®å‰ä¸»æµçš„ high-level runtime æœ‰ï¼š</p>
<ul>
<li>docker â€“ è€ç†Ÿäººå®Œæ•´çš„é›†è£…ç®±(Container)è§£å†³æ–¹æ¡ˆ</li>
<li>containerd â€“ æœ¬ç« ä¸»è§’</li>
<li>rkt â€“ ä¸Dockerç±»ä¼¼çš„å®¹å™¨å¼•æ“æ›´åŠ ä¸“æ³¨äºè§£å†³å®‰å…¨ã€å…¼å®¹ã€æ‰§è¡Œæ•ˆç‡ç­‰æ–¹é¢çš„é—®é¢˜ã€‚</li>
</ul>
</blockquote>
<p><br/></p>
<p><strong>CRI</strong><br>æè¿°: CRIæ˜¯Kuberneteså®šä¹‰çš„ä¸€ç»„gRPCæœåŠ¡ã€‚Kubeletä½œä¸ºå®¢æˆ·ç«¯ï¼ŒåŸºäºgRPCæ¡†æ¶ï¼Œé€šè¿‡Socketå’Œå®¹å™¨è¿è¡Œæ—¶é€šä¿¡ã€‚å®ƒåŒ…æ‹¬ä¸¤ç±»æœåŠ¡ï¼šé•œåƒæœåŠ¡ï¼ˆImage Serviceï¼‰å’Œè¿è¡Œæ—¶æœåŠ¡ï¼ˆRuntime Serviceï¼‰ã€‚é•œåƒæœåŠ¡æä¾›ä¸‹è½½ã€æ£€æŸ¥å’Œåˆ é™¤é•œåƒçš„è¿œç¨‹ç¨‹åºè°ƒç”¨ã€‚è¿è¡Œæ—¶æœåŠ¡åŒ…å«ç”¨äºç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠä¸å®¹å™¨äº¤äº’çš„è°ƒç”¨ <code>( exec / attach / port-forward )</code> çš„è¿œç¨‹ç¨‹åºè°ƒç”¨ã€‚</p>
<p><br/></p>
<p><strong>CRIæ¥å£å®¢æˆ·ç«¯å·¥å…·</strong></p>
<ul>
<li><p><code>ctr</code>: æ˜¯containerdæœ¬èº«çš„ CLI (<a href="https://github.com/containerd/containerd/tree/master/cmd/ctr" target="_blank" rel="noopener">https://github.com/containerd/containerd/tree/master/cmd/ctr</a>)</p>
</li>
<li><p><code>crictl</code>: æ˜¯Kubernetesç¤¾åŒºå®šä¹‰çš„ä¸“é—¨ CLI å·¥å…· (<a href="https://github.com/kubernetes-sigs/cri-tools" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/cri-tools</a>)</p>
</li>
</ul>
<p><br></p>
<h3 id="3-æ¶æ„ç®€è¿°"><a href="#3-æ¶æ„ç®€è¿°" class="headerlink" title="3.æ¶æ„ç®€è¿°"></a>3.æ¶æ„ç®€è¿°</h3><h4 id="CRI-çš„æ¶æ„"><a href="#CRI-çš„æ¶æ„" class="headerlink" title="CRI çš„æ¶æ„"></a>CRI çš„æ¶æ„</h4><p>æè¿°: CRI æ’ä»¶æ˜¯ Kubernetes å®¹å™¨è¿è¡Œæ—¶æ¥å£ ï¼ˆCRIï¼‰ çš„å®ç°, Containerd ä¸ Kubelet åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p>
<p>containerd ä¸­çš„æ’ä»¶å¤„ç†æ¥è‡ª Kubelet çš„æ‰€æœ‰ CRI æœåŠ¡è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨å®¹å™¨å†…éƒ¨æ¥ç®¡ç†å®¹å™¨å’Œå®¹å™¨æ˜ åƒ,è¯¥æ’ä»¶ä½¿ç”¨ containerd æ¥ç®¡ç†æ•´ä¸ªå®¹å™¨ç”Ÿå‘½å‘¨æœŸå’Œæ‰€æœ‰å®¹å™¨æ˜ åƒ,å¹¶é€šè¿‡CNIï¼ˆå¦ä¸€ä¸ªCNCFé¡¹ç›®ï¼‰ç®¡ç†podç½‘ç»œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://gitee.com/WeiyiGeek/blogimage/raw/master/2022/2/20220424131920.png" target="_blank" title="WeiyiGeek.CRI æ’ä»¶" data-fancybox="images"><img src="https://gitee.com/WeiyiGeek/blogimage/raw/master/2022/2/20220424131920.png" alt="WeiyiGeek.CRI æ’ä»¶" title="" class=""></a>
                <p>WeiyiGeek.CRI æ’ä»¶</p>
            </figure>
<p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥æ¼”ç¤ºå½“ Kubelet åˆ›å»ºä¸€ä¸ªå•å®¹å™¨ pod æ—¶ï¼Œæ’ä»¶æ˜¯å¦‚ä½•å·¥ä½œçš„</p>
<ul>
<li>Kubelet é€šè¿‡ CRI è¿è¡Œæ—¶æœåŠ¡ API è°ƒç”¨æ’ä»¶æ¥åˆ›å»º pod;</li>
<li>cri åˆ›å»º Pod çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œç„¶åä½¿ç”¨ CNI å¯¹å…¶è¿›è¡Œé…ç½®;</li>
<li>cri ä½¿ç”¨ containerd internal åˆ›å»ºå’Œå¯åŠ¨ä¸€ä¸ªç‰¹æ®Šçš„æš‚åœå®¹å™¨ï¼ˆæ²™ç›’å®¹å™¨ï¼‰ï¼Œå¹¶å°†è¯¥å®¹å™¨æ”¾åœ¨ pod çš„ cgroup å’Œå‘½åç©ºé—´ä¸­ï¼ˆä¸ºç®€æ´èµ·è§çœç•¥äº†æ­¥éª¤ï¼‰;</li>
<li>Kubeletéšåé€šè¿‡CRIé•œåƒæœåŠ¡APIè°ƒç”¨æ’ä»¶ï¼Œæ‹‰å–åº”ç”¨å®¹å™¨é•œåƒ;</li>
<li>cri è¿›ä¸€æ­¥ä½¿ç”¨å®¹å™¨æ¥æ‹‰å–å›¾åƒï¼Œå¦‚æœå›¾åƒä¸å­˜åœ¨äºèŠ‚ç‚¹ä¸Š;</li>
<li>ç„¶å Kubelet é€šè¿‡ CRI è¿è¡Œæ—¶æœåŠ¡ API è°ƒç”¨ï¼Œä½¿ç”¨æ‹‰å–çš„å®¹å™¨æ˜ åƒåœ¨ pod å†…åˆ›å»ºå’Œå¯åŠ¨åº”ç”¨ç¨‹åºå®¹å™¨;cri</li>
<li>cri æœ€åä½¿ç”¨ containerd internal åˆ›å»ºåº”ç”¨ç¨‹åºå®¹å™¨ï¼Œå°†å…¶æ”¾åœ¨ pod çš„ cgroup å’Œå‘½åç©ºé—´ä¸­ï¼Œç„¶åå¯åŠ¨ pod çš„æ–°åº”ç”¨ç¨‹åºå®¹å™¨ã€‚å®Œæˆè¿™äº›æ­¥éª¤åï¼Œå°†åˆ›å»ºå¹¶è¿è¡Œ Pod åŠå…¶ç›¸åº”çš„åº”ç”¨ç¨‹åºå®¹å™¨ã€‚</li>
</ul>
<p><br/></p>
<h4 id="Containerd-çš„æ¶æ„"><a href="#Containerd-çš„æ¶æ„" class="headerlink" title="Containerd çš„æ¶æ„"></a>Containerd çš„æ¶æ„</h4><p>æè¿°: containerdæ˜¯Linuxå’ŒWindowsçš„å®ˆæŠ¤ç¨‹åºã€‚å®ƒç®¡ç†å…¶ä¸»æœºç³»ç»Ÿçš„å®Œæ•´å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œä»å›¾åƒä¼ è¾“å’Œå­˜å‚¨åˆ°å®¹å™¨æ‰§è¡Œå’Œç›‘ç£ï¼Œå†åˆ°ä½çº§å­˜å‚¨åˆ°ç½‘ç»œé™„ä»¶ç­‰ç­‰ã€‚</p>
<p>Containerd çš„è®¾è®¡æ˜¯ä¸€ä¸ªå¤§çš„æ’ä»¶ç³»ç»Ÿï¼Œä¸‹å›¾ä¸­æ¯ä¸€ä¸ªè™šçº¿æ¡†å…¶å®å°±å¯¹åº”ä¸€ä¸ªæ’ä»¶ã€‚</p>
<ul>
<li>1) åº•å±‚ç³»ç»Ÿæ”¯æŒ Linux ã€Windowsæ“ä½œç³»ç»Ÿ å’Œ æ”¯æŒ arm å’Œ x86 æ¶æ„</li>
<li>2) ä¸­é—´ containerd åŒ…å« Backendã€coreã€API ä¸‰å±‚<ul>
<li>Backend å±‚: Runtime plugin æä¾›äº†å®¹å™¨è¿è¡Œæ—¶çš„å…·ä½“æ“ä½œï¼Œä¸ºäº†æ”¯æŒä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ containerd ä¹Ÿæä¾›äº†ä¸€ç³»åˆ—çš„ containerd-shim</li>
<li>Core å±‚: åˆ™æ˜¯æ ¸å¿ƒéƒ¨åˆ†ï¼Œæä¾›äº†å„ç§åŠŸèƒ½çš„æœåŠ¡ï¼Œå…¶ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ Content service ï¼Œæä¾›å¯¹é•œåƒä¸­å¯å¯»å€å†…å®¹çš„è®¿é—®ï¼Œæ‰€æœ‰ä¸å¯å˜çš„å†…å®¹éƒ½è¢«å­˜å‚¨åœ¨è¿™é‡Œï¼›Images Service æä¾›é•œåƒç›¸å…³çš„æ“ä½œï¼›Snapshot Plugin : ç”¨æ¥ç®¡ç†å®¹å™¨é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ã€‚é•œåƒä¸­çš„æ¯ä¸€ä¸ª layer éƒ½ä¼šè¢«è§£å‹æˆæ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼Œç±»ä¼¼äº Docker ä¸­çš„ graphdriver</li>
<li>API å±‚: é€šè¿‡ GRPC ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œä¾‹å¦‚æä¾›äº†ç»™ Prometheus ä½¿ç”¨ API æ¥è¿›è¡Œç›‘æ§ï¼Œç»™kubernetesæä¾›äº†CRIæ¥å£ï¼Œç»™containerdæä¾›äº†æœåŠ¡å¤„ç†ç¨‹åºã€‚</li>
</ul>
</li>
<li>3) é«˜å±‚æä¾›å„ç§å®¢æˆ·ç«¯ï¼ŒåŒ…æ‹¬ K8s çš„ kubeletï¼Œcontainerd è‡ªå·±çš„å‘½ä»¤è¡Œ ctr ç­‰ã€‚</li>
</ul>
<p>å…ˆæ¥çœ‹çœ‹ Containerd çš„æ¶æ„ï¼š<br><figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629164835.png" target="_blank" title="WeiyiGeek.containerdæ¶æ„ä½“ç³»" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629164835.png" alt="WeiyiGeek.containerdæ¶æ„ä½“ç³»" title="" class=""></a>
                <p>WeiyiGeek.containerdæ¶æ„ä½“ç³»</p>
            </figure></p>
<p><br></p>
<p>å¯ä»¥çœ‹åˆ° Containerd ä»ç„¶é‡‡ç”¨æ ‡å‡†çš„ C/S æ¶æ„ï¼ŒæœåŠ¡ç«¯é€šè¿‡ GRPC åè®®æä¾›ç¨³å®šçš„ APIï¼Œå®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨æœåŠ¡ç«¯çš„ API è¿›è¡Œé«˜çº§çš„æ“ä½œã€‚</p>
<p>ä¸ºäº†è§£è€¦ï¼ŒContainerd å°†ä¸åŒçš„èŒè´£åˆ’åˆ†ç»™ä¸åŒçš„ç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶å°±ç›¸å½“äºä¸€ä¸ªå­ç³»ç»Ÿï¼ˆsubsystemï¼‰ã€‚è¿æ¥ä¸åŒå­ç³»ç»Ÿçš„ç»„ä»¶è¢«ç§°ä¸ºæ¨¡å—ã€‚</p>
<p>æ€»ä½“ä¸Š Containerd è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªå­ç³»ç»Ÿï¼š</p>
<ul>
<li>Bundle : åœ¨ Containerd ä¸­ï¼ŒBundle åŒ…å«äº†é…ç½®ã€å…ƒæ•°æ®å’Œæ ¹æ–‡ä»¶ç³»ç»Ÿæ•°æ®ï¼Œä½ å¯ä»¥ç†è§£ä¸ºå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚è€Œ Bundle å­ç³»ç»Ÿå…è®¸ç”¨æˆ·ä»é•œåƒä¸­æå–å’Œæ‰“åŒ… Bundlesã€‚</li>
<li>Runtime : Runtime å­ç³»ç»Ÿç”¨æ¥æ‰§è¡Œ Bundlesï¼Œæ¯”å¦‚åˆ›å»ºå®¹å™¨ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼Œæ¯ä¸€ä¸ªå­ç³»ç»Ÿçš„è¡Œä¸ºéƒ½ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—åä½œå®Œæˆï¼ˆæ¶æ„å›¾ä¸­çš„ Core éƒ¨åˆ†ï¼‰ã€‚æ¯ä¸€ç§ç±»å‹çš„æ¨¡å—éƒ½ä»¥æ’ä»¶çš„å½¢å¼é›†æˆåˆ° Containerd ä¸­ï¼Œè€Œä¸”æ’ä»¶ä¹‹é—´æ˜¯ç›¸äº’ä¾èµ–çš„ã€‚ä¾‹å¦‚ï¼Œä¸Šå›¾ä¸­çš„æ¯ä¸€ä¸ªé•¿è™šçº¿çš„æ–¹æ¡†éƒ½è¡¨ç¤ºä¸€ç§ç±»å‹çš„æ’ä»¶ï¼ŒåŒ…æ‹¬ <code>Service Pluginã€Metadata Pluginã€GC Pluginã€Runtime Plugin</code> ç­‰ï¼Œå…¶ä¸­<code>Service Plugin åˆä¼šä¾èµ– Metadata Pluginã€GC Plugin å’Œ Runtime Plugin</code>ã€‚æ¯ä¸€ä¸ªå°æ–¹æ¡†éƒ½è¡¨ç¤ºä¸€ä¸ªç»†åˆ†çš„æ’ä»¶ï¼Œä¾‹å¦‚ Metadata Plugin ä¾èµ– Containers Pluginã€Content Plugin ç­‰ã€‚ æ€»ä¹‹ï¼Œä¸‡ç‰©çš†æ’ä»¶ï¼Œæ’ä»¶å°±æ˜¯æ¨¡å—ï¼Œæ¨¡å—å°±æ˜¯æ’ä»¶ã€‚</p>
<p><a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220314153536.png" target="_blank" title="WeiyiGeek.æ’ä»¶è°ƒç”¨é“¾å›¾" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220314153536.png" alt="WeiyiGeek.æ’ä»¶è°ƒç”¨é“¾å›¾"></a></p>
<p>ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„æ’ä»¶ï¼š</p>
<ul>
<li>Content Plugin : æä¾›å¯¹é•œåƒä¸­å¯å¯»å€å†…å®¹çš„è®¿é—®ï¼Œæ‰€æœ‰ä¸å¯å˜çš„å†…å®¹éƒ½è¢«å­˜å‚¨åœ¨è¿™é‡Œã€‚</li>
<li>Snapshot Plugin : ç”¨æ¥ç®¡ç†å®¹å™¨é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ã€‚é•œåƒä¸­çš„æ¯ä¸€ä¸ª layer éƒ½ä¼šè¢«è§£å‹æˆæ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼Œç±»ä¼¼äº Docker ä¸­çš„ graphdriverã€‚</li>
<li>Metrics : æš´éœ²å„ä¸ªç»„ä»¶çš„ç›‘æ§æŒ‡æ ‡ã€‚</li>
</ul>
<p><br></p>
<p>æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„æ¶æ„å›¾ç®€åŒ–å¦‚ä¸‹, ç®€åŒ–åçš„Containerd åˆ†ä¸ºä¸‰å¤§å—<code>ã€Storageã€‘ç®¡ç†é•œåƒæ–‡ä»¶çš„å­˜å‚¨ï¼› ã€Metadataã€‘ ç®¡ç†é•œåƒå’Œå®¹å™¨çš„å…ƒæ•°æ®ï¼›ã€Runtimeã€‘ç”± Task è§¦å‘è¿è¡Œæ—¶</code>, å¹¶å¯¹å¤–æä¾› GRPC æ–¹å¼çš„ API ä»¥åŠ Metrics æ¥å£ã€‚</p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629173044.png" target="_blank" title="WeiyiGeek.æ¶æ„å›¾ç®€åŒ–" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629173044.png" alt="WeiyiGeek.æ¶æ„å›¾ç®€åŒ–" title="" class=""></a>
                <p>WeiyiGeek.æ¶æ„å›¾ç®€åŒ–</p>
            </figure>
<p><br></p>
<p><strong>containerd-shim</strong><br>æè¿°: ä¸»è¦æ˜¯ç”¨äºå‰¥ç¦» containerd å®ˆæŠ¤è¿›ç¨‹ä¸å®¹å™¨è¿›ç¨‹ã€‚ç›®å‰å·²æœ‰ shim v1 å’Œ shim v2 ä¸¤ä¸ªç‰ˆæœ¬ï¼›å®ƒæ˜¯containerdä¸­çš„ä¸€ä¸ªç»„ä»¶ï¼Œå…¶é€šè¿‡ shim è°ƒç”¨ runc çš„åŒ…å‡½æ•°æ¥å¯åŠ¨å®¹å™¨ã€‚ç›´ç™½çš„è¯´å¼•å…¥shimæ˜¯å…è®¸runcåœ¨åˆ›å»ºå’Œè¿è¡Œå®¹å™¨ä¹‹åé€€å‡º, å¹¶å°†shimä½œä¸ºå®¹å™¨çš„çˆ¶è¿›ç¨‹, è€Œä¸æ˜¯containerdä½œä¸ºçˆ¶è¿›ç¨‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - å½“æˆ‘ä»¬æ‰§è¡Œ pstree å‘½ä»¤æ—¶å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¿›ç¨‹å…³ç³»containerd-shimæ˜¯ç‹¬ç«‹äºcontainerdè¿›ç¨‹è¿è¡Œçš„ã€‚</span></span><br><span class="line">pstree</span><br><span class="line">systemdâ”€â”¬â”€VGAuthService</span><br><span class="line">        â”œâ”€containerdâ”€â”€â”€15*[&#123;containerd&#125;]</span><br><span class="line">        â”œâ”€containerd-shimâ”€â”¬â”€sh</span><br><span class="line">        â”‚                 â””â”€13*[&#123;containerd-shim&#125;]</span><br><span class="line">        â”œâ”€2*[containerd-shimâ”€â”¬â”€sh]</span><br><span class="line">        â”‚                    â””â”€12*[&#123;containerd-shim&#125;]]</span><br></pre></td></tr></table></figure>
<p>æ­¤ç§æ–¹å¼çš„ç›®çš„æ˜¯å½“containerdè¿›ç¨‹æŒ‚æ‰æ—¶ä¿è¯å®¹å™¨ä¸å—å½±å“, æ­¤å¤– shim ä¹Ÿå¯ä»¥æ”¶é›†å’ŒæŠ¥å‘Šå®¹å™¨çš„é€€å‡ºçŠ¶æ€ï¼Œä¸éœ€è¦ containerd æ¥ wait å®¹å™¨è¿›ç¨‹ã€‚</p>
<p>Tipsï¼šæˆ‘ä»¬æœ‰éœ€æ±‚å»æ›¿æ¢ runc è¿è¡Œæ—¶å·¥å…·åº“æ—¶ï¼Œä¾‹å¦‚ æ›¿æ¢ä¸ºå®‰å…¨å®¹å™¨ kata container æˆ– Google ç ”å‘çš„ gViserï¼Œåˆ™éœ€è¦å¢åŠ å¯¹åº”çš„ <code>shim(kata-shim)</code> ä»¥ä¸Šä¸¤è€…å‡æœ‰è‡ªå·±å®ç°çš„ shimã€‚</p>
<p><br></p>
<p><strong>CRI &amp; OCI</strong><br>å¦‚ä¸‹å›¾æ‰€ç¤º dockershimï¼Œcontainerd å’Œ cri-o éƒ½æ˜¯éµå¾ªCRIçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ç§°ä»–ä»¬ä¸ºé«˜å±‚çº§è¿è¡Œæ—¶ï¼ˆHigh-level Runtimeï¼‰ã€‚</p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094736.png" target="_blank" title="WeiyiGeek.CRI" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094736.png" alt="WeiyiGeek.CRI" title="" class=""></a>
                <p>WeiyiGeek.CRI</p>
            </figure>
<p><br></p>
<p><strong>Containerd vs Cri-o</strong><br>æè¿°: å‰é¢æˆ‘ä»¬è¯´åˆ°è¿‡kubernetesä¸ºå•¥ä¼šæ›¿æ¢æ‰Dockerå‘¢?ä¸»è¦åŸå› å°±æ˜¯å…¶å¤æ‚æ€§ï¼Œç”±äºDockerçš„å¤šå±‚å°è£…å’Œè°ƒç”¨ï¼Œå¯¼è‡´å…¶åœ¨å¯ç»´æŠ¤æ€§ä¸Šç•¥é€Šä¸€ç­¹ï¼Œå¢åŠ äº†çº¿ä¸Šé—®é¢˜çš„å®šä½éš¾åº¦(è²Œä¼¼é™¤äº†é‡å¯Dockerï¼Œæˆ‘ä»¬å°±æ¯«æ— ä»–æ³•äº†);</p>
<ul>
<li>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æ€»ç»“äº†Dockerï¼Œcontainerdä»¥åŠcri-oçš„è¯¦ç»†è°ƒç”¨å±‚çº§, Containerdå’Œcri-oçš„æ–¹æ¡ˆæ¯”èµ· Docker ç®€æ´å¾ˆå¤š, å› æ­¤æˆ‘ä»¬æ›´åå‘äºé€‰ç”¨æ›´åŠ ç®€å•å’Œçº¯ç²¹çš„ containerd å’Œ cri-o ä½œä¸ºæˆ‘ä»¬çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œkubernetes 1.20.x ä¹‹ä¸Šçš„ç‰ˆæœ¬å»ºè®®ä½¿ç”¨containerdä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094805.png" target="_blank" title="WeiyiGeek.å®¹å™¨è¿è¡Œæ—¶è°ƒç”¨å±‚çº§" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094805.png" alt="WeiyiGeek.å®¹å™¨è¿è¡Œæ—¶è°ƒç”¨å±‚çº§" title="" class=""></a>
                <p>WeiyiGeek.å®¹å™¨è¿è¡Œæ—¶è°ƒç”¨å±‚çº§</p>
            </figure>
<ul>
<li>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯¹containerdå’Œcri-oè¿›è¡Œäº†ä¸€ç»„æ€§èƒ½æµ‹è¯•ï¼ŒåŒ…æ‹¬åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å’Œåˆ é™¤å®¹å™¨ï¼Œå¾—å‡ºå®ƒä»¬æ‰€è€—çš„æ—¶é—´ã€‚<br>Tips : containerdåœ¨å„ä¸ªæ–¹é¢éƒ½è¡¨ç°è‰¯å¥½ï¼Œé™¤äº†å¯åŠ¨å®¹å™¨è¿™é¡¹ã€‚ä»æ€»ç”¨æ—¶æ¥çœ‹ containerdçš„ç”¨æ—¶è¿˜æ˜¯è¦æ¯”cri-oè¦çŸ­çš„ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705161043.png" target="_blank" title="WeiyiGeek.containerdå’Œcrioçš„æ€§èƒ½æ¯”è¾ƒ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705161043.png" alt="WeiyiGeek.containerdå’Œcrioçš„æ€§èƒ½æ¯”è¾ƒ" title="" class=""></a>
                <p>WeiyiGeek.containerdå’Œcrioçš„æ€§èƒ½æ¯”è¾ƒ</p>
            </figure>
<ul>
<li>å¦‚ä¸‹å›¾æ‰€ç¤º, ä»åŠŸèƒ½æ€§æ¥è®²<code>containerdå’Œcri-oéƒ½ç¬¦åˆCRIå’ŒOCI</code>çš„æ ‡å‡†ã€‚ä»ç¨³å®šæ€§æ¥è¯´ï¼Œå•ç‹¬ä½¿ç”¨containerdå’Œcri-oéƒ½æ²¡æœ‰è¶³å¤Ÿçš„ç”Ÿäº§ç¯å¢ƒç»éªŒã€‚ä½†åº†å¹¸çš„æ˜¯ï¼Œcontainerdä¸€ç›´åœ¨Dockeré‡Œä½¿ç”¨ï¼Œè€ŒDockerçš„ç”Ÿäº§ç¯å¢ƒç»éªŒå¯ä»¥è¯´æ¯”è¾ƒå……è¶³ã€‚å¯è§åœ¨ç¨³å®šæ€§ä¸Šcontainerdç•¥èƒœä¸€ç­¹ã€‚æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆé€‰ç”¨äº†containerdã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>-</th>
<th>Containerd</th>
<th>CRI-O</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ€§èƒ½</td>
<td>æ›´ä¼˜</td>
<td>ä¼˜</td>
<td>-</td>
</tr>
<tr>
<td>åŠŸèƒ½</td>
<td>ä¼˜</td>
<td>ä¼˜</td>
<td>CRIä¸OCIå…¼å®¹</td>
</tr>
<tr>
<td>ç¨³å®šæ€§</td>
<td>ç¨³å®š</td>
<td>æœªçŸ¥</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong>Device Mapper vs. Overlayfs</strong><br>æè¿°: å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨å­˜å‚¨é©±åŠ¨ç¨‹åº(storage driver)æ¥ç®¡ç†é•œåƒå’Œå®¹å™¨çš„æ•°æ®ã€‚ç›®å‰æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒé€‰ç”¨çš„æ˜¯Device Mapperã€‚ç„¶è€Œç›®å‰Device Mapperåœ¨æ–°ç‰ˆæœ¬çš„Dockerä¸­å·²ç»è¢«å¼ƒç”¨ï¼Œcontainerdä¹Ÿæ”¾å¼ƒå¯¹Device Mapperçš„æ”¯æŒã€‚</p>
<p>å½“åˆé€‰ç”¨ Device Mapperï¼Œä¹Ÿæ˜¯æœ‰å†å²åŸå› çš„ã€‚æˆ‘ä»¬å¤§æ¦‚æ˜¯åœ¨2014å¹´å¼€å§‹Kubernetesè¿™ä¸ªé¡¹ç›®çš„ã€‚é‚£æ—¶å€™Overlayfséƒ½è¿˜æ²¡åˆè¿›kernelã€‚å½“æ—¶æˆ‘ä»¬è¯„ä¼°äº†Dockeræ”¯æŒçš„å­˜å‚¨é©±åŠ¨ç¨‹åºï¼Œå‘ç°Device Mapperæ˜¯æœ€ç¨³å®šçš„ã€‚æ‰€ä»¥æˆ‘ä»¬é€‰ç”¨äº†Device Mapperã€‚ä½†æ˜¯å®é™…ä½¿ç”¨ä¸‹æ¥ï¼Œç”±Device Mapperå¼•èµ·çš„Dockeré—®é¢˜ä¹Ÿä¸å°‘ã€‚æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå€Ÿè¿™ä¸ªå¥‘æœºæŠŠDevice Mapperç»™æ¢æ‰ï¼Œæ¢æˆç°åœ¨containerdå’ŒDockeréƒ½é»˜è®¤çš„Overlayfsã€‚</p>
<p>ä»ä¸‹å›¾çš„æµ‹è¯•ç»“æœæ¥çœ‹ï¼ŒOverlayfs çš„ IOæ€§èƒ½æ¯” Device Mapper å¥½å¾ˆå¤šã€‚Overlayfsçš„IOPSå¤§ä½“ä¸Šèƒ½æ¯”Device Mapperé«˜20%ï¼Œå’Œç›´æ¥æ“ä½œä¸»æœºè·¯å¾„å·®ä¸å¤šã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬é€‰ç”¨äº†containerdï¼Œå¹¶ä»¥Overlayfsä½œä¸ºå­˜å‚¨åç«¯çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ›¿æ¢äº†åŸæœ‰çš„DockeråŠ Device Mapperçš„æ­é…ã€‚</p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095538.png" target="_blank" title="WeiyiGeek.åç«¯å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½æ¯”è¾ƒ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095538.png" alt="WeiyiGeek.åç«¯å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½æ¯”è¾ƒ" title="" class=""></a>
                <p>WeiyiGeek.åç«¯å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½æ¯”è¾ƒ</p>
            </figure>
<p>æˆ‘ä»¬åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸ŠåŒæ—¶èµ·10ï¼Œ30ï¼Œ50å’Œ80çš„Podï¼Œç„¶åå†åŒæ—¶åˆ é™¤ï¼Œå»æ¯”è¾ƒè¿ç§»å‰ååˆ›å»ºå’Œåˆ é™¤çš„ç”¨æ—¶ã€‚ä»ä¸‹å›¾å¯çŸ¥ï¼Œcontainerdç”¨æ—¶æ˜æ˜¾ä¼˜äºDockerã€‚</p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095801.png" target="_blank" title="WeiyiGeek.åˆ›å»ºä¸åˆ é™¤Podçš„ç”¨æ—¶æ¯”è¾ƒ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095801.png" alt="WeiyiGeek.åˆ›å»ºä¸åˆ é™¤Podçš„ç”¨æ—¶æ¯”è¾ƒ" title="" class=""></a>
                <p>WeiyiGeek.åˆ›å»ºä¸åˆ é™¤Podçš„ç”¨æ—¶æ¯”è¾ƒ</p>
            </figure>
<p><br></p>
<p><strong>Dockerå’Œcontainerdé™¤äº†ä¸Šè¿°å¸¸ç”¨å‘½ä»¤æœ‰äº›åŒºåˆ«å¤–ï¼Œåœ¨å®¹å™¨æ—¥å¿—åŠç›¸å…³å‚æ•°é…ç½®æ–¹é¢ä¹Ÿå­˜åœ¨ä¸€äº›å·®å¼‚</strong></p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171827.png" target="_blank" title="WeiyiGeek.æ—¥å¿—ä¸cniå‚æ•°é…ç½®" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171827.png" alt="WeiyiGeek.æ—¥å¿—ä¸cniå‚æ•°é…ç½®" title="" class=""></a>
                <p>WeiyiGeek.æ—¥å¿—ä¸cniå‚æ•°é…ç½®</p>
            </figure>
<hr>
<h2 id="0x01-å®‰è£…é…ç½®"><a href="#0x01-å®‰è£…é…ç½®" class="headerlink" title="0x01 å®‰è£…é…ç½®"></a>0x01 å®‰è£…é…ç½®</h2><h3 id="1-Ubuntuå®‰è£…Containerd-ioæµç¨‹"><a href="#1-Ubuntuå®‰è£…Containerd-ioæµç¨‹" class="headerlink" title="1.Ubuntuå®‰è£…Containerd.ioæµç¨‹"></a>1.Ubuntuå®‰è£…Containerd.ioæµç¨‹</h3><p><strong>å®‰è£…ç¯å¢ƒ:</strong> å·²è¿›è¡Œå®‰å…¨åŸºçº¿åŠ å›ºä»¥åŠç³»ç»Ÿä¼˜åŒ–ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - OS</span></span><br><span class="line">$ lsb_release -a</span><br><span class="line">  <span class="comment"># Description:    Ubuntu 20.04.2 LTS focal</span></span><br><span class="line">$ uname -a</span><br><span class="line">  <span class="comment"># Linux containerd 5.4.0-78-generic #87-Ubuntu SMP Fri Jun 18 16:29:09 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Container : 1.4.6-1</span></span><br><span class="line">$ apt-cache madison containerd.io | cut -d <span class="string">'|'</span> -f 2 |  sed <span class="string">'s/^[ \t]*//g'</span></span><br><span class="line">  <span class="comment"># 1.4.6-1</span></span><br><span class="line">  <span class="comment"># 1.4.4-1</span></span><br><span class="line">  <span class="comment"># 1.4.3-2</span></span><br><span class="line">  <span class="comment"># 1.4.3-1</span></span><br><span class="line">  <span class="comment"># 1.3.9-1</span></span><br><span class="line">  <span class="comment"># 1.3.7-1</span></span><br><span class="line">  <span class="comment"># 1.2.13-2</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>å®‰è£…æµç¨‹</strong></p>
<ul>
<li><p>Step 1.å‚è€ƒ<a href="https://kubernetes.io/docs/setup/cri" target="_blank" rel="noopener">Kuberneteså®¹å™¨è¿è¡Œæ—¶æ¥å£</a>è¿›è¡Œå®‰è£…å‰çš„åŸºç¡€ç¯å¢ƒå‡†å¤‡.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å’Œé…ç½®å…ˆå†³æ¡ä»¶ï¼š</span></span><br><span class="line"><span class="comment"># æ¨¡å—åŠ è½½</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup required sysctl params, these persist across reboots.</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply sysctl params without reboot</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.åœ¨Ubuntuä¸­å®‰è£…containerd.ioï¼Œå®ƒæ¥è‡ªå®˜æ–¹Dockerå­˜å‚¨åº“çš„è½¯ä»¶åŒ…æˆ‘ä»¬å¯ä»¥å‚è€ƒå®‰è£…<code>Install Docker Engine</code>(<a href="https://docs.docker.com/engine/install/ubuntu/)ä¸­çš„å®‰è£…å‘½ä»¤ã€‚" target="_blank" rel="noopener">https://docs.docker.com/engine/install/ubuntu/)ä¸­çš„å®‰è£…å‘½ä»¤ã€‚</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - å¸è½½åŸæœ‰ Docker ä»¥åŠ containerd</span></span><br><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"><span class="comment"># - æ›´æ–°aptç¨‹åºåŒ…ç´¢å¼•å¹¶å®‰è£…ç¨‹åºåŒ…ï¼Œä»¥å…è®¸apté€šè¿‡HTTPSä½¿ç”¨å­˜å‚¨åº“</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates \</span><br><span class="line">  curl \</span><br><span class="line">  gnupg \</span><br><span class="line">  lsb-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># - æ·»åŠ Dockerçš„å®˜æ–¹GPGå¯†é’¥ï¼š</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># - ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®¾ç½®ç¨³å®šå­˜å‚¨åº“ã€‚è¦æ·»åŠ nightlyæˆ–testå­˜å‚¨åº“ï¼Œè¯·åœ¨ä¸‹é¢çš„å‘½ä»¤ä¸­çš„å•è¯stableåé¢æ·»åŠ å•è¯nightlyæˆ–testï¼ˆæˆ–ä¸¤è€…ï¼‰ã€‚</span></span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> stable"</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># - æ›´æ–°aptåŒ…ç´¢å¼•ï¼Œå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„containerdæˆ–è¿›å…¥ä¸‹ä¸€æ­¥å®‰è£…ç‰¹å®šç‰ˆæœ¬ï¼š</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># å®‰è£…å‰å¯æŸ¥çœ‹containerd.ioå¯ç”¨çš„ç‰ˆæœ¬: apt-cache madison containerd.io &amp;&amp; apt install containerd.io=1.4.6-1</span></span><br><span class="line">apt install containerd.io=1.4.6-1</span><br><span class="line"></span><br><span class="line"><span class="comment"># - æŸ¥çœ‹å®‰è£…Containerdçš„ç‰ˆæœ¬</span></span><br><span class="line">$ ctr --version</span><br><span class="line">  <span class="comment"># ctr containerd.io 1.4.6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.åˆå§‹åŒ–Containerd.ioåŸºç¡€é…ç½®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - åˆå§‹åŒ–é…ç½®</span></span><br><span class="line">sudo mkdir -p /etc/containerd</span><br><span class="line">containerd config default | sudo tee /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># - æ›¿æ¢é»˜è®¤çš„ sandbox_image = "k8s.gcr.io/pause:3.2" é•œåƒå› ä¸ºGFWçš„åŸå› å¯¼è‡´æ— æ³•è®¿é—®æˆ‘ä»¬å¯ä»¥æ›¿æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒæºã€‚</span></span><br><span class="line">sed -ir <span class="string">'s#sandbox_image = \S\w+.*$#sandbox_image = "registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"#g'</span> /etc/containerd/config.toml</span><br><span class="line">sed -ir <span class="string">"s#https://registry-1.docker.io#https://xlx9erfu.mirror.aliyuncs.com#g"</span>  /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># - åº”ç”¨é…ç½®å¹¶é‡æ–°è¿è¡ŒcontainerdæœåŠ¡å¹¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart containerd</span><br><span class="line">systemctl status containerd.service</span><br><span class="line">  <span class="comment"># â— containerd.service - containerd container runtime</span></span><br><span class="line">  <span class="comment">#     Loaded: loaded (/lib/systemd/system/containerd.service; enabled; vendor preset: enabled)</span></span><br><span class="line">  <span class="comment">#     Active: active (running) since Sun 2021-06-27 19:05:48 CST; 8s ago</span></span><br><span class="line">  <span class="comment">#       Docs: https://containerd.io</span></span><br><span class="line">  <span class="comment">#     Process: 3088 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)</span></span><br><span class="line">  <span class="comment">#   Main PID: 3097 (containerd)</span></span><br><span class="line">  <span class="comment">#       Tasks: 15</span></span><br><span class="line">  <span class="comment">#     Memory: 22.6M</span></span><br><span class="line">  <span class="comment">#     CGroup: /system.slice/containerd.service</span></span><br><span class="line">  <span class="comment">#             â””â”€3097 /usr/bin/containerd</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : æŸ¥çœ‹é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­rootä¸state åˆ†åˆ«è¡¨ç¤º Containerd æœ‰ä¸¤ä¸ªä¸åŒçš„å­˜å‚¨è·¯å¾„ï¼Œä¸€ä¸ªç”¨æ¥ä¿å­˜æŒä¹…åŒ–æ•°æ®ï¼Œä¸€ä¸ªç”¨æ¥ä¿å­˜è¿è¡Œæ—¶çŠ¶æ€ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/containerd/config.toml</span><br><span class="line">version = 2</span><br><span class="line">root = <span class="string">"/var/lib/containerd"</span></span><br><span class="line">state = <span class="string">"/run/containerd"</span></span><br><span class="line">plugin_dir = <span class="string">""</span></span><br><span class="line">disabled_plugins = []</span><br><span class="line">required_plugins = []</span><br><span class="line">oom_score = 0</span><br><span class="line"></span><br><span class="line">[grpc]</span><br><span class="line">  address = <span class="string">"/run/containerd/containerd.sock"</span></span><br><span class="line">  tcp_address = <span class="string">""</span></span><br><span class="line">  tcp_tls_cert = <span class="string">""</span></span><br><span class="line">  tcp_tls_key = <span class="string">""</span></span><br><span class="line">  uid = 0</span><br><span class="line">  gid = 0</span><br><span class="line">  max_recv_message_size = 16777216</span><br><span class="line">  max_send_message_size = 16777216</span><br><span class="line"></span><br><span class="line">[ttrpc]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  uid = 0</span><br><span class="line">  gid = 0</span><br><span class="line"></span><br><span class="line">[debug]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  uid = 0</span><br><span class="line">  gid = 0</span><br><span class="line">  level = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">[metrics]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  grpc_histogram = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">[cgroup]</span><br><span class="line">  path = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">[timeouts]</span><br><span class="line">  <span class="string">"io.containerd.timeout.shim.cleanup"</span> = <span class="string">"5s"</span></span><br><span class="line">  <span class="string">"io.containerd.timeout.shim.load"</span> = <span class="string">"5s"</span></span><br><span class="line">  <span class="string">"io.containerd.timeout.shim.shutdown"</span> = <span class="string">"3s"</span></span><br><span class="line">  <span class="string">"io.containerd.timeout.task.state"</span> = <span class="string">"2s"</span></span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">  [plugins.<span class="string">"io.containerd.gc.v1.scheduler"</span>]</span><br><span class="line">    pause_threshold = 0.02</span><br><span class="line">    deletion_threshold = 0</span><br><span class="line">    mutation_threshold = 100</span><br><span class="line">    schedule_delay = <span class="string">"0s"</span></span><br><span class="line">    startup_delay = <span class="string">"100ms"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>]</span><br><span class="line">    disable_tcp_service = <span class="literal">true</span></span><br><span class="line">    stream_server_address = <span class="string">"127.0.0.1"</span></span><br><span class="line">    stream_server_port = <span class="string">"0"</span></span><br><span class="line">    stream_idle_timeout = <span class="string">"4h0m0s"</span></span><br><span class="line">    enable_selinux = <span class="literal">false</span></span><br><span class="line">    selinux_category_range = 1024</span><br><span class="line">    sandbox_image = <span class="string">"registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"</span></span><br><span class="line">    stats_collect_period = 10</span><br><span class="line">    systemd_cgroup = <span class="literal">false</span></span><br><span class="line">    enable_tls_streaming = <span class="literal">false</span></span><br><span class="line">    max_container_log_line_size = 16384</span><br><span class="line">    disable_cgroup = <span class="literal">false</span></span><br><span class="line">    disable_apparmor = <span class="literal">false</span></span><br><span class="line">    restrict_oom_score_adj = <span class="literal">false</span></span><br><span class="line">    max_concurrent_downloads = 3</span><br><span class="line">    disable_proc_mount = <span class="literal">false</span></span><br><span class="line">    unset_seccomp_profile = <span class="string">""</span></span><br><span class="line">    tolerate_missing_hugetlb_controller = <span class="literal">true</span></span><br><span class="line">    disable_hugetlb_controller = <span class="literal">true</span></span><br><span class="line">    ignore_image_defined_volumes = <span class="literal">false</span></span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd]</span><br><span class="line">      snapshotter = <span class="string">"overlayfs"</span></span><br><span class="line">      default_runtime_name = <span class="string">"runc"</span></span><br><span class="line">      no_pivot = <span class="literal">false</span></span><br><span class="line">      disable_snapshot_annotations = <span class="literal">true</span></span><br><span class="line">      discard_unpacked_layers = <span class="literal">false</span></span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.default_runtime]</span><br><span class="line">        runtime_type = <span class="string">""</span></span><br><span class="line">        runtime_engine = <span class="string">""</span></span><br><span class="line">        runtime_root = <span class="string">""</span></span><br><span class="line">        privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">        base_runtime_spec = <span class="string">""</span></span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.untrusted_workload_runtime]</span><br><span class="line">        runtime_type = <span class="string">""</span></span><br><span class="line">        runtime_engine = <span class="string">""</span></span><br><span class="line">        runtime_root = <span class="string">""</span></span><br><span class="line">        privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">        base_runtime_spec = <span class="string">""</span></span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc]</span><br><span class="line">          runtime_type = <span class="string">"io.containerd.runc.v2"</span></span><br><span class="line">          runtime_engine = <span class="string">""</span></span><br><span class="line">          runtime_root = <span class="string">""</span></span><br><span class="line">          privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">          base_runtime_spec = <span class="string">""</span></span><br><span class="line">          [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc.options]</span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.cni]</span><br><span class="line">      bin_dir = <span class="string">"/opt/cni/bin"</span></span><br><span class="line">      conf_dir = <span class="string">"/etc/cni/net.d"</span></span><br><span class="line">      max_conf_num = 1</span><br><span class="line">      conf_template = <span class="string">""</span></span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry]</span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"docker.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"https://registry-1.docker.io"</span>]</span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.image_decryption]</span><br><span class="line">      key_model = <span class="string">""</span></span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.x509_key_pair_streaming]</span><br><span class="line">      tls_cert_file = <span class="string">""</span></span><br><span class="line">      tls_key_file = <span class="string">""</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.internal.v1.opt"</span>]</span><br><span class="line">    path = <span class="string">"/opt/containerd"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.internal.v1.restart"</span>]</span><br><span class="line">    interval = <span class="string">"10s"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.metadata.v1.bolt"</span>]</span><br><span class="line">    content_sharing_policy = <span class="string">"shared"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.monitor.v1.cgroups"</span>]</span><br><span class="line">    no_prometheus = <span class="literal">false</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.runtime.v1.linux"</span>]</span><br><span class="line">    shim = <span class="string">"containerd-shim"</span></span><br><span class="line">    runtime = <span class="string">"runc"</span></span><br><span class="line">    runtime_root = <span class="string">""</span></span><br><span class="line">    no_shim = <span class="literal">false</span></span><br><span class="line">    shim_debug = <span class="literal">false</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.runtime.v2.task"</span>]</span><br><span class="line">    platforms = [<span class="string">"linux/amd64"</span>]</span><br><span class="line">  [plugins.<span class="string">"io.containerd.service.v1.diff-service"</span>]</span><br><span class="line">    default = [<span class="string">"walking"</span>]</span><br><span class="line">  [plugins.<span class="string">"io.containerd.snapshotter.v1.devmapper"</span>]</span><br><span class="line">    root_path = <span class="string">""</span></span><br><span class="line">    pool_name = <span class="string">""</span></span><br><span class="line">    base_image_size = <span class="string">""</span></span><br><span class="line">    async_remove = <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: rootç”¨æ¥ä¿å­˜æŒä¹…åŒ–æ•°æ®ï¼ŒåŒ…æ‹¬ Snapshots, Content, Metadata ä»¥åŠå„ç§æ’ä»¶çš„æ•°æ®ã€‚æ¯ä¸€ä¸ªæ’ä»¶éƒ½æœ‰è‡ªå·±å•ç‹¬çš„ç›®å½•ï¼ŒContainerd æœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒçš„æ‰€æœ‰åŠŸèƒ½éƒ½æ¥è‡ªäºå·²åŠ è½½çš„æ’ä»¶ï¼ŒçœŸæ˜¯å¤ªæœºæ™ºäº†ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ tree -L 2 /var/lib/containerd/</span><br><span class="line">/var/lib/containerd/</span><br><span class="line">â”œâ”€â”€ io.containerd.content.v1.content</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ blobs</span><br><span class="line">â”‚Â Â  â””â”€â”€ ingest</span><br><span class="line">â”œâ”€â”€ io.containerd.grpc.v1.cri</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â””â”€â”€ sandboxes</span><br><span class="line">â”œâ”€â”€ io.containerd.metadata.v1.bolt</span><br><span class="line">â”‚Â Â  â””â”€â”€ meta.db</span><br><span class="line">â”œâ”€â”€ io.containerd.runtime.v1.linux</span><br><span class="line">â”‚Â Â  â””â”€â”€ k8s.io</span><br><span class="line">â”œâ”€â”€ io.containerd.runtime.v2.task</span><br><span class="line">â”œâ”€â”€ io.containerd.snapshotter.v1.aufs</span><br><span class="line">â”‚Â Â  â””â”€â”€ snapshots</span><br><span class="line">â”œâ”€â”€ io.containerd.snapshotter.v1.btrfs</span><br><span class="line">â”œâ”€â”€ io.containerd.snapshotter.v1.native</span><br><span class="line">â”‚Â Â  â””â”€â”€ snapshots</span><br><span class="line">â”œâ”€â”€ io.containerd.snapshotter.v1.overlayfs</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ metadata.db</span><br><span class="line">â”‚Â Â  â””â”€â”€ snapshots</span><br><span class="line">â””â”€â”€ tmpmounts</span><br><span class="line"></span><br><span class="line">18 directories, 2 files</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: ç”¨æ¥ä¿å­˜ä¸´æ—¶æ•°æ®ï¼ŒåŒ…æ‹¬ socketsã€pidã€æŒ‚è½½ç‚¹ã€è¿è¡Œæ—¶çŠ¶æ€ä»¥åŠä¸éœ€è¦æŒä¹…åŒ–ä¿å­˜çš„æ’ä»¶æ•°æ®ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ğŸ³  â†’ tree -L 2 /run/containerd/</span><br><span class="line">/run/containerd/</span><br><span class="line">â”œâ”€â”€ containerd.sock</span><br><span class="line">â”œâ”€â”€ containerd.sock.ttrpc</span><br><span class="line">â”œâ”€â”€ io.containerd.grpc.v1.cri</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â””â”€â”€ sandboxes</span><br><span class="line">â”œâ”€â”€ io.containerd.runtime.v1.linux</span><br><span class="line">â”‚Â Â  â””â”€â”€ k8s.io</span><br><span class="line">â”œâ”€â”€ io.containerd.runtime.v2.task</span><br><span class="line">â””â”€â”€ runc</span><br><span class="line">    â””â”€â”€ k8s.io</span><br><span class="line"></span><br><span class="line">8 directories, 2 files</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: å€¼å¾—æ³¨æ„çš„æ˜¯ OOM è¿™ä¸€é…ç½®é¡¹ <code>oom_score = 0</code>ã€‚<br>Containerd æ˜¯å®¹å™¨çš„å®ˆæŠ¤è€…ï¼Œä¸€æ—¦å‘ç”Ÿå†…å­˜ä¸è¶³çš„æƒ…å†µï¼Œç†æƒ³çš„æƒ…å†µåº”è¯¥æ˜¯å…ˆæ€æ­»å®¹å™¨ï¼Œè€Œä¸æ˜¯æ€æ­» Containerdã€‚æ‰€ä»¥éœ€è¦è°ƒæ•´ Containerd çš„ OOM æƒé‡ï¼Œå‡å°‘å…¶è¢« OOM Kill çš„å‡ ç‡,æœ€å¥½æ˜¯å°† oom_score çš„å€¼è°ƒæ•´ä¸ºæ¯”å…¶ä»–å®ˆæŠ¤è¿›ç¨‹ç•¥ä½çš„å€¼ã€‚è¿™é‡Œçš„ oom_socre å…¶å®å¯¹åº”çš„æ˜¯ <code>/proc/&lt;pid&gt;/oom_socre_adj</code>ï¼Œåœ¨æ—©æœŸçš„ Linux å†…æ ¸ç‰ˆæœ¬é‡Œä½¿ç”¨ oom_adj æ¥è°ƒæ•´æƒé‡, åæ¥æ”¹ç”¨ <code>oom_socre_adj</code> äº†ã€‚åœ¨è®¡ç®—æœ€ç»ˆçš„ <code>badness score</code> æ—¶ï¼Œä¼šåœ¨è®¡ç®—ç»“æœæ˜¯ä¸­åŠ ä¸Š oom_score_adj ,è¿™æ ·ç”¨æˆ·å°±å¯ä»¥é€šè¿‡è¯¥åœ¨å€¼æ¥ä¿æŠ¤æŸä¸ªè¿›ç¨‹ä¸è¢«æ€æ­»æˆ–è€…æ¯æ¬¡éƒ½æ€æŸä¸ªè¿›ç¨‹ã€‚å…¶å–å€¼èŒƒå›´ä¸º -1000 åˆ° 1000ã€‚</p>
<p>å¦‚æœå°†è¯¥å€¼è®¾ç½®ä¸º -1000ï¼Œåˆ™è¿›ç¨‹æ°¸è¿œä¸ä¼šè¢«æ€æ­»ï¼Œå› ä¸ºæ­¤æ—¶ badness score æ°¸è¿œè¿”å›0, å»ºè®® Containerd å°†è¯¥å€¼è®¾ç½®ä¸º -999 åˆ° 0 ä¹‹é—´ã€‚å¦‚æœä½œä¸º Kubernetes çš„ Worker èŠ‚ç‚¹ï¼Œå¯ä»¥è€ƒè™‘è®¾ç½®ä¸º -999ã€‚</p>
<p><br></p>
<ul>
<li>Step 4.æŸ¥çœ‹containerd Clientä¸Serverç«¯çš„ä¿¡æ¯ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ctr version</span><br><span class="line">Client:</span><br><span class="line">  Version:  1.4.6</span><br><span class="line">  Revision: d71fcd7d8303cbf684402823e425e9dd2e99285d</span><br><span class="line">  Go version: go1.13.15</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">  Version:  1.4.6</span><br><span class="line">  Revision: d71fcd7d8303cbf684402823e425e9dd2e99285d</span><br><span class="line">  UUID: 71a28bbb-6ed6-408d-a873-e394d48b35d8</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 5.æŸ¥çœ‹ Containerd çš„ systemd é…ç½®ä¸è‡ªå¯è®¾ç½®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ cat /lib/systemd/system/containerd.service | grep -v <span class="string">"#"</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target <span class="built_in">local</span>-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/bin/containerd</span><br><span class="line"></span><br><span class="line">Type=notify</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">TasksMax=infinity</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç°åœ¨åˆ°äº†æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå¯ç”¨ Containerd è‡ªå¯åŠ¨ã€‚</span></span><br><span class="line">systemctl <span class="built_in">enable</span> containerd --now</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ä¸Šè¿°é…ç½®ä¸­æœ‰ä¸¤ä¸ªé‡è¦å‚æ•°å³ Delegate å’Œ KillModeã€‚</p>
<ul>
<li><strong>Delegate</strong> : è¿™ä¸ªé€‰é¡¹å…è®¸ Containerd ä»¥åŠè¿è¡Œæ—¶è‡ªå·±ç®¡ç†è‡ªå·±åˆ›å»ºçš„å®¹å™¨çš„ cgroupsã€‚å¦‚æœä¸è®¾ç½®è¿™ä¸ªé€‰é¡¹ï¼Œsystemd å°±ä¼šå°†è¿›ç¨‹ç§»åˆ°è‡ªå·±çš„ cgroups ä¸­ï¼Œä»è€Œå¯¼è‡´ Containerd æ— æ³•æ­£ç¡®è·å–å®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚</li>
<li><strong>KillMode</strong> : è¿™ä¸ªé€‰é¡¹ç”¨æ¥å¤„ç† Containerd è¿›ç¨‹è¢«æ€æ­»çš„æ–¹å¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œsystemd ä¼šåœ¨è¿›ç¨‹çš„ cgroup ä¸­æŸ¥æ‰¾å¹¶æ€æ­» Containerd çš„æ‰€æœ‰å­è¿›ç¨‹ï¼Œè¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚KillModeå­—æ®µå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ã€‚<ul>
<li><code>control-group</code>ï¼ˆé»˜è®¤å€¼ï¼‰ï¼šå½“å‰æ§åˆ¶ç»„é‡Œé¢çš„æ‰€æœ‰å­è¿›ç¨‹ï¼Œéƒ½ä¼šè¢«æ€æ‰</li>
<li><code>process</code>ï¼šåªæ€ä¸»è¿›ç¨‹</li>
<li><code>mixed</code>ï¼šä¸»è¿›ç¨‹å°†æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå­è¿›ç¨‹æ”¶åˆ° SIGKILL ä¿¡å·</li>
<li><code>none</code>ï¼šæ²¡æœ‰è¿›ç¨‹ä¼šè¢«æ€æ‰ï¼Œåªæ˜¯æ‰§è¡ŒæœåŠ¡çš„ stop å‘½ä»¤ã€‚</li>
</ul>
</li>
</ul>
<p>æˆ‘ä»¬éœ€è¦å°† KillMode çš„å€¼è®¾ç½®ä¸º processï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿å‡çº§æˆ–é‡å¯ Containerd æ—¶ä¸æ€æ­»ç°æœ‰çš„å®¹å™¨ã€‚</p>
<hr>
<h2 id="0x02-Containerd-ç®€å•å°è¯•ä½¿ç”¨"><a href="#0x02-Containerd-ç®€å•å°è¯•ä½¿ç”¨" class="headerlink" title="0x02 Containerd ç®€å•å°è¯•ä½¿ç”¨"></a>0x02 Containerd ç®€å•å°è¯•ä½¿ç”¨</h2><p>æè¿°: æ­¤å¤„ä»¥ä¸Šé¢Ubuntuçš„å®‰è£…ç¯å¢ƒè¿›è¡Œæ¼”ç¤ºã€‚</p>
<h3 id="1-é•œåƒæ‹‰å–ä¸è¿è¡Œ"><a href="#1-é•œåƒæ‹‰å–ä¸è¿è¡Œ" class="headerlink" title="1.é•œåƒæ‹‰å–ä¸è¿è¡Œ"></a>1.é•œåƒæ‹‰å–ä¸è¿è¡Œ</h3><p>Tips : containerd é»˜è®¤çš„ä¸‰ä¸ªåç§°ç©ºé—´(Namespace)æ˜¯<code>default,docker.io,k8s.io</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 1.å°† hello-world:latest é•œåƒæ‹‰å–åˆ°é»˜è®¤çš„åç§°ç©ºé—´ä¸­,å°†busybox:latesté•œåƒæ‹‰å–åˆ°k8s.ioåç§°ç©ºé—´ä¸­ã€‚</span></span><br><span class="line">ctr image pull docker.io/library/hello-world:latest</span><br><span class="line">ctr -n k8s.io image pull docker.io/library/busybox:latest</span><br><span class="line">ctr -n k8s.io image pull registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 2.åˆ†åˆ«æŸ¥çœ‹æ‹‰å–çš„é•œåƒ</span></span><br><span class="line">ctr image ls &amp;&amp; ctr -n k8s.io image ls</span><br><span class="line">  <span class="comment"># REF                                  TYPE                                                      DIGEST                                                                  SIZE    PLATFORMS                                                                                                             LABELS</span></span><br><span class="line">  <span class="comment"># docker.io/library/hello-world:latest application/vnd.docker.distribution.manifest.list.v2+json sha256:9f6ad537c5132bcce57f7a0a20e317228d382c3cd61edae14650eec68b2b345c 6.5 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x,windows/amd64 </span></span><br><span class="line">  <span class="comment"># docker.io/library/busybox:latest                                        application/vnd.docker.distribution.manifest.list.v2+json sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d 752.6 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x io.cri-containerd.image=managed</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0     application/vnd.docker.distribution.manifest.v2+json      sha256:3b3a29e3c90ae7762bdf587d19302e62485b6bef46e114b741f7d75dba023bd3 306.4 KiB linux/amd64                                                                                                          io.cri-containerd.image=managed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 3.è¿è¡Œhello-world:latestå’Œåˆ†æ­¥è¿è¡Œbusyboxé•œåƒ</span></span><br><span class="line">ctr run docker.io/library/hello-world:latest hello-world</span><br><span class="line"><span class="comment"># Hello from Docker!</span></span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line"><span class="comment"># For more examples and ideas, visit:</span></span><br><span class="line"><span class="comment">#  https://docs.docker.com/get-started/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªcontainer(æ­¤æ—¶è¿˜æœªè¿è¡Œ)</span></span><br><span class="line">ctr -n k8s.io container create docker.io/library/busybox:latest busybox</span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªtaskå¹¶åå°è¿è¡Œ</span></span><br><span class="line">ctr -n k8s.io task start -d busybox</span><br><span class="line"><span class="comment"># ä¸€æ­¥åˆ°ä½: ctr -n k8s.io run -d docker.io/library/busybox:latest busybox</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 4.æŸ¥çœ‹ä½ åˆ›å»ºçš„å®¹å™¨ä¸Task</span></span><br><span class="line">ctr container ls &amp;&amp; ctr -n k8s.io container ls</span><br><span class="line">  <span class="comment"># CONTAINER      IMAGE                                   RUNTIME</span></span><br><span class="line">  <span class="comment"># hello-world    docker.io/library/hello-world:latest    io.containerd.runc.v2</span></span><br><span class="line">  <span class="comment"># CONTAINER    IMAGE                               RUNTIME</span></span><br><span class="line">  <span class="comment"># busybox      docker.io/library/busybox:latest    io.containerd.runc.v2</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¯¥å®¹å™¨åœ¨å®¿ä¸»æœºçš„PID</span></span><br><span class="line">ctr -n k8s.io task ls</span><br><span class="line">  <span class="comment"># TASK       PID      STATUS</span></span><br><span class="line">  <span class="comment"># busybox    25856    RUNNING</span></span><br><span class="line">ps ajxf|grep <span class="string">"containerd-shim-runc\|25856"</span>|grep -v grep</span><br><span class="line">      1   25828   25828    3097 ?             -1 Sl       0   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id busybox -address /run/containerd/containerd.sock</span><br><span class="line">  25828   25856   25856   25856 ?             -1 Ss       0   0:00  \_ sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 5.è¿›å…¥åˆ°å®¹å™¨å†…éƒ¨æ‰§è¡Œshellå‘½ä»¤</span></span><br><span class="line">ctr -n k8s.io t <span class="built_in">exec</span> --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> -t busybox sh</span><br><span class="line">  <span class="comment"># / # uname -a</span></span><br><span class="line">  <span class="comment"># Linux containerd 3.10.0-1062.el7.x86_64 #1 SMP Wed Aug 7 18:08:02 UTC 2019 x86_64 GNU/Linux</span></span><br><span class="line">  <span class="comment"># ---  æ­¤å¤„ä½ ä¼šå‘ç°åªæœ‰loç½‘ç»œå¡åç»­æˆ‘ä»¬å¯ä»¥é€šè¿‡CNIæ’ä»¶çš„å½¢å¼æ·»åŠ ç½‘å¡å®ç°å¤–éƒ¨ç½‘ç»œé€šä¿¡ --- </span></span><br><span class="line">  <span class="comment"># / # ip a</span></span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line">  <span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 ::1/128 scope host </span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 6.åˆ é™¤åˆ›å»ºçš„Taskä¸å®¹å™¨</span></span><br><span class="line">ctr -n k8s.io t <span class="built_in">kill</span> -s SIGKILL busybox  <span class="comment"># å‘é€SIGKILLä¿¡å·é‡æ€æ­»è¯¥å®¹å™¨</span></span><br><span class="line">ctr -n k8s.io task rm busybox</span><br><span class="line">ctr -n k8s.io snapshots rm busybox</span><br><span class="line">ctr -n k8s.io container rm busybox</span><br><span class="line">ctr container rm hello-world</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="2-åˆ›å»ºå’Œä½¿ç”¨ç½‘ç»œ"><a href="#2-åˆ›å»ºå’Œä½¿ç”¨ç½‘ç»œ" class="headerlink" title="2.åˆ›å»ºå’Œä½¿ç”¨ç½‘ç»œ"></a>2.åˆ›å»ºå’Œä½¿ç”¨ç½‘ç»œ</h3><p>æè¿°: åœ¨å‰é¢æˆ‘ä»¬è¿›å…¥busyboxå®¹å™¨ä¸­ä¼šå‘ç°é‡Œé¢åªæœ‰ä¸€å¼ ç½‘å¡è€Œä¸”æ— æ³•è¿æ¥åˆ°å¤–éƒ¨ç½‘ç»œä¹‹ä¸­,æ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©äº<a href="https://www.cni.dev/" target="_blank" rel="noopener">CNIï¼ˆContainer Network Interface</a>å®ƒæ˜¯ä¸€ä¸ªäº‘è®¡ç®—åŸºç¡€é¡¹ç›®æ¥å®ç°Containerdå®¹å™¨å…·æœ‰ç½‘ç»œåŠŸèƒ½ã€‚</p>
<p><strong>é¡¹ç›®è¯´æ˜:</strong></p>
<ul>
<li>2.1) CNI ç½‘ç»œæ’ä»¶(Plugins) : <a href="https://github.com/containernetworking/plugins" target="_blank" rel="noopener">https://github.com/containernetworking/plugins</a> (PS : å½“å‰ç‰ˆæœ¬ v0.9.1)</li>
<li>2.2) CNI å®¹å™¨ç½‘ç»œæ¥å£-Linuxå®¹å™¨ç½‘ç»œ : <a href="https://github.com/containernetworking/cni" target="_blank" rel="noopener">https://github.com/containernetworking/cni</a></li>
</ul>
<p><strong>æ“ä½œæµç¨‹:</strong></p>
<ul>
<li><p>Step 1.CNIæ’ä»¶ä¸‹è½½ï¼ˆç°åœ¨ç‰ˆæœ¬å¯èƒ½å¤§äºv0.9.1,å¦‚æœ‰ä¸åŒè¯·å‚è€ƒå®˜ç½‘æ–‡æ¡£ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 1.ä»containernetworking/pluginsçš„releaseé¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆæœ¬å¹¶è§£å‹åˆ°/usr/local/cni-plugins:</span></span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">mkdir -vp /usr/<span class="built_in">local</span>/cni-plugins &amp;&amp; tar xvf cni-plugins-linux-amd64-v0.9.1.tgz -C /usr/<span class="built_in">local</span>/cni-plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 2.ä»containernetworking/cniçš„releaseé¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆæœ¬å¹¶è§£å‹åˆ°/usr/local/cni-&#123;version&#125;:</span></span><br><span class="line">wget https://github.com/containernetworking/cni/archive/refs/tags/v0.8.1.tar.gz</span><br><span class="line">tar -zxvf v0.8.1.tar.gz -C /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.åˆ›å»ºå’Œ<a href="https://github.com/containernetworking/cni#running-the-plugins" target="_blank" rel="noopener">ä½¿ç”¨CNIç½‘ç»œæ’ä»¶</a></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - ä½¿ç”¨bridgeæ’ä»¶åˆ›å»ºä¸€ä¸ªç½‘å¡ä¾èµ–äºä¸€ä¸‹é¢çš„é…ç½®æ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line">mkdir -p /etc/cni/net.d</span><br><span class="line">cat &gt;/etc/cni/net.d/10-mynet.conf &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cniVersion"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"mynet"</span>,</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">  <span class="string">"bridge"</span>: <span class="string">"cni0"</span>,</span><br><span class="line">  <span class="string">"isGateway"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"ipMasq"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"ipam"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"host-local"</span>,</span><br><span class="line">    <span class="string">"subnet"</span>: <span class="string">"10.22.0.0/16"</span>,</span><br><span class="line">    <span class="string">"routes"</span>: [</span><br><span class="line">      &#123; <span class="string">"dst"</span>: <span class="string">"0.0.0.0/0"</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line">cat &gt;/etc/cni/net.d/99-loopback.conf &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cniVersion"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"lo"</span>,</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"loopback"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># - æ³¨æ„jsonå­—ç¬¦ä¸²è§£æéœ€è¦ä¾èµ–jqå‘½ä»¤æ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£…(å·²å®‰è£…å¯ä»¥è·³è¿‡)</span></span><br><span class="line">apt install jq -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># - åˆ©ç”¨CNIç½‘ç»œæ’ä»¶è¿›è¡Œæ¿€æ´»cni0ç½‘å¡</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/cni-0.8.1/scripts/</span><br><span class="line">/usr/<span class="built_in">local</span>/cni-0.8.1/scripts<span class="comment"># CNI_PATH=/usr/local/cni-plugins ./priv-net-run.sh echo "Hello World! CNI Plugins."</span></span><br><span class="line">Hello World! CNI Plugins.</span><br><span class="line"></span><br><span class="line"><span class="comment"># - å®¿ä¸»æœºæ‰§è¡Œip aå‘½ä»¤å³å¯çœ‹åˆ°ä¸€ä¸ªcni0çš„ç½‘å¡</span></span><br><span class="line">/usr/<span class="built_in">local</span>/cni-0.8.1/scripts<span class="comment"># ip addr show cni0</span></span><br><span class="line">3: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link/ether ea:3e:1b:23:66:3a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.22.0.1/16 brd 10.22.255.255 scope global cni0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 3.ä½¿<code>containerd</code>å®¹å™¨å…·å¤‡ç½‘ç»œåŠŸèƒ½(<code>ä½¿å…¶å…·å¤‡å„å®¹å™¨äº’é€šã€å¤–éƒ¨ç½‘ç»œé€šä¿¡åŠŸèƒ½</code>)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - å°†busyboxå®¹å™¨å®ç°ç½‘ç»œé€šä¿¡</span></span><br><span class="line">ctr -n k8s.io run -d docker.io/library/busybox:latest busybox</span><br><span class="line">ctr -n k8s.io task ls</span><br><span class="line">  <span class="comment"># TASK       PID      STATUS</span></span><br><span class="line">  <span class="comment"># busybox    43908    RUNNING</span></span><br><span class="line">pid=$(ctr -n k8s.io t ls|grep busybox|awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">netnspath=/proc/<span class="variable">$pid</span>/ns/net</span><br><span class="line">CNI_PATH=/usr/<span class="built_in">local</span>/cni-plugins /usr/<span class="built_in">local</span>/cni-0.8.1/scripts/<span class="built_in">exec</span>-plugins.sh add <span class="variable">$pid</span> <span class="variable">$netnspath</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - éšåè¿›å…¥busyboxå®¹å™¨æˆ‘ä»¬å°†ä¼šå‘ç°å…¶æ–°å¢äº†ä¸€å¼ ç½‘å¡å¹¶å¯ä»¥å®ç°å¤–éƒ¨ç½‘ç»œè®¿é—®ï¼š</span></span><br><span class="line">ctr -n k8s.io task <span class="built_in">exec</span> --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> -t busybox  sh -</span><br><span class="line">  <span class="comment"># / # ip addr</span></span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line">  <span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># 3: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line">  <span class="comment">#     link/ether d6:fd:92:9c:8a:a9 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 10.22.0.3/16 brd 10.22.255.255 scope global eth0</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 fe80::d4fd:92ff:fe9c:8aa9/64 scope link</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># / # ping 223.6.6.6   # å¤–ç½‘æ²¡æœ‰é—®é¢˜ã€‚</span></span><br><span class="line">  PING 223.6.6.6 (223.6.6.6): 56 data bytes</span><br><span class="line">  64 bytes from 223.6.6.6: seq=0 ttl=113 time=7.902 ms</span><br><span class="line">  64 bytes from 223.6.6.6: seq=1 ttl=113 time=7.102 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># - åœ¨åˆ›å»ºä¸€ä¸ªbusybox-1å®ç°äº’é€šã€‚</span></span><br><span class="line">ctr -n k8s.io run -d docker.io/library/busybox:latest busybox-1</span><br><span class="line">pid=$(ctr -n k8s.io t ls|grep busybox-1|awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">netnspath=/proc/<span class="variable">$pid</span>/ns/net</span><br><span class="line">CNI_PATH=/usr/<span class="built_in">local</span>/cni-plugins /usr/<span class="built_in">local</span>/cni-0.8.1/scripts/<span class="built_in">exec</span>-plugins.sh add <span class="variable">$pid</span> <span class="variable">$netnspath</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - æŸ¥çœ‹ä½ åˆ›å»ºå®¹å™¨çš„pidè¿›ç¨‹ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">ps ajxf|egrep <span class="string">"containerd-shim-runc|43908|48850"</span>|grep -v grep</span><br><span class="line">  <span class="comment">#     1   43883   43883   39042 ?             -1 Sl       0   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id busybox -address /run/containerd/containerd.sock</span></span><br><span class="line">  <span class="comment"># 43883   43908   43908   43908 ?             -1 Ss       0   0:00  \_ sh</span></span><br><span class="line">  <span class="comment">#     1   48825   48825   39042 ?             -1 Sl       0   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id busybox-1 -address /run/containerd/containerd.sock</span></span><br><span class="line">  <span class="comment"># 48825   48850   48850   48850 ?             -1 Ss       0   0:00  \_ sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - æŸ¥çœ‹åˆ›å»ºçš„busybox-1ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">ctr -n k8s.io task <span class="built_in">exec</span> --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> -t busybox-1 sh -</span><br><span class="line">  <span class="comment"># 3: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line">  <span class="comment">#     link/ether 9e:70:c6:cd:a5:7b brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 10.22.0.4/16 brd 10.22.255.255 scope global eth0</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 fe80::9c70:c6ff:fecd:a57b/64 scope link</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : é‡‡ç”¨<code>nc -l -v -p 8080</code>ç›‘å¬åœ¨å¦å¤–çš„ä¸€ä¸ªå®¹å™¨é‡Œé¢è¿›è¡Œé€šä¿¡é“¾æ¥ã€‚</p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210628221210.png" target="_blank" title="WeiyiGeek.CNI-Plugins" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210628221210.png" alt="WeiyiGeek.CNI-Plugins" title="" class=""></a>
                <p>WeiyiGeek.CNI-Plugins</p>
            </figure>
<p><br></p>
<h3 id="3-ä¸å®¿ä¸»æœºå’Œå…¶å®ƒå®¹å™¨å…±äº«æ–‡ä»¶"><a href="#3-ä¸å®¿ä¸»æœºå’Œå…¶å®ƒå®¹å™¨å…±äº«æ–‡ä»¶" class="headerlink" title="3.ä¸å®¿ä¸»æœºå’Œå…¶å®ƒå®¹å™¨å…±äº«æ–‡ä»¶"></a>3.ä¸å®¿ä¸»æœºå’Œå…¶å®ƒå®¹å™¨å…±äº«æ–‡ä»¶</h3><p>æè¿°: åœ¨Dockeræˆ‘ä»¬å¸¸å¸¸éœ€è¦å°†é…ç½®æ–‡ä»¶æˆ–è€…å„ç±»æ•°æ®æ˜ å°„è¿›å…¥åˆ°dockerå®¹å™¨ä¹‹ä¸­ï¼Œä¾¿äºå®¹å™¨å†…éƒ¨ç¨‹åºä½¿ç”¨æˆ–è€…æ•°æ®çš„æŒä¹…åŒ–ã€‚</p>
<p>ä¸‹é¢åˆ†åˆ«ç®€å•æ¼”ç¤ºä¸å®¿ä¸»æœºæˆ–è€…å…¶å®ƒå®¹å™¨å…±äº«ç›®å½•;</p>
<ul>
<li><p><strong>(1) å®¿ä¸»æœºå…±äº«</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ctr -n k8s.io c create docker.io/library/busybox:latest busybox-2 --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/tmp,dst=/host,options=rbind:rw</span><br><span class="line"></span><br><span class="line">ctr -n k8s.io t start -d busybox-2 sh</span><br><span class="line"></span><br><span class="line">ctr -n k8s.io t <span class="built_in">exec</span> -t --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> busybox-2 sh</span><br><span class="line">  <span class="comment"># / # echo "WeiyiGeek" &gt; /host/name</span></span><br><span class="line">  <span class="comment"># / # </span></span><br><span class="line">root@containerd:~<span class="comment"># cat /tmp/name</span></span><br><span class="line">WeiyiGeek</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>(2) å…¶å®ƒå®¹å™¨é—´å…±äº«</strong><br>æè¿°: æœ¬ç« èŠ‚å¯¹äºPID NSå…±äº«ä¸ºä¾‹å…¶å®ƒçš„NSå…±äº«ä¸è¯¥æ–¹æ¡ˆç±»ä¼¼ï¼Œä¸‹é¢æˆ‘ä»¬åˆ©ç”¨docker ä¸ container å¯¹nså…±äº«è®¾ç½®åšä¸€ä¸ªå¯¹æ¯”ã€‚</p>
</li>
</ul>
<p>é¦–å…ˆæˆ‘ä»¬å¯¹dockerçš„nså…±äº«è¿›è¡Œå®éªŒï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@docker scripts]<span class="comment"># docker run --rm -it -d busybox sh</span></span><br><span class="line">687c80243ee15e0a2171027260e249400feeeee2607f88d1f029cc270402cdd1</span><br><span class="line">[root@docker scripts]<span class="comment"># docker run --rm -it -d --pid="container:687c80243ee15e0a2171027260e249400feeeee2607f88d1f029cc270402cdd1" busybox cat</span></span><br><span class="line">fa2c09bd9c042128ebb2256685ce20e265f4c06da6d9406bc357d149af7b83d2</span><br><span class="line">[root@docker scripts]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">fa2c09bd9c04        busybox             <span class="string">"cat"</span>               2 seconds ago       Up 1 second                             pedantic_goodall</span><br><span class="line">687c80243ee1        busybox             <span class="string">"sh"</span>                22 seconds ago      Up 21 seconds                           hopeful_franklin</span><br><span class="line">[root@docker scripts]<span class="comment"># docker exec -it 687c80243ee1 sh</span></span><br><span class="line">/ <span class="comment"># ps aux</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">    8 root      0:00 cat</span><br><span class="line">   15 root      0:00 sh</span><br></pre></td></tr></table></figure></p>
<p>ç„¶ååŸºäºcontainerdçš„æ–¹å¼å®ç°<code>pid ns</code>å…±äº«ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ctr -n k8s.io t ls</span><br><span class="line">  <span class="comment"># TASK         PID      STATUS</span></span><br><span class="line">  <span class="comment"># busybox      43908    RUNNING </span></span><br><span class="line">  <span class="comment"># busybox-1    48850    RUNNING  # è¿™é‡Œçš„48850å³ä¸ºå·²æœ‰taskè¿è¡Œæ—¶çš„pidå·</span></span><br><span class="line">  <span class="comment"># busybox-2    50314    RUNNING</span></span><br><span class="line"></span><br><span class="line">$ ctr -n k8s.io c create --with-ns <span class="string">"pid:/proc/48850/ns/pid"</span> v4ehxdz8.mirror.aliyuncs.com/library/python:3.6-slim python <span class="comment"># å°† å®¹å™¨ä¸­è¿è¡Œ çš„è¿›ç¨‹å…±äº«æ³¨å…¥åˆ° 48850 pidä¹‹ä¸­</span></span><br><span class="line"></span><br><span class="line">$ ctr -n k8s.io t start -d python python  <span class="comment"># å¯åŠ¨äº†ä¸€ä¸ªpythonçš„å‘½ä»¤</span></span><br><span class="line"></span><br><span class="line">$ ctr -n k8s.io t <span class="built_in">exec</span> -t --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> busybox-1 sh <span class="comment"># è‡³æ­¤å¯ä»¥åœ¨busybox-1å®¹å™¨ä¸­çœ‹è§åˆšæ‰§è¡Œçš„pythonå‘½ä»¤</span></span><br><span class="line">/ <span class="comment"># ps aux</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">   34 root      0:00 python3</span><br><span class="line">   41 root      0:00 sh</span><br><span class="line">   47 root      0:00 ps aux</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="4-Docker-ä¸-Containerd-å¹¶ç”¨é…ç½®"><a href="#4-Docker-ä¸-Containerd-å¹¶ç”¨é…ç½®" class="headerlink" title="4.Docker ä¸ Containerd å¹¶ç”¨é…ç½®"></a>4.Docker ä¸ Containerd å¹¶ç”¨é…ç½®</h3><p>æè¿°: äº‹å®ä¸Šï¼ŒDocker å’Œ Containerd æ˜¯å¯ä»¥åŒæ—¶ä½¿ç”¨çš„ï¼Œåªä¸è¿‡ Docker é»˜è®¤ä½¿ç”¨çš„ Containerd çš„å‘½åç©ºé—´ä¸æ˜¯ defaultï¼Œè€Œæ˜¯ mobyï¼Œæ­¤å¤„ä¸ºäº†æ›´æ–¹ä¾¿æˆ‘ä»¬å­¦ä¹ å¯ä»¥å°† Docker ä¸ Containerd è”åˆä½¿ç”¨ã€‚<br>Docker-CE å®‰è£…å‚è€ƒé“¾æ¥ï¼š<a href="https://docs.docker.com/engine/reference/commandline/dockerd/" target="_blank" rel="noopener">https://docs.docker.com/engine/reference/commandline/dockerd/</a></p>
<ul>
<li><p>Step 1.åœ¨å‰é¢æˆ‘ä»¬å®Œæˆ containerd çš„å®‰è£…é…ç½®å¹¶å¯åŠ¨åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®¿ä¸»æœºä¸­å®‰è£…dockerå®¢æˆ·ç«¯åŠæœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> stable"</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">apt-update</span><br><span class="line"><span class="comment"># - æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬</span></span><br><span class="line">apt-cache madison docker-ce </span><br><span class="line"><span class="comment"># - å®‰è£…æŒ‡å®šç‰ˆæœ¬ (20.10.X ç‰ˆæœ¬æ”¯æŒ Docker Scan ç‰¹æ€§)</span></span><br><span class="line">sudo apt-get install docker-ce=5:20.10.7~3-0~ubuntu-focal docker-ce-cli=5:20.10.7~3-0~ubuntu-focal</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.ç¼–è¾‘<code>/etc/systemd/system/multi-user.target.wants/docker.service</code>æ–‡ä»¶å¹¶ä¸ºå…¶æ–°å¢ <code>--containerd</code>å¦‚ä¸‹å¯åŠ¨é¡¹ï¼š<code>--containerd /run/containerd/containerd.sock</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/multi-user.target.wants/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --cri-containerd --debug </span><br><span class="line"></span><br><span class="line"><span class="comment"># - é‡æ–°åŠ è½½é…ç½®</span></span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.æ·»åŠ ä½æƒé™ç”¨æˆ·åˆ°dockerç»„é‡Œå¹¶è‡ªå¯Dockerã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl status docker</span><br><span class="line">  <span class="comment"># â— docker.service - Docker Application Container Engine</span></span><br><span class="line">  <span class="comment">#     Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)</span></span><br><span class="line">  <span class="comment">#     Active: active (running) since Mon 2021-07-05 12:47:10 CST; 5min ago</span></span><br><span class="line">  <span class="comment"># TriggeredBy: â— docker.socket</span></span><br><span class="line">  <span class="comment">#       Docs: https://docs.docker.com</span></span><br><span class="line">  <span class="comment">#   Main PID: 129606 (dockerd)</span></span><br><span class="line">  <span class="comment">#       Tasks: 12</span></span><br><span class="line">  <span class="comment">#     Memory: 45.0M</span></span><br><span class="line">  <span class="comment">#     CGroup: /system.slice/docker.service</span></span><br><span class="line">  <span class="comment">#             â””â”€129606 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…æŸ¥çœ‹ Dockerd æœåŠ¡ç«¯æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class="line">ps aux|grep docker</span><br><span class="line">  <span class="comment"># root      129606  0.0  4.4 1021016 89792 ?       Ssl  12:47   0:00 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å¢docker0ç½‘å¡ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># 7: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#   link/ether 02:42:23:41:2c:db brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#   inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span></span><br><span class="line"><span class="comment">#       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 4.æ‰“å¼€ä¸¤ä¸ªShellç»ˆç«¯ä¸€ä¸ªé‡‡ç”¨ docker è¿è¡Œä¸€ä¸ª busybox å®¹å™¨ï¼Œå¦å¤–ä¸€ä¸ªæŸ¥çœ‹å¯¹æ¯”ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -it busybox sh</span><br><span class="line">  <span class="comment"># / # ip addr</span></span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line">  <span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># 8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line">  <span class="comment">#     link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0   # å…³é”®ç‚¹</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># / # cat /etc/hosts</span></span><br><span class="line">  <span class="comment"># 127.0.0.1       localhost</span></span><br><span class="line">  <span class="comment"># 172.17.0.2      51dcdf68d3b8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡‡ç”¨ ctr åœ¨ moby åç§°ç©ºé—´ä¸‹æŸ¥çœ‹dockeråˆ›å»ºçš„å®¹å™¨ä»¥åŠTask PID</span></span><br><span class="line">$ ctr -n moby c ls</span><br><span class="line">  <span class="comment"># CONTAINER                                                           IMAGE    RUNTIME</span></span><br><span class="line">  <span class="comment"># 51dcdf68d3b8bf4c9707c9059e33f9570cb83725355595e77cf433dd3e25b64b    -        io.containerd.runc.v2</span></span><br><span class="line">$ ctr -n moby t ls</span><br><span class="line">  <span class="comment"># TASK                                                                PID       STATUS</span></span><br><span class="line">  <span class="comment"># 51dcdf68d3b8bf4c9707c9059e33f9570cb83725355595e77cf433dd3e25b64b    131926    RUNNING</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯è·å–åˆ°çš„ Task PID ä¸‹å…¶ net ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">$ grep <span class="string">"172.17.0.2"</span> /proc/131926/net/fib_trie</span><br><span class="line">  |-- 172.17.0.2</span><br><span class="line">  |-- 172.17.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡‡ç”¨ ctr è¿›å…¥ Docker åˆ›å»ºçš„å®¹å™¨</span></span><br><span class="line">$ ctr -n moby t <span class="built_in">exec</span> -t --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span>  51dcdf68d3b8bf4c9707c9059e33f9570cb83725355595e77cf433dd3e25b64b sh</span><br><span class="line">  <span class="comment"># / # ip addr | grep "172.17.0.2"</span></span><br><span class="line">  <span class="comment">#   inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span></span><br><span class="line">  <span class="comment"># / # hostname</span></span><br><span class="line">  <span class="comment">#   51dcdf68d3b8</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="5-é•œåƒåŠ é€Ÿé…ç½®"><a href="#5-é•œåƒåŠ é€Ÿé…ç½®" class="headerlink" title="5.é•œåƒåŠ é€Ÿé…ç½®"></a>5.é•œåƒåŠ é€Ÿé…ç½®</h3><p>æè¿°: é•œåƒåŠ é€Ÿçš„é…ç½®å°±åœ¨ cri æ’ä»¶é…ç½®å—ä¸‹é¢çš„ registry é…ç½®å—ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/containerd/config.toml</span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry]</span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"docker.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"https://xlx9erfu.mirror.aliyuncs.com"</span>]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"k8s.gcr.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"https://registry.aliyuncs.com/k8sxio"</span>]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"gcr.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"xxx"</span>]</span><br></pre></td></tr></table></figure></p>
<p><strong>æ’ä»¶åŠå…¶å‚æ•°è§£é‡Š:</strong></p>
<ul>
<li><code>registry.mirrors.&quot;xxx&quot;</code> : è¡¨ç¤ºéœ€è¦é…ç½® mirror çš„é•œåƒä»“åº“ã€‚ä¾‹å¦‚ï¼Œregistry.mirrors.â€docker.ioâ€ è¡¨ç¤ºé…ç½® docker.io çš„ mirrorã€‚</li>
<li><code>endpoint</code> : è¡¨ç¤ºæä¾› mirror çš„é•œåƒåŠ é€ŸæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæ¨èä½¿ç”¨è¥¿åŒ—å†œæ—ç§‘æŠ€å¤§å­¦æä¾›çš„é•œåƒåŠ é€ŸæœåŠ¡ä½œä¸º docker.io çš„ mirror, æˆ–è€…é˜¿é‡Œäº‘çš„</li>
</ul>
<hr>
<h2 id="0x03-Containerd-ä¸-Docker-CLI-å·¥å…·å‘½ä»¤è¡¨"><a href="#0x03-Containerd-ä¸-Docker-CLI-å·¥å…·å‘½ä»¤è¡¨" class="headerlink" title="0x03 Containerd ä¸ Docker CLI å·¥å…·å‘½ä»¤è¡¨"></a>0x03 Containerd ä¸ Docker CLI å·¥å…·å‘½ä»¤è¡¨</h2><p>æè¿°: Containerd å’Œ Docker åœ¨å‘½ä»¤ä½¿ç”¨ä¸Šçš„ä¸€äº›åŒºåˆ«ä¸»è¦å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">åŠŸèƒ½è¯´æ˜</th>
<th style="text-align:left">Containerd CLI</th>
<th style="text-align:left">Docker CLI</th>
<th style="text-align:left">Crictl CLI</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">é•œåƒåˆ—ä¸¾</td>
<td style="text-align:left">ctr image [ls/list]</td>
<td style="text-align:left">docker images [ls]</td>
<td style="text-align:left">crictl images [ls]</td>
</tr>
<tr>
<td style="text-align:center">å¯¼å‡ºé•œåƒ</td>
<td style="text-align:left">ctr image export app.tar weiyigeek.top/app:1.2.0</td>
<td style="text-align:left">docker save -o app.tar app:1.2.0</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">å¯¼å…¥é•œåƒ</td>
<td style="text-align:left">ctr image import app.tar</td>
<td style="text-align:left">docker load -i app.tar</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">æ‹‰å–é•œåƒ</td>
<td style="text-align:left">ctr -n k8s.io images pull docker.io/library/redis:latest</td>
<td style="text-align:left">docker pull redis:latest</td>
<td style="text-align:left">crictl pull redis:latest</td>
</tr>
<tr>
<td style="text-align:center">ä¸Šä¼ é•œåƒ</td>
<td style="text-align:left">ctr -n k8s.io images push docker.io/library/redis:latest</td>
<td style="text-align:left">docker push</td>
<td style="text-align:left">crictl  push</td>
</tr>
<tr>
<td style="text-align:center">æ›´æ”¹æ ‡è®°</td>
<td style="text-align:left">ctr -n k8s.io images tag docker.io/library/redis:latest weiyigeek.top/redis:latest</td>
<td style="text-align:left">docker tag redis:latest  weiyigeek.top/redis:latest</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">åˆ é™¤é•œåƒ</td>
<td style="text-align:left">ctr -n k8s.io images rm docker.io/library/redis:latest</td>
<td style="text-align:left">docker rmi</td>
<td style="text-align:left">crictl rmi</td>
</tr>
<tr>
<td style="text-align:center">åˆ›å»ºå®¹å™¨</td>
<td style="text-align:left">ctr -n k8s.io container create docker.io/library/redis:latest redis</td>
<td style="text-align:left">docker create</td>
<td style="text-align:left">crictl create</td>
</tr>
<tr>
<td style="text-align:center">åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨</td>
<td style="text-align:left">ctr run -d â€“env name=WeiyiGeek application weiyigeek.top/app:1.2.0</td>
<td style="text-align:left">docker run</td>
</tr>
<tr>
<td style="text-align:center">æŸ¥çœ‹å®¹å™¨</td>
<td style="text-align:left">ctr -n k8s.io container list</td>
<td style="text-align:left">docker ps</td>
<td style="text-align:left">crictl ps</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">å¯åŠ¨å®¹å™¨</td>
<td style="text-align:left">ctr -n k8s.io task start</td>
<td style="text-align:left">docker start</td>
<td style="text-align:left">crictl start</td>
</tr>
<tr>
<td style="text-align:center">åœæ­¢å®¹å™¨</td>
<td style="text-align:left">ctr -n k8s.io task pause</td>
<td style="text-align:left">docker stop</td>
<td style="text-align:left">crictl stop</td>
</tr>
<tr>
<td style="text-align:center">åˆ é™¤å®¹å™¨</td>
<td style="text-align:left">ctr -n k8s.io container rm</td>
<td style="text-align:left">docker rm</td>
<td style="text-align:left">crictl rm</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">å®¹å™¨è¯¦æƒ…</td>
<td style="text-align:left">ctr -n k8s.io c info 39d36ef08456</td>
<td style="text-align:left">docker inspect 39d36ef08456</td>
<td style="text-align:left">crictl inspect 39d36ef08456</td>
</tr>
<tr>
<td style="text-align:center">å®¹å™¨è¿æ¥</td>
<td style="text-align:left">ctr -n k8s.io task  attach</td>
<td style="text-align:left">docker attach</td>
<td style="text-align:left">crictl attach</td>
</tr>
<tr>
<td style="text-align:center">è¿›å…¥å®¹å™¨</td>
<td style="text-align:left">ctr -n k8s.io task  exec</td>
<td style="text-align:left">docker exec</td>
<td style="text-align:left">crictl exec</td>
</tr>
<tr>
<td style="text-align:center">stats(çŠ¶æ€)</td>
<td style="text-align:left">ctr -n k8s.io task metric 39d36ef08456</td>
<td style="text-align:left">docker top</td>
<td style="text-align:left">crictl stats</td>
</tr>
<tr>
<td style="text-align:center">æ—¥å¿—æŸ¥çœ‹</td>
<td style="text-align:left">ctr -n k8s.io event</td>
<td style="text-align:left">docker logs â€“tail 50  8db74c2bf7595</td>
<td style="text-align:left">crictl logs â€“tail 50 8db74c2bf7595</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="ctr-å‘½ä»¤-Containerd-ç®¡ç†å‘½ä»¤è¯¦ç»†"><a href="#ctr-å‘½ä»¤-Containerd-ç®¡ç†å‘½ä»¤è¯¦ç»†" class="headerlink" title="ctr å‘½ä»¤ - Containerd ç®¡ç†å‘½ä»¤è¯¦ç»†"></a>ctr å‘½ä»¤ - Containerd ç®¡ç†å‘½ä»¤è¯¦ç»†</h3><p>æè¿°: å®ƒæ˜¯ä¸€ä¸ªä¸å—æ”¯æŒçš„è°ƒè¯•å’Œç®¡ç†å®¢æˆ·ç«¯ï¼Œç”¨äºä¸å®¹å™¨å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œäº¤äº’ã€‚å› ä¸ºå®ƒä¸å—æ”¯æŒï¼Œæ‰€ä»¥å‘½ä»¤ã€é€‰é¡¹å’Œæ“ä½œä¸èƒ½ä¿è¯å‘åå…¼å®¹æˆ–ç¨³å®šä»é›†è£…ç®±é¡¹ç›®çš„å‘å¸ƒåˆ°å‘å¸ƒã€‚</p>
<p><strong>è¯­æ³•å‚æ•°:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#USAGE:</span></span><br><span class="line">  ctr [global options] <span class="built_in">command</span> [<span class="built_in">command</span> options] [arguments...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># GLOBAL OPTIONS:</span></span><br><span class="line">  --debug                      <span class="built_in">enable</span> debug output <span class="keyword">in</span> logs</span><br><span class="line">  --address value, -a value    address <span class="keyword">for</span> containerds GRPC server (default: <span class="string">"/run/containerd/containerd.sock"</span>) [<span class="variable">$CONTAINERD_ADDRESS</span>]</span><br><span class="line">  --timeout value              total timeout <span class="keyword">for</span> ctr commands (default: 0s)</span><br><span class="line">  --connect-timeout value      timeout <span class="keyword">for</span> connecting to containerd (default: 0s)</span><br><span class="line">  --namespace value, -n value  namespace to use with commands (default: <span class="string">"default"</span>) [<span class="variable">$CONTAINERD_NAMESPACE</span>]</span><br><span class="line">  --version, -v                <span class="built_in">print</span> the version</span><br><span class="line"></span><br><span class="line"><span class="comment"># COMMANDS:</span></span><br><span class="line">  plugins, plugin            provides information about containerd plugins</span><br><span class="line">  version                    <span class="built_in">print</span> the client and server versions</span><br><span class="line">  containers, c, container   manage containers</span><br><span class="line">  content                    manage content</span><br><span class="line">  events, event              display containerd events</span><br><span class="line">  images, image, i           manage images</span><br><span class="line">  leases                     manage leases</span><br><span class="line">  namespaces, namespace, ns  manage namespaces</span><br><span class="line">  pprof                      provide golang pprof outputs <span class="keyword">for</span> containerd</span><br><span class="line">  run                        run a container</span><br><span class="line">  snapshots, snapshot        manage snapshots</span><br><span class="line">  tasks, t, task             manage tasks</span><br><span class="line">  install                    install a new package</span><br><span class="line">  oci                        OCI tools</span><br><span class="line">  shim                       interact with a shim directly (ç›´æ¥ä¸shimäº¤äº’)</span><br><span class="line">  <span class="built_in">help</span>, h                    Shows a list of commands or <span class="built_in">help</span> <span class="keyword">for</span> one <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­å‘½ä»¤ #</span></span><br><span class="line"><span class="comment"># Images COMMANDS:</span></span><br><span class="line">  check       check that an image has all content available locally(æ‰¾åˆ°å‘ç”Ÿæ•…éšœçš„å®¹å™¨åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æ£€æŸ¥å…¶æ—¥å¿—)</span><br><span class="line">  <span class="built_in">export</span>      <span class="built_in">export</span> images</span><br><span class="line">  import      import images</span><br><span class="line">  list, ls    list images known to containerd</span><br><span class="line">  mount       mount an image to a target path</span><br><span class="line">  unmount     unmount the image from the target</span><br><span class="line">  pull        pull an image from a remote</span><br><span class="line">  push        push an image to a remote</span><br><span class="line">  remove, rm  remove one or more images by reference</span><br><span class="line">  tag         tag an image</span><br><span class="line">  label       <span class="built_in">set</span> and clear labels <span class="keyword">for</span> an image</span><br><span class="line"></span><br><span class="line"><span class="comment"># Container COMMANDS:</span></span><br><span class="line">  create           create container</span><br><span class="line">  delete, del, rm  delete one or more existing containers</span><br><span class="line">  info             get info about a container</span><br><span class="line">  list, ls         list containers</span><br><span class="line">  label            <span class="built_in">set</span> and clear labels <span class="keyword">for</span> a container</span><br><span class="line">  checkpoint       checkpoint a container (æ£€æŸ¥ç‚¹å®¹å™¨)</span><br><span class="line">  restore          restore a container from checkpoint(ä»æ£€æŸ¥ç‚¹è¿˜åŸå®¹å™¨)</span><br><span class="line"></span><br><span class="line"><span class="comment"># run OPTIONS:</span></span><br><span class="line">  --rm                                    remove the container after running</span><br><span class="line">  --null-io                               send all IO to /dev/null (å°†å®¹å™¨å†…æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°/dev/null)</span><br><span class="line">  --<span class="built_in">log</span>-uri value                         <span class="built_in">log</span> uri</span><br><span class="line">  --detach, -d                            detach from the task after it has started execution(åœ¨ä»»åŠ¡å¼€å§‹æ‰§è¡Œåä»ä¸­åˆ†ç¦»,å¦‚æ²¡æœ‰é€‰é¡¹åˆ™ä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥å¹¶å®šå‘åˆ°å®¹å™¨å†…)</span><br><span class="line">  --fifo-dir value                        directory used <span class="keyword">for</span> storing IO FIFOs</span><br><span class="line">  --cgroup value                          cgroup path (To <span class="built_in">disable</span> use of cgroup, <span class="built_in">set</span> to <span class="string">""</span> explicitly)</span><br><span class="line">  --platform value                        run image <span class="keyword">for</span> specific platform</span><br><span class="line">  --runc-binary value                     specify runc-compatible binary</span><br><span class="line">  --runc-systemd-cgroup                   start runc with systemd cgroup manager</span><br><span class="line">  --uidmap container-uid:host-uid:length  run inside a user namespace with the specified UID mapping range; specified with the format container-uid:host-uid:length</span><br><span class="line">  --gidmap container-gid:host-gid:length  run inside a user namespace with the specified GID mapping range; specified with the format container-gid:host-gid:length</span><br><span class="line">  --remap-labels                          provide the user namespace ID remapping to the snapshotter via label options; requires snapshotter support</span><br><span class="line">  --cpus value                            <span class="built_in">set</span> the CFS cpu qouta (default: 0)</span><br><span class="line">  --snapshotter value                     snapshotter name. Empty value stands <span class="keyword">for</span> the default value. [<span class="variable">$CONTAINERD_SNAPSHOTTER</span>]</span><br><span class="line">  --config value, -c value                path to the runtime-specific spec config file</span><br><span class="line">  --cwd value                             specify the working directory of the process</span><br><span class="line">  --env value                             specify additional container environment variables (i.e. FOO=bar)</span><br><span class="line">  --env-file value                        specify additional container environment variables <span class="keyword">in</span> a file(i.e. FOO=bar, one per line)</span><br><span class="line">  --label value                           specify additional labels (i.e. foo=bar)</span><br><span class="line">  --mount value                           specify additional container mount (ex: <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/tmp,dst=/host,options=rbind:ro)</span><br><span class="line">  --net-host                              <span class="built_in">enable</span> host networking <span class="keyword">for</span> the container</span><br><span class="line">  --privileged                            run privileged container</span><br><span class="line">  --<span class="built_in">read</span>-only                             <span class="built_in">set</span> the containers filesystem as <span class="built_in">readonly</span></span><br><span class="line">  --runtime value                         runtime name (default: <span class="string">"io.containerd.runc.v2"</span>)</span><br><span class="line">  --tty, -t                               allocate a TTY <span class="keyword">for</span> the container</span><br><span class="line">  --with-ns value                         specify existing Linux namespaces to join at container runtime (format <span class="string">'&lt;nstype&gt;:&lt;path&gt;'</span>)</span><br><span class="line">  --pid-file value                        file path to write the task<span class="string">'s pid</span></span><br><span class="line"><span class="string">  --gpus value                            add gpus to the container (default: 0)</span></span><br><span class="line"><span class="string">  --allow-new-privs                       turn off OCI spec'</span>s NoNewPrivileges feature flag</span><br><span class="line">  --memory-limit value                    memory <span class="built_in">limit</span> (<span class="keyword">in</span> bytes) <span class="keyword">for</span> the container (default: 0)</span><br><span class="line">  --device value                          add a device to a container</span><br><span class="line">  --seccomp                               <span class="built_in">enable</span> the default seccomp profile</span><br><span class="line">  --rootfs                                use custom rootfs that is not managed by containerd snapshotter</span><br><span class="line">  --no-pivot                              <span class="built_in">disable</span> use of pivot-root (linux only)</span><br><span class="line">  --cpu-quota value                       Limit CPU CFS quota (default: -1)</span><br><span class="line">  --cpu-period value                      Limit CPU CFS period (default: 0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tasks COMMANDS:</span></span><br><span class="line">  attach           attach to the IO of a running container</span><br><span class="line">  checkpoint       checkpoint a container</span><br><span class="line">  delete, rm       delete one or more tasks</span><br><span class="line">  <span class="built_in">exec</span>             execute additional processes <span class="keyword">in</span> an existing container</span><br><span class="line">  list, ls         list tasks</span><br><span class="line">  <span class="built_in">kill</span>             signal a container (default: SIGTERM)</span><br><span class="line">  pause            pause an existing container</span><br><span class="line">  ps               list processes <span class="keyword">for</span> container</span><br><span class="line">  resume           resume a paused container</span><br><span class="line">  start            start a container that has been created</span><br><span class="line">  metrics, metric  get a single data point of metrics <span class="keyword">for</span> a task with the built-in Linux runtime</span><br></pre></td></tr></table></figure></p>
<p>Tips : containerd å¼•å…¥äº† namespace æ¦‚å¿µ, æ¯ä¸ªimageå’Œcontaineréƒ½ä¼šåœ¨å„è‡ªçš„namespaceä¸‹å¯è§, ç›®å‰k8sä¼šä½¿ç”¨ k8s.io ä»¥åŠ default ä½œä¸ºå‘½åç©ºé—´ã€‚<br>Tips : å½“å¯¼å…¥æœ¬åœ°é•œåƒæ—¶cträ¸æ”¯æŒå‹ç¼©ã€‚<br>Tips : é€šè¿‡<code>ctr containers create</code>åˆ›å»ºå®¹å™¨åï¼Œåªæ˜¯ä¸€ä¸ªé™æ€çš„å®¹å™¨ï¼Œå®¹å™¨ä¸­çš„ç”¨æˆ·è¿›ç¨‹å¹¶æ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦é€šè¿‡<code>ctr task start</code>æ¥å¯åŠ¨å®¹å™¨è¿›ç¨‹ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥ç”¨<code>ctr run</code>çš„å‘½ä»¤ç›´æ¥åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ã€‚åœ¨è¿›å…¥å®¹å™¨æ“ä½œæ—¶ä¸dockerä¸åŒçš„æ˜¯ï¼Œå¿…é¡»åœ¨<code>ctr task exec</code>å‘½ä»¤åæŒ‡å®š<code>--exec-id</code>å‚æ•°ï¼Œè¿™ä¸ªidå¯ä»¥éšä¾¿å†™åªè¦å”¯ä¸€å°±è¡Œã€‚<br>Tips : ctræ²¡æœ‰stopå®¹å™¨çš„åŠŸèƒ½ï¼Œåªèƒ½æš‚åœï¼ˆctr task pauseï¼‰æˆ–è€…æ€æ­»ï¼ˆctr task killï¼‰å®¹å™¨</p>
<p><br/></p>
<p><strong>å®é™…æ¡ˆä¾‹:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) åç§°ç©ºé—´æŸ¥çœ‹åˆ›å»ºæˆ–åˆ é™¤</span></span><br><span class="line">ctr namespace create devops</span><br><span class="line">ctr namespace ls -q</span><br><span class="line">  <span class="comment"># devops</span></span><br><span class="line">  <span class="comment"># k8s.io</span></span><br><span class="line">ctr namespace remove devops</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) é•œåƒæŸ¥çœ‹åŠå…¶æ“ä½œ</span></span><br><span class="line">ctr -n k8s.io images ls | grep <span class="string">"busybox"</span></span><br><span class="line">  <span class="comment"># docker.io/library/busybox:1.33.1 application/vnd.docker.distribution.manifest.list.v2+json sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d 752.6 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x io.cri-containerd.image=managed</span></span><br><span class="line">ctr -n k8s.io images ls -q | grep <span class="string">"busybox"</span>   <span class="comment"># docker.io/library/busybox:1.33.1</span></span><br><span class="line">ctr -n k8s.io i rm k8s.gcr.io/pause:3.2       <span class="comment"># åˆ é™¤é•œåƒ</span></span><br><span class="line">ctr -n k8s.io i pull -k k8s.gcr.io/pause:3.2  <span class="comment"># æ‹‰å–é•œåƒ </span></span><br><span class="line">ctr -n k8s.io i push -k k8s.gcr.io/pause:3.2  <span class="comment"># æ¨é€é•œåƒ</span></span><br><span class="line">ctr -n k8s.io i <span class="built_in">export</span> pause.tar k8s.gcr.io/pause:3.2 <span class="comment"># å¯¼å‡ºé•œåƒ</span></span><br><span class="line">ctr -n k8s.io i import pause.tar              <span class="comment"># å¯¼å…¥é•œåƒ    </span></span><br><span class="line">ctr -n k8s.io images check  | grep <span class="string">"busybox"</span>  <span class="comment"># é•œåƒæ£€æŸ¥</span></span><br><span class="line">  <span class="comment"># docker.io/library/busybox:1.33.1  application/vnd.docker.distribution.manifest.list.v2+json sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d complete (2/2) 750.1 KiB/750.1 KiB true</span></span><br><span class="line">ctr -n k8s.io i tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2 k8s.gcr.io/pause:3.2         <span class="comment"># é•œåƒæ ‡è®° Tag æ›´æ”¹</span></span><br><span class="line">ctr -n k8s.io i tag --force registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2 k8s.gcr.io/pause:3.2 <span class="comment"># è‹¥æ–°é•œåƒ reference å·²å­˜åœ¨éœ€è¦å…ˆåˆ é™¤æ–° reference æˆ–è€…å¦‚ä¸‹æ–¹å¼å¼ºåˆ¶æ›¿æ¢</span></span><br><span class="line">ctr -n k8s.io i label docker.io/library/busybox:1.33.1 name=weiyigeek-test  <span class="comment"># è®¾ç½®é•œåƒæ ‡ç­¾</span></span><br><span class="line">  <span class="comment"># io.cri-containerd.image=managed,name=weiyigeek-test</span></span><br><span class="line">ctr -n k8s.io i label docker.io/library/busybox:1.33.1 name=<span class="string">""</span>              <span class="comment"># æ¸…é™¤é•œåƒæ ‡ç­¾</span></span><br><span class="line">  <span class="comment"># io.cri-containerd.image=managed</span></span><br><span class="line">ctr i mount docker.io/library/nginx:alpine /mnt <span class="comment"># é•œåƒæŒ‚è½½åˆ°ä¸»æœºç›®å½• /mnt ä¸­</span></span><br><span class="line">ctr i unmount /mnt <span class="comment"># å°†é•œåƒä»ä¸»æœºç›®å½•ä¸Šå¸è½½</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) é•œåƒå†…å®¹ç¼–è¾‘,å¯¹é•œåƒçš„æ›´é«˜çº§æ“ä½œå¯ä»¥ä½¿ç”¨å­å‘½ä»¤ content.</span></span><br><span class="line"><span class="comment"># åœ¨çº¿ç¼–è¾‘é•œåƒçš„ blob å¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ digest</span></span><br><span class="line">â†’ ctr content ls</span><br><span class="line">â†’ ctr content edit --editor vim sha256:fdd7fff110870339d34cf071ee90fbbe12bdbf3d1d9a14156995dfbdeccd7923</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) å®¹å™¨æŸ¥çœ‹åŠå…¶æ“ä½œ</span></span><br><span class="line">ctr -n k8s.io container ls</span><br><span class="line">  <span class="comment"># CONTAINER                                                           IMAGE                                                            RUNTIME</span></span><br><span class="line">  <span class="comment"># 3d840c5cf157c322c1c0839d0166d80550fe49ca53544e1d589bd44f422b1f81    registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2    io.containerd.runc.v2</span></span><br><span class="line">ctr -n k8s.io container create docker.io/library/busybox:latest busybox                       <span class="comment"># åˆ›å»ºå®¹å™¨(å¹¶æ²¡æœ‰å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œåªæ˜¯ä¸€ä¸ªé™æ€çš„å®¹å™¨)</span></span><br><span class="line">ctr -n k8s.io container info 39d36ef08456bed24a52bf1c845facbd9f93c35cbd65b16739b4746ab1811cb5 <span class="comment"># æŸ¥çœ‹åˆ›å»ºçš„å®¹å™¨è¯¦æƒ…ï¼ˆæ³¨æ„è¿™ä¸ªå¿…é¡»æ˜¯å®Œæ•´çš„å®¹å™¨IDï¼‰å’Œ docker inspect ç±»ä¼¼</span></span><br><span class="line">ctr -n k8s.io container rm 39d36ef08456bed24a52bf1c845facbd9f93c35cbd65b16739b4746ab1811cb5   <span class="comment"># åˆ é™¤å®¹å™¨</span></span><br><span class="line">ctr -n k8s.io container label busybox name=weiyigeek-test     <span class="comment"># è®¾ç½®å®¹å™¨æ ‡ç­¾</span></span><br><span class="line">  <span class="comment"># io.containerd.image.config.stop-signal=SIGTERM,name=weiyigeek-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5) å®¹å™¨çœŸæ­£è¿è¡Œæ˜¯ç”±ä»»åŠ¡(Task)ç›¸å…³æ“ä½œå®ç°</span></span><br><span class="line">ctr -n k8s.io task start -d nginx  <span class="comment"># å¯åŠ¨å®¹å™¨</span></span><br><span class="line">ctr -n k8s.io tasks ls</span><br><span class="line">  <span class="comment"># TASK     PID      STATUS</span></span><br><span class="line">  <span class="comment"># nginx    12708    RUNNING</span></span><br><span class="line">ctr -n k8s.io task pause nginx     <span class="comment"># æš‚åœå®¹å™¨</span></span><br><span class="line">ctr -n k8s.io task resume nginx    <span class="comment"># æ¢å¤å®¹å™¨</span></span><br><span class="line">ctr -n k8s.io task ps nginx        <span class="comment"># æŸ¥çœ‹å®¹å™¨ä¸­æ‰€æœ‰è¿›ç¨‹çš„ PID (å®¿ä¸»æœºä¸­çš„PID)</span></span><br><span class="line">ctr -n k8s.io task <span class="built_in">exec</span> --<span class="built_in">exec</span>-id 0 -t nginx sh <span class="comment"># è¿›å…¥å®¹å™¨,å¿…é¡»è¦æŒ‡å®šå”¯ä¸€çš„--exec-idã€‚</span></span><br><span class="line">ctr -n k8s.io tasks <span class="built_in">kill</span> -a -s 9 &#123;id&#125;  <span class="comment"># åœæ­¢å®¹å™¨å†…çš„Task</span></span><br><span class="line">ctr -n k8s.io task metric 37d0ff9d8df20d34c652ee286c17e0626d8838d6d546a28e8246151fffd99b98 <span class="comment"># è·å–å®¹å™¨çš„ cgroup ä¿¡æ¯ï¼Œç”¨äºè·å–å®¹å™¨çš„å†…å­˜ã€CPU å’Œ PID çš„é™é¢ä¸ä½¿ç”¨é‡ã€‚</span></span><br><span class="line">  <span class="comment"># ID                                                                  TIMESTAMP</span></span><br><span class="line">  <span class="comment"># 37d0ff9d8df20d34c652ee286c17e0626d8838d6d546a28e8246151fffd99b98    2021-07-11 03:33:18.421996083 +0000 UTC</span></span><br><span class="line">  <span class="comment"># METRIC                   VALUE </span></span><br><span class="line">  <span class="comment"># memory.usage_in_bytes    65269760            </span></span><br><span class="line">  <span class="comment"># memory.limit_in_byte     9223372036854771712 </span></span><br><span class="line">  <span class="comment"># memory.stat.cache        4157440 </span></span><br><span class="line">  <span class="comment"># cpuacct.usage            44769155237                                                                                              </span></span><br><span class="line">  <span class="comment"># cpuacct.usage_percpu     [22375115908 22394039329 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</span></span><br><span class="line">  <span class="comment"># pids.current             43          </span></span><br><span class="line">  <span class="comment"># pids.limit               4582    </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6) ä¸€æ­¥åˆ°ä½,ç›´æ¥è¿›è¡Œå®¹å™¨åˆ›å»ºå¹¶è¿è¡Œã€‚</span></span><br><span class="line">ctr -n k8s.io run --null-io --net-host -d</span><br><span class="line">â€“env PASSWORD=<span class="variable">$drone_password</span></span><br><span class="line">â€“mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/etc,dst=/host-etc,options=rbind:rw</span><br><span class="line">â€“mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/root/.kube,dst=/root/.kube,options=rbind:rw</span><br><span class="line">-<span class="built_in">log</span>-uri file:///var/<span class="built_in">log</span>/xx.log</span><br><span class="line">WeiyiGeek:Test sysreport bash /sysreport/run.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7) æ¯ä¸€ä¸ªé¡¶çº§é…ç½®å—çš„å‘½åéƒ½æ˜¯ plugins."io.containerd.xxx.vx.xxx" è¿™ç§å½¢å¼ï¼Œå…¶å®æ¯ä¸€ä¸ªé¡¶çº§é…ç½®å—éƒ½ä»£è¡¨ä¸€ä¸ªæ’ä»¶ï¼Œå…¶ä¸­ io.containerd.xxx.vx è¡¨ç¤ºæ’ä»¶çš„ç±»å‹ï¼Œvx åé¢çš„ xxx è¡¨ç¤ºæ’ä»¶çš„ IDã€‚</span></span><br><span class="line">ctr plugin ls</span><br><span class="line">  <span class="comment"># TYPE                            ID                    PLATFORMS      STATUS</span></span><br><span class="line">  <span class="comment"># io.containerd.content.v1        content               -              ok</span></span><br><span class="line">  <span class="comment"># io.containerd.snapshotter.v1    btrfs                 linux/amd64    error</span></span><br><span class="line">  <span class="comment"># io.containerd.snapshotter.v1    devmapper             linux/amd64    error</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8) å®¹å™¨è¿è¡Œè¡¥å……</span></span><br><span class="line">ctr run --null-io --net-host  -d --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/home/registry,dst=/var/lib/registry,options=rbind:rw  --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/home/registry/certs,dst=/certs,options=rbind:rw --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/home/registry/config.yml,dst=/etc/docker/registry/config.yml,options=rbind:rw  docker.io/library/registry:latest  registry-v2</span><br><span class="line"></span><br><span class="line">ctr -n default run --rm --net-host --env DOCKERHUB=docker.io \</span><br><span class="line">--mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/storage/dev/soft/kaniko/config,dst=/kaniko/.docker,options=rbind:ro \</span><br><span class="line">--mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/storage/dev/soft/kaniko/demo1,dst=/workspace,options=rbind:rw \</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/weiyigeek/kaniko-executor:latest kaniko-executor \</span><br><span class="line">/kaniko/executor --dockerfile=/workspace/dockerfile --context=dir://workspace --destination=docker.io/weiyigeek/busybox:1.35.0</span><br></pre></td></tr></table></figure></p>
<p>Tips: æ³¨æ„å®¹å™¨é»˜è®¤ä½¿ç”¨fifoåˆ›å»ºæ—¥å¿—æ–‡ä»¶, æœ‰å¯èƒ½å› ä¸ºfifoå®¹é‡å¯¼è‡´ä¸šåŠ¡è¿è¡Œé˜»å¡ã€‚<br>Tips: æ³¨æ„éœ€è¦åœæ­¢å®¹å™¨æ—¶éœ€è¦å…ˆåœæ­¢å®¹å™¨å†…çš„Taskå†åˆ é™¤å®¹å™¨ã€‚<br>Tips: æ³¨æ„ctræ²¡æœ‰stopå®¹å™¨çš„åŠŸèƒ½ï¼Œåªèƒ½æš‚åœæˆ–è€…æ€æ­»å®¹å™¨ã€‚<br>Tips: <code>Container åˆ›å»ºé˜¶æ®µ</code>: ä¸€ä¸ª container å¯¹è±¡åªæ˜¯åŒ…å«äº†è¿è¡Œä¸€ä¸ªå®¹å™¨æ‰€éœ€çš„èµ„æºåŠé…ç½®çš„æ•°æ®ç»“æ„ï¼Œæ„å‘³ç€ namespacesã€rootfs å’Œå®¹å™¨çš„é…ç½®éƒ½å·²ç»åˆå§‹åŒ–æˆåŠŸäº†ï¼Œåªæ˜¯ç”¨æˆ·è¿›ç¨‹(è¿™é‡Œæ˜¯nginx)è¿˜æ²¡æœ‰å¯åŠ¨ã€‚<br>Tips: <code>Container è¿è¡Œé˜¶æ®µ</code>: ä¸€ä¸ªå®¹å™¨çœŸæ­£çš„è¿è¡Œèµ·æ¥æ˜¯ç”± Task å¯¹è±¡å®ç°çš„ï¼Œtask ä»£è¡¨ä»»åŠ¡çš„æ„æ€ï¼Œå¯ä»¥ä¸ºå®¹å™¨è®¾ç½®ç½‘å¡ï¼Œè¿˜å¯ä»¥é…ç½®å·¥å…·æ¥å¯¹å®¹å™¨è¿›è¡Œç›‘æ§ç­‰ã€‚</p>
<p><br></p>
<h3 id="crictl-å‘½ä»¤-Kubernetes-ç®¡ç†å‘½ä»¤è¯¦è§£"><a href="#crictl-å‘½ä»¤-Kubernetes-ç®¡ç†å‘½ä»¤è¯¦è§£" class="headerlink" title="crictl å‘½ä»¤ - Kubernetes ç®¡ç†å‘½ä»¤è¯¦è§£"></a>crictl å‘½ä»¤ - Kubernetes ç®¡ç†å‘½ä»¤è¯¦è§£</h3><p>æè¿°ï¼šcrictl æ˜¯ CRI å…¼å®¹çš„å®¹å™¨è¿è¡Œæ—¶å‘½ä»¤è¡Œå¯¹æ¥å®¢æˆ·ç«¯, ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥æ£€æŸ¥å’Œè°ƒè¯• Kubernetes èŠ‚ç‚¹ä¸Šçš„å®¹å™¨è¿è¡Œæ—¶å’Œåº”ç”¨ç¨‹åºã€‚ç”±äºè¯¥å‘½ä»¤æ˜¯ä¸ºk8sé€šè¿‡CRIä½¿ç”¨containerdè€Œå¼€å‘çš„(<code>ä¸»è¦æ˜¯è°ƒè¯•å·¥å…·</code>), å…¶ä»–ék8sçš„åˆ›å»ºçš„ crictl æ˜¯æ— æ³•çœ‹åˆ°å’Œè°ƒè¯•çš„, ç®€å•çš„è¯´ç”¨ <code>ctr run</code> è¿è¡Œçš„å®¹å™¨æ— æ³•ä½¿ç”¨ crictl çœ‹åˆ°ã€‚</p>
<p>Tips: crictl å‘½ä»¤å·¥å…· å’Œ å®ƒçš„æºä»£ç åœ¨ <a href="https://github.com/kubernetes-sigs/cri-tools" target="_blank" rel="noopener">cri-tools ä»£ç åº“</a>ã€‚<br>Tips: crictl é»˜è®¤ä½¿ç”¨å‘½åç©ºé—´ k8s.io.<br>Tips: cri pluginåŒºåˆ«å¯¹å¾…podå’Œcontainer</p>
<p>å®˜æ–¹å‚è€ƒ: <a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md</a></p>
<p><br></p>
<p><strong>åŸºç¡€é…ç½®</strong><br>æè¿°: åœ¨ k8s 1.19.x ä¹‹å‰ crictl é»˜è®¤è¿æ¥åˆ° <code>unix:///var/run/dockershim.sock</code>ï¼Œè€Œåœ¨1.20.xèµ·é»˜è®¤é‡‡ç”¨ <code>/run/containerd/containerd.sock</code> è¿è¡Œæ—¶,å½“ç„¶é™¤æ­¤ä¹‹å¤–è¿˜æ˜¯æ”¯æŒcri-oè¿è¡Œæ—¶ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crictl by default connects on Unix to:</span></span><br><span class="line">unix:///var/run/dockershim.sock or</span><br><span class="line">unix:///run/containerd/containerd.sock or</span><br><span class="line">unix:///run/crio/crio.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># or on Windows to:</span></span><br><span class="line">npipe:////./pipe/dockershim or</span><br><span class="line">npipe:////./pipe/containerd or</span><br><span class="line">npipe:////./pipe/crio</span><br><span class="line"></span><br><span class="line"><span class="comment"># For other runtimes, use:</span></span><br><span class="line">frakti: unix:///var/run/frakti.sock</span><br></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹æˆ–ç¼–è¾‘ /etc/crictl.yaml çš„å†…å®¹å¹¶è®¾ç½®æŒ‡å®šçš„å®¹å™¨è¿è¡Œæ—¶runtimeã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/crictl.yaml</span><br><span class="line">runtime-endpoint: <span class="string">"unix:///run/containerd/containerd.sock"</span></span><br><span class="line">image-endpoint: <span class="string">"unix:///run/containerd/containerd.sock"</span></span><br><span class="line">timeout: 0</span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line">pull-image-on-create: <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>Tips: é™¤äº†ä¸Šé¢çš„è®¾ç½®ç«¯ç‚¹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨å…¶å®ƒæ–¹å¼è¿›è¡Œä¸´æ—¶è®¾ç½®æˆ–è€…æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ç«¯ç‚¹å¹¶é€šè¿‡ --config å‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶</span></span><br><span class="line">crictl --config=/etc/crictl-demo.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.é€šè¿‡è®¾ç½®å‚æ•° --runtime-endpoint å’Œ --image-endpoint</span></span><br><span class="line">crictl --runtime-endpoint=<span class="string">"unix:///run/containerd/containerd.sock"</span> --image-endpoint=<span class="string">"unix:///run/containerd/containerd.sock"</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>åŸºç¡€è¯­æ³•:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># USAGE:</span></span><br><span class="line">  crictl [global options] <span class="built_in">command</span> [<span class="built_in">command</span> options] [arguments...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># COMMANDS:</span></span><br><span class="line">  attach        Attach to a running container</span><br><span class="line">  create        Create a new container (åˆ›å»ºå®¹å™¨è¿™é‡Œéœ€è¦å…ˆåˆ›å»º sandbox, è·å–sandboxå®¹å™¨çš„idåå†ç”¨æ­¤idåˆ›å»ºä¸šåŠ¡å®¹å™¨)</span><br><span class="line">  <span class="built_in">exec</span>          Run a <span class="built_in">command</span> <span class="keyword">in</span> a running container</span><br><span class="line">  version       Display runtime version information</span><br><span class="line">  images        List images</span><br><span class="line">  inspect       Display the status of one or more containers (æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„çŠ¶æ€)</span><br><span class="line">  inspecti      Return the status of one or more images (è¿”å›ä¸€ä¸ªæˆ–è€…å¤šä¸ªé•œåƒçš„çŠ¶æ€)</span><br><span class="line">  inspectp      Display the status of one or more pods (è¿”å›ä¸€ä¸ªæˆ–è€…å¤šä¸ªPodçš„çŠ¶æ€)</span><br><span class="line">  imagefsinfo: Return image filesystem info</span><br><span class="line">  logs          Fetch the logs of a container</span><br><span class="line">  port-forward  Forward <span class="built_in">local</span> port to a pod</span><br><span class="line">  ps            List containers (åˆ—å‡ºåœ¨ k8s.io å‘½åç©ºé—´ä¸‹çš„ä¸šåŠ¡å®¹å™¨)</span><br><span class="line">  pull          Pull an image from a registry</span><br><span class="line">  runp          Run a new pod</span><br><span class="line">  rm            Remove one or more containers</span><br><span class="line">  rmi           Remove one or more images</span><br><span class="line">  rmp           Remove one or more pods</span><br><span class="line">  pods          List pods (åˆ—å‡ºåœ¨ k8s.io å‘½åç©ºé—´ä¸‹çš„ sandbox å®¹å™¨, åœ¨k8sé‡Œé€šå¸¸æ˜¯pauseå®¹å™¨)</span><br><span class="line">  start         Start one or more created containers</span><br><span class="line">  info          Display information of the container runtime</span><br><span class="line">  stop          Stop one or more running containers</span><br><span class="line">  stopp         Stop one or more running pods</span><br><span class="line">  update        Update one or more running containers</span><br><span class="line">  config        Get and <span class="built_in">set</span> crictl options</span><br><span class="line">  stats         List container(s) resource usage statistics</span><br><span class="line">  completion    Output bash shell completion code</span><br><span class="line">  <span class="built_in">help</span>, h       Shows a list of commands or <span class="built_in">help</span> <span class="keyword">for</span> one <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GLOBAL OPTIONS:</span></span><br><span class="line">  --config value, -c value            Location of the client config file (default: <span class="string">"/etc/crictl.yaml"</span>) [<span class="variable">$CRI_CONFIG_FILE</span>]</span><br><span class="line">  --debug, -D                         Enable debug mode</span><br><span class="line">  --image-endpoint value, -i value    Endpoint of CRI image manager service [<span class="variable">$IMAGE_SERVICE_ENDPOINT</span>]</span><br><span class="line">  --runtime-endpoint value, -r value  Endpoint of CRI container runtime service (default: <span class="string">"unix:///var/run/dockershim.sock"</span>) [<span class="variable">$CONTAINER_RUNTIME_ENDPOINT</span>]</span><br><span class="line">  --timeout value, -t value           Timeout of connecting to the server (default: 10s)</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>å®è·µæ¡ˆä¾‹:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0) é•œåƒæŸ¥çœ‹åŠå…¶æ“ä½œ</span></span><br><span class="line">crictl images --digests</span><br><span class="line">  <span class="comment"># IMAGE                                                                         TAG                 DIGEST              IMAGE ID            SIZE</span></span><br><span class="line">  <span class="comment"># docker.io/calico/cni                                                          v3.18.4             278fd825d089e       021ecb3cb5348       44.7MB</span></span><br><span class="line">crictl images nginx   <span class="comment"># - æ‰“å°æŸä¸ªé•œåƒ</span></span><br><span class="line">crictl images -q      <span class="comment"># - åªæ‰“å°é•œåƒID</span></span><br><span class="line">  <span class="comment"># sha256:8c811b4aec35f259572d0f79207bc0678df4c736eeec50bc9fec37ed936a472a</span></span><br><span class="line">crictl images -o [json|yaml|table]   <span class="comment"># - é•œåƒè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">crictl inspecti busybox              <span class="comment"># - æŸ¥çœ‹é•œåƒä¿¡æ¯</span></span><br><span class="line">crictl pull busybox                  <span class="comment"># - æ‹‰å– busybox é•œåƒ</span></span><br><span class="line">crictl push weiyigeek.top/busybox    <span class="comment"># - æ¨é€ busybox é•œåƒ</span></span><br><span class="line">crictl rmi docker.io/library/busybox <span class="comment"># - å®¹å™¨åˆ é™¤</span></span><br><span class="line">  <span class="comment"># Deleted: docker.io/library/busybox:1.33.1</span></span><br><span class="line">  <span class="comment"># Deleted: docker.io/library/busybox:latest</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) å®¹å™¨æŸ¥çœ‹åŠå…¶æ“ä½œ</span></span><br><span class="line">crictl ps -a  <span class="comment"># - æ‰“å°åœ¨ k8s.io å‘½åç©ºé—´ä¸‹çš„ä¸šåŠ¡å®¹å™¨</span></span><br><span class="line">crictl --runtime-endpoint /run/containerd/containerd.sock ps -a | grep kube | grep -v pause <span class="comment"># - æŸ¥çœ‹è¿‡æ»¤æŒ‡å®šçš„å®¹å™¨ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">  <span class="comment"># CONTAINER ID        IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID</span></span><br><span class="line">  <span class="comment"># 8db74c2bf7595       ebc659140e762       3 days ago          Running             calico-node               0                   5af3d484b32c0</span></span><br><span class="line">crictl create f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f[åˆ›å»ºçš„ Pod çš„ ID] container-config.json pod-config.json <span class="comment"># - åˆ›å»ºå®¹å™¨</span></span><br><span class="line">crictl start 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60  <span class="comment"># - å¯åŠ¨å®¹å™¨</span></span><br><span class="line">crictl stop 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60   <span class="comment"># - åˆ é™¤å®¹å™¨</span></span><br><span class="line">crictl <span class="built_in">exec</span> -i -t 1f73f2d81bf98 ls <span class="comment"># - å®¹å™¨ä¸Šæ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) PodæŸ¥çœ‹ä¸æ“ä½œ</span></span><br><span class="line">$ crictl pods</span><br><span class="line">  <span class="comment"># POD ID              CREATED             STATE               NAME                                   NAMESPACE           ATTEMPT</span></span><br><span class="line">  <span class="comment"># 5af3d484b32c0       4 days ago          Ready               calico-node-zvst7                      kube-system         0</span></span><br><span class="line">$ crictl pods --name nginx-65899c769f-wv2gp  <span class="comment"># - æ‰“å°æŸä¸ªå›ºå®špod.</span></span><br><span class="line">$ crictl pods --label run=nginx              <span class="comment"># - æ ¹æ®æ ‡ç­¾ç­›é€‰pod.</span></span><br><span class="line">$ crictl runp pod-config.json                <span class="comment"># - ä½¿ç”¨ crictl runp å‘½ä»¤åº”ç”¨ JSON æ–‡ä»¶å¹¶è¿è¡Œæ²™ç›’ã€‚</span></span><br><span class="line">$ crictl inspectp --output table <span class="variable">$POD_ID</span>     <span class="comment"># - ç”¨crictlæŸ¥çœ‹podçš„ä¿¡æ¯</span></span><br><span class="line">$ crictl stopp <span class="variable">$POD_ID</span>  <span class="comment"># - åœæ­¢Pod</span></span><br><span class="line">$ crictl rmp  <span class="variable">$POD_ID</span>   <span class="comment"># - åˆ é™¤Pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) æ—¥å¿—æŸ¥çœ‹</span></span><br><span class="line">crictl --runtime-endpoint /run/containerd/containerd.sock logs --tail 50 8db74c2bf7595</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) å®¹å™¨å ç”¨èµ„æºçŠ¶æ€æŸ¥çœ‹</span></span><br><span class="line">crictl stats</span><br><span class="line">  <span class="comment"># CONTAINER           CPU %               MEM                 DISK                INODES</span></span><br><span class="line">  <span class="comment"># 8db74c2bf7595       0.69                53.37MB             274.4kB             81</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5) é¢å¤–ä¿¡æ¯æ˜¾ç¤ºï¼Œä¾‹å¦‚ç‰ˆæœ¬åŠå…¶æ˜¾ç¤ºæœ‰å…³ Containerd å’Œ CRI æ’ä»¶çš„çŠ¶æ€å’Œé…ç½®ä¿¡æ¯</span></span><br><span class="line">crictl version</span><br><span class="line">  <span class="comment"># Version:  0.1.0</span></span><br><span class="line">  <span class="comment"># RuntimeName:  containerd</span></span><br><span class="line">  <span class="comment"># RuntimeVersion:  1.5.11</span></span><br><span class="line">  <span class="comment"># RuntimeApiVersion:  v1alpha2</span></span><br><span class="line">crictl info -o go-template --template <span class="string">"&#123;&#123;index .status&#125;&#125;"</span>  <span class="comment"># æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class="line">  <span class="comment"># map[conditions:[map[message: reason: status:true type:RuntimeReady] map[message: reason: status:true type:NetworkReady]]]</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : <code>crictl pods</code> åˆ—å‡ºçš„æ˜¯podçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬podæ‰€åœ¨çš„å‘½åç©ºé—´ä»¥åŠçŠ¶æ€ã€‚</p>
<p>Tips : <code>crictl ps</code> åˆ—å‡ºçš„æ˜¯åº”ç”¨å®¹å™¨çš„ä¿¡æ¯ï¼Œè€Œdocker psåˆ—å‡ºçš„æ˜¯åˆå§‹åŒ–å®¹å™¨ï¼ˆpauseå®¹å™¨ï¼‰å’Œåº”ç”¨å®¹å™¨çš„ä¿¡æ¯ï¼Œåˆå§‹åŒ–å®¹å™¨åœ¨æ¯ä¸ªpodå¯åŠ¨æ—¶éƒ½ä¼šåˆ›å»ºï¼Œé€šå¸¸ä¸ä¼šå…³æ³¨ï¼Œä»è¿™ä¸€ç‚¹ä¸Šæ¥è¯´ï¼Œcrictlä½¿ç”¨èµ·æ¥æ›´ç®€æ´æ˜äº†ä¸€äº›ã€‚</p>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171428.png" target="_blank" title="WeiyiGeek.podsä¸ps" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171428.png" alt="WeiyiGeek.podsä¸ps" title="" class=""></a>
                <p>WeiyiGeek.podsä¸ps</p>
            </figure>
<p><br/></p>
<p>Tips: ç”¨ crictl åˆ›å»ºå®¹å™¨å¯¹å®¹å™¨è¿è¡Œæ—¶æ’é”™å¾ˆæœ‰å¸®åŠ©ã€‚ åœ¨è¿è¡Œçš„ Kubernetes é›†ç¾¤ä¸­ï¼Œæ²™ç›’ä¼šéšæœºçš„è¢« kubelet åœæ­¢å’Œåˆ é™¤, ä¸‹é¢é€šè¿‡å®ä¾‹è¿›è¡Œæ¼”ç¤ºcrictlä½¿ç”¨ã€‚</p>
<ul>
<li><p>Step 1.ç¼–å†™è¿è¡Œ Pod æ²™ç›’çš„ JSON æ–‡ä»¶ï¼Œä½¿ç”¨ crictl runp å‘½ä»¤åº”ç”¨ JSON æ–‡ä»¶å¹¶è¿è¡Œæ²™ç›’ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat pod-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nginx-sandbox"</span>,</span><br><span class="line">        <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"attempt"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"hdishd83djaidwnduwk28bcsb"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"log_directory"</span>: <span class="string">"/tmp"</span>,</span><br><span class="line">    <span class="attr">"linux"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crictl runp pod-config.json</span><br><span class="line">f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.æ£€æŸ¥æ²™ç›’æ˜¯å¦å¤„äºå°±ç»ªçŠ¶æ€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crictl pods</span><br><span class="line">POD ID              CREATED             STATE               NAME                NAMESPACE           ATTEMPT</span><br><span class="line">f84dd361f8dc5       17 seconds ago      Ready               busybox-sandbox     default             1</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.ä½¿ç”¨è¿è¡Œæ—¶å¤„ç†ç¨‹åºè¿è¡Œpodæ²™ç›’,è¿è¡Œæ—¶å¤„ç†ç¨‹åºéœ€è¦è¿è¡Œæ—¶æ”¯æŒã€‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•åœ¨containerdè¿è¡Œæ—¶ä¸Šä½¿ç”¨runscå¤„ç†ç¨‹åºè¿è¡Œpodæ²™ç›’ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cat pod-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"nginx-runsc-sandbox"</span>,</span><br><span class="line">        <span class="string">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="string">"attempt"</span>: 1,</span><br><span class="line">        <span class="string">"uid"</span>: <span class="string">"hdishd83djaidwnduwk28bcsb"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"log_directory"</span>: <span class="string">"/tmp"</span>,</span><br><span class="line">    <span class="string">"linux"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crictl runp --runtime=runsc pod-config.json</span><br><span class="line">c112976cb6caa43a967293e2c62a2e0d9d8191d5109afef230f403411147548c</span><br><span class="line"></span><br><span class="line">$ crictl inspectp c112976cb6caa43a967293e2c62a2e0d9d8191d5109afef230f403411147548c</span><br><span class="line">...</span><br><span class="line">    <span class="string">"runtime"</span>: &#123;</span><br><span class="line">      <span class="string">"runtimeType"</span>: <span class="string">"io.containerd.runtime.v1.linux"</span>,</span><br><span class="line">      <span class="string">"runtimeEngine"</span>: <span class="string">"/usr/local/sbin/runsc"</span>,</span><br><span class="line">      <span class="string">"runtimeRoot"</span>: <span class="string">"/run/containerd/runsc"</span></span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Step 4.æ‹‰å– busybox é•œåƒç„¶ååœ¨podæ²™ç›’ä¸­ä½¿ç”¨configæ–‡ä»¶åˆ›å»ºå®¹å™¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">crictl pull busybox:1.33.1</span><br><span class="line"> <span class="comment"># Image is up to date for sha256:69593048aa3acfee0f75f20b77acb549de2472063053f6730c4091b53f2dfb02</span></span><br><span class="line"></span><br><span class="line">$ cat pod-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"nginx-sandbox"</span>,</span><br><span class="line">        <span class="string">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="string">"attempt"</span>: 1,</span><br><span class="line">        <span class="string">"uid"</span>: <span class="string">"hdishd83djaidwnduwk28bcsb"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"log_directory"</span>: <span class="string">"/tmp"</span>,</span><br><span class="line">    <span class="string">"linux"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat container-config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"busybox"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"image"</span>:&#123;</span><br><span class="line">      <span class="string">"image"</span>: <span class="string">"busybox:1.33.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"command"</span>: [</span><br><span class="line">      <span class="string">"top"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"log_path"</span>:<span class="string">"busybox.log"</span>,</span><br><span class="line">  <span class="string">"linux"</span>: &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crictl create f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f container-config.json pod-config.json</span><br><span class="line">3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.åˆ—å‡ºå®¹å™¨å¹¶æ£€æŸ¥å®¹å™¨æ˜¯å¦å¤„äºå·²åˆ›å»ºçŠ¶å¹¶å¯åŠ¨å®¹å™¨</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ crictl ps -a</span><br><span class="line">CONTAINER ID        IMAGE               CREATED             STATE               NAME                ATTEMPT</span><br><span class="line">3e025dd50a72d       busybox             32 seconds ago      Created             busybox             0</span><br><span class="line"></span><br><span class="line">$ crictl start 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60</span><br><span class="line">3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60</span><br><span class="line"></span><br><span class="line">$ crictl ps</span><br><span class="line">CONTAINER ID        IMAGE               CREATED              STATE               NAME                ATTEMPT</span><br><span class="line">3e025dd50a72d       busybox             About a minute ago   Running             busybox             0</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Step 6.åœ¨å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crictl <span class="built_in">exec</span> -i -t 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60 ls</span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 7.æ˜¾ç¤ºå®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crictl stats</span><br><span class="line">CONTAINER           CPU %               MEM                 DISK              INODES</span><br><span class="line">3e025dd50a72d       0.00                983kB             16.38kB             6</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Containerd-è·Ÿ-Docker-çš„åŒºåˆ«è¯´æ˜"><a href="#Containerd-è·Ÿ-Docker-çš„åŒºåˆ«è¯´æ˜" class="headerlink" title="Containerd è·Ÿ Docker çš„åŒºåˆ«è¯´æ˜"></a>Containerd è·Ÿ Docker çš„åŒºåˆ«è¯´æ˜</h3><p>Docker å¯¹å®¹å™¨çš„ç®¡ç†å’Œæ“ä½œåŸºæœ¬éƒ½æ˜¯é€šè¿‡ containerd å®Œæˆçš„ï¼Œåªæ˜¯ç›¸å½“å¯¹äºå¯¹å…¶è¿›è¡Œäº†å°è£…ï¼Œæä¾›ä¸€äº›éå¸¸ç®€å•çš„å‘½ä»¤è¿›è¡Œç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€‚ </p>
<p>Containerd æ˜¯ä¸€ä¸ªå·¥ä¸šçº§æ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒå¼ºè°ƒç®€å•æ€§ã€å¥å£®æ€§å’Œå¯ç§»æ¤æ€§ï¼Œä¸»è¦åœ¨å®¿ä¸»æœºä¸­ç®¡ç†å®Œæ•´çš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼šå®¹å™¨é•œåƒçš„ä¼ è¾“å’Œå­˜å‚¨ã€å®¹å™¨çš„æ‰§è¡Œå’Œç®¡ç†ã€å­˜å‚¨å’Œç½‘ç»œç­‰ã€‚</p>
<p><strong>Kubernetes è°ƒç”¨é“¾å¯¹æ¯”</strong></p>
<p>åœ¨Kubenetes 1.19.x ä¸ Kubernetes 1.20.x ç‰ˆæœ¬é’ˆå¯¹runtimeåˆ†åˆ«ä½¿ç”¨dockerã€Containerçš„è°ƒç”¨é“¾å…³ç³»ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Runtime = docker æ—¶çš„è°ƒç”¨é“¾</span></span><br><span class="line">Kubelet -&gt; Dockerd -&gt; Containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Runtime = containerd æ—¶çš„è°ƒç”¨é“¾</span></span><br><span class="line">Kubelet -&gt; Containerd</span><br></pre></td></tr></table></figure></p>
<p>å‘½ä»¤å¯¹æ¯”ï¼šcontainerdä¸æ”¯æŒdocker APIå’Œdocker CLIï¼Œ ä½†æ˜¯å¯ä»¥é€šè¿‡cri-toolå®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p>
<table>
<thead>
<tr>
<th>é•œåƒç›¸å…³åŠŸèƒ½</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ˜¾ç¤ºæœ¬åœ°é•œåƒåˆ—è¡¨</td>
<td>docker images</td>
<td>crictl images</td>
</tr>
<tr>
<td>ä¸‹è½½é•œåƒ</td>
<td>docker pull</td>
<td>crictl pull</td>
</tr>
<tr>
<td>ä¸Šä¼ é•œåƒ</td>
<td>docker push</td>
<td>æ— </td>
</tr>
<tr>
<td>åˆ é™¤æœ¬åœ°é•œåƒ</td>
<td>docker rmi</td>
<td>crictl rmi</td>
</tr>
<tr>
<td>æŸ¥çœ‹é•œåƒè¯¦æƒ…</td>
<td>docker inspect</td>
<td>crictl inspecti</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>å®¹å™¨ç›¸å…³åŠŸèƒ½</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ˜¾ç¤ºå®¹å™¨åˆ—è¡¨</td>
<td>docker ps</td>
<td>crictl ps</td>
</tr>
<tr>
<td>åˆ›å»ºå®¹å™¨</td>
<td>docker create</td>
<td>crictl create</td>
</tr>
<tr>
<td>å¯åŠ¨å®¹å™¨</td>
<td>docker start</td>
<td>crictl start</td>
</tr>
<tr>
<td>åœæ­¢å®¹å™¨</td>
<td>docker stop</td>
<td>crictl stop</td>
</tr>
<tr>
<td>åˆ é™¤å®¹å™¨</td>
<td>docker rm</td>
<td>crictl rm</td>
</tr>
<tr>
<td>æŸ¥çœ‹å®¹å™¨è¯¦æƒ…</td>
<td>docker  inspect</td>
<td>crictl  inspect</td>
</tr>
<tr>
<td>attach</td>
<td>docker attach</td>
<td>crictl attach</td>
</tr>
<tr>
<td>exec</td>
<td>docker exec</td>
<td>crictl exec</td>
</tr>
<tr>
<td>logs</td>
<td>docker logs</td>
<td>crictl logs</td>
</tr>
<tr>
<td>stats</td>
<td>docker stats</td>
<td>crictl stats</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>PODç›¸å…³åŠŸèƒ½</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ˜¾ç¤ºPODåˆ—è¡¨</td>
<td>æ— </td>
<td>crictl pods</td>
</tr>
<tr>
<td>æŸ¥çœ‹PODè¯¦æƒ…</td>
<td>æ— </td>
<td>crictl  inspectp</td>
</tr>
<tr>
<td>è¿è¡ŒPOD</td>
<td>æ— </td>
<td>crictl runp</td>
</tr>
<tr>
<td>åœæ­¢POD</td>
<td>æ— </td>
<td>crictl stopp</td>
</tr>
</tbody>
</table>
<p><strong>é…ç½®å‚æ•°å¯¹æ¯”</strong>: </p>
<ul>
<li>æ—¥å¿—é…ç½®å‚æ•°åŒºåˆ«</li>
</ul>
<table>
<thead>
<tr>
<th>å¯¹æ¯”é¡¹</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­˜å‚¨è·¯å¾„</td>
<td>dockerä½œä¸ºk8så®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ï¼Œå®¹å™¨æ—¥å¿—çš„è½ç›˜ç”±dockeræ¥å®Œæˆï¼Œ ä¿å­˜åœ¨ç±»ä¼¼<code>/var/lib/docker/containers/CONTAINERID</code> ç›®å½•ä¸‹ã€‚kubeletä¼šåœ¨<code>/var/log/podså’Œ/var/log/containers</code>ä¸‹é¢å»ºç«‹è½¯é“¾æ¥ï¼ŒæŒ‡å‘<code>/var/lib/docker/containers/CONTAINERID</code>ç›®å½•ä¸‹çš„å®¹å™¨æ—¥å¿—æ–‡ä»¶</td>
<td>containerdä½œä¸ºk8så®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ï¼Œ å®¹å™¨æ—¥å¿—çš„è½ç›˜ç”±kubeletæ¥å®Œæˆï¼Œä¿å­˜åˆ°<code>/var/log/pods/$CONTAINER_NAME</code>ç›®å½•ä¸‹ï¼ŒåŒæ—¶åœ¨/var/log/containersç›®å½•ä¸‹åˆ›å»ºè½¯é“¾æ¥ï¼ŒæŒ‡å‘æ—¥å¿—æ–‡ä»¶</td>
</tr>
<tr>
<td>é…ç½®å‚æ•°</td>
<td>åœ¨dockeré…ç½®æ–‡ä»¶ä¸­æŒ‡å®š<code>ï¼š&quot;log-driver&quot;: &quot;json-file&quot;, &quot;log-opts&quot;: {&quot;max-size&quot;: &quot;100m&quot;,&quot;max-file&quot;: &quot;5&quot;}</code></td>
<td>æ–¹æ³•ä¸€ï¼šåœ¨kubeletå‚æ•°ä¸­æŒ‡å®šï¼š <code>--container-log-max-files=5 --container-log-max-size=&quot;100Mi&quot;</code> <br/> æ–¹æ³•äºŒï¼šåœ¨KubeletConfigurationä¸­æŒ‡å®šï¼š<code>&quot;containerLogMaxSize&quot;: &quot;100Mi&quot;,&quot;containerLogMaxFiles&quot;: 5</code></td>
</tr>
<tr>
<td>å®¹å™¨æ—¥å¿—ä¿å­˜åˆ°æ•°æ®ç›˜</td>
<td>æŠŠæ•°æ®ç›˜æŒ‚è½½åˆ°<code>&quot;data-root&quot;</code>(ç¼ºçœæ˜¯<code>/var/lib/docker</code>)å³å¯</td>
<td>åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥<code>/var/log/pods</code>æŒ‡å‘æ•°æ®ç›˜æŒ‚è½½ç‚¹ä¸‹çš„æŸä¸ªç›®å½•åœ¨TKEä¸­é€‰æ‹©â€å°†å®¹å™¨å’Œé•œåƒå­˜å‚¨åœ¨æ•°æ®ç›˜â€ä¼šè‡ªåŠ¨åˆ›å»ºè½¯é“¾æ¥<code>/var/log/pods</code></td>
</tr>
</tbody>
</table>
<ul>
<li>stream server åŒºåˆ«: æ‰§è¡Œ kubectl exec/logs ç­‰å‘½ä»¤éœ€è¦åœ¨apiserverè·Ÿå®¹å™¨è¿è¡Œæ—¶ä¹‹é—´å»ºç«‹æµè½¬å‘é€šé“ã€‚<br>Docker APIæœ¬èº«æä¾›streamæœåŠ¡ï¼Œkubelet å†…éƒ¨çš„ docker-shim ä¼šé€šè¿‡ docker APIåšæµè½¬å‘, containerd çš„streamæœåŠ¡éœ€è¦å•ç‹¬é…ç½®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[plugins.cri]</span><br><span class="line">  stream_server_address = <span class="string">"127.0.0.1"</span></span><br><span class="line">  stream_server_port = <span class="string">"0"</span></span><br><span class="line">  enable_tls_streaming = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
Tips: ä»k8s1.11å¼•å…¥äº† <code>kubelet stream proxy</code> <code>(https://github.com/kubernetes/kubernetes/pull/64006)</code>, ä»è€Œä½¿å¾—<code>containerd stream server</code>åªéœ€è¦ç›‘å¬æœ¬åœ°åœ°å€å³å¯ã€‚</li>
</ul>
<ul>
<li>CNI ç½‘ç»œåŒºåˆ«</li>
</ul>
<table>
<thead>
<tr>
<th>å¯¹æ¯”é¡¹</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>è°è´Ÿè´£è°ƒç”¨CNI</td>
<td>kubeletå†…éƒ¨çš„docker-shim</td>
<td>containerdå†…ç½®çš„cri-plugin(containerd 1.1ä»¥å)</td>
</tr>
<tr>
<td>å¦‚ä½•é…ç½®CNI</td>
<td>kubeletå‚æ•° â€“cni-bin-dir å’Œ â€“cni-conf-dir</td>
<td>containerdé…ç½®æ–‡ä»¶(toml)ï¼šplugins.cri.cni  <br/>bin_dir = â€œ/opt/cni/binâ€   <br/>  conf_dir = â€œ/etc/cni/net.dâ€</td>
</tr>
</tbody>
</table>
<ul>
<li>åç§°ç©ºé—´ï¼ˆNamespaceï¼‰:<br>Dockeræ²¡æœ‰namespaceåç§°ç©ºé—´ï¼Œè€ŒContainerdæ˜¯æ”¯æŒnamespacesçš„ï¼Œå¯¹äºä¸Šå±‚ç¼–æ’ç³»ç»Ÿçš„æ”¯æŒï¼Œä¸»è¦åŒºåˆ†äº†3ä¸ªå‘½åç©ºé—´åˆ†åˆ«æ˜¯k8s.ioã€mobyå’Œdefaultï¼Œä»¥ä¸Šæˆ‘ä»¬ç”¨crictlæ“ä½œçš„å‡åœ¨k8s.ioå‘½åç©ºé—´å®Œæˆå¦‚æŸ¥çœ‹é•œåƒåˆ—è¡¨å°±éœ€è¦åŠ ä¸Š-nå‚æ•° .</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯• href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211215112553.png" target="_blank" title="WeiyiGeek.Containerd Namespace" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211215112553.png" alt="WeiyiGeek.Containerd Namespace" title="" class=""></a>
                <p>WeiyiGeek.Containerd Namespace</p>
            </figure>

        </div>
        
  <hr>
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>

  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ï¼Œè½¬ä¸ªå‘ã€‘(äººé—´äº”å¤§æƒ…)</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œè°¢è°¢ï¼ã€‚</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="æ‰«æVisit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-09-08T07:25:18.393Z" itemprop="dateUpdated">2022-09-08 15:25:18</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Containerd/1.åŸºäºContainerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Containerd/1.åŸºäºContainerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2021/6-27-570.html" target="_blank" rel="external">https://blog.weiyigeek.top/2021/6-27-570.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">ğŸ‘ é’Ÿæ„ä½œè€…</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Containerd/" rel="tag">Containerd</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=ã€Š1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=ã€Š1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/6-27-570.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/6-29-571.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">2.åŸºäºContainerdè¿è¡Œæ—¶æ­å»ºKuberneteså¤šæ§åˆ¶å¹³é¢é›†ç¾¤å®è·µ</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/6-17-562.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">KVMå­¦ä¹ å…¥å‘ä¸å‡ºå‘</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 å‰è¨€ç®€è¿°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-åŸºç¡€ä»‹ç»"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.åŸºç¡€ä»‹ç»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-ä¸“ä¸šæœ¯è¯­"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.ä¸“ä¸šæœ¯è¯­</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-æ¶æ„ç®€è¿°"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.æ¶æ„ç®€è¿°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#CRI-çš„æ¶æ„"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">CRI çš„æ¶æ„</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Containerd-çš„æ¶æ„"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">Containerd çš„æ¶æ„</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-å®‰è£…é…ç½®"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 å®‰è£…é…ç½®</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Ubuntuå®‰è£…Containerd-ioæµç¨‹"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.Ubuntuå®‰è£…Containerd.ioæµç¨‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-Containerd-ç®€å•å°è¯•ä½¿ç”¨"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 Containerd ç®€å•å°è¯•ä½¿ç”¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-é•œåƒæ‹‰å–ä¸è¿è¡Œ"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.é•œåƒæ‹‰å–ä¸è¿è¡Œ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-åˆ›å»ºå’Œä½¿ç”¨ç½‘ç»œ"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.åˆ›å»ºå’Œä½¿ç”¨ç½‘ç»œ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-ä¸å®¿ä¸»æœºå’Œå…¶å®ƒå®¹å™¨å…±äº«æ–‡ä»¶"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.ä¸å®¿ä¸»æœºå’Œå…¶å®ƒå®¹å™¨å…±äº«æ–‡ä»¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-Docker-ä¸-Containerd-å¹¶ç”¨é…ç½®"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.Docker ä¸ Containerd å¹¶ç”¨é…ç½®</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-é•œåƒåŠ é€Ÿé…ç½®"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">5.é•œåƒåŠ é€Ÿé…ç½®</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-Containerd-ä¸-Docker-CLI-å·¥å…·å‘½ä»¤è¡¨"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 Containerd ä¸ Docker CLI å·¥å…·å‘½ä»¤è¡¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ctr-å‘½ä»¤-Containerd-ç®¡ç†å‘½ä»¤è¯¦ç»†"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">ctr å‘½ä»¤ - Containerd ç®¡ç†å‘½ä»¤è¯¦ç»†</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#crictl-å‘½ä»¤-Kubernetes-ç®¡ç†å‘½ä»¤è¯¦è§£"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">crictl å‘½ä»¤ - Kubernetes ç®¡ç†å‘½ä»¤è¯¦è§£</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Containerd-è·Ÿ-Docker-çš„åŒºåˆ«è¯´æ˜"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Containerd è·Ÿ Docker çš„åŒºåˆ«è¯´æ˜</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¿˜è¯·æ”¯æŒä¸€ä¸‹åšä¸»å“Ÿ, è°¢è°¢å„ä½çœ‹å‹â™¥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="228" height="228" alt="æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="228" height="228" alt="æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½æœ‹å‹,å¯ä»¥å…³ä¸ªæ³¨å—? â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">ä¸ªäººGithub</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">ä¸ªäººGitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">ä¸ªäººçŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘+äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved. ITå”¯ä¸€æå®¢ ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=ã€Š1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=ã€Š1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š1.Containerdå®¹å™¨è¿è¡Œæ—¶åˆè¯†ä¸å°è¯•ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/6-27-570.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJklEQVR42u3ay24CMQwFUP7/p6nUVSU0w7U9g0pyskJAQ84s3PjxeMTr+bv+vn5dr58e7ZOsxx0LAwPjaxnJdvlBj/Y8+vRo//xsGBgY+zCSIHt+3ISUx8z8bBgYGBjnP5AH6OqjwcDAwJgE3BxTTXo/+n8DAwPjCxmTItr5D5y/0wvrGBgYuzF6jYHPvL69v4GBgfHvGc/BuqO32DwJBgbG0ozqtW9y0DzprTYJMDAwdmMkKWU1ia1+p4fEwMBYm1Hdotf4zMNx9VcwMDB2YOSJZe8CNx8vi0I/BgbGNoxeeL2vDdDsxGJgYCzKyENkcrHLH011tOJNYwADA2M5RnX8az7yNQnZh3+FgYGxJSMPiMlVMtl/lAxjYGAszegVvJJBirycNx/pwMDAWJuRHKXXKqheKxPqmyCLgYGxJaM3DJGnoPP3MTAwdmAk5fjJZbHahqyOhR1m5BgYGAsxJonoJFlNAmvSwizccDEwML6W0Su09ZLSPE2tfhMDA2MfxlVJbFK265XhCkU3DAyMRRm96+CkSXnVw8LAwNiBUQ2gyQWxmo4mpf/8sWJgYKzEeBZXtRBWLec102YMDIylGflKjptcH3skDAwMjF75/uK0Mx5Na46FYWBgLMFIgmxv2CvZrfe4MTAwMJKAm5fbksGOUSMTAwMDI25hXttOSH4FAwNjH0beDKjCes2Aco0QAwNjaUavllVtMU7GLMozIxgYGOswfgAO/CLgbOJ00QAAAABJRU5ErkJggg==" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
