{"title":"23-Kubernetes扩展学习实践笔记","slug":"虚拟云容/云容器/Kubernetes/23-Kubernetes扩展学习实践笔记","date":"2022-12-18T02:37:47.000Z","updated":"2022-12-27T03:23:54.229Z","url":"2022/12-18-691.html","path":"api/articles/2022/12-18-691.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-如何将K8S中源数据通过环境变量注入到容器\"><a href=\"#0x00-如何将K8S中源数据通过环境变量注入到容器\" class=\"headerlink\" title=\"0x00 如何将K8S中源数据通过环境变量注入到容器?\"></a>0x00 如何将K8S中源数据通过环境变量注入到容器?</h2><p>描述: Kubernetes 自从1.7开始，可以在 pod 的container 内获取pod的spec,metadata 等源数据信息，实际上是使用 downward API 通过环境变量把自身的信息呈现给 Pod 中运行的容器。</p>\n<p>pod一共有三种类型容器<br>• Infrastructure Container：基础容器<br> • 维护整个Pod网络空间<br>• InitContainers：初始化容器<br>• 先于业务容器开始执行<br>• Containers：业务容器<br>• 并行启动 </p>\n<p><strong>需求</strong>: 假如你有一个根据主机名词尾缀进行选择要使用GPU资源序号，或者是获取资源控制器生成的Pod相关IP或标签信息，此时都可以使用注入环境变量的方式（希望对大家有帮助）</p>\n<p><strong>目标</strong>：通过使用 env 和 fieldRef，将 k8s 的源数据和容器字段变成环境变量注入到了容器中。</p>\n<p>当前资源控制器env对象 (<code>valueFrom.fieldRef.fieldPath</code>) 支持的注入字段信息如下:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Pod 名称（主机名称）</span></span><br><span class=\"line\">metadata.name</span><br><span class=\"line\"><span class=\"comment\"># 名称空间</span></span><br><span class=\"line\">metadata.namespace</span><br><span class=\"line\"><span class=\"comment\"># 标签</span></span><br><span class=\"line\">metadata.labels[<span class=\"string\">''</span>]</span><br><span class=\"line\"><span class=\"comment\"># 注释</span></span><br><span class=\"line\">metadata.annotations[<span class=\"string\">''</span>]</span><br><span class=\"line\"><span class=\"comment\"># 节点名词</span></span><br><span class=\"line\">spec.nodeName</span><br><span class=\"line\"><span class=\"comment\"># 服务账户名词</span></span><br><span class=\"line\">spec.serviceAccountName</span><br><span class=\"line\"><span class=\"comment\"># 宿主机IP地址信息</span></span><br><span class=\"line\">status.hostIP</span><br><span class=\"line\"><span class=\"comment\"># Pod IPV4地址信息</span></span><br><span class=\"line\">status.podIP</span><br><span class=\"line\"><span class=\"comment\"># 获取 Pod 的 IPv4 和 IPv6 地址</span></span><br><span class=\"line\">status.podIPs</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例</strong>：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">dapi-envars-fieldref</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devtest</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">downwardAPI</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\"><span class=\"attr\">    demo:</span> <span class=\"string\">dapi-envars</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">test-container</span></span><br><span class=\"line\"><span class=\"attr\">      image:</span> <span class=\"attr\">busybox:latest</span></span><br><span class=\"line\"><span class=\"attr\">      command:</span> <span class=\"string\">[</span> <span class=\"string\">\"sh\"</span><span class=\"string\">,</span> <span class=\"string\">\"-c\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">      args:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">while</span> <span class=\"literal\">true</span><span class=\"string\">;</span> <span class=\"string\">do</span></span><br><span class=\"line\">          <span class=\"string\">echo</span> <span class=\"bullet\">-en</span> <span class=\"string\">'\\n'</span><span class=\"string\">;</span></span><br><span class=\"line\">          <span class=\"string\">printenv</span> <span class=\"string\">MY_NODE_NAME</span> <span class=\"string\">MY_POD_NAME</span> <span class=\"string\">MY_POD_NAMESPACE;</span></span><br><span class=\"line\">          <span class=\"string\">printenv</span> <span class=\"string\">MY_POD_IP</span> <span class=\"string\">MY_POD_IPS</span> <span class=\"string\">MY_POD_SERVICE_ACCOUNT;</span></span><br><span class=\"line\">          <span class=\"string\">printenv</span> <span class=\"string\">MY_POD_LABELS_APP</span> <span class=\"string\">MY_POD_ANNOTATIONS_DEMO;</span></span><br><span class=\"line\">          <span class=\"string\">printenv</span> <span class=\"string\">MY_CPU_REQUEST</span> <span class=\"string\">MY_CPU_LIMIT;</span></span><br><span class=\"line\">          <span class=\"string\">printenv</span> <span class=\"string\">MY_MEM_REQUEST</span> <span class=\"string\">MY_MEM_LIMIT;</span></span><br><span class=\"line\">          <span class=\"string\">sleep</span> <span class=\"number\">10</span><span class=\"string\">;</span></span><br><span class=\"line\">        <span class=\"string\">done;</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          memory:</span> <span class=\"string\">\"32Mi\"</span></span><br><span class=\"line\"><span class=\"attr\">          cpu:</span> <span class=\"string\">\"125m\"</span></span><br><span class=\"line\"><span class=\"attr\">        limits:</span></span><br><span class=\"line\"><span class=\"attr\">          memory:</span> <span class=\"string\">\"64Mi\"</span></span><br><span class=\"line\"><span class=\"attr\">          cpu:</span> <span class=\"string\">\"250m\"</span></span><br><span class=\"line\"><span class=\"attr\">      env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">spec.nodeName</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_NODE_NAME</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">spec.nodeName</span></span><br><span class=\"line\"><span class=\"attr\">       - name:</span> <span class=\"string\">HOST_IP</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">status.hostIP</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_POD_NAME</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_POD_NAMESPACE</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_POD_IP</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_POD_IPS</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">status.podIPs</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_POD_SERVICE_ACCOUNT</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">spec.serviceAccountName</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_POD_LABELS_APP</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">metadata.labels['app']</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_POD_ANNOTATIONS_DEMO</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">metadata.annotations['demo']</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_CPU_REQUEST</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            resourceFieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              containerName:</span> <span class=\"string\">test-container</span></span><br><span class=\"line\"><span class=\"attr\">              resource:</span> <span class=\"string\">requests.cpu</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_CPU_LIMIT</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            resourceFieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              containerName:</span> <span class=\"string\">test-container</span></span><br><span class=\"line\"><span class=\"attr\">              resource:</span> <span class=\"string\">limits.cpu</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_MEM_REQUEST</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            resourceFieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              containerName:</span> <span class=\"string\">test-container</span></span><br><span class=\"line\"><span class=\"attr\">              resource:</span> <span class=\"string\">requests.memory</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">MY_MEM_LIMIT</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            resourceFieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              containerName:</span> <span class=\"string\">test-container</span></span><br><span class=\"line\"><span class=\"attr\">              resource:</span> <span class=\"string\">limits.memory</span></span><br><span class=\"line\"><span class=\"attr\">  restartPolicy:</span> <span class=\"string\">Never</span></span><br></pre></td></tr></table></figure>\n<p>运行Pod后查看注入的环境变量:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ kubectl apply -f <span class=\"built_in\">test</span>-container.yaml</span><br><span class=\"line\">pod/dapi-envars-fieldref created</span><br><span class=\"line\"></span><br><span class=\"line\">~$ kubectl logs -n devtest dapi-envars-fieldref</span><br><span class=\"line\">dapi-envars-fieldref</span><br><span class=\"line\">devtest</span><br><span class=\"line\">10.66.182.247</span><br><span class=\"line\">10.66.182.247</span><br><span class=\"line\">default</span><br><span class=\"line\">downwardAPI</span><br><span class=\"line\">dapi-envars</span><br><span class=\"line\">1</span><br><span class=\"line\">1</span><br><span class=\"line\">33554432</span><br><span class=\"line\">67108864</span><br><span class=\"line\"></span><br><span class=\"line\">~$ kubectl <span class=\"built_in\">exec</span> -n devtest dapi-envars-fieldref -- printenv</span><br><span class=\"line\">HOSTNAME=dapi-envars-fieldref</span><br><span class=\"line\">MY_MEM_REQUEST=33554432</span><br><span class=\"line\">HOST_IP=192.168.12.226</span><br><span class=\"line\">MY_POD_NAME=dapi-envars-fieldref</span><br><span class=\"line\">MY_POD_NAMESPACE=devtest</span><br><span class=\"line\">MY_POD_IP=10.66.182.247</span><br><span class=\"line\">MY_POD_IPS=10.66.182.247</span><br><span class=\"line\">MY_POD_SERVICE_ACCOUNT=default</span><br><span class=\"line\">MY_POD_ANNOTATIONS_DEMO=dapi-envars</span><br><span class=\"line\">NODE_NAME=weiyigeek-226</span><br><span class=\"line\">MY_POD_LABELS_APP=downwardAPI</span><br><span class=\"line\">MY_CPU_REQUEST=1</span><br><span class=\"line\">MY_CPU_LIMIT=1</span><br><span class=\"line\">MY_MEM_LIMIT=67108864</span><br><span class=\"line\">....</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>实践示例:</strong> 根据Pod名称截取最后一个<code>-</code>字符后的数字来选择该Pod调用的GPU序号(即使用那一块gpu)</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">healthcode</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devtest</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">healthcode</span></span><br><span class=\"line\"><span class=\"attr\">    use:</span> <span class=\"string\">gpu</span></span><br><span class=\"line\"><span class=\"attr\">  annotations:</span></span><br><span class=\"line\"><span class=\"attr\">    author:</span> <span class=\"string\">weiyigeek</span></span><br><span class=\"line\"><span class=\"attr\">    blog:</span> <span class=\"string\">blog.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">      port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">8000</span></span><br><span class=\"line\"><span class=\"attr\">      protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">      nodePort:</span> <span class=\"number\">30000</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">healthcode</span></span><br><span class=\"line\"><span class=\"attr\">    use:</span> <span class=\"string\">gpu</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">healthcode-0</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">devtest</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">healthcode</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">healthcode</span></span><br><span class=\"line\"><span class=\"attr\">      use:</span> <span class=\"string\">gpu</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">\"healthcode\"</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">healthcode</span></span><br><span class=\"line\"><span class=\"attr\">        use:</span> <span class=\"string\">gpu</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">workdir</span></span><br><span class=\"line\"><span class=\"attr\">        emptyDir:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">workspace</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/storage/webapp/project/MultiTravelcodeocr</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">model</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/storage/webapp/project/.EasyOCR</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">img</span></span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/storage/webapp/project/upfile</span></span><br><span class=\"line\"><span class=\"attr\">          type:</span> <span class=\"string\">DirectoryOrCreate</span></span><br><span class=\"line\"><span class=\"attr\">      initContainers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">init</span>  <span class=\"comment\"># 使用初始化容器进行相应处理</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">busybox:1.35.0</span></span><br><span class=\"line\"><span class=\"attr\">        imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span>  <span class=\"comment\"># 设置 Pod 使用的 GPU 显卡序号</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">/bin/sh</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"bullet\">-c</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">\"echo export CUDA_VISIBLE_DEVICES=$&#123;GPU_DEVICES##*-&#125;&gt; /app/$&#123;GPU_DEVICES&#125;\"</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">GPU_DEVICES</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">        <span class=\"comment\"># - name: CUDA_VISIBLE_DEVICES    # 此种方式不行，env不能直接截取变量</span></span><br><span class=\"line\">        <span class=\"comment\">#   value: $&#123;GPU_DEVICES##*-&#125;</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">workdir</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/app/</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">harbor.weiyigeek.top/python/easyocr-healthcode:v1.6.2</span></span><br><span class=\"line\"><span class=\"attr\">          command:</span> <span class=\"string\">['/bin/bash',</span> <span class=\"string\">'-c'</span><span class=\"string\">,'source</span> <span class=\"string\">/app/$&#123;HOSTNAME&#125;;</span> <span class=\"string\">echo</span> <span class=\"string\">$&#123;CUDA_VISIBLE_DEVICES&#125;;</span> <span class=\"string\">python</span> <span class=\"string\">./setup.py</span> <span class=\"bullet\">--imgdir=/imgs</span> <span class=\"bullet\">--logdir=</span></span><br><span class=\"line\"><span class=\"string\">/logs</span> <span class=\"bullet\">--gpu=True']</span> <span class=\"comment\"># 加载进行环境变量之中,实际上我们也可以在app容器直接在source命令前echo export CUDA_VISIBLE_DEVICES=$&#123;HOSTNAME##*-&#125;&gt; /app/$&#123;HOSTNAME&#125;使用搞定，总之条条大路通罗马，学习就是思路。</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">          resources:</span></span><br><span class=\"line\"><span class=\"attr\">            limits:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\">            <span class=\"comment\">#  cpu: \"8\"</span></span><br><span class=\"line\">            <span class=\"comment\">#  memory: 8Gi</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">workdir</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/app/</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">workspace</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/workspace</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">model</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/root/.EasyOCR</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">img</span></span><br><span class=\"line\"><span class=\"attr\">              mountPath:</span> <span class=\"string\">/imgs</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">              protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">              containerPort:</span> <span class=\"number\">8000</span></span><br></pre></td></tr></table></figure>\n<p>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 一个6个pod，每个pod使用对应的GPU，例如0-0则使用0号CPU，0-1则使用1号CPU </span></span><br><span class=\"line\">$ kubectl get pod -n devtest</span><br><span class=\"line\">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">healthcode-0-5   1/1     Running   0          15h </span><br><span class=\"line\">healthcode-0-4   1/1     Running   0          15h</span><br><span class=\"line\">healthcode-0-3   1/1     Running   0          15h</span><br><span class=\"line\">healthcode-0-2   1/1     Running   0          15h</span><br><span class=\"line\">healthcode-0-1   1/1     Running   0          15h</span><br><span class=\"line\">healthcode-0-0   1/1     Running   0          15h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看 GPU 服务器使用情况</span></span><br><span class=\"line\">$ nvidia-smi</span><br><span class=\"line\">Fri Dec  9 10:08:32 2022</span><br><span class=\"line\">+-----------------------------------------------------------------------------+</span><br><span class=\"line\">| NVIDIA-SMI 465.19.01    Driver Version: 465.19.01    CUDA Version: 11.3     |</span><br><span class=\"line\">|-------------------------------+----------------------+----------------------+</span><br><span class=\"line\">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class=\"line\">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class=\"line\">|                               |                      |               MIG M. |</span><br><span class=\"line\">|===============================+======================+======================|</span><br><span class=\"line\">|   0  NVIDIA Tesla V1...  Off  | 00000000:1B:00.0 Off |                    0 |</span><br><span class=\"line\">| N/A   41C    P0    36W / 250W |   6697MiB / 32510MiB |      0%      Default |</span><br><span class=\"line\">|                               |                      |                  N/A |</span><br><span class=\"line\">+-------------------------------+----------------------+----------------------+</span><br><span class=\"line\">|   1  NVIDIA Tesla V1...  Off  | 00000000:1D:00.0 Off |                    0 |</span><br><span class=\"line\">| N/A   51C    P0    53W / 250W |   9489MiB / 32510MiB |     14%      Default |</span><br><span class=\"line\">|                               |                      |                  N/A |</span><br><span class=\"line\">+-------------------------------+----------------------+----------------------+</span><br><span class=\"line\">|   2  NVIDIA Tesla V1...  Off  | 00000000:3D:00.0 Off |                    0 |</span><br><span class=\"line\">| N/A   53C    P0    42W / 250W |   5611MiB / 32510MiB |     20%      Default |</span><br><span class=\"line\">|                               |                      |                  N/A |</span><br><span class=\"line\">+-------------------------------+----------------------+----------------------+</span><br><span class=\"line\">|   3  NVIDIA Tesla V1...  Off  | 00000000:3F:00.0 Off |                    0 |</span><br><span class=\"line\">| N/A   37C    P0    35W / 250W |  10555MiB / 32510MiB |      0%      Default |</span><br><span class=\"line\">|                               |                      |                  N/A |</span><br><span class=\"line\">+-------------------------------+----------------------+----------------------+</span><br><span class=\"line\">|   4  NVIDIA Tesla V1...  Off  | 00000000:40:00.0 Off |                    0 |</span><br><span class=\"line\">| N/A   45C    P0    51W / 250W |   5837MiB / 32510MiB |      5%      Default |</span><br><span class=\"line\">|                               |                      |                  N/A |</span><br><span class=\"line\">+-------------------------------+----------------------+----------------------+</span><br><span class=\"line\">|   5  NVIDIA Tesla V1...  Off  | 00000000:41:00.0 Off |                    0 |</span><br><span class=\"line\">| N/A   37C    P0    37W / 250W |  10483MiB / 32510MiB |      0%      Default |</span><br><span class=\"line\">|                               |                      |                  N/A |</span><br><span class=\"line\">+-------------------------------+----------------------+----------------------+</span><br><span class=\"line\"></span><br><span class=\"line\">+-----------------------------------------------------------------------------+</span><br><span class=\"line\">| Processes:                                                                  |</span><br><span class=\"line\">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class=\"line\">|        ID   ID                                                   Usage      |</span><br><span class=\"line\">|=============================================================================|</span><br><span class=\"line\">|    0   N/A  N/A    167660      C   python                           6693MiB |</span><br><span class=\"line\">|    1   N/A  N/A    166790      C   python                           9485MiB |</span><br><span class=\"line\">|    2   N/A  N/A    165941      C   python                           5607MiB |</span><br><span class=\"line\">|    3   N/A  N/A    165032      C   python                          10551MiB |</span><br><span class=\"line\">|    4   N/A  N/A    164226      C   python                           5833MiB |</span><br><span class=\"line\">|    5   N/A  N/A    163344      C   python                          10479MiB |</span><br><span class=\"line\">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p>\n<p>参考文章:</p>\n<ul>\n<li><a href=\"https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/\" target=\"_blank\" rel=\"noopener\">https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/</a></li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"k8s","path":"api/tags/k8s.json"}]}