{"title":"n2.Docker家文件目录介绍和配置文件与守护进程命令参数一览","slug":"虚拟云容/云容器/Docker/n2.Docker配置文件与守护进程参数一览","date":"2019-05-06T07:36:30.000Z","updated":"2023-01-31T02:29:10.642Z","url":"2019/5-6-462.html","path":"api/articles/2019/5-6-462.html.json","covers":["https://img.weiyigeek.top/2020/1/20200803161619.png","https://img.weiyigeek.top/2020/1/20200805172819.png","https://img.weiyigeek.top/2020/1/20200806094310.png","https://img.weiyigeek.top/2020/1/20200808224518.png","https://img.weiyigeek.top/2020/1/20200702100012.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-Docker应用路径\"><a href=\"#0x00-Docker应用路径\" class=\"headerlink\" title=\"0x00 Docker应用路径\"></a>0x00 Docker应用路径</h4><h5 id=\"1-组织结构\"><a href=\"#1-组织结构\" class=\"headerlink\" title=\"1.组织结构\"></a>1.组织结构</h5><p><strong>/var/lib/docker - docker 根(家)目录</strong><br>描述:它是Docker中镜像、容器、容器配置的本地存储目录;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls -lah </span><br><span class=\"line\">drwx------.  2 root root   24 3月  22 13:39 builder</span><br><span class=\"line\">drwx--x--x.  4 root root   92 3月  22 13:39 buildkit</span><br><span class=\"line\">drwx------.  8 root root 4.0K 7月   5 21:28 containers  <span class=\"comment\">#容器相关信息(运行时容器内部的一些配置)</span></span><br><span class=\"line\">drwx------.  3 root root   22 3月  22 13:39 image       <span class=\"comment\">#镜像元数据相关信息</span></span><br><span class=\"line\">drwxr-x---.  3 root root   19 3月  22 13:39 network     <span class=\"comment\">#网络模式相关信息</span></span><br><span class=\"line\">drwx------. 49 root root 8.0K 7月   5 21:41 overlay2    <span class=\"comment\">#容器Layer数据存储目录，</span></span><br><span class=\"line\">drwx------.  4 root root   32 3月  22 13:39 plugins     <span class=\"comment\">#插件信息</span></span><br><span class=\"line\">drwx------.  2 root root    6 7月   2 11:21 runtimes</span><br><span class=\"line\">drwx------.  2 root root    6 3月  22 13:39 swarm       <span class=\"comment\">#集群相关信息</span></span><br><span class=\"line\">drwx------.  2 root root    6 7月   5 21:42 tmp         <span class=\"comment\">#临时目录(在拉去镜像时候会产生临时文件例如: GetImageBlob285307443)</span></span><br><span class=\"line\">drwx------.  2 root root    6 3月  22 13:39 trust       <span class=\"comment\">#验证相关信息</span></span><br><span class=\"line\">drwx------.  7 root root 4.0K 6月  30 22:48 volumes     <span class=\"comment\">#数据卷相关信息(容器持久化的相关信息在其中)</span></span><br></pre></td></tr></table></figure></p>\n<p>补充说明:</p>\n<ul>\n<li>1) 目前最新版本的 docker 默认优先采用 overlay2 作为存储驱动，对于已支持该驱动的 Linux 发行版，不需要任何进行任何额外的配置，可使用 <code>lsmod | grep &quot;overlay&quot;</code> 命令查看当前系统内核是否支持 overlay2,值得一提的是 <code>devicemapper</code> 存储驱动(本人常常被其摧残)已经在 docker 18.09 版本中被废弃，所以在高于此版本的Docker勿听百度的叫您去安装<code>device-mapper-persistent-data</code>因为完全没必要;</li>\n</ul>\n<p><br></p>\n<p><strong>/var/lib/docker/image - 镜像元数据信息</strong><br>描述: 该目录存储docker pull所下载的镜像的相关信息，并且在每次Docker pull 镜像时候都会检查repositories.json文件中索引本地是否存在该拉取镜像(<code>image id / diff_ids</code>)，如果不存在则拉去下载，在Docker家目录中会看见sha256编码的目录名称它们实际是digest信息摘要;</p>\n<p>Q:为什么要有digest?</p>\n<blockquote>\n<p>答:如果一个镜像的镜像名和tag没有变，但是镜像的内容变了（layer变了），会造成相同的镜像名+tag得到了不同的镜像。digest是对manifest文件的sha256，当镜像的内容变化，即layer变化，相应的layer的sha256变化，以至manifest变化，从而保证了一个digest（不是镜像名+tag）对应一个镜像。<br>一句话理解: <code>一个digest 对应一个image Id</code></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree -f 1 /var/lib/docker/image/overlay2</span><br><span class=\"line\"><span class=\"comment\"># 当前 Docker 中存储两个images镜像</span></span><br><span class=\"line\">image</span><br><span class=\"line\">└── overlay2  <span class=\"comment\"># 镜像和容器的层信息(其也代表本使用的overlay2存储驱动)</span></span><br><span class=\"line\">    ├── distribution </span><br><span class=\"line\">    │   ├── diffid-by-digest    <span class=\"comment\">#[通过digest得到diffid] 可以通过Layer的diff id找到对应的digest，并且包含了生成该digest的源仓库</span></span><br><span class=\"line\">    │   │   └── sha256</span><br><span class=\"line\">    │   │       ├── 039b991354af4dcbc534338f687e27643c717bb57e11b87c2e81d50bdd0b2376</span><br><span class=\"line\">    │   │       ├── 09a4142c5c9dde2fbf35e7a6e6475eba75a8c28540c375c80be7eade4b7cb438</span><br><span class=\"line\">    │   └── v2metadata-by-diffid <span class=\"comment\">#[通过diffid得到digest] diffid-by-digest目录则与v2metadata-by-diffid相反</span></span><br><span class=\"line\">    │       └── sha256</span><br><span class=\"line\">    │           ├── 0683de2821778aa9546bf3d3e6944df779daba1582631b7ea3517bb36f9e4007</span><br><span class=\"line\">    │           ├── 0f7493e3a35bab1679e587b41b353b041dca1e7043be230670969703f28a1d83</span><br><span class=\"line\">    ├── imagedb  <span class=\"comment\"># 存储镜像元相关信息</span></span><br><span class=\"line\">    │   ├── content <span class=\"comment\"># 该目录下存储了镜像的JSON格式描述信息</span></span><br><span class=\"line\">    │   │   └── sha256</span><br><span class=\"line\">    │   │       ├── 708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea</span><br><span class=\"line\">    │   │       └── f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a</span><br><span class=\"line\">    │   └── metadata <span class=\"comment\"># 该目录保存每个镜像的parent镜像ID</span></span><br><span class=\"line\">    │       └── sha256</span><br><span class=\"line\">    ├── layerdb <span class=\"comment\"># 层元数据</span></span><br><span class=\"line\">    │   ├── mounts         <span class=\"comment\"># 容器运行时挂载的layer目录 lowerdir、upperdir</span></span><br><span class=\"line\">    │   ├── sha256</span><br><span class=\"line\">    │   │   ├── b9835d6a62886d4e85b65abb120c0ea44ff1b3d116d7a707620785d4664d8c1a <span class=\"comment\"># 唯一层ID</span></span><br><span class=\"line\">    │   │   │   ├── cache-id <span class=\"comment\">#内容为一个uuid，指向Layer本地的真正存储位置</span></span><br><span class=\"line\">    │   │   │   ├── diff     <span class=\"comment\">#该Layer层的差异 id</span></span><br><span class=\"line\">    │   │   │   ├── parent   <span class=\"comment\">#存储了当前Layer层的父层chain_id</span></span><br><span class=\"line\">    │   │   │   ├── size     <span class=\"comment\">#该层的大小</span></span><br><span class=\"line\">    │   │   │   └── tar-split.json.gz  <span class=\"comment\"># tar-split.json.gz，layer压缩包的split文件，通过这个文件可以还原layer的tar包，https://github.com/vbatts/tar-split</span></span><br><span class=\"line\">    │   │   └── d9b567b77bcdb9d8944d3654ea9bb5f6f4f7c4d07a264b2e40b1bb09af171dd3</span><br><span class=\"line\">    │   │       ├── cache-id</span><br><span class=\"line\">    │   │       ├── diff</span><br><span class=\"line\">    │   │       ├── parent</span><br><span class=\"line\">    │   │       ├── size</span><br><span class=\"line\">    │   │       └── tar-split.json.gz</span><br><span class=\"line\">    │   └── tmp</span><br><span class=\"line\">    └── repositories.json  <span class=\"comment\">#该文件存储了本地的所有images列表(镜像元数据信息)，可以通过`docker images --digests`找到对应的镜像名称</span></span><br><span class=\"line\">21 directories, 119 files</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># digest 和 image id 的对应</span></span><br><span class=\"line\"><span class=\"variable\">$jq</span> <span class=\"string\">\".\"</span> /var/lib/docker/overlay2/image/repositories.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"Repositories\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"alpine\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"alpine:latest\"</span>: <span class=\"string\">\"sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"alpine@sha256:185518070891758909c9f839cf4ca393ee977ac378609f700f60a771a2dfe321\"</span>: <span class=\"string\">\"sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><em>补充知识:</em></p>\n<ul>\n<li><p>(1) 通过 overlayfs 联合挂载的技术将镜像的多层 layer 挂载为一层, 下面从 docker 官方文档 <code>Use the OverlayFS storage driver</code> 里偷来的一张图片分别介绍各 Dir 的作用:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 容器ID</span></span><br><span class=\"line\">docker run -ti -d docker-search.4pd.io/ubuntu:18.04 top</span><br><span class=\"line\">c70488b4ca7dfc882664272f5e3c6fe7dd6de1ce36c692b6c52f8002d76ca5ee</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$pwd</span></span><br><span class=\"line\">/var/lib/docker/image/overlay2/layerdb/mounts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 容器的文件系统分为三层:</span></span><br><span class=\"line\">* init层：启动容器时的参数</span><br><span class=\"line\">* r/o层：也就是镜像层</span><br><span class=\"line\">* r/w层：可读写层</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#运行一个容器会返回一个容器id. 通过这个id我们能在*/var/lib/docker/image/overlay2/layerdb/mounts*目录下找到该容器的信息：</span></span><br><span class=\"line\"><span class=\"variable\">$tree</span></span><br><span class=\"line\">├── c70488b4ca7dfc882664272f5e3c6fe7dd6de1ce36c692b6c52f8002d76ca5ee</span><br><span class=\"line\">│   ├── init-id   <span class=\"comment\"># 内容:a66b1fa59d833d7d217ed3c2325079077c69822a21b739bd338f9c0dad227c03-init</span></span><br><span class=\"line\">│   ├── mount-id  <span class=\"comment\"># 内容:a66b1fa59d833d7d217ed3c2325079077c69822a21b739bd338f9c0dad227c03</span></span><br><span class=\"line\">│   └── parent    <span class=\"comment\"># 内容:36a83751a1193f6edf65d21f62fe7988394d562d71904ee20cb4aa72f14148bd</span></span><br><span class=\"line\">└── e35b0d4511220a727e89d90a957a25460349ad143072e6b4efdde9a82c039807</span><br><span class=\"line\">    ├── init-id   <span class=\"comment\"># init层的id</span></span><br><span class=\"line\">    ├── mount-id  <span class=\"comment\"># r/w层的id</span></span><br><span class=\"line\">    └── parent    <span class=\"comment\"># 基于哪个layer层存放的是Digest摘要</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># docker 如何使用的overlayFS?我们可以通过mount -l 查看一下，存储驱动是怎么挂载的目录；</span></span><br><span class=\"line\"><span class=\"variable\">$mount</span> -l</span><br><span class=\"line\">overlay on /var/lib/docker/overlay2/a66b1fa59d833d7d217ed3c2325079077c69822a21b739bd338f9c0dad227c03/merged <span class=\"built_in\">type</span> overla y </span><br><span class=\"line\">(rw,relatime,seclabel,</span><br><span class=\"line\">lowerdir=/var/lib/docker/overlay2/l/C7RLSUT3FAOYOZQ44X5MLUFGXS:/var/lib/docker/overlay2/l/WFV3HGS7BXAK6C2VIPHHGMGRVC:/var/lib/docker/overlay2/l/UO6DNPRKCHHWTV6TWJEFQLAE74:/var/lib/docker/overlay2/l/OUYDRT4WTUXB4J27RBSO72TM6E:/var/lib/docker/overlay2/l/XSKIKL3ZDUGHFLHXAQJEEQLRCV:/var/lib/docker/overlay2/l/NXRKPTSOTIHHPL7YH7YUYZKOCE,</span><br><span class=\"line\">upperdir=/var/lib/docker/overlay2/a66b1fa59d833d7d217ed3c2325079077c69822a21b739bd338f9c0dad227c03/diff,</span><br><span class=\"line\">workdir=/var/lib/docker/overlay2/a66b1fa59d833d7d217ed3c2325079077c69822a21b739bd338f9c0dad227c03/work</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\"># 其中lowerdir就是image layer的四层加上init层，upperdir层是r/w层是diff目录也就是挂载点，workdir是挂载之后的工作目录。</span></span><br><span class=\"line\"><span class=\"comment\"># 此时您可能会困惑WFV3HGS7BXAK6C2VIPHHGMGRVC这些有是啥，这些是为了避免mount命令太长而导致的错误，所有故意搞短一点，</span></span><br><span class=\"line\"><span class=\"comment\"># 实际上您看一哈`/var/lib/docker/overlay2/l/`也即是link的缩写这里面就是一坨指向真正层数据的软链。</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200803161619.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n<li><p>(2) 文件 repositories.json 存储镜像信息<code>主要是name和image id的对应</code>，<code>digest和image id的对应</code>而镜像imageid又包含了image config 以及各层的Digest;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat image/overlay2/repositories.json  | python -m json.tool</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"Repositories\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"docker.io/ubuntu\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"docker.io/ubuntu:18.04\"</span>: <span class=\"string\">\"sha256:775349758637aff77bf85e2ff0597e86e3e859183ef0baba8b3e8fc8d3cba51c\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"docker.io/ubuntu@sha256:6e9f67fa63b0323e9a1e587fd71c561ba48a034504fb804fd26fd8800039835d\"</span>: <span class=\"string\">\"sha256:775349758637aff77bf85e2ff0597e86e3e859183ef0baba8b3e8fc8d3cba51c\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># image id和digest的联系digest是manifest的sha256.</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span> images --digests</span><br><span class=\"line\">REPOSITORY                    TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE</span><br><span class=\"line\">docker-search.4pd.io/ubuntu   18.04               sha256:134c7fe821b9d359490cd009ce7ca322453f4f2d018623f849e580a89a685e5d   775349758637        5 weeks ago         64.2 MB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 因为manifest在本地没有，所有我们可以通过registry的结果去获取经过sha256sum算法生成摘要与docker images --digests中的DIGEST进行对比</span></span><br><span class=\"line\"><span class=\"variable\">$curl</span> -H <span class=\"string\">\"Accept:application/vnd.docker.distribution.manifest.v2+json\"</span> https://docker-search.4pd.io/v2/ubuntu/manifests/18.04 | sha256sum</span><br><span class=\"line\">134c7fe821b9d359490cd009ce7ca322453f4f2d018623f849e580a89a685e5d  -</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过sha256 image config就能得到imageid：</span></span><br><span class=\"line\"><span class=\"variable\">$sha256sum</span> image/overlay2/imagedb/content/sha256/775349758637aff77bf85e2ff0597e86e3e859183ef0baba8b3e8fc8d3cba51c</span><br><span class=\"line\">775349758637aff77bf85e2ff0597e86e3e859183ef0baba8b3e8fc8d3cba51c  image/overlay2/imagedb/content/sha256/775349758637aff77bf85e2ff0597e86e3e859183ef0baba8b3e8fc8d3cba51c</span><br></pre></td></tr></table></figure></li>\n<li>(3) 在pull镜像的时候显示的是<code>各个layer的digest信息而在image config存的是diffid</code>，所以注意区分manifest的layer的表达和image config的layer的表达中不是一个东西;<ul>\n<li>在Registry上拉取Layer的时候需要在请求头加入media type来确定拉取什么格式, 为了在网络上传输的更加快呢所有media type一般会指定压缩格式的比如gzip的，具体有哪些格式，见<a href=\"https://docs.docker.com/registry/spec/manifest-v2-2/#media-types\" target=\"_blank\" rel=\"noopener\">media type</a><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Media Types</span></span><br><span class=\"line\">application/vnd.docker.distribution.manifest.v1+json: <span class=\"comment\"># schema1 (existing manifest format)</span></span><br><span class=\"line\">application/vnd.docker.distribution.manifest.v2+json: <span class=\"comment\"># New image manifest format (schemaVersion = 2)</span></span><br><span class=\"line\">application/vnd.docker.distribution.manifest.list.v2+json: <span class=\"comment\"># Manifest list, aka “fat manifest”</span></span><br><span class=\"line\">application/vnd.docker.container.image.v1+json: <span class=\"comment\"># Container config JSON</span></span><br><span class=\"line\">application/vnd.docker.image.rootfs.diff.tar.gzip: <span class=\"comment\"># “Layer”, as a gzipped tar</span></span><br><span class=\"line\">application/vnd.docker.image.rootfs.foreign.diff.tar.gzip: <span class=\"comment\">#  “Layer”, as a gzipped tar that should never be pushed</span></span><br><span class=\"line\">application/vnd.docker.plugin.v1+json: <span class=\"comment\"># Plugin config JSON</span></span><br></pre></td></tr></table></figure></li>\n<li>当docker发现本地不存在某个layer的时候，就会通过manifest里面的<code>digest + mediaType</code>（一般是”application/vnd.docker.image.rootfs.diff.tar.gzip”）去registry拉对应的leyer, 然后在image id存的对应的diff id就是上面拿到的tar.gz包解压为tar包的id。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># curl -H \"Accept:application/vnd.docker.image.rootfs.diff.tar.gzip\" https://docker-search.4pd.io/v2/ubuntu/blobs/sha256:7ddbc47eeb70dc7f08e410a667948b87ff3883024eb41478b44ef9a81bf400c -o layer1.tar.gz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># sha256sum layer1.tar.gz</span></span><br><span class=\"line\">7ddbc47eeb70dc7f08e410a6667948b87ff3883024eb41478b44ef9a81bf400c  layer1.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># sha256sum layer1.tar</span></span><br><span class=\"line\">cc967c529ced563b7746b663d98248bc571afdb3c012019d7f54d6c092793b8b  layer1.tar</span><br></pre></td></tr></table></figure></li>\n<li><code>/var/lib/docker/image/overlay2/distribution</code> 上面layer digest和diff id的互相对应关系</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<p><strong>/var/lib/docker/overlay2 - 镜像Layer内容存放目录</strong><br>描述:镜像 layer 的内容都存放在一个 diff 的文件夹下(<code>它是Layer本地真正的存储位置</code>)，diff 的上级目录就是以镜像 layer 的 digest 为名的目录;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$docker</span> images --digests --format <span class=\"string\">\"table &#123;&#123;.ID&#125;&#125;\"</span> | grep -v <span class=\"string\">\"none\"</span></span><br><span class=\"line\">IMAGE ID            DIGEST</span><br><span class=\"line\">1e4467b07108        sha256:5d1d5407f353843ecf8b16524bc5565aa332e9e6a1297c73a92d3e754b8a636d</span><br><span class=\"line\">21f378ba43ec        sha256:72b62ec9d0e542f8656d3b9fdb9d11a8c375d9d3396575f999648c50bcd650e7</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$ls</span> /var/lib/docker/overlay2 | egrep <span class=\"string\">\"14f7|75013\"</span></span><br><span class=\"line\">14f71bfdc22c04347ee318693557642f9af04cc1035cd11d92692ec138a086ae</span><br><span class=\"line\">75013da532e8e1fca06ac64cc1c6cc61e3e67b7198eee411c70fab3322bc6df0</span><br><span class=\"line\">75013da532e8e1fca06ac64cc1c6cc61e3e67b7198eee411c70fab3322bc6df0-init</span><br></pre></td></tr></table></figure></p>\n<p>其中还有个 l 文件夹(link 的缩写)，下面有一坨坨的硬链接文件指向上级目录的 layer 目录，l 下的文件都是一些比 digest 文件夹名短一些的，方面不至于 mount 的参数过长。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$tree</span> /var/lib/docker/overlay2/l</span><br><span class=\"line\">.</span><br><span class=\"line\">├── 2R3OHCF7E7AQNZSMWJ7REQGQXF -&gt; ../14f71bfdc22c04347ee318693557642f9af04cc1035cd11d92692ec138a086ae/diff</span><br><span class=\"line\">├── QYJMESMUPSLVLW2WLVFOXGGJFB -&gt; ../75013da532e8e1fca06ac64cc1c6cc61e3e67b7198eee411c70fab3322bc6df0-init/diff</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>/var/lib/docker/containers/容器ID - 运行或者暂停的容器时相关信息</strong><br>描述:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ls</span> -lah /var/lib/docker/containers/4a1a157c5e701af224f3a4c5fb04c47d5b6e90dedc7d2124e21ec9ac33f87991/</span><br><span class=\"line\">-rw-r-----. 1 root root 647K 7月   2 09:11 4a1a157c5e701af224f3a4c5fb04c47d5b6e90dedc7d2124e21ec9ac33f87991-json.log <span class=\"comment\">#标准输入的日志记录</span></span><br><span class=\"line\">drwx------. 2 root root    6 4月   8 11:35 checkpoints  <span class=\"comment\">#容器检查信息</span></span><br><span class=\"line\">-rw-------. 1 root root 3.7K 7月   2 11:21 config.v2.json <span class=\"comment\">#容器设置信息</span></span><br><span class=\"line\">-rw-r--r--. 1 root root 1.7K 7月   2 11:21 hostconfig.json <span class=\"comment\">#容器主机设置信息</span></span><br><span class=\"line\">-rw-r--r--. 1 root root   13 6月  29 22:23 hostname  <span class=\"comment\"># 主机名称</span></span><br><span class=\"line\">-rw-r--r--. 1 root root  171 7月   2 09:11 hosts  <span class=\"comment\"># 主机域名绑定</span></span><br><span class=\"line\">drwx------. 3 root root   17 4月   8 11:35 mounts   <span class=\"comment\"># 挂载的数据卷信息</span></span><br><span class=\"line\">-rw-r--r--. 1 root root   38 6月  29 22:23 resolv.conf <span class=\"comment\">#DNS 域设置</span></span><br><span class=\"line\">-rw-r--r--. 1 root root   71 6月  29 22:23 resolv.conf.hash</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>/var/lib/registry - 镜像仓库目录(非默认可自定义)</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Registry Container Create</span></span><br><span class=\"line\"><span class=\"variable\">$docker</span> run -d --name registry -p 5000:5000 -v /var/lib/registry:/var/lib/registry registry</span><br></pre></td></tr></table></figure></p>\n<p>目录结构:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$tree</span> -h registry/</span><br><span class=\"line\">registry/</span><br><span class=\"line\">└── [  22]  docker</span><br><span class=\"line\">    └── [  16]  registry</span><br><span class=\"line\">        └── [  39]  v2 <span class=\"comment\">#版本协议</span></span><br><span class=\"line\">            ├── [  20]  blobs <span class=\"comment\">#存储镜像的Layer 以及 Manifest 和 Image Config</span></span><br><span class=\"line\">            │   └── [  36]  sha256</span><br><span class=\"line\">            │       ├── [  78]  53</span><br><span class=\"line\">            │       │   └── [  18]  5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368</span><br><span class=\"line\">            │       │       └── [1.1M]  data <span class=\"comment\"># 存储镜像的Layer </span></span><br><span class=\"line\">            │       ├── [  78]  8d</span><br><span class=\"line\">            │       │   └── [  18]  8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">            │       │       └── [ 528]  data <span class=\"comment\"># Manifest 是针对registry服务端的配置信息 </span></span><br><span class=\"line\">            │       └── [  78]  cb</span><br><span class=\"line\">            │           └── [  18]  cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209</span><br><span class=\"line\">            │               └── [1.4K]  data <span class=\"comment\">#Image Config是针对本地镜像的描述</span></span><br><span class=\"line\">            └── [  22]  repositories <span class=\"comment\"># 存储镜像在仓库相关的信息，方便pull时候与blobs 存储的镜像信息对应</span></span><br><span class=\"line\">                └── [  55]  go-hello</span><br><span class=\"line\">                    ├── [  20]  _layers</span><br><span class=\"line\">                    │   └── [ 150]  sha256</span><br><span class=\"line\">                    │       ├── [  18]  5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368</span><br><span class=\"line\">                    │       │   └── [  71]  link</span><br><span class=\"line\">                    │       └── [  18]  cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209</span><br><span class=\"line\">                    │           └── [  71]  link</span><br><span class=\"line\">                    ├── [  35]  _manifests</span><br><span class=\"line\">                    │   ├── [  20]  revisions</span><br><span class=\"line\">                    │   │   └── [  78]  sha256</span><br><span class=\"line\">                    │   │       └── [  18]  8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">                    │   │           └── [  71]  link</span><br><span class=\"line\">                    │   └── [  21]  tags</span><br><span class=\"line\">                    │       └── [  34]  scratch</span><br><span class=\"line\">                    │           ├── [  18]  current</span><br><span class=\"line\">                    │           │   └── [  71]  link</span><br><span class=\"line\">                    │           └── [  20]  index</span><br><span class=\"line\">                    │               └── [  78]  sha256</span><br><span class=\"line\">                    │                   └── [  18]  8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">                    │                       └── [  71]  link</span><br><span class=\"line\">                    ├──[   6]  _uploads  <span class=\"comment\"># 文件夹是个临时的文件夹，主要用来存放 push 镜像过程中的文件数据上传完成后文件夹将会被清空;</span></span><br><span class=\"line\">                    └── _manifests/  <span class=\"comment\"># 由于太多截取一部分</span></span><br><span class=\"line\">                      ├── [  20]  revisions  <span class=\"comment\"># _revisions 目录里存放了该 repository 历史上上传版本的所有 sha256 编码信息。</span></span><br><span class=\"line\">                      │   └── [ 150]  sha256</span><br><span class=\"line\">                      │       ├── [  18]  8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">                      │       │   └── [  71]  link  <span class=\"comment\"># 链接到对应的blobs目录中</span></span><br><span class=\"line\">                      │       └── [  18]  b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c</span><br><span class=\"line\">                      │           └── [  71]  link</span><br><span class=\"line\">                      └── [  34]  tags   <span class=\"comment\">#镜像标记中存有 current 目录和 index 目录</span></span><br><span class=\"line\">                          ├── [  34]  scratch</span><br><span class=\"line\">                          │   ├── [  18]  current  <span class=\"comment\"># current 目录下的 link 文件保存了该 tag 目前的 manifest 文件的 sha256 编码，对应在 blobs 中的 sha256 目录下的 data 文件</span></span><br><span class=\"line\">                          │   │   └── [  71]  link</span><br><span class=\"line\">                          │   └── [  20]  index  <span class=\"comment\"># index 目录则列出了该 tag 历史上传的所有版本的 sha256 编码信息</span></span><br><span class=\"line\">                          │       └── [  78]  sha256</span><br><span class=\"line\">                          │           └── [  18]  8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">                          │               └── [  71]  link</span><br><span class=\"line\">                          └── [  34]  stage</span><br><span class=\"line\">                              ├── [  18]  current</span><br><span class=\"line\">                              │   └── [  71]  link</span><br><span class=\"line\">                              └── [  20]  index</span><br><span class=\"line\">                                  └── [  78]  sha256</span><br><span class=\"line\">                                      └── [  18]  b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c</span><br><span class=\"line\">                                          └── [  71]  link</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>补充说明:</p>\n<ul>\n<li>(1)在<code>/var/lib/registry/docker/registry/v2/blobs/sha256/53/{Digest}</code>目录下的data文件实际是一个压缩文件其文件格式<code>vnd.docker.image.rootfs.diff.tar.gzip</code>,我们可以使用<code>tar</code>命令将其解压；<ul>\n<li>在Docker拉取镜像时候会下载该data文件，等待完成后docker-untar进程将会把data文件解压到<code>/var/lib/docker/overlay2/${digest}/diff</code>目录下<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$pwd</span></span><br><span class=\"line\">/var/lib/registry/docker/registry/v2/blobs/sha256/53/5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368</span><br><span class=\"line\"><span class=\"variable\">$mkdir</span> layer</span><br><span class=\"line\"><span class=\"variable\">$tar</span> -xf data -C <span class=\"variable\">$_</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> layer/</span><br><span class=\"line\">hello     <span class=\"comment\"># 镜像中该Layer所存储文件</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>(2) 在<code>/var/lib/registry/docker/registry/v2/blobs/sha256/8d/{Digest}</code>目录下文data文件实际是Manifest记录了一个镜像所包含的 layer 信息，当我们 pull 镜像的时候会使用到这个文件;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$pwd</span></span><br><span class=\"line\">/var/lib/registry/docker/registry/v2/blobs/sha256/8d/8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\"><span class=\"variable\">$cat</span> data</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">   <span class=\"comment\"># 镜像 Image Config</span></span><br><span class=\"line\">   <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,</span><br><span class=\"line\">   <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.container.image.v1+json\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 1472,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209\"</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"comment\"># 镜像层Digest</span></span><br><span class=\"line\">   <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,</span><br><span class=\"line\">         <span class=\"string\">\"size\"</span>: 1106793,</span><br><span class=\"line\">         <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>(3) 在<code>/var/lib/registry/docker/registry/v2/blobs/sha256/cb/{digest}</code>目录下的date文件实际存放的是<code>Image config</code>文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"architecture\"</span>: <span class=\"string\">\"amd64\"</span>,</span><br><span class=\"line\">  <span class=\"comment\"># 未来根据这个image启动container时，config里面的配置就是运行container时的默认参数。</span></span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"User\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdout\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStderr\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Env\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Cmd\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"./hello\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:52e976b8f1f3a361b88de03eb6cd8f114a9ce3bece123d31e8d04f116cb4d862\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Volumes\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"WorkingDir\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Entrypoint\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"OnBuild\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"Labels\"</span>: null</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"comment\"># 该镜像时临时容器的ID</span></span><br><span class=\"line\">  <span class=\"string\">\"container\"</span>: <span class=\"string\">\"2247a541f3c65b40fe0b1af8d2bf8ac9d9d9d399e46b2f721a1e203484ad2de4\"</span>,</span><br><span class=\"line\">  <span class=\"comment\"># 对比containner_config与config的内容，字段完全一致验证了config的作用。</span></span><br><span class=\"line\">  <span class=\"string\">\"container_config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"2247a541f3c6\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"User\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStdout\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"AttachStderr\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Env\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Cmd\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"/bin/sh\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"-c\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"#(nop) \"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"CMD [\\\"./hello\\\"]\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:52e976b8f1f3a361b88de03eb6cd8f114a9ce3bece123d31e8d04f116cb4d862\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Volumes\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"WorkingDir\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Entrypoint\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"OnBuild\"</span>: null,</span><br><span class=\"line\">    <span class=\"string\">\"Labels\"</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2020-07-27T14:50:40.305884817Z\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"docker_version\"</span>: <span class=\"string\">\"19.03.9\"</span>,</span><br><span class=\"line\">  <span class=\"comment\"># 构建该镜像的所有历史命令</span></span><br><span class=\"line\">  <span class=\"string\">\"history\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2020-07-27T14:50:40.251387904Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop) COPY file:25386fc86439ade6abebd01bfc3fa9b402ce30141c2dd5a5539d00c3f623b541 in . \"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2020-07-27T14:50:40.305884817Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop)  CMD [\\\"./hello\\\"]\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"empty_layer\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">\"os\"</span>: <span class=\"string\">\"linux\"</span>,</span><br><span class=\"line\">  <span class=\"comment\"># 该镜像包含的layer层的diff id</span></span><br><span class=\"line\">  <span class=\"string\">\"rootfs\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span>: <span class=\"string\">\"layers\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"diff_ids\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"sha256:a3586d8823611b4ebdec8742bedc72e50aecc5da2ff04c3f40c5f955591d7637\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>(4) 在<code>/var/lib/registry/docker/registry/v2/repositories/{镜像名称}/_uploads/</code>目录存放在push镜像过程中的文件数据，当镜像Layer上传完毕后会清空该文件夹；其中的 data 文件上传完毕后会移动到 blobs 目录下，并根据该文件的 sha256 值来进行散列存储到相应的目录下。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 上传过程中的目录结构：</span></span><br><span class=\"line\">_uploads</span><br><span class=\"line\">├── [  53]  0d6c996e-638f-4436-b2b6-54fa7ad430d2</span><br><span class=\"line\">│   ├── [198M]  data</span><br><span class=\"line\">│   ├── [  20]  hashstates</span><br><span class=\"line\">│   │   └── [  15]  sha256</span><br><span class=\"line\">│   │       └── [ 108]  0</span><br><span class=\"line\">│   └── [  20]  startedat</span><br><span class=\"line\">└── [  53]  ba31818e-4217-47ef-ae46-2784c9222614</span><br><span class=\"line\">    ├── [571M]  data</span><br><span class=\"line\">    ├── [  20]  hashstates</span><br><span class=\"line\">    │   └── [  15]  sha256</span><br><span class=\"line\">    │       └── [ 108]  0</span><br><span class=\"line\">    └── [  20]  startedat</span><br><span class=\"line\">6 directories, 6 files</span><br><span class=\"line\"></span><br><span class=\"line\">Tips:上传完镜像之后_uploads 文件夹就会被清空，正常情况下这个文件夹是空的; 但也有异常的时候比如网络抖动导致上传意外中断，该文件夹就可能不为空。</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>(5) 在<code>/var/lib/registry/docker/registry/v2/repositories/{镜像名称}/_mainfest/</code>目录下是镜像上传完成之后由Registry来生成的，并且该目录下的文件都是一个名为Link的文本文件，其值指向blobs目录下与之对应的目录; 在该目录中包含镜像的tags 和 revisions 信息，每一个镜像的每一个Tag对应着于tag名称相同的目录;</p>\n<ul>\n<li>注意点: 镜像的 tag 并不存储在 image config 中而是以目录的形式来形成镜像的 tag，这一点比较奇妙这和我们 Dockerfile 中并不包含镜像名和 tag 一个道理？<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$tree</span> -h 1 _manifests/</span><br><span class=\"line\">_manifests/</span><br><span class=\"line\">├── [  20]  revisions</span><br><span class=\"line\">│   └── [ 150]  sha256</span><br><span class=\"line\">│       ├── [  18]  8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">│       │   └── [  71]  link</span><br><span class=\"line\">│       └── [  18]  b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c</span><br><span class=\"line\">│           └── [  71]  link</span><br><span class=\"line\">└── [  34]  tags</span><br><span class=\"line\">    ├── [  34]  scratch</span><br><span class=\"line\">    │   ├── [  18]  current</span><br><span class=\"line\">    │   │   └── [  71]  link</span><br><span class=\"line\">    │   └── [  20]  index</span><br><span class=\"line\">    │       └── [  78]  sha256</span><br><span class=\"line\">    │           └── [  18]  8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\">    │               └── [  71]  link</span><br><span class=\"line\">    └── [  34]  stage</span><br><span class=\"line\">        ├── [  18]  current</span><br><span class=\"line\">        │   └── [  71]  link</span><br><span class=\"line\">        └── [  20]  index</span><br><span class=\"line\">            └── [  78]  sha256</span><br><span class=\"line\">                └── [  18]  b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c</span><br><span class=\"line\">                    └── [  71]  link</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 补充说明</span></span><br><span class=\"line\">- _revisions 目录里存放了该 repository 历史上上传版本的所有 sha256 编码信息。</span><br><span class=\"line\">- tags/index 目录则列出了该 tag 历史上传的所有版本的 sha256 编码息      </span><br><span class=\"line\">- tags/current 目录下的 link 文件保存了该 tag 目前的 manifest 文件的 sha256 编码对应在 blobs 中的 sha256 目录下的 data 文件，在`拉取镜像时候会首先找到该目录下的links文件中的sha256值对应目录的manifest返回给客户端`;</span><br><span class=\"line\"><span class=\"variable\">$cat</span> /var/lib/registry/docker/registry/v2/repositories/go-hello/_manifests/tags/scratch/current/link</span><br><span class=\"line\">sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e</span><br><span class=\"line\"><span class=\"variable\">$ls</span> -lah /var/lib/registry/docker/registry/v2/blobs/sha256/8d/8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e/</span><br><span class=\"line\">总用量 4.0K</span><br><span class=\"line\">drwxr-xr-x. 2 root root  18 8月   2 09:58 .</span><br><span class=\"line\">drwxr-xr-x. 3 root root  78 8月   2 09:58 ..</span><br><span class=\"line\">-rw-r--r--. 1 root root 528 8月   2 09:58 data</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<h5 id=\"2-基础实例\"><a href=\"#2-基础实例\" class=\"headerlink\" title=\"2.基础实例\"></a>2.基础实例</h5><p>描述:为了更好的了解目录及其文件作用，我们构建一个镜像来存储到本地;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; Dockerfile &lt;&lt;END</span><br><span class=\"line\">FROM alpine</span><br><span class=\"line\">LABEL name=<span class=\"string\">\"test-image\"</span></span><br><span class=\"line\">RUN <span class=\"built_in\">echo</span> <span class=\"string\">\"http://mirrors.ustc.edu.cn/alpine/v3.10/main\"</span> &gt; /etc/apk/repositories; \\</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"http://mirrors.ustc.edu.cn/alpine/v3.10/community\"</span>&gt;&gt; /etc/apk/repositories; \\</span><br><span class=\"line\">apk -v add --no-cache bash; \\</span><br><span class=\"line\">apk -v add --no-cache curl</span><br><span class=\"line\">COPY ./startService.sh /</span><br><span class=\"line\">CMD [<span class=\"string\">\"/bin/bash\"</span>, <span class=\"string\">\"/startService.sh\"</span>]</span><br><span class=\"line\">END</span><br></pre></td></tr></table></figure><br>构建过程输出如下:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$docker</span> build -t <span class=\"built_in\">test</span>-image .</span><br><span class=\"line\">Sending build context to Docker daemon  3.072kB</span><br><span class=\"line\">Step 1/6 : FROM alpine</span><br><span class=\"line\">  ---&gt; 3f53bb00af94              <span class=\"comment\"># 镜像id</span></span><br><span class=\"line\">Step 2/6 : LABEL name=<span class=\"string\">\"test-image\"</span></span><br><span class=\"line\"><span class=\"comment\">#  ---&gt; Running in 3bd6320fc291  # 运行的容器 id</span></span><br><span class=\"line\"><span class=\"comment\"># Removing intermediate container 3bd6320fc291  # 对运行的容器进行写后并移除该容器</span></span><br><span class=\"line\"> ---&gt; bb97dd1fb1a1               <span class=\"comment\"># 镜像id</span></span><br><span class=\"line\">Step 3/6 : RUN apk -v add --no-cache bash</span><br><span class=\"line\"><span class=\"comment\">#  ---&gt; Running in f9987ff57ad7  # 运行的容器 id</span></span><br><span class=\"line\">fetch http://mirrors.ustc.edu.cn/alpine/v3.8/main/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">fetch http://mirrors.ustc.edu.cn/alpine/v3.8/community/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">(1/5) Installing ncurses-terminfo-base (6.1_p20180818-r1)</span><br><span class=\"line\">(2/5) Installing ncurses-terminfo (6.1_p20180818-r1)</span><br><span class=\"line\">(3/5) Installing ncurses-libs (6.1_p20180818-r1)</span><br><span class=\"line\">(4/5) Installing readline (7.0.003-r0)</span><br><span class=\"line\">(5/5) Installing bash (4.4.19-r1)</span><br><span class=\"line\">Executing bash-4.4.19-r1.post-install</span><br><span class=\"line\">Executing busybox-1.28.4-r2.trigger</span><br><span class=\"line\">OK: 18 packages, 136 <span class=\"built_in\">dirs</span>, 2877 files, 13 MiB</span><br><span class=\"line\"><span class=\"comment\"># Removing intermediate container f9987ff57ad7</span></span><br><span class=\"line\"> ---&gt; a5635f1b1d00               <span class=\"comment\"># 镜像id</span></span><br><span class=\"line\">Step 4/6 : RUN apk -v add --no-cache curl</span><br><span class=\"line\"><span class=\"comment\">#  ---&gt; Running in c49fb2e4b311  # 运行的容器 id  </span></span><br><span class=\"line\">fetch http://mirrors.ustc.edu.cn/alpine/v3.8/main/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">fetch http://mirrors.ustc.edu.cn/alpine/v3.8/community/x86_64/APKINDEX.tar.gz</span><br><span class=\"line\">(1/5) Installing ca-certificates (20171114-r3)</span><br><span class=\"line\">(2/5) Installing nghttp2-libs (1.32.0-r0)</span><br><span class=\"line\">(3/5) Installing libssh2 (1.8.0-r3)</span><br><span class=\"line\">(4/5) Installing libcurl (7.61.1-r1)</span><br><span class=\"line\">(5/5) Installing curl (7.61.1-r1)</span><br><span class=\"line\">Executing busybox-1.28.4-r2.trigger</span><br><span class=\"line\">Executing ca-certificates-20171114-r3.trigger</span><br><span class=\"line\">OK: 23 packages, 141 <span class=\"built_in\">dirs</span>, 3040 files, 15 MiB</span><br><span class=\"line\"><span class=\"comment\"># Removing intermediate container c49fb2e4b311</span></span><br><span class=\"line\"> ---&gt; 9156d1521a2f           <span class=\"comment\"># 镜像id</span></span><br><span class=\"line\">Step 5/6 : COPY ./startService.sh /  <span class=\"comment\"># none</span></span><br><span class=\"line\"> ---&gt; 704626646baf           <span class=\"comment\"># 镜像id</span></span><br><span class=\"line\">Step 6/6 : CMD [<span class=\"string\">\"/bin/bash\"</span>, <span class=\"string\">\"/startService.sh\"</span>]</span><br><span class=\"line\"><span class=\"comment\">#  ---&gt; Running in 1c5e6e861264    # 运行的容器 id</span></span><br><span class=\"line\"><span class=\"comment\"># Removing intermediate container 1c5e6e861264</span></span><br><span class=\"line\"> ---&gt; 6cd0a66e83f1           <span class=\"comment\"># 镜像id</span></span><br><span class=\"line\">Successfully built 6cd0a66e83f1  <span class=\"comment\"># 最终生成的test-image镜像ID为 6cd0a66e83f1 </span></span><br><span class=\"line\">Successfully tagged <span class=\"built_in\">test</span>-image:latest</span><br></pre></td></tr></table></figure></p>\n<p>构建过程如图所示:<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200805172819.png\" alt=\"WeiyiGeek.docker\" title=\"\" class=\"\">\n                <p>WeiyiGeek.docker</p>\n            </figure></p>\n<p>首先查看镜像的基本信息然后进行分析本地目录:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker images --digests <span class=\"built_in\">test</span>-image</span><br><span class=\"line\">REPOSITORY          TAG                 DIGEST              IMAGE ID            CREATED             SIZE</span><br><span class=\"line\"><span class=\"built_in\">test</span>-image          latest              &lt;none&gt;              6cd0a66e83f1        About an hour ago </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如前面所述digest是有docker repository生成，因为本地构建完之后并没有推送至远程仓库，所以为None。</span></span><br></pre></td></tr></table></figure></p>\n<p>此时<code>/var/lib/docker/image</code>目录发送如下变化<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">image/</span><br><span class=\"line\">└── overlay2</span><br><span class=\"line\">    ├── distribution</span><br><span class=\"line\">    │   ├── diffid-by-digest</span><br><span class=\"line\">    │   │   └── sha256</span><br><span class=\"line\">    │   │       └── cd784148e3483c2c86c50a48e535302ab0288bebd587accf40b714fffd0646b3</span><br><span class=\"line\">    │   └── v2metadata-by-diffid <span class=\"comment\"># 元数据由diff id</span></span><br><span class=\"line\">    │       └── sha256</span><br><span class=\"line\">    │           └── 7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8</span><br><span class=\"line\">    ├── imagedb   <span class=\"comment\"># 镜像数据库</span></span><br><span class=\"line\">    │   ├── content </span><br><span class=\"line\">    │   │   └── sha256 <span class=\"comment\"># 构建镜像时各Layer层的镜像ID</span></span><br><span class=\"line\">    │   │       ├── 3f53bb00af943dfdf815650be70c0fa7b426e56a66f5e3362b47a129d57d5991 <span class=\"comment\"># Alpine</span></span><br><span class=\"line\">    │   │       ├── 6cd0a66e83f133a2bad37103ed03f6480330fa3c469368eb5871320996d3b924 <span class=\"comment\"># test-Images</span></span><br><span class=\"line\">    │   │       ├── 704626646baf8bdea82da237819cded076a0852eb97dba2fc731569dd85ae836</span><br><span class=\"line\">    │   │       ├── 9156d1521a2fd50d972e1e1abc30d37df7c8e8f7825ca5955170f3b5441b3341</span><br><span class=\"line\">    │   │       ├── a5635f1b1d0078cd926f21ef3ed77b357aa899ac0c8bf80cae51c37129167e3a</span><br><span class=\"line\">    │   │       └── bb97dd1fb1a10b717655594950efb4605ff0d3f2f631feafc4558836c2b34c3c</span><br><span class=\"line\">    │   └── metadata <span class=\"comment\"># 元数据 (在构建test-image之前，metadata目录为空，因为alpine没有parent) 在build之后新增了5个目录，分别对应docker build test-image所产生的5个镜像，每一层以上一层为parent，即parent文件中存储了上一层image id。</span></span><br><span class=\"line\">    │       └── sha256</span><br><span class=\"line\">    │           ├── 6cd0a66e83f133a2bad37103ed03f6480330fa3c469368eb5871320996d3b924</span><br><span class=\"line\">    │           │   ├── lastUpdated</span><br><span class=\"line\">    │           │   └── parent  <span class=\"comment\"># 源(父)镜像id</span></span><br><span class=\"line\">    │           ├── 704626646baf8bdea82da237819cded076a0852eb97dba2fc731569dd85ae836</span><br><span class=\"line\">    │           │   └── parent</span><br><span class=\"line\">    │           ├── 9156d1521a2fd50d972e1e1abc30d37df7c8e8f7825ca5955170f3b5441b3341</span><br><span class=\"line\">    │           │   └── parent</span><br><span class=\"line\">    │           ├── a5635f1b1d0078cd926f21ef3ed77b357aa899ac0c8bf80cae51c37129167e3a</span><br><span class=\"line\">    │           │   └── parent</span><br><span class=\"line\">    │           └── bb97dd1fb1a10b717655594950efb4605ff0d3f2f631feafc4558836c2b34c3c</span><br><span class=\"line\">    │               └── parent</span><br><span class=\"line\">    ├── layerdb <span class=\"comment\"># 层数据库</span></span><br><span class=\"line\">    │   ├── mounts <span class=\"comment\"># 当由镜像生成容器时，该目录下会生成容器的可读可写两个layer，可读即为由镜像生成，而可写就是未来对容器的修改都会放在</span></span><br><span class=\"line\">    │   ├── sha256 <span class=\"comment\"># 镜像 Layer的diff id（但是实际只有四层）</span></span><br><span class=\"line\">    │   │   ├── 0e88764cdf90e8a5d6597b2d8e65b8f70e7b62982b0aee934195b54600320d47</span><br><span class=\"line\">    │   │   │   ├── cache-id</span><br><span class=\"line\">    │   │   │   ├── diff</span><br><span class=\"line\">    │   │   │   ├── parent</span><br><span class=\"line\">    │   │   │   ├── size</span><br><span class=\"line\">    │   │   │   └── tar-split.json.gz</span><br><span class=\"line\">    │   │   ├── 7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8</span><br><span class=\"line\">    │   │   │   ├── cache-id</span><br><span class=\"line\">    │   │   │   ├── diff</span><br><span class=\"line\">    │   │   │   ├── size</span><br><span class=\"line\">    │   │   │   └── tar-split.json.gz</span><br><span class=\"line\">    │   │   ├── 80fe1abae43103e3be54ac2813114d1dea6fc91454a3369104b8dd6e2b1363f5</span><br><span class=\"line\">    │   │   │   ├── cache-id</span><br><span class=\"line\">    │   │   │   ├── diff</span><br><span class=\"line\">    │   │   │   ├── parent</span><br><span class=\"line\">    │   │   │   ├── size</span><br><span class=\"line\">    │   │   │   └── tar-split.json.gz</span><br><span class=\"line\">    │   │   └── db7c15c2f03f63a658285a55edc0a0012ccd0033f4695d4b428b1b464637e655</span><br><span class=\"line\">    │   │       ├── cache-id</span><br><span class=\"line\">    │   │       ├── diff</span><br><span class=\"line\">    │   │       ├── parent</span><br><span class=\"line\">    │   │       ├── size</span><br><span class=\"line\">    │   │       └── tar-split.json.gz</span><br><span class=\"line\">    │   └── tmp</span><br><span class=\"line\">    └── repositories.json</span><br></pre></td></tr></table></figure><br>在imagedb的<code>content</code>和<code>metadata</code>下增加了build过程中产生的镜像（镜像ID能够一一对应），在layerdb下增加了三个Layer，目前还看不出来关联关系，后续分析。</p>\n<ul>\n<li><p>Step1.先从<code>repositories.json</code>文件看起</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$cat</span> image/overlay2/repositories.json | python -m json.tool</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"Repositories\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"alpine\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"alpine:latest\"</span>: <span class=\"string\">\"sha256:3f53bb00af943dfdf815650be70c0fa7b426e56a66f5e3362b47a129d57d5991\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"alpine@sha256:46e71df1e5191ab8b8034c5189e325258ec44ea739bba1e5645cff83c9048ff1\"</span>: <span class=\"string\">\"sha256:3f53bb00af943dfdf815650be70c0fa7b426e56a66f5e3362b47a129d57d5991\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"comment\"># 镜像ID : 增加了test-image该项包含其tag和id。</span></span><br><span class=\"line\">        <span class=\"string\">\"test-image\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"test-image:latest\"</span>: <span class=\"string\">\"sha256:6cd0a66e83f133a2bad37103ed03f6480330fa3c469368eb5871320996d3b924\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step2.以test-image为例（目前的最底层镜像），查看其描述信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"architecture\"</span>: <span class=\"string\">\"amd64\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"ArgsEscaped\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"string\">\"AttachStderr\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"AttachStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"AttachStdout\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Cmd\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"/bin/bash\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"/startService.sh\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Entrypoint\"</span>: null,</span><br><span class=\"line\">        <span class=\"string\">\"Env\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:704626646baf8bdea82da237819cded076a0852eb97dba2fc731569dd85ae836\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Labels\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"name\"</span>: <span class=\"string\">\"test-image\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"OnBuild\"</span>: null,</span><br><span class=\"line\">        <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"User\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Volumes\"</span>: null,</span><br><span class=\"line\">        <span class=\"string\">\"WorkingDir\"</span>: <span class=\"string\">\"\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"comment\"># 容器ID可以与图XX中生成该image的容器ID对应上即最后一次构建镜像时的容器ID;</span></span><br><span class=\"line\">    <span class=\"string\">\"container\"</span>: <span class=\"string\">\"1c5e6e861264654f79a190eba5157dd4dedce59ab3de098a3625fb4e5b6f1d98\"</span>,</span><br><span class=\"line\">    <span class=\"comment\"># 容器配置状态实际是执行完dockerfile中命令之后的容器状态;</span></span><br><span class=\"line\">    <span class=\"string\">\"container_config\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"ArgsEscaped\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"string\">\"AttachStderr\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"AttachStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"AttachStdout\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Cmd\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"/bin/sh\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"-c\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"#(nop) \"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"CMD [\\\"/bin/bash\\\" \\\"/startService.sh\\\"]\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Entrypoint\"</span>: null,</span><br><span class=\"line\">        <span class=\"string\">\"Env\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"1c5e6e861264\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:704626646baf8bdea82da237819cded076a0852eb97dba2fc731569dd85ae836\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Labels\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"name\"</span>: <span class=\"string\">\"test-image\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"OnBuild\"</span>: null,</span><br><span class=\"line\">        <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">\"User\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"Volumes\"</span>: null,</span><br><span class=\"line\">        <span class=\"string\">\"WorkingDir\"</span>: <span class=\"string\">\"\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2019-01-01T02:29:19.701494089Z\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"docker_version\"</span>: <span class=\"string\">\"18.09.0\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"history\"</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2018-12-21T00:21:29.97055571Z\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop) ADD file:2ff00caea4e83dfade726ca47e3c795a1e9acb8ac24e392785c474ecf9a621f2 in / \"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2018-12-21T00:21:30.122610396Z\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop)  CMD [\\\"/bin/sh\\\"]\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"empty_layer\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2019-01-01T02:29:06.530296297Z\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop)  LABEL name=test-image\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"empty_layer\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2019-01-01T02:29:14.182236016Z\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c apk -v add --no-cache bash\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2019-01-01T02:29:19.327280058Z\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c apk -v add --no-cache curl\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2019-01-01T02:29:19.549474383Z\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop) COPY file:fff66db7f2d773b25215edcc9d5697d84813835e3b731e5a6afe9a9b9647ecec in / \"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2019-01-01T02:29:19.701494089Z\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop)  CMD [\\\"/bin/bash\\\" \\\"/startService.sh\\\"]\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"empty_layer\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"os\"</span>: <span class=\"string\">\"linux\"</span>,</span><br><span class=\"line\">    <span class=\"comment\"># test-image镜像包含的Layer的diff id (四层)</span></span><br><span class=\"line\">    <span class=\"comment\"># 在 LABEL name=\"test-image\"和CMD [\"/bin/bash\", \"/startService.sh\"] 这两行并未产生新的Layer由于其并未改变文件系统中任何文件只是写在了Image-Config中;</span></span><br><span class=\"line\">    <span class=\"string\">\"rootfs\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"diff_ids\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"sha256:b1ddbff022577cd249a074285a1a7eb76d7c9139132ba5aa4272fc115dfa9e36\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"sha256:9edc93f4dcf640f272ed73f933863dbefae6719745093d09c6c6908f402b1c34\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"sha256:a6c8828ba4b58628284f783d3c918ac379ae2aba0830f4c926a330842361ffb6\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">\"type\"</span>: <span class=\"string\">\"layers\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>事实上如果我们认为镜像是一个打包的静态OS，那么Layer可以认为是描述该OS的fs变化，<code>即文件系统中文件或者目录发生的改变</code>，很明显上述两行命令并不会引起fs的变化只是会写入该镜像的config中，<code>在生成容器时读取即可自然也就不存在diff id</code>。<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200806094310.png\" alt=\"WeiyiGeek.diff-id\" title=\"\" class=\"\">\n                <p>WeiyiGeek.diff-id</p>\n            </figure></p>\n<ul>\n<li>Step3.其次目前Layer已经增加至4个，这与我们上一节中看到的test-image的rootfs配置中有4个layer diif id能够对应上，然后很显然除了第一层的”7bff100f35cb”能对应上其他三个完全不同；<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ChainID(A) = DiffID(A) = sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8</span><br></pre></td></tr></table></figure>\n进一步研究才知道这里目录名其实是layer的chain id，而非diff id，关于这两这个的区别，我们可以理解为<code>diff id用来描述单个变化</code> 而 <code>chain id用来便于一些列的变化</code>，</li>\n</ul>\n<p>重点:<code>diff id和chain id</code>之间的计算公式可以在image-spec中看到。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ChainID(A) = DiffID(A)</span><br><span class=\"line\">ChainID(A|B) = Digest(ChainID(A) + <span class=\"string\">\" \"</span> + DiffID(B))</span><br><span class=\"line\">ChainID(A|B|C) = Digest(ChainID(A|B) + <span class=\"string\">\" \"</span> + DiffID(C))</span><br></pre></td></tr></table></figure><br>此处以test-image的rootfs验证分析他们是如何关联的:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\"rootfs\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"comment\"># 文件系统差异标识</span></span><br><span class=\"line\">    <span class=\"string\">\"diff_ids\"</span>: [</span><br><span class=\"line\">        <span class=\"string\">\"sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8\"</span>,  <span class=\"comment\"># 该层可以对应上dir</span></span><br><span class=\"line\">        <span class=\"string\">\"sha256:b1ddbff022577cd249a074285a1a7eb76d7c9139132ba5aa4272fc115dfa9e36\"</span>,  <span class=\"comment\"># 通过基础层 + diff_ids 获得Layer层摘要</span></span><br><span class=\"line\">        <span class=\"string\">\"sha256:9edc93f4dcf640f272ed73f933863dbefae6719745093d09c6c6908f402b1c34\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"sha256:a6c8828ba4b58628284f783d3c918ac379ae2aba0830f4c926a330842361ffb6\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span>: <span class=\"string\">\"layers\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>链ID计算公式:因为chainid的一层是依赖上一层的所以最后算出来的rootfs是统一的;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 公式 </span></span><br><span class=\"line\">Chaninid(1) = diffid(1) chainid(n) = sha256(chain(n-1) diffid(n) )</span><br><span class=\"line\">ChainID(A|B) = Digest(ChainID(A) + <span class=\"string\">\" \"</span> + DiffID(B))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 链ID 与 差异ID</span></span><br><span class=\"line\">ChainID(A) = sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8</span><br><span class=\"line\">DiffID(B) = sha256:b1ddbff022577cd249a074285a1a7eb76d7c9139132ba5aa4272fc115dfa9e36</span><br><span class=\"line\">DiffID(C) = sha256:9edc93f4dcf640f272ed73f933863dbefae6719745093d09c6c6908f402b1c34</span><br><span class=\"line\">DiffID(D) = sha256:a6c8828ba4b58628284f783d3c918ac379ae2aba0830f4c926a330842361ffb6</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果：</span></span><br><span class=\"line\"><span class=\"comment\"># ChainID(A|B) = sha256:db7c15c2f03f63a658285a55edc0a0012ccd0033f4695d4b428b1b464637e655</span></span><br><span class=\"line\"><span class=\"variable\">$echo</span> -n <span class=\"string\">\"sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8 sha256:b1ddbff022577cd249a074285a1a7eb76d7c9139132ba5aa4272fc115dfa9e36\"</span> | sha256sum -</span><br><span class=\"line\">db7c15c2f03f63a658285a55edc0a0012ccd0033f4695d4b428b1b464637e655  -  <span class=\"comment\"># sha256下面引用 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#chainID(A|B|C) = sha256:0e88764cdf90e8a5d6597b2d8e65b8f70e7b62982b0aee934195b54600320d47</span></span><br><span class=\"line\"><span class=\"variable\">$echo</span> -n <span class=\"string\">\"sha256:db7c15c2f03f63a658285a55edc0a0012ccd0033f4695d4b428b1b464637e655 sha256:9edc93f4dcf640f272ed73f933863dbefae6719745093d09c6c6908f402b1c34\"</span> | sha256sum -</span><br><span class=\"line\">0e88764cdf90e8a5d6597b2d8e65b8f70e7b62982b0aee934195b54600320d47  -</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 计算流程如上</span></span><br><span class=\"line\"><span class=\"comment\"># chainID(A|B|C|D) = sha256:80fe1abae43103e3be54ac2813114d1dea6fc91454a3369104b8dd6e2b1363f5</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200808224518.png\" alt=\"WeiyiGeek.ChainID\" title=\"\" class=\"\">\n                <p>WeiyiGeek.ChainID</p>\n            </figure>\n<ul>\n<li>Step4.在 <code>imagedb/overlay2/destribution</code> 目录中初始文件如下:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@docker-learn overlay2]<span class=\"variable\">$tree</span> distribution/</span><br><span class=\"line\">distribution/</span><br><span class=\"line\">├── diffid-by-digest</span><br><span class=\"line\">│   └── sha256</span><br><span class=\"line\">│       └── cd784148e3483c2c86c50a48e535302ab0288bebd587accf40b714fffd0646b3</span><br><span class=\"line\">└── v2metadata-by-diffid</span><br><span class=\"line\">    └── sha256</span><br><span class=\"line\">        └── 7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8</span><br><span class=\"line\">4 directories, 2 files</span><br></pre></td></tr></table></figure>\n<ul>\n<li>目前来看，destribution目录和只有alpine镜像时并没有什么区别，这是因为digest是由镜像仓库生成，本地构建的镜像在没有push到仓库之前，自然也就没有digest。<br>使用docker push命令将test-image推送至dockerhub。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@docker-learn distribution]<span class=\"comment\"># docker push backbp/test-image:lasted</span></span><br><span class=\"line\">The push refers to repository [docker.io/backbp/<span class=\"built_in\">test</span>-image]  <span class=\"comment\"># 从上层依次传输到下层</span></span><br><span class=\"line\">a6c8828ba4b5: Pushed </span><br><span class=\"line\">9edc93f4dcf6: Pushed </span><br><span class=\"line\">b1ddbff02257: Pushed </span><br><span class=\"line\">7bff100f35cb: Mounted from library/alpine </span><br><span class=\"line\">lasted: digest: sha256:3dc66a43c28ea3e994e4abf6a2d04c7027a9330e8eeab5c609e4971a8c58f0b0 size: 1156</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 此时 distribution/ 文件如下:</span></span><br><span class=\"line\">distribution/</span><br><span class=\"line\">├── diffid-by-digest</span><br><span class=\"line\">│   └── sha256</span><br><span class=\"line\">│       ├── 2826782ee82560ec5f90a8a9da80880d48dd4036763f5250024fab5b3ef8e8cf</span><br><span class=\"line\">│       ├── 8e905c02e6908fbb0e591cea285470208920d32408735bd6a8fcaf85ffba9089</span><br><span class=\"line\">│       ├── a5bec9983f6902f4901b38735db9c427190ffcb3734c84ee233ea391da81081b</span><br><span class=\"line\">│       └── cd784148e3483c2c86c50a48e535302ab0288bebd587accf40b714fffd0646b3</span><br><span class=\"line\">└── v2metadata-by-diffid</span><br><span class=\"line\">    └── sha256</span><br><span class=\"line\">        ├── 7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8  <span class=\"comment\"># push 4 - ChianID(A)</span></span><br><span class=\"line\">        ├── 9edc93f4dcf640f272ed73f933863dbefae6719745093d09c6c6908f402b1c34  <span class=\"comment\"># push 2 - DiffID(C)</span></span><br><span class=\"line\">        ├── a6c8828ba4b58628284f783d3c918ac379ae2aba0830f4c926a330842361ffb6  <span class=\"comment\"># push 1 - DiffID(D) </span></span><br><span class=\"line\">        └── b1ddbff022577cd249a074285a1a7eb76d7c9139132ba5aa4272fc115dfa9e36  <span class=\"comment\"># push 3 - DiffID(B)</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<p><em>补充知识点:</em><br>Q: 1.docker tag命令发生了什么?</p>\n<blockquote>\n<p>答:我们还是采用上面的test-image生成一个新的tag为例进行实验查看得知,两个tag的镜像都指向同一个image id，所以这个命令相当于只有修改了repositories.json类比于软链接;</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@docker-learn overlay2]<span class=\"variable\">$cat</span> repositories.json | python -m json.tool</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"Repositories\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"alpine\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"alpine:latest\"</span>: <span class=\"string\">\"sha256:3f53bb00af943dfdf815650be70c0fa7b426e56a66f5e3362b47a129d57d5991\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"alpine@sha256:46e71df1e5191ab8b8034c5189e325258ec44ea739bba1e5645cff83c9048ff1\"</span>: <span class=\"string\">\"sha256:3f53bb00af943dfdf815650be70c0fa7b426e56a66f5e3362b47a129d57d5991\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"test-image\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"test-image:latest\"</span>: <span class=\"string\">\"sha256:6cd0a66e83f133a2bad37103ed03f6480330fa3c469368eb5871320996d3b924\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">\"test-image-tag\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">\"test-image-tag:latest\"</span>: <span class=\"string\">\"sha256:6cd0a66e83f133a2bad37103ed03f6480330fa3c469368eb5871320996d3b924\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p>Q: 2.Image Size是如何计算的？<br>答: 上述的alpine镜像和test-image镜像大小分别是：4.41M和9.88M。为了更准确的分析，可以使用docker inspect 镜像查看详细大小，分别为4413428和9876099。<br>再次查看每层Layer的大小(layerdb/layer chain id/size)，分别为<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 每层大小</span></span><br><span class=\"line\">Layer1：4413428</span><br><span class=\"line\">Layer2：3815516</span><br><span class=\"line\">Layer3：1647117</span><br><span class=\"line\">Layer4：38</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 镜像计算</span></span><br><span class=\"line\">alpine     只有一层，所以image size与Layer size相等；</span><br><span class=\"line\"><span class=\"built_in\">test</span>-image 有四层，所以image size = sum(Layer1+Layer2+Layer3+Layer4)=9876099</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>Q: 3.Dockerfile 指令之<code>apk del .build-deps</code>对Layer层Size的影响?<br>答: 如下Dockerfile 指令优化并减少了生成镜像的大小，分析原因如下将一部分命令放在一个RUN指令中运行会在同一个Layer执行其指令中的多条语句从而不会在其它层进行执行，这样所做的好处就是节约空间，此处采用一个虚拟目录<code>.build-deps</code>的安装和卸载相对于上一层而言根本就不存在，这是由于<code>OCI Image的原理所致，只需要记住的是每一个Layer记录的是与上一层Layer相比的变化</code>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 灵魂重点(DockerFile 优化必备)</span></span><br><span class=\"line\">RUN apk -v add --no-cache --virtual .build-deps gcc make &amp;&amp; \\</span><br><span class=\"line\">make clean &amp;&amp; make &amp;&amp; make install &amp;&amp; \\</span><br><span class=\"line\">apk del .build-deps</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><em>总结本章:</em></p>\n<ul>\n<li>1.在image/overlay2/imagedb目录中，保存的Image的配置信息在content目录中，并且以image id为文件名存储，Image之间关联信息在metadata中，以parent文件存储。我们根据image生成容器的时候可以生成了一个文件系统，但是上述这些信息并不包含fs的数据。<br>因为真正的fs数据是存储在Layer中的<code>即Layer的信息存储在layerdb目录下</code>。</li>\n<li>2.因此test-image的第二层Layer对应的目录为：layerdb/sha256/db7c15c2f03f63a658285a55edc0a0012ccd0033f4695d4b428b1b464637e655，与上一节中相比多了parent，包含了上一层Layer的chain id，查看该Layer的信息：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@docker-learn sha256]<span class=\"variable\">$ls</span> db7c15c2f03f63a658285a55edc0a0012ccd0033f4695d4b428b1b464637e655/</span><br><span class=\"line\">cache-id  diff  parent  size  tar-split.json.gz</span><br><span class=\"line\"><span class=\"comment\"># parent = sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h4 id=\"0x01-Dockerd-语法参数\"><a href=\"#0x01-Dockerd-语法参数\" class=\"headerlink\" title=\"0x01 Dockerd 语法参数\"></a>0x01 Dockerd 语法参数</h4><p>描述:通过前面Docker的学习我们知道了它是一个C/S架构, 即Daemon CLI (dockerd)它是docker的服务端它是管理容器的持久进程;</p>\n<p>Docker为守护进程和客户端使用不同的二进制文件,要运行守护进程输入dockerd。</p>\n<p>Dockerd基础语法参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法:容器的自给自足运行时。</span></span><br><span class=\"line\">Usage: dockerd COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数选项</span></span><br><span class=\"line\">Options:</span><br><span class=\"line\">  --add-runtime runtime                   Register an additional OCI compatible runtime (default [])</span><br><span class=\"line\">  --allow-nondistributable-artifacts list Allow push of nondistributable artifacts to registry</span><br><span class=\"line\">  --api-cors-header string                Set CORS headers <span class=\"keyword\">in</span> the Engine API</span><br><span class=\"line\">  --authorization-plugin list             Authorization plugins to load</span><br><span class=\"line\">  --bip string                            Specify network bridge IP</span><br><span class=\"line\">-b, --bridge string                         Attach containers to a network bridge</span><br><span class=\"line\">  --cgroup-parent string                  Set parent cgroup <span class=\"keyword\">for</span> all containers</span><br><span class=\"line\">  --cluster-advertise string              Address or interface name to advertise</span><br><span class=\"line\">  --cluster-store string                  URL of the distributed storage backend</span><br><span class=\"line\">  --cluster-store-opt map                 Set cluster store options (default map[])</span><br><span class=\"line\">  --config-file string                    Daemon configuration file (default <span class=\"string\">\"/etc/docker/daemon.json\"</span>)</span><br><span class=\"line\">  --containerd string                     containerd grpc 地址</span><br><span class=\"line\">  --cpu-rt-period int                     以微秒为单位限制CPU的实时周期</span><br><span class=\"line\">  --cpu-rt-runtime int                    以微秒为单位限制CPU的实时运行时间</span><br><span class=\"line\">  --cri-containerd                        以cri启动containerd</span><br><span class=\"line\">  --data-root string                      Root directory of persistent Docker state (default <span class=\"string\">\"/var/lib/docker\"</span>)</span><br><span class=\"line\">-D, --debug                                 Enable debug mode</span><br><span class=\"line\">  --default-address-pool pool-options     Default address pools <span class=\"keyword\">for</span> node specific <span class=\"built_in\">local</span> networks</span><br><span class=\"line\">  --default-gateway ip                    Container default gateway IPv4 address</span><br><span class=\"line\">  --default-gateway-v6 ip                 Container default gateway IPv6 address</span><br><span class=\"line\">  --default-ipc-mode string               Default mode <span class=\"keyword\">for</span> containers ipc (<span class=\"string\">\"shareable\"</span> | <span class=\"string\">\"private\"</span>) (default <span class=\"string\">\"private\"</span>)</span><br><span class=\"line\">  --default-runtime string                Default OCI runtime <span class=\"keyword\">for</span> containers (default <span class=\"string\">\"runc\"</span>)</span><br><span class=\"line\">  --default-shm-size bytes                Default shm size <span class=\"keyword\">for</span> containers (default 64MiB)</span><br><span class=\"line\">  --default-ulimit <span class=\"built_in\">ulimit</span>                 Default ulimits <span class=\"keyword\">for</span> containers (default [])</span><br><span class=\"line\">  --dns list                              DNS server to use</span><br><span class=\"line\">  --dns-opt list                          DNS options to use</span><br><span class=\"line\">  --dns-search list                       DNS search domains to use</span><br><span class=\"line\">  --<span class=\"built_in\">exec</span>-opt list                         Runtime execution options</span><br><span class=\"line\">  --<span class=\"built_in\">exec</span>-root string                      Root directory <span class=\"keyword\">for</span> execution state files (default <span class=\"string\">\"/var/run/docker\"</span>)</span><br><span class=\"line\">  --experimental                          注意:在一台主机上运行多个守护进程被认为是“试验性的”。</span><br><span class=\"line\">  --fixed-cidr string                     IPv4 subnet <span class=\"keyword\">for</span> fixed IPs</span><br><span class=\"line\">  --fixed-cidr-v6 string                  IPv6 subnet <span class=\"keyword\">for</span> fixed IPs</span><br><span class=\"line\">-G, --group string                          Group <span class=\"keyword\">for</span> the unix socket (default <span class=\"string\">\"docker\"</span>)</span><br><span class=\"line\">  --<span class=\"built_in\">help</span>                                  Print usage</span><br><span class=\"line\">-H, --host list                             Daemon socket(s) to connect to</span><br><span class=\"line\">  --icc                                   Enable inter-container communication (default <span class=\"literal\">true</span>)</span><br><span class=\"line\">  --init                                  Run an init <span class=\"keyword\">in</span> the container to forward signals and reap processes</span><br><span class=\"line\">  --init-path string                      Path to the docker-init binary</span><br><span class=\"line\">  --insecure-registry list                Enable insecure registry communication</span><br><span class=\"line\">  --ip ip                                 Default IP when binding container ports (default 0.0.0.0)</span><br><span class=\"line\">  --ip-forward                            Enable net.ipv4.ip_forward (default <span class=\"literal\">true</span>)</span><br><span class=\"line\">  --ip-masq                               Enable IP masquerading (default <span class=\"literal\">true</span>)</span><br><span class=\"line\">  --iptables                              Enable addition of iptables rules (default <span class=\"literal\">true</span>)</span><br><span class=\"line\">  --ipv6                                  Enable IPv6 networking</span><br><span class=\"line\">  --label list                            Set key=value labels to the daemon</span><br><span class=\"line\">  --live-restore                         当容器仍在运行时，启用docker的活还原</span><br><span class=\"line\">  --<span class=\"built_in\">log</span>-driver string                     Default driver <span class=\"keyword\">for</span> container logs (default <span class=\"string\">\"json-file\"</span>)</span><br><span class=\"line\">-l, --<span class=\"built_in\">log</span>-level string                      Set the logging level (<span class=\"string\">\"debug\"</span>|<span class=\"string\">\"info\"</span>|<span class=\"string\">\"warn\"</span>|<span class=\"string\">\"error\"</span>|<span class=\"string\">\"fatal\"</span>) (default <span class=\"string\">\"info\"</span>)</span><br><span class=\"line\">  --<span class=\"built_in\">log</span>-opt map                           Default <span class=\"built_in\">log</span> driver options <span class=\"keyword\">for</span> containers (default map[])</span><br><span class=\"line\">  --max-concurrent-downloads int          设置每次拉取的最大并发下载(默认为3)</span><br><span class=\"line\">  --max-concurrent-uploads int            设置每个推送的最大并发上传数(默认为5)</span><br><span class=\"line\">  --metrics-addr string                   Set default address and port to serve the metrics api on</span><br><span class=\"line\">  --mtu int                               Set the containers network MTU</span><br><span class=\"line\">  --network-control-plane-mtu int         Network Control plane MTU (default 1500)</span><br><span class=\"line\">  --no-new-privileges                     Set no-new-privileges by default <span class=\"keyword\">for</span> new containers</span><br><span class=\"line\">  --node-generic-resource list            Advertise user-defined resource</span><br><span class=\"line\">  --oom-score-adjust int                  为守护进程设置oom_score_adj(默认值为-500)</span><br><span class=\"line\">-p, --pidfile string                      Path to use <span class=\"keyword\">for</span> daemon PID file (default <span class=\"string\">\"/var/run/docker.pid\"</span>)</span><br><span class=\"line\">  --raw-logs                              Full timestamps without ANSI coloring</span><br><span class=\"line\">  --registry-mirror list                  Preferred Docker registry mirror</span><br><span class=\"line\">  --rootless                              Enable rootless mode; typically used with RootlessKit (experimental)</span><br><span class=\"line\">  --seccomp-profile string                Path to seccomp profile</span><br><span class=\"line\">  --selinux-enabled                       Enable selinux support</span><br><span class=\"line\">  --shutdown-timeout int                  Set the default shutdown timeout (default 15)</span><br><span class=\"line\">-s, --storage-driver string                 Storage driver to use</span><br><span class=\"line\">  --storage-opt list                      Storage driver options</span><br><span class=\"line\">  --swarm-default-advertise-addr string   Set default address or interface <span class=\"keyword\">for</span> swarm advertised address</span><br><span class=\"line\">  --tls                                   Use TLS; implied by --tlsverify</span><br><span class=\"line\">  --tlscacert string                      Trust certs signed only by this CA (default <span class=\"string\">\"~/.docker/ca.pem\"</span>)</span><br><span class=\"line\">  --tlscert string                        Path to TLS certificate file (default <span class=\"string\">\"~/.docker/cert.pem\"</span>)</span><br><span class=\"line\">  --tlskey string                         Path to TLS key file (default <span class=\"string\">\"~/.docker/key.pem\"</span>)</span><br><span class=\"line\">  --tlsverify                             Use TLS and verify the remote</span><br><span class=\"line\">  --userland-proxy                        Use userland proxy <span class=\"keyword\">for</span> loopback traffic (default <span class=\"literal\">true</span>)</span><br><span class=\"line\">  --userland-proxy-path string            Path to the userland proxy binary</span><br><span class=\"line\">  --userns-remap string                   User/Group setting <span class=\"keyword\">for</span> user namespaces</span><br><span class=\"line\">-v, --version                              版本信息</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h5 id=\"基础选项讲解\"><a href=\"#基础选项讲解\" class=\"headerlink\" title=\"基础选项讲解\"></a>基础选项讲解</h5><ul>\n<li>docker 服务端调试模式Debug开启:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># docker.service</span></span><br><span class=\"line\">dockerd -D --debug</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># docker.service</span></span><br><span class=\"line\">dockerd --experimental <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># daemon.json file</span></span><br><span class=\"line\"><span class=\"string\">\"experimental\"</span>: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>守护进程套接字选项:<br>Docker守护进程可以通过三种不同类型的套接字侦听Docker引擎API请求:unix、tcp和fd，并且支持侦听多个套接字在同一时间使用多个-H选项。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 默认情况下在/var/run/docker创建一个unix域套接字(或IPC套接字),需要root权限或docker组成员资格。</span></span><br><span class=\"line\"><span class=\"comment\"># 如有需要远程访问Docker Deamon建议使用Nginx等进行配置HTTPS加密套接字(TLS1.0&gt;=), 通常使用端口2375进行非加密，而使用端口2376与守护进程进行加密通信。</span></span><br><span class=\"line\"><span class=\"comment\"># Run docker in daemon mode</span></span><br><span class=\"line\">$ sudo &lt;path to&gt;/dockerd -H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock &amp;</span><br><span class=\"line\">$ sudo dockerd -H unix:///var/run/docker.sock -H tcp://192.168.59.106 -H tcp://10.10.10.2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 在基于Systemd的系统上，您可以通过激活Systemd套接字与守护进程通信，使用dockerd -H fd://。</span></span><br><span class=\"line\">使用fd://将工作完美的大多数设置，但你也可以指定个别套接字: dockerd -H fd://3，如果没有找到指定的套接字激活的文件，那么Docker将退出。</span><br><span class=\"line\"><span class=\"comment\"># 您可以在Docker源树中找到使用Systemd套接字激活Docker和Systemd的示例。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) Docker客户机将使用DOCKER_HOST环境变量或者为客户机设置-H标志</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> DOCKER_HOST=<span class=\"string\">\"tcp://0.0.0.0:2375\"</span> \\</span><br><span class=\"line\">  <span class=\"built_in\">export</span> DOCKER_TLS_VERIFY=1 \\</span><br><span class=\"line\">  &amp;&amp; docker ps &amp;&amp; docker --tlsverify ps</span><br><span class=\"line\"></span><br><span class=\"line\">$ docker -H tcp://127.0.0.1:2375 pull ubuntu</span><br><span class=\"line\">$ docker -H :5555 pull ubuntu</span><br><span class=\"line\">$ docker -H tcp://0.0.0.0:2375 ps</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 从Docker 18.09开始，Docker客户端支持通过SSH连接到远程守护进程可以配置公钥认证远程主机:</span></span><br><span class=\"line\">$ docker -H ssh://me@example.com ps</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>存储驱动器:<br>描述:在Linux上Docker守护进程支持几种不同的图像层存储驱动程序:<code>aufs、devicemapper、btrfs、zfs、overlay 和 overlay2</code>。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aufs : 最早的存储驱动基于Linux补丁内核集(存在未知位置BUG)，但是允许容器共享可执行内存和共享库内存</span><br><span class=\"line\">devicemapper : 驱动程序使用瘦配置和写上复制(CoW)快照,默认情况下这些块设备是通过使用自动创建的稀疏文件的环回挂载来自动创建的（先已经被overlay2所替代）</span><br><span class=\"line\">btrfs : 与上者类似但是不同的是它不能在设备之间共享可执行内存</span><br><span class=\"line\">zfs : 该驱动程序可能不如btrfs快但在稳定性方面有较长的记录。由于只有一个副本，克隆之间的共享块只缓存一次。</span><br><span class=\"line\">overlay : 是一个非常快的union文件系统。它现在已经合并到3.18.0的主Linux内核中。覆盖也支持页面缓存共享，这意味着访问同一个文件的多个容器可以共享一个页面缓存条目(或多个条目)，这使得覆盖和aufs驱动程序一样高效。</span><br><span class=\"line\">overlay2 : 使用相同的快速union文件系统，但是利用了Linux内核4.0中添加的其他特性，以避免过度使用inode。(调用dockerd -s overlay2来使用它。-当前默认)</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>基础示例:devicemapper<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 指定要用于thin-pool的自定义块存储设</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.thinpooldev=/dev/mapper/thin-pool</span><br><span class=\"line\"><span class=\"comment\"># 设置块设备进行存储</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.directlvm_device=/dev/xvdf</span><br><span class=\"line\"><span class=\"comment\"># 设置在块设备传递到用于存储的百分比。</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.thinp_percent=95</span><br><span class=\"line\"><span class=\"comment\"># 设置传入的块设备的百分比，用于元数据存储。</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.thinp_metapercent=1</span><br><span class=\"line\"><span class=\"comment\"># 设置lvm尝试自动扩展可用空间之前使用的空间百分比值[100 =禁用]</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.thinp_autoextend_threshold=80</span><br><span class=\"line\"><span class=\"comment\"># 设置值百分比值，当lvm尝试自动扩展可用空间时增加瘦池[100 =禁用]</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.thinp_autoextend_percent=20</span><br><span class=\"line\"><span class=\"comment\"># 指定要用于瘦池的自定义块大小。默认块大小为64K。</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.blocksize=512K</span><br><span class=\"line\"><span class=\"comment\"># 指定用于瘦池数据的自定义块设备</span></span><br><span class=\"line\">$ sudo dockerd \\</span><br><span class=\"line\">  --storage-opt dm.datadev=/dev/sdb1 \\</span><br><span class=\"line\"><span class=\"comment\"># 指定用于瘦池元数据的自定义块设备。为了获得最佳性能，元数据应该位于与数据不同的轴上，甚至更好地位于SSD上。</span></span><br><span class=\"line\">  --storage-opt dm.metadatadev=/dev/sdc1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 基本设备大小可以在守护进程重启时增加，这将允许所有将来的映像和容器(基于这些新映像)都是新的基本设备大小。</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.basesize=50G <span class=\"comment\">#指定创建基本设备时要使用的大小，该设备限制图像和容器的大小</span></span><br><span class=\"line\"><span class=\"comment\"># 指定为瘦池使用的“data”设备创建回送文件时使用的大小。默认大小是100G，此选项配置devicemapper环回，不应在生产中使用。</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.loopdatasize=200G</span><br><span class=\"line\"><span class=\"comment\"># 指定为瘦池使用的“元数据”设备创建回送文件时使用的大小。默认大小是2G</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.loopmetadatasize=4G</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 为基本设备指定要使用的文件系统类型。支持的选项是“ext4”和“xfs”。默认值是“xfs”</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.fs=ext4</span><br><span class=\"line\"><span class=\"comment\"># 指定创建基础设备时要使用额外的mkfs参数。</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt <span class=\"string\">\"dm.mkfsarg=-O ^has_journal\"</span></span><br><span class=\"line\"><span class=\"comment\"># 指定安装瘦设备时使用的额外挂载选项</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.mountopt=nodiscard</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果libdm和内核驱动程序支持延迟设备删除机制，则支持使用延迟设备删除。</span></span><br><span class=\"line\">$ sudo dockerd --storage-opt dm.use_deferred_removal=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 允许对瘦池设备使用延迟设备删除。默认情况下，瘦池设备删除是同步的在删除一个容器之前，Docker守护进程会删除所有相关的设备。如果存储驱动程序不能删除设备，则容器删除失败，守护进程返回，下面避免了这样的情况。</span></span><br><span class=\"line\">$ sudo dockerd \\</span><br><span class=\"line\">      --storage-opt dm.use_deferred_deletion=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">      --storage-opt dm.use_deferred_removal=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>基础示例:Overlay2<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 覆盖允许overlay2的Linux内核版本检查。</span></span><br><span class=\"line\">$ overlay2.override_kernel_check</span><br><span class=\"line\"><span class=\"comment\"># 设置容器的默认最大大小。仅当后备fs是xfs并使用pquota挂载选项挂载时才支持它。在这些条件下用户可以传递小于后台fs大小的任何大小。</span></span><br><span class=\"line\">$ sudo dockerd -s overlay2 --storage-opt overlay2.size=1G</span><br></pre></td></tr></table></figure></p>\n<hr>\n<ul>\n<li>Docker运行时执行选项<br>Docker守护进程依赖于OCI兼容的运行时(通过containerd守护进程调用)作为它到Linux内核名称空间、cgroups和SELinux的接口。<br>默认情况下，Docker守护进程会自动启动containerd。如果您想控制containerd的启动，请手动启动containerd并使用—containerd标志将路径传递给containerd套接字。例如:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo dockerd --containerd /var/run/dev/docker-containerd.sock</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以通过配置文件或使用——add-runtime命令行参数向守护进程注册运行时。</span></span><br><span class=\"line\">$ sudo dockerd --add-runtime runc=runc --add-runtime custom=/usr/<span class=\"built_in\">local</span>/bin/my-runc-replacement</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 选项指定容器的cgroups的管理,该示例将cgroupdriver设置为systemd</span></span><br><span class=\"line\">$ sudo dockerd --<span class=\"built_in\">exec</span>-opt native.cgroupdriver=systemd <span class=\"comment\"># 设置此选项适用于守护进程启动的所有容器。</span></span><br><span class=\"line\"><span class=\"comment\"># 将使hyperv成为Windows上的默认隔离技术。如果在守护进程启动时没有指定隔离值，那么在Windows客户机上，默认为hyperv，在Windows服务器上，默认为process。</span></span><br><span class=\"line\">$ dockerd --<span class=\"built_in\">exec</span>-opt isolation=hyperv</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>守护进程DNS选项<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 为所有Docker容器设置DNS服务器，请使用:</span></span><br><span class=\"line\">$ sudo dockerd --dns 8.8.8.8</span><br><span class=\"line\"><span class=\"comment\"># 为所有Docker容器设置DNS搜索域，请使用:</span></span><br><span class=\"line\">$ sudo dockerd --dns-search example.com</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>允许推入不可分发的工件<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">To override this behavior <span class=\"keyword\">for</span> specific registries, use the --allow-nondistributable-artifacts option <span class=\"keyword\">in</span> one of the following forms:</span><br><span class=\"line\">--allow-nondistributable-artifacts myregistry:5000 tells the Docker daemon to push nondistributable artifacts to myregistry:5000.</span><br><span class=\"line\">--allow-nondistributable-artifacts 10.1.0.0/16 tells the Docker daemon to push nondistributable artifacts to all registries whose resolved IP address is within the subnet described by the CIDR syntax.</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>Insecure registries<br>默认情况下，Docker假设所有注册，但是在本地(参见下面的本地注册)，注册是安全的。与不安全的注册表通信是不可能的，如果Docker假设注册表是安全的。为了与不安全的注册表通信，Docker守护进程需要—insecure注册表在以下两种形式之一:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--insecure-registry myregistry:5000 tells the Docker daemon that myregistry:5000 should be considered insecure.</span><br><span class=\"line\">--insecure-registry 10.1.0.0/16 tells the Docker daemon that all registries whose domain resolve to an IP address is part of the subnet described by the CIDR syntax, should be considered insecure.</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>Node discovery<br>选项指定这个特定守护进程实例在向集群发布自身时应该使用的主机:端口或接口:端口组合。<br>守护进程使用libkv公布集群中的节点。一些键值后端支持相互TLS。要配置守护进程使用的客户端TLS设置，可以使用 ——cluster-store-opt 标志进行配置，指定PEM编码文件的路径。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo dockerd \\</span><br><span class=\"line\">    --cluster-advertise 192.168.1.2:2376 \\</span><br><span class=\"line\">    --cluster-store etcd://192.168.1.2:2379 \\</span><br><span class=\"line\">    --cluster-store-opt kv.cacertfile=/path/to/ca.pem \\ <span class=\"comment\"># 指定要信任的带有PEM编码CA证书的本地文件的路径。</span></span><br><span class=\"line\">    --cluster-store-opt kv.certfile=/path/to/cert.pem \\ <span class=\"comment\"># 指定具有PEM编码证书的本地文件的路径。</span></span><br><span class=\"line\">    --cluster-store-opt kv.keyfile=/path/to/key.pem     <span class=\"comment\"># 使用PEM编码的私钥指定本地文件的路径。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当前支持的集群存储选项是</span></span><br><span class=\"line\">discovery.heartbeat = 心跳检测默认默认值是20秒。</span><br><span class=\"line\">discovery.ttl = 指定TTL(生存时间)(以秒为单位)，如果在配置的TTL值内没有接收到有效的心跳，则发现模块使用该TTL为节点超时。如果没有配置，默认值是60秒。</span><br><span class=\"line\">kv.path = 指定的键/值存储的路径。</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>杂项选项<br>描述:IP伪装使用地址转换来允许没有公共IP的容器与Internet上的其他机器进行对话。这可能会干扰一些网络拓扑，可以使用–ip-masq=false禁用。<br>Docker支持Docker数据目录<code>(/var/lib/ Docker)</code>和<code>/var/lib/Docker/tmp</code>的软链接。DOCKER_TMPDIR和数据目录可以这样设置:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DOCKER_TMPDIR=/mnt/disk2/tmp /usr/<span class=\"built_in\">local</span>/bin/dockerd -D -g /var/lib/docker -H unix:// &gt; /var/lib/docker-machine/docker.log 2&gt;&amp;1</span><br><span class=\"line\"><span class=\"comment\"># or</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> DOCKER_TMPDIR=/mnt/disk2/tmp</span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/bin/dockerd -D -g /var/lib/docker -H unix:// &gt; /var/lib/docker-machine/docker.log 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Docker的访问授权可以通过授权插件来扩展</span></span><br><span class=\"line\">$ sudo dockerd --authorization-plugin=plugin1 --authorization-plugin=plugin2</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<ul>\n<li>守护进程指标<br>–metrics-addr 选项接受一个tcp地址来为度量API提供服务。要在localhost:9323上提供度量API，您需要指定——metrsts -addr 127.0.0.1:9323，允许您对127.0.0.1:9323/metrics的API发出请求，以接收 prometheus的度量。端口9323是与Docker度量相关联的默认端口，以避免与其他prometheus出口商和服务发生冲突。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果你运行的是prometheus服务器你可以将这个地址添加到你的scrape配置中</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: <span class=\"string\">'docker'</span></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets: [<span class=\"string\">'127.0.0.1:9323'</span>]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>命令选项:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--api-cors-header=<span class=\"string\">\"\"</span>：CORS 头部域，默认不允许 CORS，要允许任意的跨域访问，可以指定为 <span class=\"string\">\"*\"</span>；</span><br><span class=\"line\">--authorization-plugin=<span class=\"string\">\"\"</span>：载入认证的插件；</span><br><span class=\"line\">-b=<span class=\"string\">\"\"</span>：将容器挂载到一个已存在的网桥上。指定为 none 时则禁用容器的网络，与 --bip 选项互斥；</span><br><span class=\"line\">--bip=<span class=\"string\">\"\"</span>：让动态创建的 docker0 网桥采用给定的 CIDR 地址; 与 -b 选项互斥；</span><br><span class=\"line\">--cgroup-parent=<span class=\"string\">\"\"</span>：指定 cgroup 的父组，默认 fs cgroup 驱动为 /docker，systemd cgroup 驱动为 system.slice；</span><br><span class=\"line\">--cluster-store=<span class=\"string\">\"\"</span>：构成集群（如 Swarm）时，集群键值数据库服务地址；</span><br><span class=\"line\">--cluster-advertise=<span class=\"string\">\"\"</span>：构成集群时，自身的被访问地址，可以为 host:port 或 interface:port；</span><br><span class=\"line\">--cluster-store-opt=<span class=\"string\">\"\"</span>：构成集群时，键值数据库的配置选项；</span><br><span class=\"line\">--config-file=<span class=\"string\">\"/etc/docker/daemon.json\"</span>：daemon 配置文件路径；</span><br><span class=\"line\">--containerd=<span class=\"string\">\"\"</span>：containerd 文件的路径；</span><br><span class=\"line\">-D, --debug=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否使用 Debug 模式。缺省为 <span class=\"literal\">false</span>；</span><br><span class=\"line\">--default-gateway=<span class=\"string\">\"\"</span>：容器的 IPv4 网关地址，必须在网桥的子网段内；</span><br><span class=\"line\">--default-gateway-v6=<span class=\"string\">\"\"</span>：容器的 IPv6 网关地址；</span><br><span class=\"line\">--default-ulimit=[]：默认的 <span class=\"built_in\">ulimit</span> 值；</span><br><span class=\"line\">--<span class=\"built_in\">disable</span>-legacy-registry=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否允许访问旧版本的镜像仓库服务器；</span><br><span class=\"line\">--dns=<span class=\"string\">\"\"</span>：指定容器使用的 DNS 服务器地址；添加 DNS 服务器到容器的 /etc/resolv.conf 中，让容器用这个服务器来解析所有不在 /etc/hosts 中的主机名。</span><br><span class=\"line\">--dns-opt=<span class=\"string\">\"\"</span>：DNS 选项；</span><br><span class=\"line\">--dns-search=[]：DNS 搜索域；当设定搜索域为 .example.com 时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 host.example.com。</span><br><span class=\"line\">--<span class=\"built_in\">exec</span>-opt=[]：运行时的执行选项；</span><br><span class=\"line\">--<span class=\"built_in\">exec</span>-root=<span class=\"string\">\"\"</span>：容器执行状态文件的根路径，默认为 /var/run/docker；</span><br><span class=\"line\">--fixed-cidr=<span class=\"string\">\"\"</span>：限定分配 IPv4 地址范围；</span><br><span class=\"line\">--fixed-cidr-v6=<span class=\"string\">\"\"</span>：限定分配 IPv6 地址范围；</span><br><span class=\"line\">-G, --group=<span class=\"string\">\"\"</span>：分配给 unix 套接字的组，默认为 docker；</span><br><span class=\"line\">-g, --graph=<span class=\"string\">\"\"</span>：Docker 运行时的根路径，默认为 /var/lib/docker；</span><br><span class=\"line\">-H, --host=[]：指定命令对应 Docker daemon 的监听接口，可以为 unix 套接字 unix:///path/to/socket，文件句柄 fd://socketfd 或 tcp 套接字 tcp://[host[:port]]，默认为 unix:///var/run/docker.sock；</span><br><span class=\"line\">--icc=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否启用容器间以及跟 daemon 所在主机的通信。默认为 <span class=\"literal\">true</span>。</span><br><span class=\"line\">--insecure-registry=[]：允许访问给定的非安全仓库服务；</span><br><span class=\"line\">--ip=<span class=\"string\">\"\"</span>：绑定容器端口时候的默认 IP 地址。缺省为 0.0.0.0；</span><br><span class=\"line\">--ip-forward=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否检查启动在 Docker 主机上的启用 IP 转发服务，默认开启。注意关闭该选项将不对系统转发能力进行任何检查修改；</span><br><span class=\"line\">--ip-masq=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否进行地址伪装，用于容器访问外部网络，默认开启；</span><br><span class=\"line\">--iptables=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否允许 Docker 添加 iptables 规则。缺省为 <span class=\"literal\">true</span>；</span><br><span class=\"line\">--ipv6=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否启用 IPv6 支持，默认关闭；</span><br><span class=\"line\">-l, --<span class=\"built_in\">log</span>-level=<span class=\"string\">\"debug|info|warn|error|fatal\"</span>：指定日志输出级别；</span><br><span class=\"line\">--label=<span class=\"string\">\"[]\"</span>：添加指定的键值对标注；</span><br><span class=\"line\">--<span class=\"built_in\">log</span>-driver=<span class=\"string\">\"json-file|syslog|journald|gelf|fluentd|awslogs|splunk|etwlogs|gcplogs|none\"</span>：指定日志后端驱动，默认为 json-file；</span><br><span class=\"line\">--<span class=\"built_in\">log</span>-opt=[]：日志后端的选项；</span><br><span class=\"line\">--mtu=VALUE：指定容器网络的 mtu；</span><br><span class=\"line\">-p=<span class=\"string\">\"\"</span>：指定 daemon 的 PID 文件路径。缺省为 /var/run/docker.pid；</span><br><span class=\"line\">--raw-logs：输出原始，未加色彩的日志信息；</span><br><span class=\"line\">--registry-mirror=&lt;scheme&gt;://&lt;host&gt;：指定 docker pull 时使用的注册服务器镜像地址；</span><br><span class=\"line\">-s, --storage-driver=<span class=\"string\">\"\"</span>：指定使用给定的存储后端；</span><br><span class=\"line\">--selinux-enabled=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否启用 SELinux 支持。缺省值为 <span class=\"literal\">false</span>。SELinux 目前尚不支持 overlay 存储驱动；</span><br><span class=\"line\">--storage-opt=[]：驱动后端选项；</span><br><span class=\"line\">--tls=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否对 Docker daemon 启用 TLS 安全机制，默认为否；</span><br><span class=\"line\">--tlscacert=/.docker/ca.pem：TLS CA 签名的可信证书文件路径；</span><br><span class=\"line\">--tlscert=/.docker/cert.pem：TLS 可信证书文件路径；</span><br><span class=\"line\">--tlscert=/.docker/key.pem：TLS 密钥文件路径；</span><br><span class=\"line\">--tlsverify=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：启用 TLS 校验，默认为否；</span><br><span class=\"line\">--userland-proxy=<span class=\"literal\">true</span>|<span class=\"literal\">false</span>：是否使用用户态代理来实现容器间和出容器的回环通信，默认为 <span class=\"literal\">true</span>；</span><br><span class=\"line\">--userns-remap=default|uid:gid|user:group|user|uid：指定容器的用户命名空间，默认是创建新的 UID 和 GID 映射到容器内进程。</span><br></pre></td></tr></table></figure></p>\n<p><strong>dockerd 简单的启动示例1脚本:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/bin/dockerd </span><br><span class=\"line\">--config-file /etc/docker/daemon.json</span><br><span class=\"line\">-g /<span class=\"built_in\">export</span>/docker</span><br><span class=\"line\">-H fd:// </span><br><span class=\"line\">-H tcp://0.0.0.0:2375</span><br><span class=\"line\">-H unix:///var/run/docker.sock </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Docker运行时执行选项</span></span><br><span class=\"line\">--containerd=/run/containerd/containerd.sock</span><br><span class=\"line\">--<span class=\"built_in\">exec</span>-opt native.cgroupdriver=systemd  <span class=\"comment\">#cgroupfs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当容器仍在运行时，启用docker的活还原</span></span><br><span class=\"line\">--live-retore  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 存储引擎为devicemapper及相关参数</span></span><br><span class=\"line\">-s devicemapper</span><br><span class=\"line\">--storage-opt dm.loopdatasize=500G</span><br><span class=\"line\">--storage-opt dm.loopmetadatasize=4G</span><br><span class=\"line\">--storage-opt dm.basesize=100G</span><br><span class=\"line\">--storage-opt dm.fs=ext4</span><br><span class=\"line\"></span><br><span class=\"line\">--insecure-registry https://index.docker.io/v1/</span><br><span class=\"line\">--biq 172.17.42.1/16</span><br><span class=\"line\">--fixed-cidr 172.17.0.0/16</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例2:脚本的Docker守护进程的一个单独的“bootstrap”实例没有网络:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo dockerd \\</span><br><span class=\"line\">  -H unix:///var/run/docker-bootstrap.sock \\</span><br><span class=\"line\">  -p /var/run/docker-bootstrap.pid \\</span><br><span class=\"line\">  --iptables=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --ip-masq=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --bridge=none \\</span><br><span class=\"line\">  --data-root=/var/lib/docker-bootstrap \\</span><br><span class=\"line\">  --<span class=\"built_in\">exec</span>-root=/var/run/docker-bootstrap</span><br></pre></td></tr></table></figure></p>\n<p><strong>补充说明:</strong></p>\n<ul>\n<li>重新加载配置行为 ：在守护进程运行时，可以重新配置一些选项，而不需要重新启动进程。<code>我们在Linux中使用SIGHUP信号来重新加载，在Windows中使用一个全局事件</code><br>当前支持的选项列表，可以重新配置如下:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># debug: it changes the daemon to debug mode when set to true.</span></span><br><span class=\"line\"><span class=\"comment\"># cluster-store: it reloads the discovery store with the new address.</span></span><br><span class=\"line\"><span class=\"comment\"># cluster-store-opts: it uses the new options to reload the discovery store.</span></span><br><span class=\"line\"><span class=\"comment\"># cluster-advertise: it modifies the address advertised after reloading.</span></span><br><span class=\"line\"><span class=\"comment\"># labels: it replaces the daemon labels with a new set of labels.</span></span><br><span class=\"line\"><span class=\"comment\"># live-restore: Enables keeping containers alive during daemon downtime.</span></span><br><span class=\"line\"><span class=\"comment\"># max-concurrent-downloads: it updates the max concurrent downloads for each pull.</span></span><br><span class=\"line\"><span class=\"comment\"># max-concurrent-uploads: it updates the max concurrent uploads for each push.</span></span><br><span class=\"line\"><span class=\"comment\"># default-runtime: it updates the runtime to be used if not is specified at container creation. It defaults to “default” which is the runtime shipped with the official docker packages.</span></span><br><span class=\"line\"><span class=\"comment\"># runtimes: it updates the list of available OCI runtimes that can be used to run containers.</span></span><br><span class=\"line\"><span class=\"comment\"># authorization-plugin: it specifies the authorization plugins to use.</span></span><br><span class=\"line\"><span class=\"comment\"># allow-nondistributable-artifacts: Replaces the set of registries to which the daemon will push nondistributable artifacts with a new set of registries.</span></span><br><span class=\"line\"><span class=\"comment\"># insecure-registries: it replaces the daemon insecure registries with a new set of insecure registries. If some existing insecure registries in daemon’s configuration are not in newly reloaded insecure resgitries, these existing ones will be removed from daemon’s config.</span></span><br><span class=\"line\"><span class=\"comment\"># registry-mirrors: it replaces the daemon registry mirrors with a new set of registry mirrors. If some existing registry mirrors in daemon’s configuration are not in newly reloaded registry mirrors, these existing ones will be removed from daemon’s config.</span></span><br><span class=\"line\"><span class=\"comment\"># shutdown-timeout: it replaces the daemon’s existing configuration timeout with a new timeout for shutting down all containers.</span></span><br><span class=\"line\"><span class=\"comment\"># features: it explicitly enables or disables specific features.</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h4 id=\"0x02-Docker-配置文件\"><a href=\"#0x02-Docker-配置文件\" class=\"headerlink\" title=\"0x02 Docker 配置文件\"></a>0x02 Docker 配置文件</h4><p>描述:本章节记录了docker的一些主要的配置文件路径及其功能，并对其文件内容进行解析备注;</p>\n<h5 id=\"Configure-Path\"><a href=\"#Configure-Path\" class=\"headerlink\" title=\"Configure Path\"></a>Configure Path</h5><ul>\n<li>/root/.docker/config.json <code>Docker认证+启动配置(注意您使用的docker版本</code>)</li>\n<li>/etc/docker/deamon.json   <code>Docker 启动参数配置文件(主要文件CentOS)</code><ul>\n<li>/etc/docker/key.json      <code>Docker 认证相关配置(主要是存储仓库认证鉴权信息)</code></li>\n</ul>\n</li>\n<li>/lib/systemd/system/docker.service</li>\n</ul>\n<p><br/></p>\n<p><strong>1.~/.config.json</strong><br>描述:该配置文件是root用户下设定的 docker configure 参数, 优先级高于/etc/docker/deamon.json;<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$vim /root/.docker/config.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"auths\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"https://index.$docker.io/v1/\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"auth\"</span>: <span class=\"string\">\"********\"</span>  //账号：密码</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"HttpHeaders\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"User-Agent\"</span>: <span class=\"string\">\"$docker-Client/18.09.5 (linux)\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>2./etc/docker/daemon.json</strong><br>描述:Docker Engine V1.12 之后版本，用户可以自行创建 daemon.json 文件对 Docker Engine 进行配置和调整。在Linux中使用<code>/etc/docker/daemon.json（Linux）</code> 与在Windows中<code>%programdata%\\docker\\config\\daemon.json（Windows）</code>来配置 Daemon.json, 可能在您的系统没有daemon.json目录此时你可以创建一个即可;</p>\n<p>要点如下：</p>\n<ul>\n<li>该文件作为 Docker Engine 的配置管理文件, 里面几乎涵盖了所有 docker 命令行启动可以配置的参数。</li>\n<li>不管是在哪个平台以何种方式启动, Docker 默认都会来这里读取配置，使用户可以统一管理不同系统下的 docker daemon 配置(优先级低于用户配置~/.docker/config.json)。</li>\n<li>相关参数的使用说明，可以参阅 man dockerd 帮助信息，或者参阅官方文档。</li>\n</ul>\n<p>Docker 官方 daemon-configuration-file参数一览：<a href=\"https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file\" target=\"_blank\" rel=\"noopener\">https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file</a><br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123; </span><br><span class=\"line\">  // 镜像仓库鉴权信息(优先级没有用户配置文件高)</span><br><span class=\"line\">  \"auths\": &#123;</span><br><span class=\"line\">      \"https://registry.weiyigek.top/v2\": &#123;\"auth\": \"VlJFpmQE43Sw==\"&#125;,</span><br><span class=\"line\">      \"localhost\": &#123;\"auth\": \"cm9vdDoxMjM0NTY=\"&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  // 注册镜像-加速镜像站配置</span><br><span class=\"line\">  \"registry-mirrors\": [</span><br><span class=\"line\">    \"https://xlx9erfu.mirror.aliyuncs.com\",</span><br><span class=\"line\">    <span class=\"string\">\"https://docker.mirrors.ustc.edu.cn\"</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\"></span><br><span class=\"line\"> // 私有镜像仓库的 IP 地址或者域名(harbor或者docker)不进行HTTPS认证</span><br><span class=\"line\">  \"insecure-registries\" : [</span><br><span class=\"line\">    \"https://harbor.weiyigeek.top\",</span><br><span class=\"line\">    <span class=\"string\">\"192.168.10.200:5000\"</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\"></span><br><span class=\"line\">  // 私有仓库registry仓库不对外分发的产品</span><br><span class=\"line\">  \"allow-nondistributable-artifacts\": [\"192.168.10.200:5000\"],</span><br><span class=\"line\"></span><br><span class=\"line\">  // docker 客户端 User-Agent 设置</span><br><span class=\"line\">  \"HttpHeaders\": &#123;</span><br><span class=\"line\">    \"User-Agent\": \"Docker-Client/19.03.5 (linux)\"</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">  // Docker守护进程的监听接口以及存储守护程序的pid文件</span><br><span class=\"line\">  \"hosts\": [\"/var/run/docker.sock\"],  </span><br><span class=\"line\">  \"pidfile\":\"/var/run/docker.pid\", </span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\">  // 存储位置更改</span><br><span class=\"line\">  \"graph\": \"/disk/docker\",</span><br><span class=\"line\">  // 更改 Docker 的默认存储位置(指定挂载磁盘分区目录限定容器使用磁盘的大小)</span><br><span class=\"line\">  \"data-root\": \"/data/docker\",</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  //  容器运行时相关配置</span><br><span class=\"line\">  \"containerd\": \"/run/containerd/containerd.sock\",</span><br><span class=\"line\">  \"containerd-namespace\": \"docker\",</span><br><span class=\"line\">  \"containerd-plugin-namespace\": \"docker-plugins\",</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  // 存储驱动采用 overlay2</span><br><span class=\"line\">  \"storage-driver\": \"overlay2\",</span><br><span class=\"line\">  //存储驱动程序选项</span><br><span class=\"line\">  \"storage-opts\": [</span><br><span class=\"line\">    \"overlay2.override_kernel_check=true\",</span><br><span class=\"line\">    <span class=\"string\">\"overlay2.size=1G\"</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\"></span><br><span class=\"line\">  // 存储驱动采用 devicemapper 时候</span><br><span class=\"line\">  \"storage-driver\": \"devicemapper\",</span><br><span class=\"line\">  \"storage-opts\": [</span><br><span class=\"line\">    \"dm.thinpooldev=/dev/mapper/thin-pool\", #指定要用于瘦池的自定义块存储设备</span><br><span class=\"line\">    \"dm.use_deferred_deletion=true\",</span><br><span class=\"line\">    <span class=\"string\">\"dm.use_deferred_removal=true\"</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\"></span><br><span class=\"line\">  // 容器日志文件分割每个文件最大500MB</span><br><span class=\"line\">  \"log-driver\":\"json-file\",</span><br><span class=\"line\">  \"log-opts\": &#123;</span><br><span class=\"line\">    \"max-size\":\"500m\", </span><br><span class=\"line\">    \"max-file\":\"3\",</span><br><span class=\"line\">    \"labels\": \"production_status\",</span><br><span class=\"line\">    \"env\": \"os,customer\"</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  // 容器中ulimits限制(基于宿主机进行ulimits来设置)</span><br><span class=\"line\">  \"default-ulimits\": &#123;</span><br><span class=\"line\">        \"nofile\": &#123;</span><br><span class=\"line\">            \"Name\": \"nofile\",</span><br><span class=\"line\">            \"Hard\": 1024000,</span><br><span class=\"line\">            \"Soft\": 1024000</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        \"nproc\": &#123;</span><br><span class=\"line\">            \"Name\": \"nproc\",</span><br><span class=\"line\">            \"Hard\": 1024000,</span><br><span class=\"line\">            \"Soft\": 1024000</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">       \"core\": &#123;</span><br><span class=\"line\">            \"Name\": \"core\",</span><br><span class=\"line\">            \"Hard\": -1,</span><br><span class=\"line\">            \"Soft\": -1</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  </span><br><span class=\"line\">  // 标志指定的选项配置运行时。把docker更改驱动为systemtd或者cgroupfs</span><br><span class=\"line\">  \"exec-opts\": [\"native.cgroupdriver=cgroupfs\"],</span><br><span class=\"line\">  // Docker运行时执行选项,以下是一个例子将通过配置2个运行时</span><br><span class=\"line\">  \"default-runtime\": \"runc\",</span><br><span class=\"line\">  \"runtimes\": &#123;</span><br><span class=\"line\">    \"runc\": &#123;</span><br><span class=\"line\">      \"path\": \"runc\"</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    \"custom\": &#123;</span><br><span class=\"line\">      \"path\": \"/usr/local/bin/my-runc-replacement\",</span><br><span class=\"line\">      \"runtimeArgs\": [</span><br><span class=\"line\">        <span class=\"string\">\"--debug\"</span></span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">  //永久绑定到某个固定的 IP 地址</span><br><span class=\"line\">  \"ip\": \"0.0.0.0\",  </span><br><span class=\"line\">  //禁止访问所有端口（来关闭容器之间的通信）</span><br><span class=\"line\">  \"icc\": false, </span><br><span class=\"line\">  //启用iptables规则添加（默认为true）</span><br><span class=\"line\">  \"iptables\": true,</span><br><span class=\"line\">  //设置默认桥接到新建立的桥接网卡(将容器附加到网桥)</span><br><span class=\"line\">  \"bridge\": \"bridge0\",</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  // 容器中使用的DNS解析地址相关配置，设定容器DNS额外扩展、容器的搜索域</span><br><span class=\"line\">  \"dns\" :[</span><br><span class=\"line\">    \"114.114.114.114\",</span><br><span class=\"line\">    <span class=\"string\">\"8.8.8.8\"</span></span><br><span class=\"line\">  ],  </span><br><span class=\"line\">  \"dns-opts\": [], </span><br><span class=\"line\">  \"dns-search\": [], </span><br><span class=\"line\">  </span><br><span class=\"line\">  //此时 dockerd 会在日志中输入更多信息供分析</span><br><span class=\"line\">  \"debug\": true,   </span><br><span class=\"line\"></span><br><span class=\"line\">  //注意:在一台主机上运行多个守护进程被认为是“试验性的”。</span><br><span class=\"line\">  \"experimental\": \"enabled\",</span><br><span class=\"line\"></span><br><span class=\"line\">  //为守护进程设置oom_score_adj(默认值为-500)</span><br><span class=\"line\">  \"oom-score-adjust\": -1000,</span><br><span class=\"line\"></span><br><span class=\"line\">  //设置每次拉取的最大并发下载(默认为3)</span><br><span class=\"line\">  \"max-concurrent-downloads\": 3,    </span><br><span class=\"line\"></span><br><span class=\"line\">  //设置每个推送的最大并发上传数(默认为5)      </span><br><span class=\"line\">  \"max-concurrent-uploads\": 5,</span><br><span class=\"line\">  </span><br><span class=\"line\">  //设置该选项保证 docker daemon重启时容器不重启(需要设置 docker.server 只杀死docker进程，而不是cgroup中的所有进程)</span><br><span class=\"line\">  \"live-restore\": true,</span><br><span class=\"line\"></span><br><span class=\"line\">  // 支持IPV6</span><br><span class=\"line\">  \"ipv6\": true,</span><br><span class=\"line\">  \"fixed-cidr-v6\": \"2001:db8:1::/64\",</span><br><span class=\"line\">  </span><br><span class=\"line\">  // 允许您设置默认的 cgroup 父级 用于容器。 如果未设置此选项，则默认为 /docker为了 fs cgroup 驱动程序和 system.slice用于 systemd cgroup 驱动程序。 </span><br><span class=\"line\">  \"cgroup-parent\": \"/custom\",</span><br><span class=\"line\"></span><br><span class=\"line\">  // 设置不使用用户态代理来实现容器间和出容器的回环通信，</span><br><span class=\"line\">  \"userland-proxy\": false,</span><br><span class=\"line\">  \"userland-proxy-path\": \"/usr/libexec/docker-proxy\",</span><br><span class=\"line\"></span><br><span class=\"line\">  // 设置不为新容器设置新权限</span><br><span class=\"line\">  \"no-new-privileges\": false,</span><br><span class=\"line\"></span><br><span class=\"line\">  // 启用 SELinux 支持, SELinux 目前尚不支持 overlay 存储驱动, redhat 与 centOS支持设置，ubuntu需要自行安装；</span><br><span class=\"line\">  \"selinux-enabled\": true,</span><br><span class=\"line\"></span><br><span class=\"line\">  // 配置dockerd API的TLS认证</span><br><span class=\"line\">  \"tls\": true,        // 默认 false, 启动TLS认证开关</span><br><span class=\"line\">  \"tlscacert\": \"/etc/docker/ssl/ca.pem\",    // 默认 ~/.docker/ca.pem，通过CA认证过的的certificate文件路径</span><br><span class=\"line\">  \"tlscert\": \"/etc/docker/ssl/cert.pem\",      // 默认 ~/.docker/cert.pem ，TLS的certificate文件路径</span><br><span class=\"line\">  \"tlskey\": \"/etc/docker/ssl/key.pem\",       // 默认~/.docker/key.pem，TLS的key文件路径</span><br><span class=\"line\">  \"tlsverify\": true,  // 默认false，使用TLS并做后台进程与客户端通讯的验证</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>3.docker.service</strong></p>\n<ul>\n<li>基于Docker-CE17.12版本以及之后, build 481bc77156<br>docker服务配置文件路径：/lib/systemd/system/docker.service<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ExecStart=/usr/bin/dockerd --registry-mirror=https://xlx9erfu.mirror.aliyuncs.com</span><br></pre></td></tr></table></figure>\n<br></li>\n</ul>\n<p><strong>服务重启</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#修改配置文件后进行平滑重启</span></span><br><span class=\"line\"><span class=\"variable\">$sudo</span> <span class=\"built_in\">kill</span> -SIGHUP $(pidof dockerd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#通用启动</span></span><br><span class=\"line\"><span class=\"variable\">$sudo</span> systemctl daemon-reload   <span class=\"comment\">#重载守护</span></span><br><span class=\"line\"><span class=\"variable\">$sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure></p>\n<p>补充说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Docker Server/Client:</span></span><br><span class=\"line\">Version:         1.12.6</span><br><span class=\"line\">API version:     1.24</span><br><span class=\"line\">- /etc/systemd/system/docker.service.requires/flanneld.service </span><br><span class=\"line\">- /etc/docker/</span><br></pre></td></tr></table></figure></p>\n<p><em>Q:如何配置Docker Deamon能被Docker Client远程链接?</em><br>答: 我们需要在docker.service配置文件中进行更改dockerd的启动参数中添加<code>-H tcp://0.0.0.0:2375</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改启动参数</span></span><br><span class=\"line\">nano /usr/lib/systemd/system/docker.service</span><br><span class=\"line\">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重载守护进程与重启docker</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看监听情况</span></span><br><span class=\"line\">netstat -tlnp</span><br><span class=\"line\"><span class=\"comment\"># Active Internet connections (only servers)</span></span><br><span class=\"line\"><span class=\"comment\"># Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span></span><br><span class=\"line\"><span class=\"comment\"># tcp6       0      0 :::2375                 :::*                    LISTEN      11389/dockerd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 简单验证远程访问</span></span><br><span class=\"line\">curl http://127.0.0.1:2375/containers/json | jq</span><br><span class=\"line\">[</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Id\"</span>: <span class=\"string\">\"25d2d645bfc9e6530039d6aac890f69dd9af33f8f966adc2d7287b74964678e3\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Names\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"/test1\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"test1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"ImageID\"</span>: <span class=\"string\">\"sha256:5ec0e2b89f7aadb6178c17b3db73aba2e209f9556a436562de7f32b077b776bd\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Command\"</span>: <span class=\"string\">\"top -b -d 2\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Created\"</span>: 1592451272,</span><br><span class=\"line\">    <span class=\"string\">\"Ports\"</span>: [],</span><br><span class=\"line\">    <span class=\"string\">\"Labels\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"Author\"</span>: <span class=\"string\">\"WeiyiGeek\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"Description\"</span>: <span class=\"string\">\"Test Dockerfile\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"State\"</span>: <span class=\"string\">\"running\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Status\"</span>: <span class=\"string\">\"Up 35 minutes\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"HostConfig\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"NetworkMode\"</span>: <span class=\"string\">\"default\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"NetworkSettings\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"Networks\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"bridge\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">\"IPAMConfig\"</span>: null,</span><br><span class=\"line\">          <span class=\"string\">\"Links\"</span>: null,</span><br><span class=\"line\">          <span class=\"string\">\"Aliases\"</span>: null,</span><br><span class=\"line\">          <span class=\"string\">\"NetworkID\"</span>: <span class=\"string\">\"257f6a8500710d76efba6a1c9be8c0f10b4308afb481baf1e9ba77cf98f596bd\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"EndpointID\"</span>: <span class=\"string\">\"ac4518815359da7b8182167dfeeec728c0ea51accd1736719005f1596797e944\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"Gateway\"</span>: <span class=\"string\">\"172.17.0.1\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"IPAddress\"</span>: <span class=\"string\">\"172.17.0.2\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"IPPrefixLen\"</span>: 16,</span><br><span class=\"line\">          <span class=\"string\">\"IPv6Gateway\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"GlobalIPv6Address\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"GlobalIPv6PrefixLen\"</span>: 0,</span><br><span class=\"line\">          <span class=\"string\">\"MacAddress\"</span>: <span class=\"string\">\"02:42:ac:11:00:02\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"DriverOpts\"</span>: null</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"Mounts\"</span>: []</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200702100012.png\" alt=\"WeiyiGeek.Dockerd-TCP\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Dockerd-TCP</p>\n            </figure></p>\n<p><br/></p>\n<p><strong>容器 HTTP/HTTPS proxy 设置</strong><br>Docker 守护程序在其启动环境中使用 HTTP_PROXY、HTTPS_PROXY 和 NO_PROXY 环境变量来配置 HTTP 或 HTTPS 代理行为。  您无法使用 daemon.json 文件配置这些环境变量。</p>\n<p>如果您在 HTTP 或 HTTPS 代理服务器后面，例如在公司设置中，则需要在 Docker systemd 服务文件中添加此配置。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.为 docker 服务创建一个 systemd 插入目录：</span></span><br><span class=\"line\">sudo mkdir -p /etc/systemd/system/docker.service.d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.创建一个名为 /etc/systemd/system/docker.service.d/http-proxy.conf 的文件，其中添加了 HTTP_PROXY 环境变量：</span></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=<span class=\"string\">\"HTTP_PROXY=http://proxy.example.com:80\"</span></span><br><span class=\"line\">Environment=<span class=\"string\">\"HTTPS_PROXY=https://proxy.example.com:443\"</span></span><br><span class=\"line\"><span class=\"comment\"># 如果您有内部 Docker 注册表需要在不使用代理的情况下联系，您可以通过 NO_PROXY 环境变量指定它们。</span></span><br><span class=\"line\">Environment=<span class=\"string\">\"NO_PROXY=localhost,127.0.0.1,docker-registry.example.com,.corp\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.Flush changes and restart Docker</span></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl restart docker</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.验证配置是否已加载并与您所做的更改相匹配，例如：</span></span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"docker","path":"api/tags/docker.json"}]}