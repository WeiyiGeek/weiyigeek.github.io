<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Nginx,Lua">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                å­¦ä¹ ä¹‹è·¯
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°</h1>
        <h5 class="subtitle">
            
                <time datetime="2022-07-02T05:34:30.000Z" itemprop="datePublished" class="page-time">
  2022-07-02
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/">è¿ç»´å®è·µ</a></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-ç³»ç»Ÿè¿ç»´/Application/Web/WebApp/Nginx/7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°</h1>
        <div class="post-meta">
            <time class="post-time" title="2022-07-02 13:34:30" datetime="2022-07-02T05:34:30.000Z"  itemprop="datePublished">2022-07-02</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/">è¿ç»´å®è·µ</a></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p><strong>æœ¬ç« ç›®å½•</strong></p>
<p>[TOC]</p>
<hr>
<h2 id="0x00-å‰è¨€ç®€è¿°"><a href="#0x00-å‰è¨€ç®€è¿°" class="headerlink" title="0x00 å‰è¨€ç®€è¿°"></a>0x00 å‰è¨€ç®€è¿°</h2><p><strong>ä¸ºå•¥æœ‰æ­¤ç¯‡æ–‡ç« ?</strong><br>æè¿°: åœ¨è¿›è¡Œå…¬å¸çš„å›¾ç‰‡å­˜å‚¨è§£å†³æ–¹æ¡ˆç ”ç©¶ä¸­ï¼Œæœ€å¼€å§‹å‡†å¤‡ä½¿ç”¨çš„æ˜¯FastDFSï¼Œä½†æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘ï¼Œä»¥åŠåæœŸè¿ç»´æˆæœ¬è€ƒè™‘è¿˜æ˜¯æ”¾å¼ƒäº†ï¼Œåªèƒ½è½¬è€Œä½¿ç”¨å­˜å‚¨ç›´æ¥å­˜æ”¾å›¾ç‰‡æ–‡ä»¶ï¼Œç›´æ¥è¯·æ±‚æ•ˆç‡æç¤ºæ æ çš„ï¼Œä½†å¦‚ä½•æœ€å¤§é™åº¦ä¿è¯ä¸šåŠ¡å®‰å…¨ä»¥åŠå‡å°‘ä¸šåŠ¡å¯¹æ•°æ®åº“å¢åˆ æ”¹æŸ¥çš„å‹åŠ›? åœ¨ Google ã€Githubä¸€ç•ªæŸ¥æ‰¾åå‘ç°å¯ä»¥ç›´æ¥ä½¿ç”¨ Nginx + Lua è¿›è¡Œè®¿é—®æ•°æ®è¿›è¡Œè·å–é™æ€èµ„æºä¿¡æ¯ï¼Œè€Œä¸ç”¨ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œè®¿é—®æ•°æ®åº“ç›´æ¥è·å–é™æ€èµ„æºè·¯å¾„ï¼Œè€Œæ˜¾å¼çš„å±•ç°èµ„æºçœŸå®æš´éœ²ç»™å¤–éƒ¨ï¼Œéå¸¸å®¹æ˜“è¢«æ‰¹é‡æŠ“å–ã€‚</p>
<p>å…¶æ¬¡ç¬”è€…åœ¨å®è·µä¸­å‘ç°å½“å‰æœç´¢åˆ°çš„å®‰è£…éƒ¨ç½²Nginx+Luaå¯èƒ½å·²å°†ä¸é€‚ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬çš„Nginxç‰ˆæœ¬ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ 1.15.x ~ 1.18.xï¼Œå¯¹äºå½“å‰Nginx 1.22.0 ç‰ˆæœ¬æ¥è¯´æ˜¾ç„¶æ˜¯å¤ªè€äº†ã€‚<br>æ‰€ä»¥æœ¬ç« å°±è¯¥é—®é¢˜è¿›è¡Œ <code>Nginx + Lua + Redis</code> æ¨¡å—ç¯å¢ƒçš„å®‰è£…ä»¥åŠç®€å•çš„å®è·µï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°å„ä½æœ‰ç›¸åŒéœ€æ±‚çš„Personã€‚</p>
<a id="more"></a>
<p><br/></p>
<p><strong>åŸºç¡€çŸ¥è¯†:</strong></p>
<ul>
<li>Nginx: æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†webæœåŠ¡å™¨ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†IMAP/POP3/SMTPæœåŠ¡, å…¶ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…å«é™æ€èµ„æºã€åå‘ä»£ç†ã€apiæ¨¡å—æ‰©å±•ï¼Œå¯¹äºluaè„šæœ¬çš„æ‰©å±•ï¼Œä¾‹å¦‚ç”±lua-nginx-moduleæ¨¡å—ï¼Œå°±æ˜¯apiæ¨¡å—æ‰©å±•çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”nginxå¯ä»¥é€šè¿‡luaè„šæœ¬ç›´æ¥è°ƒç”¨redisæœåŠ¡å™¨ï¼›</li>
<li>Lua: æ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§ï¼Œé«˜æ•ˆï¼Œè½»é‡çº§ï¼Œå¯åµŒå…¥çš„è„šæœ¬è¯­è¨€ï¼Œéå¸¸å®¹æ˜“åµŒå…¥åˆ°æˆ‘ä»¬åº”ç”¨ç¨‹åºä¸­, å®ƒç”¨äºå„ç§åº”ç”¨ç¨‹åºï¼Œä»æ¸¸æˆåˆ°Webåº”ç”¨ç¨‹åºå’Œå›¾åƒå¤„ç†ã€‚ </li>
<li>lua-nginx-module : è¯¥æ¨¡å—æ˜¯ OpenResty çš„æ ¸å¿ƒç»„ä»¶ï¼Œç›®å½•æ˜¯å°†luaçš„åŠŸèƒ½åµŒå…¥åˆ°Nginx httpæœåŠ¡å™¨ä¸­ã€‚</li>
<li>lua-resty-redis : è¯¥æ¨¡å—æ˜¯åœ¨ OpenResty é¡¹ç›®ä¸‹åŸºäº cosocket API çš„ ngx_lua çš„ Lua redis å®¢æˆ·ç«¯é©±åŠ¨ã€‚</li>
</ul>
<p><br/></p>
<p>æ¸©é¦¨æç¤º: å¦‚æœä¸æ˜¯ç°æœ‰ä¸šåŠ¡å¤§é‡ä½¿ç”¨Nginxè¿›è¡Œæ‰¿è½½ä¸èƒ½ç›´æ¥æ›¿æ¢å…¶å®ƒä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆï¼Œåªèƒ½ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œä»è€Œè½¬å…¥ <code>OpenResty</code> æˆ–è€… <code>caddy</code> æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚</p>
<p>åŸæ–‡åœ°å€: <a href="https://blog.weiyigeek.top">https://blog.weiyigeek.top</a></p>
<hr>
<h3 id="çŸ¥è¯†å¼•å…¥"><a href="#çŸ¥è¯†å¼•å…¥" class="headerlink" title="çŸ¥è¯†å¼•å…¥"></a>çŸ¥è¯†å¼•å…¥</h3><p><strong>Nginx çš„æŒ‡ä»¤çš„éƒ½æ˜¯å®‰è£…æ‰§è¡Œé¡ºåºçš„å—?</strong></p>
<blockquote>
<p>ç­”: æ—¢ç„¶æˆ‘éƒ½è¿™æ ·é—®äº†ç­”æ¡ˆåˆ™æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œè¿™ä¹Ÿæ˜¯å¤§å¤šæ•°æ–°æ‰‹é¢‘ç¹é‡åˆ°çš„ä¸€ä¸ªå›°æƒ‘ï¼Œå½“ç„¶ä¹Ÿå›°æƒ‘äº†ç¬”è€…ï¼Œå¦åˆ™æˆ‘ä¹Ÿä¸ä¼šè¿™æ ·é—®ã€‚</p>
</blockquote>
<p>é‚£æˆ‘ä»¬ä¸‹æ¥æ¥çœ‹è¿™ä¹ˆä¸€ä¸ªç¤ºä¾‹: (éªŒè¯æ­¤ç¤ºä¾‹ä½ å¯èƒ½éœ€è¦å…ˆæŒ‰ç…§ä¸‹ä¸€ç« çš„ã€0x01 éƒ¨ç½²ç¯å¢ƒã€‘è¿›è¡Œå‡†å¤‡ç›¸å…³ç¯å¢ƒ), æ­¤æ—¶ä½ å¯èƒ½ä¼šè¯´è¾“å‡ºä¸å°±æ˜¯<code>WeiyiGeek</code>å—?<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /sequence_demo_1 &#123;</span><br><span class="line"> <span class="built_in">set</span> <span class="variable">$a</span> Weiyi;</span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$a</span>;</span><br><span class="line"> <span class="built_in">set</span> <span class="variable">$a</span> Geek;</span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä½†å¦‚æœè¯·æ±‚è¯¥URLä½ ä¼šå‘ç°å®æ—¶å¹¶éå¦‚æ­¤ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl http:&#x2F;&#x2F;demo.weiyigeek.top&#x2F;sequence_demo_1</span><br><span class="line">Geek</span><br><span class="line">Geek</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>é‚£ä¸ºä»€ä¹ˆå‡ºç°äº†è¿™ç§ä¸åˆå¸¸ç†çš„ç°è±¡å‘¢ï¼Ÿ</strong></p>
<blockquote>
<p>ç­”: ä¸ºäº†è§£é‡Šæ­¤ç°è±¡, æˆ‘ä»¬ä¸å¾—ä¸ä»‹ç»Nginxçš„è¯·æ±‚å¤„ç†çš„11é˜¶æ®µï¼Œåˆ†åˆ«æ˜¯post-readã€server-rewriteã€find-configã€rewriteã€post-rewriteã€preaccessã€accessã€post-accessã€precontentã€contentä»¥åŠlogï¼Œå…¶ä¸­3ä¸ªæ¯”è¾ƒå¸¸è§çš„æŒ‰ç…§æ‰§è¡Œæ—¶çš„å…ˆåé¡ºåºä¾æ¬¡æ˜¯rewriteé˜¶æ®µã€accessé˜¶æ®µä»¥åŠcontenté˜¶æ®µã€‚<br>Nginx é…ç½®æŒ‡ä»¤ä¸€èˆ¬åªä¼šæ³¨å†Œå¹¶è¿è¡Œåœ¨å…¶ä¸­çš„æŸä¸€ä¸ªå¤„ç†é˜¶æ®µï¼Œæ¯”å¦‚ <code>set</code> æŒ‡ä»¤å°±æ˜¯åœ¨<code>rewrite</code>é˜¶æ®µè¿è¡Œçš„ï¼Œè€Œ<code>echo</code>æŒ‡ä»¤åªä¼šåœ¨<code>content</code>é˜¶æ®µè¿è¡Œ, åœ¨ä¸€æ¬¡è¯·æ±‚å¤„ç†æµç¨‹ä¸­<code>rewrite</code>é˜¶æ®µæ€»æ˜¯åœ¨contenté˜¶æ®µä¹‹å‰æ‰§è¡Œã€‚</p>
</blockquote>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802164753.png" target="_blank" title="WeiyiGeek.Nginxçš„è¯·æ±‚å¤„ç†çš„11é˜¶æ®µ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802164753.png" alt="WeiyiGeek.Nginxçš„è¯·æ±‚å¤„ç†çš„11é˜¶æ®µ" title="" class=""></a>
                <p>WeiyiGeek.Nginxçš„è¯·æ±‚å¤„ç†çš„11é˜¶æ®µ</p>
            </figure>
<p>å› æ­¤ï¼Œå±äºrewriteé˜¶æ®µçš„é…ç½®æŒ‡ä»¤ï¼ˆç¤ºä¾‹ä¸­çš„setï¼‰æ€»æ˜¯ä¼šæ— æ¡ä»¶åœ°åœ¨contenté˜¶æ®µçš„é…ç½®æŒ‡ä»¤ï¼ˆç¤ºä¾‹ä¸­çš„echoï¼‰ä¹‹å‰æ‰§è¡Œï¼Œå³ä¾¿æ˜¯<code>echo</code>æŒ‡ä»¤å‡ºç°åœ¨<code>set</code>æŒ‡ä»¤çš„å‰é¢, ä¸Šé¢ä¾‹å­ä¸­çš„æŒ‡ä»¤æŒ‰ç…§è¯·æ±‚å¤„ç†é˜¶æ®µçš„å…ˆåæ¬¡åºæ’åºï¼Œå®é™…çš„æ‰§è¡Œæ¬¡åºå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /sequence_demo_1 &#123;</span><br><span class="line"> <span class="comment"># rewriteé˜¶æ®µçš„é…ç½®æŒ‡ä»¤ï¼Œæ‰§è¡Œåœ¨å‰é¢</span></span><br><span class="line"> <span class="built_in">set</span> <span class="variable">$a</span> Weiyi;</span><br><span class="line"> <span class="built_in">set</span> <span class="variable">$a</span> Geek ;</span><br><span class="line"> <span class="comment"># contenté˜¶æ®µçš„é…ç½®æŒ‡ä»¤ï¼Œæ‰§è¡Œåœ¨åé¢</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$a</span>;</span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥ï¼Œè¾“å‡ºçš„ç»“æœå°±æ˜¯Weiyi Geekäº†ã€‚</p>
<p><br></p>
<h3 id="Luaæ¨¡å—æŒ‡ä»¤é˜¶æ®µ"><a href="#Luaæ¨¡å—æŒ‡ä»¤é˜¶æ®µ" class="headerlink" title="Luaæ¨¡å—æŒ‡ä»¤é˜¶æ®µ"></a>Luaæ¨¡å—æŒ‡ä»¤é˜¶æ®µ</h3><p><strong>å„é˜¶æ®µä½¿ç”¨Luaæ¨¡å—æŒ‡ä»¤</strong><br>æè¿°: ç”±äºæœ¬ç«  Nginx ä¹Ÿæ˜¯ä½¿ç”¨ OpenResty Lua æ¨¡å—å®ç°çš„è§£æLuaè„šæœ¬,æ‰€ä»¥å…¶æŒ‡ä»¤æˆ‘ä»¬ä¹Ÿéœ€è¦åšä¸€ä¸ªç®€å•äº†è§£ï¼Œå¯¹äºåç»­å­¦ä¹ æœ‰éå¸¸å¤§çš„å¸®åŠ©ã€‚</p>
<p>æŒ‡ä»¤è¯­æ³•: <a href="https://github.com/openresty/lua-nginx-module#synopsis" target="_blank" rel="noopener">https://github.com/openresty/lua-nginx-module#synopsis</a></p>
<p>ä½¿ç”¨Luaæ¥æ„å»ºnginxè„šæœ¬å°±æ˜¯é€šè¿‡ä¸€æ¡æ¡æŒ‡ä»¤æ¥å®Œæˆçš„ï¼ŒæŒ‡ä»¤å¸¸ç”¨äºæŒ‡å®š Lua ä»£ç æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ä»¥åŠå¦‚ä½•ä½¿ç”¨è¿è¡Œçš„ç»“æœï¼Œlua æŒ‡ä»¤åˆ†ä¸ºé…ç½®æŒ‡ä»¤ã€æ§åˆ¶æŒ‡ä»¤, è€Œæ§åˆ¶æŒ‡ä»¤åˆ†ä¸ºä¸¤ç§æ–¹å¼ã€‚</p>
<ul>
<li>luaè„šæœ¬å— ï¼š<code>*_by_lua_block</code></li>
<li>luaè„šæœ¬æ–‡ä»¶ ï¼š<code>*_by_lua_file</code></li>
</ul>
<p>ä¸‹å›¾å±•ç¤ºäº†æŒ‡ä»¤æ‰§è¡Œçš„é¡ºåºï¼šä»ä¸Šè‡³ä¸‹ï¼šåˆå§‹åŒ–ã€é‡å†™/è®¿é—®ã€å†…å®¹å¤„ç†ã€æ—¥å¿—è¾“å‡ºå››ä¸ªé˜¶æ®µ</p>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802171007.png" target="_blank" title="WeiyiGeek.ngx-lua-order" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802171007.png" alt="WeiyiGeek.ngx-lua-order" title="" class=""></a>
                <p>WeiyiGeek.ngx-lua-order</p>
            </figure>
<p><br/></p>
<p><strong>lua-nginx-module Directives Documentï¼ˆLua Nginx æ¨¡å—æŒ‡ä»¤æ–‡æ¡£ï¼‰:</strong></p>
<ul>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_load_resty_core" target="_blank" rel="noopener">lua_load_resty_core</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_capture_error_log" target="_blank" rel="noopener">lua_capture_error_log</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_use_default_type" target="_blank" rel="noopener">lua_use_default_type</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_malloc_trim" target="_blank" rel="noopener">lua_malloc_trim</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_code_cache" target="_blank" rel="noopener">lua_code_cache</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_thread_cache_max_entries" target="_blank" rel="noopener">lua_thread_cache_max_entries</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_regex_cache_max_entries" target="_blank" rel="noopener">lua_regex_cache_max_entries</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_regex_match_limit" target="_blank" rel="noopener">lua_regex_match_limit</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_package_path" target="_blank" rel="noopener">lua_package_path</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_package_cpath" target="_blank" rel="noopener">lua_package_cpath</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#init_by_lua" target="_blank" rel="noopener">init_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#init_by_lua_block" target="_blank" rel="noopener">init_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#init_by_lua_file" target="_blank" rel="noopener">init_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#init_worker_by_lua" target="_blank" rel="noopener">init_worker_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#init_worker_by_lua_block" target="_blank" rel="noopener">init_worker_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#init_worker_by_lua_file" target="_blank" rel="noopener">init_worker_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#exit_worker_by_lua_block" target="_blank" rel="noopener">exit_worker_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#exit_worker_by_lua_file" target="_blank" rel="noopener">exit_worker_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#set_by_lua" target="_blank" rel="noopener">set_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#set_by_lua_block" target="_blank" rel="noopener">set_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#set_by_lua_file" target="_blank" rel="noopener">set_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#content_by_lua" target="_blank" rel="noopener">content_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#content_by_lua_block" target="_blank" rel="noopener">content_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#content_by_lua_file" target="_blank" rel="noopener">content_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#server_rewrite_by_lua_block" target="_blank" rel="noopener">server_rewrite_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#server_rewrite_by_lua_file" target="_blank" rel="noopener">server_rewrite_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#rewrite_by_lua" target="_blank" rel="noopener">rewrite_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#rewrite_by_lua_block" target="_blank" rel="noopener">rewrite_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#rewrite_by_lua_file" target="_blank" rel="noopener">rewrite_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#access_by_lua" target="_blank" rel="noopener">access_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#access_by_lua_block" target="_blank" rel="noopener">access_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#access_by_lua_file" target="_blank" rel="noopener">access_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#header_filter_by_lua" target="_blank" rel="noopener">header_filter_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#header_filter_by_lua_block" target="_blank" rel="noopener">header_filter_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#header_filter_by_lua_file" target="_blank" rel="noopener">header_filter_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#body_filter_by_lua" target="_blank" rel="noopener">body_filter_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#body_filter_by_lua_block" target="_blank" rel="noopener">body_filter_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#body_filter_by_lua_file" target="_blank" rel="noopener">body_filter_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#log_by_lua" target="_blank" rel="noopener">log_by_lua</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#log_by_lua_block" target="_blank" rel="noopener">log_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#log_by_lua_file" target="_blank" rel="noopener">log_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#balancer_by_lua_block" target="_blank" rel="noopener">balancer_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#balancer_by_lua_file" target="_blank" rel="noopener">balancer_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_need_request_body" target="_blank" rel="noopener">lua_need_request_body</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_client_hello_by_lua_block" target="_blank" rel="noopener">ssl_client_hello_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_client_hello_by_lua_file" target="_blank" rel="noopener">ssl_client_hello_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_certificate_by_lua_block" target="_blank" rel="noopener">ssl_certificate_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_certificate_by_lua_file" target="_blank" rel="noopener">ssl_certificate_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_session_fetch_by_lua_block" target="_blank" rel="noopener">ssl_session_fetch_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_session_fetch_by_lua_file" target="_blank" rel="noopener">ssl_session_fetch_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_session_store_by_lua_block" target="_blank" rel="noopener">ssl_session_store_by_lua_block</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#ssl_session_store_by_lua_file" target="_blank" rel="noopener">ssl_session_store_by_lua_file</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_shared_dict" target="_blank" rel="noopener">lua_shared_dict</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_connect_timeout" target="_blank" rel="noopener">lua_socket_connect_timeout</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_send_timeout" target="_blank" rel="noopener">lua_socket_send_timeout</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_send_lowat" target="_blank" rel="noopener">lua_socket_send_lowat</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_read_timeout" target="_blank" rel="noopener">lua_socket_read_timeout</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_buffer_size" target="_blank" rel="noopener">lua_socket_buffer_size</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_pool_size" target="_blank" rel="noopener">lua_socket_pool_size</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_keepalive_timeout" target="_blank" rel="noopener">lua_socket_keepalive_timeout</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_socket_log_errors" target="_blank" rel="noopener">lua_socket_log_errors</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_ssl_ciphers" target="_blank" rel="noopener">lua_ssl_ciphers</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_ssl_crl" target="_blank" rel="noopener">lua_ssl_crl</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_ssl_protocols" target="_blank" rel="noopener">lua_ssl_protocols</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_ssl_trusted_certificate" target="_blank" rel="noopener">lua_ssl_trusted_certificate</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_ssl_verify_depth" target="_blank" rel="noopener">lua_ssl_verify_depth</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_ssl_conf_command" target="_blank" rel="noopener">lua_ssl_conf_command</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_http10_buffering" target="_blank" rel="noopener">lua_http10_buffering</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#rewrite_by_lua_no_postpone" target="_blank" rel="noopener">rewrite_by_lua_no_postpone</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#access_by_lua_no_postpone" target="_blank" rel="noopener">access_by_lua_no_postpone</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_transform_underscores_in_response_headers" target="_blank" rel="noopener">lua_transform_underscores_in_response_headers</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_check_client_abort" target="_blank" rel="noopener">lua_check_client_abort</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_max_pending_timers" target="_blank" rel="noopener">lua_max_pending_timers</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_max_running_timers" target="_blank" rel="noopener">lua_max_running_timers</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_sa_restart" target="_blank" rel="noopener">lua_sa_restart</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module#lua_worker_thread_vm_pool_size" target="_blank" rel="noopener">lua_worker_thread_vm_pool_size</a></li>
</ul>
<p><br></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯Nginxå¯ä»¥æå‰ç»ˆæ­¢è¯·æ±‚ï¼ˆè‡³å°‘ï¼‰ï¼Œè¿™æ„å‘³ç€è·³è¿‡æ­£å¸¸è¿è¡Œçš„é˜¶æ®µï¼Œä¾‹å¦‚é‡å†™æˆ–è®¿é—®é˜¶æ®µã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œä¸ç®¡è¿è¡Œçš„åæœŸé˜¶æ®µï¼ˆä¾‹å¦‚log_by_luaï¼‰å°†æ— æ³•è®¿é—®é€šå¸¸åœ¨è¿™äº›é˜¶æ®µä¸­è®¾ç½®çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">400 (Bad Request)</span><br><span class="line">405 (Not Allowed)</span><br><span class="line">408 (Request Timeout)</span><br><span class="line">413 (Request Entity Too Large)</span><br><span class="line">414 (Request URI Too Large)</span><br><span class="line">494 (Request Headers Too Large)</span><br><span class="line">499 (Client Closed Request)</span><br><span class="line">500 (Internal Server Error)</span><br><span class="line">501 (Not Implemented)</span><br></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œæ­¤å¤„å°±åªæ˜¯å…ˆç®€å•ç‚¹ä¸€ä¸‹ï¼Œåœ¨åç»­å®è·µä¸­æ‚¨åœ¨å›è¿‡å¤´æ¥çœ‹å³å¯ã€‚</p>
<hr>
<h2 id="0x01-éƒ¨ç½²ç¯å¢ƒ"><a href="#0x01-éƒ¨ç½²ç¯å¢ƒ" class="headerlink" title="0x01 éƒ¨ç½²ç¯å¢ƒ"></a>0x01 éƒ¨ç½²ç¯å¢ƒ</h2><h3 id="å®‰è£…è¯´æ˜"><a href="#å®‰è£…è¯´æ˜" class="headerlink" title="å®‰è£…è¯´æ˜"></a>å®‰è£…è¯´æ˜</h3><p><strong>ç¯å¢ƒæè¿°:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line">$ cat /etc/issue.net</span><br><span class="line">Ubuntu 20.04.3 LTS</span><br><span class="line">$ uname -a</span><br><span class="line">Linux weiyigeek.top 5.4.0-92-generic \<span class="comment">#103-Ubuntu SMP Fri Nov 26 16:13:00 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¯ä»¶ç‰ˆæœ¬</span></span><br><span class="line">Nginx - 1.22.0  (stable ç‰ˆæœ¬) </span><br><span class="line">pcre - 8.45</span><br><span class="line">zlib - 1.2.12</span><br><span class="line">Lua - 5.4</span><br><span class="line">openssl - 1.1.1q</span><br><span class="line">ngx_devel_kit - v0.3.1</span><br><span class="line">lua-nginx-module - v0.10.21</span><br><span class="line"><span class="built_in">echo</span>-nginx-module - v0.62</span><br><span class="line">lua-resty-core - v0.1.23</span><br><span class="line">lua-resty-lrucache - v0.13</span><br><span class="line">lua-resty-redis - v0.29</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: æ­¤å¤„ä½¿ç”¨çš„æ˜¯ Ubuntu 20.04 æ“ä½œç³»ç»Ÿ, è¯¥ç³»ç»Ÿå·²åšå®‰å…¨åŠ å›ºå’Œå†…æ ¸ä¼˜åŒ–ç¬¦åˆç­‰ä¿2.0è¦æ±‚ã€<a href="https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh" target="_blank" rel="noopener">SecOpsDev/Ubuntu-InitializeSecurity.sh at master Â· WeiyiGeek/SecOpsDev</a> ã€‘, å¦‚ä½ çš„Linuxæœªè¿›è¡Œç›¸åº”é…ç½®ç¯å¢ƒå¯èƒ½ä¸è¯»è€…æœ‰äº›è®¸å·®å¼‚, å¦‚éœ€è¦è¿›è¡Œ(windows serverã€Ubuntuã€CentOS)å®‰å…¨åŠ å›ºè¯·å‚ç…§å¦‚ä¸‹åŠ å›ºè„šæœ¬è¿›è¡ŒåŠ å›º, è¯·å¤§å®¶ç–¯ç‹‚çš„ star ã€‚<br>åŠ å›ºè„šæœ¬åœ°å€:ã€ <a href="https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh" target="_blank" rel="noopener">https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh</a> ã€‘</p>
<p style='color:red'><br>ä¸ºäº†èŠ‚çœå¤§å®¶çš„å®è·µæ—¶é—´ï¼Œæˆ‘å·²ç»æŠŠéœ€è¦ç”¨åˆ°çš„æºç åŒ…ä¸Šä¼ åˆ°ç©ºé—´ä¸­ï¼Œæœ‰éœ€è¦çš„æœ‹å‹å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œä¸‹è½½åœ°å€: (<a href="http://share.weiyigeek.top/d/36158960-50338508-7c5982?p=2088)ï¼ˆè®¿é—®å¯†ç ï¼š2088ï¼‰" target="_blank" rel="noopener">http://share.weiyigeek.top/d/36158960-50338508-7c5982?p=2088)ï¼ˆè®¿é—®å¯†ç ï¼š2088ï¼‰</a><br><br/>æ¸©é¦¨æç¤º: å¦‚æç¤ºè¯ä¹¦ä¸å¯¹ï¼Œè¯·ç‚¹å‡»é«˜çº§ç»§ç»­è®¿é—®å³å¯.</p>

<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220806093220.png" target="_blank" title="WeiyiGeek.NginxåŠå…¶æ¨¡å—ä¸‹è½½" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220806093220.png" alt="WeiyiGeek.NginxåŠå…¶æ¨¡å—ä¸‹è½½" title="" class=""></a>
                <p>WeiyiGeek.NginxåŠå…¶æ¨¡å—ä¸‹è½½</p>
            </figure>
<p><br></p>
<h3 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h3><p><strong>æºä»£ç ç¼–è¯‘æ„å»º</strong><br>Step 1.åœ¨ Ubuntu 20.04 LTS ç³»ç»Ÿå®‰è£…ç¼–è¯‘æ‰€éœ€ç¯å¢ƒ.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y gcc g++ make perl net-tools</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 2.ä¸‹è½½ Nginxã€PCREã€zlibã€OpenSSL æºä»£ç åŒ…ï¼Œå¹¶ç¼–è¯‘æ„å»º <code>PCREã€zlibã€OpenSSL</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="comment"># Nginx è½»é‡çº§çš„Webä»£ç†æœåŠ¡å™¨ã€‚</span></span><br><span class="line"><span class="comment"># å®˜ç½‘: https://nginx.org/en/download.html</span></span><br><span class="line">wget -c https://nginx.org/download/nginx-1.22.0.tar.gz -O /usr/<span class="built_in">local</span>/src/nginx-1.22.0.tar.gz</span><br><span class="line">tar -zxf nginx-1.22.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># PCRE â€“ æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼ŒNGINX Core å’Œ Rewrite æ¨¡å—éœ€è¦</span></span><br><span class="line"><span class="comment"># å®˜ç½‘ï¼š http://pcre.org/</span></span><br><span class="line">wget -c https://nchc.dl.sourceforge.net/project/pcre/pcre/8.45/pcre-8.45.tar.bz2</span><br><span class="line">tar -jxf pcre-8.45.tar.bz2 &amp;&amp; <span class="built_in">cd</span> pcre-8.45</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># zlib â€“ æ”¯æŒæ ‡å¤´å‹ç¼©, NGINX Gzip æ¨¡å—éœ€è¦ã€‚</span></span><br><span class="line"><span class="comment"># å®˜ç½‘ï¼šhttp://www.zlib.net/</span></span><br><span class="line">wget -c http://www.zlib.net/zlib-1.2.12.tar.gz</span><br><span class="line">tar -zxf zlib-1.2.12.tar.gz &amp;&amp; <span class="built_in">cd</span> zlib-1.2.12</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenSSL â€“ æ”¯æŒ HTTPS åè®®, NGINX SSL æ¨¡å—å’Œå…¶ä»–æ¨¡å—éœ€è¦ã€‚</span></span><br><span class="line"><span class="comment"># å®˜ç½‘: https://www.openssl.org/source/</span></span><br><span class="line">wget -c https://www.openssl.org/<span class="built_in">source</span>/openssl-1.1.1q.tar.gz</span><br><span class="line">tar -zxf openssl-1.1.1q.tar.gz &amp;&amp; <span class="built_in">cd</span> openssl-1.1.1q</span><br><span class="line">./config --prefix=/usr/<span class="built_in">local</span>/openssl</span><br><span class="line">make &amp;&amp; sudo make install</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/openssl/bin/openssl /usr/<span class="built_in">local</span>/bin/openssl</span><br><span class="line"><span class="comment"># lib åº“åŠ è½½åˆ°ç³»ç»Ÿ</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/usr/local/openssl/lib"</span> &gt;&gt; /etc/ld.so.conf.d/libc.conf</span><br><span class="line">ldconfig</span><br><span class="line"><span class="comment"># æ‰§è¡Œå‘½ä»¤éªŒè¯ç³»ç»Ÿçš„ OpenSSL ç‰ˆæœ¬</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/openssl version</span><br><span class="line">OpenSSL 1.1.1q 5 Jul 2022</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: å¦‚<code>./configure</code>æœªæŒ‡å®š<code>--prefix</code>å‚æ•°çš„å°†ä¼šç›´æ¥å®‰è£…åœ¨<code>/usr/local</code>ç›®å½•ä¸‹çš„binã€libã€shareç­‰å­ç›®å½•ä¸­ã€‚</p>
<p><br/></p>
<p>Step 3.ä¸‹è½½ç¼–è¯‘æ„å»ºLuaè§£æå™¨ä»¥åŠNginxæ‰€éœ€çš„å¼€å‘å·¥å…·åŒ…å’ŒLuaæ¨¡å—ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="comment"># ngx_devel_kit - æ˜¯Nginxå¼€å‘å·¥å…·åŒ…ï¼Œå®é™…ä¸Šå¯ä»¥çœ‹åšä¸€ä¸ªNginxæ¨¡å—ï¼Œå®ƒæ·»åŠ äº†é¢å¤–çš„é€šç”¨å·¥å…·ï¼Œæ¨¡å—å¼€å‘äººå‘˜å¯ä»¥åœ¨è‡ªå·±çš„æ¨¡å—ä¸­ä½¿ç”¨è¿™äº›å·¥å…·ã€‚</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/simpl/ngx_devel_kit</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/vision5/ngx_devel_kit</span></span><br><span class="line">wget -c https://github.com/vision5/ngx_devel_kit/archive/refs/tags/v0.3.1.tar.gz -O ngx_devel_kit-v0.3.1.tar.gz</span><br><span class="line">tar -zxf ngx_devel_kit-v0.3.1.tar.gz &amp;&amp; ls ngx_devel_kit-0.3.1</span><br><span class="line">  <span class="comment"># auto  config  docs  examples  LICENSE  ngx_auto_lib_core  notes  objs  patches  README_AUTO_LIB.md  README.md  src</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lua-nginx-module - å°†Luaçš„å¼ºå¤§åŠŸèƒ½åµŒå…¥åˆ°NGINX HTTPæœåŠ¡å™¨ä¸­</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/openresty/lua-nginx-module</span></span><br><span class="line">wget -c https://github.com/openresty/lua-nginx-module/archive/refs/tags/v0.10.21.tar.gz -O /usr/<span class="built_in">local</span>/src/lua-nginx-module-v0.10.21.tar.gz</span><br><span class="line">tar -zxf lua-nginx-module-v0.10.21.tar.gz &amp;&amp; ls lua-nginx-module-0.10.21</span><br><span class="line">  <span class="comment"># config  doc  dtrace  misc  README.markdown  src  t  tapset  util  valgrind.suppress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo-nginx-module - ä¸€ä¸ªNginxçš„è¾“å‡ºæ¨¡å—ï¼Œç”¨äºå°†â€œechoâ€ã€â€œsleepâ€ã€â€œtimeâ€ç­‰åŠŸèƒ½å¼•å…¥Nginxçš„é…ç½®æ–‡ä»¶, æ­¤æ¨¡å—ä¸éšNginxæºä¸€èµ·åˆ†å‘ã€‚</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/openresty/echo-nginx-module</span></span><br><span class="line">wget --no-check-certificate -c https://github.com/openresty/<span class="built_in">echo</span>-nginx-module/archive/refs/tags/v0.62.tar.gz -O /usr/<span class="built_in">local</span>/src/<span class="built_in">echo</span>-nginx-module-v0.62.tar.gz</span><br><span class="line">tar -zxf <span class="built_in">echo</span>-nginx-module-v0.62.tar.gz &amp;&amp; ls <span class="built_in">echo</span>-nginx-module-0.62</span><br><span class="line">  <span class="comment"># config  LICENSE  README.markdown  src  t  util  valgrind.suppress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># luajit2 - lua è§£æå™¨ LuaJIT 2 OpenResty çš„åˆ†æ”¯ï¼Œä¸”æ³¨æ„è§£æå™¨çš„Luaç‰ˆæœ¬ä¸º5.1</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/openresty/luajit2 </span></span><br><span class="line">wget -c  https://github.com/openresty/luajit2/archive/refs/tags/v2.1-20220411.tar.gz -O /usr/<span class="built_in">local</span>/src/luajit2-v2.1-20220411.tar.gz</span><br><span class="line">tar -zxvf luajit2-v2.1-20220411.tar.gz &amp;&amp; <span class="built_in">cd</span> luajit2-2.1-20220411</span><br><span class="line">make PREFIX=/usr/<span class="built_in">local</span>/luajit &amp;&amp; make install PREFIX=/usr/<span class="built_in">local</span>/luajit</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/luajit/bin/luajit /usr/<span class="built_in">local</span>/bin/luajit</span><br><span class="line"></span><br><span class="line"><span class="comment"># é“¾æ¥åº“è®¾ç½®</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/usr/local/luajit/lib"</span> &gt;&gt; /etc/ld.so.conf.d/libc.conf</span><br><span class="line">ldconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸´æ—¶ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/luajit/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/luajit/include/luajit-2.1</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/luajit -v</span><br><span class="line">  <span class="comment"># LuaJIT 2.1.0-beta3 -- Copyright (C) 2005-2017 Mike Pall. http://luajit.org/</span></span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: ä¸Šè¿° lua è§£æå™¨æ­¤å¤„é‡‡ç”¨çš„æ˜¯ LuaJIT å®˜æ–¹çš„ OpenResty åˆ†æ”¯, è€Œä¸æ˜¯ luajit çš„ä¸»åˆ†æ”¯<code>https://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz</code>ï¼Œåé¢å…¥å‘å‡ºå‘ä¼šè§£é‡Šä¸ºå•¥è¿™æ ·åšã€‚</p>
<p><br/></p>
<p>Step 4.ä¸ºäº†ä½¿Nginxå¯ä»¥è¿æ¥åˆ°redisæ•°æ®åº“ä¸­æ‰§è¡Œä¸€äº›åˆ—æ“ä½œï¼Œæ­¤å¤„å€ŸåŠ©äºlua-nginx-moduleæ¨¡å—ä¸‹è½½å¹¶è§£å‹æ‰€éœ€çš„lua-resty-coreã€lua-resty-lrucacheã€lua-resty-redisã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="comment"># åŸºäº FFI çš„ lua-nginx-module API</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/openresty/lua-resty-core</span></span><br><span class="line">wget -c https://github.com/openresty/lua-resty-core/archive/refs/tags/v0.1.23.tar.gz -O /usr/<span class="built_in">local</span>/src/lua-resty-core.tar.gz</span><br><span class="line">tar -zxvf lua-resty-core.tar.gz &amp;&amp; ls lua-resty-core-0.1.23</span><br><span class="line">  <span class="comment"># dist.ini  lib  Makefile  README.markdown  t  valgrind.suppress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºäº LuaJIT FFI çš„ Lua-land LRU Cache</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/openresty/lua-resty-lrucache</span></span><br><span class="line">wget -c https://github.com/openresty/lua-resty-lrucache/archive/refs/tags/v0.13.tar.gz -O /usr/<span class="built_in">local</span>/src/lua-resty-lrucache-v0.13.tar.gz</span><br><span class="line">tar -zxvf lua-resty-lrucache-v0.13.tar.gz &amp;&amp; ls lua-resty-lrucache-0.13/</span><br><span class="line">  <span class="comment"># dist.ini  lib  Makefile  README.markdown  t  valgrind.suppress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºäº cosocket API çš„ ngx_lua çš„ Lua redis å®¢æˆ·ç«¯é©±åŠ¨</span></span><br><span class="line"><span class="comment"># é¡¹ç›®åœ°å€: https://github.com/openresty/lua-resty-redis</span></span><br><span class="line">wget -c https://github.com/openresty/lua-resty-redis/archive/refs/tags/v0.29.tar.gz -O /usr/<span class="built_in">local</span>/src/lua-resty-redis-v0.29.tar.gz</span><br><span class="line">tar -zxvf lua-resty-redis-v0.29.tar.gz &amp;&amp; ls lua-resty-redis-0.29/</span><br><span class="line"><span class="comment"># åœ¨ä½¿ç”¨æ—¶å¯å°†luaè„šæœ¬æ”¾å…¥åˆ°nginxé…ç½®ç›®å½•ä¸­ã€‚</span></span><br><span class="line">mkdir -vp /usr/<span class="built_in">local</span>/nginx/lua/</span><br><span class="line">cp -a  /usr/<span class="built_in">local</span>/src/lua-resty-redis-0.29/lib /usr/<span class="built_in">local</span>/nginx/lua/</span><br><span class="line"><span class="comment"># ä»¥æ ‘å½¢ç»“æ„æ˜¾ç¤ºè¯¥ç›®å½•</span></span><br><span class="line">$ tree /usr/<span class="built_in">local</span>/nginx/lua/</span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/lua/</span><br><span class="line">â”œâ”€â”€ hello.lua</span><br><span class="line">â””â”€â”€ lib</span><br><span class="line">    â””â”€â”€ resty</span><br><span class="line">        â””â”€â”€ redis.lua</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>Step 5.åœ¨ä¸Šé¢æ­¥éª¤æ“ä½œå®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥è¿›è¡Œnginxç¼–è¯‘å®‰è£…äº†ï¼Œæ„å»ºæµç¨‹å¦‚ä¸‹(åœ¨åšä¸»çš„å‰é¢è®²è§£çš„Nginxç³»åˆ—æ•™ç¨‹å°±å·²ç»æœ‰è¯¦ç»†è®²è¿° ã€[Nginxè¿›é˜¶å­¦ä¹ ä¹‹æœ€ä½³é…ç½®å®è·µæŒ‡å—][<a href="https://blog.weiyigeek.top/2019/9-1-124.html]ã€‘ï¼Œæ­¤å¤„å°±ä¸åœ¨å¤§ç¯‡å¹…ç´¯è¿°äº†)">https://blog.weiyigeek.top/2019/9-1-124.html]ã€‘ï¼Œæ­¤å¤„å°±ä¸åœ¨å¤§ç¯‡å¹…ç´¯è¿°äº†)</a>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå…è®¸ç”¨æˆ·å’Œç»„,ä¸éœ€è¦å®¶ç›®å½•ä¸ç™»å½•bash</span></span><br><span class="line">useradd -M -s /sbin/nologin nginx </span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º Nginx æ‰€éœ€ç›®å½•</span></span><br><span class="line">sudo mkdir -vp /usr/<span class="built_in">local</span>/nginx/&#123;module,modules,lua&#125; /var/cache/nginx/&#123;client_temp,proxy_temp,fastcgi_temp,uwsgi_temp,scgi_temp&#125;</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.22.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nginx é¢„ç¼–è¯‘å‚æ•°è®¾ç½®</span></span><br><span class="line">./configure \</span><br><span class="line">--prefix=/usr/<span class="built_in">local</span>/nginx \</span><br><span class="line">--user=nginx --group=nginx \</span><br><span class="line">--with-pcre=../pcre-8.45 \</span><br><span class="line">--with-zlib=../zlib-1.2.12 \</span><br><span class="line">--with-openssl=../openssl-1.1.1q \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--conf-path=/usr/<span class="built_in">local</span>/nginx/nginx.conf \</span><br><span class="line">--pid-path=/usr/<span class="built_in">local</span>/nginx/nginx.pid \</span><br><span class="line">--error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span><br><span class="line">--http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span><br><span class="line">--lock-path=/var/run/nginx.lock \</span><br><span class="line">--modules-path=/usr/<span class="built_in">local</span>/nginx/modules \</span><br><span class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp \</span><br><span class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span><br><span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span><br><span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">--with-threads \</span><br><span class="line">--with-http_sub_module --with-http_v2_module \</span><br><span class="line">--with-http_auth_request_module --with-http_realip_module --with-http_secure_link_module \</span><br><span class="line">--with-http_gunzip_module --with-http_gzip_static_module --with-http_ssl_module \</span><br><span class="line">--with-http_slice_module --with-http_stub_status_module --with-http_image_filter_module \</span><br><span class="line">--with-http_dav_module --with-http_flv_module --with-http_mp4_module \</span><br><span class="line">--with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-stream_geoip_module \</span><br><span class="line">--with-mail --with-mail_ssl_module \</span><br><span class="line">--with-http_addition_module --with-http_random_index_module \</span><br><span class="line">--with-compat --with-file-aio \</span><br><span class="line">--with-cc-opt=<span class="string">'-Os -fomit-frame-pointer -g'</span>  \</span><br><span class="line">--with-ld-opt=<span class="string">'-Wl,-rpath,/usr/local/luajit/lib,--as-needed,-O1,--sort-common'</span> \</span><br><span class="line">--add-module=/usr/<span class="built_in">local</span>/src/ngx_devel_kit-0.3.1 \</span><br><span class="line">--add-module=/usr/<span class="built_in">local</span>/src/lua-nginx-module-0.10.21 \</span><br><span class="line">--add-dynamic-module=/usr/<span class="built_in">local</span>/src/<span class="built_in">echo</span>-nginx-module-0.62 \</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘æ„å»ºå®‰è£…</span></span><br><span class="line">make &amp; make install</span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: ä¸Šè¿° <code>./configure</code> ç¼–è¯‘é…ç½®ä¸­ä½¿ç”¨é™æ€é“¾æ¥åº“æ–¹å¼æ¥æ·»åŠ <code>ngx_devel_kit-0.3.1/lua-nginx-module-0.10.21</code>æ¨¡å—ï¼Œ åˆä¸ºäº†æ¼”ç¤ºåŠ å…¥åŠ¨æ€é“¾æ¥åº“çš„ä½¿ç”¨æ–¹å¼ï¼Œæ­¤å¤„ä½¿ç”¨<code>--add-dynamic-module</code>å‚æ•°æŒ‡å®š<code>echo-nginx-module-0.62</code>çš„è§£å‹ç›®å½•ï¼Œå¦‚æœä½¿ç”¨åŠ¨æ€è¿æ¥åº“çš„æ–¹å¼åŠ è½½æ¨¡å—å°†ä¼šåœ¨åç»­å®è·µä¸­å±•ç¤ºã€‚</p>
<p><strong>æ„å»ºç»“æœ:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configure ç»“æœ</span></span><br><span class="line">Configuration summary</span><br><span class="line">  <span class="comment"># + using threads</span></span><br><span class="line">  <span class="comment"># + using PCRE library: ../pcre-8.45</span></span><br><span class="line">  <span class="comment"># + using OpenSSL library: ../openssl-1.1.1q</span></span><br><span class="line">  <span class="comment"># + using zlib library: ../zlib-1.2.12</span></span><br><span class="line">  <span class="comment"># nginx path prefix: "/usr/local/nginx"</span></span><br><span class="line">  <span class="comment"># ....................................</span></span><br><span class="line">  <span class="comment"># nginx http scgi temporary files: "/var/cache/nginx/scgi_temp"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make æ„å»ºå®‰è£…åæç¤ºlibåŠ¨æ€é“¾æ¥åº“åœ°å€ã€‚</span></span><br><span class="line">- add LIBDIR to the <span class="string">'LD_LIBRARY_PATH'</span> environment variable during execution</span><br><span class="line">- add LIBDIR to the <span class="string">'LD_RUN_PATH'</span> environment variable during linking</span><br><span class="line">- use the <span class="string">'-Wl,-rpath -Wl,LIBDIR'</span> linker flag <span class="comment"># æˆ–è€…åœ¨ç¼–è¯‘æ˜¯æ·»åŠ ä¾èµ–çš„Libç›®å½•ã€‚</span></span><br><span class="line">- have your system administrator add LIBDIR to <span class="string">'/etc/ld.so.conf'</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/src/nginx-1.22.0<span class="comment"># ls objs/</span></span><br><span class="line">  <span class="comment"># ls objs/</span></span><br><span class="line">  <span class="comment"># addon         ngx_auto_config.h               </span></span><br><span class="line">  <span class="comment"># autoconf.err  ngx_auto_headers.h              </span></span><br><span class="line">  <span class="comment"># Makefile      ngx_http_echo_module_modules.c  </span></span><br><span class="line">  <span class="comment"># nginx         ngx_http_echo_module_modules.o  </span></span><br><span class="line">  <span class="comment"># ngx_modules.c src</span></span><br><span class="line">  <span class="comment"># nginx.8       ngx_http_echo_module.so   ngx_modules.o</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220730231815.png" target="_blank" title="WeiyiGeek.build Nginx" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220730231815.png" alt="WeiyiGeek.build Nginx" title="" class=""></a>
                <p>WeiyiGeek.build Nginx</p>
            </figure>
<p><br/></p>
<p>Step 6.åœ¨Nginxå®‰è£…éƒ¨ç½²æˆåŠŸåï¼Œä¸ºäº†éªŒè¯Nginx + Luaå®‰è£…ç¯å¢ƒï¼Œæˆ‘ä»¬éœ€è¦å† nginx ä¸»é…ç½®æ–‡ä»¶å…¥å£é…ç½®å¦‚ä¸‹å…³é”®å†…å®¹ï¼Œæ³¨æ„ä¸‹é¢å¸¦æœ‰æ–‡å­—æ³¨é‡Šéƒ¨åˆ†ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ grep -v <span class="string">"^#|^$|#"</span>  /usr/<span class="built_in">local</span>/nginx/conf.d/nginx.conf</span><br><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">  include       mime.types;</span><br><span class="line">  default_type  application/octet-stream;</span><br><span class="line">  <span class="comment"># å»é™¤ log_format å‰è€…çš„æ³¨é‡Šç¬¦ `#`</span></span><br><span class="line">  log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                    <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                    <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">  sendfile        on;</span><br><span class="line">  keepalive_timeout  65;</span><br><span class="line">  <span class="comment"># lua åŒ…æ¨¡å—ä¾èµ–è·¯å¾„</span></span><br><span class="line">  lua_package_path <span class="string">'/usr/local/src/lua-resty-core-0.1.23/lib/?.lua;/usr/local/src/lua-resty-lrucache-0.13/lib/?.lua;'</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment"># æ·»åŠ åŠ è½½nginxå®¶ç›®å½•ä¸‹çš„conf.d/ç›®å½•å­é…ç½®æ–‡ä»¶ (é€šé…ç¬¦)</span></span><br><span class="line">  include conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åå†åˆ›å»ºå­é…ç½®ç›®å½•ä¸demo.weiyigeek.topç«™ç‚¹é…ç½®demo.confæ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹serverå­—æ®µå†…å®¹ç‰‡æ®µã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/nginx/conf.d</span><br><span class="line">tee /usr/<span class="built_in">local</span>/nginx/conf.d/demo.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># https - demo.weiyigeek.top</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name  demo.weiyigeek.top;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  access_log /var/<span class="built_in">log</span>/nginx/demo-access.log main buffer=128k flush=1m;</span><br><span class="line">  <span class="comment"># æ–¹å¼1.content_by_lua_block lua ç‰‡æ®µ</span></span><br><span class="line">  location /hello-lua &#123;</span><br><span class="line">    default_type <span class="string">'text/plain'</span>;</span><br><span class="line">    content_by_lua_block &#123;</span><br><span class="line">      ngx.say(<span class="string">"Hello World! Lua &amp; Nginx ."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment"># æ–¹å¼2.content_by_lua_file lua è„šæœ¬æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">  location /hello-lua-file &#123;</span><br><span class="line">    default_type <span class="string">'text/html'</span>;</span><br><span class="line">    content_by_lua_file ./lua/hello.lua;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ–¹å¼3.access_by_lua åœ¨è¯·æ±‚è®¿é—®é˜¶æ®µå¤„ç†ç”¨äºè®¿é—®æ§åˆ¶ã€‚</span></span><br><span class="line">  location /hello-lua-access &#123;</span><br><span class="line">    default_type <span class="string">'text/html'</span>;</span><br><span class="line">    access_by_lua <span class="string">'</span></span><br><span class="line"><span class="string">      local message = "403 - Hello World! Lua &amp; Nginx  access_by_lua"</span></span><br><span class="line"><span class="string">      ngx.say(message)</span></span><br><span class="line"><span class="string">    '</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ–¹å¼4.content_by_lua åœ¨å†…å®¹å¤„ç†é˜¶æ®µæ¥å—è¯·æ±‚å¹¶è¾“å‡ºå“åº”ã€‚</span></span><br><span class="line">  location /hello-lua-content &#123;</span><br><span class="line">    default_type <span class="string">'text/html'</span>;</span><br><span class="line">    content_by_lua <span class="string">"ngx.print('Hello World!')"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤ºï¼š<code>access_by_lua</code>ä¸ <code>content_by_lua</code> çš„åŒºåˆ«æ˜¯å¯¹äºNginxè¯·æ±‚çš„ä¸åŒå¤„ç†é˜¶æ®µï¼Œå‰è€…æ˜¯è®¿é—®é˜¶æ®µå¤„ç†ç”¨äºè®¿é—®æ§åˆ¶(é€‚ç”¨äº<code>httpã€serverã€locationã€location if</code>)ï¼Œåè€…å†…å®¹å¤„ç†å™¨æ¥å—è¯·æ±‚å¹¶è¾“å‡ºå“åº”ï¼Œé€‚ç”¨äº<code>locationã€location if</code></p>
<p><br/></p>
<p>Step 7.ä¸Šè¿°é…ç½®å®Œæˆåä¸ºäº†éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Œå¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¦‚æœæ˜¾ç¤º successful è¡¨ç¤ºé…ç½®æ²¡æœ‰é—®é¢˜ï¼Œä¹‹åå°±å¯é‡è½½ nginx æœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -t </span><br><span class="line">  <span class="comment"># nginx: the configuration file /usr/local/nginx/nginx.conf syntax is ok</span></span><br><span class="line">  <span class="comment"># nginx: configuration file /usr/local/nginx/nginx.conf test is successful</span></span><br><span class="line"></span><br><span class="line">$ /usr/sbin/nginx -s reload</span><br><span class="line">$ ps -ef | grep <span class="string">"nginx"</span></span><br><span class="line">  <span class="comment"># root      244962       1  0 16:40 ?        00:00:00 nginx: master process nginx</span></span><br><span class="line">  <span class="comment"># nginx     245707  244962  0 21:42 ?        00:00:00 nginx: worker process</span></span><br><span class="line">  <span class="comment"># root      245710  245523  0 21:42 pts/0    00:00:00 grep nginx</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>Step 8.éªŒè¯åŸºæœ¬çš„Nginx+Luaç¯å¢ƒï¼Œæˆ‘ä»¬è®¿é—®ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­çš„åŸŸåå’Œå­ç›®å½•ï¼Œè®¿é—®ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºåˆ™è¡¨ç¤ºç¯å¢ƒOKï¼Œå¦åˆ™è¯·æ’æŸ¥é”™è¯¯æˆ–è€…æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ä¸‹è¿°çš„å…¥å‘å‡ºå‘ä¸­ç›¸å…³é—®é¢˜ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"host:demo.weiyigeek.top"</span> 10.20.172.201/hello-lua</span><br><span class="line">Hello World! Lua &amp; Nginx .</span><br><span class="line"></span><br><span class="line">curl -H <span class="string">"host:demo.weiyigeek.top"</span> 10.20.172.201/hello-lua-file</span><br><span class="line">&lt;h2&gt; Hello world! Lua &amp; Nginx with Hello.lua. &lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">curl -H <span class="string">"host:demo.weiyigeek.top"</span> 10.20.172.201/hello-lua-access</span><br><span class="line">Hello World! Lua &amp; Nginx  access_by_lua</span><br><span class="line"></span><br><span class="line">curl -H <span class="string">"host:demo.weiyigeek.top"</span> 10.20.172.201/hello-lua-content</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220731215547.png" target="_blank" title="WeiyiGeek.demo.weiyigeek.top" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220731215547.png" alt="WeiyiGeek.demo.weiyigeek.top" title="" class=""></a>
                <p>WeiyiGeek.demo.weiyigeek.top</p>
            </figure>
<p><br/></p>
<p><strong>çŸ¥è¯†æ‰©å±•</strong>: ç¼–è¯‘æ„å»ºnginxåæˆ‘ä»¬å¯é€šè¿‡<code>nginx -V</code>å‘½ä»¤æŸ¥çœ‹æ›¾ç»<code>./configure</code>é¢„ç¼–è¯‘å‚æ•°çš„è®¾ç½®ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -V</span><br><span class="line">nginx version: nginx/1.22.0</span><br><span class="line">built by gcc 9.4.0 (Ubuntu 9.4.0-1ubuntu1~20.04.1)</span><br><span class="line">built with OpenSSL 1.1.1q  5 Jul 2022</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/<span class="built_in">local</span>/nginx  </span><br><span class="line">....</span><br><span class="line">--add-module=/usr/<span class="built_in">local</span>/src/lua-nginx-module-0.10.21 --add-dynamic-module=/usr/<span class="built_in">local</span>/src/<span class="built_in">echo</span>-nginx-module-0.62 -</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x02-ä½¿ç”¨å®è·µ"><a href="#0x02-ä½¿ç”¨å®è·µ" class="headerlink" title="0x02 ä½¿ç”¨å®è·µ"></a>0x02 ä½¿ç”¨å®è·µ</h2><h3 id="1-Nginx-å®è·µä½¿ç”¨-echo-nginx-module-æ¨¡å—ä¹‹åŠ¨æ€åŠ è½½é“¾æ¥åº“"><a href="#1-Nginx-å®è·µä½¿ç”¨-echo-nginx-module-æ¨¡å—ä¹‹åŠ¨æ€åŠ è½½é“¾æ¥åº“" class="headerlink" title="1.Nginx å®è·µä½¿ç”¨ echo-nginx-module æ¨¡å—ä¹‹åŠ¨æ€åŠ è½½é“¾æ¥åº“"></a>1.Nginx å®è·µä½¿ç”¨ echo-nginx-module æ¨¡å—ä¹‹åŠ¨æ€åŠ è½½é“¾æ¥åº“</h3><p>æè¿°: ä» NGINX 1.9.11 å¼€å§‹ï¼Œæ‚¨è¿˜å¯ä»¥å°†æ­¤æ¨¡å—ç¼–è¯‘ä¸ºåŠ¨æ€æ¨¡å—ï¼Œæ–¹æ³•æ˜¯åœ¨ä¸Šé¢çš„ <code>./configure</code> å‘½ä»¤è¡Œä¸­ä½¿ç”¨ <code>--add-dynamic-module=PATH</code> é€‰é¡¹è€Œä¸æ˜¯<code>--add-module=PATH</code>é€‰é¡¹ï¼Œç„¶åä½ å¯ä»¥é€šè¿‡ <code>load_module</code> æŒ‡ä»¤åœ¨ä½ çš„ <code>nginx.conf</code> ä¸­æ˜¾å¼åŠ è½½æ¨¡å—ï¼Œæ³¨æ„å¿…é¡»åœ¨ <code>events{}</code> ç‰‡æ®µä¹‹å‰.</p>
<p>æ¨¡å—è¯­æ³•: <a href="https://github.com/openresty/echo-nginx-module#synopsis" target="_blank" rel="noopener">https://github.com/openresty/echo-nginx-module#synopsis</a></p>
<p>Step 1.åœ¨<code>Nginx.conf</code>æ–‡ä»¶ä¸­é…ç½®<code>load_module</code>æŒ‡ä»¤ä»¥åŠ¨æ€åŠ è½½ <code>echo-nginx-module</code> æ¨¡å—ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1.ç»å¯¹è·¯å¾„</span></span><br><span class="line">load_module /usr/<span class="built_in">local</span>/nginx/modules/ngx_http_echo_module.so;</span><br><span class="line"><span class="comment"># æ–¹å¼2.ç›¸å¯¹è·¯å¾„</span></span><br><span class="line">load_module ./modules/ngx_http_echo_module.so;</span><br><span class="line">.....</span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections  1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>Step 2.åŒæ ·åœ¨<code>demo.conf</code>æ–‡ä»¶ä¸­çš„è¿›è¡Œè¯¥æ¨¡å—å¸¸è§„çš„ä½¿ç”¨å®è·µã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">$ cat conf.d/demo.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment"># ç¤ºä¾‹1.å¸¸è§„è¾“å‡º(æ³¨æ„æ–‡æœ¬ç±»å‹åˆ™ç½‘é¡µä¸­åé¦ˆå±•ç°æ•°æ®ä¹Ÿä¸ç›¸åŒ)ã€‚</span></span><br><span class="line">  location /nginx-module/<span class="built_in">echo</span> &#123;</span><br><span class="line">    default_type <span class="string">'text/html'</span>;</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"&lt;b&gt;Domain: demo.weiyigeek.top&lt;/b&gt; &lt;br/&gt;"</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Hello World! by ngx_http_echo_module.so"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç¤ºä¾‹2.è¯·æ±‚å»¶æ—¶æ˜¾ç¤ºä»¥åŠé‡ç½®æ—¶é—´å®šæ—¶å™¨ã€‚</span></span><br><span class="line">  location /nginx-module/timed &#123;</span><br><span class="line">    default_type <span class="string">'text/plain'</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Hello World! by ngx_http_echo_module.so \r"</span>;</span><br><span class="line">    echo_reset_timer;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"1.takes about <span class="variable">$echo_timer_elapsed</span> sec \r"</span>;</span><br><span class="line">    echo_flush;</span><br><span class="line">    echo_sleep 2.5;  <span class="comment"># in sec</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"2.takes about <span class="variable">$echo_timer_elapsed</span> sec."</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"End"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç¤ºä¾‹3.Bodyæ–‡æ¡£å‰åæ’å…¥æ•°æ®ä»¥åŠåœ¨ä¸­éƒ¨æ’åµŒå…¥åå‘ä»£ç†ç½‘ç«™æºç ã€‚</span></span><br><span class="line">  location /nginx-module/body &#123;</span><br><span class="line">    resolver 223.6.6.6;</span><br><span class="line">    default_type <span class="string">'text/html'</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Hello World! by ngx_http_echo_module.so"</span>;</span><br><span class="line">    echo_before_body <span class="string">'Blog - '</span>;</span><br><span class="line">    proxy_pass <span class="variable">$scheme</span>://www.weiyigeek.top:<span class="variable">$server_port</span>/index.html;</span><br><span class="line">    echo_before_body <span class="string">'www.WeiyiGeek.top'</span>;</span><br><span class="line">    echo_after_body <span class="string">'[END]'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç¤ºä¾‹4.å¤šæ¬¡è¾“å‡ºåŒä¸€ä¸ªå­—ç¬¦ä¸²ä»¥åŠæ˜¾ç¤ºå®¢æˆ·ç«¯è¯·æ±‚headerä¸è¯·æ±‚bodyä¸»ä½“å‚æ•°</span></span><br><span class="line">  location /nginx-module/duplicate &#123;</span><br><span class="line">    default_type <span class="string">'text/plain'</span>;</span><br><span class="line">    echo_duplicate 3 <span class="string">"--"</span>;</span><br><span class="line">    echo_duplicate 1 <span class="string">"\rHello World! by ngx_http_echo_module.so \r\r"</span>;</span><br><span class="line">    <span class="comment"># echo_duplicate 1000_000 "Hello World! by ngx_http_echo_module.so";</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"\r"</span>;</span><br><span class="line">    echo_duplicate 1 <span class="variable">$echo_client_request_headers</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"\r"</span>;</span><br><span class="line">    echo_read_request_body;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"\r"</span>;</span><br><span class="line">    echo_request_body;</span><br><span class="line">    echo_duplicate 3 <span class="string">"--"</span>;</span><br><span class="line">    <span class="built_in">echo</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># ç¤ºä¾‹5.æ­£åˆ™åŒ¹é…è¯·æ±‚å‚æ•°ï¼Œæ³¨æ„`$arg_var`åé¢çš„varæ˜¯å¯ä»¥è‡ªå®šä¹‰è®¾ç½®ï¼Œæ­¤å¤„ä¸ºflagå‚æ•°ã€‚</span></span><br><span class="line">  location ^~ /nginx-module/<span class="keyword">if</span> &#123;</span><br><span class="line">    default_type <span class="string">'text/plain'</span>;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$res</span> default;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$arg_flag</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$arg_flag</span> ~* <span class="string">'^a'</span>) &#123;</span><br><span class="line">      <span class="built_in">set</span> <span class="variable">$res</span> change;</span><br><span class="line">      <span class="built_in">echo</span> <span class="variable">$arg_flag</span>, <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$res</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¡¥å…… echo_subrequest_async å¼‚æ­¥è¯·æ±‚</strong><br>æè¿°: ä½¿ç”¨ HTTP æ–¹æ³•ã€å¯é€‰çš„ url å‚æ•°ï¼ˆæˆ–æŸ¥è¯¢å­—ç¬¦ä¸²ï¼‰å’Œå¯é€‰çš„è¯·æ±‚ä¸»ä½“å‘èµ·å¼‚æ­¥å­è¯·æ±‚ï¼Œè¯·æ±‚ä¸»ä½“å¯ä»¥å®šä¹‰ä¸ºå­—ç¬¦ä¸²æˆ–åŒ…å«ä¸»ä½“çš„æ–‡ä»¶çš„è·¯å¾„ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /multi will yields</span></span><br><span class="line"> <span class="comment">#   querystring: foo=Foo</span></span><br><span class="line"> <span class="comment">#   method: POST</span></span><br><span class="line"> <span class="comment">#   body: hi</span></span><br><span class="line"> <span class="comment">#   content length: 2</span></span><br><span class="line"> <span class="comment">#   ///</span></span><br><span class="line"> <span class="comment">#   querystring: bar=Bar</span></span><br><span class="line"> <span class="comment">#   method: PUT</span></span><br><span class="line"> <span class="comment">#   body: hello</span></span><br><span class="line"> <span class="comment">#   content length: 5</span></span><br><span class="line"> <span class="comment">#   ///</span></span><br><span class="line"> location /multi &#123;</span><br><span class="line">     echo_subrequest_async POST <span class="string">'/sub'</span> -q <span class="string">'foo=Foo'</span> -b <span class="string">'hi'</span>;</span><br><span class="line">     echo_subrequest_async PUT <span class="string">'/sub'</span> -q <span class="string">'bar=Bar'</span> -b <span class="string">'hello'</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> location /sub &#123;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">"querystring: <span class="variable">$query_string</span>"</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">"method: <span class="variable">$echo_request_method</span>"</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">"body: <span class="variable">$echo_request_body</span>"</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">"content length: <span class="variable">$http_content_length</span>"</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">'///'</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 3.å®Œæˆé…ç½®åé‡è½½nginxæœåŠ¡, é€šè¿‡æµè§ˆå™¨è®¿é—®ä¸Šè¿°è·¯å¾„éªŒè¯æ¨¡å—ä½¿ç”¨ä¸è¾“å‡ºï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220801143605.png" target="_blank" title="WeiyiGeek.use ngx_http_echo_module" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220801143605.png" alt="WeiyiGeek.use ngx_http_echo_module" title="" class=""></a>
                <p>WeiyiGeek.use ngx_http_echo_module</p>
            </figure>
<p>è¯¥æ¨¡å—çš„å…¶å®ƒä½¿ç”¨è¯·å‚è€ƒå…¶é¡¹ç›®åœ°å€Readmeæ–‡æ¡£ï¼Œæ­¤å¤„æ¼”ç¤ºäº†å¦‚ä½•åŠ è½½åŠ¨æ€é“¾æ¥åº“åˆ°nginx,å¹¶ä¸”ä½¿ç”¨é“¾æ¥åº“ä¸­çš„æ¨¡å—ã€‚</p>
<p><br/></p>
<h3 id="2-Nginx-å®è·µä½¿ç”¨-lua-resty-redis-æ¨¡å—è¿æ¥-Redis-è¿›è¡Œæ•°æ®æ“ä½œä¸å±•ç¤º"><a href="#2-Nginx-å®è·µä½¿ç”¨-lua-resty-redis-æ¨¡å—è¿æ¥-Redis-è¿›è¡Œæ•°æ®æ“ä½œä¸å±•ç¤º" class="headerlink" title="2.Nginx å®è·µä½¿ç”¨ lua-resty-redis æ¨¡å—è¿æ¥ Redis è¿›è¡Œæ•°æ®æ“ä½œä¸å±•ç¤º"></a>2.Nginx å®è·µä½¿ç”¨ lua-resty-redis æ¨¡å—è¿æ¥ Redis è¿›è¡Œæ•°æ®æ“ä½œä¸å±•ç¤º</h3><p>æè¿°: å‰é¢ç¯å¢ƒéƒ¨ç½²ä¸­å·²ä¸‹è½½ ngx_lua_nginx æ¨¡å—çš„ Redis å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºLuaåº“, ä¸‹é¢å°†æ¼”ç¤ºå¦‚ä½•åœ¨ Nginx åŸºäº ngx_lua_nginx æ¨¡å—è¿æ¥åˆ°Rediså†…å­˜æ•°æ®åº“è¿›è¡Œç›¸åº”æ•°æ®æŸ¥æ‰¾ï¼Œå¥½äº†æœ¬å°èŠ‚å°±ç›´å¥”ä¸»é¢˜ã€‚</p>
<p>è¯­æ³•å‚è€ƒ: <a href="https://github.com/openresty/lua-resty-redis#synopsis" target="_blank" rel="noopener">https://github.com/openresty/lua-resty-redis#synopsis</a></p>
<p><strong>åºŸè¯ä¸å¤šè¯´ï¼Œå®è·µå‡ºçœŸçŸ¥</strong></p>
<p>Step 1.åœ¨å‰é¢ç¯å¢ƒå®‰è£…ä¸­æˆ‘ä»¬è§£å‹åœ¨ ngx_lua_nginx æ¨¡å—ä½¿ç”¨ Redis å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºLuaåº“ï¼Œå¹¶å°†å…¶ Lib ç›®å½•å¤åˆ¶åˆ° <code>/usr/local/nginx/lua/</code> ç›®å½•ä¸­ï¼Œå…¶æ¬¡æˆ‘ä¹Ÿå‡†å¤‡äº†Redisæ•°æ®åº“ç¯å¢ƒï¼Œé’ˆå¯¹å®‰è£…éƒ¨ç½²æ­¥éª¤å°±ä¸åœ¨è¯¦è¿°äº†, æƒ³è¦å¿«é€Ÿå®‰è£…çš„æœ‹å‹å¯ä»¥å‚è€ƒæˆ‘çš„æ­¤ç¯‡æ–‡ç« ã€[Rediså†…å­˜æ•°æ®åº“ç¯å¢ƒå¿«é€Ÿæ­å»ºéƒ¨ç½²][<a href="https://blog.weiyigeek.top/2022/4-24-653.html]ã€‘ã€‚">https://blog.weiyigeek.top/2022/4-24-653.html]ã€‘ã€‚</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ tree /usr/<span class="built_in">local</span>/nginx/lua/lib/</span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/lua/lib/</span><br><span class="line">â””â”€â”€ resty</span><br><span class="line">    â””â”€â”€ redis.lua</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis æ•°æ®åº“ &amp; ä¸ºäº†æ¼”ç¤ºæ•°æ®å‡†å¤‡ä¸¤ä¸ªKeyå³domain/blog</span></span><br><span class="line">192.168.1.22 6379 weiyigeek.top</span><br><span class="line">/data <span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; auth  weiyigeek.top</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> domain www.weiyigeek.top </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> blog blog.weiyigeek.top</span><br><span class="line">OK</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 2.æƒ³è¦åœ¨Nginxä½¿ç”¨è¯¥<code>redis.lua</code>é“¾æ¥åˆ°æ•°æ®åº“ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨<code>nginx.conf</code>é…ç½®æ–‡ä»¶ä¸­åŠ å…¥è¯¥luaåŒ…è·¯å¾„<code>/usr/local/nginx/lua/lib/</code>ï¼Œä¾‹å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep &quot;lua_package_path&quot; &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">lua_package_path &#39;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;lua&#x2F;lib&#x2F;?.lua;&#x2F;usr&#x2F;local&#x2F;src&#x2F;lua-resty-core-0.1.23&#x2F;lib&#x2F;?.lua;&#x2F;usr&#x2F;local&#x2F;src&#x2F;lua-resty-lrucache-0.13&#x2F;lib&#x2F;?.lua;&#39;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 3.æ­¤å¤„ä¹Ÿæ˜¯åœ¨ <code>demo.conf</code> ä¸­è¿›è¡Œé…ç½®ä½¿ç”¨Rediså®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºLuaåº“ï¼Œè¿æ¥åˆ°Redisæ•°æ®åº“ä¸­, æ­¤å¤„ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºå°±ç›´æ¥åœ¨è¯¥é…ç½®æ–‡ä»¶<code>content_by_lua_block</code> ä»£ç å—ä¸­ä½¿ç”¨luaè¯­æ³•ï¼Œåœ¨ä¼ä¸šç”Ÿäº§å®è·µç¯å¢ƒä¸­ä¸€å®šè¦å°†å…¶å†™å…¥åˆ°luaæ–‡ä»¶æ–‡ä»¶ä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/local/nginx/conf.d/demo.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">...</span><br><span class="line">  location /redis/get &#123;</span><br><span class="line">    default_type <span class="string">'text/html'</span>;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;</span><br><span class="line">    content_by_lua_block &#123;</span><br><span class="line">      -- <span class="comment"># å¼•å…¥resty.redisæ¨¡å—ä¸åˆ›å»ºå®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">      <span class="built_in">local</span> redis = require <span class="string">"resty.redis"</span></span><br><span class="line">      <span class="built_in">local</span> client = redis:new()</span><br><span class="line">      <span class="built_in">local</span> REDIS_HOST = <span class="string">"192.168.1.22"</span></span><br><span class="line">      <span class="built_in">local</span> REDIS_PROT = 6379</span><br><span class="line">      <span class="built_in">local</span> REDIS_AUTH = <span class="string">"weiyigeek.top"</span></span><br><span class="line">      -- <span class="comment"># ngx.log(ngx.ERR, ngx.var.key)</span></span><br><span class="line">      -- <span class="comment"># åˆ†åˆ«è®¾ç½®è¿æ¥ã€å‘é€å’Œè¯»å–è¶…æ—¶é˜ˆå€¼ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ï¼Œç”¨äºåç»­å¥—æ¥å­—æ“ä½œã€‚</span></span><br><span class="line">      client:set_timeouts(1000, 1000, 1000)</span><br><span class="line">  </span><br><span class="line">      -- <span class="comment"># åˆ›å»ºé“¾æ¥å¯¹è±¡, è¿æ¥åˆ°Redisæ•°æ®åº“</span></span><br><span class="line">      ngx.say(<span class="string">"1.connect redis server..... &lt;br&gt;"</span>);</span><br><span class="line">      <span class="built_in">local</span> ok, err = client:connect(REDIS_HOST, REDIS_PROT)</span><br><span class="line">      <span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">"failed to connect: "</span>, err)</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">      end</span><br><span class="line">  </span><br><span class="line">      -- <span class="comment"># è®¤è¯</span></span><br><span class="line">      ngx.say(<span class="string">"2.auth redis server..... &lt;br&gt;"</span>);</span><br><span class="line">      <span class="built_in">local</span> res, err = client:auth(REDIS_AUTH)</span><br><span class="line">      <span class="keyword">if</span> not res <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">"failed to authenticate: "</span>, err)</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">      end</span><br><span class="line">  </span><br><span class="line">      -- <span class="comment"># è·å–æŒ‡å®šè¯·æ±‚é”®å€¼</span></span><br><span class="line">      ngx.say(<span class="string">"3.get custom KV for redis server, Key = "</span>,ngx.var.key,<span class="string">" &lt;br&gt;"</span>);</span><br><span class="line">      <span class="built_in">local</span> res, err = client:get(ngx.var.key)</span><br><span class="line">      <span class="keyword">if</span> not res <span class="keyword">then</span></span><br><span class="line">          ngx.say(<span class="string">"failed to get key: "</span>, err)</span><br><span class="line">          <span class="built_in">return</span></span><br><span class="line">      end</span><br><span class="line">      <span class="keyword">if</span> res == ngx.null <span class="keyword">then</span></span><br><span class="line">          ngx.say(<span class="string">"key not found."</span>)</span><br><span class="line">          <span class="built_in">return</span></span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      -- <span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">      ngx.say(<span class="string">"&lt;b style='color:red'&gt;4.result value: "</span>,res,<span class="string">"&lt;/b&gt;&lt;br/&gt;"</span>)</span><br><span class="line"></span><br><span class="line">      -- <span class="comment"># ä½¿ç”¨å®Œæ¯•åç«‹å³å…³é—­é”€æ¯Redisè¿æ¥(çŸ­è¿æ¥å¯ä»¥å¦‚æ­¤ä½¿ç”¨,å¦‚æœæ˜¯é•¿é“¾æ¥å»ºè®®å›æ”¶è¯¥è¿æ¥æ± å¯¹è±¡å³å¯)</span></span><br><span class="line">      <span class="built_in">local</span> ok, err = client:close()</span><br><span class="line">      <span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">"failed to close: "</span>, err)</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        ngx.say(<span class="string">"5.just close the Redis connection right away &lt;br/&gt;"</span>)</span><br><span class="line">      end</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220801161649.png" target="_blank" title="WeiyiGeek.Lua-redis-demo1" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220801161649.png" alt="WeiyiGeek.Lua-redis-demo1" title="" class=""></a>
                <p>WeiyiGeek.Lua-redis-demo1</p>
            </figure>
<p><br/></p>
<p>Step 5.åœ¨æ¼”ç¤ºä¸€ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§æ‰§è¡Œå¤šä¸ªredisæ“ä½œå‘½ä»¤ lua-resty-redis åº“æ”¯æŒpipelineæäº¤ï¼Œä¸‹é¢æˆ‘ä»¬æ¼”ç¤ºä½¿ç”¨ <code>content_by_lua_file</code> å…³é”®å­—æŒ‡å®šè¿æ¥æ“ä½œredisçš„luaè„šæœ¬åœ°å€(<code>/usr/local/nginx/lua/custom/nginx-redis.lua</code>)å®è·µ, è¯¥æ–¹å¼åœ¨çº¿ä¸Šç¯å¢ƒä¸­æ¨èä½¿ç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) æ“ä½œ redis æ•°æ®åº“çš„ lua è„šæœ¬ç¤ºä¾‹ã€‚</span></span><br><span class="line">tee /usr/<span class="built_in">local</span>/nginx/lua/custom/nginx-redis.lua &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">-- <span class="comment"># å¼•å…¥resty.redisæ¨¡å—ä¸åˆ›å»ºå®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line"><span class="built_in">local</span> redis = require <span class="string">"resty.redis"</span></span><br><span class="line"><span class="built_in">local</span> client = redis:new()</span><br><span class="line"><span class="built_in">local</span> REDIS_HOST = <span class="string">"192.168.1.22"</span></span><br><span class="line"><span class="built_in">local</span> REDIS_PROT = 6379</span><br><span class="line"><span class="built_in">local</span> REDIS_AUTH = <span class="string">"weiyigeek.top"</span></span><br><span class="line">-- <span class="comment"># ngx.log(ngx.ERR, ngx.var.key)</span></span><br><span class="line">-- <span class="comment"># åˆ†åˆ«è®¾ç½®è¿æ¥ã€å‘é€å’Œè¯»å–è¶…æ—¶é˜ˆå€¼ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ï¼Œç”¨äºåç»­å¥—æ¥å­—æ“ä½œã€‚</span></span><br><span class="line">client:set_timeouts(1000, 1000, 1000)</span><br><span class="line"></span><br><span class="line">-- <span class="comment"># éªŒè¯è¯·æ±‚çš„å‚æ•°æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="keyword">if</span> (ngx.var.key == ngx.null and ngx.var.value == ngx.null) </span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  ngx.say(<span class="string">"Request parameters : key + value not found!"</span>)</span><br><span class="line">  ngx.exit(404)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- <span class="comment"># åˆ›å»ºé“¾æ¥å¯¹è±¡, è¿æ¥åˆ°Redisæ•°æ®åº“</span></span><br><span class="line">ngx.say(<span class="string">"1.connect redis server..... &lt;br&gt;"</span>);</span><br><span class="line"><span class="built_in">local</span> ok, err = client:connect(REDIS_HOST, REDIS_PROT)</span><br><span class="line"><span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">  ngx.say(<span class="string">"failed to connect: "</span>, err)</span><br><span class="line">  <span class="built_in">return</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- <span class="comment"># è®¤è¯</span></span><br><span class="line">ngx.say(<span class="string">"2.auth redis server..... &lt;br&gt;"</span>);</span><br><span class="line"><span class="built_in">local</span> res, err = client:auth(REDIS_AUTH)</span><br><span class="line"><span class="keyword">if</span> not res <span class="keyword">then</span></span><br><span class="line">  ngx.say(<span class="string">"failed to authenticate: "</span>, err)</span><br><span class="line">  <span class="built_in">return</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- <span class="comment"># ä½¿ç”¨ pipeline é€šé“æ–¹å¼è¿›è¡Œredis æ•°æ®åº“æ“ä½œ</span></span><br><span class="line">client:init_pipeline()</span><br><span class="line">client:<span class="built_in">set</span>(ngx.var.key, ngx.var.value)</span><br><span class="line">client:get(ngx.var.key)</span><br><span class="line">client:get(<span class="string">"domain"</span>)</span><br><span class="line"><span class="built_in">local</span> results, err = client:commit_pipeline()</span><br><span class="line"><span class="keyword">if</span> not results <span class="keyword">then</span></span><br><span class="line">  ngx.say(<span class="string">"failed to commit the pipelined requests: "</span>, err)</span><br><span class="line">  <span class="built_in">return</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- ç»“æœéå†</span><br><span class="line"><span class="keyword">for</span> i, res <span class="keyword">in</span> ipairs(results) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">type</span>(res) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> res[1] == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">          ngx.say(<span class="string">"failed to run command "</span>, i, <span class="string">": "</span>, res[2],<span class="string">"&lt;br/&gt;"</span>)</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        -- process the table value</span><br><span class="line">        ngx.say(<span class="string">"3) 3."</span>,i, <span class="string">": "</span>, res[2],<span class="string">"&lt;br/&gt;"</span>)</span><br><span class="line">      end</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    -- process the scalar value</span><br><span class="line">    ngx.say(<span class="string">"&lt;p style='color:red'&gt;3) "</span>,i,<span class="string">"---"</span>,res,<span class="string">"&lt;/p&gt;"</span>)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- å°†å½“å‰ Redis è¿æ¥ç«‹å³æ”¾å…¥ ngx_lua cosocket è¿æ¥æ± ï¼ˆå°†å…¶æ”¾å…¥å¤§å°ä¸º100çš„è¿æ¥æ± ä¸­ï¼Œæœ€å¤§ç©ºé—²æ—¶é—´ä¸º10ç§’ï¼‰ã€‚</span><br><span class="line"><span class="built_in">local</span> ok, err = client:set_keepalive(10000, 100)</span><br><span class="line"><span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">  ngx.say(<span class="string">"failed to set keepalive: "</span>, err)</span><br><span class="line">  <span class="built_in">return</span></span><br><span class="line">end</span><br><span class="line">ngx.say(<span class="string">"4.å°†å½“å‰ Redis è¿æ¥ç«‹å³æ”¾å…¥ ngx_lua cosocket è¿æ¥æ± &lt;br/&gt;"</span>)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) é…ç½® demo.conf æ–‡ä»¶ åŒæ ·åœ¨ server ç‰‡æ®µä¸­åŠ å…¥å¦‚ä¸‹ location ç‰‡æ®µã€‚</span></span><br><span class="line">server &#123;</span><br><span class="line">....</span><br><span class="line">  location /redis/pipeline &#123;</span><br><span class="line">    default_type <span class="string">'text/html'</span>;</span><br><span class="line">    <span class="comment"># è·å–è¯·æ±‚å‚æ•°ä¸­keyçš„å€¼ä¸valueçš„å€¼å¹¶å­˜æ”¾åˆ°nginxç¯å¢ƒå˜é‡ä¸­</span></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$value</span> <span class="variable">$arg_value</span>;</span><br><span class="line">    <span class="comment"># è°ƒç”¨å¹¶æ‰§è¡ŒæŒ‡å®šçš„luaè„šæœ¬</span></span><br><span class="line">    content_by_lua_file ./lua/custom/nginx-redis.lua;</span><br><span class="line">  &#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨é…ç½®å®Œæˆåæˆ‘ä»¬ä¾¿å¯ä»¥é‡è½½nginxï¼Œå¹¶ä½¿ç”¨è®¿é—®æµè§ˆå™¨è®¿é—®ä¸Šè¿°è·¯å¾„ï¼Œä¾‹å¦‚: <code>http://demo.weiyigeek.top/redis/pipeline?key=name&amp;value=WeiyiGeek</code>ï¼Œæ­¤å¤„æˆ‘æ¼”ç¤ºçš„ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220801174916.png" target="_blank" title="WeiyiGeek.lua-redis-pipeline" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220801174916.png" alt="WeiyiGeek.lua-redis-pipeline" title="" class=""></a>
                <p>WeiyiGeek.lua-redis-pipeline</p>
            </figure>
<p><br></p>
<h3 id="3-Nginx-å®è·µè¯»å–Redisæ•°æ®åº“ä¸­å›¾ç‰‡ç»‘å®šå¯¹åº”é”®å€¼å¹¶è¿›è¡Œå›¾ç‰‡å±•ç¤º"><a href="#3-Nginx-å®è·µè¯»å–Redisæ•°æ®åº“ä¸­å›¾ç‰‡ç»‘å®šå¯¹åº”é”®å€¼å¹¶è¿›è¡Œå›¾ç‰‡å±•ç¤º" class="headerlink" title="3.Nginx å®è·µè¯»å–Redisæ•°æ®åº“ä¸­å›¾ç‰‡ç»‘å®šå¯¹åº”é”®å€¼å¹¶è¿›è¡Œå›¾ç‰‡å±•ç¤º"></a>3.Nginx å®è·µè¯»å–Redisæ•°æ®åº“ä¸­å›¾ç‰‡ç»‘å®šå¯¹åº”é”®å€¼å¹¶è¿›è¡Œå›¾ç‰‡å±•ç¤º</h3><p>æè¿°: å‡å¦‚åœ¨è¿™æ ·ä¸€ä¸ªåœºæ™¯ä¸­ï¼Œä¸ºäº†é¿å…æ¶æ„ç”¨æˆ·éå†æœ‰è§„å¾‹çš„å›¾ç‰‡è¿›è¡Œä¸‹è½½ï¼Œé‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢?</p>
<p>æ–¹æ³•æ˜¯æœ‰å¾—ä½†ä¹Ÿä¸é™äºæœ¬èŠ‚å®è·µçš„æ¡ˆä¾‹ï¼Œæ­¤å¤„æˆ‘ä»¬å¯ä»¥å°†å…¶å›¾ç‰‡åç§°æˆ–è€…å›¾ç‰‡md5å€¼å­˜å…¥åˆ°Redisæ•°æ®åº“ä¸­ä½œä¸ºKeyï¼Œè€Œå®é™…çš„å›¾ç‰‡è·¯å¾„ä½œä¸ºValueï¼Œåœ¨è¯·æ±‚æ—¶æˆ‘ä»¬å°†è¯¥md5å€¼ä½œä¸ºå‚æ•°è¿›è¡Œä¼ å…¥ï¼Œç»è¿‡ Nginx å¯¹è¯·æ±‚å‚æ•°çš„å¤„ç†ï¼Œä½¿ç”¨å‰é¢çš„æ–¹å¼åœ¨ Lua è„šæœ¬ä¸­è¿æ¥Redisï¼Œå¹¶å°†URLä¼ é€’çš„md5å‚æ•°ä½œä¸ºkeyè¿›è¡ŒgetæŸ¥è¯¢ï¼Œå¹¶å°†æŸ¥è¯¢åˆ°çš„å›¾ç‰‡è·¯å¾„ï¼Œåé¦ˆç»™setæŒ‡ä»¤è®¾ç½®çš„å˜é‡ä¹‹ä¸­ï¼Œç„¶åæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ proxy_pass è¿›è¡Œä»£ç†è®¿é—®(åœ°å€æ ä¸­çš„urlä¸ä¼šå˜åŒ–ï¼Œä¿è¯å®é™…çš„å›¾ç‰‡è·¯å¾„)ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥åŠ ä¸Šä¸€ä¸ªå¤´<code>Content-Disposition</code>ç›´æ¥è¿›è¡Œå›¾ç‰‡ä¸‹è½½ã€‚</p>
<p>ä¸åœ¨å¤šè¯´åºŸè¯äº†,åªæœ‰å®è·µæ‰æ˜¯ç‹é“ã€‚</p>
<p><strong>å®è·µæµç¨‹:</strong></p>
<ul>
<li>Step 1.å‡†å¤‡ä¸€ä¸ªå›¾ç‰‡ç›®å½•ä»¥åŠæ”¾å…¥å‡ å¼ å›¾ç‰‡è¿›è¡Œæ¼”ç¤ºï¼Œæ­¤å¤„ä½ å¯ä»¥ä½¿ç”¨å›¾ç‰‡åç§°md5ä¹Ÿå¯ä½¿ç”¨å›¾å½¢æ–‡ä»¶æœ¬èº«md5æ•ˆéªŒå€¼ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ tree /usr/<span class="built_in">local</span>/nginx/html/</span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/html/</span><br><span class="line">â”œâ”€â”€ 50x.html</span><br><span class="line">â”œâ”€â”€ images</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ 1562941454569.jpeg</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ 1562941454570.jpeg</span><br><span class="line">â”‚Â Â  â””â”€â”€ 1562941454571.png</span><br><span class="line">â””â”€â”€ index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶çš„MD5å€¼</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/html/images<span class="comment"># md5sum * | awk '&#123;print "set "$1" "$2&#125;'</span></span><br><span class="line"><span class="built_in">set</span> 6fad4c2466dc7f61fb055021ec65324d  1562941454569.jpeg</span><br><span class="line"><span class="built_in">set</span> 611877180883388de4752ded33a81165  1562941454570.jpeg</span><br><span class="line"><span class="built_in">set</span> 6636d52bfbe068177df5219edf4dd456  1562941454571.png</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥KVåˆ°redisæ•°æ®åº“ä¸­</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> 6fad4c2466dc7f61fb055021ec65324d 1562941454569.jpeg</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> 611877180883388de4752ded33a81165 1562941454570.jpeg</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> 6636d52bfbe068177df5219edf4dd456 1562941454571.png</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 2.åœ¨<code>demo.conf</code>æ–‡ä»¶ä¸­çš„<code>server</code>ç‰‡æ®µä¸­å¢åŠ  <code>location</code> ç‰‡æ®µï¼Œå…¶ä¸­è¿›è¡Œå¦‚ä¸‹é…ç½®:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ vim conf.d/demo.conf</span><br><span class="line">server &#123;</span><br><span class="line">......</span><br><span class="line"> location = /api/v2/images/get &#123;</span><br><span class="line">   resolver 223.6.6.6;</span><br><span class="line">   <span class="built_in">set</span> <span class="variable">$key</span> <span class="variable">$arg_md5sum</span>;</span><br><span class="line">   <span class="built_in">set</span> <span class="variable">$name</span> <span class="string">""</span>;</span><br><span class="line">   access_by_lua_block &#123;</span><br><span class="line">    <span class="built_in">local</span> redis = require <span class="string">"resty.redis"</span></span><br><span class="line">    <span class="built_in">local</span> client = redis:new()</span><br><span class="line">    <span class="built_in">local</span> REDIS_HOST = <span class="string">"192.168.1.22"</span></span><br><span class="line">    <span class="built_in">local</span> REDIS_PROT = 6379</span><br><span class="line">    <span class="built_in">local</span> REDIS_AUTH = <span class="string">"weiyigeek.top"</span></span><br><span class="line">    client:set_timeouts(1000, 1000, 1000)</span><br><span class="line">    <span class="built_in">local</span> ok, err = client:connect(REDIS_HOST, REDIS_PROT)</span><br><span class="line">    <span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">      ngx.say(<span class="string">"failed to connect: "</span>, err)</span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">local</span> res, err = client:auth(REDIS_AUTH)</span><br><span class="line">    <span class="keyword">if</span> not res <span class="keyword">then</span></span><br><span class="line">      ngx.say(<span class="string">"failed to authenticate: "</span>, err)</span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">local</span> res, err = client:get(ngx.var.key)</span><br><span class="line">    <span class="keyword">if</span> not res <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">"failed to get key: "</span>, err)</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">if</span> res == ngx.null <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">"key not found."</span>)</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      -- <span class="comment"># å…³é”®ç‚¹å°†redisä¸­æŒ‡å®šé”®çš„å€¼èµ‹äºˆç»™nginxæŒ‡å®šå˜é‡</span></span><br><span class="line">      ngx.var.name = res</span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">local</span> ok, err = client:set_keepalive(10000, 100)</span><br><span class="line">    <span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">      ngx.say(<span class="string">"failed to set keepalive: "</span>, err)</span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">   &#125;</span><br><span class="line">   proxy_pass <span class="variable">$scheme</span>://<span class="variable">$server_name</span>/images/<span class="variable">$name</span>;</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>åœ¨é…ç½®å®Œæˆåæˆ‘ä»¬é‡è½½ Nginxï¼Œç„¶ååˆ©ç”¨æµè§ˆå™¨è¿›è¡Œè®¿é—®å¦‚ä¸ŠURLï¼Œä¾‹å¦‚<code>http://demo.weiyigeek.top/api/v2/images/get?md5sum=6636d52bfbe068177df5219edf4dd456</code>ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802145343.png" target="_blank" title="WeiyiGeek.access_by_lua_block-proxy_pass" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802145343.png" alt="WeiyiGeek.access_by_lua_block-proxy_pass" title="" class=""></a>
                <p>WeiyiGeek.access_by_lua_block-proxy_pass</p>
            </figure>
<p><br/></p>
<ul>
<li>Step 3.å¦‚æœæˆ‘ä»¬æƒ³é€šè¿‡æµè§ˆå™¨è®¿é—®ä¸Šè¿°åœ°å€å°±ç›´æ¥å¼¹å‡ºæºæ–‡ä»¶åç§°è¿›è¡Œä¸‹è½½çš„ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥åœ¨ <code>proxy_pass</code> ç‰‡æ®µååŠ ä¸Šå¦‚ä¸‹ <code>header</code> å¤´: <code>add_header Content-Disposition &quot;attachment;filename=$name&quot;;</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">proxy_pass <span class="variable">$scheme</span>://<span class="variable">$server_name</span>/images/<span class="variable">$name</span>;</span><br><span class="line">add_header Content-Disposition <span class="string">"attachment;filename=<span class="variable">$name</span>"</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡è½½Nginxååˆ©ç”¨CURLè®¿é—®è¯¥URL</span></span><br><span class="line">$ curl -I http://demo.weiyigeek.top/api/v2/images/get?md5sum=6636d52bfbe068177df5219edf4dd456</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.22.0</span><br><span class="line">Date: Tue, 02 Aug 2022 02:23:12 GMT</span><br><span class="line">Content-Type: image/png</span><br><span class="line">Content-Length: 32641</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Last-Modified: Wed, 23 Mar 2022 00:48:26 GMT</span><br><span class="line">ETag: <span class="string">"623a6e5a-7f81"</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Disposition: attachment;filename=1562941454571.png</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802150239.png" target="_blank" title="WeiyiGeek.proxy_pass-Content-Disposition" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802150239.png" alt="WeiyiGeek.proxy_pass-Content-Disposition" title="" class=""></a>
                <p>WeiyiGeek.proxy_pass-Content-Disposition</p>
            </figure>
<p><br/></p>
<ul>
<li>Step 4.å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä½¿ç”¨<code>rewrite_by_lua_block</code>ä»£ç å—åŒ…å«Luaå¯ç›´æ¥æˆ–è€…å›¾ç‰‡è·¯å¾„ï¼Œç„¶åä½¿ç”¨<code>ngx.redirect()</code>æ–¹æ³•è¿›è¡Œè·³è½¬ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ vim conf.d/demo.conf</span><br><span class="line">server &#123;</span><br><span class="line">......</span><br><span class="line"> location = /api/v1/images/get &#123;</span><br><span class="line">  resolver 223.6.6.6;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$key</span> <span class="variable">$arg_md5sum</span>;</span><br><span class="line">  rewrite_by_lua_block &#123;</span><br><span class="line">    <span class="built_in">local</span> redis = require <span class="string">"resty.redis"</span></span><br><span class="line">    <span class="built_in">local</span> client = redis:new()</span><br><span class="line">    <span class="built_in">local</span> REDIS_HOST = <span class="string">"192.168.1.22"</span></span><br><span class="line">    <span class="built_in">local</span> REDIS_PROT = 6379</span><br><span class="line">    <span class="built_in">local</span> REDIS_AUTH = <span class="string">"weiyigeek.top"</span></span><br><span class="line">    client:set_timeouts(1000, 1000, 1000)</span><br><span class="line">    <span class="built_in">local</span> ok, err = client:connect(REDIS_HOST, REDIS_PROT)</span><br><span class="line">    <span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">      ngx.say(<span class="string">"failed to connect: "</span>, err)</span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">local</span> res, err = client:auth(REDIS_AUTH)</span><br><span class="line">    <span class="keyword">if</span> not res <span class="keyword">then</span></span><br><span class="line">      ngx.say(<span class="string">"failed to authenticate: "</span>, err)</span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">local</span> res, err = client:get(ngx.var.key)</span><br><span class="line">    <span class="keyword">if</span> not res <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">"failed to get key: "</span>, err)</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">if</span> res == ngx.null <span class="keyword">then</span></span><br><span class="line">      ngx.say(<span class="string">"key not found."</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      -- <span class="comment"># å…³é”®ç‚¹å›¾ç‰‡æ ¼å¼åŒ–ã€‚</span></span><br><span class="line">      <span class="built_in">return</span> ngx.redirect(string.format(<span class="string">"%s%s"</span>,<span class="string">"/images/"</span>,res))</span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">local</span> ok, err = client:set_keepalive(10000, 100)</span><br><span class="line">    <span class="keyword">if</span> not ok <span class="keyword">then</span></span><br><span class="line">      ngx.say(<span class="string">"failed to set keepalive: "</span>, err)</span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    end</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment"># è‹¥æ²¡æœ‰åŒ¹é…æ­é…åˆ°è¿›è¡Œè·³è½¬è¿›è¡Œè·³è½¬åˆ™è®¿é—®é¦–é¡µ</span></span><br><span class="line">   proxy_pass <span class="variable">$scheme</span>://<span class="variable">$server_name</span>/index.html;</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç° href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802153937.png" target="_blank" title="WeiyiGeek.rewrite_by_lua_block+ngx.redirect" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220802153937.png" alt="WeiyiGeek.rewrite_by_lua_block+ngx.redirect" title="" class=""></a>
                <p>WeiyiGeek.rewrite_by_lua_block+ngx.redirect</p>
            </figure>
<p>å¥½äº†ï¼Œæœ¬ç« å®è·µå°±åˆ°æ­¤å¤„äº†ï¼Œæ›´å¤šçš„å¥‡æŠ€æ·«å·§å°½åœ¨ [weiyigeek] å…¬ä¼—å·.</p>
<hr>
<h2 id="0x03-æ‰©å±•è¡¥å……"><a href="#0x03-æ‰©å±•è¡¥å……" class="headerlink" title="0x03 æ‰©å±•è¡¥å……"></a>0x03 æ‰©å±•è¡¥å……</h2><p><strong>ç¤ºä¾‹1.ä½¿ç”¨ ngx.location.capture() è¯·æ±‚å†…éƒ¨æ¥å£</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">location = /auth &#123;</span><br><span class="line">  internal;</span><br><span class="line">  retur 200 <span class="string">'&#123;"status":"$auth_status"&#125;'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤å¤„æ ¹æ®ä¸šåŠ¡çš„éœ€æ±‚æ¥å†™æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸€å®šè¦ä¸ª redis é‡Œçš„ KEY  å¯¹åº”ä¸Š</span></span><br><span class="line">location  ~/[0-9].*\.(gif|jpg|jpeg|png)$ &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$target</span> <span class="string">''</span>;</span><br><span class="line">  access_by_lua <span class="string">'</span></span><br><span class="line"><span class="string">  # ä½¿ç”¨ nginx çš„å†…éƒ¨å‚æ•° ngx.var.uri æ¥è·å–è¯·æ±‚çš„ uri åœ°å€ï¼Œå¦‚ /000001.jpg</span></span><br><span class="line"><span class="string">    local key = ngx.var.uri</span></span><br><span class="line"><span class="string">  # æ ¹æ®æ­£åˆ™åŒ¹é…åˆ° KEY ï¼Œä» redis æ•°æ®åº“é‡Œè·å–æ–‡ä»¶ ID (è·¯å¾„å’Œæ–‡ä»¶å)</span></span><br><span class="line"><span class="string">    local res = ngx.location.capture(</span></span><br><span class="line"><span class="string">        "/Redis", &#123; args = &#123; key = key &#125; &#125;</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    if res.status ~= 200 then</span></span><br><span class="line"><span class="string">        ngx.log(ngx.ERR, "Redis server returned bad status: ",res.status)</span></span><br><span class="line"><span class="string">        ngx.exit(res.status)</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    if not res.body then</span></span><br><span class="line"><span class="string">        ngx.log(ngx.ERR, "Redis returned empty body")</span></span><br><span class="line"><span class="string">        ngx.exit(500)</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    local parser = require "Redis.parser"</span></span><br><span class="line"><span class="string">    local filename, typ = parser.parse_reply(res.body)</span></span><br><span class="line"><span class="string">    if typ ~= parser.BULK_REPLY or not server then</span></span><br><span class="line"><span class="string">        ngx.log(ngx.ERR, "bad Redis response: ", res.body)</span></span><br><span class="line"><span class="string">        ngx.exit(500)</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    ngx.var.target = filename</span></span><br><span class="line"><span class="string">  '</span>;</span><br><span class="line">    proxy_pass http://10.20.172.196/<span class="variable">$target</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>ç¤ºä¾‹2.Nginxåœ¨reponseè¿”å›çš„cookieä¸­è®¾ç½®HttpOnly</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> cookies = ngx.header.set_cookie</span><br><span class="line"><span class="keyword">if</span> cookies <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(cookies) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> pairs(cookies) <span class="keyword">do</span></span><br><span class="line">            cookies[k] = v .. <span class="string">"; HttpOnly"</span></span><br><span class="line">            ngx.header.set_cookie = cookies</span><br><span class="line">        end</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">local</span> cookiesStr = cookies .. <span class="string">"; HttpOnly"</span></span><br><span class="line">        ngx.header.set_cookie = cookiesStr;</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure><br>ä»¥ä¸Šè„šæœ¬çš„å«ä¹‰ï¼š</p>
<ul>
<li>è·å– nginx å“åº”ä¿¡æ¯ä¸­çš„cookieä¿¡æ¯</li>
<li>å¦‚æœcookieä¿¡æ¯ä¸ºç©ºï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åˆ¤æ–­æ˜¯å¤šä¸ª cookie è¿˜æ˜¯å•ä¸ª cookie è¿”å›</li>
<li>å¦‚æœæ˜¯å¤šä¸ª cookie çš„è¯ï¼Œåˆ™éå†æ•°ç»„ï¼Œæ¯ä¸ª cookie å­—ç¬¦ä¸²æ‹¼æ¥ â€˜; HttpOnlyâ€™ çš„å­—ç¬¦ä¸²</li>
<li>å¦‚æœæ˜¯å•ä¸ª cookie çš„è¯ï¼Œåˆ™ç›´æ¥æ‹¼æ¥ â€˜; HttpOnlyâ€™ çš„å­—ç¬¦ä¸²</li>
</ul>
<hr>
<h2 id="0x0n-å…¥å‘å‡ºå‘"><a href="#0x0n-å…¥å‘å‡ºå‘" class="headerlink" title="0x0n å…¥å‘å‡ºå‘"></a>0x0n å…¥å‘å‡ºå‘</h2><h3 id="é—®é¢˜1-å½“ç¼–è¯‘-Nginx-æ—¶æŠ¥checking-for-LuaJIT-2-x-not-found-configure-error-unsupported-LuaJIT-version-ngx-http-lua-module-requires-LuaJIT-2-x-é”™è¯¯æ—¶çš„è§£å†³åŠæ³•ã€‚"><a href="#é—®é¢˜1-å½“ç¼–è¯‘-Nginx-æ—¶æŠ¥checking-for-LuaJIT-2-x-not-found-configure-error-unsupported-LuaJIT-version-ngx-http-lua-module-requires-LuaJIT-2-x-é”™è¯¯æ—¶çš„è§£å†³åŠæ³•ã€‚" class="headerlink" title="é—®é¢˜1. å½“ç¼–è¯‘ Nginx æ—¶æŠ¥checking for LuaJIT 2.x ... not found, ./configure: error: unsupported LuaJIT version; ngx_http_lua_module requires LuaJIT 2.x. é”™è¯¯æ—¶çš„è§£å†³åŠæ³•ã€‚"></a>é—®é¢˜1. å½“ç¼–è¯‘ Nginx æ—¶æŠ¥<code>checking for LuaJIT 2.x ... not found, ./configure: error: unsupported LuaJIT version; ngx_http_lua_module requires LuaJIT 2.x.</code> é”™è¯¯æ—¶çš„è§£å†³åŠæ³•ã€‚</h3><p>é—®é¢˜æè¿°: tell nginxâ€™s build system where to find LuaJIT 2.1<br>è§£å†³åŠæ³•:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸´æ—¶ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/luajit/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/luajit/include/luajit-2.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line">tee -a /etc/profile &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/luajit/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/luajit/include/luajit-2.1</span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="é—®é¢˜2-åœ¨ä½¿ç”¨luajitå®˜æ–¹ä¸»åˆ†æ”¯LuaJIT-2-1-0-beta3æä¾›LuaJITå®‰è£…éƒ¨ç½²å‡ºç°nginx-alert-detected-a-LuaJIT-version-which-is-not-OpenResty-39-s-ä»¥åŠnginx-alert-failed-to-load-the-39-resty-core-39-moduleè­¦å‘Šã€‚"><a href="#é—®é¢˜2-åœ¨ä½¿ç”¨luajitå®˜æ–¹ä¸»åˆ†æ”¯LuaJIT-2-1-0-beta3æä¾›LuaJITå®‰è£…éƒ¨ç½²å‡ºç°nginx-alert-detected-a-LuaJIT-version-which-is-not-OpenResty-39-s-ä»¥åŠnginx-alert-failed-to-load-the-39-resty-core-39-moduleè­¦å‘Šã€‚" class="headerlink" title="é—®é¢˜2.åœ¨ä½¿ç”¨luajitå®˜æ–¹ä¸»åˆ†æ”¯LuaJIT-2.1.0-beta3æä¾›LuaJITå®‰è£…éƒ¨ç½²å‡ºç°nginx: [alert] detected a LuaJIT version which is not OpenResty&#39;s;ä»¥åŠnginx: [alert] failed to load the &#39;resty.core&#39; moduleè­¦å‘Šã€‚"></a>é—®é¢˜2.åœ¨ä½¿ç”¨luajitå®˜æ–¹ä¸»åˆ†æ”¯<code>LuaJIT-2.1.0-beta3</code>æä¾›LuaJITå®‰è£…éƒ¨ç½²å‡ºç°<code>nginx: [alert] detected a LuaJIT version which is not OpenResty&#39;s;</code>ä»¥åŠ<code>nginx: [alert] failed to load the &#39;resty.core&#39; module</code>è­¦å‘Šã€‚</h3><p>é”™è¯¯ä¿¡æ¯:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/sbin/nginx </span><br><span class="line">nginx: [alert] detected a LuaJIT version <span class="built_in">which</span> is not OpenResty<span class="string">'s; many optimizations will be disabled and performance will be compromised (see https://github.com/openresty/luajit2 for OpenResty'</span>s LuaJIT or, even better, consider using the OpenResty releases from https://openresty.org/en/download.html)</span><br><span class="line">nginx: [alert] failed to load the <span class="string">'resty.core'</span> module (https://github.com/openresty/lua-resty-core); ensure you are using an OpenResty release from https://openresty.org/en/download.html (reason: module <span class="string">'resty.core'</span> not found:</span><br><span class="line">  no field package.preload[<span class="string">'resty.core'</span>]</span><br><span class="line">  no file <span class="string">'./resty/core.lua'</span></span><br><span class="line">  no file <span class="string">'/usr/local/share/luajit-2.1.0-beta3/resty/core.lua'</span></span><br><span class="line">  no file <span class="string">'/usr/local/share/lua/5.1/resty/core.lua'</span></span><br><span class="line">  no file <span class="string">'/usr/local/share/lua/5.1/resty/core/init.lua'</span></span><br><span class="line">  no file <span class="string">'./resty/core.so'</span></span><br><span class="line">  no file <span class="string">'/usr/local/lib/lua/5.1/resty/core.so'</span></span><br><span class="line">  no file <span class="string">'/usr/local/lib/lua/5.1/loadall.so'</span></span><br><span class="line">  no file <span class="string">'./resty.so'</span></span><br><span class="line">  no file <span class="string">'/usr/local/lib/lua/5.1/resty.so'</span></span><br><span class="line">  no file <span class="string">'/usr/local/lib/lua/5.1/loadall.so'</span>) <span class="keyword">in</span> /usr/<span class="built_in">local</span>/nginx/nginx.conf:117</span><br></pre></td></tr></table></figure><br><br></p>
<p>é—®é¢˜åŸå› 1: æç¤ºLuaJITçš„ç‰ˆæœ¬ä¸åŒ¹é…OpenRestyâ€™så†…æ ¸ç‰ˆæœ¬, è®©æˆ‘ä¸è¦ç”¨è¿™ä¸ªluajitç‰ˆæœ¬ï¼Œå¯ä»¥ç”¨openrestyæä¾›çš„luajitä¼˜åŒ–ç‰ˆæœ¬ï¼Œæˆ–è€…å¹²è„†ç›´æ¥ç”¨openresty,ä¸‹é¢å°†å®‰è£…å¸è½½luajitå®˜ç½‘ç‰ˆæœ¬ï¼Œä¸‹è½½openrestyæä¾›çš„luajitä¼˜åŒ–ç‰ˆæœ¬ï¼ˆå³ä¸Šé¢ç¯å¢ƒå®‰è£…å·²ç»å®è·µäº†ï¼ŒæŒ‰ç…§ä¸Šé¢ç‰ˆæœ¬è¿›è¡Œå®‰è£…ä¸€èˆ¬ä¸ä¼šå­˜åœ¨è¯¥é—®é¢˜ï¼‰ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½ å¯èƒ½ä¼šè¿›è¡Œ Lua è„šæœ¬è§£é‡Šå™¨çš„å®‰è£… LuaJIT </span></span><br><span class="line">http://luajit.org/download.html</span><br><span class="line">wget -c https://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz</span><br><span class="line">tar -zxf LuaJIT-2.1.0-beta3.tar.gz &amp;&amp; <span class="built_in">cd</span> LuaJIT-2.1.0-beta3</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">ln -sf /usr/<span class="built_in">local</span>/bin/luajit-2.1.0-beta3 /usr/<span class="built_in">local</span>/bin/luajit</span><br><span class="line"><span class="comment"># å¸è½½LuaJITå®˜ç½‘ä¸»åˆ†æ”¯ç‰ˆæœ¬ï¼Œç„¶åé‡æ–°å®‰è£…openrestyæä¾›çš„luajitä¼˜åŒ–ç‰ˆå³å¯</span></span><br><span class="line">make uninstall</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure></p>
<p>é—®é¢˜åŸå› 2: æç¤ºåŠ è½½â€™resty.coreâ€™æ¨¡å—å¤±è´¥ï¼Œå…¶è§£å†³åŠæ³•ï¼ŒæŒ‰ç…§<code>https://github.com/openresty/lua-nginx-module/issues/1509</code>ä¸Šé¢æ‰€è¯´,  å®‰è£…<code>lua-resty-core</code>å’Œä¾èµ–æ–‡ä»¶<code>lua-resty-lrucache</code>è§£å†³é—®é¢˜ï¼Œå³æˆ‘å‰é¢å®è·µä¸­å·²ç»è¿›è¡Œæ­¤éƒ¨åˆ†æ“ä½œï¼Œè‹¥ä¸ä¼šæ“ä½œè¯·ä¸Šç¿»åˆ° ã€å®‰è£…éƒ¨ç½²ã€‘æ ‡é¢˜è¿›è¡ŒæŸ¥çœ‹ã€‚</p>
<hr>
<p>åŸæ–‡åœ°å€: <a href="https://blog.weiyigeek.top/2022/7-2-676.html">https://blog.weiyigeek.top/2022/7-2-676.html</a></p>

        </div>
        <!-- Google å¹¿å‘Š -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-09-08T07:41:17.197Z" itemprop="dateUpdated">2022-09-08 15:41:17</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/ç³»ç»Ÿè¿ç»´/Application/Web/WebApp/Nginx/7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°.md" target="_blank" rel="noopener noreferrer">_posts/ç³»ç»Ÿè¿ç»´/Application/Web/WebApp/Nginx/7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2022/7-2-676.html" target="_blank" rel="external">https://blog.weiyigeek.top/2022/7-2-676.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lua/" rel="tag">Lua</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2022/7-2-676.html&title=ã€Š7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2022/7-2-676.html&title=ã€Š7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°ã€‹ â€” WeiyiGeek Blog&source=æœ¬ç« ç›®å½•
[TOC]

0x00 å‰è¨€ç®€è¿°ä¸ºå•¥æœ‰æ­¤ç¯‡æ–‡ç« ?æè¿°: åœ¨è¿›è¡Œå…¬å¸çš„å›¾ç‰‡å­˜å‚¨è§£å†³æ–¹æ¡ˆç ”ç©¶ä¸­ï¼Œæœ€å¼€å§‹å‡†å¤‡ä½¿ç”¨çš„æ˜¯FastDFSï¼Œä½†æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘ï¼Œ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2022/7-2-676.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2022/7-2-676.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2022/7-2-676.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2022/7-3-677.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">8.Nginxå®è·µä¹‹è¯·æ±‚å›¾ç‰‡è½¬æ¢ä¸ºGoogleæ¨å‡ºçš„webpæ ¼å¼è½¬æ¢å·¥å…·å®è·µ</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2022/6-21-659.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">å®å¾·PowerLeaderæœåŠ¡å™¨åŸºç¡€çŸ¥è¯†ä¸ç®¡ç†</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 å‰è¨€ç®€è¿°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#çŸ¥è¯†å¼•å…¥"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">çŸ¥è¯†å¼•å…¥</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Luaæ¨¡å—æŒ‡ä»¤é˜¶æ®µ"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Luaæ¨¡å—æŒ‡ä»¤é˜¶æ®µ</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-éƒ¨ç½²ç¯å¢ƒ"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 éƒ¨ç½²ç¯å¢ƒ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å®‰è£…è¯´æ˜"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">å®‰è£…è¯´æ˜</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å®‰è£…éƒ¨ç½²"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">å®‰è£…éƒ¨ç½²</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-ä½¿ç”¨å®è·µ"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 ä½¿ç”¨å®è·µ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Nginx-å®è·µä½¿ç”¨-echo-nginx-module-æ¨¡å—ä¹‹åŠ¨æ€åŠ è½½é“¾æ¥åº“"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.Nginx å®è·µä½¿ç”¨ echo-nginx-module æ¨¡å—ä¹‹åŠ¨æ€åŠ è½½é“¾æ¥åº“</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-Nginx-å®è·µä½¿ç”¨-lua-resty-redis-æ¨¡å—è¿æ¥-Redis-è¿›è¡Œæ•°æ®æ“ä½œä¸å±•ç¤º"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.Nginx å®è·µä½¿ç”¨ lua-resty-redis æ¨¡å—è¿æ¥ Redis è¿›è¡Œæ•°æ®æ“ä½œä¸å±•ç¤º</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-Nginx-å®è·µè¯»å–Redisæ•°æ®åº“ä¸­å›¾ç‰‡ç»‘å®šå¯¹åº”é”®å€¼å¹¶è¿›è¡Œå›¾ç‰‡å±•ç¤º"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.Nginx å®è·µè¯»å–Redisæ•°æ®åº“ä¸­å›¾ç‰‡ç»‘å®šå¯¹åº”é”®å€¼å¹¶è¿›è¡Œå›¾ç‰‡å±•ç¤º</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-æ‰©å±•è¡¥å……"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 æ‰©å±•è¡¥å……</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x0n-å…¥å‘å‡ºå‘"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x0n å…¥å‘å‡ºå‘</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é—®é¢˜1-å½“ç¼–è¯‘-Nginx-æ—¶æŠ¥checking-for-LuaJIT-2-x-not-found-configure-error-unsupported-LuaJIT-version-ngx-http-lua-module-requires-LuaJIT-2-x-é”™è¯¯æ—¶çš„è§£å†³åŠæ³•ã€‚"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">é—®é¢˜1. å½“ç¼–è¯‘ Nginx æ—¶æŠ¥checking for LuaJIT 2.x ... not found, .&#x2F;configure: error: unsupported LuaJIT version; ngx_http_lua_module requires LuaJIT 2.x. é”™è¯¯æ—¶çš„è§£å†³åŠæ³•ã€‚</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é—®é¢˜2-åœ¨ä½¿ç”¨luajitå®˜æ–¹ä¸»åˆ†æ”¯LuaJIT-2-1-0-beta3æä¾›LuaJITå®‰è£…éƒ¨ç½²å‡ºç°nginx-alert-detected-a-LuaJIT-version-which-is-not-OpenResty-39-s-ä»¥åŠnginx-alert-failed-to-load-the-39-resty-core-39-moduleè­¦å‘Šã€‚"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">é—®é¢˜2.åœ¨ä½¿ç”¨luajitå®˜æ–¹ä¸»åˆ†æ”¯LuaJIT-2.1.0-beta3æä¾›LuaJITå®‰è£…éƒ¨ç½²å‡ºç°nginx: [alert] detected a LuaJIT version which is not OpenResty&#39;s;ä»¥åŠnginx: [alert] failed to load the &#39;resty.core&#39; moduleè­¦å‘Šã€‚</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½çœ‹å‹,æ¬¢è¿å…³æ³¨åšä¸»å¾®ä¿¡å…¬ä¼—å·å“Ÿ! â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘å³å¯å…³é—­ç»§ç»­æµè§ˆæ–‡ç« .<br>  <b style="color:red;"> æ¸©é¦¨æç¤º: æœªè§£é”çš„ç”¨æˆ·ä¸èƒ½ç²˜è´´å¤åˆ¶æ–‡ç« å†…å®¹å“Ÿ!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2022/7-2-676.html&title=ã€Š7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2022/7-2-676.html&title=ã€Š7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°ã€‹ â€” WeiyiGeek Blog&source=æœ¬ç« ç›®å½•
[TOC]

0x00 å‰è¨€ç®€è¿°ä¸ºå•¥æœ‰æ­¤ç¯‡æ–‡ç« ?æè¿°: åœ¨è¿›è¡Œå…¬å¸çš„å›¾ç‰‡å­˜å‚¨è§£å†³æ–¹æ¡ˆç ”ç©¶ä¸­ï¼Œæœ€å¼€å§‹å‡†å¤‡ä½¿ç”¨çš„æ˜¯FastDFSï¼Œä½†æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘ï¼Œ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2022/7-2-676.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š7.Nginxå®è·µä¹‹ä½¿ç”¨Lua-nginxæ¨¡å—è„šæœ¬è¿æ¥Redisæ•°æ®åº“è¯»å–é™æ€èµ„æºå¹¶éšå¼å±•ç°ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2022/7-2-676.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2022/7-2-676.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACG0lEQVR42u3awY7DIAxF0f7/T2e2lUal99mkUsxlVaGUcLKwsM3rhcf1Nv7PvM9/ev7Tmum/WkOGDBmPZVzLsWaQlckK69/rvcmQIeMcBtnEGs//RYI435sMGTJkkCBI1uHHPhkyZMjYFXB5osuTYRkyZMhYM0gSy6teaTD9aS4uQ4aMBzLSzf3y9y39DRkyZDyKcYWDr5CGy6sxZMiQMZtRS1BJub+2TidhliFDxlRGuihPdHnCuf4oaEaGDBnHMNIrFP2iP3kj2oMMGTJGM+5IRDsF/U5DQoYMGbMZ/eXSoMlnOgmzDBkyJjFI0T/dLqrz4WfQB5UhQ8ZoRgrjJTN+nYIA4haCDBkyxjFqC5FCWLGzWgvxMmTIGMcgbYB0Ji3G1YI+6sTKkCFjBKOWuKbXMtLjYy3oy5AhYyoDBa9GkE3TWh6Cv9wZkSFDxiDGOqRy5K7ENf2sX/qoMmTIGMTgaWrt+Jh+lA3HRBkyZIxj8KI8T2L74Digy5Ah4wDGruJ+rWGwASNDhowDGP3X8PZA7VJFXG6TIUPGUEZtQ+kKe6+OyZAhYzbjCscuHg/T6/fKkCHjBMau62LpDG9IdC5nyJAhYxIjDbJp6S0NwbUmhAwZMk5gkONaurlOgyFGypAhQ0b71JkmpemnkSFDhox063zT/QscMmTIOIdBktj0kkR6+EvxMmTIOIfBU8da6/G+Q6QMGTIOYPwBXABqmM1OqqgAAAAASUVORK5CYII=" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// ç«™ç‚¹è¿è¡Œæ—¶é—´
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "å¤©" + RunHours + "æ—¶" + RunMinutes + "åˆ†" + RunSeconds + "ç§’";
  document.getElementById(id).innerHTML = "ç½‘ç«™å·²åœ¨é£é›¨ä¸­å‹‰å‹‰å¼ºå¼ºè¿è¡Œäº†ã€" + RunTime + "ã€‘";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>