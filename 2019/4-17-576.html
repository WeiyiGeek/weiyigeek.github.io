<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 4.Redis基础运维之哨兵和集群安装配置|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Redis">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>4.Redis基础运维之哨兵和集群安装配置</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">4.Redis基础运维之哨兵和集群安装配置</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-04-17T12:35:30.000Z" itemprop="datePublished" class="page-time">
  2019-04-17
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/">Database</a></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-数据存储/Redis/4.Redis基础运维之哨兵和集群安装配置"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">4.Redis基础运维之哨兵和集群安装配置</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-04-17 20:35:30" datetime="2019-04-17T12:35:30.000Z"  itemprop="datePublished">2019-04-17</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/">Database</a></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x01-Redis-运行模式"><a href="#0x01-Redis-运行模式" class="headerlink" title="0x01 Redis 运行模式"></a>0x01 Redis 运行模式</h2><h3 id="Redis-哨兵模式"><a href="#Redis-哨兵模式" class="headerlink" title="Redis 哨兵模式"></a>Redis 哨兵模式</h3><p>描述: 哨兵模式是主从的升级版，因为主从的出现故障后，不会自动恢复，需要人为干预，这就很蛋疼啊。在主从的基础上，实现哨兵模式就是为了监控主从的运行状况，对主从的健壮进行监控，就好像哨兵一样，只要有异常就发出警告，对异常状况进行处理。</p>
<h4 id="Sentinel-介绍"><a href="#Sentinel-介绍" class="headerlink" title="Sentinel 介绍"></a>Sentinel 介绍</h4><p>描述: Redis从2.8开始发布了一个稳定版本的<code>Redis Sentinel</code> 。当前版本的 Sentinel 称为Sentinel 2。它是使用更强大和更简单的预测算法来重写初始Sentinel实现。</p>
<p>Redis Sentinel 是一个分布式系统，Redis Sentinel为Redis提供高可用性。可以在没有人为干预的情况下 阻止某种类型的故障。</p>
<p>Redis Sentinel 是redis的高可用实现方案，在实际生产环境中，对提高整个系统可用性是非常有帮助的。</p>
<p>Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：</p>
<ul>
<li><code>监控(Monitoring)</code>: Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li>
<li><code>提醒(Notification)</code>: 当被监控的某个 Redis 服务器出现问题时，Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li>
<li><code>自动故障迁移（Automatic failover）</code>：如果 master 没有按预期工作，Sentinel 可以启动一个故障转移过程，其中一个副本被提升为 master，其他额外的副本被重新配置为使用新的 master，并且使用 Redis 服务器的应用程序会被告知要使用的新地址连接时</li>
<li><code>配置提供程序</code>: Sentinel 充当客户端服务发现的权威来源：客户端连接到 Sentinel 以请求负责给定服务的当前 Redis 主节点的地址。如果发生故障转移，Sentinels 将报告新地址。</li>
<li></li>
</ul>
<p>默认情况下，Sentinel 使用 TCP 端口 26379 运行（请注意，6379 是普通的 Redis 端口）。Sentinel 接受使用 Redis 协议的命令，因此您可以使用<code>redis-cli</code>或任何其他未修改的 Redis 客户端来与 Sentinel 对话。并且可以直接查询 Sentinel 以从其角度检查受监控 Redis 实例的状态，查看它知道的其他 Sentinel，等等。</p>
<p><br/></p>
<h4 id="Sentinel-高可用性"><a href="#Sentinel-高可用性" class="headerlink" title="Sentinel 高可用性"></a>Sentinel 高可用性</h4><p>描述: 当主节点出现故障时redis sentinel 能自动完成故障发现和故障转移，并通知客户端从而实现真正的高可用。</p>
<p>Redis Sentinel是一个分布式架构，其中包含N个Sentinel节点和Redis数据节点，每个Sentinel节点会对数据节点和其他Sentinel节点进行监控， 当它返现节点不可达时，会对节点做下线标识，如果被标识的是主节点，它还会和其他Sentinel及诶单进行“协商”，当大多数节点都认为主 节点不可达时，会选举出一个Sentinel节点来完成自动故障转移的工作，同时会将这个变化实时通知给redis的客户端，整个过程是自动的不需要人工干预，有效的解决了redis的高可用问题。</p>
<figure class="image-box">
                <a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://images2017.cnblogs.com/blog/802666/201711/802666-20171102101833623-796701766.jpg" target="_blank" title="Redis 主从和Redis Sentinel 区别" data-fancybox="images"><img src="https://images2017.cnblogs.com/blog/802666/201711/802666-20171102101833623-796701766.jpg" alt="Redis 主从和Redis Sentinel 区别" title="" class=""></a>
                <p>Redis 主从和Redis Sentinel 区别</p>
            </figure>
<p>同时看出，Redis Sentinel包含多个Sentinel节点，这样做带来两个好处:</p>
<ul>
<li>对于节点的故障判断是由多个节点共同完成，这样可以有效的防止误判断</li>
<li>多个Sentinel节点出现个别节点不可用，也不会影响客户端的访问</li>
</ul>
<p><br/></p>
<p><strong>Sentinel的仲裁会</strong><br>描述: 我们master被sentinel集群监控时，需要为它指定一个参数，该参数指定了当需要判决master为不可用，并且进行failover时，所需要的sentinel数量。</p>
<p>不过，当failover主备切换真正被触发后，failover并不会马上进行，还需要sentinel中的大多数sentinel授权后才可以进行failover。<br>当<code>Objectively Down</code>时，failover被触发后将尝试去进行failover的sentinel会去获得“大多数”sentinel的授权（如果票数比大多数还要大的时候，则询问更多的sentinel)</p>
<p>例如，当集群中有 5个sentinel 票数被设置为2，当2个sentinel认为一个master已经不可用了以后，将会触发failover，但是，进行failover的那个sentinel必须先获得至少3个sentinel的授权才可以实行failover。</p>
<p>如果票数被设置为5，要达到ODOWN状态，必须所有5个sentinel都主观认为master为不可用，要进行failover，那么得获得所有5个sentinel的授权。</p>
<figure class="image-box">
                <a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829142848.png" target="_blank" title="WeiyiGeek.简单图示" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829142848.png" alt="WeiyiGeek.简单图示" title="" class=""></a>
                <p>WeiyiGeek.简单图示</p>
            </figure>
<p><br/></p>
<p><strong>选举算法</strong><br>Q: 当master被认为客观下线后，又是怎么进行故障恢复的呢?</p>
<blockquote>
<p>原来哨兵中首先选举出一个老大哨兵来进行故障恢复，选举老大哨兵的算法叫做「Raft算法」：</p>
<ul>
<li>发现master下线的哨兵（sentinelA）会向其它的哨兵发送命令进行拉票，要求选择自己为哨兵大佬。</li>
<li>若是目标哨兵没有选择其它的哨兵，就会选择该哨兵（sentinelA）为大佬。</li>
<li>若是选择sentinelA的哨兵超过半数（半数原则），该大佬非sentinelA莫属。</li>
<li>如果有多个哨兵同时竞选，并且可能存在票数一致的情况，就会等待下次的一个随机时间再次发起竞选请求，进行新的一轮投票，直到大佬被选出来。</li>
</ul>
</blockquote>
<p>选出大佬哨兵后，大佬哨兵就会对故障进行自动回复，从slave中选出一名slave作为主数据库，选举的规则如下所示：</p>
<ul>
<li>1) 所有的slave中slave-priority优先级最高的会被选中。</li>
<li>2) 若是优先级相同，会选择偏移量最大的，因为偏移量记录着数据的复制的增量，越大表示数据越完整。</li>
<li>3) 若是以上两者都相同，选择ID最小的。</li>
</ul>
<p>Tips: 通过以上的层层筛选最终实现故障恢复，当选的slave晋升为master，其它的slave会向新的master复制数据，若是down掉的master重新上线，会被当作slave角色运行。</p>
<p><br/></p>
<p><strong>配置版本号</strong><br>为什么要先获得大多数sentinel的认可时才能真正去执行failover呢？</p>
<blockquote>
<p>保证了活跃性：如果大多数sentinel能够互相通信，最终将会有一个被授权去进行failover.<br>保证了安全性：每个试图去failover同一个master的sentinel都会得到一个独一无二的版本号。</p>
</blockquote>
<p>当一个sentinel被授权后，它将会获得宕掉的master的一份最新配置版本号，当failover执行结束以后，这个版本号将会被用于最新的配置。因为大多数sentinel都已经知道该版本号已经被要执行failover的sentinel拿走了，所以其他的sentinel都不能再去使用这个版本号。这意味着每次failover都会附带有一个独一无二的版本号。我们将会看到这样做的重要性。</p>
<p><br/></p>
<p><strong>节点通信</strong><br>描述: 当哨兵启动后会与master建立一条连接，用于订阅master的<code>_sentinel_:hello</code>频道。</p>
<p>该频道用于获取监控该master的其它哨兵的信息,并且还会建立一条定时向master发送INFO命令获取master信息的连接。</p>
<p>「当哨兵与master建立连接后，定期会向（10秒一次）master和slave发送INFO命令，若是master被标记为主观下线，频率就会变为1秒一次。」</p>
<p>但是一个faiover要想被成功实行的前提，sentinel必须能够向选为master的slave发送<code>SLAVEOF NO ONE</code>命令，然后能够通过INFO命令看到新master的配置信息。</p>
<p>并且，定期<code>向_sentinel_:hello频道</code>发送自己的信息，以便其它的哨兵能够订阅获取自己的信息，发送的内容包含「哨兵的ip和端口、运行id、配置版本、master名字、master的ip端口还有master的配置版本」等信息。</p>
<p>以及，「定期的向master、slave和其它哨兵发送PING命令（每秒一次），以便检测对象是否存活」，若是对方接收到了PING命令，无故障情况下，会回复PONG命令。</p>
<p>所以，哨兵通过建立这两条连接、<code>通过定期发送INFO、PING命令来实现哨兵与哨兵、哨兵与master之间的通信</code>。</p>
<p>例子说明，假设有一个名为mymaster的地址为192.168.56.11:6379。一开始，集群中所有的sentinel都知道这个地址，于是为mymaster的配置打上版本号1。一段时候后mymaster死了，有一个sentinel被授权用版本号2对其进行failover。如果failover成功了，假设地址改为了192.168.56.12:6279，此时配置的版本号为2，进行failover的sentinel会将新配置广播给其他的sentinel，由于其他sentinel维护的版本号为1，发现新配置的版本号为2时，版本号变大了，说明配置更新了，于是就会采用最新的版本号为2的配置。</p>
<p>重要的事情说明三遍: </p>
<ul>
<li>一个能够互相通信的sentinel集群最终会采用版本号最高且相同的配置。</li>
<li>一个能够互相通信的sentinel集群最终会采用版本号最高且相同的配置。</li>
<li>一个能够互相通信的sentinel集群最终会采用版本号最高且相同的配置。</li>
</ul>
<p>Tips: 这里涉及到一些概念需要理解，INFO、PING、PONG等命令，后面还会有MEET、FAIL命令，以及主观下线，当然还会有客观下线，这里主要说一下这几个概念的理解：</p>
<ul>
<li>INFO：该命令可以获取主从数据库的最新信息，可以实现新结点的发现</li>
<li>PING：该命令被使用最频繁，该命令封装了自身节点和其它节点的状态数据。</li>
<li>MEET：该命令在新结点加入集群的时候，会向老节点发送该命令，表示自己是个新人</li>
<li>PONG：当节点收到MEET和PING，会回复PONG命令，也把自己的状态发送给对方。</li>
<li>FAIL：当节点下线，会向集群中广播该消息。</li>
<li>SLAVEOF NO ONE: 不属于任何节点的从节点。</li>
</ul>
<p><br></p>
<p><strong>上线和下线</strong></p>
<ul>
<li><code>主观下线（Subjectively Down， 简称 SDOWN）</code>指的是单个 Sentinel 实例对服务器做出的下线判断。</li>
<li><code>客观下线（Objectively Down， 简称 ODOWN）</code>指的是多个 Sentinel 实例在对同一个服务器做出 SDOWN 判断， 并且通过 SENTINEL is-master-down-by-addr 命令互相交流之后， 得出的服务器下线判断。 （一个 Sentinel 可以通过向另一个 Sentinel 发送 SENTINEL is-master-down-by-addr 命令来询问对方是否认为给定的服务器已下线。）</li>
</ul>
<p>Sentinel(哨兵) 与 master会定期一直保持联系，若是某一时刻哨兵发送的PING在指定时间内没有收到回复<code>（配置sentinel down-after-milliseconds master-name milliseconds 字段）</code>，那么发送PING命令的哨兵就会认为该master「主观下线」（Subjectively Down）。</p>
<p>当sentinel发送PING后，以下回复之一都被认为是合法的, <code>除此之外其它任何回复（或者根本没有回复）都是不合法的</code>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* PING replied with +PONG.</span><br><span class="line">* PING replied with -LOADING error.</span><br><span class="line">* PING replied with -MASTERDOWN error.</span><br></pre></td></tr></table></figure></p>
<p>有时 哨兵 与 master 之间的网络问题造成收发中断，而不是master本身的原因，所以哨兵同时会询问其它的哨兵是否也认为该master下线，若是认为该节点下线的哨兵达到一定的数量（<code>「配置的quorum字段」</code>），就会认为该节点「客观下线」（Objectively Down）。</p>
<p>从SDOWN切换到ODOWN不需要任何一致性算法，只需要一个gossip协议：如果一个sentinel收到了足够多的sentinel发来消息告诉它某个master已经down掉了，SDOWN状态就会变成ODOWN状态。如果之后master可用了，这个状态就会相应地被清理掉。</p>
<p>正如之前已经解释过了，真正进行failover需要一个授权的过程，但是所有的failover都开始于一个ODOWN状态。</p>
<p>ODOWN状态只适用于master，对于不是master的redis节点sentinel之间不需要任何协商，slaves和sentinel不会有ODOWN状态。</p>
<p>若是<code>没有足够数量的sentinel同意该master下线</code>，则该master客观下线的标识会被移除；<code>若是master重新向哨兵的PING命令</code>回复了客观下线的标识也会被移除。</p>
<p><br></p>
<p><strong>每个 Sentinel 都需要定期执行的任务</strong></p>
<ul>
<li>每个 Sentinel 以每秒钟一次的频率向它所知的主服务器、从服务器以及其他 Sentinel 实例发送一个 PING 命令。</li>
<li>如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 那么这个实例会被 Sentinel 标记为主观下线。 一个有效回复可以是： +PONG 、 -LOADING 或者 -MASTERDOWN 。</li>
<li>如果一个主服务器被标记为主观下线， 那么正在监视这个主服务器的所有 Sentinel 要以每秒一次的频率确认主服务器的确进入了主观下线状态。</li>
<li>如果一个主服务器被标记为主观下线， 并且有足够数量的 Sentinel （至少要达到配置文件指定的数量）在指定的时间范围内同意这一判断， 那么这个主服务器被标记为客观下线。</li>
<li>在一般情况下， 每个 Sentinel 会以每 10 秒一次的频率向它已知的所有主服务器和从服务器发送 INFO 命令。 当一个主服务器被 Sentinel 标记为客观下线时， Sentinel 向下线主服务器的所有从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。</li>
<li>当没有足够数量的 Sentinel 同意主服务器已经下线， 主服务器的客观下线状态就会被移除。 当主服务器重新向 Sentinel 的 PING 命令返回有效回复时， 主服务器的主管下线状态就会被移除。</li>
</ul>
<p><br></p>
<p><strong>Sentinel之间和Slaves之间的自动发现机制</strong><br>描述: 虽然sentinel集群中各个sentinel都互相连接彼此来检查对方的可用性以及互相发送消息。但是你不用在任何一个sentinel配置任何其它的sentinel的节点。</p>
<p>因为sentinel利用了master的发布/订阅机制(<code>__sentinel__:hello</code>)去自动发现其它也监控了统一master的sentinel节点。</p>
<p>同样，你也不需要在sentinel中配置某个master的所有slave的地址，sentinel会通过询问master来得到这些slave的地址的。</p>
<ul>
<li>每个 Sentinel 会以每两秒一次的频率， 通过发布与订阅功能， 向被它监视的所有主服务器和从服务器的 <code>__sentinel__:hello</code> 频道发送一条信息， 信息中包含了 Sentinel 的 IP 地址、端口号和运行 ID （runid）。</li>
<li>每个 Sentinel 都订阅了被它监视的所有主服务器和从服务器的<code>__sentinel__:hello</code>频道， 查找之前未出现过的 sentinel （looking for unknown sentinels）。 当一个 Sentinel 发现一个新的 Sentinel 时， 它会将新的 Sentinel * 添加到一个列表中， 这个列表保存了 Sentinel 已知的， 监视同一个主服务器的所有其他 Sentinel 。</li>
<li>Sentinel 发送的信息中还包括完整的主服务器当前配置（configuration）。 如果一个 Sentinel 包含的主服务器配置比另一个 Sentinel 发送的配置要旧， 那么这个 Sentinel 会立即升级到新配置上。</li>
<li>在将一个新 Sentinel 添加到监视主服务器的列表上面之前， Sentinel 会先检查列表中是否已经包含了和要添加的 Sentinel 拥有相同运行 ID 或者相同地址（包括 IP 地址和端口号）的 Sentinel ， 如果是的话， Sentinel 会先移除列表中已有的那些拥有相同运行 ID 或者相同地址的 Sentinel ， 然后再添加新 Sentinel 。</li>
</ul>
<p><br></p>
<p><strong>网络隔离时的一致性</strong></p>
<p>描述: redis sentinel集群的配置的一致性模型为最终一致性，集群中每个sentinel最终都会采用最高版本的配置。然而，在实际的应用环境中，有三个不同的角色会与sentinel打交道: <code>Redis实例/Sentinel实例/客户端</code></p>
<p>为了考察整个系统的行为我们必须同时考虑到这三个角色。</p>
<p>下面有个简单的例子，有三个主机，每个主机分别运行一个redis和一个sentinel:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">            +-------------+</span><br><span class="line">            | Sentinel 1  | &lt;--- Client A</span><br><span class="line">            | Redis 1 (M) |</span><br><span class="line">            +-------------+</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">+-------------+     |                     +------------+</span><br><span class="line">| Sentinel 2  |-----+-- / partition / ----| Sentinel 3 | &lt;--- Client B</span><br><span class="line">| Redis 2 (S) |                           | Redis 3 (M)|</span><br><span class="line">+-------------+                           +------------+</span><br></pre></td></tr></table></figure>
<p>在这个系统中，初始状态下redis3是master, redis1和redis2是slave。之后redis3所在的主机网络不可用了，sentinel1和sentinel2启动了failover并把redis1选举为master。</p>
<p>Sentinel集群的特性保证了sentinel1和sentinel2得到了关于master的最新配置。但是sentinel3依然持着的是就的配置，因为它与外界隔离了。</p>
<p>当网络恢复以后，我们知道sentinel3将会更新它的配置。但是，如果客户端所连接的master被网络隔离，会发生什么呢？</p>
<p>客户端将依然可以向redis3写数据，但是当网络恢复后，redis3就会变成redis的一个slave，那么，在网络隔离期间，客户端向redis3写的数据将会丢失。</p>
<p>也许你不会希望这个场景发生：</p>
<p>如果你把redis当做缓存来使用，那么你也许能容忍这部分数据的丢失。<br> 但如果你把redis当做一个存储系统来使用，你也许就无法容忍这部分数据的丢失了。<br> 因为redis采用的是异步复制，在这样的场景下，没有办法避免数据的丢失。然而,你可以通过以下配置来配置redis3和redis1，使得数据不会丢失。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> redis.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> min-replicas-to-write 3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> min-replicas-max-lag 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default min-replicas-to-write is <span class="built_in">set</span> to 0 (feature disabled) and</span></span><br><span class="line"></span><br><span class="line">min-slaves-to-write 1</span><br><span class="line">min-slaves-max-lag 10</span><br></pre></td></tr></table></figure>
<p>通过上面的配置，当一个redis是master时，如果它不能向至少一个slave写数据(上面的min-slaves-to-write指定了slave的数量)，它将会拒绝接受客户端的写请求。由于复制是异步的，master无法向slave写数据意味着slave要么断开连接了，要么不在指定时间内向master发送同步数据的请求了(上面的min-slaves-max-lag指定了这个时间)。</p>
<p><br></p>
<p><strong>故障转移步骤</strong></p>
<p>一次故障转移操作由以下步骤组成：</p>
<ul>
<li>发现主服务器已经进入客观下线状态。</li>
<li>对我们的当前纪元进行自增（详情请参考 Raft leader election ）， 并尝试在这个纪元中当选。</li>
<li>如果当选失败， 那么在设定的故障迁移超时时间的两倍之后， 重新尝试当选。 如果当选成功， 那么执行以下步骤。</li>
<li>选出一个从服务器，并将它升级为主服务器。</li>
<li>向被选中的从服务器发送 SLAVEOF NO ONE 命令，让它转变为主服务器。</li>
<li>通过发布与订阅功能， 将更新后的配置传播给所有其他 Sentinel ， 其他 Sentinel 对它们自己的配置进行更新。</li>
<li>向已下线主服务器的从服务器发送 SLAVEOF 命令， 让它们去复制新的主服务器。</li>
<li>当所有从服务器都已经开始复制新的主服务器时， 领头 Sentinel 终止这次故障迁移操作。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每当一个 Redis 实例被重新配置（reconfigured） —— 无论是被设置成主服务器、从服务器、又或者被设置成其他主服务器的从服务器 —— Sentinel 都会向被重新配置的实例发送一个 CONFIG REWRITE 命令， 从而确保这些配置会持久化在硬盘里。</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>Sentinel 使用以下规则来选择新的主服务器：</p>
<ul>
<li>在失效主服务器属下的从服务器当中， 那些被标记为主观下线、已断线、或者最后一次回复 PING 命令的时间大于五秒钟的从服务器都会被淘汰。</li>
<li>在失效主服务器属下的从服务器当中， 那些与失效主服务器连接断开的时长超过 down-after 选项指定的时长十倍的从服务器都会被淘汰。</li>
<li>在经历了以上两轮淘汰之后剩下来的从服务器中， 我们选出复制偏移量（replication offset）最大的那个从服务器作为新的主服务器； 如果复制偏移量不可用， 或者从服务器的复制偏移量相同， 那么带有最小运行 ID 的那个从服务器成为新的主服务器。</li>
</ul>
<p><br></p>
<p><strong>Sentinel状态持久化</strong></p>
<p>snetinel的状态会被持久化地写入sentinel的配置文件中。每次当收到一个新的配置时，或者新创建一个配置时，配置会被持久化到硬盘中，并带上配置的版本戳。这意味着，可以安全的停止和重启sentinel进程。</p>
<p><br></p>
<p><strong>优点</strong><br>哨兵模式是主从模式的升级版，所以在系统层面提高了系统的可用性和性能、稳定性。当master宕机的时候，能够自动进行故障恢复，需不要人为的干预。</p>
<p>哨兵与哨兵之间、哨兵与master之间能够进行及时的监控，心跳检测，及时发现系统的问题，这都是弥补了主从的缺点。</p>
<p><br/></p>
<p><strong>缺点</strong><br>哨兵一主多从的模式同样也会遇到写的瓶颈，已经存储瓶颈，若是master宕机了，故障恢复的时间比较长，写的业务就会受到影响。</p>
<p>增加了哨兵也增加了系统的复杂度，需要同时维护哨兵模式。</p>
<p><br/></p>
<h4 id="Sentinel-配置步骤"><a href="#Sentinel-配置步骤" class="headerlink" title="Sentinel 配置步骤"></a>Sentinel 配置步骤</h4><p>描述: 哨兵模式的监控配置信息，是通过配置从数据库的<code>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</code>来指定的，比如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster 10.20.172.108 6379 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数解析:</span></span><br><span class="line">- mymaster 表示给master数据库定义了一个名字，</span><br><span class="line">- master的ip 和 端口</span><br><span class="line">- 2 : 表示至少需要一个Sentinel进程同意才能将master判断为失效，如果不满足这个条件，则自动故障转移（failover）不会执行</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>运行哨兵的两种方式:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果您正在使用redis-sentinel可执行文件</span></span><br><span class="line">redis-sentinel /path/to/sentinel.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接使用redis-server在 Sentinel 模式下启动它的可执行文件：</span></span><br><span class="line">redis-server /path/to/sentinel.conf --sentinel</span><br></pre></td></tr></table></figure></p>
<p>Tips: 在运行 Sentinel 时必须使用配置文件，因为系统将使用该文件来保存在重启时将重新加载的当前状态。如果没有给出配置文件或配置文件路径不可写，Sentinel 将简单地拒绝启动。</p>
<p>Tips: Sentinel 默认运行侦听 TCP 端口 26379 的连接，因此要使Sentinel 工作，您的服务器的端口 26379必须打开以接收来自其他 Sentinel 实例的 IP 地址的连接。否则哨兵不能说话，也不能就该做什么达成一致，所以永远不会执行故障转移。</p>
<p>官方参考: <a href="https://redis.io/topics/sentinel" target="_blank" rel="noopener">https://redis.io/topics/sentinel</a></p>
<p><br/></p>
<p><strong>测试环境</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.20.172.108 Redis-Master 6379 |&#123;Sentinel01&#125; 26379</span><br><span class="line">10.20.172.108 Redis-Slave 6380  |&#123;Sentinel02&#125; 36379</span><br><span class="line">10.20.172.108 Redis-Slave 6381  |&#123;Sentinel03&#125; 46379</span><br></pre></td></tr></table></figure></p>
<p>Tips: 此处演示只用了一台主机进行演示，在生产环境中搭建sentinel一定要在各redis服务器上配置监听，这才能真正的实现高可用。</p>
<p><br/></p>
<p><strong>流程步骤</strong><br>描述: 哨兵模式的搭建配置比较简单，在前面一章配置的主从模式的基础上，同时创建一个文件夹用于存放三个哨兵的配置文件：</p>
<ul>
<li>Step 0.Redis主从服务配置文件并启动配置Redis主从服务。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置&amp;启动启动脚本</span></span><br><span class="line">tee startRedisServer.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># cp /etc/redis/redis.conf /home/weiyigeek/redis/6379/redis-6379.conf</span></span><br><span class="line">sed <span class="string">'s#6379#6380#g'</span> /home/weiyigeek/redis/6379/redis-6379.conf &gt; /home/weiyigeek/redis/6380/redis-6380.conf</span><br><span class="line">sed <span class="string">'s#6379#6381#g'</span> /home/weiyigeek/redis/6379/redis-6379.conf &gt; /home/weiyigeek/redis/6381/redis-6381.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /home/weiyigeek/redis/6379/redis-6379.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /home/weiyigeek/redis/6380/redis-6380.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /home/weiyigeek/redis/6381/redis-6381.conf</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 权限赋予与执行</span></span><br><span class="line">chmod +x startRedisServer.sh &amp;&amp; ./startRedisServer.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证启动的redis服务</span></span><br><span class="line">netstat -ano | egrep <span class="string">"(6379|6380|6381)"</span></span><br><span class="line">tcp        0      0 0.0.0.0:6379            0.0.0.0:*               LISTEN     </span><br><span class="line">tcp        0      0 0.0.0.0:6380            0.0.0.0:*               LISTEN</span><br><span class="line">tcp        0      0 0.0.0.0:6381            0.0.0.0:*               LISTEN</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此步骤非常重要为了后续故障转移后Master-&gt;Slave服务能正常提供服务。</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"CONFIG set masterauth 123456\nCONFIG REWRITE"</span> | redis-cli -p 6379 -a 123456 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 针对6380、6381服务端口设置Redis的Slave。</span></span><br><span class="line"><span class="comment"># 方式1</span></span><br><span class="line">redis-cli -h 127.0.0.1 -p 6380 -a 123456</span><br><span class="line">127.0.0.1:6380&gt; SLAVEOF 10.20.172.108 6379   <span class="comment"># OK</span></span><br><span class="line">127.0.0.1:6380&gt; CONFIG <span class="built_in">set</span> masterauth 123456 <span class="comment"># OK</span></span><br><span class="line">127.0.0.1:6380&gt; CONFIG REWRITE  <span class="comment"># OK</span></span><br><span class="line"><span class="comment"># 方式2</span></span><br><span class="line">➜ <span class="built_in">echo</span> <span class="string">"SLAVEOF 10.20.172.108 6379\nCONFIG set masterauth 123456\nCONFIG REWRITE"</span> | redis-cli -p 6381 -a 123456 </span><br><span class="line">OK</span><br><span class="line">OK</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在上面的进行CONFIG REWRITE命令执行后，将会更改其配置文件。</span></span><br><span class="line">grep <span class="string">"Generated by CONFIG REWRITE"</span> -A 5 ~/redis/6380/redis-6380.conf</span><br><span class="line">.... <span class="comment"># 在末尾加上如下几行</span></span><br><span class="line"><span class="comment"># Generated by CONFIG REWRITE</span></span><br><span class="line">masterauth <span class="string">"123456"</span></span><br><span class="line">user default on <span class="comment">#8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92 ~* &amp;* +@all</span></span><br><span class="line">replicaof 10.20.172.108 6379</span><br><span class="line"></span><br><span class="line">grep <span class="string">"Generated by CONFIG REWRITE"</span> -A 5 ~/redis/6381/redis-6381.conf</span><br><span class="line">.... <span class="comment"># 在末尾加上如下几行</span></span><br><span class="line"><span class="comment"># Generated by CONFIG REWRITE</span></span><br><span class="line">masterauth <span class="string">"123456"</span></span><br><span class="line">user default on <span class="comment">#8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92 ~* &amp;* +@all</span></span><br><span class="line">replicaof 10.20.172.108 6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证主从服务 &#123;Master&#125; 6379 / &#123;Slave&#125; 6380 8381</span></span><br><span class="line">redis-cli -p 6379 -a 123456 info replication | head -n 5</span><br><span class="line">  <span class="comment"># role:master</span></span><br><span class="line">  <span class="comment"># connected_slaves:2</span></span><br><span class="line">  <span class="comment"># slave0:ip=10.20.172.108,port=6380,state=online,offset=448,lag=0</span></span><br><span class="line">  <span class="comment"># slave1:ip=10.20.172.108,port=6381,state=online,offset=448,lag=1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 1.Redis 哨兵Sentinel常用配置简单说明。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 绑定主机、三个哨兵分别26379,36379,46379端口</span></span><br><span class="line"><span class="built_in">bind</span> 10.20.172.108</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="comment">## 主目录与日志存放路径</span></span><br><span class="line">dir <span class="string">"/home/weiyigeek/redis"</span></span><br><span class="line">logfile <span class="string">"/home/weiyigeek/redis/sentinel_26379.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 哨兵sentinel监控的redis主节点的  </span></span><br><span class="line"><span class="comment">## master-name：可以自己命名的主节点名字（只能由字母A-z、数字0-9 、这三个字符".-_"组成。） </span></span><br><span class="line"><span class="comment">## quorum：当这些quorum个数sentinel哨兵认为master主节点失联 那么这时客观上认为主节点失联了 (最低通过票数为2) </span></span><br><span class="line">sentinel monitor mymaster 10.20.172.108 6379 2</span><br><span class="line"></span><br><span class="line"><span class="comment">## 当在Redis实例中开启了requirepass，所有连接Redis实例的客户端都要提供密码。 </span></span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line"></span><br><span class="line"><span class="comment">## 向master发送心跳PING来确认master是否存活，在这段时间（3s）内没有收到来自 ping 的任何回复，就会检测到主节点失败。</span></span><br><span class="line"><span class="comment">## 过需要注意的是，这个时候sentinel并不会马上进行failover主备切换，这个sentinel还需要参考sentinel集群中其他sentinel的意见，如果超过某个数量的sentinel也主观地认为该master死了，那么这个master就会被客观地(注意哦，这次不是主观，是客观，与刚才的subjectively down相对，这次是objectively down，简称为ODOWN)认为已经死了</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># # 指定了在发生failover主备切换时，最多可以有多少个slave同时对新的master进行同步。这个数字越小，完成failover所需的时间就越长；反之，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为1，来保证每次只有一个slave，处于不能处理命令请求的状态。 </span></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"><span class="comment"># 故障转移的超时时间failover-timeout，默认三分钟，可以用在以下这些方面： </span></span><br><span class="line"><span class="comment">## 1. 同一个sentinel对同一个master两次failover之间的间隔时间。   </span></span><br><span class="line"><span class="comment">## 2. 当一个slave从一个错误的master那里同步数据时开始，直到slave被纠正为从正确的master那里同步数据时结束。   </span></span><br><span class="line"><span class="comment">## 3. 当想要取消一个正在进行的failover时所需要的时间。 </span></span><br><span class="line"><span class="comment">## 4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来同步数据了 </span></span><br><span class="line">sentinel failover-timeout mymaster 5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本。一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。 </span></span><br><span class="line"><span class="comment"># 对于脚本的运行结果有以下规则：   </span></span><br><span class="line"><span class="comment">## 1. 若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10。 </span></span><br><span class="line"><span class="comment">## 2. 若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。   </span></span><br><span class="line"><span class="comment">## 3. 如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。 </span></span><br><span class="line"><span class="comment"># sentinel notification-script mymaster /var/redis/notify.sh </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个脚本应该是通用的，能被多次调用，不是针对性的。 </span></span><br><span class="line"><span class="comment"># sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 2.sentinel 配置文件配置分别生成26379、36379、46379的监听端口,以及分别启动三个端口的哨兵服务。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /home/weiyigeek/redis/sentinel-26379.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># 绑定主机、三个哨兵分别26379,36379,46379端口</span></span><br><span class="line"><span class="built_in">bind</span> 10.20.172.108</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">dir <span class="string">"/home/weiyigeek/redis"</span></span><br><span class="line">logfile <span class="string">"/home/weiyigeek/redis/sentinel_26379.log"</span></span><br><span class="line">sentinel monitor mymaster 10.20.172.108 6379 2</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 10000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将上述 sentinel 文件配置再复制两份并更改服务端口</span></span><br><span class="line">sed <span class="string">'s#26379#36379#g'</span> /home/weiyigeek/redis/sentinel-26379.conf &gt; /home/weiyigeek/redis/sentinel-36379.conf</span><br><span class="line">sed <span class="string">'s#26379#46379#g'</span> /home/weiyigeek/redis/sentinel-26379.conf &gt; /home/weiyigeek/redis/sentinel-46379.conf</span><br><span class="line"></span><br><span class="line">➜ ls &amp;&amp; grep <span class="string">"port"</span> sentinel-*</span><br><span class="line">  <span class="comment"># 6379  6380  6381  sentinel-26379.conf  sentinel-36379.conf  sentinel-46379.conf</span></span><br><span class="line">  <span class="comment"># sentinel-26379.conf:port 26379</span></span><br><span class="line">  <span class="comment"># sentinel-36379.conf:port 36379</span></span><br><span class="line">  <span class="comment"># sentinel-46379.conf:port 46379</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务启动脚本与启动哨兵服务</span></span><br><span class="line">tee startSentinel.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /home/weiyigeek/redis/sentinel-26379.conf --sentinel</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /home/weiyigeek/redis/sentinel-36379.conf --sentinel</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-server /home/weiyigeek/redis/sentinel-46379.conf --sentinel</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x startSentinel.sh &amp;&amp; ./startSentinel.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证服务监听断开状态</span></span><br><span class="line">redis netstat -ano | egrep <span class="string">"0 0.0.0.0:([234])&#123;0,1&#125;(6379|6380|6381)"</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:36379           0.0.0.0:*               LISTEN      关闭 (0.00/0/0)</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:46379           0.0.0.0:*               LISTEN      关闭 (0.00/0/0)</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:26379           0.0.0.0:*               LISTEN      关闭 (0.00/0/0)</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:6379            0.0.0.0:*               LISTEN      关闭 (0.00/0/0)</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:6380            0.0.0.0:*               LISTEN      关闭 (0.00/0/0)</span></span><br><span class="line">  <span class="comment"># tcp        0      0 0.0.0.0:6381            0.0.0.0:*               LISTEN      关闭 (0.00/0/0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以通过如下进行查看redis服务与哨兵启动的进程。</span></span><br><span class="line">redis ps u -C <span class="string">"redis-server"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 3.验证Redis Sentine服务并通过查看哨兵相关信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) Master(6379) 同步数据到 Slave(6380、6381)</span></span><br><span class="line">$ cat /home/weiyigeek/redis/6379/logs/6379.log</span><br><span class="line"><span class="comment">#  10.20.172.108:6380</span></span><br><span class="line">118725:M 05 Sep 2021 10:33:05.714 * Replica 10.20.172.108:6380 asks <span class="keyword">for</span> synchronization</span><br><span class="line">118725:M 05 Sep 2021 10:33:05.715 * Full resync requested by replica 10.20.172.108:6380</span><br><span class="line">118725:M 05 Sep 2021 10:33:05.715 * Replication backlog created, my new replication IDs are <span class="string">'01bf2439d1606b8b74c2846ebb3dab02b1ab993c'</span> and <span class="string">'0000000000000000000000000000000000000000'</span></span><br><span class="line">118725:M 05 Sep 2021 10:33:05.715 * Starting BGSAVE <span class="keyword">for</span> SYNC with target: disk</span><br><span class="line">118725:M 05 Sep 2021 10:33:05.715 * Background saving started by pid 118816</span><br><span class="line">118816:C 05 Sep 2021 10:33:05.756 * DB saved on disk</span><br><span class="line">118816:C 05 Sep 2021 10:33:05.757 * RDB: 0 MB of memory used by copy-on-write</span><br><span class="line">118725:M 05 Sep 2021 10:33:05.767 * Background saving terminated with success</span><br><span class="line">118725:M 05 Sep 2021 10:33:05.767 * Synchronization with replica 10.20.172.108:6380 succeeded</span><br><span class="line">118725:M 05 Sep 2021 10:34:58.126 - Accepted 10.20.172.108:36343</span><br><span class="line"><span class="comment">#  10.20.172.108:6380</span></span><br><span class="line">118725:M 05 Sep 2021 10:34:58.152 * Replica 10.20.172.108:6381 asks <span class="keyword">for</span> synchronization</span><br><span class="line">118725:M 05 Sep 2021 10:34:58.152 * Partial resynchronization not accepted: Replication ID mismatch (Replica asked <span class="keyword">for</span> <span class="string">'44d3228555abe04a02f979761bd534283d0d3613'</span>, my replication IDs are <span class="string">'01bf2439d1606b8b74c2846ebb3dab02b1ab993c'</span> and <span class="string">'0000000000000000000000000000000000000000'</span>)</span><br><span class="line">118725:M 05 Sep 2021 10:34:58.152 * Starting BGSAVE <span class="keyword">for</span> SYNC with target: disk</span><br><span class="line">118725:M 05 Sep 2021 10:34:58.152 * Background saving started by pid 118865</span><br><span class="line">118865:C 05 Sep 2021 10:34:58.184 * DB saved on disk</span><br><span class="line">118865:C 05 Sep 2021 10:34:58.185 * RDB: 0 MB of memory used by copy-on-write</span><br><span class="line">118725:M 05 Sep 2021 10:34:58.232 * Background saving terminated with success</span><br><span class="line">118725:M 05 Sep 2021 10:34:58.233 * Synchronization with replica 10.20.172.108:6381 succeeded</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 查看 sentinel 日志</span></span><br><span class="line">/redis$ more sentinel_26379.log </span><br><span class="line">10:50:43.944 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">10:50:43.944 <span class="comment"># Redis version=6.2.5, bits=64, commit=00000000, modified=0, pid=119377, just started</span></span><br><span class="line">10:50:43.944 <span class="comment"># Configuration loaded</span></span><br><span class="line">10:50:43.945 * Increased maximum number of open files to 10032 (it was originally <span class="built_in">set</span> to 1024). </span><br><span class="line">10:50:43.945 * Running mode=sentinel, port=26379. <span class="comment"># 当前模式与监听断开</span></span><br><span class="line">10:50:44.026 <span class="comment"># Sentinel ID is 875046c517f19aded2a5545457930ccd8ff35cb6</span></span><br><span class="line">10:50:44.026 <span class="comment"># +monitor master mymaster 10.20.172.108 6379 quorum 2</span></span><br><span class="line"><span class="comment"># 两个slave服务</span></span><br><span class="line">10:50:44.027 * +slave slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6379</span><br><span class="line">10:50:44.129 * +slave slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6379</span><br><span class="line"><span class="comment"># 其它两个sentinel实例</span></span><br><span class="line">10:50:45.990 * +sentinel sentinel 2e53ed2e7407064d08f09b5547615144d6e34159 10.20.172.108 36379 @ mymaster 10.20.172.108 6379</span><br><span class="line">10:50:46.917 * +sentinel sentinel 1c12264f05132a5627620588752a07429a635198 10.20.172.108 46379 @ mymaster 10.20.172.108 6379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 访问所有 sentinel 查看当前master节点信息</span></span><br><span class="line">~/redis$ redis-cli -h 10.20.172.108 -p 26379 -a 123456 info | grep -n <span class="string">"master"</span></span><br><span class="line">~/redis$ redis-cli -h 10.20.172.108 -p 36379 -a 123456 info | grep -n <span class="string">"master"</span></span><br><span class="line">~/redis$ redis-cli -h 10.20.172.108 -p 46379 -a 123456 info | grep -n <span class="string">"master"</span></span><br><span class="line">  <span class="comment"># 85:sentinel_masters:1</span></span><br><span class="line">  <span class="comment"># 90:master0:name=mymaster,status=ok,address=10.20.172.108:6379,slaves=2,sentinels=3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 登陆 sentinel 26379 提供的服务</span></span><br><span class="line">redis-cli -h 10.20.172.108 -p 26379 -a 123456</span><br><span class="line">10.20.172.108:26379&gt; sentinel masters              <span class="comment"># 查看所有Master状态</span></span><br><span class="line">10.20.172.108:26379&gt; sentinel master mymaster      <span class="comment"># 查看指定Master状态</span></span><br><span class="line">10.20.172.108:26379&gt; SENTINEL replicas mymaster    <span class="comment"># 查看备选slave节点 </span></span><br><span class="line">10.20.172.108:26379&gt; SENTINEL sentinels mymaster   <span class="comment"># 查看其它哨兵状态</span></span><br><span class="line">1)  1) <span class="string">"name"</span></span><br><span class="line">    2) <span class="string">"2e53ed2e7407064d08f09b5547615144d6e34159"</span></span><br><span class="line">    3) <span class="string">"ip"</span></span><br><span class="line">    4) <span class="string">"10.20.172.108"</span></span><br><span class="line">    5) <span class="string">"port"</span></span><br><span class="line">    6) <span class="string">"36379"</span></span><br><span class="line">    7) <span class="string">"runid"</span></span><br><span class="line">    8) <span class="string">"2e53ed2e7407064d08f09b5547615144d6e34159"</span></span><br><span class="line">    省略.....</span><br><span class="line">2)  1) <span class="string">"name"</span></span><br><span class="line">    2) <span class="string">"1c12264f05132a5627620588752a07429a635198"</span></span><br><span class="line">    3) <span class="string">"ip"</span></span><br><span class="line">    4) <span class="string">"10.20.172.108"</span></span><br><span class="line">    5) <span class="string">"port"</span></span><br><span class="line">    6) <span class="string">"46379"</span></span><br><span class="line">    7) <span class="string">"runid"</span></span><br><span class="line">    8) <span class="string">"1c12264f05132a5627620588752a07429a635198"</span></span><br><span class="line">    省略.....</span><br><span class="line">  </span><br><span class="line"><span class="comment"># (5) 获取当前master的地址</span></span><br><span class="line">10.20.172.108:26379&gt; SENTINEL get-master-addr-by-name mymaster</span><br><span class="line">1) <span class="string">"10.20.172.108"</span></span><br><span class="line">2) <span class="string">"6379"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 4.在Master节点上添加一个Keys验证主从正常同步<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.在master 6379中添加一个key</span></span><br><span class="line">10.20.172.108:6379&gt; <span class="built_in">set</span> username WeiyiGeek </span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.在Slave 6380 中查询添加key</span></span><br><span class="line">10.20.172.108:6380&gt; get username    <span class="comment"># "WeiyiGeek"</span></span><br><span class="line">10.20.172.108:6380&gt; <span class="built_in">set</span> demo redis  <span class="comment"># 注意从节点只能读不能写(主节点采有写)</span></span><br><span class="line">  <span class="comment"># (error) READONLY You cant write against a read only replica.  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.在Slave 6381 中查询添加key</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"get username"</span> | redis-cli -p 6381 -a 123456 <span class="comment">#  # "WeiyiGeek"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Step 6.从上面流程验证了redis主从同步以及哨兵服务正常运行，下面我们将进行演示哨兵模式故障转移(<code>验证其高可用</code>)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.模拟故障转移两种方式</span></span><br><span class="line"><span class="comment"># 方式1.此命令将使我们的 master 不再可访问，休眠 60 秒。它基本上模拟了出于某种原因挂起的主人。</span></span><br><span class="line"><span class="comment"># redis-cli -p 6379 DEBUG sleep 60</span></span><br><span class="line"><span class="comment"># 方式2.直接在哨兵服务中模拟故障转移（重新仲裁Master节点）</span></span><br><span class="line">sentinel failover mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查看 sentinel 日志</span></span><br><span class="line">10:58:23.402 <span class="comment"># Executing user requested FAILOVER of 'mymaster'</span></span><br><span class="line">10:58:23.402 <span class="comment"># +new-epoch 1</span></span><br><span class="line">10:58:23.402 <span class="comment"># +try-failover master mymaster 10.20.172.108 6379</span></span><br><span class="line">10:58:23.457 <span class="comment"># +vote-for-leader 875046c517f19aded2a5545457930ccd8ff35cb6 1</span></span><br><span class="line"><span class="comment"># step 1</span></span><br><span class="line">10:58:23.457 <span class="comment"># +elected-leader master mymaster 10.20.172.108 6379</span></span><br><span class="line"><span class="comment"># step 2</span></span><br><span class="line">10:58:23.457 <span class="comment"># +failover-state-select-slave master mymaster 10.20.172.108 6379</span></span><br><span class="line"><span class="comment"># Step 3.从slave中选举出 6380 服务的redis</span></span><br><span class="line">10:58:23.534 <span class="comment"># +selected-slave slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6379</span></span><br><span class="line"><span class="comment"># step 4.设置 6380 不为从节点</span></span><br><span class="line">10:58:23.534 * +failover-state-send-slaveof-noone slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6379</span><br><span class="line">10:58:23.589 * +failover-state-wait-promotion slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6379</span><br><span class="line">10:58:24.522 <span class="comment"># +promoted-slave slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6379</span></span><br><span class="line"><span class="comment"># step 5.将原master实例转为slave</span></span><br><span class="line">10:58:24.522 <span class="comment"># +failover-state-reconf-slaves master mymaster 10.20.172.108 6379</span></span><br><span class="line">10:58:24.550 * +slave-reconf-sent slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6379</span><br><span class="line">10:58:25.542 * +slave-reconf-inprog slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6379</span><br><span class="line">10:58:25.542 * +slave-reconf-done slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6379</span><br><span class="line">10:58:25.625 <span class="comment"># +failover-end master mymaster 10.20.172.108 6379</span></span><br><span class="line"><span class="comment"># Step 6.将6379master服务切换到10.20.172.108 6380中</span></span><br><span class="line">10:58:25.625 <span class="comment"># +switch-master mymaster 10.20.172.108 6379 10.20.172.108 6380</span></span><br><span class="line"><span class="comment"># Step 7.切换后其它两个slave信息</span></span><br><span class="line">10:58:25.625 * +slave slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6380</span><br><span class="line">10:58:25.625 * +slave slave 10.20.172.108:6379 10.20.172.108 6379 @ mymaster 10.20.172.108 6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.此时看6379服务的日志（已将其配置为从节点）</span></span><br><span class="line">grep <span class="string">"Generated by CONFIG REWRITE"</span> -A 5 ~/redis/6379/redis-6379.conf</span><br><span class="line">.... <span class="comment"># 在末尾加上如下几行</span></span><br><span class="line"><span class="comment"># Generated by CONFIG REWRITE</span></span><br><span class="line">user default on <span class="comment">#8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92 ~* &amp;* +@all</span></span><br><span class="line">replicaof 10.20.172.108 6380</span><br><span class="line">masterauth <span class="string">"123456"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 6.向 Sentinel 询问 master 的状态，在开始使用 Sentinel 最明显的事情是检查它正在监视的 master 是否运行良好</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 在新的 Master 节点 6380 中新增一个keys并查询其包括的slave</span></span><br><span class="line">$ redis-cli -h 10.20.172.108 -p 6380 -a 123456 info replication | head -n 5</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=10.20.172.108,port=6379,state=online,offset=2396601,lag=0</span><br><span class="line">slave1:ip=10.20.172.108,port=6381,state=online,offset=2396601,lag=0</span><br><span class="line"></span><br><span class="line">$ redis-cli -h 10.20.172.108 -p 6380 -a 123456</span><br><span class="line">127.0.0.1:6380&gt; <span class="built_in">set</span> demo1 sentinel</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; get username </span><br><span class="line">weiyigeek</span><br><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line">1) <span class="string">"username"</span></span><br><span class="line">2) <span class="string">"demo1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 哨兵服务选举出来的当前master节点信息</span></span><br><span class="line">~/redis$ redis-cli -h 10.20.172.108 -p 26379 -a 123456 info | grep -n <span class="string">"master"</span></span><br><span class="line">  <span class="comment"># 85:sentinel_masters:1</span></span><br><span class="line">  <span class="comment"># 90:master0:name=mymaster,status=ok,address=10.20.172.108:6380,slaves=2,sentinels=3</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829173914.png" target="_blank" title="WeiyiGeek.验证" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829173914.png" alt="WeiyiGeek.验证" title="" class=""></a>
                <p>WeiyiGeek.验证</p>
            </figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 7.然后我们再来测试一下哨兵的自动故障恢复，直接kill掉6380服务端口的进程。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) pid进程号查看并kill掉</span></span><br><span class="line">~/redis$ ps uax | grep <span class="string">"6380"</span></span><br><span class="line">weiyige+  119353  0.4  0.0 146544  6168 ?        Ssl  10:50   0:53 /usr/<span class="built_in">local</span>/bin/redis-server 0.0.0.0:6380</span><br><span class="line">~/redis$ <span class="built_in">kill</span> 119353</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 查哨兵新选举出来的Master地址</span></span><br><span class="line">10.20.172.108:26379&gt;  SENTINEL get-master-addr-by-name mymaster</span><br><span class="line">1) <span class="string">"10.20.172.108"</span></span><br><span class="line">2) <span class="string">"6381"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 查看sentinel日志(可以看到6380服务主动下线、与客观下线)</span></span><br><span class="line">13:58:50.367 <span class="comment"># +sdown master mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:50.451 <span class="comment"># +odown master mymaster 10.20.172.108 6380 #quorum 2/2</span></span><br><span class="line">13:58:50.451 <span class="comment"># +new-epoch 2</span></span><br><span class="line">13:58:50.451 <span class="comment"># +try-failover master mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:50.504 <span class="comment"># +vote-for-leader 875046c517f19aded2a5545457930ccd8ff35cb6 2</span></span><br><span class="line">13:58:50.693 <span class="comment"># 2e53ed2e7407064d08f09b5547615144d6e34159 voted for 875046c517f19aded2a5545457930ccd8ff35cb6 2</span></span><br><span class="line">13:58:50.719 <span class="comment"># 1c12264f05132a5627620588752a07429a635198 voted for 875046c517f19aded2a5545457930ccd8ff35cb6 2</span></span><br><span class="line">13:58:50.727 <span class="comment"># +elected-leader master mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:50.727 <span class="comment"># +failover-state-select-slave master mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:50.803 <span class="comment"># +selected-slave slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:50.803 * +failover-state-send-slaveof-noone slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6380</span><br><span class="line">13:58:50.874 * +failover-state-wait-promotion slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6380</span><br><span class="line">13:58:51.563 <span class="comment"># +promoted-slave slave 10.20.172.108:6381 10.20.172.108 6381 @ mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:51.563 <span class="comment"># +failover-state-reconf-slaves master mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:51.568 * +slave-reconf-sent slave 10.20.172.108:6379 10.20.172.108 6379 @ mymaster 10.20.172.108 6380</span><br><span class="line">13:58:51.843 <span class="comment"># -odown master mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:52.529 * +slave-reconf-inprog slave 10.20.172.108:6379 10.20.172.108 6379 @ mymaster 10.20.172.108 6380</span><br><span class="line">13:58:52.529 * +slave-reconf-done slave 10.20.172.108:6379 10.20.172.108 6379 @ mymaster 10.20.172.108 6380</span><br><span class="line">13:58:52.582 <span class="comment"># +failover-end master mymaster 10.20.172.108 6380</span></span><br><span class="line">13:58:52.582 <span class="comment"># +switch-master mymaster 10.20.172.108 6380 10.20.172.108 6381</span></span><br><span class="line">13:58:52.582 * +slave slave 10.20.172.108:6379 10.20.172.108 6379 @ mymaster 10.20.172.108 6381</span><br><span class="line">13:58:52.582 * +slave slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6381</span><br><span class="line">13:58:57.611 <span class="comment"># +sdown slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6381</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 登陆6381进行验证角色及其权限(此时6379变成了从节点、6380不在线)</span></span><br><span class="line">redis-cli -p 6381 -a 123456 info replication  | head -n 5</span><br><span class="line">  <span class="comment"># Replication</span></span><br><span class="line">  role:master</span><br><span class="line">  connected_slaves:1</span><br><span class="line">  slave0:ip=10.20.172.108,port=6379,state=online,offset=2456277,lag=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) 在 6981 master节点上新增一个key </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"set newname weiyigeek"</span> | redis-cli -h 10.20.172.108 -p 6381 -a 123456</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># (6) 在slave 6380 中查询上面插入的键</span></span><br><span class="line">10.20.172.108:6380&gt; keys *</span><br><span class="line">1) <span class="string">"newname"</span></span><br><span class="line">2) <span class="string">"username"</span></span><br><span class="line">3) <span class="string">"demo1"</span></span><br><span class="line">10.20.172.108:6380&gt; get newname</span><br><span class="line"><span class="string">"weiyigeek"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (7) 现在恢复我们杀掉的6380服务</span></span><br><span class="line">~/redis$ /usr/<span class="built_in">local</span>/bin/redis-server /home/weiyigeek/redis/6380/redis-6380.conf </span><br><span class="line"><span class="comment"># 查看其redis服务日志</span></span><br><span class="line">~/redis$ tail -f 50 /home/weiyigeek/redis/6381/redis-6381.conf </span><br><span class="line"><span class="comment"># Generated by CONFIG REWRITE</span></span><br><span class="line">masterauth <span class="string">"123456"</span></span><br><span class="line">user default on sanitize-payload <span class="comment">#8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92 ~* &amp;* +@all</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (8) 查看 sentinel 服务可以看到6380以及上线且设置其连接的master实例节点为10.20.172.108 6381</span></span><br><span class="line">14:04:23.511 <span class="comment"># -sdown slave 10.20.172.108:6380 10.20.172.108 6380 @ mymaster 10.20.172.108 6381</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (9) 6381 redis 已切换为master角色</span></span><br><span class="line">$ redis redis-cli -p 6381 -a 123456 info replication  | head -n 5</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=10.20.172.108,port=6379,state=online,offset=2456277,lag=0</span><br><span class="line">slave1:ip=10.20.172.108,port=6380,state=online,offset=2456277,lag=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># (10) 在从故障恢复的6380服务加入到当前主从服务，并查询之前在master节点插入的newname键。</span></span><br><span class="line">➜  redis redis-cli -p 6380 -a 123456 get newname                   </span><br><span class="line"><span class="string">"weiyigeek"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 8.至此哨兵的故障恢复实践完毕，下面是一些注意事项:<ul>
<li>sentinel 节点不要部署在同一台机器。</li>
<li>至少不是三个且奇数个的 sentinel 节点，增加选举的准确性因为领导者选举需要至少一半加1个节点。</li>
<li>sentinel节点集合可以只监控一个主节点，也可以监控多个主节点，尽量使用一套sentinel监控一个主节点。</li>
<li>sentinel的数据节点与普通的 redis 数据节点没有区别。</li>
<li>客户端初始化连接的是 Sentinel节点集合，不再是具体的redis节点，但是Sentinel 是配置中心不是代理。</li>
</ul>
</li>
</ul>
<p><br/></p>
<h4 id="Sentinel-配置文件"><a href="#Sentinel-配置文件" class="headerlink" title="Sentinel 配置文件"></a>Sentinel 配置文件</h4><p>描述：在redis源码包中自带一个<code>sentinel.conf</code>配置文件示例。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"># Example sentinel.conf</span><br><span class="line"></span><br><span class="line"># *** IMPORTANT ***</span><br><span class="line"># 默认情况下，无法从不同于本地主机的接口访问Sentinel，请使用“bind”指令绑定到网络接口列表，或通过将其添加到此配置文件来禁用带有“protected mode no”的protected mode。</span><br><span class="line">bind 127.0.0.1 192.168.1.1</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"># port &lt;sentinel-port&gt; : The port that this sentinel instance will run on</span><br><span class="line">port 26379</span><br><span class="line"></span><br><span class="line"># By default Redis Sentinel does not run as a daemon. </span><br><span class="line"># 设置yes后将生成 &#x2F;var&#x2F;run&#x2F;redis-sentinel.pid</span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"># 自定义 pid file 在本地路径</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis-sentinel.pid</span><br><span class="line"></span><br><span class="line"># 指定日志文件名。</span><br><span class="line"># 如使用 &quot;&quot; 标准输出</span><br><span class="line"># 如使用 daemonize 则日志将发送到 &#x2F;dev&#x2F;null.</span><br><span class="line">logfile &quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 由于NAT，Sentinel可以通过非本地地址从外部访问。当提供了通告ip时，Sentinel将在用于告知其存在的HELLO消息中声明指定的ip地址，而不是像通常那样自动检测本地地址。</span><br><span class="line"># Example:</span><br><span class="line"># sentinel announce-ip 1.2.3.4</span><br><span class="line"># sentinel announce-port 26379</span><br><span class="line"></span><br><span class="line"># sentinel 数据相关文件存储目录</span><br><span class="line"># dir &lt;working-directory&gt;</span><br><span class="line">dir &#x2F;tmp</span><br><span class="line"></span><br><span class="line"># 设置要得监控主控名称以及服务地址端口、并设置quorum(票数)</span><br><span class="line"># 注意：主控名称不应包含特殊字符或空格，有效字符集为A-z 0-9和三个字符“-\”。</span><br><span class="line"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"></span><br><span class="line"># 设置用于向主机和副本进行身份验证的密码（与服务端的密码保持一致）。</span><br><span class="line"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span><br><span class="line">sentinel auth-pass mymaster MySUPER--secret-0123passw0rd</span><br><span class="line"></span><br><span class="line"># 对于向具有ACL功能的实例进行身份验证非常有用，并且运行Redis 6.0或更高版本，当提供了just auth pass时 它将使用 “AUTH&lt;user&gt;&lt;pass&gt;” (一般情况下设置的是密码)</span><br><span class="line"># sentinel auth-user &lt;master-name&gt; &lt;username&gt;</span><br><span class="line"># user sentinel-user &gt;somepassword +client +subscribe +publish \</span><br><span class="line">#                    +ping +info +multi +slaveof +config +client +exec on</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 主（或任何附加的副本或哨兵）应是不可达的（如在指定的时间段内连续不可接受的答复），以考虑它在Sy-DOWN状态（主观下线），默认30s.</span><br><span class="line"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line"># IMPORTANT NOTE: starting with Redis 6.2 ACL capability is supported for Sentinel mode, </span><br><span class="line"># 参考地址: https:&#x2F;&#x2F;redis.io&#x2F;topics&#x2F;acl</span><br><span class="line"># Sentinel&#39;s ACL users are defined in the following format:</span><br><span class="line">#   user &lt;username&gt; ... acl rules ...</span><br><span class="line"># For example:</span><br><span class="line">#   user worker +@admin +@connection ~* on &gt;ffa9203c493aa99</span><br><span class="line"># For more information about ACL configuration please refer to the Redis</span><br><span class="line"># website at https:&#x2F;&#x2F;redis.io&#x2F;topics&#x2F;acl and redis server configuration </span><br><span class="line"># template redis.conf.</span><br><span class="line"></span><br><span class="line"># ACL日志跟踪失败的命令和与ACL关联的身份验证事件, 在下面定义ACL日志的最大条目长度：</span><br><span class="line">acllog-max-len 128</span><br><span class="line"></span><br><span class="line"># 使用外部ACL用户文件并且格式与redis.conf中用于描述用户的格式完全相同。</span><br><span class="line">aclfile &#x2F;etc&#x2F;redis&#x2F;sentinel-users.acl</span><br><span class="line"></span><br><span class="line"># requirepass 与 aclfile选项和ACL LOAD命令不兼容，在使用acl如设置该字段将被忽略。</span><br><span class="line"># requirepass &lt;password&gt;</span><br><span class="line"># 建议新配置文件对传入连接（通过ACL）和传出连接（通过sentinel user和sentinel pass）使用单独的身份验证控制</span><br><span class="line"></span><br><span class="line"># 将Sentinel配置为与具有特定用户名的其他Sentinel进行身份验证。</span><br><span class="line">sentinel sentinel-user &lt;username&gt;</span><br><span class="line"></span><br><span class="line"># Sentinel与其他Sentinel进行身份验证的密码。如果未配置sentinel用户，sentinel将使用具有sentinel pass的“默认”用户进行身份验证。</span><br><span class="line">sentinel sentinel-pass &lt;password&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在故障切换过程中，我们可以重新配置多少副本以同时指向新副本。如果使用副本来提供查询，请使用较低的数字，以避免在执行与主服务器的同步时，几乎同时无法访问所有副本。</span><br><span class="line"># sentinel parallel-syncs &lt;master-name&gt; &lt;numreplicas&gt;</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line"># 以毫秒为单位指定故障转移超时（默认三分钟)</span><br><span class="line"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># SCRIPTS EXECUTION</span><br><span class="line"># sentinel通知脚本和sentinel reconfig脚本用于配置在故障转移后被调用以通知系统管理员或重新配置客户端的脚本。使用以下错误处理规则执行脚本：</span><br><span class="line"># 如果脚本以“1”退出，则稍后将重试执行（最大次数当前设置为10）。</span><br><span class="line"># 如果脚本以“2”（或更高的值）退出，则不会重试脚本执行。</span><br><span class="line"># 如果脚本因接收到信号而终止，则行为与退出代码1相同。</span><br><span class="line"># 脚本的最大运行时间为60秒。达到此限制后，脚本将以SIGKILL终止，并重试执行。</span><br><span class="line"></span><br><span class="line"># NOTIFICATION SCRIPT | 通知执行</span><br><span class="line"># 为警告级别（例如-sdown、-odown等）中生成的任何sentinel事件调用指定的通知脚本</span><br><span class="line"># Example:</span><br><span class="line"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span><br><span class="line">sentinel notification-script mymaster &#x2F;var&#x2F;redis&#x2F;notify.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># CLIENTS RECONFIGURATION SCRIPT | 客户端重新配置脚本（可以多次调用）</span><br><span class="line"># 由于故障切换而更改主机时，可以调用脚本来执行特定于应用程序的任务，以通知客户端配置已更改且主机位于不同的地址。</span><br><span class="line"># ip、from port、to ip、to port 的参数用于传递主机的旧地址和所选副本（现在是主机）的新地址。</span><br><span class="line"># The following arguments are passed to the script:</span><br><span class="line"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span><br><span class="line"># &lt;state&gt; is currently always &quot;failover&quot;</span><br><span class="line"># &lt;role&gt; is either &quot;leader&quot; or &quot;observer&quot;</span><br><span class="line"># Example:</span><br><span class="line"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span><br><span class="line"> sentinel client-reconfig-script mymaster &#x2F;var&#x2F;redis&#x2F;reconfig.sh</span><br><span class="line"></span><br><span class="line"># SECURITY</span><br><span class="line"># 默认情况下，SENTINEL SET将无法在运行时更改通知脚本和客户端重新配置脚本。这避免了一个微不足道的安全问题，客户机可以将脚本设置为任何值，并触发故障转移以执行程序。</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line"># REDIS COMMANDS RENAMING </span><br><span class="line"># 有时 Redis服务器会将Sentinel正常工作所需的某些命令重命名为不可用字符串。在将Redis作为服务提供的提供者的上下文中，CONFIG和SLAVEOF通常是这种情况，并且不希望客户在管理控制台之外重新配置实例。</span><br><span class="line"># 在这种情况下，可以告诉Sentinel使用不同的命令名，而不是普通的命令名。</span><br><span class="line"># 例如，如果主机“mymaster”和相关副本的“CONFIG”全部重命名为“GUESSME”，我可以使用如下配置，设置好这样的配置后，Sentinel每次使用CONFIG时都会使用GUESSME。</span><br><span class="line">SENTINEL rename-command mymaster CONFIG GUESSME</span><br><span class="line"></span><br><span class="line"># SENTINEL SET也可用于在运行时执行此配置。</span><br><span class="line"># 为了将命令设置回其原始名称（撤消重命名），可以只将命令重命名为其自身：</span><br><span class="line">SENTINEL rename-command mymaster CONFIG CONFIG</span><br><span class="line"></span><br><span class="line"># HOSTNAMES SUPPORT</span><br><span class="line"># 通过启用解析主机名来启用主机名支持。请注意，您必须确保DNS配置正确，并且DNS解析不会引入很长的延迟。</span><br><span class="line">SENTINEL resolve-hostnames no</span><br><span class="line"></span><br><span class="line"># 启用“解析主机名”时，Sentinel在向用户、配置文件等公开实例时仍使用IP地址。如果要在宣布时保留主机名，请启用下面的“宣布主机名”。</span><br><span class="line">SENTINEL announce-hostnames no</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="Sentinel-常用命令"><a href="#Sentinel-常用命令" class="headerlink" title="Sentinel 常用命令"></a>Sentinel 常用命令</h4><p>描述: Sentinel 常用API命令(<a href="https://redis.io/topics/sentinel#Sentinel%20API),以下列出的是Sentinel接受的命令：" target="_blank" rel="noopener">https://redis.io/topics/sentinel#Sentinel%20API),以下列出的是Sentinel接受的命令：</a></p>
<p><strong>常用命令</strong></p>
<p>(1) 出于连接管理和管理目的，Sentinel 支持以下 Redis 命令子集：</p>
<ul>
<li><p><strong>PING</strong>：返回PONG。</p>
</li>
<li><p><strong>COMMAND</strong> ( <code>&gt;= 6.2</code>) 此命令返回有关命令的信息。有关详细信息，请参阅<a href="https://redis.io/commands/command" target="_blank" rel="noopener">COMMAND</a>命令及其各种子命令。</p>
</li>
<li><p><strong>INFO</strong> 返回有关 Sentinel 服务器的信息和统计信息。有关更多信息，请参阅<a href="https://redis.io/commands/info" target="_blank" rel="noopener">INFO</a>命令。</p>
</li>
<li><p><strong>ROLE</strong> 此命令返回字符串“sentinel”和受监控主站的列表。有关更多信息，请参阅<a href="https://redis.io/commands/role" target="_blank" rel="noopener">ROLE</a>命令。</p>
</li>
<li><p><strong>AUTH</strong> ( <code>&gt;= 5.0.1</code>)  验证客户端连接。有关更多信息，请参阅<a href="https://redis.io/commands/auth" target="_blank" rel="noopener">AUTH</a>命令和<a href="https://redis.io/topics/sentinel#configuring-sentinel-instances-with-authentication" target="_blank" rel="noopener"><em>使用身份验证配置 Sentinel 实例</em>部分</a>。</p>
</li>
<li><p><strong>HELLO</strong> ( <code>&gt;= 6.0</code>)  切换连接的协议。有关更多信息，请参阅<a href="https://redis.io/commands/hello" target="_blank" rel="noopener">HELLO</a>命令。</p>
</li>
<li><p><strong>CLIENT</strong> 此命令管理客户端连接。有关更多信息，请参阅其子命令页面。</p>
</li>
<li><p><strong>ACL</strong> ( &gt;= 6.2) `此命令管理 Sentinel 访问控制列表。有关详细信息，请参阅<a href="https://redis.io/topics/acl" target="_blank" rel="noopener">ACL</a>文档页面和<a href="https://redis.io/topics/sentinel#sentinel-access-control-list-authentication" target="_blank" rel="noopener"><em>Sentinel 访问控制列表身份验证</em></a>。</p>
</li>
<li><p><strong>SHUTDOWN</strong> 关闭 Sentinel 实例。</p>
</li>
</ul>
<p><br/></p>
<p>(2) SENTINEL命令是 Sentinel 的主要 API</p>
<ul>
<li><code>SENTINEL masters</code>：用于查看监控的所有Redis Master信息，包括配置和状态等。</li>
<li><code>SENTINEL master &lt;master name&gt;</code>： 显示指定主机的状态和信息。</li>
<li><code>SENTINEL slaves</code>：列出给定主服务器的所有从服务器，以及这些从服务器的当前状态。</li>
<li><code>SENTINEL replicas &lt;master name&gt;</code> ( &gt;= 5.0) 显示此主服务器的副本列表及其状态。</li>
<li><code>SENTINEL sentinels</code>：查看给定主服务器的Sentinel实例列表及其状态。</li>
<li><code>SENTINEL sentinel &lt;master name&gt;</code>: 显示此 master 的哨兵实例列表及其状态。</li>
<li><code>SENTINEL monitor</code>: 启动 Sentinel 的监控。参阅<a href="https://redis.io/topics/sentinel#reconfiguring-sentinel-at-runtime" target="_blank" rel="noopener"><em>在运行时重新配置 Sentinel</em>部分</a>。</li>
<li><code>SENTINEL MONITOR&lt;name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</code>：此命令告诉 Sentinel 开始监视具有指定名称、IP、端口和仲裁的新主服务器。</li>
<li><code>SENTINEL myid</code> ( &gt;= 6.2):  返回 Sentinel 实例的 ID。</li>
<li><code>SENTINEL get-master-addr-by-name</code>：返回给定名字的主服务器的IP地址和端口号。 如果这个主服务器正在执行故障转移操作，或者针对这个主服务器的故障转移操作已经完成，那么这个命令返回新的主服务器的IP地址和端口号。</li>
<li><p><code>SENTINEL is-master-down-by-addr</code>：一个Sentinel可以通过向另一个Sentinel发送SENTINEL is-master-down-by-addr命令来询问对方是否认为给定的服务器已下线。</p>
</li>
<li><p><code>SENTINEL failover</code>：强制发起一次某个Master的failover，如果该Master不可访问的话。</p>
</li>
<li><code>SENTINEL failover &lt;master name&gt;</code>: 强制故障转移，就好像主节点不可访问一样，并且不要求其他 Sentinel 同意（但是，将发布新版本的配置，以便其他 Sentinel 更新其配置）。</li>
<li><code>SENTINEL reset</code>：强制重设所有监控的Master状态，清除已知的Slave和Sentinel实例信息，重新获取并生成配置文件。</li>
<li><code>SENTINEL reset &lt;pattern&gt;</code>：重置所有名字和给定模式pattern相匹配的主服务器。pattern 参数是一个Glob风格的模式。重置操作清除主服务器目前的所有状态，包括正在执行中的故障转移，并移除目前已经发现和关联的，主服务器的所有从服务器和Sentinel。</li>
<li><code>SENTINEL ckquorum &lt;master name&gt;</code>: 检查当前 Sentinel 配置是否能够达到故障转移主服务器所需的法定人数，以及授权故障转移所需的大多数人数。此命令应用于监控系统以检查 Sentinel 部署是否正常。</li>
<li><code>SENTINEL PENDING-SCRIPTS</code>: 此命令返回有关挂起脚本的信息。</li>
<li><code>SENTINEL SIMULATE-FAILURE (crash-after-election|crash-after-promotion|help)</code> ( &gt;= 3.2): 此命令模拟不同的 Sentinel 崩溃场景。</li>
</ul>
<p><br/></p>
<p>(3) 动态获取修改Sentinel配置</p>
<ul>
<li><code>SENTINEL CONFIG GET&lt;name&gt;</code> ( <code>&gt;= 6.2</code>) 获取全局 Sentinel 配置参数的当前值。指定的名称可以是通配符，类似于Redis CONFIG GET命令。</li>
<li><code>SENTINEL CONFIG &lt;name&gt; &lt;value&gt;</code>: SET命令与Redis的CONFIG SET命令非常相似，用于更改特定master 的配置参数。可以指定多个选项/值对（或根本不指定）。可以通过配置的所有配置参数也可以sentinel.conf使用 SET 命令进行配置。</li>
<li><code>SENTINEL FLUSHCONFIG</code>: 强制 Sentinel 在磁盘上重写其配置，包括当前 Sentinel 状态。通常 Sentinel 会在每次其状态发生变化时重写配置（在状态子集的上下文中，该子集在重新启动时保留在磁盘上）。但是有时可能会因为操作错误、磁盘故障、包升级脚本或配置管理器而导致配置文件丢失。在这些情况下，强制 Sentinel 重写配置文件的方法很方便。即使之前的配置文件完全丢失此命令也能工作。</li>
</ul>
<p>Tips 可以操作的全局参数包括：</p>
<ul>
<li>resolve-hostnames, announce-hostnames. 请参阅IP 地址和 DNS 名称。</li>
<li>announce-ip, announce-port. 请参阅Sentinel、Docker、NAT 和可能的问题。</li>
<li>sentinel-user, sentinel-pass. 请参阅使用身份验证配置 Sentinel 实例。</li>
</ul>
<p><br/></p>
<p>(4) 移除master监控服务或者删除旧的 master 或无法访问的副本</p>
<ul>
<li><code>SENTINEL REMOVE &lt;name&gt;</code> : 用于移除指定的master：master将不再被监控（放弃对某个master的监听）。</li>
<li><code>SENTINEL RESET mastername</code>: 从 Sentinels 监视的副本列表中永远删除一个副本（可能是旧的 master）。</li>
</ul>
<p><br/></p>
<p>(5) 添加或删除哨兵<br>描述: 由于 Sentinel 实现了自动发现机制，因此将新 Sentinel 添加到您的部署中是一个简单的过程。您需要做的就是启动配置为监视当前活动主站的新 Sentinel。在 10 秒内，Sentinel 将获取其他 Sentinel 的列表以及附加到 master 的副本集。在该过程结束时，可以使用该命令 <code>SENTINEL MASTER mastername</code> 来检查所有 Sentinel 是否同意监视 master 的 Sentinel 总数。</p>
<p>移除 Sentinel 有点复杂：Sentinels 永远不会忘记已经看到的 Sentinels，即使它们很长时间无法访问，因为我们不想动态更改授权故障转移和创建新配置所需的多数数字。因此为了删除 Sentinel，应在没有网络分区的情况下执行以下步骤：</p>
<ul>
<li>停止要移除的 Sentinel 的 Sentinel 进程。</li>
<li><code>SENTINEL RESET *</code> 向所有其他 Sentinel 实例发送命令（*如果您只想重置一个主服务器，则可以使用确切的主服务器名称）。一个接一个，实例之间至少等待 30 秒。</li>
<li>通过检查<code>SENTINEL MASTER mastername</code> 每个 Sentinel的输出，检查所有 Sentinel 是否同意当前活动的 Sentinel 数量。</li>
</ul>
<p><br></p>
<p><strong>发布/订阅消息</strong><br>描述: 客户端可以使用 Sentinel 作为与 Redis 兼容的发布/订阅服务器（但您不能使用PUBLISH），以便订阅或PSUBSCRIBE到频道并获得有关特定事件的通知。</p>
<p>以下是您可以使用此 API 接收的频道和消息格式的列表。第一个字是通道/事件名称，其余的是数据的格式。<br><code>&lt;instance-type&gt; &lt;name&gt; &lt;ip&gt; &lt;port&gt; @ &lt;master-name&gt; &lt;master-ip&gt; &lt;master-port&gt;</code><br>注意：指定实例详细信息的地方意味着提供以下参数来标识目标实例：</p>
<p>标识 master 的部分（从 @ 参数到结尾）是可选的，并且仅在实例本身不是 master 时才指定。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+reset-master &lt;instance details&gt; -- 主机被重置。</span><br><span class="line">+slave &lt;instance details&gt; -- 检测到并附加了一个新副本。</span><br><span class="line">+failover-state-reconf-slaves &lt;instance details&gt; -- 故障转移状态更改为reconf-slavesstate。</span><br><span class="line">+failover-detected &lt;instance details&gt; --检测到由另一个 Sentinel 或任何其他外部实体启动的故障转移（一个附加的副本变成了一个主）。</span><br><span class="line">+slave-reconf-sent &lt;instance details&gt; -- 领导哨兵向该实例发送REPLICAOF命令，以便为新副本重新配置它。</span><br><span class="line">+slave-reconf-inprog &lt;instance details&gt; -- 正在重新配置的副本显示为新主 ip:port 对的副本，但同步过程尚未完成。</span><br><span class="line">+slave-reconf-done &lt;instance details&gt; -- 副本现在与新的主服务器同步。</span><br><span class="line">-dup-sentinel &lt;instance details&gt; -- 指定 master 的一个或多个 sentinel 被删除为重复的（例如，当 Sentinel 实例重新启动时会发生这种情况）。</span><br><span class="line">+sentinel &lt;instance details&gt; -- 检测到并附加了此主人的新哨兵。</span><br><span class="line">+sdown &lt;instance details&gt; -- 指定的实例现在处于主观关闭状态。</span><br><span class="line">-sdown &lt;instance details&gt; -- 指定的实例不再处于主观关闭状态。</span><br><span class="line">+odown &lt;instance details&gt; -- 指定的实例现在处于 Objectively Down 状态。</span><br><span class="line">-odown &lt;instance details&gt; -- 指定的实例不再处于 Objectively Down 状态。</span><br><span class="line">+new-epoch &lt;instance details&gt; -- 当前纪元已更新。</span><br><span class="line">+try-failover &lt;instance details&gt; -- 正在进行新的故障转移，等待多数人选举。</span><br><span class="line">+elected-leader &lt;instance details&gt; -- 赢得指定时期的选举，可以进行故障转移。</span><br><span class="line">+failover-state-select-slave &lt;instance details&gt; -- 新的故障转移状态是select-slave：我们正在尝试寻找合适的副本进行升级。</span><br><span class="line">no-good-slave &lt;instance details&gt; -- 没有好的副本可以推广。目前我们会在一段时间后尝试，但可能这会改变，在这种情况下状态机将完全中止故障转移。</span><br><span class="line">selected-slave &lt;instance details&gt; -- 我们找到了要提升的指定好的副本。</span><br><span class="line">failover-state-send-slaveof-noone -- &lt;instance details&gt;我们正在尝试将提升的副本重新配置为主副本，等待它切换。</span><br><span class="line">failover-end-for-timeout -- &lt;instance details&gt;故障转移因超时而终止，副本最终将被配置为与新的主节点进行复制。</span><br><span class="line">failover-end &lt;instance details&gt; -- 故障转移成功终止。所有副本似乎都被重新配置为使用新的主副本进行复制。</span><br><span class="line">switch-master &lt;master name&gt; &lt;oldip&gt; &lt;oldport&gt; &lt;newip&gt; &lt;newport&gt; -- 主新 IP 和地址是配置更改后指定的。这是大多数外部用户感兴趣的消息。</span><br><span class="line">+tilt -- 进入倾斜模式。</span><br><span class="line">-tilt -- 退出倾斜模式。</span><br></pre></td></tr></table></figure></p>
<p>Tips ：-BUSY 状态的处理，当 Lua 脚本运行的时间超过配置的 Lua 脚本时间限制时，Redis 实例会返回 -BUSY 错误。在触发故障转移之前发生这种情况时，Redis Sentinel 将尝试发送SCRIPT KILL 命令，只有在脚本为只读时才会成功。如果在此尝试后实例仍处于错误状态，则最终将进行故障转移。</p>
<p><br></p>
<p><strong>命令使用演示:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.展示所有被监控的主节点状态以及相关的统计信息</span></span><br><span class="line">&gt; sentinel masters</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.展示指定&lt;master name&gt;的主节点状态以及相关的统计信息，例如：</span></span><br><span class="line">&gt; sentinel master mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.展示指定&lt;master name&gt;的从节点状态以及相关的统计信息</span></span><br><span class="line">&gt; sentinel slaves mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.展示指定&lt;master name&gt;的Sentinel节点集合（不包含当前Sentinel节点），例如：</span></span><br><span class="line">&gt; sentinel sentinels mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.返回指定&lt;master name&gt;主节点的IP地址和端口</span></span><br><span class="line">&gt; sentinel get-master-addr-by-name mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.当前Sentinel节点对符合 &lt;pattern&gt;（通配符风格）主节点的配置进行重置，包含清除主节点的相关状态（例如故障转移），重新发现从节点和 Sentinel节点。</span></span><br><span class="line"><span class="comment"># 例如，sentinel-1节点对mymaster-1节点重置状态如下：</span></span><br><span class="line">&gt; sentinel reset mymaster <span class="comment"># integer 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.对指定&lt;master name&gt;主节点进行强制故障转移（没有和其他Sentinel节 点“协商”）</span></span><br><span class="line"><span class="comment"># 例如，对 mymaster 进行故障转移， 执行命令后mymaster由原来的一个从节点6380代替。</span></span><br><span class="line">&gt; sentinel failover mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.检测当前可达的Sentinel节点总数是否达到的个数。例如 quorum=3，而当前可达的Sentinel节点个数为2个，那么将无法进行故障转 移，Redis Sentinel的高可用特性也将失去。</span></span><br><span class="line">&gt; sentinel ckquorum mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.将Sentinel节点的配置强制刷到磁盘上，这个命令Sentinel节点自身用得 比较多，对于开发和运维人员只有当外部原因（例如磁盘损坏）造成配置文 件损坏或者丢失时，这个命令是很有用的。</span></span><br><span class="line">&gt; sentinel flushconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.取消当前Sentinel节点对于指定 &lt;master name&gt;主节点的监控。</span></span><br><span class="line"><span class="comment"># 例如，sentinel-1当前对mymaster进行了监控，sentinel-1节点取消对mymaster节点的监控，但是要注意这 个命令仅仅对当前Sentinel节点有效。</span></span><br><span class="line">&gt; sentinel remove mymaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.通过命令的形式 来完成Sentinel节点对主节点的监控。</span></span><br><span class="line"><span class="comment"># 例如,命令sentinel-1节点重新监控mymaster节点：</span></span><br><span class="line">&gt; sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 12.Sentinel节点之间用来交换对主节点是否下线的判断。</span></span><br><span class="line">&gt; sentinel is-master-down-by-addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 13.动态修改Sentinel节点配置选项。</span></span><br><span class="line">&gt; sentinel <span class="built_in">set</span> &lt;master name&gt;</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210906114041.png" target="_blank" title="WeiyiGeek.sentinel相关命令实践" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210906114041.png" alt="WeiyiGeek.sentinel相关命令实践" title="" class=""></a>
                <p>WeiyiGeek.sentinel相关命令实践</p>
            </figure></p>
<hr>
<h3 id="Redis-Cluster-模式"><a href="#Redis-Cluster-模式" class="headerlink" title="Redis Cluster 模式"></a>Redis Cluster 模式</h3><p>描述: 在大型项目中Redis Cluster 集群模式被广泛应用，哨兵解决和主从不能自动故障恢复的问题，但是同时也存在难以扩容以及单机存储、读写能力受限的问题，并且集群之前都是一台redis的全量的数据，导致所有的redis都冗余一份，就会大大消耗内存空间,所以此时我们需要引入Redis 集群模式。</p>
<h4 id="1-基础介绍"><a href="#1-基础介绍" class="headerlink" title="1.基础介绍"></a>1.基础介绍</h4><p>描述: <strong>什么是Redis集群？</strong></p>
<blockquote>
<p>Redis集群是一个多Redis实例的集合，用于通过对数据库分区来扩展数据库，使其更具有弹性。集群中的每个成员，无论是主副本还是次级副本，都管理哈希槽的一个子集。如果一个主服务器出现不能访问的故障，那么它的从属服务器会提升为主服务器。在由三个主节点组成的最小的Redis集群中，每个主节点都有一个从属节点（为了至少能保证最低程度的故障转移），每个主节点分配一个范围在0至16383之间的哈希槽。节点A包含哈希槽范围为从0到5000，节点B为5001到10000，节点C从10001到18383。集群内部的通信则通过内部总线进行，使用gossip协议来传播关于集群的信息或者发现新节点。</p>
</blockquote>
<p><br/></p>
<p>Redis 集群采用了P2P的模式完全去中心化(分布式存储), 实现数据的分片把所有的 Key 分成了 16384 个 slot，每个 Redis 实例负责其中一部分slot, 并根据算法每个redis节点存储不同的内容; 集群中的所有信息（节点、端口、slot等），都通过节点之间定期的数据交换而更新，同时解决了在线的节点收缩（下线）和扩容（上线）问题。</p>
<p>例如：Redis 客户端可以在任意一个 Redis 实例发出请求（读、写），如果所需数据不在该实例中，通过重定向命令引导客户端访问所需的实例。</p>
<p><a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210908170616.png" target="_blank" title="WeiyiGeek.RedisCluster" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210908170616.png" alt="WeiyiGeek.RedisCluster"></a></p>
<p><br></p>
<p><strong>cluster 特性(已测试):</strong></p>
<ul>
<li>1): 节点自动发现</li>
<li>2): slave-&gt;master 选举,集群容错</li>
<li>3): Hot resharding:在线分片</li>
<li>4): 集群管理:cluster xxx</li>
<li>5): 基于配置(nodes-port.conf)的集群管理</li>
<li>6): ASK 转向/MOVED 转向机制.</li>
</ul>
<p><strong>优点</strong><br>1) 集群模式是一个无中心的架构模式，将数据进行分片，分布到对应的槽中，每个节点存储不同的数据内容，通过路由能够找到对应的节点负责存储的槽，能够实现高效率的查询。<br>2) 并且集群模式增加了横向和纵向的扩展能力，实现节点加入和收缩，集群模式是哨兵的升级版，哨兵的优点集群都有。</p>
<p><strong>缺点</strong><br>1) cluster环境下slave默认不接受任何读写操作，在slave执行readonly命令后可只能执行读操作<br>2) client端不支持多key操作(mget,mset等)，但当keys集合对应的slot相同时支持mget操作见:hash_tag<br>3) 不支持多数据库，只有一个<code>db select 0</code>(无多个db)<br>4) JedisCluster 没有针对byte[]的API，需要自己扩展(附件是我加的基于byte[]的BinaryJedisCluster-api)<br>1) 缓存的最大问题就是带来数据一致性问题，在平衡数据一致性的问题时，兼顾性能与业务要求，大多数都是以最终一致性的方案进行解决，而不是强一致性。<br>2) 并且集群模式带来节点数量的剧增，一个集群模式最少要6台机，因为要满足半数原则的选举方式，所以也带来了架构的复杂性。</p>
<p>Tips: 集群模式真正意义上实现了系统的高可用和高性能，但是集群同时进一步使系统变得越来越复杂，接下来我们来详细的了解集群的运作原理。</p>
<p><em>Q:什么是redis-cluster选举容错?</em></p>
<ul>
<li>(1)选举过程是集群中所有master参与, 如果半数以上master节点与故障节点通信超过(cluster-node-timeout)时间, 则认为该节点故障，自动触发故障转移操作.</li>
<li>(2) 什么时候整个集群不可用(cluster_state:fail)? <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a: 如果集群任意master挂掉,且当前master没有slave.集群进入fail状态,也可以理解成集群的slot映射[0-16383]不完整时进入fail状态.ps : redis-3.0.0.rc1 加入cluster-require-full-coverage 参数,默认关闭,打开集群兼容部分失败.</span><br><span class="line">b: 如果集群超过半数以上master挂掉，无论是否有slave集群进入fail状态.</span><br><span class="line">ps: 当集群不可用时,所有对集群的操作做都不可用，收到((error) CLUSTERDOWN The cluster is down)错误</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h4 id="2-集群架构"><a href="#2-集群架构" class="headerlink" title="2.集群架构"></a>2.集群架构</h4><p>描述: redis-cluter 架构细节浅析</p>
<ul>
<li>所有的redis节点彼此互联(PING-PONG机制),内部使用二进制协议优化传输速度和带宽.</li>
<li>节点的fail是通过集群中超过半数的节点检测失效时才生效.</li>
<li>客户端与redis节点直连,不需要中间proxy层.客户端不需要连接集群所有节点,连接集群中任何一个可用节点即可</li>
<li>redis-cluster把所有的物理节点映射到<code>\[0-16383]slot</code>上, cluster 负责维护 <code>node&lt;-&gt;slot&lt;-&gt;key</code></li>
<li>Redis集群预分好16384个桶，当需要在 Redis 集群中放置一个key-value 时，根据 CRC16(key) mod 16384的值，决定将一个key放到哪个桶中。</li>
</ul>
<figure class="image-box">
                <a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190418085002.png" target="_blank" title="WeiyiGeek.架构图" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190418085002.png" alt="WeiyiGeek.架构图" title="" class=""></a>
                <p>WeiyiGeek.架构图</p>
            </figure>
<p><br/></p>
<h4 id="3-原理分析"><a href="#3-原理分析" class="headerlink" title="3.原理分析"></a>3.原理分析</h4><p><strong>3.1 数据分区原理</strong><br>描述: 集群的原理图还是很好理解的，在Redis集群中采用的是虚拟槽分区算法，会把redis集群分成 16384 个槽（0-16383）。</p>
<p>比如：下图所示三个master会把<code>0-16383</code>范围的槽可能分成三部分（0-5000）、（5001-11000）、（11001-16383）分别数据三个缓存节点的槽范围。</p>
<p>当客户端请求过来，会首先通过对key进行CRC16 校验并对 16384 取模（CRC16(key)%16383）计算出key所在的槽，然后再到对应的槽上进行取数据或者存数据，这样就实现了数据的访问更新。</p>
<figure class="image-box">
                <a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829160046.png" target="_blank" title="WeiyiGeek.数据分区原理" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829160046.png" alt="WeiyiGeek.数据分区原理" title="" class=""></a>
                <p>WeiyiGeek.数据分区原理</p>
            </figure>
<p>Tips: 进行分槽存储是将一整堆的数据进行分片，防止单台的redis数据量过大，影响性能的问题。</p>
<p><br></p>
<p><strong>3.2 节点通信</strong><br>描述: 节点之间实现了将数据进行分片存储，那么节点之间又是怎么通信的呢？</p>
<p>这个和前面哨兵模式讲的命令基本一样, 首先新上线的节点, 会通过 Gossip 协议向老成员发送Meet消息，表示自己是新加入的成员。</p>
<p>老成员收到Meet消息后，在没有故障的情况下会恢复PONG消息，表示欢迎新结点的加入，除了第一次发送Meet消息后，之后都会发送定期PING消息，实现节点之间的通信。</p>
<p>Redis集群节点间的通信机制有如下两种方式</p>
<p>集中式方式</p>
<ul>
<li>1) 优点：元数据的更新和读取，时效性非常好，一旦元数据出现变更立即就会更新到集中式的存储中，其他节点读取的时候立即就可以立即感知到。</li>
<li><p>2) 缺点：所有的元数据的更新压力全部集中在一个地方，可能导致元数据的存储压力。</p>
<p>TiP: 很多中间件都会借助zookeeper集中式存储元数据。</p>
</li>
</ul>
<p>gossip 方式</p>
<ul>
<li>1) 优点：元数据的更新比较分散，不是集中在一个地方，更新请求会陆陆续续，打到所有节点上去更新，有一定的延时，降低了压力。</li>
<li>2)缺点：元数据更新有延时可能导致集群的一些操作会有一些滞后。</li>
</ul>
<p><br></p>
<p>gossip协议包含多种消息，包括ping，pong，meet，fail等等，流程示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">缓存节点2  </span><br><span class="line">-&gt; Meet 消息  <span class="comment"># 某个节点发送meet给新加入的节点，让新节点加入集群中，然后新节点就会开始与其他节点进行通信。</span></span><br><span class="line">-&lt; Pong 消息 </span><br><span class="line">-&gt; Ping 消息  <span class="comment"># 每个节点都会频繁给其他节点发送ping，其中包含自己的状态还有自己维护的集群元数据，互相通过ping交换元数据（获取集群节点相关信息如增加、移除、Hash slot信息等）</span></span><br><span class="line">-&lt; Pong 消息  <span class="comment"># 对ping和meet消息的返回，包含自己的状态和其他信息，也可以用于信息广播和更新。</span></span><br><span class="line">-&gt; fail 信息  <span class="comment"># 某个节点判断另一个节点fail之后，就发送fail给其他节点，通知其他节点指定的节点宕机了。</span></span><br><span class="line">缓存节点1</span><br></pre></td></tr></table></figure></p>
<p>通信的过程中会为每一个通信的节点开通一条tcp通道，之后就是定时任务，不断的向其它节点发送PING消息，这样做的目的就是为了了解节点之间的元数据存储情况，以及健康状况，以便即使发现问题。</p>
<p><br></p>
<p>但如果节点通信网络抖动问题,网络通信中有时会因为一些客观原因使得网络突然中断或者波动而变得不可访问。</p>
<p>此时 Redis Cluster 提供了一种选项 cluster-­node-­timeout，表示当某个节点持续timeout的时间失联时，才可以认定该节点出现故障，需要进行主从切换。当没有此参数时候，网络抖动会导致主从频繁切换 【数据的重新复制】。</p>
<p>Tips: 每个节点都有一个专门用于节点间gossip通信的端口，默认得为自己提供服务的端口号+10000，即6379为redis服务端点则节点间通信的就是18000端口。</p>
<p><br></p>
<p><strong>3.3 数据请求</strong><br>上面说到了槽信息，在Redis的底层维护了<code>unsigned char myslots[CLUSTER_SLOTS/8]</code>一个数组存放每个节点的槽信息。</p>
<p>因为他是一个二进制数组，只有存储0和1值，如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数组下标: 0 1 2 3 4 ..... 16382 16383</span><br><span class="line">二进制值: 1 1 1 1 0 ..... 0     0</span><br></pre></td></tr></table></figure></p>
<p>这样数组只表示自己是否存储对应的槽数据，若是1表示存在该数据，0表示不存在该数据，这样查询的效率就会非常的高，类似于布隆过滤器(二进制存储)。</p>
<p>比如：集群节点1负责存储0-5000的槽数据，但是此时只有0、1、2存储有数据，其它的槽还没有存数据，所以0、1、2对应的值为1。</p>
<p>并且，每个redis底层还维护了一个clusterNode数组，大小也是16384，用于储存负责对应槽的节点的ip、端口等信息，这样每一个节点就维护了其它节点的元数据信息，便于及时的找到对应的节点。</p>
<p>当新结点加入或者节点收缩，通过PING命令通信，及时的更新自己clusterNode数组中的元数据信息，这样有请求过来也就能及时的找到对应的节点。</p>
<figure class="image-box">
                <a rel=4.Redis基础运维之哨兵和集群安装配置 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829160747.png" target="_blank" title="WeiyiGeek.clusterNode数组中的元数据信息" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210829160747.png" alt="WeiyiGeek.clusterNode数组中的元数据信息" title="" class=""></a>
                <p>WeiyiGeek.clusterNode数组中的元数据信息</p>
            </figure>
<p>有两种其它的情况就是：</p>
<p>1) 若是请求过来发现，数据发生了迁移，比如新节点加入，会使旧的缓存节点数据迁移到新结点。</p>
<p>2) 请求过来发现旧节点已经发生了数据迁移并且数据被迁移到新结点，由于每个节点都有clusterNode信息，通过该信息的ip和端口。此时旧节点就会向客户端发一个MOVED 的重定向请求，表示数据已经迁移到新结点上，你要访问这个新结点的ip和端口就能拿到数据，这样就能重新获取到数据。</p>
<p><br></p>
<p><em>倘若正在发正数据迁移呢？</em></p>
<blockquote>
<p>答: 旧节点就会向客户端发送一个ASK 重定向请求，并返回给客户端迁移的目标节点的ip和端口，这样也能获取到数据。</p>
</blockquote>
<p><br></p>
<p><strong>3.4扩容和收缩</strong></p>
<p>描述: 扩容和收缩也就是节点的上线和下线，可能节点发生故障了，故障自动回复的过程（节点收缩）。</p>
<p>节点的收缩和扩容时，会重新计算每一个节点负责的槽范围，并发根据虚拟槽算法，将对应的数据更新到对应的节点。</p>
<p>还有前面的讲的新加入的节点会首先发送Meet消息，详细可以查看前面讲的内容，基本一样的模式。</p>
<p>以及发生故障后，哨兵老大节点的选举，master节点的重新选举，slave怎样晋升为master节点，可以查看前面哨兵模式选举过程。</p>
<p>Tips: 新节点加入集群时都是master节点,并且也是无法写数据的（没有slot槽位），需要从新分配槽位后才可以访问。</p>
<p><br></p>
<p><strong>3.5高可用主从切换原理</strong><br>描述: 集群中当<code>slave</code>发现自己的 master(主节点)变为 FAIL 状态时，便尝试进行 Failover 指向其它正常 master 节点。</p>
<p>有时由于挂掉的 master 可能会有多个slave 节点，从而存在多个 slave 节点 竞争成为 master节点 的过程，其过程如下：</p>
<p>1.slave 发现自己的 master 变为<code>FAIL</code></p>
<p>2.将自己记录的集群 <code>currentEpoch</code> 进行 +1，并广播 <code>FAILOVER_AUTH_REQUEST</code> 信息.</p>
<p>3.其他节点收到该信息只有 master 响应判断请求者的合法性， 并发送 <code>FAILOVER_AUTH_ACK</code>，对每一个 epoch 只发送一次 ack</p>
<p>4.尝试 failover 的 slave 收集 <code>FAILOVER_AUTH_ACK</code>.</p>
<p>5.超过半数后变成新Master.</p>
<p>6.广播 Pong 通知其他集群节点。</p>
<p>所以 Redis Cluster 既能够实现主从的角色分配，又能够实现主从切换，相当于<code>集成了Replication 和Sentinal</code> 的功能。</p>
<p><br></p>
<p><strong>3.6 跳转重定位节点与卡槽</strong><br>当客户端向一个错误的节点发出了指令，该节点会发现指令的key所在的槽位并不归自己管理，这时它会向客户端发送一个特殊的跳转指令携带目标操作的节点地址，告诉客户端去连这个节点去获取数据。</p>
<p>客户端收到指令后除了跳转到正确的节点上去操作，还会同步更新纠正本地的槽位映射表缓存，后续所有key将使用新的槽位映射表。</p>
<p><br></p>
<h4 id="4-集群搭建"><a href="#4-集群搭建" class="headerlink" title="4.集群搭建"></a>4.集群搭建</h4><p>描述: Redis集群中要求奇数节点,至少要有三个节点，并且每个节点至少有一备份节点，所以至少需要6个redis服务实例。</p>
<p><strong>4.1 安装环境</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统版本与redis版本</span></span><br><span class="line">OS: Centos7.10 / Centos6.10</span><br><span class="line">Reids版本：5.0.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3台服务器，每台起3个服务，共9个节点</span></span><br><span class="line">Centos7：192.168.1.99/24 &#123;7000,7001,7002&#125;</span><br><span class="line">Centos6-1：192.168.1.100/24 &#123;7000,7001,7002&#125;</span><br><span class="line">Centos6-2：192.168.1.101/24 &#123;7000,7001,7002&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS 依赖库更新，并下载或更新额外需要的依赖</span></span><br><span class="line">$ yum update -y &amp;&amp; yum uograde -y</span><br><span class="line">lib / zlib / ruby / rubugems  <span class="comment">#述均安装最新版本，否则会和redis版本不匹配</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>4.2 安装流程</strong><br>Step 1.分别在三台服务器安装编译配置redis安装与上面一致(注意更新依赖)。</p>
<p><br/></p>
<p>Step 2.准备目录结构和redis配置。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每台机器上执行如下命令</span></span><br><span class="line">$ mkdir -p /data/redis/redis-cluster/&#123;7000,7001,7002&#125;</span><br><span class="line">$ touch /data/redis/redis-cluster/7000/redis.conf</span><br><span class="line">$ mkdir -p /etc/redis/cluster/run/ <span class="comment">#7建立集群配置文件cluster-config-file路径</span></span><br><span class="line"></span><br><span class="line">tee /data/redis/redis-cluster/7000/redis.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment">## redis 通用配置 ## (注意注意：注释不能放在配置文件后)</span></span><br><span class="line"><span class="comment"># 指定监听地址与端口</span></span><br><span class="line">port 7000</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改安全模式(我们设置requirepass字段，所以保护模式可以关闭了)</span></span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台运行</span></span><br><span class="line">daemonize yes</span><br><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库文件存放路径</span></span><br><span class="line">dir /data/redis/redis-cluster/7000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定进程pid文件</span></span><br><span class="line">pidfile /var/run/redis_7000.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定日志文件记录文件(notice / verbose)</span></span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis_7000.log</span><br><span class="line">loglevel verbose  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 最大客户端连接数</span></span><br><span class="line">maxclients 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端连接空闲多久后断开连接，单位秒，0表示禁用</span></span><br><span class="line">timeout 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis 数据持久化(rdb/aof)配置</span></span><br><span class="line"><span class="comment"># RDB 文件名</span></span><br><span class="line">dbfilename <span class="string">"dump.rdb"</span></span><br><span class="line"><span class="comment"># 数据自动保存脚本条件例如300s中有10key发生变化</span></span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="comment"># 对RDB文件进行压缩，建议以（磁盘）空间换（CPU）时间。</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="comment"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span></span><br><span class="line">rdbchecksum yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF开启</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="comment"># AOF文件名</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line"><span class="comment"># 可选值 always， everysec，no，建议设置为everysec</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名Redis风险命令</span></span><br><span class="line"><span class="comment"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class="line">rename-command FLUSHDB b840fc02d524045429941cc15f59e41cb7be6c53</span><br><span class="line">rename-command FLUSHALL b840fc02d524045429941cc15f59e41cb7be6c54</span><br><span class="line">rename-command EVAL b840fc02d524045429941cc15f59e41cb7be6c55</span><br><span class="line">rename-command DEBUG b840fc02d524045429941cc15f59e41cb7be6c56</span><br><span class="line"><span class="comment"># rename-command SHUTDOWN SHUTDOWN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用集群</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"><span class="comment"># 指定集群配置文件名称，该文件记录集群运行时信息</span></span><br><span class="line"><span class="comment"># 注意：可以用绝对路径，但必须保证路径已经存在，否则启动失败；如果只有文件名称的话，文件生成在工作路径下</span></span><br><span class="line">cluster-config-file /etc/redis/cluster/run/nodes-7000.conf</span><br><span class="line"><span class="comment"># 集群超时时间</span></span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line"><span class="comment"># 主节点写入后必须同步到一台从上。</span></span><br><span class="line">min‐replicas‐to‐write 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 3.将配置文件分别复制到其他目录并修改端口号。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp /data/redis/redis-cluster/7000/redis.conf /data/redis/redis-cluster/7001/redis.conf</span><br><span class="line">cp /data/redis/redis-cluster/7000/redis.conf /data/redis/redis-cluster/7002/redis.conf </span><br><span class="line">sed -i <span class="string">'s/7000/7001/g'</span> /data/redis/redis-cluster/7001/redis.conf</span><br><span class="line">sed -i <span class="string">'s/7000/7002/g'</span> /data/redis/redis-cluster/7002/redis.conf</span><br><span class="line"><span class="comment"># 注意，上述有些配置项要对应服务和目录，三个目录按照上述配置好后，启动服务</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 4.编写开启与关闭集群脚本 cluster-control.sh，并启动集群<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">tee cluster-control.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> start_cluster()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..2&#125;</span><br><span class="line">  <span class="keyword">do</span> </span><br><span class="line">    /usr/bin/redis-server /data/redis/redis-cluster/700<span class="variable">$i</span>/redis.conf; </span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> stop_cluster()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment"># -c 连接到集群</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..2&#125;</span><br><span class="line">  <span class="keyword">do</span> </span><br><span class="line">    /usr/bin/redis-cli -a 123456 -c -p 700<span class="variable">$&#123;i&#125;</span> shutdown save; </span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Usage: cluster-control.sh [start|sop]"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">    start) <span class="built_in">echo</span> <span class="string">"开启redis集群"</span> </span><br><span class="line">      start_cluster</span><br><span class="line">    ;;</span><br><span class="line">    stop) <span class="built_in">echo</span> <span class="string">"停止Redis集群"</span></span><br><span class="line">      stop_cluster</span><br><span class="line">    ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line">$ chmod +x ./cluster_control.sh &amp;&amp; ./cluster_control.sh start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群服务的进程查看</span></span><br><span class="line">$ ps -ef | grep <span class="string">"redis"</span></span><br><span class="line"><span class="comment"># root      6171     1  0 11:25 ?        00:00:00 /usr/bin/redis-server 0.0.0.0:7000 [cluster]</span></span><br><span class="line"><span class="comment"># root      6178     1  0 11:25 ?        00:00:00 /usr/bin/redis-server 0.0.0.0:7001 [cluster]</span></span><br><span class="line"><span class="comment"># root      6182     1  0 11:25 ?        00:00:00 /usr/bin/redis-server 0.0.0.0:7002 [cluster]</span></span><br><span class="line"><span class="comment"># root      6198  3732  0 11:26 pts/0    00:00:00 grep --color=auto redis</span></span><br></pre></td></tr></table></figure><br><br></p>
<p>Step 5.Redis 官方提供了 redis-trib.rb 工具(<code>/opt/redis/redis-5.0.4/utils/create-cluster</code>)，我们可以进行手动进行创建Redis集群。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：在任意一台上运行即可, 不要在每台机器上都运行，一台就够了我们就选用CentOS7作为主。</span></span><br><span class="line"><span class="comment"># redis-4.0.10 版本</span></span><br><span class="line">./redis-trib.rb create --replicas 1 192.168.1.99:7000 192.168.1.99:7001 192.168.1.99:7002 192.168.1.100:7000 192.168.1.100:7001 192.168.1.100:7002 192.168.1.101:7000 192.168.1.101:7001 192.168.1.101:7002 -a [密码]       </span><br><span class="line"><span class="comment"># redis-5.0.4 版本</span></span><br><span class="line">redis-cli --cluster create 192.168.1.99:7000 192.168.1.99:7001 192.168.1.99:7002 192.168.1.100:7000 192.168.1.100:7001 192.168.1.100:7002 192.168.1.101:7000 192.168.1.101:7001 192.168.1.101:7002 --cluster-replicas 1 -a [密码] </span><br><span class="line"></span><br><span class="line"><span class="comment"># 正在9个节点上执行哈希插槽分配</span></span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 9 nodes... </span><br><span class="line">Master[0] -&gt; Slots 0 - 4095</span><br><span class="line">Master[1] -&gt; Slots 4096 - 8191</span><br><span class="line">Master[2] -&gt; Slots 8192 - 12287</span><br><span class="line">Master[3] -&gt; Slots 12288 - 16383</span><br><span class="line"><span class="comment"># 四台 master 、五台 slave (选择：YES)</span></span><br><span class="line">Adding replica 192.168.1.101:7001 to 192.168.1.99:7000</span><br><span class="line">Adding replica 192.168.1.99:7002 to 192.168.1.100:7000</span><br><span class="line">Adding replica 192.168.1.100:7002 to 192.168.1.101:7000</span><br><span class="line">Adding replica 192.168.1.101:7002 to 192.168.1.99:7001</span><br><span class="line">Adding replica 192.168.1.100:7001 to 192.168.1.99:7000</span><br><span class="line">M: 8c5a037999975a052e422bc030c3fc72053d059e 192.168.1.99:7000</span><br><span class="line">   slots:[0-4095] (4096 slots) master</span><br><span class="line">M: 4877856114a8efc62325dc0d32adede6256eb9ef 192.168.1.99:7001</span><br><span class="line">   slots:[12288-16383] (4096 slots) master</span><br><span class="line">S: 3bd40f9a2d95a9865f58706b55f4559e6c43dd7e 192.168.1.99:7002</span><br><span class="line">   replicates 6df7e2ad828ba148239dd4465235d17ce0e0af10</span><br><span class="line">M: 6df7e2ad828ba148239dd4465235d17ce0e0af10 192.168.1.100:7000</span><br><span class="line">   slots:[4096-8191] (4096 slots) master</span><br><span class="line">S: 35756a64813b68bf5fea92b6ee2b1a7020b8cc7a 192.168.1.100:7001</span><br><span class="line">   replicates 8c5a037999975a052e422bc030c3fc72053d059e</span><br><span class="line">S: f467098bffa3761868842556eb4cfff7cc8bc363 192.168.1.100:7002</span><br><span class="line">   replicates 660590807a4417e901c6d2277b29a306c1ea07e3</span><br><span class="line">M: 660590807a4417e901c6d2277b29a306c1ea07e3 192.168.1.101:7000</span><br><span class="line">   slots:[8192-12287] (4096 slots) master</span><br><span class="line">S: cd7fb4d0a48a114629c1f34e0f75da5235910995 192.168.1.101:7001</span><br><span class="line">   replicates 8c5a037999975a052e422bc030c3fc72053d059e</span><br><span class="line">S: 8d1cab296fe88e1809e550ecd482f6df67c61e7b 192.168.1.101:7002</span><br><span class="line">   replicates 4877856114a8efc62325dc0d32adede6256eb9ef</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示了集群和slot分配结果 4主/5从</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.99:7000)</span><br><span class="line">M: 8c5a037999975a052e422bc030c3fc72053d059e 192.168.1.99:7000</span><br><span class="line">   slots:[0-4095] (4096 slots) master</span><br><span class="line">   2 additional replica(s)</span><br><span class="line">S: cd7fb4d0a48a114629c1f34e0f75da5235910995 192.168.1.101:7001</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 8c5a037999975a052e422bc030c3fc72053d059e</span><br><span class="line">S: 35756a64813b68bf5fea92b6ee2b1a7020b8cc7a 192.168.1.100:7001</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 8c5a037999975a052e422bc030c3fc72053d059e</span><br><span class="line">M: 4877856114a8efc62325dc0d32adede6256eb9ef 192.168.1.99:7001</span><br><span class="line">   slots:[12288-16383] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 6df7e2ad828ba148239dd4465235d17ce0e0af10 192.168.1.100:7000</span><br><span class="line">   slots:[4096-8191] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 3bd40f9a2d95a9865f58706b55f4559e6c43dd7e 192.168.1.99:7002</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 6df7e2ad828ba148239dd4465235d17ce0e0af10</span><br><span class="line">S: f467098bffa3761868842556eb4cfff7cc8bc363 192.168.1.100:7002</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 660590807a4417e901c6d2277b29a306c1ea07e3</span><br><span class="line">S: 8d1cab296fe88e1809e550ecd482f6df67c61e7b 192.168.1.101:7002</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4877856114a8efc62325dc0d32adede6256eb9ef</span><br><span class="line">M: 660590807a4417e901c6d2277b29a306c1ea07e3 192.168.1.101:7000</span><br><span class="line">   slots:[8192-12287] (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果要重新配置集群先停止集群，然后 将cluster-config-file 配置的所有文件删除，再重新启动集群，就可以重新配置集群。</span></span><br><span class="line"><span class="comment"># 当出现集群无法启动时，删除集群配置文件，再次重新启动每一个redis服务，然后重新构件集群环境。</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>Step 6.验证Redis集群是否正常工作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli --cluster check 192.168.1.99:7000 <span class="comment">#查看节点7000端口号的集群信息</span></span><br><span class="line"></span><br><span class="line">$ redis-cli -c -p 7000 -h 192.168.1.99  <span class="comment"># 连接集群（-c参数得重要特性）</span></span><br><span class="line">192.168.1.99:7000&gt; auth 123456</span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 如果该redis实例中没有key则切换到其他得机器得redis实例中进行获取。</span></span><br><span class="line">192.168.1.99:7000&gt; get name  </span><br><span class="line"><span class="comment"># -&gt; Redirected to slot [5798] located at 192.168.1.100:7000 (error) NOAUTH Authentication required.</span></span><br><span class="line">192.168.1.100:7000&gt; auth 123456</span><br><span class="line">OK</span><br><span class="line">192.168.1.100:7000&gt; get name</span><br><span class="line"><span class="string">"weiyi"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">192.168.1.100:7000&gt; cluster info </span><br><span class="line">  <span class="comment"># cluster_state:ok</span></span><br><span class="line">  <span class="comment"># cluster_slots_assigned:16384</span></span><br><span class="line">  <span class="comment"># cluster_slots_ok:16384</span></span><br><span class="line">  <span class="comment"># cluster_slots_pfail:0</span></span><br><span class="line">  <span class="comment"># cluster_slots_fail:0</span></span><br><span class="line">  <span class="comment"># cluster_known_nodes:9</span></span><br><span class="line">  <span class="comment"># cluster_size:4</span></span><br><span class="line">  <span class="comment"># cluster_current_epoch:9</span></span><br><span class="line">  <span class="comment"># cluster_my_epoch:4</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_ping_sent:1100</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_pong_sent:984</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_sent:2084</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_ping_received:984</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_pong_received:1087</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_received:2071</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群节点</span></span><br><span class="line">192.168.1.100:7000&gt; cluster nodes </span><br><span class="line">  <span class="comment"># 8d1cab296fe88e1809e550ecd482f6df67c61e7b 192.168.1.101:7002@17002 slave 4877856114a8efc62325dc0d32adede6256eb9ef 0 1555559362575 9 connected</span></span><br><span class="line">  <span class="comment"># f467098bffa3761868842556eb4cfff7cc8bc363 192.168.1.100:7002@17002 slave 660590807a4417e901c6d2277b29a306c1ea07e3 0 1555559363077 7 connected</span></span><br><span class="line">  <span class="comment"># 8c5a037999975a052e422bc030c3fc72053d059e 192.168.1.99:7000@17000 master - 0 1555559362172 1 connected 0-4095</span></span><br><span class="line">  <span class="comment"># cd7fb4d0a48a114629c1f34e0f75da5235910995 192.168.1.101:7001@17001 slave 8c5a037999975a052e422bc030c3fc72053d059e 0 1555559363582 8 connected</span></span><br><span class="line">  <span class="comment"># 660590807a4417e901c6d2277b29a306c1ea07e3 192.168.1.101:7000@17000 master - 0 1555559362575 7 connected 8192-12287</span></span><br><span class="line">  <span class="comment"># 6df7e2ad828ba148239dd4465235d17ce0e0af10 192.168.1.100:7000@17000 myself,master - 0 1555559362000 4 connected 4096-8191</span></span><br><span class="line">  <span class="comment"># 35756a64813b68bf5fea92b6ee2b1a7020b8cc7a 192.168.1.100:7001@17001 slave 8c5a037999975a052e422bc030c3fc72053d059e 0 1555559363000 5 connected</span></span><br><span class="line">  <span class="comment"># 4877856114a8efc62325dc0d32adede6256eb9ef 192.168.1.99:7001@17001 master - 0 1555559362070 2 connected 12288-16383</span></span><br><span class="line">  <span class="comment"># 3bd40f9a2d95a9865f58706b55f4559e6c43dd7e 192.168.1.99:7002@17002 slave 6df7e2ad828ba148239dd4465235d17ce0e0af10 0 1555559363078 4 connected</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群数据槽（划分给每个节点的分片Slots范围。）</span></span><br><span class="line">192.168.1.100:7000&gt; CLUSTER SLOTS   </span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 0</span><br><span class="line">   2) (<span class="built_in">integer</span>) 4095</span><br><span class="line">   3) 1) <span class="string">"192.168.1.99"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7000</span><br><span class="line">      3) <span class="string">"8c5a037999975a052e422bc030c3fc72053d059e"</span></span><br><span class="line">   4) 1) <span class="string">"192.168.1.101"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7001</span><br><span class="line">      3) <span class="string">"cd7fb4d0a48a114629c1f34e0f75da5235910995"</span></span><br><span class="line">   5) 1) <span class="string">"192.168.1.100"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7001</span><br><span class="line">      3) <span class="string">"35756a64813b68bf5fea92b6ee2b1a7020b8cc7a"</span></span><br><span class="line">2) 1) (<span class="built_in">integer</span>) 8192</span><br><span class="line">   2) (<span class="built_in">integer</span>) 12287</span><br><span class="line">   3) 1) <span class="string">"192.168.1.101"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7000</span><br><span class="line">      3) <span class="string">"660590807a4417e901c6d2277b29a306c1ea07e3"</span></span><br><span class="line">   4) 1) <span class="string">"192.168.1.100"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7002</span><br><span class="line">      3) <span class="string">"f467098bffa3761868842556eb4cfff7cc8bc363"</span></span><br><span class="line">3) 1) (<span class="built_in">integer</span>) 4096</span><br><span class="line">   2) (<span class="built_in">integer</span>) 8191</span><br><span class="line">   3) 1) <span class="string">"192.168.1.100"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7000</span><br><span class="line">      3) <span class="string">"6df7e2ad828ba148239dd4465235d17ce0e0af10"</span></span><br><span class="line">   4) 1) <span class="string">"192.168.1.99"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7002</span><br><span class="line">      3) <span class="string">"3bd40f9a2d95a9865f58706b55f4559e6c43dd7e"</span></span><br><span class="line">4) 1) (<span class="built_in">integer</span>) 12288</span><br><span class="line">   2) (<span class="built_in">integer</span>) 16383</span><br><span class="line">   3) 1) <span class="string">"192.168.1.99"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7001</span><br><span class="line">      3) <span class="string">"4877856114a8efc62325dc0d32adede6256eb9ef"</span></span><br><span class="line">   4) 1) <span class="string">"192.168.1.101"</span></span><br><span class="line">      2) (<span class="built_in">integer</span>) 7002</span><br><span class="line">      3) <span class="string">"8d1cab296fe88e1809e550ecd482f6df67c61e7b"</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="5-集群命令"><a href="#5-集群命令" class="headerlink" title="5.集群命令"></a>5.集群命令</h4><h5 id="5-1-命令行式"><a href="#5-1-命令行式" class="headerlink" title="5.1 命令行式"></a>5.1 命令行式</h5><p><strong>语法格式:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Help | 获取帮助</span></span><br><span class="line">$ redis-cli --cluster <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Cluster Manager Commands:</span></span><br><span class="line"><span class="comment"># - 集群创建</span></span><br><span class="line">  create         host1:port1 ... hostN:portN </span><br><span class="line">                 --cluster-replicas &lt;arg&gt;    <span class="comment"># 指定集群副本主节点数/从节点数的比例，如果为0表示不为集群的master节点创建slave。</span></span><br><span class="line"><span class="comment"># - 集群检查</span></span><br><span class="line">  check          host:port </span><br><span class="line">                 --cluster-search-multiple-owners      <span class="comment"># 检查是否有槽同时被分配给了多个节点</span></span><br><span class="line"><span class="comment"># - 集群信息</span></span><br><span class="line">  info           host:port</span><br><span class="line"><span class="comment"># - 集群修复</span></span><br><span class="line">  fix            host:port</span><br><span class="line">                 --cluster-search-multiple-owners       <span class="comment"># 说明：修复集群和槽的重复分配问题</span></span><br><span class="line">                 --cluster-fix-with-unreachable-masters <span class="comment"># 不可访问主机的群集修复</span></span><br><span class="line"><span class="comment"># - 添加节点        </span></span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port <span class="comment"># 默认为主节点</span></span><br><span class="line">                 --cluster-slave           <span class="comment"># 按比例分配到master上作为副本Slave</span></span><br><span class="line">                 --cluster-master-id id    <span class="comment"># 指定MasterID上作为其副本Slave</span></span><br><span class="line"><span class="comment"># - 删除节点                 </span></span><br><span class="line">  del-node       host:port node_id </span><br><span class="line"></span><br><span class="line"><span class="comment"># - 分片迁移              </span></span><br><span class="line">  reshard        host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;  <span class="comment"># 需要从哪些源master节点（id）上迁移slot，可从多个源节点完成迁移，以逗号隔开，传递的是节点的node id，还可以直接传递--from all，这样源节点就是集群的所有节点，不传递该参数的话，则会在迁移过程中提示用户输入</span></span><br><span class="line">                 --cluster-to &lt;arg&gt;    <span class="comment"># slot需要迁移的目的节点的node id</span></span><br><span class="line">                 --cluster-slots &lt;arg&gt; <span class="comment"># 需要迁移的slot数量</span></span><br><span class="line">                 --cluster-yes         <span class="comment"># 指定迁移时的确认输入</span></span><br><span class="line">                 --cluster-timeout &lt;arg&gt;  <span class="comment"># 设置migrate命令的超时时间</span></span><br><span class="line">                 --cluster-pipeline &lt;arg&gt; <span class="comment"># 定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10</span></span><br><span class="line">                 --cluster-replace       <span class="comment"># 是否直接replace到目标节点</span></span><br><span class="line"><span class="comment"># - 集群重新分片 </span></span><br><span class="line">  rebalance      host:port</span><br><span class="line">                 --cluster-weight &lt;node1=w1...nodeN=wN&gt;   <span class="comment"># 节点权重配置默认1，如为多个节点分配权重则 master1id=5 master2id=2 需要保证前缀数能唯一区别该节点。</span></span><br><span class="line">                 --cluster-use-empty-masters  <span class="comment"># 让没有分配的slots的主机节点参与到rebalance 分片中</span></span><br><span class="line">                 --cluster-timeout &lt;arg&gt;      <span class="comment"># 超时时间设置</span></span><br><span class="line">                 --cluster-simulate           <span class="comment"># 模拟执行</span></span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;     <span class="comment"># 定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10</span></span><br><span class="line">                 --cluster-threshold &lt;arg&gt;    <span class="comment"># 迁移的slot阈值超过threshold，执行rebalance操作</span></span><br><span class="line">                 --cluster-replace            <span class="comment"># 是否直接replace到目标节点</span></span><br><span class="line"><span class="comment"># 将外部redis数据导入集群</span></span><br><span class="line">  import         host:port</span><br><span class="line">                 --cluster-from &lt;arg&gt;      <span class="comment"># 将指定实例IP</span></span><br><span class="line">                 --cluster-from-user &lt;arg&gt;</span><br><span class="line">                 --cluster-from-pass &lt;arg&gt;</span><br><span class="line">                 --cluster-from-askpass</span><br><span class="line">                 --cluster-copy        <span class="comment"># 复制</span></span><br><span class="line">                 --cluster-replace     <span class="comment"># 替换</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  在集群的所有节点执行相关命令</span></span><br><span class="line">  call           host:port <span class="built_in">command</span> arg arg .. arg</span><br><span class="line">                 --cluster-only-masters</span><br><span class="line">                 --cluster-only-replicas</span><br><span class="line">              </span><br><span class="line"><span class="comment"># 备份集群数据</span></span><br><span class="line">  backup         host:port backup_directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群节点间心跳连接的超时时间</span></span><br><span class="line">  <span class="built_in">set</span>-timeout    host:port milliseconds</span><br><span class="line"></span><br><span class="line"><span class="comment"># Cluster Manager Options:</span></span><br><span class="line">  --cluster-yes  Automatic yes to cluster commands prompts (在脚本实现自动化的时候非常有用)</span><br></pre></td></tr></table></figure></p>
<p>Tips: 对于check、fix、reshard、del node、set timeout，您可以指定群集中任何工作节点的主机和端口。</p>
<p><br/></p>
<p><strong>实践使用:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) Redis集群创建提供6台配置一样的Redis服务，--cluster-replicas 1 : 表示我们希望为集群中的每个主节点创建一个从节点，此处为三主三从。</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/redis-cli -h 192.168.1.2 -a weiyigeek.top --cluster create --cluster-replicas 1 [192.168.1.2:6379 ~ 192.168.1.7:6379]</span><br><span class="line">  <span class="comment"># [OK] All nodes agree about slots configuration.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class="line">  <span class="comment"># [OK] All 16384 slots covered.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 集群信息各工作节点以及卡槽使用检查(2Master/5从节点)</span></span><br><span class="line">redis-cli -h 172.16.243.97 -a weiyigeek --cluster check 172.16.243.97:6379 --cluster-search-multiple-owners</span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Performing Cluster Check (using node 172.16.243.97:6379)</span></span><br><span class="line">  <span class="comment"># M: d97cb5b15b7130ca0bd5322758e0c2dce061fd7b 172.16.243.97:6379  slots:[0-4723],[8192-16383] (12916 slots) master</span></span><br><span class="line">  <span class="comment">#   3 additional replica(s)</span></span><br><span class="line">  <span class="comment"># S: 436c6a1d7e4c5f782e1e0620b831211ebb0a41a4 172.16.100.116:6379 slots: (0 slots) slave</span></span><br><span class="line">  <span class="comment">#   replicates d97cb5b15b7130ca0bd5322758e0c2dce061fd7b</span></span><br><span class="line">  <span class="comment"># M: 94b8d3748dc47053454e657da8d6bb90e0081f2c 172.16.183.95:6379  slots:[4724-8191] (3468 slots) master</span></span><br><span class="line">  <span class="comment">#   1 additional replica(s)</span></span><br><span class="line">  <span class="comment"># S: 6af3ad6a8691b57393aeb6b4cc5334382aa5b392 172.16.243.98:6379  slots: (0 slots) slave</span></span><br><span class="line">  <span class="comment">#   replicates d97cb5b15b7130ca0bd5322758e0c2dce061fd7b</span></span><br><span class="line">  <span class="comment"># S: d69c99fd6605d747da03874aafaa283a2b5614ea 172.16.24.215:6379  slots: (0 slots) slave</span></span><br><span class="line">  <span class="comment">#   replicates d97cb5b15b7130ca0bd5322758e0c2dce061fd7b</span></span><br><span class="line">  <span class="comment"># S: 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 172.16.24.214:6379  slots: (0 slots) slave</span></span><br><span class="line">  <span class="comment">#   replicates 94b8d3748dc47053454e657da8d6bb90e0081f2c</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 集群Master节点信息以及占用的Keys数量和卡槽数量以及有几个从节点</span></span><br><span class="line">redis-cli -h 172.16.243.97 -a weiyigeek --cluster info 172.16.24.214:6379</span><br><span class="line">  <span class="comment"># 172.16.183.95:6379 (94b8d374...) -&gt; 30327 keys | 3468 slots | 1 slaves.</span></span><br><span class="line">  <span class="comment"># 172.16.243.97:6379 (d97cb5b1...) -&gt; 194497 keys | 12916 slots | 3 slaves.</span></span><br><span class="line">  <span class="comment"># [OK] 224824 keys in 2 masters.</span></span><br><span class="line">  <span class="comment"># 13.72 keys per slot on average.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 集群节点删除实践，例如从redis集群中删除上面的 172.16.100.116:6379 从节点。</span></span><br><span class="line">redis-cli -h 172.16.243.97 -a weiyigeek --cluster del-node 172.16.100.116:6379 436c6a1d7e4c5f782e1e0620b831211ebb0a41a4</span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Removing node 436c6a1d7e4c5f782e1e0620b831211ebb0a41a4 from cluster 172.16.100.116:6379 </span></span><br><span class="line">redis-cli -h 172.16.243.97 -a weiyigeek --cluster del-node 172.16.24.214:6379 2674f21a88a9573f51ec46f9dc248ad4a5c5974d</span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Removing node 2674f21a88a9573f51ec46f9dc248ad4a5c5974d from cluster 172.16.24.214:6379</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) 集群节点添加实践，前者按照比例添加到其master节点下，我们可以使用后者将节点添加为master节点</span></span><br><span class="line">redis-cli -h 172.16.243.97 -a weiyigeek --cluster add-node 172.16.100.116:6379 172.16.243.97:6379 --cluster-slave  <span class="comment"># slave 节点添加</span></span><br><span class="line">  <span class="comment"># [OK] All nodes agree about slots configuration.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class="line">  <span class="comment"># [OK] All 16384 slots covered.</span></span><br><span class="line">  <span class="comment"># Automatically selected master 172.16.183.95:6379</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Send CLUSTER MEET to node 172.16.100.116:6379 to make it join the cluster.</span></span><br><span class="line">  <span class="comment"># Waiting for the cluster to join</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Configure node as replica of 172.16.183.95:6379.</span></span><br><span class="line">  <span class="comment"># [OK] New node added correctly.</span></span><br><span class="line">~$ redis-cli -h 172.16.243.97 -a weiyigeek --cluster add-node 172.16.24.214:6379 172.16.243.97:6379 --cluster-master-id 94b8d3748dc47053454e657da8d6bb90e0081f2c  <span class="comment"># master节点</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (6) 说明：修复集群和槽的重复分配问题（将所有slots迁移到一处）</span></span><br><span class="line">~$ redis-cli -h 172.16.243.97 -a weiyigeek --cluster fix --cluster-fix-with-unreachable-masters 172.16.24.214:6379 </span><br><span class="line">  <span class="comment"># 172.16.24.214:6379 (2674f21a...) -&gt; 0 keys | 0 slots | 0 slaves.</span></span><br><span class="line">  <span class="comment"># [OK] 0 keys in 1 masters.</span></span><br><span class="line">  <span class="comment"># 0.00 keys per slot on average.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Performing Cluster Check (using node 172.16.24.214:6379)</span></span><br><span class="line">  <span class="comment"># M: 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 172.16.24.214:6379</span></span><br><span class="line">  <span class="comment">#   slots: (0 slots) master</span></span><br><span class="line">  <span class="comment"># [OK] All nodes agree about slots configuration.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class="line">  <span class="comment"># [ERR] Not all 16384 slots are covered by nodes.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Fixing slots coverage...</span></span><br><span class="line">  <span class="comment"># The following uncovered slots have no keys across the cluster:</span></span><br><span class="line">  <span class="comment"># [0-16383]</span></span><br><span class="line">  <span class="comment"># Fix these slots by covering with a random node? (type 'yes' to accept): yes</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Covering slot 660 with 172.16.24.214:6379</span></span><br><span class="line">  .....</span><br><span class="line">~$ redis-cli -h 172.16.243.97 -a weiyigeek -c cluster nodes  <span class="comment"># 可以看见现在只有一个Master</span></span><br><span class="line">  <span class="comment"># 436c6a1d7e4c5f782e1e0620b831211ebb0a41a4 172.16.100.116:6379@16379 slave 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 0 1631268716040 10 connected</span></span><br><span class="line">  <span class="comment"># 94b8d3748dc47053454e657da8d6bb90e0081f2c 172.16.183.95:6379@16379 slave 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 0 1631268715000 10 connected</span></span><br><span class="line">  <span class="comment"># 6af3ad6a8691b57393aeb6b4cc5334382aa5b392 172.16.243.98:6379@16379 slave 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 0 1631268716541 10 connected</span></span><br><span class="line">  <span class="comment"># d69c99fd6605d747da03874aafaa283a2b5614ea 172.16.24.215:6379@16379 slave 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 0 1631268716000 10 connected</span></span><br><span class="line">  <span class="comment"># d97cb5b15b7130ca0bd5322758e0c2dce061fd7b 172.16.243.97:6379@16379 myself,slave 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 0 1631268715000 10 connected</span></span><br><span class="line">  <span class="comment"># 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 172.16.24.214:6379@16379 master - 0 1631268715537 10 connected 0-16383 ... (关键点)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (6) redis集群重新分配slots给加入的主节点，此时按照如下步骤进行</span></span><br><span class="line"><span class="comment"># - 将两个Slave节点移除</span></span><br><span class="line">~$ redis-cli -h 172.16.24.214 -a weiyigeek --cluster del-node 172.16.183.95:6379  94b8d3748dc47053454e657da8d6bb90e0081f2c</span><br><span class="line">~$ redis-cli -h 172.16.24.214 -a weiyigeek --cluster del-node 172.16.243.97:6379  d97cb5b15b7130ca0bd5322758e0c2dce061fd7b</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 将刚才移除的两个slave节点加入到集群并设置为master(此时我们的三主Master也回来了)</span></span><br><span class="line">~$ redis-cli -h 172.16.24.214 -a weiyigeek --cluster add-node 172.16.183.95:6379 172.16.24.214:6379</span><br><span class="line">~$ redis-cli -h 172.16.24.214 -a weiyigeek --cluster add-node 172.16.243.97:6379 172.16.24.214:6379</span><br><span class="line">  <span class="comment"># 94b8d3748dc47053454e657da8d6bb90e0081f2c 172.16.183.95:6379@16379 master - 0 1631276731560 8 connected</span></span><br><span class="line">  <span class="comment"># 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 172.16.24.214:6379@16379 myself,master - 0 1631276729000 10 connected 0-16383</span></span><br><span class="line">  <span class="comment"># d97cb5b15b7130ca0bd5322758e0c2dce061fd7b 172.16.243.97:6379@16379 master - 0 1631276730000 9 connected</span></span><br><span class="line"><span class="comment"># - 重新分配卡槽给两个空的master节点</span></span><br><span class="line">~$ redis-cli -h 172.16.24.214 -a weiyigeek --cluster rebalance --cluster-threshold 1 --cluster-use-empty-masters --cluster-pipeline 10 172.16.243.97:6379</span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Performing Cluster Check (using node 172.16.243.97:6379)</span></span><br><span class="line">  <span class="comment"># [OK] All nodes agree about slots configuration.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class="line">  <span class="comment"># [OK] All 16384 slots covered.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Rebalancing across 3 nodes. Total weight = 3.00</span></span><br><span class="line">  <span class="comment"># Moving 5462 slots from 172.16.24.214:6379 to 172.16.243.97:6379</span></span><br><span class="line">  <span class="comment"># #######</span></span><br><span class="line">  <span class="comment"># Moving 5461 slots from 172.16.24.214:6379 to 172.16.183.95:6379</span></span><br><span class="line">  <span class="comment"># #######</span></span><br><span class="line">~$ redis-cli -h 172.16.24.214 -a weiyigeek -c cluster nodes  <span class="comment"># 验证分配</span></span><br><span class="line">  <span class="comment"># 94b8d3748dc47053454e657da8d6bb90e0081f2c 172.16.183.95:6379@16379 master - 0 1631277376000 12 connected 5462-10922</span></span><br><span class="line">  <span class="comment"># 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 172.16.24.214:6379@16379 myself,master - 0 1631277377000 10 connected 10923-16383</span></span><br><span class="line">  <span class="comment"># d97cb5b15b7130ca0bd5322758e0c2dce061fd7b 172.16.243.97:6379@16379 master - 0 1631277377248 11 connected 0-5461</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (7) 迁移 slot 到指定nodeID张，在线把集群的一些slot从集群原来slot节点迁移到新的节点，即可以完成集群的在线横向扩容和缩容。（非常注意卡槽分别分配的数量为 5462 、5461）</span></span><br><span class="line"><span class="comment"># 交互式 - 直接连接到集群的任意一节点，根据选择进行操作</span></span><br><span class="line">~$ redis-cli -a weiyigeek --cluster reshard 172.16.24.214:6379 <span class="comment"># </span></span><br><span class="line"><span class="comment"># 命令行式 - 连接到集群的任意一节点来对指定节点指定数量的slot进行迁移到指定的节点</span></span><br><span class="line">~$ redis-cli -a weiyigeek --cluster reshard 172.16.24.214:6379 --cluster-from d97cb5b15b7130ca0bd5322758e0c2dce061fd7b --cluster-to 2674f21a88a9573f51ec46f9dc248ad4a5c5974d --cluster-slots 50 --cluster-yes --cluster-timeout 5000 --cluster-pipeline 50 --cluster-replace</span><br><span class="line">  <span class="comment"># Ready to move 50 slots.</span></span><br><span class="line">  <span class="comment">#   Source nodes:</span></span><br><span class="line">  <span class="comment">#     M: d97cb5b15b7130ca0bd5322758e0c2dce061fd7b 172.16.243.97:6379</span></span><br><span class="line">  <span class="comment">#       slots:[0-5461] (5462 slots) master</span></span><br><span class="line">  <span class="comment">#       1 additional replica(s)</span></span><br><span class="line">  <span class="comment">#   Destination node:</span></span><br><span class="line">  <span class="comment">#     M: 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 172.16.24.214:6379</span></span><br><span class="line">  <span class="comment">#       slots:[10923-16383] (5461 slots) master</span></span><br><span class="line">  <span class="comment">#       1 additional replica(s)</span></span><br><span class="line">  <span class="comment">#   Resharding plan:</span></span><br><span class="line">  <span class="comment">#     Moving slot 0 from d97cb5b15b7130ca0bd5322758e0c2dce061fd7b</span></span><br><span class="line">  <span class="comment">#     .....</span></span><br><span class="line">  <span class="comment">#     Moving slot 49 from d97cb5b15b7130ca0bd5322758e0c2dce061fd7b</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (8) 备份集群数据到本地目录中。</span></span><br><span class="line">redis-cli -a weiyigeek --cluster backup 172.16.243.97:6379 .</span><br><span class="line">  <span class="comment"># [OK] All nodes agree about slots configuration.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class="line">  <span class="comment"># [OK] All 16384 slots covered.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Node 172.16.243.97:6379 -&gt; Saving RDB...</span></span><br><span class="line">  <span class="comment"># SYNC sent to master, writing 178 bytes to './redis-node-172.16.243.97-6379-d97cb5b15b7130ca0bd5322758e0c2dce061fd7b.rdb'</span></span><br><span class="line">  <span class="comment"># Transfer finished with success.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Node 172.16.183.95:6379 -&gt; Saving RDB...</span></span><br><span class="line">  <span class="comment"># SYNC sent to master, writing 178 bytes to './redis-node-172.16.183.95-6379-94b8d3748dc47053454e657da8d6bb90e0081f2c.rdb'</span></span><br><span class="line">  <span class="comment"># Transfer finished with success.</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Node 172.16.24.214:6379 -&gt; Saving RDB...</span></span><br><span class="line">  <span class="comment"># SYNC sent to master, writing 178 bytes to './redis-node-172.16.24.214-6379-2674f21a88a9573f51ec46f9dc248ad4a5c5974d.rdb'</span></span><br><span class="line">  <span class="comment"># Transfer finished with success.</span></span><br><span class="line">  <span class="comment"># Saving cluster configuration to: ./nodes.json</span></span><br><span class="line">  <span class="comment"># [OK] Backup created into: .</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (9) 将外部redis数据导入集群，例如：把 192.168.1.187:6379 上的数据导入到192.168.75.187:6379 这个节点所在的集群</span></span><br><span class="line">redis-cli --cluster import 192.168.75.187:6379 --cluster-from 192.168.1.187:6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># (10) 设置集群的超时时间  </span></span><br><span class="line">redis-cli -a weiyigeek --cluster <span class="built_in">set</span>-timeout 172.16.24.214:6379 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># (11) 在集群全部节点上执行相同命令</span></span><br><span class="line">redis-cli -a weiyigeek --cluster call 172.16.243.97:6379 info keyspace</span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Calling info keyspace</span></span><br><span class="line">  <span class="comment"># 172.16.243.97:6379: # Keyspace</span></span><br><span class="line">  <span class="comment"># db0:keys=264260,expires=0,avg_ttl=0</span></span><br><span class="line">  <span class="comment"># 172.16.100.116:6379: # Keyspace</span></span><br><span class="line">  <span class="comment"># db0:keys=264260,expires=0,avg_ttl=0</span></span><br><span class="line">  <span class="comment"># 172.16.183.95:6379: # Keyspace</span></span><br><span class="line">  <span class="comment"># 172.16.243.98:6379: # Keyspace</span></span><br><span class="line">  <span class="comment"># 172.16.24.215:6379: # Keyspace</span></span><br><span class="line">  <span class="comment"># db0:keys=1,expires=0,avg_ttl=0</span></span><br><span class="line">  <span class="comment"># 172.16.24.214:6379: # Keyspace</span></span><br><span class="line">  <span class="comment"># db0:keys=1,expires=0,avg_ttl=0</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>Tips : 通过<code>--cluster import</code>从其它集群导入数据到当前集群中的流程说明。</p>
<ul>
<li>1、通过load_cluster_info_from_node方法加载集群信息，check_cluster方法检查集群是否健康；</li>
<li>2、连接外部redis节点，如果外部节点开启了cluster_enabled，则提示错误；</li>
<li>3、通过scan命令遍历外部节点，一次获取1000条数据；</li>
<li>4、遍历这些key，计算出key对应的slot；</li>
<li>5、执行migrate命令,源节点是外部节点,目的节点是集群slot对应的节点，如果设置了–copy参数，则传递copy参数，如果设置了–replace，则传递replace参数；</li>
<li>6、不停执行scan命令，直到遍历完全部的key；</li>
<li>7、至此完成整个迁移流程。</li>
</ul>
<p><br/></p>
<h5 id="5-2-交互式命令"><a href="#5-2-交互式命令" class="headerlink" title="5.2 交互式命令"></a>5.2 交互式命令</h5><p>描述: 在我们以<code>-c</code>集群模式连接到集群中的任意一台主机时，可以通过交互魔术执行如下命令。</p>
<p><strong>语法格式:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Help | 获取帮助</span></span><br><span class="line">redis-cli --cluster <span class="built_in">help</span> cluster <span class="built_in">help</span></span><br><span class="line"><span class="comment"># 集群相关操作主命令</span></span><br><span class="line"> 1) CLUSTER &lt;subcommand&gt; [&lt;arg&gt; [value] [opt] ...]. Subcommands are:</span><br><span class="line">  CLUSTER BUMPEPOCH -              <span class="comment"># 进行集群配置 epoch</span></span><br><span class="line">  CLUSTER SET-CONFIG-EPOCH config-epoch <span class="comment"># 在新节点中设置配置EPOCH </span></span><br><span class="line"></span><br><span class="line">  CLUSTER COUNT-FAILURE-REPORTS node-id  <span class="comment"># 返回给定节点的活动故障报告数</span></span><br><span class="line">  CLUSTER GETKEYSINSLOT slot count <span class="comment"># 返回指定哈希槽中的本地密钥名称</span></span><br><span class="line">  CLUSTER COUNTKEYSINSLOT slot           <span class="comment"># 返回指定哈希槽中的本地密钥数</span></span><br><span class="line">  CLUSTER SLOTS - <span class="comment"># 获取群集插槽到节点映射的数组</span></span><br><span class="line">  CLUSTER ADDSLOTS slot [slot ...] <span class="comment"># 将新哈希槽分配给接收节点</span></span><br><span class="line">  CLUSTER SETSLOT slot IMPORTING|MIGRATING|STABLE|NODE [node-id]  <span class="comment"># 将哈希槽绑定到特定节点</span></span><br><span class="line">  CLUSTER DELSLOTS slot [slot ...]       <span class="comment"># 在接收节点中将哈希槽设置为未绑定</span></span><br><span class="line">  CLUSTER FLUSHSLOTS -                   <span class="comment"># 删除节点自己的插槽信息</span></span><br><span class="line"></span><br><span class="line">  CLUSTER KEYSLOT key    <span class="comment"># 返回指定键的哈希槽</span></span><br><span class="line"></span><br><span class="line">  CLUSTER INFO -         <span class="comment"># 提供有关Redis群集节点状态的信息</span></span><br><span class="line">  CLUSTER MYID -         <span class="comment"># 返回节点id</span></span><br><span class="line">  CLUSTER NODES -        <span class="comment"># 获取节点的群集配置</span></span><br><span class="line"></span><br><span class="line">  CLUSTER FAILOVER [FORCE|TAKEOVER]      <span class="comment"># 强制复制副本对其主副本执行手动故障切换。</span></span><br><span class="line">  CLUSTER FORGET node-id <span class="comment"># 从节点表中删除节点</span></span><br><span class="line">  CLUSTER MEET ip port   <span class="comment"># 强制节点群集与另一个节点握手</span></span><br><span class="line">  CLUSTER RESET [HARD|SOFT] <span class="comment"># 重置Redis群集节点</span></span><br><span class="line"></span><br><span class="line">  CLUSTER SLAVES node-id  <span class="comment"># 列出指定主节点的副本节点</span></span><br><span class="line">  CLUSTER REPLICAS node-id  <span class="comment"># 列出指定主节点的副本节点 (在5.x版本以上使用)</span></span><br><span class="line">  CLUSTER REPLICATE node-id <span class="comment"># 将节点重新配置为指定主节点的副本</span></span><br><span class="line">  CLUSTER SAVECONFIG -      <span class="comment"># 强制节点在磁盘上保存群集状态</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>使用实践:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h 172.16.243.97 -a weiyigeek -c</span><br><span class="line"><span class="comment"># //集群(cluster)</span></span><br><span class="line">CLUSTER INFO  <span class="comment">#打印集群的信息</span></span><br><span class="line">  <span class="comment"># cluster_state:ok</span></span><br><span class="line">  <span class="comment"># cluster_slots_assigned:16384</span></span><br><span class="line">  <span class="comment"># cluster_slots_ok:16384</span></span><br><span class="line">  <span class="comment"># cluster_slots_pfail:0</span></span><br><span class="line">  <span class="comment"># cluster_slots_fail:0</span></span><br><span class="line">  <span class="comment"># cluster_known_nodes:6</span></span><br><span class="line">  <span class="comment"># cluster_size:3</span></span><br><span class="line">  <span class="comment"># cluster_current_epoch:13</span></span><br><span class="line">  <span class="comment"># cluster_my_epoch:11</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_ping_sent:196626</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_pong_sent:244353</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_meet_sent:7</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_update_sent:179</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_sent:441165</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_ping_received:193415</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_pong_received:210335</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_meet_received:8</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_update_received:138</span></span><br><span class="line">  <span class="comment"># cluster_stats_messages_received:403896</span></span><br><span class="line"></span><br><span class="line">CLUSTER NODES <span class="comment">#列出集群当前已知的所有节点（node），以及这些节点的相关信息。</span></span><br><span class="line">  <span class="comment"># 436c6a1d7e4c5f782e1e0620b831211ebb0a41a4 172.16.100.116:6379@16379 slave d97cb5b15b7130ca0bd5322758e0c2dce061fd7b 0 1631280922704 11 connected</span></span><br><span class="line">  <span class="comment"># 94b8d3748dc47053454e657da8d6bb90e0081f2c 172.16.183.95:6379@16379 master - 0 1631280921700 12 connected 5462-10922</span></span><br><span class="line">  <span class="comment"># 6af3ad6a8691b57393aeb6b4cc5334382aa5b392 172.16.243.98:6379@16379 slave 94b8d3748dc47053454e657da8d6bb90e0081f2c 0 1631280923706 12 connected</span></span><br><span class="line">  <span class="comment"># d69c99fd6605d747da03874aafaa283a2b5614ea 172.16.24.215:6379@16379 slave 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 0 1631280920697 13 connected</span></span><br><span class="line">  <span class="comment"># d97cb5b15b7130ca0bd5322758e0c2dce061fd7b 172.16.243.97:6379@16379 myself,master - 0 1631280922000 11 connected 50-5461</span></span><br><span class="line">  <span class="comment"># 2674f21a88a9573f51ec46f9dc248ad4a5c5974d 172.16.24.214:6379@16379 master - 0 1631280922000 13 connected 0-49 10923-16383</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CLUSTER SLOTS <span class="comment">#用于当前的集群状态，以数组形式展,返回值 IP/端口嵌套的列表数组</span></span><br><span class="line">  <span class="comment"># 1) 1) (integer) 0</span></span><br><span class="line">  <span class="comment">#   2) (integer) 49</span></span><br><span class="line">  <span class="comment">#   3) 1) "172.16.24.214"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "2674f21a88a9573f51ec46f9dc248ad4a5c5974d"</span></span><br><span class="line">  <span class="comment">#   4) 1) "172.16.24.215"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "d69c99fd6605d747da03874aafaa283a2b5614ea"</span></span><br><span class="line">  <span class="comment"># 2) 1) (integer) 50</span></span><br><span class="line">  <span class="comment">#   2) (integer) 5461</span></span><br><span class="line">  <span class="comment">#   3) 1) "172.16.243.97"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "d97cb5b15b7130ca0bd5322758e0c2dce061fd7b"</span></span><br><span class="line">  <span class="comment">#   4) 1) "172.16.100.116"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "436c6a1d7e4c5f782e1e0620b831211ebb0a41a4"</span></span><br><span class="line">  <span class="comment"># 3) 1) (integer) 5462</span></span><br><span class="line">  <span class="comment">#   2) (integer) 10922</span></span><br><span class="line">  <span class="comment">#   3) 1) "172.16.183.95"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "94b8d3748dc47053454e657da8d6bb90e0081f2c"</span></span><br><span class="line">  <span class="comment">#   4) 1) "172.16.243.98"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "6af3ad6a8691b57393aeb6b4cc5334382aa5b392"</span></span><br><span class="line">  <span class="comment"># 4) 1) (integer) 10923</span></span><br><span class="line">  <span class="comment">#   2) (integer) 16383</span></span><br><span class="line">  <span class="comment">#   3) 1) "172.16.24.214"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "2674f21a88a9573f51ec46f9dc248ad4a5c5974d"</span></span><br><span class="line">  <span class="comment">#   4) 1) "172.16.24.215"</span></span><br><span class="line">  <span class="comment">#       2) (integer) 6379</span></span><br><span class="line">  <span class="comment">#       3) "d69c99fd6605d747da03874aafaa283a2b5614ea"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># //节点(node)</span></span><br><span class="line">CLUSTER MEET 172.16.24.215 6379    <span class="comment"># 将 ip 和 port 所指定的节点添加到集群当中，让它成为集群的一份子。</span></span><br><span class="line">CLUSTER FORGET &lt;node_id&gt;           <span class="comment"># 从 集群中移除指定的 node_id 节点。</span></span><br><span class="line">CLUSTER REPLICATE &lt;node_id&gt;        <span class="comment"># 将当前节点设置为指定的 node_id 节点的从节点。</span></span><br><span class="line">CLUSTER SAVECONFIG                  <span class="comment"># 将节点的配置文件保存到硬盘里面。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># //槽(slot)</span></span><br><span class="line">CLUSTER ADDSLOTS &lt;slot&gt; [slot ...] <span class="comment"># 将一个或多个槽（slot）指派（assign）给当前节点。</span></span><br><span class="line">CLUSTER DELSLOTS &lt;slot&gt; [slot ...] <span class="comment"># 移除一个或多个槽对当前节点的指派。</span></span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; NODE &lt;node_id&gt; <span class="comment"># 将槽 slot 指派给 node_id 指定的节点，如果槽已经指派给另一个节点，那么先让另一个节点删除该槽&gt;，然后再进行指派。</span></span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;node_id&gt; <span class="comment"># 将本节点的槽 slot 迁移到 node_id 指定的节点中。</span></span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;node_id&gt;<span class="comment">#  从 node_id 指定的节点中导入槽 slot 到本节点。</span></span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; STABLE <span class="comment"># 取消对槽 slot 的导入（import）或者迁移（migrate）。</span></span><br><span class="line">CLUSTER FLUSHSLOTS <span class="comment"># 移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点, 前提是该节点上无任何数据。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># //键 (key)</span></span><br><span class="line">CLUSTER KEYSLOT &lt;key&gt; 计算键 key 应该被放置在哪个槽上。</span><br><span class="line">  <span class="comment"># 172.16.243.97:6379&gt; CLUSTER KEYSLOT weiyigeek66666</span></span><br><span class="line">  <span class="comment"># (integer) 11697</span></span><br><span class="line"></span><br><span class="line">CLUSTER COUNTKEYSINSLOT &lt;slot&gt; 返回槽 slot 目前包含的键值对数量。</span><br><span class="line">  <span class="comment"># 172.16.243.97:6379&gt; CLUSTER COUNTKEYSINSLOT 2604</span></span><br><span class="line">  <span class="comment"># (integer) 61</span></span><br><span class="line"></span><br><span class="line">CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; 返回 count 个 slot 槽中的键。</span><br><span class="line">  <span class="comment"># 172.16.243.97:6379&gt; CLUSTER GETKEYSINSLOT 2604 8</span></span><br><span class="line">  <span class="comment"># 1) "weiyigeek108466"</span></span><br><span class="line">  <span class="comment"># 2) "weiyigeek119427"</span></span><br><span class="line">  <span class="comment"># 3) "weiyigeek12581"</span></span><br><span class="line">  <span class="comment"># 4) "weiyigeek201670"</span></span><br><span class="line">  <span class="comment"># 5) "weiyigeek204102"</span></span><br><span class="line">  <span class="comment"># 6) "weiyigeek210631"</span></span><br><span class="line">  <span class="comment"># 7) "weiyigeek215143"</span></span><br><span class="line">  <span class="comment"># 8) "weiyigeek21542"</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>常用命令示例:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0.集群创建</span></span><br><span class="line">redis-cli -h 127.0.0.1 -a weiyigeek --cluster create --cluster-replicas 1 172.16.182.219:6379 172.16.183.72:6379 172.16.24.202:6379 172.16.100.65:6379 172.16.135.193:6379 172.16.243.65:6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.向集群中添加主节点(127.0.0.1:7000 将成为主节点)</span></span><br><span class="line">redis-cli -a weiyigeek --cluster add-node 192.168.1.100:7000 192.168.1.99:7000 </span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Adding node 192.168.1.100:7000 to cluster 192.168.1.99:7000</span></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.99:7000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.向集群中添加指定从节点(192.168.1.99:7001 将成为1.99:7000(MYID=a7b511330bffe28357cd21d6ee543e59f0a38dea) 从节点)</span></span><br><span class="line">redis-cli -a weiyigeek --cluster add-node --cluster-slave --cluster-master-id a7b511330bffe28357cd21d6ee543e59f0a38dea  192.168.1.100:7000 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.集群信息与节点查看</span></span><br><span class="line">redis-cli -a weiyigeek --cluster check 192.168.1.100:7000 </span><br><span class="line">redis-cli -h 192.168.1.100 -p 7000 -a weiyigeek -c cluster info</span><br><span class="line">redis-cli -h 192.168.1.100 -p 7000 -a weiyigeek -c cluster nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.删除节点</span></span><br><span class="line">redis-cli --cluster del-node 127.0.0.1:7000 f467098bffa3761868842556eb4cfff7cc8bc363 -a 123456   <span class="comment">#该节点将会被shutdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.平衡各节点槽数量</span></span><br><span class="line">redis-cli --cluster rebalance -a 123456 --cluster-threshold 1 127.0.0.1:8007  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.把7000节点的10个slots移到7001节点上，键入命令如下，</span></span><br><span class="line">redis-cli -–cluster reshard 127.0.0.1:7000 -–cluster-from a7b511330bffe28357cd21d6ee543e59f0a38dea -–cluster-to a7ab1aa24c9030d1fb42bbac3ad72c15bf683ef4 –-cluster-slots 10 –cluster-yes</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h4 id="6-集群补充"><a href="#6-集群补充" class="headerlink" title="6.集群补充"></a>6.集群补充</h4><p><strong>(1) Redis集群和哨兵的区别</strong><br>1、哨兵只提供一个主节点，同步时也是全量同步。集群的数据是分片放的，分片意味着数据是不重叠的。<br>2、哨兵架构可以写主读从，但是集群架构读写都走主节点。<br>3、哨兵架构收到单机数据量制约【一般不超过10个G】，集群架构可以很方便的进行水平扩展【当然操作起来还需要分配slots槽等等是有些麻烦】。<br>4、哨兵架构中的哨兵角色只是起到监控的作用，但不对外提供服务，相当于占用了资源。集群的话每一台主机都是主/或从，就不会有哨兵角色的这种主机资源“浪费”。</p>
<p><br></p>
<p><strong>(2) Redis集群脑裂产生的问题</strong><br>描述: 一个小集群内部主从因网络问题无法进行同步数据导致了重新选举(<code>此时主节点是存活的，只是网络问题导致无法同步</code>)而后网络恢复导致该小集群出现2个主节点对外提供服务。</p>
<p>规避方式: 在redis.conf配置文件下更改<code>min‐replicas‐to‐write 1</code>参数配置，该配置意思是主节点写数据完成后，最少需要同步的slave数量。</p>
<p>举例说明: 比如1主2从的机制，原来的主节点因为网络波动被判定为挂了，此时新的从节点想上位，那么它必须要能给另外1个从节点进行redis写的同步，它才能成为主节点。此时对于这个从节点除了自己以外他还有一个从节点对其进行数据同步，那么1+1&gt;2/3符合半数选举机制。</p>
<p>Tips: 非常注意该配置在一定程度上会影响集群的可用性，比如slave要是少于1个，那么没有从节点写入数据，就满足不了这个配置，那就不能对外提供服务了。</p>
<p><br></p>
<p><strong>(3) Redis集群为什么至少需要三个master节点，并且推荐节点数为奇数？</strong></p>
<p>描述: 因为新master的选举需要大于半数的集群master节点同意才能选举成功，如果只有两个master节点，当其中 一个挂了，是达不到选举新master的条件的。</p>
<p>示例: 3个master，挂了1个，则挂了的master其对应的slave若是获得了另外两个master的支持【2&gt;3/2】，则它就可以成为master。</p>
<p>反例: 2个master，挂了1个，那么就算另外一个master选出一个slave作为新的master，此时票数也不够【1=2/2】，达不到半数效果。</p>
<p>反例: 4个master，如果挂了1个，选举方式和3个master的方式类似，可以达到半数选举的效果。但如果挂了2个，场景和上面的类似，也一样无法选出新的master。</p>
<p>总结: 为什么至少需要3个master节点,因为主从切换需要满足半数选举机制。<br>总结: 为什么推荐节点数为奇数，因为需要从节省机器资源角度出发考虑的。</p>
<p><br></p>
<p><strong>(4) 集群是否完整才能对外提供服务？</strong><br>描述: 不一定 redis.conf 可以配置<code>cluster-require-full-coverage no</code>参数,表示当负责一个插槽的主库下线且没有相应的从库进行故障恢复时，集群仍然可用，如果为yes则集群不可用。</p>
<p><br></p>
<p><strong>(5) 为啥redis.cond文件内部要写集群信息？</strong><br>描述: 因为当关闭所有机器的时候，再次重启可以通过配置文件来恢复集群信息。<br>PS：集群重启不要用创建集群的命令，直接启动单台机器即可</p>
<p><br></p>
<p><strong>(6) 集群内部主从为啥不放在一台机器上？</strong><br>描述: 为了更安全，如果放在一台机器上，一个小集群挂了就整个集群全部挂掉。</p>

        </div>
        
  <hr>
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>

  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注，转个发】(人间五大情)</b>，这将对我的肯定，谢谢！。</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="扫描Visit(浏览)极客全栈修炼小程序"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-03-29T05:39:06.311Z" itemprop="dateUpdated">2022-03-29 13:39:06</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/数据存储/Redis/4.Redis基础运维之哨兵和集群安装配置.md" target="_blank" rel="noopener noreferrer">_posts/数据存储/Redis/4.Redis基础运维之哨兵和集群安装配置.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2019/4-17-576.html" target="_blank" rel="external">https://blog.weiyigeek.top/2019/4-17-576.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">👍 钟意作者</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/4-17-576.html&title=《4.Redis基础运维之哨兵和集群安装配置》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/4-17-576.html&title=《4.Redis基础运维之哨兵和集群安装配置》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/4-17-576.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《4.Redis基础运维之哨兵和集群安装配置》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/4-17-576.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/4-17-576.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2019/4-17-524.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">5.Redis基础运维之在K8S中的安装与配置</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/4-17-97.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">3.Redis基础运维之原理介绍和主从配置</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-Redis-运行模式"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x01 Redis 运行模式</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Redis-哨兵模式"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Redis 哨兵模式</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Sentinel-介绍"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">Sentinel 介绍</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Sentinel-高可用性"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">Sentinel 高可用性</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Sentinel-配置步骤"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">Sentinel 配置步骤</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Sentinel-配置文件"><span class="post-toc-number">1.1.4.</span> <span class="post-toc-text">Sentinel 配置文件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Sentinel-常用命令"><span class="post-toc-number">1.1.5.</span> <span class="post-toc-text">Sentinel 常用命令</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Redis-Cluster-模式"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Redis Cluster 模式</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-基础介绍"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">1.基础介绍</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-集群架构"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">2.集群架构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-原理分析"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">3.原理分析</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-集群搭建"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">4.集群搭建</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-集群命令"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">5.集群命令</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#6-集群补充"><span class="post-toc-number">1.2.6.</span> <span class="post-toc-text">6.集群补充</span></a></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，还请支持一下博主哟, 谢谢各位看友♥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- 微信公众号关注/文章版权复制 -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">个人Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">个人Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">个人知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云+云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/4-17-576.html&title=《4.Redis基础运维之哨兵和集群安装配置》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/4-17-576.html&title=《4.Redis基础运维之哨兵和集群安装配置》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/4-17-576.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《4.Redis基础运维之哨兵和集群安装配置》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/4-17-576.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/4-17-576.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLklEQVR42u3awW7DIBBFUf//T9NtpMjufTO4FXBZVU5ifLyYwjyuC4/xMT6vPH/6ff37ns+zTB4yZMhYljEeR+07BH9HSueVIUPGOYzarZ8LJZm+z5YhQ4aM9Dv9EixDhgwZswoun5IU5X/7vyFDhoylGGSD+txKQ1vNsD33yl5chgwZCzJ41/3v/34l35AhQ8ZSjBGOtPjyYHI0hgwZMvZm8ALXiS35hrb2PDJkyNibQRr0fHuZHvAiDTh0RYYMGUcySJuMPyhp+qdhJyq4MmTI2I7BpyelcFZgiaIFGTJkHMDobCbTKdMXhw6NyZAhY2tG2lDrRAh8wccD1GJfUIYMGQsyeAzZP66RFvfgVzJkyNiU0QF0yisPElB0KkOGjAMYtceqbXHTRWR8WkSGDBlbM2pHLvjjdkIItP+WIUPGpoy0sVVr1teKeBp/ypAhY1dGGgPw8he8OdxcC34mQ4aMjRidMpoGnzzC5IctZMiQcSajVl471DQeuJ1LhgwZBzA6U3YWl/wO6MyIDBkytmakhyo6LTbe5gtiThkyZBzAIFOmm09eZGvp5FV7czJkyFiKMcKRHq2Y9VJ+ed0yZMjYmtHPB9NogYcNnCpDhowTGLMOWJBlHA8p05ItQ4aMExj9LWsaTKIdNi/9MmTIkBEu+9KCm+JlyJAhI91A8pCy/zpu8TJkyDiAQRZ85ODF3PL6SrtNhgwZCzI6JzXIcpA32viCstgElCFDxnqMH0M5IuBz58qcAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
