<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 1.Containerd容器运行时初识与尝试|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Containerd">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>1.Containerd容器运行时初识与尝试</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">1.Containerd容器运行时初识与尝试</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-06-27T06:36:30.000Z" itemprop="datePublished" class="page-time">
  2021-06-27
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-虚拟云容/云容器/Containerd/1.基于Containerd容器运行时初识与尝试"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">1.Containerd容器运行时初识与尝试</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-06-27 14:36:30" datetime="2021-06-27T06:36:30.000Z"  itemprop="datePublished">2021-06-27</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<hr>
<h2 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h2><p>描述: 目前Docker是Kubernetes默认的容器运行时（Container Runtime）, 由于k8s在2020年宣布1.20版本之后将弃用 dockershim (其中也有kubernetes与Docker爱恨情仇)时，才把containerd拉回大众的视野之中，所以本章主要讲解containerd基础入门。</p>
<h3 id="1-基础介绍"><a href="#1-基础介绍" class="headerlink" title="1.基础介绍"></a>1.基础介绍</h3><p><strong>Q: 什么是Containerd?</strong></p>
<blockquote>
<p>答: Containerd是从Docker中分类出的容器运行时与runc一样被分解为Docke的高级运行时部分,它支持 OCI 的镜像标准、可以实现拉取和推送镜像、管理操作镜像负责容器的整个生命周期。<br>例如当它需要运行一个容器时,它会将映像解压到一个OCI运行时包中,并将其发送给runc来运行它，Containerd还提供了一个API和客户端应用程序可以用来与之交互，containerd命令行客户端是ctr命令。<br>官方介绍: An industry-standard container runtime with an emphasis on simplicity, robustness and portability - 业界标准的容器运行时，强调简单性、健壮性和可移植性。</p>
</blockquote>
<p><strong>Q: Containerd 有何特点?</strong></p>
<ul>
<li>OCI Image Spec support - OCI图像规范支持</li>
<li>OCI Runtime Spec support - OCI运行时规范支持</li>
<li>Image push and pull support - 图像推拉支持</li>
<li>Container runtime and lifecycle support - 容器运行时和生命周期支持</li>
<li>Network primitives for creation, modification, and deletion of interfaces - 用于创建、修改和删除接口的网络原语</li>
<li>Management of network namespaces containers to join existing namespaces - 管理连接现有名称空间的网络名称空间容器</li>
<li>Multi-tenant supported with CAS storage for global images - CAS存储支持用于全局映像的多租户</li>
</ul>
<p><br></p>
<p><strong>发展历史</strong>: （ Containerd 和 Docker 的前世今生以及爱恨情仇）<br>在几年之前 Docker 公司在容器技术领域强势崛起一家独大，Google、RedHat 这样的巨头们都产生了很大的危机感，因此他们想与 Docker 公司一起联合研发推进一个开源的容器运行时作为 Docker 技术的核心依赖。然鹅 Docker 公司很高冷的表示：我不干！巨头们听到这个反馈就很不爽啊，因此通过一些手段对 Docker 公司软硬兼施，使其将 libcontainer 捐给了开源社区，也就是现在的 runc，一个 low level 的容器运行时。此外巨头们又成立了 CNCF 去对抗 Docker 公司的一家独大，CNCF 成立的思路很明确：在容器领域干不过 Docker，那就搞容器上层的建设——容器编排，从此 K8s 诞生了。虽然 Docker 公司也尝试使用 Swarm 去对抗 K8s但最终也失败了。</p>
<p><br></p>
<p>自此K8s慢慢成为云原生领域的标配，其生态也越做越大、越做越完善。Docker 公司为了融入生态，开源了 Docker 的核心依赖 containerd 。2019年2月28日containerd正式成为云原生计算基金会(Cloud Native Computing Foundation -CNCF)的一个毕业项目,紧随<code>Kubernetes、Prometheus、Envoy和CoreDNS</code>之后,在从containerd1.5开始，Kubernetes容器运行时接口（CRI）的containerd插件已经合并到containerd中。。</p>
<p><br></p>
<p>此外 K8s 为了对接下一层的容器，也因为其中立性搞了一个运行时接口，也就是 <code>CRI(Container Runtime Interface)</code>，runc、containerd 等运行时都去支持此接口。由于当时确实没有啥 high level 的 runtime，oci-o 虽然支持 CRI 接口，但其功能太弱；containerd 也尚未成熟，而且其当时的定位是嵌入到系统中，并非给终端用户使用；rkt 有自己的一套体系后来这个项目也失败了。只能暂时为了适配 Docker 搞了个 shim，将 CRI 转换为 Docker API。K8s 和 Docker 进入了冷静期，双方都在各自优化自己，互不干扰。然而平静之下仍是暗潮汹涌，CNCF 社区一直在不断完善 containerd，其定位也发生了改变，由原来的系统嵌入组件，变成了今天的<code>&quot;工业标准容器运行时&quot;</code>，并提供给终端用户使用。直到2020年12月 K8s 宣布废弃使用 Docker，而改用 Containerd。</p>
<p>总结: 其实kubernetes宣布废弃dockershim,一方面是因为商业因素,而另一方面 K8s 已经提供了标准接口对接底层容器运行时，不再想单独维护一个类似于<code>Dockershim</code>的适配层去迎合不同的运行时。</p>
<p><strong>Q: 那什么是dockershim?</strong><br>描述: dockershim 是 Kubernetes 的一个组件，其作用是为了操作Docker。Docker是在2013年面世的而Kubernetes是在2016年，所以Docker刚开始并没有想到编排，也不会知道会出现Kubernetes这个庞然大物（它要是知道，也不会败的那么快）。但是Kubernetes在创建的时候就是以Docker作为容器运行时，很多操作逻辑都是针对的Docker，随着社区越来越健壮，为了兼容更多的容器运行时，才将Docker的相关逻辑独立出来组成了dockershim。</p>
<p>正因为这样，只要Kubernetes的任何变动或者Docker的任何变动，都必须维护dockershim，这样才能保证足够的支持，但是通过dockershim操作Docker，其本质还是操作Docker的底层运行时Containerd，而且Containerd自身也是支持CRI（Container Runtime Interface）交互，所以正如前面所说只是kubernetes不想单独维护一个类似于<code>Dockershim</code>的适配层去迎合不同的运行时。</p>
<p><br/></p>
<p><strong>相关参考</strong><br>Containerd 官网: <a href="https://containerd.io/" target="_blank" rel="noopener">https://containerd.io/</a><br>Containerd 帮助文档: <a href="https://containerd.io/docs/" target="_blank" rel="noopener">https://containerd.io/docs/</a><br>CNI 网络项目: <a href="https://github.com/containernetworking" target="_blank" rel="noopener">https://github.com/containernetworking</a></p>
<p><em>Tips: 在github存储库中的 containerd 基本项目级信息:</em></p>
<ul>
<li>containerd/containerd ：containerd的主要项目repo，包括container运行时以及从containerd 1.5开始，用于<a href="https://kubernetes.io/docs/setup/cri" target="_blank" rel="noopener">Kubernetes容器运行时接口(CRI)</a>已并入containerd。</li>
<li>containerd/containerd.io : 用于构建containerd网站和文档的资产（即您当前正在阅读的内容）</li>
<li>containerd/project : 跨containerd存储库使用的实用程序，如脚本、公共文件和核心文档</li>
<li>containerd/ttrpc : containerd使用的gRPC版本（为低内存环境设计）</li>
</ul>
<p><br></p>
<h3 id="2-专业术语"><a href="#2-专业术语" class="headerlink" title="2.专业术语"></a>2.专业术语</h3><p>描述: 在介绍容器运行时相关概念及组件原理，梳理下我们常听到的 OCI、runc、containerd 等名词之间的关系。</p>
<p><strong>OCI</strong><br>Docker 公司与 CoreOS 和 Google 共同创建了 <code>OCI (Open Container Initial)</code> 并提供了两种规范：</p>
<ul>
<li>1) 镜像规范 (<a href="https://github.com/opencontainers/image-spec" target="_blank" rel="noopener">https://github.com/opencontainers/image-spec</a>) 镜像规范定义了OCI镜像的标准，high level 运行时将会下载一个OCI 镜像，并把它解压成OCI 运行时文件系统包（filesystem bundle），例如 制定镜像格式、操作等</li>
<li>2) 运行时规范 (<a href="https://github.com/opencontainers/runtime-spec)" target="_blank" rel="noopener">https://github.com/opencontainers/runtime-spec)</a>: 描述了如何从OCI 运行时文件系统包运行容器程序，并且定义它的配置、运行环境和生命周期，如何为新容器设置命名空间（namepsaces）和控制组（cgroups），以及挂载根文件系统等等操作，都是在这里定义的。它的一个参考实现是runC(<code>低层级运行时- Low-level Runtime</code>)除它以外也有很多其他的运行时遵循OCI标准,例如kata-runtime。</li>
</ul>
<p>Tips: <code>文件系统束(filesystem bundle)</code>: 定义了一种将容器编码为文件系统束的格式，即以某种方式组织的一组文件，并包含所有符合要求的运行时对其执行所有标准操作的必要数据和元数据，即 config.json 与 根文件系统。</p>
<p>Tips: <code>CRI(Container Runtime Interface,容器运行时接口)</code> : 它是为了解决这些容器运行时和Kubernetes的集成问题在Kubernetes 1.5版本中推出。</p>
<p><br></p>
<p>Docker、Google 等开源了用于运行容器的工具和库 runC 作为 OCI 的一种实现参考, 随后各种运行时和库也慢慢出现例如 <code>rkt、containerd(今天的主角)、cri-o</code>，然而这些工具所拥有的功能却不尽相同，有的只有运行容器(runc、lxc)，而有的除此之外也可以对镜像进行管理(containerd、cri-o), 按照前面容器运行时进行分为两类, 其不同容器运行时工具分类关系图如下。</p>
<p><strong>Runtime</strong></p>
<ul>
<li><p>1) 容器运行时(Container Runtime): 运行于Docker或者Kubernetes集群的每个节点中, 负责容器的整个生命周期，包括构建、创建、运行、管理、删除等对容器的操作。其中Docker是目前应用最广的，随着容器云的发展，越来越多的容器运行时涌现。</p>
</li>
<li><p>2) 容器运行时分成了 <code>low-level</code> 和 <code>high-level</code> 两类。</p>
<ul>
<li>(1) low-level : 指的是仅关注运行容器的容器运行时，调用操作系统，使用 namespace 和 cgroup 实现资源隔离和限制</li>
<li>(2) high-level :指包含了更多上层功能，例如 grpc调用，镜像存储管理等。</li>
</ul>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629142203.png" target="_blank" title="WeiyiGeek.不同运行时工具间关系" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629142203.png" alt="WeiyiGeek.不同运行时工具间关系" title="" class=""></a>
                <p>WeiyiGeek.不同运行时工具间关系</p>
            </figure>
<p><br></p>
<blockquote>
<p>(1) <code>low-level runtime</code> : 主要关注如何与操作系统资源交互和创建并运行容器。目前常见的 low-level runtime有：</p>
<ul>
<li>lmctfy – Google的一个项目它是Borg使用的容器运行时。</li>
<li>runc – 目前使用最广泛的容器运行时。它最初是作为Docker的一部分开发的，后来被提取出来作为一个单独的工具和库, 其实现了 OCI 规范包含config.json文件和容器的根文件系统。</li>
<li>rkt – CoreOS开发的Docker/runc的一个流行替代方案，提供了其他 low-level runtimes (如runc)所提供的所有特性。</li>
</ul>
</blockquote>
<blockquote>
<p>(2) <code>high-level runtime</code> : 主要负责传输和管理容器镜像，解压镜像，并传递给low-level runtimes来运行容器。目前主流的 high-level runtime 有：</p>
<ul>
<li>docker – 老熟人完整的集装箱(Container)解决方案</li>
<li>containerd – 本章主角</li>
<li>rkt – 与Docker类似的容器引擎更加专注于解决安全、兼容、执行效率等方面的问题。</li>
</ul>
</blockquote>
<p><br/></p>
<p><strong>CRI</strong><br>描述: CRI是Kubernetes定义的一组gRPC服务。Kubelet作为客户端，基于gRPC框架，通过Socket和容器运行时通信。它包括两类服务：镜像服务（Image Service）和运行时服务（Runtime Service）。镜像服务提供下载、检查和删除镜像的远程程序调用。运行时服务包含用于管理容器生命周期，以及与容器交互的调用 <code>( exec / attach / port-forward )</code> 的远程程序调用。</p>
<p><br/></p>
<p><strong>CRI接口客户端工具</strong></p>
<ul>
<li><p><code>ctr</code>: 是containerd本身的 CLI (<a href="https://github.com/containerd/containerd/tree/master/cmd/ctr" target="_blank" rel="noopener">https://github.com/containerd/containerd/tree/master/cmd/ctr</a>)</p>
</li>
<li><p><code>crictl</code>: 是Kubernetes社区定义的专门 CLI 工具 (<a href="https://github.com/kubernetes-sigs/cri-tools" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/cri-tools</a>)</p>
</li>
</ul>
<p><br></p>
<h3 id="3-架构简述"><a href="#3-架构简述" class="headerlink" title="3.架构简述"></a>3.架构简述</h3><h4 id="CRI-的架构"><a href="#CRI-的架构" class="headerlink" title="CRI 的架构"></a>CRI 的架构</h4><p>描述: CRI 插件是 Kubernetes 容器运行时接口 （CRI） 的实现, Containerd 与 Kubelet 在同一节点上运行。</p>
<p>containerd 中的插件处理来自 Kubelet 的所有 CRI 服务请求，并使用容器内部来管理容器和容器映像,该插件使用 containerd 来管理整个容器生命周期和所有容器映像,并通过CNI（另一个CNCF项目）管理pod网络，如下图所示</p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://gitee.com/WeiyiGeek/blogimage/raw/master/2022/2/20220424131920.png" target="_blank" title="WeiyiGeek.CRI 插件" data-fancybox="images"><img src="https://gitee.com/WeiyiGeek/blogimage/raw/master/2022/2/20220424131920.png" alt="WeiyiGeek.CRI 插件" title="" class=""></a>
                <p>WeiyiGeek.CRI 插件</p>
            </figure>
<p>让我们用一个例子来演示当 Kubelet 创建一个单容器 pod 时，插件是如何工作的</p>
<ul>
<li>Kubelet 通过 CRI 运行时服务 API 调用插件来创建 pod;</li>
<li>cri 创建 Pod 的网络命名空间，然后使用 CNI 对其进行配置;</li>
<li>cri 使用 containerd internal 创建和启动一个特殊的暂停容器（沙盒容器），并将该容器放在 pod 的 cgroup 和命名空间中（为简洁起见省略了步骤）;</li>
<li>Kubelet随后通过CRI镜像服务API调用插件，拉取应用容器镜像;</li>
<li>cri 进一步使用容器来拉取图像，如果图像不存在于节点上;</li>
<li>然后 Kubelet 通过 CRI 运行时服务 API 调用，使用拉取的容器映像在 pod 内创建和启动应用程序容器;cri</li>
<li>cri 最后使用 containerd internal 创建应用程序容器，将其放在 pod 的 cgroup 和命名空间中，然后启动 pod 的新应用程序容器。完成这些步骤后，将创建并运行 Pod 及其相应的应用程序容器。</li>
</ul>
<p><br/></p>
<h4 id="Containerd-的架构"><a href="#Containerd-的架构" class="headerlink" title="Containerd 的架构"></a>Containerd 的架构</h4><p>描述: containerd是Linux和Windows的守护程序。它管理其主机系统的完整容器生命周期，从图像传输和存储到容器执行和监督，再到低级存储到网络附件等等。</p>
<p>Containerd 的设计是一个大的插件系统，下图中每一个虚线框其实就对应一个插件。</p>
<ul>
<li>1) 底层系统支持 Linux 、Windows操作系统 和 支持 arm 和 x86 架构</li>
<li>2) 中间 containerd 包含 Backend、core、API 三层<ul>
<li>Backend 层: Runtime plugin 提供了容器运行时的具体操作，为了支持不同的容器运行时 containerd 也提供了一系列的 containerd-shim</li>
<li>Core 层: 则是核心部分，提供了各种功能的服务，其中比较常用的是 Content service ，提供对镜像中可寻址内容的访问，所有不可变的内容都被存储在这里；Images Service 提供镜像相关的操作；Snapshot Plugin : 用来管理容器镜像的文件系统快照。镜像中的每一个 layer 都会被解压成文件系统快照，类似于 Docker 中的 graphdriver</li>
<li>API 层: 通过 GRPC 与客户端连接，例如提供了给 Prometheus 使用 API 来进行监控，给kubernetes提供了CRI接口，给containerd提供了服务处理程序。</li>
</ul>
</li>
<li>3) 高层提供各种客户端，包括 K8s 的 kubelet，containerd 自己的命令行 ctr 等。</li>
</ul>
<p>先来看看 Containerd 的架构：<br><figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629164835.png" target="_blank" title="WeiyiGeek.containerd架构体系" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629164835.png" alt="WeiyiGeek.containerd架构体系" title="" class=""></a>
                <p>WeiyiGeek.containerd架构体系</p>
            </figure></p>
<p><br></p>
<p>可以看到 Containerd 仍然采用标准的 C/S 架构，服务端通过 GRPC 协议提供稳定的 API，客户端通过调用服务端的 API 进行高级的操作。</p>
<p>为了解耦，Containerd 将不同的职责划分给不同的组件，每个组件就相当于一个子系统（subsystem）。连接不同子系统的组件被称为模块。</p>
<p>总体上 Containerd 被划分为两个子系统：</p>
<ul>
<li>Bundle : 在 Containerd 中，Bundle 包含了配置、元数据和根文件系统数据，你可以理解为容器的文件系统。而 Bundle 子系统允许用户从镜像中提取和打包 Bundles。</li>
<li>Runtime : Runtime 子系统用来执行 Bundles，比如创建容器。</li>
</ul>
<p>其中，每一个子系统的行为都由一个或多个模块协作完成（架构图中的 Core 部分）。每一种类型的模块都以插件的形式集成到 Containerd 中，而且插件之间是相互依赖的。例如，上图中的每一个长虚线的方框都表示一种类型的插件，包括 <code>Service Plugin、Metadata Plugin、GC Plugin、Runtime Plugin</code> 等，其中<code>Service Plugin 又会依赖 Metadata Plugin、GC Plugin 和 Runtime Plugin</code>。每一个小方框都表示一个细分的插件，例如 Metadata Plugin 依赖 Containers Plugin、Content Plugin 等。 总之，万物皆插件，插件就是模块，模块就是插件。</p>
<p><a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220314153536.png" target="_blank" title="WeiyiGeek.插件调用链图" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220314153536.png" alt="WeiyiGeek.插件调用链图"></a></p>
<p>介绍几个常用的插件：</p>
<ul>
<li>Content Plugin : 提供对镜像中可寻址内容的访问，所有不可变的内容都被存储在这里。</li>
<li>Snapshot Plugin : 用来管理容器镜像的文件系统快照。镜像中的每一个 layer 都会被解压成文件系统快照，类似于 Docker 中的 graphdriver。</li>
<li>Metrics : 暴露各个组件的监控指标。</li>
</ul>
<p><br></p>
<p>我们可以将上面的架构图简化如下, 简化后的Containerd 分为三大块<code>【Storage】管理镜像文件的存储； 【Metadata】 管理镜像和容器的元数据；【Runtime】由 Task 触发运行时</code>, 并对外提供 GRPC 方式的 API 以及 Metrics 接口。</p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629173044.png" target="_blank" title="WeiyiGeek.架构图简化" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210629173044.png" alt="WeiyiGeek.架构图简化" title="" class=""></a>
                <p>WeiyiGeek.架构图简化</p>
            </figure>
<p><br></p>
<p><strong>containerd-shim</strong><br>描述: 主要是用于剥离 containerd 守护进程与容器进程。目前已有 shim v1 和 shim v2 两个版本；它是containerd中的一个组件，其通过 shim 调用 runc 的包函数来启动容器。直白的说引入shim是允许runc在创建和运行容器之后退出, 并将shim作为容器的父进程, 而不是containerd作为父进程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 当我们执行 pstree 命令时可以看到如下的进程关系containerd-shim是独立于containerd进程运行的。</span></span><br><span class="line">pstree</span><br><span class="line">systemd─┬─VGAuthService</span><br><span class="line">        ├─containerd───15*[&#123;containerd&#125;]</span><br><span class="line">        ├─containerd-shim─┬─sh</span><br><span class="line">        │                 └─13*[&#123;containerd-shim&#125;]</span><br><span class="line">        ├─2*[containerd-shim─┬─sh]</span><br><span class="line">        │                    └─12*[&#123;containerd-shim&#125;]]</span><br></pre></td></tr></table></figure>
<p>此种方式的目的是当containerd进程挂掉时保证容器不受影响, 此外 shim 也可以收集和报告容器的退出状态，不需要 containerd 来 wait 容器进程。</p>
<p>Tips：我们有需求去替换 runc 运行时工具库时，例如 替换为安全容器 kata container 或 Google 研发的 gViser，则需要增加对应的 <code>shim(kata-shim)</code> 以上两者均有自己实现的 shim。</p>
<p><br></p>
<p><strong>CRI &amp; OCI</strong><br>如下图所示 dockershim，containerd 和 cri-o 都是遵循CRI的容器运行时，我们称他们为高层级运行时（High-level Runtime）。</p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094736.png" target="_blank" title="WeiyiGeek.CRI" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094736.png" alt="WeiyiGeek.CRI" title="" class=""></a>
                <p>WeiyiGeek.CRI</p>
            </figure>
<p><br></p>
<p><strong>Containerd vs Cri-o</strong><br>描述: 前面我们说到过kubernetes为啥会替换掉Docker呢?主要原因就是其复杂性，由于Docker的多层封装和调用，导致其在可维护性上略逊一筹，增加了线上问题的定位难度(貌似除了重启Docker，我们就毫无他法了);</p>
<ul>
<li>如下图所示，我们总结了Docker，containerd以及cri-o的详细调用层级, Containerd和cri-o的方案比起 Docker 简洁很多, 因此我们更偏向于选用更加简单和纯粹的 containerd 和 cri-o 作为我们的容器运行时，kubernetes 1.20.x 之上的版本建议使用containerd作为容器运行时。</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094805.png" target="_blank" title="WeiyiGeek.容器运行时调用层级" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706094805.png" alt="WeiyiGeek.容器运行时调用层级" title="" class=""></a>
                <p>WeiyiGeek.容器运行时调用层级</p>
            </figure>
<ul>
<li>如下图所示，我们对containerd和cri-o进行了一组性能测试，包括创建、启动、停止和删除容器，得出它们所耗的时间。<br>Tips : containerd在各个方面都表现良好，除了启动容器这项。从总用时来看 containerd的用时还是要比cri-o要短的。</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705161043.png" target="_blank" title="WeiyiGeek.containerd和crio的性能比较" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210705161043.png" alt="WeiyiGeek.containerd和crio的性能比较" title="" class=""></a>
                <p>WeiyiGeek.containerd和crio的性能比较</p>
            </figure>
<ul>
<li>如下图所示, 从功能性来讲<code>containerd和cri-o都符合CRI和OCI</code>的标准。从稳定性来说，单独使用containerd和cri-o都没有足够的生产环境经验。但庆幸的是，containerd一直在Docker里使用，而Docker的生产环境经验可以说比较充足。可见在稳定性上containerd略胜一筹。所以我们最终选用了containerd。</li>
</ul>
<table>
<thead>
<tr>
<th>-</th>
<th>Containerd</th>
<th>CRI-O</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>性能</td>
<td>更优</td>
<td>优</td>
<td>-</td>
</tr>
<tr>
<td>功能</td>
<td>优</td>
<td>优</td>
<td>CRI与OCI兼容</td>
</tr>
<tr>
<td>稳定性</td>
<td>稳定</td>
<td>未知</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong>Device Mapper vs. Overlayfs</strong><br>描述: 容器运行时使用存储驱动程序(storage driver)来管理镜像和容器的数据。目前我们生产环境选用的是Device Mapper。然而目前Device Mapper在新版本的Docker中已经被弃用，containerd也放弃对Device Mapper的支持。</p>
<p>当初选用 Device Mapper，也是有历史原因的。我们大概是在2014年开始Kubernetes这个项目的。那时候Overlayfs都还没合进kernel。当时我们评估了Docker支持的存储驱动程序，发现Device Mapper是最稳定的。所以我们选用了Device Mapper。但是实际使用下来，由Device Mapper引起的Docker问题也不少。所以我们也借这个契机把Device Mapper给换掉，换成现在containerd和Docker都默认的Overlayfs。</p>
<p>从下图的测试结果来看，Overlayfs 的 IO性能比 Device Mapper 好很多。Overlayfs的IOPS大体上能比Device Mapper高20%，和直接操作主机路径差不多。最终，我们选用了containerd，并以Overlayfs作为存储后端的文件系统，替换了原有的Docker加Device Mapper的搭配。</p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095538.png" target="_blank" title="WeiyiGeek.后端存储文件系统性能比较" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095538.png" alt="WeiyiGeek.后端存储文件系统性能比较" title="" class=""></a>
                <p>WeiyiGeek.后端存储文件系统性能比较</p>
            </figure>
<p>我们在同一个节点上同时起10，30，50和80的Pod，然后再同时删除，去比较迁移前后创建和删除的用时。从下图可知，containerd用时明显优于Docker。</p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095801.png" target="_blank" title="WeiyiGeek.创建与删除Pod的用时比较" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210706095801.png" alt="WeiyiGeek.创建与删除Pod的用时比较" title="" class=""></a>
                <p>WeiyiGeek.创建与删除Pod的用时比较</p>
            </figure>
<p><br></p>
<p><strong>Docker和containerd除了上述常用命令有些区别外，在容器日志及相关参数配置方面也存在一些差异</strong></p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171827.png" target="_blank" title="WeiyiGeek.日志与cni参数配置" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171827.png" alt="WeiyiGeek.日志与cni参数配置" title="" class=""></a>
                <p>WeiyiGeek.日志与cni参数配置</p>
            </figure>
<hr>
<h2 id="0x01-安装配置"><a href="#0x01-安装配置" class="headerlink" title="0x01 安装配置"></a>0x01 安装配置</h2><h3 id="1-Ubuntu安装Containerd-io流程"><a href="#1-Ubuntu安装Containerd-io流程" class="headerlink" title="1.Ubuntu安装Containerd.io流程"></a>1.Ubuntu安装Containerd.io流程</h3><p><strong>安装环境:</strong> 已进行安全基线加固以及系统优化。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - OS</span></span><br><span class="line">$ lsb_release -a</span><br><span class="line">  <span class="comment"># Description:    Ubuntu 20.04.2 LTS focal</span></span><br><span class="line">$ uname -a</span><br><span class="line">  <span class="comment"># Linux containerd 5.4.0-78-generic #87-Ubuntu SMP Fri Jun 18 16:29:09 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Container : 1.4.6-1</span></span><br><span class="line">$ apt-cache madison containerd.io | cut -d <span class="string">'|'</span> -f 2 |  sed <span class="string">'s/^[ \t]*//g'</span></span><br><span class="line">  <span class="comment"># 1.4.6-1</span></span><br><span class="line">  <span class="comment"># 1.4.4-1</span></span><br><span class="line">  <span class="comment"># 1.4.3-2</span></span><br><span class="line">  <span class="comment"># 1.4.3-1</span></span><br><span class="line">  <span class="comment"># 1.3.9-1</span></span><br><span class="line">  <span class="comment"># 1.3.7-1</span></span><br><span class="line">  <span class="comment"># 1.2.13-2</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>安装流程</strong></p>
<ul>
<li><p>Step 1.参考<a href="https://kubernetes.io/docs/setup/cri" target="_blank" rel="noopener">Kubernetes容器运行时接口</a>进行安装前的基础环境准备.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装和配置先决条件：</span></span><br><span class="line"><span class="comment"># 模块加载</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup required sysctl params, these persist across reboots.</span></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply sysctl params without reboot</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.在Ubuntu中安装containerd.io，它来自官方Docker存储库的软件包我们可以参考安装<code>Install Docker Engine</code>(<a href="https://docs.docker.com/engine/install/ubuntu/)中的安装命令。" target="_blank" rel="noopener">https://docs.docker.com/engine/install/ubuntu/)中的安装命令。</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 卸载原有 Docker 以及 containerd</span></span><br><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"><span class="comment"># - 更新apt程序包索引并安装程序包，以允许apt通过HTTPS使用存储库</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates \</span><br><span class="line">  curl \</span><br><span class="line">  gnupg \</span><br><span class="line">  lsb-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 添加Docker的官方GPG密钥：</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 使用以下命令设置稳定存储库。要添加nightly或test存储库，请在下面的命令中的单词stable后面添加单词nightly或test（或两者）。</span></span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> stable"</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 更新apt包索引，安装最新版本的containerd或进入下一步安装特定版本：</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 安装前可查看containerd.io可用的版本: apt-cache madison containerd.io &amp;&amp; apt install containerd.io=1.4.6-1</span></span><br><span class="line">apt install containerd.io=1.4.6-1</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 查看安装Containerd的版本</span></span><br><span class="line">$ ctr --version</span><br><span class="line">  <span class="comment"># ctr containerd.io 1.4.6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.初始化Containerd.io基础配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 初始化配置</span></span><br><span class="line">sudo mkdir -p /etc/containerd</span><br><span class="line">containerd config default | sudo tee /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># - 替换默认的 sandbox_image = "k8s.gcr.io/pause:3.2" 镜像因为GFW的原因导致无法访问我们可以替换为阿里云镜像源。</span></span><br><span class="line">sed -ir <span class="string">'s#sandbox_image = \S\w+.*$#sandbox_image = "registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"#g'</span> /etc/containerd/config.toml</span><br><span class="line">sed -ir <span class="string">"s#https://registry-1.docker.io#https://xlx9erfu.mirror.aliyuncs.com#g"</span>  /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 应用配置并重新运行containerd服务并查看服务状态</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart containerd</span><br><span class="line">systemctl status containerd.service</span><br><span class="line">  <span class="comment"># ● containerd.service - containerd container runtime</span></span><br><span class="line">  <span class="comment">#     Loaded: loaded (/lib/systemd/system/containerd.service; enabled; vendor preset: enabled)</span></span><br><span class="line">  <span class="comment">#     Active: active (running) since Sun 2021-06-27 19:05:48 CST; 8s ago</span></span><br><span class="line">  <span class="comment">#       Docs: https://containerd.io</span></span><br><span class="line">  <span class="comment">#     Process: 3088 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)</span></span><br><span class="line">  <span class="comment">#   Main PID: 3097 (containerd)</span></span><br><span class="line">  <span class="comment">#       Tasks: 15</span></span><br><span class="line">  <span class="comment">#     Memory: 22.6M</span></span><br><span class="line">  <span class="comment">#     CGroup: /system.slice/containerd.service</span></span><br><span class="line">  <span class="comment">#             └─3097 /usr/bin/containerd</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : 查看默认的配置文件，其中root与state 分别表示 Containerd 有两个不同的存储路径，一个用来保存持久化数据，一个用来保存运行时状态。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/containerd/config.toml</span><br><span class="line">version = 2</span><br><span class="line">root = <span class="string">"/var/lib/containerd"</span></span><br><span class="line">state = <span class="string">"/run/containerd"</span></span><br><span class="line">plugin_dir = <span class="string">""</span></span><br><span class="line">disabled_plugins = []</span><br><span class="line">required_plugins = []</span><br><span class="line">oom_score = 0</span><br><span class="line"></span><br><span class="line">[grpc]</span><br><span class="line">  address = <span class="string">"/run/containerd/containerd.sock"</span></span><br><span class="line">  tcp_address = <span class="string">""</span></span><br><span class="line">  tcp_tls_cert = <span class="string">""</span></span><br><span class="line">  tcp_tls_key = <span class="string">""</span></span><br><span class="line">  uid = 0</span><br><span class="line">  gid = 0</span><br><span class="line">  max_recv_message_size = 16777216</span><br><span class="line">  max_send_message_size = 16777216</span><br><span class="line"></span><br><span class="line">[ttrpc]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  uid = 0</span><br><span class="line">  gid = 0</span><br><span class="line"></span><br><span class="line">[debug]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  uid = 0</span><br><span class="line">  gid = 0</span><br><span class="line">  level = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">[metrics]</span><br><span class="line">  address = <span class="string">""</span></span><br><span class="line">  grpc_histogram = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">[cgroup]</span><br><span class="line">  path = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">[timeouts]</span><br><span class="line">  <span class="string">"io.containerd.timeout.shim.cleanup"</span> = <span class="string">"5s"</span></span><br><span class="line">  <span class="string">"io.containerd.timeout.shim.load"</span> = <span class="string">"5s"</span></span><br><span class="line">  <span class="string">"io.containerd.timeout.shim.shutdown"</span> = <span class="string">"3s"</span></span><br><span class="line">  <span class="string">"io.containerd.timeout.task.state"</span> = <span class="string">"2s"</span></span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">  [plugins.<span class="string">"io.containerd.gc.v1.scheduler"</span>]</span><br><span class="line">    pause_threshold = 0.02</span><br><span class="line">    deletion_threshold = 0</span><br><span class="line">    mutation_threshold = 100</span><br><span class="line">    schedule_delay = <span class="string">"0s"</span></span><br><span class="line">    startup_delay = <span class="string">"100ms"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>]</span><br><span class="line">    disable_tcp_service = <span class="literal">true</span></span><br><span class="line">    stream_server_address = <span class="string">"127.0.0.1"</span></span><br><span class="line">    stream_server_port = <span class="string">"0"</span></span><br><span class="line">    stream_idle_timeout = <span class="string">"4h0m0s"</span></span><br><span class="line">    enable_selinux = <span class="literal">false</span></span><br><span class="line">    selinux_category_range = 1024</span><br><span class="line">    sandbox_image = <span class="string">"registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"</span></span><br><span class="line">    stats_collect_period = 10</span><br><span class="line">    systemd_cgroup = <span class="literal">false</span></span><br><span class="line">    enable_tls_streaming = <span class="literal">false</span></span><br><span class="line">    max_container_log_line_size = 16384</span><br><span class="line">    disable_cgroup = <span class="literal">false</span></span><br><span class="line">    disable_apparmor = <span class="literal">false</span></span><br><span class="line">    restrict_oom_score_adj = <span class="literal">false</span></span><br><span class="line">    max_concurrent_downloads = 3</span><br><span class="line">    disable_proc_mount = <span class="literal">false</span></span><br><span class="line">    unset_seccomp_profile = <span class="string">""</span></span><br><span class="line">    tolerate_missing_hugetlb_controller = <span class="literal">true</span></span><br><span class="line">    disable_hugetlb_controller = <span class="literal">true</span></span><br><span class="line">    ignore_image_defined_volumes = <span class="literal">false</span></span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd]</span><br><span class="line">      snapshotter = <span class="string">"overlayfs"</span></span><br><span class="line">      default_runtime_name = <span class="string">"runc"</span></span><br><span class="line">      no_pivot = <span class="literal">false</span></span><br><span class="line">      disable_snapshot_annotations = <span class="literal">true</span></span><br><span class="line">      discard_unpacked_layers = <span class="literal">false</span></span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.default_runtime]</span><br><span class="line">        runtime_type = <span class="string">""</span></span><br><span class="line">        runtime_engine = <span class="string">""</span></span><br><span class="line">        runtime_root = <span class="string">""</span></span><br><span class="line">        privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">        base_runtime_spec = <span class="string">""</span></span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.untrusted_workload_runtime]</span><br><span class="line">        runtime_type = <span class="string">""</span></span><br><span class="line">        runtime_engine = <span class="string">""</span></span><br><span class="line">        runtime_root = <span class="string">""</span></span><br><span class="line">        privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">        base_runtime_spec = <span class="string">""</span></span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc]</span><br><span class="line">          runtime_type = <span class="string">"io.containerd.runc.v2"</span></span><br><span class="line">          runtime_engine = <span class="string">""</span></span><br><span class="line">          runtime_root = <span class="string">""</span></span><br><span class="line">          privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">          base_runtime_spec = <span class="string">""</span></span><br><span class="line">          [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc.options]</span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.cni]</span><br><span class="line">      bin_dir = <span class="string">"/opt/cni/bin"</span></span><br><span class="line">      conf_dir = <span class="string">"/etc/cni/net.d"</span></span><br><span class="line">      max_conf_num = 1</span><br><span class="line">      conf_template = <span class="string">""</span></span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry]</span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"docker.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"https://registry-1.docker.io"</span>]</span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.image_decryption]</span><br><span class="line">      key_model = <span class="string">""</span></span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.x509_key_pair_streaming]</span><br><span class="line">      tls_cert_file = <span class="string">""</span></span><br><span class="line">      tls_key_file = <span class="string">""</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.internal.v1.opt"</span>]</span><br><span class="line">    path = <span class="string">"/opt/containerd"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.internal.v1.restart"</span>]</span><br><span class="line">    interval = <span class="string">"10s"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.metadata.v1.bolt"</span>]</span><br><span class="line">    content_sharing_policy = <span class="string">"shared"</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.monitor.v1.cgroups"</span>]</span><br><span class="line">    no_prometheus = <span class="literal">false</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.runtime.v1.linux"</span>]</span><br><span class="line">    shim = <span class="string">"containerd-shim"</span></span><br><span class="line">    runtime = <span class="string">"runc"</span></span><br><span class="line">    runtime_root = <span class="string">""</span></span><br><span class="line">    no_shim = <span class="literal">false</span></span><br><span class="line">    shim_debug = <span class="literal">false</span></span><br><span class="line">  [plugins.<span class="string">"io.containerd.runtime.v2.task"</span>]</span><br><span class="line">    platforms = [<span class="string">"linux/amd64"</span>]</span><br><span class="line">  [plugins.<span class="string">"io.containerd.service.v1.diff-service"</span>]</span><br><span class="line">    default = [<span class="string">"walking"</span>]</span><br><span class="line">  [plugins.<span class="string">"io.containerd.snapshotter.v1.devmapper"</span>]</span><br><span class="line">    root_path = <span class="string">""</span></span><br><span class="line">    pool_name = <span class="string">""</span></span><br><span class="line">    base_image_size = <span class="string">""</span></span><br><span class="line">    async_remove = <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>温馨提示: root用来保存持久化数据，包括 Snapshots, Content, Metadata 以及各种插件的数据。每一个插件都有自己单独的目录，Containerd 本身不存储任何数据，它的所有功能都来自于已加载的插件，真是太机智了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ tree -L 2 /var/lib/containerd/</span><br><span class="line">/var/lib/containerd/</span><br><span class="line">├── io.containerd.content.v1.content</span><br><span class="line">│   ├── blobs</span><br><span class="line">│   └── ingest</span><br><span class="line">├── io.containerd.grpc.v1.cri</span><br><span class="line">│   ├── containers</span><br><span class="line">│   └── sandboxes</span><br><span class="line">├── io.containerd.metadata.v1.bolt</span><br><span class="line">│   └── meta.db</span><br><span class="line">├── io.containerd.runtime.v1.linux</span><br><span class="line">│   └── k8s.io</span><br><span class="line">├── io.containerd.runtime.v2.task</span><br><span class="line">├── io.containerd.snapshotter.v1.aufs</span><br><span class="line">│   └── snapshots</span><br><span class="line">├── io.containerd.snapshotter.v1.btrfs</span><br><span class="line">├── io.containerd.snapshotter.v1.native</span><br><span class="line">│   └── snapshots</span><br><span class="line">├── io.containerd.snapshotter.v1.overlayfs</span><br><span class="line">│   ├── metadata.db</span><br><span class="line">│   └── snapshots</span><br><span class="line">└── tmpmounts</span><br><span class="line"></span><br><span class="line">18 directories, 2 files</span><br></pre></td></tr></table></figure></p>
<p>温馨提示: 用来保存临时数据，包括 sockets、pid、挂载点、运行时状态以及不需要持久化保存的插件数据。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">🐳  → tree -L 2 /run/containerd/</span><br><span class="line">/run/containerd/</span><br><span class="line">├── containerd.sock</span><br><span class="line">├── containerd.sock.ttrpc</span><br><span class="line">├── io.containerd.grpc.v1.cri</span><br><span class="line">│   ├── containers</span><br><span class="line">│   └── sandboxes</span><br><span class="line">├── io.containerd.runtime.v1.linux</span><br><span class="line">│   └── k8s.io</span><br><span class="line">├── io.containerd.runtime.v2.task</span><br><span class="line">└── runc</span><br><span class="line">    └── k8s.io</span><br><span class="line"></span><br><span class="line">8 directories, 2 files</span><br></pre></td></tr></table></figure></p>
<p>温馨提示: 值得注意的是 OOM 这一配置项 <code>oom_score = 0</code>。<br>Containerd 是容器的守护者，一旦发生内存不足的情况，理想的情况应该是先杀死容器，而不是杀死 Containerd。所以需要调整 Containerd 的 OOM 权重，减少其被 OOM Kill 的几率,最好是将 oom_score 的值调整为比其他守护进程略低的值。这里的 oom_socre 其实对应的是 <code>/proc/&lt;pid&gt;/oom_socre_adj</code>，在早期的 Linux 内核版本里使用 oom_adj 来调整权重, 后来改用 <code>oom_socre_adj</code> 了。在计算最终的 <code>badness score</code> 时，会在计算结果是中加上 oom_score_adj ,这样用户就可以通过该在值来保护某个进程不被杀死或者每次都杀某个进程。其取值范围为 -1000 到 1000。</p>
<p>如果将该值设置为 -1000，则进程永远不会被杀死，因为此时 badness score 永远返回0, 建议 Containerd 将该值设置为 -999 到 0 之间。如果作为 Kubernetes 的 Worker 节点，可以考虑设置为 -999。</p>
<p><br></p>
<ul>
<li>Step 4.查看containerd Client与Server端的信息。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ctr version</span><br><span class="line">Client:</span><br><span class="line">  Version:  1.4.6</span><br><span class="line">  Revision: d71fcd7d8303cbf684402823e425e9dd2e99285d</span><br><span class="line">  Go version: go1.13.15</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">  Version:  1.4.6</span><br><span class="line">  Revision: d71fcd7d8303cbf684402823e425e9dd2e99285d</span><br><span class="line">  UUID: 71a28bbb-6ed6-408d-a873-e394d48b35d8</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 5.查看 Containerd 的 systemd 配置与自启设置。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ cat /lib/systemd/system/containerd.service | grep -v <span class="string">"#"</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target <span class="built_in">local</span>-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/bin/containerd</span><br><span class="line"></span><br><span class="line">Type=notify</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">TasksMax=infinity</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在到了最关键的一步，启用 Containerd 自启动。</span></span><br><span class="line">systemctl <span class="built_in">enable</span> containerd --now</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>上述配置中有两个重要参数即 Delegate 和 KillMode。</p>
<ul>
<li><strong>Delegate</strong> : 这个选项允许 Containerd 以及运行时自己管理自己创建的容器的 cgroups。如果不设置这个选项，systemd 就会将进程移到自己的 cgroups 中，从而导致 Containerd 无法正确获取容器的资源使用情况。</li>
<li><strong>KillMode</strong> : 这个选项用来处理 Containerd 进程被杀死的方式。默认情况下，systemd 会在进程的 cgroup 中查找并杀死 Containerd 的所有子进程，这肯定不是我们想要的。KillMode字段可以设置的值如下。<ul>
<li><code>control-group</code>（默认值）：当前控制组里面的所有子进程，都会被杀掉</li>
<li><code>process</code>：只杀主进程</li>
<li><code>mixed</code>：主进程将收到 SIGTERM 信号，子进程收到 SIGKILL 信号</li>
<li><code>none</code>：没有进程会被杀掉，只是执行服务的 stop 命令。</li>
</ul>
</li>
</ul>
<p>我们需要将 KillMode 的值设置为 process，这样可以确保升级或重启 Containerd 时不杀死现有的容器。</p>
<hr>
<h2 id="0x02-Containerd-简单尝试使用"><a href="#0x02-Containerd-简单尝试使用" class="headerlink" title="0x02 Containerd 简单尝试使用"></a>0x02 Containerd 简单尝试使用</h2><p>描述: 此处以上面Ubuntu的安装环境进行演示。</p>
<h3 id="1-镜像拉取与运行"><a href="#1-镜像拉取与运行" class="headerlink" title="1.镜像拉取与运行"></a>1.镜像拉取与运行</h3><p>Tips : containerd 默认的三个名称空间(Namespace)是<code>default,docker.io,k8s.io</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 1.将 hello-world:latest 镜像拉取到默认的名称空间中,将busybox:latest镜像拉取到k8s.io名称空间中。</span></span><br><span class="line">ctr image pull docker.io/library/hello-world:latest</span><br><span class="line">ctr -n k8s.io image pull docker.io/library/busybox:latest</span><br><span class="line">ctr -n k8s.io image pull registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 2.分别查看拉取的镜像</span></span><br><span class="line">ctr image ls &amp;&amp; ctr -n k8s.io image ls</span><br><span class="line">  <span class="comment"># REF                                  TYPE                                                      DIGEST                                                                  SIZE    PLATFORMS                                                                                                             LABELS</span></span><br><span class="line">  <span class="comment"># docker.io/library/hello-world:latest application/vnd.docker.distribution.manifest.list.v2+json sha256:9f6ad537c5132bcce57f7a0a20e317228d382c3cd61edae14650eec68b2b345c 6.5 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x,windows/amd64 </span></span><br><span class="line">  <span class="comment"># docker.io/library/busybox:latest                                        application/vnd.docker.distribution.manifest.list.v2+json sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d 752.6 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x io.cri-containerd.image=managed</span></span><br><span class="line">  <span class="comment"># registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0     application/vnd.docker.distribution.manifest.v2+json      sha256:3b3a29e3c90ae7762bdf587d19302e62485b6bef46e114b741f7d75dba023bd3 306.4 KiB linux/amd64                                                                                                          io.cri-containerd.image=managed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 3.运行hello-world:latest和分步运行busybox镜像</span></span><br><span class="line">ctr run docker.io/library/hello-world:latest hello-world</span><br><span class="line"><span class="comment"># Hello from Docker!</span></span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line"><span class="comment"># For more examples and ideas, visit:</span></span><br><span class="line"><span class="comment">#  https://docs.docker.com/get-started/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个container(此时还未运行)</span></span><br><span class="line">ctr -n k8s.io container create docker.io/library/busybox:latest busybox</span><br><span class="line"><span class="comment"># 创建一个task并后台运行</span></span><br><span class="line">ctr -n k8s.io task start -d busybox</span><br><span class="line"><span class="comment"># 一步到位: ctr -n k8s.io run -d docker.io/library/busybox:latest busybox</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 4.查看你创建的容器与Task</span></span><br><span class="line">ctr container ls &amp;&amp; ctr -n k8s.io container ls</span><br><span class="line">  <span class="comment"># CONTAINER      IMAGE                                   RUNTIME</span></span><br><span class="line">  <span class="comment"># hello-world    docker.io/library/hello-world:latest    io.containerd.runc.v2</span></span><br><span class="line">  <span class="comment"># CONTAINER    IMAGE                               RUNTIME</span></span><br><span class="line">  <span class="comment"># busybox      docker.io/library/busybox:latest    io.containerd.runc.v2</span></span><br><span class="line"><span class="comment"># 查看该容器在宿主机的PID</span></span><br><span class="line">ctr -n k8s.io task ls</span><br><span class="line">  <span class="comment"># TASK       PID      STATUS</span></span><br><span class="line">  <span class="comment"># busybox    25856    RUNNING</span></span><br><span class="line">ps ajxf|grep <span class="string">"containerd-shim-runc\|25856"</span>|grep -v grep</span><br><span class="line">      1   25828   25828    3097 ?             -1 Sl       0   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id busybox -address /run/containerd/containerd.sock</span><br><span class="line">  25828   25856   25856   25856 ?             -1 Ss       0   0:00  \_ sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 5.进入到容器内部执行shell命令</span></span><br><span class="line">ctr -n k8s.io t <span class="built_in">exec</span> --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> -t busybox sh</span><br><span class="line">  <span class="comment"># / # uname -a</span></span><br><span class="line">  <span class="comment"># Linux containerd 3.10.0-1062.el7.x86_64 #1 SMP Wed Aug 7 18:08:02 UTC 2019 x86_64 GNU/Linux</span></span><br><span class="line">  <span class="comment"># ---  此处你会发现只有lo网络卡后续我们可以通过CNI插件的形式添加网卡实现外部网络通信 --- </span></span><br><span class="line">  <span class="comment"># / # ip a</span></span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line">  <span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 ::1/128 scope host </span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 6.删除创建的Task与容器</span></span><br><span class="line">ctr -n k8s.io t <span class="built_in">kill</span> -s SIGKILL busybox  <span class="comment"># 发送SIGKILL信号量杀死该容器</span></span><br><span class="line">ctr -n k8s.io task rm busybox</span><br><span class="line">ctr -n k8s.io snapshots rm busybox</span><br><span class="line">ctr -n k8s.io container rm busybox</span><br><span class="line">ctr container rm hello-world</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="2-创建和使用网络"><a href="#2-创建和使用网络" class="headerlink" title="2.创建和使用网络"></a>2.创建和使用网络</h3><p>描述: 在前面我们进入busybox容器中会发现里面只有一张网卡而且无法连接到外部网络之中,所以我们需要借助于<a href="https://www.cni.dev/" target="_blank" rel="noopener">CNI（Container Network Interface</a>它是一个云计算基础项目来实现Containerd容器具有网络功能。</p>
<p><strong>项目说明:</strong></p>
<ul>
<li>2.1) CNI 网络插件(Plugins) : <a href="https://github.com/containernetworking/plugins" target="_blank" rel="noopener">https://github.com/containernetworking/plugins</a> (PS : 当前版本 v0.9.1)</li>
<li>2.2) CNI 容器网络接口-Linux容器网络 : <a href="https://github.com/containernetworking/cni" target="_blank" rel="noopener">https://github.com/containernetworking/cni</a></li>
</ul>
<p><strong>操作流程:</strong></p>
<ul>
<li><p>Step 1.CNI插件下载（现在版本可能大于v0.9.1,如有不同请参考官网文档）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 1.从containernetworking/plugins的release页面下载最新版本并解压到/usr/local/cni-plugins:</span></span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">mkdir -vp /usr/<span class="built_in">local</span>/cni-plugins &amp;&amp; tar xvf cni-plugins-linux-amd64-v0.9.1.tgz -C /usr/<span class="built_in">local</span>/cni-plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 2.从containernetworking/cni的release页面下载最新版本并解压到/usr/local/cni-&#123;version&#125;:</span></span><br><span class="line">wget https://github.com/containernetworking/cni/archive/refs/tags/v0.8.1.tar.gz</span><br><span class="line">tar -zxvf v0.8.1.tar.gz -C /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.创建和<a href="https://github.com/containernetworking/cni#running-the-plugins" target="_blank" rel="noopener">使用CNI网络插件</a></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 使用bridge插件创建一个网卡依赖于一下面的配置文件。</span></span><br><span class="line"></span><br><span class="line">mkdir -p /etc/cni/net.d</span><br><span class="line">cat &gt;/etc/cni/net.d/10-mynet.conf &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cniVersion"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"mynet"</span>,</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">  <span class="string">"bridge"</span>: <span class="string">"cni0"</span>,</span><br><span class="line">  <span class="string">"isGateway"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"ipMasq"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"ipam"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"host-local"</span>,</span><br><span class="line">    <span class="string">"subnet"</span>: <span class="string">"10.22.0.0/16"</span>,</span><br><span class="line">    <span class="string">"routes"</span>: [</span><br><span class="line">      &#123; <span class="string">"dst"</span>: <span class="string">"0.0.0.0/0"</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line">cat &gt;/etc/cni/net.d/99-loopback.conf &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cniVersion"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"lo"</span>,</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"loopback"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 注意json字符串解析需要依赖jq命令所以我们需要安装(已安装可以跳过)</span></span><br><span class="line">apt install jq -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 利用CNI网络插件进行激活cni0网卡</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/cni-0.8.1/scripts/</span><br><span class="line">/usr/<span class="built_in">local</span>/cni-0.8.1/scripts<span class="comment"># CNI_PATH=/usr/local/cni-plugins ./priv-net-run.sh echo "Hello World! CNI Plugins."</span></span><br><span class="line">Hello World! CNI Plugins.</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 宿主机执行ip a命令即可看到一个cni0的网卡</span></span><br><span class="line">/usr/<span class="built_in">local</span>/cni-0.8.1/scripts<span class="comment"># ip addr show cni0</span></span><br><span class="line">3: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link/ether ea:3e:1b:23:66:3a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.22.0.1/16 brd 10.22.255.255 scope global cni0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 3.使<code>containerd</code>容器具备网络功能(<code>使其具备各容器互通、外部网络通信功能</code>)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 将busybox容器实现网络通信</span></span><br><span class="line">ctr -n k8s.io run -d docker.io/library/busybox:latest busybox</span><br><span class="line">ctr -n k8s.io task ls</span><br><span class="line">  <span class="comment"># TASK       PID      STATUS</span></span><br><span class="line">  <span class="comment"># busybox    43908    RUNNING</span></span><br><span class="line">pid=$(ctr -n k8s.io t ls|grep busybox|awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">netnspath=/proc/<span class="variable">$pid</span>/ns/net</span><br><span class="line">CNI_PATH=/usr/<span class="built_in">local</span>/cni-plugins /usr/<span class="built_in">local</span>/cni-0.8.1/scripts/<span class="built_in">exec</span>-plugins.sh add <span class="variable">$pid</span> <span class="variable">$netnspath</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 随后进入busybox容器我们将会发现其新增了一张网卡并可以实现外部网络访问：</span></span><br><span class="line">ctr -n k8s.io task <span class="built_in">exec</span> --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> -t busybox  sh -</span><br><span class="line">  <span class="comment"># / # ip addr</span></span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line">  <span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 ::1/128 scope host</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># 3: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line">  <span class="comment">#     link/ether d6:fd:92:9c:8a:a9 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 10.22.0.3/16 brd 10.22.255.255 scope global eth0</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 fe80::d4fd:92ff:fe9c:8aa9/64 scope link</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># / # ping 223.6.6.6   # 外网没有问题。</span></span><br><span class="line">  PING 223.6.6.6 (223.6.6.6): 56 data bytes</span><br><span class="line">  64 bytes from 223.6.6.6: seq=0 ttl=113 time=7.902 ms</span><br><span class="line">  64 bytes from 223.6.6.6: seq=1 ttl=113 time=7.102 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 在创建一个busybox-1实现互通。</span></span><br><span class="line">ctr -n k8s.io run -d docker.io/library/busybox:latest busybox-1</span><br><span class="line">pid=$(ctr -n k8s.io t ls|grep busybox-1|awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">netnspath=/proc/<span class="variable">$pid</span>/ns/net</span><br><span class="line">CNI_PATH=/usr/<span class="built_in">local</span>/cni-plugins /usr/<span class="built_in">local</span>/cni-0.8.1/scripts/<span class="built_in">exec</span>-plugins.sh add <span class="variable">$pid</span> <span class="variable">$netnspath</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 查看你创建容器的pid进程相关信息</span></span><br><span class="line">ps ajxf|egrep <span class="string">"containerd-shim-runc|43908|48850"</span>|grep -v grep</span><br><span class="line">  <span class="comment">#     1   43883   43883   39042 ?             -1 Sl       0   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id busybox -address /run/containerd/containerd.sock</span></span><br><span class="line">  <span class="comment"># 43883   43908   43908   43908 ?             -1 Ss       0   0:00  \_ sh</span></span><br><span class="line">  <span class="comment">#     1   48825   48825   39042 ?             -1 Sl       0   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id busybox-1 -address /run/containerd/containerd.sock</span></span><br><span class="line">  <span class="comment"># 48825   48850   48850   48850 ?             -1 Ss       0   0:00  \_ sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 查看创建的busybox-1相关信息</span></span><br><span class="line">ctr -n k8s.io task <span class="built_in">exec</span> --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> -t busybox-1 sh -</span><br><span class="line">  <span class="comment"># 3: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line">  <span class="comment">#     link/ether 9e:70:c6:cd:a5:7b brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 10.22.0.4/16 brd 10.22.255.255 scope global eth0</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet6 fe80::9c70:c6ff:fecd:a57b/64 scope link</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : 采用<code>nc -l -v -p 8080</code>监听在另外的一个容器里面进行通信链接。</p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210628221210.png" target="_blank" title="WeiyiGeek.CNI-Plugins" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210628221210.png" alt="WeiyiGeek.CNI-Plugins" title="" class=""></a>
                <p>WeiyiGeek.CNI-Plugins</p>
            </figure>
<p><br></p>
<h3 id="3-与宿主机和其它容器共享文件"><a href="#3-与宿主机和其它容器共享文件" class="headerlink" title="3.与宿主机和其它容器共享文件"></a>3.与宿主机和其它容器共享文件</h3><p>描述: 在Docker我们常常需要将配置文件或者各类数据映射进入到docker容器之中，便于容器内部程序使用或者数据的持久化。</p>
<p>下面分别简单演示与宿主机或者其它容器共享目录;</p>
<ul>
<li><p><strong>(1) 宿主机共享</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ctr -n k8s.io c create docker.io/library/busybox:latest busybox-2 --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/tmp,dst=/host,options=rbind:rw</span><br><span class="line"></span><br><span class="line">ctr -n k8s.io t start -d busybox-2 sh</span><br><span class="line"></span><br><span class="line">ctr -n k8s.io t <span class="built_in">exec</span> -t --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> busybox-2 sh</span><br><span class="line">  <span class="comment"># / # echo "WeiyiGeek" &gt; /host/name</span></span><br><span class="line">  <span class="comment"># / # </span></span><br><span class="line">root@containerd:~<span class="comment"># cat /tmp/name</span></span><br><span class="line">WeiyiGeek</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>(2) 其它容器间共享</strong><br>描述: 本章节对于PID NS共享为例其它的NS共享与该方案类似，下面我们利用docker 与 container 对ns共享设置做一个对比。</p>
</li>
</ul>
<p>首先我们对docker的ns共享进行实验：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@docker scripts]<span class="comment"># docker run --rm -it -d busybox sh</span></span><br><span class="line">687c80243ee15e0a2171027260e249400feeeee2607f88d1f029cc270402cdd1</span><br><span class="line">[root@docker scripts]<span class="comment"># docker run --rm -it -d --pid="container:687c80243ee15e0a2171027260e249400feeeee2607f88d1f029cc270402cdd1" busybox cat</span></span><br><span class="line">fa2c09bd9c042128ebb2256685ce20e265f4c06da6d9406bc357d149af7b83d2</span><br><span class="line">[root@docker scripts]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">fa2c09bd9c04        busybox             <span class="string">"cat"</span>               2 seconds ago       Up 1 second                             pedantic_goodall</span><br><span class="line">687c80243ee1        busybox             <span class="string">"sh"</span>                22 seconds ago      Up 21 seconds                           hopeful_franklin</span><br><span class="line">[root@docker scripts]<span class="comment"># docker exec -it 687c80243ee1 sh</span></span><br><span class="line">/ <span class="comment"># ps aux</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">    8 root      0:00 cat</span><br><span class="line">   15 root      0:00 sh</span><br></pre></td></tr></table></figure></p>
<p>然后基于containerd的方式实现<code>pid ns</code>共享：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ctr -n k8s.io t ls</span><br><span class="line">  <span class="comment"># TASK         PID      STATUS</span></span><br><span class="line">  <span class="comment"># busybox      43908    RUNNING </span></span><br><span class="line">  <span class="comment"># busybox-1    48850    RUNNING  # 这里的48850即为已有task运行时的pid号</span></span><br><span class="line">  <span class="comment"># busybox-2    50314    RUNNING</span></span><br><span class="line"></span><br><span class="line">$ ctr -n k8s.io c create --with-ns <span class="string">"pid:/proc/48850/ns/pid"</span> v4ehxdz8.mirror.aliyuncs.com/library/python:3.6-slim python <span class="comment"># 将 容器中运行 的进程共享注入到 48850 pid之中</span></span><br><span class="line"></span><br><span class="line">$ ctr -n k8s.io t start -d python python  <span class="comment"># 启动了一个python的命令</span></span><br><span class="line"></span><br><span class="line">$ ctr -n k8s.io t <span class="built_in">exec</span> -t --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span> busybox-1 sh <span class="comment"># 至此可以在busybox-1容器中看见刚执行的python命令</span></span><br><span class="line">/ <span class="comment"># ps aux</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">   34 root      0:00 python3</span><br><span class="line">   41 root      0:00 sh</span><br><span class="line">   47 root      0:00 ps aux</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="4-Docker-与-Containerd-并用配置"><a href="#4-Docker-与-Containerd-并用配置" class="headerlink" title="4.Docker 与 Containerd 并用配置"></a>4.Docker 与 Containerd 并用配置</h3><p>描述: 事实上，Docker 和 Containerd 是可以同时使用的，只不过 Docker 默认使用的 Containerd 的命名空间不是 default，而是 moby，此处为了更方便我们学习可以将 Docker 与 Containerd 联合使用。<br>Docker-CE 安装参考链接：<a href="https://docs.docker.com/engine/reference/commandline/dockerd/" target="_blank" rel="noopener">https://docs.docker.com/engine/reference/commandline/dockerd/</a></p>
<ul>
<li><p>Step 1.在前面我们完成 containerd 的安装配置并启动后，我们可以在宿主机中安装docker客户端及服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> stable"</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">apt-update</span><br><span class="line"><span class="comment"># - 查看可用版本</span></span><br><span class="line">apt-cache madison docker-ce </span><br><span class="line"><span class="comment"># - 安装指定版本 (20.10.X 版本支持 Docker Scan 特性)</span></span><br><span class="line">sudo apt-get install docker-ce=5:20.10.7~3-0~ubuntu-focal docker-ce-cli=5:20.10.7~3-0~ubuntu-focal</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.编辑<code>/etc/systemd/system/multi-user.target.wants/docker.service</code>文件并为其新增 <code>--containerd</code>如下启动项：<code>--containerd /run/containerd/containerd.sock</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/multi-user.target.wants/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --cri-containerd --debug </span><br><span class="line"></span><br><span class="line"><span class="comment"># - 重新加载配置</span></span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.添加低权限用户到docker组里并自启Docker。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl status docker</span><br><span class="line">  <span class="comment"># ● docker.service - Docker Application Container Engine</span></span><br><span class="line">  <span class="comment">#     Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)</span></span><br><span class="line">  <span class="comment">#     Active: active (running) since Mon 2021-07-05 12:47:10 CST; 5min ago</span></span><br><span class="line">  <span class="comment"># TriggeredBy: ● docker.socket</span></span><br><span class="line">  <span class="comment">#       Docs: https://docs.docker.com</span></span><br><span class="line">  <span class="comment">#   Main PID: 129606 (dockerd)</span></span><br><span class="line">  <span class="comment">#       Tasks: 12</span></span><br><span class="line">  <span class="comment">#     Memory: 45.0M</span></span><br><span class="line">  <span class="comment">#     CGroup: /system.slice/docker.service</span></span><br><span class="line">  <span class="comment">#             └─129606 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者查看 Dockerd 服务端执行的命令</span></span><br><span class="line">ps aux|grep docker</span><br><span class="line">  <span class="comment"># root      129606  0.0  4.4 1021016 89792 ?       Ssl  12:47   0:00 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增docker0网卡信息</span></span><br><span class="line"><span class="comment"># 7: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line"><span class="comment">#   link/ether 02:42:23:41:2c:db brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="comment">#   inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span></span><br><span class="line"><span class="comment">#       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 4.打开两个Shell终端一个采用 docker 运行一个 busybox 容器，另外一个查看对比。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -it busybox sh</span><br><span class="line">  <span class="comment"># / # ip addr</span></span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line">  <span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># 8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span></span><br><span class="line">  <span class="comment">#     link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0   # 关键点</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment"># / # cat /etc/hosts</span></span><br><span class="line">  <span class="comment"># 127.0.0.1       localhost</span></span><br><span class="line">  <span class="comment"># 172.17.0.2      51dcdf68d3b8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 采用 ctr 在 moby 名称空间下查看docker创建的容器以及Task PID</span></span><br><span class="line">$ ctr -n moby c ls</span><br><span class="line">  <span class="comment"># CONTAINER                                                           IMAGE    RUNTIME</span></span><br><span class="line">  <span class="comment"># 51dcdf68d3b8bf4c9707c9059e33f9570cb83725355595e77cf433dd3e25b64b    -        io.containerd.runc.v2</span></span><br><span class="line">$ ctr -n moby t ls</span><br><span class="line">  <span class="comment"># TASK                                                                PID       STATUS</span></span><br><span class="line">  <span class="comment"># 51dcdf68d3b8bf4c9707c9059e33f9570cb83725355595e77cf433dd3e25b64b    131926    RUNNING</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证获取到的 Task PID 下其 net 相关信息</span></span><br><span class="line">$ grep <span class="string">"172.17.0.2"</span> /proc/131926/net/fib_trie</span><br><span class="line">  |-- 172.17.0.2</span><br><span class="line">  |-- 172.17.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 采用 ctr 进入 Docker 创建的容器</span></span><br><span class="line">$ ctr -n moby t <span class="built_in">exec</span> -t --<span class="built_in">exec</span>-id <span class="variable">$RANDOM</span>  51dcdf68d3b8bf4c9707c9059e33f9570cb83725355595e77cf433dd3e25b64b sh</span><br><span class="line">  <span class="comment"># / # ip addr | grep "172.17.0.2"</span></span><br><span class="line">  <span class="comment">#   inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span></span><br><span class="line">  <span class="comment"># / # hostname</span></span><br><span class="line">  <span class="comment">#   51dcdf68d3b8</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="5-镜像加速配置"><a href="#5-镜像加速配置" class="headerlink" title="5.镜像加速配置"></a>5.镜像加速配置</h3><p>描述: 镜像加速的配置就在 cri 插件配置块下面的 registry 配置块，所以需要修改的部分如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/containerd/config.toml</span><br><span class="line">    [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry]</span><br><span class="line">      [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"docker.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"https://xlx9erfu.mirror.aliyuncs.com"</span>]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"k8s.gcr.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"https://registry.aliyuncs.com/k8sxio"</span>]</span><br><span class="line">        [plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="string">"gcr.io"</span>]</span><br><span class="line">          endpoint = [<span class="string">"xxx"</span>]</span><br></pre></td></tr></table></figure></p>
<p><strong>插件及其参数解释:</strong></p>
<ul>
<li><code>registry.mirrors.&quot;xxx&quot;</code> : 表示需要配置 mirror 的镜像仓库。例如，registry.mirrors.”docker.io” 表示配置 docker.io 的 mirror。</li>
<li><code>endpoint</code> : 表示提供 mirror 的镜像加速服务。例如，这里推荐使用西北农林科技大学提供的镜像加速服务作为 docker.io 的 mirror, 或者阿里云的</li>
</ul>
<hr>
<h2 id="0x03-Containerd-与-Docker-CLI-工具命令表"><a href="#0x03-Containerd-与-Docker-CLI-工具命令表" class="headerlink" title="0x03 Containerd 与 Docker CLI 工具命令表"></a>0x03 Containerd 与 Docker CLI 工具命令表</h2><p>描述: Containerd 和 Docker 在命令使用上的一些区别主要如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">功能说明</th>
<th style="text-align:left">Containerd CLI</th>
<th style="text-align:left">Docker CLI</th>
<th style="text-align:left">Crictl CLI</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">镜像列举</td>
<td style="text-align:left">ctr image [ls/list]</td>
<td style="text-align:left">docker images [ls]</td>
<td style="text-align:left">crictl images [ls]</td>
</tr>
<tr>
<td style="text-align:center">导出镜像</td>
<td style="text-align:left">ctr image export app.tar weiyigeek.top/app:1.2.0</td>
<td style="text-align:left">docker save -o app.tar app:1.2.0</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">导入镜像</td>
<td style="text-align:left">ctr image import app.tar</td>
<td style="text-align:left">docker load -i app.tar</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">拉取镜像</td>
<td style="text-align:left">ctr -n k8s.io images pull docker.io/library/redis:latest</td>
<td style="text-align:left">docker pull redis:latest</td>
<td style="text-align:left">crictl pull redis:latest</td>
</tr>
<tr>
<td style="text-align:center">上传镜像</td>
<td style="text-align:left">ctr -n k8s.io images push docker.io/library/redis:latest</td>
<td style="text-align:left">docker push</td>
<td style="text-align:left">crictl  push</td>
</tr>
<tr>
<td style="text-align:center">更改标记</td>
<td style="text-align:left">ctr -n k8s.io images tag docker.io/library/redis:latest weiyigeek.top/redis:latest</td>
<td style="text-align:left">docker tag redis:latest  weiyigeek.top/redis:latest</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">删除镜像</td>
<td style="text-align:left">ctr -n k8s.io images rm docker.io/library/redis:latest</td>
<td style="text-align:left">docker rmi</td>
<td style="text-align:left">crictl rmi</td>
</tr>
<tr>
<td style="text-align:center">创建容器</td>
<td style="text-align:left">ctr -n k8s.io container create docker.io/library/redis:latest redis</td>
<td style="text-align:left">docker create</td>
<td style="text-align:left">crictl create</td>
</tr>
<tr>
<td style="text-align:center">创建并运行容器</td>
<td style="text-align:left">ctr run -d –env name=WeiyiGeek application weiyigeek.top/app:1.2.0</td>
<td style="text-align:left">docker run</td>
</tr>
<tr>
<td style="text-align:center">查看容器</td>
<td style="text-align:left">ctr -n k8s.io container list</td>
<td style="text-align:left">docker ps</td>
<td style="text-align:left">crictl ps</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">启动容器</td>
<td style="text-align:left">ctr -n k8s.io task start</td>
<td style="text-align:left">docker start</td>
<td style="text-align:left">crictl start</td>
</tr>
<tr>
<td style="text-align:center">停止容器</td>
<td style="text-align:left">ctr -n k8s.io task pause</td>
<td style="text-align:left">docker stop</td>
<td style="text-align:left">crictl stop</td>
</tr>
<tr>
<td style="text-align:center">删除容器</td>
<td style="text-align:left">ctr -n k8s.io container rm</td>
<td style="text-align:left">docker rm</td>
<td style="text-align:left">crictl rm</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">容器详情</td>
<td style="text-align:left">ctr -n k8s.io c info 39d36ef08456</td>
<td style="text-align:left">docker inspect 39d36ef08456</td>
<td style="text-align:left">crictl inspect 39d36ef08456</td>
</tr>
<tr>
<td style="text-align:center">容器连接</td>
<td style="text-align:left">ctr -n k8s.io task  attach</td>
<td style="text-align:left">docker attach</td>
<td style="text-align:left">crictl attach</td>
</tr>
<tr>
<td style="text-align:center">进入容器</td>
<td style="text-align:left">ctr -n k8s.io task  exec</td>
<td style="text-align:left">docker exec</td>
<td style="text-align:left">crictl exec</td>
</tr>
<tr>
<td style="text-align:center">stats(状态)</td>
<td style="text-align:left">ctr -n k8s.io task metric 39d36ef08456</td>
<td style="text-align:left">docker top</td>
<td style="text-align:left">crictl stats</td>
</tr>
<tr>
<td style="text-align:center">日志查看</td>
<td style="text-align:left">ctr -n k8s.io event</td>
<td style="text-align:left">docker logs –tail 50  8db74c2bf7595</td>
<td style="text-align:left">crictl logs –tail 50 8db74c2bf7595</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="ctr-命令-Containerd-管理命令详细"><a href="#ctr-命令-Containerd-管理命令详细" class="headerlink" title="ctr 命令 - Containerd 管理命令详细"></a>ctr 命令 - Containerd 管理命令详细</h3><p>描述: 它是一个不受支持的调试和管理客户端，用于与容器守护进程进行交互。因为它不受支持，所以命令、选项和操作不能保证向后兼容或稳定从集装箱项目的发布到发布。</p>
<p><strong>语法参数:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#USAGE:</span></span><br><span class="line">  ctr [global options] <span class="built_in">command</span> [<span class="built_in">command</span> options] [arguments...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># GLOBAL OPTIONS:</span></span><br><span class="line">  --debug                      <span class="built_in">enable</span> debug output <span class="keyword">in</span> logs</span><br><span class="line">  --address value, -a value    address <span class="keyword">for</span> containerds GRPC server (default: <span class="string">"/run/containerd/containerd.sock"</span>) [<span class="variable">$CONTAINERD_ADDRESS</span>]</span><br><span class="line">  --timeout value              total timeout <span class="keyword">for</span> ctr commands (default: 0s)</span><br><span class="line">  --connect-timeout value      timeout <span class="keyword">for</span> connecting to containerd (default: 0s)</span><br><span class="line">  --namespace value, -n value  namespace to use with commands (default: <span class="string">"default"</span>) [<span class="variable">$CONTAINERD_NAMESPACE</span>]</span><br><span class="line">  --version, -v                <span class="built_in">print</span> the version</span><br><span class="line"></span><br><span class="line"><span class="comment"># COMMANDS:</span></span><br><span class="line">  plugins, plugin            provides information about containerd plugins</span><br><span class="line">  version                    <span class="built_in">print</span> the client and server versions</span><br><span class="line">  containers, c, container   manage containers</span><br><span class="line">  content                    manage content</span><br><span class="line">  events, event              display containerd events</span><br><span class="line">  images, image, i           manage images</span><br><span class="line">  leases                     manage leases</span><br><span class="line">  namespaces, namespace, ns  manage namespaces</span><br><span class="line">  pprof                      provide golang pprof outputs <span class="keyword">for</span> containerd</span><br><span class="line">  run                        run a container</span><br><span class="line">  snapshots, snapshot        manage snapshots</span><br><span class="line">  tasks, t, task             manage tasks</span><br><span class="line">  install                    install a new package</span><br><span class="line">  oci                        OCI tools</span><br><span class="line">  shim                       interact with a shim directly (直接与shim交互)</span><br><span class="line">  <span class="built_in">help</span>, h                    Shows a list of commands or <span class="built_in">help</span> <span class="keyword">for</span> one <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子命令 #</span></span><br><span class="line"><span class="comment"># Images COMMANDS:</span></span><br><span class="line">  check       check that an image has all content available locally(找到发生故障的容器后，可以使用以下工具检查其日志)</span><br><span class="line">  <span class="built_in">export</span>      <span class="built_in">export</span> images</span><br><span class="line">  import      import images</span><br><span class="line">  list, ls    list images known to containerd</span><br><span class="line">  mount       mount an image to a target path</span><br><span class="line">  unmount     unmount the image from the target</span><br><span class="line">  pull        pull an image from a remote</span><br><span class="line">  push        push an image to a remote</span><br><span class="line">  remove, rm  remove one or more images by reference</span><br><span class="line">  tag         tag an image</span><br><span class="line">  label       <span class="built_in">set</span> and clear labels <span class="keyword">for</span> an image</span><br><span class="line"></span><br><span class="line"><span class="comment"># Container COMMANDS:</span></span><br><span class="line">  create           create container</span><br><span class="line">  delete, del, rm  delete one or more existing containers</span><br><span class="line">  info             get info about a container</span><br><span class="line">  list, ls         list containers</span><br><span class="line">  label            <span class="built_in">set</span> and clear labels <span class="keyword">for</span> a container</span><br><span class="line">  checkpoint       checkpoint a container (检查点容器)</span><br><span class="line">  restore          restore a container from checkpoint(从检查点还原容器)</span><br><span class="line"></span><br><span class="line"><span class="comment"># run OPTIONS:</span></span><br><span class="line">  --rm                                    remove the container after running</span><br><span class="line">  --null-io                               send all IO to /dev/null (将容器内标准输出重定向到/dev/null)</span><br><span class="line">  --<span class="built_in">log</span>-uri value                         <span class="built_in">log</span> uri</span><br><span class="line">  --detach, -d                            detach from the task after it has started execution(在任务开始执行后从中分离,如没有选项则会等待用户输入并定向到容器内)</span><br><span class="line">  --fifo-dir value                        directory used <span class="keyword">for</span> storing IO FIFOs</span><br><span class="line">  --cgroup value                          cgroup path (To <span class="built_in">disable</span> use of cgroup, <span class="built_in">set</span> to <span class="string">""</span> explicitly)</span><br><span class="line">  --platform value                        run image <span class="keyword">for</span> specific platform</span><br><span class="line">  --runc-binary value                     specify runc-compatible binary</span><br><span class="line">  --runc-systemd-cgroup                   start runc with systemd cgroup manager</span><br><span class="line">  --uidmap container-uid:host-uid:length  run inside a user namespace with the specified UID mapping range; specified with the format container-uid:host-uid:length</span><br><span class="line">  --gidmap container-gid:host-gid:length  run inside a user namespace with the specified GID mapping range; specified with the format container-gid:host-gid:length</span><br><span class="line">  --remap-labels                          provide the user namespace ID remapping to the snapshotter via label options; requires snapshotter support</span><br><span class="line">  --cpus value                            <span class="built_in">set</span> the CFS cpu qouta (default: 0)</span><br><span class="line">  --snapshotter value                     snapshotter name. Empty value stands <span class="keyword">for</span> the default value. [<span class="variable">$CONTAINERD_SNAPSHOTTER</span>]</span><br><span class="line">  --config value, -c value                path to the runtime-specific spec config file</span><br><span class="line">  --cwd value                             specify the working directory of the process</span><br><span class="line">  --env value                             specify additional container environment variables (i.e. FOO=bar)</span><br><span class="line">  --env-file value                        specify additional container environment variables <span class="keyword">in</span> a file(i.e. FOO=bar, one per line)</span><br><span class="line">  --label value                           specify additional labels (i.e. foo=bar)</span><br><span class="line">  --mount value                           specify additional container mount (ex: <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/tmp,dst=/host,options=rbind:ro)</span><br><span class="line">  --net-host                              <span class="built_in">enable</span> host networking <span class="keyword">for</span> the container</span><br><span class="line">  --privileged                            run privileged container</span><br><span class="line">  --<span class="built_in">read</span>-only                             <span class="built_in">set</span> the containers filesystem as <span class="built_in">readonly</span></span><br><span class="line">  --runtime value                         runtime name (default: <span class="string">"io.containerd.runc.v2"</span>)</span><br><span class="line">  --tty, -t                               allocate a TTY <span class="keyword">for</span> the container</span><br><span class="line">  --with-ns value                         specify existing Linux namespaces to join at container runtime (format <span class="string">'&lt;nstype&gt;:&lt;path&gt;'</span>)</span><br><span class="line">  --pid-file value                        file path to write the task<span class="string">'s pid</span></span><br><span class="line"><span class="string">  --gpus value                            add gpus to the container (default: 0)</span></span><br><span class="line"><span class="string">  --allow-new-privs                       turn off OCI spec'</span>s NoNewPrivileges feature flag</span><br><span class="line">  --memory-limit value                    memory <span class="built_in">limit</span> (<span class="keyword">in</span> bytes) <span class="keyword">for</span> the container (default: 0)</span><br><span class="line">  --device value                          add a device to a container</span><br><span class="line">  --seccomp                               <span class="built_in">enable</span> the default seccomp profile</span><br><span class="line">  --rootfs                                use custom rootfs that is not managed by containerd snapshotter</span><br><span class="line">  --no-pivot                              <span class="built_in">disable</span> use of pivot-root (linux only)</span><br><span class="line">  --cpu-quota value                       Limit CPU CFS quota (default: -1)</span><br><span class="line">  --cpu-period value                      Limit CPU CFS period (default: 0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tasks COMMANDS:</span></span><br><span class="line">  attach           attach to the IO of a running container</span><br><span class="line">  checkpoint       checkpoint a container</span><br><span class="line">  delete, rm       delete one or more tasks</span><br><span class="line">  <span class="built_in">exec</span>             execute additional processes <span class="keyword">in</span> an existing container</span><br><span class="line">  list, ls         list tasks</span><br><span class="line">  <span class="built_in">kill</span>             signal a container (default: SIGTERM)</span><br><span class="line">  pause            pause an existing container</span><br><span class="line">  ps               list processes <span class="keyword">for</span> container</span><br><span class="line">  resume           resume a paused container</span><br><span class="line">  start            start a container that has been created</span><br><span class="line">  metrics, metric  get a single data point of metrics <span class="keyword">for</span> a task with the built-in Linux runtime</span><br></pre></td></tr></table></figure></p>
<p>Tips : containerd 引入了 namespace 概念, 每个image和container都会在各自的namespace下可见, 目前k8s会使用 k8s.io 以及 default 作为命名空间。<br>Tips : 当导入本地镜像时ctr不支持压缩。<br>Tips : 通过<code>ctr containers create</code>创建容器后，只是一个静态的容器，容器中的用户进程并没有启动，所以还需要通过<code>ctr task start</code>来启动容器进程。 当然也可以用<code>ctr run</code>的命令直接创建并运行容器。在进入容器操作时与docker不同的是，必须在<code>ctr task exec</code>命令后指定<code>--exec-id</code>参数，这个id可以随便写只要唯一就行。<br>Tips : ctr没有stop容器的功能，只能暂停（ctr task pause）或者杀死（ctr task kill）容器</p>
<p><br/></p>
<p><strong>实际案例:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) 名称空间查看创建或删除</span></span><br><span class="line">ctr namespace create devops</span><br><span class="line">ctr namespace ls -q</span><br><span class="line">  <span class="comment"># devops</span></span><br><span class="line">  <span class="comment"># k8s.io</span></span><br><span class="line">ctr namespace remove devops</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 镜像查看及其操作</span></span><br><span class="line">ctr -n k8s.io images ls | grep <span class="string">"busybox"</span></span><br><span class="line">  <span class="comment"># docker.io/library/busybox:1.33.1 application/vnd.docker.distribution.manifest.list.v2+json sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d 752.6 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x io.cri-containerd.image=managed</span></span><br><span class="line">ctr -n k8s.io images ls -q | grep <span class="string">"busybox"</span>   <span class="comment"># docker.io/library/busybox:1.33.1</span></span><br><span class="line">ctr -n k8s.io i rm k8s.gcr.io/pause:3.2       <span class="comment"># 删除镜像</span></span><br><span class="line">ctr -n k8s.io i pull -k k8s.gcr.io/pause:3.2  <span class="comment"># 拉取镜像 </span></span><br><span class="line">ctr -n k8s.io i push -k k8s.gcr.io/pause:3.2  <span class="comment"># 推送镜像</span></span><br><span class="line">ctr -n k8s.io i <span class="built_in">export</span> pause.tar k8s.gcr.io/pause:3.2 <span class="comment"># 导出镜像</span></span><br><span class="line">ctr -n k8s.io i import pause.tar              <span class="comment"># 导入镜像    </span></span><br><span class="line">ctr -n k8s.io images check  | grep <span class="string">"busybox"</span>  <span class="comment"># 镜像检查</span></span><br><span class="line">  <span class="comment"># docker.io/library/busybox:1.33.1  application/vnd.docker.distribution.manifest.list.v2+json sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d complete (2/2) 750.1 KiB/750.1 KiB true</span></span><br><span class="line">ctr -n k8s.io i tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2 k8s.gcr.io/pause:3.2         <span class="comment"># 镜像标记 Tag 更改</span></span><br><span class="line">ctr -n k8s.io i tag --force registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2 k8s.gcr.io/pause:3.2 <span class="comment"># 若新镜像 reference 已存在需要先删除新 reference 或者如下方式强制替换</span></span><br><span class="line">ctr -n k8s.io i label docker.io/library/busybox:1.33.1 name=weiyigeek-test  <span class="comment"># 设置镜像标签</span></span><br><span class="line">  <span class="comment"># io.cri-containerd.image=managed,name=weiyigeek-test</span></span><br><span class="line">ctr -n k8s.io i label docker.io/library/busybox:1.33.1 name=<span class="string">""</span>              <span class="comment"># 清除镜像标签</span></span><br><span class="line">  <span class="comment"># io.cri-containerd.image=managed</span></span><br><span class="line">ctr i mount docker.io/library/nginx:alpine /mnt <span class="comment"># 镜像挂载到主机目录 /mnt 中</span></span><br><span class="line">ctr i unmount /mnt <span class="comment"># 将镜像从主机目录上卸载</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) 镜像内容编辑,对镜像的更高级操作可以使用子命令 content.</span></span><br><span class="line"><span class="comment"># 在线编辑镜像的 blob 并生成一个新的 digest</span></span><br><span class="line">→ ctr content ls</span><br><span class="line">→ ctr content edit --editor vim sha256:fdd7fff110870339d34cf071ee90fbbe12bdbf3d1d9a14156995dfbdeccd7923</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) 容器查看及其操作</span></span><br><span class="line">ctr -n k8s.io container ls</span><br><span class="line">  <span class="comment"># CONTAINER                                                           IMAGE                                                            RUNTIME</span></span><br><span class="line">  <span class="comment"># 3d840c5cf157c322c1c0839d0166d80550fe49ca53544e1d589bd44f422b1f81    registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2    io.containerd.runc.v2</span></span><br><span class="line">ctr -n k8s.io container create docker.io/library/busybox:latest busybox                       <span class="comment"># 创建容器(并没有处于运行状态，只是一个静态的容器)</span></span><br><span class="line">ctr -n k8s.io container info 39d36ef08456bed24a52bf1c845facbd9f93c35cbd65b16739b4746ab1811cb5 <span class="comment"># 查看创建的容器详情（注意这个必须是完整的容器ID）和 docker inspect 类似</span></span><br><span class="line">ctr -n k8s.io container rm 39d36ef08456bed24a52bf1c845facbd9f93c35cbd65b16739b4746ab1811cb5   <span class="comment"># 删除容器</span></span><br><span class="line">ctr -n k8s.io container label busybox name=weiyigeek-test     <span class="comment"># 设置容器标签</span></span><br><span class="line">  <span class="comment"># io.containerd.image.config.stop-signal=SIGTERM,name=weiyigeek-test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5) 容器真正运行是由任务(Task)相关操作实现</span></span><br><span class="line">ctr -n k8s.io task start -d nginx  <span class="comment"># 启动容器</span></span><br><span class="line">ctr -n k8s.io tasks ls</span><br><span class="line">  <span class="comment"># TASK     PID      STATUS</span></span><br><span class="line">  <span class="comment"># nginx    12708    RUNNING</span></span><br><span class="line">ctr -n k8s.io task pause nginx     <span class="comment"># 暂停容器</span></span><br><span class="line">ctr -n k8s.io task resume nginx    <span class="comment"># 恢复容器</span></span><br><span class="line">ctr -n k8s.io task ps nginx        <span class="comment"># 查看容器中所有进程的 PID (宿主机中的PID)</span></span><br><span class="line">ctr -n k8s.io task <span class="built_in">exec</span> --<span class="built_in">exec</span>-id 0 -t nginx sh <span class="comment"># 进入容器,必须要指定唯一的--exec-id。</span></span><br><span class="line">ctr -n k8s.io tasks <span class="built_in">kill</span> -a -s 9 &#123;id&#125;  <span class="comment"># 停止容器内的Task</span></span><br><span class="line">ctr -n k8s.io task metric 37d0ff9d8df20d34c652ee286c17e0626d8838d6d546a28e8246151fffd99b98 <span class="comment"># 获取容器的 cgroup 信息，用于获取容器的内存、CPU 和 PID 的限额与使用量。</span></span><br><span class="line">  <span class="comment"># ID                                                                  TIMESTAMP</span></span><br><span class="line">  <span class="comment"># 37d0ff9d8df20d34c652ee286c17e0626d8838d6d546a28e8246151fffd99b98    2021-07-11 03:33:18.421996083 +0000 UTC</span></span><br><span class="line">  <span class="comment"># METRIC                   VALUE </span></span><br><span class="line">  <span class="comment"># memory.usage_in_bytes    65269760            </span></span><br><span class="line">  <span class="comment"># memory.limit_in_byte     9223372036854771712 </span></span><br><span class="line">  <span class="comment"># memory.stat.cache        4157440 </span></span><br><span class="line">  <span class="comment"># cpuacct.usage            44769155237                                                                                              </span></span><br><span class="line">  <span class="comment"># cpuacct.usage_percpu     [22375115908 22394039329 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</span></span><br><span class="line">  <span class="comment"># pids.current             43          </span></span><br><span class="line">  <span class="comment"># pids.limit               4582    </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6) 一步到位,直接进行容器创建并运行。</span></span><br><span class="line">ctr -n k8s.io run --null-io --net-host -d</span><br><span class="line">–env PASSWORD=<span class="variable">$drone_password</span></span><br><span class="line">–mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/etc,dst=/host-etc,options=rbind:rw</span><br><span class="line">–mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/root/.kube,dst=/root/.kube,options=rbind:rw</span><br><span class="line">-<span class="built_in">log</span>-uri file:///var/<span class="built_in">log</span>/xx.log</span><br><span class="line">WeiyiGeek:Test sysreport bash /sysreport/run.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7) 每一个顶级配置块的命名都是 plugins."io.containerd.xxx.vx.xxx" 这种形式，其实每一个顶级配置块都代表一个插件，其中 io.containerd.xxx.vx 表示插件的类型，vx 后面的 xxx 表示插件的 ID。</span></span><br><span class="line">ctr plugin ls</span><br><span class="line">  <span class="comment"># TYPE                            ID                    PLATFORMS      STATUS</span></span><br><span class="line">  <span class="comment"># io.containerd.content.v1        content               -              ok</span></span><br><span class="line">  <span class="comment"># io.containerd.snapshotter.v1    btrfs                 linux/amd64    error</span></span><br><span class="line">  <span class="comment"># io.containerd.snapshotter.v1    devmapper             linux/amd64    error</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8) 容器运行补充</span></span><br><span class="line">ctr run --null-io --net-host  -d --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/home/registry,dst=/var/lib/registry,options=rbind:rw  --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/home/registry/certs,dst=/certs,options=rbind:rw --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/home/registry/config.yml,dst=/etc/docker/registry/config.yml,options=rbind:rw  docker.io/library/registry:latest  registry-v2</span><br><span class="line"></span><br><span class="line">ctr -n default run --rm --net-host --env DOCKERHUB=docker.io \</span><br><span class="line">--mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/storage/dev/soft/kaniko/config,dst=/kaniko/.docker,options=rbind:ro \</span><br><span class="line">--mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/storage/dev/soft/kaniko/demo1,dst=/workspace,options=rbind:rw \</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/weiyigeek/kaniko-executor:latest kaniko-executor \</span><br><span class="line">/kaniko/executor --dockerfile=/workspace/dockerfile --context=dir://workspace --destination=docker.io/weiyigeek/busybox:1.35.0</span><br></pre></td></tr></table></figure></p>
<p>Tips: 注意容器默认使用fifo创建日志文件, 有可能因为fifo容量导致业务运行阻塞。<br>Tips: 注意需要停止容器时需要先停止容器内的Task再删除容器。<br>Tips: 注意ctr没有stop容器的功能，只能暂停或者杀死容器。<br>Tips: <code>Container 创建阶段</code>: 一个 container 对象只是包含了运行一个容器所需的资源及配置的数据结构，意味着 namespaces、rootfs 和容器的配置都已经初始化成功了，只是用户进程(这里是nginx)还没有启动。<br>Tips: <code>Container 运行阶段</code>: 一个容器真正的运行起来是由 Task 对象实现的，task 代表任务的意思，可以为容器设置网卡，还可以配置工具来对容器进行监控等。</p>
<p><br></p>
<h3 id="crictl-命令-Kubernetes-管理命令详解"><a href="#crictl-命令-Kubernetes-管理命令详解" class="headerlink" title="crictl 命令 - Kubernetes 管理命令详解"></a>crictl 命令 - Kubernetes 管理命令详解</h3><p>描述：crictl 是 CRI 兼容的容器运行时命令行对接客户端, 你可以使用它来检查和调试 Kubernetes 节点上的容器运行时和应用程序。由于该命令是为k8s通过CRI使用containerd而开发的(<code>主要是调试工具</code>), 其他非k8s的创建的 crictl 是无法看到和调试的, 简单的说用 <code>ctr run</code> 运行的容器无法使用 crictl 看到。</p>
<p>Tips: crictl 命令工具 和 它的源代码在 <a href="https://github.com/kubernetes-sigs/cri-tools" target="_blank" rel="noopener">cri-tools 代码库</a>。<br>Tips: crictl 默认使用命名空间 k8s.io.<br>Tips: cri plugin区别对待pod和container</p>
<p>官方参考: <a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md</a></p>
<p><br></p>
<p><strong>基础配置</strong><br>描述: 在 k8s 1.19.x 之前 crictl 默认连接到 <code>unix:///var/run/dockershim.sock</code>，而在1.20.x起默认采用 <code>/run/containerd/containerd.sock</code> 运行时,当然除此之外还是支持cri-o运行时。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crictl by default connects on Unix to:</span></span><br><span class="line">unix:///var/run/dockershim.sock or</span><br><span class="line">unix:///run/containerd/containerd.sock or</span><br><span class="line">unix:///run/crio/crio.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># or on Windows to:</span></span><br><span class="line">npipe:////./pipe/dockershim or</span><br><span class="line">npipe:////./pipe/containerd or</span><br><span class="line">npipe:////./pipe/crio</span><br><span class="line"></span><br><span class="line"><span class="comment"># For other runtimes, use:</span></span><br><span class="line">frakti: unix:///var/run/frakti.sock</span><br></pre></td></tr></table></figure></p>
<p>查看或编辑 /etc/crictl.yaml 的内容并设置指定的容器运行时runtime。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/crictl.yaml</span><br><span class="line">runtime-endpoint: <span class="string">"unix:///run/containerd/containerd.sock"</span></span><br><span class="line">image-endpoint: <span class="string">"unix:///run/containerd/containerd.sock"</span></span><br><span class="line">timeout: 0</span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line">pull-image-on-create: <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>Tips: 除了上面的设置端点外，我们还可以利用其它方式进行临时设置或者指定配置文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.通过在配置文件中设置端点并通过 --config 参数指定配置文件</span></span><br><span class="line">crictl --config=/etc/crictl-demo.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.通过设置参数 --runtime-endpoint 和 --image-endpoint</span></span><br><span class="line">crictl --runtime-endpoint=<span class="string">"unix:///run/containerd/containerd.sock"</span> --image-endpoint=<span class="string">"unix:///run/containerd/containerd.sock"</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>基础语法:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># USAGE:</span></span><br><span class="line">  crictl [global options] <span class="built_in">command</span> [<span class="built_in">command</span> options] [arguments...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># COMMANDS:</span></span><br><span class="line">  attach        Attach to a running container</span><br><span class="line">  create        Create a new container (创建容器这里需要先创建 sandbox, 获取sandbox容器的id后再用此id创建业务容器)</span><br><span class="line">  <span class="built_in">exec</span>          Run a <span class="built_in">command</span> <span class="keyword">in</span> a running container</span><br><span class="line">  version       Display runtime version information</span><br><span class="line">  images        List images</span><br><span class="line">  inspect       Display the status of one or more containers (显示一个或多个容器的状态)</span><br><span class="line">  inspecti      Return the status of one or more images (返回一个或者多个镜像的状态)</span><br><span class="line">  inspectp      Display the status of one or more pods (返回一个或者多个Pod的状态)</span><br><span class="line">  imagefsinfo: Return image filesystem info</span><br><span class="line">  logs          Fetch the logs of a container</span><br><span class="line">  port-forward  Forward <span class="built_in">local</span> port to a pod</span><br><span class="line">  ps            List containers (列出在 k8s.io 命名空间下的业务容器)</span><br><span class="line">  pull          Pull an image from a registry</span><br><span class="line">  runp          Run a new pod</span><br><span class="line">  rm            Remove one or more containers</span><br><span class="line">  rmi           Remove one or more images</span><br><span class="line">  rmp           Remove one or more pods</span><br><span class="line">  pods          List pods (列出在 k8s.io 命名空间下的 sandbox 容器, 在k8s里通常是pause容器)</span><br><span class="line">  start         Start one or more created containers</span><br><span class="line">  info          Display information of the container runtime</span><br><span class="line">  stop          Stop one or more running containers</span><br><span class="line">  stopp         Stop one or more running pods</span><br><span class="line">  update        Update one or more running containers</span><br><span class="line">  config        Get and <span class="built_in">set</span> crictl options</span><br><span class="line">  stats         List container(s) resource usage statistics</span><br><span class="line">  completion    Output bash shell completion code</span><br><span class="line">  <span class="built_in">help</span>, h       Shows a list of commands or <span class="built_in">help</span> <span class="keyword">for</span> one <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GLOBAL OPTIONS:</span></span><br><span class="line">  --config value, -c value            Location of the client config file (default: <span class="string">"/etc/crictl.yaml"</span>) [<span class="variable">$CRI_CONFIG_FILE</span>]</span><br><span class="line">  --debug, -D                         Enable debug mode</span><br><span class="line">  --image-endpoint value, -i value    Endpoint of CRI image manager service [<span class="variable">$IMAGE_SERVICE_ENDPOINT</span>]</span><br><span class="line">  --runtime-endpoint value, -r value  Endpoint of CRI container runtime service (default: <span class="string">"unix:///var/run/dockershim.sock"</span>) [<span class="variable">$CONTAINER_RUNTIME_ENDPOINT</span>]</span><br><span class="line">  --timeout value, -t value           Timeout of connecting to the server (default: 10s)</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>实践案例:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0) 镜像查看及其操作</span></span><br><span class="line">crictl images --digests</span><br><span class="line">  <span class="comment"># IMAGE                                                                         TAG                 DIGEST              IMAGE ID            SIZE</span></span><br><span class="line">  <span class="comment"># docker.io/calico/cni                                                          v3.18.4             278fd825d089e       021ecb3cb5348       44.7MB</span></span><br><span class="line">crictl images nginx   <span class="comment"># - 打印某个镜像</span></span><br><span class="line">crictl images -q      <span class="comment"># - 只打印镜像ID</span></span><br><span class="line">  <span class="comment"># sha256:8c811b4aec35f259572d0f79207bc0678df4c736eeec50bc9fec37ed936a472a</span></span><br><span class="line">crictl images -o [json|yaml|table]   <span class="comment"># - 镜像详细信息</span></span><br><span class="line">crictl inspecti busybox              <span class="comment"># - 查看镜像信息</span></span><br><span class="line">crictl pull busybox                  <span class="comment"># - 拉取 busybox 镜像</span></span><br><span class="line">crictl push weiyigeek.top/busybox    <span class="comment"># - 推送 busybox 镜像</span></span><br><span class="line">crictl rmi docker.io/library/busybox <span class="comment"># - 容器删除</span></span><br><span class="line">  <span class="comment"># Deleted: docker.io/library/busybox:1.33.1</span></span><br><span class="line">  <span class="comment"># Deleted: docker.io/library/busybox:latest</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) 容器查看及其操作</span></span><br><span class="line">crictl ps -a  <span class="comment"># - 打印在 k8s.io 命名空间下的业务容器</span></span><br><span class="line">crictl --runtime-endpoint /run/containerd/containerd.sock ps -a | grep kube | grep -v pause <span class="comment"># - 查看过滤指定的容器相关信息</span></span><br><span class="line">  <span class="comment"># CONTAINER ID        IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID</span></span><br><span class="line">  <span class="comment"># 8db74c2bf7595       ebc659140e762       3 days ago          Running             calico-node               0                   5af3d484b32c0</span></span><br><span class="line">crictl create f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f[创建的 Pod 的 ID] container-config.json pod-config.json <span class="comment"># - 创建容器</span></span><br><span class="line">crictl start 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60  <span class="comment"># - 启动容器</span></span><br><span class="line">crictl stop 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60   <span class="comment"># - 删除容器</span></span><br><span class="line">crictl <span class="built_in">exec</span> -i -t 1f73f2d81bf98 ls <span class="comment"># - 容器上执行命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) Pod查看与操作</span></span><br><span class="line">$ crictl pods</span><br><span class="line">  <span class="comment"># POD ID              CREATED             STATE               NAME                                   NAMESPACE           ATTEMPT</span></span><br><span class="line">  <span class="comment"># 5af3d484b32c0       4 days ago          Ready               calico-node-zvst7                      kube-system         0</span></span><br><span class="line">$ crictl pods --name nginx-65899c769f-wv2gp  <span class="comment"># - 打印某个固定pod.</span></span><br><span class="line">$ crictl pods --label run=nginx              <span class="comment"># - 根据标签筛选pod.</span></span><br><span class="line">$ crictl runp pod-config.json                <span class="comment"># - 使用 crictl runp 命令应用 JSON 文件并运行沙盒。</span></span><br><span class="line">$ crictl inspectp --output table <span class="variable">$POD_ID</span>     <span class="comment"># - 用crictl查看pod的信息</span></span><br><span class="line">$ crictl stopp <span class="variable">$POD_ID</span>  <span class="comment"># - 停止Pod</span></span><br><span class="line">$ crictl rmp  <span class="variable">$POD_ID</span>   <span class="comment"># - 删除Pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) 日志查看</span></span><br><span class="line">crictl --runtime-endpoint /run/containerd/containerd.sock logs --tail 50 8db74c2bf7595</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) 容器占用资源状态查看</span></span><br><span class="line">crictl stats</span><br><span class="line">  <span class="comment"># CONTAINER           CPU %               MEM                 DISK                INODES</span></span><br><span class="line">  <span class="comment"># 8db74c2bf7595       0.69                53.37MB             274.4kB             81</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5) 额外信息显示，例如版本及其显示有关 Containerd 和 CRI 插件的状态和配置信息</span></span><br><span class="line">crictl version</span><br><span class="line">  <span class="comment"># Version:  0.1.0</span></span><br><span class="line">  <span class="comment"># RuntimeName:  containerd</span></span><br><span class="line">  <span class="comment"># RuntimeVersion:  1.5.11</span></span><br><span class="line">  <span class="comment"># RuntimeApiVersion:  v1alpha2</span></span><br><span class="line">crictl info -o go-template --template <span class="string">"&#123;&#123;index .status&#125;&#125;"</span>  <span class="comment"># 格式化输出</span></span><br><span class="line">  <span class="comment"># map[conditions:[map[message: reason: status:true type:RuntimeReady] map[message: reason: status:true type:NetworkReady]]]</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : <code>crictl pods</code> 列出的是pod的信息，包括pod所在的命名空间以及状态。</p>
<p>Tips : <code>crictl ps</code> 列出的是应用容器的信息，而docker ps列出的是初始化容器（pause容器）和应用容器的信息，初始化容器在每个pod启动时都会创建，通常不会关注，从这一点上来说，crictl使用起来更简洁明了一些。</p>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171428.png" target="_blank" title="WeiyiGeek.pods与ps" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210724171428.png" alt="WeiyiGeek.pods与ps" title="" class=""></a>
                <p>WeiyiGeek.pods与ps</p>
            </figure>
<p><br/></p>
<p>Tips: 用 crictl 创建容器对容器运行时排错很有帮助。 在运行的 Kubernetes 集群中，沙盒会随机的被 kubelet 停止和删除, 下面通过实例进行演示crictl使用。</p>
<ul>
<li><p>Step 1.编写运行 Pod 沙盒的 JSON 文件，使用 crictl runp 命令应用 JSON 文件并运行沙盒。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat pod-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nginx-sandbox"</span>,</span><br><span class="line">        <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"attempt"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"hdishd83djaidwnduwk28bcsb"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"log_directory"</span>: <span class="string">"/tmp"</span>,</span><br><span class="line">    <span class="attr">"linux"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crictl runp pod-config.json</span><br><span class="line">f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.检查沙盒是否处于就绪状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crictl pods</span><br><span class="line">POD ID              CREATED             STATE               NAME                NAMESPACE           ATTEMPT</span><br><span class="line">f84dd361f8dc5       17 seconds ago      Ready               busybox-sandbox     default             1</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.使用运行时处理程序运行pod沙盒,运行时处理程序需要运行时支持。下面的示例显示如何在containerd运行时上使用runsc处理程序运行pod沙盒。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cat pod-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"nginx-runsc-sandbox"</span>,</span><br><span class="line">        <span class="string">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="string">"attempt"</span>: 1,</span><br><span class="line">        <span class="string">"uid"</span>: <span class="string">"hdishd83djaidwnduwk28bcsb"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"log_directory"</span>: <span class="string">"/tmp"</span>,</span><br><span class="line">    <span class="string">"linux"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crictl runp --runtime=runsc pod-config.json</span><br><span class="line">c112976cb6caa43a967293e2c62a2e0d9d8191d5109afef230f403411147548c</span><br><span class="line"></span><br><span class="line">$ crictl inspectp c112976cb6caa43a967293e2c62a2e0d9d8191d5109afef230f403411147548c</span><br><span class="line">...</span><br><span class="line">    <span class="string">"runtime"</span>: &#123;</span><br><span class="line">      <span class="string">"runtimeType"</span>: <span class="string">"io.containerd.runtime.v1.linux"</span>,</span><br><span class="line">      <span class="string">"runtimeEngine"</span>: <span class="string">"/usr/local/sbin/runsc"</span>,</span><br><span class="line">      <span class="string">"runtimeRoot"</span>: <span class="string">"/run/containerd/runsc"</span></span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Step 4.拉取 busybox 镜像然后在pod沙盒中使用config文件创建容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">crictl pull busybox:1.33.1</span><br><span class="line"> <span class="comment"># Image is up to date for sha256:69593048aa3acfee0f75f20b77acb549de2472063053f6730c4091b53f2dfb02</span></span><br><span class="line"></span><br><span class="line">$ cat pod-config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"metadata"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"nginx-sandbox"</span>,</span><br><span class="line">        <span class="string">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="string">"attempt"</span>: 1,</span><br><span class="line">        <span class="string">"uid"</span>: <span class="string">"hdishd83djaidwnduwk28bcsb"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"log_directory"</span>: <span class="string">"/tmp"</span>,</span><br><span class="line">    <span class="string">"linux"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat container-config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"busybox"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"image"</span>:&#123;</span><br><span class="line">      <span class="string">"image"</span>: <span class="string">"busybox:1.33.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"command"</span>: [</span><br><span class="line">      <span class="string">"top"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"log_path"</span>:<span class="string">"busybox.log"</span>,</span><br><span class="line">  <span class="string">"linux"</span>: &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crictl create f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f container-config.json pod-config.json</span><br><span class="line">3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.列出容器并检查容器是否处于已创建状并启动容器</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ crictl ps -a</span><br><span class="line">CONTAINER ID        IMAGE               CREATED             STATE               NAME                ATTEMPT</span><br><span class="line">3e025dd50a72d       busybox             32 seconds ago      Created             busybox             0</span><br><span class="line"></span><br><span class="line">$ crictl start 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60</span><br><span class="line">3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60</span><br><span class="line"></span><br><span class="line">$ crictl ps</span><br><span class="line">CONTAINER ID        IMAGE               CREATED              STATE               NAME                ATTEMPT</span><br><span class="line">3e025dd50a72d       busybox             About a minute ago   Running             busybox             0</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Step 6.在容器中执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crictl <span class="built_in">exec</span> -i -t 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60 ls</span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 7.显示容器的统计信息</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crictl stats</span><br><span class="line">CONTAINER           CPU %               MEM                 DISK              INODES</span><br><span class="line">3e025dd50a72d       0.00                983kB             16.38kB             6</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Containerd-跟-Docker-的区别说明"><a href="#Containerd-跟-Docker-的区别说明" class="headerlink" title="Containerd 跟 Docker 的区别说明"></a>Containerd 跟 Docker 的区别说明</h3><p>Docker 对容器的管理和操作基本都是通过 containerd 完成的，只是相当对于对其进行了封装，提供一些非常简单的命令进行管理容器生命周期。 </p>
<p>Containerd 是一个工业级标准的容器运行时，它强调简单性、健壮性和可移植性，主要在宿主机中管理完整的容器生命周期：容器镜像的传输和存储、容器的执行和管理、存储和网络等。</p>
<p><strong>Kubernetes 调用链对比</strong></p>
<p>在Kubenetes 1.19.x 与 Kubernetes 1.20.x 版本针对runtime分别使用docker、Container的调用链关系。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Runtime = docker 时的调用链</span></span><br><span class="line">Kubelet -&gt; Dockerd -&gt; Containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Runtime = containerd 时的调用链</span></span><br><span class="line">Kubelet -&gt; Containerd</span><br></pre></td></tr></table></figure></p>
<p>命令对比：containerd不支持docker API和docker CLI， 但是可以通过cri-tool实现类似的功能。</p>
<table>
<thead>
<tr>
<th>镜像相关功能</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>显示本地镜像列表</td>
<td>docker images</td>
<td>crictl images</td>
</tr>
<tr>
<td>下载镜像</td>
<td>docker pull</td>
<td>crictl pull</td>
</tr>
<tr>
<td>上传镜像</td>
<td>docker push</td>
<td>无</td>
</tr>
<tr>
<td>删除本地镜像</td>
<td>docker rmi</td>
<td>crictl rmi</td>
</tr>
<tr>
<td>查看镜像详情</td>
<td>docker inspect</td>
<td>crictl inspecti</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>容器相关功能</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>显示容器列表</td>
<td>docker ps</td>
<td>crictl ps</td>
</tr>
<tr>
<td>创建容器</td>
<td>docker create</td>
<td>crictl create</td>
</tr>
<tr>
<td>启动容器</td>
<td>docker start</td>
<td>crictl start</td>
</tr>
<tr>
<td>停止容器</td>
<td>docker stop</td>
<td>crictl stop</td>
</tr>
<tr>
<td>删除容器</td>
<td>docker rm</td>
<td>crictl rm</td>
</tr>
<tr>
<td>查看容器详情</td>
<td>docker  inspect</td>
<td>crictl  inspect</td>
</tr>
<tr>
<td>attach</td>
<td>docker attach</td>
<td>crictl attach</td>
</tr>
<tr>
<td>exec</td>
<td>docker exec</td>
<td>crictl exec</td>
</tr>
<tr>
<td>logs</td>
<td>docker logs</td>
<td>crictl logs</td>
</tr>
<tr>
<td>stats</td>
<td>docker stats</td>
<td>crictl stats</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>POD相关功能</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>显示POD列表</td>
<td>无</td>
<td>crictl pods</td>
</tr>
<tr>
<td>查看POD详情</td>
<td>无</td>
<td>crictl  inspectp</td>
</tr>
<tr>
<td>运行POD</td>
<td>无</td>
<td>crictl runp</td>
</tr>
<tr>
<td>停止POD</td>
<td>无</td>
<td>crictl stopp</td>
</tr>
</tbody>
</table>
<p><strong>配置参数对比</strong>: </p>
<ul>
<li>日志配置参数区别</li>
</ul>
<table>
<thead>
<tr>
<th>对比项</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>存储路径</td>
<td>docker作为k8s容器运行时的情况下，容器日志的落盘由docker来完成， 保存在类似<code>/var/lib/docker/containers/CONTAINERID</code> 目录下。kubelet会在<code>/var/log/pods和/var/log/containers</code>下面建立软链接，指向<code>/var/lib/docker/containers/CONTAINERID</code>目录下的容器日志文件</td>
<td>containerd作为k8s容器运行时的情况下， 容器日志的落盘由kubelet来完成，保存到<code>/var/log/pods/$CONTAINER_NAME</code>目录下，同时在/var/log/containers目录下创建软链接，指向日志文件</td>
</tr>
<tr>
<td>配置参数</td>
<td>在docker配置文件中指定<code>：&quot;log-driver&quot;: &quot;json-file&quot;, &quot;log-opts&quot;: {&quot;max-size&quot;: &quot;100m&quot;,&quot;max-file&quot;: &quot;5&quot;}</code></td>
<td>方法一：在kubelet参数中指定： <code>--container-log-max-files=5 --container-log-max-size=&quot;100Mi&quot;</code> <br/> 方法二：在KubeletConfiguration中指定：<code>&quot;containerLogMaxSize&quot;: &quot;100Mi&quot;,&quot;containerLogMaxFiles&quot;: 5</code></td>
</tr>
<tr>
<td>容器日志保存到数据盘</td>
<td>把数据盘挂载到<code>&quot;data-root&quot;</code>(缺省是<code>/var/lib/docker</code>)即可</td>
<td>创建一个软链接<code>/var/log/pods</code>指向数据盘挂载点下的某个目录在TKE中选择”将容器和镜像存储在数据盘”会自动创建软链接<code>/var/log/pods</code></td>
</tr>
</tbody>
</table>
<ul>
<li>stream server 区别: 执行 kubectl exec/logs 等命令需要在apiserver跟容器运行时之间建立流转发通道。<br>Docker API本身提供stream服务，kubelet 内部的 docker-shim 会通过 docker API做流转发, containerd 的stream服务需要单独配置。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[plugins.cri]</span><br><span class="line">  stream_server_address = <span class="string">"127.0.0.1"</span></span><br><span class="line">  stream_server_port = <span class="string">"0"</span></span><br><span class="line">  enable_tls_streaming = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
Tips: 从k8s1.11引入了 <code>kubelet stream proxy</code> <code>(https://github.com/kubernetes/kubernetes/pull/64006)</code>, 从而使得<code>containerd stream server</code>只需要监听本地地址即可。</li>
</ul>
<ul>
<li>CNI 网络区别</li>
</ul>
<table>
<thead>
<tr>
<th>对比项</th>
<th>docker</th>
<th>containerd</th>
</tr>
</thead>
<tbody>
<tr>
<td>谁负责调用CNI</td>
<td>kubelet内部的docker-shim</td>
<td>containerd内置的cri-plugin(containerd 1.1以后)</td>
</tr>
<tr>
<td>如何配置CNI</td>
<td>kubelet参数 –cni-bin-dir 和 –cni-conf-dir</td>
<td>containerd配置文件(toml)：plugins.cri.cni  <br/>bin_dir = “/opt/cni/bin”   <br/>  conf_dir = “/etc/cni/net.d”</td>
</tr>
</tbody>
</table>
<ul>
<li>名称空间（Namespace）:<br>Docker没有namespace名称空间，而Containerd是支持namespaces的，对于上层编排系统的支持，主要区分了3个命名空间分别是k8s.io、moby和default，以上我们用crictl操作的均在k8s.io命名空间完成如查看镜像列表就需要加上-n参数 .</li>
</ul>
<figure class="image-box">
                <a rel=1.Containerd容器运行时初识与尝试 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211215112553.png" target="_blank" title="WeiyiGeek.Containerd Namespace" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211215112553.png" alt="WeiyiGeek.Containerd Namespace" title="" class=""></a>
                <p>WeiyiGeek.Containerd Namespace</p>
            </figure>

        </div>
        
  <hr>
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>

  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注，转个发】(人间五大情)</b>，这将对我的肯定，谢谢！。</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="扫描Visit(浏览)极客全栈修炼小程序"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-09-08T07:25:18.393Z" itemprop="dateUpdated">2022-09-08 15:25:18</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/虚拟云容/云容器/Containerd/1.基于Containerd容器运行时初识与尝试.md" target="_blank" rel="noopener noreferrer">_posts/虚拟云容/云容器/Containerd/1.基于Containerd容器运行时初识与尝试.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2021/6-27-570.html" target="_blank" rel="external">https://blog.weiyigeek.top/2021/6-27-570.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">👍 钟意作者</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Containerd/" rel="tag">Containerd</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=《1.Containerd容器运行时初识与尝试》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=《1.Containerd容器运行时初识与尝试》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《1.Containerd容器运行时初识与尝试》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/6-27-570.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/6-29-571.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">2.基于Containerd运行时搭建Kubernetes多控制平面集群实践</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/6-17-562.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">KVM学习入坑与出坑</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-基础介绍"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.基础介绍</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-专业术语"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.专业术语</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-架构简述"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.架构简述</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#CRI-的架构"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">CRI 的架构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Containerd-的架构"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">Containerd 的架构</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-安装配置"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 安装配置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Ubuntu安装Containerd-io流程"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.Ubuntu安装Containerd.io流程</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-Containerd-简单尝试使用"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 Containerd 简单尝试使用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-镜像拉取与运行"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.镜像拉取与运行</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-创建和使用网络"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.创建和使用网络</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-与宿主机和其它容器共享文件"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.与宿主机和其它容器共享文件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-Docker-与-Containerd-并用配置"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.Docker 与 Containerd 并用配置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-镜像加速配置"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">5.镜像加速配置</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-Containerd-与-Docker-CLI-工具命令表"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 Containerd 与 Docker CLI 工具命令表</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ctr-命令-Containerd-管理命令详细"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">ctr 命令 - Containerd 管理命令详细</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#crictl-命令-Kubernetes-管理命令详解"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">crictl 命令 - Kubernetes 管理命令详解</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Containerd-跟-Docker-的区别说明"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Containerd 跟 Docker 的区别说明</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，还请支持一下博主哟, 谢谢各位看友♥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="228" height="228" alt="打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="228" height="228" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- 微信公众号关注/文章版权复制 -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">个人Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">个人Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">个人知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云+云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved. IT唯一极客 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=《1.Containerd容器运行时初识与尝试》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/6-27-570.html&title=《1.Containerd容器运行时初识与尝试》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《1.Containerd容器运行时初识与尝试》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/6-27-570.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/6-27-570.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJklEQVR42u3ay24CMQwFUP7/p6nUVSU0w7U9g0pyskJAQ84s3PjxeMTr+bv+vn5dr58e7ZOsxx0LAwPjaxnJdvlBj/Y8+vRo//xsGBgY+zCSIHt+3ISUx8z8bBgYGBjnP5AH6OqjwcDAwJgE3BxTTXo/+n8DAwPjCxmTItr5D5y/0wvrGBgYuzF6jYHPvL69v4GBgfHvGc/BuqO32DwJBgbG0ozqtW9y0DzprTYJMDAwdmMkKWU1ia1+p4fEwMBYm1Hdotf4zMNx9VcwMDB2YOSJZe8CNx8vi0I/BgbGNoxeeL2vDdDsxGJgYCzKyENkcrHLH011tOJNYwADA2M5RnX8az7yNQnZh3+FgYGxJSMPiMlVMtl/lAxjYGAszegVvJJBirycNx/pwMDAWJuRHKXXKqheKxPqmyCLgYGxJaM3DJGnoPP3MTAwdmAk5fjJZbHahqyOhR1m5BgYGAsxJonoJFlNAmvSwizccDEwML6W0Su09ZLSPE2tfhMDA2MfxlVJbFK265XhCkU3DAyMRRm96+CkSXnVw8LAwNiBUQ2gyQWxmo4mpf/8sWJgYKzEeBZXtRBWLec102YMDIylGflKjptcH3skDAwMjF75/uK0Mx5Na46FYWBgLMFIgmxv2CvZrfe4MTAwMJKAm5fbksGOUSMTAwMDI25hXttOSH4FAwNjH0beDKjCes2Aco0QAwNjaUavllVtMU7GLMozIxgYGOswfgAO/CLgbOJ00QAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
