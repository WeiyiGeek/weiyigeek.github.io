<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="k8s">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-09-27T10:37:47.000Z" itemprop="datePublished" class="page-time">
  2020-09-27
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/10-kubernetesè¿›é˜¶ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-09-27 18:37:47" datetime="2020-09-27T10:37:47.000Z"  itemprop="datePublished">2020-09-27</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-å‰è¨€ç®€è¿°"><a href="#0x00-å‰è¨€ç®€è¿°" class="headerlink" title="0x00 å‰è¨€ç®€è¿°"></a>0x00 å‰è¨€ç®€è¿°</h2><h3 id="åŸºç¡€ç®€è¿°"><a href="#åŸºç¡€ç®€è¿°" class="headerlink" title="åŸºç¡€ç®€è¿°"></a>åŸºç¡€ç®€è¿°</h3><p>åœ¨å‰é¢çš„ç« èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»è¿‡Podæ˜¯K8sè¿›è¡Œåˆ›å»ºã€è°ƒåº¦ç®¡ç†çš„æœ€å°å•ä½ï¼Œåœ¨åŒä¸€ä¸ªPodå†…çš„Containerä¸ä¼šå®ä¸»æœºï¼Œæ¯ä¸ªPodéƒ½æœ‰ç‹¬ç«‹çš„Pod IP (<code>IP per Pod</code>)å¹¶ä¸”è¯¥PodåŒ…å«çš„æ‰€æœ‰å®¹å™¨å…±äº«ä¸€ä¸ªç½‘ç»œåè®®æ ˆ(æˆ–è€…ç½‘ç»œåç§°ç©ºé—´), ä¾‹å¦‚å®¹å™¨ä¹‹é—´é€šè¿‡localhost+portå¯ä»¥è¿›è¡Œç›¸äº’è®¿é—®ã€‚å³é›†ç¾¤ä¸­çš„æ‰€æœ‰Podéƒ½å¤„äºä¸€ä¸ªæ‰å¹³äº’é€šçš„ç½‘ç»œç©ºé—´ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pod --all-namespaces -o json | jq <span class="string">'.items[] | select(.metadata.name=="kubernetes-dashboard-7448ffc97b-sd9bt")'</span> | jq .status.podIP</span><br><span class="line"><span class="string">"172.16.182.203"</span></span><br><span class="line"></span><br><span class="line">~$ kubectl get endpoints --all-namespaces</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper        172.16.24.198:8000                                                       59d</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard             172.16.182.203:8443                                                      59d</span><br></pre></td></tr></table></figure></p>
<p>Tips: åœ¨Dockerä¸­æˆ‘ä»¬ä½¿ç”¨<code>Docker Bridge</code>æ¨¡å‹å®ç°æœåŠ¡çš„è·¨èŠ‚ç‚¹è®¿é—®,è€Œåœ¨æˆ‘ä»¬çš„Kubernetsä¸­åˆ™é‡‡ç”¨ä¸€ä¸ªæ›´ä¼˜çš„<code>IP-Per-Pod</code>æ¨¡å‹;</p>
<p><br></p>
<p><strong>Linuxç½‘ç»œåè¯è§£é‡Š</strong></p>
<ul>
<li><p>ç½‘ç»œçš„å‘½åç©ºé—´ï¼šLinuxåœ¨ç½‘ç»œæ ˆä¸­å¼•å…¥ç½‘ç»œå‘½åç©ºé—´ï¼Œå°†ç‹¬ç«‹çš„ç½‘ç»œåè®®æ ˆéš”ç¦»åˆ°ä¸åŒçš„å‘½ä»¤ç©ºé—´ä¸­ï¼Œå½¼æ­¤é—´æ— æ³•é€šä¿¡ï¼›Dockeråˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œå®ç°ä¸åŒå®¹å™¨é—´çš„ç½‘ç»œéš”ç¦»ã€‚</p>
</li>
<li><p>Vethè®¾å¤‡å¯¹ï¼šVethè®¾å¤‡å¯¹çš„å¼•å…¥æ˜¯ä¸ºäº†å®ç°åœ¨ä¸åŒç½‘ç»œå‘½åç©ºé—´çš„é€šä¿¡ã€‚</p>
</li>
<li><p>Iptables/Netfilterï¼šNetfilterè´Ÿè´£åœ¨å†…æ ¸ä¸­æ‰§è¡Œå„ç§æŒ‚æ¥çš„è§„åˆ™ï¼ˆè¿‡æ»¤ã€ä¿®æ”¹ã€ä¸¢å¼ƒç­‰ï¼‰ï¼Œè¿è¡Œåœ¨å†…æ ¸æ¨¡å¼ä¸­ï¼›Iptablesæ¨¡å¼æ˜¯åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œçš„è¿›ç¨‹ï¼Œè´Ÿè´£ååŠ©ç»´æŠ¤å†…æ ¸ä¸­Netfilterçš„å„ç§è§„åˆ™è¡¨ï¼›é€šè¿‡äºŒè€…çš„é…åˆæ¥å®ç°æ•´ä¸ªLinuxç½‘ç»œåè®®æ ˆä¸­çµæ´»çš„æ•°æ®åŒ…å¤„ç†æœºåˆ¶ã€‚</p>
</li>
<li><p>ç½‘æ¡¥ï¼šç½‘æ¡¥æ˜¯ä¸€ä¸ªäºŒå±‚ç½‘ç»œè®¾å¤‡ï¼Œé€šè¿‡ç½‘æ¡¥å¯ä»¥å°†Linuxæ”¯æŒçš„ä¸åŒçš„ç«¯å£è¿æ¥èµ·æ¥ï¼Œå¹¶å®ç°ç±»ä¼¼äº¤æ¢æœºé‚£æ ·çš„å¤šå¯¹å¤šçš„é€šä¿¡ã€‚</p>
</li>
<li><p>è·¯ç”±ï¼šLinuxç³»ç»ŸåŒ…å«ä¸€ä¸ªå®Œæ•´çš„è·¯ç”±åŠŸèƒ½ï¼Œå½“IPå±‚åœ¨å¤„ç†æ•°æ®å‘é€æˆ–è½¬å‘çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨è·¯ç”±è¡¨æ¥å†³å®šå‘å¾€å“ªé‡Œã€‚</p>
</li>
</ul>
<p><br/></p>
<h3 id="æ¨¡å‹æ ‡å‡†"><a href="#æ¨¡å‹æ ‡å‡†" class="headerlink" title="æ¨¡å‹æ ‡å‡†"></a>æ¨¡å‹æ ‡å‡†</h3><p>æè¿°: å®¹å™¨ç½‘ç»œå‘å±•çš„ä¸¤å¤§é˜µè¥å³Dockerçš„CNMå®¹å™¨ç½‘ç»œæ¨¡å‹(åŸç”Ÿ)å’ŒCoreOSã€Googleã€K8sä¸»å¯¼çš„CNIå®¹å™¨ç½‘ç»œæ¥å£æ¨¡å‹(ç½‘ç»œç®¡ç†æ’ä»¶)ï¼Œä»–ä»¬ä¸»è¦çš„ä½œç”¨æ˜¯è¿›è¡Œç½‘ç»œç®¡ç†ã€‚å³ä»æ¶æ„è§’åº¦æ¥çœ‹ä»–ä»¬æ˜¯<code>ç½‘ç»œè§„èŒƒå’Œç½‘ç»œä½“ç³»</code>,è€Œä»ç ”å‘çš„è§’åº¦ä»–ä»¬å°±æ˜¯ä¸€å †æ¥å£ã€‚</p>
<p><strong>CNM ä»‹ç»</strong><br>å®ƒæ˜¯ Docker Libnetwork Container Network Model çš„ç®€ç§°(<code>Libnetwork æ˜¯ CNM æ ‡å‡†çš„å®ç°</code>) Libnetwork æä¾› Docker å®ˆæŠ¤ç¨‹åºå’Œç½‘ç»œé©±åŠ¨ç¨‹åºä¹‹é—´çš„æ¥å£ã€‚ç½‘ç»œæ§åˆ¶å™¨è´Ÿè´£å°†é©±åŠ¨ç¨‹åºä¸ç½‘ç»œé…å¯¹ã€‚æ¯ä¸ªé©±åŠ¨ç¨‹åºè´Ÿè´£ç®¡ç†å…¶æ‹¥æœ‰çš„ç½‘ç»œï¼ŒåŒ…æ‹¬æä¾›ç»™è¯¥ç½‘ç»œçš„æœåŠ¡ã€‚æ¯ä¸ªç½‘ç»œæœ‰ä¸€ä¸ªé©±åŠ¨ç¨‹åºï¼Œå¤šä¸ªé©±åŠ¨ç¨‹åºå¯ä»¥ä¸è¿æ¥åˆ°å¤šä¸ªç½‘ç»œçš„å®¹å™¨åŒæ—¶ä½¿ç”¨ã€‚</p>
<p>ä¼˜ç‚¹: Docker åŸç”Ÿæ‰€ä»¥å’ŒDockerå®¹å™¨ç”Ÿå‘½å‘¨æœŸç»“åˆç´§å¯†ã€‚<br>ç¼ºç‚¹: Docker åŸç”Ÿæ‰€ä»¥è¢«Dockerç»‘æ¶äº†æ²¡ä»–ä¸è¡Œã€‚<br>å®ç°æ’ä»¶: Docker Swarm Overlay ã€Macvalnã€ Calicoã€ Contivã€ Weave</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313232313.png" target="_blank" title="WeiyiGeek.CNM" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313232313.png" alt="WeiyiGeek.CNM" title="" class=""></a>
                <p>WeiyiGeek.CNM</p>
            </figure>
<p><br></p>
<p><strong>CNI ä»‹ç»</strong><br>å®ƒæ˜¯ Container Network Interface çš„ç®€è¿°(<code>CNCF çš„æ­£å¼é¡¹ç›®</code>); ç”¨äºç¼–å†™æ’ä»¶ä»¥é…ç½® Linux å®¹å™¨ä¸­çš„ç½‘ç»œæ¥å£ã€‚CNI ä»…å…³æ³¨å®¹å™¨çš„ç½‘ç»œè¿æ¥å¹¶åœ¨åˆ é™¤å®¹å™¨çš„åŒæ—¶åˆ é™¤åˆ†é…çš„èµ„æº<br>ä¼˜ç‚¹: æä¾›äº†å¹¿æ³›çš„æ”¯æŒï¼Œå¹¶ä¸”è§„èŒƒæ˜“äºå®ç°ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹æ’ä»¶ã€‚ ç®€å•çš„è¯´å…¼å®¹å…¶å®ƒå®¹å™¨æŠ€æœ¯(Podman)ä»¥åŠä¸Šå±‚ç¼–æ’ç³»ç»Ÿ(Kubernetes &amp; Mesosç­‰)å¹¶ä¸”ç¤¾åŒºæ´»è·ƒåº¦é«˜(CoreOSä¸»æ¨);<br>ç¼ºç‚¹: éDockeråŸç”Ÿä¸Dockerå®¹å™¨æ²¡é‚£ä¹ˆç´§å¯†ã€‚</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313232442.png" target="_blank" title="WeiyiGeek.CNI" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313232442.png" alt="WeiyiGeek.CNI" title="" class=""></a>
                <p>WeiyiGeek.CNI</p>
            </figure>
<p>å¸¸è§çš„ CNI ç½‘ç»œæ’ä»¶æœ‰ï¼š</p>
<ul>
<li><p>Calicoï¼ˆæ€§èƒ½å¥½ã€çµæ´»æ€§æœ€å¼ºï¼Œç›®å‰çš„ä¼ä¸šçº§ä¸»æµï¼‰ï¼šæ˜¯ä¸€ä¸ª<code>åŸºäº BGP è·¯ç”±åè®®</code>çš„çº¯ L3 çš„æ•°æ®ä¸­å¿ƒç½‘ç»œæ–¹æ¡ˆï¼ˆä¸éœ€è¦ Overlayï¼‰ï¼Œæä¾›ç®€å•ï¼Œå¯æ‰©å±•çš„ç½‘ç»œã€‚é™¤äº†å¯æ‰©å±•çš„ç½‘ç»œï¼Œ Calico è¿˜æä¾›ç­–ç•¥éš”ç¦»ã€‚</p>
</li>
<li><p>Flannelï¼ˆæœ€æˆç†Ÿã€æœ€ç®€å•çš„é€‰æ‹©ï¼‰ï¼šåŸºäº Linux TUN/TAPï¼Œ<code>ä½¿ç”¨ UDP å°è£… IP æ•°æ®åŒ…</code>çš„æ–¹å¼æ¥åˆ›å»º Overlay ç½‘ç»œï¼Œå¹¶å€ŸåŠ© etcd æ¥ç»´æŠ¤ç½‘ç»œèµ„æºçš„åˆ†é…æƒ…å†µï¼Œæ˜¯ä¸€ç§ç®€å•æ˜“ç”¨çš„ Overlay ç½‘ç»œæ–¹æ¡ˆã€‚</p>
</li>
<li><p>Weave Netï¼šæ”¯æŒå¤šä¸»æœºå®¹å™¨ç½‘ç»œå¯ä»¥è·¨è¶Šä¸åŒçš„<code>äº‘ç½‘ç»œé…ç½®</code>ã€‚ç‹¬æœ‰çš„åŠŸèƒ½ï¼Œæ˜¯å¯¹æ•´ä¸ªç½‘ç»œçš„ç®€å•åŠ å¯†ï¼Œä¼šå¢åŠ ç½‘ç»œå¼€é”€ã€‚</p>
</li>
<li><p>Ciliumï¼šæ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼ŒåŸºäº Linux Kernel BPF æŠ€æœ¯ï¼Œå¯ä»¥åœ¨ Linux Kernel å†…éƒ¨åŠ¨æ€åœ°æ’å…¥å…·æœ‰å®‰å…¨æ€§ã€å¯è§æ€§çš„ç½‘ç»œæ§åˆ¶é€»è¾‘ã€‚</p>
</li>
<li><p>kopeio-networkingï¼šæ˜¯ä¸“ä¸º Kubernetes è€Œè®¾è®¡çš„ç½‘ç»œæ–¹æ¡ˆï¼Œå……åˆ†åˆ©ç”¨äº† Kubernetes APIï¼Œå› æ­¤æ›´ç®€å•æ›´å¯é ã€‚</p>
</li>
<li><p>kube-routerï¼šæ˜¯ä¸“ä¸º Kubernetes æ‰“é€ çš„ä¸“ç”¨ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨æä¾›æ“ä½œç®€å•æ€§å’Œæ€§èƒ½ã€‚</p>
</li>
</ul>
<p>CNI æ’ä»¶é¡¹ç›® Forks æ•°é‡æ¯”è¾ƒï¼š<br><figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313233227.png" target="_blank" title="WeiyiGeek.å¸‚åœºå æœ‰ç‡" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313233227.png" alt="WeiyiGeek.å¸‚åœºå æœ‰ç‡" title="" class=""></a>
                <p>WeiyiGeek.å¸‚åœºå æœ‰ç‡</p>
            </figure></p>
<p>Tips : CNI æ’ä»¶é¡¹ç›® 10Gbit ç½‘ç»œä¸‹çš„ CPU æ¶ˆè€—æ¯”è¾ƒ <code>Calico &lt; Cilium &lt; Flannel &lt; kube-router &lt; Weave Net</code></p>
<hr>
<h2 id="0x01-ç½‘ç»œæ¨¡å‹"><a href="#0x01-ç½‘ç»œæ¨¡å‹" class="headerlink" title="0x01 ç½‘ç»œæ¨¡å‹"></a>0x01 ç½‘ç»œæ¨¡å‹</h2><p>æè¿°: åœ¨è¿›è¡Œç½‘ç»œæ¨¡å‹çš„è®²è§£ä¹‹å‰å…ˆæ¥çœ‹çœ‹åŸºç¡€ç½‘ç»œæ¨¡å‹;</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313233740.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313233740.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><strong>Kubernetes ç½‘ç»œä¸­æ¶‰åŠä»¥ä¸‹å‡ ç§ç±»å‹çš„åœ°å€ï¼š</strong></p>
<ul>
<li>Node IPï¼šå®¿ä¸»æœº IP åœ°å€ã€‚</li>
<li>Pod IPï¼šPod æ˜¯ Kubernetes çš„æœ€å°éƒ¨ç½²å•å…ƒï¼ŒPod ä¸‹å¯ä»¥åŒ…å«è‹¥å¹²ä¸ª Containersï¼Œä½†æ˜¯ Container æ²¡æœ‰ç‹¬ç«‹çš„ IP åœ°å€ï¼Œå®ƒä»¬å…±äº« Pod çš„ IP åœ°å€å’Œ Ports åŒºé—´ã€‚</li>
<li>Cluster IPï¼šè¿™é‡Œæ‰€è¿° Cluster å¹¶é Kubernetes Clusterï¼Œè€Œæ˜¯ Kubernetes Service çš„ IP åœ°å€ã€‚å¤–éƒ¨ç½‘ç»œæ˜¯æ— æ³•è®¿é—®è¯¥åœ°å€çš„ï¼Œåªæœ‰ Kubernetes Cluster å†…éƒ¨æ‰èƒ½è®¿é—®ã€‚å› ä¸º Cluster IP æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ IP åœ°å€ï¼Œå³ï¼šæ²¡æœ‰ç½‘ç»œè®¾å¤‡ä¸ºè¿™ä¸ª IP åœ°å€è´Ÿè´£ã€‚åœ¨ Kubernetes å†…éƒ¨ä½¿ç”¨äº† IPtables è§„åˆ™æ¥é‡å®šå‘åˆ°å…¶æœ¬åœ°ç«¯å£ï¼Œå†å‡è¡¡åˆ°åç«¯çš„ Podsï¼›</li>
<li>Public IPï¼šå› ä¸º Cluster IP èƒ½åœ¨ Kubernetes Cluster Internal è®¿é—®ï¼Œå±äºåº”ç”¨ç¨‹åºå†…éƒ¨çš„å±‚çº§ã€‚å¦‚æœå¸Œæœ›å°†è¿™ä¸ª Service ä¸º Kubernetes Cluster External çš„å®¢æˆ·ç«¯æä¾›è®¿é—®å°±éœ€è¦ä¸ºè¿™ä¸ª Service æä¾›ä¸€ä¸ª Public IPã€‚</li>
</ul>
<h3 id="ç½‘ç»œå®ç°"><a href="#ç½‘ç»œå®ç°" class="headerlink" title="ç½‘ç»œå®ç°"></a>ç½‘ç»œå®ç°</h3><p>æè¿°: æ ¹æ®ä¸šåŠ¡å’Œéœ€æ±‚çš„ä¸åŒk8såœ¨è¿›è¡Œç½‘ç»œè®¾è®¡æ—¶ä¸»è¦è€ƒè™‘äº†ä¸‹é¢å‡ ç§é€šä¿¡åœºæ™¯</p>
<ul>
<li>1) Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡</li>
<li>2) åŒä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆHost Virtual Network æ¨¡å¼ï¼‰</li>
<li>3) è·¨ä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆSDN æ¨¡å¼ï¼‰</li>
<li>4) é›†ç¾¤ä¸­ Service ä¸ Pod é—´çš„é€šä¿¡</li>
<li>5) é›†ç¾¤ä¸­ å„å†…å¤–ç»„ä»¶é—´çš„é€šä¿¡</li>
</ul>
<p><br/></p>
<h4 id="1-Pod-å†…éƒ¨çš„-Containers-é—´çš„é€šä¿¡"><a href="#1-Pod-å†…éƒ¨çš„-Containers-é—´çš„é€šä¿¡" class="headerlink" title="(1) Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡"></a>(1) Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡</h4><p>æè¿°: Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡<code>ï¼ˆContainer æ¨¡å¼ï¼‰</code>ï¼ŒPod å†…éƒ¨çš„ Containers é€šè¿‡ localhost è¿›è¡Œé€šä¿¡ï¼Œå®ƒä»¬ä½¿ç”¨äº†åŒä¸€ä¸ª Network Namespaceã€‚å¯¹ Container è€Œè¨€hostname å°±æ˜¯ Pod çš„åç§°ã€‚</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313235045.png" target="_blank" title="WeiyiGeek.Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313235045.png" alt="WeiyiGeek.Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡" title="" class=""></a>
                <p>WeiyiGeek.Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡</p>
            </figure>
<p>Pod å†…éƒ¨çš„ Containers å…±äº«åŒä¸€ä¸ª IP åœ°å€å’Œç«¯å£åŒºé—´ï¼Œæ‰€ä»¥è¦ä¸ºæ¯ä¸ªå¯ä»¥å»ºç«‹è¿æ¥çš„ Container åˆ†é…ä¸åŒçš„ Port å·ã€‚ä¹Ÿå°±æ˜¯è¯´Pod ä¸­çš„ â€œåº”ç”¨â€ éœ€è¦è‡ªå·±åè°ƒç«¯å£å·çš„åˆ†é…å’Œä½¿ç”¨ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šåˆ›å»ºä¸€ä¸ª Pod åŒ…å«ä¸¤ä¸ª Containers åŒä¸€ä¸ª Pod ä¸‹å±çš„ä¸¤ä¸ª Containers ä¸èƒ½å æœ‰åŒä¸€ä¸ª Port å·ï¼Œå› ä¸º Port åŒºé—´ä¹Ÿæ˜¯å…±äº«çš„ã€‚</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313234705.png" target="_blank" title="WeiyiGeek.Containerså…±äº«ç½‘ç»œæ ˆ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313234705.png" alt="WeiyiGeek.Containerså…±äº«ç½‘ç»œæ ˆ" title="" class=""></a>
                <p>WeiyiGeek.Containerså…±äº«ç½‘ç»œæ ˆ</p>
            </figure>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å°† Pod ç†è§£ä¸ºä¸€ä¸ªå°å‹çš„ â€œæ“ä½œç³»ç»Ÿæ²™ç›’â€ï¼Œä¸¤ä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿ IP åœ°å€ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª Port å·äº†ã€‚</p>
<p>å®ç°åŸç†ï¼šåŒä¸€ä¸ª Pod å†…çš„ Containers å¤„äºåŒä¸€ä¸ª Network Namespaceï¼Œå› æ­¤ä½¿ç”¨äº†ç›¸åŒçš„ IP åœ°å€å’Œ Port åŒºé—´ã€‚è¯¥ Namespace æ˜¯ç”±ä¸€ä¸ªåä¸º Pause Container å®ç°çš„ï¼Œæ¯å½“ä¸€ä¸ª Pod è¢«åˆ›å»ºï¼Œ<code>é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª Pause Container</code>ã€‚<code>åç»­æ‰€æœ‰æ–°çš„æ™®é€š Containers éƒ½é€šè¿‡è¿‡å…±äº« Pause Container çš„ç½‘ç»œæ ˆ</code>ï¼Œå®ç°ä¸å¤–éƒ¨ Pod è¿›è¡Œé€šä¿¡ã€‚å› æ­¤å¯¹äºåŒ Pod ä¸‹å±çš„ Containers è€Œè¨€ï¼Œå®ƒä»¬çœ‹åˆ°çš„ç½‘ç»œè§†å›¾æ˜¯ä¸€æ ·çš„ã€‚ä¸Šè¿°æˆ‘ä»¬åœ¨ Container ä¸­çœ‹çš„ IP åœ°å€ï¼Œå®é™…å°±æ˜¯ Pause Container çš„ IP åœ°å€ï¼Œé€šè¿‡æ§åˆ¶ Pause Container çš„ç½‘ç»œåè®®æ ˆå°±å¯ä»¥å½±å“æ‰€æœ‰åŒå± Pod ä¸‹çš„ Container çš„ç½‘ç»œåè®®æ ˆäº†ã€‚</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313235141.png" target="_blank" title="WeiyiGeek.Pause Container çš„ç½‘ç»œåè®®æ ˆ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313235141.png" alt="WeiyiGeek.Pause Container çš„ç½‘ç»œåè®®æ ˆ" title="" class=""></a>
                <p>WeiyiGeek.Pause Container çš„ç½‘ç»œåè®®æ ˆ</p>
            </figure>
<p>Tipsï¼šè¿™ç§æ–°åˆ›å»ºçš„å®¹å™¨å’Œå·²ç»å­˜åœ¨çš„ä¸€ä¸ªå®¹å™¨ï¼ˆPauseï¼‰å…±äº«ä¸€ä¸ª Network Namespaceï¼ˆ<code>è€Œä¸æ˜¯å’Œå®¿ä¸»æœºå…±äº«</code>ï¼‰çš„æ¨¡å¼å°±æ˜¯å¸¸è¯´çš„ Container æ¨¡å¼ã€‚</p>
<p><br></p>
<h4 id="2-åŒä¸»æœº-Pod-é—´çš„é€šä¿¡ï¼ˆHost-Virtual-Network-æ¨¡å¼ï¼‰"><a href="#2-åŒä¸»æœº-Pod-é—´çš„é€šä¿¡ï¼ˆHost-Virtual-Network-æ¨¡å¼ï¼‰" class="headerlink" title="(2) åŒä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆHost Virtual Network æ¨¡å¼ï¼‰"></a>(2) åŒä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆHost Virtual Network æ¨¡å¼ï¼‰</h4><p>æè¿°: æ¯ä¸ª Node ä¸Šçš„æ¯ä¸ª Pod éƒ½æœ‰è‡ªå·±ä¸“å±çš„ Network Namespaceï¼Œç”±æ­¤å®ç° Container æ¨¡å‹ç½‘ç»œçš„éš”ç¦»ã€‚è€Œä¸¤ä¸ª Pod ä¹‹é—´å³ä¸¤ä¸ª Network Namespace ä¹‹é—´å¸Œæœ›è¿›è¡Œé€šä¿¡çš„è¯ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ° Linux æ“ä½œç³»ç»Ÿçš„<code>ç½‘ç»œè™šæ‹ŸåŒ–æŠ€æœ¯ Veth Pairï¼ˆè™šæ‹Ÿç½‘çº¿ï¼‰</code>äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ª Pod éƒ½éœ€è¦ä¸¤ä¸¤å»ºç«‹ Veth Pair çš„è¯ï¼Œæ‰©å±•æ€§å°±ä¼šéå¸¸çš„å·®ï¼Œå‡å¦‚ï¼šæœ‰ N ä¸ª Podï¼Œå°±éœ€è¦åˆ›å»º n(n-1)/2 ä¸ª Veth Pairã€‚å¯è§ï¼Œé™¤äº† Veth Pairï¼ˆè™šæ‹Ÿç½‘çº¿ï¼‰ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªäºŒå±‚çš„ â€œé›†çº¿â€ è®¾å¤‡ <code>Linux Bridgeï¼ˆè™šæ‹Ÿäº¤æ¢æœºï¼‰</code>ã€‚</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313235531.png" target="_blank" title="WeiyiGeek.åŒä¸»æœº Pod é—´çš„é€šä¿¡" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210313235531.png" alt="WeiyiGeek.åŒä¸»æœº Pod é—´çš„é€šä¿¡" title="" class=""></a>
                <p>WeiyiGeek.åŒä¸»æœº Pod é—´çš„é€šä¿¡</p>
            </figure>
<p>Tips: åœ¨K8sèŠ‚ç‚¹ä¸­å°†ä¼šä»Docker0è™šæ‹Ÿç½‘å¡ä¸­çš„tunl0éš§é“æ¥å£å­ç½‘ä¸­åˆ†é…ä¸€ä¸ªè¯¥ç½‘æ®µIPç»™Podè¿›è¡Œä½¿ç”¨å¹¶ä¸”æ­¤tunl0éš§é“æ¥å£åœ°å€å³ä¸ºPodç½‘å…³é€šä¿¡åœ°å€;</p>
<p>åŸç†ç¤ºä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1</span></span><br><span class="line">$ ip addr</span><br><span class="line">....</span><br><span class="line">3: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">    inet 172.16.0.192/32 scope global tunl0  <span class="comment"># è¿è¡Œåœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„Podçš„ç½‘å…³åœ°å€</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:e3:83:5e:a1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:e3ff:fe83:5ea1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">....</span><br><span class="line">97: veth09836f7@if96: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether 6e:e4:02:db:75:57 brd ff:ff:ff:ff:ff:ff link-netnsid 2</span><br><span class="line">    inet6 fe80::6ce4:2ff:fedb:7557/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">117: veth867869c@if116: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether 4a:62:4c:ba:c6:91 brd ff:ff:ff:ff:ff:ff link-netnsid 3</span><br><span class="line">    inet6 fe80::4862:4cff:feba:c691/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="comment"># æ–¹å¼2</span></span><br><span class="line">$ bridge -d link</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master docker0 docker0</span><br><span class="line">97: veth09836f7@if96: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master docker0 state forwarding priority 32 cost 2</span><br><span class="line">    hairpin off guard off root_block off fastleave off learning on flood on mcast_flood on mcast_to_unicast off neigh_suppress off vlan_tunnel off isolated off veth09836f7</span><br><span class="line">117: veth867869c@if116: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master docker0 state forwarding priority 32 cost 2</span><br><span class="line">    hairpin off guard off root_block off fastleave off learning on flood on mcast_flood on mcast_to_unicast off neigh_suppress off vlan_tunnel off isolated off veth867869c</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚æœ¬æœºçš„corednsPod</span></span><br><span class="line">~$ kubectl get pod -n kube-system  -o wide | grep <span class="string">"coredns"</span></span><br><span class="line">coredns-6c76c8bb89-hr9b7                   1/1     Running   2          61d   172.16.0.198     weiyigeek-107  </span><br><span class="line">coredns-6c76c8bb89-kgbdb                   1/1     Running   2          61d   172.16.0.199     weiyigeek-107 </span><br><span class="line"><span class="comment"># coredns çš„ç«¯ç‚¹æƒ…å†µ</span></span><br><span class="line">~$ kubectl get endpoints -n kube-system kube-dns</span><br><span class="line">NAME       ENDPOINTS                                                     AGE</span><br><span class="line">kube-dns   172.16.0.198:53,172.16.0.199:53,172.16.0.198:53 + 3 more...   61d</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·¯ç”±è·Ÿè¸ªå°±æ˜¯æœ¬æœº</span></span><br><span class="line">~$ tracepath  -4 172.16.0.199</span><br><span class="line"> 1?: [LOCALHOST]                      pmtu 1480</span><br><span class="line"> 1:  172.16.0.199                                          0.063ms reached</span><br><span class="line"> 1:  172.16.0.199                                          0.034ms reached</span><br><span class="line">     Resume: pmtu 1480 hops 1 back 1</span><br></pre></td></tr></table></figure></p>
<p>è¡¥å……è¯´æ˜:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾‹å¦‚ jenkins-844756cf77-nvhmj pod è¿è¡Œåœ¨weiyigeek-226èŠ‚ç‚¹çš„ 172.16.182.205 ä¸­</span></span><br><span class="line">~$ kubectl get pod -n devops -o wide</span><br><span class="line">NAME                                 READY   STATUS    RESTARTS   AGE   IP               NODE      </span><br><span class="line">jenkins-844756cf77-nvhmj             1/1     Running   0          12d   172.16.182.205   weiyigeek-226   </span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶æ¬¡æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šè¿›è¡Œè·¯ç”±è·Ÿè¸ª</span></span><br><span class="line">~$ tracepath  -4 172.16.182.205</span><br><span class="line"> 1?: [LOCALHOST]                      pmtu 1480</span><br><span class="line"> 1:  172.16.182.192                    0.353ms  <span class="comment"># å®é™…ä¸Šæ˜¯weiyigeek-226èŠ‚ç‚¹çš„tunl0è™šæ‹Ÿç½‘å¡;</span></span><br><span class="line"> 1:  172.16.182.192                    0.305ms</span><br><span class="line"> 2:  172.16.182.205                    0.304ms reached</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯ç»“è®º</span></span><br><span class="line">weiyigeek@weiyigeek-226:~$ ip addr | grep <span class="string">"172.16.182.192"</span> -B 2</span><br><span class="line">7: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">    inet 172.16.182.192/32 scope global tunl0</span><br></pre></td></tr></table></figure></p>
<p>Tips : è¿™ç§å€ŸåŠ©äº Linux æ“ä½œç³»ç»ŸåŸç”Ÿçš„ç½‘ç»œè™šæ‹ŸåŒ–æŠ€æœ¯å®ç°çš„ä¸¤ä¸ªæœ¬åœ° Pods ä¹‹é—´çš„ç½‘ç»œé€šä¿¡æ–¹å¼ï¼Œç§°ä¸º <code>Host Virtual Network</code> æ¨¡å¼ã€‚</p>
<p><br></p>
<h4 id="3-è·¨ä¸»æœº-Pod-é—´çš„é€šä¿¡ï¼ˆSDN-æ¨¡å¼ï¼‰"><a href="#3-è·¨ä¸»æœº-Pod-é—´çš„é€šä¿¡ï¼ˆSDN-æ¨¡å¼ï¼‰" class="headerlink" title="(3) è·¨ä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆSDN æ¨¡å¼ï¼‰"></a>(3) è·¨ä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆSDN æ¨¡å¼ï¼‰</h4><p>æè¿°: æ€»çš„æ¥è¯´è·¨ä¸»æœºé€šä¿¡æ— éæ˜¯ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼Œæœ¬è´¨æ˜¯åœ¨ç½‘ç»œä¸Šæ¶è®¾ä¸€å±‚Overlay Networkä½¿å®¹å™¨çš„ç½‘ç»œè¿è¡Œåœ¨Overlayç½‘ç»œä¸Šï¼Œå‰é¢æåˆ°K8sçš„ç½‘ç»œå¯¹Podçš„IPåœ°å€çš„è§„åˆ’æ˜¯å¹³é¢ç®¡ç†çš„ã€‚</p>
<ul>
<li>Overlay éš§é“äº’é€šï¼šNodes ä¹‹é—´é€šè¿‡ç‰©ç†ç½‘ç»œäº’é€šï¼Œe.g. OvSã€Flannel å’Œ Weaveã€‚</li>
<li>Underlay ç›´æ¥äº’é€šï¼šNodes ä¹‹é—´é€šè¿‡ç‰©ç†ç½‘ç»œäº’é€šï¼Œe.g. Calico çš„ Direct æ¨¡å¼ã€macvlanã€‚</li>
</ul>
<p>ä»ç½‘ç»œè§’åº¦å¯¹ Flannel å’Œ Calico è¿›è¡Œç®€å•å¯¹æ¯”(<code>åé¢è¯¦ç»†è®²è§£</code>)ã€‚</p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314001828.png" target="_blank" title="WeiyiGeek.Flannel å’Œ Calicoå¯¹æ¯”" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314001828.png" alt="WeiyiGeek.Flannel å’Œ Calicoå¯¹æ¯”" title="" class=""></a>
                <p>WeiyiGeek.Flannel å’Œ Calicoå¯¹æ¯”</p>
            </figure>
<p>Tips: å¯è§å¯¹æ€§èƒ½æ•æ„Ÿã€ç­–ç•¥éœ€æ±‚è¾ƒé«˜æ—¶åå‘äº Calico æ–¹æ¡ˆã€‚å¦åˆ™é‡‡ç”¨ Flannel ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼›<br>Tips: è·¨ä¸»æœºPodé—´é€šä¿¡çš„ç®€å•æµç¨‹<code>Pod1æµå‡ºåˆ°Vethè™šæ‹Ÿæ¥å£-&gt;åˆ°è¾¾Docker0ç½‘æ¡¥-&gt;é€šè¿‡å®¿ä¸»æœºç‰©ç†ç½‘å£-&gt;åˆ°è¾¾å¯¹æ–¹ç‰©ç†ç½‘å£-&gt;å¯¹æ–¹Docker0ç½‘æ¡¥-&gt;Vethè™šæ‹Ÿæ¥å£-&gt;Pod2</code></p>
<p><br></p>
<h4 id="4-Service-çš„-Cluster-IP-å’Œå¤–éƒ¨ç½‘ç»œé—´çš„é€šä¿¡"><a href="#4-Service-çš„-Cluster-IP-å’Œå¤–éƒ¨ç½‘ç»œé—´çš„é€šä¿¡" class="headerlink" title="(4) Service çš„ Cluster IP å’Œå¤–éƒ¨ç½‘ç»œé—´çš„é€šä¿¡"></a>(4) Service çš„ Cluster IP å’Œå¤–éƒ¨ç½‘ç»œé—´çš„é€šä¿¡</h4><p>æè¿°: Service ä¹‹äºé›†ç¾¤å†…éƒ¨ Pods ä¹‹é—´çš„é€šä¿¡Pod é—´å¯ä»¥ç›´æ¥é€šè¿‡ IP åœ°å€é€šä¿¡ï¼Œä½†å‰ææ˜¯ Pod çŸ¥é“å¯¹æ–¹çš„ IPã€‚</p>
<p>åœ¨ Kubernetes Cluster ä¸­ï¼ŒPod å¯èƒ½ä¼šé¢‘ç¹åœ°é”€æ¯å’Œåˆ›å»ºï¼Œä¹Ÿå°±æ˜¯è¯´ Pod çš„ IP ä¸æ˜¯å›ºå®šçš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒKubernetes Service ä½œä¸ºè®¿é—® Pod çš„ä¸Šå±‚æŠ½è±¡ã€‚æ— è®ºåç«¯çš„ Pod å¦‚ä½•å˜åŒ–ï¼ŒService éƒ½ä½œä¸ºç¨³å®šçš„å‰ç«¯å¯¹å¤–æä¾›æœåŠ¡(é€šè¿‡æ ‡ç­¾labelæ–¹å¼è¿›è¡Œç»‘å®š)ã€‚åŒæ—¶ Service è¿˜æä¾›äº†é«˜å¯ç”¨å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè´Ÿè´£å°†è¯·æ±‚è½¬å‘ç»™æ­£ç¡®çš„ Podã€‚</p>
<p>æè¿°: Service ä¹‹äºé›†ç¾¤å¤–éƒ¨ä¸ Pod çš„é€šä¿¡, æ— è®ºæ˜¯ <code>Pod IP è¿˜æ˜¯ Service çš„ Cluster IP</code>ï¼Œå®ƒä»¬éƒ½æ˜¯åªèƒ½åœ¨ Kubernetes Cluster å†…éƒ¨å¯è§çš„ç§æœ‰ IP åœ°å€ã€‚Kubernetes æä¾›äº†ä¸¤ç§æ–¹å¼å¯ä»¥è®©å¤–éƒ¨ç½‘ç»œè®¿é—® Service çš„ Cluster IPç»§è€Œä¸ Pod è¿›è¡Œé€šä¿¡ï¼š</p>
<ul>
<li><p>ClusterIP ï¼š é»˜è®¤ç±»å‹è‡ªåŠ¨åˆ†é…ä¸€ä¸ªä»…Clusterå†…éƒ¨å¯ä»¥è®¿é—®çš„è™šæ‹ŸIP(<code>å¸¸å¸¸ç”± flannel/Calico ç½‘ç»œæ’ä»¶è¿›è¡Œç®¡ç†</code>)ã€serviceåˆ›å»ºä¸€ä¸ªä»…é›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„ipï¼Œé›†ç¾¤å†…éƒ¨å…¶ä»–çš„podå¯ä»¥é€šè¿‡è¯¥æœåŠ¡è®¿é—®åˆ°å…¶ç›‘æ§ä¸‹çš„podã€‘</p>
</li>
<li><p>NodePortï¼šService é€šè¿‡ Node çš„é™æ€ç«¯å£å¯¹å¤–æä¾›æœåŠ¡ï¼Œå¤–éƒ¨ç½‘ç»œå¯ä»¥é€šè¿‡ NodeIP:NodePort è®¿é—® Serviceï¼Œæ ¹æ®ä¸åŒçš„ NodePort å¯ä»¥è®¿é—®ä¸åŒçš„ Serviceã€‚</p>
</li>
<li><p>LoadBalancerï¼šService åˆ©ç”¨è‡ªå»ºçš„è´Ÿè½½å‡è¡¡å™¨ï¼ˆåå‘ä»£ç†ï¼‰å°†æµé‡å¯¼å‘ Serviceï¼Œä¾‹å¦‚ï¼šNginxã€OpenStack Octaviaã€Cloud Providerï¼ˆGCPã€AWSã€ Azureï¼‰ç­‰ã€‚</p>
</li>
</ul>
<p>Tips: NodePort å…¶å·¥ä½œåŸç†ä¸ClusterIPå¤§è‡´ç›¸åŒå‘é€åˆ°æŸä¸ª<code>NodeIP:NodePort</code>æ—¶, é€šè¿‡iptablesé‡å®šå‘åˆ°kube-proxyå¯¹åº”çš„ç«¯å£ä¹‹ä¸­(<code>å›ºå®šæˆ–è€…éšæœºç”±nodePortå†³å®š</code>), ç„¶åç”±Kube-proxyå°†è¯·æ±‚å‘é€åˆ°æŒ‡å®šPodçš„TargetPodç«¯å£ä¹‹ä¸­ã€‚</p>
<p><br/></p>
<p><strong>Kube-proxy åŸç†ç®€è¿°</strong><br>å®ç°çš„ä¸¤ç§Porxy Mode:</p>
<ul>
<li>1) UserSpace Mode : v1.0 ç‰ˆæœ¬åŠä¹‹å‰é»˜è®¤ã€‚<ul>
<li>æè¿°: åœ¨ç”¨æˆ·ç©ºé—´é€šè¿‡kube-proxyå®ç°Serviceçš„ä»£ç†æœåŠ¡ï¼Œå…¶ä¸»è¦é—®é¢˜æ˜¯<code>Serviceè¯·æ±‚å…ˆä¼šä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸çš„IPtables ç„¶åå›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç”±kube-proxyå®Œæˆåç«¯çš„Endpointsçš„é€‰æ‹©å’Œä»£ç†å·¥ä½œ</code>ï¼Œè¿™æ ·å¯¼è‡´æµé‡ä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸å¸¦æ¥çš„æ€§èƒ½æŸè€—æ˜¯ä¸å¯æ¥å—çš„ã€‚</li>
</ul>
</li>
</ul>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314090853.png" target="_blank" title="WeiyiGeek.UserSpace Mode" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314090853.png" alt="WeiyiGeek.UserSpace Mode" title="" class=""></a>
                <p>WeiyiGeek.UserSpace Mode</p>
            </figure>
<ul>
<li>2) IPtables mode : v1.1 ç‰ˆæœ¬å‡ºç°ï¼Œåœ¨v1.2ç‰ˆæœ¬è¯¥æ¨¡å¼æ›¿ä»£äº†userpaceæ¨¡å¼.<ul>
<li>æè¿°: å®ƒå®Œå…¨åˆ©ç”¨å†…æ ¸çš„IPtablesæ¥å®ç°Serviceçš„ä»£ç†å’ŒLB, å…¶ä¸»è¦é—®é¢˜æ˜¯ä½¿ç”¨<code>IPtables NATæ¥å®Œæˆè½¬å‘å­˜åœ¨ä¸€å®šçš„ä¸”ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—</code>ã€‚å¦å¤–å¦‚æœé›†ç¾¤ä¸­å­˜åœ¨ä¸Šä¸‡çš„Service/Endpointé‚£ä¹ˆNodeä¸Šçš„iptables ruleså°†ä¼šéå¸¸åºå¤§ä¸”æ€§èƒ½è¿˜ä¼šå†æ‰“æŠ˜æ‰£ã€‚æ‰€ä»¥å¸¸å¸¸åœ¨ä¼ä¸šä¸­é€šè¿‡Ingress Controlleræ¥é›†æˆHAproxyæˆ–è€…Nginxæ¥æ›¿ä»£Kube-proxy;</li>
</ul>
</li>
</ul>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314090942.png" target="_blank" title="WeiyiGeek.IPtables mode" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314090942.png" alt="WeiyiGeek.IPtables mode" title="" class=""></a>
                <p>WeiyiGeek.IPtables mode</p>
            </figure>
<p>ç¤ºä¾‹è¯´æ˜:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) è·å–ClusterIPä¸Endpointç«¯ç‚¹å¯çŸ¥ 10.107.122.223 ä»£ç†äº†åç«¯ 172.16.182.200:8080,172.16.183.89:8080,172.16.24.230:8080</span></span><br><span class="line">~$ kubectl get endpoints deploy-maven-svc</span><br><span class="line">  <span class="comment"># NAME               ENDPOINTS                                                   AGE</span></span><br><span class="line">  <span class="comment"># deploy-maven-svc   172.16.182.200:8080,172.16.183.89:8080,172.16.24.230:8080   9d  # </span></span><br><span class="line"></span><br><span class="line">~$ kubectl get svc deploy-maven-svc</span><br><span class="line">  <span class="comment"># NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span></span><br><span class="line">  <span class="comment"># deploy-maven-svc   NodePort   10.107.122.223   &lt;none&gt;        8080:30089/TCP   9d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) å†…æ ¸ä¸­ iptables è½¬å‘åˆ—è¡¨æŸ¥çœ‹</span></span><br><span class="line">~$ sudo iptables -S -t nat</span><br><span class="line">  <span class="comment"># -A KUBE-FIREWALL -j KUBE-MARK-DROP</span></span><br><span class="line">  <span class="comment"># -A KUBE-LOAD-BALANCER -j KUBE-MARK-MASQ</span></span><br><span class="line">  <span class="comment"># -A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span></span><br><span class="line">  <span class="comment"># -A KUBE-NODE-PORT -p tcp -m comment --comment "Kubernetes nodeport TCP port for masquerade purpose" -m set --match-set KUBE-NODE-PORT-TCP dst -j KUBE-MARK-MASQ</span></span><br><span class="line">  <span class="comment"># -A KUBE-POSTROUTING -m comment --comment "Kubernetes endpoints dst ip:port, source ip for solving hairpin purpose" -m set --match-set KUBE-LOOP-BACK dst,dst,src -j MASQUERADE</span></span><br><span class="line">  <span class="comment"># -A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span></span><br><span class="line">  <span class="comment"># -A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span></span><br><span class="line">  <span class="comment"># -A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully</span></span><br><span class="line">  <span class="comment"># # æ­¤ä¸º Pod è¿è¡Œçš„çš„ç½‘æ®µæŒ‡å‘`KUBE-CLUSTER-IP`ClusterIP</span></span><br><span class="line">  <span class="comment"># -A KUBE-SERVICES ! -s 172.16.0.0/16 -m comment --comment "Kubernetes service cluster ip + port for masquerade purpose" -m set --match-set KUBE-CLUSTER-IP dst,dst -j KUBE-MARK-MASQ  </span></span><br><span class="line">  <span class="comment"># -A KUBE-SERVICES -m addrtype --dst-type LOCAL -j KUBE-NODE-PORT</span></span><br><span class="line">  <span class="comment"># # è½¬å‘åˆ° KUBE-SERVICES é“¾ä¸­åŒ¹é…CLUSTER-IPåœ°å€è¿›è¡Œé€šä¿¡</span></span><br><span class="line">  <span class="comment"># -A KUBE-SERVICES -m set --match-set KUBE-CLUSTER-IP dst,dst -j ACCEPT</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="ç½‘ç»œç»„ä»¶"><a href="#ç½‘ç»œç»„ä»¶" class="headerlink" title="ç½‘ç»œç»„ä»¶"></a>ç½‘ç»œç»„ä»¶</h3><h4 id="1-Flannel"><a href="#1-Flannel" class="headerlink" title="(1) Flannel"></a>(1) Flannel</h4><p>æè¿°: Flannel æ˜¯ CoreOS å›¢é˜Ÿé’ˆå¯¹äºKubernetesè®¾è®¡çš„ä¸€ä¸ªç½‘ç»œè§„åˆ’æœåŠ¡ä¹Ÿå¯ä»¥ä¸ºå…¶å®ƒå…¶å®ƒå®¹å™¨æä¾›å¾€æ¥æœåŠ¡ï¼Œç®€å•æ¥è¯´å®ƒçš„åŠŸèƒ½æ˜¯è®©é›†ç¾¤ä¸­çš„ä¸åŒèŠ‚ç‚¹ä¸»æœºåˆ›å»ºçš„Dockerå®¹å™¨éƒ½å…·æœ‰å…¨é›†æƒå”¯ä¸€çš„è™šæ‹ŸIPåœ°å€ï¼Œå¹¶ä¸”å®ƒèƒ½å°†è¿™äº›IPåœ°å€ä¹‹é—´å»ºç«‹ä¸€ä¸ªè¦†ç›–ç½‘ç»œ<code>(Overlay Network å°†æ•°æ®åŒ…åŸå°ä¸åŠ¨çš„ä¼ é€’åˆ°ç›®æ ‡å®¹å™¨å†…)</code>ï¼Œå³å®ç°äº†è·¨ä¸»æœºçš„æ‰å¹³åŒ–ç®¡ç†ç½‘ç»œï¼›</p>
<p>Tips: æ‰€æœ‰å®¹å™¨åœ¨Flannelæä¾›çš„ç½‘ç»œå¹³é¢ä¸Šå¯ä»¥çœ‹ä½œæ˜¯åŒä¸€ä¸ªç½‘æ®µè‡ªç”±é€šä¿¡ï¼Œå…¶æ¨¡å‹å…¨éƒ¨çš„å®¹å™¨ä½¿ç”¨ä¸€ä¸ªNetworkç„¶ååœ¨æ¯ä¸ªHostä¸Šä»networkä¸­åˆ’åˆ†ä¸€ä¸ªå­ç½‘subnetï¼Œåœ¨ä¸ºhostä¸Šçš„å®¹å™¨åˆ›å»ºç½‘ç»œæ—¶ï¼Œå°†ä¼šä»subnetä¸­åˆ’åˆ†ä¸€ä¸ªIPç»™å®¹å™¨ï¼Œè¿™æ ·å°±å¤§å¤§æé«˜äº†å®¹å™¨ä¹‹é—´çš„å·¥ä½œæ•ˆç‡å¹¶ä¸”ä¸ç”¨è€ƒè™‘IPè½¬æ¢é—®é¢˜ã€‚</p>
<p>Tips: ç”±äºK8sçš„æ¨¡å‹ä¸ºæ¯ä¸€ä¸ªPodæä¾›ä¸€ä¸ªIPï¼ŒFlannelçš„æ¨¡å‹æ­£å¥½ä¸ä¹‹å¥‘åˆã€‚å› æ­¤Flannelæ˜¯æœ€ç®€å•æ˜“ç”¨çš„Kubernetesé›†ç¾¤ç½‘ç»œè§£å†³æ–¹æ¡ˆã€‚</p>
<p><br/></p>
<p><strong>ä¼˜ç¼ºç‚¹</strong><br>ä¼˜ç‚¹: Flannel æ¨¡å‹ä¸K8sé»˜è®¤æ¨¡å‹ä¸€æ ·éƒ½ä¸ºæ¯ä¸ªPodæä¾›ä¸€ä¸ªip,å…¶å¯ä»¥å¤§å¤§æå‡å®¹å™¨ä¹‹é—´çš„å·¥ä½œæ•ˆç‡ã€‚<br>ç¼ºç‚¹: èµ„æºå ç”¨è¾ƒé«˜ï¼Œä¸”å¿…é¡»å’Œetcdæ•°æ®åº“ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p><br/></p>
<p><strong>åŸç†è§£æä¸å›¾ç¤º</strong><br>æè¿°: Flannelç½‘ç»œè§£å†³æ–¹æ¡ˆåˆ©ç”¨Overlayç½‘ç»œåœ¨æŠ¥æ–‡è¿›å…¥å®é™…ç‰©ç†ç½‘ç»œä¹‹å‰ä¼šç»è¿‡ä¸€å±‚UDPå°è£…ä½œä¸ºPlayloadåˆ°è¾¾å¯¹ç«¯ï¼Œå¯¹ç«¯æ‹¿åˆ°UDPæŠ¥æ–‡åè¿›è¡Œè§£åŒ…å¾—åˆ°çœŸå®ç”¨æˆ·æŠ¥æ–‡åè½¬å‘ç»™å®é™…æ¥æ”¶æ–¹ã€‚</p>
<p>åŸç†å›¾å¦‚ä¸‹:<br><figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201101220922.png" target="_blank" title="WeiyiGeek.Flannelç½‘ç»œè§£å†³æ–¹æ¡ˆåŸç†" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201101220922.png" alt="WeiyiGeek.Flannelç½‘ç»œè§£å†³æ–¹æ¡ˆåŸç†" title="" class=""></a>
                <p>WeiyiGeek.Flannelç½‘ç»œè§£å†³æ–¹æ¡ˆåŸç†</p>
            </figure></p>
<p>åŸç†è¯´æ˜ï¼š</p>
<ul>
<li>(0) etcd åœ¨ Flannel ä¸»è¦ç”¨äºå­˜å‚¨ç®¡ç†Flannelå¯åˆ†é…çš„IPåœ°å€æ®µèµ„æº, ç›‘æ§etcdä¸­æ¯ä¸ªpodçš„å®é™…åœ°å€å¹¶åœ¨å†…å­˜ä¸­å»ºç«‹ç»´æŠ¤PodèŠ‚ç‚¹çš„è·¯ç”±è¡¨ï¼ˆ<code>ä¾¿äºè·¨Podé—´äº¤æµé€šä¿¡çŸ¥é“èµ°å“ªé‡Œ</code>ï¼‰;</li>
<li>(1) Flanneld è¿›ç¨‹æœåŠ¡æœ‰ä¸€ä¸ªç›‘å¬ç«¯å£ï¼Œç”¨äºåæœŸè½¬å‘æ•°æ®åŒ…ä»¥åŠæ¥æ”¶æ•°æ®åŒ…çš„æ¥å£;</li>
<li>(2) Iptables é€šè¿‡åº•å±‚çš„ä¸€å †è½¬å‘æœºåˆ¶è¿›è¡Œæ•°æ®åŒ…çš„è½¬å‘åˆ°å¦å¤–ä¸€å°RealServerçš„Flanneldä¸Š</li>
</ul>
<p>å›Šæ‹¬è¯´æ˜: Flannel ç½‘ç»œç»„ä»¶ç¦»ä¸å¼€etcdå› ä¸ºå…¶å­˜å‚¨äº†å„ä¸ªNodeä¸­Podå­ç½‘ä»¥åŠServiceç›¸å…³çš„IPåœ°å€ï¼Œå½“éœ€è¦å¯¹å…¶å®ƒHOSTè¿›è¡Œæ•°æ®è½¬å‘æ—¶ï¼Œä»etcdæ•°æ®åº“æŸ¥è¯¢åˆ°ç›®æ ‡hostæ‰€åœ¨çš„å­ç½‘IPï¼Œå¹¶å°†æ•°æ®å‘å¾€å¯¹åº”çš„hostä¸Šçš„Flanneldäº¤ç”±å…¶è½¬å‘ã€‚</p>
<p>Tips : å®˜æ–¹å›¾ç¤ºä¸ºDocker0ä½†å‡ºäºåœ°å€è§„åˆ’çš„åŸå› ï¼Œå®é™…ä¸Šåœ¨K8sä¸Šä¼šæ–°åˆ›å»ºä¸€ä¸ªCNI0ç½‘æ¡¥å…¶è´Ÿè´£æœ¬ Node å®¹å™¨çš„IPåˆ†é…(/24)ã€‚</p>
<p>Q: æ¯ä¸ªNodeéƒ½æœ‰è‡ªå·±çš„CNI0ç½‘æ¡¥å¦‚ä½•ä¿è¯åœ°å€ä¸ä¼šé‡å¤åˆ†é…å‘¢?</p>
<blockquote>
<p>ç­”: è¿™å°±æ˜¯ä½¿ç”¨äº†Flannelæ’ä»¶å…¶ä¼šæ ¹æ®å…¨å±€ç»Ÿä¸€çš„etcdæ¥ä¸ºæ¯ä¸€ä¸ªNodeåˆ†é…å…¨é›†ç¾¤å”¯ä¸€çš„ç½‘æ®µæ¥é¿å…åœ°å€åˆ†é…å†²çªï¼Œå³å½“cni0æ‹¿åˆ°æŠ¥æ–‡åæŸ¥è¯¢æœ¬æœºè·¯ç”±ï¼Œå°†ä¼šåŒ¹é…çš„æ˜¯16ä½çš„æ©ç Flannelã€‚</p>
</blockquote>
<p>Q: linux ä¸Šç”¨æˆ·æ€å’Œå†…æ ¸æ€é€šä¿¡çš„æ‰‹æ®µ?</p>
<blockquote>
<p>1.Netlink Socket<br>2.syscall : ä¾‹å¦‚è°ƒç”¨ç”¨æˆ·æ€çš„read/writeæ¥å£ã€‚<br>3.IOCTL<br>4.procfs : ä¾‹å¦‚è¯»å–/procç›®å½•ä¸‹çš„ipç»Ÿè®¡è®¡æ•°ã€‚<br>5.TUN/TAP : ä¸¤ç§é©±åŠ¨ç¨‹åºå®ç°äº†è™šæ‹Ÿç½‘å¡çš„åŠŸèƒ½ï¼ŒTunè¡¨ç¤ºè™šæ‹Ÿçš„æ˜¯ç‚¹å¯¹ç‚¹çš„è®¾å¤‡ï¼Œtapè¡¨ç¤ºè™šæ‹Ÿçš„æ˜¯ä»¥å¤ªç½‘è®¾å¤‡ä¸¤ç§è®¾å¤‡éƒ½æ˜¯å¯¹ç½‘ç»œåŒ…å®æ–½ä¸åŒçš„å°è£…ã€‚</p>
</blockquote>
<p><br/></p>
<p><strong>åœ°å€åˆ†é… &amp; è·¯ç”±ä¸‹å‘</strong><br>æè¿°: flanneld å®ˆæŠ¤è¿›ç¨‹ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä¼šä» etcd è·å–é…ç½®çš„ Pod ç½‘æ®µä¿¡æ¯ï¼Œä¸ºæœ¬èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„ IP åœ°å€æ®µï¼Œç„¶ååˆ›å»º flannedl.1 ç½‘ç»œæ¥å£ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒåç§°ï¼‰ï¼ŒFlannel å°†åˆ†é…ç»™è‡ªå·±çš„ Pod ç½‘æ®µä¿¡æ¯å†™å…¥ <code>/run/flannel/docker</code> æ–‡ä»¶ï¼ˆä¸åŒ Kubernets ç‰ˆæœ¬çš„æ–‡ä»¶åå­˜åœ¨å·®å¼‚ï¼‰ï¼ŒDocker åç»­ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡è®¾ç½® docker0 ç½‘æ¡¥ï¼Œä»è€Œä½¿è¿™ä¸ªåœ°å€æ®µä¸ºæœ¬èŠ‚ç‚¹çš„æ‰€æœ‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ Flannel ä¸º Docker åˆ†é…çš„åœ°å€æ®µï¼š</span></span><br><span class="line">~$ cat /run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.1.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>Tips : è¡¨ç¤ºè¯¥ Node ä¸Šæ‰€æœ‰ Pod çš„ IP åœ°å€éƒ½ä» <code>Flannel Subnet 10.244.1.1/24</code> ä¸­åˆ†é…ï¼Œæ¯”å¦‚ node1 ä¸‹å±çš„ 2 ä¸ª Pod çš„ IP åœ°å€ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pod -o wide | grep <span class="string">"Running"</span></span><br><span class="line">  <span class="comment"># deploy-blog-html-0                        1/1     Running       2          79d   10.244.1.19    weiyigeek-ubuntu</span></span><br><span class="line">  <span class="comment"># deploy-java-maven-0                       1/1     Running       2          40d   10.244.1.15    weiyigeek-ubuntu</span></span><br><span class="line">  <span class="comment"># nfs-client-provisioner-58b5dc958d-pxhb7   1/1     Running       1          11d   10.244.1.20    weiyigeek-ubuntu</span></span><br><span class="line">  <span class="comment"># nginx-app                                 1/1     Running       2          38d   10.244.1.14    weiyigeek-ubuntu</span></span><br><span class="line">  <span class="comment"># web-0                                     1/1     Running       2          38d   10.244.1.16    weiyigeek-ubuntu</span></span><br></pre></td></tr></table></figure></p>
<p>Tips : è·¯ç”±ä¸‹å‘ æ¯ä¸ª Node ä¸­çš„ flanneld å®ˆæŠ¤è¿›ç¨‹ï¼Œå¯ä»¥åˆ›å»º Kernel çš„è·¯ç”±è¡¨ï¼ŒæŸ¥çœ‹ node1 çš„è·¯ç”±è¡¨å¦‚ä¸‹, å…¶ä¸­ Destination 10.244.2.0 ä¸º node2 çš„ç›®çš„ç½‘æ®µå‡ºå£ä¸º <code>flannel.1 interface</code>;<br><code>flannel.1 interface</code>æ˜¯ flanneld åˆ›å»ºçš„ä¸€ä¸ªéš§é“æ¥å£ã€‚å¹¶ä¸” flanneld ä¸­å¤®å­˜å‚¨äº† Container-Node ä¹‹é—´çš„æ˜ å°„å…³ç³»åˆ° etcd ä¸­ï¼Œä»¥æ­¤æ¥ä½œä¸ºå»ºç«‹æœ€å¤–å±‚éš§é“å°è£…çš„ Tunnel IDï¼Œå°†ä¸¤ä¸ª Nodes ä¸­çš„ä¸¤ä¸ª Containers äº’è”èµ·æ¥ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ route -n</span><br><span class="line">  <span class="comment"># Kernel IP routing table</span></span><br><span class="line">  <span class="comment"># Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span></span><br><span class="line">  <span class="comment"># 0.0.0.0         10.10.107.1     0.0.0.0         UG    0      0        0 ens160</span></span><br><span class="line">  <span class="comment"># 10.10.107.0     0.0.0.0         255.255.255.0   U     0      0        0 ens160</span></span><br><span class="line">  <span class="comment"># 10.244.0.0      0.0.0.0         255.255.255.0   U     0      0        0 cni0</span></span><br><span class="line">  <span class="comment"># 10.244.1.0      10.244.1.0      255.255.255.0   UG    0      0        0 flannel.1</span></span><br><span class="line">  <span class="comment"># 10.244.2.0      10.244.2.0      255.255.255.0   UG    0      0        0 flannel.1</span></span><br><span class="line">  <span class="comment"># 172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span></span><br><span class="line">  <span class="comment"># 172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-26a32f4b83c1</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>æ•°æ®å°è£…</strong><br>æè¿°: Flannel çŸ¥é“å¤–å±‚å°è£…çš„éš§é“å¯¹ç«¯ IP åœ°å€åï¼Œå¯¹æ•°æ®æŠ¥æ–‡è¿›è¡Œå°è£…ï¼ŒSourceIP é‡‡ç”¨æœ¬èŠ‚ç‚¹çš„ NodeIPï¼ŒDestIP é‡‡ç”¨å¯¹ç«¯çš„ VXLAN å¤–å±‚çš„ UDP Port 8472ï¼Œéš§é“çš„å¯¹ç«¯åªéœ€è¦ç›‘å¬è¿™ä¸ª Port å³å¯ï¼Œå½“è¯¥ Port æ”¶åˆ°æŠ¥æ–‡åå°†æŠ¥æ–‡é€åˆ° flannedld è¿›ç¨‹ï¼Œè¿›ç¨‹å°†æŠ¥æ–‡é€åˆ° flanned interface è¿›è¡Œå°è£…ï¼Œç„¶åæŸ¥è¯¢æœ¬åœ°è·¯ç”±è¡¨ï¼Œå¯ä»¥çœ‹åˆ°ç›®çš„åœ°å€çš„ interface ä¸º cni0<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ route -n</span><br><span class="line">  <span class="comment"># Kernel IP routing table</span></span><br><span class="line">  <span class="comment"># Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span></span><br><span class="line">  <span class="comment"># 10.244.0.0      0.0.0.0         255.255.255.0   U     0      0        0 cni0</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>å®é™…æµç¨‹</strong></p>
<ul>
<li><p>1) å‡å¦‚ Web app3 è®¿é—® Backend , å…¶æµç¨‹å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.Web APP3 å‘ç”Ÿè¯·æ±‚è®°å½•ç›®æ ‡çš„IPä¸º10.1.20.3å’Œè¯·æ±‚åœ°å€çš„æ•°æ®åŒ…</span><br><span class="line">2.Docker0ç½‘æ¡¥æ”¶åˆ°æ•°æ®åŒ…åå‘ç°æ˜¯åœ¨åŒä¸€ä¸ªå­ç½‘é‡Œ`åˆ©ç”¨UDP`ç›´æ¥è½¬å‘ç»™10.1.20.3çš„BackendæœåŠ¡</span><br><span class="line">3.Backendæ¥æ”¶åˆ°Web App3çš„è¯·æ±‚åå°†åé¦ˆçš„æ•°æ®é€šè¿‡åŸè·¯è¿”å›</span><br></pre></td></tr></table></figure>
</li>
<li><p>2) å‡å¦‚ Web app2 è®¿é—® Backend , å…¶æµç¨‹å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.Web APP3 å‘ç”Ÿè¯·æ±‚ç”Ÿæˆæ•°æ®åŒ…å…¶ä¸­åŒ…æ‹¬ç›®æ ‡çš„IP(`10.1.20.3`)å’ŒæºIP(10.1.15.2)ä»¥åŠè‡ªèº«çš„Mac</span><br><span class="line">2.Docker0 (10.1.15.1/24) ç½‘æ¡¥å¯¹è¯¥æ•°æ®å°åŒ…è¿›è¡Œè§£æå‘ç°ç›®æ ‡åœ°å€éæœ¬å±€åŸŸç½‘å†…å¡«ä¸Šè‡ªèº«çš„æºè½¬å‘ç»™Flannel0</span><br><span class="line">3.åœ¨Dlannel0æ¥æ”¶åˆ°åä¼šé€šè¿‡Flanneldè¿›ç¨‹æœåŠ¡ä»etcdæ•°æ®åº“ä¸­å–å‡ºåˆ°è¯¥ç›®æ ‡IPçš„è·¯ç”±</span><br><span class="line">4.ç„¶åé€šè¿‡Iptableè½¬å‘å°è£…OuterIPçš„Srcåœ°å€192.168.66.11å’ŒDeståœ°å€ä¸º192.168.66.12, å…¶InnerIP è®°å½•å®é™…çš„è¯·æ±‚æºåœ°å€ä»¥åŠç›®æ ‡åœ°å€åœ¨åŠ ä¸ŠPlayloadçš„æ•°æ®åŒ…å®ä½“;</span><br><span class="line">5.å½“Podç½‘ç»œæ¥å£æ¥æ”¶åˆ°è¯¥æ•°æ®åŒ…æ—¶å€™è½¬å‘ç»™FlanneldæœåŠ¡</span><br><span class="line">6.FlanneldæœåŠ¡è·å¾—InnerIPæ•°æ®åŒ…çš„è¯·æ±‚çš„ç›®æ ‡åœ°å€å¹¶åœ¨etcä¸­è¿›è¡ŒæŸ¥è¯¢è·å¾—è·¯ç”±è¡¨ä¿¡æ¯</span><br><span class="line">7.è½¬å‘ç»™Flannel0åœ¨å‘é€Docker0ç½‘æ¡¥å…¶å‘ç°è®¿é—®çš„åœ°å€ä¸º10.1.20.3åˆ™å°†è¯·æ±‚è¿›è¡Œé‡æ–°å°è£…åè½¬å‘</span><br><span class="line">8.Backendè·å¾—è¯·æ±‚çš„æ•°æ®åŒ…</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Flannelè·¨Podé€šä¿¡æµç¨‹: <code>Container A -&gt; vethx(Pod IP) -&gt; docker0 -&gt; flannel(0CNI) -&gt; Node A(ç‰©ç†ç½‘å¡) --&gt; Node B(ç‰©ç†ç½‘å¡) -&gt; flannel(0CNI) -&gt;  docker0 -&gt; vethx (Pod IP) -&gt; Container B</code></p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201101223859.png" target="_blank" title="WeiyiGeek.Flannelè·¨Podé€šä¿¡æµç¨‹" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201101223859.png" alt="WeiyiGeek.Flannelè·¨Podé€šä¿¡æµç¨‹" title="" class=""></a>
                <p>WeiyiGeek.Flannelè·¨Podé€šä¿¡æµç¨‹</p>
            </figure>
<p><br/></p>
<p><strong>è¡¥å……è¯´æ˜:</strong></p>
<ul>
<li><p>(1) Docker å¯ä»¥ä¸ Flannel ç½‘ç»œæ¨¡å‹è¿›è¡Œé›†æˆé…ç½®;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir -vp /usr/lib/systemd/system/docker.service.d/</span><br><span class="line">~$ tee -a /usr/lib/systemd/system/docker.service.d/flannel.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Service]</span><br><span class="line">environmentFile=-/run/flannel/docker</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ cat /run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>(2) Flannel æ”¯æŒ 2 ç§ä¸åŒçš„åç«¯å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>Host-gwï¼šéœ€è¦ä¸¤ä¸ª Node å¤„äºåŒä¸€ç½‘æ®µï¼Œä¸æ”¯æŒè·¨ç½‘ï¼Œå› æ­¤ä¸é€‚åˆå¤§è§„æ¨¡éƒ¨ç½²ã€‚</li>
<li>VXLANï¼šä½¿ç”¨ VXLAN æŠ€æœ¯ä¸ºå„ Node åˆ›å»ºä¸€ä¸ªå¯ä»¥äº’é€šçš„ Pod ç½‘ç»œï¼Œä½¿ç”¨çš„ç«¯å£ä¸º UDP 8472ã€‚</li>
</ul>
</li>
</ul>
<p><br/></p>
<h4 id="2-Calico"><a href="#2-Calico" class="headerlink" title="(2) Calico"></a>(2) Calico</h4><p>æè¿°: Calico æ˜¯ä¸€ä¸ªçº¯ä¸‰å±‚çš„æ•°æ®ä¸­å¿ƒç½‘ç»œæ–¹æ¡ˆï¼Œè€Œä¸”æ— ç¼é›†æˆåƒOpenStackè¿™ç§IaaSäº‘æ¶æ„ï¼Œèƒ½å¤Ÿæä¾›å¯æ§çš„VM/å®¹å™¨/è£¸æœºä¹‹é—´çš„IPé€šä¿¡ã€‚å…¶é‡‡ç”¨è™šæ‹Ÿè·¯ç”±æ›¿ä»£è™šæ‹Ÿäº¤æ¢ï¼Œæ¯å°è™šæ‹Ÿè·¯ç”±é€šè¿‡<code>BGPåè®®</code>ä¼ æ’­å¯è¾¾ä¿¡æ¯(è·¯ç”±)åˆ°å‰©ä½™æ•°æ®ä¸­å¿ƒã€‚</p>
<p><strong>åŸç†è§£æ</strong><br>æè¿°: Calico åœ¨æ¯ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹åˆ©ç”¨Linux Kernel å®ç°ä¸€ä¸ªé«˜æ•ˆçš„vRouteræ¥è´Ÿè´£æ•°æ®çš„è½¬å‘ï¼Œè€Œæ¯ä¸ªvRouteré€šè¿‡BGPåè®®è´Ÿè´£æŠŠè‡ªå·±è¿è¡Œçš„Workloadçš„è·¯ç”±ä¿¡æ¯å‘æ•´ä¸ªCalicoç½‘ç»œä¼ æ’­(<code>å°è§„æ¨¡å¯ä»¥ç›´æ¥äº’è”è€Œåœ¨å¤§è§„æ¨¡ä¸‹å¯é€šè¿‡æŒ‡å®šçš„BGP Route Reflectoræ¥å®Œæˆ</code>)ã€‚</p>
<p><br></p>
<p><strong>Calico æ¶æ„</strong></p>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314222310.png" target="_blank" title="WeiyiGeek.æ¶æ„å›¾" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314222310.png" alt="WeiyiGeek.æ¶æ„å›¾" title="" class=""></a>
                <p>WeiyiGeek.æ¶æ„å›¾</p>
            </figure>
<p><br></p>
<p><strong>Calico ç»„ä»¶åŠŸèƒ½(é‡ç‚¹):</strong></p>
<ul>
<li>Felixï¼ˆCalico agentï¼‰ï¼šè¿è¡Œåœ¨æ¯ä¸ª Node ä¸Šï¼Œä¸ºå®¹å™¨è®¾ç½®ç½‘ç»œä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šIP åœ°å€ã€è·¯ç”±è§„åˆ™ï¼ŒIPtables è§„åˆ™ç­‰ã€‚</li>
<li>Birdï¼ˆBGP Clientï¼‰ï¼šè¿è¡Œåœ¨æ¯ä¸ª Node ä¸Šï¼Œç›‘å¬ç”± Felix æ³¨å…¥çš„è·¯ç”±ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ BGP åè®®å¹¿æ’­å‘Šè¯‰å…¶ä»– Nodesï¼Œä»è€Œå®ç°ç½‘ç»œäº’é€šã€‚</li>
<li>BGP Route Reflectorï¼šBGP Peer å»ºç«‹çš„æ–¹å¼å¤šæ ·ï¼Œå¯ä»¥åœ¨ Node ä¹‹é—´ä¸¤ä¸¤å»ºç«‹ BPGP Peerï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ï¼Œå’Œä¼ ç»Ÿ iBGP Peer é—®é¢˜ç±»ä¼¼ï¼Œè¿™ä¼šå¸¦æ¥ n*(n-1)/2 çš„é‚»å±…é‡ã€‚å› æ­¤ä¹Ÿå¯ä»¥è‡ªå»º RR åå°„å™¨ï¼ŒNode å’Œ RR å»ºç«‹ Peerã€‚å½“ç„¶ Node ä¹Ÿå¯ä»¥å’Œ TOR å»ºç«‹ Peerã€‚å…·ä½“é€‰æ‹©å“ªç§ Peer æ–¹å¼æ²¡æœ‰å›ºå®šæ ‡å‡†ï¼Œè¦é€‚é…æ€»ä½“ç½‘ç»œè§„åˆ’ï¼Œåªè¦æœ€ç»ˆä¿è¯å®¹å™¨ç½‘ç»œå¯æ­£ç¡®å‘å¸ƒåˆ°ç‰©ç†ç½‘ç»œå³å¯ï¼›</li>
<li>Etcd : åˆ†å¸ƒå¼é”®å€¼æ•°æ®åº“ï¼Œè´Ÿè´£ç½‘ç»œå…ƒæ•°æ®çš„ä¸€è‡´æ€§ä»¥åŠCalicoç½‘ç»œçŠ¶æ€çš„å‡†ç¡®æ€§ã€‚</li>
<li>Calicoctlï¼šå‘½ä»¤è¡Œç®¡ç†å·¥å…·ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314222200.png" target="_blank" title="WeiyiGeek.ç»„ä»¶åŠŸèƒ½å›¾" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314222200.png" alt="WeiyiGeek.ç»„ä»¶åŠŸèƒ½å›¾" title="" class=""></a>
                <p>WeiyiGeek.ç»„ä»¶åŠŸèƒ½å›¾</p>
            </figure>
<p>Tips : Calico å…¶ä¸ä½¿ç”¨é‡å çš„ç½‘ç»œæ¯”å¦‚Flannel å’Œ Libnetwork ç½‘ç»œé©±åŠ¨ã€‚<br>Tips : Calico èŠ‚ç‚¹ç»„ç½‘å¯ç›´æ¥åˆ©ç”¨æ•°æ®ä¸­å¿ƒçš„ç½‘ç»œç»“æœæ— è®ºæ˜¯(L2æˆ–è€…L3)ï¼Œä¸éœ€è¦é¢å¤–çš„NATä»¥åŠéš§é“æˆ–è€…Overlay Network;<br>Tips : Calico åŸºäºIPtablesè¿˜æä¾›äº†ä¸°å¯Œè€Œåˆçµæ´»çš„ç½‘ç»œPolicy, ä¿è¯é€šè¿‡å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ACLsæ¥æä¾›Workloadçš„å¤šç§Ÿæˆ·éš”ç¦»ã€å®‰å…¨ç»„ä»¥åŠå…¶å®ƒå¯è¾¾é™åˆ¶ç­‰åŠŸèƒ½ã€‚</p>
<p><br></p>
<p><strong>Calico æ”¯æŒ 3 ç§è·¯ç”±æ¨¡å¼ï¼š</strong></p>
<ul>
<li>1) Direct è·¯ç”±è½¬å‘ï¼ŒæŠ¥æ–‡ä¸åšå°è£…ï¼›</li>
<li>2) IP-in-IPï¼ˆDefaultï¼‰å°è£…ï¼›</li>
<li>3) VXLAN å°è£…ï¼›</li>
</ul>
<p>è¿™é‡Œä¸»è¦ä»‹ç» Direct æ¨¡å¼ï¼Œä½¿ç”¨ BGP è·¯ç”±åè®®å®£å‘Šå®¹å™¨ç½‘æ®µï¼Œä½¿å¾—å…¨ç½‘æ‰€æœ‰çš„ Nodes å’Œç½‘ç»œè®¾å¤‡éƒ½æœ‰åˆ°å½¼æ­¤çš„è·¯ç”±çš„ä¿¡æ¯ï¼Œç„¶åç›´æ¥é€šè¿‡ Underlay è½¬å‘ã€‚</p>
<p><strong>é€šä¿¡æµç¨‹:</strong><br>æ•°æ®é€šä¿¡çš„æµç¨‹ä¸º<code>æ•°æ®åŒ…å…ˆä» Veth Pair çš„ä¸€ç«¯å‘å‡ºï¼Œåˆ°è¾¾ Node ä¸Šçš„ä»¥ Cali ä¸ºå‰ç¼€çš„è™šæ‹Ÿç½‘å¡ä¸Šï¼Œä¹Ÿå°±åˆ°è¾¾äº† Host çš„å†…æ ¸ç½‘ç»œåè®®æ ˆ, ç„¶åæŸ¥è¯¢è·¯ç”±è¡¨è½¬å‘</code>ï¼›å› ä¸ºæœ¬åœ°èŠ‚ç‚¹é€šè¿‡ Bird å’Œ RR å»ºç«‹ BGP é‚»å±…å…³ç³»ï¼Œä¼šå°†æœ¬åœ°çš„å®¹å™¨åœ°å€å‘é€åˆ° RR ä»è€Œåå°„åˆ°ç½‘ç»œä¸­çš„å…¶å®ƒ Nodes ä¸Šï¼ŒåŒæ ·å…¶å®ƒ Nodes çš„ç½‘ç»œåœ°å€ä¹Ÿä¼šä¼ é€åˆ°æœ¬åœ°ï¼Œç„¶åç”± Felix è¿›ç¨‹è¿›è¡Œç®¡ç†å¹¶ä¸‹å‘åˆ°è·¯ç”±è¡¨ä¸­ï¼ŒæŠ¥æ–‡åŒ¹é…è·¯ç”±è§„åˆ™åæ­£å¸¸è¿›è¡Œè½¬å‘å³å¯ï¼ˆå®é™…è¿˜æœ‰å¤æ‚çš„ iptables è§„åˆ™è¿™é‡Œä¸åšå±•å¼€ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è™šæ‹Ÿæ¥å£</span></span><br><span class="line">~$ ip addr | egrep -v <span class="string">"^\s"</span></span><br><span class="line">  <span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></span><br><span class="line">  <span class="comment"># 2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span></span><br><span class="line">  <span class="comment"># 3: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000</span></span><br><span class="line">  <span class="comment"># 4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span></span><br><span class="line">  <span class="comment"># 5: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default</span></span><br><span class="line">  <span class="comment"># 6: calib6c39f0a1d5@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default</span></span><br><span class="line">  <span class="comment"># 7: calic77cbbaf4da@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default</span></span><br><span class="line">  <span class="comment"># 97: veth09836f7@if96: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span></span><br><span class="line">  <span class="comment"># 117: veth867869c@if116: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NAT è½¬å‘è¡¨ä»¥åŠäº”æ¡é“¾</span></span><br><span class="line"><span class="comment"># PREROUTING:æ•°æ®åŒ…è¿›å…¥è·¯ç”±è¡¨ä¹‹å‰</span></span><br><span class="line"><span class="comment"># INPUT:é€šè¿‡è·¯ç”±è¡¨åç›®çš„åœ°ä¸ºæœ¬æœº</span></span><br><span class="line"><span class="comment"># FORWARDING:é€šè¿‡è·¯ç”±è¡¨åï¼Œç›®çš„åœ°ä¸ä¸ºæœ¬æœº</span></span><br><span class="line"><span class="comment"># OUTPUT:ç”±æœ¬æœºäº§ç”Ÿï¼Œå‘å¤–è½¬å‘</span></span><br><span class="line"><span class="comment"># POSTROUTIONG:å‘é€åˆ°ç½‘å¡æ¥å£ä¹‹å‰ã€‚</span></span><br><span class="line">~$ sudo iptables -S -t nat | grep <span class="string">"cali"</span></span><br><span class="line">  <span class="comment"># -N cali-OUTPUT</span></span><br><span class="line">  <span class="comment"># -N cali-POSTROUTING</span></span><br><span class="line">  <span class="comment"># -N cali-PREROUTING</span></span><br><span class="line">  <span class="comment"># -N cali-fip-dnat</span></span><br><span class="line">  <span class="comment"># -N cali-fip-snat</span></span><br><span class="line">  <span class="comment"># -N cali-nat-outgoing</span></span><br><span class="line">  <span class="comment"># -A PREROUTING -m comment --comment "cali:6gwbT8clXdHdC1b1" -j cali-PREROUTING</span></span><br><span class="line">  <span class="comment"># -A OUTPUT -m comment --comment "cali:tVnHkvAo15HuiPy0" -j cali-OUTPUT</span></span><br><span class="line">  <span class="comment"># -A POSTROUTING -m comment --comment "cali:O3lYWMrLQYEMJtB5" -j cali-POSTROUTING</span></span><br><span class="line">  <span class="comment"># -A cali-OUTPUT -m comment --comment "cali:GBTAv2p5CwevEyJm" -j cali-fip-dnat</span></span><br><span class="line">  <span class="comment"># -A cali-POSTROUTING -m comment --comment "cali:Z-c7XtVd2Bq7s_hA" -j cali-fip-snat</span></span><br><span class="line">  <span class="comment"># -A cali-POSTROUTING -m comment --comment "cali:nYKhEzDlr11Jccal" -j cali-nat-outgoing</span></span><br><span class="line">  <span class="comment"># -A cali-POSTROUTING -o tunl0 -m comment --comment "cali:SXWvdsbh4Mw7wOln" -m addrtype ! --src-type LOCAL --limit-iface-out -m addrtype --src-type LOCAL -j MASQUERADE --random-fully</span></span><br><span class="line">  <span class="comment"># -A cali-PREROUTING -m comment --comment "cali:r6XmIziWUJsdOK6Z" -j cali-fip-dnat</span></span><br><span class="line">  <span class="comment"># -A cali-nat-outgoing -m comment --comment "cali:flqWnvo8yq4ULQLa" -m set --match-set cali40masq-ipam-pools src -m set ! --match-set cali40all-ipam-pools dst -j MASQUERADE --random-fully</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314222849.png" target="_blank" title="WeiyiGeek.é€šè®¯å›¾ç¤º" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210314222849.png" alt="WeiyiGeek.é€šè®¯å›¾ç¤º" title="" class=""></a>
                <p>WeiyiGeek.é€šè®¯å›¾ç¤º</p>
            </figure>
<p><br></p>
<h4 id="3-CoreDNS"><a href="#3-CoreDNS" class="headerlink" title="(3) CoreDNS"></a>(3) CoreDNS</h4><p>æè¿°: Kubernetes å°±æ˜¯é€šè¿‡ä½¿ç”¨å®¹å™¨å·æ˜ å°„çš„åŠŸèƒ½ä¿®æ”¹ <code>/etc/resolv.conf</code>ï¼Œä½¿é›†ç¾¤çš„æ‰€æœ‰å®¹å™¨éƒ½ä½¿ç”¨é›†ç¾¤ DNS æœåŠ¡å™¨(CoreDNS)è¿›è¡Œ DNS è§£æ, é»˜è®¤çš„é›†ç¾¤DNSåç§°ä¸º<code>svc.cluster.local</code>ã€‚</p>
<p>æ–‡æ¡£å‚è€ƒåœ°å€: <a href="https://coredns.io/manual/toc/" target="_blank" rel="noopener">https://coredns.io/manual/toc/</a><br>åº”ç”¨åœºæ™¯: <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/</a><br>åº”ç”¨åœºæ™¯: <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/</a></p>
<p>Tips : åœ¨ K8s ä¸­å®ƒè¢«ç”¨äºæä¾›æœåŠ¡å‘ç°åŠŸèƒ½; CoreDNS æœ€å¤§çš„ç‰¹ç‚¹æ˜¯çµæ´»ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç»™å®ƒç¼–å†™æ’ä»¶ä»¥æä¾›æ–°åŠŸèƒ½ã€‚åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œç›¸æ¯”ä¼ ç»Ÿ DNS æœåŠ¡å™¨ï¼Œå®ƒéå¸¸â€œç°ä»£åŒ–â€ã€‚</p>
<p><br/></p>
<p><strong>CoreDNS åº”ç”¨åœ¨k8såœºæ™¯</strong><br>æè¿°: ä¸»æµçš„æœ¬åœ° DNS æœåŠ¡å™¨ä¸­ï¼Œæä¾› UI ç•Œé¢çš„æœ‰ <code>Windows DNS Server</code> å’Œ ç¾¤æ™– <code>DNS Server</code>ï¼Œå¾ˆæ–¹ä¾¿ä¸è¿‡è¿™ä¸¤ä¸ªéƒ½æ˜¯æ“ä½œç³»ç»Ÿç»‘å®šçš„ã€‚</p>
<p>åœ¨å¼€æºçš„ DNS æœåŠ¡å™¨é‡Œè¾¹å„¿BIND å¥½åƒæ˜¯æœ€æœ‰åçš„ï¼Œå„å¤§ Linux å‘è¡Œç‰ˆè‡ªå¸¦çš„ <code>dig/host/nslookup</code>ï¼Œæœ€åˆéƒ½æ˜¯ Bind æä¾›çš„å‘½ä»¤è¡Œå·¥å…·, ä¸è¿‡ä¸ºäº†ä¸€ä¸¾ä¸¤å¾—ï¼ˆDNS+K8sï¼‰å’±è¿˜æ˜¯ç›´æ¥å­¦ä¹  CoreDNS çš„ä½¿ç”¨ã€‚ã€‚</p>
<p><br/></p>
<p>ç¤ºä¾‹1.åœ¨k8sä¸­é›†ç¾¤å†…éƒ¨æœåŠ¡å‘ç°ä¸ç»‘å®šé‡‡ç”¨çš„æ˜¯CoreDNSå¦‚ä¸‹æ‰€ç¤º:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) ä¾‹å¦‚ æˆ‘ä»¬è®¾ç½® /etc/resolv.conf å¦‚ä¸‹</span></span><br><span class="line"><span class="comment"># nameserver 192.168.12.254</span></span><br><span class="line"><span class="comment"># search weiyigeek.top weiyigeek.cn</span></span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line"><span class="comment"># ndots:5 æ˜¯æŒ‡å°‘äº 5 ä¸ª dots çš„åŸŸåï¼Œéƒ½é¦–å…ˆå½“ä½œé FQDN çœ‹å¾…ä¼˜å…ˆåœ¨æœç´¢åŸŸé‡Œé¢æŸ¥æ‰¾;</span></span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) è¾“å…¥ä¸€ä¸ªä¸å­˜åœ¨çš„åŸŸåæŸ¥çœ‹å°è¯•è¿‡ç¨‹</span></span><br><span class="line">~$ host -v weiyigeek</span><br><span class="line">  <span class="comment"># Trying "weiyigeek.default.svc.cluster.local"</span></span><br><span class="line">  <span class="comment"># Trying "weiyigeek.svc.cluster.local"</span></span><br><span class="line">  <span class="comment"># Trying "weiyigeek.cluster.local"</span></span><br><span class="line">  <span class="comment"># Trying "weiyigeek"</span></span><br><span class="line">  <span class="comment"># Host weiyigeek not found: 3(NXDOMAIN)</span></span><br><span class="line">  <span class="comment"># Received 102 bytes from 10.96.0.10#53 in 47 ms</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>CoreDNS é…ç½®å¤–éƒ¨DNS</strong><br>æè¿°: æ¥ä¸‹æ¥ä»¥ CoreDNS ä¸ºä¾‹ï¼Œè®²è¿°å¦‚ä½•é…ç½®ä¸€ä¸ª DNS æœåŠ¡å™¨ï¼Œæ·»åŠ ç§æœ‰çš„ DNS è®°å½•ï¼Œå¹¶è®¾ç½®è½¬å‘è§„åˆ™ä»¥è§£æå…¬ç½‘åŸŸåã€‚</p>
<ol>
<li>é…ç½®æ–‡ä»¶ï¼šCorefile<br>CoreDNS å› ä¸ºæ˜¯ Go è¯­è¨€å†™çš„ï¼Œç¼–è¯‘ç»“æœæ˜¯å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒé»˜è®¤ä»¥å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„ Corefile ä¸ºé…ç½®æ–‡ä»¶ã€‚ä»¥ kubernetes ä¸­çš„ Corefile ä¸ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.:53 &#123;</span><br><span class="line">    errors  <span class="comment"># å¯ç”¨é”™è¯¯æ—¥å¿—</span></span><br><span class="line">    health  <span class="comment"># å¯ç”¨å¥åº·æ£€æŸ¥ api</span></span><br><span class="line">    ready  <span class="comment"># å¯ç”¨ readiness å°±ç»ª api</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯ç”¨ kubernetes é›†ç¾¤æ”¯æŒï¼Œè¯¦è§ https://coredns.io/plugins/kubernetes/</span></span><br><span class="line">    <span class="comment"># æ­¤æ’ä»¶åªå¤„ç† cluster.local åŸŸï¼Œä»¥åŠ PTR è§£æ</span></span><br><span class="line">    kubernetes cluster.local <span class="keyword">in</span>-addr.arpa ip6.arpa &#123;</span><br><span class="line">      pods insecure</span><br><span class="line">      upstream  <span class="comment"># </span></span><br><span class="line">      fallthrough <span class="keyword">in</span>-addr.arpa ip6.arpa  <span class="comment"># å‘ä¸‹ä¼ é€’ DNS åå‘æŸ¥è¯¢</span></span><br><span class="line">      ttl 30  <span class="comment"># è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    &#125;</span><br><span class="line">    prometheus :9153  <span class="comment"># å¯ç”¨ prometheus metrics æ”¯æŒ</span></span><br><span class="line">    forward . 114.114.114.114 19.29.29.29 <span class="comment"># å°†éé›†ç¾¤åŸŸåçš„ DNS è¯·æ±‚ï¼Œè½¬å‘ç»™å…¬ç½‘ DNS æœåŠ¡å™¨ã€‚</span></span><br><span class="line">    cache 30  <span class="comment"># å¯ç”¨å‰ç«¯ç¼“å­˜ï¼Œç¼“å­˜çš„ TTL è®¾ä¸º 30</span></span><br><span class="line">    loop    <span class="comment"># æ£€æµ‹å¹¶åœæ­¢æ­»å¾ªç¯è§£æ</span></span><br><span class="line">    reload  <span class="comment"># æ”¯æŒåŠ¨æ€æ›´æ–° Corefile</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># éšæœºåŒ– A/AAAA/MX è®°å½•çš„é¡ºåºä»¥å®ç°è´Ÿè½½å‡è¡¡ã€‚</span></span><br><span class="line">    <span class="comment">#   å› ä¸º DNS resolver é€šå¸¸ä½¿ç”¨ç¬¬ä¸€æ¡è®°å½•ï¼Œè€Œç¬¬ä¸€æ¡è®°å½•æ˜¯éšæœºçš„ã€‚è¿™æ ·å®¢æˆ·ç«¯çš„è¯·æ±‚å°±èƒ½è¢«éšæœºåˆ†é…åˆ°å¤šä¸ªåç«¯ã€‚</span></span><br><span class="line">    loadbalance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Corefile é¦–å…ˆå®šä¹‰ DNS åŸŸï¼ŒåŸŸåçš„ä»£ç å—å†…å®šä¹‰éœ€è¦ä½¿ç”¨çš„å„ç§æ’ä»¶ã€‚æ³¨æ„è¿™é‡Œçš„æ’ä»¶é¡ºåºæ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ï¼æ’ä»¶çš„è°ƒç”¨é“¾æ˜¯åœ¨ CoreDNS ç¼–è¯‘æ—¶å°±å®šä¹‰å¥½çš„ï¼Œä¸èƒ½åœ¨è¿è¡Œæ—¶æ›´æ”¹ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°é…ç½®å¯åŠ¨çš„ CoreDNS æ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒä»¥ Kubernetes ApiServer ä¸ºæ•°æ®æºï¼ŒCoreDNS æœ¬èº«åªç›¸å½“äºä¸€ä¸ªæŸ¥è¯¢å™¨/ç¼“å­˜ï¼Œå› æ­¤å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰©ç¼©å®¹ã€‚</p>
<ol start="2">
<li>å°† CoreDNS è®¾ç½®æˆä¸€ä¸ªç§æœ‰ DNS æœåŠ¡å™¨<br>ç°åœ¨æ¸…æ¥šäº† Corefile çš„ç»“æ„ï¼Œè®©æˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªé€šè¿‡æ–‡ä»¶é…ç½® DNS æ¡ç›®çš„ Corefile é…ç½®ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># å®šä¹‰å¯å¤ç”¨ Block</span><br><span class="line">(common) &#123;</span><br><span class="line">    log</span><br><span class="line">    errors</span><br><span class="line">    cache</span><br><span class="line">    loop    # æ£€æµ‹å¹¶åœæ­¢æ­»å¾ªç¯è§£æ</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># æœ¬åœ°å¼€å‘ç¯å¢ƒçš„ DNS è§£æ</span><br><span class="line">dev-env.local:<span class="number">53</span> &#123;</span><br><span class="line">    <span class="keyword">import</span> common  # å¯¼å…¥ Block</span><br><span class="line">    file dev-env.local &#123; # ä»æ–‡ä»¶ <span class="string">`dev-env.local`</span> ä¸­è¯»å– DNS æ•°æ®</span><br><span class="line">        reload <span class="number">30s</span>  # æ¯ <span class="number">30s</span> æ£€æŸ¥ä¸€æ¬¡é…ç½®çš„ Serialï¼Œè‹¥è¯¥å€¼æœ‰å˜æ›´åˆ™é‡è½½æ•´ä¸ª Zone çš„é…ç½®ã€‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># æœ¬åœ°æµ‹è¯•ç¯å¢ƒ</span><br><span class="line">test-env.local:<span class="number">53</span> &#123;</span><br><span class="line">    <span class="keyword">import</span> common</span><br><span class="line">    file test-env.local &#123;</span><br><span class="line">        reload <span class="number">30s</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># å…¶ä»–</span><br><span class="line">.:<span class="number">53</span> &#123;</span><br><span class="line">    forward . <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>  # è§£æå…¬ç½‘åŸŸå</span><br><span class="line">    log</span><br><span class="line">    errors</span><br><span class="line">    cache</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ä¸Šé¢çš„ Corefile å®šä¹‰äº†ä¸¤ä¸ªæœ¬åœ°åŸŸå dev-env.local å’Œ test-env.localï¼Œå®ƒä»¬çš„ DNS æ•°æ®åˆ†åˆ«ä¿å­˜åœ¨ file æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚</p>
<p>è¿™ä¸ª file æŒ‡å®šçš„æ–‡ä»¶å’Œ bind9 ä¸€æ ·ï¼Œéƒ½æ˜¯ä½¿ç”¨åœ¨ rfc1035 ä¸­å®šä¹‰çš„ Master File æ ¼å¼ï¼Œdig å‘½ä»¤è¾“å‡ºçš„å°±æ˜¯è¿™ç§æ ¼å¼çš„å†…å®¹ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">;; èˆ‡æ•´å€‹é ˜åŸŸç›¸é—œæ€§è¼ƒé«˜çš„è¨­å®šåŒ…æ‹¬ NS, A, MX, SOA ç­‰æ¨™èªŒçš„è¨­å®šè™•ï¼</span><br><span class="line">$TTL    <span class="number">30</span></span><br><span class="line">@                       IN SOA   dev-env.local. devops.dev-env.local. (</span><br><span class="line">                                     <span class="number">20200202</span> ; SERIALï¼Œæ¯æ¬¡ä¿®æ”¹æ­¤æ–‡ä»¶ï¼Œéƒ½åº”è¯¥åŒæ­¥ä¿®æ”¹è¿™ä¸ªâ€œç‰ˆæœ¬å·â€ï¼Œå¯å°†å®ƒè®¾ä¸ºä¿®æ”¹æ—¶é—´ã€‚</span><br><span class="line">                                     <span class="number">7200</span>     ; REFRESH</span><br><span class="line">                                     <span class="number">600</span>      ; RETRY</span><br><span class="line">                                     <span class="number">3600000</span>  ; EXPIRE</span><br><span class="line">                                     <span class="number">60</span>)      ; MINIMUM</span><br><span class="line">@                       IN NS    dns1.dev-env.local.   ; DNS ä¼ºæœå™¨åç¨±</span><br><span class="line">dns1.dev-env.local.    IN A     <span class="number">192.168</span><span class="number">.23</span><span class="number">.2</span>         ; DNS ä¼ºæœå™¨ IP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis.dev-env.local.         IN A     <span class="number">192.168</span><span class="number">.23</span><span class="number">.21</span></span><br><span class="line">mysql.dev-env.local.         IN A     <span class="number">192.168</span><span class="number">.23</span><span class="number">.22</span></span><br><span class="line">elasticsearch.dev-env.local. IN A     <span class="number">192.168</span><span class="number">.23</span><span class="number">.23</span></span><br><span class="line">ftp                          IN A     <span class="number">192.168</span><span class="number">.23</span><span class="number">.25</span>  ;</span><br></pre></td></tr></table></figure></p>
<p>test-env.local ä¹Ÿæ˜¯ä¸€æ ·çš„æ ¼å¼ï¼Œæ ¹æ®ä¸Šé¢çš„æ¨¡æ¿ä¿®æ”¹å°±è¡Œ, å°†è¿™ä¸¤ä¸ªé…ç½®æ–‡ä»¶å’Œ Corefile æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="built_in">test</span>-ubuntu:~/dns-server<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ coredns  <span class="comment"># coredns binary</span></span><br><span class="line">â”œâ”€â”€ Corefile</span><br><span class="line">â”œâ”€â”€ dev-env.local</span><br><span class="line">â””â”€â”€ <span class="built_in">test</span>-env.local</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åé€šè¿‡ ./coredns å¯åŠ¨ corednsã€‚é€šè¿‡ dig æ£€éªŒä¸å‡ºæ„å¤–å°±å¯ä»¥çœ‹åˆ° ftp.dev-env.local å·²ç»è¢«æˆåŠŸè§£æäº†ã€‚</p>
<ol start="3">
<li><p>å¯é€‰æ’ä»¶ï¼ˆExternal Pluginsï¼‰<br>CoreDNS æä¾›çš„é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼Œä¸åŒ…å« External Plugins ä¸­åˆ—å‡ºçš„éƒ¨åˆ†ï¼Œå¦‚æœä½ éœ€è¦ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹ plugin.cfgï¼Œç„¶åæ‰‹åŠ¨ç¼–è¯‘ã€‚ä¸å¾—ä¸è¯´ Go è¯­è¨€çš„ç¼–è¯‘ï¼Œæ¯” C è¯­è¨€æ˜¯æ–¹ä¾¿å¤ªå¤šäº†ã€‚è‡ªåŠ¨æ‹‰å–ä¾èµ–ä¸€è¡Œå‘½ä»¤ç¼–è¯‘ï¼åªè¦é…å¥½ GOPROXYï¼Œå¯ç”¨å¯é€‰æ’ä»¶å…¶å®ç›¸å½“ç®€å•ã€‚</p>
</li>
<li><p>è®¾ç½® DNS é›†ç¾¤<br>å•å° DNS æœåŠ¡å™¨çš„æ€§èƒ½æ˜¯æœ‰é™çš„ï¼Œè€Œä¸”å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ã€‚å› æ­¤åœ¨è¦æ±‚é«˜å¯ç”¨æˆ–è€…é«˜æ€§èƒ½çš„æƒ…å†µä¸‹ï¼Œå°±éœ€è¦è®¾ç½® DNS é›†ç¾¤ã€‚</p>
</li>
</ol>
<p>è™½ç„¶è¯´ CoreDNS æœ¬èº«ä¹Ÿæ”¯æŒå„ç§ DNS Zone ä¼ è¾“ï¼Œä¸»ä» DNS æœåŠ¡å™¨ç­‰åŠŸèƒ½ï¼Œä¸è¿‡æˆ‘æƒ³æœ€ç®€å•çš„ï¼Œå¯èƒ½è¿˜æ˜¯ç›´æ¥ç”¨ K8sã€‚</p>
<p>ç›´æ¥ç”¨ ConfigMap å­˜é…ç½®ï¼Œé€šè¿‡ Deployment æ‰©å®¹å°±è¡Œï¼Œå¤šæ–¹ä¾¿ã€‚</p>
<p>è¦ä¿®æ”¹èµ·æ¥æ›´æ–¹ä¾¿ï¼Œè¿˜å¯ä»¥å¯ç”¨å¯é€‰æ’ä»¶ï¼šredisï¼Œç›´æ¥æŠŠé…ç½®ä»¥ json çš„å½¢å¼å­˜åœ¨ redis é‡Œï¼Œé€šè¿‡ redis-desktop-manager è¿›è¡ŒæŸ¥çœ‹ä¸ä¿®æ”¹ã€‚</p>
<hr>
<h2 id="0x02-ç½‘ç»œç»„ä»¶æ€§èƒ½å¯¹æ¯”"><a href="#0x02-ç½‘ç»œç»„ä»¶æ€§èƒ½å¯¹æ¯”" class="headerlink" title="0x02 ç½‘ç»œç»„ä»¶æ€§èƒ½å¯¹æ¯”"></a>0x02 ç½‘ç»œç»„ä»¶æ€§èƒ½å¯¹æ¯”</h2><p><strong>1) CPU å‹åŠ›  ä½ -&gt; é«˜</strong></p>
<blockquote>
<p>å¯¹æ¯”ç»“æœ: host  &lt; Calico (BGP) &lt; Calico (IPIP) == Flannel (VXLAN) == Docker (VXLAN) &lt; Flannel(UDP) &lt; Weave (UDP)</p>
</blockquote>
<p><strong>2) å¸¦å®½(MB/Sec) ä½ -&gt; é«˜</strong></p>
<blockquote>
<p>å¯¹æ¯”ç»“æœ: Weave (UDP) &lt;  Flannel(UDP) &lt;  Flannel (VXLAN)  &lt; Docker (Overlay)  &lt; Calico (BGP) &lt; Calico (IPIP)  &lt; Host</p>
</blockquote>
<p><strong>3) å»¶è¿Ÿ(us) ä½ -&gt; é«˜</strong></p>
<blockquote>
<p>å¯¹æ¯”ç»“æœ: Host &lt; Calico (IPIP) &lt; Calico (BGP) &lt;  Flannel (VXLAN) &lt;  Flannel (udp)  &lt; Docker(Overlay)</p>
</blockquote>
<table>
<thead>
<tr>
<th>ç½‘ç»œæ–¹æ¡ˆ</th>
<th>Calico</th>
<th>Flannel</th>
<th>Docker Overlay</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¼˜åŠ¿</td>
<td>æ€§èƒ½å¥½ã€å¯é æ€§åŠéš”ç¦»æ€§å¥½</td>
<td>éƒ¨ç½²ç®€å•æ€§èƒ½è¿˜å¯ä»¥</td>
<td>DockeråŸç”Ÿæ€§èƒ½å‡‘åˆ</td>
</tr>
<tr>
<td>åŠ£åŠ¿</td>
<td>æ“ä½œå¤æ‚å¯¹IPtbalesä¾èµ–</td>
<td>æ— æ³•å®ç°å›ºå®šIPçš„å®¹å™¨æ¼‚ç§»ä»¥åŠæ— æ³•å­ç½‘éš”ç¦»ï¼Œå¯¹ä¸Šå±‚è®¾è®¡ä¾èµ–åº¦é«˜ï¼Œæ²¡æœ‰IPAMä»¥åŠIPåœ°å€æµªè´¹å¯¹Dockerå¯åŠ¨æ–¹å¼æœ‰ç»‘å®š</td>
<td>å¯¹å†…æ ¸ç‰ˆæœ¬æœ‰è¦æ±‚(&gt;3.16)å¹¶ä¸”dockerå®ˆæŠ¤è¿›ç¨‹ä¾èµ–äºConsulæˆ–è€…Etcd, æœ¬èº«é©±åŠ¨å®ç°è¿˜æ˜¯ç•¥å·®ç‚¹ã€‚é’ˆå¯¹äºNetworkä»¥åŠå¤šå­ç½‘éš”ç¦»å±€éƒ¨äº¤å‰çš„éœ€æ±‚è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„IPAMå¾ˆå·®ã€‚</td>
</tr>
</tbody>
</table>
<BR/>

<p>ç½‘ç»œç»„ä»¶æ€»ç»“: Calico BGPæ–¹æ¡ˆæœ€å¥½ä¸èƒ½ç”¨BGPä¹Ÿå¯ä»¥è€ƒè™‘<code>Calico ipip</code>tunnelæ–¹æ¡ˆï¼›å¦‚æœæ˜¯CoreOSç³»åˆèƒ½å¼€UDP Offloadï¼ŒFlannelæ˜¯ä¸é”™çš„é€‰æ‹©, DockeråŸç”ŸOverlayè¿˜æœ‰å¾ˆå¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚</p>
<hr>
<h2 id="0x03-Q-amp-A"><a href="#0x03-Q-amp-A" class="headerlink" title="0x03 Q&amp;A"></a>0x03 Q&amp;A</h2><p>Qï¼šAçš„Podå¦‚ä½•è¿æ¥Bçš„Podï¼Ÿ kube-dnsèµ·åˆ°ä»€ä¹ˆä½œç”¨ï¼Ÿ kube-dnså¦‚æœè°ƒç”¨kube-proxyï¼Ÿ</p>
<pre><code>Aï¼šè¿™é‡Œè¯´çš„Aå’ŒBåº”å½“æ˜¯æŒ‡Serviceï¼ŒA Serviceä¸­Podä¸B Service Podä¹‹é—´çš„é€šä¿¡ï¼Œå¯ä»¥åœ¨å…¶å®¹å™¨çš„ç¯å¢ƒå˜é‡ä¸­å®šä¹‰Service IPæˆ–æ˜¯Service Nameæ¥å®ç°ï¼›ç”±äºService IPæå‰ä¸çŸ¥é“ï¼Œä½¿ç”¨å¼•å…¥kube-dnsåšæœåŠ¡å‘ç°ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ç›‘å¬Serviceå˜åŒ–å¹¶æ›´æ–°DNSï¼Œå³Podé€šè¿‡æœåŠ¡åç§°å¯ä»¥æŸ¥è¯¢DNSï¼›kube-proxyæ˜¯ä¸€ä¸ªç®€å•çš„ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œå®ƒçš„ä½œç”¨ä¸»è¦æ˜¯è´Ÿè´£serviceçš„å®ç°ï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å®ç°äº†å†…éƒ¨ä»Podåˆ°Serviceå’Œå¤–éƒ¨çš„ä»NodePortå‘Serviceçš„è®¿é—®ï¼Œå¯ä»¥è¯´kube-dnså’Œkube-proxyéƒ½æ˜¯ä¸ºServiceæœåŠ¡çš„ã€‚
</code></pre><p>Qï¼šç½‘ç»œé—®é¢˜docker defaultæ˜¯ç½‘æ¡¥æ¨¡å¼ï¼ˆNATï¼‰ å¦‚æœç”¨è·¯ç”±çš„æ¨¡å¼ï¼Œæ‰€ä»¥Podçš„ç½‘å…³éƒ½ä¼šæ˜¯docker0 IP ï¼Ÿ é‚£Pod 1ä¸Pod 2ä¹‹é—´ä¹Ÿèµ°è·¯ç”± ï¼Œè¿™ä¼šä½¿è·¯ç”±è¡¨å¾ˆå¤§ï¼Ÿ Flannel ç½‘ç»œæ˜¯ä¸æ˜¯å¯ä»¥æŠŠæ‰€æœ‰çš„Nodeä¸Šï¼Œç›¸å½“äºä¸€ä¸ªåˆ†å¸ƒå¼äº¤æ¢æœºï¼Ÿ</p>
<pre><code>Aï¼šDockerå®ç°è·¨ä¸»æœºé€šä¿¡å¯ä»¥é€šè¿‡æ¡¥æ¥å’Œè·¯ç”±çš„æ–¹å¼ï¼Œæ¡¥æ¥çš„æ–¹å¼æ˜¯å°†docker0æ¡¥æ¥åœ¨ä¸»æœºçš„ç½‘å¡ä¸Šï¼Œè€Œè·¯ç”±ç›´æ¥é€šè¿‡ä¸»æœºç½‘å£è½¬å‘å‡ºå»ï¼›Kubernetesç½‘ç»œæœ‰Podå’ŒServerï¼ŒPodç½‘ç»œå®ç°çš„æ–¹å¼å¾ˆå¤šï¼Œå¯ä»¥å‚è€ƒCNIç½‘ç»œæ¨¡å‹ï¼ŒFlannelå®è´¨ä¸Šæ˜¯ä¸€ç§`â€œè¦†ç›–ç½‘ç»œï¼ˆOverlay Networkï¼‰â€`ï¼Œä¹Ÿå°±æ˜¯`å°†TCPæ•°æ®åŒ…è£…åœ¨å¦ä¸€ç§ç½‘ç»œåŒ…é‡Œé¢è¿›è¡Œè·¯ç”±è½¬å‘å’Œé€šä¿¡`ã€‚
</code></pre><p>Qï¼šå¤§è§„æ¨¡å®¹å™¨é›†ç¾¤å¦‚ä½•ä¿è¯å®‰å…¨? ä¸»è¦ä»å‡ ä¸ªæ–¹é¢è€ƒè™‘ï¼Ÿ</p>
<ul>
<li>A: ä¸€ä¸ªå¤§è§„æ¨¡å®¹å™¨é›†ç¾¤ä»å®‰å…¨æ€§è€ƒè™‘æ¥è®²ï¼Œå¯ä»¥åˆ†ä¸ºå‡ ä¸ªæ–¹é¢ï¼š</li>
<li>1ã€é›†ç¾¤å®‰å…¨ï¼ŒåŒ…æ‹¬é›†ç¾¤é«˜å¯ç”¨ï¼›</li>
<li>2ã€è®¿é—®å®‰å…¨ï¼ŒåŒ…æ‹¬è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ç­‰ï¼›</li>
<li>3ã€èµ„æºéš”ç¦»ï¼ŒåŒ…æ‹¬å¤šç§Ÿæˆ·ç­‰ï¼›</li>
<li>4ã€ç½‘ç»œå®‰å…¨ï¼ŒåŒ…æ‹¬ç½‘ç»œéš”ç¦»ã€æµé‡æ§åˆ¶ç­‰ï¼›</li>
<li>5ã€é•œåƒå®‰å…¨ï¼ŒåŒ…æ‹¬å®¹å™¨æ¼æ´ç­‰ï¼›</li>
<li>6ã€å®¹å™¨å®‰å…¨ï¼ŒåŒ…æ‹¬ç«¯å£æš´éœ²ã€privilegedæƒé™ç­‰ã€‚</li>
</ul>
<p>Qï¼šSVCå¦‚ä½•è¿›è¡Œå®¢æˆ·ç«¯åˆ†æµï¼ŒAç½‘æ®µçš„è®¿é—®Pod1 ï¼ŒBç½‘æ®µçš„è®¿é—®Pod2ï¼ŒCç½‘æ®µçš„è®¿é—®Pod3ï¼Œ3ä¸ªPodéƒ½åœ¨SVCçš„Endpointä¸­ï¼Ÿ</p>
<pre><code>Aï¼šå†…éƒ¨ä»Podåˆ°Serviceçš„å®ç°æ˜¯ç”±kube-proxyï¼ˆç®€å•çš„ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ï¼‰æ¥å®Œæˆï¼Œkube-proxyé»˜è®¤é‡‡ç”¨è½®è¯¢æ–¹æ³•è¿›è¡Œåˆ†é…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å°†service.spec.sessionAffinityè®¾ç½®ä¸ºâ€œClientIPâ€ï¼ˆé»˜è®¤ä¸ºâ€œæ— â€ï¼‰æ¥é€‰æ‹©åŸºäºå®¢æˆ·ç«¯IPçš„ä¼šè¯å…³è”ï¼Œç›®å‰è¿˜ä¸èƒ½è¿›è¡Œç½‘æ®µçš„æŒ‡å®šã€‚
</code></pre><p>Qï¼šå¯¹äºIngress+HAProxyè¿™ç§å®ç°Serviceè´Ÿè½½å‡è¡¡çš„æ–¹å¼ï¼ŒIngress controllerè½®è¯¢Serviceåé¢çš„PodsçŠ¶æ€ï¼Œå¹¶é‡æ–°ç”ŸæˆHAProxyé…ç½®æ–‡ä»¶ï¼Œç„¶åé‡å¯HAProxyï¼Œä»è€Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ç›®çš„ã€‚è¿™ç§åŸç†å¯¹äºHAProxyæ¥è®²æ˜¯ä¸æ˜¯æœåŠ¡ä¼šæš‚æ—¶é—´æ–­ã€‚æœ‰æ²¡æœ‰å¥½çš„æ›¿ä»£æ–¹æ¡ˆï¼Ÿä¹‹å‰çœ‹åˆ°Golangå®ç°çš„TrÃ¦fikï¼Œå¯æ— ç¼å¯¹æ¥Kubernetesï¼ŒåŒæ—¶ä¸éœ€è¦Ingressäº†ã€‚æ–¹æ¡ˆå¯è¡Œä¹ˆï¼Ÿ</p>
<pre><code>Aï¼šç”±äºå¾®æœåŠ¡æ¶æ„ä»¥åŠDockeræŠ€æœ¯å’ŒKubernetesç¼–æ’å·¥å…·æœ€è¿‘å‡ å¹´æ‰å¼€å§‹é€æ¸æµè¡Œï¼Œæ‰€ä»¥ä¸€å¼€å§‹çš„åå‘ä»£ç†æœåŠ¡å™¨æ¯”å¦‚Nginx/HAProxyå¹¶æœªæä¾›å…¶æ”¯æŒï¼Œæ¯•ç«Ÿä»–ä»¬ä¹Ÿä¸æ˜¯å…ˆçŸ¥ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°IngressControllerè¿™ç§ä¸œè¥¿æ¥åšKuberneteså’Œå‰ç«¯è´Ÿè½½å‡è¡¡å™¨å¦‚Nginx/HAProxyä¹‹é—´åšè¡”æ¥ï¼Œå³Ingress Controllerçš„å­˜åœ¨å°±æ˜¯ä¸ºäº†èƒ½è·ŸKubernetesäº¤äº’ï¼Œåˆèƒ½å†™ Nginx/HAProxyé…ç½®ï¼Œè¿˜èƒ½ reload å®ƒï¼Œè¿™æ˜¯ä¸€ç§æŠ˜ä¸­æ–¹æ¡ˆï¼›è€Œæœ€è¿‘å¼€å§‹å‡ºç°çš„Traefikå¤©ç”Ÿå°±æ˜¯æä¾›äº†å¯¹Kubernetesçš„æ”¯æŒï¼Œä¹Ÿå°±æ˜¯è¯´Traefikæœ¬èº«å°±èƒ½è·ŸKubernetes APIäº¤äº’ï¼Œæ„ŸçŸ¥åç«¯å˜åŒ–ï¼Œå› æ­¤åœ¨ä½¿ç”¨Traefikæ—¶å°±ä¸éœ€è¦Ingress Controllerï¼Œæ­¤æ–¹æ¡ˆå½“ç„¶å¯è¡Œã€‚
</code></pre><p>Qï¼š1ã€ä¸€ä¸ªPODé‡Œé¢çš„å¤šä¸ªContaineræ˜¯åŒä¸€ä¸ªServiceçš„ï¼Ÿè¿˜æ˜¯ç”±ä¸åŒçš„Serviceçš„ç»„æˆï¼Ÿ æ˜¯å•¥æ ·çš„åˆ†é…é€»è¾‘ï¼Ÿ 2ã€Flannel æ˜¯å®ç°å¤šä¸ªå®¿ä¸»æœºä¸Šçš„Nå¤šçš„Serviceä»¥åŠPodé‡Œé¢çš„å„ä¸ªContainerçš„IPçš„å”¯ä¸€æ€§ä¹ˆï¼Ÿ 3ã€Kuberneteså…·å¤‡è´Ÿè½½å‡è¡¡çš„æ•ˆæœ ã€‚é‚£æ˜¯å¦å°±ä¸ç”¨åœ¨è€ƒè™‘Nigixï¼Ÿ</p>
<pre><code>Aï¼šPodæ˜¯Kubernetesçš„åŸºæœ¬æ“ä½œå•å…ƒï¼ŒPodåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªç›¸å…³çš„å®¹å™¨ï¼ŒPodå¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„ä¸€ç§å»¶ä¼¸æ‰©å±•ï¼Œä¸€ä¸ªPodä¹Ÿæ˜¯ä¸€ä¸ªéš”ç¦»ä½“ï¼Œè€ŒPodå†…éƒ¨åŒ…å«çš„ä¸€ç»„å®¹å™¨åˆæ˜¯å…±äº«çš„ï¼ˆåŒ…æ‹¬PIDã€Networkã€IPCã€UTSï¼‰ï¼›Serviceæ˜¯Podçš„è·¯ç”±ä»£ç†æŠ½è±¡ï¼Œèƒ½è§£å†³Podä¹‹é—´çš„æœåŠ¡å‘ç°é—®é¢˜ï¼›Flannelçš„è®¾è®¡ç›®çš„å°±æ˜¯ä¸ºé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹é‡æ–°è§„åˆ’IPåœ°å€çš„ä½¿ç”¨è§„åˆ™ï¼Œä»è€Œä½¿å¾—ä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨èƒ½å¤Ÿè·å¾—â€œåŒå±ä¸€ä¸ªå†…ç½‘â€ä¸”â€ä¸é‡å¤çš„â€IPåœ°å€ï¼Œå¹¶è®©å±äºä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨èƒ½å¤Ÿç›´æ¥é€šè¿‡å†…ç½‘IPé€šä¿¡ï¼›Kubernetes kube-proxyå®ç°çš„æ˜¯å†…éƒ¨L4å±‚è½®è¯¢æœºåˆ¶çš„è´Ÿè½½å‡è¡¡ï¼Œè¦æ”¯æŒL4ã€L7è´Ÿè½½å‡è¡¡ï¼ŒKubernetesä¹Ÿæä¾›äº†Ingressç»„ä»¶ï¼Œé€šè¿‡åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨ï¼ˆNginx/HAProxyï¼‰+Ingress Controller+Ingresså¯ä»¥å®ç°å¯¹å¤–æœåŠ¡æš´éœ²ï¼Œå¦å¤–ä½¿ç”¨Traefikæ–¹æ¡ˆæ¥å®ç°Serviceçš„è´Ÿè½½å‡è¡¡ä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚
</code></pre><p>Qï¼škube-proxyæ˜¯æ€æ ·è¿›è¡Œè´Ÿè½½ï¼Ÿ Serviceè™šæ‹ŸIPå­˜åœ¨å“ªé‡Œï¼Ÿ</p>
<pre><code>Aï¼škube-proxyæœ‰2ä¸ªæ¨¡å¼å®ç°è´Ÿè½½å‡è¡¡ï¼Œä¸€ç§æ˜¯userspaceï¼Œé€šè¿‡Iptablesé‡å®šå‘åˆ°kube-proxyå¯¹åº”çš„ç«¯å£ä¸Šï¼Œç„¶åç”±kube-proxyè¿›ä¸€æ­¥æŠŠæ•°æ®å‘é€åˆ°å…¶ä¸­çš„ä¸€ä¸ªPodä¸Šï¼Œå¦ä¸€ç§æ˜¯Iptablesï¼Œçº¯é‡‡ç”¨Iptablesæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œkube-proxyé»˜è®¤é‡‡ç”¨è½®è¯¢æ–¹æ³•è¿›è¡Œåˆ†é…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å°†service.spec.sessionAffinityè®¾ç½®ä¸ºâ€œClientIPâ€ï¼ˆé»˜è®¤ä¸ºâ€œæ— â€ï¼‰æ¥é€‰æ‹©åŸºäºå®¢æˆ·ç«¯IPçš„ä¼šè¯å…³è”ï¼›Service Cluster IPå®ƒæ˜¯ä¸€ä¸ªè™šæ‹ŸIPï¼Œæ˜¯ç”±kube-proxyä½¿ç”¨Iptablesè§„åˆ™é‡æ–°å®šå‘åˆ°å…¶æœ¬åœ°ç«¯å£ï¼Œå†å‡è¡¡åˆ°åç«¯Podçš„ï¼Œé€šè¿‡ apiserverçš„å¯åŠ¨å‚æ•°--service-cluster-ip-rangeæ¥è®¾ç½®ï¼Œç”±kubernetesé›†ç¾¤å†…éƒ¨ç»´æŠ¤ã€‚
</code></pre><p>Qï¼šKubernetesç½‘ç»œå¤æ‚ï¼Œå¦‚æœè¦å®ç°è¿œç¨‹è°ƒè¯•ï¼Œè¯¥æ€ä¹ˆåšï¼Œç«¯å£æ˜ å°„çš„æ–¹å¼ä¼šæœ‰ä»€ä¹ˆæ ·çš„éšæ‚£ï¼Ÿ</p>
<pre><code>Aï¼šKubernetesç½‘ç»œè¿™å—é‡‡ç”¨çš„æ˜¯CNIè§„èŒƒï¼Œç½‘ç»œæ’ä»¶åŒ–ï¼Œéå¸¸çµæ´»ï¼Œä¸åŒçš„ç½‘ç»œæ’ä»¶è°ƒè¯•çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼›ç«¯å£æ˜ å°„æ–¹å¼çš„æœ€å¤§éšæ‚£å°±æ˜¯å¾ˆå®¹æ˜“é€ æˆç«¯å£å†²çªã€‚
</code></pre><p>Qï¼šRPCçš„æœåŠ¡æ³¨å†Œï¼ŒæŠŠæœ¬æœºIPæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¦‚æœåœ¨å®¹å™¨é‡Œé¢ä¼šæ³¨å†Œé‚£ä¸ªè™šæ‹ŸIPï¼Œé›†ç¾¤å¤–é¢æ²¡æ³•è°ƒç”¨ï¼Œæœ‰ä»€ä¹ˆå¥½çš„è§£å†³æ–¹æ¡ˆå—ï¼Ÿ</p>
<pre><code>Aï¼šKubernetes Serviceåˆ°Podçš„é€šä¿¡æ˜¯ç”±kube-proxyä»£ç†åˆ†å‘ï¼Œè€ŒPodä¸­å®¹å™¨çš„é€šä¿¡æ˜¯é€šè¿‡ç«¯å£ï¼Œä¸åŒServiceé—´é€šä¿¡å¯ä»¥é€šè¿‡DNSï¼Œä¸ä¸€å®šè¦ä½¿ç”¨è™šæ‹ŸIPã€‚
</code></pre><p>Qï¼šæˆ‘ç°åœ¨æ‰ç”¨çš„æ˜¯CoreOSä½œä¸ºåº•å±‚ï¼Œæ‰€ä»¥ç½‘ç»œé‡‡ç”¨çš„æ˜¯Flannel ä½†æ˜¯ä¸Šå±‚ç”¨Calicoä½œä¸ºNetwork Policyï¼Œæœ€è¿‘æœ‰ä¸€ä¸ªCanalçš„ç»“æ„å’Œè¿™ä¸ªæ¯”è¾ƒç±»ä¼¼ï¼Œèƒ½ä»‹ç»ä¸€ä¸‹ä¹ˆï¼Œå¯ä»¥çš„è¯ï¼Œèƒ½è¯¦ç»†ä»‹ç»ä¸€ä¸‹CNIåŸç†å’ŒCallicoçš„Policyå®ç°ä¹ˆï¼Ÿ</p>
<pre><code>Aï¼šCanalä¸æ˜¯å¾ˆäº†è§£ï¼›CNIå¹¶ä¸æ˜¯ç½‘ç»œå®ç°ï¼Œå®ƒæ˜¯ç½‘ç»œè§„èŒƒå’Œç½‘ç»œä½“ç³»ï¼Œä»ç ”å‘çš„è§’åº¦å®ƒå°±æ˜¯ä¸€å †æ¥å£ï¼Œå…³å¿ƒçš„æ˜¯ç½‘ç»œç®¡ç†çš„é—®é¢˜ï¼ŒCNIçš„å®ç°ä¾èµ–äºä¸¤ç§Pluginï¼Œä¸€ç§æ˜¯CNI Pluginè´Ÿè´£å°†å®¹å™¨connect/disconnectåˆ°hostä¸­çš„vbridge/vswitchï¼Œå¦ä¸€ç§æ˜¯IPAM Pluginè´Ÿè´£é…ç½®å®¹å™¨Namespaceä¸­çš„ç½‘ç»œå‚æ•°ï¼›Calico çš„policyæ˜¯åŸºäºIptablesï¼Œä¿è¯é€šè¿‡å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ ACLs æ¥æä¾›workload çš„å¤šç§Ÿæˆ·éš”ç¦»ã€å®‰å…¨ç»„ä»¥åŠå…¶ä»–å¯è¾¾æ€§é™åˆ¶ç­‰åŠŸèƒ½ã€‚
</code></pre><p>Qï¼šCNIæ˜¯æ€ä¹ˆç®¡ç†ç½‘ç»œçš„ï¼Ÿæˆ–è€…è¯´å®ƒè·Ÿç½‘ç»œæ–¹æ¡ˆä¹‹é—´æ˜¯æ€ä¹ˆé…åˆçš„ï¼Ÿ</p>
<pre><code>Aï¼šCNIå¹¶ä¸æ˜¯ç½‘ç»œå®ç°ï¼Œå®ƒæ˜¯ç½‘ç»œè§„èŒƒå’Œç½‘ç»œä½“ç³»ï¼Œä»ç ”å‘çš„è§’åº¦å®ƒå°±æ˜¯ä¸€å †æ¥å£ï¼Œä½ åº•å±‚æ˜¯ç”¨Flannelä¹Ÿå¥½ã€ç”¨Calicoä¹Ÿå¥½ï¼Œå®ƒå¹¶ä¸å…³å¿ƒï¼Œå®ƒå…³å¿ƒçš„æ˜¯ç½‘ç»œç®¡ç†çš„é—®é¢˜ï¼ŒCNIçš„å®ç°ä¾èµ–äºä¸¤ç§pluginï¼Œä¸€ç§æ˜¯CNI Pluginè´Ÿè´£å°†å®¹å™¨connect/disconnectåˆ°hostä¸­çš„vbridge/vswitchï¼Œå¦ä¸€ç§æ˜¯IPAM Pluginè´Ÿè´£é…ç½®å®¹å™¨Namespaceä¸­çš„ç½‘ç»œå‚æ•°ã€‚
</code></pre><p>Qï¼šServiceæ˜¯ä¸ªå®ä½“ç»„ä»¶ä¹ˆï¼Ÿé‚£äº›ä¸ªServiceé…ç½®æ–‡ä»¶ï¼Œä»€ä¹ˆéƒ¨ä»¶æ¥æ‰§è¡Œå‘¢ï¼Ÿ</p>
<pre><code>Aï¼šServicesæ˜¯Kubernetesçš„åŸºæœ¬æ“ä½œå•å…ƒï¼Œæ˜¯çœŸå®åº”ç”¨æœåŠ¡çš„æŠ½è±¡ï¼ŒService IPèŒƒå›´åœ¨é…ç½®kube-apiserveræœåŠ¡çš„æ—¶å€™é€šè¿‡--service-cluster-ip-rangeå‚æ•°æŒ‡å®šï¼Œç”±Kubernetesé›†ç¾¤è‡ªèº«ç»´æŠ¤ã€‚
</code></pre>
        </div>
        <!-- Google å¹¿å‘Š -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-09-29T05:58:20.867Z" itemprop="dateUpdated">2022-09-29 13:58:20</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/10-kubernetesè¿›é˜¶ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/10-kubernetesè¿›é˜¶ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆ.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2020/9-27-538.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/9-27-538.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/9-27-538.html&title=ã€Š10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/9-27-538.html&title=ã€Š10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/9-27-538.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/9-27-538.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/9-27-538.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/10-13-585.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Linuxä¸WindowsæœåŠ¡å™¨æ“ä½œç³»ç»Ÿå®‰å…¨é˜²å¾¡å®è·µæŒ‡å—</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/9-27-522.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">7-Kuberneteså…¥é—¨åŸºç¡€ä¹‹å­˜å‚¨Volumeä»‹ç»</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 å‰è¨€ç®€è¿°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#åŸºç¡€ç®€è¿°"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">åŸºç¡€ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#æ¨¡å‹æ ‡å‡†"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">æ¨¡å‹æ ‡å‡†</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-ç½‘ç»œæ¨¡å‹"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 ç½‘ç»œæ¨¡å‹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç½‘ç»œå®ç°"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">ç½‘ç»œå®ç°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-Pod-å†…éƒ¨çš„-Containers-é—´çš„é€šä¿¡"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">(1) Pod å†…éƒ¨çš„ Containers é—´çš„é€šä¿¡</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-åŒä¸»æœº-Pod-é—´çš„é€šä¿¡ï¼ˆHost-Virtual-Network-æ¨¡å¼ï¼‰"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">(2) åŒä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆHost Virtual Network æ¨¡å¼ï¼‰</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-è·¨ä¸»æœº-Pod-é—´çš„é€šä¿¡ï¼ˆSDN-æ¨¡å¼ï¼‰"><span class="post-toc-number">2.1.3.</span> <span class="post-toc-text">(3) è·¨ä¸»æœº Pod é—´çš„é€šä¿¡ï¼ˆSDN æ¨¡å¼ï¼‰</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-Service-çš„-Cluster-IP-å’Œå¤–éƒ¨ç½‘ç»œé—´çš„é€šä¿¡"><span class="post-toc-number">2.1.4.</span> <span class="post-toc-text">(4) Service çš„ Cluster IP å’Œå¤–éƒ¨ç½‘ç»œé—´çš„é€šä¿¡</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç½‘ç»œç»„ä»¶"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">ç½‘ç»œç»„ä»¶</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-Flannel"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">(1) Flannel</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-Calico"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">(2) Calico</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-CoreDNS"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">(3) CoreDNS</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-ç½‘ç»œç»„ä»¶æ€§èƒ½å¯¹æ¯”"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 ç½‘ç»œç»„ä»¶æ€§èƒ½å¯¹æ¯”</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-Q-amp-A"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 Q&amp;A</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½æœ‹å‹,å¯ä»¥å…³ä¸ªæ³¨å—? â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/9-27-538.html&title=ã€Š10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/9-27-538.html&title=ã€Š10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/9-27-538.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š10-kuberneteså…¥é—¨åŸºç¡€ä¹‹ç½‘ç»œè®¾è®¡å®ç°æ–¹æ¡ˆã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/9-27-538.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/9-27-538.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACGUlEQVR42u3aS27DMAwFwN7/0um2RRDnkVSKWhqtgsR2NF4Q/OjrK16Pp/Xq1+T6n9dcP2fxwsDAuC3jcbmuN5pjXt31/P3163hJxcDAOICRP7oXiK+vmbAxMDAwqoxkW0ngxsDAwJgwesXnvwu4GBgYN2QkoTPZdN5oS9pzH6nFMTAwbsjIu+5///kj8w0MDIxbMR7FlfCSwnW+k1/PxMDA2JqRB7heMlctaCf7wcDAOJMx+bNVDbj8GwwMjL0Zqw5G5IljklY2W34YGBibMvJ2fG9Dk4Fl/powMDBOYEwa9KuGmvmLeJPhYmBgbMfotdXy4Du5vvlyMTAwNmLMi9JqSK0276K7MDAwDmD0jllMWmx5whcV0hgYGFszeklb0rivzhbzRtubl4uBgbE1oxfm8jFktdGWjwcwMDBOYKw6r9Frli0DY2BgHMCoxq6clCdzk+IZAwPjTEYvdH4iuYzSRAwMjAMYeYI4GUNWj2IkeAwMjJMZ1cbcqpK4+loxMDAwen+TjzaTcWmUwmJgYBzAyBtekzBaPjARJ6AYGBi7Mh7FNWFUg2zyfAwMjBMY84Nik0FmdfywIGRjYGDcltErRKsbqg4p8/QUAwPjHEYvdUsStWqa2Az9GBgYGNdN+eJd1bBbaLphYGBgtA57TQrdwugCAwPjAEZ1GDC/q4dcUItjYGDckDE5qTEpPidNuuYgEwMD436Mb/Um0T/mplT0AAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>