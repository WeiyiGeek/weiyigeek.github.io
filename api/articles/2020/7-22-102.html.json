{"title":"CIFS与CIFS Homedir文件系统学习总结","slug":"系统运维/Application/DiskManagement/NetworkStorage/CIFS与CIFS-Homedir网络文件系统学习总结","date":"2020-07-22T11:35:30.000Z","updated":"2022-07-10T02:05:16.955Z","url":"2020/7-22-102.html","path":"api/articles/2020/7-22-102.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811200752.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811201120.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811204220.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811204045.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h4><p>本章主要介绍 CIFS 与 CIFS Homedir 概念及其配置，方便初学者快速入门;</p>\n<h5 id=\"1-CIFS\"><a href=\"#1-CIFS\" class=\"headerlink\" title=\"1.CIFS\"></a>1.CIFS</h5><p>描述:CIFS（Common Internet File System - 通用网络文件系统）是当前<code>主流异构平台共享文件系统之一</code>,它是一个网络文件共享协议，允许Internet和Intranet中的Windows主机访问网络中的文件或其他资源。<code>主要应用在Window操作系统环境下进行文件共享</code>，如果你是Linux系统还是建议您采用NFS文件系统;</p>\n<p>CIFS是<code>SMB（Server Message Block）</code>的一个公共版本;</p>\n<p>Q: 那什么是SMB协议?</p>\n<blockquote>\n<p>答: SMB协议是一个网络文件访问协议，使本机程序可以访问局域网内计算机上的文件并请求此计算机的服务。</p>\n</blockquote>\n<p>Q: 为什么要使用CIFS文件系统而不是直接使用SMB共享?</p>\n<blockquote>\n<p>答: 随着企业规模的扩大，企业内各部门之间进行文件共享和访问的用户数量越来越多;由于共享文件所在的服务器的硬件配置限制，当大量用户访问共享文件时，造成访问速度下降、系统响应慢的问题<br>如何能够提高大量用户访问共享文件的性能，是企业网络应用必须解决的问题。<br>存储系统支持CIFS共享特性，使得Windows客户端<code>能够识别并访问网络中存储系统提供的共享资源</code>，客户端用户能够像使用本机一样对保存在存储系统中的文件进行读、写、创建等操作。CIFS<code>解决了大量用户访问共享文件速度下降和系统响应慢的问题</code>。</p>\n</blockquote>\n<p>CIFS 优势:</p>\n<ul>\n<li>1.高并发性: 提供文件共享和文件锁机制，允许多个客户端访问或更新同一个文件而不产生冲突（<code>同一时刻只允许一个客户端更新文件</code>）</li>\n<li>2.高性能: 某个客户端对共享文件进行的操作并不会立即写入存储系统而是保存在本地缓存中。当该客户端再次对共享文件进行操作时，系统会直接从缓存中读取文件，提高文件访问性能。</li>\n<li>3.数据完整性: 采用抢占缓存、预读和回写的方式保证数据的完整性,上面我们说到客户端对共享文件的操作不会立即写入存储系统而是保存在本地缓存之中,当其它客户端需要访问同一文件时候便会将缓存数据写入到存储之中,从而保证了在同一时刻<code>只有一个拷贝文件处于激活状态防止数据冲突</code>;</li>\n<li>4.高安全性: FS支持匿名传输和共享的鉴权访问(<code>设置用户对文件系统的访问权限，保证文件的机密性和安全性</code>)</li>\n<li>5.应用广泛性: 任意支持CIFS协议的客户端，均可以访问CIFS共享空间。</li>\n<li>6.统一的字符编码标准: 支持各类字符集，保证CIFS可以在所有语言系统中使用。</li>\n</ul>\n<p>配置CIFS共享包括<code>无域环境中配置CIFS共享</code>和<code>AD域环境中配置CIFS共享</code>两种方式;</p>\n<ul>\n<li>(1) 无域环境中的CIFS共享: 存储系统使用CIFS共享的方式，把文件系统以目录的形式共享给某个用户，并且存储系统还可以为不同的用户设置共享文件，使存储系统共享的目录和用户名一致，该用户无法查看或访问其他用户的共享目录。<ul>\n<li>链接流程:通过CIFS协议，向客户端提供对文件系统的共享访问，客户端（通过鉴权后）将共享文件映射到本地后，用户可以像访问本地文件一样远程访问服务器中的文件系统。</li>\n<li>Tips:在存储系统中通过设置本地认证的用户名和密码，确定允许访问该文件系统的本地认证信息。</li>\n</ul>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811200752.png\" alt=\"WeiyiGeek.无域环境中的CIFS共享\" title=\"\" class=\"\">\n                <p>WeiyiGeek.无域环境中的CIFS共享</p>\n            </figure>\n<ul>\n<li>(2) AD域环境中的CIFS共享:随着局域网、广域网规模越来越大，很多企业使用AD域进行Windows网络管理，使得管理更便捷、更具有扩展性。<br>比如华为V5存储系统能够加入AD域，作为AD域的客户端，实现和AD域环境的无缝对接，利用其AD域控制器中保存了域环境中所有的用户信息、群组信息等；AD域客户端访问存储系统提供的CIFS共享时，认证均通过AD域控制器完成。所有域用户均可以访问存储系统提供的共享目录。同时AD域的管理员可以配置基于文件的权限管理，对不同域用户访问每个文件夹进行不同的权限控制。同时，存储系统支持AD域客户端只能访问与其名称相同的共享目录，无法查看并访问其他域客户端的共享目录的方式；</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811201120.png\" alt=\"WeiyiGeek.AD域环境中的CIFS共享\" title=\"\" class=\"\">\n                <p>WeiyiGeek.AD域环境中的CIFS共享</p>\n            </figure>\n<p><br></p>\n<h5 id=\"2-CIFS-Homedir\"><a href=\"#2-CIFS-Homedir\" class=\"headerlink\" title=\"2.CIFS Homedir\"></a>2.CIFS Homedir</h5><p>描述:Homedir（Home Directory）属于CIFS共享方式的一种，它是是用户私有目录，可用于存放用户私有数据，<code>该用户只能查看和访问与其名称一致的共享目录，无法查看或访问其他用户的私有目录</code>。</p>\n<p>Homedir特性优势:</p>\n<ul>\n<li>支持配置Homedir共享名，用户可通过Homedir共享名访问不同的Homedir共享。</li>\n<li>支持配置CA、oplock、notify等特性开关，可以实现对用户访问Homedir共享业务的特性控制。</li>\n<li>支持配置Homedir共享权限，实现对Homedir共享的用户权限管理。</li>\n<li>支持配置多个Homedir共享，每个Homedir共享可添加多个用户Homedir文件系统路径映射规则，满足管理员划分用户Homedir到不同文件系统路径的业务场景。</li>\n<li>映射规则支持AutoCreate选项，可以自动为用户创建Homedir目录，简化了管理员对用户Homedir目录的管理。</li>\n</ul>\n<p>同CIFS一样华为存储V5也包括两种共享方式即<code>无域环境中的 CIFS Homedir共享 、 AD域环境中的CIFS Homedir共享</code>图示参照CIFS共享;</p>\n<hr>\n<h4 id=\"0x01-共享规划\"><a href=\"#0x01-共享规划\" class=\"headerlink\" title=\"0x01 共享规划\"></a>0x01 共享规划</h4><p>描述:在配置CIFS/CIFS Homedir共享前请先做好规划工作，以便顺利开展后续的业务配置。<br>规划的内容包括<code>网络、域、认证方式、共享方式、用户、用户组、权限和配额</code>。</p>\n<table>\n<thead>\n<tr>\n<th>规划项</th>\n<th>规划子项</th>\n<th>规划要求</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>网络</td>\n<td>存储系统IP</td>\n<td>存储系统使用逻辑端口（LIFa）提供存储系统和应用服务器之间的通信提供IP。</td>\n</tr>\n<tr>\n<td></td>\n<td>访问终端IP地址</td>\n<td>访问终端与存储系统在同一个网络中，可以相互ping通。</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>维护终端IP地址</td>\n<td>维护终端与存储系统在同一个网络中，可以相互ping通。</td>\n<td></td>\n</tr>\n<tr>\n<td>（可选）AD域环境</td>\n<td>在AD域环境中，规划AD域服务器和NTP服务器的IP地址和主机名，并保证各服务器与存储系统在同一个网络中，可以相互ping通。</td>\n<td></td>\n</tr>\n<tr>\n<td>域环境</td>\n<td>AD域或无域</td>\n<td>根据用户的管理需求，设置为AD域或无域环境。<br> 两种环境的优点如下。 AD域：存储系统能够实现与AD域的无缝对接，无需建立本地用户，域用户可以访问共享空间。无域：无需搭建域环境。</td>\n</tr>\n<tr>\n<td>认证方式</td>\n<td>本地认证和域认证</td>\n<td>根据用户环境AD域或无域环境设置认证方式。 本地认证：使用本地帐户进行用户身份的认证。域认证：使用域服务器进行用户身份的认证。</td>\n</tr>\n<tr>\n<td>共享方式</td>\n<td>CIFS共享</td>\n<td>创建CIFS共享前，需要先检查是否已启用CIFS服务并对CIFS服务进行配置。</td>\n</tr>\n<tr>\n<td>用户</td>\n<td>包括本地认证的用户和域认证的用户</td>\n<td>本地认证用户名长度范围为6到32位字符。 本地认证用户名不允许包含空格、`“””、“/”、“\\”、“[”、“]”、“&lt;”、“&gt;”、“+”、“:”、“;”、“,”、“?”、“*”、“\\</td>\n<td>”、“=”和“@”`，且尾字符不允许为“.”。</td>\n</tr>\n<tr>\n<td>用户组</td>\n<td>包括本地认证的用户组和域认证的用户组</td>\n<td>本地认证用户组名长度范围为1到32位字符。 本地认证用户组名不允许包含空格、`“””、“/”、“\\”、“[”、“]”、“&lt;”、“&gt;”、“+”、“:”、“;”、“,”、“?”、“*”、“\\</td>\n<td>”、“=”和“@”`，且尾字符不允许为“.”。</td>\n</tr>\n<tr>\n<td>权限级别</td>\n<td>用户或用户组访问共享的权限</td>\n<td>设置用户访问CIFS共享的权限，包括： <br>完全控制：拥有CIFS共享的所用权限。 <br>只读：只拥有CIFS共享的读权限。 <br>读写：拥有CIFS共享的读写权限。  <br>禁止：禁止访问。</td>\n</tr>\n<tr>\n<td>配额</td>\n<td>-</td>\n<td>配额只能针对文件系统的quota tree(b)，根据用户需求定义文件系统的配额值。配额大小不受文件系统容量限制。配额包括以下两方面： <br> 空间配额：文件系统中quota tree的最大容量。 <br> 文件配额：文件系统中quota tree的最大文件数目。</td>\n</tr>\n</tbody>\n</table>\n<p>a：LIF是在物理端口、绑定端口及VLAN端口上创建的逻辑端口，每个LIF对应一个IP地址。<br>b：quota tree即配额树，是文件系统的特殊目录。在quota tree上可以设置目录配额，管理该目录内所有文件的使用空间。 </p>\n<hr>\n<h4 id=\"0x02-CIFS-配置说明\"><a href=\"#0x02-CIFS-配置说明\" class=\"headerlink\" title=\"0x02 CIFS 配置说明\"></a>0x02 CIFS 配置说明</h4><p>描述下面以OceanStor DeviceManager设备型号：5310F V5 为例进行配置使用;</p>\n<ul>\n<li>(1) CIFS共享的配置流程</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811204220.png\" alt=\"WeiyiGeek.CIFS\" title=\"\" class=\"\">\n                <p>WeiyiGeek.CIFS</p>\n            </figure>\n<ul>\n<li>(2) CIFS Homedir共享的配置流程：</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200811204045.png\" alt=\"WeiyiGeek.CIFS Homedir\" title=\"\" class=\"\">\n                <p>WeiyiGeek.CIFS Homedir</p>\n            </figure>\n<hr>\n<h4 id=\"0x03-CIFS-挂载使用\"><a href=\"#0x03-CIFS-挂载使用\" class=\"headerlink\" title=\"0x03 CIFS 挂载使用\"></a>0x03 CIFS 挂载使用</h4><h5 id=\"Windows-平台下挂载CIFS存储\"><a href=\"#Windows-平台下挂载CIFS存储\" class=\"headerlink\" title=\"Windows 平台下挂载CIFS存储\"></a>Windows 平台下挂载CIFS存储</h5><p>描述: 此处以客户端操作系统为 Windows 7为例进行说明，在用户客户端映射网络驱动器流程如下:<br>Step 1.在Windows客户端右键单击“计算机”。选择“映射网络驱动器”。</p>\n<p>Step 2.系统弹出“映射网络驱动器”对话框。在“文件夹”中输入映射的文件夹路径。</p>\n<p>Step 3.映射的文件夹路径使用<code>\\\\logical ip address\\sharename</code>的格式。</p>\n<p>Step 4.其中sharename是指CIFS共享的共享名称。单击“完成”。 </p>\n<p><br></p>\n<h5 id=\"Linux-平台下挂载CIFS存储-windows-共享目录\"><a href=\"#Linux-平台下挂载CIFS存储-windows-共享目录\" class=\"headerlink\" title=\"Linux 平台下挂载CIFS存储(windows 共享目录)\"></a>Linux 平台下挂载CIFS存储(windows 共享目录)</h5><p>描述: 实际上在Linux中挂载CIFS(Common Internet File System，即通用internet文件系统)存储的方式流程与NFS相似，其主要使用场景是嵌入式中实现从开发板与windows的共享。</p>\n<p><strong>如果在linux去挂载其他linux或者window的磁盘该怎么做呢?</strong><br>软件安装包:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># CentOS - 环境</span></span><br><span class=\"line\">yum install cifs-utils -y </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Ubuntu - 环境</span></span><br><span class=\"line\">sudo apt-get install cifs-utils</span><br></pre></td></tr></table></figure></p>\n<p><strong>挂载使用</strong></p>\n<p>Step 1.查看CIFS共享存储上的挂载点，注意需要放行相关端口<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">showmount –e 192.168.1.250</span><br><span class=\"line\">/DATA</span><br></pre></td></tr></table></figure></p>\n<p>Step 2.挂载CIFS共享存储命令, 此处非常注意需要将Windows中<code>\\\\</code>改成Linux识别的<code>//</code>以及后续路径中的<code>\\</code>也需要改成<code>/</code>否则无法正常挂载。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -vp /app/share</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 空密码链接示例</span></span><br><span class=\"line\">mount -t cifs -o sec=none,iocharset=utf8,vers=2.0  //192.168.1.250/DATA /app/share</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 域和域用户账号密码</span></span><br><span class=\"line\">mount -t cifs -o domain=cloud,username=administrator,password=123456,sec=ntlmssp,iocharset=utf8,vers=2.0 //192.168.1.250/DATA /app/share</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 命令参数解析：</span></span><br><span class=\"line\">-t 挂载类型为cifs</span><br><span class=\"line\">-o 挂载参数 </span><br><span class=\"line\">  Domain=域名</span><br><span class=\"line\">  sername=用户名</span><br><span class=\"line\">  password=密码</span><br><span class=\"line\">  sec=安全认证方式</span><br><span class=\"line\">  iocharset=字符集</span><br><span class=\"line\">  vers=版本</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 选择安全模型：</span></span><br><span class=\"line\">sec=&#123;none|krb5|krb5i|ntlm|ntlmi|ntlmv2|ntlmv2i&#125;</span><br><span class=\"line\">  * none 尝试以空用户连接(不提供用户名)</span><br><span class=\"line\">  * krb5 使用 Kerberos version 5 认证</span><br><span class=\"line\">  * krb5i 使用 Kerberos version 5 和包签名(packet signing)认证</span><br><span class=\"line\">  * ntlm 使用 NTLM 口令散列认证(默认值)</span><br><span class=\"line\">  * ntlmi 使用 NTLM 签名口令散列认证(如果 /proc/fs/cifs/PacketSigningEnabled 被开启或者服务器端要求必须签名时，这个将成为默认值)</span><br><span class=\"line\">  * ntlmv2 使用 NTLMv2 口令散列认证</span><br><span class=\"line\">  * ntlmv2i 使用 NTLMv2 签名口令散列认证</span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 如果指定挂载后文件编码使用中文(如挂载Windows共享)<code>-ocodepage=936,iocharset=cp936</code></p>\n<p>Step 3.如果需要设置自动挂载,则需要在<code>/etc/fstab</code>文件中添加如下配置。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee -a /etc/fstab &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">....</span><br><span class=\"line\">//192.168.1.250/DATA /app/share cifs  defaults,username=administrator,password=123456 0 0</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">$ mount -a</span><br></pre></td></tr></table></figure></p>\n<p>Step 4.查看挂载的CIFS磁盘.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ df -Th | grep <span class=\"string\">\"cifs\"</span></span><br><span class=\"line\">//10.41.40.92/myshare/   cifs   44T   28G   44T    1% /mnt/cifs</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>入坑出坑</strong><br>1.使用mount挂载cifs时 <code>mount error(95): Operation not supported</code>.<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mount -t cifs -o username=weiyigeek,password=<span class=\"string\">'password'</span> //192.168.6.19/share /share</span><br><span class=\"line\">mount error(95): Operation not supported</span><br><span class=\"line\">Refer to the mount.cifs(8) manual page (e.g. man mount.cifs)</span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>解决办法: 在命令行 <code>vers=2.0</code> 参数即可。</li>\n</ul>\n<p>2.使用mount挂载cifs时普通用户无法操作挂载目录的文件及其目录报没有权限问题，以weiyigeek与app组为例<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 空密码链接示例, weiyigeek用户以及app组</span></span><br><span class=\"line\">mount -t cifs -o sec=none,iocharset=utf8,vers=2.0,uid=weiyigeek,gid=app  //192.168.1.250/DATA /app/share</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"磁盘管理","path":"api/categories/磁盘管理.json"}],"tags":[{"name":"CIFS","path":"api/tags/CIFS.json"}]}