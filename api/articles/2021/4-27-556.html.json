{"title":"6.Prometheus监控入门之企业监控实战警报发送","slug":"虚拟云容/云容器/Kubernetes/功能组件/Prometheus/6.Prometheus监控入门之企业监控实战警报发送","date":"2021-04-27T11:37:47.000Z","updated":"2023-01-31T02:29:10.641Z","url":"2021/4-27-556.html","path":"api/articles/2021/4-27-556.html.json","covers":["https://img.weiyigeek.top/2021/5/20210519224330.png","https://img.weiyigeek.top/2021/5/20210519225517.png","https://img.weiyigeek.top/2021/5/20210519230856.png","https://img.weiyigeek.top/2021/5/20210520233229.png","https://img.weiyigeek.top/2021/5/20210521091909.png","https://img.weiyigeek.top/2021/5/20210521092006.png","https://img.weiyigeek.top/2021/5/20210521095929.png","https://img.weiyigeek.top/2021/5/20210521102356.png","https://img.weiyigeek.top/2021/5/20210521102935.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-Alertmanager-快速入门\"><a href=\"#0x00-Alertmanager-快速入门\" class=\"headerlink\" title=\"0x00 Alertmanager 快速入门\"></a>0x00 Alertmanager 快速入门</h2><h3 id=\"1-基础介绍\"><a href=\"#1-基础介绍\" class=\"headerlink\" title=\"1.基础介绍\"></a>1.基础介绍</h3><p>描述: Alertmanager 负责接收来自所有Prometheus服务器的告警，并根据其规则将告警以邮件、聊天信息和呼叫等方式进行通知。</p>\n<p>Tips : 注意在使用告警规则文件前必须在<code>prometheus.yaml</code>中设置抓取目标以及加载规则文件，使用记录告警规则可以让Prometheus定期执行PromQL表达式并记录其结果。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alerting:</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">  - follow_redirects: <span class=\"literal\">true</span></span><br><span class=\"line\">    scheme: http</span><br><span class=\"line\">    timeout: 10s</span><br><span class=\"line\">    api_version: v2</span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">    - targets:</span><br><span class=\"line\">      - localhost:9093</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>Prometheus 告警分为两个部分进行实现监控规则匹配以及告警信息的通知。</p>\n<ul>\n<li>1) 首先需要在<code>Prometheus</code>中添加告警规则,定义告警产生的逻辑。</li>\n<li>2) 其次<code>Alertmanager</code>系统将触发的警报转化为通知，例如邮件、呼叫和聊天消息。</li>\n</ul>\n<p><strong>通知管道流程</strong></p>\n<ul>\n<li>降噪: 选择忽略同时出现的告警，或者发送更高级别的警告。 可利用inhibition标签。</li>\n<li>静音: 通过Web界面的添加需要Silences暂时忽略的告警。</li>\n<li>路由: 以不同方式处理生产和开发环境的告警,并将告警其分别发送到指定的对象中。</li>\n<li>分组: 针对告警进行分组安装其警告级别。</li>\n<li>抑制与重复: 防止大量的相同的警告，在处理阶段重复报警，这可能会错过新的报警信息，所以我们需要设置间间隔时间参数<code>repeat_interval</code>。</li>\n<li>通知: 将告警发送到指定的receiver标签指定的接受者，并且我们可以自定义通知模板。</li>\n</ul>\n<p><br/></p>\n<p><strong>告警状态</strong><br>Prometheus Alert 告警状态有三种状态：<code>Inactive、Pending、Firing</code>。</p>\n<ul>\n<li>Inactive：非活动状态，表示正在监控，但是还未有任何警报触发。</li>\n<li>Pending：表示这个警报必须被触发。由于警报可以被分组、压抑/抑制或静默/静音，所以等待验证，一旦所有的验证都通过，则将转到 Firing 状态。</li>\n<li>Firing：将警报发送到 AlertManager，它将按照配置将警报的发送给所有接收者。一旦警报解除则将状态转到 Inactive如此循环。</li>\n</ul>\n<p><br></p>\n<p><strong>参考来源</strong></p>\n<ul>\n<li><a href=\"https://prometheus.io/docs/alerting/configuration/\" target=\"_blank\" rel=\"noopener\">https://prometheus.io/docs/alerting/configuration/</a></li>\n</ul>\n<p><br></p>\n<h3 id=\"2-关键配置浅析\"><a href=\"#2-关键配置浅析\" class=\"headerlink\" title=\"2.关键配置浅析\"></a>2.关键配置浅析</h3><p>描述: 下面主要讲解接收者(receiver)、路由树(route)、分组(Groupby)、抑制重复、已处理通知、抑制警告。</p>\n<p><strong>接收者</strong><br>描述: receiver 字段指定了告警通知哪种方式进行发送，国内常用email、webhook、钉钉或者企业微信等方式进行告警，它也支持HipChat、PagerDuty（可以进行确认警告）、Pushover、Slack、OpsGenie、VictorOps等。</p>\n<p><strong>路由树</strong><br>描述: route 字段指定顶级它是默认路由，根路由下可以设置许多字路由(你可将其比喻作根域名)，路由的匹配是当告警规则到来后根据其携带的标签进行判断，如果匹配子路由1的规则就会匹配次路由并且停止继续匹配，如果不匹配将会对子路由2的规则进行匹配，如都没匹配到则采用根路由的设置。</p>\n<p>Tips : Prometheus 官方有提供一个可视化路由编辑器，可以显示该树以及告警遵循的路由。</p>\n<p><strong>分组</strong><br>描述: group_by 字段允许你指定标签列表对告警进行分组，在未设置分组时该路由默认将所有路由都放入一个组中，意味着你将得到一个内容很大的通知。当在设置分组后可以按照报警等级、环境、以及location来进行拆分警告。</p>\n<p>注意: 通常按照<code>instance标签</code>进行分组并不是一个好主意，因为当存在影响整个应用程序的问题时，它可能会导致大量信息。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 个人理解(伪配置)</span></span><br><span class=\"line\">group_by: [<span class=\"string\">'team'</span>]</span><br><span class=\"line\">  group_by: [<span class=\"string\">'env'</span>,<span class=\"string\">'region'</span>]</span><br><span class=\"line\">  match_re: </span><br><span class=\"line\">    severity: (page|ticket) <span class=\"comment\"># 重要事件&amp;通知单</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># severity标签值为ticket和page的记录也将按照region和env进行分组。</span></span><br><span class=\"line\">        env &#123;page|ticket&#125; </span><br><span class=\"line\">team -&gt; </span><br><span class=\"line\">        region (page|ticket)</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>抑制重复</strong><br>描述: 如果你不希望每次触发告警后当告警集发生改变时都将收到新的通知，这会导致大量的垃圾邮件。</p>\n<p>此时我们可以使用 group_wait(<code>每个来的警告组【Firing】发送等待</code>) 与 group_interval(发送一个警告组后，下一组警告组的等待时间) 、repeat_interval(<code>发送警告成功后，如果在上面两个参数指定的时间内没有完成时，将等待该参数时间到了，便继续发送</code>-推荐设置4H)来设置Altermanager通知分组限制。</p>\n<p>Tips : repeat_interval 必须要比 group_interval 大否则将无任何意义。</p>\n<p><br></p>\n<p><strong>已处理通知</strong><br>描述: send_resolved 字段,当告警问题解决后是否发送通知，启用后将在下一个通知包含此告警，如果列表中没有其它告警触发，它甚至只会发送已经解决通知的警告。</p>\n<ul>\n<li>.Alert.Firing 将仅仅提供触发告警的列表。</li>\n<li>.Alert.Resolved 将提供已解决的告警列表。</li>\n</ul>\n<p><br></p>\n<p><strong>抑制警告</strong><br>描述: inhibit_rules 字段 ，允许你在其它告警被触发时将某些警告视为不触发。例如数据迁移后旧的机器出现问题但由于用户数据已经转移到其它地方，那么发送此种警告便没有多大意义。</p>\n<p><br></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 全局设置</span></span><br><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"comment\"># - QQ企业邮件通知相关配置</span></span><br><span class=\"line\"><span class=\"attr\">  resolve_timeout:</span> <span class=\"number\">5</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_from:</span> <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_smarthost:</span> <span class=\"string\">'smtp.exmail.qq.com:465'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_auth_username:</span> <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_auth_password:</span> <span class=\"string\">'xxxxxxxxxxxxxxx'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_require_tls:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 告警模板&amp;告警接收者</span></span><br><span class=\"line\"><span class=\"attr\">templates:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">'/etc/alertmanager/*.tmpl'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'email-notify'</span></span><br><span class=\"line\"><span class=\"attr\">  email_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - send_resolved:</span> <span class=\"literal\">true</span>  <span class=\"comment\"># 如设置为true问题已解决将发送信息,如设置false则不发送</span></span><br><span class=\"line\"><span class=\"attr\">    from:</span> <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\"><span class=\"attr\">    to:</span> <span class=\"string\">'<span class=\"template-variable\">&#123;&#123; template \"email.to\" . &#125;&#125;</span>'</span></span><br><span class=\"line\"><span class=\"attr\">    html:</span> <span class=\"string\">'<span class=\"template-variable\">&#123;&#123; template \"email.to.html\" . &#125;&#125;</span>'</span></span><br><span class=\"line\">   </span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'wechat-notify'</span></span><br><span class=\"line\"><span class=\"attr\">  wechat_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - send_resolved:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    api_url:</span> <span class=\"string\">'https://qyapi.weixin.qq.com/cgi-bin/'</span></span><br><span class=\"line\"><span class=\"attr\">    corp_id:</span> <span class=\"string\">'ww32cf0bf4e14b11487'</span></span><br><span class=\"line\"><span class=\"attr\">    agent_id:</span> <span class=\"string\">'1000002'</span></span><br><span class=\"line\"><span class=\"attr\">    api_secret:</span> <span class=\"string\">'SYCdXbWj5SjdT9p1OSQnjIZ4RF_SIRqERVuZNWE1yE5g'</span></span><br><span class=\"line\"><span class=\"attr\">    to_user:</span> <span class=\"string\">'@all'</span></span><br><span class=\"line\"><span class=\"attr\">    to_party:</span> <span class=\"string\">'1'</span></span><br><span class=\"line\"><span class=\"attr\">    message:</span> <span class=\"string\">'<span class=\"template-variable\">&#123;&#123; template \"wechat.default.message\" . &#125;&#125;</span>'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'wehook-notify'</span></span><br><span class=\"line\"><span class=\"attr\">  webhook_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - url:</span> <span class=\"attr\">http://webhook.weiyigeek.top:8888/alert</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 抑制告警规则: 如果存在severity标签值为critical告警，将会抑制带有severity标签值为warning以及service标签的警告。</span></span><br><span class=\"line\"><span class=\"attr\">inhibit_rules:</span></span><br><span class=\"line\"><span class=\"attr\">- source_match:</span></span><br><span class=\"line\"><span class=\"attr\">    severity:</span> <span class=\"string\">'critical'</span></span><br><span class=\"line\"><span class=\"attr\">  target_match:</span></span><br><span class=\"line\"><span class=\"attr\">    severity:</span> <span class=\"string\">'warning'</span></span><br><span class=\"line\"><span class=\"attr\">  equal:</span> <span class=\"string\">['service']</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 路由树</span></span><br><span class=\"line\"><span class=\"attr\">route:</span></span><br><span class=\"line\">  <span class=\"comment\"># 路由默认通知接收器为邮箱通知</span></span><br><span class=\"line\"><span class=\"attr\">  receiver:</span> <span class=\"string\">'email-notify'</span>  </span><br><span class=\"line\"><span class=\"attr\">  group_by:</span> <span class=\"string\">['team']</span> <span class=\"comment\"># 默认路由告警按照team标签进行分组，如没有该标签的告警将不会进行后续匹配。</span></span><br><span class=\"line\"><span class=\"attr\">  group_wait:</span> <span class=\"number\">30</span><span class=\"string\">s</span>    <span class=\"comment\"># 当传入警报创建新的警报组时，请至少等待“group_wait”以发送初始通知。</span></span><br><span class=\"line\"><span class=\"attr\">  group_interval:</span> <span class=\"number\">5</span><span class=\"string\">m</span>  <span class=\"comment\"># 发送第一个通知时，请等待“group_interval”以发送一批新警报，这些警报已开始为该组触发。</span></span><br><span class=\"line\"><span class=\"attr\">  repeat_interval:</span> <span class=\"number\">4</span><span class=\"string\">h</span> <span class=\"comment\"># 如果警报已成功发送，请等待“重复间隔”发送警报。</span></span><br><span class=\"line\">  <span class=\"comment\"># continue: true    # 当匹配一个路由后它不会停止继续向下查找，主要用于将告警记录记录到另外一个系统。</span></span><br><span class=\"line\">  <span class=\"comment\"># 非常注意: 所有上述属性都由所有子路由继承，并且可以在每个子路由上进行覆盖。</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># * 子路由设置 </span></span><br><span class=\"line\"><span class=\"attr\">  routes:</span></span><br><span class=\"line\">  <span class=\"comment\"># 前端团队，开发测试环境主机(team/severity)分别是在告警规则文件中设置的标签。</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">      team:</span> <span class=\"string\">frontend</span></span><br><span class=\"line\"><span class=\"attr\">      env:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"><span class=\"attr\">    group_by:</span> <span class=\"string\">['region','env']</span> <span class=\"comment\"># frontend 团队根据region和env标签对告警进行分组，它针对后续子路有效，因此它们severity标签值为ticket和page的记录也将按照region和env进行分组。</span></span><br><span class=\"line\"><span class=\"attr\">    group_interval:</span> <span class=\"number\">6</span><span class=\"string\">m</span>       <span class=\"comment\"># 组警告之间的间隔时间</span></span><br><span class=\"line\"><span class=\"attr\">    receiver:</span> <span class=\"string\">'email-notify'</span> <span class=\"comment\"># 没有匹配到下述条件的告警将发送给该接收者。</span></span><br><span class=\"line\">    <span class=\"comment\"># 还可嵌套子路由</span></span><br><span class=\"line\"><span class=\"attr\">    routers:</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span> </span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">page</span>  <span class=\"comment\"># 重要事件</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">'frontend-pager'</span></span><br><span class=\"line\"><span class=\"attr\">      group_wait:</span> <span class=\"number\">1</span><span class=\"string\">m</span>        <span class=\"comment\"># 组警告等待</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span> </span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">ticket</span> <span class=\"comment\"># 通知单</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">'frontend-pager'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 后端团队，开发测试环境主机</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">      team:</span> <span class=\"string\">backend</span></span><br><span class=\"line\"><span class=\"attr\">      env:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"><span class=\"attr\">    receiver:</span> <span class=\"string\">'email-notify'</span></span><br><span class=\"line\">    <span class=\"comment\"># 还可嵌套子路由</span></span><br><span class=\"line\"><span class=\"attr\">    routers:</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span> </span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">page</span>  <span class=\"comment\"># 重要事件</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">'backend-pager'</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span> </span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">ticket</span> <span class=\"comment\"># 通知单</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">'backend-pager'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 全团队，线上环境</span></span><br><span class=\"line\"><span class=\"attr\">  - match:</span></span><br><span class=\"line\"><span class=\"attr\">      env:</span> <span class=\"string\">prod</span></span><br><span class=\"line\"><span class=\"attr\">    receiver:</span> <span class=\"string\">'wechat-notify'</span></span><br><span class=\"line\">    <span class=\"comment\"># 还可嵌套子路由</span></span><br><span class=\"line\"><span class=\"attr\">    routers:</span></span><br><span class=\"line\"><span class=\"attr\">    - match:</span> </span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">critical</span>     <span class=\"comment\"># 极为严重</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">'wechat-notify-manager'</span></span><br><span class=\"line\">    <span class=\"comment\"># 支持正则匹配就不用写多行标签了。</span></span><br><span class=\"line\"><span class=\"attr\">    - match_re:</span> </span><br><span class=\"line\"><span class=\"attr\">        severity:</span> <span class=\"string\">(page|ticket)</span> <span class=\"comment\"># 重要事件&amp;通知单</span></span><br><span class=\"line\"><span class=\"attr\">      receiver:</span> <span class=\"string\">'wechat-notify-devops'</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h2 id=\"0x01-Alertmanager-规则与模板\"><a href=\"#0x01-Alertmanager-规则与模板\" class=\"headerlink\" title=\"0x01 Alertmanager 规则与模板\"></a>0x01 Alertmanager 规则与模板</h2><p>描述: 我们知道 Alertmanager 要进行警告必须需要编写对应的告警规则，然后以告警自定义模板文件进行通知接收者。</p>\n<p><br></p>\n<h3 id=\"1-告警规则最佳实践\"><a href=\"#1-告警规则最佳实践\" class=\"headerlink\" title=\"1.告警规则最佳实践\"></a>1.告警规则最佳实践</h3><ul>\n<li>1) 编写完<code>prometheus.yml</code>和<code>rule.yml</code>文件后分别使用promtool check (config|rules) 进行检测。</li>\n<li>2) 规则名称必须唯一，命名规则<code>level:metric:operations</code>如是<code>job_name:up:rate5m</code></li>\n<li>3) 提高查询效率降低基数大小，针对相同的指标使用不同的标签集来制定聚合规则。</li>\n<li>4) 对于记录规则，应该避免在表达式中进行过滤，因为时间序列的出现或消失都很难处理。</li>\n</ul>\n<p>Tips : 对于告警规则过滤是必不可少的，评估告警表达式返回空的瞬时向量不会触发任何告警规则，但如果任何样本返回每个都将成为告警。</p>\n<p><br/></p>\n<p>基础告警规则配置:<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">groups:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">node-alert</span></span><br><span class=\"line\"><span class=\"attr\">  rules:</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"监控节点丢失或宕机\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">avg</span> <span class=\"string\">without()(up)</span> <span class=\"string\">&lt;</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">    for:</span> <span class=\"number\">2</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">'critical'</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"服务器实例 [<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span>]节点丢失或宕机,\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"请系统管理员尽快进行人工干预处理！\"</span></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"L-五分钟内CPU使用率大于90%\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">(node_load5</span> <span class=\"string\">/ignoring(mode)</span> <span class=\"string\">count</span> <span class=\"string\">without(cpu)(node_cpu_seconds_total&#123;mode=\"idle\"&#125;)</span> <span class=\"string\">*</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">&gt; 90</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">3</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"服务器实例 <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 使用率 告警通知\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span>CPU使用率已超过90%, 当前值: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span>%\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"L-内存可用容量小于 10%\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">((node_memory_MemTotal_bytes</span> <span class=\"bullet\">-</span> <span class=\"string\">node_memory_MemFree_bytes</span> <span class=\"bullet\">-</span> <span class=\"string\">node_memory_Buffers_bytes</span> <span class=\"bullet\">-</span> <span class=\"string\">node_memory_Cached_bytes)</span> <span class=\"string\">/</span> <span class=\"string\">(node_memory_MemTotal_bytes</span> <span class=\"string\">))</span> <span class=\"string\">*</span> <span class=\"number\">100</span> <span class=\"string\">&gt; 80</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">2</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"服务器实例 <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 内存不足 告警通知\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 内存可用资源已不足 10%,当前值: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span> %\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"L-磁盘可用容量小于 10%\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">round(100</span> <span class=\"bullet\">-</span> <span class=\"string\">((node_filesystem_avail_bytes&#123;mountpoint=~\".*\",fstype=~\"nfs|ext4|xfs|ext2|ext3\"&#125;</span> <span class=\"string\">*</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">/</span> <span class=\"string\">node_filesystem_size_bytes</span> <span class=\"string\">&#123;mountpoint=~\".*\",fstype=~\"nfs|ext4|xfs|ext2|ext3\"&#125;)</span> <span class=\"string\">&gt; 90)</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">3</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"服务器实例 <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 磁盘不足 告警通知\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 磁盘 <span class=\"template-variable\">&#123;&#123; $labels.device &#125;&#125;</span> 资源 已不足 10%, 当前值: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span>%\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"W-内存可用容量小于 10%\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">round((1</span> <span class=\"bullet\">-</span> <span class=\"string\">(windows_os_physical_memory_free_bytes</span> <span class=\"string\">/</span> <span class=\"string\">windows_cs_physical_memory_bytes))</span> <span class=\"string\">*</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">&gt; 90</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">2</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"服务器实例 <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 内存不足 告警通知\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 内存可用资源已不足 10%,当前值: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"W-磁盘可用容量小于 10%\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">round((1</span> <span class=\"bullet\">-</span> <span class=\"string\">windows_logical_disk_free_bytes&#123;volume=~\"C:|D:|E:|F:\"&#125;</span> <span class=\"string\">/</span> <span class=\"string\">windows_logical_disk_size_bytes&#123;volume=~\"C:|D:|E:|F:\"&#125;</span> <span class=\"string\">)</span> <span class=\"string\">*</span> <span class=\"number\">100</span> <span class=\"string\">&gt; 90)</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">3</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"服务器实例 <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 磁盘不足 告警通知\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> 磁盘 <span class=\"template-variable\">&#123;&#123; $labels.volume &#125;&#125;</span> 资源 已不足 10%, 当前值: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span>%\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"W-五分钟内CPU使用率大于 90%\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">round(100</span> <span class=\"bullet\">-</span> <span class=\"string\">((avg</span> <span class=\"string\">without(core,mode)(irate(windows_cpu_time_total&#123;mode=\"idle\"&#125;[5m])))</span> <span class=\"string\">*</span> <span class=\"number\">100</span><span class=\"string\">)</span> <span class=\"string\">&gt; 90)</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">    for:</span> <span class=\"number\">3</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"服务器实例 <span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span> CPU 使用率 告警通知\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; $labels.instance &#125;&#125;</span>CPU使用率已超过90%, 当前值: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span>%\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  - alert:</span> <span class=\"string\">\"Website-网站服务访问状态异常\"</span></span><br><span class=\"line\"><span class=\"attr\">    expr:</span> <span class=\"string\">probe_success&#123;job=\"HTTP-Check\"&#125;</span> <span class=\"string\">&lt;</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">    for:</span> <span class=\"number\">5</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">    labels:</span></span><br><span class=\"line\"><span class=\"attr\">      severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\"><span class=\"attr\">    annotations:</span></span><br><span class=\"line\"><span class=\"attr\">      message:</span> <span class=\"string\">\"网站地址 <span class=\"template-variable\">&#123;&#123; $labels.http &#125;&#125;</span> ，无法正常提供服务\"</span></span><br><span class=\"line\"><span class=\"attr\">      description:</span> <span class=\"string\">\"请检查并恢复网站名称为 <span class=\"template-variable\">&#123;&#123; $labels.site &#125;&#125;</span> 应用服务，当前值: <span class=\"template-variable\">&#123;&#123; $value &#125;&#125;</span>%\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"2-通知模板编写格式\"><a href=\"#2-通知模板编写格式\" class=\"headerlink\" title=\"2.通知模板编写格式\"></a>2.通知模板编写格式</h3><p>描述: alertmanager带有默认模板同时支持我们编写自定义报警通知模板，并且发送给接收者的通知是通过模板构建。除了文本字段可以模板化以外，还可模板化通知的目的地，通过传递在告警规则中添加指定接受用户标签，便可以在模板总引用并发生（非常Nice）。</p>\n<p>Tips : 注意 Alertmanager 模板与 Prometheus 中的模板不同， Prometheus 模板还包括<code>警报规则标签/注释中的模板</code>。</p>\n<p>参考地址: <a href=\"https://prometheus.io/docs/alerting/latest/notifications/\" target=\"_blank\" rel=\"noopener\">https://prometheus.io/docs/alerting/latest/notifications/</a></p>\n<p><br></p>\n<h4 id=\"Syntax\"><a href=\"#Syntax\" class=\"headerlink\" title=\"Syntax\"></a>Syntax</h4><p>描述: 以下是警报和相应的 Alertmanager 配置文件设置 (alertmanager.yml) 的所有不同示例。  </p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 模板代码块必须使用 &#123;&#123; <span class=\"keyword\">var</span> &#125;&#125; 包含</span><br><span class=\"line\"></span><br><span class=\"line\"># <span class=\"number\">1.</span>定义包含</span><br><span class=\"line\">&#123;&#123; define <span class=\"string\">\"wechat.custom.message\"</span> &#125;&#125; </span><br><span class=\"line\">  app: &#123;&#123; .GroupLabels.app &#125;&#125;/&#123;&#123; .GroupLabels.alertname &#125;&#125;</span><br><span class=\"line\"># <span class=\"number\">2.</span>条件判断(运算符:gt/lt/eq/gte/lte)</span><br><span class=\"line\">  &#123;&#123;- <span class=\"keyword\">if</span> gt (<span class=\"built_in\">len</span> .Alerts.Firing) <span class=\"number\">0</span> -&#125;&#125;</span><br><span class=\"line\"># <span class=\"number\">3.</span>条件循环</span><br><span class=\"line\">    &#123;&#123;- <span class=\"keyword\">range</span> $index, $alert := .Alerts -&#125;&#125;</span><br><span class=\"line\">        告警序号: &#123;&#123; $index &#125;&#125;</span><br><span class=\"line\">        告警类型: &#123;&#123; $alert.Labels.alertname &#125;&#125;</span><br><span class=\"line\">        告警级别: &#123;&#123; $alert.Labels.severity &#125;&#125;</span><br><span class=\"line\">        告警详情: &#123;&#123; $alert.Annotations.summary &#125;&#125;</span><br><span class=\"line\"># <span class=\"number\">4.</span>此处格式的时间字符串是Go诞生时间。</span><br><span class=\"line\">        故障时间: &#123;&#123; $alert.StartsAt.Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">        恢复时间: &#123;&#123; $alert.EndsAt.Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">  &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">&#123;&#123; end&#125;&#125;</span><br></pre></td></tr></table></figure>\n<p>Tips :  更多语法请参照使用 Go 模板系统（<a href=\"https://golang.org/pkg/text/template）。\" target=\"_blank\" rel=\"noopener\">https://golang.org/pkg/text/template）。</a></p>\n<p><br/></p>\n<h4 id=\"Data-Structures\"><a href=\"#Data-Structures\" class=\"headerlink\" title=\"Data Structures\"></a>Data Structures</h4><p>描述: 数据是传递给通知模板和 webhook 推送的结构。</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Receiver</td>\n<td>string</td>\n<td>定义通知将发送到的接收者名称（slack、电子邮件等）。</td>\n</tr>\n<tr>\n<td>Status</td>\n<td>string</td>\n<td>如果至少有一个警报被触发，则定义为触发，否则已解决。</td>\n</tr>\n<tr>\n<td>Alerts</td>\n<td><a href=\"https://prometheus.io/docs/alerting/latest/notifications/#alert\" target=\"_blank\" rel=\"noopener\">Alert</a></td>\n<td>该组中所有警报对象的列表:<br/>Alerts.Firing 返回该组中当前触发的警报对象的列表 <br/>Alerts.Resolved 返回此组中已解决警报对象的列表</td>\n</tr>\n<tr>\n<td>GroupLabels</td>\n<td><a href=\"https://prometheus.io/docs/alerting/latest/notifications/#kv\" target=\"_blank\" rel=\"noopener\">KV</a></td>\n<td>这些警报分组所依据的标签。</td>\n</tr>\n<tr>\n<td>CommonLabels</td>\n<td><a href=\"https://prometheus.io/docs/alerting/latest/notifications/#kv\" target=\"_blank\" rel=\"noopener\">KV</a></td>\n<td>所有警报通用的标签。</td>\n</tr>\n<tr>\n<td>CommonAnnotations</td>\n<td><a href=\"https://prometheus.io/docs/alerting/latest/notifications/#kv\" target=\"_blank\" rel=\"noopener\">KV</a></td>\n<td>所有警报的通用注释集，用于有关警报的更长的附加信息字符串。</td>\n</tr>\n<tr>\n<td>ExternalURL</td>\n<td>string</td>\n<td>反向链接到发送通知的 Alertmanager。</td>\n</tr>\n</tbody>\n</table>\n<p>简单使用示例:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 实例instance标签</span></span><br><span class=\"line\">&#123;&#123; .GroupLabels.instance &#125;&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 告警数量</span></span><br><span class=\"line\">&#123;&#123; .Alerts | len &#125;&#125; </span><br><span class=\"line\">&#123;&#123; (len .Alerts.Firing) &#125;&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h4 id=\"Alert\"><a href=\"#Alert\" class=\"headerlink\" title=\"Alert\"></a>Alert</h4><p>Alert 包含一个通知模板的警报。</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Status</td>\n<td>string</td>\n<td>定义警报是否已解决或当前是否触发。</td>\n</tr>\n<tr>\n<td>Labels</td>\n<td><a href=\"https://prometheus.io/docs/alerting/latest/notifications/#kv\" target=\"_blank\" rel=\"noopener\">KV</a></td>\n<td>要附加到警报的一组标签。</td>\n</tr>\n<tr>\n<td>Annotations</td>\n<td><a href=\"https://prometheus.io/docs/alerting/latest/notifications/#kv\" target=\"_blank\" rel=\"noopener\">KV</a></td>\n<td>警报的一组注释。</td>\n</tr>\n<tr>\n<td>StartsAt</td>\n<td>time.Time</td>\n<td>警报开始触发的时间。 如果省略当前时间由 Alertmanager 分配。</td>\n</tr>\n<tr>\n<td>EndsAt</td>\n<td>time.Time</td>\n<td>仅在已知警报的结束时间时设置。  否则设置为自上次收到警报以来的可配置超时时间。</td>\n</tr>\n<tr>\n<td>GeneratorURL</td>\n<td>string</td>\n<td>标识此警报的原因实体的反向链接。</td>\n</tr>\n<tr>\n<td>Fingerprint</td>\n<td>string</td>\n<td>可用于识别警报的指纹。</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;- range $index, $alert :&#x3D; .Alerts -&#125;&#125;</span><br><span class=\"line\">告警类型: &#123;&#123; $alert.Labels.alertname &#125;&#125;</span><br><span class=\"line\">告警级别: &#123;&#123; $alert.Labels.severity &#125;&#125;</span><br><span class=\"line\">告警详情: &#123;&#123; $alert.Annotations.summary &#125;&#125;</span><br><span class=\"line\">故障时间: &#123;&#123; $alert.StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class=\"line\">恢复时间: &#123;&#123; $alert.EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Functions\"><a href=\"#Functions\" class=\"headerlink\" title=\"Functions\"></a>Functions</h4><p>描述: 请注意 Go 模板也提供的默认功能。</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Arguments</th>\n<th>Returns</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>title</td>\n<td>string</td>\n<td>strings.Title，将每个单词的第一个字符大写。</td>\n<td></td>\n</tr>\n<tr>\n<td>toUpper</td>\n<td>string</td>\n<td>strings.ToUpper，将所有字符转换为大写。</td>\n<td></td>\n</tr>\n<tr>\n<td>toLower</td>\n<td>string</td>\n<td>strings.ToLower，将所有字符转换为小写。</td>\n<td></td>\n</tr>\n<tr>\n<td>match</td>\n<td>pattern, string</td>\n<td>正则表达式.MatchString。使用 Regexp 匹配字符串。</td>\n<td></td>\n</tr>\n<tr>\n<td>reReplaceAll</td>\n<td>pattern, replacement, text</td>\n<td>Regexp.ReplaceAllString 正则表达式替换，未锚定。</td>\n<td></td>\n</tr>\n<tr>\n<td>join</td>\n<td>sep string, s []string</td>\n<td>strings.Join，连接 s 的元素以创建单个字符串。  分隔符字符串 sep 放置在结果字符串中的元素之间。  （注意：参数顺序颠倒以便在模板中更容易流水线化。）</td>\n<td></td>\n</tr>\n<tr>\n<td>safeHtml</td>\n<td>text string</td>\n<td>html/template.HTML，将字符串标记为不需要自动转义的 HTML。</td>\n<td></td>\n</tr>\n<tr>\n<td>stringSlice</td>\n<td>…string</td>\n<td>将传递的字符串作为字符串切片返回。</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h2 id=\"0x02-AlertManager-告警实践\"><a href=\"#0x02-AlertManager-告警实践\" class=\"headerlink\" title=\"0x02 AlertManager 告警实践\"></a>0x02 AlertManager 告警实践</h2><p>描述: 在前面几章的学习中都没有讲解AlertManager报警管理系统的使用，博主专门把他放在本章进行讲解，因为其实现报警通知的方式有多种多样。</p>\n<p>Email_config 配置参考: <a href=\"https://prometheus.io/docs/alerting/latest/configuration/#email_config\" target=\"_blank\" rel=\"noopener\">https://prometheus.io/docs/alerting/latest/configuration/#email_config</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 注意此处非全局所以没有smtp前缀</span></span><br><span class=\"line\"><span class=\"comment\"># Whether or not to notify about resolved alerts.</span></span><br><span class=\"line\">[ send_resolved: &lt;boolean&gt; | default = <span class=\"literal\">false</span> ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The email address to send notifications to.</span></span><br><span class=\"line\">to: &lt;tmpl_string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The sender address.</span></span><br><span class=\"line\">[ from: &lt;tmpl_string&gt; | default = global.smtp_from ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The SMTP host through which emails are sent.</span></span><br><span class=\"line\">[ smarthost: &lt;string&gt; | default = global.smtp_smarthost ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The hostname to identify to the SMTP server.</span></span><br><span class=\"line\">[ hello: &lt;string&gt; | default = global.smtp_hello ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># SMTP authentication information.</span></span><br><span class=\"line\">[ auth_username: &lt;string&gt; | default = global.smtp_auth_username ]</span><br><span class=\"line\">[ auth_password: &lt;secret&gt; | default = global.smtp_auth_password ]</span><br><span class=\"line\">[ auth_secret: &lt;secret&gt; | default = global.smtp_auth_secret ]</span><br><span class=\"line\">[ auth_identity: &lt;string&gt; | default = global.smtp_auth_identity ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The SMTP TLS requirement.</span></span><br><span class=\"line\"><span class=\"comment\"># Note that Go does not support unencrypted connections to remote SMTP endpoints.</span></span><br><span class=\"line\">[ require_tls: &lt;bool&gt; | default = global.smtp_require_tls ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># TLS configuration.</span></span><br><span class=\"line\">tls_config:</span><br><span class=\"line\">  [ &lt;tls_config&gt; ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The HTML body of the email notification.</span></span><br><span class=\"line\">[ html: &lt;tmpl_string&gt; | default = <span class=\"string\">'&#123;&#123; template \"email.default.html\" . &#125;&#125;'</span> ]</span><br><span class=\"line\"><span class=\"comment\"># The text body of the email notification.</span></span><br><span class=\"line\">[ text: &lt;tmpl_string&gt; ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Further headers email header key/value pairs. Overrides any headers</span></span><br><span class=\"line\"><span class=\"comment\"># previously set by the notification implementation.</span></span><br><span class=\"line\">[ headers: &#123; &lt;string&gt;: &lt;tmpl_string&gt;, ... &#125; ]</span><br></pre></td></tr></table></figure></p>\n<p><strong>实践目标:</strong></p>\n<ul>\n<li>1.配置并使用腾讯企业邮箱进行邮件发送警告</li>\n<li>2.配置并使用自定义邮箱报警样式模板</li>\n<li>3.配置并使用企业微信发送报警通知</li>\n</ul>\n<p><br></p>\n<h3 id=\"1-配置并使用腾讯企业邮箱进行邮件发送警告\"><a href=\"#1-配置并使用腾讯企业邮箱进行邮件发送警告\" class=\"headerlink\" title=\"1.配置并使用腾讯企业邮箱进行邮件发送警告\"></a>1.配置并使用腾讯企业邮箱进行邮件发送警告</h3><ul>\n<li>Step 1.首先我们需要配置 Prometheus.yml 抓取目标、加载规则文件，并与Alertmanager通信设置。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">global:</span><br><span class=\"line\">  scrape_interval: 2m</span><br><span class=\"line\">  scrape_timeout: 10s</span><br><span class=\"line\">  <span class=\"comment\"># - 每分钟进行报警规则的评估 (建议根据实际情况进行修改)</span></span><br><span class=\"line\">  evaluation_interval: 1m</span><br><span class=\"line\">  external_labels:</span><br><span class=\"line\">    monitor: <span class=\"string\">'prom-demo'</span></span><br><span class=\"line\"></span><br><span class=\"line\">alerting:</span><br><span class=\"line\">  <span class=\"comment\"># - 设置报警管理系统的目标地址 (可以配置多个AlertManager)</span></span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">  - scheme: http</span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">    - targets:</span><br><span class=\"line\">      - <span class=\"string\">'192.168.12.107:30093'</span></span><br><span class=\"line\"></span><br><span class=\"line\">rule_files:</span><br><span class=\"line\">  <span class=\"comment\"># - 指标监控告警规则 (可以根据不同的场景进行报警规则)</span></span><br><span class=\"line\">  - /etc/prometheus/conf.d/rules/*.rules</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># - 采集监控的静态目标和自动化发现目标</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: <span class=\"string\">'prom-Server'</span></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets: [<span class=\"string\">'localhost:9090'</span>]</span><br><span class=\"line\">  - job_name: <span class=\"string\">'cAdvisor'</span></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets: [<span class=\"string\">'192.168.12.111:9100'</span>]</span><br><span class=\"line\">  - job_name: <span class=\"string\">'linux_exporter'</span></span><br><span class=\"line\">    scrape_interval: 30s</span><br><span class=\"line\">    file_sd_configs:</span><br><span class=\"line\">    - files:</span><br><span class=\"line\">      - /etc/prometheus/conf.d/discovery/k8s_nodes.yaml</span><br><span class=\"line\">      <span class=\"comment\"># - 自动刷新自动发现配置文件</span></span><br><span class=\"line\">      refresh_interval: 1m</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<ul>\n<li>Step 2.配置 Prometheus 报警规则此次判断采集节点的状态和节点主机负载情况<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee alert.rules &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">groups:</span><br><span class=\"line\">- name: node-normal</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - alert: service_down</span><br><span class=\"line\">    expr: up &#123;job=<span class=\"string\">\"linux_exporter\"</span>&#125; == 0</span><br><span class=\"line\">    <span class=\"comment\"># - 对于持续时间的设置在实际环境中至少建议5min，以减少噪声从而减轻固有监控各种情况,此处设置为30s便于报警情况的观察。</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>: 30s</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      severity: <span class=\"string\">'critical'</span></span><br><span class=\"line\">      team: node</span><br><span class=\"line\">    annotations:</span><br><span class=\"line\">      summary: <span class=\"string\">\"主机 &#123;&#123; <span class=\"variable\">$labels</span>.instance &#125;&#125; 监控服务已停止运行超过 15s！\"</span></span><br><span class=\"line\">      description: <span class=\"string\">\"请系统管理员尽快进行人工干预处理！\"</span></span><br><span class=\"line\">  - alert: high_load</span><br><span class=\"line\">    expr: node_load1 &gt; 0.7</span><br><span class=\"line\">    <span class=\"keyword\">for</span>: 5m</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      severity: <span class=\"string\">'warning'</span></span><br><span class=\"line\">      team: node</span><br><span class=\"line\">    annotations:</span><br><span class=\"line\">      summary: <span class=\"string\">\"主机 &#123;&#123; <span class=\"variable\">$labels</span>.instance &#125;&#125; 高负载大于0.7以上运行超过 5m！\"</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : 说明一下该 rules 目的是监测 node 是否存活 expr 为 PromQL 表达式验证特定节点 job=”linux_exporter” 是否活着，for 表示报警状态为 Pending 后等待 30s 变成 Firing 状态，一旦变成 Firing 状态则将报警发送到 AlertManager 并且 labels （<code>标签</code>）和 annotations（<code>注释</code>） 对该 alert 添加更多的标识和注解信息。</p>\n<ul>\n<li>Step 3.配置 Alertmanager 报警通知，此时配置腾讯企业邮箱的方式进行邮件发送报警。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee alertmanager.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># - 全局配置</span></span><br><span class=\"line\">global:</span><br><span class=\"line\">  resolve_timeout: 5m</span><br><span class=\"line\">  smtp_from: <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\">  <span class=\"comment\"># - 企业邮箱 SMTP 服务地址</span></span><br><span class=\"line\">  smtp_smarthost: <span class=\"string\">'smtp.exmail.qq.com:465'</span></span><br><span class=\"line\">  smtp_auth_username: <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\">  <span class=\"comment\"># - 第三方登录企业邮箱的授权码</span></span><br><span class=\"line\">  smtp_auth_password: xxxxxxxxxxx<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">  smtp_require_tls: false</span></span><br><span class=\"line\"><span class=\"string\">  # smtp_hello: '</span>qq.com<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\"># - 设置报警的分发策略</span></span><br><span class=\"line\"><span class=\"string\">route:</span></span><br><span class=\"line\"><span class=\"string\">  group_by: ['</span>alertname<span class=\"string\">']</span></span><br><span class=\"line\"><span class=\"string\">  group_wait: 30s</span></span><br><span class=\"line\"><span class=\"string\">  group_interval: 1m</span></span><br><span class=\"line\"><span class=\"string\">  # - 如果在10分钟内还未解除报警则进行发送告警</span></span><br><span class=\"line\"><span class=\"string\">  repeat_interval: 10m</span></span><br><span class=\"line\"><span class=\"string\">  receiver: '</span>default-email<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\"># -  配置告警消息接受者信息</span></span><br><span class=\"line\"><span class=\"string\">receivers:</span></span><br><span class=\"line\"><span class=\"string\">- name: '</span>default-email<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">  email_configs:</span></span><br><span class=\"line\"><span class=\"string\">  - to: '</span>master@weiyigeek.top<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">    send_resolved: true</span></span><br><span class=\"line\"><span class=\"string\"># - 抑制规则配置</span></span><br><span class=\"line\"><span class=\"string\">inhibit_rules:</span></span><br><span class=\"line\"><span class=\"string\">  - source_match:</span></span><br><span class=\"line\"><span class=\"string\">      severity: '</span>critical<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">    target_match:</span></span><br><span class=\"line\"><span class=\"string\">      severity: '</span>warning<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">    equal: ['</span>alertname<span class=\"string\">', '</span>instance<span class=\"string\">']</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<ul>\n<li>Step 4.重启Prometheus和Alertmanager服务，同时关闭一台node进行触发报警发送 Email，上边我们定义的 rule 规则为监测 job=”linux_exporter” Node 是否活着，那么就可以停掉 node-exporter 服务来间接起到 Node Down 的作用，从而达到报警条件，触发报警规则。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 重启容器</span></span><br><span class=\"line\">docker restart prometheus_alertmanager prometheus_server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 关闭192.168.12.109机器的node_exporter服务</span></span><br><span class=\"line\">ssh -p 20211 weiyigeek@weiyigeek-109 <span class=\"string\">\"sudo -S systemctl stop node_exporter.service\"</span></span><br><span class=\"line\">[sudo] password <span class=\"keyword\">for</span> weiyigeek:</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<ul>\n<li>Step 5.效果查看及报警流程说明，关闭后等待prometheus定时拉取各job的任务执行，其次我们可以在<code>Targets</code>刷新查看<code>linux_exporter</code>任务中状态为 unhealthy <code>192.168.12.109</code>的节点状态是否变成了DOWN，等待 30s 后，alert 页面由绿色 Service_down (0 active) Inactive 状态变成了黄色 Service_down (1 active) Pending 状态，继续等待 30s 后状态变成红色 Firing 状态，向 AlertManager 发送报警信息，此时 AlertManager 则按照配置规则向接受者发送邮件告警。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">linux_exporter (5/6 up)</span><br><span class=\"line\">Endpoint\tState\t Error</span><br><span class=\"line\">http://192.168.12.109:9100/metrics\tDOWN\tGet <span class=\"string\">\"http://192.168.12.109:9100/metrics\"</span>: dial tcp 192.168.12.109:9100: connect: connection refused</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210519224330.png\" alt=\"WeiyiGeek.Alert\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Alert</p>\n            </figure>\n<p><br></p>\n<ul>\n<li>Step 6.我们在 AlertManager 查看发送报警信息以及发送的报警邮箱，可以看到接收到的报警包含该节点的标签以及我们添加的<code>Annotations</code>注释信息。<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210519225517.png\" alt=\"WeiyiGeek.AlertManager-Firing\" title=\"\" class=\"\">\n                <p>WeiyiGeek.AlertManager-Firing</p>\n            </figure>\n</li>\n</ul>\n<ul>\n<li>Step 7.然后我们将<code>192.168.12.109</code>机器的linux_exporter服务进行开启查看其恢复以及警报解除情况。在等待 30s 之后，Prometheus Alerts 页面变成绿色 <code>Service_down (0 active) Inactive</code> 状态，同时也收到了报警解除邮件提醒。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -p 20211 weiyigeek@weiyigeek-109 <span class=\"string\">\"sudo -S systemctl start node_exporter.service\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210519230856.png\" alt=\"WeiyiGeek.AlertManager-Resolved\" title=\"\" class=\"\">\n                <p>WeiyiGeek.AlertManager-Resolved</p>\n            </figure>\n<p>Tips : 每次停止/恢复服务后 30s 之后才会发现 Alert 状态变化，是因为 prometheus.yml中 global -&gt; scrape_interval: 30s 配置决定的，如果觉得等待 30s 时间太长，可以修改小一些可以全局修改，也可以局部修改。例如s上面就行采用局部修改 linux_exporter 等待时间为 30s。</p>\n<p><br></p>\n<h3 id=\"2-配置并使用自定义邮箱报警样式模板\"><a href=\"#2-配置并使用自定义邮箱报警样式模板\" class=\"headerlink\" title=\"2.配置并使用自定义邮箱报警样式模板\"></a>2.配置并使用自定义邮箱报警样式模板</h3><p>描述: 虽然默认的邮件报警样式模板已经包含了所有核心的信息，但是邮件格式内容可以更优雅直观一些，同时AlertManager 也是支持自定义邮件模板配置的。</p>\n<ul>\n<li>Step 1.首先新建一个模板文件 email.tmpl<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee email.tmpl&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">&#123;&#123; define <span class=\"string\">\"email.from\"</span> &#125;&#125;monitor@weiyigeek.top&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">&#123;&#123; define <span class=\"string\">\"email.to\"</span> &#125;&#125;master@weiyigeek.top&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">&#123;&#123; define <span class=\"string\">\"email.to.html\"</span> &#125;&#125;</span><br><span class=\"line\">&#123;&#123; range .Alerts &#125;&#125;</span><br><span class=\"line\">&lt;b&gt;=========start==========&lt;/b&gt;&lt;br&gt;</span><br><span class=\"line\">告警程序: prometheus_alert &lt;br&gt;</span><br><span class=\"line\">告警级别: &#123;&#123; .Labels.severity &#125;&#125; 级 &lt;br&gt;</span><br><span class=\"line\">告警类型: &#123;&#123; .Labels.alertname &#125;&#125; &lt;br&gt;</span><br><span class=\"line\">故障主机: &#123;&#123; .Labels.instance &#125;&#125; &lt;br&gt;</span><br><span class=\"line\">告警主题: &#123;&#123; .Annotations.summary &#125;&#125; &lt;br&gt;</span><br><span class=\"line\">告警详情: &#123;&#123; .Annotations.description &#125;&#125; &lt;br&gt;</span><br><span class=\"line\">触发时间: &#123;&#123; .StartsAt.Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125; &lt;br&gt;</span><br><span class=\"line\">&lt;b&gt;=========end==========&lt;/b&gt;&lt;br&gt;</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\nTips : 注意上述的<code>.StartsAt.Format</code>的格式化字符必须是<code>&quot;2006-01-02 15:04:05&quot;</code>(Go 语言诞生的时间我，我们可以<code>简约记2006 1 2 3 4 5</code>),否则报警的时间不对。</li>\n</ul>\n<ul>\n<li>Step 2.其次在AlertManager主配置文件中引用模板及其定义<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">alertmanager.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\"><span class=\"attr\">  resolve_timeout:</span> <span class=\"number\">5</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_from:</span> <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_smarthost:</span> <span class=\"string\">'smtp.exmail.qq.com:465'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_auth_username:</span> <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_auth_password:</span> <span class=\"string\">'xxxxxxxxxxxxxxx'</span></span><br><span class=\"line\"><span class=\"attr\">  smtp_require_tls:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"comment\"># smtp_hello: 'qq.com'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - Tips 上面的全局邮件参数无法从email.tmpl中读取&#123;&#123; template \"email.username\" . &#125;&#125;坑(排错一下午)</span></span><br><span class=\"line\"><span class=\"attr\">templates:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">'/alertmanager/email.tmpl'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">route:</span></span><br><span class=\"line\"><span class=\"attr\">  group_by:</span> <span class=\"string\">['alertname']</span></span><br><span class=\"line\"><span class=\"attr\">  group_wait:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">  group_interval:</span> <span class=\"number\">1</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">  repeat_interval:</span> <span class=\"number\">10</span><span class=\"string\">m</span></span><br><span class=\"line\"><span class=\"attr\">  receiver:</span> <span class=\"string\">'default-email'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">receivers:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">'default-email'</span></span><br><span class=\"line\"><span class=\"attr\">  email_configs:</span></span><br><span class=\"line\"><span class=\"attr\">  - to:</span> <span class=\"string\">'<span class=\"template-variable\">&#123;&#123; template \"email.to\" . &#125;&#125;</span>'</span></span><br><span class=\"line\"><span class=\"attr\">    html:</span> <span class=\"string\">'<span class=\"template-variable\">&#123;&#123; template \"email.to.html\" . &#125;&#125;</span>'</span></span><br><span class=\"line\">    <span class=\"comment\"># 如果问题已解决将发送信息如设置false则不发送</span></span><br><span class=\"line\"><span class=\"attr\">    send_resolved:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">inhibit_rules:</span></span><br><span class=\"line\"><span class=\"attr\">- source_match:</span></span><br><span class=\"line\"><span class=\"attr\">    severity:</span> <span class=\"string\">'critical'</span></span><br><span class=\"line\"><span class=\"attr\">  target_match:</span></span><br><span class=\"line\"><span class=\"attr\">    severity:</span> <span class=\"string\">'warning'</span></span><br><span class=\"line\"><span class=\"attr\">  equal:</span> <span class=\"string\">['alertname',</span> <span class=\"string\">'instance'</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">温馨提示：全局中的邮件参数无法从email.tmpl中读取定义的模板参数，例如&#123;&#123; template <span class=\"string\">\"email.username\"</span> .&#125;&#125;坑(排错一下午)只有以下对象可以读取:</span><br><span class=\"line\"></span><br><span class=\"line\">email_config:</span><br><span class=\"line\">- to: &lt;tmpl_string&gt;</span><br><span class=\"line\">  from: &lt;tmpl_string&gt;</span><br><span class=\"line\">  html: &lt;tmpl_string&gt;  | text: &lt;tmpl_string&gt;  &#123;&#123; template <span class=\"string\">\"email.default.html\"</span> . &#125;&#125;</span><br></pre></td></tr></table></figure>\n<p>Tips:官方email_config配置参考地址(<a href=\"https://prometheus.io/docs/alerting/latest/configuration/#email_config\" target=\"_blank\" rel=\"noopener\">https://prometheus.io/docs/alerting/latest/configuration/#email_config</a>)</p>\n<p><br></p>\n<ul>\n<li>Step 3.重启alertmanager服务<code>docker restart prometheus_alertmanager</code>, 然后同样停止<code>192.168.12.109</code>的node_exporter服务<code>ssh -p 20211 weiyigeek@weiyigeek-109 &quot;sudo -S systemctl stop node_exporter.service&quot;</code>然后等待prometheus拉取的时间30s，此时为pending状态，再等待30s此时为Firing状态并发送告警邮件，并且在10分钟外如果还收到该报警信息便会再次进行发送。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210520233229.png\" alt=\"WeiyiGeek.自定义邮件模板\" title=\"\" class=\"\">\n                <p>WeiyiGeek.自定义邮件模板</p>\n            </figure>\n<ul>\n<li>Step 4.至此自定义的Email通知模板的使用到此结束,但是此模板还有不够完善的地方例如当计算机恢复后的通知信息没有进行判断。</li>\n</ul>\n<p><br></p>\n<h3 id=\"3-配置并使用企业微信发送报警通知\"><a href=\"#3-配置并使用企业微信发送报警通知\" class=\"headerlink\" title=\"3.配置并使用企业微信发送报警通知\"></a>3.配置并使用企业微信发送报警通知</h3><p>描述: Alertmanager 已经内置了对企业微信的支持，我们可以通过企业微信来管理报警，更进一步可以通过企业微信和微信的互通来直接将告警消息转发到个人微信上，在前面的Alertmanager.yaml配置文件参数进行了解也可以从<a href=\"https://prometheus.io/docs/alerting/configuration/#wechat_config\" target=\"_blank\" rel=\"noopener\">prometheus的官网</a> 中给出了企业微信的相关配置说明如下：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Whether or not to notify about resolved alerts.</span></span><br><span class=\"line\">[ send_resolved: &lt;boolean&gt; | default = <span class=\"literal\">false</span> ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The WeChat API URL.</span></span><br><span class=\"line\">[ api_url: &lt;string&gt; | default = global.wechat_api_url ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 企业微信账号唯一 ID， 可以在我的企业中查看。</span></span><br><span class=\"line\">[ corp_id: &lt;string&gt; | default = global.wechat_api_corp_id ]</span><br><span class=\"line\"><span class=\"comment\"># 第三方企业应用的密钥，可以在自己创建的第三方企业应用详情页面查看。</span></span><br><span class=\"line\">[ api_secret: &lt;secret&gt; | default = global.wechat_api_secret ]</span><br><span class=\"line\"><span class=\"comment\"># 第三方企业应用的 ID，可以在自己创建的第三方企业应用详情页面查看。</span></span><br><span class=\"line\">[ agent_id: &lt;string&gt; | default = <span class=\"string\">'&#123;&#123; template \"wechat.default.agent_id\" . &#125;&#125;'</span> ]</span><br><span class=\"line\"><span class=\"comment\"># 在后台通讯录查看需要发送的组的部门ID ( PartyID1 | PartyID2)</span></span><br><span class=\"line\">[ to_party: &lt;string&gt; | default = <span class=\"string\">'&#123;&#123; template \"wechat.default.to_party\" . &#125;&#125;'</span> ]</span><br><span class=\"line\"><span class=\"comment\"># 发送的成员 @all 表示所有的成员</span></span><br><span class=\"line\">[ to_user: &lt;string&gt; | default = <span class=\"string\">'&#123;&#123; template \"wechat.default.to_user\" . &#125;&#125;'</span> ]</span><br><span class=\"line\"><span class=\"comment\"># 发送给特点 tag 标记的，</span></span><br><span class=\"line\">[ to_tag: &lt;string&gt; | default = <span class=\"string\">'&#123;&#123; template \"wechat.default.to_tag\" . &#125;&#125;'</span> ]</span><br><span class=\"line\"><span class=\"comment\"># </span></span><br><span class=\"line\">[ message: &lt;tmpl_string&gt; | default = <span class=\"string\">'&#123;&#123; template \"wechat.default.message\" . &#125;&#125;'</span> ]</span><br></pre></td></tr></table></figure></p>\n<p><br/><br>Tips : 企业微信相关概念说明请参考<a href=\"https://work.weixin.qq.com/api/doc#90000/90135/90665\" target=\"_blank\" rel=\"noopener\">企业微信API说明</a>，可以在企业微信的后台中建立多个应用，每个应用对应不同的报警分组，由企业微信来做接收成员的划分。</p>\n<p><br/></p>\n<p><strong>操作流程步骤:</strong></p>\n<ul>\n<li>Step 1.访问<a href=\"https://work.weixin.qq.com/\" target=\"_blank\" rel=\"noopener\">企业微信</a>网站有账号的直接扫码登陆如果没有就注册一个即可,登陆后访问企业应用进行创建自建应用,点击创建应用按钮-&gt;填写应用相关信息(包括应用名称、或应用介绍以及可用范围)。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210521091909.png\" alt=\"WeiyiGeek.创建自建应用\" title=\"\" class=\"\">\n                <p>WeiyiGeek.创建自建应用</p>\n            </figure>\n<p><br/></p>\n<ul>\n<li>Step 2.查看的获得 AgentId 以及 Secret 将其记录下来以及部门<code>ID：to_party</code>(需要发送的组),在后面的<code>AlertManager.yml</code>配置文件中使用。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 例如:博主的AgentId和Secret的格式如下</span></span><br><span class=\"line\">企业ID: ww32cf0bf4e4b11487</span><br><span class=\"line\">agent_id: 1000002</span><br><span class=\"line\">api_secret: SYCdXbWj5SjdT9pOSQnjIZ4RF_SIRqERVuZNWE1yE5g</span><br><span class=\"line\">to_party: 1</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210521092006.png\" alt=\"WeiyiGeek.AgentId和Secret\" title=\"\" class=\"\">\n                <p>WeiyiGeek.AgentId和Secret</p>\n            </figure>\n<p><br/></p>\n<ul>\n<li>Step 3.编辑Alertmanager.yaml主配置文件设置企业微信通知相关参数。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee alertmanager.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">global:</span><br><span class=\"line\">  resolve_timeout: 2m</span><br><span class=\"line\"></span><br><span class=\"line\">templates:</span><br><span class=\"line\">- <span class=\"string\">'/alertmanager/*.tmpl'</span></span><br><span class=\"line\"></span><br><span class=\"line\">route:</span><br><span class=\"line\">  group_by: [<span class=\"string\">'alertname'</span>]</span><br><span class=\"line\">  group_wait: 30s</span><br><span class=\"line\">  group_interval: 1m</span><br><span class=\"line\">  repeat_interval: 10m</span><br><span class=\"line\">  receiver: <span class=\"string\">'wechat'</span></span><br><span class=\"line\"></span><br><span class=\"line\">receivers:</span><br><span class=\"line\">- name: <span class=\"string\">'default-email'</span></span><br><span class=\"line\">  email_configs:</span><br><span class=\"line\">  - from: <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\">    smarthost: <span class=\"string\">'smtp.exmail.qq.com:465'</span></span><br><span class=\"line\">    auth_username: <span class=\"string\">'monitor@weiyigeek.top'</span></span><br><span class=\"line\">    auth_password: <span class=\"string\">'xxxxxxxxxxxxxxx'</span></span><br><span class=\"line\">    require_tls: <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"comment\"># smtp_hello: 'qq.com'</span></span><br><span class=\"line\">    to: <span class=\"string\">'&#123;&#123; template \"email.to\" . &#125;&#125;'</span></span><br><span class=\"line\">    html: <span class=\"string\">'&#123;&#123; template \"email.to.html\" . &#125;&#125;'</span></span><br><span class=\"line\">    send_resolved: <span class=\"literal\">true</span></span><br><span class=\"line\">  </span><br><span class=\"line\">- name: <span class=\"string\">'wechat'</span></span><br><span class=\"line\">  wechat_configs:</span><br><span class=\"line\">  - send_resolved: <span class=\"literal\">true</span></span><br><span class=\"line\">    api_url: <span class=\"string\">'https://qyapi.weixin.qq.com/cgi-bin/'</span></span><br><span class=\"line\">    corp_id: <span class=\"string\">'ww32cf0bf4e4b11487'</span></span><br><span class=\"line\">    agent_id: <span class=\"string\">'1000002'</span></span><br><span class=\"line\">    api_secret: <span class=\"string\">'SYCdXbWj5SjdT9pOSQnjIZ4RF_SIRqERVuZNWE1yE5g'</span></span><br><span class=\"line\">    to_user: <span class=\"string\">'@all'</span></span><br><span class=\"line\">    to_party: <span class=\"string\">'1'</span></span><br><span class=\"line\">    message: <span class=\"string\">'&#123;&#123; template \"wechat.default.message\" . &#125;&#125;'</span></span><br><span class=\"line\">   </span><br><span class=\"line\">inhibit_rules:</span><br><span class=\"line\">- source_match:</span><br><span class=\"line\">    severity: <span class=\"string\">'critical'</span></span><br><span class=\"line\">  target_match:</span><br><span class=\"line\">    severity: <span class=\"string\">'warning'</span></span><br><span class=\"line\">  equal: [<span class=\"string\">'alertname'</span>, <span class=\"string\">'instance'</span>]</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>Step 4.重启Alertmanager服务<code>docker restart prometheus_alertmanager</code>以后,我们先来查看默认的企业微信报警信息通知。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210521095929.png\" alt=\"WeiyiGeek.Webchat报警查看\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Webchat报警查看</p>\n            </figure>\n<p><br></p>\n<ul>\n<li>Step 5.采用自定义的Wechat报警模块(包括Firing和Resolved)的信息通知<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee wechat.tmpl &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">&#123;&#123; define <span class=\"string\">\"wechat.default.message\"</span> &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- range <span class=\"variable\">$index</span>, <span class=\"variable\">$alert</span> := .Alerts -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> eq <span class=\"variable\">$index</span> 0 -&#125;&#125;</span><br><span class=\"line\">告警类型: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.alertname &#125;&#125;</span><br><span class=\"line\">告警级别: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.severity &#125;&#125;</span><br><span class=\"line\">=====================</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">===告警详情===</span><br><span class=\"line\">告警详情: &#123;&#123; <span class=\"variable\">$alert</span>.Annotations.summary &#125;&#125;</span><br><span class=\"line\">告警描述: &#123;&#123; <span class=\"variable\">$alert</span>.Annotations.description &#125;&#125;</span><br><span class=\"line\">故障时间: &#123;&#123; <span class=\"variable\">$alert</span>.StartsAt.Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">===参考信息===</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.instance) 0 -&#125;&#125;故障实例ip: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.instance &#125;&#125;;&#123;&#123;- end -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.namespace) 0 -&#125;&#125;故障实例所在namespace: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.namespace &#125;&#125;;&#123;&#123;- end -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.node) 0 -&#125;&#125;故障物理机ip: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.node &#125;&#125;;&#123;&#123;- end -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.pod_name) 0 -&#125;&#125;故障pod名称: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.pod_name &#125;&#125;&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">=====================</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- range <span class=\"variable\">$index</span>, <span class=\"variable\">$alert</span> := .Alerts -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> eq <span class=\"variable\">$index</span> 0 -&#125;&#125;</span><br><span class=\"line\">告警类型: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.alertname &#125;&#125;</span><br><span class=\"line\">告警级别: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.severity &#125;&#125;</span><br><span class=\"line\">=====================</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">===告警详情===</span><br><span class=\"line\">告警详情: &#123;&#123; <span class=\"variable\">$alert</span>.Annotations.summary &#125;&#125;</span><br><span class=\"line\">故障时间: &#123;&#123; <span class=\"variable\">$alert</span>.StartsAt.Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">恢复时间: &#123;&#123; <span class=\"variable\">$alert</span>.EndsAt.Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">===参考信息===</span><br><span class=\"line\">&#123;&#123; <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.instance) 0 -&#125;&#125;故障实例ip: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.instance &#125;&#125;;&#123;&#123;- end -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.namespace) 0 -&#125;&#125;故障实例所在namespace: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.namespace &#125;&#125;;&#123;&#123;- end -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.node) 0 -&#125;&#125;故障物理机ip: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.node &#125;&#125;;&#123;&#123;- end -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.pod_name) 0 -&#125;&#125;故障pod名称: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.pod_name &#125;&#125;;&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">=====================</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>Step 6.将alertmanager主配置yaml文件下面的, 采用注释的#去掉即可启用自定义模板信息，将<code>192.168.12.109</code>机器的node_exporter进行关闭测试模板情况,等待3m将把警告进行发送。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># message: '&#123;&#123; template \"wechat.default.message\" . &#125;&#125;'</span></span><br><span class=\"line\">apt </span><br><span class=\"line\"><span class=\"comment\"># 重启 </span></span><br><span class=\"line\">docker restart prometheus_alertmanager</span><br><span class=\"line\"><span class=\"comment\"># 日志查看</span></span><br><span class=\"line\">docker logs --tail 50 -f prometheus_alertmanager</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210521102356.png\" alt=\"WeiyiGeek.prometheus&alertmanager\" title=\"\" class=\"\">\n                <p>WeiyiGeek.prometheus&alertmanager</p>\n            </figure>\n<ul>\n<li>Step 7.异常告警<code>(Alerts.Firing)</code>以及<code>异常恢复(Alerts.Resolved)</code>通知发送结果查看。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210521102935.png\" alt=\"WeiyiGeek.Firing&Resolved\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Firing&Resolved</p>\n            </figure>\n<p><br/></p>\n<p><strong>补充说明:</strong></p>\n<ul>\n<li>1.Wechat 模板示例学习与改进。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123; define <span class=\"string\">\"wechat.default.message\"</span> &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- range <span class=\"variable\">$index</span>, <span class=\"variable\">$alert</span> := .Alerts -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> eq <span class=\"variable\">$index</span> 0 &#125;&#125;</span><br><span class=\"line\">==========异常告警==========</span><br><span class=\"line\">告警类型: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.alertname &#125;&#125;</span><br><span class=\"line\">告警级别: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.severity &#125;&#125;</span><br><span class=\"line\">告警详情: &#123;&#123; <span class=\"variable\">$alert</span>.Annotations.message &#125;&#125;&#123;&#123; <span class=\"variable\">$alert</span>.Annotations.description&#125;&#125;;&#123;&#123;<span class=\"variable\">$alert</span>.Annotations.summary&#125;&#125;</span><br><span class=\"line\">故障时间: &#123;&#123; (<span class=\"variable\">$alert</span>.StartsAt.Add 28800e9).Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.instance) 0 &#125;&#125;</span><br><span class=\"line\">实例信息: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.instance &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.namespace) 0 &#125;&#125;</span><br><span class=\"line\">命名空间: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.namespace &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.node) 0 &#125;&#125;</span><br><span class=\"line\">节点信息: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.node &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.pod) 0 &#125;&#125;</span><br><span class=\"line\">实例名称: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.pod &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">============END============</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- range <span class=\"variable\">$index</span>, <span class=\"variable\">$alert</span> := .Alerts -&#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> eq <span class=\"variable\">$index</span> 0 &#125;&#125;</span><br><span class=\"line\">==========异常恢复==========</span><br><span class=\"line\">告警类型: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.alertname &#125;&#125;</span><br><span class=\"line\">告警级别: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.severity &#125;&#125;</span><br><span class=\"line\">告警详情: &#123;&#123; <span class=\"variable\">$alert</span>.Annotations.message &#125;&#125;&#123;&#123; <span class=\"variable\">$alert</span>.Annotations.description&#125;&#125;;&#123;&#123;<span class=\"variable\">$alert</span>.Annotations.summary&#125;&#125;</span><br><span class=\"line\">故障时间: &#123;&#123; (<span class=\"variable\">$alert</span>.StartsAt.Add 28800e9).Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">恢复时间: &#123;&#123; (<span class=\"variable\">$alert</span>.EndsAt.Add 28800e9).Format <span class=\"string\">\"2006-01-02 15:04:05\"</span> &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.instance) 0 &#125;&#125;</span><br><span class=\"line\">实例信息: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.instance &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.namespace) 0 &#125;&#125;</span><br><span class=\"line\">命名空间: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.namespace &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.node) 0 &#125;&#125;</span><br><span class=\"line\">节点信息: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.node &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- <span class=\"keyword\">if</span> gt (len <span class=\"variable\">$alert</span>.Labels.pod) 0 &#125;&#125;</span><br><span class=\"line\">实例名称: &#123;&#123; <span class=\"variable\">$alert</span>.Labels.pod &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">============END============</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x03-实现Prometheus安全认证配置\"><a href=\"#0x03-实现Prometheus安全认证配置\" class=\"headerlink\" title=\"0x03 实现Prometheus安全认证配置\"></a>0x03 实现Prometheus安全认证配置</h2><p>描述: 由于 <code>export</code> 并没有提供任何认证支持，所需要借助 Nginx 作为反向代理服务器，添加 <code>HTTP Basic Auth</code> 功能，此时只有授权的用户才能采集监控指标, 可以极大避免未授权访问的情况出现。</p>\n<p><strong>操作流程</strong></p>\n<ul>\n<li>1.我们采用Nginx镜像作为演示搭建与.htpasswd配置生成。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 镜像拉取与镜像运行</span></span><br><span class=\"line\">docker pull nginx:1.21.0</span><br><span class=\"line\">docker run --name auth -d nginx:1.21.0</span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it auth bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 `apache2-utils` 提供的 `htpasswd` 工具创建一个用户文件,该镜像中没自带所以我们下载即可</span></span><br><span class=\"line\">apt install apache2-utils</span><br><span class=\"line\"><span class=\"comment\"># 运行 htpasswd 生成一个或多个认证用户</span></span><br><span class=\"line\">htpasswd -bc htpasswd.auth weiyigeek password</span><br><span class=\"line\">Adding password <span class=\"keyword\">for</span> user weiyigeek</span><br><span class=\"line\">htpasswd -b htpasswd.auth prometheus password</span><br><span class=\"line\">Adding password <span class=\"keyword\">for</span> user prometheus</span><br><span class=\"line\">htpasswd -b htpasswd.auth monitor password</span><br><span class=\"line\">Adding password <span class=\"keyword\">for</span> user monitor</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<ul>\n<li>2.准备映射到nginx容器中相关文件</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拷贝容器中nginx配置</span></span><br><span class=\"line\">docker cp auth:/etc/nginx /monitor/nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 拷贝生成htpasswd.auth 到宿主机</span></span><br><span class=\"line\">docker cp auth:/tmp/htpasswd.auth /monitor/nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Nginx 配置文件</span></span><br><span class=\"line\">root@prometheus:/monitor/nginx/conf<span class=\"comment\"># cat conf.d/default.conf</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen       8080;</span><br><span class=\"line\">  listen  [::]:8080;</span><br><span class=\"line\">  server_name  monitor.weiyigeek.top;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class=\"line\">  add_header X-Frame-Options SAMEORIGIN;</span><br><span class=\"line\">  auth_basic <span class=\"string\">\"weiyigeek Prometheus Metrics\"</span>;</span><br><span class=\"line\">  auth_basic_user_file /etc/nginx/auth/htpasswd.auth;</span><br><span class=\"line\">  <span class=\"comment\">#这里放的是认证文件位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">  location / &#123;</span><br><span class=\"line\">    proxy_pass http://monitor.weiyigeek.top:9090;</span><br><span class=\"line\">    proxy_redirect          off;</span><br><span class=\"line\">    proxy_set_header        X-Real-IP       <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    proxy_set_header        X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">    proxy_set_header        Host            <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504 http_404;</span><br><span class=\"line\">    access_log  /var/<span class=\"built_in\">log</span>/nginx/prometheus_access.log;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<ul>\n<li>3.启动nginx反代容器的参数及状态查看<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 容器启动</span></span><br><span class=\"line\">docker run -d --name=prometheus_proxy -p 8080:8080 -v /monitor/nginx/conf:/etc/nginx -v /monitor/nginx/logs:/var/<span class=\"built_in\">log</span>/nginx/ nginx:1.21.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 容器状态</span></span><br><span class=\"line\">docker ps</span><br><span class=\"line\">  &lt;!-- CONTAINER ID   IMAGE                   COMMAND                  CREATED         STATUS         PORTS                                               NAMES</span><br><span class=\"line\">  6347a6498e69   nginx:1.21.0            <span class=\"string\">\"/docker-entrypoint.…\"</span>   6 minutes ago   Up 6 minutes   80/tcp, 0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   prometheus_proxy --&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<ul>\n<li>4.系统防火墙策略设置(安装最小访问权限设置)<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动防火墙 &amp; 查看状态</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> ufw &amp;&amp; systemctl restart ufw</span><br><span class=\"line\">ufw status &amp;&amp; systemctl status ufw</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 允许所有的机器访问 80(Grafana),8080(Nginx Proxy Prometheus Server)</span></span><br><span class=\"line\">sudo ufw allow proto tcp to port 80,8080</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以通过ip addr查看网卡的网段以便后续docker或者本地访问。</span></span><br><span class=\"line\">ip addr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只允许从本地和docker0网卡访问 9090,9093,9094,9115 端口</span></span><br><span class=\"line\">sudo ufw allow proto tcp from 127.0.0.1 to any port 9090,9093,9094,9115</span><br><span class=\"line\">ufw delete allow proto tcp from 172.17.0.1/16 to any port 9090,9093,9094,9115</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h2 id=\"0x04-辅助工具\"><a href=\"#0x04-辅助工具\" class=\"headerlink\" title=\"0x04 辅助工具\"></a>0x04 辅助工具</h2><h3 id=\"promtool-命令-Prometheus-附带的一个实用工具。\"><a href=\"#promtool-命令-Prometheus-附带的一个实用工具。\" class=\"headerlink\" title=\"promtool 命令 - Prometheus 附带的一个实用工具。\"></a>promtool 命令 - Prometheus 附带的一个实用工具。</h3><p>描述: 普罗米修斯监控系统的工具,包含在Prometheus安装包之中。我们可以使用<code>amtool check-config</code>来检查alertmanager.yml文件以及警报查询和Silences。</p>\n<p><strong>语法参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">usage: promtool [&lt;flags&gt;] &lt;<span class=\"built_in\">command</span>&gt; [&lt;args&gt; ...]</span><br><span class=\"line\"></span><br><span class=\"line\">Flags:</span><br><span class=\"line\">-h, --<span class=\"built_in\">help</span>     Show context-sensitive <span class=\"built_in\">help</span> (also try --<span class=\"built_in\">help</span>-long and --<span class=\"built_in\">help</span>-man).</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  <span class=\"built_in\">help</span> [&lt;<span class=\"built_in\">command</span>&gt;...] Show <span class=\"built_in\">help</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">  check config &lt;config-files&gt;... <span class=\"comment\"># Check if the config files are valid or not.</span></span><br><span class=\"line\">  check web-config &lt;web-config-files&gt;... <span class=\"comment\"># Check if the web config files are valid or not.</span></span><br><span class=\"line\">  check rules &lt;rule-files&gt;... <span class=\"comment\"># Check if the rule files are valid or not.</span></span><br><span class=\"line\">  check metrics <span class=\"comment\"># Pass Prometheus metrics over stdin to lint them for consistency and correctness.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  query instant [&lt;flags&gt;] &lt;server&gt; &lt;expr&gt;  <span class=\"comment\"># Run instant query.</span></span><br><span class=\"line\">  query range [&lt;flags&gt;] &lt;server&gt; &lt;expr&gt; <span class=\"comment\"># Run range query.</span></span><br><span class=\"line\">  query series --match=MATCH [&lt;flags&gt;] &lt;server&gt; <span class=\"comment\">#  Run series query.</span></span><br><span class=\"line\">  query labels [&lt;flags&gt;] &lt;server&gt; &lt;name&gt; <span class=\"comment\"># Run labels query.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  debug pprof &lt;server&gt; <span class=\"comment\"># Fetch profiling debug information.</span></span><br><span class=\"line\">  debug metrics &lt;server&gt; <span class=\"comment\"># Fetch metrics debug information.</span></span><br><span class=\"line\">  debug all &lt;server&gt; <span class=\"comment\"># Fetch all debug information.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">test</span> rules &lt;<span class=\"built_in\">test</span>-rule-file&gt;... <span class=\"comment\"># Unit tests for rules.</span></span><br><span class=\"line\"></span><br><span class=\"line\">  tsdb bench write [&lt;flags&gt;] [&lt;file&gt;] <span class=\"comment\"># Run a write performance benchmark.</span></span><br><span class=\"line\">  tsdb analyze [&lt;flags&gt;] [&lt;db path&gt;] [&lt;block id&gt;] <span class=\"comment\">#  Analyze churn, label pair cardinality.</span></span><br><span class=\"line\">  tsdb list [&lt;flags&gt;] [&lt;db path&gt;] <span class=\"comment\">#  List tsdb blocks.</span></span><br><span class=\"line\">  tsdb dump [&lt;flags&gt;] [&lt;db path&gt;] <span class=\"comment\"># Dump samples from a TSDB.</span></span><br><span class=\"line\">  tsdb create-blocks-from openmetrics &lt;input file&gt; [&lt;output directory&gt;] <span class=\"comment\">#  Import samples from OpenMetrics input and produce TSDB blocks. Please refer to the storage docs for more details.</span></span><br><span class=\"line\">  tsdb create-blocks-from rules --start=START [&lt;flags&gt;] &lt;rule-files&gt;... <span class=\"comment\"># Create blocks of data for new recording rules.</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>基础示例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 1.验证指标输出是否有效并执行格式检查。</span></span><br><span class=\"line\">$ cat metrics.prom | promtool check metrics</span><br><span class=\"line\">$ curl -s http://localhost:9090/metrics | promtool check metrics</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"monitor","path":"api/categories/monitor.json"},{"name":"kubernetes","path":"api/categories/kubernetes.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"Prometheus","path":"api/tags/Prometheus.json"}]}