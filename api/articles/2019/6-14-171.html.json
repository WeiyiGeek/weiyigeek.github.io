{"title":"brctl快速入门与基础","slug":"系统运维/Linux/常用命令/网络查看类命令/brctl快速入门与基础","date":"2019-06-14T11:35:30.000Z","updated":"2020-10-10T02:37:45.395Z","url":"2019/6-14-171.html","path":"api/articles/2019/6-14-171.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-快速入门\"><a href=\"#0x00-快速入门\" class=\"headerlink\" title=\"0x00 快速入门\"></a>0x00 快速入门</h4><p>命令brctl主要运用于 Linux 网桥配置,Linux网关模式下将有线LAN和无线LAN共享网段实现局域网内互联；</p>\n<p><em>什么是网桥?</em><br>答：网桥是一种在链路层实现中继，对帧进行转发的技术，根据MAC分区块，可隔离碰撞，将网络的多个网段在数据链路层连接起来的网络设备（类似于VLAN）。</p>\n<p><em>思路其实很简单：</em><br>就是将虚拟出一个bridge口，将对应的有线LAN和无线LAN都绑定在这个虚拟bridge口上，并给这个bridge口分配一个地址，其他子网微机配置网关为bridge口的地址便可以了。当，因为是设备是网关模式，路由和nat也是必须的了。如果设备本身便是网桥模式那么路由和nat便可以省掉了</p>\n<p>安装网桥管理工具包：bridge-utile<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install bridge-utils -y</span><br><span class=\"line\">apt-get install bridge-utils</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入到内核（手动）</span></span><br><span class=\"line\">modprobe bridge</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"1\"</span>&gt;/proc/sys/net/ipv4/ip_forward  <span class=\"comment\">#设置转发支持（iptables NAT转发也需要此）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置桥开机激活 </span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"modprobe bridge\"</span>&gt;&gt;/etc/rc.local @<span class=\"comment\">#开机加载 bridge 模块，或者echo \"bridge\"&gt;&gt;/etc/modules</span></span><br><span class=\"line\">cp /etc/network/interfaces /etc/network/interfaces.default <span class=\"comment\">#</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#或者编译安装bridge-utils</span></span><br><span class=\"line\">（1）进入到/usr/src 目录下，下载bridge-utils-1.4.tar.gz ：</span><br><span class=\"line\"><span class=\"comment\">#cd /usr/src</span></span><br><span class=\"line\"><span class=\"comment\">#wget http://launchpad.net/bridgeutils/main/1.4/+download/bridge-utils-1.4.tar.gz</span></span><br><span class=\"line\"></span><br><span class=\"line\">（2）解压缩：</span><br><span class=\"line\"><span class=\"comment\">#tar zxvf bridge-utils-1.4.tar.gz</span></span><br><span class=\"line\">进入bridge-utils-1.4目录：</span><br><span class=\"line\"><span class=\"comment\">#cd bridge-utils-1.4</span></span><br><span class=\"line\"></span><br><span class=\"line\">（3）编译安装：</span><br><span class=\"line\"><span class=\"comment\">#autoconf</span></span><br><span class=\"line\">生成configure文件：</span><br><span class=\"line\"><span class=\"comment\">#./configure</span></span><br><span class=\"line\"><span class=\"comment\">#make</span></span><br><span class=\"line\"><span class=\"comment\">#make install</span></span><br><span class=\"line\">编译安装完成。最后将命令brctl复制到/sbin下：</span><br><span class=\"line\"><span class=\"comment\">#cp/usr/local/sbin/brctl/sbin</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"0x01-brctl-命令\"><a href=\"#0x01-brctl-命令\" class=\"headerlink\" title=\"0x01 brctl 命令\"></a>0x01 brctl 命令</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Usage: brctl [commands]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#参数</span></span><br><span class=\"line\">addbr [name] <span class=\"comment\">#添加网桥</span></span><br><span class=\"line\">delbr [name] <span class=\"comment\">#删除网桥</span></span><br><span class=\"line\">addif [name] [interface] <span class=\"comment\">#将接口添加进入网桥</span></span><br><span class=\"line\">show [name]  <span class=\"comment\">#网桥信息查看</span></span><br><span class=\"line\"></span><br><span class=\"line\">        addbr           &lt;bridge&gt;                add bridge</span><br><span class=\"line\">        delbr           &lt;bridge&gt;                delete bridge</span><br><span class=\"line\">        addif           &lt;bridge&gt; &lt;device&gt;       add interface to bridge</span><br><span class=\"line\">        delif           &lt;bridge&gt; &lt;device&gt;       delete interface from bridge</span><br><span class=\"line\">        setageing       &lt;bridge&gt; &lt;time&gt;          <span class=\"comment\">#设置老化时间，即生存周期</span></span><br><span class=\"line\">        setbridgeprio   &lt;bridge&gt; &lt;prio&gt;         <span class=\"comment\">#设置bridge的优先级</span></span><br><span class=\"line\">        setfd           &lt;bridge&gt; &lt;time&gt;         <span class=\"comment\">#设置bridge转发延迟时间</span></span><br><span class=\"line\">        sethello        &lt;bridge&gt; &lt;time&gt;         <span class=\"built_in\">set</span> hello time</span><br><span class=\"line\">        setmaxage       &lt;bridge&gt; &lt;time&gt;         <span class=\"comment\"># #设置消息的最大生命周期</span></span><br><span class=\"line\">        sethashel       &lt;bridge&gt; &lt;int&gt;          <span class=\"built_in\">set</span> <span class=\"built_in\">hash</span> elasticity</span><br><span class=\"line\">        sethashmax      &lt;bridge&gt; &lt;int&gt;          <span class=\"built_in\">set</span> <span class=\"built_in\">hash</span> max</span><br><span class=\"line\">        setmclmc        &lt;bridge&gt; &lt;int&gt;          <span class=\"built_in\">set</span> multicast last member count</span><br><span class=\"line\">        setmcrouter     &lt;bridge&gt; &lt;int&gt;          <span class=\"built_in\">set</span> multicast router</span><br><span class=\"line\">        setmcsnoop      &lt;bridge&gt; &lt;int&gt;          <span class=\"built_in\">set</span> multicast snooping</span><br><span class=\"line\">        setmcsqc        &lt;bridge&gt; &lt;int&gt;          <span class=\"built_in\">set</span> multicast startup query count</span><br><span class=\"line\">        setmclmi        &lt;bridge&gt; &lt;time&gt;         <span class=\"built_in\">set</span> multicast last member interval</span><br><span class=\"line\">        setmcmi         &lt;bridge&gt; &lt;time&gt;         <span class=\"built_in\">set</span> multicast membership interval</span><br><span class=\"line\">        setmcqpi        &lt;bridge&gt; &lt;time&gt;         <span class=\"built_in\">set</span> multicast querier interval</span><br><span class=\"line\">        setmcqi         &lt;bridge&gt; &lt;time&gt;         <span class=\"built_in\">set</span> multicast query interval</span><br><span class=\"line\">        setmcqri        &lt;bridge&gt; &lt;time&gt;         <span class=\"built_in\">set</span> multicast query response interval</span><br><span class=\"line\">        setmcqri        &lt;bridge&gt; &lt;time&gt;         <span class=\"built_in\">set</span> multicast startup query interval</span><br><span class=\"line\">        setpathcost     &lt;bridge&gt; &lt;port&gt; &lt;cost&gt;  <span class=\"built_in\">set</span> path cost</span><br><span class=\"line\">        setportprio     &lt;bridge&gt; &lt;port&gt; &lt;prio&gt;  <span class=\"built_in\">set</span> port priority</span><br><span class=\"line\">        setportmcrouter &lt;bridge&gt; &lt;port&gt; &lt;int&gt;   <span class=\"built_in\">set</span> port multicast router</span><br><span class=\"line\">        show            [ &lt;bridge&gt; ]            <span class=\"comment\">#显示网新信息</span></span><br><span class=\"line\">        showmacs        &lt;bridge&gt;                <span class=\"comment\">##显示MAC地址</span></span><br><span class=\"line\">        showstp         &lt;bridge&gt;                show bridge stp info</span><br><span class=\"line\">        stp             &lt;bridge&gt; &#123;on|off&#125;       turn stp on/off</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h4 id=\"0x02-实际案例\"><a href=\"#0x02-实际案例\" class=\"headerlink\" title=\"0x02 实际案例\"></a>0x02 实际案例</h4><p>示例1.添加网桥并将接口进行接入,将有线和无线都设置为10.0.0.*网段，即可通过网上邻居进行访问；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brctl addbr bridge   <span class=\"comment\">#添加了一个bridge名称的网桥</span></span><br><span class=\"line\">brctl addif bridge eth0  <span class=\"comment\">#并将接口加入到其中;</span></span><br><span class=\"line\">brctl addif bridge ath0 <span class=\"comment\">#无线接口</span></span><br><span class=\"line\"></span><br><span class=\"line\">ifconfig eth0  0.0.0.0 <span class=\"comment\">#</span></span><br><span class=\"line\">ifconfig bridge 10.0.0.1 netmask 255.255.255.0 up <span class=\"comment\">#设置哇</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加防火墙规则</span></span><br><span class=\"line\">iptables -t nat -A POSTROUTING -o eth1 -j SNAT --to 192.168.2.173</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>示例2.有五台主机。其中一台主机装有linux 安装了网桥模块，而且有四块物理网卡，分别连接同一网段的其他主机，我们希望其成为一个网桥（192.168.1.1.），为其他四台主机(IP分别为192.168.1.2 ，192.168.1.3，192.168.1.4，192.168.1.5) 之间转发数据包</p>\n<ul>\n<li>同时为了方便管理，使用网桥能一个IP就可以在192.168.1.0/24网段内的主机上telnet到网桥，及连接不同网段的主机;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 实际上，我们可以把逻辑网段192.168.1.0/24看作使一个VLAN ，而br0则是这个VLAN的名称。</span></span><br><span class=\"line\">brctl addbr br0        <span class=\"comment\"># (建立一个逻辑网段，名称为br0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在Linux中，一个端口实际上就是一个物理网卡，假如网桥的每个物理网卡的名称则分别为eth0，eth1，eth2，eth3</span></span><br><span class=\"line\">brctl addif br0 eth0               (让eth0成为br0的一个端口)</span><br><span class=\"line\">brctl addif br0 eth1               (让eth1成为br0的一个端口)</span><br><span class=\"line\">brctl addif br0 eth0               (让eth2成为br0的一个端口)</span><br><span class=\"line\">brctl addif br0 eth3               (让eth3成为br0的一个端口)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#网桥的每个物理网卡作为一个端口，运行于混杂模式，而且是在链路层工作，所以就不需要IP了。</span></span><br><span class=\"line\">ifconfig eth0 0.0.0.0</span><br><span class=\"line\">ifconfig eth1 0.0.0.0</span><br><span class=\"line\">ifconfig eth2 0.0.0.0</span><br><span class=\"line\">ifconfig eth3 0.0.0.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#然后给br0的虚拟网卡配置IP：192.168.1.1。那样就能远程管理网桥。</span></span><br><span class=\"line\">ifconfig br0 192.168.1.1</span><br><span class=\"line\"><span class=\"comment\">#给br0配置了IP之后，网桥就能够工作了。192.168.1.0/24网段内的主机都可以telnet到网桥上对其进行配置。</span></span><br><span class=\"line\"><span class=\"comment\">#以上配置的是一个逻辑网段，实际上Linux网桥也能配置成多个逻辑网段(相当于交换机中划分多个VLAN)。</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p>示例3.设置Linux让网桥运行配置网桥;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brctl addbr br0</span><br><span class=\"line\">brctl stp br0 off <span class=\"comment\">#不需要STP(生成树协议)等。因为我们只有一个路由器，是绝对不可能形成一个环的，则关闭它</span></span><br><span class=\"line\"><span class=\"comment\">#关闭生成树协议，减少数据包污染，因为我这里只有一个路由器哦！</span></span><br><span class=\"line\"></span><br><span class=\"line\">brctl addif br0 eth0 eth1 <span class=\"comment\">#添加两个（或更多）以太网物理接口</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#原来我们的两个以太网物理接口变成了网桥上的两个逻辑端口。那两个物理接口过去存在，未来也不会消失</span></span><br><span class=\"line\"><span class=\"comment\">#现在他们成了逻辑网桥设备的一部分了，所以不再需要IP地址。下面我们将这些IP地址释放掉</span></span><br><span class=\"line\"><span class=\"variable\">$ifconfig</span> eth0 down</span><br><span class=\"line\"><span class=\"variable\">$ifconfig</span> eth1 down</span><br><span class=\"line\"><span class=\"variable\">$ifconfig</span> eth0 0.0.0.0 up</span><br><span class=\"line\"><span class=\"variable\">$ifconfig</span> eth1 0.0.0.0 up</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#最后，启用网桥并配置其地址</span></span><br><span class=\"line\"><span class=\"variable\">$ifconfig</span> br0 10.0.3.129 up</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#如果需要关闭和删除网桥</span></span><br><span class=\"line\">brctl delif br0 eth1 eth0;</span><br><span class=\"line\">ifconfig br0 down;</span><br><span class=\"line\">brctl delbr br0;</span><br></pre></td></tr></table></figure></p>\n<p>示例4.配置eth0 eth1 br0开机启动，eth0、eth1未设置IP信息，在启动br0网卡时，开启了eth0，eth1的混杂模式，并桥接了它们。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[inbi@debian~]<span class=\"variable\">$vim</span> /etc/network/interfaces</span><br><span class=\"line\">auto lo eth0 eth1 br0  <span class=\"comment\">#将接口加入</span></span><br><span class=\"line\">iface lo inet loopback <span class=\"comment\">#设置本地地址为回路</span></span><br><span class=\"line\">iface br0 inet static</span><br><span class=\"line\">    address 10.10.10.1</span><br><span class=\"line\">    netmask 255.255.0.0</span><br><span class=\"line\">    gateway 10.10.10.254</span><br><span class=\"line\">    pre-up ip link <span class=\"built_in\">set</span> eth0 promisc on</span><br><span class=\"line\">    pre-up ip link <span class=\"built_in\">set</span> eth1 promisc ono</span><br><span class=\"line\">    pre-up <span class=\"built_in\">echo</span> <span class=\"string\">\"1\"</span>&gt;/proc/sys/net/ipv4/ip_forward</span><br><span class=\"line\">    bridge_ports eth0 eth1</span><br></pre></td></tr></table></figure>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Linux命令","path":"api/categories/Linux命令.json"}],"tags":[{"name":"网络命令","path":"api/tags/网络命令.json"}]}