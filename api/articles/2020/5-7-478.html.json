{"title":"1.Podman容器管理工具基础学习","slug":"虚拟云容/云容器/Podman/1.Podman容器管理工具基础学习","date":"2020-05-07T06:36:30.000Z","updated":"2022-03-29T05:39:03.651Z","url":"2020/5-7-478.html","path":"api/articles/2020/5-7-478.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200923203752.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200923212550.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-基础介绍\"><a href=\"#0x00-基础介绍\" class=\"headerlink\" title=\"0x00 基础介绍\"></a>0x00 基础介绍</h4><p><strong>Q:什么是Podman?</strong><br>官网描述: Podman是一个无守护进程的容器引擎,用于在Linux系统上开发、管理和运行OCI容器(<code>开源的容器管理工具</code>)。容器可以作为根运行，也可以以无根模式运行。简单地说:<code>alias docker=podman</code>简单的说它是下一代容器。</p>\n<p>官网 : <a href=\"https://podman.io/\" target=\"_blank\" rel=\"noopener\">https://podman.io/</a><br>Github 项目: <a href=\"https://github.com/containers/podman\" target=\"_blank\" rel=\"noopener\">https://github.com/containers/podman</a></p>\n<h5 id=\"前生今世\"><a href=\"#前生今世\" class=\"headerlink\" title=\"前生今世\"></a>前生今世</h5><blockquote>\n<p>介绍:Podman 原是 <a href=\"https://github.com/kubernetes-incubator/cri-o\" target=\"_blank\" rel=\"noopener\">CRI-O</a> 项目的一部分后来被分离成一个单独的项目叫 <a href=\"https://github.com/containers/libpod\" target=\"_blank\" rel=\"noopener\">libpod</a>, Podman 的使用体验和 Docker 类似不同的是 Podman 没有 daemon。</p>\n<ul>\n<li>以前使用 Docker CLI 的时候它会通过 gRPC API 去跟 Docker Engine 说「我要启动一个容器」，然后 Docker Engine 才会通过 <code>OCI Container runtime</code>（默认是 runc）来启动一个容器;意味着容器的进程不可能是 Docker CLI 的子进程而是 Docker Engine 的子进程。</li>\n<li>Podman 比较简单粗暴它不使用 Daemon，而是直接通过 OCI runtime（默认也是 runc）来启动容器所以容器的进程是 podman 的子进程(<code>相当于是省去了中间商,减少了赚差价 (●ˇ∀ˇ●)</code>),比较像 Linux 的 fork/exec 模型;</li>\n</ul>\n</blockquote>\n<p>fork/exec 模型优势:</p>\n<ul>\n<li>1.某个容器进程父进程是谁(即到底是谁启动的一目了然)</li>\n<li>2.利用 cgroup 对 podman 限制则利用podman创建的容器都会被限制;</li>\n<li>3.可将 podman命令放入systemd单元文件中容器进程可通过podman返回通知(SD_NOTIFY)表明服务已准备好接收任务</li>\n</ul>\n<p><strong>Q:Podman有何作用?</strong></p>\n<blockquote>\n<p> 描述:podman是作为libpod库的一部分而提供的工具,它可以用来创建和维护容器类似于Docker但又不等同于它;</p>\n</blockquote>\n<p>Podman有何特点:</p>\n<ul>\n<li>1.没有 Daemon (守护进程) 直接通过 OCI runtime（默认也是runc）来启动容器，所以容器的进程是 podman 的子进程;</li>\n<li>2.采用类似于Linux中<code>&quot;fork/exec模型&quot;</code>相比较于”C/S模型”有一定的优势。</li>\n<li>3.能够以非 root 用户的身份去运行容器</li>\n<li>4.引入注册表的概念其内部包括docker.io在内的多个容器镜像源,默认的有<code>redhat docker fedora centos quay</code></li>\n</ul>\n<p><br></p>\n<p><strong>Podman VS Docker</strong></p>\n<ul>\n<li>(1) 模型对比<ul>\n<li>Podman: fork/exec 模型</li>\n<li>Docker: C/S 模型</li>\n</ul>\n</li>\n<li>(2) 启动模式：<ul>\n<li>前者直接OCI containner runtime(runc)进行交互来创建container的</li>\n<li>后者通过API跟 Docker Engine(引擎)请求才会调用OCI container runtime(runc)来启动一个container</li>\n</ul>\n</li>\n<li>(3) 守护进程<ul>\n<li>前者容器不支持–restart策略但是可以通过编写systemd服务来完成自启动</li>\n<li>后者因有docker daemon，所以docker启动的容器支持–restart策略</li>\n</ul>\n</li>\n<li>(4) 权限对比<ul>\n<li>前者可以非root用户创建容器</li>\n<li>后者必须使用root用户来创建容器</li>\n</ul>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>Q: Podman 如何使用?</strong></p>\n<blockquote>\n<p>答: Podman 官网的 <a href=\"https://podman.io/getting-started/\" target=\"_blank\" rel=\"noopener\">getting-started</a> 文档永远是你最好的选择;</p>\n</blockquote>\n<hr>\n<h4 id=\"0x01-安装试用\"><a href=\"#0x01-安装试用\" class=\"headerlink\" title=\"0x01 安装试用\"></a>0x01 安装试用</h4><p>描述:考虑到本文所写时间可能于读者查看时间有一定的间隔，所此处安装参考官网 <a href=\"https://podman.io/getting-started/installation\" target=\"_blank\" rel=\"noopener\">installation</a>,首先祭出我们Ubuntu作为一个Linux爱好者必备;</p>\n<h5 id=\"Ubuntu\"><a href=\"#Ubuntu\" class=\"headerlink\" title=\"Ubuntu\"></a>Ubuntu</h5><p>描述:Kubic项目提供了Ubuntu 18.04、19.04、19.10和20.04的软件包, 在Ubuntu上已经有许多带有libpod前缀的包可用<br>安装环境: Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-46-generic x86_64)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /etc/os-release</span><br><span class=\"line\">NAME=<span class=\"string\">\"Ubuntu\"</span></span><br><span class=\"line\">VERSION=<span class=\"string\">\"20.04.1 LTS (Focal Fossa)\"</span></span><br><span class=\"line\">ID=ubuntu</span><br><span class=\"line\">ID_LIKE=debian</span><br><span class=\"line\">PRETTY_NAME=<span class=\"string\">\"Ubuntu 20.04.1 LTS\"</span></span><br><span class=\"line\">VERSION_ID=<span class=\"string\">\"20.04\"</span></span><br></pre></td></tr></table></figure></p>\n<p><em>Ubuntu 下 Podman 安装:</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - Stable Install:</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/ /\"</span> | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list</span><br><span class=\"line\">curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/Release.key | sudo apt-key add -</span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get -y upgrade </span><br><span class=\"line\">sudo apt-get -y install podman</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - Development Install</span></span><br><span class=\"line\"><span class=\"comment\"># Kubic项目为Ubuntu 18.04、19.04、19.10和20.04提供RC/测试包。</span></span><br><span class=\"line\">. /etc/os-release</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/testing/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/ /\"</span> | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:testing.list</span><br><span class=\"line\">curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/testing/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/Release.key | sudo apt-key add -</span><br><span class=\"line\">sudo apt-get update -qq</span><br><span class=\"line\">sudo apt-get -qq -y install podman</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - Building from scratch</span></span><br><span class=\"line\"><span class=\"comment\"># 构建和运行依赖项运行 make packege-install，它将安装依赖项、构建源代码、为当前平台生成rpm并最终安装它们。</span></span><br><span class=\"line\">sudo apt-get install \\</span><br><span class=\"line\">  btrfs-tools \\</span><br><span class=\"line\">  git \\</span><br><span class=\"line\">  golang-go \\</span><br><span class=\"line\">  go-md2man \\</span><br><span class=\"line\">  iptables \\</span><br><span class=\"line\">  libassuan-dev \\</span><br><span class=\"line\">  libbtrfs-dev \\</span><br><span class=\"line\">  libc6-dev \\</span><br><span class=\"line\">  libdevmapper-dev \\</span><br><span class=\"line\">  libglib2.0-dev \\</span><br><span class=\"line\">  libgpgme-dev \\</span><br><span class=\"line\">  libgpg-error-dev \\</span><br><span class=\"line\">  libprotobuf-dev \\</span><br><span class=\"line\">  libprotobuf-c0-dev \\</span><br><span class=\"line\">  libseccomp-dev \\</span><br><span class=\"line\">  libselinux1-dev \\</span><br><span class=\"line\">  libsystemd-dev \\</span><br><span class=\"line\">  pkg-config \\</span><br><span class=\"line\">  runc \\</span><br><span class=\"line\">  uidmap</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"Podman-命令-容器管理工具\"><a href=\"#Podman-命令-容器管理工具\" class=\"headerlink\" title=\"Podman 命令 - 容器管理工具\"></a>Podman 命令 - 容器管理工具</h5><p>描述:了解Podman是如何工作的你可以使用这个帮助以及验证podman安装情况:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman &lt;subcommand&gt; --<span class=\"built_in\">help</span></span><br><span class=\"line\">$ man podman-&lt;subcommand&gt;</span><br><span class=\"line\">$ podman --version</span><br><span class=\"line\">podman version 2.0.6</span><br></pre></td></tr></table></figure></p>\n<p><strong>Podman 运行信息:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> podman info</span><br><span class=\"line\">host:</span><br><span class=\"line\">  arch: amd64</span><br><span class=\"line\">  buildahVersion: 1.15.1</span><br><span class=\"line\">  cgroupVersion: v1</span><br><span class=\"line\">  conmon:</span><br><span class=\"line\">    package: <span class=\"string\">'conmon: /usr/libexec/podman/conmon'</span></span><br><span class=\"line\">    path: /usr/libexec/podman/conmon</span><br><span class=\"line\">    version: <span class=\"string\">'conmon version 2.0.20, commit: '</span></span><br><span class=\"line\">  cpus: 2</span><br><span class=\"line\">  distribution:</span><br><span class=\"line\">    distribution: ubuntu</span><br><span class=\"line\">    version: <span class=\"string\">\"20.04\"</span></span><br><span class=\"line\">  eventLogger: file</span><br><span class=\"line\">  hostname: ubuntu</span><br><span class=\"line\">  idMappings:</span><br><span class=\"line\">    gidmap: null</span><br><span class=\"line\">    uidmap: null</span><br><span class=\"line\">  kernel: 5.4.0-46-generic</span><br><span class=\"line\">  linkmode: dynamic</span><br><span class=\"line\">  memFree: 756535296</span><br><span class=\"line\">  memTotal: 4127399936</span><br><span class=\"line\">  ociRuntime:</span><br><span class=\"line\">    name: runc</span><br><span class=\"line\">    package: <span class=\"string\">'containerd.io: /usr/bin/runc'</span></span><br><span class=\"line\">    path: /usr/bin/runc</span><br><span class=\"line\">    version: |-</span><br><span class=\"line\">      runc version 1.0.0-rc10</span><br><span class=\"line\">      commit: dc9208a3303feef5b3839f4323d9beb36df0a9dd</span><br><span class=\"line\">      spec: 1.0.1-dev</span><br><span class=\"line\">  os: linux</span><br><span class=\"line\">  remoteSocket:</span><br><span class=\"line\">    exists: <span class=\"literal\">true</span></span><br><span class=\"line\">    path: /run/podman/podman.sock</span><br><span class=\"line\">  rootless: <span class=\"literal\">false</span></span><br><span class=\"line\">  slirp4netns:</span><br><span class=\"line\">    executable: <span class=\"string\">\"\"</span></span><br><span class=\"line\">    package: <span class=\"string\">\"\"</span></span><br><span class=\"line\">    version: <span class=\"string\">\"\"</span></span><br><span class=\"line\">  swapFree: 0</span><br><span class=\"line\">  swapTotal: 0</span><br><span class=\"line\">  uptime: 452h 40m 5.75s (Approximately 18.83 days)</span><br><span class=\"line\">registries:</span><br><span class=\"line\">  docker.io:</span><br><span class=\"line\">    Blocked: <span class=\"literal\">false</span></span><br><span class=\"line\">    Insecure: <span class=\"literal\">false</span></span><br><span class=\"line\">    Location: docker.io</span><br><span class=\"line\">    MirrorByDigestOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    Mirrors:</span><br><span class=\"line\">    - Insecure: <span class=\"literal\">true</span></span><br><span class=\"line\">      Location: xlx9erfu.mirror.aliyuncs.com</span><br><span class=\"line\">    Prefix: docker.io</span><br><span class=\"line\">  search:</span><br><span class=\"line\">  - docker.io</span><br><span class=\"line\">store:</span><br><span class=\"line\">  configFile: /etc/containers/storage.conf</span><br><span class=\"line\">  containerStore:</span><br><span class=\"line\">    number: 0</span><br><span class=\"line\">    paused: 0</span><br><span class=\"line\">    running: 0</span><br><span class=\"line\">    stopped: 0</span><br><span class=\"line\">  graphDriverName: overlay</span><br><span class=\"line\">  graphOptions: &#123;&#125;</span><br><span class=\"line\">  graphRoot: /var/lib/containers/storage</span><br><span class=\"line\">  graphStatus:</span><br><span class=\"line\">    Backing Filesystem: extfs</span><br><span class=\"line\">    Native Overlay Diff: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    Supports d_type: <span class=\"string\">\"true\"</span></span><br><span class=\"line\">    Using metacopy: <span class=\"string\">\"false\"</span></span><br><span class=\"line\">  imageStore:</span><br><span class=\"line\">    number: 1</span><br><span class=\"line\">  runRoot: /var/run/containers/storage</span><br><span class=\"line\">  volumePath: /var/lib/containers/storage/volumes</span><br><span class=\"line\">version:</span><br><span class=\"line\">  APIVersion: 1</span><br><span class=\"line\">  Built: 0</span><br><span class=\"line\">  BuiltTime: Thu Jan  1 00:00:00 1970</span><br><span class=\"line\">  GitCommit: <span class=\"string\">\"\"</span></span><br><span class=\"line\">  GoVersion: go1.14.2</span><br><span class=\"line\">  OsArch: linux/amd64</span><br><span class=\"line\">  Version: 2.0.6</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x02-小试牛刀\"><a href=\"#0x02-小试牛刀\" class=\"headerlink\" title=\"0x02 小试牛刀\"></a>0x02 小试牛刀</h4><h5 id=\"1-Podman-Hello-world\"><a href=\"#1-Podman-Hello-world\" class=\"headerlink\" title=\"1.Podman Hello-world\"></a>1.Podman Hello-world</h5><p>运行环境说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu 20.04.1 LTS (Focal Fossa)</span><br><span class=\"line\">Linux ubuntu 5.4.0-46-generic 50-Ubuntu SMP Fri Aug 28 15:33:36 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure></p>\n<p><strong>简单使用：</strong><br>描述:建议在非根用户运行并在需要根升级的地方使用sudo,下面以Hello-Worlds示例展现podman的使用;<br>使用示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.搜索，拉出和列出图像</span></span><br><span class=\"line\"><span class=\"variable\">$podman</span> search hello-world</span><br><span class=\"line\">INDEX       NAME                                                 DESCRIPTION                                       STARS   OFFICIAL   AUTOMATED</span><br><span class=\"line\">docker.io   docker.io/library/hello-world                        Hello World! (an example of minimal Dockeriz...   1297    [OK]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$podman</span> pull hello-world --<span class=\"built_in\">log</span>-level debug  <span class=\"comment\"># 此处我已经进行加速镜像配置所以是从xlx9erfu.mirror.aliyuncs.com拉取(注意看其拉取过程)</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0000] GET https://xlx9erfu.mirror.aliyuncs.com/v2/</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0000] Ping https://xlx9erfu.mirror.aliyuncs.com/v2/ status 200</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0000] GET https://xlx9erfu.mirror.aliyuncs.com/v2/library/hello-world/manifests/latest</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- Manifest List  ---</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0008] Content-Type from manifest GET is \"application/vnd.docker.distribution.manifest.list.v2+json\"</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0008] Using blob info cache at /var/lib/containers/cache/blob-info-cache-v1.boltdb</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0008] Source is a manifest list; copying (only) instance sha256:90659bf80b44ce6be8234e6ff90a1ac34acbeb826903b02cfa0da11c82cbc042 for current system</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0008] GET https://xlx9erfu.mirror.aliyuncs.com/v2/library/hello-world/manifests/sha256:90659bf80b44ce6be8234e6ff90a1ac34acbeb826903b02cfa0da11c82cbc042 </span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- Image Manifest  ---</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] Content-Type from manifest GET is \"application/vnd.docker.distribution.manifest.v2+json\" </span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] IsRunningImageAllowed for image docker:docker.io/library/hello-world:latest</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009]  Using default policy section</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009]  Requirement 0: allowed</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] Overall: allowed</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] Downloading /v2/library/hello-world/blobs/sha256:bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] GET https://xlx9erfu.mirror.aliyuncs.com/v2/library/hello-world/blobs/sha256:bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b</span></span><br><span class=\"line\">  <span class=\"comment\"># Getting image source signatures</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] Manifest has MIME type application/vnd.docker.distribution.manifest.v2+json, ordered candidate list [application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.v1+prettyjws, application/vnd.oci.image.manifest.v1+json, application/vnd.docker.distribution.manifest.v1+json]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- Layers  ---</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] Downloading /v2/library/hello-world/blobs/sha256:0e03bdcc26d7a9a57ef3b6f1bf1a210cff6239bff7c8cac72435984032851689</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0009] GET https://xlx9erfu.mirror.aliyuncs.com/v2/library/hello-world/blobs/sha256:0e03bdcc26d7a9a57ef3b6f1bf1a210cff6239bff7c8cac72435984032851689</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] Detected compression format gzip</span></span><br><span class=\"line\">  <span class=\"comment\"># Copying blob 0e03bdcc26d7 done</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] No compression detected</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 镜像ID --- </span></span><br><span class=\"line\">  <span class=\"comment\"># Copying config bf756fb1ae done</span></span><br><span class=\"line\">  <span class=\"comment\"># Writing manifest to image destination</span></span><br><span class=\"line\">  <span class=\"comment\"># Storing signatures</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] Applying tar in /var/lib/containers/storage/overlay/9c27e219663c25e0f28493790cc0b88bc973ba3b1686355f221c38a36978ac63/diff</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] setting image creation date to 2020-01-03 01:21:37.263809283 +0000 UTC</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] created new image ID \"bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b\"</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] set names of image \"bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b\" to [docker.io/library/hello-world:latest]</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] saved image metadata \"&#123;\\\"signatures-sizes\\\":&#123;\\\"sha256:90659bf80b44ce6be8234e6ff90a1ac34acbeb826903b02cfa0da11c82cbc042\\\":[]&#125;&#125;\"</span></span><br><span class=\"line\">  <span class=\"comment\"># DEBU[0010] parsed reference into \"[overlay@/var/lib/containers/storage+/var/run/containers/storage]docker.io/library/hello-world:latest\"</span></span><br><span class=\"line\">  <span class=\"comment\"># bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$podman</span> images hello-world</span><br><span class=\"line\">REPOSITORY                     TAG     IMAGE ID      CREATED       SIZE</span><br><span class=\"line\">docker.io/library/hello-world  latest  bf756fb1ae65  8 months ago  20 kB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.创建pod(与K8s中含义一致)和查看pod</span></span><br><span class=\"line\">$ podman pull mirrorgcrio/pause:3.2 &amp;&amp; podman tag docker.io/mirrorgcrio/pause:3.2 k8s.gcr.io/pause:3.2 <span class=\"comment\"># 创建pod前拉取k8s.gcr.io中pause应用组件(唯一与docker不同的地方)</span></span><br><span class=\"line\">$ podman pod create --name HelloWorld</span><br><span class=\"line\">  <span class=\"comment\"># 73c5a062cb17b5088072ec13c496c101b0b239f9aba1dcad93ba5d746cdfb12d</span></span><br><span class=\"line\">$ podman pod ls</span><br><span class=\"line\">  <span class=\"comment\"># POD ID        NAME        STATUS   CREATED         OF CONTAINERS    INFRA ID(下文ID)</span></span><br><span class=\"line\">  <span class=\"comment\"># 73c5a062cb17  HelloWorld  Created  29 seconds ago  1                15e7d3797552</span></span><br><span class=\"line\">$ podman container ls -a   <span class=\"comment\"># 当前POD运行的容器</span></span><br><span class=\"line\">  <span class=\"comment\"># CONTAINER ID  IMAGE                            COMMAND  CREATED             STATUS   PORTS   NAMES</span></span><br><span class=\"line\">  <span class=\"comment\"># 15e7d3797552  docker.io/mirrorgcrio/pause:3.2           About a minute ago  Created          73c5a062cb17-infra</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.在pod中创建并运行容器</span></span><br><span class=\"line\">$ podman run --pod HelloWorld hello-world  <span class=\"comment\"># hello-world镜像无后台程序所以无法后台运行</span></span><br><span class=\"line\">2fd059b66fb640393394e82404ed895e6a44673e7b1061ade81c1ae2e25e37fb</span><br><span class=\"line\">$ podman logs 2fd059b66  <span class=\"comment\"># 将会看见我们最熟悉的Hello-World</span></span><br><span class=\"line\">  <span class=\"comment\"># Hello from Docker!</span></span><br><span class=\"line\">  <span class=\"comment\"># This message shows that your installation appears to be working correctly.</span></span><br><span class=\"line\">  <span class=\"comment\"># ....</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.运行在pod中container查看</span></span><br><span class=\"line\">$ podman ps -ap</span><br><span class=\"line\">  <span class=\"comment\"># CONTAINER ID  IMAGE                                 COMMAND  CREATED        STATUS                    PORTS   NAMES               POD ID        PODNAME</span></span><br><span class=\"line\">  <span class=\"comment\"># 15e7d3797552  docker.io/mirrorgcrio/pause:3.2                6 minutes ago  Up 2 minutes ago                  73c5a062cb17-infra  73c5a062cb17  HelloWorld</span></span><br><span class=\"line\">  <span class=\"comment\"># 2fd059b66fb6  docker.io/library/hello-world:latest  /hello   2 minutes ago  Exited (0) 2 minutes ago          friendly_neumann    73c5a062cb17  HelloWorld  # 退出的容器</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"2-Podman-Hugo-envoy\"><a href=\"#2-Podman-Hugo-envoy\" class=\"headerlink\" title=\"2.Podman-Hugo-envoy\"></a>2.Podman-Hugo-envoy</h5><p>描述:此处以podman来进行部署Hugo生成的静态页在nginx中运行然后由Envoy进行代理转发实现负载均衡,然后再由前度代理进行内部转发路径的选择;<br>案例方案:</p>\n<ul>\n<li>1.首先会有一个前端代理在某个地方单独运行。前端代理的工作是给其他地方提供一个入口。来自外部的传入连接请求到这里，前端代理将会决定他们在内部的转发路径。</li>\n<li>2.其次博客静态页面由 nginx 提供，同时运行一个 “服务 Envoy”，它与 nginx 容器共享 network nemspace（相当于 Kubernetes 的 Sidecar）。</li>\n<li>3.所有的 Envoy 形成一个网格，然后在他们之间共享路由信息。</li>\n</ul>\n<p>Tips: Envoy 是专为大型现代 SOA（面向服务架构）架构设计的 L7 代理和通信总线,简单的说主要实现<code>高级负载均衡、前端/边缘代理支持</code>等功能;</p>\n<p>Step 1.环境准备模拟Nginx网页文件<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/HugoBlog/&#123;nginx,envoy&#125;</span><br><span class=\"line\"><span class=\"built_in\">echo</span>  <span class=\"string\">'&lt;h1&gt;WeiyiGeek Blog With Nginx&lt;/h1&gt;'</span> &gt; /opt/HugoBlog/nginx/index.html</span><br></pre></td></tr></table></figure></p>\n<p>Step 2.Envoy-services配置清单声明(重点)<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">sudo</span> <span class=\"string\">tee</span> <span class=\"string\">/opt/HugoBlog/envoy/service-envoy.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">static_resources:</span></span><br><span class=\"line\"><span class=\"attr\">  listeners:</span></span><br><span class=\"line\"><span class=\"attr\">  - address:</span></span><br><span class=\"line\"><span class=\"attr\">      socket_address:</span></span><br><span class=\"line\"><span class=\"attr\">        address:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"attr\">        port_value:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"attr\">    filter_chains:</span></span><br><span class=\"line\"><span class=\"attr\">    - filters:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">envoy.http_connection_manager</span></span><br><span class=\"line\"><span class=\"attr\">        config:</span></span><br><span class=\"line\"><span class=\"attr\">          codec_type:</span> <span class=\"string\">auto</span></span><br><span class=\"line\"><span class=\"attr\">          stat_prefix:</span> <span class=\"string\">ingress_http</span></span><br><span class=\"line\"><span class=\"attr\">          access_log:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">envoy.file_access_log</span></span><br><span class=\"line\"><span class=\"attr\">            config:</span></span><br><span class=\"line\"><span class=\"attr\">              path:</span> <span class=\"string\">\"/dev/stdout\"</span></span><br><span class=\"line\"><span class=\"attr\">          route_config:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">local_route</span></span><br><span class=\"line\"><span class=\"attr\">            virtual_hosts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">service</span></span><br><span class=\"line\"><span class=\"attr\">              domains:</span></span><br><span class=\"line\"><span class=\"bullet\">              -</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"attr\">              routes:</span></span><br><span class=\"line\"><span class=\"attr\">              - match:</span></span><br><span class=\"line\"><span class=\"attr\">                  prefix:</span> <span class=\"string\">\"/\"</span></span><br><span class=\"line\"><span class=\"attr\">                route:</span></span><br><span class=\"line\"><span class=\"attr\">                  cluster:</span> <span class=\"string\">local_service</span></span><br><span class=\"line\"><span class=\"attr\">          http_filters:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">envoy.router</span></span><br><span class=\"line\"><span class=\"attr\">            config:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">  clusters:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">local_service</span></span><br><span class=\"line\"><span class=\"attr\">    connect_timeout:</span> <span class=\"number\">0.25</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">strict_dns</span></span><br><span class=\"line\"><span class=\"attr\">    lb_policy:</span> <span class=\"string\">round_robin</span></span><br><span class=\"line\"><span class=\"attr\">    hosts:</span></span><br><span class=\"line\"><span class=\"attr\">    - socket_address:</span></span><br><span class=\"line\"><span class=\"attr\">        address:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\"><span class=\"attr\">        port_value:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">admin:</span></span><br><span class=\"line\"><span class=\"attr\">  access_log_path:</span> <span class=\"string\">\"/dev/null\"</span></span><br><span class=\"line\"><span class=\"attr\">  address:</span></span><br><span class=\"line\"><span class=\"attr\">    socket_address:</span></span><br><span class=\"line\"><span class=\"attr\">      address:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"attr\">      port_value:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p>Step 3.利用Podman工具进行创建hugoblog与hugoblog-envoy容器<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个 hugoblog 容器并指定容器的 IP：</span></span><br><span class=\"line\">$ podman run -d --name hugoblog \\</span><br><span class=\"line\">  --ip=10.88.0.10 \\</span><br><span class=\"line\">  -v /opt/HugoBlog/nginx:/usr/share/nginx/html \\</span><br><span class=\"line\">  -v /etc/localtime:/etc/localtime \\</span><br><span class=\"line\">  nginx:alpine</span><br><span class=\"line\">b466e555f6f1d84bc81454503afddf69de4d5812fda2b75b2f17c307f4430768</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 再创建一个 envoy 容器与hugoblog 容器共享 network namespace：</span></span><br><span class=\"line\">$ podman run -d --name hugoblog-envoy \\</span><br><span class=\"line\">  -v /opt/HugoBlog/envoy/service-envoy.yaml:/etc/envoy/envoy.yaml \\</span><br><span class=\"line\">  -v /etc/localtime:/etc/localtime \\</span><br><span class=\"line\">  --net=container:hugoblog envoyproxy/envoy-alpine:latest</span><br></pre></td></tr></table></figure></p>\n<p>Step 4.查看创建的容器:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">podman ps --size --pod <span class=\"comment\"># 此处没有直接运行在pod中可以看见PODID与PODNAME为空</span></span><br><span class=\"line\">  <span class=\"comment\"># CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS   NAMES           POD ID  PODNAME  SIZE</span></span><br><span class=\"line\">  <span class=\"comment\"># b466e555f6f1  docker.io/library/nginx:alpine            nginx -g daemon o...  2 hours ago  Up 2 hours ago          hugoblog                         1.12kB (virtual 22.1MB)</span></span><br><span class=\"line\">  <span class=\"comment\"># c18c914654ac  docker.io/envoyproxy/envoy-alpine:latest  envoy -c /etc/env...  2 hours ago  Up 2 hours ago          hugoblog-envoy                   0B (virtual 52.9MB)</span></span><br></pre></td></tr></table></figure></p>\n<p>Step 5.访问容器验证envoy工作<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.先看Nginx工作是否正常</span></span><br><span class=\"line\">~$ curl http://10.88.0.10</span><br><span class=\"line\">  <span class=\"comment\"># &lt;h1&gt;WeiyiGeek Blog With Nginx&lt;/h1&gt;</span></span><br><span class=\"line\">~$ curl -I http://10.88.0.10   <span class=\"comment\"># 返回的头信息</span></span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 200 OK</span></span><br><span class=\"line\">  <span class=\"comment\"># Server: nginx/1.19.2</span></span><br><span class=\"line\">  <span class=\"comment\"># Date: Wed, 23 Sep 2020 04:55:31 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># Content-Length: 35</span></span><br><span class=\"line\">  <span class=\"comment\"># Last-Modified: Wed, 23 Sep 2020 04:48:24 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># Connection: keep-alive</span></span><br><span class=\"line\">  <span class=\"comment\"># ETag: \"5f6ad398-23\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Accept-Ranges: bytes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.再来看envoy是否工作正常</span></span><br><span class=\"line\">WeiyiGeek@ubuntu:~$ curl http://10.88.0.10:8080</span><br><span class=\"line\">  <span class=\"comment\"># &lt;h1&gt;WeiyiGeek Blog With Nginx&lt;/h1&gt;</span></span><br><span class=\"line\">WeiyiGeek@ubuntu:~$ curl -I http://10.88.0.10:8080   <span class=\"comment\"># 返回的头信息</span></span><br><span class=\"line\">  <span class=\"comment\"># HTTP/1.1 200 OK</span></span><br><span class=\"line\">  <span class=\"comment\"># server: envoy                                    # 关键点: 可以看见已经成功负载了</span></span><br><span class=\"line\">  <span class=\"comment\"># date: Wed, 23 Sep 2020 06:05:01 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># content-type: text/html</span></span><br><span class=\"line\">  <span class=\"comment\"># content-length: 35</span></span><br><span class=\"line\">  <span class=\"comment\"># last-modified: Wed, 23 Sep 2020 04:48:24 GMT</span></span><br><span class=\"line\">  <span class=\"comment\"># etag: \"5f6ad398-23\"</span></span><br><span class=\"line\">  <span class=\"comment\"># accept-ranges: bytes</span></span><br><span class=\"line\">  <span class=\"comment\"># x-envoy-upstream-service-time: 0                # 关键点</span></span><br></pre></td></tr></table></figure></p>\n<p>Step 6.前面说过podman 创建的容器是 podman 的子进程而实际上 podman 由两部分组成:</p>\n<ul>\n<li>(1) podman CLI</li>\n<li>(2) container runtime : <code>conmon 是所有容器的父进程</code>并且由 conmon 来负责主要包括监控、日志、TTY 分配以及类似 out-of-memory 情况的杂事,也就是说去做所有 systemd 不做或者不想做的事情并且。即使 CRI-O 不直接使用 systemd 来管理容器它也将容器分配到 sytemd 兼容的 cgroup 中，好处是常规的 systemd 工具比如 systemctl 就可以看见容器资源使用情况了。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.podman 进程查看</span></span><br><span class=\"line\">pstree -p</span><br><span class=\"line\"><span class=\"comment\"># systemd(1)─┬─VGAuthService(733)</span></span><br><span class=\"line\"><span class=\"comment\">#            ├─conmon(824338)─┬─nginx(824363)─┬─nginx(824399)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               └─nginx(824400)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                └─&#123;conmon&#125;(824340)</span></span><br><span class=\"line\"><span class=\"comment\">#            ├─conmon(824555)─┬─envoy(824585)─┬─&#123;envoy&#125;(824596)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824597)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824598)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824599)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824600)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824601)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824602)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824603)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               ├─&#123;envoy&#125;(824604)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                │               └─&#123;envoy&#125;(826782)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                └─&#123;conmon&#125;(824557)</span></span><br><span class=\"line\"><span class=\"comment\">#            ├─containerd(720296)─┬─&#123;containerd&#125;(720297)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720298)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720299)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720300)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720301)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720302)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720305)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720307)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(720310)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    ├─&#123;containerd&#125;(734346)</span></span><br><span class=\"line\"><span class=\"comment\">#            │                    └─&#123;containerd&#125;(779760)</span></span><br><span class=\"line\"><span class=\"comment\">#            ├─podman pause(737423)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.通过conmon进程将容器资源使用情况给systemd相关程序所共享比如下面查看cgroup相关信息</span></span><br><span class=\"line\">systemd-cgtop</span><br><span class=\"line\"><span class=\"comment\"># Control Group                                                                                     Tasks   %CPU   Memory  Input/s Output/s</span></span><br><span class=\"line\"><span class=\"comment\"># /                                                                                                   279      -     3.2G        -        -</span></span><br><span class=\"line\"><span class=\"comment\"># init.scope                                                                                            1      -    10.5M        -        -</span></span><br><span class=\"line\"><span class=\"comment\"># machine.slice                                                                                        18      -    17.7M        -        -</span></span><br><span class=\"line\"><span class=\"comment\"># machine.slice/libpod-b466e555f6f1d84bc81454503afddf69de4d5812fda2b75b2f17c307f4430768.scope           3      -     3.1M        -        -  #  hugoblog</span></span><br><span class=\"line\"><span class=\"comment\"># machine.slice/libpod-c18c914654ac4ad1ddcd2f5d7b51917ef6c066fdec353c608e0f1c8d653b253c.scope          11      -    12.7M        -        -  #  hugoblog-envoy  </span></span><br><span class=\"line\"><span class=\"comment\"># machine.slice/libpod-conmon-b46…5f6f1d84bc81454503afddf69de4d5812fda2b75b2f17c307f4430768.scope       2      -   840.0K        -        -</span></span><br><span class=\"line\"><span class=\"comment\"># machine.slice/libpod-conmon-c18…654ac4ad1ddcd2f5d7b51917ef6c066fdec353c608e0f1c8d653b253c.scope       2      -   816.0K        -        -</span></span><br></pre></td></tr></table></figure>\n<p>Step 7.目前为止它还是一个半成品只能在本机访问10.88.0.10该pod地址,外部网络无法直接访问所以<code>为了实现外部网络访问我们网站我需要部署前端代理</code>;</p>\n<p>自签证书:(<code>注意对外部访问的生产环境不建议采用自签证书</code>)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /opt/ssl</span><br><span class=\"line\">/opt/ssl<span class=\"comment\"># openssl genrsa -des3 -out server.pass.key 2048  # 2020WeiyiGeek.TOP</span></span><br><span class=\"line\">/opt/ssl<span class=\"comment\"># openssl rsa -in server.pass.key -out demo.weiyigeek.top.key</span></span><br><span class=\"line\">/opt/ssl<span class=\"comment\"># openssl req -new -key demo.weiyigeek.top.key -out server.csr -subj \"/C=EN/ST=Chongqing/L=Chongqing/O=WeiyiGeek/OU=WeiyiGeek/CN=demo.weiyigeek.top\"</span></span><br><span class=\"line\">/opt/ssl<span class=\"comment\"># openssl x509 -req -days 3650 -in server.csr -signkey server.key -out demo.weiyigeek.top.crt</span></span><br><span class=\"line\">/opt/ssl<span class=\"comment\"># openssl x509 -in demo.weiyigeek.top.crt -out demo.weiyigeek.top.cer -outform der</span></span><br><span class=\"line\">/opt/ssl<span class=\"comment\"># ls -alh    </span></span><br><span class=\"line\"><span class=\"comment\"># total 28K  # 生成相关证书文件</span></span><br><span class=\"line\"><span class=\"comment\"># -rw-r--r-- 1 root root  895 Sep 23 07:29 demo.weiyigeek.top.cer</span></span><br><span class=\"line\"><span class=\"comment\"># -rw-r--r-- 1 root root 1.3K Sep 23 07:27 demo.weiyigeek.top.crt</span></span><br><span class=\"line\"><span class=\"comment\"># -rw-r--r-- 1 root root 1.1K Sep 23 07:27 server.csr</span></span><br><span class=\"line\"><span class=\"comment\"># -rw------- 1 root root 1.7K Sep 23 07:23 demo.weiyigeek.top.key</span></span><br><span class=\"line\"><span class=\"comment\"># -rw------- 1 root root 1.8K Sep 23 07:23 server.pass.key</span></span><br></pre></td></tr></table></figure></p>\n<p>envoy 的配置文件中是通过域名来添加 cluster 的 front-envoy.yaml 内容如下,官方参考地址 <a href=\"https://github.com/envoyproxy/envoy/blob/51551ae944c642e6fc61563cbea8653087e70f1f/examples/front-proxy/front-envoy.yaml\" target=\"_blank\" rel=\"noopener\">front-envoy.yaml</a> ：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">sudo</span> <span class=\"string\">tee</span> <span class=\"string\">/opt/HugoBlog/envoy/front-envoy.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">static_resources:</span></span><br><span class=\"line\"><span class=\"attr\">  listeners:</span></span><br><span class=\"line\"><span class=\"attr\">  - address:</span></span><br><span class=\"line\"><span class=\"attr\">      socket_address:</span></span><br><span class=\"line\"><span class=\"attr\">        address:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"attr\">        port_value:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">    filter_chains:</span></span><br><span class=\"line\"><span class=\"attr\">    - filters:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">envoy.filters.network.http_connection_manager</span></span><br><span class=\"line\"><span class=\"attr\">        config:</span></span><br><span class=\"line\"><span class=\"attr\">          codec_type:</span> <span class=\"string\">auto</span></span><br><span class=\"line\"><span class=\"attr\">          stat_prefix:</span> <span class=\"string\">ingress_http</span></span><br><span class=\"line\"><span class=\"attr\">          access_log:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">envoy.file_access_log</span></span><br><span class=\"line\"><span class=\"attr\">            config:</span></span><br><span class=\"line\"><span class=\"attr\">              path:</span> <span class=\"string\">\"/dev/stdout\"</span></span><br><span class=\"line\"><span class=\"attr\">          route_config:</span></span><br><span class=\"line\"><span class=\"attr\">            virtual_hosts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">backend</span></span><br><span class=\"line\"><span class=\"attr\">              domains:</span></span><br><span class=\"line\"><span class=\"bullet\">              -</span> <span class=\"string\">\"*\"</span></span><br><span class=\"line\"><span class=\"attr\">              routes:</span></span><br><span class=\"line\"><span class=\"attr\">              - match:</span></span><br><span class=\"line\"><span class=\"attr\">                  prefix:</span> <span class=\"string\">\"/\"</span></span><br><span class=\"line\"><span class=\"attr\">                redirect:</span></span><br><span class=\"line\"><span class=\"attr\">                  https_redirect:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">                  response_code:</span> <span class=\"string\">\"FOUND\"</span></span><br><span class=\"line\"><span class=\"attr\">          http_filters:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">envoy.router</span></span><br><span class=\"line\"><span class=\"attr\">            config:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">  - address:</span></span><br><span class=\"line\"><span class=\"attr\">      socket_address:</span></span><br><span class=\"line\"><span class=\"attr\">        address:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"attr\">        port_value:</span> <span class=\"number\">443</span></span><br><span class=\"line\"><span class=\"attr\">    filter_chains:</span></span><br><span class=\"line\"><span class=\"attr\">    - filter_chain_match:</span></span><br><span class=\"line\"><span class=\"attr\">        server_names:</span> <span class=\"string\">[\"demo.weiyigeek.top\"]</span></span><br><span class=\"line\"><span class=\"attr\">      tls_context:</span></span><br><span class=\"line\"><span class=\"attr\">        common_tls_context:</span></span><br><span class=\"line\"><span class=\"attr\">          alpn_protocols:</span> <span class=\"string\">h2</span></span><br><span class=\"line\"><span class=\"attr\">          tls_params:</span></span><br><span class=\"line\"><span class=\"attr\">            tls_maximum_protocol_version:</span> <span class=\"string\">TLSv1_3</span></span><br><span class=\"line\"><span class=\"attr\">          tls_certificates:</span></span><br><span class=\"line\">            <span class=\"comment\"># 证书链此处是自签而不是第三方证书颁发机构</span></span><br><span class=\"line\"><span class=\"attr\">            - certificate_chain:</span></span><br><span class=\"line\"><span class=\"attr\">                filename:</span> <span class=\"string\">\"/opt/ssl/demo.weiyigeek.top.crt\"</span>  </span><br><span class=\"line\"><span class=\"attr\">              private_key:</span></span><br><span class=\"line\"><span class=\"attr\">                filename:</span> <span class=\"string\">\"/opt/ssl/demo.weiyigeek.top.key\"</span></span><br><span class=\"line\"><span class=\"attr\">      filters:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">envoy.filters.network.http_connection_manager</span></span><br><span class=\"line\"><span class=\"attr\">        config:</span></span><br><span class=\"line\"><span class=\"attr\">          codec_type:</span> <span class=\"string\">auto</span></span><br><span class=\"line\"><span class=\"attr\">          stat_prefix:</span> <span class=\"string\">ingress_http</span></span><br><span class=\"line\"><span class=\"attr\">          route_config:</span></span><br><span class=\"line\"><span class=\"attr\">            name:</span> <span class=\"string\">local_route</span></span><br><span class=\"line\"><span class=\"attr\">            virtual_hosts:</span></span><br><span class=\"line\"><span class=\"attr\">            - name:</span> <span class=\"string\">backend</span></span><br><span class=\"line\"><span class=\"attr\">              domains:</span></span><br><span class=\"line\"><span class=\"bullet\">              -</span> <span class=\"string\">\"demo.weiyigeek.top\"</span></span><br><span class=\"line\"><span class=\"attr\">              routes:</span></span><br><span class=\"line\"><span class=\"attr\">              - match:</span></span><br><span class=\"line\"><span class=\"attr\">                  prefix:</span> <span class=\"string\">\"/\"</span></span><br><span class=\"line\"><span class=\"attr\">                route:</span></span><br><span class=\"line\"><span class=\"attr\">                  cluster:</span> <span class=\"string\">hugoblog</span></span><br><span class=\"line\"><span class=\"attr\">          http_filters:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">envoy.router</span></span><br><span class=\"line\"><span class=\"attr\">            config:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">  clusters:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">hugoblog</span></span><br><span class=\"line\"><span class=\"attr\">    connect_timeout:</span> <span class=\"number\">0.25</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">strict_dns</span></span><br><span class=\"line\"><span class=\"attr\">    lb_policy:</span> <span class=\"string\">round_robin</span></span><br><span class=\"line\"><span class=\"attr\">    http2_protocol_options:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    load_assignment:</span></span><br><span class=\"line\"><span class=\"attr\">      cluster_name:</span> <span class=\"string\">hugoblog</span></span><br><span class=\"line\"><span class=\"attr\">      endpoints:</span></span><br><span class=\"line\"><span class=\"attr\">      - lb_endpoints:</span></span><br><span class=\"line\"><span class=\"attr\">        - endpoint:</span></span><br><span class=\"line\"><span class=\"attr\">            address:</span></span><br><span class=\"line\"><span class=\"attr\">              socket_address:</span></span><br><span class=\"line\"><span class=\"attr\">                address:</span> <span class=\"string\">hugoblog</span></span><br><span class=\"line\"><span class=\"attr\">                port_value:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p>由于没办法自动服务发现需要通过参数<code>--add-host 手动添加 hosts 到hugoblog容器中</code>(注意映射证书签名)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman run -d --name hugoblog-front-envoy \\</span><br><span class=\"line\">--add-host=hugoblog:10.88.0.10 \\</span><br><span class=\"line\">-v /opt/HugoBlog/envoy/front-envoy.yaml:/etc/envoy/envoy.yaml \\</span><br><span class=\"line\">-v /etc/localtime:/etc/localtime \\</span><br><span class=\"line\">-v /opt/ssl/:/opt/ssl/ \\</span><br><span class=\"line\">--net host envoyproxy/envoy</span><br><span class=\"line\"><span class=\"comment\"># 0a3a62265c6d464f86cce41a8cea5f7316d226bbb62be7124dfc44f7aebcd2f5</span></span><br><span class=\"line\"><span class=\"comment\"># [2020-09-23 12:22:50.096][1][info][config] [source/server/configuration_impl.cc:129] loading stats sink configuration</span></span><br><span class=\"line\"><span class=\"comment\"># [2020-09-23 12:22:50.096][1][info][main] [source/server/server.cc:554] starting main dispatch loop</span></span><br><span class=\"line\"><span class=\"comment\"># [2020-09-23 12:22:50.096][1][info][upstream] [source/common/upstream/cluster_manager_impl.cc:171] cm init: all clusters initialized</span></span><br><span class=\"line\"><span class=\"comment\"># [2020-09-23 12:22:50.096][1][info][main] [source/server/server.cc:533] all clusters initialized. initializing init manager</span></span><br><span class=\"line\"><span class=\"comment\"># [2020-09-23 12:22:50.096][1][info][config] [source/server/listener_manager_impl.cc:725] all dependencies initialized. starting workers</span></span><br></pre></td></tr></table></figure></p>\n<p>Step 8.访问验证envoyproxy前端代理是是否成功<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.直接访问非http网站会强制302进行跳转</span></span><br><span class=\"line\">root@WeiyiGeek:/mnt/c/Users/WeiyiGeek/Desktop<span class=\"comment\"># curl -I demo.weiyigeek.top</span></span><br><span class=\"line\">HTTP/1.1 302 Found</span><br><span class=\"line\">location: https://demo.weiyigeek.top/</span><br><span class=\"line\">date: Wed, 23 Sep 2020 12:26:17 GMT</span><br><span class=\"line\">server: envoy   <span class=\"comment\"># 可以看见server是envoy</span></span><br><span class=\"line\">transfer-encoding: chunked</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.访问https网站结果</span></span><br><span class=\"line\">root@WeiyiGeek:/mnt/c/Users/WeiyiGeek/Desktop<span class=\"comment\"># curl https://demo.weiyigeek.top --insecure</span></span><br><span class=\"line\">&lt;h1&gt;WeiyiGeek Blog With Nginx&lt;/h1&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">root@WeiyiGeek:/mnt/c/Users/WeiyiGeek/Desktop<span class=\"comment\"># curl https://demo.weiyigeek.top --insecure -I</span></span><br><span class=\"line\">HTTP/2 200</span><br><span class=\"line\">server: envoy</span><br><span class=\"line\">date: Wed, 23 Sep 2020 12:28:37 GMT</span><br><span class=\"line\">content-type: text/html</span><br><span class=\"line\">content-length: 35</span><br><span class=\"line\">last-modified: Wed, 23 Sep 2020 04:48:24 GMT</span><br><span class=\"line\">etag: <span class=\"string\">\"5f6ad398-23\"</span></span><br><span class=\"line\">accept-ranges: bytes</span><br><span class=\"line\">x-envoy-upstream-service-time: 0</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200923203752.png\" alt=\"WeiyiGeek.EnvoyProxy\" title=\"\" class=\"\">\n                <p>WeiyiGeek.EnvoyProxy</p>\n            </figure>\n<p><br/></p>\n<h5 id=\"3-Podman-导出与部署声明式清单\"><a href=\"#3-Podman-导出与部署声明式清单\" class=\"headerlink\" title=\"3.Podman-导出与部署声明式清单\"></a>3.Podman-导出与部署声明式清单</h5><p>描述:我们将上面的示例整合进指定pod中然后进行导出清单和快捷部署导出的清单;</p>\n<p>Step 1.在前面的环境的基础上创建pod以及将创建的容器加入到pod中<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pod 创建并设置其ip地址(非常重要)</span></span><br><span class=\"line\">$ podman pod create --ip 10.88.0.10 --name Blog</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个nginx容器并指加入到pod中</span></span><br><span class=\"line\">$ podman run -d --pod Blog --name hugoblog \\</span><br><span class=\"line\">  -v /opt/HugoBlog/nginx:/usr/share/nginx/html \\</span><br><span class=\"line\">  -v /etc/localtime:/etc/localtime \\</span><br><span class=\"line\">  nginx:alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个 envoy 容器 与hugoblog 容器共享 network namespace也加入到pod中</span></span><br><span class=\"line\">$ podman run -d --pod Blog --name hugoblog-envoy \\</span><br><span class=\"line\">  -v /opt/HugoBlog/envoy/service-envoy.yaml:/etc/envoy/envoy.yaml \\</span><br><span class=\"line\">  -v /etc/localtime:/etc/localtime \\</span><br><span class=\"line\">  --net=container:hugoblog envoyproxy/envoy-alpine:latest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部署前端代理将pod内部应用进行转发到宿主机上</span></span><br><span class=\"line\">podman run -d --pod Blog --name hugoblog-front-envoy \\</span><br><span class=\"line\">  --add-host=hugoblog:10.88.0.10 \\</span><br><span class=\"line\">  -v /opt/HugoBlog/envoy/front-envoy.yaml:/etc/envoy/envoy.yaml \\</span><br><span class=\"line\">  -v /etc/localtime:/etc/localtime \\</span><br><span class=\"line\">  -v /opt/ssl/:/opt/ssl/ \\</span><br><span class=\"line\">  --net host envoyproxy/envoy</span><br></pre></td></tr></table></figure></p>\n<p>Step 2.本机访问验证<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu:~<span class=\"comment\"># nano /etc/hosts</span></span><br><span class=\"line\">10.10.107.202 demo.weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\">root@ubuntu:~<span class=\"comment\"># curl -I https://demo.weiyigeek.top --insecure</span></span><br><span class=\"line\">HTTP/2 200</span><br><span class=\"line\">server: envoy</span><br><span class=\"line\">date: Wed, 23 Sep 2020 13:17:57 GMT</span><br><span class=\"line\">content-type: text/html</span><br><span class=\"line\">content-length: 71</span><br><span class=\"line\">last-modified: Wed, 23 Sep 2020 12:35:16 GMT</span><br><span class=\"line\">etag: <span class=\"string\">\"5f6b4104-47\"</span></span><br><span class=\"line\">accept-ranges: bytes</span><br><span class=\"line\">x-envoy-upstream-service-time: 0</span><br><span class=\"line\"></span><br><span class=\"line\">root@ubuntu:~<span class=\"comment\"># curl https://demo.weiyigeek.top --insecure</span></span><br><span class=\"line\">&lt;h3 style=<span class=\"string\">\"color:red\"</span>&gt;WeiyiGeek Blog , Example Podman pod Create Nginx and Envoy and EnvoyProxy!&lt;/h3&gt;</span><br></pre></td></tr></table></figure></p>\n<p>Step 3.外部机器访问<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200923212550.png\" alt=\"WeiyiGeek.envoyproxy\" title=\"\" class=\"\">\n                <p>WeiyiGeek.envoyproxy</p>\n            </figure></p>\n<p>Step 4.将 pod 导出为声明式部署清单<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">$</span> <span class=\"string\">podman</span> <span class=\"string\">generate</span> <span class=\"string\">kube</span> <span class=\"string\">Blog</span> <span class=\"string\">&gt; Blog.yaml </span></span><br><span class=\"line\"><span class=\"string\">$ cat Blog.yaml </span></span><br><span class=\"line\"><span class=\"string\"># Generation of Kubernetes YAML is still under development!</span></span><br><span class=\"line\"><span class=\"string\">#</span></span><br><span class=\"line\"><span class=\"string\"># Save the output of this file and use kubectl create -f to import</span></span><br><span class=\"line\"><span class=\"string\"># it into Kubernetes.</span></span><br><span class=\"line\"><span class=\"string\">#</span></span><br><span class=\"line\"><span class=\"string\"># Created with podman-2.0.6</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  creationTimestamp:</span> <span class=\"string\">\"2020-09-23T13:50:40Z\"</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">Blog</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">Blog</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span></span><br><span class=\"line\"><span class=\"attr\">  - command:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">envoy</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"bullet\">-c</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/etc/envoy/envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">    env:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">PATH</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">TERM</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">xterm</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">LANG</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">C.UTF-8</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">container</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">podman</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">HOSTNAME</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">Blog</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">docker.io/envoyproxy/envoy-alpine:latest</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">hugoblog-envoy</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">      allowPrivilegeEscalation:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      capabilities:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      privileged:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      readOnlyRootFilesystem:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      seLinuxOptions:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">    - mountPath:</span> <span class=\"string\">/etc/envoy/envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">opt-HugoBlog-envoy-service-envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">    - mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">etc-localtime</span></span><br><span class=\"line\"><span class=\"attr\">    workingDir:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">  - command:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">envoy</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"bullet\">-c</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">/etc/envoy/envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">    env:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">PATH</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">TERM</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">xterm</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">container</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">podman</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">HOSTNAME</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">Blog</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">docker.io/envoyproxy/envoy:latest</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">hugoblog-front-envoy</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">      allowPrivilegeEscalation:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      capabilities:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      privileged:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      readOnlyRootFilesystem:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      seLinuxOptions:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">    - mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">etc-localtime</span></span><br><span class=\"line\"><span class=\"attr\">    - mountPath:</span> <span class=\"string\">/opt/ssl</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">opt-ssl</span></span><br><span class=\"line\"><span class=\"attr\">    - mountPath:</span> <span class=\"string\">/etc/envoy/envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">opt-HugoBlog-envoy-front-envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">    workingDir:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">  - command:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"bullet\">-g</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">daemon</span> <span class=\"string\">off;</span></span><br><span class=\"line\"><span class=\"attr\">    env:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">PATH</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">TERM</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">xterm</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">NGINX_VERSION</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"number\">1.19</span><span class=\"number\">.2</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">NJS_VERSION</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"number\">0.4</span><span class=\"number\">.3</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">PKG_RELEASE</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">\"1\"</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">container</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">podman</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">HOSTNAME</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">Blog</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">docker.io/library/nginx:alpine</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">hugoblog</span></span><br><span class=\"line\"><span class=\"attr\">    resources:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    securityContext:</span></span><br><span class=\"line\"><span class=\"attr\">      allowPrivilegeEscalation:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">      capabilities:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">      privileged:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      readOnlyRootFilesystem:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">      seLinuxOptions:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">    volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">    - mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">opt-HugoBlog-nginx</span></span><br><span class=\"line\"><span class=\"attr\">    - mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">etc-localtime</span></span><br><span class=\"line\"><span class=\"attr\">    workingDir:</span> <span class=\"string\">/</span></span><br><span class=\"line\"><span class=\"attr\">  volumes:</span></span><br><span class=\"line\"><span class=\"attr\">  - hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/opt/HugoBlog/envoy/service-envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">      type:</span> <span class=\"string\">File</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">opt-HugoBlog-envoy-service-envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">  - hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\"><span class=\"attr\">      type:</span> <span class=\"string\">File</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">etc-localtime</span></span><br><span class=\"line\"><span class=\"attr\">  - hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/opt/ssl</span></span><br><span class=\"line\"><span class=\"attr\">      type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">opt-ssl</span></span><br><span class=\"line\"><span class=\"attr\">  - hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/opt/HugoBlog/envoy/front-envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">      type:</span> <span class=\"string\">File</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">opt-HugoBlog-envoy-front-envoy.yaml</span></span><br><span class=\"line\"><span class=\"attr\">  - hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/opt/HugoBlog/nginx</span></span><br><span class=\"line\"><span class=\"attr\">      type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">opt-HugoBlog-nginx</span></span><br><span class=\"line\"><span class=\"attr\">status:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">status:</span></span><br><span class=\"line\"><span class=\"attr\">  loadBalancer:</span> <span class=\"string\">&#123;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p><em>怎么样是不是有种熟悉的味道?</em><br>答: 它是一个兼容 kubernetes 的 pod 定义，你可以直接通过 kubectl apply -f hugo.yaml 将其部署在 Kubernetes 集群中也可以直接通过 podman 部署 <code>podman play kube hugo.yaml</code>, 回到之前的问题，如果通过声明式定义来创建 pod，还是无法解决服务发现的问题，除非换个支持静态 IP 的 CNI 插件，而支持静态 IP 的这些 CNI 插件又需要 etcd 作为数据库看来还是暂时放弃;</p>\n<p>Step 5.pod中的容器systemd管理脚本生成,<code>注意 podman 不再使用 daemon 管理服务所以--restart 参数被废弃了</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman generate systemd hugoblog</span><br><span class=\"line\"><span class=\"comment\"># container-2603018909da9c48c7bf4b369a2d540a92573749e120aa0832b19ad908c81cdd.service</span></span><br><span class=\"line\"><span class=\"comment\"># autogenerated by Podman 2.0.6</span></span><br><span class=\"line\"><span class=\"comment\"># Wed Sep 23 13:59:13 UTC 2020</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Podman container-2603018909da9c48c7bf4b369a2d540a92573749e120aa0832b19ad908c81cdd.service</span><br><span class=\"line\">Documentation=man:podman-generate-systemd(1)</span><br><span class=\"line\">Wants=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=PODMAN_SYSTEMD_UNIT=%n</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">ExecStart=/usr/bin/podman start 2603018909da9c48c7bf4b369a2d540a92573749e120aa0832b19ad908c81cdd</span><br><span class=\"line\">ExecStop=/usr/bin/podman stop -t 10 2603018909da9c48c7bf4b369a2d540a92573749e120aa0832b19ad908c81cdd</span><br><span class=\"line\">ExecStopPost=/usr/bin/podman stop -t 10 2603018909da9c48c7bf4b369a2d540a92573749e120aa0832b19ad908c81cdd</span><br><span class=\"line\">PIDFile=/var/run/containers/storage/overlay-containers/2603018909da9c48c7bf4b369a2d540a92573749e120aa0832b19ad908c81cdd/userdata/conmon.pid</span><br><span class=\"line\">KillMode=none</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target default.target</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ podman generate systemd hugoblog-envoy</span><br><span class=\"line\"><span class=\"comment\"># container-23444cf45564d9e3a7d0fe96343d8d0e08c83823403bc05cf99e0a0928318736.service</span></span><br><span class=\"line\"><span class=\"comment\"># autogenerated by Podman 2.0.6</span></span><br><span class=\"line\"><span class=\"comment\"># Wed Sep 23 13:59:43 UTC 2020</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Podman container-23444cf45564d9e3a7d0fe96343d8d0e08c83823403bc05cf99e0a0928318736.service</span><br><span class=\"line\">Documentation=man:podman-generate-systemd(1)</span><br><span class=\"line\">Wants=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">After=hugoblog.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=PODMAN_SYSTEMD_UNIT=%n</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">ExecStart=/usr/bin/podman start 23444cf45564d9e3a7d0fe96343d8d0e08c83823403bc05cf99e0a0928318736</span><br><span class=\"line\">ExecStop=/usr/bin/podman stop -t 10 23444cf45564d9e3a7d0fe96343d8d0e08c83823403bc05cf99e0a0928318736</span><br><span class=\"line\">ExecStopPost=/usr/bin/podman stop -t 10 23444cf45564d9e3a7d0fe96343d8d0e08c83823403bc05cf99e0a0928318736</span><br><span class=\"line\">PIDFile=/var/run/containers/storage/overlay-containers/23444cf45564d9e3a7d0fe96343d8d0e08c83823403bc05cf99e0a0928318736/userdata/conmon.pid</span><br><span class=\"line\">KillMode=none</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target default.target</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$podman</span> generate systemd hugoblog-front-envoy</span><br><span class=\"line\"><span class=\"comment\"># container-25bcd2f79803a1b7dd653e36a0d0656d6d055df5a29d184e71df728e1c46adce.service</span></span><br><span class=\"line\"><span class=\"comment\"># autogenerated by Podman 2.0.6</span></span><br><span class=\"line\"><span class=\"comment\"># Wed Sep 23 14:00:22 UTC 2020</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Podman container-25bcd2f79803a1b7dd653e36a0d0656d6d055df5a29d184e71df728e1c46adce.service</span><br><span class=\"line\">Documentation=man:podman-generate-systemd(1)</span><br><span class=\"line\">Wants=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">After=hugoblog.service hugoblog-envoy.service  <span class=\"comment\"># 启动顺序非常重要</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=PODMAN_SYSTEMD_UNIT=%n</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">ExecStart=/usr/bin/podman start 25bcd2f79803a1b7dd653e36a0d0656d6d055df5a29d184e71df728e1c46adce</span><br><span class=\"line\">ExecStop=/usr/bin/podman stop -t 10 25bcd2f79803a1b7dd653e36a0d0656d6d055df5a29d184e71df728e1c46adce</span><br><span class=\"line\">ExecStopPost=/usr/bin/podman stop -t 10 25bcd2f79803a1b7dd653e36a0d0656d6d055df5a29d184e71df728e1c46adce</span><br><span class=\"line\">PIDFile=/var/run/containers/storage/overlay-containers/25bcd2f79803a1b7dd653e36a0d0656d6d055df5a29d184e71df728e1c46adce/userdata/conmon.pid</span><br><span class=\"line\">KillMode=none</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target default.target</span><br></pre></td></tr></table></figure></p>\n<p>实际上我们可以直接采用pod为单位进行管理起容器启动和停止：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo tee /etc/systemd/system/Blog.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=WeiyiGeek-Blog-Service</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">After=podman.service</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">ExecStart=/usr/bin/podman pod start Blog</span><br><span class=\"line\">ExecStop=/usr/bin/podman pod stop -t 10 Blog</span><br><span class=\"line\">KillMode=none</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\"></span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target default.target</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>Step 6.设置开启自启已经systemd守护进程监听<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.停止所有的容器</span></span><br><span class=\"line\">podman stop $(podman ps -aq)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.设置开机自启</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> Blog.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.启动pod</span></span><br><span class=\"line\">root@ubuntu:~<span class=\"comment\"># systemctl start Blog.service</span></span><br><span class=\"line\">root@ubuntu:~<span class=\"comment\"># systemctl status Blog.service</span></span><br><span class=\"line\">● Blog.service - WeiyiGeek-Blog-Service</span><br><span class=\"line\">     Loaded: loaded (/etc/systemd/system/Blog.service; disabled; vendor preset: enabled)</span><br><span class=\"line\">     Active: active (running) since Wed 2020-09-23 14:21:28 UTC; 5s ago</span><br><span class=\"line\">    Process: 880757 ExecStart=/usr/bin/podman pod start Blog (code=exited, status=0/SUCCESS)</span><br><span class=\"line\">      Tasks: 8 (<span class=\"built_in\">limit</span>: 4620)</span><br><span class=\"line\">     Memory: 3.0M</span><br><span class=\"line\">     CGroup: /system.slice/Blog.service</span><br><span class=\"line\">             ├─880804 /usr/libexec/podman/conmon --api-version 1 -c 9a1c6b58305ca3b3b7dc58ed99388ab309384900d54f4d1d71c94c5172c67167 -u 9a1c6b58305ca3b3b7dc58ed993&gt;</span><br><span class=\"line\">             ├─880835 /usr/libexec/podman/conmon --api-version 1 -c 25bcd2f79803a1b7dd653e36a0d0656d6d055df5a29d184e71df728e1c46adce -u 25bcd2f79803a1b7dd653e36a0d&gt;</span><br><span class=\"line\">             ├─880859 /usr/libexec/podman/conmon --api-version 1 -c 2603018909da9c48c7bf4b369a2d540a92573749e120aa0832b19ad908c81cdd -u 2603018909daton9c48c7bf4b369a2&gt;</span><br><span class=\"line\">             └─880906 /usr/libexec/podman/conmon --api-version 1 -c 23444cf45564d9e3a7d0fe96343d8d0e08c83823403bc05cf99e0a0928318736 -u 23444cf45564d9e3a7d0fe96343&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Sep 23 14:21:27 ubuntu systemd[1]: Starting WeiyiGeek-Blog-Service...</span><br><span class=\"line\">Sep 23 14:21:28 ubuntu podman[880757]: 80171e5522608aee384e001ec3267bf091837e0075a64a93c45b1b64381674ac</span><br><span class=\"line\">Sep 23 14:21:28 ubuntu systemd[1]: Started WeiyiGeek-Blog-Service.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.采用systemd停止pod及其容器</span></span><br><span class=\"line\">root@ubuntu:~<span class=\"comment\"># systemctl stop Blog.service</span></span><br><span class=\"line\">root@ubuntu:~<span class=\"comment\"># systemctl status Blog.service</span></span><br><span class=\"line\">● Blog.service - WeiyiGeek-Blog-Service</span><br><span class=\"line\">     Loaded: loaded (/etc/systemd/system/Blog.service; disabled; vendor preset: enabled)</span><br><span class=\"line\">     Active: inactive (dead)</span><br><span class=\"line\"></span><br><span class=\"line\">Sep 23 14:23:34 ubuntu systemd[1]: Stopping WeiyiGeek-Blog-Service...</span><br><span class=\"line\">Sep 23 14:23:35 ubuntu podman[880999]: 80171e5522608aee384e001ec3267bf091837e0075a64a93c45b1b64381674ac</span><br><span class=\"line\">Sep 23 14:23:35 ubuntu systemd[1]: Blog.service: Succeeded.</span><br><span class=\"line\">Sep 23 14:23:35 ubuntu systemd[1]: Stopped WeiyiGeek-Blog-Service.</span><br></pre></td></tr></table></figure></p>\n<p>至此每次系统重启后 systemd 都会自动启动这个服务所对应的容器。</p>\n<hr>\n<h4 id=\"0x03-基础配置\"><a href=\"#0x03-基础配置\" class=\"headerlink\" title=\"0x03 基础配置\"></a>0x03 基础配置</h4><h5 id=\"1-镜像加速\"><a href=\"#1-镜像加速\" class=\"headerlink\" title=\"1.镜像加速\"></a>1.镜像加速</h5><p>描述:国内直接用 <code>podman pull</code> 拉取镜像会很慢所以需要配置阿里云容器镜像来加速访问。<br>配置说明: Podman 默认注册表配置文件在<code>/etc/containers/registries.conf</code>,把 location 对应的值修改为你的阿里云容器加速镜像地址然后重新服务即可;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 参考1</span><br><span class=\"line\">unqualified-search-registries &#x3D; [&quot;docker.io&quot;]</span><br><span class=\"line\">[[registry]]</span><br><span class=\"line\">prefix &#x3D; &quot;docker.io&quot;</span><br><span class=\"line\">insecure &#x3D; true</span><br><span class=\"line\">location &#x3D; &quot;xlx9erfu.mirror.aliyuncs.com&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 参考2</span><br><span class=\"line\">unqualified-search-registries &#x3D; [&#39;docker.io&#39;]</span><br><span class=\"line\">[[registry]]</span><br><span class=\"line\">prefix &#x3D; &quot;docker.io&quot;</span><br><span class=\"line\">insecure &#x3D; false</span><br><span class=\"line\">location &#x3D; &quot;docker.io&quot;</span><br><span class=\"line\">[[registry.mirror]]</span><br><span class=\"line\">location &#x3D; &quot;xlx9erfu.mirror.aliyuncs.com&quot;</span><br><span class=\"line\">insecure &#x3D; true</span><br></pre></td></tr></table></figure></p>\n<p><em>主要事项:</em></p>\n<ul>\n<li>版本1中registries.search, registries.insecure, and registries.block 格式已弃用</li>\n<li>运行podman info命令可查看设置加速镜像<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1</span></span><br><span class=\"line\">registries:</span><br><span class=\"line\">  docker.io:</span><br><span class=\"line\">    Blocked: <span class=\"literal\">false</span></span><br><span class=\"line\">    Insecure: <span class=\"literal\">false</span></span><br><span class=\"line\">    Location: docker.io</span><br><span class=\"line\">    MirrorByDigestOnly: <span class=\"literal\">false</span></span><br><span class=\"line\">    Mirrors:</span><br><span class=\"line\">    - Insecure: <span class=\"literal\">true</span></span><br><span class=\"line\">      Location: xlx9erfu.mirror.aliyuncs.com</span><br><span class=\"line\">    Prefix: docker.io</span><br><span class=\"line\">  search:</span><br><span class=\"line\">  - docker.io</span><br><span class=\"line\"><span class=\"comment\"># 方式2</span></span><br><span class=\"line\">podman info -f <span class=\"string\">\"&#123;&#123;.Registries&#125;&#125;\"</span></span><br><span class=\"line\">map[docker.io:&#123;docker.io &#123;docker.io <span class=\"literal\">false</span>&#125; [&#123;xlx9erfu.mirror.aliyuncs.com <span class=\"literal\">true</span>&#125;] <span class=\"literal\">false</span> <span class=\"literal\">false</span>&#125; search:[docker.io]]</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>参考连接: <a href=\"https://github.com/containers/podman/issues/5764#issuecomment-611157552\" target=\"_blank\" rel=\"noopener\">https://github.com/containers/podman/issues/5764#issuecomment-611157552</a></p>\n<hr>\n<h4 id=\"0x04-入坑出坑\"><a href=\"#0x04-入坑出坑\" class=\"headerlink\" title=\"0x04 入坑出坑\"></a>0x04 入坑出坑</h4><h5 id=\"问题-创建pod的提-示Error-initializing-source-docker-k8s-gcr-io-pause-3-2-dial-tcp-108-177-97-82-443-i-o-timeout\"><a href=\"#问题-创建pod的提-示Error-initializing-source-docker-k8s-gcr-io-pause-3-2-dial-tcp-108-177-97-82-443-i-o-timeout\" class=\"headerlink\" title=\"问题.创建pod的提 示Error initializing source docker://k8s.gcr.io/pause:3.2:dial tcp 108.177.97.82:443: i/o timeout\"></a>问题.创建pod的提 示Error initializing source docker://k8s.gcr.io/pause:3.2:dial tcp 108.177.97.82:443: i/o timeout</h5><p>问题描述: 首次执行 podman pod create –name HelloWorld 时候会出现以下错误;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERRO[0060] Error freeing pod lock after failed creation: no such file or directory</span><br><span class=\"line\">Error: error adding Infra Container: unable to pull k8s.gcr.io/pause:3.2: Error initializing <span class=\"built_in\">source</span> docker://k8s.gcr.io/pause:3.2: error pinging docker registry k8s.gcr.io: Get <span class=\"string\">\"https://k8s.gcr.io/v2/\"</span>: dial tcp 108.177.97.82:443: i/o timeout</span><br></pre></td></tr></table></figure><br>解决方式:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$podman</span> pull mirrorgcrio/pause:3.2 --<span class=\"built_in\">log</span>-level info</span><br><span class=\"line\"><span class=\"variable\">$podman</span> images</span><br><span class=\"line\"><span class=\"comment\"># REPOSITORY                        TAG     IMAGE ID      CREATED        SIZE</span></span><br><span class=\"line\"><span class=\"comment\"># docker.io/mirrorgcrio/pause       3.2     80d28bedfe5d  7 months ago   686 kB</span></span><br><span class=\"line\"><span class=\"comment\"># docker.io/library/hello-world     latest  bf756fb1ae65  8 months ago   20 kB</span></span><br><span class=\"line\"><span class=\"variable\">$podman</span> tag docker.io/mirrorgcrio/pause:3.2 k8s.gcr.io/pause:3.2</span><br><span class=\"line\"><span class=\"variable\">$podman</span> images</span><br><span class=\"line\">REPOSITORY                        TAG     IMAGE ID      CREATED        SIZE</span><br><span class=\"line\">docker.io/mirrorgcrio/pause       3.2     80d28bedfe5d  7 months ago   686 kB</span><br><span class=\"line\">k8s.gcr.io/pause                  3.2     80d28bedfe5d  7 months ago   686 kB</span><br></pre></td></tr></table></figure></p>\n<hr>\n<!-- Reffrence -->\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"Podman","path":"api/tags/Podman.json"}]}