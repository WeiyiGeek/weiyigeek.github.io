{"title":"MYSQL数据库读写分离实例","slug":"数据存储/Database-运维/MySQL/运维实战/MYSQL数据库读写分离实例","date":"2019-06-01T12:34:33.000Z","updated":"2022-03-29T05:39:06.312Z","url":"2019/6-1-88.html","path":"api/articles/2019/6-1-88.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601124539.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601134837.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601134747.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601192019.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601212228.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601191541.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602012918.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602183824.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602180508.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602213619.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602221810.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-利用PHP实现读写分离\"><a href=\"#0x00-利用PHP实现读写分离\" class=\"headerlink\" title=\"0x00 利用PHP实现读写分离\"></a>0x00 利用PHP实现读写分离</h4><p>描述：在做PHP读写分离前需要拿到运维部门给好的读写数据库的连接地址,提前定义好数据库的操作类程序,然后编写开发文档让所有的开发同时都统一调用这个类来执行SQL语句;</p>\n<p>目前要实现mysql的主从读写分离，主要有以下几种方案：</p>\n<ul>\n<li>方法1：通过程序实现程序判断SQL语句(DQL-数据查询语言/DML-数据操作语言)比较复杂，如果添加从服务器要更改多台服务器的代码。</li>\n<li>方法2：自己开发接口实现通过自写类调用实现(传入参数的方法)，这种方案门槛高，开发成本高，不是一般的小公司能承担得起。</li>\n<li>方法3：通过mysql-proxy来实现，由于mysql-proxy的主从读写分离是通过lua脚本来实现，目前lua的脚本的开发跟不上节奏，而写没有完美的现成的脚本，因此导致用于生产环境的话风险比较大，据网上很多人说mysql-proxy的性能不高。</li>\n<li>方法4：一些读写分离的软件比如amoeba</li>\n</ul>\n<p><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601124539.png\" alt=\"WeiyiGeek.执行流程\"></p>\n<p><em>方法优缺点</em>：</p>\n<ul>\n<li>方法1：<ul>\n<li>优点：开发人员无需自行区分是读库还是写库,程序根据SQL语句进行自动鉴别,从而区分连接;</li>\n<li>缺点：需要进行SQL语句的字符截取,影响效率;</li>\n</ul>\n</li>\n<li>方法2：<ul>\n<li>优点：效率高,无需截取多余的字符串进行判断;</li>\n<li>缺点：开发人员在开发的时候容易把读库当作写库来操作,由于传入类是true还是false;</li>\n</ul>\n</li>\n</ul>\n<p>方法1：伪代码<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#首先定义读库和写库（连接数据库的账户密码IP这里不定义）</span></span><br><span class=\"line\">define(<span class=\"string\">'IDATABASE'</span>,<span class=\"string\">'INSERTDB'</span>); </span><br><span class=\"line\">define(<span class=\"string\">'SDATABASE'</span>,<span class=\"string\">'SELECTDB'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#类方法</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">@ 作用：截取SQL语句的字符，从而判断进行读写分离</span></span><br><span class=\"line\"><span class=\"comment\">@ 参数：传入执行的SQL语句</span></span><br><span class=\"line\"><span class=\"comment\">**/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">execute</span><span class=\"params\">($sql)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $check_sql = strtolower(trim($sql)); <span class=\"comment\">//去掉空格键字符串转变为空格</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(substr($check_sql,<span class=\"number\">0</span>,<span class=\"number\">6</span>)==<span class=\"string\">'select'</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;getAll($sql); <span class=\"comment\">//读库</span></span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;exec($sql);  <span class=\"comment\">//写库</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>方法2：伪代码<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#类ConnectMysql</span></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">@ 利用实例化类传入的参数进行判断是读库还是写库</span></span><br><span class=\"line\"><span class=\"comment\">@ __construct构造方法：传入flag判断false为读,true为写</span></span><br><span class=\"line\"><span class=\"comment\">**/</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConnectMysql</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $flag = <span class=\"string\">'false'</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($flag)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;flag=$flag;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;flag == <span class=\"string\">'false'</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;DBselect();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;DBwrite();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<hr/>\n\n<h4 id=\"0x01-amoeba架构实现读写分离\"><a href=\"#0x01-amoeba架构实现读写分离\" class=\"headerlink\" title=\"0x01 amoeba架构实现读写分离\"></a>0x01 amoeba架构实现读写分离</h4><h5 id=\"1-简介\"><a href=\"#1-简介\" class=\"headerlink\" title=\"1.简介\"></a>1.简介</h5><p>Amoeba[英 /ə’miːbə/]是一个以MySQL为底层数据存储，并对应用提供MySQL协议接口的proxy,Amoeba相当于一个SQL请求的路由器(进行转发请求)，它集中地响应应用的请求，依据用户事先设置的规则，将SQL请求发送到特定的数据库上执行,并且需要结合使用MySQL的 Replication等机制来实现副本同步等功能,基于此可以实现负载均衡、读写分离、高可用性等需求，</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601134837.png\" alt=\"WeiyiGeek.amoeba执行流程\" title=\"\" class=\"\">\n                <p>WeiyiGeek.amoeba执行流程</p>\n            </figure>\n<p><em>Amoeba体系架构：</em><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601134747.png\" alt=\"WeiyiGeek.amoeba架构图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.amoeba架构图</p>\n            </figure></p>\n<p><em>为什么要用Amoeba?</em><br>答：利用阿里巴巴的开源项目Amoeba来实现，具有负载均衡、高可用性、sql过滤、读写分离、可路由相关的query到目标数据库，并且安装配置非常简单</p>\n<h5 id=\"2-环境需求\"><a href=\"#2-环境需求\" class=\"headerlink\" title=\"2.环境需求\"></a>2.环境需求</h5><p>安装环境：</p>\n<ul>\n<li>CentOS Linux release 7.6.1810 (Core)</li>\n<li>JDK : Java SE Development Kit 8u211</li>\n<li>MySQL : 8.0.16</li>\n</ul>\n<p>TIPS: #Amoeba框架是居于JDK1.5开发的，采用了JDK1.5的特性，所以还需要安装java环境，建议使用javaSE1.5以上的JDK版本</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>系统IP</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>MYSQL</td>\n<td>192.168.1.100</td>\n<td>单机多实例化3306/3307</td>\n</tr>\n<tr>\n<td>Amoeba</td>\n<td>192.168.1.101</td>\n<td>Amoeba主机和phpMyadmin主机</td>\n</tr>\n</tbody>\n</table>\n<p><strong>环境安装</strong><br>Step1. MySQL安装以及主从复制搭建,这里看前面的主从多实例配置文章即可;<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601192019.png\" alt=\"WeiyiGeek.MYSQL8.0\" title=\"\" class=\"\">\n                <p>WeiyiGeek.MYSQL8.0</p>\n            </figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#解压二进制包</span></span><br><span class=\"line\">xz -d mysql-8.0.16-linux-glibc2.12-x86_64.tar.xz </span><br><span class=\"line\">tar xf mysql-8.0.16-linux-glibc2.12-x86_64.tar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#建立mysql数据库用户</span></span><br><span class=\"line\">useradd mysq</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#建立软连接</span></span><br><span class=\"line\">ln -s /opt/mysql8/bin/* /usr/<span class=\"built_in\">local</span>/bin/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#多实例目录</span></span><br><span class=\"line\">mkdir -vp /data/&#123;&#123;3307,3306&#125;/&#123;data,tmp,binlog,innodb_ts,innodb_log,undo&#125;,backup,scripts&#125;</span><br><span class=\"line\">mkdir: 已创建目录 <span class=\"string\">\"/data\"</span></span><br><span class=\"line\">mkdir: 已创建目录 <span class=\"string\">\"/data/3307\"</span></span><br><span class=\"line\">mkdir: 已创建目录 <span class=\"string\">\"/data/3307/data\"</span></span><br><span class=\"line\">mkdir: 已创建目录 <span class=\"string\">\"/data/3307/tmp\"</span></span><br><span class=\"line\">mkdir: 已创建目录 <span class=\"string\">\"/data/3307/binlog\"</span></span><br><span class=\"line\">mkdir: 已创建目录 <span class=\"string\">\"/data/3307/innodb_ts\"</span></span><br><span class=\"line\"><span class=\"comment\">#非常重要</span></span><br><span class=\"line\">chown -R mysql:mysql /data</span><br><span class=\"line\">chown -R mysql:mysql /opt/mysql8</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#8.x多实例 my.cnf配置</span></span><br><span class=\"line\">[client]</span><br><span class=\"line\">default-character-set=utf8   <span class=\"comment\"># 设置mysql客户端默认字符集</span></span><br><span class=\"line\">port = 3306</span><br><span class=\"line\">socket = /data/3306/mysql.sock</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The MySQL server</span></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">port = 3306</span><br><span class=\"line\">mysqlx_port = 33060</span><br><span class=\"line\">user = mysql</span><br><span class=\"line\">server-id = 3306</span><br><span class=\"line\">socket = /data/3306/mysql.sock</span><br><span class=\"line\">mysqlx_socket=/data/3306/mysqlx.sock</span><br><span class=\"line\">pid-file = /data/3306/mysql.pid</span><br><span class=\"line\">basedir = /opt/mysql8/</span><br><span class=\"line\">datadir = /data/3306/data</span><br><span class=\"line\">tmpdir = /data/3306/tmp <span class=\"comment\">#非必须</span></span><br><span class=\"line\"><span class=\"built_in\">log</span>-bin = /data/3306/binlog/mysql-bin  <span class=\"comment\">#从库建议关闭log-bin</span></span><br><span class=\"line\"><span class=\"built_in\">log</span>-error = /data/3306/mysqlerror.log</span><br><span class=\"line\">explicit_defaults_for_timestamp</span><br><span class=\"line\">character-set-server=utf8  <span class=\"comment\">#服务端默认字符集</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#初始化实例与启动数据库：</span></span><br><span class=\"line\">mysqld --defaults-file=/data/3307/my.cnf --initialize --user=mysql --basedir=/opt/mysql8</span><br><span class=\"line\">mysqld --defaults-file=/data/3306/my.cnf --initialize --user=mysql --basedir=/opt/mysql8</span><br><span class=\"line\">mysqld_safe --defaults-file=/data/3306/my.cnf --user=mysql&amp;</span><br><span class=\"line\">mysqld_safe --defaults-file=/data/3307/my.cnf --user=mysql&amp;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#账户密码在mysqlerror.log</span></span><br><span class=\"line\">3306：root@localhost: W=!_hK2qjlFl</span><br><span class=\"line\">3307：root@localhost: l7OuDBq_2zQj</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 端口启动验证</span></span><br><span class=\"line\">netstat -tlnp | grep <span class=\"string\">\"mysql\"</span></span><br><span class=\"line\">tcp6       0      0 :::3306                 :::*                    LISTEN      10402/mysqld</span><br><span class=\"line\">tcp6       0      0 :::3307                 :::*                    LISTEN      10102/mysqld</span><br><span class=\"line\">tcp6       0      0 :::33070                :::*                    LISTEN      10102/mysqld</span><br><span class=\"line\">tcp6       0      0 :::33060                :::*                    LISTEN      10402/mysqld</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; ALTER USER USER() IDENTIFIED BY <span class=\"string\">'/weiye!@#888'</span>;</span><br><span class=\"line\">Query OK, 0 rows affected (0.20 sec)</span><br><span class=\"line\">mysql&gt; flush privileges;</span><br><span class=\"line\">Query OK, 0 rows affected (0.01 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##mysql 8.0 主从账户</span></span><br><span class=\"line\">CREATE USER <span class=\"string\">'rep'</span>@<span class=\"string\">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class=\"string\">'System123@'</span>; </span><br><span class=\"line\">GRANT REPLICATION SLAVE ON *.* TO <span class=\"string\">'rep'</span>@<span class=\"string\">'%'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#获取主节点当前binary log文件名和位置（position）- 不再导入以前的库</span></span><br><span class=\"line\">MASTER&gt; SHOW MASTER STATUS;</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">| mysql-bin.000002 |     1659 |              |                  |                   |</span><br><span class=\"line\">+------------------+----------+--------------+------------------+-------------------+</span><br><span class=\"line\">1 row <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.09 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在从（Slave）节点上设置主节点参数 并启动主从（不用导入以前的库）</span></span><br><span class=\"line\">CHANGE MASTER TO MASTER_HOST=<span class=\"string\">'192.168.1.100'</span>,</span><br><span class=\"line\">MASTER_USER=<span class=\"string\">'rep'</span>,</span><br><span class=\"line\">MASTER_PASSWORD=<span class=\"string\">'System123@'</span>,</span><br><span class=\"line\">MASTER_LOG_FILE=<span class=\"string\">'mysql-bin.000002'</span>,</span><br><span class=\"line\">MASTER_LOG_POS=1659;</span><br><span class=\"line\"><span class=\"comment\">#开启从库</span></span><br><span class=\"line\">start slave;</span><br><span class=\"line\"><span class=\"comment\">#主从开启成功</span></span><br><span class=\"line\">mysql&gt; show slave status\\G;</span><br><span class=\"line\">*************************** 1. row ***************************</span><br><span class=\"line\">               Slave_IO_State: Waiting <span class=\"keyword\">for</span> master to send event</span><br><span class=\"line\">                  Master_Host: 192.168.1.100</span><br><span class=\"line\">                  Master_User: rep</span><br><span class=\"line\">                  Master_Port: 3306</span><br><span class=\"line\">                Connect_Retry: 60</span><br><span class=\"line\">              Master_Log_File: mysql-bin.000002</span><br><span class=\"line\">          Read_Master_Log_Pos: 1659</span><br><span class=\"line\">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class=\"line\">                Relay_Log_Pos: 322</span><br><span class=\"line\">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class=\"line\">             Slave_IO_Running: Yes</span><br><span class=\"line\">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601212228.png\" alt=\"WeiyiGeek.成功登陆\" title=\"\" class=\"\">\n                <p>WeiyiGeek.成功登陆</p>\n            </figure>\n<p>Step2. 在Amoeba机器上安装JDK及配置环境：(CENTOS7安装jdk)<br>下载地址：<a href=\"https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html\" target=\"_blank\" rel=\"noopener\">https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190601191541.png\" alt=\"WeiyiGeek.JDK64位\" title=\"\" class=\"\">\n                <p>WeiyiGeek.JDK64位</p>\n            </figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.下载Linux x64\t185.96 MB  \tjdk-8u211-linux-x64.tar.gz 上传到opt目录并解压</span></span><br><span class=\"line\"><span class=\"variable\">$tar</span> -zxf jdk-8u211-linux-x64.tar.gz</span><br><span class=\"line\"><span class=\"variable\">$ls</span></span><br><span class=\"line\">jdk1.8.0_211  jdk-8u211-linux-x64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.添加java的环境变量(非常重要)并刷新环境变量</span></span><br><span class=\"line\"><span class=\"variable\">$vi</span> /etc/profile </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Java Env</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_HOME=/opt/jdk1.8.0_211</span><br><span class=\"line\"><span class=\"built_in\">export</span> CLASSPATH=.:<span class=\"variable\">$JAVA_HOME</span>/lib/dt.jar:<span class=\"variable\">$JAVA_HOME</span>/lib/tools.jar</span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$JAVA_HOME</span>/bin</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#更新环境变量</span></span><br><span class=\"line\"><span class=\"variable\">$source</span> /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.查看JDK版本(如果不存在执行权限就添加)</span></span><br><span class=\"line\">java -version</span><br><span class=\"line\">java version <span class=\"string\">\"1.8.0_211\"</span></span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_211-b12)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)</span><br></pre></td></tr></table></figure>\n<p>Step3. 安装amoeba软件(已经停止开发了-2013年版本3.0.5)<br>下载地址：<a href=\"https://datapacket.dl.sourceforge.net/project/amoeba/Amoeba%20for%20mysql/2.2.x/amoeba-mysql-binary-2.2.0.tar.gz\" target=\"_blank\" rel=\"noopener\">https://datapacket.dl.sourceforge.net/project/amoeba/Amoeba%20for%20mysql/2.2.x/amoeba-mysql-binary-2.2.0.tar.gz</a><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$tar</span> -zxf amoeba-mysql-binary-2.2.0.tar.gz &amp;&amp; ll</span><br><span class=\"line\">-rw-r--r--. 1 root root 3161433 6月   2 01:00 amoeba-mysql-binary-2.2.0.tar.gz</span><br><span class=\"line\">drwxr-xr-x. 2 root root      63 6月   2 01:00 benchmark</span><br><span class=\"line\">drwxr-xr-x. 2 root root     131 2月  29 2012 bin</span><br><span class=\"line\">-rw-r--r--. 1 root root    3976 8月  29 2012 changelogs.txt</span><br><span class=\"line\">drwxr-xr-x. 2 root root     243 6月   2 01:00 conf</span><br><span class=\"line\">drwxr-xr-x. 3 root root    4096 6月   2 01:00 lib</span><br><span class=\"line\">-rw-r--r--. 1 root root   34520 8月  29 2012 LICENSE.txt</span><br><span class=\"line\">-rw-r--r--. 1 root root    2031 8月  29 2012 README.html</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"3-实际案例\"><a href=\"#3-实际案例\" class=\"headerlink\" title=\"3.实际案例\"></a>3.实际案例</h5><p>Step0. 分别在主从库创建mysqlproxy用户<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE USER <span class=\"string\">'mysqlproxy'</span>@<span class=\"string\">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class=\"string\">'System123@'</span>; <span class=\"comment\">#注意加密方式,不加默认是 Authentication plugin 'caching_sha2_password</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#主库（插入测试数据）</span></span><br><span class=\"line\">GRANT INSERT ON demo.* TO <span class=\"string\">'mysqlproxy'</span>@<span class=\"string\">'%'</span> ;</span><br><span class=\"line\">mysql&gt; insert into demo.user value (1,<span class=\"string\">'weiyigekk'</span>),(2,<span class=\"string\">'k9s'</span>),(3,<span class=\"string\">'docker'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#从库(执行)</span></span><br><span class=\"line\">GRANT select ON demo.* TO <span class=\"string\">'mysqlproxy'</span>@<span class=\"string\">'%'</span>;</span><br></pre></td></tr></table></figure></p>\n<p>Step1. 修改配置文件 dbServer.xml 文件在 amoeba/conf/目录下<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 数据库连接配置的公共部分 --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dbServer</span> <span class=\"attr\">name</span>=<span class=\"string\">\"abstractServer\"</span> <span class=\"attr\">abstractive</span>=<span class=\"string\">\"true\"</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">factoryConfig</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.mysql.net.MysqlServerConnectionFactory\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"manager\"</span>&gt;</span>$&#123;defaultManager&#125;<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sendBufferSize\"</span>&gt;</span>64<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"receiveBufferSize\"</span>&gt;</span>128<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- mysql port 端口号 --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"port\"</span>&gt;</span>3306<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- mysql schema amoeba 访问主从数据库真实库--&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"schema\"</span>&gt;</span>demo<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- mysql user 主从数据库分配给Amoeba访问数据的用户名 --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"user\"</span>&gt;</span>mysqlproxy<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!--  mysql password 主从数据库分配给Amoeba访问数据的密码--&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"password\"</span>&gt;</span>System123@<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">factoryConfig</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">poolConfig</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.net.poolable.PoolableObjectPool\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"maxActive\"</span>&gt;</span>500<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"maxIdle\"</span>&gt;</span>500<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"minIdle\"</span>&gt;</span>10<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"minEvictableIdleTimeMillis\"</span>&gt;</span>600000<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"timeBetweenEvictionRunsMillis\"</span>&gt;</span>600000<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"testOnBorrow\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"testWhileIdle\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">poolConfig</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dbServer</span>&gt;</span></span><br><span class=\"line\">       <span class=\"comment\">&lt;!-- Master 的独立部分，也就只有 IP 了这里 写了主机名 由于我是单机多实例所有填写一样的IP --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dbServer</span> <span class=\"attr\">name</span>=<span class=\"string\">\"master\"</span>  <span class=\"attr\">parent</span>=<span class=\"string\">\"abstractServer\"</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">factoryConfig</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- mysql ip --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ipAddress\"</span>&gt;</span>192.168.1.100<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">factoryConfig</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dbServer</span>&gt;</span></span><br><span class=\"line\">       <span class=\"comment\">&lt;!-- Slave 的独立部分，也就只有 IP 了这里 写了主机名 ,如果有多个Slave服务器，可以配置多个dbServer --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dbServer</span> <span class=\"attr\">name</span>=<span class=\"string\">\"slave\"</span>  <span class=\"attr\">parent</span>=<span class=\"string\">\"abstractServer\"</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">factoryConfig</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- mysql ip --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ipAddress\"</span>&gt;</span>192.168.1.100<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">factoryConfig</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dbServer</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">&lt;!-- 数据库池，虚拟服务器，实现读取的负载均衡，如果有多个Slave，则&lt;property name=\"poolNames\"&gt;slave1,slave2&lt;/property&gt;用逗号隔开 --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dbServer</span> <span class=\"attr\">name</span>=<span class=\"string\">\"slaves\"</span> <span class=\"attr\">virtual</span>=<span class=\"string\">\"true\"</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">poolConfig</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.server.MultipleServerPool\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- Load balancing strategy: 1=ROUNDROBIN , 2=WEIGHTBASED , 3=HA--&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"loadbalance\"</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- Separated by commas,such as: server1,server2,server1 --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"poolNames\"</span>&gt;</span>slave<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">poolConfig</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dbServer</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>Step2. 修改amoeba.xml文件，设置读写分离<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">proxy</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"comment\">&lt;!-- service class must implements com.meidusa.amoeba.service.Service --&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">service</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Amoeba for Mysql\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.net.ServerableConnectionManager\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- Amoeba 端口号 ，客户端client 链接amoeba端口号，不能和主从数据库 冲突--&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"port\"</span>&gt;</span>8066<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- bind ipAddress --&gt;</span></span><br><span class=\"line\">                      <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ipAddress\"</span>&gt;</span>192.168.1.100<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">       </span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"manager\"</span>&gt;</span>$&#123;clientConnectioneManager&#125;<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"connectionFactory\"</span>&gt;</span></span><br><span class=\"line\">                               <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.mysql.net.MysqlClientConnectionFactory\"</span>&gt;</span></span><br><span class=\"line\">                                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sendBufferSize\"</span>&gt;</span>128<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"receiveBufferSize\"</span>&gt;</span>64<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                               <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"authenticator\"</span>&gt;</span></span><br><span class=\"line\">                               <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.mysql.server.MysqlClientAuthenticator\"</span>&gt;</span></span><br><span class=\"line\">                                       <span class=\"comment\">&lt;!-- Amoeba 账号 ，客户端client 链接amoeba端 账号--&gt;</span></span><br><span class=\"line\">                                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"user\"</span>&gt;</span>root<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                                       <span class=\"comment\">&lt;!-- Amoeba 账号 ，客户端client 链接amoeba端 密码--&gt;</span></span><br><span class=\"line\">                                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"password\"</span>&gt;</span>root<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"filter\"</span>&gt;</span></span><br><span class=\"line\">                                               <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.server.IPAccessController\"</span>&gt;</span></span><br><span class=\"line\">                                                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ipFile\"</span>&gt;</span>$&#123;amoeba.home&#125;/conf/access_list.conf<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                                               <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">                                       <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                               <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">service</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"comment\">&lt;!-- server class must implements com.meidusa.amoeba.service.Service --&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">service</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Amoeba Monitor Server\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.monitor.MonitorServer\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- port --&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!--  default value: random number</span></span><br><span class=\"line\"><span class=\"comment\">                       &lt;property name=\"port\"&gt;9066&lt;/property&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                       --&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- bind ipAddress --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ipAddress\"</span>&gt;</span>192.168.1.100<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"daemon\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"manager\"</span>&gt;</span>$&#123;clientConnectioneManager&#125;<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"connectionFactory\"</span>&gt;</span></span><br><span class=\"line\">                               <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.monitor.net.MonitorClientConnectionFactory\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">service</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">runtime</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.mysql.context.MysqlRuntimeContext\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- proxy server net IO Read thread size --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"readThreadPoolSize\"</span>&gt;</span>20<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- proxy server client process thread size --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"clientSideThreadPoolSize\"</span>&gt;</span>30<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- mysql server data packet process thread size --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"serverSideThreadPoolSize\"</span>&gt;</span>30<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- per connection cache prepared statement size  --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"statementCacheSize\"</span>&gt;</span>500<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!-- query timeout( default: 60 second , TimeUnit:second) --&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"queryTimeout\"</span>&gt;</span>60<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">runtime</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">proxy</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">               Each ConnectionManager will start as thread</span></span><br><span class=\"line\"><span class=\"comment\">               manager responsible for the Connection IO read , Death Detection</span></span><br><span class=\"line\"><span class=\"comment\">       --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">connectionManagerList</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">connectionManager</span> <span class=\"attr\">name</span>=<span class=\"string\">\"clientConnectioneManager\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.net.MultiConnectionManagerWrapper\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"subManagerClassName\"</span>&gt;</span>com.meidusa.amoeba.net.ConnectionManager<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">                         default value is avaliable Processors</span></span><br><span class=\"line\"><span class=\"comment\">                       &lt;property name=\"processors\"&gt;5&lt;/property&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        --&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">connectionManager</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">connectionManager</span> <span class=\"attr\">name</span>=<span class=\"string\">\"defaultManager\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.net.MultiConnectionManagerWrapper\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"subManagerClassName\"</span>&gt;</span>com.meidusa.amoeba.net.AuthingableConnectionManager<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                       <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">                         default value is avaliable Processors</span></span><br><span class=\"line\"><span class=\"comment\">                       &lt;property name=\"processors\"&gt;5&lt;/property&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        --&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">connectionManager</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">connectionManagerList</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"comment\">&lt;!-- default using file loader --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dbServerLoader</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.context.DBServerConfigFileLoader\"</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"configFile\"</span>&gt;</span>$&#123;amoeba.home&#125;/conf/dbServers.xml<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dbServerLoader</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">queryRouter</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.mysql.parser.MysqlQueryRouter\"</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ruleLoader\"</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">\"com.meidusa.amoeba.route.TableRuleFileLoader\"</span>&gt;</span></span><br><span class=\"line\">                               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ruleFile\"</span>&gt;</span>$&#123;amoeba.home&#125;/conf/rule.xml<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"functionFile\"</span>&gt;</span>$&#123;amoeba.home&#125;/conf/ruleFunctionMap.xml<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">                       <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sqlFunctionFile\"</span>&gt;</span>$&#123;amoeba.home&#125;/conf/functionMap.xml<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"LRUMapSize\"</span>&gt;</span>1500<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">               <span class=\"comment\">&lt;!-- 默认数据库，主数据库 --&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"defaultPool\"</span>&gt;</span>master<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"comment\">&lt;!-- 写数据库 / 读数据库，dbServer.xml 中配置的 虚拟数据库，数据库池 --&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"writePool\"</span>&gt;</span>master<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"readPool\"</span>&gt;</span>slaves<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"needParse\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">queryRouter</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>Step3. 启动amoeba启动失败了，原因 Amoeba 启动 指定的堆栈大小太小,指定至少228k；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./amoeba</span><br><span class=\"line\">The stack size specified is too small, Specify at least 228k</span><br><span class=\"line\">Error: Could not create the Java Virtual Machine.</span><br><span class=\"line\">Error: A fatal exception has occurred. Program will <span class=\"built_in\">exit</span>.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解决办法 ：</span></span><br><span class=\"line\">打开bin/amoeba，DEFAULT_OPTS=”-server -Xms256m -Xmx256m -Xss128k”改成：DEFAULT_OPTS=<span class=\"string\">\"-server -Xms512m -Xmx512m -Xmn100m -Xss1204k\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#再次启动</span></span><br><span class=\"line\">./amoeba start</span><br><span class=\"line\">log4j:WARN log4j config load completed from file:/opt/amoeba/conf/log4j.xml</span><br><span class=\"line\">2019-06-02 01:08:48,521 INFO  context.MysqlRuntimeContext - Amoeba <span class=\"keyword\">for</span> Mysql current versoin=5.1.45-mysql-amoeba-proxy-2.2.0</span><br><span class=\"line\">log4j:WARN ip access config load completed from file:/opt/amoeba/conf/access_list.conf</span><br><span class=\"line\">2019-06-02 01:08:49,517 INFO  net.ServerableConnectionManager - Amoeba <span class=\"keyword\">for</span> Mysql listening on /192.168.1.101:8066.</span><br><span class=\"line\">2019-06-02 01:08:49,522 INFO  net.ServerableConnectionManager - Amoeba Monitor Server listening on /192.168.1.101:39401.</span><br></pre></td></tr></table></figure></p>\n<p>Step 4.读写分离测试<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#在amoeba机器上执行 (注意amoeba客户端端口-在上面的配置文件里面)</span></span><br><span class=\"line\">mysql -h 192.168.1.101 -P8066 -uroot -proot</span><br><span class=\"line\">Welcome to the MariaDB monitor.  Commands end with ; or \\g.</span><br><span class=\"line\">Your MySQL connection id is 1186796719</span><br><span class=\"line\">Server version: 5.1.45-mysql-amoeba-proxy-2.2.0  <span class=\"comment\">#注意观察这里不一样</span></span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; insert into demo.user value(5,<span class=\"string\">'zhangwei'</span>);</span><br><span class=\"line\">Query OK, 1 row affected (0.10 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">主从mysql&gt; select * from user;</span><br><span class=\"line\">+----+-----------+</span><br><span class=\"line\">| id | name      |</span><br><span class=\"line\">+----+-----------+</span><br><span class=\"line\">|  1 | weiyigekk |</span><br><span class=\"line\">|  2 | k9s       |</span><br><span class=\"line\">|  3 | docker    |</span><br><span class=\"line\">|  5 | zhangwei  |</span><br><span class=\"line\">+----+-----------+</span><br><span class=\"line\">4 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.01 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#下面关闭slave</span></span><br><span class=\"line\">mysql&gt; stop slave;</span><br><span class=\"line\">mysql&gt; insert into demo.user value(4,<span class=\"string\">'this is slave insert'</span>);</span><br><span class=\"line\">Query OK, 1 row affected (0.02 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#采用amoeba进行读取</span></span><br><span class=\"line\">MySQL [(none)]&gt; select * from demo.user;</span><br><span class=\"line\">+----+----------------------+</span><br><span class=\"line\">| id | name                 |</span><br><span class=\"line\">+----+----------------------+</span><br><span class=\"line\">|  1 | weiyigekk            |</span><br><span class=\"line\">|  2 | k9s                  |</span><br><span class=\"line\">|  3 | docker               |</span><br><span class=\"line\">|  5 | zhangwei             |</span><br><span class=\"line\">|  4 | this is slave insert |</span><br><span class=\"line\">+----+----------------------+</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602012918.png\" alt=\"WeiyiGeek.mysql\" title=\"\" class=\"\">\n                <p>WeiyiGeek.mysql</p>\n            </figure></p>\n<hr/>\n\n<h4 id=\"0x02-mysql-proxy实现读写分离\"><a href=\"#0x02-mysql-proxy实现读写分离\" class=\"headerlink\" title=\"0x02 mysql-proxy实现读写分离\"></a>0x02 mysql-proxy实现读写分离</h4><h5 id=\"1-简介-1\"><a href=\"#1-简介-1\" class=\"headerlink\" title=\"1. 简介\"></a>1. 简介</h5><p>前言：在实际的生产环境中由单台Mysql作为独立的数据库是完全不能满足实际需求的无论是在安全性，高可用性以及高并发等各个方面;<br>常常在大规模集群中通过主从复制（Master-Slave）的方式来同步数据，再通过读写分离（MySQL-Proxy）来提升数据库的并发负载能力,常使用这样的方案来进行部署与实施的。</p>\n<p>MySQL-proxy 是通过网络利用MySQL的网络协议,并且提供一个或多个MySQL服务器与一个或多个MySQL客户端相互沟通的程序,又因为MySQL-Proxy使用MySQL网络协议,所以它兼容任何MySQL客户端并且无需修改,其功能：</p>\n<ul>\n<li>MySQL-Proxy 可以在查询队列发送到服务器之前插入一些查询请求</li>\n<li>MySQL-Proxy 可以在服务器应答中将对应的应答删除</li>\n<li>管理员可以对每个查询进行跟踪并获取报告,如监控其执行时间或其他调试信息,并分别记录,同时还能降正确应答返还给客户端：</li>\n</ul>\n<p>MySQL-Proxy的读写分离主要是通过lua脚本实现的因此需要安装lua(后面会进行相应安装的介绍),并且从设定上将lua分为两类：</p>\n<ul>\n<li>一类负责管理模块的控制,对应参数admin-lua-script</li>\n<li>另一类负责代理模块控制,对应参数proxy-lua-script<br>两类脚本的编码规则完全相同,只是对应功能有差异,管理模块侧重与代理服务器相关状态的控制,代理模块则侧重于客户端的CRUD操作;</li>\n</ul>\n<p>TIPS: 貌似只有alpha版本,可能不稳定不建议在实际环境中使用;</p>\n<hr>\n\n<h5 id=\"2-安装环境\"><a href=\"#2-安装环境\" class=\"headerlink\" title=\"2. 安装环境\"></a>2. 安装环境</h5><p><em>环境准备</em>：</p>\n<ul>\n<li>系统：</li>\n<li>lua版本: <a href=\"http://www.lua.org/ftp/lua-5.3.5.tar.gz\" target=\"_blank\" rel=\"noopener\">http://www.lua.org/ftp/lua-5.3.5.tar.gz</a></li>\n<li>mysql-proxy版本：0.8.5 </li>\n</ul>\n<p><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602183824.png\" alt=\"WeiyiGeek.\"></p>\n<p><em>场景描述：</em></p>\n<ul>\n<li>192.168.1.100:3306/3307：数据库Master主服务器/Slave从服务器</li>\n<li>192.168.1.101:4040/4041：MySQL-Proxy调度服务器（客户端/管理端） </li>\n</ul>\n<p><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602180508.png\" alt=\"WeiyiGeek.场景接收\"></p>\n<p><strong>环境安装：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1. MySQL-Proxy上安装所需软件包</span></span><br><span class=\"line\">yum install -y gcc* gcc-c++* autoconf* automake* zlib* libxml* ncurses-devel* libmcrypt* libtool* flex* pkgconfig* libevent* glib* readline-devel*</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2. 编译安装LUA</span></span><br><span class=\"line\"><span class=\"comment\">#从http://www.lua.org/download.html下载源码包并安装</span></span><br><span class=\"line\">wget http://www.lua.org/ftp/lua-5.3.5.tar.gz -O /opt/</span><br><span class=\"line\">tar -zxf lua-5.3.5.tar.gz &amp;&amp; <span class=\"built_in\">cd</span> lua-5.3.5</span><br><span class=\"line\">make linux &amp;&amp; make install  <span class=\"comment\">#注意发生错误的先执行make clean 编译过程中遗留的文件</span></span><br><span class=\"line\"><span class=\"comment\"># make[1]: 进入目录“/opt/lua-5.3.5/src”</span></span><br><span class=\"line\"><span class=\"comment\"># make all SYSCFLAGS=\"-DLUA_USE_LINUX\" SYSLIBS=\"-Wl,-E -ldl -lreadline\"</span></span><br><span class=\"line\"><span class=\"comment\"># make[2]: 进入目录“/opt/lua-5.3.5/src”</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3. 下载mysql-proxy的二进制包解压并复制</span></span><br><span class=\"line\">wget https://downloads.mysql.com/archives/get/file/mysql-proxy-0.8.5-linux-glibc2.3-x86-64bit.tar.gz</span><br><span class=\"line\">tar -zxf mysql-proxy-0.8.5-linux-glibc2.3-x86-64bit.tar.gz</span><br><span class=\"line\">mv mysql-proxy-0.8.5-linux-glibc2.3-x86-64bit/ mysql-proxy/</span><br><span class=\"line\"><span class=\"built_in\">cd</span> mysql-proxy</span><br><span class=\"line\">mkdir lua logs  <span class=\"comment\">#创建脚本存放目录/与日志文件</span></span><br><span class=\"line\">cp share/doc/mysql-proxy/rw-splitting.lua ./lua/</span><br><span class=\"line\">cp share/doc/mysql-proxy/admin-sql.lua ./lua/</span><br></pre></td></tr></table></figure><br><br/><br>Step 3. 配置修改<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.创建配置文件</span></span><br><span class=\"line\">vi /etc/mysql-proxy.cnf   <span class=\"comment\">#创建配置文件</span></span><br><span class=\"line\">[mysql-proxy]</span><br><span class=\"line\">user=root </span><br><span class=\"line\"><span class=\"comment\">#运行mysql-proxy用户</span></span><br><span class=\"line\">admin-username=admin </span><br><span class=\"line\"><span class=\"comment\">#主从mysql共有的用户</span></span><br><span class=\"line\">admin-password=admin</span><br><span class=\"line\"><span class=\"comment\">#用户的密码</span></span><br><span class=\"line\">proxy-address=192.168.1.101:4040</span><br><span class=\"line\"><span class=\"comment\">#mysql-proxy运行ip和端口，不加端口，默认4040 ip:port</span></span><br><span class=\"line\">proxy-read-only-backend-addresses=192.168.1.100:3307</span><br><span class=\"line\"><span class=\"comment\">#指定后端从slave读取数据 ip:port （简写  -r）</span></span><br><span class=\"line\">proxy-backend-addresses=192.168.1.100:3306 </span><br><span class=\"line\"><span class=\"comment\">#指定后端主master写入数据 （简写  -b）</span></span><br><span class=\"line\">proxy-lua-script=/opt/mysql-proxy/lua/rw-splitting.lua</span><br><span class=\"line\"><span class=\"comment\">#指定读写分离配置文件位置</span></span><br><span class=\"line\">admin-lua-script=/opt/mysql-proxy/lua/admin-sql.lua</span><br><span class=\"line\"><span class=\"comment\">#指定管理脚本</span></span><br><span class=\"line\"><span class=\"built_in\">log</span>-file=/opt/mysql-proxy/logs/mysql-proxy.log </span><br><span class=\"line\"><span class=\"comment\">#日志位置</span></span><br><span class=\"line\"><span class=\"built_in\">log</span>-level=info</span><br><span class=\"line\"><span class=\"comment\">#定义log日志级别，由高到低分别有(error|warning|info|message|debug)</span></span><br><span class=\"line\">pid-file=/opt/mysql-proxy/mysql-proxy.pid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.修改读写分离脚本//修改默认连接，进行快速测试，不修改的话要达到连接数为4时才启用读写分离</span></span><br><span class=\"line\"><span class=\"variable\">$vi</span> /opt/mysql-proxy/lua/rw-splitting.lua </span><br><span class=\"line\"><span class=\"keyword\">if</span> not proxy.global.config.rwsplit <span class=\"keyword\">then</span></span><br><span class=\"line\">        proxy.global.config.rwsplit = &#123;</span><br><span class=\"line\">                min_idle_connections = 1, <span class=\"comment\">##默认超过4个连接数时，才开始读写分离改为1</span></span><br><span class=\"line\">                max_idle_connections = 1, <span class=\"comment\">#默认为8</span></span><br><span class=\"line\">                is_debug = <span class=\"literal\">false</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">end</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.手动启用并且验证是否启用</span></span><br><span class=\"line\">chmod 600 /etc/mysql-proxy.cnf </span><br><span class=\"line\">/opt/mysql-proxy/bin/mysql-proxy --defaults-file=/etc/mysql-proxy.cnf</span><br><span class=\"line\"><span class=\"comment\">#支持的选项</span></span><br><span class=\"line\"><span class=\"comment\"># --daemon \\ //定义以守护进程模式启动</span></span><br><span class=\"line\"><span class=\"comment\"># --keepalive \\ //使进程在异常关闭后能够自动恢复</span></span><br><span class=\"line\"><span class=\"comment\"># --pid-file=$PROXY_PID \\ //定义mysql-proxy PID文件路径</span></span><br><span class=\"line\"><span class=\"comment\"># --user=mysql \\ //以mysql用户身份启动服务</span></span><br><span class=\"line\"><span class=\"comment\"># --log-level=warning \\ //定义log日志级别，由高到低分别有(error|warning|info|message|debug)</span></span><br><span class=\"line\"><span class=\"comment\"># --log-file=/opt/mysql-proxy/log/mysql-proxy.log //定义log日志文件路径</span></span><br><span class=\"line\"></span><br><span class=\"line\">netstat -tupln | grep 4040 <span class=\"comment\">#已经启动</span></span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class=\"line\">tcp        0      0 192.168.1.101:4040      0.0.0.0:*               LISTEN      10767/mysql-proxy</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">killall -9 mysql-proxy <span class=\"comment\">#关闭mysql-proxy使用</span></span><br></pre></td></tr></table></figure></p>\n<p><br/><br>4.或者创建mysql-proxy服务管理脚本<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$vi &#x2F;etc&#x2F;init.d&#x2F;mysql-proxy</span><br><span class=\"line\">#!&#x2F;bin&#x2F;sh</span><br><span class=\"line\"># mysql-proxy This script starts and stops the mysql-proxy daemon</span><br><span class=\"line\"># chkconfig: - 78 30</span><br><span class=\"line\"># processname: mysql-proxy</span><br><span class=\"line\"># description: mysql-proxy is a proxy daemon to mysql</span><br><span class=\"line\"># Source function library.</span><br><span class=\"line\">. &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;functions</span><br><span class=\"line\"></span><br><span class=\"line\">#定义mysql-proxy服务二进制文件路径 </span><br><span class=\"line\">PROXY_PATH&#x3D;&#x2F;opt&#x2F;mysql-proxy&#x2F;bin</span><br><span class=\"line\">prog&#x3D;&quot;mysql-proxy&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Source networking configuration.</span><br><span class=\"line\">. &#x2F;etc&#x2F;sysconfig&#x2F;network</span><br><span class=\"line\"># Check that networking is up.</span><br><span class=\"line\">#[ $&#123;NETWORKING&#125; &#x3D;&#x3D; &quot;no&quot; ] &amp;&amp; exit 0</span><br><span class=\"line\"></span><br><span class=\"line\">#设置默认mysql-proxy选项(也可以采用配置文件的形式 -b为mater -r 指定slave) </span><br><span class=\"line\">PROXY_OPTIONS&#x3D;&quot;--log-level&#x3D;info \\</span><br><span class=\"line\">--plugins&#x3D;proxy -b 192.168.1.100:3306 -r 192.168.1.100:3307 \\</span><br><span class=\"line\">--proxy-lua-script&#x3D;&#x2F;opt&#x2F;mysql-proxy&#x2F;lua&#x2F;rw-splitting.lua \\</span><br><span class=\"line\">--plugins&#x3D;admin \\</span><br><span class=\"line\">--admin-username&#x3D;admin \\</span><br><span class=\"line\">--admin-password&#x3D;admin \\</span><br><span class=\"line\">--admin-lua-script&#x3D;&#x2F;opt&#x2F;mysql-proxy&#x2F;lib&#x2F;mysql-proxy&#x2F;lua&#x2F;admin.lua&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#pid文件路径</span><br><span class=\"line\">PROXY_PID&#x3D;&#x2F;opt&#x2F;mysql-proxy&#x2F;mysql-proxy.pid</span><br><span class=\"line\"></span><br><span class=\"line\"># Source mysql-proxy configuration.</span><br><span class=\"line\">if [ -f &#x2F;etc&#x2F;sysconfig&#x2F;mysql-proxy ]; then</span><br><span class=\"line\">        . &#x2F;etc&#x2F;sysconfig&#x2F;mysql-proxy</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">PATH&#x3D;$PATH:&#x2F;usr&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;bin:$PROXY_PATH</span><br><span class=\"line\"># By default it&#39;s all good</span><br><span class=\"line\">RETVAL&#x3D;0</span><br><span class=\"line\"></span><br><span class=\"line\"># See how we were called.</span><br><span class=\"line\">case &quot;$1&quot; in</span><br><span class=\"line\">  start)</span><br><span class=\"line\">        # Start daemon.</span><br><span class=\"line\">        echo -n $&quot;Starting $prog: &quot;</span><br><span class=\"line\">        $NICELEVEL $PROXY_PATH&#x2F;mysql-proxy $PROXY_OPTIONS --daemon --pid-file&#x3D;$PROXY_PID --user&#x3D;mysql</span><br><span class=\"line\">        RETVAL&#x3D;$?</span><br><span class=\"line\">        echo</span><br><span class=\"line\">        if [ $RETVAL &#x3D; 0 ]; then</span><br><span class=\"line\">                touch &#x2F;var&#x2F;lock&#x2F;subsys&#x2F;mysql-proxy</span><br><span class=\"line\">        fi</span><br><span class=\"line\">       ;;</span><br><span class=\"line\"></span><br><span class=\"line\">  stop)</span><br><span class=\"line\">        # Stop daemons.</span><br><span class=\"line\">        echo -n $&quot;Stopping $prog: &quot;</span><br><span class=\"line\">        killproc $prog</span><br><span class=\"line\">        RETVAL&#x3D;$?</span><br><span class=\"line\">        echo</span><br><span class=\"line\">        if [ $RETVAL &#x3D; 0 ]; then</span><br><span class=\"line\">                rm -f &#x2F;var&#x2F;lock&#x2F;subsys&#x2F;mysql-proxy</span><br><span class=\"line\">                rm -f $PROXY_PID</span><br><span class=\"line\"></span><br><span class=\"line\">        fi</span><br><span class=\"line\">       ;;</span><br><span class=\"line\">  restart)</span><br><span class=\"line\">        $0 stop</span><br><span class=\"line\">        sleep 3</span><br><span class=\"line\">        $0 start</span><br><span class=\"line\">       ;;</span><br><span class=\"line\"></span><br><span class=\"line\">  condrestart)</span><br><span class=\"line\">       [ -e &#x2F;var&#x2F;lock&#x2F;subsys&#x2F;mysql-proxy ] &amp;&amp; $0 restart</span><br><span class=\"line\">      ;;</span><br><span class=\"line\"></span><br><span class=\"line\">  status)</span><br><span class=\"line\">        status mysql-proxy</span><br><span class=\"line\">        RETVAL&#x3D;$?</span><br><span class=\"line\">       ;;</span><br><span class=\"line\">  *)</span><br><span class=\"line\"></span><br><span class=\"line\">        echo &quot;Usage: $0 &#123;start|stop|restart|status|condrestart&#125;&quot;</span><br><span class=\"line\">        RETVAL&#x3D;1</span><br><span class=\"line\">       ;;</span><br><span class=\"line\">esac</span><br><span class=\"line\">exit $RETVAL</span><br></pre></td></tr></table></figure><br><br></p>\n<h5 id=\"3-操作实例\"><a href=\"#3-操作实例\" class=\"headerlink\" title=\"3. 操作实例\"></a>3. 操作实例</h5><p>mysql-proxy读写分离的流程步骤：<br>当在mysql-proxy插入数据时写入到了master上,查询数据是从slave上查看插入主库数据,停止主从后当在slave上插入数据，在mysql-proxy上可以看到,则说明读是从slave上，写是在master上。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.启动nysql-proxy和赋值权限</span></span><br><span class=\"line\">chmod 755 /etc/init.d/mysql-proxy</span><br><span class=\"line\">chmod 600 /etc/mysql-proxy.cnf</span><br><span class=\"line\">/etc/init.d/mysql-proxy start</span><br><span class=\"line\">/etc/init.d/mysql-proxy status</span><br><span class=\"line\"><span class=\"comment\"># ● mysql-proxy.service - SYSV: mysql-proxy is a proxy daemon to mysql</span></span><br><span class=\"line\"><span class=\"comment\">#    Loaded: loaded (/etc/rc.d/init.d/mysql-proxy; bad; vendor preset: disabled)</span></span><br><span class=\"line\"><span class=\"comment\">#    Active: active (running) since 日 2019-06-02 21:29:00 CST; 2s ago</span></span><br><span class=\"line\"></span><br><span class=\"line\">netstat -tlnp</span><br><span class=\"line\"><span class=\"comment\"># Active Internet connections (only servers)</span></span><br><span class=\"line\"><span class=\"comment\"># Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span></span><br><span class=\"line\"><span class=\"comment\"># tcp        0      0 0.0.0.0:4040            0.0.0.0:*               LISTEN      12741/mysql-proxy</span></span><br><span class=\"line\"><span class=\"comment\"># tcp        0      0 0.0.0.0:4041            0.0.0.0:*               LISTEN      12741/mysql-proxy</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.登录主库建立一个test用户从数据库中暂时关闭主从复制的功能</span></span><br><span class=\"line\">%         | <span class=\"built_in\">test</span>             | mysql_native_password |  <span class=\"comment\">#注意认证插件</span></span><br><span class=\"line\">mysql&gt; grant select on *.* to <span class=\"string\">'test'</span>@<span class=\"string\">'%'</span>;  <span class=\"comment\">#从库在停止主从前执行</span></span><br><span class=\"line\">mysql&gt; stop slave;</span><br><span class=\"line\">Query OK, 0 rows affected (0.00 sec)</span><br><span class=\"line\">mysql&gt;flush privileges;</span><br><span class=\"line\">Query OK, 0 rows affected (0.01 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3. 登录mysql-porxy管理段主从查看状态（与/opt/mysql-proxy/lua/rw-splitting.lua 配置文件有关）</span></span><br><span class=\"line\">MySQL [(none)]&gt; SELECT * FROM <span class=\"built_in\">help</span>;</span><br><span class=\"line\">+------------------------+------------------------------------+</span><br><span class=\"line\">| <span class=\"built_in\">command</span>                | description                        |</span><br><span class=\"line\">+------------------------+------------------------------------+</span><br><span class=\"line\">| SELECT * FROM <span class=\"built_in\">help</span>     | shows this <span class=\"built_in\">help</span>                    |</span><br><span class=\"line\">| SELECT * FROM backends | lists the backends and their state |</span><br><span class=\"line\">+------------------------+------------------------------------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">MySQL [(none)]&gt; SELECT * FROM backends;  <span class=\"comment\">#有可能需要登录有多个终端才能触发从库up</span></span><br><span class=\"line\">+-------------+--------------------+-------+------+------+-------------------+</span><br><span class=\"line\">| backend_ndx | address            | state | <span class=\"built_in\">type</span> | uuid | connected_clients |</span><br><span class=\"line\">+-------------+--------------------+-------+------+------+-------------------+</span><br><span class=\"line\">|           1 | 192.168.1.100:3306 | up    | rw   | NULL |                 1 |</span><br><span class=\"line\">|           2 | 192.168.1.100:3307 | up    | ro   | NULL |                 1 |</span><br><span class=\"line\">+-------------+--------------------+-------+------+------+-------------------+</span><br><span class=\"line\"><span class=\"comment\"># up：表示读写分离生效</span></span><br><span class=\"line\"><span class=\"comment\"># unKnown：还没生效</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.连接连接MySQL-Proxy并且插入数据到主库（注意这里是数据库的账号密码）</span></span><br><span class=\"line\"><span class=\"variable\">$mysql</span> -h 192.168.1.101 -P 4040 -utest -pweiye!@<span class=\"comment\">#888</span></span><br><span class=\"line\">Welcome to the MariaDB monitor.  Commands end with ; or \\g.</span><br><span class=\"line\">Your MySQL connection id is 22</span><br><span class=\"line\">Server version: 8.0.16 MySQL Community Server - GPL</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$MySQL</span> [(none)]&gt; show databases;</span><br><span class=\"line\">+--------------------+</span><br><span class=\"line\">| Database           |</span><br><span class=\"line\">+--------------------+</span><br><span class=\"line\">| demo               |</span><br><span class=\"line\">| information_schema |</span><br><span class=\"line\">| mysql              |</span><br><span class=\"line\">| performance_schema |</span><br><span class=\"line\">| phpmyadmin         |</span><br><span class=\"line\">| sys                |</span><br><span class=\"line\">+--------------------+</span><br><span class=\"line\">6 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.12 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">MySQL [(none)]&gt; use demo</span><br><span class=\"line\">MySQL [demo]&gt; insert into user value (10,<span class=\"string\">'mysql-proxy-insert'</span>);</span><br><span class=\"line\">Query OK, 1 row affected (0.12 sec)</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602213619.png\" alt=\"WeiyiGeek.mysql-proxy-write\" title=\"\" class=\"\">\n                <p>WeiyiGeek.mysql-proxy-write</p>\n            </figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#4.登录主库查看从MySQL-proxy插入到的数据,再登录从库插入一条数据,然后在MySQL-proxy中查看</span></span><br><span class=\"line\">mysql&gt; insert into user value (11,<span class=\"string\">'SLAVE INSERT - MYSQL-PROXY-READ'</span>);</span><br><span class=\"line\">Query OK, 1 row affected (0.09 sec)</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190602221810.png\" alt=\"WeiyiGeek.mysql-proxy-read\" title=\"\" class=\"\">\n                <p>WeiyiGeek.mysql-proxy-read</p>\n            </figure>\n<p><br/></p>\n<h5 id=\"4-入坑\"><a href=\"#4-入坑\" class=\"headerlink\" title=\"4. 入坑\"></a>4. 入坑</h5><p><strong>问题1：编译lua时候出现 lua.c:82:31: 致命错误：readline/readline.h：没有那个文件或目录</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#include &lt;readline/readline.h&gt;</span></span><br><span class=\"line\">解决：安装</span><br><span class=\"line\">yum install libtermcap-devel ncurses-devel libevent-devel readline-devel</span><br></pre></td></tr></table></figure><br><br><br><strong>问题2：登录mysql-proxy管理段查看到从库状态为unkown？</strong><br>原因：由于没有达到读写分离连接数限制;<br>解决方法：多登录几个mysql-proxy终端进行查询和插入即可将状态转变成为up;</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Database","path":"api/categories/Database.json"},{"name":"DBA","path":"api/categories/DBA.json"},{"name":"运维","path":"api/categories/运维.json"}],"tags":[{"name":"MYSQL","path":"api/tags/MYSQL.json"}]}