<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 4-MYSQL容备与入坑|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="MYSQL">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                学习之路
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>4-MYSQL容备与入坑</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">4-MYSQL容备与入坑</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-03-26T06:34:30.000Z" itemprop="datePublished" class="page-time">
  2019-03-26
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/">Database</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/DBA/">DBA</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-数据存储/Database-运维/MySQL/基础知识/4-MYSQL容备与入坑"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">4-MYSQL容备与入坑</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-03-26 14:34:30" datetime="2019-03-26T06:34:30.000Z"  itemprop="datePublished">2019-03-26</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/">Database</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/DBA/">DBA</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h3 id="容灾备份介绍"><a href="#容灾备份介绍" class="headerlink" title="容灾备份介绍"></a>容灾备份介绍</h3><p><em>1.容灾备份恢复必备条件</em><br>MySQL 数据库开启了log-bin参数记录binlog日志功能,且主库于备份的从库都要开启binlo功能。</p>
<p><em>1.全量备份</em><br>全量数据就是数据库中所有的数据,全量备份就是把数据库中所有的数据进行备份。<br>案例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">备份所有库 -F 刷新BINLOG</span></span><br><span class="line">mysql -uroot -p12345 -S mysql.sock  --defalut-character-set=utf8 --single--transaction -F -A | gzip &gt; /backup/mysql.bak.sql.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">备份一个库</span></span><br><span class="line">mysql -uroot -p12345 -S mysql.sock -F -B student | gzip &gt; /backup/mysql.bak.sql.gz</span><br></pre></td></tr></table></figure><br>注意：因为-single-transaction选项备份时涉及到的是select语句，所以dml语句是被允许的，ddl不被允许直到回滚保存点撤销select 语句</p>
<ol start="2">
<li>增量备份<br>增量数据就是从上次全量备份之后更新的数据,遂于MYSQL来说binlog日志就是MySQL增量数据。</li>
</ol>
<p><em>2.1 按天全备情况</em></p>
<ul>
<li>优点：恢复时间短,维护成本低</li>
<li>缺点：占用空间多,占用系统资源多,经常锁表影响用户体验。</li>
</ul>
<p><em>2.2 按周全备情况</em></p>
<ul>
<li>优点：占用空间比按天备份小,占用系统资源少,无需锁表用户体验好一些.</li>
<li>缺点：维护成本高,恢复麻烦,时间长。</li>
</ul>
<ol start="3">
<li>常见全量和增量备份的频率<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1) 中小公司：全量每天一次在业务流量低谷执行全备,执行前要进行锁表。</span><br><span class="line">2) 单台数据库：采用rsyn或者inotify,主从复制(把所有binlog备份到远程服务器中)</span><br><span class="line">rsync -avz &#x2F;data&#x2F;3306&#x2F;mysql-bin.* rsync_backup@10.0.0.1:bakcp --password-file&#x3D;&#x2F;etc&#x2F;rsync.passwd</span><br><span class="line">3) 大型公司周备,每周六零点一次全量，下周日-下周六00点前都是增量</span><br><span class="line">4) 一主多从的方式,一般会有一个从库作为备份延迟同步</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Q：mysqldump 备份什么时候派上用场?<br>A：</p>
<ul>
<li>迁移或者升级数据库时;</li>
<li>增加从库的时候;</li>
<li>硬件或者特殊异常情况下,主库或者从库宕机,主从相互切换,建立新的从库的时候。</li>
<li>人为的DDL，DML语句,主库没办法了,所有的库都会执行,此时需要备份。</li>
<li>跨机房容灾,需要备份到异地</li>
</ul>
<p>Q：什么情况下需要增量恢复？<br>A：常用于一主多从的数据库架构下,从库上开启binlog然后实施定时全备份和实时增量备份。</p>
<p>Q：什么是增量恢复?<br>利用二进制日志和全备进行的恢复过程,称为增量恢复。</p>
<p>Q: 人为操作数据库SQL语句破坏主库是否需要增量恢复？<br>A：在主库内部命令行误操作,会导致所有的数据库(包括主从库)数据丢失，这样的场景是需要增量恢复的。</p>
<p>Q：只有一个主库是否需要增量恢复?<br>A：如果公司里只有一个主库情况下,尽量做全备(一天一次),及增量备份(每隔1-10分钟对bin-log日志做的切割返回备份到其他服务器上,或者本地),宁一种好的方法就是做从库,基于drod(基于磁盘块的)同步。</p>
<p><em>小结：</em></p>
<ul>
<li>人为或者程序逻辑方式在数据库中执行SQL语句等误操作,都需要增量恢复.</li>
<li>从库进行全量和增量方式的备份,可以防止人为对主库的误操作导致数据丢失,确保备份的从库和主库是同步状态。</li>
<li>增量恢复的条件,存放一份全备与时刻同步的增量备份。</li>
</ul>
<hr>

<h4 id="0x00-MySQL数据库存储目录迁徙"><a href="#0x00-MySQL数据库存储目录迁徙" class="headerlink" title="0x00 MySQL数据库存储目录迁徙"></a>0x00 MySQL数据库存储目录迁徙</h4><p>测试环境：Ubuntu 16TLS<br>迁移流程：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">1.在目录迁徙目标文件夹(原始数据),默认目录：/var/lib/mysql ，注意权限700与所属者，所属组都是mysql用户与组.</span></span><br><span class="line">drwx------ mysql mysql mysql/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2.建立备份目录</span></span><br><span class="line">sudo mkdir /databackup</span><br><span class="line">sudo chown -vR mysql:mysql /databackup/</span><br><span class="line">sudo chmod -vR 700 /databackup/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3.通过cp命令进行复制(由于权限问题需要切换到root权限):</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> su root</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp -av /var/lib/mysql/* /databackup/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">4.下面需要修改MySQL配置文件:</span></span><br><span class="line">vim /etc/mysql/my.cnf  #12.06 verion</span><br><span class="line">vim /etc/mysql/mysql.conf.d/mysqld.cnf # 16.04 version</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">5.修改配置文件,设置新的datadir = /databackup,并用<span class="comment">#注销默认数据目录。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">6.修改appormor 配置（Ubuntu里面的软件都受到这个的限制）,修改为：/mysqldata/ r, /mysqldata/** rwk,</span></span><br><span class="line"><span class="meta">$</span><span class="bash">sudo vim /etc/apparmor.d/user.sbin.mysqld</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">7.重启apparmor | MySQL</span></span><br><span class="line"><span class="meta">$</span><span class="bash">sudo service apparmor reload</span></span><br><span class="line"><span class="meta">$</span><span class="bash">sudo service mysql start</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">8.登陆MySQL （ 默认情况下，出于安全的考虑，MySQL在初始状态下不允许远程连接，只允许服务器内部应用的本地连接。 ）</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">9.创建数据库,查看迁移目录下的数据库文件 并删除原数据库文件</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> create database imooc;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> su root</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /mysqldata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rm -rvf /usr/lib/mysql</span></span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326110057.png" target="_blank" title="WeiyiGeek.apparmor修改" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326110057.png" alt="WeiyiGeek.apparmor修改" title="" class=""></a>
                <p>WeiyiGeek.apparmor修改</p>
            </figure></p>
<hr>

<h4 id="0x01-MySQL数据库-表备份还原的操作"><a href="#0x01-MySQL数据库-表备份还原的操作" class="headerlink" title="0x01 MySQL数据库|表备份还原的操作"></a>0x01 MySQL数据库|表备份还原的操作</h4><p>描述：利用mysqldump备份数据库过程，实际上就是把数据从mysql库里以逻辑的SQL语句的形式直接输出或者生成备份的文件的过程；</p>
<h5 id="1-1-备份数据库（全备）"><a href="#1-1-备份数据库（全备）" class="headerlink" title="1.1 备份数据库（全备）"></a>1.1 备份数据库（全备）</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">语法：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">use mysqdump --<span class="built_in">help</span></span></span><br><span class="line">mysqldump -u用户名 -p密码 数据库 数据表 &gt; 数据表备份名字   #不会建立库与切换库 （但会判断库里面的表是不是存在）</span><br><span class="line"></span><br><span class="line">mysqldump -u用户名 -p密码 -A &gt; 所有数据库备份名字  #注意这里-A 指定了后面也可以指定-B参数   ==  --all-databases</span><br><span class="line">mysqldump -u用户名 -p密码 -B 数据库名 &gt; 备份名字    # 推荐 -&gt; -B 会建立库-自动切换库       == --database</span><br><span class="line">mysqldump -u用户名 -p密码 -B 库名1 库名2|gzip &gt; 备份名.gz  #指定压缩命令压缩备份多个库 sql</span><br><span class="line"></span><br><span class="line">mysqldump -u用户名 -p密码 --compact -d 数据库 数据表 &gt; 数据表备份名字 </span><br><span class="line">mysqldump -u用户名 -p密码 --compact -t 数据库 数据表 &gt; 数据表备份名字 </span><br><span class="line">mysqldump -u用户名 -p密码 --compact -A -B -F --events|gzip &gt; 数据表备份名字 </span><br><span class="line">mysqldump -u用户名 -p密码 --compact --master-data=1 数据库 &gt; 数据表备份名字 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">参数：</span></span><br><span class="line">-A 相当于 -B 数据库中一个一个库放在后面</span><br><span class="line">-B 连接多个库，并且增加create database db 和 use db信息；</span><br><span class="line">--compact 测试使用较多，可以优化内容的大小，让容量更少，适合调试;（不会 set names 、忽略key、添加锁）减小了生成文件的体积</span><br><span class="line">-d : 备份表结构</span><br><span class="line">-t ：备份表内容</span><br><span class="line">-F : 刷新切割binlog日志(分段备份导入)</span><br><span class="line">--master-data ：增加binlog日志文件名及对应的位置点;  #注意需要开启log_bin ON  |查看  -e "show variables;" | grep log_bin</span><br><span class="line">-x ：锁定所有表 #--lock-all-tables</span><br><span class="line">-l ：锁定指定表</span><br><span class="line">--single-transaction  : 适合innodb事务数据库备份（保证备份的一致性）| 工作原理隔离级别REPEATABLE READ</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">案例：</span></span><br><span class="line">mysqldump -u root -p f_info user_info &gt; user_info.bak</span><br><span class="line">mysqldump -usystem -psystem -B test &gt; test.sql</span><br><span class="line">mysqldump -usystem -psystem -A &gt; AllTest.sql</span><br><span class="line">mysqldump -usystem -psystem -A -B --events|gzip &gt; AllTest.sql.gz   #注意 gzip -d 会删除源文件解压</span><br><span class="line">mysqldump -usystem -psystem -A -B -F --events|gzip &gt; AllTest.sql.gz</span><br><span class="line">mysqldump -uroot -p123456 --master-data=2 --compact -B demo   #2会加上注释</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">可以直接排除特殊字符查看</span></span><br><span class="line">grep -E -v "#|\/|^$|--" test.sql</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326110726.png" target="_blank" title="WeiyiGeek.mysqldump使用" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326110726.png" alt="WeiyiGeek.mysqldump使用" title="" class=""></a>
                <p>WeiyiGeek.mysqldump使用</p>
            </figure>
<h5 id="1-2-备份表结构与表数据"><a href="#1-2-备份表结构与表数据" class="headerlink" title="1.2 备份表结构与表数据"></a>1.2 备份表结构与表数据</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">实战</span></span><br><span class="line">&#123;lamb&#125; mysqldump -uroot -p123456 --compact -t demo user | less</span><br><span class="line">&#123;lamb&#125; mysqldump -uroot -p123456 --compact -d demo user | less</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326110843.png" target="_blank" title="WeiyiGeek.备份表结构与表数据" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326110843.png" alt="WeiyiGeek.备份表结构与表数据" title="" class=""></a>
                <p>WeiyiGeek.备份表结构与表数据</p>
            </figure>
<h5 id="1-3-MYSQL引擎不同的备份比较"><a href="#1-3-MYSQL引擎不同的备份比较" class="headerlink" title="1.3 MYSQL引擎不同的备份比较"></a>1.3 MYSQL引擎不同的备份比较</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 差备恢复</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MyISAM &lt;= 5.3.5 </span></span><br><span class="line">mysqldump -u用户名 -p密码 -A -F -x --events --master-data=2|gzip  &gt; 数据表备份名字.gz   #需要锁表 （-F = flush bin-log）</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> innoDB &gt;= 5.5.x  多一个事务操作参数</span></span><br><span class="line">mysqldump -u用户名 -p密码 -A -F -B --events -t --master-data=2 --sigle-transaction|gzip &gt; 数据表备份名字.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">涉及了触发器trigeers 与存储过程 routines</span></span><br></pre></td></tr></table></figure>
<h5 id="1-4-还原数据库-表"><a href="#1-4-还原数据库-表" class="headerlink" title="1.4 还原数据库|表"></a>1.4 还原数据库|表</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">实例</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">mysql -uroot -p123456 mydb &lt; /root/data/mydb.bak;  <span class="comment">#方法1 库名 </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">mysql -uroot -p123456 mydb mytable&lt; /root/data/mydb.bak;  <span class="comment">#方法2 带表</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">方法2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">先 create database test1，然后 下mysql &gt;下输入<span class="built_in">source</span> 路径即可，要注意 test.sql 所在的路径！</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> create database test1;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> use test1;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">source</span> test.sql</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326111029.png" target="_blank" title="WeiyiGeek.数据库导入" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326111029.png" alt="WeiyiGeek.数据库导入" title="" class=""></a>
                <p>WeiyiGeek.数据库导入</p>
            </figure>
<h5 id="1-5-导出-导入查询的数据到文件"><a href="#1-5-导出-导入查询的数据到文件" class="headerlink" title="1.5 导出/导入查询的数据到文件"></a>1.5 导出/导入查询的数据到文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*语法：*&#x2F;</span><br><span class="line">select columns FROM into outfile &quot;path&#x2F;dest_file&quot;;</span><br><span class="line">load data infile &quot;path&#x2F;file_name&quot; into table table_name;</span><br><span class="line"></span><br><span class="line">&#x2F;*案例：*&#x2F;</span><br><span class="line">select * from test.websites into outfile &quot;&#x2F;tmp&#x2F;test.txt&quot;;</span><br><span class="line">load data infile &#39;&#x2F;tmp&#x2F;test.txt&#39; into table websites;  &#x2F;*注意中文导入乱码*&#x2F;</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326111236.png" target="_blank" title="WeiyiGeek.outfile与infile" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326111236.png" alt="WeiyiGeek.outfile与infile" title="" class=""></a>
                <p>WeiyiGeek.outfile与infile</p>
            </figure>
<h5 id="1-6-细说–master-data-1-2-的异同"><a href="#1-6-细说–master-data-1-2-的异同" class="headerlink" title="1.6 细说–master-data=1|2 的异同"></a>1.6 细说–master-data=1|2 的异同</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">--master-data = 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 常常在主从同步中使用，从机中拉取主机中的LOG-bin文件及其位置进行复制，相反主机也从从机中抓取数据</span></span><br><span class="line">CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000006', MASTER_LOG_POS=366;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">--master-data = 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 常常在增量备份中使用,只需要知道 bin-log文件 LOG_POS 366 以后的数据信息 （差备恢复）</span></span><br><span class="line">CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000005', MASTER_LOG_POS=366;</span><br></pre></td></tr></table></figure>
<hr>

<h4 id="0x02-增量恢复MySQL数据实战"><a href="#0x02-增量恢复MySQL数据实战" class="headerlink" title="0x02 增量恢复MySQL数据实战"></a>0x02 增量恢复MySQL数据实战</h4><p>描述：有时需要恢复到一个操作之前的数据库，但又不想丢失这一部分的数据，那么可以用初步增量进行将这段时间参数的数据，恢复到数据库之中；<br>原理：mysql中的binlog日志，用来记录mysql内部增删改查的等对mysql数据库有更新内容，依靠足够长度的binlog日志和定期的全备，我们可以恢复任意时间点的表单数据。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">语法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">mysqlbinlog 解析mysql的binlog日志</span></span><br><span class="line">mysqlbinlog  -d 库名 bin-log[日志文件] &gt; 库名_operi.sql  #可以将bin-log中所有对库操作的SQL语句导出</span><br><span class="line">mysqlbinlog bin-log[日志文件]  --start-position=365 --stop-position=456 -r 恢复的库名_operi.sql          #位置数范围恢复</span><br><span class="line">mysqlbinlog bin-log[日志文件] --start-datetime="2018-1-1 21:22:22" --stop-datetime="2018-1-3 21:22:22"  -r 恢复的库名_operi.sql  #通过时间范围恢复数据</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">参数：</span></span><br><span class="line">-d ：指定库名 </span><br><span class="line">--start-position ：指定开始位置   # at 位置数 </span><br><span class="line">--stop-position  ：指定结束位置</span><br><span class="line">--start-datetime : 指定开始时间   # 时间</span><br><span class="line">--stop-datetime  : 指定结束时间</span><br></pre></td></tr></table></figure><br><em>注意使用之前必须开启在配置中开启增量备份（主要是完成记录数据库的增删改查）：</em><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">author：WeiyiGeek 博客</span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件中加入<span class="built_in">log</span>-bin</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin  # 将前面的#去掉,后面的增量备份名可以更改；</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启MySQL</span></span><br><span class="line">/etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">进行对数据库简单操作</span></span><br><span class="line">create table `test`(</span><br><span class="line">    `id` INT(5) NOT NULL DEFAULT 0, </span><br><span class="line">    `name` CHAR(128) NOT NULL DEFAULT 'undefine'</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into test value (1,"test"),(2,"www"),(3,"java");</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326111946.png" target="_blank" title="WeiyiGeek.logbin" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326111946.png" alt="WeiyiGeek.logbin" title="" class=""></a>
                <p>WeiyiGeek.logbin</p>
            </figure></p>
<p>在mysql安装目录中的data目录中，便能找到存在我们增量备份：<br><figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326112132.png" target="_blank" title="WeiyiGeek.apparmor修改" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326112132.png" alt="WeiyiGeek.apparmor修改" title="" class=""></a>
                <p>WeiyiGeek.apparmor修改</p>
            </figure></p>
<p><em>注意：</em> bin-log 注意它会记录所有数据库的更改记录，所有我们需要对其进行分段，使其更快更好的查找我们需要恢复的数据，如果无bin-log数据有可能导致有些数据删除了不能更快的找回来；</p>
<h5 id="2-1-常用增量恢复方式"><a href="#2-1-常用增量恢复方式" class="headerlink" title="2.1 常用增量恢复方式"></a>2.1 常用增量恢复方式</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">不能停住数据库的思路</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">insert into <span class="built_in">test</span> value (4,<span class="string">"php"</span>),(5,<span class="string">"Apache"</span>);</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">update <span class="built_in">test</span> <span class="built_in">set</span> name to <span class="string">"Python"</span> <span class="built_in">where</span> name=<span class="string">"test"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">下面是切割我们增量数据：</span></span><br><span class="line">mysqladmin -usystem -p123456 flush-log  #如果一个文件太过于庞大的时候或者业务不能停的时候把记录转到00002中去</span><br><span class="line"><span class="meta">#</span><span class="bash">备份命令中 mysqldump 的-F参数也能进行刷新切割bin_log数据</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326112418.png" target="_blank" title="WeiyiGeek.apparmor修改" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326112418.png" alt="WeiyiGeek.apparmor修改" title="" class=""></a>
                <p>WeiyiGeek.apparmor修改</p>
            </figure>
<h5 id="2-2-常用增量文件导出为sql（三种方法）"><a href="#2-2-常用增量文件导出为sql（三种方法）" class="headerlink" title="2.2 常用增量文件导出为sql（三种方法）"></a>2.2 常用增量文件导出为sql（三种方法）</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">方式1.实战将binlog全部导入</span></span><br><span class="line">mysqlbinlog -d test mysqlback-bin.000001 &gt; mysqlback.sql   #过滤test库的数据库进行写入到我们需要恢复的SQL文件中</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">方式2.按照条件导入</span></span><br><span class="line">mysqlbinlog mysqlback-bin.000001 --start-position=356 --stop-position=456 -r mysqlback.sql   #选择bin-log中AT位置范围的语句写入到我们需要恢复的SQL文件中</span><br><span class="line">mysqlbinlog mysqlback-bin.000001 --start-datetime="2018-1-1 21:22:22" --stop-datetime="2018-1-3 21:22:22"  -r mysqlback.sql   #通过时间范围来恢复 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">方式3.删除mysqlback.sql中的错误操作，然后进行导入；</span></span><br><span class="line">mysql -usystem -p123456 test &lt;mysqlback.sql </span><br><span class="line">mysql -usystem -p123456 -e "select * from test.test" 恢复到上次记录；</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326113107.png" target="_blank" title="WeiyiGeek.删除binlog误操作的语句" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326113107.png" alt="WeiyiGeek.删除binlog误操作的语句" title="" class=""></a>
                <p>WeiyiGeek.删除binlog误操作的语句</p>
            </figure>
<figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326113307.png" target="_blank" title="WeiyiGeek.导入binlog解析的sql" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326113307.png" alt="WeiyiGeek.导入binlog解析的sql" title="" class=""></a>
                <p>WeiyiGeek.导入binlog解析的sql</p>
            </figure>
<p><br></p>
<h5 id="2-3-update与delete-误删除恢复实战"><a href="#2-3-update与delete-误删除恢复实战" class="headerlink" title="2.3 update与delete 误删除恢复实战"></a>2.3 update与delete 误删除恢复实战</h5><p>描述:在实际运维中常常会发生将表中的数据进行update 以及 delete 等SQL语句未加WHERE条件时候，当日志记录没有开启时候，我们只能通过binlog文件进行查验导出恢复;</p>
<p>注意事项:binglog格式必须是ROW<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.查看 binlog 文件列表</span></span><br><span class="line">mysql&gt; show binary logs;</span><br><span class="line"><span class="comment">#2.指定 inlog 文件查看</span></span><br><span class="line">mysql&gt; show binlog events <span class="keyword">in</span> <span class="string">'mysql-bin.000008'</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>1.update误操作恢复</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#环境假设</span></span><br><span class="line">update user <span class="built_in">set</span> flag = 1  <span class="comment">#此时没加上条件导致数据被该</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复流程与步骤如下</span></span><br><span class="line"><span class="comment">#1.如何数据库是在线上的话比较复杂，要先进行锁表，以免数据再次被污染；</span></span><br><span class="line">mysql&gt; lock tables t1 <span class="built_in">read</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.查看当前写的二进制文件</span></span><br><span class="line">mysql&gt; show master status;</span><br><span class="line"><span class="comment"># +------------------+----------+--------------+------------------+</span></span><br><span class="line"><span class="comment"># | File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span></span><br><span class="line"><span class="comment"># +------------------+----------+--------------+------------------+</span></span><br><span class="line"><span class="comment"># | mysql-bin.000024 |     1852 |              |                  |</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.分析二进制日志，并且在其中找到相关记录</span></span><br><span class="line"><span class="comment">#通过关键字</span></span><br><span class="line">mysqlbinlog --no-defaults -v -v --base64-output=DECODE-ROWS mysql-bin.000024 | grep -B 15 <span class="string">'zhuhai'</span> <span class="comment">#下十五条</span></span><br><span class="line"><span class="comment">#通过时间段</span></span><br><span class="line">mysqlbinlog --no-defaults -v -v --base64-output=DECODE-ROWS binlog.000004 --start-datetime=<span class="string">"2020-3-1 01:33:23"</span> --stop-datetime=<span class="string">"2020-3-1 01:40:22"</span> | grep -C 5 --color  <span class="string">"@4=3"</span> &gt; 1.txt</span><br><span class="line"><span class="comment">#200301  1:33:23 server id 1  end_log_pos 1033911 CRC32 0x19eac976      Xid = 35805 COMMIT/*!*/;</span></span><br><span class="line"><span class="comment"># at 1033911</span></span><br><span class="line">--</span><br><span class="line"><span class="comment">### UPDATE `student`.`user`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=49 /* SHORTINT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2='杜邦能' /* STRING(128) meta=65152 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4=3 /* TINYINT meta=0 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @5=1583055203 /* TIMESTAMP(0) meta=0 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=49 /* SHORTINT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2='杜邦能' /* STRING(128) meta=65152 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3=0 /* TINYINT meta=0 nullable=1 is_null=0 */  （误操作的部分）</span></span><br><span class="line"><span class="comment">###   @4=3 /* TINYINT meta=0 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @5=1583055203 /* TIMESTAMP(0) meta=0 nullable=1 is_null=0 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.处理分析处理的二进制日志采用sed</span></span><br><span class="line">sed <span class="string">'/WHERE/&#123;:a;N;/SET/!ba;s/\([^\n]*\)\n\(.*\)\n\(.*\)/\3\n\2\n\1/&#125;'</span> t1.txt | sed -r <span class="string">'/WHERE/&#123;:a;N;/@4/!ba;s/###   @2.*//g&#125;'</span> | sed <span class="string">'s/### //g;s/\/\*.*/,/g'</span> | sed <span class="string">'/WHERE/&#123;:a;N;/@1/!ba;s/,/;/g&#125;;s/#.*//g;s/COMMIT,//g'</span> | sed <span class="string">'/^$/d'</span> &gt; recover.sql </span><br><span class="line">grep -vE <span class="string">'@5'</span> recover.sql &gt; recover1.sql <span class="comment">#排除@5的一行</span></span><br><span class="line"><span class="comment"># 处理后的SQL</span></span><br><span class="line"><span class="comment"># UPDATE `student`.`user`</span></span><br><span class="line"><span class="comment"># SET</span></span><br><span class="line"><span class="comment">#   @1=49 ,</span></span><br><span class="line"><span class="comment">#   @2='杜邦能' ,</span></span><br><span class="line"><span class="comment">#   @3=1 ,</span></span><br><span class="line"><span class="comment">#   @4=3 ,</span></span><br><span class="line"><span class="comment">#   @5=1583055203 ,</span></span><br><span class="line"><span class="comment"># WHERE</span></span><br><span class="line"><span class="comment">#   @1=49 ;</span></span><br><span class="line"><span class="comment">#   @5=1583055203 ,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4.将文件中的@1,@2,@3,@4替换为t1表中id，name，sex，address字段，并删除最后字段的","号</span></span><br><span class="line">sed -i <span class="string">'s/@1/id/g;s/@2/name/g;s/@3/flag/g;s/@4/grade/g;'</span> recover1.sql</span><br><span class="line">sed -i -r <span class="string">'s/(grade=.*),/\1/g'</span> recover1.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#5.登录MySQL数据库然后导入SQL语句恢复数据</span></span><br><span class="line">mysql&gt; <span class="built_in">source</span> recover.sql;</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200301133034.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200301133034.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure></p>
<p><br></p>
<p><strong>2) delete 误操作恢复</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.找到时间和POSITION位置节点,并且打印关键字之间的行</span></span><br><span class="line">mysqlbinlog --no-defaults --base64-output=decode-rows -v -v mysql-bin.000004 | sed -n <span class="string">'/### DELETE FROM db01.t1/,/COMMIT/p'</span> &gt; delete.txt</span><br><span class="line"><span class="comment">### DELETE FROM db01.t1</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2='daiiy' /* STRING(60) meta=65084 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3=2 /* ENUM(1 byte) meta=63233 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='guangzhou' /* VARSTRING(90) meta=90 nullable=0 is_null=0 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.SQL语句转换</span></span><br><span class="line">cat delete.txt | sed -n <span class="string">'/###/p'</span> | sed <span class="string">'s/### //g;s/\/\*.*/,/g;s/DELETE FROM/INSERT INTO/g;s/WHERE/SELECT/g;'</span> | sed -r <span class="string">'s/(@4.*),/\1;/g'</span> | sed <span class="string">'s/@[1-9]=//g'</span> &gt; t1.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.导入数据</span></span><br><span class="line">mysql&gt; <span class="built_in">source</span> t1.sql</span><br></pre></td></tr></table></figure></p>
<hr>

<h4 id="0x03-主从复制之MYSQL增量恢复实战"><a href="#0x03-主从复制之MYSQL增量恢复实战" class="headerlink" title="0x03 主从复制之MYSQL增量恢复实战"></a>0x03 主从复制之MYSQL增量恢复实战</h4><p>案例图解：<br><figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326115817.png" target="_blank" title="WeiyiGeek.增量恢复案例" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190326115817.png" alt="WeiyiGeek.增量恢复案例" title="" class=""></a>
                <p>WeiyiGeek.增量恢复案例</p>
            </figure><br>解决流程：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) 判断关联业务哪一个数据库出现错误,查看SQL语句执行历史查看是什么问题导致业务中断;</span><br><span class="line"><span class="number">2</span>) 我们从<span class="number">10</span>:<span class="number">11</span>接收,停止从库,然后再将Binlog把mysql-bin<span class="number">.0000004</span> 恢复成 bin.sql 并且 去掉drop语句;</span><br><span class="line"><span class="number">3</span>) 把<span class="number">0</span>点的前面全备bak_00:<span class="number">00</span>:<span class="number">00.</span>sql以及<span class="number">10</span>点前的增量bin.sql恢复到从库;</span><br><span class="line"><span class="number">4</span>) 数据丢多少？<span class="number">10</span>：<span class="number">10</span>分刷新BINLOG以后的数据 mysql-bin<span class="number">.00003</span>;</span><br><span class="line"><span class="number">5</span>) 停止主库，快速把mysql-bin<span class="number">.00003</span>解析为sql，恢复到从库切换到从库提供服务; </span><br><span class="line"><span class="number">6</span>) 晚上某个时间节点将从库的数据重新灌入到主库中，恢复主从复制;</span><br><span class="line"><span class="number">7</span>) 后期数据库权限关联思想调整</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------------环境假设---------------------</span><br><span class="line">$ mysql -uroot -p12356 -S /data/<span class="number">3306</span>/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据库字符集 utf8  | 数据库校对规则：utf8_general_ci 不区分大小写</span></span><br><span class="line">mysql&gt; create database weiyigeek DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br><span class="line"><span class="comment">//ci是case insensitive的缩写，意思是大小写不敏感；</span></span><br><span class="line"><span class="comment">//相对的是cs，即case sensitive，大小写敏感；</span></span><br><span class="line"><span class="comment">//还有一种是utf8_bin，是将字符串中的每一个字符用二进制数据存储，区分大小写。</span></span><br><span class="line">mysql&gt; <span class="function">create table <span class="title">study</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    `id` <span class="keyword">int</span>(<span class="number">4</span>) <span class="keyword">not</span> <span class="literal">NULL</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    `name` CHAR(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入数据</span></span><br><span class="line">mysql&gt; insert into study values(1,'WeiyiGEEK');</span><br><span class="line">Query OK, <span class="number">1</span> <span class="function">row <span class="title">affected</span> <span class="params">(<span class="number">0.09</span> sec)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">mysql&gt; select * from study;</span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  <span class="number">1</span> | WeiyiGEEK |</span><br><span class="line">|  <span class="number">2</span> | test      |</span><br><span class="line">|  <span class="number">2</span> | testdemo  |</span><br><span class="line">| <span class="number">45</span> | testdemo  |</span><br><span class="line">| <span class="number">41</span> | testdemo  |</span><br><span class="line">+----+-----------+</span><br><span class="line"><span class="number">5</span> <span class="function">rows in <span class="title">set</span> <span class="params">(<span class="number">0.00</span> sec)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//0点全备</span></span></span><br><span class="line">[root@WeiyiGeek data]# mysqldump -uroot -pSystem123@ -S /data/3306/mysql.sock -B weiyigeek -F --events|gzip &gt; bak_`(date +%F)`.sql.gz &amp;&amp; ll</span><br><span class="line"></span><br><span class="line"><span class="comment">//再插入数据</span></span><br><span class="line">mysql&gt; insert into study values(1204,'Geek');</span><br><span class="line">Query OK, <span class="number">1</span> <span class="function">row <span class="title">affected</span> <span class="params">(<span class="number">0.01</span> sec)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">mysql&gt; insert into study values(12,'adddGeek');</span><br><span class="line">Query OK, <span class="number">1</span> <span class="function">row <span class="title">affected</span> <span class="params">(<span class="number">0.04</span> sec)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">mysql&gt; insert into study values(12,'GeekAdd');</span><br><span class="line">Query OK, <span class="number">1</span> <span class="function">row <span class="title">affected</span> <span class="params">(<span class="number">0.01</span> sec)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 10:00 执行了错误得语句</span></span></span><br><span class="line">mysql&gt; drop table study;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="function">rows <span class="title">affected</span> <span class="params">(<span class="number">0.03</span> sec)</span></span></span><br></pre></td></tr></table></figure><br>解决实例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Step1.增量恢复得重点,判断业务是否可以暂停;通过防火墙禁止WEB等应用向主库写数据或者锁表,穰主库暂时停止更新,然后再进行恢复。</span><br><span class="line"></span><br><span class="line">Step2.检查全备并且解压</span><br><span class="line">-rw-r--r-- 1 root  root    777 Mar 27 00:12 bak_2019-03-27.sql.gz</span><br><span class="line"></span><br><span class="line">[root@WeiyiGeek 3306]# gzip -d bak_2019-03-27.sql.gz</span><br><span class="line">-rw-r--r-- 1 root  root   2094 Mar 27 16:12 bak_2019-03-27.sql</span><br><span class="line"></span><br><span class="line">Step3.检查增量备份</span><br><span class="line">[root@WeiyiGeek data]# grep -i "change" bak_2019-03-27.sql  #来判断MYSQL增量文件</span><br><span class="line">[root@WeiyiGeek data]# grep -i "completed " bak_2019-03-27.sql</span><br><span class="line">-- Dump completed on 2019-03-27 00:12:17</span><br><span class="line">-rw-r----- 1 mysql mysql   1001 Mar 27 10:17 binlog.000006</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Step4.当机器不能暂停得时候mysqladmin进行刷新bin-log  #我们恢复得目标就是000006了</span><br><span class="line"> mysqladmin -uroot -pSystem123@ -S /data/3306/mysql.sock flush-logs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Step5.拷贝我们刷新后binlog文件(恢复目标)到其他文件中,防止误操作 , 采用mysqlbinlog 将binlog 解析为sql</span><br><span class="line">cp binlog.000006 ../server/backup/</span><br><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -d weiyieek binlog.000006 &gt; bin.sql</span></span><br><span class="line"></span><br><span class="line">mysqlbinlog mysql-bin.0000* &gt; bin.sql  #或者 mysqlbinlog mysql-bin.00001 mysql-bin.00002 &gt; bin1.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Step6.找到误操作语句进行删除</span><br><span class="line"><span class="meta">$</span><span class="bash"> grep -n <span class="string">"DROP"</span> bin.sql</span></span><br><span class="line">92:DROP TABLE `study` /* generated by server */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Step7.登陆到数据库找到一个关键 sql_log_bin 点,当我们导入备份数据后得时候不记录到bin-log日志中  </span><br><span class="line"><span class="meta">#</span><span class="bash">同时如果业务没有中断还在写数据这时候用户得数据也不写进bin-log日志里面了，所以恢复得时候需要注意（业务停还是没有停）。</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%log_bin%'</span>;</span></span><br><span class="line">+---------------------------------+-------------------------+</span><br><span class="line">| Variable_name                   | Value                   |</span><br><span class="line">+---------------------------------+-------------------------+</span><br><span class="line">| log_bin                         | ON                      |</span><br><span class="line">| log_bin_basename                | /data/3306/binlog       |</span><br><span class="line">| log_bin_index                   | /data/3306/binlog.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                     |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                     |</span><br><span class="line">| sql_log_bin(important)          | ON                      |</span><br><span class="line">+---------------------------------+-------------------------+</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> GLOABL sql_log_bin = OFF; <span class="comment">#当前会话生效。</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Step8.导入全备与其增量备份</span><br><span class="line">mysql -uroot -pSystem123@ -S /data/3306/mysql.sock &lt; bak_2 019-03-27.sql</span><br><span class="line">mysql -uroot -pSystem123@ -S /data/3306/mysql.sock &lt; bin.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Step9.进入查看恢复得数据</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from study;</span></span><br><span class="line">+------+-----------+</span><br><span class="line">| id   | name      |</span><br><span class="line">+------+-----------+</span><br><span class="line">|    1 | WeiyiGEEK |</span><br><span class="line">|    2 | test      |</span><br><span class="line">|    2 | testdemo  |</span><br><span class="line">|   45 | testdemo  |</span><br><span class="line">|   41 | testdemo  |</span><br><span class="line">| 1204 | Geek      |</span><br><span class="line">|   12 | adddGeek  |</span><br><span class="line">|   12 | GeekAdd   |</span><br><span class="line">+------+-----------+</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">以上方案不会有主键冲突问题。</span></span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=4-MYSQL容备与入坑 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190327163952.png" target="_blank" title="WeiyiGeek.停止外写入恢复MySQL数据库" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190327163952.png" alt="WeiyiGeek.停止外写入恢复MySQL数据库" title="" class=""></a>
                <p>WeiyiGeek.停止外写入恢复MySQL数据库</p>
            </figure></p>
<h4 id="0x04-数据库-表备份总结"><a href="#0x04-数据库-表备份总结" class="headerlink" title="0x04 数据库|表备份总结"></a>0x04 数据库|表备份总结</h4><p>1) 备份与字符集修改导入</p>
<ul>
<li>导出所有的数据库（存在乱码）或者库中的表，sed批量修改为utf-8；</li>
<li>修改mysql服务端和客户端的编码为utf-8，使用set names 字符集；</li>
<li>删除原有的库表及数据，建立utf-8的为编码的数据库；</li>
<li>导入mysql的所有数据；<br>2) 增量备份总结<br>如果不是Drop而是UPDATE破坏数据,解决起来就复杂;一般需要停库或禁止被应用服务写入,然后再恢复。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.人为SQL造成的误操作</span><br><span class="line">2.全备和增量</span><br><span class="line">3.恢复时建议对外停止更新</span><br><span class="line">4.恢复全量然后把增量日志中有问题的SQL语句删除,恢复到数据库</span><br><span class="line">5.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">增量恢复的核心思想</span></span><br><span class="line">1.流程制度控制(业务操作需要层层审批),有效的防止问题发生。</span><br><span class="line">2.延迟备份解决,建立堡垒机对于高风险语句做黑名单于白名单机制。</span><br><span class="line">3.业务需求容忍度,可量化的目标,根据需求选择停库或者锁表或者容忍丢失部分数据。</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="备份shell脚本"><a href="#备份shell脚本" class="headerlink" title="备份shell脚本"></a>备份shell脚本</h3><h4 id="批量备份数据库与库中之表"><a href="#批量备份数据库与库中之表" class="headerlink" title="批量备份数据库与库中之表"></a>批量备份数据库与库中之表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">BACKUPPATH=/data/backup/</span><br><span class="line">[ ! -d <span class="variable">$BACKUPPATH</span> ] &amp;&amp; mkdir -p <span class="variable">$BACKUPPATH</span></span><br><span class="line">UMYSQL=<span class="string">"root"</span></span><br><span class="line">PMYSQL=<span class="string">"123456"</span></span><br><span class="line">SOCKET=<span class="string">'/date/3306/mysql.sock'</span></span><br><span class="line">CONNECT=<span class="string">"mysql -u<span class="variable">$&#123;UMYSQL&#125;</span> -p<span class="variable">$&#123;PMYSQL&#125;</span> -S <span class="variable">$&#123;SOCKET&#125;</span>"</span></span><br><span class="line">DUMPDB=<span class="string">"mysqldump -u<span class="variable">$&#123;UMYSQL&#125;</span> -p<span class="variable">$&#123;PMYSQL&#125;</span> -S <span class="variable">$&#123;SOCKET&#125;</span> -x -B -F -R"</span></span><br><span class="line">LISTDB=$(<span class="variable">$CONNECT</span> -e <span class="string">"show databases;"</span>|sed 1d|egrep -v <span class="string">"_shcema|mysql"</span>)</span><br><span class="line"><span class="keyword">for</span> dbname <span class="keyword">in</span> <span class="variable">$LISTDB</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment">#$DUMPDB $dbname|gzip &gt;$&#123;BACKUPPATH&#125;/$&#123;dbname&#125;_$(date +%F).sql.gz  #光备份数据库</span></span><br><span class="line">    LISTTABLE=$( <span class="variable">$CONNECT</span> -e <span class="string">"show tables from <span class="variable">$dbname</span>;"</span>|sed 1d )</span><br><span class="line">    BACKUPPATH=<span class="variable">$BACKUPPATH</span><span class="variable">$&#123;dbname&#125;</span></span><br><span class="line">    [ ! -d <span class="variable">$BACKUPPATH</span> ] &amp;&amp;  mkdir -p <span class="variable">$BACKUPPATH</span></span><br><span class="line">    <span class="keyword">for</span> tablename <span class="keyword">in</span> <span class="variable">$LISTTABLE</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="variable">$DUMPDB</span> <span class="variable">$dbname</span> <span class="variable">$tablename</span>|gzip &gt;<span class="variable">$BACKUPPATH</span>/<span class="variable">$&#123;dbname&#125;</span>_<span class="variable">$&#123;tablename&#125;</span>_$(date +%F).sql.gz </span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<h4 id="Windows-下利用Powershell的MySQL数据库备份"><a href="#Windows-下利用Powershell的MySQL数据库备份" class="headerlink" title="Windows 下利用Powershell的MySQL数据库备份"></a>Windows 下利用Powershell的MySQL数据库备份</h4><p><strong>环境准备:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">测试环境: Server 2008 R2</span><br><span class="line">所需软件: </span><br><span class="line"> - MySQLdump.exe  </span><br><span class="line"> - msvcp120.dll  x64&#x2F;x86</span><br><span class="line"> - msvcr120.dll  x64&#x2F;x86</span><br><span class="line"> - powershell</span><br><span class="line"> - 7z</span><br></pre></td></tr></table></figure></p>
<p><strong>设置PowerShell策略:</strong><br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator&gt; <span class="built_in">Set-ExecutionPolicy</span> -ExecutionPolicy Unrestricted -Scope LocalMachine</span><br><span class="line"></span><br><span class="line">执行策略更改</span><br><span class="line">执行策略可以防止您执行不信任的脚本。更改执行策略可能会使您面临 about_Execution_Policies</span><br><span class="line">帮助主题中所述的安全风险。是否要更改执行策略?</span><br><span class="line">[Y] 是(Y)  [N] 否(N)  [S] 挂起(S)  [?] 帮助 (默认值为“Y”): Y</span><br></pre></td></tr></table></figure></p>
<p><strong>注册 mysqldump 依赖的dll
</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">regsvr32 msvcr120.dll</span><br><span class="line">regsvr32 msvcp120.dll</span><br></pre></td></tr></table></figure></p>
<p><strong>数据库相关信息查看:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- # 1.版本</span></span><br><span class="line"><span class="keyword">SELECT</span> @@<span class="keyword">version</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- # 2.指定数据库的表与表数据行统计查看</span></span><br><span class="line"><span class="keyword">select</span> table_name,table_rows <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> TABLE_SCHEMA = <span class="string">'authcenter'</span> <span class="keyword">order</span> <span class="keyword">by</span> table_rows <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- # 3.如有创建备份用户的需求，可以按照如下sql进行执行。</span></span><br><span class="line"><span class="comment">-- 备份用户创建及其权限赋予, 普通用户 mysqldump 的权限, 只需要该用户有 select 和 lock tables 的权限即可。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">`backupuser`</span>@<span class="string">`%`</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">'BcUP.2022weiyigeek'</span> <span class="keyword">PASSWORD</span> <span class="keyword">EXPIRE</span> <span class="keyword">NEVER</span>;</span><br><span class="line"><span class="keyword">GRANT</span> PROCESS <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'backupuser'</span>@<span class="string">'%'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">LOCK</span> <span class="keyword">TABLES</span> <span class="keyword">ON</span> <span class="string">`weiyigeekweb`</span>.* <span class="keyword">TO</span> <span class="string">'backupuser'</span>@<span class="string">'%'</span>;</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>
<p><strong>备份脚本一览:</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ------------------------------- #</span></span><br><span class="line"><span class="comment"># Author:WeiyiGeek                #</span></span><br><span class="line"><span class="comment"># PS: 数据库备份 &amp; 应用备份         #</span></span><br><span class="line"><span class="comment"># Create: 2020年6月11日 21:34:40   #</span></span><br><span class="line"><span class="comment"># ------------------------------- #    </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------- #</span></span><br><span class="line"><span class="comment"># 全局变量</span></span><br><span class="line"><span class="variable">$GD</span>=<span class="built_in">Get-Date</span></span><br><span class="line"><span class="variable">$TIME</span>=<span class="variable">$GD</span>.ToString(<span class="string">'yyyy-MM-dd_HHmmss'</span>)</span><br><span class="line"><span class="variable">$DATE</span>=<span class="variable">$GD</span>.ToString(<span class="string">'yyyy-MM-dd'</span>)</span><br><span class="line"><span class="variable">$global:BACKUP_SQLFILE</span> = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL 备份程序</span></span><br><span class="line"><span class="variable">$MYSQL_DUMP</span>=<span class="string">"D:\mysql\bin\mysqldump.exe"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩SQL文件</span></span><br><span class="line"><span class="variable">$7Zfile</span> = <span class="string">"C:\7-Zip\7z.exe"</span></span><br><span class="line"><span class="variable">$7ZPASS</span> = <span class="string">"WwW.WeiyiGeek.top"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定备份文件存放目录</span></span><br><span class="line"><span class="variable">$BACKUP_DIR</span> = <span class="string">"D:/mysql/SQL-$&#123;DATE&#125;"</span></span><br><span class="line"><span class="variable">$BACKUP_7ZDIR</span> = <span class="string">"D:/mysql/7Z-$&#123;DATE&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FTP 上传</span></span><br><span class="line"><span class="variable">$FTP_IP</span> = <span class="string">"192.168.12.31"</span></span><br><span class="line"><span class="variable">$FTP_PORT</span> = <span class="string">"21212"</span></span><br><span class="line"><span class="variable">$FTP_USER</span> = <span class="string">"User"</span></span><br><span class="line"><span class="variable">$FTP_PASS</span> = <span class="string">"Pass"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证备份文件夹是否创建</span></span><br><span class="line"><span class="variable">$FLAG</span>=<span class="built_in">Test-Path</span> -Path <span class="string">"<span class="variable">$BACKUP_DIR</span>"</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$FLAG</span> )&#123;</span><br><span class="line">  <span class="comment">#New-Item -ItemType Directory -Path $BACKUP_DIR/ -Force</span></span><br><span class="line">  mkdir <span class="string">"<span class="variable">$BACKUP_DIR</span>"</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL数据库备份链接</span></span><br><span class="line"><span class="keyword">function</span> dumpMySQL &#123;</span><br><span class="line">  <span class="keyword">param</span> (</span><br><span class="line">    [string] <span class="variable">$APP_HOST</span>=<span class="string">""</span>,</span><br><span class="line">    [string] <span class="variable">$APP_DBNAME</span>=<span class="string">""</span>,</span><br><span class="line">    [string] <span class="variable">$APP_DBU</span>=<span class="string">""</span>,</span><br><span class="line">    [string] <span class="variable">$APP_DBP</span>=<span class="string">""</span>,</span><br><span class="line">    [int] <span class="variable">$APP_PORT</span>=<span class="number">3306</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>([String]::IsNullOrEmpty(<span class="variable">$APP_HOST</span>) -or [String]::IsNullOrEmpty(<span class="variable">$APP_DBNAME</span>) -or [String]::IsNullOrEmpty(<span class="variable">$APP_DBU</span>) -or [String]::IsNullOrEmpty(<span class="variable">$APP_DBP</span>))&#123;</span><br><span class="line">  <span class="built_in">Write-Host</span> <span class="string">"# 备份 <span class="variable">$APP_DBNAME</span> 数据库错误 "</span>  -ForegroundColor red</span><br><span class="line">  [Environment]::<span class="keyword">Exit</span>(<span class="number">127</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">Write-Host</span> <span class="string">"# 正在备份 <span class="variable">$APP_DBNAME</span> 数据库 "</span>  -ForegroundColor Green</span><br><span class="line">  <span class="variable">$global:BACKUP_SQLFILE</span> = <span class="string">"$&#123;APP_DBNAME&#125;_$&#123;TIME&#125;.sql"</span></span><br><span class="line">  <span class="built_in">Invoke-Expression</span> <span class="string">"$&#123;MYSQL_DUMP&#125; -h <span class="variable">$APP_HOST</span> -P <span class="variable">$APP_PORT</span> --default-character-set=UTF8 -u<span class="variable">$APP_DBU</span> -p<span class="variable">$APP_DBP</span> -B --databases <span class="variable">$APP_DBNAME</span> --hex-blob --result-file=<span class="variable">$BACKUP_DIR</span>/<span class="variable">$BACKUP_SQLFILE</span>"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7Z 压缩SQL文件</span></span><br><span class="line"><span class="keyword">function</span> Compress7Z &#123;</span><br><span class="line">  <span class="comment"># 判断压缩备份目录是否存在</span></span><br><span class="line">    <span class="variable">$flag</span> = <span class="built_in">Test-Path</span> -Path <span class="string">"$&#123;BACKUP_7ZDIR&#125;"</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$flag</span>)&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">"正在建立 <span class="variable">$Dstdir</span> 备份目录 "</span> -ForegroundColor Green</span><br><span class="line">        <span class="built_in">New-Item</span> -ItemType Directory -Path <span class="variable">$BACKUP_7ZDIR</span> -Force</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Start-Process</span> -FilePath <span class="variable">$7Zfile</span> -ArgumentList <span class="string">"a -p$&#123;7ZPASS&#125; $&#123;BACKUP_7ZDIR&#125;\$&#123;BACKUP_SQLFILE&#125;.7z <span class="variable">$BACKUP_DIR</span>\*_$&#123;TIME&#125;.sql"</span> -WindowStyle hidden</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份文件上传方式</span></span><br><span class="line"><span class="keyword">function</span> uploadBack &#123;</span><br><span class="line">  <span class="keyword">param</span> (</span><br><span class="line">    [string] <span class="variable">$FLAG</span>=<span class="string">""</span></span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ftp 方式</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$FLAG</span> <span class="nomarkup">-eq</span> <span class="string">"ftp"</span> )&#123;</span><br><span class="line">    <span class="string">"open $&#123;FTP_IP&#125; $&#123;FTP_PORT&#125;"</span> | <span class="built_in">Out-File</span> ftp.tmp</span><br><span class="line">    <span class="string">"$&#123;FTP_USER&#125;"</span> | <span class="built_in">Out-File</span> -Append ftp.tmp</span><br><span class="line">    <span class="string">"$&#123;FTP_PASS&#125;"</span> | <span class="built_in">Out-File</span> -Append ftp.tmp</span><br><span class="line">    <span class="string">"bin"</span> | <span class="built_in">Out-File</span> -Append ftp.tmp</span><br><span class="line">    <span class="string">"mkdir $&#123;DATE&#125;"</span> | <span class="built_in">Out-File</span> -Append ftp.tmp</span><br><span class="line">    <span class="string">"cd $&#123;DATE&#125;"</span> | <span class="built_in">Out-File</span> -Append ftp.tmp</span><br><span class="line">    <span class="string">"put $&#123;BACKUP_7ZDIR&#125;\$&#123;BACKUP_SQLFILE&#125;.7z"</span> | <span class="built_in">Out-File</span> -Append ftp.tmp</span><br><span class="line">    <span class="string">"quit"</span> | <span class="built_in">Out-File</span> -Append ftp.tmp</span><br><span class="line">    <span class="built_in">Start-Process</span> ftp -ArgumentList <span class="string">"-i -s:ftp.tmp"</span></span><br><span class="line">    <span class="built_in">Remove-Item</span> -Path ftp.tmp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用MySQLDump函数执行下载(指定数据库拉取)</span></span><br><span class="line">dumpMySQL -APP_HOST <span class="number">127.0</span>.<span class="number">0.1</span> -APP_PORT <span class="number">8066</span> -APP_DBNAME <span class="string">"AuthCenterschema"</span> -APP_DBU <span class="string">"root"</span> -APP_DBP <span class="string">"123456"</span></span><br><span class="line"><span class="comment"># 调用压缩</span></span><br><span class="line">Compress7Z</span><br><span class="line"><span class="comment"># 调用上传</span></span><br><span class="line">uploadBack -FLAG <span class="string">"ftp"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#Write-Host "# 正在输出备份数据库路径: $BACKUP_DIR"  -ForegroundColor Green</span></span><br><span class="line"><span class="comment">#Get-ChildItem $BACKUP_DIR\*.sql </span></span><br><span class="line"><span class="comment">#Write-Host "# 正在输出压缩文件备份数据库路径: $&#123;BACKUP_7ZDIR&#125;"  -ForegroundColor Green</span></span><br><span class="line"><span class="comment">#Get-ChildItem $&#123;BACKUP_7ZDIR&#125;\*.7z</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<p><strong>定时任务设置:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每周5的一点进行备份同步(不管用户是否登陆)</span></span><br><span class="line">schtasks /create /TN mysql-backup  /SC WEEKLY  /D FRI /ST 01:00 /TR <span class="string">"powershell.exe d:\mysql\backup.ps1"</span> /NP</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="入坑问题解决"><a href="#入坑问题解决" class="headerlink" title="入坑问题解决"></a>入坑问题解决</h3><h4 id="0x01-学习MySQL所遇到得问题"><a href="#0x01-学习MySQL所遇到得问题" class="headerlink" title="0x01 学习MySQL所遇到得问题"></a>0x01 学习MySQL所遇到得问题</h4><p><strong>问题1：忘记的MySQL密码重置密码</strong><br>单实例方法：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">停止mysql服务</span></span><br><span class="line">/etc/init.d/mysqld stop</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">忽略授权登录验证</span></span><br><span class="line">mysqlsafe --skip-grant-tables --user=mysql &amp;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">直接空密码登录</span></span><br><span class="line">mysql -uroot -p </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">使用update方式修改密码</span></span><br><span class="line">UPDATE mysql.user SET password = PASSWORD("new_pass") WHERE user='root' and host='localhost';</span><br><span class="line">flush privileges;   #任何时候都要记住改密的啥时候都要更新权限；</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">采用mysqladmin来停止mysqlsafe服务</span></span><br><span class="line">mysqladmin -uroot -pnew_pass shutdwon</span><br><span class="line">/etc/init.d/mysqld start  #重启即可</span><br></pre></td></tr></table></figure><br>多实例的方法：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">kill</span>掉所有的mysql进程</span></span><br><span class="line">killall mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">使用多实例的配置文件与 --skip且必须放在后面</span></span><br><span class="line"> mysqld_safe --default-file=/data/3306/my.cnf --skip-grant-table;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">然后多实例登录修改密码 (这时密码为空)</span></span><br><span class="line">mysql -uroot -p -S /data/3306/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">同样采用上面的update方法修改密码</span></span><br><span class="line"><span class="meta">#</span><span class="bash">然后重启服务用新密码登录</span></span><br><span class="line">killall mysqld</span><br><span class="line">/data/3306/mysql restart</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>问题2：认证插件问题</strong><br>在安装mysql5.8后采用了最新的加密插件caching-sha2-password,用客户端连接比如navicate会提示客户端连接caching-sha2-password,是由于客户端不支持这种插件，可以通过如下方式进行修改：authentication plugin ‘caching_sha2_password’</p>
<p>mysql5.8开始将caching_sha2_password作为默认的身份验证插件<br>在MySQL 5.7中默认的身份验证插件是 mysql_native_password！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysql_native_password  密码认证方法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改加密规则  </span></span><br><span class="line">    ALTER USER 'root'@'localhost' IDENTIFIED BY 'password' PASSWORD EXPIRE NEVER; </span><br><span class="line"><span class="meta">#</span><span class="bash">更新密码（mysql_native_password模式）    </span></span><br><span class="line">    ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '&#123;NewPassword&#125;';</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>问题3：MySQL服务器内存太小问题</strong><br>检查一下 linux 系统的虚拟内存大小，如果内存不足 1G，启动 mysql 的时候可能会产生下面这个错误提示：　　<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Starting mysqld (via systemctl): Job for mysqld.service failed because the control process exited with error code.</span><br><span class="line">See &quot;systemctl status mysqld.service&quot; and &quot;journalctl -xe&quot; for details.[FAILED]</span><br></pre></td></tr></table></figure><br>起初安装的时候使用的是虚拟机自动分区，内存设置的是 1G，结果在这上面话费了大量的精力和时间去调试始终也启动没成功。</p>
<p><br></p>
<p><strong>问题4:用户权限问题不能创建PID</strong><br>出错如下：Starting MySQL..The server quit without updating PID file (/usr/local/mysql/var/localhost.localdomain.pid)<br>解决方法：配置PIDfile路径或者使用root用户启动mysql</p>
<p><br></p>
<p><strong>问题5:读取预读时间太长</strong><br>问题：Reading table information for completion of table and column names , You can turn off this feature to get a quicker startup with -A<br>原因：导致一般产生这个问题是由于MYSQL中数据库太大,导致读取预读时间太长,从而显示这个提示,如果之前都没有遇到这个问题,那么产生这个问题的原因可能是由于有改变数据库信息的操作,比如drop一个很大的表(几千万数据)而中途终止<code></code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">方法1： </span></span><br><span class="line">登录时候指定 -A 参数</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">方法2：</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist ;</span></span><br><span class="line">图中锁表的id为16545618,则可以使用kill命令,结束它.</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">kill</span> 16545618;</span></span><br></pre></td></tr></table></figure></p>
<p><br><br><strong>问题6:多实例mysql无法启动问题</strong><br>故障：利用脚本启动mysql总是Running，进程中也没有显示ps -ef /data/3306/mysqld start<br>原因：由于上次没有正常退出，导致sock文件未删除关闭；<br>解决方法：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rm -rf /data/3306/mysql.sock /data/3306/*pid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /data/3306/mysql restart</span></span><br></pre></td></tr></table></figure><br><br><br><strong>问题7: MySQL数据库备份入坑记录</strong></p>
<blockquote>
<p>问题1：mysqldump : got error 1556, you can’t user lock with log tables,when using LOCK TABLES;<br>原因：mysql默认数据库里的logs表,不能被加锁(Lock tables)引起的<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解决方法1：把mysql这个默认数据库相关的语句清空后,文件可以正常运行 （备份时候最后加入-B/-F）</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> mysqldump -uroot -ptest -B -F --single-transaction  eshop|gzip&gt;<span class="variable">$bakpath</span>/eshop_$(date +%F).sql.gz</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><br><br><strong>问题8: MySQL主从同步入坑记录</strong></p>
<blockquote>
<p>问题：主从同步last-error = 1007 ,无法创建数据库（DB_Create_exists）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解决方法1：主从数据不一致更重要还是保持主从同步只续状态更重要。</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> stop slave;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">set</span> global sql_slave_skip_counter = 1; <span class="comment">#忽略跳过错误，根据业务需求来决定。</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> start slave;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">解决方法2：根据错误号跳过指定的错误（从库my.cnf配置文件修改）</span></span><br><span class="line">slave-skip-errors = 1032,1062,1007   </span><br><span class="line"><span class="meta">#</span><span class="bash">或者但不建议使用all值忽略所有的错误信息。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">slave-skip-errors = all</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不同的数据库版本会引起不同步，低版本到高版本可以，但是高版本不能向低版本同步。</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><br><br><strong>问题9：导入全备恢复到数据库从中</strong></p>
<blockquote>
<p>问题：mysql eshop  &lt;/home/xxx/esho.0624.sql<br>ERROR 1030 (HY000) at line 46: Got error -1 from storage engine</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1.首先看看数据库备份内容是否异常</span><br><span class="line"><span class="variable">$less</span> /home/xxx/eshop_ett100.0624.sql</span><br><span class="line">-- MySQL dump 10.13  Distrib5.5.33, <span class="keyword">for</span> Linux (x86_64)</span><br><span class="line"></span><br><span class="line">2. 停止数据库调整配置文件参数</span><br><span class="line">$/etc/init.d/mysqld stop</span><br><span class="line">Shutting down MySQL. SUCCESS! </span><br><span class="line"></span><br><span class="line"><span class="variable">$vi</span> /etc/my.cnf &lt;==此处顺便调整相关其他参数</span><br><span class="line">innodb_force_recovery= 0 <span class="comment">#调整这个参数为0</span></span><br><span class="line">skip-external-locking</span><br><span class="line">key_buffer_size = 256M</span><br><span class="line">max_allowed_packet = 1M</span><br><span class="line">table_open_cache = 614</span><br><span class="line">sort_buffer_size = 1M</span><br><span class="line">read_buffer_size = 1M</span><br><span class="line">read_rnd_buffer_size = 4M</span><br><span class="line">myisam_sort_buffer_size = 64M</span><br><span class="line">thread_cache_size = 8</span><br><span class="line">query_cache_size= 16M</span><br><span class="line">query_cache_limit = 1M</span><br><span class="line">query_cache_min_res_unit = 2k</span><br><span class="line"><span class="comment"># Try number of CPU's*2 for thread_concurrency</span></span><br><span class="line">thread_concurrency = 8</span><br><span class="line"></span><br><span class="line">3.重启MYSQL服务建立utf-8字符集的数据库</span><br><span class="line">mysql&gt; create database eshop CHARACTER SET utf8  COLLATE utf8_general_ci;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">4.最后直接导入全备到数据库中</span><br><span class="line"></span><br><span class="line">5.更改账号密码权限</span><br><span class="line">grant select,insert,update,delete on eshop.* to<span class="string">'etiantian'</span>@<span class="string">'localhost'</span> identified by <span class="string">'test110'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>问题10：增量数据库恢复规则</strong></p>
<blockquote>
<p>mysqlbinlog mysql-bin.000014mysql-bin.000015 –start-datetime=’2014-06-24 02:23:00’ &gt;bin.sql<br>mysqlbinlog: unknown variable ‘default-character-set=utf8’</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解决方法：添加--no-defaults参数开始增量恢复</span></span><br><span class="line">$/install/mysql/bin/mysqlbinlog --no-defaultsmysql-bin.000014 mysql-bin.000015 --start-datetime=<span class="string">'2014-06-24 02:23:00'</span>&gt;bin.sql</span><br><span class="line"><span class="variable">$less</span> bin.sql  <span class="comment">#查看增量恢复出来的sql</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>问题11：强制killall停止mysql导致的错误</strong><br>查看/var/log/mysql/err.log日志可以看到：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">InnoDB: Error: auto-extending data file ./ibdata1 is of a different size140624 18:51:58 [ERROR] Plugin <span class="string">'InnoDB'</span> init <span class="keyword">function</span> returned error.</span><br><span class="line">140624 18:51:58 [ERROR] Plugin <span class="string">'InnoDB'</span> registration as a STORAGE ENGINE failed.</span><br><span class="line">140624 18:51:58 [ERROR] Unknown/unsupported storage engine: InnoDB</span><br><span class="line">140624 18:51:58 [ERROR] Aborting</span><br><span class="line"></span><br><span class="line"><span class="comment">#原因：强制终止了进程或者改变了数据文件即强制关闭服务导致innodb表空间或文件异常</span></span><br><span class="line"><span class="comment">#解决流程：</span></span><br><span class="line"></span><br><span class="line">1.根据常规判断及历史记录（<span class="built_in">history</span>命令行及/root/.mysql_history文件）</span><br><span class="line">2.找到数据库的配置文件/etc/my.cnf</span><br><span class="line">进而找到了数据库安装路径/install/mysql</span><br><span class="line">数据文件路径/data/mysql</span><br><span class="line">binlog的路径/data/mysql</span><br><span class="line">db备份路径/home/xx/</span><br><span class="line">3. 检查binlog是否完整,全备是否有效</span><br><span class="line">4. 然后利用问题9解决方法进行恢复</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>问题12：mysq8首次登陆显示ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement</strong><br>远程：MySQL版本5.6.6版本起，添加了password_expired功能，它允许设置用户的过期时间。这个特性已经添加到mysql.user数据表，但是它的默认值是”N”，可以使用ALTER USER语句来修改这个值。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解决方法</span></span><br><span class="line">mysql&gt; ALTER USER USER() IDENTIFIED BY <span class="string">'Xiaoming250'</span>;  <span class="comment">#MySQL版本5.7.6版开设 </span></span><br><span class="line">ALTER USER <span class="string">'xiaoming'</span>@<span class="string">'localhost'</span> PASSWORD EXPIRE; <span class="comment">#将账号密码强制到期：</span></span><br><span class="line">ALTER USER <span class="string">'testuser'</span>@<span class="string">'localhost'</span> PASSWORD EXPIRE NEVER; <span class="comment">#禁用到期</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>问题13:MySQL中”Invalid default value”错误解决方法</strong><br>描述:在插入SQL语句的时候由于设置了time和default 0000-00-00导致报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#原因1：datetime类型只支持mysql 5.6.5+.</span></span><br><span class="line">CREATE TABLE `sys_expense` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `createtime` datetime DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=23 DEFAULT CHARSET=utf8 COMMENT=<span class="string">'报销表'</span>;</span><br><span class="line"><span class="comment">#解决办法：将datetime修改成为timestamp；</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#原因2：由于time、datetime类型在5.7之后默认不在支持0000-00-00，会导致上面的错误</span></span><br><span class="line">`createtime` time NOT NULL DEFAULT <span class="string">"0000-00-00"</span> COMMIT <span class="string">"登录时间"</span>;</span><br><span class="line"><span class="comment">#解决办法：在/etc/my.cnf配置文件中插入</span></span><br><span class="line">sql-mode=ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"><span class="comment">#或者将上面的0000-00-00替换成为1970-01-01</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>问题14:PowerShell引发mysqldump导出文件的字符集错误</strong><br>问题描述:尝试使用PS执行mysqldump导出数据库，发现导出的数据库有中文乱码的问题，用vscode发信导出的sql文件是utf-16，而数据库默认的字符集是utf-8；<br>问题解决思路:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 尝试采用Out-File模块指定编码格式，执行后tbl_test.sql文件打开的默认编码已经是utf-8但是里面的文依然还是乱码。</span></span><br><span class="line">mysqldump -uroot -p --default-character-set=UTF8 --databases test_db --tables tbl_test --hex-blob | Out-File E:\Temp\tbl_test.sql -EnCoding UTF8</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 最终的解决办法直接在命令行中指定`--result-file`参数</span></span><br><span class="line">mysqldump -uroot -p --default-character-set=UTF8 --databasestest_db --tables tbl_test --hex-blob --result-file=E:\Temp\tbl_test.sql</span><br></pre></td></tr></table></figure><br>参考地址:<a href="https://dev.mysql.com/doc/refman/5.5/en/mysqldump.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.5/en/mysqldump.html</a></p>
<p><br></p>
<p><strong>问题15:mysql出现unblock with ‘mysqladmin flush-hosts’</strong><br>问题描述: 系统应用登录的时候提示MySQL连接超时, 此时应用和数据库是否都正常，且数据库没有问题但是应用日志报无法连接数据库。<br>错误信息:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据库版本是：5.5.53</span></span><br><span class="line"><span class="comment"># telnet  8.8.9.9 3306</span></span><br><span class="line"><span class="comment"># Trying 8.8.9.9...</span></span><br><span class="line"><span class="comment"># Connected to 8.8.9.9.</span></span><br><span class="line"><span class="comment"># Escape character is '^]'.</span></span><br><span class="line"><span class="comment"># gHost 'kapp' is blocked because of many connection errors; unblock with 'mysqladmin flush-hosts'Connection closed by foreign host.</span></span><br></pre></td></tr></table></figure><br>错误原因: 同一个ip在短时间内产生太多（超过mysql数据库max_connect_errors的最大值）中断的数据库连接而导致的阻塞;<br><code>max_connect_errors</code> 是一个MySQL中与安全有关的计数器值，它负责阻止过多尝试失败的客户端以防止暴力破解密码的情况。<br><code>max_connect_errors</code> 的值与性能并无太大关系，默认是10，不知道为何改为了2。意味着如果某一客户端尝试连接此MySQL服务器，但是失败（如密码错误等等）2次 ，则MySQL会无条件强制阻止此客户端连接。所以如果max_connect_errors设置过小，则网页可能提示无法连接数据库服务器。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; show variables like <span class="string">'max_connect_errors'</span>;</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| max_connect_errors | 2     |</span><br><span class="line">+--------------------+-------+</span><br></pre></td></tr></table></figure></p>
<p>解决办法:如果希望重置此计数器的值，则必须重启MySQL服务器或者执行mysql&gt; flush hosts; 命令。当这一客户端成功连接一次MySQL服务器后，针对此客户端的max_connect_errors会清零。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决方法1：修改max_connect_errors的值</span></span><br><span class="line">(1)进入Mysql数据库查看max_connect_errors：</span><br><span class="line">&gt; show variables like <span class="string">'%max_connect_errors%'</span>;</span><br><span class="line">(2)修改max_connect_errors的值：</span><br><span class="line">&gt; <span class="built_in">set</span> global max_connect_errors = 100;</span><br><span class="line">(3)查看是否修改成功</span><br><span class="line">&gt; show variables like <span class="string">'%max_connect_errors%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决方法2：使用mysqladmin flush-hosts 命令清理一下hosts文件</span></span><br><span class="line">(1)在查找到的目录下使用命令修改：mysqladmin -u xxx -p flush-hosts</span><br><span class="line">或者</span><br><span class="line">&gt; flush hosts;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决方法3：重启mysqld 也可以在重启之前，在配置文件中将该参数调大。</span></span><br><span class="line"><span class="comment"># vi /etc/my.cnf</span></span><br><span class="line">max_connect_errors = 100</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p><strong>问题16:利用mysqldump进行备份出现Error: ‘Access denied； you need (at least one of) the PROCESS privilege(s) for this operation’ when trying to dump tablespaces错误</strong><br>问题环境: MySQL/8.0.24</p>
<p>问题描述: 在虚拟机的 centos7 上备份数据库，执行脚步时报错 <code>mysqldump: Error: &#39;Access denied; you need (at least one of) the PROCESS privilege(s) for this operation&#39; when trying to dump tablespaces</code>。</p>
<p>解决办法:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户只有本机可以访问的执行如下命令授权PROCESS 权限</span></span><br><span class="line">GRANT PROCESS ON *.* TO <span class="string">'数据库用户名'</span>@<span class="string">''</span>localhost<span class="string">''</span>;</span><br><span class="line"><span class="comment"># 用户全局可以访问的执行如下命令授权PROCESS 权限</span></span><br><span class="line">GRANT PROCESS ON *.* TO <span class="string">'数据库用户名'</span>@<span class="string">''</span>%<span class="string">''</span>;</span><br><span class="line"><span class="comment"># 最后刷新权限</span></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>问题17.程序连接到mysql服务端时报 <code>java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed</code> 错误。</strong><br>问题环境: MySQL/8.0.24<br>问题描述:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">02-18 06:51:09.429 ERROR [com.alibaba.druid.pool.DruidDataSource ] - create connection SQLException, url: jdbc:mysql://cmsmysql:3306/web?useSSL=<span class="literal">false</span>&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;serverTimezone=Asia/ShangMultiQueries=<span class="literal">true</span>, errorCode 0, state 08001</span><br><span class="line">java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed</span><br></pre></td></tr></table></figure><br>问题原因: 如果用户使用了 sha256_password 认证，密码在传输过程中必须使用 TLS 协议保护，但是如果 RSA 公钥不可用，可以使用服务器提供的公钥；可以在连接中通过 ServerRSAPublicKeyFile 指定服务器的 RSA 公钥，或者加上<code>AllowPublicKeyRetrieval=True</code> 参数以允许客户端从服务器获取公钥；但是需要注意的是 AllowPublicKeyRetrieval=True 可能会导致恶意的代理通过中间人攻击(MITM)获取到明文密码，所以默认是关闭的，必须显式开启<br>解决办法: 可以将jdbc连接字符串改为 <code>jdbc:mysql://localhost:3306/user?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=true</code></p>
<hr>
<h4 id="0x02-MySQL的出错代码表"><a href="#0x02-MySQL的出错代码表" class="headerlink" title="0x02 MySQL的出错代码表"></a>0x02 MySQL的出错代码表</h4><p>根据mysql的头文件 /mysql/include/mysqld_error.h 整理而成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1005</span>：创建表失败</span><br><span class="line"><span class="number">1006</span>：创建数据库失败</span><br><span class="line"><span class="number">1007</span>：数据库已存在，创建数据库失败</span><br><span class="line"><span class="number">1008</span>：数据库不存在，删除数据库失败</span><br><span class="line"><span class="number">1009</span>：不能删除数据库文件导致删除数据库失败</span><br><span class="line"><span class="number">1010</span>：不能删除数据目录导致删除数据库失败</span><br><span class="line"><span class="number">1011</span>：删除数据库文件失败</span><br><span class="line"><span class="number">1012</span>：不能读取系统表中的记录</span><br><span class="line"><span class="number">1020</span>：记录已被其他用户修改</span><br><span class="line"><span class="number">1021</span>：硬盘剩余空间不足，请加大硬盘可用空间</span><br><span class="line"><span class="number">1022</span>：关键字重复，更改记录失败</span><br><span class="line"><span class="number">1023</span>：关闭时发生错误</span><br><span class="line"><span class="number">1024</span>：读文件错误</span><br><span class="line"><span class="number">1025</span>：更改名字时发生错误</span><br><span class="line"><span class="number">1026</span>：写文件错误</span><br><span class="line"><span class="number">1032</span>：记录不存在</span><br><span class="line"><span class="number">1036</span>：数据表是只读的，不能对它进行修改</span><br><span class="line"><span class="number">1037</span>：系统内存不足，请重启数据库或重启服务器</span><br><span class="line"><span class="number">1038</span>：用于排序的内存不足，请增大排序缓冲区</span><br><span class="line"><span class="number">1040</span>：已到达数据库的最大连接数，请加大数据库可用连接数</span><br><span class="line"><span class="number">1041</span>：系统内存不足</span><br><span class="line"><span class="number">1042</span>：无效的主机名</span><br><span class="line"><span class="number">1043</span>：无效连接</span><br><span class="line"><span class="number">1044</span>：当前用户没有访问数据库的权限</span><br><span class="line"><span class="number">1045</span>：不能连接数据库，用户名或密码错误</span><br><span class="line"><span class="number">1048</span>：字段不能为空</span><br><span class="line"><span class="number">1049</span>：数据库不存在</span><br><span class="line"><span class="number">1050</span>：数据表已存在</span><br><span class="line"><span class="number">1051</span>：数据表不存在</span><br><span class="line"><span class="number">1054</span>：字段不存在</span><br><span class="line"><span class="number">1062</span>：字段值重复，入库失败</span><br><span class="line"><span class="number">1065</span>：无效的SQL语句，SQL语句为空</span><br><span class="line"><span class="number">1081</span>：不能建立Socket连接</span><br><span class="line"><span class="number">1114</span>：数据表已满，不能容纳任何记录</span><br><span class="line"><span class="number">1116</span>：打开的数据表太多</span><br><span class="line"><span class="number">1129</span>：数据库出现异常，请重启数据库</span><br><span class="line"><span class="number">1130</span>：连接数据库失败，没有连接数据库的权限</span><br><span class="line"><span class="number">1133</span>：数据库用户不存在</span><br><span class="line"><span class="number">1141</span>：当前用户无权访问数据库</span><br><span class="line"><span class="number">1142</span>：当前用户无权访问数据表</span><br><span class="line"><span class="number">1143</span>：当前用户无权访问数据表中的字段</span><br><span class="line"><span class="number">1146</span>：数据表不存在</span><br><span class="line"><span class="number">1147</span>：未定义用户对数据表的访问权限</span><br><span class="line"><span class="number">1149</span>：SQL语句语法错误</span><br><span class="line"><span class="number">1158</span>：网络错误，出现读错误，请检查网络连接状况</span><br><span class="line"><span class="number">1159</span>：网络错误，读超时，请检查网络连接状况</span><br><span class="line"><span class="number">1160</span>：网络错误，出现写错误，请检查网络连接状况</span><br><span class="line"><span class="number">1161</span>：网络错误，写超时，请检查网络连接状况</span><br><span class="line"><span class="number">1169</span>：字段值重复，更新记录失败</span><br><span class="line"><span class="number">1177</span>：打开数据表失败</span><br><span class="line"><span class="number">1180</span>：提交事务失败</span><br><span class="line"><span class="number">1181</span>：回滚事务失败</span><br><span class="line"><span class="number">1203</span>：当前用户和数据库建立的连接已到达数据库的最大连接数，请增大可用的数据库连接数或重启数据库</span><br><span class="line"><span class="number">1205</span>：加锁超时</span><br><span class="line"><span class="number">1211</span>：当前用户没有创建用户的权限</span><br><span class="line"><span class="number">1216</span>：外键约束检查失败，更新子表记录失败</span><br><span class="line"><span class="number">1217</span>：外键约束检查失败，删除或修改主表记录失败</span><br><span class="line"><span class="number">1226</span>：当前用户使用的资源已超过所允许的资源，请重启数据库或重启服务器</span><br><span class="line"><span class="number">1227</span>：权限不足，您无权进行此操作</span><br><span class="line"><span class="number">1235</span>：MySQL版本过低，不具有本功能</span><br><span class="line"><span class="number">1250</span>：客户端不支持服务器要求的认证协议，请考虑升级客户端。</span><br><span class="line"><span class="number">2000</span>：像素格式无效。</span><br><span class="line"><span class="number">2001</span>：指定的驱动程序无效。</span><br><span class="line"><span class="number">2002</span>：该操作的窗口样式或类属性无效。</span><br><span class="line"><span class="number">2003</span>：不支持请求的图元文件操作。</span><br><span class="line"><span class="number">2004</span>：不支持请求的转换操作。</span><br><span class="line"><span class="number">2005</span>：不支持请求的剪辑操作。</span><br><span class="line"><span class="number">2010</span>：指定的颜色管理模块无效。</span><br><span class="line"><span class="number">2011</span>：指定的颜色文件配置无效。</span><br><span class="line"><span class="number">2012</span>：找不到指定的标识。</span><br><span class="line"><span class="number">2013</span>：所需的标识不存在。</span><br><span class="line"><span class="number">2014</span>：指定的标识已经存在。</span><br><span class="line"><span class="number">2015</span>：指定的颜色文件配置与任何设备都不相关。</span><br><span class="line"><span class="number">2016</span>：找不到该指定的颜色文件配置。</span><br><span class="line"><span class="number">2017</span>：指定的颜色空间无效。</span><br><span class="line"><span class="number">2018</span>：图像颜色管理没有启用。</span><br><span class="line"><span class="number">2019</span>：在删除该颜色转换时有一个错误。</span><br><span class="line"><span class="number">2020</span>：指定的颜色转换无效。</span><br><span class="line"><span class="number">2021</span>：指定的转换与位图的颜色空间不匹配。</span><br><span class="line"><span class="number">2022</span>：指定的命名颜色索引在配置文件中不存在。</span><br><span class="line"><span class="number">2108</span>：网络连接已成功，但需要提示用户输入一个不同于原始指定的密码。</span><br><span class="line"><span class="number">2202</span>：指定的用户名无效。</span><br><span class="line"><span class="number">2250</span>：网络连接不存在。</span><br><span class="line"><span class="number">2401</span>：在这个网络连接上已存在打开的文件或未处理的请求。</span><br><span class="line"><span class="number">2402</span>：活动的连接仍然存在。</span><br><span class="line"><span class="number">2404</span>：设备正由活动进程使用，无法断开连接。</span><br><span class="line"><span class="number">3000</span>：指定的打印监视程序未知。</span><br><span class="line"><span class="number">3001</span>：指定的打印机驱动程序正在使用中。</span><br><span class="line"><span class="number">3002</span>：找不到假脱机文件。</span><br><span class="line"><span class="number">3003</span>：没有发出：StartDocPrinter：调用。</span><br><span class="line"><span class="number">3004</span>：尚未发出：AddJob：调用。</span><br><span class="line"><span class="number">3005</span>：指定的打印处理程序已经安装。</span><br><span class="line"><span class="number">3006</span>：指定的打印监视程序已经安装。</span><br><span class="line"><span class="number">3007</span>：该指定的打印监视器不具备所要求的功能。</span><br><span class="line"><span class="number">3008</span>：指定的打印机监视器正在使用中。</span><br><span class="line"><span class="number">3009</span>：当打印机有作业排成队列时此操作请求是不允许的。</span><br><span class="line"><span class="number">3010</span>：请求的操作成功。只有重新启动系统，更改才会生效。</span><br><span class="line"><span class="number">3011</span>：请求的操作成功。只有重新启动服务，更改才会生效。</span><br><span class="line"><span class="number">3012</span>：找不到打印机。</span><br><span class="line"><span class="number">4000</span>：WINS：在处理命令时遇到执行错误。</span><br><span class="line"><span class="number">4001</span>：无法删除本地的：WINS。</span><br><span class="line"><span class="number">4002</span>：从文件引入失败。</span><br><span class="line"><span class="number">4003</span>：备份失败。以前执行过完整的备份吗</span><br><span class="line"><span class="number">4004</span>：备份失败。请检查备份数据库的目标目录。</span><br><span class="line"><span class="number">4005</span>：名称在：WINS：数据库中不存在。</span><br><span class="line"><span class="number">4006</span>：不允许进行未配置部分的复制。</span><br><span class="line"><span class="number">4100</span>：DHCP：客户获得一个在网上已被使用的：IP：地址。直到：DHCP：客户可以获得新的地址前，本地接口将被禁用。</span><br><span class="line"><span class="number">4200</span>：WMI：数据提供程序不能识别传来的：GUID：是否有效。</span><br><span class="line"><span class="number">4201</span>：WMI：数据提供程序无法识别传来的实例名是否有效。</span><br><span class="line"><span class="number">4202</span>：WMI：数据提供程序无法识别传来的数据项目标识符是否有效。</span><br><span class="line"><span class="number">4203</span>：无法完成：WMI：请求，请重试一次。</span><br><span class="line"><span class="number">4204</span>：找不到：WMI：数据提供程序。</span><br><span class="line"><span class="number">4205</span>：WMI：数据提供程序引用到一个未注册的实例组。</span><br><span class="line"><span class="number">4206</span>：WMI：数据块或事件通知已启用。</span><br><span class="line"><span class="number">4207</span>：WMI：数据块不再可用。</span><br><span class="line"><span class="number">4208</span>：WMI：数据服务无法使用。</span><br><span class="line"><span class="number">4209</span>：WMI：数据提供程序无法完成请求。</span><br><span class="line"><span class="number">4210</span>：WMI：MOF：信息无效。</span><br><span class="line"><span class="number">4211</span>：WMI：注册信息无效。</span><br><span class="line"><span class="number">4212</span>：WMI：数据块或事件通知已禁用。</span><br><span class="line"><span class="number">4213</span>：WMI：数据项目或数据块为只读。</span><br><span class="line"><span class="number">4214</span>：WMI：数据项目或数据块不能更改。</span><br><span class="line"><span class="number">6118</span>：该工作组的服务器列表当前不可用。</span><br><span class="line"><span class="number">6200</span>：要正常运行，任务计划程序服务的配置必须在系统帐户中运行。单独的任务可以被配置成在其他帐户中运行。</span><br><span class="line"><span class="number">7001</span>：指定的会话名无效。</span><br><span class="line"><span class="number">7002</span>：指定的协议驱动程序无效。</span><br><span class="line"><span class="number">7003</span>：在系统路径上找不到指定的协议驱动程序。</span><br><span class="line"><span class="number">7004</span>：在系统路径上找不到指定的终端连接驱动程序。</span><br><span class="line"><span class="number">7005</span>：不能为这个会话创建一个事件日志的注册键。</span><br><span class="line"><span class="number">7006</span>：同名的一个服务已经在系统中存在。</span><br><span class="line"><span class="number">7007</span>：在会话上一个关闭操作挂起。</span><br><span class="line"><span class="number">7008</span>：没有可用的输出缓冲器。</span><br><span class="line"><span class="number">7009</span>：找不到：MODEM.INF：文件。</span><br><span class="line"><span class="number">7010</span>：在：MODEM.INF：中没有找到调制解调器名称。</span><br><span class="line"><span class="number">7011</span>：调制解调器没有接受发送给它的指令。验证配置的调制解调器与连接的调制解调器是否匹配。：<span class="number">7012</span>：调制解调器没有响应发送给它的指令。验证该调制解调器是否接线正确并且打开了电源开关。</span><br><span class="line"><span class="number">7013</span>：由于断开连接，载波检测失败或载波停止。</span><br><span class="line"><span class="number">7014</span>：在要求的时间内没有发现拨号音。确定电话线连接正确并可使用。</span><br><span class="line"><span class="number">7015</span>：在远程站点回叫时检测到了占线信号。</span><br><span class="line"><span class="number">7016</span>：在回叫时远程站点上检测到了声音。</span><br><span class="line"><span class="number">7017</span>：传输驱动程序错误</span><br><span class="line"><span class="number">7022</span>：找不到指定的会话。</span><br><span class="line"><span class="number">7023</span>：指定的会话名称已处于使用中。</span><br><span class="line"><span class="number">7024</span>：由于终端连接目前正在忙于处理一个连接、断开连接、复位或删除操作，无法完成该请求的操作。</span><br><span class="line"><span class="number">7025</span>：试图连接到其视频模式不受当前客户支持的会话。</span><br><span class="line"><span class="number">7035</span>：应用程序尝试启动：DOS：图形模式。不支持：DOS：图形模式。</span><br><span class="line"><span class="number">7037</span>：您的交互式登录权限已被禁用。请与您的管理员联系。</span><br><span class="line"><span class="number">7038</span>：该请求的操作只能在系统控制台上执行。这通常是一个驱动程序或系统：DLL：要求直接控制台访问的结果。</span><br><span class="line"><span class="number">7040</span>：客户未能对服务器连接消息作出响应。</span><br><span class="line"><span class="number">7041</span>：不支持断开控制台会话。</span><br><span class="line"><span class="number">7042</span>：不支持重新将一个断开的会话连接到控制台。</span><br><span class="line"><span class="number">7044</span>：远程控制另一个会话的请求被拒绝。</span><br><span class="line"><span class="number">7045</span>：拒绝请求的会话访问。</span><br><span class="line"><span class="number">7049</span>：指定的终端连接驱动程序无效。</span><br><span class="line"><span class="number">7050</span>：不能远程控制请求的会话。这也许是由于该会话被中断或目前没有一个用户登录。另外，您不能从该系统控制台远程控制一个会话或远程控制系统控制台。并且，您不能远程控制您自己的当前会话。</span><br><span class="line"><span class="number">7051</span>：该请求的会话没有配置成允许远程控制。</span><br><span class="line"><span class="number">7052</span>：连接到这个终端服务器的申请被拒绝。终端服务器客户许可证目前正在被另一个用户使用。请与系统管理员联系，获取一份新的终端服务器客户，其许可证号码必须是有效的、唯一的。</span><br><span class="line"><span class="number">7053</span>：连接到这个终端服务器的申请被拒绝。还没有为这份终端服务器客户输入您的终端服务器客户许可证号码。请与系统管理员联系，为该终端服务器客户输入一个有效的、唯一的许可证号码。</span><br><span class="line"><span class="number">7054</span>：系统已达到其授权的登录限制。请以后再试一次。</span><br><span class="line"><span class="number">7055</span>：您正在使用的客户没有使用该系统的授权。您的登录请求被拒绝。</span><br><span class="line"><span class="number">7056</span>：系统许可证已过期。您的登录请求被拒绝。</span><br></pre></td></tr></table></figure>

        </div>
        <!-- Google 广告 -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-03-29T05:39:06.312Z" itemprop="dateUpdated">2022-03-29 13:39:06</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/数据存储/Database-运维/MySQL/基础知识/4-MYSQL容备与入坑.md" target="_blank" rel="noopener noreferrer">_posts/数据存储/Database-运维/MySQL/基础知识/4-MYSQL容备与入坑.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2019/3-26-84.html" target="_blank" rel="external">https://blog.weiyigeek.top/2019/3-26-84.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MYSQL/" rel="tag">MYSQL</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/3-26-84.html&title=《4-MYSQL容备与入坑》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/3-26-84.html&title=《4-MYSQL容备与入坑》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/3-26-84.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《4-MYSQL容备与入坑》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/3-26-84.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/3-26-84.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2019/3-27-25.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">操作系统学习笔记(一).md</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/3-25-364.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">轻量化HTTP服务器环境快速搭建部署</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#容灾备份介绍"><span class="post-toc-number">1.</span> <span class="post-toc-text">容灾备份介绍</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x00-MySQL数据库存储目录迁徙"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">0x00 MySQL数据库存储目录迁徙</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x01-MySQL数据库-表备份还原的操作"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">0x01 MySQL数据库|表备份还原的操作</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-增量恢复MySQL数据实战"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">0x02 增量恢复MySQL数据实战</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x03-主从复制之MYSQL增量恢复实战"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">0x03 主从复制之MYSQL增量恢复实战</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x04-数据库-表备份总结"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">0x04 数据库|表备份总结</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#备份shell脚本"><span class="post-toc-number">2.</span> <span class="post-toc-text">备份shell脚本</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#批量备份数据库与库中之表"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">批量备份数据库与库中之表</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Windows-下利用Powershell的MySQL数据库备份"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Windows 下利用Powershell的MySQL数据库备份</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#入坑问题解决"><span class="post-toc-number">3.</span> <span class="post-toc-text">入坑问题解决</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x01-学习MySQL所遇到得问题"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">0x01 学习MySQL所遇到得问题</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-MySQL的出错代码表"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">0x02 MySQL的出错代码表</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- 微信公众号关注/文章版权复制 -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好看友,欢迎关注博主微信公众号哟! ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】即可关闭继续浏览文章.<br>  <b style="color:red;"> 温馨提示: 未解锁的用户不能粘贴复制文章内容哟!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">博主Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">博主Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">墨天轮</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">西瓜视频</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2023 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/3-26-84.html&title=《4-MYSQL容备与入坑》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/3-26-84.html&title=《4-MYSQL容备与入坑》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/3-26-84.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《4-MYSQL容备与入坑》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/3-26-84.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/3-26-84.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKElEQVR42u3aSW7kQAwEQP//0/Z5MGghk5QNqBQ6Gb1UK3SguX19xdf3hyt/9/qTn75784WBgfFYRnLc/0df/+Q19dPnWzYGBsbbGPnRyQ/n30peub43DAwMjE1AnCWCGBgYGBtGjskTyuRkDAwMjLyInWH2wf3mWhwDA+OBjLzr/vd//8p8AwMD41GMTamZBOL8zFUBjIGBcTRjP8Jsw2Wb3hWJJgYGxtGM6y/krfyk0d8uauTLHBgYGGczNi2wTdM/Ty6je8DAwDiaMetl5aF2NuC8uXeIgYHxWMamNf+LT65MTDEwMM5mJKlhXpS2hetdySUGBsbZjDbVm204JAF9tUyGgYFxNKNN+9pmfVvcJusXefKKgYFxEmOT2OWhs23rD2ewGBgYhzJmY4A84WsHpatRJQYGxnGMVtkOA9rB5zCfxcDAOJrRlqzJQHH2aOppBgYGxmsYbeicjTlnaxnFY8LAwDiaMQusCWm2cNYOQf85DQMD4wWMWZhrhwrtyKF4oBgYGC9gtOGyLXdnrxdDUAwMjKMZ+QByNhdt1zJmiSMGBsapjO/ySlK6/EaT8B0VwxgYGEczNkGzHQm0RW+bjGJgYJzNyBtbbVu/XeZYpaEYGBgvYAzbW6MydfMfoKjCMTAwXs+Y3fpmFBrtuGFgYGDE5ehsPJkvn92WGmJgYDyKkRexxapWnCDOBgmrdhsGBsajGPf2strVjXYIsRpkYmBgPI/xAzOwrWOsfUeuAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// 站点运行时间
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "天" + RunHours + "时" + RunMinutes + "分" + RunSeconds + "秒";
  document.getElementById(id).innerHTML = "网站已在风雨中勉勉强强运行了【" + RunTime + "】";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>