{"title":"高可用服务解决方案(DBA).md","slug":"系统运维/系统架构/高可用/Heartbeat高可用服务解决方案","date":"2019-04-09T06:34:30.000Z","updated":"2022-03-29T05:39:06.301Z","url":"2019/4-9-261.html","path":"api/articles/2019/4-9-261.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190406230526.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190408225805.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190409160848.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190409233728.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190429150631.png"],"content":"<p>[TOC]</p>\n<h4 id=\"文章目录\"><a href=\"#文章目录\" class=\"headerlink\" title=\"文章目录\"></a>文章目录</h4><p>(1) Heartbeat 高可用解决方案</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-Heartbeat-高可用\"><a href=\"#0x00-Heartbeat-高可用\" class=\"headerlink\" title=\"0x00 Heartbeat 高可用\"></a>0x00 Heartbeat 高可用</h4><p><em>Q:什么是高可用技术呢？</em><br>答：在生产环境中我既要保证服务不间断的服务又要保证服务器稳定不down机，但是异常还是会发生;<br>比如说服务器硬件损坏导致服务器down机,我该如何保证服务器down机后继续提供服务呢？这时我就应该请出高可用技术来帮忙了，当我们的服务器发生故障后不能继续时，高可用集群技术解决将业务及服务自动转移至其他主机服务器上继续服务，保证服务架构不间断运行。</p>\n<h5 id=\"1-Heartbeat-介绍\"><a href=\"#1-Heartbeat-介绍\" class=\"headerlink\" title=\"1) Heartbeat 介绍\"></a>1) Heartbeat 介绍</h5><p><strong>1.1 Heartbeat作用</strong><br>描述：是Linux-HA 工程的一个组成部分，它实现了一个高可用集群系统,常常使用在分区集群等大型架构中<br>通过heartbeat,可以将资源（ip以及程序服务等资源）从一台已经故障的计算机快速转移到另一台正常运转的机器上继续提供服务,一般称之为高可用服务;</p>\n<p>heartbeat和keepalived(近年来使用增加,但是某些场景还是不及hb)有很多相同之处,但是也有区别:</p>\n<ol>\n<li>Keepalived</li>\n</ol>\n<ul>\n<li>使用的vrrp协议方式,虚拟路由冗余协议 (Virtual Router Redundancy Protocol，简称VRRP)</li>\n<li>目的是模拟路由器的双机</li>\n<li>常常与lvs负载均衡的高可用中使用结合</li>\n<li>ka主要控制IP飘移，配置应用简单，而且分层，layer3，4，5，各自配置极为简单</li>\n</ul>\n<ol start=\"2\">\n<li>Heartbeat</li>\n</ol>\n<ul>\n<li>基于主机或网络的服务的高可用方式；</li>\n<li>目的是用户service的双机</li>\n<li>中间件业务的高可用中使用但是与lvs负载均衡配置比较麻烦需要其他脚本介入(ldirectord),常常与drbd进行联合使用</li>\n<li>hb不但可以控制IP飘移，更擅长对资源服务的控制，配置，应用于比较复杂场景</li>\n</ul>\n<p><strong>1.2 Heartbeat工作原理</strong><br>描述：通过修改heartbeat的配置文件，可以指定一台heartbeat服务器作为主服务器，另一台自动成为热备服务器。<br>在热备服务器上面配置heartbeat守护程序来监听来自主服务器的心跳信息;如果在规定时间内，无法监听到心跳信息，那么就启动故障转移，取得主服务器上的相关资源的所有权，接替主服务器继续不间断的提供服务，从而达到资源以及服务高可用的目的;</p>\n<p>Heartbeat支持模式：</p>\n<ul>\n<li>主从模式</li>\n<li>主主模式</li>\n<li>互为主备</li>\n</ul>\n<p>一般故障转移切换时间在5~20s之间(hearbeat需要进行arp广播,资源收缩等);<em>和keepalived的服务一样，heartbeat高可用是服务器级别的，不是服务级别的</em>。 </p>\n<p><em>切换漂移的条件：</em></p>\n<ol>\n<li>主服务器物理宕机（硬件损坏，操作系统故障）</li>\n<li>heartbeat软件故障</li>\n<li>两台主备服务器之间心跳连接故障<br>服务故障不会导致切换,可以通过服务宕机把heartbeat服务停掉。 </li>\n</ol>\n<p><strong>1.3 Heartbeat心跳连接</strong><br>高可用服务器上的Heartbeat软件会利用这条心跳连接线来检查对端的机器释放存活,进而决定是否做故障漂移,资源切换来保证业务的连续性;<br><em>Q:如何进行心跳连接与监控?</em><br>答：至少需要两台主机才可以实现高可用服务,采用通信技术使两台heartbeat服务之间通信;</p>\n<ul>\n<li>穿行电缆，所谓的串口Serial（首先，缺点是距离不能太远）</li>\n<li>一根以太网电缆两网卡直连（常用方式）</li>\n<li>以太网电缆，通过交换机等网络设备连接。（交换机可能出现问题,心跳数据容易受到影响等） </li>\n</ul>\n<p><strong>1.4 Heartbeat应用场景</strong></p>\n<ul>\n<li>Nginx/haproxy高可用</li>\n<li>数据库主从库主的高可用</li>\n<li>LVS-DR负载均衡高可用</li>\n<li>共享存储高可用</li>\n</ul>\n<p>实际工作中两种高可用问题：<br>(1) hb仅仅控制vip资源,不负责服务资源的启动及停止;比如下面的Heartbeat 安装与配置(Web服务)<br>(2) hb即控制vip资源的漂移,同时又控制服务资源启动及停止;比如下面的实例;(适合数据库和存储)</p>\n<p>其他架构参考：<br>(1) heartbeat+drbd+mysql     #数据库高可用 (后面会进行讲解)<br>(2) heartbeat+active+nfs/mfs #存储高可用</p>\n<p><em>Tips:</em></p>\n<ul>\n<li>一般来说只有内网机器很多的情况下,才有可能使用heartbeat,几台机器是没有必要的；</li>\n<li>如果VIP正常httpd服务宕掉这时候它有可能不做高可用切换;需要自己写个脚本判断httpd服务,如果有问题则停止hb使业务转到另外一台服务器上;</li>\n</ul>\n<p><br></p>\n<h5 id=\"2-Heartbeat-脑裂介绍\"><a href=\"#2-Heartbeat-脑裂介绍\" class=\"headerlink\" title=\"2) Heartbeat 脑裂介绍\"></a>2) Heartbeat 脑裂介绍</h5><p><em>裂脑(splitbrain)原理：</em><br>两台服务器在一定时间内，无法相互检测到对方心跳而各自启动故障转移功能，取得资源和服务的所有权，会导致同一个IP在两端同时启动服务，存在两个相同的VIP，造成冲突可能导致服务器两端的数据不一致或数据丢失;(即共享资源被瓜分，服务都起不起来了又或者服务都起来，但是共享资源同时写，最后数据就被破坏了！)</p>\n<p><strong>2.1 裂脑原因</strong></p>\n<ul>\n<li>心跳链路故障(心跳线老化,接触不良,网卡驱动问题等等),导致无法正常通信 </li>\n<li>开启了防火墙阻挡了心跳信息传输;</li>\n<li>心跳网卡地址等配置不正确;</li>\n<li>服务配置错误,心跳方式异常，心跳广播冲突，软件bug;</li>\n</ul>\n<p><strong>2.2 裂脑解决</strong></p>\n<ul>\n<li>同时使用串行电缆和以太网电缆连接，同时使用两条心跳线（推荐）</li>\n<li>检测到裂脑时,强制关闭一个节点(需要特殊设备支持,如stonish和fence), 相当于程序上的备节点发现心跳故障，发送关机指令到主节点</li>\n<li>监控预警(短信电话通知运维人员),报警在服务器接管之前给人员处理留足时间,报警后不直接服务器此时接管而是由人员来控制操作</li>\n<li>启用磁盘锁,做冗余</li>\n<li>仲裁机制（确定让那个节点接管服务）, 通过第三方软件仲裁谁获得资源;</li>\n</ul>\n<p><strong>2.3 fence介绍</strong><br>描述：Fence是HA集群环境下的术语,在硬件领域fence设备其实就是一个智能电源管理设备(IPMI,Intelligent PowerManagement Interface);其分为内/外部fence,这些设备都有以太网口的,用来在HA切换触发时通过网络重启提供资源服务的服务器;</p>\n<p>不同服务器对应Fence设备名称：</p>\n<ul>\n<li>IBM：RSA II</li>\n<li>HP：ILO 2</li>\n<li>DELL：iDRAC 3</li>\n<li>外部fence设备：有APC（UPS电源生产商）生产的PowerSwitch </li>\n</ul>\n<h5 id=\"3-Heartbeat-消息列表\"><a href=\"#3-Heartbeat-消息列表\" class=\"headerlink\" title=\"3) Heartbeat 消息列表\"></a>3) Heartbeat 消息列表</h5><p>高可用软件工作过程中,一般来说由三种消息类型：</p>\n<ul>\n<li>心跳信息：150字节的数据包,可能为单播,广播或多播方式;可以控制心跳频率与出现故障的等待时间;</li>\n<li>集群转换消息: ip-request (Master 恢复在线状态时) / ip-request-rsp (Slave 释放主服务器失败时取得的资源及服务),主服务器收到备节点的该消息则提供正常访问;</li>\n<li>重传消息：rexmit-request 控制重传心跳请求 </li>\n</ul>\n<p><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190406230526.png\" alt=\"WeiyiGeek.集群转换消息\"></p>\n<p>提示：以上心跳控制消息都使用UDP协议发生到/etc/ha.d/ha.cf 文件指定的任意端口或者指定多播地址;</p>\n<p><strong>3.1 IP地址接管和故障转移</strong><br>通过IP地址接管和ARP广播进行故障转移的,ARP广播在主服务器故障时候,备用节点接管资源后,会立即强制更新所有Client本地arp表(VIP地址与mac地址的解析记录),<em>确保客户端和新的服务器对话</em>;</p>\n<p><strong>3.2 VIP/IP 别名/辅助IP</strong></p>\n<ul>\n<li><p>真实IP又称为管理/物理ip，一般指配置在物理网卡上面的ip。在负载均衡高可用环境中，管理IP是不对外提供访问服务的。仅仅作为管理服务器使用，如SSH可以通过这个进行服务连接管理。</p>\n</li>\n<li><p>VIP是虚拟ip,实际上就是eth0:X，x为0~255的任意数字，你可以在一个网卡上面绑定多个别名。VIP当主服务器故障时，可以自动漂移到备用服务器。</p>\n</li>\n</ul>\n<p>注意区别辅助ip和别名ip，keepalived和heartbeat3都是用辅助ip的形式;在实际生产环境中需要在DNS配置中把网站域名地址解析到VIP地址而并发非真实IP地址;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#辅助ip设置：(HA/HB3 现在都采用这个)</span></span><br><span class=\"line\">ip addr add 192.168.12.1/24 broadcast 192.168.12.255 dev eth1</span><br><span class=\"line\">ip addr del 192.168.12.1/24 broadcast 192.168.12.255 dev eth1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#别名ip设置：（收工设置 HB2版本时候使用）</span></span><br><span class=\"line\">ifconfig eth0:1 192.168.12.1 netmask 255.255.255.224 up</span><br><span class=\"line\">ifconfig eth0:1 192.168.12.1 netmask 255.255.255.224 down</span><br></pre></td></tr></table></figure>\n<p>管理IP/VIP对比：</p>\n<ul>\n<li>管理IP来回迁移非常难做到</li>\n<li>VIP 方便管理与配置</li>\n</ul>\n<h5 id=\"4-Heartbeat-安装与配置\"><a href=\"#4-Heartbeat-安装与配置\" class=\"headerlink\" title=\"4) Heartbeat 安装与配置\"></a>4) Heartbeat 安装与配置</h5><p><strong>1.环境需求介绍</strong><br>需求：当Master-data1或者Master-data2任意一台服务器宕机,再宕机的机器上初始启动的虚拟VIP就会自动切换到运作正常的机器上,实现IP资源的自动接管,从而达到高可用无业务影响的目的; </p>\n<p>在实际生产环境中,也可以配置主备模式,即只在主的一端配置VIP,备的一端仅处于热备状态;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">系统：CentOS release 6.10 (Final) </span><br><span class=\"line\">内核：Linux WeiyiGeek 2.6.32-754.10.1.el6.i686 2019 GNU/Linux</span><br><span class=\"line\">虚拟软件：VirtualBOX (管理-&gt; 全局设定 -&gt; NAT 网络 -&gt; 配置两个1/2网段将自动获取IP去掉)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#机器1 Master-data1 </span></span><br><span class=\"line\">管理IP ：192.168.1.100</span><br><span class=\"line\">心跳连接：192.168.2.100</span><br><span class=\"line\">VIP ：192.168.1.10</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#机器2 Master-data2 </span></span><br><span class=\"line\">管理IP ：192.168.1.101</span><br><span class=\"line\">心跳连接：192.168.2.101</span><br><span class=\"line\">VIP ：192.168.1.11</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#两台机器都关闭防火墙和unix安全</span></span><br><span class=\"line\"><span class=\"comment\">#关闭iptables和selinux： </span></span><br><span class=\"line\">[root@Master-data1/2 ~]<span class=\"comment\"># getenforce</span></span><br><span class=\"line\">Disabled</span><br></pre></td></tr></table></figure>\n<p>Tips:</p>\n<ul>\n<li>建议大家把内外网IP最后8位配置成为相同的方式,容易记忆方便管理;</li>\n<li>另外存储服务器之间,存储服务器和交换机之间可配置成双千兆网卡绑定（bonding）来提升网卡性能;</li>\n<li>在部署进行主机规划意义重大,它让我们思路清晰;</li>\n</ul>\n<p><strong>2.Heartbeat版本和配置</strong><br>官方网站：<a href=\"http://www.linux-ha.org/wiki/Download\" target=\"_blank\" rel=\"noopener\">http://www.linux-ha.org/wiki/Download</a><br>Heartbeat-3.X版本以后被分为了4个模块，这些安装包都可以从官网：</p>\n<ul>\n<li>Heartbeat 3.0.6        //心跳主程序包</li>\n<li>Cluster Glue 1.0.12    //可重复使用的群集组件（光盘）</li>\n<li>Resource Agents 3.9.6   //集群实验资源代理（光盘）</li>\n<li>Pacemaker-1.1.9-1512.el6.src.rpm   //起搏器（光盘镜像）<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190408225805.png\" alt=\"WeiyiGeek.Heartbeat下载\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Heartbeat下载</p>\n            </figure>\n</li>\n</ul>\n<p>HA默认配置文件目录/etc/ha.d/,常用配置文件：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ha.cf     参数配置文件    配置heartbeat一些基本参数</span><br><span class=\"line\">authkey   认证文件        高可用服务器对之间根据对端的authkey(对端进行相互认证-防止第三者插足)</span><br><span class=\"line\">haresource  资源配置文件  配置启动IP资源及脚本程序/服务等</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#/etc/ha.d/resource.d/ 以后开发的程序存放目录直接可以进行调用</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>环境配置</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##Step1.配置DATA1与DATA2的 IP地址</span></span><br><span class=\"line\">vim /etc/sysconfig/network-scripts/ifcfg-eth2</span><br><span class=\"line\">DEVICE=eth2</span><br><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\">UUID=c3f35428-3740-4791-bc38-8e0d69707d4b</span><br><span class=\"line\">ONBOOT=yes</span><br><span class=\"line\">NM_CONTROLLED=no</span><br><span class=\"line\">BOOTPROTO=static</span><br><span class=\"line\">IPADDR=192.168.2.100</span><br><span class=\"line\">NETMASK=255.255.255.0</span><br><span class=\"line\">; GATEWAY=192.168.1.1    心跳线IP配置不用配网关和DNS</span><br><span class=\"line\"><span class=\"comment\">#或者采用临时生效 </span></span><br><span class=\"line\">$ ifconfig eth2 192.168.2.100</span><br><span class=\"line\">$ ifdown eth2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#机器1 Master-data1</span></span><br><span class=\"line\">ETH1:inet addr:192.168.1.100  Bcast:192.168.1.255  Mask:255.255.255.0  <span class=\"comment\">#管理</span></span><br><span class=\"line\">ETH2:inet addr:192.168.2.100    <span class=\"comment\">#心跳</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#机器2 Master-data2</span></span><br><span class=\"line\">ETH1:inet addr:192.168.1.101  Bcast:192.168.1.255  Mask:255.255.255.0</span><br><span class=\"line\">ETH2:inet addr:192.168.2.101  <span class=\"comment\">#心跳</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##Step2.配置主机名</span></span><br><span class=\"line\">[root@WeiyiGeek ~]$ hostname Master-data1</span><br><span class=\"line\">[root@WeiyiGeek ~]$ sed -i <span class=\"string\">'s/HOSTNAME=WeiyiGeek/HOSTNAME=Master-data1/g'</span> /etc/sysconfig/network</span><br><span class=\"line\">[root@WeiyiGeek ~]$ sed -i <span class=\"string\">'s/HOSTNAME=WeiyiGeek/HOSTNAME=Master-data2/g'</span> /etc/sysconfig/network</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#两台机器上分别运行</span></span><br><span class=\"line\">cat &gt;&gt; /etc/hosts&lt;&lt;eof</span><br><span class=\"line\">192.168.1.100 Master-data1</span><br><span class=\"line\">192.168.1.101 Master-data2</span><br><span class=\"line\">eof</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#判断能否相互通信</span></span><br><span class=\"line\">[root@Master-data1 ]<span class=\"comment\"># ping Master-data2</span></span><br><span class=\"line\">64 bytes from Master-data2 (192.168.1.101): icmp_seq=1 ttl=64 time=0.415 ms</span><br><span class=\"line\">64 bytes from Master-data2 (192.168.1.101): icmp_seq=2 ttl=64 time=0.545 ms</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ]<span class=\"comment\"># ping Master-data1</span></span><br><span class=\"line\">64 bytes from Master-data1 (192.168.1.100): icmp_seq=1 ttl=64 time=1.04 ms</span><br><span class=\"line\">64 bytes from Master-data1 (192.168.1.100): icmp_seq=2 ttl=64 time=0.796 ms</span><br></pre></td></tr></table></figure></p>\n<p><em>Tips:</em> hosts配置在heartbeat服务中会用到,后文的drbd及存储高可用性能配置都会用到;在实际的生产环境中会把所有机器名对应上所有的机器IP地址;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Step3.心跳连接配置(实际添加两条主机路由)</span></span><br><span class=\"line\">route add -host 192.168.2.101 dev eth2   <span class=\"comment\">#Master-data1 (对端的IP)</span></span><br><span class=\"line\">route add -host 192.168.2.100 dev eth2   <span class=\"comment\">#Master-data2</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">'/sbin/route add -host 192.168.2.101 dev eth2'</span> &gt;&gt; /etc/rc.local <span class=\"comment\">#配置开机自动配置,同上</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ route -n  <span class=\"comment\">#查看路由</span></span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">192.168.2.101   0.0.0.0         255.255.255.255 UH    0      0        0 eth2  <span class=\"comment\">#Master-data1 (对端的IP)</span></span><br><span class=\"line\"></span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">192.168.2.100   0.0.0.0         255.255.255.255 UH    0      0        0 eth2  <span class=\"comment\">#Master-data2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step4.安装Heartbeat3.x软件包</span></span><br><span class=\"line\">TIPS：先yum search heartbeat看看是否有相关可以下载的包;没有的话下载安装epel扩展 (注意选中对应的版本)</span><br><span class=\"line\">mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup</span><br><span class=\"line\">yum install -y epel-release  <span class=\"comment\">#或者</span></span><br><span class=\"line\">rpm -ivh http://dl.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm   <span class=\"comment\">#注意系统版本</span></span><br><span class=\"line\">rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm </span><br><span class=\"line\">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 <span class=\"comment\">#导入key</span></span><br><span class=\"line\">[root@Master-data[1/2] ~]<span class=\"comment\"># rpm -qa | grep epel</span></span><br><span class=\"line\">epel-release-6-8.noarch</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#进行yum安装heartbeat （您也可选中编译安装）</span></span><br><span class=\"line\">TIPS：yum 安装rpm包安装后本地不清除的方法  sed -i <span class=\"string\">\"s/keepcache=0/keppcache=1/g\"</span> /etc/yum.conf  </span><br><span class=\"line\">$ yum install heartbeat* -y</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step5.配置文件</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ <span class=\"built_in\">cd</span> /usr/share/doc/heartbeat-3.0.4/  <span class=\"comment\">#配置模板目录</span></span><br><span class=\"line\">$ cp ha.cf haresources authkeys /etc/ha.d/  <span class=\"comment\"># authkeys(600权限)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## ha.cf 文件配置</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ vim ha.cf</span><br><span class=\"line\">[root@Master-data1 ha.d]<span class=\"comment\"># grep -v -E \"^#\" ha.cf</span></span><br><span class=\"line\">debugfile /var/<span class=\"built_in\">log</span>/ha-debug</span><br><span class=\"line\">logfile /var/<span class=\"built_in\">log</span>/ha-log</span><br><span class=\"line\">logfacility     local0  <span class=\"comment\">#以上为日志配置 </span></span><br><span class=\"line\"></span><br><span class=\"line\">keepalive 2</span><br><span class=\"line\">deadtime 30</span><br><span class=\"line\">warntime 10</span><br><span class=\"line\">initdead 120  <span class=\"comment\">#以上为基础参数,配置不需要改动</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关键点（多播的网卡）</span></span><br><span class=\"line\">mcast eth1 225.0.0.11 694 1 0    <span class=\"comment\">#注意这里是11 netmask （关键点）子网掩码对应</span></span><br><span class=\"line\">auto_failback on</span><br><span class=\"line\">node    Master-data1</span><br><span class=\"line\">node    Master-data2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## authkeys 文件配置</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$  chmod 600 authkeys</span><br><span class=\"line\">[root@Master-data1 ha.d]$  vim authkeys</span><br><span class=\"line\">auth 2</span><br><span class=\"line\">2 sha1 HI! <span class=\"comment\">#这里HI是密匙</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## haresources 文件配置</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ vim haresources</span><br><span class=\"line\"><span class=\"comment\">#node-name resource1 resource2 ... resourceN</span></span><br><span class=\"line\">45 Master-data1 IPaddr::192.168.1.10/24/eth1   <span class=\"comment\">#这里的IP 网卡 与 mcast 参数是存在关联的 （关键点）</span></span><br><span class=\"line\">46 Master-data2 IPaddr::192.168.1.11/24/eth1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step6.拷贝配置文件到Master-data2中 （注意如果对应IP网卡不对就需要修改）</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ tar -zcvf test.tar.gz ha.cf authkeys haresources</span><br><span class=\"line\">[root@Master-data2 ha.d]$ scp root@192.168.1.100:/etc/ha.d/test.tar.gz /etc/ha.d/</span><br><span class=\"line\">$ tar -zxvf test.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step7. 启动heartbeat</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ /etc/init.d/heartbeat start</span><br><span class=\"line\">[root@Master-data2 ha.d]$ /etc/init.d/heartbeat start</span><br><span class=\"line\">Starting High-Availability services: INFO:  Resource is stopped</span><br><span class=\"line\">INFO:  Resource is stopped</span><br><span class=\"line\">Done.</span><br><span class=\"line\"></span><br><span class=\"line\">正常情况需要等待120s来恢复网络：</span><br><span class=\"line\">[root@Master-data1 ha.d]$ ip addr | grep -v -E <span class=\"string\">\"link|inet6\"</span> | grep <span class=\"string\">\"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.100/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\">    inet 192.168.1.10/24 brd 192.168.1.255 scope global secondary eth1  <span class=\"comment\">#虚拟VIP </span></span><br><span class=\"line\">    inet 192.168.2.100/24 brd 192.168.2.255 scope global eth2</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ha.d]$ ip addr | grep -v -E <span class=\"string\">\"link|inet6\"</span> | grep <span class=\"string\">\"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.101/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\">    inet 192.168.1.11/24 brd 192.168.1.255 scope global secondary eth1 <span class=\"comment\">#虚拟VIP </span></span><br><span class=\"line\">    inet 192.168.2.101/24 brd 192.168.2.255 scope global eth2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step8. 切换延时</span></span><br><span class=\"line\"><span class=\"comment\">#服务器停掉/网卡down掉/heartbeat服务关闭（停掉Master-data1）</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ /etc/init.d/heartbeat stop</span><br><span class=\"line\">$ ip addr | grep -v -E <span class=\"string\">\"link|inet6\"</span> | grep <span class=\"string\">\"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.100/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#此时Master-data2进行接管 (当Master-data1 重新启动后将会自动进行接管)</span></span><br><span class=\"line\">[root@Master-data2 ha.d]$ ip addr | grep -v -E <span class=\"string\">\"link|inet6\"</span> | grep <span class=\"string\">\"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.101/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\">    inet 192.168.1.11/24 brd 192.168.1.255 scope global secondary eth1</span><br><span class=\"line\">    inet 192.168.1.10/24 brd 192.168.1.255 scope global secondary eth1</span><br></pre></td></tr></table></figure>\n<h5 id=\"5-实战案例\"><a href=\"#5-实战案例\" class=\"headerlink\" title=\"5) 实战案例\"></a>5) 实战案例</h5><p>目的：通过一个WEB服务高可用案例熟悉heartbeat软件的使用,在上面基础之上进行实现;<br>环境：安装 httpd (不多说)</p>\n<p><em>步骤流程：</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 配置httpd首页将Master-data1 / Master-data2分别写入index.html</span><br><span class=\"line\">[root@Master-data1 ~]$ <span class=\"built_in\">echo</span> <span class=\"string\">\"Master-data1 192.168.1.100\"</span> &gt; /var/www/html/index.html</span><br><span class=\"line\">[root@Master-data2 ~]$ <span class=\"built_in\">echo</span> <span class=\"string\">\"Master-data2 192.168.1.101\"</span> &gt; /var/www/html/index.html</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2. 配置host域名来解析(判断VIP是不是被漂移)</span><br><span class=\"line\">[root@Master-data2 ~]$ <span class=\"built_in\">echo</span> <span class=\"string\">'192.168.1.10 www.demo.org'</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\">[root@Master-data2 ~]$ ping www.demo.org</span><br><span class=\"line\">PING www.demo.org (192.168.1.10) 56(84) bytes of data.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3.开启主备的httpd与heartbeat服务</span><br><span class=\"line\">[root@Master-data1 ~]$ /etc/init.d/heartbeat start</span><br><span class=\"line\">$ service httpd start</span><br><span class=\"line\">Starting httpd:                                            [  OK  ]</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ~]$ /etc/init.d/heartbeat start</span><br><span class=\"line\">$ /etc/init.d/httpd start</span><br><span class=\"line\">Starting httpd:                                            [  OK  ]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4.模式释放 <span class=\"comment\">#[Master-data1] 上执行</span></span><br><span class=\"line\">[root@Master-data1 html]$ /usr/share/heartbeat/hb_standby  <span class=\"comment\">#[Master-data1] heartbeat3.0.4</span></span><br><span class=\"line\">Going standby [all].</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">5.实现的效果</span><br><span class=\"line\">[root@Master-data2 ~]$ curl www.demo.org <span class=\"comment\">#(master-data1 释放前)</span></span><br><span class=\"line\">Master-data1 192.168.1.100</span><br><span class=\"line\">[root@Master-data2 ~]$ curl www.demo.org  <span class=\"comment\">#(master-data1 释放后)</span></span><br><span class=\"line\">Master-data2 192.168.1.101</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">6.此时以将漂移到Master-data2上</span><br><span class=\"line\">[root@Master-data2 ~]$ ip addr | grep -v -E <span class=\"string\">\"link|inet6\"</span> | grep <span class=\"string\">\"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.101/24 brd 192.168.1.255 scope global eth3</span><br><span class=\"line\">    inet 192.168.1.11/24 brd 192.168.1.255 scope global secondary eth3</span><br><span class=\"line\">    inet 192.168.1.10/24 brd 192.168.1.255 scope global secondary eth3</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">7.恢复接管</span><br><span class=\"line\">/usr/share/heartbeat/hb_takeover  <span class=\"comment\">#heartbeat3.0.4</span></span><br><span class=\"line\">[root@Master-data1 html]$ ip addr | grep -v -E <span class=\"string\">\"link|inet6\"</span> | grep <span class=\"string\">\"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.100/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\">    inet 192.168.1.10/24 brd 192.168.1.255 scope global secondary eth1</span><br><span class=\"line\">    inet 192.168.1.11/24 brd 192.168.1.255 scope global secondary eth1</span><br></pre></td></tr></table></figure></p>\n<p><em>第二种方式：</em> 让heartbeat负责httpd启动同时负责vip启动<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Step1.将httpd放权给heatbeat </span></span><br><span class=\"line\">chkconfig httpd off  <span class=\"comment\">#分别关闭httpd自启动</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step2.配置http服务启动脚本(由于yum安装已经制动就有了) [Master-data1/2 配置一致]</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ cp /etc/init.d/httpd /etc/ha.d/resource.d  <span class=\"comment\">#拷贝到hb默认脚本目录中</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#step3.修改haresource 加上httpd启动脚本   [Master-data1/2 配置一致]</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ vim haresources</span><br><span class=\"line\">Master-data1 IPaddr::192.168.1.10/24/eth1 httpd  <span class=\"comment\">#注意这里只需要配置一个httpd 服务即可(随着VIP漂移而开启与停止)</span></span><br><span class=\"line\">Master-data2 IPaddr::192.168.1.11/24/eth1 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#step4.验证查看</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ netstat -tlnp | grep <span class=\"string\">\"httpd\"</span>  <span class=\"comment\">#没有启动</span></span><br><span class=\"line\">[root@Master-data1 ha.d]$ /etc/init.d/heartbeat start  <span class=\"comment\">#主节点开启heartbeat</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data1 resource.d]$ netstat -tlnp | grep <span class=\"string\">\"httpd\"</span>  <span class=\"comment\">#等待120s后启动</span></span><br><span class=\"line\">tcp        0      0 :::80                       :::*                        LISTEN      12984/httpd</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ha.d]$ curl www.demo.org</span><br><span class=\"line\">Master-data1 192.168.1.100</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step5.当主备同时启动heartbeat时候</span></span><br><span class=\"line\"><span class=\"comment\">#Master-data1 heartbeat/主机挂了才会httpd 启动 （默认在Master-data1启动）</span></span><br><span class=\"line\"><span class=\"comment\">#还是会在Master-data1主机进行启动httpd,这时候停止该主机上的heartbeat便会进行漂移到data2上是;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ha.d]$ netstat -tlnp | grep <span class=\"string\">\"httpd\"</span></span><br><span class=\"line\">tcp        0      0 :::80                       :::*                        LISTEN      12063/httpd</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ha.d]$ curl www.demo.org</span><br><span class=\"line\">Master-data2 192.168.1.101</span><br><span class=\"line\"><span class=\"comment\">#可以通过log文件观察 httpd 停止/启动</span></span><br><span class=\"line\">ResourceManager(default)[14023]: </span><br><span class=\"line\">2019/04/09_23:32:35 info: Releasing resource group: master-data1     IPaddr::192.168.1.10/24/eth1 httpd</span><br><span class=\"line\"></span><br><span class=\"line\">ResourceManager(default)[14023]:       </span><br><span class=\"line\">2019/04/09_23:32:35 info: Running /etc/ha.d/resource.d/httpd  stop</span><br></pre></td></tr></table></figure></p>\n<p><em>注意事项：</em></p>\n<ul>\n<li>脚本路径要放入/etc/init.d/httpd 或 /etc/ha.d/resource.d/</li>\n<li>脚本执行需要支持 stop/start方式脚本具备可执行权限,且与haresource 中脚本名称一致</li>\n<li>如果httpd服务被卡死,会自己重启系统(进行进程自杀)</li>\n<li>常用git/svn进行配置heartbeat配置文件,重要的事情说三遍(备份/备份/备份);</li>\n<li>在正式的环境中建议先进行测试(找个流量低谷),手动配置临时网卡来测试网络方面的问题;</li>\n</ul>\n<p><br></p>\n<h5 id=\"补充（附录）\"><a href=\"#补充（附录）\" class=\"headerlink\" title=\"补充（附录）\"></a>补充（附录）</h5><p><strong>0.heartbeat释放模拟脚本</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#完全释放</span></span><br><span class=\"line\">/usr/lib64/heartbeat/hb_standby</span><br><span class=\"line\">/usr/share/heartbeat/hb_standby  <span class=\"comment\">#heartbeat3.0.4</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#完全接管</span></span><br><span class=\"line\">/usr/lib64/heartbeat/hb_takeover</span><br><span class=\"line\">/usr/share/heartbeat/hb_takeover  <span class=\"comment\">#heartbeat3.0.4</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>1.配置文件讲解</strong><br>ha.cf<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/ha.d/ha.cf</span><br><span class=\"line\">24 debugfile /var/<span class=\"built_in\">log</span>/ha-debug  <span class=\"comment\">#调试日志文件，取默认值</span></span><br><span class=\"line\">29 logfile /var/<span class=\"built_in\">log</span>/ha-log     <span class=\"comment\">#系统日志文件，取默认值    </span></span><br><span class=\"line\">34 ogfacility local0   <span class=\"comment\">#在syslog服务中配置通过local1设备接收日志 表示使用系统日志与上面只能开启一个</span></span><br><span class=\"line\"></span><br><span class=\"line\">48 keepalive 2 <span class=\"comment\">#心跳频率，可以自己设定 heartbeat 之间的时间间隔为 2 秒。也可以200ms 表示200毫秒</span></span><br><span class=\"line\">56 deadtime 30  <span class=\"comment\">#节点死亡时间的阀值，就是从节点在过了 30 秒后还没有收到心跳就认为主节点死亡</span></span><br><span class=\"line\">61 warntime 10  <span class=\"comment\">#指定心跳延迟的为10S,当10s内备份节点不能接收到主节点的心跳信号,并在日志中发出“late heartbeat“警告前等待的时间，</span></span><br><span class=\"line\">71 initdead 120  <span class=\"comment\">#在某些系统上，系统启动或重启之后需要经过一段时间网络才能正常工作，该选项用于解决这种情况产生的时间间隔。取值至少为 deadtime 的两倍。</span></span><br><span class=\"line\">76 udpport 694  <span class=\"comment\">#心跳信息传递的UDP端口，使用端口 694 进行 bcast 和 ucast 通信。这是默认的，并且在 IANA 官方注册的端口号。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#baud   19200  #串行端口的波特率</span></span><br><span class=\"line\"><span class=\"comment\">#serial /dev/ttyS0      # Linux  #串口的接口名</span></span><br><span class=\"line\"><span class=\"comment\">#serial /dev/cuaa0      # FreeBSD</span></span><br><span class=\"line\"><span class=\"comment\">#serial /dev/cuad0      # FreeBSD 6.x</span></span><br><span class=\"line\"><span class=\"comment\">#serial /dev/cua/a      # Solaris</span></span><br><span class=\"line\"><span class=\"comment\">#bcast  eth0            # Linux #传播心跳的广播网卡信息</span></span><br><span class=\"line\"><span class=\"comment\">#bcast  eth1 eth2       # Linux</span></span><br><span class=\"line\"><span class=\"comment\">#bcast  le0             # Solaris</span></span><br><span class=\"line\"><span class=\"comment\">#bcast  le1 le2         # Solaris</span></span><br><span class=\"line\"></span><br><span class=\"line\">91 <span class=\"comment\">#bcast  eth0   #表示在 eth0 接口上使用广播 heartbeat（将 eth1 替换为 eth0， eth2，或者您使用的任何接口）,心跳网卡，如果你有两个网卡，可以写成 eth1 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重点需要更网卡的物理ip在一个网段</span></span><br><span class=\"line\">113 mcast eth0 225.0.0.1 694 1 0    <span class=\"comment\">#说明：采用udp多播播来通知心跳(稳定）， D类地址建议在副节点不只一台时使用(默认端口694) 多播传送心跳的网卡 多播组 端口 跃点数 是否回环内传送</span></span><br><span class=\"line\">121 <span class=\"comment\">#ucast eth0 192.168.1.64    #需要修改，表示从本机的 eth0 接口发心跳消息给对方节点，写另一端的IP 地址。这是单播地址。 xuegod64 上改为 192.168.1.63 </span></span><br><span class=\"line\">157 auto_failback on    <span class=\"comment\">#默认启用，当 auto_failback 设置为 on 时，一旦主节点重新恢复联机，将从从节点取回所有资源。若该选项设置为 off，主节点便不能重新获得资源。</span></span><br><span class=\"line\"></span><br><span class=\"line\">211 node Master-data1  <span class=\"comment\">#(主节点)需要修改，该选项是必须配置的。集群中机器的主机名，与“uname –n”的输出相同。</span></span><br><span class=\"line\">212 node Master-data2  <span class=\"comment\">#(备用节点)需要修改</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#使用ping模式 有时当主机挂掉或者heartbeat挂掉后vip才会转移  有时出现某个进程挂掉 切换需要使用脚本 </span></span><br><span class=\"line\"><span class=\"comment\">#ping模式用于测试 如果网卡ping不同 某个主机 就认为当前断网 需要转移vip </span></span><br><span class=\"line\">220 ping 192.186.1.254 <span class=\"comment\">#需要修改，通过ping命令实现仲裁</span></span><br><span class=\"line\">253 respawn hacluster /usr/libexec/heartbeat/ipfail  <span class=\"comment\">#当ping不通时 自动调用 ipfail这个脚本</span></span><br><span class=\"line\">259 apiauth ipfail gid=haclient uid=hacluster  <span class=\"comment\"># 表示有权限操作ipfail脚本的组和用户</span></span><br><span class=\"line\"></span><br><span class=\"line\">157 auto_failback on <span class=\"comment\">#auto_failback on 为 on 时，主结点恢复正常后，资源自动转给主结点。建议设为 auto_failback off ，等主节点恢复正常后，在业务不繁忙时，切换回来。防止主节点恢复正常时，回切时，再次影起网络中断。</span></span><br><span class=\"line\"><span class=\"comment\">#crm no  #是否开启Cluster Resource Masnger（集群资源管理）功能;(一般不用)</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br>authkeys 文件:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 注意该文件权限必须是600</span></span><br><span class=\"line\">auth 1  <span class=\"comment\"># 设置认证的方法</span></span><br><span class=\"line\"><span class=\"comment\">#1 crc  # 不安全</span></span><br><span class=\"line\"><span class=\"comment\">#2 sha1 HI!  #推荐使用</span></span><br><span class=\"line\"><span class=\"comment\">#3 md5 Hello!</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br>haresource 文件：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#指定节点主机名，和VIP地址，以双冒号分隔资源，此处以apache为例进行配置</span></span><br><span class=\"line\"><span class=\"comment\">#主备节点 VIP漂移IP</span></span><br><span class=\"line\">data-1-1 IPaddr::10.0.0.100/24/eth0</span><br><span class=\"line\">data-1-2 IPaddr::10.0.0.101/24/eth0    <span class=\"comment\">#当主挂了才进行触发</span></span><br><span class=\"line\"><span class=\"comment\">#参数详解：</span></span><br><span class=\"line\">data-1-1 : 主机名</span><br><span class=\"line\">IPaddr ：Resources.d/ 中的脚本文件</span><br><span class=\"line\">10.0.0.100/24/eth0 : 集群对外服务的VIP,24为子网掩码,eth0为IP绑定的实际物理网卡;为heartbeat提供对外服务的通信接口;</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190409160848.png\" alt=\"WeiyiGeek.MYSQL集群运维\" title=\"\" class=\"\">\n                <p>WeiyiGeek.MYSQL集群运维</p>\n            </figure></p>\n<p><br></p>\n<p><strong>2.Heartbaet入坑计</strong><br>建议：查看日志/var/log/ha-log<br><em>Q:日志分析接管过程?</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.pacemaker support 情况</span><br><span class=\"line\">2.logging daemon</span><br><span class=\"line\">3.heartbeat 版本信息</span><br><span class=\"line\">4.glib:UDP 多播信息发送</span><br><span class=\"line\">5.运行/etc/ha.d/rc.d/status 脚本查看对端的状态;</span><br><span class=\"line\">6.服务异常则接管资源,通过IPaddr脚本</span><br><span class=\"line\">7.广播UDP及VIP地址</span><br><span class=\"line\">8.如果检测对端正常则将结果的资源释放并返回给它   ip-request (请求发送) / ip-request-rsep (请求发送)</span><br></pre></td></tr></table></figure></p>\n<p><em>Q:两边都显示漂移的VIP地址?</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@Master-data1 ha.d]$ ip addr | grep -v -E <span class=\"string\">\"link|inet6\"</span> | grep <span class=\"string\">\"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.100/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\">    inet 192.168.1.11/24 brd 192.168.1.255 scope global secondary eth1  <span class=\"comment\">#问题点</span></span><br><span class=\"line\">    inet 192.168.1.10/24 brd 192.168.1.255 scope global secondary eth1</span><br><span class=\"line\">    inet 192.168.2.100/24 brd 192.168.2.255 scope global eth3</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ha.d]<span class=\"comment\"># ip addr | grep -v -E \"link|inet6\" | grep \"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.101/24 brd 192.168.1.255 scope global eth3</span><br><span class=\"line\">    inet 192.168.1.10/24 brd 192.168.1.255 scope global secondary eth3  <span class=\"comment\">#问题点</span></span><br><span class=\"line\">    inet 192.168.1.11/24 brd 192.168.1.255 scope global secondary eth3</span><br><span class=\"line\">    inet 192.168.2.101/24 brd 192.168.2.255 scope global eth5</span><br></pre></td></tr></table></figure><br>解决方法：是不是链路有问题,能不能进行通信,防火墙是否被开启(可以关闭/也可以将694端口添加通信规则)</p>\n<p><em>Q:一个LAN中是多组heartbeat服务同时开启的问题?</em><br>比如：mcast eth1 225.0.0.1 694 1 0 — 当同一个IDC有多个这样的情况应该使用单播;<br>如果非要使用多播方式,前提是多播地址不能相同(可选mutiladdr&gt; 224.0.0.0 ~ 239.255.255.255)一般 Router/siwtch等设备都是采用多播形式;<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190409233728.png\" alt=\"WeiyiGeek.实时同步共享存储\" title=\"\" class=\"\">\n                <p>WeiyiGeek.实时同步共享存储</p>\n            </figure></p>\n<p><em>Q:Filesystem脚本问题</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#问题</span></span><br><span class=\"line\">Filesystem(Filesystem_/dev/drbd0)[18085]:       2019/05/14_17:12:48 ERROR: Setup problem: couldn<span class=\"string\">'t find command: fuser'</span></span><br><span class=\"line\"><span class=\"comment\">#解决办法</span></span><br><span class=\"line\">yum install psmisc</span><br></pre></td></tr></table></figure></p>\n<p><em>Q:从机虚拟机复制的主机开启heartbeat时候报uuid错误</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">May 15 13:29:21 Szabbix heartbeat: [4467]: WARN: nodename mzabbix uuid changed to szabbix</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解决方法:删除其中一台主机的hd_uuid （重启的时候会自动更新）</span></span><br><span class=\"line\">[root@Szabbix ~]<span class=\"comment\"># rm -rf /usr/local/heartbeat/var/lib/heartbeat/hb_uuid</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>3.Centos7安装heartbeat在epel源不存在问题</strong><br>解决方法：描述采用源码编译安装heartbeat即可：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#共用配置</span></span><br><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> firewalld</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\">sed -i s<span class=\"comment\">#SELINUX=enforcing#SELINUX=disabled# /etc/selinux/config</span></span><br><span class=\"line\">reboot</span><br><span class=\"line\"></span><br><span class=\"line\">hostname data-1</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"data-1\"</span> &gt;&gt; /etc/hostname</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"192.168.1.100 data-1 node1\\n192.168.1.100 data-1 node2\"</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\">ssh-keygen -q -t rsa -N <span class=\"string\">''</span> -f ~/.ssh/id_rsa</span><br><span class=\"line\">ssh-copy-id root@192.168.1.100   <span class=\"comment\">#拷贝公钥到对方机器,就能不使用密码进行登陆ssh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#1.安装基础环境包：</span></span><br><span class=\"line\">yum install gcc gcc-c++ autoconf automake libtool glib2-devel libxml2-devel bzip2 bzip2-devel e2fsprogs-devel libxslt-devel libtool-ltdl-devel asciidoc wget psmisc </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.创建用户和组</span></span><br><span class=\"line\">groupadd haclient</span><br><span class=\"line\">useradd -g haclient hacluster</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.官网下载软件包：Reusable-Components-glue、resource-agents、heartbeat</span></span><br><span class=\"line\">wget http://hg.linux-ha.org/heartbeat-STABLE_3_0/archive/958e11be8686.tar.bz2 -O /opt/heartbeat3.tar.bz2</span><br><span class=\"line\">wget http://hg.linux-ha.org/glue/archive/0a7add1d9996.tar.bz2  -O /opt/glue.tar.bz2</span><br><span class=\"line\">wget https://github.com/ClusterLabs/resource-agents/archive/v3.9.6.tar.gz -O /opt/resource-agents.tar.bz2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.安装glue</span></span><br><span class=\"line\">tar xf glue.tar.bz2 </span><br><span class=\"line\">./autogen.sh</span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --<span class=\"built_in\">enable</span>-fatal-warnings=no LIBS=<span class=\"string\">'/lib64/libuuid.so.1'</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"built_in\">echo</span> $?</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#5.安装Resource Agents</span></span><br><span class=\"line\">tar xf resource-agents.tar.bz2 </span><br><span class=\"line\"><span class=\"built_in\">cd</span> resource-agents-3.9.6/</span><br><span class=\"line\">./autogen.sh </span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --<span class=\"built_in\">enable</span>-fatal-warnings=no LIBS=<span class=\"string\">'/lib64/libuuid.so.1'</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"built_in\">echo</span> $?</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#6.安装HeartBeat</span></span><br><span class=\"line\">tar xf heartbeat3.tar.bz2</span><br><span class=\"line\">./bootstrap</span><br><span class=\"line\"><span class=\"built_in\">export</span> CFLAGS=<span class=\"string\">\"<span class=\"variable\">$CFLAGS</span> -I/usr/local/heartbeat/include -L/usr/local/heartbeat/lib\"</span></span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/heartbeat --with-daemon-user=hacluster --with-daemon-group=haclient --<span class=\"built_in\">enable</span>-fatal-warnings=no LIBS=<span class=\"string\">'/lib64/libuuid.so.1'</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"built_in\">echo</span> $?</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#7.配置网卡支持插件文件</span></span><br><span class=\"line\">mkdir -pv /usr/<span class=\"built_in\">local</span>/heartbeat/usr/lib/ocf/lib/heartbeat/</span><br><span class=\"line\">cp /usr/lib/ocf/lib/heartbeat/ocf-* /usr/<span class=\"built_in\">local</span>/heartbeat/usr/lib/ocf/lib/heartbeat/</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#注意：一般启动时会报错因为 ping和ucast这些配置都需要插件支持 需要将lib64下面的插件软连接到lib目录 才不会抛出异常</span></span><br><span class=\"line\">ln -svf /usr/<span class=\"built_in\">local</span>/heartbeat/lib64/heartbeat/plugins/RAExec/* /usr/<span class=\"built_in\">local</span>/heartbeat/lib/heartbeat/plugins/RAExec/</span><br><span class=\"line\">ln -svf /usr/<span class=\"built_in\">local</span>/heartbeat/lib64/heartbeat/plugins/* /usr/<span class=\"built_in\">local</span>/heartbeat/lib/heartbeat/plugins/</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装后主要得目录配置文件</span></span><br><span class=\"line\">heartbeat configuration:</span><br><span class=\"line\">  Version                  = <span class=\"string\">\"3.0.6\"</span></span><br><span class=\"line\">  Executables              = <span class=\"string\">\"/usr/local/heartbeat/sbin\"</span></span><br><span class=\"line\">  Man pages                = <span class=\"string\">\"/usr/local/heartbeat/share/man\"</span></span><br><span class=\"line\">  Libraries                = <span class=\"string\">\"/usr/local/heartbeat/lib64\"</span></span><br><span class=\"line\">  Header files             = <span class=\"string\">\"/usr/local/heartbeat/include\"</span></span><br><span class=\"line\">  Arch-independent files   = <span class=\"string\">\"/usr/local/heartbeat/share\"</span></span><br><span class=\"line\">  Documentation files      = <span class=\"string\">\"/usr/local/heartbeat/share/doc/heartbeat\"</span></span><br><span class=\"line\">  State information        = <span class=\"string\">\"/usr/local/heartbeat/var\"</span></span><br><span class=\"line\">  System configuration     = <span class=\"string\">\"/usr/local/heartbeat/etc\"</span></span><br><span class=\"line\">  Init (rc) scripts        = <span class=\"string\">\"/etc/rc.d/init.d\"</span></span><br><span class=\"line\">  Init (rc) defaults       = <span class=\"string\">\"/etc/sysconfig\"</span></span><br><span class=\"line\">  Use system LTDL          = <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">  HA group name            = <span class=\"string\">\"haclient\"</span></span><br><span class=\"line\">  HA group id              = <span class=\"string\">\"1001\"</span></span><br><span class=\"line\">  HA user name             = <span class=\"string\">\"hacluster\"</span></span><br><span class=\"line\">  HA user user id          = <span class=\"string\">\"1001\"</span></span><br><span class=\"line\">  Build dopd plugin        = <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">  Enable <span class=\"built_in\">times</span> kludge      = <span class=\"string\">\"yes\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#8. 配置heartbeat配置文件(参考上面即可)</span></span><br><span class=\"line\"><span class=\"comment\">#拷贝三个模版配置文件到 /usr/local/heartbeat/etc/ha.d 目录下 </span></span><br><span class=\"line\">cp /usr/<span class=\"built_in\">local</span>/heartbeat/share/doc/heartbeat/&#123;ha.cf,haresources,authkeys&#125; /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/</span><br><span class=\"line\">vim /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/ha.cf</span><br><span class=\"line\"><span class=\"comment\">#非常建议使用单播方法 （非常注意网卡 -- 巨坑）</span></span><br><span class=\"line\">mcast eth2 225.0.0.200 694 1 0   <span class=\"comment\">#多播传送心跳的网卡 多播组 端口 跃点数 是否回环内传送</span></span><br><span class=\"line\">ucast eth2 192.168.2.100  <span class=\"comment\">#对端 - data2上配置</span></span><br><span class=\"line\">ucast eth2 192.168.2.101  <span class=\"comment\">#对端 - data1上配置</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">vim /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/authkeys</span><br><span class=\"line\">vim /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/haresources</span><br><span class=\"line\"><span class=\"comment\">#指定节点主机名，和VIP地址，以双冒号分隔资源，此处以apache为例进行配置</span></span><br><span class=\"line\">node1 192.168.1.200 apache::/etc/httpd/conf/httpd.conf</span><br><span class=\"line\">data1 IPaddr::192.168.1.200/24/eth1  <span class=\"comment\">#VIP 漂移得IP</span></span><br><span class=\"line\">data2 IPaddr::192.168.1.201/24/eth1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#9.设置权限非常重要</span></span><br><span class=\"line\">chmod 600 /usr/<span class=\"built_in\">local</span>/heartbeat/etc/ha.d/authkeys</span><br><span class=\"line\">chown -R root:haclient /usr/<span class=\"built_in\">local</span>/heartbeat/</span><br><span class=\"line\"></span><br><span class=\"line\">[root@data1 heartbeat]<span class=\"comment\"># ip addr | grep \"192.168\"</span></span><br><span class=\"line\">    inet 192.168.1.100/24 brd 192.168.1.255 scope global eth1</span><br><span class=\"line\">    inet 192.168.1.201/24 brd 192.168.1.255 scope global secondary eth1:0</span><br><span class=\"line\">    inet 192.168.1.200/24 brd 192.168.1.255 scope global secondary eth1:1</span><br><span class=\"line\">    inet 192.168.2.100/24 brd 192.168.2.255 scope global noprefixroute eth2</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190429150631.png\" alt=\"WeiyiGeek.测试接管\" title=\"\" class=\"\">\n                <p>WeiyiGeek.测试接管</p>\n            </figure></p>\n<p><br><br><strong>4.如何配置nfs的高可用</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置NFS共享存储</span></span><br><span class=\"line\"><span class=\"comment\">#在建立NFS的服务器上建立NFS存储：</span></span><br><span class=\"line\">yum install nfs-utils rpcbind</span><br><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl start nfs</span><br><span class=\"line\">cat /etc/exports  <span class=\"comment\">#建立NFS共享存储</span></span><br><span class=\"line\">/data 192.168.146.0/24(ro)</span><br><span class=\"line\">mkdir /data  <span class=\"comment\">#建立测试文件</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">'&lt;h1&gt;nfs server&lt;/h1&gt;'</span> &gt; /data/index.html</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#然后修改haresources配置文件添加自动挂载nfs资源：</span></span><br><span class=\"line\">node1.pjy.com IPaddr::192.168.146.222/24/ens33 Filesystem::192.168.146.151:/data::/var/www/html::nfs::ro apache::/etc/httpd/conf/httpd.conf</span><br><span class=\"line\"></span><br><span class=\"line\">pz142  IPaddr::192.168.146.222/24/eth0 drbddisk::nfddrbd Filesystem::/dev/drbd0::/data/image::ext4 killnfsd</span><br><span class=\"line\"><span class=\"comment\">#kulllnfsd脚本</span></span><br><span class=\"line\"><span class=\"comment\">#killall -9 nfsd; /etc/init.d/nfs restart; /etc/init.d/nfs restart; exit 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启heartbeat服务加载配置</span></span><br><span class=\"line\">systemctl restart heartbeat</span><br><span class=\"line\">ssh node2 <span class=\"string\">'systemctl restart heartbeat'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#测试是否加载资源：</span></span><br><span class=\"line\">ip addr</span><br><span class=\"line\">netstat -lntup</span><br><span class=\"line\">mount</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#资源转移测试：</span></span><br><span class=\"line\">/usr/<span class=\"built_in\">local</span>/heartbeat/share/heartbeat/hb_standby</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]文章目录(1) Heartbeat 高可用解决方案","categories":[{"name":"系统架构","path":"api/categories/系统架构.json"},{"name":"运维基础","path":"api/categories/运维基础.json"}],"tags":[{"name":"高可用服务","path":"api/tags/高可用服务.json"}]}