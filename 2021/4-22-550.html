<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 1.Prometheus监控入门之介绍整体架构及安装|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Prometheus">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>1.Prometheus监控入门之介绍整体架构及安装</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">1.Prometheus监控入门之介绍整体架构及安装</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-04-22T09:37:47.000Z" itemprop="datePublished" class="page-time">
  2021-04-22
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/">monitor</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/">kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/OperationTools/">OperationTools</a></li></ul></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-虚拟云容/云容器/Kubernetes/功能组件/Prometheus/1.Prometheus监控入门之介绍整体架构及安装"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">1.Prometheus监控入门之介绍整体架构及安装</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-04-22 17:37:47" datetime="2021-04-22T09:37:47.000Z"  itemprop="datePublished">2021-04-22</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/">monitor</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/">kubernetes</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/monitor/kubernetes/OperationTools/">OperationTools</a></li></ul></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h2><h3 id="0-学习导读"><a href="#0-学习导读" class="headerlink" title="0.学习导读"></a>0.学习导读</h3><p><strong>Q: 什么是监控?</strong><br>描述: 一般的将这类可操作的计算机系统归纳为以下四个特征;</p>
<blockquote>
<p>1.告警: 掌握故障的发生时间并通知相应人员(监控的重要目标)。<br>2.调试: 通过相应人员后需要根据判断错误根源来解决问题。<br>3.趋势: 展示一段时间内系统相应指标的发生变化趋势(该特征影响架构设计和处理)。<br>4.管道: 监控系统的数据处理管道用作于定制采集。</p>
</blockquote>
<p><br></p>
<p><strong>Q: 监控采集数据存储量优化解决方案?</strong><br>描述: 我们知道系统的数据监控采集必不可少都要处理或者存储采集到的数据,但是往往我们只需要针对某一事件的度量值进行存储，而其他值只是作为瞬间或者某一时间段内监控指标进行匹配对比报警，所以我们为了减少系统资源的消耗，采用以下四种方案来尽可能的减少数据存储量。</p>
<blockquote>
<p>1.剖析: 在无法提供事件的完整上下文时，可以截取某一段有限时间内的上下文作为剖析对象。(主要用作计算调试)<br>2.跟踪: 并不是关注所有事件而是采集某项指标的事件。(主要用于某一个指标的异常分析)<br>3.日志: 它关注的是一组有限的事件并记录每个事件的一些上下文。(通常日志记录的事件记录并非采集式)<br>4.指标: 它在很大程度上忽略了上下文而是跟踪不同类型事件随时间的聚合。(严格限制指标数量采集特定指标的数据)</p>
</blockquote>
<p><br></p>
<p><strong>Q: 日志分类说明？</strong><br>描述: 根据不同类型的日志有着不同的用处、耐用性和保留要求，大致分为以下四类。</p>
<blockquote>
<p>1.事务日志: 关键业务记录需要永久保存,主要涉及金钱和面向用户的关键性功能。<br>2.请求日志: 例如HTTP请求和数据库请求主要用于业务的处理优化和访问趋势。<br>3.应用日志: 即应用进程本身的日志通常是人为处理，主要涉及启动信息、后台运行任务以及其他进程级别的日志。<br>4.调试日志: 在应用或者程序出现莫名其妙的的Bug开启所有其日志在可靠性和保留性要求较低。</p>
</blockquote>
<p><br></p>
<h3 id="1-开源监控系统简史"><a href="#1-开源监控系统简史" class="headerlink" title="1.开源监控系统简史"></a>1.开源监控系统简史</h3><p>描述: 下面列举出比较常用的开源监控系统<code>Nagios [&#39;negos&#39;]、Cacti 英 [ˈkæktaɪ]、Ganglia 英 [ˈgæŋglɪə]、Zabbix、Openfalcon、Prometheus</code></p>
<p>监控软件发展历史简述:</p>
<ul>
<li>1994 年 - MRTG 1.0 由 Tobias Oetiker 编写主要是通过SNMP协议来监控网络。</li>
<li>1996 年 - NetSaint 由 Ethan Galstad 创建的作为一个MS-DOS应用来执行ping命令</li>
<li>1997 年 - MRTG 1.0 改进而来采用C进行重写并创造了用于存储指标数据的RRD(<code>Round Robin Database</code>)。</li>
<li>2002 年 - Nagios 由 NetSaint 重命名  </li>
<li>2006 年 - Graphite 使用与 RRD 类似的设计的Whisper来做指标数的存储。(其本身不会收集数据而是将数据发送给收集工具)</li>
<li>cacti : 一套基于PHP,MySQL,SNMP及RRDTool开发的网络流量监测图形分析工具。</li>
<li>2012 年 - zabbix 发布 2.x 版本，基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。</li>
<li>2012 年 - Prometheus 由Sound Cloud开发者进行维护开发后2016年加入到CNCF成为了第二个成员。</li>
</ul>
<p><br/></p>
<p><strong>Nagios</strong><br>描述: 它是一款免费的开源 IT 基础设施监控系统,基于CS架构。</p>
<ul>
<li>优点：通过安装插件和编写监控脚本，可以实现对目标灵活的监控</li>
<li>缺点：无法查询历史数据</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429223909.png" target="_blank" title="WeiyiGeek.Nagios架构" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429223909.png" alt="WeiyiGeek.Nagios架构" title="" class=""></a>
                <p>WeiyiGeek.Nagios架构</p>
            </figure>
<p><br></p>
<p><strong>Cacti</strong><br>描述: 基于<code>php/mysql/snmp及rrdtool</code>开发的网络流量监测图形分析工具</p>
<ul>
<li>优点：机房、流量监控方面应用较广泛</li>
<li>缺点：报警比较简陋</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224112.png" target="_blank" title="WeiyiGeek.Catic架构" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224112.png" alt="WeiyiGeek.Catic架构" title="" class=""></a>
                <p>WeiyiGeek.Catic架构</p>
            </figure>
<p><br></p>
<p><strong>Ganglia</strong><br>描述: 用于监控数以千计的节点的基础性能和流量使用情况。</p>
<ul>
<li>优点：部署方便，用不同分层管理上万台机器，无需逐个添加配置；ganglia服务端能通过一台客户端收集到同一个网段的所有客户端的数据；ganglia集群服务端能够通过一台服务端收集到它下属的所有客户端数据。</li>
<li>缺点：没有内置的消息系统，无法报警</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224300.png" target="_blank" title="WeiyiGeek.Ganglia架构" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224300.png" alt="WeiyiGeek.Ganglia架构" title="" class=""></a>
                <p>WeiyiGeek.Ganglia架构</p>
            </figure>
<p><br></p>
<p><strong>Openfalcon</strong><br>描述: OpenFalcon是一款企业级、高可用、可扩展的开源监控解决方案<code>(企业使用较多)</code>。</p>
<ul>
<li>优点: 支持多种方式报警，且会对警告进行合并处理，不会进行短信轰炸。</li>
<li>缺点: 社区支持不完善、基础软件监控不支持<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224420.png" target="_blank" title="WeiyiGeek.OpenFalcon" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224420.png" alt="WeiyiGeek.OpenFalcon" title="" class=""></a>
                <p>WeiyiGeek.OpenFalcon</p>
            </figure>
</li>
</ul>
<p><br></p>
<p><strong>Zabbix</strong><br>描述: Zabbix 是一个企业级的分布式开源监控方案，需要在被监控主机中安装Agent<code>(个人、企业使用较多)</code>。</p>
<ul>
<li>优点: 使用成本低安装部署简单，百分之95%的功能都可以在<code>Web UI</code>界面上进行操作，主机监控添加方便。</li>
<li>缺点: 自定义监控脚本编写复杂<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224930.png" target="_blank" title="WeiyiGeek.Zabbix架构" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429224930.png" alt="WeiyiGeek.Zabbix架构" title="" class=""></a>
                <p>WeiyiGeek.Zabbix架构</p>
            </figure>
</li>
</ul>
<p><br></p>
<p><strong>Why use Prometheus?</strong><br>描述: 这里不得不提到老生常谈的东西，人们使用机器方法演变/监控选型；</p>
<ul>
<li>1.最初人们直接使用物理机，将进程直接跑在物理机上面 <ul>
<li>从监控的角度考虑：监控起来最方便，复杂度最低</li>
</ul>
</li>
<li>2.后来人们开始在物理机中进行虚拟化来安装多台虚拟机例如(VMware/kvm)<ul>
<li>从监控角度来讲：相对比较复杂，我们要知道哪台机器上跑了哪些虚拟机，同时还要知道每个虚拟机里面跑了什么程序</li>
</ul>
</li>
<li>3.最后由于docker容器的出现进行了，翻起了新一轮的技术革命。<ul>
<li>从监控角度来讲：监控起来复杂度非常高，我们要知道每台机器上跑了哪些docker，和每个docker的资源使用情况，(很难用静态方法去监控)</li>
</ul>
</li>
<li>4.现在由于云环境的火热常采用 Kubernetes 对 Docker 容器进行编排，极大的提高了运维效率;<ul>
<li>从监控角度来讲：Prometheus是在Kubernetes孕育而来，在原生支持上面提到的各种工具的监控。</li>
</ul>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430162727.png" target="_blank" title="WeiyiGeek.基础环境" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430162727.png" alt="WeiyiGeek.基础环境" title="" class=""></a>
                <p>WeiyiGeek.基础环境</p>
            </figure>
<p><br/></p>
<p><em>总结说明:</em></p>
<ul>
<li>Prometheus并不是最好的监控系统，它不适用于存储事件日志或者单一的事件以及敏感信息采集，选择它的主要原因是他对云环境的原生支持；</li>
<li>Promethus 专门运行监控而设计存在由于某些因素(例如内核调度和抓取故障)导致一些数据不准确和资源竞争的现象，即并不能保证数据的绝对准确性。</li>
<li>恰好现在云环境是当前最火，应用最广泛的解决方案；</li>
<li>监控是应用于服务的，不同的服务场景选择不同的监控软件，切勿盲从；</li>
</ul>
<p><br></p>
<h3 id="2-Prometheus-基础简介"><a href="#2-Prometheus-基础简介" class="headerlink" title="2.Prometheus 基础简介"></a>2.Prometheus 基础简介</h3><p>简介: Prometheus 是一个开源的云原生基于指标的监控系统以及告警系统，泛义上包括<code>监控，告警，时序数据库(TSDB)，各种指标收集器(Exporter)组成</code>。现在最常见的Kubernetes容器管理系统中，通常会搭配Prometheus进行监控, 所以它主要用于容器监控和k8s集群监控以及云环境的监控(<code>OpenStack</code>)。</p>
<p>2016年 Prometheus 加入了云原生计算基金会(<code>Cloud Native Computing Foundation,CNCF</code>)，成为kubernetes之后的第二个托管项目 google SRE 的书内也曾提到跟他们BorgMon监控系统相似的实现是Prometheus。</p>
<p>官网介绍: 从度量到洞察使用领先的开源监控解决方案。</p>
<blockquote>
<p>Dimensional data (高维数据) : Prometheus implements a highly dimensional data model. Time series are identified by a metric name and a set of key-value pairs.</p>
</blockquote>
<blockquote>
<p>Powerful queries (强大的查询) : PromQL allows slicing and dicing of collected time series data in order to generate ad-hoc graphs, tables, and alerts.</p>
</blockquote>
<blockquote>
<p>Great visualization (UI-视觉效果) : Prometheus has multiple modes for visualizing data: a built-in expression browser, Grafana integration, and a console template language.</p>
</blockquote>
<blockquote>
<p>Efficient storage (高效的存储) : Prometheus stores time series in memory and on local disk in an efficient custom format. Scaling is achieved by functional sharding and federation.</p>
</blockquote>
<blockquote>
<p>Simple operation (操作简单) : Each server is independent for reliability, relying only on local storage. Written in Go, all binaries are statically linked and easy to deploy.</p>
</blockquote>
<blockquote>
<p>Precise alerting (精确报警) :<br>Alerts are defined based on Prometheus’s flexible PromQL and maintain dimensional information. An alertmanager handles notifications and silencing.</p>
</blockquote>
<blockquote>
<p>Many client libraries (众多客户端库) : Client libraries allow easy instrumentation of services. Over ten languages are supported already and custom libraries are easy to implement.</p>
</blockquote>
<blockquote>
<p>Many integrations (许多集成监控指标) : Existing exporters allow bridging of third-party data into Prometheus. <code>Examples: system statistics, as well as Docker, HAProxy, StatsD, and JMX metrics.</code></p>
</blockquote>
<p><br/></p>
<p><strong>优点说明:</strong></p>
<ul>
<li>定制化难度低，后端采用Go语言开发、前端可用Grafana直接进行Json编辑</li>
<li>开箱即用的各种服务发现机制，可以<em>自动发现监控端点</em></li>
<li>专为监控指标数据设计的<em>高性能时序数据库TSDB</em>，单机单实例支持数十万监控项/每秒</li>
<li>强大易用的查询语言<em>PromQL</em>以及丰富的<em>聚合函数</em>便于对已有数据进行新的聚合</li>
<li>生态完善有各种现成的开源Exporter实现，自定义的监控指标也非常简单</li>
<li>配置灵活的告警规则，支持<em>告警分组、抑制、静默、路由</em>等等高级功能</li>
<li>高可用的架构核心组件都有高可用解决方案</li>
<li>强大的功能除了云平台之外还支持主机、各种db资源、web网站、dns、网络延时、端口连通性、各种语言写的程序监控等等</li>
<li>成熟的社区和健全的生态</li>
</ul>
<p><br></p>
<p><strong>缺点说明:</strong></p>
<ul>
<li>安装相对复杂、监控、告警和界面都分属于不同的组件。</li>
<li>没有任何监控告警之外的功能(<code>用户/角色/权限控制等等</code>),需要多配置必须在配置文件中修改。</li>
<li>通过 HTTP 拉取监控数据效率不够高</li>
</ul>
<p>Tips: 保有量最多的三种监控系统(<code>Zabbix、Openfalcon、Promethes</code>)方式对比;<br><figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429230010.png" target="_blank" title="WeiyiGeek.三者对比" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210429230010.png" alt="WeiyiGeek.三者对比" title="" class=""></a>
                <p>WeiyiGeek.三者对比</p>
            </figure></p>
<p><br></p>
<h3 id="3-Prometheus-架构组件"><a href="#3-Prometheus-架构组件" class="headerlink" title="3.Prometheus 架构组件"></a>3.Prometheus 架构组件</h3><p>描述: Prometheus 架构由客户端在被监控系统上利用导出器采集指标数据，在服务端配置静态目标或者动态的服务发现，此时Prometheus 根据抓取频率进行数据的拉取(exporter)和推送(pushgateway), 然后将抓取的数据存储到时序数据库(TSDB)之中，再利用Grafana的仪表盘展示Prometheus服务中的数据，同时设定记录规则(PromQL表达式)和告警规则(频率)并发送给alertmanager进行发送报警事件到运维人员手中，最终可能还需要进行数据的持久化默认的是本地存储但可以通过远程读写的API让其他系统也可接入采集存储数据。</p>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://prometheus.io/assets/architecture.svg" target="_blank" title="Prometheus 架构" data-fancybox="images"><img src="https://prometheus.io/assets/architecture.svg" alt="Prometheus 架构" title="" class=""></a>
                <p>Prometheus 架构</p>
            </figure>
<p><br/></p>
<p>Prometheus 监控体系如下图几大部分构成:</p>
<ul>
<li>1.<code>Prometheus server</code> : 主要负责数据采集和存储，提供PromQL查询语言的支持 (默认端口: 9090)</li>
<li>2.<code>exporters</code> : 监控指标采集器，支持数据库、硬件、消息中间件、http 服务器、jmx 等 (默认端口:)</li>
<li>3.<code>alertmanager</code> : 用来进行报警、prometheus_cli：命令行工具 (默认端口: 9093)</li>
<li>4.<code>Web UI</code> : 原生UI功能较为单一，常常采用<code>Grafana</code>这个跨平台的开源的分析和可视化工具 (默认端口: 3000)</li>
<li>5.<code>PushGateWay</code> : 跨网段被监控主机指标采集数据转发到网关代理等待Server的Pull。</li>
<li>6.<code>Time Series DataBase</code> : 时序数据库(TSDB)用于保存时间序列（按时间顺序变化）的数据,每条记录都有完整的时间戳，基于时间的操作都比较方便.</li>
</ul>
<p><br></p>
<p><strong>Q:采用时序数据库(TSDB)的优点?</strong></p>
<blockquote>
<p>1.时间作为他的主轴，数据按顺序到达。</p>
</blockquote>
<blockquote>
<p>2.大多数操作是插入新数据，偶尔伴随查询，更新数据比较少。</p>
</blockquote>
<blockquote>
<p>3.时间序列数据累计速度非常快，更高的容纳率、更快的大规模查询以及更好的数据压缩。</p>
</blockquote>
<blockquote>
<p>4.TSDB 通常还包括一些共通的对时间序列数据分析的功能和操作:数据保留策略、连续查询、灵活的时间聚合等。</p>
</blockquote>
<p><br/></p>
<p><strong>Q:什么是微服务架构?</strong></p>
<blockquote>
<ul>
<li>他的组件是可以独立工作的，每个组件都不依赖其他的组件</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>配置文件来将不同的模块关联到一起，实现整个监控的功能</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>每个独立的模块都可以扩展，做高可用方案</li>
</ul>
</blockquote>
<p><br></p>
<h3 id="4-Prometheus-基本原理"><a href="#4-Prometheus-基本原理" class="headerlink" title="4.Prometheus 基本原理"></a>4.Prometheus 基本原理</h3><p>描述: Prometheus 基本工作流程步骤如下:</p>
<ul>
<li>Setp 1.<code>Prometheus Server</code> 读取配置解析<code>静态监控端点（static_configs）</code>，以及服务发现规则(xxx_sd_configs)自动收集需要监控的端点</li>
</ul>
<ul>
<li><p>Setp 2.Prometheus Server 周期刮取<code>(scrape_interval)</code>监控端点通过HTTP的Pull方式采集监控数据</p>
</li>
<li><p>Step 3.Prometheus Server HTTP 请求到达 <code>Node Exporter</code>，Exporter 返回一个文本响应，每个非注释行包含一条完整的时序数据：<code>Name + Labels + Samples(一个浮点数和一个时间戳构成)</code>, 数据来源是一些官方的exporter或自定义sdk或接口;</p>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430093748.png" target="_blank" title="WeiyiGeek.Exporter-Metrics" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430093748.png" alt="WeiyiGeek.Exporter-Metrics" title="" class=""></a>
                <p>WeiyiGeek.Exporter-Metrics</p>
            </figure>
<ul>
<li><p>Step 4.Prometheus Server 收到响应，Relabel处理之后<code>(relabel_configs)</code>将其存储在TSDB中并建立倒排索引</p>
</li>
<li><p>Step 5.Prometheus Server 另一个<code>周期计算任务(evaluation_interval)</code>开始执行，根据配置的Rules逐个计算与设置的阈值进行匹配，若结果超过阈值并持续时长超过临界点将进行报警，此时发送Alert到AlertManager独立组件中。</p>
</li>
<li><p>Step 6.AlertManager 收到告警请求，根据配置的策略决定是否需要触发告警，如需告警则根据配置的路由链路依次发送告警，比如<code>邮件、微信、Slack、PagerDuty、WebHook</code>等等。</p>
</li>
</ul>
<ul>
<li><p>Step 7.当通过界面或HTTP调用查询时序数据利用PromQL表达式查询，Prometheus Server 处理过滤完之后返回瞬时向量<code>(Instant vector, N条只有一个Sample的时序数据)</code>，区间向量<code>(Range vector，N条包含M个Sample的时序数据)</code>，或标量数据 <code>(Scalar, 一个浮点数)</code></p>
</li>
<li><p>Step 8.采用Grafana开源的分析和可视化工具进行数据的图形化展示。</p>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430095142.png" target="_blank" title="WeiyiGeek.Grafana" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430095142.png" alt="WeiyiGeek.Grafana" title="" class=""></a>
                <p>WeiyiGeek.Grafana</p>
            </figure>
<p><br></p>
<h3 id="5-Prometheus-数据模型和类型"><a href="#5-Prometheus-数据模型和类型" class="headerlink" title="5.Prometheus 数据模型和类型"></a>5.Prometheus 数据模型和类型</h3><p>描述: metrics name &amp; label 指标名称和标签(key=value)的形式组成的数据模型，其次是Prometheus惯例是使用基本单元<code>如字节(Byte)和秒(s)</code>;</p>
<blockquote>
<p>metrics name : 一般由字母和下划线构成 <code>prometheus_http_requests_total</code><br>Lable : 标签就是对一条时间序列不同维度的识别 <code>(应用名称=name_监测对像=object_数值类型=int_单位=ok)</code>。</p>
</blockquote>
<p>基础示例:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据模型 : metric  @ timestamp  =&gt;  value</span></span><br><span class="line">http_requests_total&#123;status=<span class="string">"200"</span>,method=<span class="string">"GET"</span>&#125;@1434417560938  =&gt; 94355</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据格式 : Metric_Name&#123;key="value"&#125;</span></span><br><span class="line">go_info&#123;instance=<span class="string">"localhost:9090"</span>, job=<span class="string">"prometheus"</span>, version=<span class="string">"go1.16.2"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>数据类型</strong><br>描述: Prometheus 常常使用以下核心指标类型 <code>Counter(计数器类型) 、Gauge(仪表盘类型) 、Histogram(直方图类型)、Summary(摘要类型)</code>;</p>
<ul>
<li><p>Counter <code>英 [ˈkaʊntə(r)]</code> 类型 ：该指标的工作方式和计数器一样，只增不减（除非系统发生了重置）。Counter一般用于累计值，例如记录请求次数、任务完成数、错误发生次数,通常来讲许多指标counter本身并没有什么意义，有意义的是counter随时间的变化率如采用rate函数能计算出每秒增长,由 <code>&lt;basename&gt;</code>_total组成。</p>
</li>
<li><p>Gauge <code>英 [ɡeɪdʒ]</code> 类型 : 可增可减的指标类，可以用于反应当前应用的状态。比如机器内存，磁盘可用空间大小<code>node_memory_MemAvailable_bytes/node_filesystem_avail_bytes</code>等等;</p>
</li>
<li><p>Histogram <code>英 [ˈhɪstəɡræm]</code> 类型 : 客户端计算主要用于表示一段时间范围内对数据进行采样（通常是请求持续时间或响应大小），并能够对其指定区间以及总数进行统计，通常它采集的数据展示为直方图。由 <code>&lt;basename&gt;_bucket, &lt;basename&gt;_sum， &lt;basename&gt;_count</code> 组成;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">所有事件产生值的大小的总和: basename_sum</span><br><span class="line">事件发生的总次数: basename_count</span><br><span class="line">事件产生的值分布: basename_bucket</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430103424.png" target="_blank" title="WeiyiGeek.Histogram" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430103424.png" alt="WeiyiGeek.Histogram" title="" class=""></a>
                <p>WeiyiGeek.Histogram</p>
            </figure>
</li>
<li><p>Summary <code>英 [ˈsʌməri]</code> 类型 : 与<code>Histogram类型</code>相似主要用于表示一段时间内数据采样结果（通常时请求持续时间或响应大小），它直接存储了分位数据，而不是根据统计区间计算出来的, 由<code>&lt; basename&gt;_sum，&lt; basename&gt;_count,&lt;basename&gt;{quantile=&quot;&lt;φ&gt;&quot;}</code>组成;</p>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430105024.png" target="_blank" title="WeiyiGeek.Summary" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430105024.png" alt="WeiyiGeek.Summary" title="" class=""></a>
                <p>WeiyiGeek.Summary</p>
            </figure>
<p><br/></p>
<p><strong>Q: Histogram 与 Sumamry 的两者区别?</strong></p>
<blockquote>
<p>Histogram 指标: 直接反应了在不同区间内样本的个数，区间通过标签len进行定义，同时对于Histogram的指标，我们还可以<code>通过histogram_quantile()函数</code>计算出其值的分位数。<br>Sumamry 指标: 分位数则是直接在客户端计算完成。</p>
</blockquote>
<blockquote>
<p>因此Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。反之对于客户端而言Histogram消耗的资源更少。<br>在选择这两种方式时用户应该按照自己的实际场景进行选择。</p>
</blockquote>
<p><br></p>
<h3 id="6-Prometheus-学习参考"><a href="#6-Prometheus-学习参考" class="headerlink" title="6.Prometheus 学习参考"></a>6.Prometheus 学习参考</h3><p>描述: 当前2021年4月30日Prometheus Server版本: <code>v2.26.0</code>下载地址:<a href="https://prometheus.io/download/" target="_blank" rel="noopener">https://prometheus.io/download/</a><br>官方地址: <a href="https://prometheus.io/" target="_blank" rel="noopener">https://prometheus.io/</a><br>项目地址: </p>
<ul>
<li><a href="https://github.com/prometheus/" target="_blank" rel="noopener">https://github.com/prometheus/</a></li>
<li><a href="https://github.com/prometheus-community" target="_blank" rel="noopener">https://github.com/prometheus-community</a></li>
</ul>
<p>帮助文档: <a href="https://prometheus.io/docs/prometheus/latest/getting_started/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/getting_started/</a></p>
<hr>
<h2 id="0x01-环境安装配置"><a href="#0x01-环境安装配置" class="headerlink" title="0x01 环境安装配置"></a>0x01 环境安装配置</h2><h3 id="1-Prometheus-安装方式"><a href="#1-Prometheus-安装方式" class="headerlink" title="1.Prometheus 安装方式"></a>1.Prometheus 安装方式</h3><p>描述: 上面的prometheus组件里常规的安装方式有如下几种;</p>
<ul>
<li>Using pre-compiled binaries ：二进制可执行文件</li>
<li>From source : 源码编译(需要安装gcc 和 g++ 和 Make)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus_server</span></span><br><span class="line">$ mkdir -p <span class="variable">$GOPATH</span>/src/github.com/prometheus</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/prometheus</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/prometheus/prometheus.git</span><br><span class="line">$ <span class="built_in">cd</span> prometheus</span><br><span class="line">$ make build</span><br><span class="line">$ ./prometheus -config.file=your_config.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># prometheus_alertmanager</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/prometheus/alertmanager.git</span><br><span class="line">$ <span class="built_in">cd</span> alertmanager</span><br><span class="line">$ make build</span><br><span class="line">$ ./alertmanager -config.file=&lt;your_file&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>Using Docker : 依赖于Docker进行安装,注意在<a href="https://quay.io/repository/prometheus/prometheus" target="_blank" rel="noopener">Quay.io</a>或<a href="https://hub.docker.com/r/prom/prometheus/" target="_blank" rel="noopener">Docker Hub</a>上Docker图像的形式提供。</p>
<ul>
<li>最重要的Docker主机和容器度量的简单概述(cAdvisor/普罗米修斯)参考地址: <a href="https://grafana.com/grafana/dashboards/893" target="_blank" rel="noopener">https://grafana.com/grafana/dashboards/893</a></li>
</ul>
</li>
<li><p>Using configuration management systems : 使用配置管理系统进行安装;</p>
</li>
</ul>
<p>参考地址: <a href="https://prometheus.io/docs/prometheus/latest/installation/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/installation/</a></p>
<p><br/></p>
<h3 id="2-Prometheus-服务安装"><a href="#2-Prometheus-服务安装" class="headerlink" title="2.Prometheus 服务安装"></a>2.Prometheus 服务安装</h3><p>描述: 此次为了方便部署和测试我在Docker容器环境中利用 <a href="https://github.com/docker/compose/releases/download/1.25.4/docker-compose-Linux-x86_64" target="_blank" rel="noopener">docker-compose</a>的方式部署 <code>prometheus</code>、 <code>alertmanager</code> 、<code>grafana</code>进行安装以及准备好文件，以及相应服务的配置文件。</p>
<ul>
<li>Step 1.准备好持久化数据目录的创建与权限赋予<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 此为NFS共享存储便于后面多台主机的</span></span><br><span class="line">/nfsdisk-31/monitor<span class="comment"># mkdir -vp /nfsdisk-31/monitor/prometheus/&#123;conf,data&#125; grafana/data</span></span><br><span class="line">  <span class="comment"># mkdir: created directory '/nfsdisk-31/monitor/prometheus'</span></span><br><span class="line">  <span class="comment"># mkdir: created directory 'prometheus/conf'</span></span><br><span class="line">  <span class="comment"># mkdir: created directory 'prometheus/data'</span></span><br><span class="line">  <span class="comment"># mkdir: created directory 'grafana'</span></span><br><span class="line">  <span class="comment"># mkdir: created directory 'grafana/data'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) grafana 服务数据存储目录所属者设置(否则报错:GF_PATHS_DATA='/var/lib/grafana' is not writable.)</span></span><br><span class="line">chown 472:root -R /nfsdisk-31/monitor/grafana/data</span><br><span class="line">chmod 777 /nfsdisk-31/monitor/prometheus/data</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 2.配置文件目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tree -L 3</span><br><span class="line">.</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── grafana</span><br><span class="line">│   └── data</span><br><span class="line">└── prometheus</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── alertmanager.yaml</span><br><span class="line">    │   ├── alert.rules</span><br><span class="line">    │   └── prometheus.yml</span><br><span class="line">    └── data</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 3.docker 创建指定网络名称monitor;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d bridge monitor</span><br><span class="line">  <span class="comment"># 527a8953a9d57c64e2d728d817f46ea735b104e6f0f2c342f1c7844eebe8ad87</span></span><br><span class="line">docker network ls</span><br><span class="line">  <span class="comment"># NETWORK ID     NAME      DRIVER    SCOPE</span></span><br><span class="line">  <span class="comment"># 4fe5982b8449   bridge    bridge    local</span></span><br><span class="line">  <span class="comment"># 484bfd6f8556   host      host      local</span></span><br><span class="line">  <span class="comment"># 527a8953a9d5   monitor   bridge    local</span></span><br><span class="line">  <span class="comment"># 0b83b3436078   none      null      local</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Step 4.Docker-compose 资源清单描述进行prometheus以及grafana容器的创建, 以及相应的配置文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">tee</span> <span class="string">/nfsdisk-31/monitor/prometheus/conf/docker-compose.yml</span> <span class="string">&lt;&lt;'END'</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3.2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  prometheus:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">prom/prometheus:v2.26.0</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">prometheus_server</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/nfsdisk-31/monitor/prometheus/conf/prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/nfsdisk-31/monitor/prometheus/conf/alert.rules:/etc/prometheus/alert.rules</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/nfsdisk-31/monitor/prometheus:/prometheus</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/etc/localtime:/etc/localtime</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'--config.file=/etc/prometheus/prometheus.yaml'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'--storage.tsdb.path=/prometheus/data'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'--web.enable-admin-api'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'--web.enable-lifecycle'</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'30090:9090'</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">monitor</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">  pushgateway:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">prom/pushgateway</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">prometheus_pushgateway</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/etc/localtime:/etc/localtime</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'30091:9091'</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">monitor</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  alertmanager:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">prom/alertmanager:v0.21.0</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">prometheus_alertmanager</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/nfsdisk-31/monitor/prometheus/conf/alertmanager.yaml:/etc/alertmanager.yaml</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/nfsdisk-31/monitor/prometheus/alertmanager:/alertmanager</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/etc/localtime:/etc/localtime</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'--config.file=/etc/alertmanager.yaml'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'--storage.path=/alertmanager'</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'30093:9093'</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">monitor</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  grafana:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">grafana/grafana:7.5.5</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">"472"</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD=weiyigeek</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/nfsdisk-31/monitor/grafana/data:/var/lib/grafana</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'30000:3000'</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">    dns:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">223.6</span><span class="number">.6</span><span class="number">.6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.254</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  monitor:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">END</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.prometheus 和 alertmanager 依赖的相关配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /nfsdisk-31/monitor/prometheus/conf/</span><br><span class="line"><span class="comment"># prometheus 监控服务</span></span><br><span class="line">tee prometheus.yml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">global:</span><br><span class="line">    <span class="comment"># pull 频率</span></span><br><span class="line">    scrape_interval: 120s</span><br><span class="line">    <span class="comment"># 超时时间</span></span><br><span class="line">    scrape_timeout: 15s</span><br><span class="line">    <span class="comment"># 外部标签</span></span><br><span class="line">    external_labels:</span><br><span class="line">      monitor: <span class="string">'current-monitor'</span></span><br><span class="line">scrape_configs:</span><br><span class="line">    <span class="comment"># 工作组名称</span></span><br><span class="line">    - job_name: <span class="string">'prometheus'</span></span><br><span class="line">      <span class="comment"># 监控的主机地址与端口信息</span></span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: [<span class="string">'localhost:9090'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 报警规则</span></span><br><span class="line">rule_files:</span><br><span class="line">  - <span class="string">'alert.rules'</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报警服务</span></span><br><span class="line">tee alertmanager.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># 默认采用哪种方式进行预警</span></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">'alertname'</span>]</span><br><span class="line">  receiver: <span class="string">'default-receiver'</span></span><br><span class="line">receivers:</span><br><span class="line">  - name: <span class="string">'default-receiver'</span></span><br><span class="line">    <span class="comment">#接收者为webhook类型</span></span><br><span class="line">    webhook_configs:</span><br><span class="line">    <span class="comment">#webhook的接收地址</span></span><br><span class="line">    - url: <span class="string">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=4e1165c3-55c1-4bc4-8493-ecc5ccda9275'</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报警规则</span></span><br><span class="line">tee alert.rules &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">groups:</span><br><span class="line">- name: node-alert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: service_down</span><br><span class="line">    expr: up == 0</span><br><span class="line">    <span class="keyword">for</span>: 3m</span><br><span class="line">  - alert: high_load</span><br><span class="line">    expr: node_load1 &gt; 1.0</span><br><span class="line">    <span class="keyword">for</span>: 5m</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 6.根据需求配置好相关信息之后使用 <code>docker-compose up -d</code> 启动容器,注意进行相应端口的防火墙规则调整通行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps</span><br><span class="line">  <span class="comment"># Name                        Command               State                 Ports</span></span><br><span class="line">  <span class="comment"># -----------------------------------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment"># grafana                   /run.sh                          Up      0.0.0.0:30000-&gt;3000/tcp</span></span><br><span class="line">  <span class="comment"># prometheus_alertmanager   /bin/alertmanager --config ...   Up      0.0.0.0:30093-&gt;9093/tcp</span></span><br><span class="line">  <span class="comment"># prometheus_server         /bin/prometheus --config.f ...   Up      0.0.0.0:30090-&gt;9090/tcp</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 7.所有的容器状态都 UP 之后,打开浏览器访问以下服务查看是否正常。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus 监控主服务 - 提供简陋的管理页面</span></span><br><span class="line">http://192.168.12.107:30090/</span><br><span class="line"></span><br><span class="line"><span class="comment"># prometheus Alertmanager 服务 - 提供简陋的管理页面</span></span><br><span class="line">http://192.168.12.107:30093/</span><br><span class="line"></span><br><span class="line"><span class="comment"># grafana UI 服务 - 提供数据专业化展示 (默认账户密码: admin/weiyigeek)</span></span><br><span class="line">http://192.168.12.107:30000/login</span><br></pre></td></tr></table></figure>
<p>点击 <code>- insert metric at cursor</code> 选择框，选额 <code>go_info</code> ，再点击 <code>Execute</code> 按钮查看是否有监控指标输出即安装成功<code>go_info{instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;, version=&quot;go1.16.2&quot;}</code>。</p>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430163203.png" target="_blank" title="WeiyiGeek.服务验证" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430163203.png" alt="WeiyiGeek.服务验证" title="" class=""></a>
                <p>WeiyiGeek.服务验证</p>
            </figure>
<p><br/></p>
<h3 id="3-Node-Exporter-节点导出器安装"><a href="#3-Node-Exporter-节点导出器安装" class="headerlink" title="3.Node Exporter 节点导出器安装"></a>3.Node Exporter 节点导出器安装</h3><p>描述: 该组件主要用于机器指标导出。</p>
<ul>
<li><p>Step 1.在Github的Release中下载<code>node_exporter</code>可直接运行的二进制包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.解压二进制文件</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">tar -xvf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">sudo cp -a node_exporter /usr/<span class="built_in">local</span>/bin/node_exporter</span><br><span class="line"><span class="comment"># sudo ln -s /usr/local/node_exporter-1.2.2.linux-amd64/node_exporter /usr/local/bin/node_exporter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.创建配置文件</span></span><br><span class="line">sudo mkdir /etc/node_exporter/</span><br><span class="line">sudo tee /etc/node_exporter/exporter.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># 官方建议添加环境变量  `/etc/node_exporter/exporter.confr` ，内容如下：</span></span><br><span class="line"><span class="comment"># OPTIONS="--collector.textfile.directory /var/lib/node_exporter/textfile_collector"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 2.创建 <code>/usr/lib/systemd/system/node_exporter.service</code> systemd unit 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &gt; systemd 可用于监控系统服务，需要在 node_exporter 启动时添加 --collector.systemd 参数开启，默认是关闭的。</span></span><br><span class="line">sudo tee /usr/lib/systemd/system/node_exporter.service &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Node Exporter Clinet</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">StandardError=journal</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/node_exporter --web.listen-address=:9100</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=3s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># EnvironmentFile=/etc/node_exporter/exporter.conf</span></span><br><span class="line"></span><br><span class="line">sudo chmod 754 /usr/lib/systemd/system/node_exporter.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 3.重载systemd与开机自启node_exporter服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重载&amp;开机自启</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> node_exporter.service</span><br><span class="line">sudo systemctl start node_exporter.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志查看</span></span><br><span class="line">sudo systemctl status node_exporter.service</span><br><span class="line">● node_exporter.service - Node Exporter Clinet</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/node_exporter.service; disabled; vendor preset: enabled)</span><br><span class="line">     Active: active (running) since Fri 2021-04-30 22:49:33 CST; 10s ago</span><br><span class="line">   Main PID: 1238901 (node_exporter)</span><br><span class="line">      Tasks: 12 (<span class="built_in">limit</span>: 19111)</span><br><span class="line">     Memory: 11.4M</span><br><span class="line">     CGroup: /system.slice/node_exporter.service</span><br><span class="line">             └─1238901 /usr/<span class="built_in">local</span>/bin/node_exporter --collector.systemd</span><br><span class="line"></span><br><span class="line">Apr 30 22:49:33 weiyigeek-107 node_exporter[1238901]: level=info ts=2021-04-30T14:49:33.154Z <span class="built_in">caller</span>=node_exporter.go:113 collector=thermal_zone</span><br><span class="line">......</span><br><span class="line">Apr 30 22:49:33 weiyigeek-107 node_exporter[1238901]: level=info ts=2021-04-30T14:49:33.154Z <span class="built_in">caller</span>=node_exporter.go:113 collector=zfs</span><br><span class="line">Apr 30 22:49:33 weiyigeek-107 node_exporter[1238901]: level=info ts=2021-04-30T14:49:33.154Z <span class="built_in">caller</span>=node_exporter.go:195 msg=<span class="string">"Listening on"</span> address=:9100</span><br><span class="line">Apr 30 22:49:33 weiyigeek-107 node_exporter[1238901]: level=info ts=2021-04-30T14:49:33.155Z <span class="built_in">caller</span>=tls_config.go:191 msg=<span class="string">"TLS is disabled."</span> http2=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">netstat -tlnp | grep <span class="string">"9100"</span></span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">tcp6       0      0 :::9100                 :::*                    LISTEN      -</span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 4.通过<code>node exporter</code>的http服务查看该主机的metrics信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://192.168.12.107:9100/metrics | head -n 20</span><br><span class="line">  <span class="comment"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span></span><br><span class="line">  <span class="comment"># TYPE go_gc_duration_seconds summary</span></span><br><span class="line">  go_gc_duration_seconds&#123;quantile=<span class="string">"0"</span>&#125; 2.4814e-05</span><br><span class="line">  go_gc_duration_seconds&#123;quantile=<span class="string">"0.25"</span>&#125; 5.1128e-05</span><br><span class="line">  go_gc_duration_seconds&#123;quantile=<span class="string">"0.5"</span>&#125; 9.3675e-05</span><br><span class="line">  go_gc_duration_seconds&#123;quantile=<span class="string">"0.75"</span>&#125; 0.000131435</span><br><span class="line">  go_gc_duration_seconds&#123;quantile=<span class="string">"1"</span>&#125; 0.000767665</span><br><span class="line">  go_gc_duration_seconds_sum 0.015132517</span><br><span class="line">  go_gc_duration_seconds_count 135</span><br><span class="line">  <span class="comment"># HELP go_goroutines Number of goroutines that currently exist.</span></span><br><span class="line">  <span class="comment"># TYPE go_goroutines gauge</span></span><br><span class="line">  go_goroutines 8</span><br><span class="line">  <span class="comment"># HELP go_info Information about the Go environment.</span></span><br><span class="line">  <span class="comment"># TYPE go_info gauge</span></span><br><span class="line">  go_info&#123;version=<span class="string">"go1.15.8"</span>&#125; 1</span><br><span class="line">  <span class="comment"># HELP go_memstats_alloc_bytes Number of bytes allocated and still in use.</span></span><br><span class="line">  <span class="comment"># TYPE go_memstats_alloc_bytes gauge</span></span><br><span class="line">  go_memstats_alloc_bytes 3.019424e+06</span><br><span class="line">  <span class="comment"># HELP go_memstats_alloc_bytes_total Total number of bytes allocated, even if freed.</span></span><br><span class="line">  <span class="comment"># TYPE go_memstats_alloc_bytes_total counter</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 5.配置 prometheus.yml 添加如下Job工作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /nfsdisk-31/monitor/prometheus/conf/prometheus.yml</span><br><span class="line">  - job_name: <span class="string">'node-resources'</span></span><br><span class="line">    scrape_interval: 120s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">'192.168.12.107:9100'</span>]   <span class="comment"># 指定安装和启动后 node_exporter 的主机</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 6.重新<code>prometheus</code>容器进行更新配置，之后访问<code>http://192.168.12.107:30090/targets</code>页面查看目标是否可以正常监控了(UP上线)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/nfsdisk-31/monitor<span class="comment"># docker-compose restart prometheus</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430230323.png" target="_blank" title="WeiyiGeek.Target-node-resources" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430230323.png" alt="WeiyiGeek.Target-node-resources" title="" class=""></a>
                <p>WeiyiGeek.Target-node-resources</p>
            </figure>
</li>
</ul>
<ul>
<li>Step 7.监控该主机系统相关信息，我们可以在UI首页进行系统空闲磁盘大小查看<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PromQL 表达式: 获取系统空闲磁盘的空间大小(单位 GB)</span></span><br><span class="line">node_filesystem_free_bytes&#123;fstype!=<span class="string">"tmpfs"</span>&#125; / (1024*1024*1024)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">&#123;device=<span class="string">"/dev/mapper/ubuntu--vg-lv--0"</span>, fstype=<span class="string">"ext4"</span>, instance=<span class="string">"192.168.12.107:9100"</span>, job=<span class="string">"node-resources"</span>, mountpoint=<span class="string">"/"</span>&#125;</span><br><span class="line">  76.21196365356445</span><br><span class="line">&#123;device=<span class="string">"/dev/sda2"</span>, fstype=<span class="string">"ext4"</span>, instance=<span class="string">"192.168.12.107:9100"</span>, job=<span class="string">"node-resources"</span>, mountpoint=<span class="string">"/boot"</span>&#125;</span><br><span class="line">  0.6655235290527344</span><br><span class="line">&#123;device=<span class="string">"192.168.10.30:/nask8sapp"</span>, fstype=<span class="string">"nfs"</span>, instance=<span class="string">"192.168.12.107:9100"</span>, job=<span class="string">"node-resources"</span>, mountpoint=<span class="string">"/nfsdisk-31"</span>&#125;</span><br><span class="line">  2275.9747009277344</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430230835.png" target="_blank" title="WeiyiGeek.PromQL 表达式数据查询" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210430230835.png" alt="WeiyiGeek.PromQL 表达式数据查询" title="" class=""></a>
                <p>WeiyiGeek.PromQL 表达式数据查询</p>
            </figure>
</li>
</ul>
<hr>
<p><br/></p>
<h3 id="4-cAdvisor-容器监控安装"><a href="#4-cAdvisor-容器监控安装" class="headerlink" title="4.cAdvisor 容器监控安装"></a>4.cAdvisor 容器监控安装</h3><p>描述: cAdvisor <code>英 [Kədˈvaɪzə]</code>使用Go语言开发，利用Linux的cgroups获取容器的资源使用信息, 可以对节点机器上的资源及容器进行实时监控和性能数据采集，包括CPU使用情况、内存使用情况、网络吞吐量及文件系统使用情况,还提供基础查询界面和http接口，方便其他组件如Prometheus进行数据抓取.</p>
<p>cAdvisor原生支持Docker容器，并且对任何其他类型的容器能够开箱即用,它也是基于lmctfy的容器抽象，所以容器本身是分层嵌套的。</p>
<p><strong>优缺点：</strong></p>
<ul>
<li>优点：谷歌开源产品，监控指标齐全，部署方便，而且有官方的docker镜像。</li>
<li>缺点：是集成度不高，默认只在本地保存1分钟数据，但可以集成InfluxDB等存储</li>
</ul>
<p>项目地址: <a href="https://github.com/google/cadvisor/" target="_blank" rel="noopener">https://github.com/google/cadvisor/</a><br>学习参考地址: <a href="https://docs.huihoo.com/apache/mesos/chrisrc.me/dcos-admin-monitoring-docker.html" target="_blank" rel="noopener">https://docs.huihoo.com/apache/mesos/chrisrc.me/dcos-admin-monitoring-docker.html</a></p>
<p><strong>cAdvisor 结构图:</strong></p>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210506120318.png" target="_blank" title="WeiyiGeek.cAdvisor 结构图" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210506120318.png" alt="WeiyiGeek.cAdvisor 结构图" title="" class=""></a>
                <p>WeiyiGeek.cAdvisor 结构图</p>
            </figure>
<p><br/></p>
<p><strong>安装方式:</strong></p>
<ul>
<li>1) 二进制部署<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下载二进制：https://github.com/google/cadvisor/releases/latest</span><br><span class="line">本地运行：./cadvisor  -port=8080 &amp;&gt;&gt;/var/<span class="built_in">log</span>/cadvisor.log</span><br></pre></td></tr></table></figure></li>
<li><p>2) 使用docker部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  --volume=/var/run:/var/run:rw \</span><br><span class="line">  --volume=/sys:/sys:ro \</span><br><span class="line">  --volume=/var/lib/docker/:/var/lib/docker:ro \</span><br><span class="line">  --volume=/dev/disk/:/dev/disk:ro \</span><br><span class="line">  --publish=9100:8080\</span><br><span class="line">  --detach=<span class="literal">true</span> \</span><br><span class="line">  --name=cadvisor \</span><br><span class="line">  google/cadvisor:latest</span><br><span class="line"><span class="comment"># 8fa36cd105ebce5c9cc334f2bfaae781833ddce396bfb96bd775a18706c9e1f3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意:在Ret Hat,CentOS, Fedora 等发行版上需要传递如下参数，因为 SELinux 加强了安全策略：</span></span><br><span class="line">--privileged=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选参数</span></span><br><span class="line">--volume=/:/rootfs:ro \</span><br></pre></td></tr></table></figure>
</li>
<li><p>3) 启动后访问 <code>http://192.168.12.108:9100/containers</code> 查看 CAvisor 监控页面;</p>
</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210505154147.png" target="_blank" title="WeiyiGeek.CAvisor-containers" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210505154147.png" alt="WeiyiGeek.CAvisor-containers" title="" class=""></a>
                <p>WeiyiGeek.CAvisor-containers</p>
            </figure>
<ul>
<li><p>4) 然后访问: <code>http://192.168.12.108:9100/metrics</code> 查看其暴露给 Prometheus 的所有数据;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HELP cadvisor_version_info A metric with a constant '1' value labeled by kernel version, OS version, docker version, cadvisor version &amp; cadvisor revision.</span></span><br><span class="line"><span class="comment"># TYPE cadvisor_version_info gauge</span></span><br><span class="line">cadvisor_version_info&#123;cadvisorRevision=<span class="string">"8949c822"</span>,cadvisorVersion=<span class="string">"v0.32.0"</span>,dockerVersion=<span class="string">"19.03.14"</span>,kernelVersion=<span class="string">"5.4.0-60-generic"</span>,osVersion=<span class="string">"Alpine Linux v3.7"</span>&#125; 1</span><br><span class="line"><span class="comment"># HELP container_cpu_load_average_10s Value of container cpu load average over the last 10 seconds.</span></span><br><span class="line"><span class="comment"># TYPE container_cpu_load_average_10s gauge</span></span><br><span class="line">container_cpu_load_average_10s&#123;container_label_annotation_io_kubernetes_container_hash=<span class="string">""</span>,container_label_annotation_io_kubernetes_container_ports=<span class="string">""</span>,container_label_annotation_io_kubernetes_container_restartCount=<span class="string">""</span>,container_label_annotation_io_kubernetes_container_terminationMessagePath=<span class="string">""</span>,container_label_annotation_io_kubernetes_container_terminationMessagePolicy=<span class="string">""</span>,</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>
</li>
<li><p>5) 我们将cAdvisor配置接入到<code>prometheus</code>之中，修改后重新启动容器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /nfsdisk-31/monitor/prometheus/conf/prometheus.yml</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: <span class="string">'node-resources'</span></span><br><span class="line">    scrape_interval: 120s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">'192.168.12.107:9100'</span>,<span class="string">'192.168.12.108:9100'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 cAdvisor 添加到监控数据采集任务目标当中</span></span><br><span class="line"><span class="comment"># - job_name: cadvisor</span></span><br><span class="line"><span class="comment">#   static_configs:</span></span><br><span class="line"><span class="comment">#   - targets:</span></span><br><span class="line"><span class="comment">#     - 10.10.107.234:9060</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启容器</span></span><br><span class="line">docker restart prometheus_server</span><br><span class="line">  <span class="comment"># prometheus_server</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>6) 访问Prometheus后台页面查看target以及查询验证。</p>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210505161912.png" target="_blank" title="WeiyiGeek.cadvisor_version_info" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210505161912.png" alt="WeiyiGeek.cadvisor_version_info" title="" class=""></a>
                <p>WeiyiGeek.cadvisor_version_info</p>
            </figure>
</li>
</ul>
<p>Tips : 在CentOS上运行cAdvisor时，需要添加 <code>--privileged=true</code> 和 <code>--volume=/cgroup:/cgroup:ro</code> 两项配置。</p>
<ul>
<li><p>CentOS/RHEL对其上的容器做了额外的安全限定，cAdvisor需要通过Docker的socket访问Docker守护进程，这需要<code>--privileged=true</code>参数。</p>
</li>
<li><p>某些版本的CentOS/RHEL将cgroup层次结构挂载到了<code>/cgroup</code>下，cAdvisor需要通过<code>--volume=/cgroup:/cgroup:ro</code>获取容器信息。</p>
</li>
</ul>
<p>Tips : 如果碰到<code>Invalid Bindmount /</code>错误，可能是由于Docker版本较低所致，可以在启动cAdvisor时不挂载<code>--volume=/:/rootfs:ro</code>。</p>
<p>Tips ：总结正是因为 cadvisor 与 Prometheus 的完美结合，所以它成为了容器监控的第一选择,或者<code>cadvisor + influxdb + grafna</code>搭配使用。</p>
<p><br></p>
<h3 id="5-Grafana-图像化展示接入"><a href="#5-Grafana-图像化展示接入" class="headerlink" title="5.Grafana 图像化展示接入"></a>5.Grafana 图像化展示接入</h3><p>描述: 在简单的配置好node-export被监控主机以及cAdvisor容器监控之后,将其监控采集的数据接入到Grafana进行展示。</p>
<ul>
<li>Step 1.点击首页 <code>Create a data source</code> 按钮选择 <code>Prometheus</code> 导入  <code>Prometheus</code> 监控数据源(注:由于搭建的版本不同位置名称可能由些许不同)<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506144815.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506144815.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
</li>
</ul>
<ul>
<li>Step 2.进入 Prometheus 的 Data Sources 设置页面之后, 设置 URL 为的 <code>http://192.168.12.107:30090</code>, 其余的默认即可 Auth 方式稍后使用 nginx 进行用户访问权限验证处理。</li>
</ul>
<ul>
<li>Step 3.配置好信息之后点击底部的 <code>Save &amp; test</code> 按钮，测试是否能正常获取的<code>Prometheus</code> 监控数据源</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506165636.png" target="_blank" title="WeiyiGeek.Prometheus监控数据源" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506165636.png" alt="WeiyiGeek.Prometheus监控数据源" title="" class=""></a>
                <p>WeiyiGeek.Prometheus监控数据源</p>
            </figure>
<ul>
<li>Step 4.点击右上角 <code>+</code> 按钮 —&gt; <code>Import dashboard</code> 然后在 <code>Import via grafana.com</code> 输入栏中输入 <code>https://grafana.com/grafana/dashboards/8919</code> 再点击 <code>Load</code> ，之后会自动跳转到该 dashboard 的配置页面。</li>
</ul>
<ul>
<li>Step 5.设置好名称，并在 <code>Prometheus Data Source</code> 选择之前配置好的数据源，然后点击 <code>import</code> 即可。</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506172036.png" target="_blank" title="WeiyiGeek.import-prometheus-dashboard" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506172036.png" alt="WeiyiGeek.import-prometheus-dashboard" title="" class=""></a>
                <p>WeiyiGeek.import-prometheus-dashboard</p>
            </figure>
<ul>
<li>Step 6.回到 grafana 的主页面，页面 <code>Recently viewed dashboards</code> 会有出现我们刚刚导入的  dashboard, 点击进入后会出现以下监控信息。</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506172650.png" target="_blank" title="WeiyiGeek.prometheus-dashboard-1" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506172650.png" alt="WeiyiGeek.prometheus-dashboard-1" title="" class=""></a>
                <p>WeiyiGeek.prometheus-dashboard-1</p>
            </figure>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506172859.png" target="_blank" title="WeiyiGeek.prometheus-dashboard-2" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20210506172859.png" alt="WeiyiGeek.prometheus-dashboard-2" title="" class=""></a>
                <p>WeiyiGeek.prometheus-dashboard-2</p>
            </figure>
<p><br/></p>
<h3 id="6-在k8s中安装部署上述组件"><a href="#6-在k8s中安装部署上述组件" class="headerlink" title="6.在k8s中安装部署上述组件"></a>6.在k8s中安装部署上述组件</h3><p>描述: 该存储库将Kubernetes清单、Grafana仪表板和Prometheus规则与文档和脚本结合起来，通过Prometheus使用Prometheus操作符来提供易于操作的端到端Kubernetes集群监控。<br>Prometheus github 地址: <a href="https://github.com/prometheus-operator/kube-prometheus#quickstart" target="_blank" rel="noopener">https://github.com/prometheus-operator/kube-prometheus#quickstart</a><br>Prometheus github 地址: <a href="https://github.com/coreos/kube-prometheus" target="_blank" rel="noopener">https://github.com/coreos/kube-prometheus</a></p>
<p><strong>组件说明:</strong></p>
<ul>
<li>1.MetricServer: 是kubernetes集群资源使用情况的聚合器，收集数据给kubernetes集群内使用，如 kubectl,hpa,scheduler等。</li>
<li>2.PrometheusOperotor:是一个系统监测和警报工具箱，用来存储监控数据 </li>
<li>3.NodeExporter:用于各node的关键度量指标状态数据。</li>
<li>4.KubeStateMetrics:收集kubernetes集群内资源对象数 据，制定告警规则。</li>
<li>5.Prometheus：:采用pull方式收集apiserver, scheduler, controller-mandger, kubelet组件数 据，通过http协议传输。</li>
<li>6.Grafana:是可视化数据统计和监控平台。</li>
</ul>
<p><strong>操作流程:</strong></p>
<ul>
<li>Step 0.拉取 kube-prometheus 在 Github 中的项目文件;<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PS : 设置当前代理为 http://127.0.0.1:1080 或 socket5://127.0.0.1:1080 (此处为了加快拉取速度我采用自己的VPS搭建的梯子)</span></span><br><span class="line">git config --global http.proxy <span class="string">'socks5://127.0.0.1:1080'</span></span><br><span class="line">git config --global https.proxy <span class="string">'socks5://127.0.0.1:1080'</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/coreos/kube-prometheus.git</span><br><span class="line"></span><br><span class="line">~/K8s/Day10/kube-prometheus$ ls</span><br><span class="line">build.sh            DCO   example.jsonnet  experimental  go.sum  jsonnet           jsonnetfile.lock.json  LICENSE   manifests  OWNERS     scripts                            tests</span><br><span class="line">code-of-conduct.md  docs  examples         go.mod        hack    jsonnetfile.json  kustomization.yaml     Makefile  NOTICE     README.md  sync-to-internal-registry.jsonnet  test.sh</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 1.由于GFW的原因我们需要将资源清单中的quay.io仓库以及k8s.gcr.io仓库镜像地址进行换成国内(<code>PS:建议在国外买VPS然后PULL下载后打包回国内</code>)以及type访问类型<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">~/K8s/Day10/kube-prometheus/manifests/setup$ grep <span class="string">"quay.io/"</span> *</span><br><span class="line">  <span class="comment"># prometheus-operator-deployment.yaml:        - --prometheus-config-reloader=quay.io/prometheus-operator/prometheus-config-reloader:v0.44.0</span></span><br><span class="line">  <span class="comment"># prometheus-operator-deployment.yaml:        image: quay.io/prometheus-operator/prometheus-operator:v0.44.0</span></span><br><span class="line">  <span class="comment"># prometheus-operator-deployment.yaml:        image: quay.io/brancz/kube-rbac-proxy:v0.8.0</span></span><br><span class="line">~/K8s/Day10/kube-prometheus/manifests/setup$ sed -i <span class="string">"s#quay.io/#quay.mirrors.ustc.edu.cn/#g"</span> *</span><br><span class="line">~/K8s/Day10/kube-prometheus/manifests/$ sed -i <span class="string">"s#quay.io/#quay.mirrors.ustc.edu.cn/#g"</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改访问方式为`type: NodePort`以及NodePort暴露的端口</span></span><br><span class="line"><span class="comment"># ---~/K8s/Day10/kube-prometheus/manifests$ cat  alertmanager-service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    alertmanager: main</span><br><span class="line">  name: alertmanager-main</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort   <span class="comment"># 修改点1</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 9093</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30070  <span class="comment"># 修改点2</span></span><br><span class="line">  selector:</span><br><span class="line">    alertmanager: main</span><br><span class="line">    app: alertmanager</span><br><span class="line">  sessionAffinity: ClientIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---~/K8s/Day10/kube-prometheus/manifests$ cat prometheus-service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    prometheus: k8s</span><br><span class="line">  name: prometheus-k8s</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort    <span class="comment"># 修改点1</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 9090</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30090  <span class="comment"># 修改点2</span></span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">    prometheus: k8s</span><br><span class="line">  sessionAffinity: ClientIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---~/K8s/Day10/kube-prometheus/manifests$ cat grafana-service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 3000</span><br><span class="line">    targetPort: http</span><br><span class="line">    nodePort: 30080  <span class="comment"># 修改点2</span></span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">  <span class="built_in">type</span>: NodePort   <span class="comment"># 修改点1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 2.使用manifests/setu的清单目录中的配置创建监视堆栈<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~/K8s/Day10/kube-prometheus/manifests/setup$ kubectl create -f .</span><br><span class="line">  <span class="comment"># namespace/monitoring created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created</span></span><br><span class="line">  <span class="comment"># clusterrole.rbac.authorization.k8s.io/prometheus-operator created</span></span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/prometheus-operator created</span></span><br><span class="line">  <span class="comment"># deployment.apps/prometheus-operator created</span></span><br><span class="line">  <span class="comment"># service/prometheus-operator created</span></span><br><span class="line">  <span class="comment"># serviceaccount/prometheus-operator created</span></span><br><span class="line"></span><br><span class="line">~/K8s/Day10/kube-prometheus/manifests/setup$ kubectl get pod -n monitoring -o wide --show-labels</span><br><span class="line"><span class="comment"># NAME                                   READY   STATUS    RESTARTS   AGE   IP            NODE       LABELS</span></span><br><span class="line"><span class="comment"># prometheus-operator-5bff4cfb76-dtvjj   2/2     Running   0          50m   10.244.2.59   k8s-node-5 app.kubernetes.io/component=controller,app.kubern   etes.io/name=prometheus-operator,app.kubernetes.io/version=v0.44.0,pod-template-hash=5bff4cfb76</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<p>Step 3. 完成上一步资源清单的创建后继续进行manifests中grafana、alertmanager、node-exporter资源清单的建立<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~/K8s/Day10/kube-prometheus$ kubectl create -f manifests/</span><br><span class="line">  <span class="comment"># alertmanager.monitoring.coreos.com/main created</span></span><br><span class="line">  <span class="comment"># secret/alertmanager-main created</span></span><br><span class="line">  ...... <span class="comment"># 此处略去</span></span><br><span class="line">  <span class="comment"># servicemonitor.monitoring.coreos.com/kubelet created</span></span><br><span class="line"></span><br><span class="line">~/K8s/Day10/kube-prometheus$ kubectl get pod -n monitoring -o wide</span><br><span class="line">  <span class="comment"># NAME                                   READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># alertmanager-main-0                    2/2     Running   0          105m    10.244.2.60     k8s-node-5    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># alertmanager-main-1                    2/2     Running   0          105m    10.244.1.157    k8s-node-4    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># alertmanager-main-2                    2/2     Running   0          105m    10.244.2.61     k8s-node-5    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># grafana-79f4b5649f-6sjg5               1/1     Running   0          105m    10.244.1.159    k8s-node-4    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># kube-state-metrics-58c88f48b7-frqb2    3/3     Running   0          105m    10.244.1.160    k8s-node-4    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># node-exporter-4nmsz                    2/2     Running   0          105m    10.10.107.214   k8s-node-4    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># node-exporter-7x6bm                    2/2     Running   0          105m    10.10.107.215   k8s-node-5    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># node-exporter-98crd                    2/2     Running   0          105m    10.10.107.202   ubuntu   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># prometheus-adapter-69b8496df6-7mqcv    1/1     Running   0          105m    10.244.2.63     k8s-node-5    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># prometheus-k8s-0                       2/2     Running   1          105m    10.244.1.158    k8s-node-4    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># prometheus-k8s-1                       2/2     Running   0          105m    10.244.2.62     k8s-node-5    &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># prometheus-operator-5bff4cfb76-dtvjj   2/2     Running   0          5h26m   10.244.2.59     k8s-node-5    &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li>Step 4.查看Services资源清单得到<code>prometheus、grafana、alertmanager</code>暴露的端口<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~/K8s/Day10/kube-prometheus/manifests$ kubectl get svc -n monitoring -o wide</span><br><span class="line">NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE     SELECTOR</span><br><span class="line">prometheus-adapter      ClusterIP   10.100.45.247    &lt;none&gt;        443/TCP                      122m    name=prometheus-adapter</span><br><span class="line">prometheus-operator     ClusterIP   None             &lt;none&gt;        8443/TCP                     5h42m   app.kubernetes.io/component=controller,app.kubernetes.io/name=prometheus-operator</span><br><span class="line">kube-state-metrics      ClusterIP   None             &lt;none&gt;        8443/TCP,9443/TCP            122m    app.kubernetes.io/name=kube-state-metrics</span><br><span class="line">prometheus-operated     ClusterIP   None             &lt;none&gt;        9090/TCP                     122m    app=prometheus</span><br><span class="line">alertmanager-operated   ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   122m    app=alertmanager</span><br><span class="line">node-exporter           ClusterIP   None             &lt;none&gt;        9100/TCP                     122m    app.kubernetes.io/name=node-exporter</span><br><span class="line">alertmanager-main       NodePort    10.100.233.132   &lt;none&gt;        9093:30070/TCP               122m    alertmanager=main,app=alertmanager</span><br><span class="line">prometheus-k8s          NodePort    10.103.33.255    &lt;none&gt;        9090:30090/TCP               122m    app=prometheus,prometheus=k8s</span><br><span class="line">grafana                 NodePort    10.104.211.111   &lt;none&gt;        3000:30080/TCP               122m    app=grafana</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>应用IP端口访问列表:</p>
<ul>
<li>prometheus 对应的 nodeport 端口为 30080 访问 <a href="http://10.10.107.202:30080" target="_blank" rel="noopener">http://10.10.107.202:30080</a></li>
<li>grafana 对应的 nodeport 端口为 30080 访问 <a href="http://10.10.107.202:30080" target="_blank" rel="noopener">http://10.10.107.202:30080</a></li>
<li>alertmanager 对应的 nodeport 端口为 30070 访问 <a href="http://10.10.107.202:30070" target="_blank" rel="noopener">http://10.10.107.202:30070</a></li>
</ul>
<p>PS : 下面验证上述服务能否正常访问</p>
<p><br></p>
<ul>
<li>Step 5.访问 prometheus <code>Web UI</code>可以看到其已经与K8S的Api-Server连接成功;<br>URL: <a href="http://10.10.107.202:30090/graph?g0.range_input=1h&amp;g0.expr=sum(rate(container_cpu_usage_seconds_total%7Bimage!%3D%22%22%7D%5B1m%5D))%20by%20(pod_name%2C%20namespace)&amp;g0.tab=0" target="_blank" rel="noopener">http://10.10.107.202:30090/graph?g0.range_input=1h&amp;g0.expr=sum(rate(container_cpu_usage_seconds_total%7Bimage!%3D%22%22%7D%5B1m%5D))%20by%20(pod_name%2C%20namespace)&amp;g0.tab=0</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Prometheus 自己的指标prometheus 的 WEB 界面上提供了基本的查询 K8S 集群中每个 POD 的 CPU 使用情况，查询条件如下</span></span><br><span class="line">sum(rate(container_cpu_usage_seconds_total&#123;image!=<span class="string">""</span>&#125;[1m])) by (pod_name, namespace)  <span class="comment"># PS:内置函数后面细讲</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208172721.png" target="_blank" title="WeiyiGeek.prometheus-Web" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208172721.png" alt="WeiyiGeek.prometheus-Web" title="" class=""></a>
                <p>WeiyiGeek.prometheus-Web</p>
            </figure>
</li>
</ul>
<p>PS : 上述的查询有出现数据说明node-exporter往Prometheus中写数据是正常的，接下来查看你我们的grafana组件实现更友好的数据展示</p>
<p><br></p>
<ul>
<li>Step 6.访问grafana Web UI进行数据图形化展示，缺省账号密码admin、admin,登录后要设置新的密码weiyigeek;</li>
</ul>
<p>随后在Grafana中添加<code>Prometheus</code>数据源进行数据的展示: <code>Configuration -&gt; Data Source -&gt; prometheus -&gt; 导入指定 prometheus</code>;<br><figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208174622.png" target="_blank" title="WeiyiGeek.grafana-import" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208174622.png" alt="WeiyiGeek.grafana-import" title="" class=""></a>
                <p>WeiyiGeek.grafana-import</p>
            </figure></p>
<p>采用 Grafana 展示的 Prometheus 数据：<br><figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208174736.png" target="_blank" title="WeiyiGeek.Grafana metrics" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208174736.png" alt="WeiyiGeek.Grafana metrics" title="" class=""></a>
                <p>WeiyiGeek.Grafana metrics</p>
            </figure></p>
<p><br/></p>
<ul>
<li>Step 7.访问 alertmanager 的 Web UI 进行查看预警;</li>
</ul>
<figure class="image-box">
                <a rel=1.Prometheus监控入门之介绍整体架构及安装 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208194952.png" target="_blank" title="WeiyiGeek.alertmanager" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201208194952.png" alt="WeiyiGeek.alertmanager" title="" class=""></a>
                <p>WeiyiGeek.alertmanager</p>
            </figure>
<p><br/></p>
<ul>
<li>Step 8.至此采用Helm安装Prometheus完成，但是它仅仅是个示例我们需要对其做完整的安全保护(访问限制、访问认证可以在Nginx中进行配置)</li>
</ul>

        </div>
        <!-- Google 广告 -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-03-29T05:39:03.674Z" itemprop="dateUpdated">2022-03-29 13:39:03</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/虚拟云容/云容器/Kubernetes/功能组件/Prometheus/1.Prometheus监控入门之介绍整体架构及安装.md" target="_blank" rel="noopener noreferrer">_posts/虚拟云容/云容器/Kubernetes/功能组件/Prometheus/1.Prometheus监控入门之介绍整体架构及安装.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2021/4-22-550.html" target="_blank" rel="external">https://blog.weiyigeek.top/2021/4-22-550.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Prometheus/" rel="tag">Prometheus</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/4-22-550.html&title=《1.Prometheus监控入门之介绍整体架构及安装》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/4-22-550.html&title=《1.Prometheus监控入门之介绍整体架构及安装》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/4-22-550.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《1.Prometheus监控入门之介绍整体架构及安装》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/4-22-550.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/4-22-550.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/4-25-554.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">4.Prometheus监控入门之PromQL表达式语法学习</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/4-21-549.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">PS常用.NET类型记录和使用命令</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#0-学习导读"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">0.学习导读</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-开源监控系统简史"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">1.开源监控系统简史</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-Prometheus-基础简介"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">2.Prometheus 基础简介</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-Prometheus-架构组件"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">3.Prometheus 架构组件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-Prometheus-基本原理"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">4.Prometheus 基本原理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-Prometheus-数据模型和类型"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">5.Prometheus 数据模型和类型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-Prometheus-学习参考"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">6.Prometheus 学习参考</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-环境安装配置"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 环境安装配置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Prometheus-安装方式"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.Prometheus 安装方式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-Prometheus-服务安装"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.Prometheus 服务安装</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-Node-Exporter-节点导出器安装"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3.Node Exporter 节点导出器安装</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-cAdvisor-容器监控安装"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">4.cAdvisor 容器监控安装</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-Grafana-图像化展示接入"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">5.Grafana 图像化展示接入</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-在k8s中安装部署上述组件"><span class="post-toc-number">2.6.</span> <span class="post-toc-text">6.在k8s中安装部署上述组件</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- 微信公众号关注/文章版权复制 -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">个人Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">个人Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">个人知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云+云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/4-22-550.html&title=《1.Prometheus监控入门之介绍整体架构及安装》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/4-22-550.html&title=《1.Prometheus监控入门之介绍整体架构及安装》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/4-22-550.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《1.Prometheus监控入门之介绍整体架构及安装》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/4-22-550.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/4-22-550.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJklEQVR42u3a0Y6DMAxEUf7/p+lrqwqYGUPV2DdPqy6kOVnJG9vZNnnsX+Pot8rz78+cz3PzgAEDxrKM/XScL1THHL31/fn5dhxSYcCAMYDxxNT6MxU2DBgwYCjh1Q3TyswwYMCAUQ+4bvL5p/83YMCAsRRDCZ3Kl+mFNuWtR3JxGDBgLMjQq+6///mR/gYMGDCWYuzmUHhK4lpfycecMGDAaM3QA5xyHKwntJX1wIABYxrDvQTmLlQvwOmfwIABYwLDLZPpC3WLdNnzMGDA6MpwL3W5y600LI3WAgwYMMYwKpcq3DB970bAgAGjNyM70rnXvLKyXbh0GDBgtGNIZSyBah/m5GaA9BYMGDAGMJQLo5XWZj18X8wDAwaM1gx9QVnrUW8q6LNdbC4MGDBaM7Iwp4TIrNCWHVhhwIDRm+EmmW6IrLPDoyEMGDAaMSpHuixxzZqd4YABA8ayDD1x/c3h0g27MGDAmMBQDnl68yAr7rvtgYu/CQwYMFozKmV6Nym9a5s+vh0GDBgDGErAvSuw6iU5Y3NhwIAxhqE3HbMwGpb13SQWBgwYjRi7OTJqFmSVjYABA8YERlbo1wOoe6XMPSbaGBgwYCzLsAtbEcNtUrohGwYMGBMYeuCrtArsDFu/OgYDBgwYURsga3Dqh9HN3VcYMGCMZOihM0t0DTwMGDAGMNxmgF7Kz8Lrg+U2GDBgLMgo3dSIWgtK+9M9hsKAAaMp4wUuPWqYkL/ESAAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>