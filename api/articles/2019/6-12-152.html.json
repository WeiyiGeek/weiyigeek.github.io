{"title":"systemd服务管理详解与子命令一览","slug":"系统运维/Linux/常用命令/安装软件类命令/systemd服务管理详解与子命令一览","date":"2019-06-12T14:35:30.000Z","updated":"2022-08-24T13:25:30.699Z","url":"2019/6-12-152.html","path":"api/articles/2019/6-12-152.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420194736.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420195050.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420212341.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420212505.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420215715.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-Systemd-简述\"><a href=\"#0x00-Systemd-简述\" class=\"headerlink\" title=\"0x00 Systemd 简述\"></a>0x00 Systemd 简述</h4><p>描述:系统启动和服务器守护进程管理器，负责在系统启动或运行时激活系统资源，并且管理服务器进程和其它进程，可以说他是Linux的小伙伴系统启动时候最先都是运行的systemd;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ps</span> aux</span><br><span class=\"line\">USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class=\"line\">root          1  0.0  0.1 128204  5884 ?        Ss   3月25   2:19 /usr/lib/systemd/systemd --switched-root --system --deserialize 22</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"1-Linux-启动流程\"><a href=\"#1-Linux-启动流程\" class=\"headerlink\" title=\"1.Linux 启动流程\"></a>1.Linux 启动流程</h5><p>描述:要想清楚 systemd 在 Linux 系统中的地位和作用，就不得不提一下 Linux 的启动流程；<br>Linux 从按下电源键到进入用户交互界面整个启动流程大致可以分为四个阶段：</p>\n<ul>\n<li>BIOS 阶段: 基本的硬件自检准备以及加载 bootloader 程序;</li>\n<li>BootLoader 阶段</li>\n<li>kernel 加载阶段</li>\n<li>init (<code>systemd/sysvinit 初始化阶段</code>)</li>\n</ul>\n<p><strong>(1) BIOS 阶段</strong><br>Step 1.在按下电源电源键（冷启动）后，<code>CPU 的程序计数器被初始化为一个特定的內存地址</code>(所以没有 CPU 是无法启动主板上的 BIOS 的)，存储在只读存储器（ROM）中的 BIOS 就是从这个特定的內存地址开始执行，值得注意的是对于嵌入式系统中的 CPU ，将会加载引导区去启动 flash/ROM 中已知地址的程序；<br>Step2.BIOS 启动后就开始执行硬件的基本初始化也称之为<code>上电自检</code>,并根据引导设备的优先级将系统控制权交给硬件启动项（<code>比如硬盘/网络/U盘等</code>）,此阶段可以进行外部中断我们按下 F12 或者 ESC 键（根据主板芯片组而异）就会弹出选择启动项的界面，而且这些按键高度依赖硬件。<br>Step3.BIOS 选择好硬件启动项之后就<code>开始执行硬件设备上的初级引导程序代码</code>，对于 MBR 硬盘来讲是最开始的一个扇区（512字节）將被加载到內存，並执行行其中的初始化代码来加载下一阶段的 Bootloader</p>\n<p>PS:此处以MBR引导的系统记录为例，MBR 主引导记录是一个 512 字节的扇区，位于硬盘的第一扇区（0道0柱1扇区），对于 GPT/EFI 引导等有经验的时候再来讲解补充;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#dd 命令读取 MBR 主引导记录</span></span><br><span class=\"line\">dd <span class=\"keyword\">if</span>=/dev/sda of=mbr.bin bs=512 count=1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#od 命令来查看二进制文件</span></span><br><span class=\"line\">od -xa mbr.bin</span><br><span class=\"line\"><span class=\"comment\"># 0000000    63eb    0090    0000    0000    0000    0000    0000    0000</span></span><br><span class=\"line\"><span class=\"comment\">#           k   c dle nul nul nul nul nul nul nul nul nul nul nul nul nul</span></span><br><span class=\"line\"><span class=\"comment\"># 0000020    0000    0000    0000    0000    0000    0000    0000    0000</span></span><br><span class=\"line\"><span class=\"comment\">#         nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul</span></span><br><span class=\"line\"><span class=\"comment\"># *</span></span><br><span class=\"line\"><span class=\"comment\"># 0000120    0000    0000    0000    0000    0000    8000    0800    0000</span></span><br><span class=\"line\"><span class=\"comment\">#         nul nul nul nul nul nul nul nul nul nul nul nul nul  bs nul nul</span></span><br><span class=\"line\"><span class=\"comment\"># 0000140    0000    0000    faff    9090    c2f6    7480    f605    70c2</span></span><br><span class=\"line\"><span class=\"comment\">#         nul nul nul nul del   z dle dle   v   B nul   t enq   v   B   p</span></span><br><span class=\"line\"><span class=\"comment\"># 0000160    0274    80b2    79ea    007c    3100    8ec0    8ed8    bcd0</span></span><br><span class=\"line\"><span class=\"comment\">#           t stx   2 nul   j   y   | nul nul   1   @  so   X  so   P   &lt;</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>(2) BootLoader 阶段</strong><br>主引导记录加载完 Bootloader（主要为GRUB）到 RAM 中之后，GRUB 会根据需求显示一个可用的内核列表（<code>定义在/etc/grub.conf，/etc/grub/menu.lst和/etc/grub.conf的软连接</code>）<br>根据 GRUB 的配置加载默认内核镜像和 initrd 镜像到内存中，当所有镜像准备好后，即跳转到内核镜像（针对于Windows可能有些许不同但都大同小异）。</p>\n<p><br></p>\n<p><strong>(3) kernel 阶段</strong><br>当BootLoader 阶段完成之后内核镜像(kernel image)被加载到内存中，系统的控制权就交给内核镜像由此内核阶段开始了;</p>\n<p>内核镜像不是一个可以执行的内核，而是一个被压缩的内核镜像 （<code>zImage 或 bzImage</code>）, 在内核镜像的头部有一个小型程序 routine 其做少量的硬件设置 ，然后自解压压缩的内核镜像并放到高端内存。<br>如果存在初始磁盘镜像（initrd）, routine 将拷贝 initrd 以供稍后安装使用，然后 routine 将调用内核开始内核启动。</p>\n<blockquote>\n<p>在内核引导过程中，初始 RAM 磁盘（initrd）是由 BootLoader 加载到内存中的，它会被复制到 RAM 中并挂载到系统上。<br>initrd 作为 RAM 中的临时根文件系统使用，并允许内核在没有挂载任何物理磁盘的情况下完整地实现引导(实际上CentOS7忘记使用进行恢复也是主要依赖于<code>initrd</code>),由于与外围设备进行交互所需要的模块可是 initrd 的一部分，因此内核可以非常小，但是仍然支持大量可能的硬件配置<br>在内核启动后就可以正式装备根文件系统了（通过 pivot_root），此时会将 initrd 根文件系统卸载掉并挂载真正的根文件系统。<br>initrd 函数可以创建一个小型的 Linux 内核，其中包括作为可加载模块编译的驱动程序, 并且该模块可以为内核提供了访问磁盘和磁盘上的文件系统的方法，并为其他硬件提供了驱动程序<br>由于根文件系统是磁盘上的一个文件系统，因此 initrd 函数会提供一种启动方法来获得对磁盘的访问，并挂载真正的根文件系统。但是在没有硬盘的嵌入式目标中，initrd 可以是最终的根文件系统，或者也可以通过网络文件系统（NFS）来挂载最终的根文件系统。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#使用 dmesg 来查看从加载内核后的流程</span></span><br><span class=\"line\">$ dmesg</span><br><span class=\"line\">[    0.000000] Linux version 5.0.0-1031-gcp (buildd@lcy01-amd64-020) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1)) <span class=\"comment\">#32-Ubuntu SMP Tue Feb 11 03:55:48 UTC 2020 (Ubuntu 5.0.0-1031.32-gcp 5.0.21)</span></span><br><span class=\"line\">[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-5.0.0-1031-gcp root=PARTUUID=9b22aacc-c8b9-497a-9583-a20c1be968c4 ro scsi_mod.use_blk_mq=Y console=ttyS0</span><br><span class=\"line\">[    0.000000] KERNEL supported cpus:</span><br><span class=\"line\">[    0.000000]   Intel GenuineIntel</span><br><span class=\"line\">[    0.000000]   AMD AuthenticAMD</span><br><span class=\"line\">[    0.000000]   Hygon HygonGenuine</span><br><span class=\"line\">[    0.000000]   Centaur CentaurHauls</span><br><span class=\"line\">……………………………………………………………………………………………………</span><br><span class=\"line\">[    2.486896] Write protecting the kernel <span class=\"built_in\">read</span>-only data: 22528k</span><br><span class=\"line\">[    2.489395] Freeing unused kernel image memory: 2016K</span><br><span class=\"line\">[    2.490937] Freeing unused kernel image memory: 1708K</span><br><span class=\"line\">[    2.500867] x86/mm: Checked W+X mappings: passed, no W+X pages found.</span><br><span class=\"line\">[    2.503126] x86/mm: Checking user space page tables</span><br><span class=\"line\">[    2.513767] x86/mm: Checked W+X mappings: passed, no W+X pages found.</span><br><span class=\"line\">[    2.516258] Run /sbin/init as init process</span><br><span class=\"line\">[    3.992535] systemd[1]: systemd 237 running <span class=\"keyword\">in</span> system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD -IDN2 +IDN -PCRE2 default-hierarchy=hybrid)</span><br><span class=\"line\">[    4.002297] systemd[1]: Detected virtualization kvm.</span><br><span class=\"line\">[    4.004593] systemd[1]: Detected architecture x86-64.</span><br><span class=\"line\">[    4.031531] systemd[1]: Set hostname to &lt;blog&gt;.</span><br><span class=\"line\">[    5.343604] systemd[1]: Reached target Swap.</span><br><span class=\"line\">[    5.355156] systemd[1]: Started Dispatch Password Requests to Console Directory Watch.</span><br><span class=\"line\">[    5.367360] systemd[1]: Created slice User and Session Slice.</span><br><span class=\"line\">[    5.379321] systemd[1]: Set up automount Arbitrary Executable File Formats File System Automount Point.</span><br><span class=\"line\">[    5.395189] systemd[1]: Started Forward Password Requests to Wall Directory Watch.</span><br><span class=\"line\">[    5.411078] systemd[1]: Reached target Local Encrypted Volumes.</span><br><span class=\"line\">[    5.644759] EXT4-fs (sda1): re-mounted. Opts: (null)</span><br><span class=\"line\">[   11.663490] bpfilter: Loaded bpfilter_umh pid 456</span><br></pre></td></tr></table></figure>\n<p><strong>（4）init 阶段</strong><br>当内核自解压完成启动并初始化后，内核启动第一个用户空间应用程序即 systemd 进程（<code>其实是老式 System V 系统的 init 程序的替代品</code>)并将控制权移交给它; 这是系统启动后调用的第一个使用标准 C 库编译的程序，在此进程之前还没有执行任何标准的 C 应用程序，至此整个系统引导过程的结束；</p>\n<p>此时 kernel和 systemd 处于工作运行状态然后就由systemd来管理各项程序，有可能您从dmesg输错的日志上该阶段首先执行/sbin/init命令而对于采用systemd的发行版来说，实际上<code>/sbin/init 是指向 /lib/systemd/systemd</code>的软链接文件;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[    2.516258] Run /sbin/init as init process</span><br><span class=\"line\">[    3.992535] systemd[1]: systemd 237 running <span class=\"keyword\">in</span> system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD -IDN2 +IDN -PCRE2 default-hierarchy=hybrid)</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h5 id=\"2-主角登场\"><a href=\"#2-主角登场\" class=\"headerlink\" title=\"2.主角登场\"></a>2.主角登场</h5><p><em>Q:为什么为systemd是 Linux 的小伙伴?</em><br>答:其实广义上来讲 Linux 是众多 Linux 系统发行版的集合，但严格来讲 Linux 仅仅是一个 OS 的 kernel 而已，仅仅有一个内核是无法组成一个系统的，所以 Linux kernel 还需要他的几个兄弟<code>比如 GNU 、 systemd 、X Window 、GNOME 、 KDE 、Xfce 等等</code>其他用户层面的程序来构建出一套完整的操作系统出来</p>\n<p>比如: GNU/Linux 将 Debian 哲学与方法论，GNU 工具集、Linux 内核，以及其他重要的自由软件结合在一起所构成的独特的软件发行版称为 Debian GNU/Linux。</p>\n<p><strong>systemd 简介</strong><br>描述:在片头的时候我大致对systemd的工作做了一个总结，在本章节我对其深入的讲解</p>\n<p>systemd 是一个 Linux 系统基础组件的集合，提供了一个系统和服务管理器，运行为 PID 1 并负责启动其它程序。<br><em>功能包括：</em></p>\n<ul>\n<li>支持并行化任务；</li>\n<li>同时采用 socket 式与 D-Bus 总线式激活服务；</li>\n<li>按需启动守护进程（daemon）；</li>\n<li>利用 Linux 的 cgroups 监视进程； <code>比如systemctl 显示 CPU 和 Mem 信息就是基于此哦</code>。</li>\n<li>支持快照和系统恢复；</li>\n<li>维护挂载点和自动挂载点；</li>\n<li>各服务间基于依赖关系进行精密控制。</li>\n<li>systemd* 支持 SysV 和 LSB 初始脚本，可以替代 sysvinit。</li>\n<li>除此之外功能还包括日志进程、控制基础系统配置，维护登陆用户列表以及系统账户、运行时目录和设置，可以运行容器和虚拟机，可以简单的管理网络配置、网络时间同步、日志转发和名称解析等。</li>\n</ul>\n<p><strong>systemd 设计目标</strong><br>描述:在Redhat、CentOS等系列发行版中从7.x ~ 8.x 正式采用systemd作为系统服务管理工具的内核系统服务;它融合之前service和chkconfig的功能于一体,所以说它也能在 <code>/etc/init.d/</code> 启动脚本进行扫描查看相程序;</p>\n<p>主要目标：</p>\n<ul>\n<li>改进效能：使用二进制代码替换松散的SYSV启动脚本，减少频繁的进程创建/ 库加载/ 内核/用户切换；</li>\n<li>启动并行化: 利用 Dbus 进程间通讯与 socket 激活机制，解决任务启动时的依赖问题</li>\n<li>实现任务（daemons）精确控制：使用内核的 cgroup 机制，不依赖 pid 来追踪进程，即使是两次 fork之后生成的守护进程也不会脱离 systemd 的控制</li>\n<li>统一任务定义: 用户不需要自行编写 shell 脚本，而仅依据 systemd 制定的 unit 规则；</li>\n</ul>\n<p><strong>systemd 体系架构</strong><br>systemd体系架构如下:</p>\n<ul>\n<li>1.最底层：<code>systemd 内核层</code>面依赖 cgroup、autofs、kdbus</li>\n<li>2.第二层：<code>systemd libraries</code> 是 systemd 依赖库</li>\n<li>3.第三层：<code>systemd Core</code> 是 systemd 自己的库</li>\n<li>4.第四层：<code>systemd daemons</code> 以及 targets 是自带的一些基本 unit、target，类似于 sysvinit 中自带的脚本</li>\n<li>5.最上层就是和 systemd 交互的一些工具，比如我们下面将要学习的systemctl;</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420194736.png\" alt=\"WeiyiGeek.systemd体系\" title=\"\" class=\"\">\n                <p>WeiyiGeek.systemd体系</p>\n            </figure>\n<p>Linux 整体硬件与systemd体系架构：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420195050.png\" alt=\"WeiyiGeek.Linux硬件\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Linux硬件</p>\n            </figure></p>\n<hr>\n<h4 id=\"0x01-Systemd-Unit\"><a href=\"#0x01-Systemd-Unit\" class=\"headerlink\" title=\"0x01 Systemd Unit\"></a>0x01 Systemd Unit</h4><p>描述：systemd核心概念unit（单元）类型：unit表示不同类型的systemd对象，并提供了处理不同单元之间依赖关系的能力,通过配置文件进行标识和配置；</p>\n<p>Systemd 服务编写参考: <a href=\"http://www.jinbuguo.com/systemd/systemd.service.html\" target=\"_blank\" rel=\"noopener\">http://www.jinbuguo.com/systemd/systemd.service.html</a></p>\n<p>文件中主要包含了系统服务、监听socket、保存的系统快照以及其它与init相关的信息;</p>\n<table>\n<thead>\n<tr>\n<th>type</th>\n<th>name</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Service unit</td>\n<td>.service</td>\n<td>用于封装一个后台服务进程</td>\n</tr>\n<tr>\n<td>Target unit</td>\n<td>.target</td>\n<td>用于将多个单元在逻辑上组合在一起。</td>\n</tr>\n<tr>\n<td>Device unit</td>\n<td>.device</td>\n<td>用于定义内核识别的设备，在 sysfs(5) 里面作为 udev(7) 设备树展示</td>\n</tr>\n<tr>\n<td>Socket unit</td>\n<td>.socket</td>\n<td>用于标识进程间通信用到的socket文件</td>\n</tr>\n<tr>\n<td>Snapshot unit</td>\n<td>.snapshot</td>\n<td>管理系统快照</td>\n</tr>\n<tr>\n<td>Swap unit</td>\n<td>.swap</td>\n<td>用于标识swap 文件或设备</td>\n</tr>\n<tr>\n<td>Mount unit</td>\n<td>.mount</td>\n<td>用于封装一个文件系统挂载点(也向后兼容传统的 /etc/fstab 文件)</td>\n</tr>\n<tr>\n<td>Automount unit</td>\n<td>.automount</td>\n<td>用于封装一个文件系统自动挂载点</td>\n</tr>\n<tr>\n<td>Path unit</td>\n<td>.path</td>\n<td>用于根据文件系统上特定对象的变化来启动其他服务。</td>\n</tr>\n<tr>\n<td>Time unit</td>\n<td>.timer</td>\n<td>用于封装一个基于时间触发的动作。取代传统的 crond 等任务计划服务</td>\n</tr>\n<tr>\n<td>Slice unit</td>\n<td>*.slice</td>\n<td>用于控制特定 CGroup 内所有进程的总体资源占用。</td>\n</tr>\n</tbody>\n</table>\n<p>systemd 只在内存中加载最小化的一组单元 只有至少满足下列条件之一的单元，才会被加载到内存中：</p>\n<ul>\n<li><p>1.处于 活动(active)、启动中(activating)、停止中(deactivating)、失败(failed) 状态之一(也就是停止(inactive)之外的状态)</p>\n</li>\n<li><p>2.至少有一个作业正在作业队列中</p>\n</li>\n<li><p>3.至少有一个其他已经加载到内存中的单元依赖于它</p>\n</li>\n<li><p>4.仍然占有某些资源 (例如一个已停止的服务单元的进程忽略了终止请求，仍在逗留)</p>\n</li>\n<li><p>5.被 D-Bus 调用以程序化的方式固定到了内存中</p>\n</li>\n</ul>\n<p>  实际上用户并不能显而易见的看到某个单元是否已被加载到内存用 <code>systemctl list-units –all</code> 命令可以显示当前已加载到内存中的所有单元不满足加载条件(见上文)的单元会被立即从内存中卸载，并且它的记帐数据(accounting data)也会被清空。 不过因为每当一个单元关闭时，都会生成一条日志记录声明该单元所消耗的资源， 所以这些数据通常不会彻底消失。</p>\n<h5 id=\"1-配置文件\"><a href=\"#1-配置文件\" class=\"headerlink\" title=\"1.配置文件\"></a>1.配置文件</h5><ul>\n<li><p>在 CentOS/RedHat 发行版中 <code>man systemd.unit</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Table 1.  Load path when running <span class=\"keyword\">in</span> system mode (--system).</span><br><span class=\"line\">┌────────────────────────┬─────────────────────────────┐</span><br><span class=\"line\">│Path                    │ Description                 │</span><br><span class=\"line\">├────────────────────────┼─────────────────────────────┤</span><br><span class=\"line\">│/etc/systemd/system     │ Local configuration         │</span><br><span class=\"line\">├────────────────────────┼─────────────────────────────┤</span><br><span class=\"line\">│/run/systemd/system     │ Runtime units               │</span><br><span class=\"line\">├────────────────────────┼─────────────────────────────┤</span><br><span class=\"line\">│/usr/lib/systemd/system │ Units of installed packages │</span><br><span class=\"line\">└────────────────────────┴─────────────────────────────┘</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li><p>在 Ubuntu/Debian 发行版中 <code>man systemd.unit</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Table 1.  Load path when running in system mode (--system).</span><br><span class=\"line\">┌────────────────────┬─────────────────────────────┐</span><br><span class=\"line\">│Path                │ Description                 │</span><br><span class=\"line\">├────────────────────┼─────────────────────────────┤</span><br><span class=\"line\">│&#x2F;etc&#x2F;systemd&#x2F;system │ Local configuration         │</span><br><span class=\"line\">├────────────────────┼─────────────────────────────┤</span><br><span class=\"line\">│&#x2F;run&#x2F;systemd&#x2F;system │ Runtime units               │</span><br><span class=\"line\">├────────────────────┼─────────────────────────────┤</span><br><span class=\"line\">│&#x2F;lib&#x2F;systemd&#x2F;system │ Units of installed packages │</span><br><span class=\"line\">└────────────────────┴─────────────────────────────┘</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>  在使用 yum/apt 或其他包管理器，以及 rpm/deb 等软件包安装软件的时候，如果该软件支持 systemd 管理的话，就会自动在<code>/usr/lib/systemd/system</code>目录添加一个配置文件(针对于CentOS说明)，此时可以采用<code>systemctl cat name 来查看该软件的 systemd 单元文件</code></p>\n<p>  但是如果软件没有自带 systemd 配置文件的话，我们可以自己搓一个配置文件出来，并复制到相应的目录下即可（后续我会简单配置一个实例<code>[Webp Server Go](https://github.com/webp-sh/webp_server_go)</code>）</p>\n<p>  <br></p>\n<p>  <em>service unit文件格式说明（类似于windows下的ini）：</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">man systemd.service  <span class=\"comment\">#参考</span></span><br><span class=\"line\"></span><br><span class=\"line\">[unit]</span><br><span class=\"line\">Description：描述信息</span><br><span class=\"line\">After：定义unit的启动次序，表示当前unit应该晚于哪些unit启动，其功能与Before相反</span><br><span class=\"line\">Requires：依赖到的其它units，强依赖，被依赖的units无法激活时，当前unit也无法激活</span><br><span class=\"line\">Wants：依赖到的其它units，弱依赖</span><br><span class=\"line\">Conflicts：定义units间的冲突关系\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">[Service] <span class=\"comment\">#与特定类型相关的专用选项；此处为Service类型</span></span><br><span class=\"line\">Type：定义影响ExecStart及相关参数的功能的unit进程启动类型</span><br><span class=\"line\">    simple：默认值，这个daemon主要由ExecStart接的指令串来启动，启动后常驻于内存中</span><br><span class=\"line\">    forking：由ExecStart启动的程序透过spawns延伸出其他子程序来作为此daemon的主要服务。原生父程序在启动结束后就会终止</span><br><span class=\"line\">    oneshot：与simple类似，不过这个程序在工作完毕后就结束了，不会常驻在内存中</span><br><span class=\"line\">    dbus：与simple类似，但这个daemon必须要在取得一个D-Bus的名称后，才会继续运作.因此通常也要同时设定BusNname=才行</span><br><span class=\"line\">    notify：在启动完成后会发送一个通知消息。还需要配合 NotifyAccess 来让 Systemd 接收消息</span><br><span class=\"line\">    idle：与simple类似，要执行这个daemon必须要所有的工作都顺利执行完毕后才会执行。这类的daemon通常是开机到最后才执行即可的服务</span><br><span class=\"line\">EnvironmentFile=/etc/sysconfig/sshd   <span class=\"comment\">#环境file</span></span><br><span class=\"line\">ExecStart=/usr/sbin/sshd -D <span class=\"variable\">$OPTIONS</span>  <span class=\"comment\">#启动</span></span><br><span class=\"line\">ExecReload=/bin/<span class=\"built_in\">kill</span> -HUP <span class=\"variable\">$MAINPID</span>  <span class=\"comment\">#重启</span></span><br><span class=\"line\">KillMode=process     <span class=\"comment\">#关闭</span></span><br><span class=\"line\">Restart=on-failure   <span class=\"comment\"># Restart: fail 时重启</span></span><br><span class=\"line\">RestartSec=42s</span><br><span class=\"line\"></span><br><span class=\"line\">[Target]</span><br><span class=\"line\"><span class=\"comment\">#.target定义了一些基础的组件，供.service文件调用</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Mount]</span><br><span class=\"line\"><span class=\"comment\">#.mount文件定义了一个挂载点，[Mount]节点里配置了What,Where,Type三个数据项</span></span><br><span class=\"line\"><span class=\"comment\">#等同于以下命令：mount -t hugetlbfs /dev/hugepages hugetlbfs</span></span><br><span class=\"line\">What=hugetlbfs </span><br><span class=\"line\">Where-/dev/hugepages</span><br><span class=\"line\">Type=hugetlbfs</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]：<span class=\"comment\">#定义由“systemctl enable”以及\"systemctl disable“命令在实现服务启用或禁用时用到的一些选项</span></span><br><span class=\"line\">Alias：别名，可使用systemctl <span class=\"built_in\">command</span> Alias.service</span><br><span class=\"line\">RequiredBy：被哪些units所依赖，强依赖</span><br><span class=\"line\">WantedBy：被哪些units所依赖，弱依赖 多用户模式下需要的</span><br><span class=\"line\">Also：安装本服务的时候还要安装别的相关服务</span><br></pre></td></tr></table></figure></p>\n<p>  注意事项:</p>\n<ul>\n<li>不同的发行版 systemd unit 的 path 不一样，但是总体来说systemd 的配置文件主要位于以下三个目录中<ul>\n<li><code>/usr/lib/systemd/system</code> 或 <code>/lib/systemd</code> : 使用包管理器安装的软件的 systemd unit 件实际配置文件的存放位置</li>\n<li><code>/run/systemd/system</code>：在运行时创建的s ystemd unit 文件。该目录优先于已安装服务单元文件的目录。</li>\n<li><code>/etc/systemd/system</code>: <code>优先级最高</code>，由 systemctl 命令创建的 systemd unit 文件以及为扩展服务而添加的 unit 文件都将启用。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"2-启动流程\"><a href=\"#2-启动流程\" class=\"headerlink\" title=\"2.启动流程\"></a>2.启动流程</h5><p>当内核加载到内存中后开始执行 systemd，并且根据 dmesg 的日志我们可以了解到 systemd 启动后执行了哪一些操作</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[    2.516258] Run &#x2F;sbin&#x2F;init as init process</span><br><span class=\"line\">[    3.992535] systemd[1]: systemd 237 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD -IDN2 +IDN -PCRE2 default-hierarchy&#x3D;hybrid)</span><br><span class=\"line\">[    4.002297] systemd[1]: Detected virtualization kvm.</span><br><span class=\"line\">[    4.004593] systemd[1]: Detected architecture x86-64.</span><br><span class=\"line\">[    4.031531] systemd[1]: Set hostname to &lt;blog&gt;.</span><br><span class=\"line\">[    5.343604] systemd[1]: Reached target Swap.</span><br><span class=\"line\">[    5.355156] systemd[1]: Started Dispatch Password Requests to Console Directory Watch.</span><br><span class=\"line\">[    5.367360] systemd[1]: Created slice User and Session Slice.</span><br><span class=\"line\">[    5.379321] systemd[1]: Set up automount Arbitrary Executable File Formats File System Automount Point.</span><br><span class=\"line\">[    5.395189] systemd[1]: Started Forward Password Requests to Wall Directory Watch.</span><br><span class=\"line\">[    5.411078] systemd[1]: Reached target Local Encrypted Volumes.</span><br><span class=\"line\">[    5.644759] EXT4-fs (sda1): re-mounted. Opts: (null)</span><br><span class=\"line\">[    5.702603] RPC: Registered named UNIX socket transport module.</span><br><span class=\"line\">[    5.704115] RPC: Registered udp transport module.</span><br><span class=\"line\">[    5.705318] RPC: Registered tcp transport module.</span><br><span class=\"line\">[    5.706573] RPC: Registered tcp NFSv4.1 backchannel transport module.</span><br><span class=\"line\">[    5.825727] Loading iSCSI transport class v2.0-870.</span><br><span class=\"line\">[    5.912079] iscsi: registered transport (tcp)</span><br><span class=\"line\">[    5.942499] systemd-journald[196]: Received request to flush runtime journal from PID 1</span><br><span class=\"line\">[    5.973269] systemd-journald[196]: File &#x2F;var&#x2F;log&#x2F;journal&#x2F;7bc72ce3e0aa559e38159aa4fa0547f9&#x2F;system.journal corrupted or uncleanly shut down, renaming and replacing.</span><br></pre></td></tr></table></figure>\n<p>下面的图表解释了 这些具有特定含义的 target 单元之间的依赖关系 以及各自在启动流程中的位置。图中的箭头表示了单元之间的依赖关系与先后顺序， 整个图表按照自上而下的时间顺序执行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local-fs-pre.target</span><br><span class=\"line\">            |</span><br><span class=\"line\">            v</span><br><span class=\"line\">   (various mounts and   (various swap   (various cryptsetup</span><br><span class=\"line\">    fsck services...)     devices...)        devices...)       (various low-level   (various low-level</span><br><span class=\"line\">            |                  |                  |             services: udevd,     API VFS mounts:</span><br><span class=\"line\">            v                  v                  v             tmpfiles, random     mqueue, configfs,</span><br><span class=\"line\">     local-fs.target      swap.target     cryptsetup.target    seed, sysctl, ...)      debugfs, ...) #主要单元Unti</span><br><span class=\"line\">            |                  |                  |                    |                    |</span><br><span class=\"line\">            \\__________________|_________________ | &#96;_______________&#96; |____________________&#x2F;</span><br><span class=\"line\">                                                 \\|&#x2F;</span><br><span class=\"line\">                                                  v</span><br><span class=\"line\">                                           sysinit.target</span><br><span class=\"line\">                                                  |</span><br><span class=\"line\">             &#96;________________________________&#96; &#x2F;|\\________________________________________</span><br><span class=\"line\">            &#x2F;                  |                  |                    |                    \\</span><br><span class=\"line\">            |                  |                  |                    |                    |</span><br><span class=\"line\">            v                  v                  |                    v                    v</span><br><span class=\"line\">        (various           (various               |                (various          rescue.service</span><br><span class=\"line\">       timers...)          paths...)              |               sockets...)               |</span><br><span class=\"line\">            |                  |                  |                    |                    v</span><br><span class=\"line\">            v                  v                  |                    v             *rescue.target</span><br><span class=\"line\">      timers.target      paths.target             |             sockets.target</span><br><span class=\"line\">            |                  |                  |                    |</span><br><span class=\"line\">            v                  \\_________________ | &#96;_______________&#96; &#x2F;</span><br><span class=\"line\">                                                 \\|&#x2F;</span><br><span class=\"line\">                                                  v</span><br><span class=\"line\">                                            basic.target</span><br><span class=\"line\">                                                  |</span><br><span class=\"line\">             &#96;________________________________&#96; &#x2F;|                                 emergency.service</span><br><span class=\"line\">            &#x2F;                  |                  |                                         |</span><br><span class=\"line\">            |                  |                  |                                         v</span><br><span class=\"line\">            v                  v                  v                                *emergency.target</span><br><span class=\"line\">        display-        (various system    (various system</span><br><span class=\"line\">    manager.service         services           services)</span><br><span class=\"line\">            |             required for            |</span><br><span class=\"line\">            |            graphical UIs)           v</span><br><span class=\"line\">            |                  |          *multi-user.target</span><br><span class=\"line\">            |                  |                  |</span><br><span class=\"line\">            \\_________________ | &#96;_____________&#96; &#x2F;</span><br><span class=\"line\">                              \\|&#x2F;</span><br><span class=\"line\">                               v</span><br><span class=\"line\">                  *graphical.target</span><br></pre></td></tr></table></figure>\n<p>(1) systemd 执行的第一个目标是 <strong>default.target</strong>。但实际上 default.target 是指向 <strong>graphical.target</strong> 的软链接。Graphical.target 的实际位置是<code>/usr/lib/systemd/system/graphical.target</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /usr/lib/systemd/system/graphical.target</span><br><span class=\"line\"><span class=\"comment\">#  This file is part of systemd.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class=\"line\"><span class=\"comment\">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class=\"line\"><span class=\"comment\">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class=\"line\"><span class=\"comment\">#  (at your option) any later version.</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Graphical Interface</span><br><span class=\"line\">Documentation=man:systemd.special(7)</span><br><span class=\"line\">Requires=multi-user.target <span class=\"comment\">#注意依赖</span></span><br><span class=\"line\">Wants=display-manager.service</span><br><span class=\"line\">Conflicts=rescue.service rescue.target</span><br><span class=\"line\">After=multi-user.target rescue.service rescue.target display-manager.service</span><br><span class=\"line\">AllowIsolate=yes</span><br></pre></td></tr></table></figure>\n<p>(2) 在<strong>default.target</strong>这个阶段，会启动<strong>multi-user.target</strong>而这个 target 将自己的子单元放在目录<code>/etc/systemd/system/multi-user.target.wants</code>里。这个 target 为多用户支持设定系统环境。非 root用户会在这个阶段的引导过程中启用。防火墙相关的服务也会在这个阶段启动。<strong>multi-user.target</strong>会将控制权交给另一层<strong>basic.target</strong>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /usr/lib/systemd/system/multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Multi-User System</span><br><span class=\"line\">Documentation=man:systemd.special(7)</span><br><span class=\"line\">Requires=basic.target <span class=\"comment\">#注意依赖</span></span><br><span class=\"line\">Conflicts=rescue.service rescue.target</span><br><span class=\"line\">After=basic.target rescue.service rescue.target</span><br><span class=\"line\">AllowIsolate=yes</span><br></pre></td></tr></table></figure>\n<p>（3）<strong>basic.target</strong>单元用于启动普通服务特别是图形管理服务。它通过<code>/etc/systemd/system/basic.target.wants</code>目录来决定哪些服务会被启动，<strong>basic.target</strong> 之后将控制权交给 <strong>sysinit.target</strong>.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree /etc/systemd/system/multi-user.target.wants</span><br><span class=\"line\">/etc/systemd/system/multi-user.target.wants</span><br><span class=\"line\">├── auditd.service -&gt; /usr/lib/systemd/system/auditd.service</span><br><span class=\"line\">├── chronyd.service -&gt; /usr/lib/systemd/system/chronyd.service</span><br><span class=\"line\">├── crond.service -&gt; /usr/lib/systemd/system/crond.service</span><br><span class=\"line\">├── docker.service -&gt; /usr/lib/systemd/system/docker.service</span><br><span class=\"line\">├── firewalld.service -&gt; /usr/lib/systemd/system/firewalld.service</span><br><span class=\"line\">├── gitlab-runner.service -&gt; /etc/systemd/system/gitlab-runner.service</span><br><span class=\"line\">├── irqbalance.service -&gt; /usr/lib/systemd/system/irqbalance.service</span><br><span class=\"line\">├── kdump.service -&gt; /usr/lib/systemd/system/kdump.service</span><br><span class=\"line\">├── NetworkManager.service -&gt; /usr/lib/systemd/system/NetworkManager.service</span><br><span class=\"line\">├── postfix.service -&gt; /usr/lib/systemd/system/postfix.service</span><br><span class=\"line\">├── remote-fs.target -&gt; /usr/lib/systemd/system/remote-fs.target</span><br><span class=\"line\">├── rhel-configure.service -&gt; /usr/lib/systemd/system/rhel-configure.service</span><br><span class=\"line\">├── rsyslog.service -&gt; /usr/lib/systemd/system/rsyslog.service</span><br><span class=\"line\">├── sshd.service -&gt; /usr/lib/systemd/system/sshd.service</span><br><span class=\"line\">└── tuned.service -&gt; /usr/lib/systemd/system/tuned.service</span><br></pre></td></tr></table></figure>\n<p>(4) <strong>sysinit.target</strong>会启动重要的系统服务例如系统挂载，内存交换空间和设备，内核补充选项等等。sysinit.target 在启动过程中会传递给<strong>local-fs.target</strong>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tree &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;basic.target.wants</span><br><span class=\"line\">&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;basic.target.wants</span><br><span class=\"line\">├── microcode.service -&gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;microcode.service</span><br><span class=\"line\">└── rhel-dmesg.service -&gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;rhel-dmesg.service</span><br></pre></td></tr></table></figure>\n<p>(5) <code>local-fs.target</code>，这个 target 单元不会启动用户相关的服务，它只处理底层核心服务。这个 target 会根据 /etc/fstab 和 /etc/inittab 来执行相关操作。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;sysinit.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description&#x3D;System Initialization</span><br><span class=\"line\">Documentation&#x3D;man:systemd.special(7)</span><br><span class=\"line\">Conflicts&#x3D;emergency.service emergency.target</span><br><span class=\"line\">Wants&#x3D;local-fs.target swap.target</span><br><span class=\"line\">After&#x3D;local-fs.target swap.target emergency.service emergency.target</span><br></pre></td></tr></table></figure>\n<h5 id=\"3-进程树-Process-tree\"><a href=\"#3-进程树-Process-tree\" class=\"headerlink\" title=\"3.进程树(Process tree)\"></a>3.进程树(Process tree)</h5><p>使用 pstree 命令来看一哈进程树的状态，用户空间的进程都挂在 PID 为 1 的 systemd 下，注意该命令不是发行版本内置的需要进行安装 <code>yum install pstree</code>;</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">╭─root@sg-02 ~</span><br><span class=\"line\">╰─# pstree -p</span><br><span class=\"line\">systemd(1)─┬─accounts-daemon(661)─┬─&#123;accounts-daemon&#125;(689)</span><br><span class=\"line\">           │                      └─&#123;accounts-daemon&#125;(729)</span><br><span class=\"line\">           ├─agetty(971)</span><br><span class=\"line\">           ├─agetty(992)</span><br><span class=\"line\">           ├─aria2c(1010)</span><br><span class=\"line\">           ├─atd(653)</span><br><span class=\"line\">           ├─containerd(2915)─┬─&#123;containerd&#125;(2928)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(2929)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(2930)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(2934)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(2935)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(2950)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(2951)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(2978)</span><br><span class=\"line\">           │                  ├─&#123;containerd&#125;(5360)</span><br><span class=\"line\">           │                  └─&#123;containerd&#125;(8299)</span><br><span class=\"line\">           ├─cron(639)───cron(20506)───sh(20507)───monitor.sh(20509)───ffmpeg(20514)</span><br><span class=\"line\">           ├─dbus-daemon(664)</span><br><span class=\"line\">           ├─dockerd(17771)─┬─&#123;dockerd&#125;(17783)</span><br><span class=\"line\">           │                ├─&#123;dockerd&#125;(17784)</span><br><span class=\"line\">           │                ├─&#123;dockerd&#125;(17785)</span><br><span class=\"line\">           │                ├─&#123;dockerd&#125;(17791)</span><br><span class=\"line\">           │                ├─&#123;dockerd&#125;(17793)</span><br><span class=\"line\">           │                ├─&#123;dockerd&#125;(17800)</span><br><span class=\"line\">           │                ├─&#123;dockerd&#125;(17803)</span><br><span class=\"line\">           │                ├─&#123;dockerd&#125;(3030)</span><br><span class=\"line\">           │                └─&#123;dockerd&#125;(3031)</span><br><span class=\"line\">           ├─fail2ban-server(755)─┬─&#123;fail2ban-server&#125;(1059)</span><br><span class=\"line\">           │                      └─&#123;fail2ban-server&#125;(1060)</span><br><span class=\"line\">           ├─iscsid(896)</span><br><span class=\"line\">           ├─iscsid(897)</span><br><span class=\"line\">           ├─lvmetad(392)</span><br><span class=\"line\">           ├─networkd-dispat(622)───&#123;networkd-dispat&#125;(982)</span><br><span class=\"line\">           ├─nginx(3305)───nginx(17700)</span><br><span class=\"line\">           ├─php-fpm7.2(7497)─┬─php-fpm7.2(1295)</span><br><span class=\"line\">           │                  ├─php-fpm7.2(1296)</span><br><span class=\"line\">           │                  └─php-fpm7.2(5611)</span><br><span class=\"line\">           ├─polkitd(808)─┬─&#123;polkitd&#125;(820)</span><br><span class=\"line\">           │              └─&#123;polkitd&#125;(822)</span><br><span class=\"line\">           ├─rngd(981)</span><br><span class=\"line\">           ├─rpcbind(7125)</span><br><span class=\"line\">           ├─rsyslogd(11567)─┬─&#123;rsyslogd&#125;(11598)</span><br><span class=\"line\">           │                 ├─&#123;rsyslogd&#125;(11599)</span><br><span class=\"line\">           │                 └─&#123;rsyslogd&#125;(11600)</span><br><span class=\"line\">           ├─ss-server(17126)───obfs-server(17138)</span><br><span class=\"line\">             ├─sshd(5357)─┬─sshd(15490)───sshd(15598)───zsh(15619)───pstree(20539)</span><br><span class=\"line\">           │            ├─sshd(20413)───sshd(20414)</span><br><span class=\"line\">           │            └─sshd(20517)</span><br><span class=\"line\">           ├─systemd(5715)───(sd-pam)(5718)</span><br><span class=\"line\">           ├─systemd-journal(12866)</span><br><span class=\"line\">           ├─systemd-logind(652)</span><br><span class=\"line\">           ├─systemd-network(12827)</span><br><span class=\"line\">           ├─systemd-resolve(12839)</span><br><span class=\"line\">           ├─systemd-timesyn(12852)───&#123;systemd-timesyn&#125;(12861)</span><br><span class=\"line\">           └─systemd-udevd(8171)</span><br></pre></td></tr></table></figure>\n<h5 id=\"4-运行级别\"><a href=\"#4-运行级别\" class=\"headerlink\" title=\"4.运行级别\"></a>4.运行级别</h5><p>描述: 如今systemd 引入了一个和启动级别(一个旧的概念)功能相似又不同的概念——目标（target）。不像数字表示的启动级别，每一个目标都有名字和独特的功能，而且能同一时候启用多个，一些目标继承其它目标的服务，并启动新服务。</p>\n<table>\n<thead>\n<tr>\n<th>SysV 启动级别</th>\n<th>Systemd 目标</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>runlevel0.target, poweroff.target</td>\n<td>中断系统（halt）</td>\n</tr>\n<tr>\n<td>1, s, single</td>\n<td>runlevel1.target, rescue.target</td>\n<td>单用户模式</td>\n</tr>\n<tr>\n<td>2, 4</td>\n<td>runlevel2.target, runlevel4.target, multi-user.target</td>\n<td>用户自己定义启动级别。通常识别为级别3。</td>\n</tr>\n<tr>\n<td>3</td>\n<td>runlevel3.target, multi-user.target</td>\n<td>多用户，无图形界面。用户能够通过终端或网络登录。</td>\n</tr>\n<tr>\n<td>5</td>\n<td>runlevel5.target, graphical.target</td>\n<td>多用户。图形界面。继承级别3的服务。并启动图形界面服务。</td>\n</tr>\n<tr>\n<td>6</td>\n<td>runlevel6.target, reboot.target</td>\n<td>重新启动</td>\n</tr>\n<tr>\n<td>emergency</td>\n<td>emergency.target</td>\n<td>急救模式（Emergency shell）</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"0x02-Systemd-Manager\"><a href=\"#0x02-Systemd-Manager\" class=\"headerlink\" title=\"0x02 Systemd Manager\"></a>0x02 Systemd Manager</h4><p>控制 systemd 的主要命令主要有以下几种：</p>\n<ul>\n<li>systemctl 命令控制 <code>systemd</code> 的管理系统和服务的命令行工具</li>\n<li>systemsdm 命令控制 <code>systemd</code> 的管理和服务的图形化工具</li>\n<li>journalctl 命令查询<code>systemd</code> 日志系统</li>\n<li>loginctl 命令控制 <code>systemd</code> 登入管理器</li>\n<li>systemd-analyze 分析系统启动效能（类似开机时间)</li>\n</ul>\n<p><br/></p>\n<h5 id=\"1-Systemctl-命令\"><a href=\"#1-Systemctl-命令\" class=\"headerlink\" title=\"1.Systemctl 命令\"></a>1.Systemctl 命令</h5><p>描述:systemctl help &lt;单元&gt; ## 显示单元的手冊页（必须由单元文件提供）：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#unit类型或者单元：</span><br><span class=\"line\">service ：文件扩展名为.service, 用于定义系统服务</span><br><span class=\"line\">target ：文件扩展名为.target，用于模拟实现运行级别</span><br><span class=\"line\">device  ：用于定义内核识别的设备 </span><br><span class=\"line\">mount：定义文件系统挂载点   </span><br><span class=\"line\">socket：用于标识进程间通信用的socket文件，也可在系统启动时，延迟启动服务，实现按需启动   </span><br><span class=\"line\">snapshot ：管理系统快照  </span><br><span class=\"line\">swap：用于标识swap设备   </span><br><span class=\"line\">automount ：文件系统的自动挂载点  </span><br><span class=\"line\">path：用于定义文件系统中的一个文件或目录使用,常用于当文件系统变化时，延迟激活服务</span><br></pre></td></tr></table></figure></p>\n<p>Systemctl 新特性: </p>\n<ul>\n<li>系统引导时实现服务并行启动</li>\n<li>按需启动守护进程</li>\n<li>自动化的服务依赖关系管理</li>\n<li>同时采用socket式与D-Bus总线式激活服务</li>\n<li>系统状态快照</li>\n</ul>\n<p><em>优先级从低到高各自是：</em></p>\n<ul>\n<li>/usr/lib/systemd/system/: 软件包安装的单元  #(Centos) <code>Ubuntu：/lib/systemd/system</code></li>\n<li>/etc/systemd/system/: 系统管理员安装的单元   </li>\n<li>/etc/init.d/ ：软件安装服务单元（#任然有部分软件采用和用户自定义脚本）</li>\n<li>当systemd执行在用户模式下时，使用的载入路径是全然不同的;systemd 单元名仅能包括 ASCII 字符, 下划线和点号. 其它字符须要用 C-style “\\x2d” 替换. 參阅 man systemd.unit 和 man systemd-escape.}}</li>\n</ul>\n<p><strong>参数语法</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#0.启动/重启/停止/重载服务</span></span><br><span class=\"line\">systemctl start NAME</span><br><span class=\"line\">systemctl restart NAME</span><br><span class=\"line\">systemctl stop NAME</span><br><span class=\"line\">systemctl reload NAME</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#1.查看服务状态</span></span><br><span class=\"line\">systemctl status NAME</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.重启守护程序-修改过服务单元配置文件必须执行它（扫描新的或有变动的单元）</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.可以实现对其他机器的远程控制，该功能使用 SSH 连接。</span></span><br><span class=\"line\">systemctl 参数中添加 -H &lt;用户名&gt;@&lt;主机名&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#4.杀死服务</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">kill</span> NAME</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#5.Systemctl配置查看</span></span><br><span class=\"line\">systemctl show</span><br><span class=\"line\"><span class=\"comment\"># Version=219</span></span><br><span class=\"line\"><span class=\"comment\"># Features=+PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 -SECCOMP +BLKID +ELFUTILS +KMOD +IDN</span></span><br><span class=\"line\"><span class=\"comment\"># Virtualization=vmware</span></span><br><span class=\"line\"><span class=\"comment\"># Architecture=x86-64</span></span><br><span class=\"line\"><span class=\"comment\"># FirmwareTimestampMonotonic=0</span></span><br><span class=\"line\"><span class=\"comment\"># LogLevel=info</span></span><br><span class=\"line\"><span class=\"comment\"># LogTarget=journal-or-kmsg</span></span><br><span class=\"line\"><span class=\"comment\"># NNames=259</span></span><br><span class=\"line\"><span class=\"comment\"># NFailedUnits=1</span></span><br><span class=\"line\"><span class=\"comment\"># NJobs=0</span></span><br><span class=\"line\"><span class=\"comment\"># NInstalledJobs=64971823</span></span><br><span class=\"line\"><span class=\"comment\"># NFailedJobs=65792</span></span><br><span class=\"line\"><span class=\"comment\"># Progress=1</span></span><br><span class=\"line\"><span class=\"comment\"># Environment=LANG=zh_CN.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span></span><br><span class=\"line\"><span class=\"comment\"># ConfirmSpawn=no</span></span><br><span class=\"line\"><span class=\"comment\"># ShowStatus=no</span></span><br><span class=\"line\"><span class=\"comment\"># UnitPath=/etc/systemd/system /run/systemd/system /run/systemd/generator /usr/local/lib/systemd/system /usr/lib/systemd/system /run/systemd/generator.late</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultStandardOutput=journal</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultStandardError=journal</span></span><br><span class=\"line\"><span class=\"comment\"># RuntimeWatchdogUSec=0</span></span><br><span class=\"line\"><span class=\"comment\"># ShutdownWatchdogUSec=10min</span></span><br><span class=\"line\"><span class=\"comment\"># SystemState=degraded</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultTimerAccuracyUSec=1min</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultTimeoutStartUSec=1min 30s</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultTimeoutStopUSec=1min 30s</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultRestartUSec=100ms</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultStartLimitInterval=10000000</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultStartLimitBurst=5</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultCPUAccounting=yes</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultBlockIOAccounting=no</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultMemoryAccounting=yes</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultTasksAccounting=yes</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitCPU=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitFSIZE=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitDATA=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitSTACK=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitCORE=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitRSS=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitNOFILE=4096</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitAS=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitNPROC=14991</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitMEMLOCK=65536</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitLOCKS=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitSIGPENDING=14991</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitMSGQUEUE=819200</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitNICE=0</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitRTPRIO=0</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultLimitRTTIME=18446744073709551615</span></span><br><span class=\"line\"><span class=\"comment\"># DefaultTasksMax=18446744073709551615</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>基本用法</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例0.自启与启动等常用命令</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nginx.service</span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> xinetd.service  <span class=\"comment\">#关闭自启动服务</span></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl start nginx.service</span><br><span class=\"line\">systemctl stop  xinetd.service     <span class=\"comment\">#停止服务</span></span><br><span class=\"line\">systemctl restart xinetd.service   <span class=\"comment\">#重启服务</span></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl status firewalld          <span class=\"comment\">#查看状态</span></span><br><span class=\"line\">systemctl status cobbler.service</span><br><span class=\"line\"><span class=\"comment\"># ● cobbler.service - SYSV: cobbler</span></span><br><span class=\"line\"><span class=\"comment\">#    Loaded: loaded (/etc/rc.d/init.d/cobbler; bad; vendor preset: disabled)</span></span><br><span class=\"line\"><span class=\"comment\">#    Active: inactive (dead)</span></span><br><span class=\"line\"><span class=\"comment\">#      Docs: man:systemd-sysv-generator(8)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例1.显示当前已加载到内存中的所有单元(Active)</span></span><br><span class=\"line\">systemctl list-units --all</span><br><span class=\"line\"><span class=\"comment\">#UNIT                                                                LOAD      ACTIVE   SUB       DESCRIPTION</span></span><br><span class=\"line\"><span class=\"comment\">#proc-sys-fs-binfmt_misc.automount                                   loaded    active   running   Arbitrary Executable File Formats File System Automount Point</span></span><br><span class=\"line\"><span class=\"comment\">#dev-block-8:2.device                                                loaded    active   plugged   LVM PV dKOf4k-3rna-sW69-3GHn-79gA-cfLX-DbC5oJ on /dev/sda2 2</span></span><br><span class=\"line\">systemctl list-units --<span class=\"built_in\">type</span>=target  <span class=\"comment\">#获取指定单元目标</span></span><br><span class=\"line\">UNIT                  LOAD   ACTIVE SUB    DESCRIPTION</span><br><span class=\"line\">basic.target          loaded active active Basic System</span><br><span class=\"line\">cryptsetup.target     loaded active active Local Encrypted Volumes</span><br><span class=\"line\"></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#示例2.查看和编辑该软件的 systemd 单元文件信息</span></span><br><span class=\"line\">systemctl cat docker</span><br><span class=\"line\"><span class=\"comment\"># /usr/lib/systemd/system/docker.service</span></span><br><span class=\"line\"><span class=\"comment\"># [Unit]</span></span><br><span class=\"line\"><span class=\"comment\"># Description=Docker Application Container Engine</span></span><br><span class=\"line\"><span class=\"comment\"># Documentation=https://docs.docker.com</span></span><br><span class=\"line\"><span class=\"comment\"># BindsTo=containerd.service</span></span><br><span class=\"line\"><span class=\"comment\"># After=network-online.target firewalld.service containerd.service</span></span><br><span class=\"line\"><span class=\"comment\"># Wants=network-online.target</span></span><br><span class=\"line\"><span class=\"comment\"># Requires=docker.socket</span></span><br><span class=\"line\">systemctl edit docker.service  <span class=\"comment\">#设置编辑覆盖规则</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例3.查看服务是否开机启动,服务是否激活</span></span><br><span class=\"line\"><span class=\"variable\">$systemctl</span> is-enabled firewalld.service</span><br><span class=\"line\"><span class=\"comment\"># disabled</span></span><br><span class=\"line\">systemctl is-enabled sshd.service</span><br><span class=\"line\"><span class=\"comment\"># enabled</span></span><br><span class=\"line\">systemctl is-active sshd</span><br><span class=\"line\"><span class=\"comment\"># active</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例4.列出 systemd 目录下面的服务单元</span></span><br><span class=\"line\">systemctl list-unit-files</span><br><span class=\"line\">systemctl list-unit-files | grep mysqld  <span class=\"comment\">#查看mysqld服务是不是启动</span></span><br><span class=\"line\">systemctl list-unit-files | grep enabled  <span class=\"comment\">#查看已启动的服务列表</span></span><br><span class=\"line\"><span class=\"comment\"># auditd.service                                enabled</span></span><br><span class=\"line\"><span class=\"comment\"># autovt@.service                               enabled</span></span><br><span class=\"line\"><span class=\"comment\"># chronyd.service                               enabled</span></span><br><span class=\"line\"><span class=\"comment\"># crond.service                                 enabled</span></span><br><span class=\"line\">systemctl list-unit-files --failed <span class=\"comment\">#查看启动失败的服务列表</span></span><br><span class=\"line\"><span class=\"comment\"># UNIT FILE STATE</span></span><br><span class=\"line\"><span class=\"comment\"># 0 unit files listed.</span></span><br><span class=\"line\"><span class=\"comment\"># 查看系统开机启动项</span></span><br><span class=\"line\">systemctl list-unit-files --<span class=\"built_in\">type</span>=service | grep enabled</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例5.欲查看对特定 target 启用的服务请执行 </span></span><br><span class=\"line\">systemctl list-dependencies</span><br><span class=\"line\">systemctl list-dependencies [target]</span><br><span class=\"line\">systemctl list-dependencies microcode.service</span><br><span class=\"line\"><span class=\"comment\"># microcode.service</span></span><br><span class=\"line\"><span class=\"comment\"># ● ├─system.slice</span></span><br><span class=\"line\"><span class=\"comment\"># ● └─basic.target</span></span><br><span class=\"line\"><span class=\"comment\">#   │ └─...</span></span><br><span class=\"line\"><span class=\"comment\">#注意：该输出结果只显示 SysV 服务，并不包含原生 systemd 服务，SysV 配置数据可能被原生 systemd 配置覆盖。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例6.切换并查看启动级别/目标</span></span><br><span class=\"line\"><span class=\"variable\">$systemctl</span> <span class=\"built_in\">set</span>-default multi-user.target</span><br><span class=\"line\">rm <span class=\"string\">'/etc/systemd/system/default.target'</span></span><br><span class=\"line\">ln -s <span class=\"string\">'/usr/lib/systemd/system/multi-user.target'</span> <span class=\"string\">'/etc/systemd/system/default.target'</span></span><br><span class=\"line\"><span class=\"comment\">#能够在 systemctl 的输出中看到命令执行的效果：链接 /etc/systemd/system/default.target 被创建。指向新的默认启动级别。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$systemctl</span> isolate graphical.target  <span class=\"comment\">#等价于telinit 3 或 telinit 5。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$systemctl</span> get-default</span><br><span class=\"line\">graphical.target <span class=\"comment\">#当前为 graphical.target 修改为命令模式multi-user.target：</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例7.查看unit中的类型</span></span><br><span class=\"line\">systemctl -t service</span><br><span class=\"line\"><span class=\"comment\"># UNIT                               LOAD   ACTIVE SUB     DESCRIPTION</span></span><br><span class=\"line\"><span class=\"comment\"># auditd.service                     loaded active running Security Auditing Service</span></span><br><span class=\"line\">systemctl --<span class=\"built_in\">type</span> target</span><br><span class=\"line\"><span class=\"comment\"># UNIT                  LOAD   ACTIVE SUB    DESCRIPTION</span></span><br><span class=\"line\"><span class=\"comment\"># basic.target          loaded active active Basic System</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例8.禁用和取消禁用单元</span></span><br><span class=\"line\"><span class=\"comment\"># 禁用一个单元(禁用后，间接启动也是不可能的)：</span></span><br><span class=\"line\">systemctl mask &lt;单元&gt;</span><br><span class=\"line\"><span class=\"comment\"># 取消禁用一个单元：</span></span><br><span class=\"line\">systemctl unmask &lt;单元&gt;</span><br><span class=\"line\">systemctl unmask containerd</span><br><span class=\"line\">  <span class=\"comment\"># Removed /etc/systemd/system/containerd.service.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例9.电源管理</span></span><br><span class=\"line\"><span class=\"comment\">#安装 polkit 后才干够一般用户身份使用电源管理。</span></span><br><span class=\"line\"><span class=\"comment\">#假设你正登录在一个本地的systemd-logind用户会话。且当前没有其它活动的会话。那么下面命令无需root权限就可以执行。否则（比如当前有还有一个用户登录在某个tty），systemd 将会自己主动请求输入rootpassword。</span></span><br><span class=\"line\">$ systemctl reboot  <span class=\"comment\">#重新启动</span></span><br><span class=\"line\">$ systemctl poweroff  <span class=\"comment\">#退出系统并停止电源</span></span><br><span class=\"line\">$ systemctl <span class=\"built_in\">suspend</span>  <span class=\"comment\">#待机</span></span><br><span class=\"line\">$ systemctl hibernate  <span class=\"comment\">#休眠</span></span><br><span class=\"line\">$ systemctl hybrid-sleep <span class=\"comment\">#混合休眠模式（同一时候休眠到硬盘并待机）：</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例10.远程控制其他服务器的 systemd</span></span><br><span class=\"line\">systemctl status nginx -H root@weiyigeek.top</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h5 id=\"2-Journal-命令\"><a href=\"#2-Journal-命令\" class=\"headerlink\" title=\"2.Journal 命令\"></a>2.Journal 命令</h5><p>描述：作为最具吸引力的优势，systemd拥有强大的处理与系统日志记录功能。在使用其它工具时，日志往往被分散在整套系统当中，由不同的守护进程及进程负责处理，这意味着我们很难跨越多种应用程序对其内容进行解读。</p>\n<p>systemd 的第二个主要部分是 journal 日志系统，类似于 syslog 但也有些显著区别。</p>\n<p>Tips : 如果你喜欢用 <code>sed 、grep 、awk</code> 三剑客来处理日志，那么当你面对 journal 日志系统的时候你就准备掀桌儿吧！因为这是个二进制日志，无法使用常规的命令行文本处理工具来解析它</p>\n<p><strong>Systemd Journal 的优点如下：</strong></p>\n<ul>\n<li>简单性：代码少，依赖少，抽象开销最小。</li>\n<li>零维护：日志是除错和监控系统的核心功能，因此它自己不能再产生问题。举例说，自动管理磁盘空间，避免由于日志的不断产生而将磁盘空间耗尽。</li>\n<li>移植性：日志 文件应该在所有类型的 Linux 系统上可用，无论它使用的何种 CPU 或者字节序。</li>\n<li>性能：添加和浏览 日志 非常快。</li>\n<li>最小资源占用：日志 数据文件需要较小。</li>\n<li>统一化：各种不同的日志存储技术应该统一起来，将所有的可记录事件保存在同一个数据存储中。所以日志内容的全局上下文都会被保存并且可供日后查询。例如一条固件记录后通常会跟随一条内核记录，最终还会有一条用户态记录。重要的是当保存到硬盘上时这三者之间的关系不会丢失。Syslog 将不同的信息保存到不同的文件中，分析的时候很难确定哪些条目是相关的。</li>\n<li>扩展性：日志的适用范围很广，从嵌入式设备到超级计算机集群都可以满足需求。</li>\n<li>安全性：日志 文件是可以验证的，让无法检测的修改不再可能。</li>\n</ul>\n<p><strong>日志的优先级和分类</strong></p>\n<p>系统日记按(优先级Priority level)和(设施Facility)对信息进行分类。日志分类对应于经典的Syslog协议（RFC 5424）。<br><em>注：下面表格最后一列 (wc -l) 是统计的记录数比例，总数是3个月的日志，大约100万条数据。</em></p>\n<p>（1）优先级：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420212341.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>（2）设施分类：</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420212505.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><strong>journalctl 命令帮助</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">journalctl -h \t  \t </span><br><span class=\"line\"><span class=\"comment\">#Options: \t  \t </span></span><br><span class=\"line\">--system \tShow the system journal \t显示系统日志</span><br><span class=\"line\">--user \tShow the user journal <span class=\"keyword\">for</span> the current user \t显示当前用户的用户日志</span><br><span class=\"line\"></span><br><span class=\"line\">-M \t--machine=CONTAINER \tOperate on <span class=\"built_in\">local</span> container \t在本地容器上操作</span><br><span class=\"line\">-S \t--since=DATE \tShow entries not older than the specified date \t显示不早于指定日期的条目</span><br><span class=\"line\">-U \t--until=DATE \tShow entries not newer than the specified date \t显示不晚于指定日期的条目</span><br><span class=\"line\">-c \t--cursor=CURSOR \tShow entries starting at the specified cursor \t显示从指定光标开始的条目</span><br><span class=\"line\">  \t--after-cursor=CURSOR \tShow entries after the specified cursor \t在指定的光标后显示条目</span><br><span class=\"line\">  \t--show-cursor \tPrint the cursor after all the entries \t在所有条目之后打印光标</span><br><span class=\"line\">  \t--cursor-file=FILE \tShow entries after cursor <span class=\"keyword\">in</span> FILE and update FILE \t在FILE中显示光标后的条目并更新FILE</span><br><span class=\"line\">-b \t--boot[=ID] \tShow current boot or the specified boot \t显示当前引导或指定的引导</span><br><span class=\"line\">  \t--list-boots \tShow terse information about recorded boots \t显示有关录制的靴子的简洁信息</span><br><span class=\"line\">-k \t--dmesg \tShow kernel message <span class=\"built_in\">log</span> from the current boot \t显示当前引导的内核消息日志</span><br><span class=\"line\">-u \t--unit=UNIT \tShow logs from the specified unit \t显示指定单位的日志</span><br><span class=\"line\">  \t--user-unit=UNIT \tShow logs from the specified user unit \t显示指定用户单元的日志</span><br><span class=\"line\">-t \t--identifier=STRING \tShow entries with the specified syslog identifier \t显示具有指定syslog标识符的条目</span><br><span class=\"line\">-p \t--priority=RANGE \tShow entries with the specified priority \t显示具有指定优先级的条目</span><br><span class=\"line\">-g \t--grep=PATTERN \tShow entries with MESSAGE matching PATTERN \t显示MESSAGE匹配PATTERN的条目</span><br><span class=\"line\">  \t--<span class=\"keyword\">case</span>-sensitive[=BOOL] \tForce <span class=\"keyword\">case</span> sensitive or insenstive matching \t强制区分大小写或不区分匹配</span><br><span class=\"line\">-e \t--pager-end \tImmediately jump to the end <span class=\"keyword\">in</span> the pager \t立即跳到寻呼机的末尾</span><br><span class=\"line\">-f \t--follow \tFollow the journal \t关注期刊, 最新的</span><br><span class=\"line\">-n \t--lines[=INTEGER] \tNumber of journal entries to show \t要显示的日记帐分录数</span><br><span class=\"line\">  \t--no-tail \tShow all lines, even <span class=\"keyword\">in</span> follow mode \t即使在跟随模式下也显示所有行</span><br><span class=\"line\">-r \t--reverse \tShow the newest entries first \t首先显示最新的条目</span><br><span class=\"line\">-o \t--output=STRING \tChange journal output mode (short, short-precise, short-iso, short-iso-precise, short-full, short-monotonic, short-unix, (precise精确,monotonic单调) \t更改日志输出模式: verbose, <span class=\"built_in\">export</span>, </span><br><span class=\"line\">json, json-pretty, json-sse, json-seq, </span><br><span class=\"line\">cat, with-unit)</span><br><span class=\"line\">  \t--output-fields=LIST \tSelect fields to <span class=\"built_in\">print</span> <span class=\"keyword\">in</span> verbose/<span class=\"built_in\">export</span>/json modes \t选择要以详细/导出/ json模式打印的字段</span><br><span class=\"line\">  \t--utc \tExpress time <span class=\"keyword\">in</span> Coordinated Universal Time (UTC) \t协调世界时（UTC）的快车时间</span><br><span class=\"line\">-x \t--catalog \tAdd message explanations <span class=\"built_in\">where</span> available \t添加消息说明（如果有）</span><br><span class=\"line\">  \t--no-full \tEllipsize fields \tEllipsize字段</span><br><span class=\"line\">-a \t--all \tShow all fields, including long and unprintable \t显示所有字段,包括长字段和不可打印字段</span><br><span class=\"line\">-q \t--quiet \tDo not show info messages and privilege warning \t不显示信息消息和权限警告</span><br><span class=\"line\">  \t--no-pager \tDo not pipe output into a pager \t不要将输出传输到寻呼机</span><br><span class=\"line\">  \t--no-hostname \tSuppress output of hostname field \t禁止输出主机名字段</span><br><span class=\"line\">-m \t--merge \tShow entries from all available journals \t显示所有可用期刊的条目</span><br><span class=\"line\">-D \t--directory=PATH \tShow journal files from directory \t显示目录中的日志文件</span><br><span class=\"line\">  \t--file=PATH \tShow journal file \t显示日志文件</span><br><span class=\"line\">  \t--root=ROOT \tOperate on files below a root directory \t对根目录下的文件进行操作</span><br><span class=\"line\">  \t--interval=TIME \tTime interval <span class=\"keyword\">for</span> changing the FSS sealing key \t更改FSS密封键的时间间隔</span><br><span class=\"line\">  \t--verify-key=KEY \tSpecify FSS verification key \t指定FSS验证密钥</span><br><span class=\"line\">  \t--force \tOverride of the FSS key pair with --setup-keys \t使用--setup-keys覆盖FSS密钥对</span><br><span class=\"line\">  \t  \t  \t </span><br><span class=\"line\">  \tCommands: \t  \t </span><br><span class=\"line\">-h \t--<span class=\"built_in\">help</span> \tShow this <span class=\"built_in\">help</span> text \t显示此帮助文本</span><br><span class=\"line\">  \t--version \tShow package version \t显示包版本</span><br><span class=\"line\">-N \t--fields \tList all field names currently used \t列出当前使用的所有字段名称</span><br><span class=\"line\">-F \t--field=FIELD \tList all values that a specified field takes \t列出指定字段所需的所有值</span><br><span class=\"line\">  \t--disk-usage \tShow total disk usage of all journal files \t显示所有日志文件的总磁盘使用情况</span><br><span class=\"line\">  \t--vacuum-size=BYTES \tReduce disk usage below specified size \t将磁盘使用量降低到指定大小以下</span><br><span class=\"line\">  \t--vacuum-files=INT \tLeave only the specified number of journal files \t只保留指定数量的日志文件</span><br><span class=\"line\">  \t--vacuum-time=TIME \tRemove journal files older than specified time \t删除早于指定时间的日志文件</span><br><span class=\"line\">  \t--verify \tVerify journal file consistency \t验证日志文件一致性</span><br><span class=\"line\">  \t--sync \tSynchronize unwritten journal messages to disk \t将未写入的日志消息同步到磁盘</span><br><span class=\"line\">  \t--flush \tFlush all journal data from /run into /var \t将/ run中的所有日志数据刷新到/var</span><br><span class=\"line\">  \t--rotate \tRequest immediate rotation of the journal files \t请求立即轮换日志文件</span><br><span class=\"line\">  \t--header \tShow journal header information \t显示日记标题信息</span><br><span class=\"line\">  \t--list-catalog \tShow all message IDs <span class=\"keyword\">in</span> the catalog \t显示目录中的所有消息ID</span><br><span class=\"line\">  \t--dump-catalog \tShow entries <span class=\"keyword\">in</span> the message catalog \t在消息目录中显示条目</span><br><span class=\"line\">  \t--update-catalog \tUpdate the message catalog database \t更新消息目录数据库</span><br><span class=\"line\">  \t--setup-keys \tGenerate a new FSS key pair \t生成新的FSS密钥对</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>实际案例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#实例1.显示系统 bootloader 启动信息</span></span><br><span class=\"line\">$ sudo journalctl -b           <span class=\"comment\">#启动信息23565</span></span><br><span class=\"line\">$ sudo journalctl -b -0     </span><br><span class=\"line\">$ sudo journalctl -b -1        <span class=\"comment\">#前一次启动信息... 通过查询引导列表可看到最多能查看前几次启动信息</span></span><br><span class=\"line\">$ sudo journalctl --list-boots <span class=\"comment\">#引导列表</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例2.显示不早于指定日期的条目何特定区间的数据(利用--since与--until选项设定时间段)。</span></span><br><span class=\"line\">$ sudo journalctl --since=<span class=\"string\">\"2019-06-13 16:42:34\"</span></span><br><span class=\"line\">$ sudo journalctl --since <span class=\"string\">\"20 min ago\"</span>  <span class=\"comment\">#Show all messages since 20 minutes ago: 最近20分钟</span></span><br><span class=\"line\">$ sudo journalctl -S <span class=\"string\">\"20 min ago\"</span></span><br><span class=\"line\">$ journalctl --since <span class=\"string\">\"2015-01-10\"</span> --until <span class=\"string\">\"2015-01-11 03:00\"</span></span><br><span class=\"line\">$ journalctl --since 09:00 --until <span class=\"string\">\"1 hour ago\"</span> <span class=\"comment\"># 获得早9：00到一小时前这段时间内的报告</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例3.持续显示最新新消息默认10条</span></span><br><span class=\"line\">$ sudo journalctl -f</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例4.显示特定可执行文件的信息(按组件路径)</span></span><br><span class=\"line\">$ sudo journalctl /usr/lib/systemd/systemd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例5.显示特定进程PID的日志信息，以及用户或者群组ID</span></span><br><span class=\"line\">$ sudo journalctl _PID=1</span><br><span class=\"line\">$ sudo journalctl _UID=33 --since today</span><br><span class=\"line\">$ sudo journalctl -F _GID  <span class=\"comment\"># 查看systemd journal拥有条目的群组ID</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例6.显示特定单元日志信息</span></span><br><span class=\"line\">$ sudo journalctl -u man-db.service</span><br><span class=\"line\">journalctl -u nginx.service -u php-fpm.service --since today</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例7.显示当前引导的内核消息日志(--dmesg)</span></span><br><span class=\"line\">$ sudo journalctl -k</span><br><span class=\"line\">$ sudo journalctl -k -b -5  <span class=\"comment\"># 查询五次之前引导环境的信息</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例8.-p 显示具有指定优先级的条目(0-7)</span></span><br><span class=\"line\"><span class=\"comment\"># 0: emerg</span></span><br><span class=\"line\"><span class=\"comment\"># 1: alert</span></span><br><span class=\"line\"><span class=\"comment\"># 2: crit</span></span><br><span class=\"line\"><span class=\"comment\"># 3: err</span></span><br><span class=\"line\"><span class=\"comment\"># 4: warning</span></span><br><span class=\"line\"><span class=\"comment\"># 5: notice</span></span><br><span class=\"line\"><span class=\"comment\"># 6: info</span></span><br><span class=\"line\"><span class=\"comment\"># 7: debug</span></span><br><span class=\"line\"><span class=\"comment\"># 以上为可在-p选项中使用的数字或者名称。</span></span><br><span class=\"line\">$ sudo journalctl -p err..alert</span><br><span class=\"line\">$ sudo journalctl -p 3..1   //3-1</span><br><span class=\"line\">$ sudo journalctl -p 3       //3-0</span><br><span class=\"line\">$ sudo journalctl -p 3 -r    //3-0; 加-r选项,首先显示最新的条目</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例9.通过在syslog工具上进行过滤来显示等效的auth.log(内核相关信息)</span></span><br><span class=\"line\">$ sudo journalctl SYSLOG_FACILITY=10</span><br><span class=\"line\"><span class=\"comment\"># 0 kern 内核；</span></span><br><span class=\"line\"><span class=\"comment\"># 1 user 用户；</span></span><br><span class=\"line\"><span class=\"comment\"># 3 daemon 守护进程；</span></span><br><span class=\"line\"><span class=\"comment\"># 4 auth 授权；</span></span><br><span class=\"line\"><span class=\"comment\"># 10 authpriv 授权；</span></span><br><span class=\"line\">$ sudo journalctl SYSLOG_FACILITY=0 -r</span><br><span class=\"line\">$ sudo journalctl -k -r</span><br><span class=\"line\">$ sudo journalctl SYSLOG_FACILITY=4 |wc -l</span><br><span class=\"line\"><span class=\"comment\">#14516</span></span><br><span class=\"line\">$ sudo journalctl SYSLOG_FACILITY=10 |wc -l</span><br><span class=\"line\"><span class=\"comment\">#9049</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例10.如果日志目录(默认位于/var/log/journal下)包含大量日志数据，那么journalctl可能需要几分钟来过滤输出。</span></span><br><span class=\"line\"><span class=\"comment\">#它可以通过使用——file选项来强制journalctl只查看最近的日志，从而显著加快速度:</span></span><br><span class=\"line\">$ sudo journalctl --file /var/<span class=\"built_in\">log</span>/journal/*/system.journal -f</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例11.手动清理日志文件删除已归档的日志文件</span></span><br><span class=\"line\">$ sudo journalctl --vacuum-size=100M <span class=\"comment\">#直到它们使用的磁盘空间低于100M：</span></span><br><span class=\"line\">$ sudo journalctl --vacuum-time=2weeks <span class=\"comment\">#使所有日记文件不包含超过2周的数据。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#实例12.查看 kubelet 服务的相关日志</span></span><br><span class=\"line\">journalctl -xeu kubelet</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例13.以UTC显示时间戳</span></span><br><span class=\"line\">journalctl --utc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例14.查看Journald中已经记录的引导信息</span></span><br><span class=\"line\">journalctl --list-boots</span><br><span class=\"line\">-1 13883d180dc0420db0abcb5fa26d6198 Tue 2015-02-03 22:17:03 UTC—Tue 2015-02-03 22:19:08 UTC</span><br><span class=\"line\"> 0 bed718b17a73415fade0e4e7f4bea609 Tue 2015-02-03 22:19:12 UTC—Tue 2015-02-03 23:01:01 UTC</span><br><span class=\"line\">  <span class=\"comment\"># 例如，要查看上次引导的journal记录，则可使用-1相对指针配合-b标记： journalctl -b -1</span></span><br><span class=\"line\">  <span class=\"comment\"># journalctl -b caf0524a1d394ce0bdbcff75b94444fe</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例15.截断或者扩大输出结果，在默认情况下journalctl会在pager内显示各条目，并通过右箭头键访问其信息</span></span><br><span class=\"line\">journalctl --no-full</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例16.本操作工具对数据进行处理则可能需要使用标准格式</span></span><br><span class=\"line\">journalclt --no-pager  <span class=\"comment\"># 标准输出结果</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例17.输出格式(特定)</span></span><br><span class=\"line\">  <span class=\"comment\"># cat: 只显示信息字段本身。</span></span><br><span class=\"line\">  <span class=\"comment\"># export: 适合传输或备份的二进制格式。</span></span><br><span class=\"line\">  <span class=\"comment\"># json: 标准JSON，每行一个条目。</span></span><br><span class=\"line\">  <span class=\"comment\"># json-pretty: JSON格式，适合人类阅读习惯。</span></span><br><span class=\"line\">  <span class=\"comment\"># json-sse: JSON格式，经过打包以兼容server-sent事件。</span></span><br><span class=\"line\">  <span class=\"comment\"># short: 默认syslog类输出格式。</span></span><br><span class=\"line\">  <span class=\"comment\"># short-iso: 默认格式，强调显示ISO 8601挂钟时间戳。</span></span><br><span class=\"line\">  <span class=\"comment\"># short-monotonic: 默认格式，提供普通时间戳。</span></span><br><span class=\"line\">  <span class=\"comment\"># short-precise: 默认格式，提供微秒级精度。</span></span><br><span class=\"line\">  <span class=\"comment\"># verbose: 显示该条目的全部可用journal字段，包括通常被内部隐藏的字段。</span></span><br><span class=\"line\">  <span class=\"comment\"># 上述选项允许大家以最适合需求的格式显示journal条目。</span></span><br><span class=\"line\">journalctl -b -u nginx -o json</span><br><span class=\"line\">journalctl -b -u nginx -o json-pretty</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例17.查看近期日志指定条数。</span></span><br><span class=\"line\">journalctl -n 20 <span class=\"comment\"># 同样为tail -n 20</span></span><br><span class=\"line\">journalctl -f    <span class=\"comment\"># 同样为tail -f</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例18.Journal维护清理部分陈旧日志以释放存储空间。</span></span><br><span class=\"line\">journalctl --disk-usage</span><br><span class=\"line\">  <span class=\"comment\"># Journals take up 8.0M on disk.</span></span><br><span class=\"line\"><span class=\"comment\"># –vacuum-size选项: 其会不断删除旧有记录直到所占容量符合要求</span></span><br><span class=\"line\">sudo journalctl --vacuum-size=1G</span><br><span class=\"line\"><span class=\"comment\"># –vacuum-time选项：任何早于这一时间点的条目都将被删除 (去年之后的条目才能保留)</span></span><br><span class=\"line\">sudo journalctl --vacuum-time=1years</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例19.持续查看指定服务程序的信息。</span></span><br><span class=\"line\">journalctl -xefu kubelet</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启</span></span><br><span class=\"line\">systemctl restart journald</span><br></pre></td></tr></table></figure></p>\n<p><strong>配置文件设置:</strong></p>\n<p><em>(1) 日志大小限制设置</em><br>默认为基础文件系统的10%，但上限为4GB。<br>例如本机/var/log/journal/位于30Gb分区上，日志最多需要3Gb。超过40Gb的分区，日志文件需要最大值都为4Gb。</p>\n<p>可以通过取消注释和更改以下内容来控制持久日志的最大大小：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/systemd/journald.conf</span><br><span class=\"line\">SystemMaxUse=50M</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#也可以使用drop-in snippets配置覆盖机制，而不是编辑全局配置文件。在这种情况下，将覆盖置于[Journal]标题下：</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/systemd/journald.conf.d/00-journal-size.conf</span><br><span class=\"line\">[Journal]</span><br><span class=\"line\">SystemMaxUse=50M</span><br></pre></td></tr></table></figure><br>修改后重新启动日志系统 <code>systemd-journald.service</code> 即 systemctl restart systemd-journald.service;</p>\n<p><br/></p>\n<p><em>(2) 过往引导记录持久化</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.当Storage=auto选项时创建以下目录进行日志的持久化。</span></span><br><span class=\"line\">sudo mkdir -p /var/<span class=\"built_in\">log</span>/journal</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2:在[Journal]区段下将Storage=选项设定为“persistent”以启用持久记录：</span></span><br><span class=\"line\">vim /etc/systemd/journald.conf</span><br><span class=\"line\">Storage=persistent</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><em>(3) 限定Journal扩展</em><br>大家可以配置自己的服务器以限定journal所能占用的最高容量。要实现这一点，我们需要编辑/etc/systemd/journald.conf文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">以下条目可用于限定journal体积的膨胀速度：</span><br><span class=\"line\"></span><br><span class=\"line\">SystemMaxUse=: 指定journal所能使用的最高持久存储容量。</span><br><span class=\"line\">SystemKeepFree=: 指定journal在添加新条目时需要保留的剩余空间。</span><br><span class=\"line\">SystemMaxFileSize=: 控制单一journal文件大小，符合要求方可被转为持久存储。</span><br><span class=\"line\">RuntimeMaxUse=: 指定易失性存储中的最大可用磁盘容量（/run文件系统之内）。</span><br><span class=\"line\">RuntimeKeepFree=: 指定向易失性存储内写入数据时为其它应用保留的空间量（/run文件系统之内）。</span><br><span class=\"line\">RuntimeMaxFileSize=: 指定单一journal文件可占用的最大易失性存储容量（/run文件系统之内）。</span><br><span class=\"line\"></span><br><span class=\"line\">通过设置上述值，大家可以控制journald对服务器空间的消耗及保留方式。</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><em>(4) journald日志被打满设置</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/systemd/journald.conf</span><br><span class=\"line\">RateLimitInterval=30s</span><br><span class=\"line\">RateLimitBurst=100000</span><br></pre></td></tr></table></figure></p>\n<p>Tips : JSON(JavaScript Object Notation)是一种轻量级的数据交换格式。易于人阅读和编写。同时也易于机器解析和生成。它基于JavaScriptProgramming Language, Standard ECMA-262 3rd Edition - December 1999的一个子集。JSON采用完全独立于语言的文本格式，但是也使用了类似于C语言家族的习惯（包括C, C++, C#, Java,JavaScript, Perl, Python等）。这些特性使JSON成为理想的数据交换语言。</p>\n<p>JSON建构于两种结构：</p>\n<ul>\n<li>“名称/值”对的集合（A collection ofname/value pairs）：不同的语言中，它被理解为对象（object），纪录（record），结构（struct），字典（dictionary），哈希表（hash table），有键列表（keyed list），或者关联数组（associativearray）。</li>\n<li>值的有序列表（An ordered list of values）：在大部分语言中，它被理解为数组（array）。</li>\n</ul>\n<p>这些都是常见的数据结构。事实上大部分现代计算机语言都以某种形式支持它们,这使得一种数据格式在同样基于这些结构的编程语言之间交换成为可能。</p>\n<p>总结到这里<code>systemd journal</code>对系统及应用数据的收集与管理机制就介绍完毕了。其出色的灵活性源自将广泛的元数据自动记录至集中化日志之内。另外 <code>journalctl</code> 命令 则显著简化了journal的使用方式，从而让更多管理员得以利用它完成面向不同应用组件的分析与相关调试工作。 </p>\n<p><br></p>\n<h5 id=\"3-Systemd-analyze-命令\"><a href=\"#3-Systemd-analyze-命令\" class=\"headerlink\" title=\"3.Systemd-analyze 命令\"></a>3.Systemd-analyze 命令</h5><p>描述: 配置文件systemd，显示单元依赖关系，并检查单元文件。</p>\n<p><strong>语法参数:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Usage:</span><br><span class=\"line\">  systemd-analyze [OPTIONS...] COMMAND ...</span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  [time]                   打印启动机器所需的时间</span><br><span class=\"line\">  blame                    打印按耗时排序的运行服务service列表</span><br><span class=\"line\">  critical-chain [UNIT...] 打印时间关键单位链的树</span><br><span class=\"line\">  plot                     Output SVG graphic showing service initialization</span><br><span class=\"line\">  dot [UNIT...]            Output dependency graph <span class=\"keyword\">in</span> dot(1) format</span><br><span class=\"line\">  dump                     Output state serialization of service manager</span><br><span class=\"line\">  cat-config               Show configuration file and drop-ins</span><br><span class=\"line\">  unit-files               List files and symlinks <span class=\"keyword\">for</span> units</span><br><span class=\"line\">  unit-paths               List load directories <span class=\"keyword\">for</span> units</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>-status [STATUS...]  List <span class=\"built_in\">exit</span> status definitions</span><br><span class=\"line\">  capability [CAP...]      List capability definitions</span><br><span class=\"line\">  syscall-filter [NAME...] Print list of syscalls <span class=\"keyword\">in</span> seccomp filter</span><br><span class=\"line\">  condition CONDITION...   Evaluate conditions and asserts</span><br><span class=\"line\">  verify FILE...           Check unit files <span class=\"keyword\">for</span> correctness</span><br><span class=\"line\">  calendar SPEC...         Validate repetitive calendar time events</span><br><span class=\"line\">  timestamp TIMESTAMP...   Validate a timestamp</span><br><span class=\"line\">  timespan SPAN...         Validate a time span</span><br><span class=\"line\">  security [UNIT...]       Analyze security of unit</span><br><span class=\"line\"></span><br><span class=\"line\">Options:</span><br><span class=\"line\">  -h --<span class=\"built_in\">help</span>                Show this <span class=\"built_in\">help</span></span><br><span class=\"line\">     --version             Show package version</span><br><span class=\"line\">     --no-pager            Do not pipe output into a pager</span><br><span class=\"line\">     --system              Operate on system systemd instance</span><br><span class=\"line\">     --user                Operate on user systemd instance</span><br><span class=\"line\">     --global              Operate on global user configuration</span><br><span class=\"line\">  -H --host=[USER@]HOST    Operate on remote host</span><br><span class=\"line\">  -M --machine=CONTAINER   Operate on <span class=\"built_in\">local</span> container</span><br><span class=\"line\">     --order               Show only order <span class=\"keyword\">in</span> the graph</span><br><span class=\"line\">     --require             Show only requirement <span class=\"keyword\">in</span> the graph</span><br><span class=\"line\">     --from-pattern=GLOB   Show only origins <span class=\"keyword\">in</span> the graph</span><br><span class=\"line\">     --to-pattern=GLOB     Show only destinations <span class=\"keyword\">in</span> the graph</span><br><span class=\"line\">     --fuzz=SECONDS        Also <span class=\"built_in\">print</span> services <span class=\"built_in\">which</span> finished SECONDS earlier than the latest <span class=\"keyword\">in</span> the branch</span><br><span class=\"line\">     --man[=BOOL]          Do [not] check <span class=\"keyword\">for</span> existence of man pages</span><br><span class=\"line\">     --generators[=BOOL]   Do [not] run unit generators (requires privileges)</span><br><span class=\"line\">     --iterations=N        Show the specified number of iterations</span><br><span class=\"line\">     --base-time=TIMESTAMP Calculate calendar <span class=\"built_in\">times</span> relative to specified time</span><br></pre></td></tr></table></figure></p>\n<p><strong>示例演示:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.Linux系统开机时间流程所耗费时间一览</span></span><br><span class=\"line\">$ systemd-analyze</span><br><span class=\"line\">  <span class=\"comment\"># Startup finished in 473ms (kernel) + 3.990s (initrd) + 40.050s (userspace) = 44.515s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.查看 Linux 系统启动时各服务耗时情况</span></span><br><span class=\"line\">~$ systemd-analyze blame</span><br><span class=\"line\">13.701s systemd-networkd-wait-online.service</span><br><span class=\"line\"> 6.002s systemd-journal-flush.service</span><br><span class=\"line\"> 4.673s dev-mapper-ubuntu\\x2d\\x2dvg\\x2dubuntu\\x2d\\x2dlv.device</span><br><span class=\"line\"> 3.656s networkd-dispatcher.service</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x03-补充知识\"><a href=\"#0x03-补充知识\" class=\"headerlink\" title=\"0x03 补充知识\"></a>0x03 补充知识</h4><p>systemctl 配置文件的设置参数一览:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]  <span class=\"comment\"># 与此 unit 的解释、执行服务相依性有关</span></span><br><span class=\"line\">Description=描述</span><br><span class=\"line\">Documentation=文档地址</span><br><span class=\"line\">After=network.target   <span class=\"comment\">#在服务之后</span></span><br><span class=\"line\">Before=test.target  <span class=\"comment\">#在服务之前</span></span><br><span class=\"line\">Wants=sshd-keygen.service <span class=\"comment\">#需求服务</span></span><br><span class=\"line\">Requires=network.target  <span class=\"comment\">#依赖的服务</span></span><br><span class=\"line\">Conflicts=冲突解决</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]        <span class=\"comment\"># 这个项目与实际执行的指令参数有关</span></span><br><span class=\"line\">Type=服务类型</span><br><span class=\"line\">EnvironmentFile=/etc/sysconfig/sshd</span><br><span class=\"line\">ExecStart=/usr/sbin/sshd -D <span class=\"variable\">$OPTIONS</span></span><br><span class=\"line\">ExecReload=/bin/<span class=\"built_in\">kill</span> -HUP <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">KillMode=process</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=42s</span><br><span class=\"line\">RemainAfterExit</span><br><span class=\"line\">TimeoutSec</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]        <span class=\"comment\"># 此 unit 要挂载哪个 target 下面即默认启动的运行级别（自启动设置）</span></span><br><span class=\"line\">WantedBy=multi-user.target <span class=\"comment\">#在何种服务或环境下启动</span></span><br><span class=\"line\">Also</span><br><span class=\"line\">Alias</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"1-自定义服务单元\"><a href=\"#1-自定义服务单元\" class=\"headerlink\" title=\"1.自定义服务单元\"></a>1.自定义服务单元</h5><p><strong>方式1：</strong><br>描述：为了避免和 pacman 冲突不应该直接编辑软件包提供的文件. 要更改由软件包提供的单元文件，先创建名为<code>/etc/systemd/system/&lt;单元名&gt;.d/ 的文件夹（如 /etc/systemd/system/httpd.service.d/</code>）；然后放入 *.conf 文件，当中能够加入或重置參数，这里设置的參数优先级高于原来的单元文件。</p>\n<p>实际案例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.比如假设想加入一个额外的依赖。创建这么一个文件就可以：</span></span><br><span class=\"line\">/etc/systemd/system/&lt;unit&gt;.d/customdependency.conf</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Requires=&lt;新依赖&gt;</span><br><span class=\"line\">After=&lt;新依赖&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">/etc/systemd/system/unit.d/customexec.conf</span><br><span class=\"line\">[Service]</span><br><span class=\"line\"><span class=\"comment\">#想知道为什么改动 ExecStart 前必须将其置空</span></span><br><span class=\"line\">ExecStart=</span><br><span class=\"line\">ExecStart=new <span class=\"built_in\">command</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#自己主动重新启动服务</span></span><br><span class=\"line\">Restart=always</span><br><span class=\"line\">RestartSec=30</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.然后执行下面命令使更改生效：</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart &lt;单元&gt;</span><br></pre></td></tr></table></figure></p>\n<p>此外，把旧的单元文件从 /usr/lib/systemd/system/ 拷贝到 /etc/systemd/system/，然后进行改动，也能够达到相同效果。</p>\n<p>总结：</p>\n<ul>\n<li><p>在 /etc/systemd/system/ 文件夹中的单元文件的优先级总是高于 /usr/lib/systemd/system/ 文件夹中的同名单元文件</p>\n</li>\n<li><p>用 systemd-delta 命令来查看哪些单元文件被覆盖、哪些被改动，系统维护的时候须要及时了解哪些单元已经有了更新。</p>\n</li>\n</ul>\n<p><strong>方法2</strong><br>自定义软件的 Systemd 单元实例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=WebP Server Go</span><br><span class=\"line\">Documentation=https://github.com/webp-sh/webp_server_go</span><br><span class=\"line\">After=nginx.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">User=root</span><br><span class=\"line\">Group=root</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">WorkingDirectory=/opt/webps</span><br><span class=\"line\"><span class=\"comment\">#EnvironmentFile=-/etc/etcd/etcd.conf</span></span><br><span class=\"line\">ExecStart=/opt/webps/webp-server --config /opt/webps/config.json</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>\n<p>然后将其保存在<code>/usr/lib/systemd/system/docker.service/webp.service</code>，并且 执行 <code>systemctl daemon-reload</code>重载守护服务; 之后将可以通过systemctl status webp.service 对我们编写的服务单元进行管理;</p>\n<p>关于 systemd 的单元配置文件如何书写，因为根据不同的单元类型包含的配置项实在是巨多。建议参<a href=\"http://www.jinbuguo.com/systemd/systemd.index.html\" target=\"_blank\" rel=\"noopener\">考官方文档/社区翻译文档</a></p>\n<p><strong>示例3.</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /usr/lib/systemd/system/nginx.service</span></span><br><span class=\"line\">tee /usr/lib/systemd/system/nginx.service&lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Nginx - high performance web server service</span><br><span class=\"line\">Documentation=http://nginx.org/en/docs/ </span><br><span class=\"line\">After=network-online.target remote-fs.target nss-lookup.target </span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/usr/<span class=\"built_in\">local</span>/nginx/logs/nginx.pid</span><br><span class=\"line\">ExecStart=/usr/<span class=\"built_in\">local</span>/nginx/sbin/nginx -c /usr/<span class=\"built_in\">local</span>/nginx/conf/nginx.conf</span><br><span class=\"line\">ExecReload=/bin/<span class=\"built_in\">kill</span> -s HUP <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\">ExecStop=/bin/<span class=\"built_in\">kill</span> -s TERM <span class=\"variable\">$MAINPID</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h5 id=\"2-自定义配置\"><a href=\"#2-自定义配置\" class=\"headerlink\" title=\"2.自定义配置\"></a>2.自定义配置</h5><p><strong>（1）基于systemd实现显示服务CPU 和 Memory 信息</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/systemd/system.conf</span><br><span class=\"line\">DefaultCPUAccounting=yes</span><br><span class=\"line\">DefaultMemoryAccounting=yes</span><br><span class=\"line\">DefaultTasksAccounting=yes</span><br></pre></td></tr></table></figure><br>修改重启系统即可看见;<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200420215715.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Linux命令","path":"api/categories/Linux命令.json"}],"tags":[{"name":"服务管理","path":"api/tags/服务管理.json"}]}