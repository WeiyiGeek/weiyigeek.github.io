{"title":"22-kubernetes集群中进行etcd数据快照的备份恢复","slug":"虚拟云容/云容器/Kubernetes/22-kubernetes集群中进行etcd数据快照的备份恢复","date":"2022-10-15T06:36:30.000Z","updated":"2022-11-13T09:26:33.915Z","url":"2022/10-15-690.html","path":"api/articles/2022/10-15-690.html.json","covers":["https://img.weiyigeek.top/2022/10/20221023173507.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>描述：在 Kubernetes 集群中所有操作的资源数据都是存储在 etcd 数据库上, 所以防止集群节点瘫痪未正常工作或在集群迁移时，以及在出现异常的情况下能尽快的恢复集群数据，则我们需要定期针对etcd集群数据进行相应的容灾操作。</p>\n<p>在K8S集群中或者Docker环境中，我们可以非常方便的针对 etcd 数据进行备份，通我们常在一个节点上对 etcd 做快照就能够实现etcd数据的备份，其快照文件包含所有 Kubernetes 状态和关键信息， 有了etcd集群数据备份后，例如在灾难场景(例如丢失所有控制平面节点)下也能快速恢复 Kubernetes 集群，Boss再也不同担心系统起不来呢。</p>\n<p><br/></p>\n<h2 id=\"0x01-环境准备\"><a href=\"#0x01-环境准备\" class=\"headerlink\" title=\"0x01 环境准备\"></a>0x01 环境准备</h2><h3 id=\"1-安装的二进制-etcdctl\"><a href=\"#1-安装的二进制-etcdctl\" class=\"headerlink\" title=\"1.安装的二进制 etcdctl\"></a>1.安装的二进制 etcdctl</h3><p>描述: etcdctl 二进制文件可以在 <code>github.com/coreos/etcd/releases</code> 选择对应的版本下载，例如可以执行以下 <code>install_etcdctl.sh</code> 的脚本，修改其中的版本信息。</p>\n<p>install_etcdctl.sh<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># Author: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\"># Description: etcd 与 etcdctl 下载安装</span></span><br><span class=\"line\">ETCD_VER=v3.5.5</span><br><span class=\"line\">ETCD_DIR=etcd-download</span><br><span class=\"line\">DOWNLOAD_URL=https://github.com/coreos/etcd/releases/download</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Download</span></span><br><span class=\"line\">mkdir <span class=\"variable\">$&#123;ETCD_DIR&#125;</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;ETCD_DIR&#125;</span></span><br><span class=\"line\">wget <span class=\"variable\">$&#123;DOWNLOAD_URL&#125;</span>/<span class=\"variable\">$&#123;ETCD_VER&#125;</span>/etcd-<span class=\"variable\">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz </span><br><span class=\"line\">tar -xzvf etcd-<span class=\"variable\">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Install</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> etcd-<span class=\"variable\">$&#123;ETCD_VER&#125;</span>-linux-amd64</span><br><span class=\"line\">cp etcdctl /usr/<span class=\"built_in\">local</span>/bin/</span><br></pre></td></tr></table></figure></p>\n<p>验证安装:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ etcdctl version</span><br><span class=\"line\">etcdctl version: 3.5.5</span><br><span class=\"line\">API version: 3.5</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h3 id=\"2-拉取带有-etcdctl-的-Docker-镜像\"><a href=\"#2-拉取带有-etcdctl-的-Docker-镜像\" class=\"headerlink\" title=\"2.拉取带有 etcdctl 的 Docker 镜像\"></a>2.拉取带有 etcdctl 的 Docker 镜像</h3><p>操作流程:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 镜像拉取与容器创建。</span></span><br><span class=\"line\">docker run --rm \\</span><br><span class=\"line\">-v /data/backup:/backup      \\</span><br><span class=\"line\">-v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \\</span><br><span class=\"line\">--env ETCDCTL_API=3          \\</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0 \\</span><br><span class=\"line\">/bin/sh -c <span class=\"string\">\"etcdctl version\"</span></span><br></pre></td></tr></table></figure></p>\n<p>安装验证:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">3.5.1-0: Pulling from google_containers/etcd</span><br><span class=\"line\">e8614d09b7be: Pull complete</span><br><span class=\"line\">45b6afb4a92f: Pull complete</span><br><span class=\"line\">.......</span><br><span class=\"line\">Digest: sha256:64b9ea357325d5db9f8a723dcf503b5a449177b17ac87d69481e126bb724c263</span><br><span class=\"line\">Status: Downloaded newer image <span class=\"keyword\">for</span> registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0</span><br><span class=\"line\">etcdctl version: 3.5.1</span><br><span class=\"line\">API version: 3.5</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h3 id=\"3-Kubernetes-使用-etcdctl-镜像创建Pod\"><a href=\"#3-Kubernetes-使用-etcdctl-镜像创建Pod\" class=\"headerlink\" title=\"3.Kubernetes 使用 etcdctl 镜像创建Pod\"></a>3.Kubernetes 使用 etcdctl 镜像创建Pod</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 镜像拉取</span></span><br><span class=\"line\">crictl pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.5-0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Pod 创建以及安装验证</span></span><br><span class=\"line\">$ kubectl run etcdctl --image=registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.5-0 --<span class=\"built_in\">command</span> -- /usr/<span class=\"built_in\">local</span>/bin/etcdctl version</span><br><span class=\"line\">$ kubectl logs -f etcdctl</span><br><span class=\"line\">etcdctl version: 3.5.5</span><br><span class=\"line\">API version: 3.5</span><br><span class=\"line\">$ kubectl delete pod etcdctl</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<h2 id=\"0x02-备份实践\"><a href=\"#0x02-备份实践\" class=\"headerlink\" title=\"0x02 备份实践\"></a>0x02 备份实践</h2><h3 id=\"1-使用二进制安装-etcdctl-客户端工具\"><a href=\"#1-使用二进制安装-etcdctl-客户端工具\" class=\"headerlink\" title=\"1.使用二进制安装 etcdctl 客户端工具\"></a>1.使用二进制安装 etcdctl 客户端工具</h3><p>温馨提示: 如果是单节点 Kubernetes 我们只需要对其的 etcd 数据库进行快照备份, 如果是多主多从的集群，我们则需依次备份多个 master 节点中 etcd，防止在备份时etc数据被更改！</p>\n<p>此处实践环境为多master高可用集群节点, 即三主节点、四从工作节点，若你对K8s集群不了解或者项搭建高可用集群的朋友，关注 WeiyiGeek 公众号回复【<code>Kubernetes学习之路汇总</code>】即可获得学习资料：<br><a href=\"https://www.weiyigeek.top/wechat.html?key=Kubernetes学习之路汇总\" target=\"_blank\" rel=\"noopener\">https://www.weiyigeek.top/wechat.html?key=Kubernetes学习之路汇总</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get node</span><br><span class=\"line\">NAME       STATUS   ROLES                  AGE    VERSION</span><br><span class=\"line\">weiyigeek-107   Ready    control-plane,master   279d   v1.23.1</span><br><span class=\"line\">weiyigeek-108   Ready    control-plane,master   278d   v1.23.1</span><br><span class=\"line\">weiyigeek-109   Ready    control-plane,master   278d   v1.23.1</span><br><span class=\"line\">weiyigeek-223   Ready    work                   278d   v1.23.1</span><br><span class=\"line\">weiyigeek-224   Ready    work                   278d   v1.23.1</span><br><span class=\"line\">weiyigeek-225   Ready    work                   279d   v1.23.1</span><br><span class=\"line\">weiyigeek-226   Ready    work                   118d   v1.23.1</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p><strong>操作流程：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.创建etcd快照备份目录</span></span><br><span class=\"line\">$ mkdir -pv /backup</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.查看etcd证书</span></span><br><span class=\"line\">$ ls /etc/kubernetes/pki/etcd/</span><br><span class=\"line\">ca.crt  ca.key  healthcheck-client.crt  healthcheck-client.key  peer.crt  peer.key  server.crt  server.key</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查看 etcd 地址以及服务</span></span><br><span class=\"line\">$ kubectl get pod -n kube-system  -o wide | grep <span class=\"string\">\"etcd\"</span></span><br><span class=\"line\">etcd-weiyigeek-107     1/1     Running   1   279d   192.168.12.107   weiyigeek-107   &lt;none&gt;&lt;none&gt;</span><br><span class=\"line\">etcd-weiyigeek-108     1/1     Running   0   278d   192.168.12.108   weiyigeek-108   &lt;none&gt;&lt;none&gt;</span><br><span class=\"line\">etcd-weiyigeek-109     1/1     Running   0   278d   192.168.12.109   weiyigeek-109   &lt;none&gt;&lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.此时在 107、 108 、109 主节点上查看你监听情况</span></span><br><span class=\"line\">$ netstat -ano | grep <span class=\"string\">\"107:2379\"</span></span><br><span class=\"line\">tcp        0      0 192.168.12.107:2379     0.0.0.0:*               LISTEN      off (0.00/0/0)</span><br><span class=\"line\">$ netstat -ano | grep <span class=\"string\">\"108:2379\"</span></span><br><span class=\"line\">tcp        0      0 192.168.12.108:2379     0.0.0.0:*               LISTEN      off (0.00/0/0)</span><br><span class=\"line\">$ netstat -ano | grep <span class=\"string\">\"109:2379\"</span></span><br><span class=\"line\">tcp        0      0 192.168.12.109:2379     0.0.0.0:*               LISTEN      off (0.00/0/0)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5. 使用etcdctl客户端工具依次备份节点中的数据</span></span><br><span class=\"line\">$ etcdctl --endpoints=https://10.20.176.212:2379 \\</span><br><span class=\"line\">--cacert=/etc/kubernetes/pki/etcd/ca.crt \\</span><br><span class=\"line\">--cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \\</span><br><span class=\"line\">--key=/etc/kubernetes/pki/etcd/healthcheck-client.key \\</span><br><span class=\"line\">snapshot save /backup/etcd-snapshot.db</span><br><span class=\"line\">&#123;<span class=\"string\">\"level\"</span>:<span class=\"string\">\"info\"</span>,<span class=\"string\">\"ts\"</span>:<span class=\"string\">\"2022-10-23T16:32:26.020+0800\"</span>,<span class=\"string\">\"caller\"</span>:<span class=\"string\">\"snapshot/v3_snapshot.go:65\"</span>,<span class=\"string\">\"msg\"</span>:<span class=\"string\">\"created temporary db file\"</span>,<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/backup/etcd-snapshot.db.part\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"level\"</span>:<span class=\"string\">\"info\"</span>,<span class=\"string\">\"ts\"</span>:<span class=\"string\">\"2022-10-23T16:32:26.034+0800\"</span>,<span class=\"string\">\"logger\"</span>:<span class=\"string\">\"client\"</span>,<span class=\"string\">\"caller\"</span>:<span class=\"string\">\"v3/maintenance.go:211\"</span>,<span class=\"string\">\"msg\"</span>:<span class=\"string\">\"opened snapshot stream; downloading\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"level\"</span>:<span class=\"string\">\"info\"</span>,<span class=\"string\">\"ts\"</span>:<span class=\"string\">\"2022-10-23T16:32:26.034+0800\"</span>,<span class=\"string\">\"caller\"</span>:<span class=\"string\">\"snapshot/v3_snapshot.go:73\"</span>,<span class=\"string\">\"msg\"</span>:<span class=\"string\">\"fetching snapshot\"</span>,<span class=\"string\">\"endpoint\"</span>:<span class=\"string\">\"https://10.20.176.212:2379\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"level\"</span>:<span class=\"string\">\"info\"</span>,<span class=\"string\">\"ts\"</span>:<span class=\"string\">\"2022-10-23T16:32:26.871+0800\"</span>,<span class=\"string\">\"logger\"</span>:<span class=\"string\">\"client\"</span>,<span class=\"string\">\"caller\"</span>:<span class=\"string\">\"v3/maintenance.go:219\"</span>,<span class=\"string\">\"msg\"</span>:<span class=\"string\">\"completed snapshot read; closing\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"level\"</span>:<span class=\"string\">\"info\"</span>,<span class=\"string\">\"ts\"</span>:<span class=\"string\">\"2022-10-23T16:32:26.946+0800\"</span>,<span class=\"string\">\"caller\"</span>:<span class=\"string\">\"snapshot/v3_snapshot.go:88\"</span>,<span class=\"string\">\"msg\"</span>:<span class=\"string\">\"fetched snapshot\"</span>,<span class=\"string\">\"endpoint\"</span>:<span class=\"string\">\"https://10.20.176.212:2379\"</span>,<span class=\"string\">\"size\"</span>:<span class=\"string\">\"112 MB\"</span>,<span class=\"string\">\"took\"</span>:<span class=\"string\">\"now\"</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">\"level\"</span>:<span class=\"string\">\"info\"</span>,<span class=\"string\">\"ts\"</span>:<span class=\"string\">\"2022-10-23T16:32:26.946+0800\"</span>,<span class=\"string\">\"caller\"</span>:<span class=\"string\">\"snapshot/v3_snapshot.go:97\"</span>,<span class=\"string\">\"msg\"</span>:<span class=\"string\">\"saved\"</span>,<span class=\"string\">\"path\"</span>:<span class=\"string\">\"/backup/etcd-snapshot.db\"</span>&#125;</span><br><span class=\"line\">Snapshot saved at /backup/etcd-snapshot.db</span><br></pre></td></tr></table></figure></p>\n<p>通过etcdctl查询Kubernetes中etcd数据，由于Kubernetes使用etcd v3版本的API，而且etcd 集群中默认使用tls认证，所以先配置几个环境变量。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.环境变量</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> ETCDCTL_API=3</span><br><span class=\"line\"><span class=\"built_in\">export</span> ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class=\"line\"><span class=\"built_in\">export</span> ETCDCTL_CERT=/etc/kubernetes/pki/etcd/peer.crt</span><br><span class=\"line\"><span class=\"built_in\">export</span> ETCDCTL_KEY=/etc/kubernetes/pki/etcd/peer.key</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.查询集群中所有的key列表</span></span><br><span class=\"line\"><span class=\"comment\"># –-prefix：表示查找所有以/registry为前缀的key</span></span><br><span class=\"line\"><span class=\"comment\"># --keys-only=true：表示只给出key不给出value</span></span><br><span class=\"line\">etcdctl --endpoints=https://10.20.176.212:2379 get /registry --prefix --keys-only=<span class=\"literal\">true</span> | head -n 1</span><br><span class=\"line\">/registry/apiextensions.k8s.io/customresourcedefinitions/bgpconfigurations.crd.projectcalico.org</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查询某个key的值</span></span><br><span class=\"line\"><span class=\"comment\"># -–keys-only=false : 表示要给出value，该参数默认值即为false，</span></span><br><span class=\"line\"><span class=\"comment\"># -w=json ：表示输出json格式</span></span><br><span class=\"line\">etcdctl --endpoints=https://10.20.176.212:2379 get /registry/namespaces/default --prefix --keys-only=<span class=\"literal\">false</span> -w=json | python3 -m json.tool</span><br><span class=\"line\"></span><br><span class=\"line\">etcdctl --endpoints=https://10.20.176.212:2379 get /registry/namespaces/default --prefix --keys-only=<span class=\"literal\">false</span> -w=json | python3 -m json.tool</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"header\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"cluster_id\"</span>: 11404821125176160774,</span><br><span class=\"line\">      <span class=\"string\">\"member_id\"</span>: 7099450421952911102,</span><br><span class=\"line\">      <span class=\"string\">\"revision\"</span>: 30240109,</span><br><span class=\"line\">      <span class=\"string\">\"raft_term\"</span>: 3</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"kvs\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">\"key\"</span>: <span class=\"string\">\"L3JlZ2lzdHJ5L25hbWVzcGFjZXMvZGVmYXVsdA==\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"create_revision\"</span>: 192,</span><br><span class=\"line\">        <span class=\"string\">\"mod_revision\"</span>: 192,</span><br><span class=\"line\">        <span class=\"string\">\"version\"</span>: 1,</span><br><span class=\"line\">        <span class=\"string\">\"value\"</span>: <span class=\"string\">\"azhzAAoPCg.......XNwYWNlEGgAiAA==\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">\"count\"</span>: 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.其 Key / Value 都是采用 base64 编码</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"L3JlZ2lzdHJ5L25hbWVzcGFjZXMvZGVmYXVsdA==\"</span> | base64 -d</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"azhzAAoPCgJ2MRIJTmFtZXNwYWNlEogCCu0BCgdkZWZhdWx0EgAaACIAKiQ5ZDQyYmYxMy03OGM0LTQ4NzQtOThiYy05NjNlMDg1MDYyZjYyADgAQggIo8yllQYQAFomChtrdWJlcm5ldGVzLmlvL21ldGFkYXRhLm5hbWUSB2RlZmF1bHR6AIoBfQoOa3ViZS1hcGlzZXJ2ZXISBlVwZGF0ZRoCdjEiCAijzKWVBhAAMghGaWVsZHNWMTpJCkd7ImY6bWV0YWRhdGEiOnsiZjpsYWJlbHMiOnsiLiI6e30sImY6a3ViZXJuZXRlcy5pby9tZXRhZGF0YS5uYW1lIjp7fX19fUIAEgwKCmt1YmVybmV0ZXMaCAoGQWN0aXZlGgAiAA==\"</span> | base64 -d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.实际上述value编码解码后的的内容如下:</span></span><br><span class=\"line\">$ kubectl get ns default -o yaml</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  creationTimestamp: <span class=\"string\">\"2022-06-15T04:54:59Z\"</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    kubernetes.io/metadata.name: default</span><br><span class=\"line\">  name: default</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">\"192\"</span></span><br><span class=\"line\">  uid: 9d42bf13-78c4-4874-98bc-963e085062f6</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  finalizers:</span><br><span class=\"line\">  - kubernetes</span><br><span class=\"line\">status:</span><br><span class=\"line\">  phase: Active</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.Pod 资源信息查看 </span></span><br><span class=\"line\">etcdctl --endpoints=https://10.20.176.212:2379 get /registry/pods/default --prefix --keys-only=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># /registry/pods/default/nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h</span></span><br><span class=\"line\"><span class=\"comment\"># /registry/pods/default/nfs-local-nfs-subdir-external-provisioner-6f97d44bb8-424tk</span></span><br><span class=\"line\"></span><br><span class=\"line\">etcdctl --endpoints=https://10.20.176.212:2379 get /registry/pods/default --prefix --keys-only=<span class=\"literal\">true</span> -w=json | python3 -m json.tool</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"header\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"cluster_id\"</span>: 11404821125176160774,</span><br><span class=\"line\">      <span class=\"string\">\"member_id\"</span>: 7099450421952911102,</span><br><span class=\"line\">      <span class=\"string\">\"revision\"</span>: 30442415,</span><br><span class=\"line\">      <span class=\"string\">\"raft_term\"</span>: 3</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"kvs\"</span>: [</span><br><span class=\"line\">      &#123;   <span class=\"comment\"># 实际上该编码是 /registry/pods/default/nfs-dev-nfs-subdir-external-provisioner-cf7684f8b-fzl9h</span></span><br><span class=\"line\">          <span class=\"string\">\"key\"</span>: <span class=\"string\">\"L3JlZ2lzdHJ5L3BvZHMvZGVmYXVsdC9uZnMtZGV2LW5mcy1zdWJkaXItZXh0ZXJuYWwtcHJvdmlzaW9uZXItY2Y3Njg0ZjhiLWZ6bDlo\"</span>,  </span><br><span class=\"line\">          <span class=\"string\">\"create_revision\"</span>: 5510865,</span><br><span class=\"line\">          <span class=\"string\">\"mod_revision\"</span>: 5510883,</span><br><span class=\"line\">          <span class=\"string\">\"version\"</span>: 5</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">          <span class=\"string\">\"key\"</span>: <span class=\"string\">\"L3JlZ2lzdHJ5L3BvZHMvZGVmYXVsdC9uZnMtbG9jYWwtbmZzLXN1YmRpci1leHRlcm5hbC1wcm92aXNpb25lci02Zjk3ZDQ0YmI4LTQyNHRr\"</span>,</span><br><span class=\"line\">          <span class=\"string\">\"create_revision\"</span>: 5510967,</span><br><span class=\"line\">          <span class=\"string\">\"mod_revision\"</span>: 5510987,</span><br><span class=\"line\">          <span class=\"string\">\"version\"</span>: 5</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">\"count\"</span>: 2</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"2-使用Docker镜像安装-etcdctl-客户端工具\"><a href=\"#2-使用Docker镜像安装-etcdctl-客户端工具\" class=\"headerlink\" title=\"2.使用Docker镜像安装 etcdctl 客户端工具\"></a>2.使用Docker镜像安装 etcdctl 客户端工具</h3><p>描述: 在装有Docker环境的机器,我们可以非常方便的备份K8s集群中的etcd数据库，此处我已经安装好了Docker，若有不了解Docker或者需要搭建Docker环境中童鞋。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.Docker 实践环境</span></span><br><span class=\"line\">$ docker version</span><br><span class=\"line\">Client: Docker Engine - Community</span><br><span class=\"line\"> Version           20.10.3</span><br><span class=\"line\">.......</span><br><span class=\"line\">Server: Docker Engine - Community</span><br><span class=\"line\"> Engine:</span><br><span class=\"line\">  Version:          20.10.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.etcd 备份文件存储的目录</span></span><br><span class=\"line\">$ mkdir -vp /backup</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.执行docker创建容器，在备份数据库后便删除该容器。</span></span><br><span class=\"line\">$ docker run --rm \\</span><br><span class=\"line\">-v /backup:/backup  \\</span><br><span class=\"line\">-v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \\</span><br><span class=\"line\">--env ETCDCTL_API=3   \\</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0 \\</span><br><span class=\"line\">/bin/sh -c <span class=\"string\">\"etcdctl --endpoints=https://192.168.12.107:2379 \\</span></span><br><span class=\"line\"><span class=\"string\">--cacert=/etc/kubernetes/pki/etcd/ca.crt  \\</span></span><br><span class=\"line\"><span class=\"string\">--key=/etc/kubernetes/pki/etcd/healthcheck-client.key \\</span></span><br><span class=\"line\"><span class=\"string\">--cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \\</span></span><br><span class=\"line\"><span class=\"string\">snapshot save /backup/etcd-snapshot.db\"</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"level\":\"info\",\"ts\":1666515535.63076,\"caller\":\"snapshot/v3_snapshot.go:68\",\"msg\":\"created temporary db file\",\"path\":\"/backup/etcd-snapshot.db.part\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"level\":\"info\",\"ts\":1666515535.6411893,\"logger\":\"client\",\"caller\":\"v3/maintenance.go:211\",\"msg\":\"opened snapshot stream; downloading\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"level\":\"info\",\"ts\":1666515535.6419039,\"caller\":\"snapshot/v3_snapshot.go:76\",\"msg\":\"fetching snapshot\",\"endpoint\":\"https://192.168.12.107:2379\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"level\":\"info\",\"ts\":1666515535.9170482,\"logger\":\"client\",\"caller\":\"v3/maintenance.go:219\",\"msg\":\"completed snapshot read; closing\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"level\":\"info\",\"ts\":1666515535.931862,\"caller\":\"snapshot/v3_snapshot.go:91\",\"msg\":\"fetched snapshot\",\"endpoint\":\"https://192.168.12.107:2379\",\"size\":\"9.0 MB\",\"took\":\"now\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;\"level\":\"info\",\"ts\":1666515535.9322069,\"caller\":\"snapshot/v3_snapshot.go:100\",\"msg\":\"saved\",\"path\":\"/backup/etcd-snapshot.db\"&#125;</span></span><br><span class=\"line\">Snapshot saved at /backup/etcd-snapshot.db</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.查看备份的etcd快照文件</span></span><br><span class=\"line\">ls -alh /backup/etcd-snapshot.db</span><br><span class=\"line\">-rw------- 1 root root 8.6M Oct 23 16:58 /backup/etcd-snapshot.db</span><br></pre></td></tr></table></figure>\n<p>使用 Docker 容器查看 k8s 集群中的etcd数据库中的数据。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker run --rm \\</span><br><span class=\"line\">-v /backup:/backup  \\</span><br><span class=\"line\">-v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \\</span><br><span class=\"line\">--env ETCDCTL_API=3   \\</span><br><span class=\"line\">--env ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt \\</span><br><span class=\"line\">--env ETCDCTL_CERT=/etc/kubernetes/pki/etcd/peer.crt \\</span><br><span class=\"line\">--env ETCDCTL_KEY=/etc/kubernetes/pki/etcd/peer.key \\</span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.1-0 \\</span><br><span class=\"line\">/bin/sh -c <span class=\"string\">\"etcdctl --endpoints=https://192.168.12.107:2379 get /registry/namespaces/default -w=json\"</span></span><br></pre></td></tr></table></figure></p>\n<p>执行结果: </p>\n<p><img src=\"https://img.weiyigeek.top/2022/10/20221023173507.png\" alt=\"WeiyiGeek.Docker容器查询Kubernetes集群中etcd数据库中k/v示例图\"></p>\n<p><br></p>\n<h3 id=\"3-在kubernetes集群中快速创建pod进行手动备份\"><a href=\"#3-在kubernetes集群中快速创建pod进行手动备份\" class=\"headerlink\" title=\"3.在kubernetes集群中快速创建pod进行手动备份\"></a>3.在kubernetes集群中快速创建pod进行手动备份</h3><p>准备一个Pod资源清单并部署<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">&lt;&lt;EOF</span> <span class=\"string\">| kubectl apply -f -</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">etcd-backup</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    tool:</span> <span class=\"string\">backup</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  containers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.5-0</span></span><br><span class=\"line\"><span class=\"attr\">    imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"attr\">    command:</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">sh</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"bullet\">-c</span></span><br><span class=\"line\"><span class=\"bullet\">    -</span> <span class=\"string\">\"etcd\"</span></span><br><span class=\"line\"><span class=\"attr\">    env:</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ETCDCTL_API</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ETCDCTL_CACERT</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">\"/etc/kubernetes/pki/etcd/ca.crt\"</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ETCDCTL_CERT</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">\"/etc/kubernetes/pki/etcd/healthcheck-client.crt\"</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">ETCDCTL_KEY</span></span><br><span class=\"line\"><span class=\"attr\">      value:</span> <span class=\"string\">\"/etc/kubernetes/pki/etcd/healthcheck-client.key\"</span></span><br><span class=\"line\"><span class=\"attr\">    volumeMounts:</span> </span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">\"pki\"</span></span><br><span class=\"line\"><span class=\"attr\">      mountPath:</span> <span class=\"string\">\"/etc/kubernetes\"</span></span><br><span class=\"line\"><span class=\"attr\">    - name:</span> <span class=\"string\">\"backup\"</span></span><br><span class=\"line\"><span class=\"attr\">      mountPath:</span> <span class=\"string\">\"/backup\"</span></span><br><span class=\"line\"><span class=\"attr\">  volumes:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">pki</span></span><br><span class=\"line\"><span class=\"attr\">    hostPath:</span> </span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">\"/etc/kubernetes\"</span>          <span class=\"comment\"># 证书目录</span></span><br><span class=\"line\"><span class=\"attr\">      type:</span> <span class=\"string\">\"DirectoryOrCreate\"</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">\"backup\"</span></span><br><span class=\"line\"><span class=\"attr\">    hostPath:</span>     </span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">\"/storage/dev/backup\"</span>      <span class=\"comment\"># 数据备份目录</span></span><br><span class=\"line\"><span class=\"attr\">      type:</span> <span class=\"string\">\"DirectoryOrCreate\"</span></span><br><span class=\"line\"><span class=\"attr\">  restartPolicy:</span> <span class=\"string\">Never</span></span><br><span class=\"line\"><span class=\"attr\">  nodeSelector:</span> </span><br><span class=\"line\">    <span class=\"string\">node-role.kubernetes.io/master:</span> <span class=\"string\">\"\"</span> <span class=\"comment\"># 绑定在主节点中</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">pod/etcd-backup</span> <span class=\"string\">created</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>进入到该Pod终端之中执行相应的备份命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~$ kubectl <span class=\"built_in\">exec</span> -it etcd-backup sh</span><br><span class=\"line\"><span class=\"comment\"># 快照备份</span></span><br><span class=\"line\">sh-5.1<span class=\"comment\"># export RAND=$RANDOM</span></span><br><span class=\"line\">sh-5.1<span class=\"comment\"># etcdctl --endpoints=https://192.168.12.107:2379 snapshot save /backup/etcd-107-$&#123;RAND&#125;-snapshot.db</span></span><br><span class=\"line\">sh-5.1<span class=\"comment\"># etcdctl --endpoints=https://192.168.12.108:2379 snapshot save /backup/etcd-108-$&#123;RAND&#125;-snapshot.db</span></span><br><span class=\"line\">Snapshot saved at /backup/etcd-108-32616-snapshot.db</span><br><span class=\"line\">sh-5.1<span class=\"comment\"># etcdctl --endpoints=https://192.168.12.109:2379 snapshot save /backup/etcd-109-$&#123;RAND&#125;-snapshot.db</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># etcd 节点成员</span></span><br><span class=\"line\">sh-5.1<span class=\"comment\"># etcdctl member list --endpoints=https://192.168.12.107:2379 --endpoints=https://192.168.12.108:2379 --endpoints=https://192.168.12.109:2379</span></span><br><span class=\"line\"></span><br><span class=\"line\">2db31a5d67ec1034, started, weiyigeek-108, https://192.168.12.108:2380, https://192.168.12.108:2379, <span class=\"literal\">false</span></span><br><span class=\"line\">42efe7cca897d765, started, weiyigeek-109, https://192.168.12.109:2380, https://192.168.12.109:2379, <span class=\"literal\">false</span></span><br><span class=\"line\">471323846709334f, started, weiyigeek-107, https://192.168.12.107:2380, https://192.168.12.107:2379, <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># etcd 节点健康信息</span></span><br><span class=\"line\">sh-5.1<span class=\"comment\"># etcdctl endpoint health --endpoints=https://192.168.12.107:2379 --endpoints=https://192.168.12.108:2379 --endpoints=https://192.168.12.109:2379</span></span><br><span class=\"line\"></span><br><span class=\"line\">https://192.168.12.107:2379 is healthy: successfully committed proposal: took = 11.930331ms</span><br><span class=\"line\">https://192.168.12.109:2379 is healthy: successfully committed proposal: took = 11.930993ms</span><br><span class=\"line\">https://192.168.12.108:2379 is healthy: successfully committed proposal: took = 109.515933ms</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># etcd 节点状态及空间占用信息</span></span><br><span class=\"line\">sh-5.1<span class=\"comment\"># etcdctl endpoint status --endpoints=https://192.168.12.107:2379  --endpoints=https://192.168.12.108:2379  --endpoints=https://192.168.12.109:2379</span></span><br><span class=\"line\"></span><br><span class=\"line\">https://192.168.12.107:2379, 471323846709334f, 3.5.1, 9.2 MB, <span class=\"literal\">false</span>, <span class=\"literal\">false</span>, 4, 71464830, 71464830,</span><br><span class=\"line\">https://192.168.12.108:2379, 2db31a5d67ec1034, 3.5.1, 9.2 MB, <span class=\"literal\">false</span>, <span class=\"literal\">false</span>, 4, 71464830, 71464830,</span><br><span class=\"line\">https://192.168.12.109:2379, 42efe7cca897d765, 3.5.1, 9.2 MB, <span class=\"literal\">true</span>, <span class=\"literal\">false</span>, 4, 71464830, 71464830, <span class=\"comment\"># 此处为主</span></span><br></pre></td></tr></table></figure>\n<p>至此，手动备份etcd集群数据快照完毕!</p>\n<p><br/></p>\n<h3 id=\"4-在kubernetes集群中使用CronJob资源控制器进行定时备份\"><a href=\"#4-在kubernetes集群中使用CronJob资源控制器进行定时备份\" class=\"headerlink\" title=\"4.在kubernetes集群中使用CronJob资源控制器进行定时备份\"></a>4.在kubernetes集群中使用CronJob资源控制器进行定时备份</h3><p>首先准备一个cronJob资源清单：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; etcd-database-backup.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: batch/v1</span><br><span class=\"line\">kind: CronJob </span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: etcd-database-backup</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    descript: <span class=\"string\">\"etcd数据库定时备份\"</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  schedule: <span class=\"string\">\"*/5 * * * *\"</span>   <span class=\"comment\"># 表示每5分钟运行一次</span></span><br><span class=\"line\">  jobTemplate:</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      template:</span><br><span class=\"line\">        spec:           </span><br><span class=\"line\">          containers:    </span><br><span class=\"line\">          - name: etcdctl</span><br><span class=\"line\">            image: registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.5-0</span><br><span class=\"line\">            env:</span><br><span class=\"line\">            - name: ETCDCTL_API</span><br><span class=\"line\">              value: <span class=\"string\">\"3\"</span></span><br><span class=\"line\">            - name: ETCDCTL_CACERT</span><br><span class=\"line\">              value: <span class=\"string\">\"/etc/kubernetes/pki/etcd/ca.crt\"</span></span><br><span class=\"line\">            - name: ETCDCTL_CERT</span><br><span class=\"line\">              value: <span class=\"string\">\"/etc/kubernetes/pki/etcd/healthcheck-client.crt\"</span></span><br><span class=\"line\">            - name: ETCDCTL_KEY</span><br><span class=\"line\">              value: <span class=\"string\">\"/etc/kubernetes/pki/etcd/healthcheck-client.key\"</span></span><br><span class=\"line\">            <span class=\"built_in\">command</span>:</span><br><span class=\"line\">            - /bin/sh </span><br><span class=\"line\">            - -c</span><br><span class=\"line\">            - |</span><br><span class=\"line\">              <span class=\"built_in\">export</span> RAND=<span class=\"variable\">$RANDOM</span></span><br><span class=\"line\">              etcdctl --endpoints=https://192.168.12.107:2379 snapshot save /backup/etcd-107-<span class=\"variable\">$&#123;RAND&#125;</span>-snapshot.db</span><br><span class=\"line\">              etcdctl --endpoints=https://192.168.12.108:2379 snapshot save /backup/etcd-108-<span class=\"variable\">$&#123;RAND&#125;</span>-snapshot.db</span><br><span class=\"line\">              etcdctl --endpoints=https://192.168.12.109:2379 snapshot save /backup/etcd-109-<span class=\"variable\">$&#123;RAND&#125;</span>-snapshot.db</span><br><span class=\"line\">            volumeMounts: </span><br><span class=\"line\">            - name: <span class=\"string\">\"pki\"</span></span><br><span class=\"line\">              mountPath: <span class=\"string\">\"/etc/kubernetes\"</span></span><br><span class=\"line\">            - name: <span class=\"string\">\"backup\"</span></span><br><span class=\"line\">              mountPath: <span class=\"string\">\"/backup\"</span></span><br><span class=\"line\">            imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          volumes:</span><br><span class=\"line\">          - name: <span class=\"string\">\"pki\"</span></span><br><span class=\"line\">            hostPath: </span><br><span class=\"line\">              path: <span class=\"string\">\"/etc/kubernetes\"</span></span><br><span class=\"line\">              <span class=\"built_in\">type</span>: <span class=\"string\">\"DirectoryOrCreate\"</span></span><br><span class=\"line\">          - name: <span class=\"string\">\"backup\"</span></span><br><span class=\"line\">            hostPath: </span><br><span class=\"line\">              path: <span class=\"string\">\"/storage/dev/backup\"</span>  <span class=\"comment\"># 数据备份目录</span></span><br><span class=\"line\">              <span class=\"built_in\">type</span>: <span class=\"string\">\"DirectoryOrCreate\"</span></span><br><span class=\"line\">          nodeSelector:  <span class=\"comment\"># 将Pod绑定在主节点之中，否则只能将相关证书放在各个节点能访问的nfs共享存储中</span></span><br><span class=\"line\">            node-role.kubernetes.io/master: <span class=\"string\">\"\"</span></span><br><span class=\"line\">          restartPolicy: Never</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure></p>\n<p>创建cronjob资源清单:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f etcd-database-backup.yaml</span><br><span class=\"line\"><span class=\"comment\"># cronjob.batch/etcd-database-backup created</span></span><br></pre></td></tr></table></figure></p>\n<p>查看创建的cronjob资源及其集群etcd备份:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAME                                 SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class=\"line\">cronjob.batch/etcd-database-backup   */5 * * * *   False     0        21s             14m</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class=\"line\">pod/etcd-database-backup-27776740-rhzkk   0/1     Completed   0          21s</span><br></pre></td></tr></table></figure></p>\n<p>查看定时Pod日志以及备份文件:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs -f pod/etcd-database-backup-27776740-rhzkk</span><br><span class=\"line\">Snapshot saved at /backup/etcd-107-25615-snapshot.db</span><br><span class=\"line\">Snapshot saved at /backup/etcd-108-25615-snapshot.db</span><br><span class=\"line\">Snapshot saved at /backup/etcd-109-25615-snapshot.db</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ ls -lt <span class=\"comment\"># 显示最新备份的文件按照时间排序</span></span><br><span class=\"line\">total 25M</span><br><span class=\"line\">-rw------- 1 root root 8.6M Oct 24 21:12 etcd-107-25615-snapshot.db</span><br><span class=\"line\">-rw------- 1 root root 7.1M Oct 24 21:12 etcd-108-25615-snapshot.db</span><br><span class=\"line\">-rw------- 1 root root 8.8M Oct 24 21:12 etcd-109-25615-snapshot.db</span><br></pre></td></tr></table></figure></p>\n<p>至此集群中的etcd快照数据备份完毕!</p>\n<p><br/></p>\n<h2 id=\"0x02-恢复实践\"><a href=\"#0x02-恢复实践\" class=\"headerlink\" title=\"0x02 恢复实践\"></a>0x02 恢复实践</h2><h3 id=\"1-单master节点恢复\"><a href=\"#1-单master节点恢复\" class=\"headerlink\" title=\"1.单master节点恢复\"></a>1.单master节点恢复</h3><p>描述: 当单master集群节点资源清单数据丢失时，我们可采用如下方式进行快速恢复数据。</p>\n<p><strong>操作流程:</strong></p>\n<p>温馨提示: 如果是单节点的k8S集群则使用如下命令恢复</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> mv /etc/kubernetes/manifests/ /etc/kubernetes/manifests-backup/</span><br><span class=\"line\"> mv /var/lib/etcd /var/lib/etcd.bak</span><br><span class=\"line\"></span><br><span class=\"line\">ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-212-32616-snapshot.db  --data-dir=/var/lib/etcd/ --endpoints=https://10.20.176.212:2379  --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-多master节点恢复\"><a href=\"#2-多master节点恢复\" class=\"headerlink\" title=\"2.多master节点恢复\"></a>2.多master节点恢复</h3><p>1.温馨提示，此处的集群etcd数据库是安装在Kubernetes集群之中的，并非外部独立安装部署的。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pod -n kube-system  etcd-devtest-master-212 etcd-devtest-master-213 etcd-devtest-master-214</span><br><span class=\"line\">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">etcd-devtest-master-212   1/1     Running   3          134d</span><br><span class=\"line\">etcd-devtest-master-213   1/1     Running   0          134d</span><br><span class=\"line\">etcd-devtest-master-214   1/1     Running   0          134d</span><br></pre></td></tr></table></figure></p>\n<p>2.前面我们提到过，在进行恢复前需要查看 etcd 集群当前成员以及监控状态。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># etcd 集群成员列表</span></span><br><span class=\"line\">ETCDCTL_API=3 etcdctl member list --endpoints=https://10.20.176.212:2379  --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key</span><br><span class=\"line\">6286508b550016fe, started, devtest-master-212, https://10.20.176.212:2380, https://10.20.176.212:2379, <span class=\"literal\">false</span></span><br><span class=\"line\">9dd15f852caf8e05, started, devtest-master-214, https://10.20.176.214:2380, https://10.20.176.214:2379, <span class=\"literal\">false</span></span><br><span class=\"line\">e0f23bd90b7c7c0d, started, devtest-master-213, https://10.20.176.213:2380, https://10.20.176.213:2379, <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># etcd 集群节点状态查看主从节点</span></span><br><span class=\"line\">ETCDCTL_API=3 etcdctl endpoint status --endpoints=https://10.20.176.212:2379 --endpoints=https://10.20.176.213:2379 --endpoints=https://10.20.176.214:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key   --write-out table</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># etcd 集群节点健康信息筛选出不健康的节点</span></span><br><span class=\"line\">ETCDCTL_API=3 etcdctl endpoint health --endpoints=https://10.20.176.212:2379   --endpoints=https://10.20.176.213:2379  --endpoints=https://10.20.176.214:2379  --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key</span><br><span class=\"line\">https://10.20.176.212:2379 is healthy: successfully committed proposal: took = 14.686875ms</span><br><span class=\"line\">https://10.20.176.214:2379 is healthy: successfully committed proposal: took = 16.201187ms</span><br><span class=\"line\">https://10.20.176.213:2379 is healthy: successfully committed proposal: took = 18.962462ms</span><br></pre></td></tr></table></figure></p>\n<p>3.停掉所有Master机器的kube-apiserver和etcd ，然后在利用备份进行恢复该节点的etcd数据。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">mv /etc/kubernetes/manifests/ /etc/kubernetes/manifests-backup/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在该节点上删除 /var/lib/etcd</span></span><br><span class=\"line\">mv /var/lib/etcd /var/lib/etcd.bak</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 利用快照进行恢复,注意etcd集群中可以用同一份snapshot恢复。</span></span><br><span class=\"line\">ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-212-32616-snapshot.db --data-dir=/var/lib/etcd --name=devtest-master-212 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key  --initial-cluster-token=etcd-cluster-0 --initial-cluster=devtest-master-212=https://10.20.176.212:2380,devtest-master-213=https://10.20.176.213:2380,devtest-master-214=https://10.20.176.214:2380  --initial-advertise-peer-urls=https://10.20.176.212:2380</span><br></pre></td></tr></table></figure>\n<p>温馨提示: 当节点加入控制平面 control-plane 后为 <code>API Server、Controller Manager 和 Scheduler</code> 生成静态Pod配置清单，主机上的kubelet服务会监视 <code>/etc/kubernetes/manifests</code>目录中的配置清单的创建、变动和删除等状态变动，并根据变动完成Pod创建、更新或删除操作。因此，这两个阶段创建生成的各配置清单将会启动Master组件的相关Pod</p>\n<p>4.然后启动 etcd 和 apiserver 并查看 pods是否恢复正常。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看 etcd pod</span></span><br><span class=\"line\">$ kubectl get pod -n kube-system -l component=etcd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看组件健康状态</span></span><br><span class=\"line\">$ kubectl get componentstatuses</span><br><span class=\"line\">Warning: v1 ComponentStatus is deprecated <span class=\"keyword\">in</span> v1.19+</span><br><span class=\"line\">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class=\"line\">scheduler            Healthy   ok</span><br><span class=\"line\">controller-manager   Healthy   ok</span><br><span class=\"line\">etcd-0               Healthy   &#123;<span class=\"string\">\"health\"</span>:<span class=\"string\">\"true\"</span>,<span class=\"string\">\"reason\"</span>:<span class=\"string\">\"\"</span>&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-K8S集群中etcd数据库节点数据不一致问题解决实践\"><a href=\"#3-K8S集群中etcd数据库节点数据不一致问题解决实践\" class=\"headerlink\" title=\"3.K8S集群中etcd数据库节点数据不一致问题解决实践\"></a>3.K8S集群中etcd数据库节点数据不一致问题解决实践</h3><p>发现etcd数据不一致，执行kubectl get pod -n xxx获取的信息资源不一样， etcdctl 直接查询了 etcd 集群状态和集群数据，返回结果显示 3 个节点状态都正常，且 RaftIndex 一致，观察 etcd 的日志也并未发现报错信息，唯一可疑的地方是 3 个节点的 dbsize 差别较大</p>\n<p>etcd 数据不一致 ？</p>\n<p>由于从 kube-apiserver 的日志中同样无法提取出能够帮助解决问题的有用信息，起初我们只能猜测可能是 kube-apiserver 的缓存更新异常导致的。正当我们要从这个切入点去解决问题时，该同事反馈了一个更诡异的问题——自己新创建的 Pod，通过 kubectl查询 Pod 列表，突然消失了！纳尼？这是什么骚操作？经过我们多次测试查询发现，通过 kubectl 来 list pod 列表，该 pod 有时候能查到，有时候查不到。那么问题来了，K8s api 的 list 操作是没有缓存的，数据是 kube-apiserver 直接从 etcd 拉取返回给客户端的，难道是 etcd 本身出了问题？</p>\n<p>众所周知，etcd 本身是一个强一致性的 KV 存储，在写操作成功的情况下，两次读请求不应该读取到不一样的数据。怀着不信邪的态度，我们通过 etcdctl 直接查询了 etcd 集群状态和集群数据，返回结果显示 3 个节点状态都正常，且 RaftIndex 一致，观察 etcd 的日志也并未发现报错信息，唯一可疑的地方是 3 个节点的 dbsize 差别较大。接着，我们又将 client 访问的 endpoint 指定为不同节点地址来查询每个节点的 key 的数量，结果发现 3 个节点返回的 key 的数量不一致，甚至两个不同节点上 Key 的数量差最大可达到几千！而直接通过 etcdctl 查询刚才创建的 Pod，发现访问某些 endpoint 能够查询到该 pod，而访问其他 endpoint 则查不到。至此，基本可以确定 etcd 集群的节点之间确实存在数据不一致现象。</p>\n<p>ETCDCTL_API=3 etcdctl endpoint status –endpoints=<a href=\"https://192.168.12.108:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.108:2379</a> –endpoints=<a href=\"https://192.168.12.107:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.107:2379</a> –endpoints=<a href=\"https://192.168.12.109:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.109:2379</a> –cacert=/etc/kubernetes/pki/etcd/ca.crt –cert=/etc/kubernetes/pki/etcd/peer.crt –key=/etc/kubernetes/pki/etcd/peer.key </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://192.168.12.108:2379, 2db31a5d67ec1034, 3.5.1, 7.4 MB, <span class=\"literal\">false</span>, <span class=\"literal\">false</span>, 4, 72288139, 72288139,</span><br><span class=\"line\">https://192.168.12.107:2379, 471323846709334f, 3.5.1, 9.0 MB, <span class=\"literal\">false</span>, <span class=\"literal\">false</span>, 4, 72288139, 72288139,</span><br><span class=\"line\">https://192.168.12.109:2379, 42efe7cca897d765, 3.5.1, 9.2 MB, <span class=\"literal\">true</span>, <span class=\"literal\">false</span>, 4, 72288139, 72288139,</span><br></pre></td></tr></table></figure>\n<p>root@weiyigeek-107:~# ETCDCTL_API=3  etcdctl get / –prefix –keys-only –endpoints=<a href=\"https://192.168.12.107:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.107:2379</a>  –cacert=/etc/kubernetes/pki/etcd/ca.crt –cert=/etc/kubernetes/pki/etcd/peer.crt –key=/etc/kubernetes/pki/etcd/peer.key  | wc -l<br>1620</p>\n<p>root@weiyigeek-107:~# ETCDCTL_API=3  etcdctl get / –prefix –keys-only –endpoints=<a href=\"https://192.168.12.108:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.108:2379</a>  –cacert=/etc/kubernetes/pki/etcd/ca.crt –cert=/etc/kubernetes/pki/etcd/peer.crt –key=/etc/kubernetes/pki/etcd/peer.key  | wc -l<br>1620</p>\n<p>root@weiyigeek-107:~# ETCDCTL_API=3  etcdctl get / –prefix –keys-only –endpoints=<a href=\"https://192.168.12.109:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.109:2379</a>  –cacert=/etc/kubernetes/pki/etcd/ca.crt –cert=/etc/kubernetes/pki/etcd/peer.crt –key=/etc/kubernetes/pki/etcd/peer.key  | wc -l<br>1620</p>\n<p> l<br>+—————————–+——————+———+———+———–+———–+————+<br>|          ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |<br>+—————————–+——————+———+———+———–+———–+————+<br>| <a href=\"https://192.168.12.108:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.108:2379</a> | 2db31a5d67ec1034 |   3.5.1 |  7.4 MB |     false |         4 |   72291872 |<br>| <a href=\"https://192.168.12.107:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.107:2379</a> | 471323846709334f |   3.5.1 |  9.0 MB |     false |         4 |   72291872 |<br>| <a href=\"https://192.168.12.109:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.109:2379</a> | 42efe7cca897d765 |   3.5.1 |  9.2 MB |      true |         4 |   72291872 |<br>+—————————–+——————+———+———+———–+———–+————+</p>\n<p> ETCDCTL_API=3 etcdctl endpoint status –endpoints=<a href=\"https://192.168.12.107:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.107:2379</a>    –endpoints=<a href=\"https://192.168.12.108:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.108:2379</a> –endpoints=<a href=\"https://192.168.12.109:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.109:2379</a>   –write-out table<br>+—————————–+——————+———+———+———–+————+———–+————+——————–+——–+<br>|          ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |<br>+—————————–+——————+———+———+———–+————+———–+————+——————–+——–+<br>| <a href=\"https://192.168.12.107:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.107:2379</a> | 471323846709334f |   3.5.1 |  9.0 MB |     false |      false |         4 |   72292452 |           72292452 |        |<br>| <a href=\"https://192.168.12.108:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.108:2379</a> | 2db31a5d67ec1034 |   3.5.1 |  7.4 MB |     false |      false |         4 |   72292452 |           72292452 |        |<br>| <a href=\"https://192.168.12.109:2379\" target=\"_blank\" rel=\"noopener\">https://192.168.12.109:2379</a> | 42efe7cca897d765 |   3.5.1 |  9.2 MB |      true |      false |         4 |   72292452 |           72292452 |        |<br>+—————————–+——————+———+———+———–+————+———–+————+——————–+——–+</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Containers","path":"api/categories/Containers.json"},{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"k8s","path":"api/tags/k8s.json"}]}