{"title":"Rsyslog服务日志审计留存","slug":"网安防御/安全建设/日志审计/Rsyslog服务日志审计留存","date":"2019-08-01T01:34:30.000Z","updated":"2020-10-10T02:37:50.520Z","url":"2019/8-1-440.html","path":"api/articles/2019/8-1-440.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言\"><a href=\"#0x00-前言\" class=\"headerlink\" title=\"0x00 前言\"></a>0x00 前言</h4><p>Linux的rsyslog日志服务器配置：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/rsyslog.conf</span><br><span class=\"line\"><span class=\"comment\">#将其中下面四行的注释取消</span></span><br><span class=\"line\"><span class=\"variable\">$ModLoad</span> imudp</span><br><span class=\"line\"><span class=\"variable\">$UDPServerRun</span> 514</span><br><span class=\"line\"><span class=\"variable\">$ModLoad</span> imtcp</span><br><span class=\"line\"><span class=\"variable\">$InputTCPServerRun</span> 514</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#### GLOBAL DIRECTIVES ####中加入如下内容：</span></span><br><span class=\"line\"><span class=\"variable\">$template</span> IpTemplate,<span class=\"string\">\"/var/log/%FROMHOST-IP%.log\"</span></span><br><span class=\"line\">*.* ?IpTemplate</span><br><span class=\"line\">&amp; ~</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#说明：实现在接收远程的日志为客户端IP地址命名。</span></span><br><span class=\"line\"><span class=\"comment\">#重新启动rsyslogd服务</span></span><br><span class=\"line\">service rsyslog restart</span><br></pre></td></tr></table></figure></p>\n<p>Linux的rsyslog日志客户端配置：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#vi /etc/rsyslog.conf</span></span><br><span class=\"line\">local1.debug    @@192.168.0.66</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#然后重新启动rsyslogd服务</span></span><br><span class=\"line\">service rsyslog restart</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"0x01-实际案例\"><a href=\"#0x01-实际案例\" class=\"headerlink\" title=\"0x01 实际案例\"></a>0x01 实际案例</h4><h4 id=\"Linux安全运维历史命令记录发往Rsyslog服务器\"><a href=\"#Linux安全运维历史命令记录发往Rsyslog服务器\" class=\"headerlink\" title=\"Linux安全运维历史命令记录发往Rsyslog服务器\"></a>Linux安全运维历史命令记录发往Rsyslog服务器</h4><p>描述：将history 命令记录发往Rsyslog服务器，即将Linux history 记录发往本地/远程Rsyslog 服务器的2种方法。</p>\n<p>syslog日志收集：</p>\n<ul>\n<li>windows: <a href=\"https://github.com/MaxBelkov/visualsyslog/\" target=\"_blank\" rel=\"noopener\">visualsyslog</a></li>\n</ul>\n<p><br></p>\n<h5 id=\"方法1：\"><a href=\"#方法1：\" class=\"headerlink\" title=\"方法1：\"></a>方法1：</h5><p>描述：从bash4.1 版本开始支持Rsyslog，所以我们需要下载bash4.1以后版本修改bash源码支持syslog记录，首先下载bash源码可以从<a href=\"https://ftp.gnu.org/gnu/bash/\" target=\"_blank\" rel=\"noopener\">gnu.org</a>下载,并且系统需要安装gcc等编译环境;</p>\n<p>1.修改两处源码：</p>\n<ul>\n<li>bashhist.c : 这个源码文件和linux history记录处理有关<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#bash_syslog_history 函数里面</span></span><br><span class=\"line\">void bash_syslog_history (line)</span><br><span class=\"line\"><span class=\"keyword\">if</span> (strlen(line) &lt; SYSLOG_MAXLEN) &#123;</span><br><span class=\"line\">  syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, <span class=\"string\">\"HISTORY: PID=%d UID=%d USER=%s CMD=%s\"</span>, getpid(), current_user.uid, current_user.user_name,line);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">  strncpy (trunc, line, SYSLOG_MAXLEN);</span><br><span class=\"line\">  trunc[SYSLOG_MAXLEN - 1] = <span class=\"string\">'\\0'</span>;</span><br><span class=\"line\">  syslog (SYSLOG_FACILITY|SYSLOG_LEVEL, <span class=\"string\">\"HISTORY (TRUNCATED): PID=%d UID=%d USER=%s CMD=%s\"</span>, getpid(), current_user.uid, current_user.user_name,trunc);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#效果</span></span><br><span class=\"line\">HISTORY (TRUNCATED): PPID=%d PID=%d SID=%d UID=%d User=%s %s<span class=\"string\">\", getppid(), getpid(), getsid(getpid()), current_user.uid, current_user.user_name, trunc</span></span><br></pre></td></tr></table></figure></li>\n<li>config-top.h : 设置开启syslog日志<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 里定义syslog的FACILITY为 user (用户级别的日志)级别为info</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SYSLOG_HISTORY</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> defined (SYSLOG_HISTORY)</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"meta-keyword\">define</span> SYSLOG_FACILITY LOG_USER</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"meta-keyword\">define</span> SYSLOG_LEVEL LOG_INFO</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"meta-keyword\">define</span> OPENLOG_OPTS LOG_PID</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> defined (SYSLOG_HISTORY)</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SYSLOG_SHOPT 1</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>2.编译与修改/etc/passwd  修改用户的登录shell （当然也可以直接替换原先的bash）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/bash &amp;&amp; make &amp;&amp; make install </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改用户的默认bash</span></span><br><span class=\"line\">root:x:0:0:root:/root:/usr/<span class=\"built_in\">local</span>/bash/bin/bash</span><br><span class=\"line\">f3:x:1004:1004::/home/f3:/usr/<span class=\"built_in\">local</span>/bash/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#建立软连接</span></span><br><span class=\"line\"><span class=\"variable\">$ln</span> -s /usr/<span class=\"built_in\">local</span>/bash/bin/bash /usr/bin/bash</span><br></pre></td></tr></table></figure></p>\n<p>3.修改/etc/rsyslog.conf最后重启rsyslog<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#将FACILITY为user且日志级别为info的信息发往 远程rsyslog 服务器 10.1.100.1</span></span><br><span class=\"line\">user.info  @@10.1.100.1</span><br></pre></td></tr></table></figure></p>\n<p><em>备注：</em></p>\n<ul>\n<li>此方法可以将其它shell类型禁用，并将bash软件软连接到/bin/sh中</li>\n</ul>\n<p><br></p>\n<h5 id=\"方法2：\"><a href=\"#方法2：\" class=\"headerlink\" title=\"方法2：\"></a>方法2：</h5><p>描述：不修改bash源码，利用trap和logger命令将执行命令记录发往远程Rsyslog 服务器</p>\n<p>1.编辑/etc/profile文件：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># cat &gt;&gt; /etc/profile</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">log2syslog</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"comment\">#过滤PS命令执行(每次执行都有)  或者采用 PROMPT_COMMAND 系统变量代替下面</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"string\">'printf \"\\033]0;%s@%s:%s\\007\" \"$&#123;USER&#125;\" \"$&#123;HOSTNAME%%.*&#125;\" \"$&#123;PWD/#$HOME/~&#125;\"'</span> != <span class=\"string\">\"<span class=\"variable\">$BASH_COMMAND</span>\"</span> ];<span class=\"keyword\">then</span>  </span><br><span class=\"line\">    logger -p user.notice -t bash-$$ -i -n 192.168.1.88 -- <span class=\"string\">\"<span class=\"variable\">$&#123;SSH_CONNECTION&#125;</span> - <span class=\"variable\">$&#123;USER&#125;</span> - <span class=\"variable\">$&#123;PWD&#125;</span> - <span class=\"variable\">$&#123;BASH_COMMAND&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">trap</span> log2syslog DEBUG</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#函数解释一下：</span></span><br><span class=\"line\">我们知道用户登录之后shell 都会执行/etc/profile中的内容在shell中每执行一次命令都是一个activity，`<span class=\"built_in\">trap</span> log2syslog DEBUG`意为对shell中的每一个activity都执行一遍log2syslog 函数</span><br><span class=\"line\"></span><br><span class=\"line\">logger 是一个向syslog发送日志的接口:-p 表示syslog的Facility   -t 表示tag  -n 表示远程syslog 地址    <span class=\"comment\"># 信息之间用— 隔开</span></span><br><span class=\"line\"><span class=\"variable\">$BASH_COMMAND</span> 表示 最新执行的shell命令</span><br><span class=\"line\">$$ 表示当前shell的进程id</span><br><span class=\"line\"><span class=\"variable\">$SSH_CONNECTION</span>   当前ssh连接的tcp socket 五元组信息</span><br><span class=\"line\"><span class=\"variable\">$USER</span> 表示当前执行命令的用户</span><br><span class=\"line\"><span class=\"variable\">$PWD</span> 表示执行命令时所在目录</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>2.vim /etc/rsyslog.conf<br>增加修改配置后<code>user.*  @@192.168.1.88</code>，重启rsyslog <code>service rsyslog restart</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#log日志服务器</span></span><br><span class=\"line\">user.* @@192.168.1.88:514</span><br><span class=\"line\">Aug  2 13:42:35\t10.10.107.222\tmaster\tlocal1\tnotice\tbash-12610[12650]\t192.168.1.88 52965 10.10.107.222 22 - root - /root - grep --color=auto <span class=\"string\">\"12610\"</span></span><br></pre></td></tr></table></figure></p>\n<p><em>注意事项：</em></p>\n<ul>\n<li>logger方法的不足:每记录一条命令日志到远程syslog服务器都会产生一个新的进程，如果命令activity 量很大则相比修改bash源码方式而言比较消耗性能</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"安全建设","path":"api/categories/安全建设.json"}],"tags":[{"name":"日志审计","path":"api/tags/日志审计.json"}]}