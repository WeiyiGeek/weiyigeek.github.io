{"title":"Multipath多路径管理基础介绍与安装配置使用","slug":"基础知识/机器硬件/Storage/Multipath多路径管理基础介绍与安装配置使用","date":"2019-12-26T01:34:30.000Z","updated":"2023-01-31T02:29:10.676Z","url":"2019/12-26-34.html","path":"api/articles/2019/12-26-34.html.json","covers":["https://img.weiyigeek.top/2020/1/20200912205044.png","https://img.weiyigeek.top/2020/1/20200912135557.png","https://img.weiyigeek.top/2020/1/20200913213655.png","https://img-blog.csdnimg.cn/20200616152900412.png","https://img.weiyigeek.top/2020/1/20200912141229.png","https://img.weiyigeek.top/2020/1/20200912142049.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h4><p><strong>Q:什么是Multipath多路径?</strong></p>\n<blockquote>\n<p>答:Multipath I/O 电脑储存技术，指利用两个以上的路径同时在CPU与储存设备之间传送讯号，以达到侦错与强化效能的目的。<br>简单的说当服务器到某一存储设备有多条路径时，每条路径都会识别为一个单独的设备(不便于使用)，而多路径允许您将服务器节点和储存阵列间的多个I/O路径配置为一个单一设备(<code>就是我们所说的链路聚合</code>)即多路径聚合了I/O路径并生成由这些集合路径组成的新设备，这些I/O路径可<code>包含独立电缆、交换器和控制器的实体SAN链接(FC / SAS / iSCSI)</code>等;</p>\n</blockquote>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200912205044.png\" alt=\"WeiyiGeek.多路径图示\" title=\"\" class=\"\">\n                <p>WeiyiGeek.多路径图示</p>\n            </figure>\n<p><br></p>\n<p><strong>工作原理:</strong><br>当因为主机HBA卡、线缆、交换机或者存储设备的RAID控制器故障等原因造成一条物理路径失效时,服务器可以将通过此物理路径的I/O转移到其他正常的物理路径上面,应用程序不会觉察到这种改变，从而提高系统的可用性。</p>\n<p><strong>硬件要求：</strong><br>硬件方面需要服务器有2块或以上的HBA接口卡，网络上有两个或以上的交换机，块存储设备有两个或以上的冗余控制器，各个物理路径之间没有任何硬件相互依赖。多路径冗余I/O也可以实现I/O的负载均衡，提高系统性能，但主要还是一种容错机制。</p>\n<p><br/></p>\n<p><strong>Q:它有什么用?</strong></p>\n<ul>\n<li>冗余: 主备模式，高可用;</li>\n<li>性能优化: 主主模式，负载均衡;</li>\n</ul>\n<p><br/></p>\n<p><strong>Q: 如何使用Multipath?</strong><br>描述: 可以参照下面的章节并存在相应的测试环境进行实践，常见三种情况会使用到比如有存储设备并且与主机通过(<code>FC-光纤线、SAS-线缆、以太网-六类线</code>)进行直连;<br>其应用场景:</p>\n<ul>\n<li>1.针对于块存储磁盘多路径IO设备</li>\n<li>2.使用在Oracle的ASM环境中</li>\n</ul>\n<p><br/></p>\n<h5 id=\"多路径技术\"><a href=\"#多路径技术\" class=\"headerlink\" title=\"多路径技术\"></a>多路径技术</h5><p>描述:实现的核心通过存储设备去适配操作系统，从而实现多路径技术，支持ALUA是其中主要部分。</p>\n<h6 id=\"1-ALUA\"><a href=\"#1-ALUA\" class=\"headerlink\" title=\"1.ALUA\"></a>1.ALUA</h6><p>描述：ALUA多路径技术(Asymmetric Logical Unit Access-非对称逻辑单元存取),其提供了一个路径发现和确定优先次序的标准化机制，<code>实现主机和存储设备的路径自协商和动态管理</code>。</p>\n<p>特点：对于特定的LUN来说，在它的路径中，一个控制器的目标端口处于<code>主动/优化</code>状态，另一个控制器的目标端口处<code>于主动/非优</code>状态。在某一个时刻，某个LUN只是属于某一个控制器，要想实现两边的负载均衡，就是将任务A扔给控制器A，将任务B扔给控制器B，<code>对于同一个任务来说任何时候只有一个控制器在控制</code>。</p>\n<h6 id=\"2-SLUA\"><a href=\"#2-SLUA\" class=\"headerlink\" title=\"2.SLUA\"></a>2.SLUA</h6><p>描述:SLUA多路径技术(Symmetric Logical Unit Access-对称逻辑单元存取)别名对称镜像卷，它是多路径的基本特性。<br>特点：对于特定的LUN来说，在它的路径中两个存储控制器的目标端口<code>均处于主动/优化</code>状态。两个控制器之间实现高速互联的通讯，一个IO发到控制器端，两个控制器可同时参与处理；<code>当一个控制器繁忙系统时候不需要主机端的负载均衡软件参与就可以自动实现负载均衡</code>。</p>\n<p><strong>SLUA与ALUA对比:</strong></p>\n<ul>\n<li>前者: 双主/优化, 一个LUN可以属于两个控制器负载均衡、同一个RAID上的不同LUN组可以跨控制器，LUN跨控制器迁移不影响应用、带宽加倍1秒自动切换;</li>\n<li>后者: 双主/非优化，同一个LUN归属某一个控制器，双控之间不可自动实现负载均衡，并且切换时间一般为十几秒;</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200912135557.png\" alt=\"WeiyiGeek.多路径技术\" title=\"\" class=\"\">\n                <p>WeiyiGeek.多路径技术</p>\n            </figure>\n<p><br/></p>\n<h5 id=\"名词解析\"><a href=\"#名词解析\" class=\"headerlink\" title=\"名词解析\"></a>名词解析</h5><h6 id=\"1-DM-Multipath-多路径设备\"><a href=\"#1-DM-Multipath-多路径设备\" class=\"headerlink\" title=\"1.DM Multipath - 多路径设备\"></a>1.DM Multipath - 多路径设备</h6><p>描述:若不采用 DM Multipath 那么从服务器节点到储存控制器的每一条路径都会被系统视为独立的设备，即使I/O路径连接的是相同的服务器节点到相同的储存控制器也是如此, <code>DM Multipath</code>提供了有逻辑的管理I/O路径的方法，即在基础设备顶端生成单一多路径设备;</p>\n<h6 id=\"2-WWID-全球识别符\"><a href=\"#2-WWID-全球识别符\" class=\"headerlink\" title=\"2.WWID - 全球识别符\"></a>2.WWID - 全球识别符</h6><p>描述:每个多路径设备都有一个WWID（全球识别符），它是全球唯一的无法更改的号码, <code>默认情况下会将多路径设备的名称设定为它的WWID</code>, 可以在多路径配置文件(<code>/etc/multipath.conf</code>)中设置<code>user_friendly_names</code>选项，该选项可将别名设为格式为mpathn的节点唯一名称也可以也可以自定义存储设备名称;</p>\n<p>示例.查看设备的 scsi id 即WWID查看, 获取 iscsi 共享盘的 wwid 全球唯一识别号三种方式<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.扫描SCSI设备号命令</span></span><br><span class=\"line\">$/usr/lib/udev/scsi_id -u -g /dev/mapper/asm08  <span class=\"comment\">#去掉空格--replace-whitespace</span></span><br><span class=\"line\">360050768xxx000000010d2</span><br><span class=\"line\">$/usr/lib/udev/scsi_id --whitelisted --device=/dev/sdb</span><br><span class=\"line\">36000d3100366e600000000000000001c</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /etc/multipath/wwids</span><br><span class=\"line\"><span class=\"comment\"># Valid WWIDs:</span></span><br><span class=\"line\">/36000d3100366e600000000000000001c/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式3</span></span><br><span class=\"line\"><span class=\"variable\">$multipath</span> -ll | grep <span class=\"string\">\"mpath\"</span></span><br><span class=\"line\">mpatha (36000d3100366e600000000000000001c) dm-0 COMPELNT,Compellent Vol</span><br></pre></td></tr></table></figure></p>\n<p>示例2.自定义存储设备名称;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/multipath.conf</span></span><br><span class=\"line\"><span class=\"comment\"># 方式1</span></span><br><span class=\"line\">defaults &#123;</span><br><span class=\"line\">  user_friendly_names yes</span><br><span class=\"line\">  ....</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 结果</span></span><br><span class=\"line\"><span class=\"variable\">$multipath</span> -ll</span><br><span class=\"line\"><span class=\"comment\"># mpatha (36000d3100366e600000000000000001c) dm-0 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=500G features='1 queue_if_no_path' hwhandler='1 alua' wp=rw</span></span><br><span class=\"line\"><span class=\"comment\"># `-+- policy='service-time 0' prio=25 status=enabled</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 4:0:0:1 sdb 8:16 active ready running</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 4:0:0:2 sdc 3:32 active ready running</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> -alh /dev/mapper/mpatha-part1</span><br><span class=\"line\"><span class=\"comment\"># lrwxrwxrwx 1 root root 7 Sep  8  2020 /dev/mapper/mpatha-part1 -&gt; ../dm-0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----------------------------------------------------------  #</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2:绑定后需重新生成路径的映射表</span></span><br><span class=\"line\">multipaths &#123;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid  <span class=\"string\">\"36000d3100366e600000000000000001c\"</span></span><br><span class=\"line\">    <span class=\"built_in\">alias</span> k8sapp</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 结果</span></span><br><span class=\"line\"><span class=\"variable\">$multipath</span> -v2</span><br><span class=\"line\"><span class=\"variable\">$multipath</span> -ll</span><br><span class=\"line\"><span class=\"comment\"># k8sapp (36000d3100366e600000000000000001c) dm-0 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=1.0T features='1 queue_if_no_path' hwhandler='1 alua' wp=rw</span></span><br><span class=\"line\"><span class=\"comment\"># -+- policy='service-time 0' prio=25 status=active</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 5:0:8:1 sdb 8:16 active ready running</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 5:0:9:1 sdc 8:32 failed ready running</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> -alh /dev/mapper/k8sapp </span><br><span class=\"line\"><span class=\"comment\"># lrwxrwxrwx 1 root root 7 Sep  8  2020 /dev/mapper/k8sapp  -&gt; ../dm-0</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h6 id=\"3-scsi-id-设备id\"><a href=\"#3-scsi-id-设备id\" class=\"headerlink\" title=\"3.scsi_id - 设备id\"></a>3.scsi_id - 设备id</h6><p>描述:其包含在udev程序包中，可以在multipath.conf中配置该程序来获取scsi设备的序号。通过序号便可以判断多个路径对应了同一设备。这个是多路径实现的关键。<br>multipath程序在创建multipath设备时，会调用scsi_id，从其标准输出中获得该设备的scsi id。在改写时需要修改scsi_id程序的返回值为0。因为在multipath程序中，会检查该值来确定scsi id是否已经成功得到。</p>\n<p><br/></p>\n<h6 id=\"4-多路径聚合和映射\"><a href=\"#4-多路径聚合和映射\" class=\"headerlink\" title=\"4.多路径聚合和映射\"></a>4.多路径聚合和映射</h6><p>Q:什么是存储的多路径聚合和映射?<br>Linux 主机上通过外接 FC / SAS 到物理存储设备时，一般都会在主机上加装HBA卡，<code>HBA卡通过WWN号连接光纤交换机或直接存储</code>。如果HBA卡出问题需要更换时，WWN号相应的也会改变，中间的这个纽带相当于断了，就无法正常识别存储磁盘分区。<br>当然有些HBA上面贴的有WWN号，可以在更换HBA卡之前在光交或存储上更换相应的配置。不过很多没有标这个WWN所以需要非常，建议更换后到系统下通过命令查看新识别的WWN号确认以下即可。</p>\n<p>主机上HBA卡WWN号查看<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># FC SAN</span></span><br><span class=\"line\">cat /sys/class/fc_host/host*/port_name</span><br><span class=\"line\">0x2002d0431efb7f5d  <span class=\"comment\">#HBA卡WWN号</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># SAS SAN</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /sys/class/sas_phy/phy-*/sas_address|sort|uniq</span><br><span class=\"line\">0x51866da091944100  <span class=\"comment\">#HBA卡WWN号</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200913213655.png\" alt=\"WeiyiGeek.服务器HBA标识\" title=\"\" class=\"\">\n                <p>WeiyiGeek.服务器HBA标识</p>\n            </figure></p>\n<hr>\n<h4 id=\"0x01-Multipath-管理\"><a href=\"#0x01-Multipath-管理\" class=\"headerlink\" title=\"0x01 Multipath 管理\"></a>0x01 Multipath 管理</h4><p>描述:对于存储设备创建的LUN卷以及映射分配给服务器后往往有多个控制器进行冗余，刷新scsi设备后你将会在服务器中查看到多个/dev/sd[b-z]磁盘设备，此时需要采用多路径软件进行聚合链路，使原本有多个SCSI磁盘的磁盘挂载到本地时候聚合为一个设备；注意这与您的存储设备息息相关大多数存储连接到Linux主机上可以使用multipath自带的多路径软件，然而向Huawei的存储则需要单独安装一个第三方的多路径软件才行;</p>\n<h5 id=\"Linux-Multipath\"><a href=\"#Linux-Multipath\" class=\"headerlink\" title=\"Linux - Multipath\"></a>Linux - Multipath</h5><p>描述：在linux中开源的multipath工具是用来进行多路径IO管理，当一条链路不稳定时可自动切换到另一条链路，当然要使用多路径设备就必须安装相对应的multipath软件；</p>\n<p><strong>Multipath 安装&amp;启动</strong><br>备注:CentOS 7.8 / Ubuntu 20.04 tls 自带无需安装<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># CentOS </span></span><br><span class=\"line\">rpm -qa | grep <span class=\"string\">\"multipath\"</span>           <span class=\"comment\"># 查看系统是否安装</span></span><br><span class=\"line\">yum install device-mapper-multipath  </span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> multipathd || chkconfig multipathd on  <span class=\"comment\"># 启用多路径软件开机自启</span></span><br><span class=\"line\">systemctl start multipathd || service multipathd status <span class=\"comment\"># 启动multipath多路径服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ubuntu</span></span><br><span class=\"line\">apt list | grep <span class=\"string\">\"multipath\"</span> <span class=\"comment\"># 查看系统是否安装</span></span><br><span class=\"line\"><span class=\"comment\"># multipath-tools-boot/focal 0.8.3-1ubuntu2 all</span></span><br><span class=\"line\"><span class=\"comment\"># multipath-tools/focal,now 0.8.3-1ubuntu2 amd64 [installed,automatic]</span></span><br><span class=\"line\">apt-get install multipath-tools</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> multipathd &amp;&amp; systemctl start multipathd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 软件包说明</span></span><br><span class=\"line\">(1) device-mapper-multipath：即multipath-tools。主要提供multipathd和multipath等工具和 multipath.conf等配置文件。创建的多路径设备会在/dev/mapper中。</span><br><span class=\"line\">(2) device-mapper：主要包括两大部分内核部分和用户部分。</span><br><span class=\"line\">  * 内核部分主要包括device mapper核心(dm.ko)和一些target driver(md-multipath.ko)。核心完成设备的映射，而target根据映射关系和自身特点具体处理从mappered device 下来的i/o。</span><br><span class=\"line\">  * 用户空间部分主要包括device-mapper这个包。其中包括dmsetup工具和一些帮助创建和配置mappered device的库。这些库主要抽象，封装了与ioctr通信的接口，以便方便创建和配置mappered device。multipath-tool的程序中就需要调用这些库。</span><br><span class=\"line\">(3) dm-multipath.ko和dm.ko：dm.ko是device mapper驱动。它是实现multipath的基础dm-multipath其实是dm的一个target驱动。</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img-blog.csdnimg.cn/20200616152900412.png\" alt=\"redhat.multipath\" title=\"\" class=\"\">\n                <p>redhat.multipath</p>\n            </figure>\n<p><br></p>\n<p><strong>接口驱动查看</strong></p>\n<ul>\n<li><p>1.针对于 FC SAN 多路径块存储卷磁盘</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 存储上将LUN映射给需要的主机,然后查看主机或者存储交换机上的wwn号</span></span><br><span class=\"line\">cat /sys/class/fc_host/host*/port_name</span><br><span class=\"line\">0x2002d0431efb7f5d  <span class=\"comment\">#HBA卡WWN号标识</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>2.针对于 SAS SAN 多路径块存储卷磁盘</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) SAS HBA卡wwn标识号标识</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /sys/class/sas_host/host5/device/phy-*/sas_phy/phy-*/sas_address|sort|uniq</span><br><span class=\"line\"><span class=\"variable\">$cat</span> /sys/class/sas_phy/phy-*/sas_address|sort|uniq</span><br><span class=\"line\">0x51866da091944100</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) SAS-HBA卡驱动查看  </span></span><br><span class=\"line\"><span class=\"variable\">$lspci</span> | grep LSI</span><br><span class=\"line\">01:00.0 RAID bus controller: Broadcom / LSI MegaRAID SAS-3 3108 [Invader] (rev 02)</span><br><span class=\"line\">04:00.0 Serial Attached SCSI controller: Broadcom / LSI SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span><br><span class=\"line\"><span class=\"comment\"># 系统块设备查看</span></span><br><span class=\"line\"><span class=\"variable\">$ll</span> /sys/block/ | grep 04:00.0</span><br><span class=\"line\">lrwxrwxrwx  1 root root 0 Sep 11 16:57 sdb -&gt; ../devices/pci0000:00/0000:00:02.0/0000:04:00.0/host4/port-4:2/end_device-4:2/target4:0:2/4:0:2:1/block/sdb/</span><br><span class=\"line\">lrwxrwxrwx  1 root root 0 Sep 11 16:57 sdc -&gt; ../devices/pci0000:00/0000:00:02.0/0000:04:00.0/host4/port-4:2/end_device-4:2/target4:0:2/4:0:2:2/block/sdc/</span><br><span class=\"line\">lrwxrwxrwx  1 root root 0 Sep 11 15:15 sdd -&gt; ../devices/pci0000:00/0000:00:02.0/0000:04:00.0/host4/port-4:1/end_device-4:1/target4:0:1/4:0:1:1/block/sdd/</span><br><span class=\"line\">lrwxrwxrwx  1 root root 0 Sep 11 15:15 sde -&gt; ../devices/pci0000:00/0000:00:02.0/0000:04:00.0/host4/port-4:1/end_device-4:1/target4:0:1/4:0:1:2/block/sde/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) systool 命令:http://fibrevillage.com/storage/61-systool-a-useful-tool-for-san-as-well-for-sysfs-devices</span></span><br><span class=\"line\"><span class=\"variable\">$apt</span> install sysfsutils</span><br><span class=\"line\"><span class=\"variable\">$systool</span> -c sas_host -v</span><br><span class=\"line\"><span class=\"comment\"># Class = \"sas_host\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Class Device = \"host5\"</span></span><br><span class=\"line\"><span class=\"comment\"># Class Device path = \"/sys/devices/pci0000:00/0000:00:02.0/0000:04:00.0/host5/sas_host/host5\"</span></span><br><span class=\"line\"><span class=\"comment\"># uevent              =</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Device = \"host5\"</span></span><br><span class=\"line\"><span class=\"comment\"># Device path = \"/sys/devices/pci0000:00/0000:00:02.0/0000:04:00.0/host5\"</span></span><br><span class=\"line\"><span class=\"comment\"># uevent              = \"DEVTYPE=scsi_host\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>3.针对于 iSCSI 块存储磁盘</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 暂代补充</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p><strong>磁盘SCSI设备扫描添加与卸载</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) SCSI存储设备扫描</span></span><br><span class=\"line\"><span class=\"comment\"># 方式1:</span></span><br><span class=\"line\"><span class=\"comment\"># yum install –y sg3_utils</span></span><br><span class=\"line\">$ sudo rescan-scsi-bus.sh <span class=\"comment\">#/usr/bin/rescan-scsi-bus.sh</span></span><br><span class=\"line\">Scanning SCSI subsystem <span class=\"keyword\">for</span> new devices</span><br><span class=\"line\">Scanning host 0 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\"> Scanning <span class=\"keyword\">for</span> device 0 2 0 0 ...</span><br><span class=\"line\">OLD: Host: scsi0 Channel: 02 Id: 00 Lun: 00</span><br><span class=\"line\">      Vendor: DELL     Model: PERC H730 Mini   Rev: 4.27</span><br><span class=\"line\">      Type:   Direct-Access                    ANSI SCSI revision: 05</span><br><span class=\"line\">Scanning host 1 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\"> Scanning <span class=\"keyword\">for</span> device 1 0 0 1 ...</span><br><span class=\"line\">OLD: Host: scsi1 Channel: 00 Id: 00 Lun: 01</span><br><span class=\"line\">      Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span><br><span class=\"line\">      Type:   Direct-Access                    ANSI SCSI revision: 05</span><br><span class=\"line\">sg2 changed: LU not available (PQual 1)</span><br><span class=\"line\">OLD: Host: scsi1 Channel: 00 Id: 00 Lun: 02</span><br><span class=\"line\">      Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span><br><span class=\"line\">      Type:   Direct-Access                    ANSI SCSI revision: 05</span><br><span class=\"line\"> Scanning <span class=\"keyword\">for</span> device 1 0 1 1 ...</span><br><span class=\"line\">OLD: Host: scsi1 Channel: 00 Id: 01 Lun: 01</span><br><span class=\"line\">      Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span><br><span class=\"line\">      Type:   Direct-Access                    ANSI SCSI revision: 05</span><br><span class=\"line\">sg4 changed: LU not available (PQual 1)</span><br><span class=\"line\">OLD: Host: scsi1 Channel: 00 Id: 01 Lun: 02</span><br><span class=\"line\">      Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span><br><span class=\"line\">      Type:   Direct-Access                    ANSI SCSI revision: 05</span><br><span class=\"line\">Scanning host 2 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 3 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 4 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 5 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 6 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 7 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 8 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 9 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 10 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\">Scanning host 11 <span class=\"keyword\">for</span>  SCSI target IDs  0 1 2 3 4 5 6 7, all LUNs</span><br><span class=\"line\"> Scanning <span class=\"keyword\">for</span> device 11 0 0 0 ...</span><br><span class=\"line\">OLD: Host: scsi11 Channel: 00 Id: 00 Lun: 00</span><br><span class=\"line\">      Vendor: PLDS     Model: DVD+-RW DU-8A5LH Rev: 6D51</span><br><span class=\"line\">      Type:   CD-ROM                           ANSI SCSI revision: 05</span><br><span class=\"line\">.0 new or changed device(s) found.</span><br><span class=\"line\">0 remapped or resized device(s) found.</span><br><span class=\"line\">0 device(s) removed.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2：如果更换HBA卡或者添加了新的LUN卷块存储则需要重新扫盘</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> /sys/class/scsi_host/*; <span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"string\">\"- - -\"</span> &gt; <span class=\"variable\">$i</span>/scan; <span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"comment\"># Tips:某些存储或系统没有scan文件，可以通issue_lip文件识别</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"1\"</span> &gt; /sys/class/fc_host/host4/issue_lip  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看存储设备是否映射到主机LUN卷存储是否被添加到本地</span></span><br><span class=\"line\">$ fdisk -l | grep <span class=\"string\">\"/dev\"</span></span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/sde: 1 TiB, 1099511627776 bytes, 2147483648 sectors</span></span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/sdd: 1.2 TiB, 1319413953024 bytes, 2576980377 sectors</span></span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/mapper/k8sapp: 1.2 TiB, 1319413953024 bytes, 2576980377 sectors</span></span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/mapper/k8slog: 1 TiB, 1099511627776 bytes, 2147483648 sectors</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ lsblk</span><br><span class=\"line\"><span class=\"comment\"># sdb        8:16   0  1.2T  0 disk</span></span><br><span class=\"line\"><span class=\"comment\"># └─k8sapp 253:0    0  1.2T  0 mpath /mnt/nfs/k8sapp</span></span><br><span class=\"line\"><span class=\"comment\"># sdc        8:32   0    1T  0 disk</span></span><br><span class=\"line\"><span class=\"comment\"># └─k8slog 253:1    0    1T  0 mpath /mnt/nfs/k8slog</span></span><br><span class=\"line\"><span class=\"comment\"># sdd        8:48   0  1.2T  0 disk</span></span><br><span class=\"line\"><span class=\"comment\"># └─k8sapp 253:0    0  1.2T  0 mpath /mnt/nfs/k8sapp</span></span><br><span class=\"line\"><span class=\"comment\"># sde        8:64   0    1T  0 disk</span></span><br><span class=\"line\"><span class=\"comment\"># └─k8slog 253:1    0    1T  0 mpath /mnt/nfs/k8slog</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /proc/partitions <span class=\"comment\"># 分区信息带有(major|minor)</span></span><br><span class=\"line\">major minor  <span class=\"comment\">#blocks  name</span></span><br><span class=\"line\">   7        0      56648 loop0</span><br><span class=\"line\">   7        1      72256 loop1</span><br><span class=\"line\">   7        2      30600 loop2</span><br><span class=\"line\">   7        3      72984 loop3</span><br><span class=\"line\">   7        4      30608 loop4</span><br><span class=\"line\">   7        5      56276 loop5</span><br><span class=\"line\">   8        0 1170997248 sda</span><br><span class=\"line\">   8        1       1024 sda1</span><br><span class=\"line\">   8        2  524288000 sda2</span><br><span class=\"line\">   8        3    4194304 sda3</span><br><span class=\"line\">   8        4   10485760 sda4</span><br><span class=\"line\">   8        5  629145600 sda5</span><br><span class=\"line\">   8       64 1073741824 sde</span><br><span class=\"line\">   8       48 1288490188 sdd</span><br><span class=\"line\">  11        0    1048575 sr0</span><br><span class=\"line\"> 253        0 1288490188 dm-0</span><br><span class=\"line\"> 253        1 1073741824 dm-1</span><br><span class=\"line\">   8       32 1073741824 sdc</span><br><span class=\"line\">   8       16 1288490188 sdb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 众所周知SATA和SCSI是支持热插拔的,通过存储设备直连的LUN到服务器时候，系统不能自动识别往往需要重启系统来识别，但是有另外一种方法可以很方面的让系统识别新的设备，即通过`/proc/scsi/scsi`使系统识别新的驱动器</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"scsi add-single-device w x y z\"</span> &gt; /proc/scsi/scsi</span><br><span class=\"line\"><span class=\"comment\"># 为使该命令正常运行，必须指定正确的参数值 w、x、y 和 z，如下所示：</span></span><br><span class=\"line\"><span class=\"comment\"># w 是主机适配器标识，第一个适配器为零(0)</span></span><br><span class=\"line\"><span class=\"comment\"># x 是主机适配器上的 SCSI 通道，第一个通道为零(0)</span></span><br><span class=\"line\"><span class=\"comment\"># y 是设备的 SCSI 标识</span></span><br><span class=\"line\"><span class=\"comment\"># z 是 LUN 号，第一个 LUN 为零(0)</span></span><br><span class=\"line\"></span><br><span class=\"line\">例如:从rescan-scsi-bus.sh执行中获得设备参数值 Scanning <span class=\"keyword\">for</span> device 1 0 0 1</span><br><span class=\"line\"><span class=\"comment\"># 添加硬盘并查看</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"scsi add-single-device 1 0 0 0\"</span> &gt;/proc/scsi/scsi &amp;&amp; fdisk -l</span><br><span class=\"line\"><span class=\"comment\"># 删除硬盘并查看(确保首先卸下的磁盘设备从系统中umount)</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"scsi remove-single-device 0 0 1 0\"</span> &gt;/proc/scsi/scsi &amp;&amp; fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /proc/scsi/scsi</span><br><span class=\"line\"><span class=\"comment\"># Attached devices:</span></span><br><span class=\"line\"><span class=\"comment\"># Host: scsi0 Channel: 02 Id: 00 Lun: 00</span></span><br><span class=\"line\"><span class=\"comment\">#   Vendor: DELL     Model: PERC H730 Mini   Rev: 4.27</span></span><br><span class=\"line\"><span class=\"comment\">#   Type:   Direct-Access                    ANSI  SCSI revision: 05</span></span><br><span class=\"line\"><span class=\"comment\"># Host: scsi4 Channel: 00 Id: 01 Lun: 01     # 例如:device ID = 4 0 1 1</span></span><br><span class=\"line\"><span class=\"comment\">#   Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span></span><br><span class=\"line\"><span class=\"comment\">#   Type:   Direct-Access                    ANSI  SCSI revision: 05</span></span><br><span class=\"line\"><span class=\"comment\"># Host: scsi4 Channel: 00 Id: 01 Lun: 02     # 例如:device ID = 4 0 1 2</span></span><br><span class=\"line\"><span class=\"comment\">#   Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span></span><br><span class=\"line\"><span class=\"comment\">#   Type:   Direct-Access                    ANSI  SCSI revision: 05</span></span><br><span class=\"line\"><span class=\"comment\"># Host: scsi11 Channel: 00 Id: 00 Lun: 00  </span></span><br><span class=\"line\"><span class=\"comment\">#   Vendor: PLDS     Model: DVD+-RW DU-8A5LH Rev: 6D51</span></span><br><span class=\"line\"><span class=\"comment\">#   Type:   CD-ROM                           ANSI  SCSI revision: 05</span></span><br><span class=\"line\"><span class=\"comment\"># Host: scsi4 Channel: 00 Id: 02 Lun: 01     # 例如:device ID = 4 0 2 2</span></span><br><span class=\"line\"><span class=\"comment\">#   Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span></span><br><span class=\"line\"><span class=\"comment\">#   Type:   Direct-Access                    ANSI  SCSI revision: 05</span></span><br><span class=\"line\"><span class=\"comment\"># Host: scsi4 Channel: 00 Id: 02 Lun: 02     # 例如:device ID = 4 0 2 2</span></span><br><span class=\"line\"><span class=\"comment\">#   Vendor: COMPELNT Model: Compellent Vol   Rev: 0701</span></span><br><span class=\"line\"><span class=\"comment\">#   Type:   Direct-Access                    ANSI  SCSI revision: 05</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>multipath 配置和使用</strong></p>\n<ul>\n<li>案例1.SAS FAN 多路径<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 多路径自动处理可载入模块</span></span><br><span class=\"line\">modprobe dm-multipath    <span class=\"comment\"># 初始化DM</span></span><br><span class=\"line\">modprobe dm-round-robin</span><br><span class=\"line\">lsmod | grep multipath   <span class=\"comment\"># 查看 </span></span><br><span class=\"line\"><span class=\"comment\"># dm_multipath           32768  4 dm_round_robin,dm_service_time</span></span><br><span class=\"line\"><span class=\"comment\"># multipath              20480  0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 查看当前系统下各磁盘分区</span></span><br><span class=\"line\">root@ubuntu:/mnt/ww<span class=\"comment\"># fdisk -l | egrep \"^/dev\"</span></span><br><span class=\"line\"><span class=\"comment\"># 比如 /dev/mapper/xxxxx 的磁盘可能是逻辑卷(LVM)或者多路径(Multipath)</span></span><br><span class=\"line\">Disk /dev/mapper/mpatha-part1  4096 0 2576980377  1.2T Linux filesystem</span><br><span class=\"line\">Disk /dev/mapper/mpatha-part2  4096 0 2147483648  1T Linux filesystem</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 查看当前系统下是否存在逻辑卷在进行判别;</span></span><br><span class=\"line\"><span class=\"variable\">$lvdisplay</span></span><br><span class=\"line\"><span class=\"comment\"># 或者采用以下命令分区以及逻辑卷一目了然</span></span><br><span class=\"line\"><span class=\"variable\">$lvmdiskscan</span></span><br><span class=\"line\">dev/loop0                [      55.32 MiB]</span><br><span class=\"line\">/dev/mapper/mpatha-part1 [      &lt;1.20 TiB]</span><br><span class=\"line\">/dev/loop1               [      70.56 MiB]</span><br><span class=\"line\">/dev/mapper/mpatha-part2 [       1.00 TiB]</span><br><span class=\"line\">/dev/loop2         [      29.88 MiB]</span><br><span class=\"line\">/dev/sda2          [     500.00 GiB]</span><br><span class=\"line\">/dev/loop3         [      71.27 MiB]</span><br><span class=\"line\">/dev/sda3          [       4.00 GiB]</span><br><span class=\"line\">/dev/loop4         [      29.89 MiB]</span><br><span class=\"line\">/dev/sda4          [      10.00 GiB]</span><br><span class=\"line\">/dev/loop5         [     &lt;54.96 MiB]</span><br><span class=\"line\">/dev/sda5          [     600.00 GiB]</span><br><span class=\"line\">2 disks</span><br><span class=\"line\">10 partitions</span><br><span class=\"line\">0 LVM physical volume whole disks</span><br><span class=\"line\">0 LVM physical volumes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 查看当前系统下是否存在多路径磁盘多路径一般的 /dev/mapper/xxxx 链接到一个磁盘 /dev/dm-x 的块设备文件</span></span><br><span class=\"line\">$ ls -alh /dev/mapper/mpatha-part1</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Sep  8  2020 /dev/mapper/mpatha-part1 -&gt; ../dm-1</span><br><span class=\"line\">$ multipath -ll </span><br><span class=\"line\"><span class=\"comment\"># mpatha (36000d3100366e6000000000000000020) dm-1 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=1.0T features='1 queue_if_no_path' hwhandler='1 alua' wp=rw</span></span><br><span class=\"line\"><span class=\"comment\"># `-+- policy='service-time 0' prio=25 status=active</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 4:0:1:2 sde 8:64 failed ready running   # 未挂载的时候显示failed</span></span><br><span class=\"line\"><span class=\"comment\">#   `- 4:0:2:2 sdc 8:32 active ready running</span></span><br><span class=\"line\"><span class=\"comment\"># mpathb (36000d3100366e6000000000000000021) dm-0 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=1.2T features='1 queue_if_no_path' hwhandler='1 alua' wp=rw</span></span><br><span class=\"line\"><span class=\"comment\"># `-+- policy='service-time 0' prio=25 status=active</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 4:0:1:1 sdd 8:48 failed ready running</span></span><br><span class=\"line\"><span class=\"comment\">#   `- 4:0:2:1 sdb 8:16 active ready running</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) multipath.conf 配置</span></span><br><span class=\"line\">blacklist &#123;</span><br><span class=\"line\">  devnode <span class=\"string\">\"^(ram|raw|loop|fd|md|dm-|sr|scd|st|sda)[0-9]*\"</span>  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">defaults &#123;</span><br><span class=\"line\">  user_friendly_names yes  <span class=\"comment\"># 磁盘名称友好显示</span></span><br><span class=\"line\">  path_grouping_policy multibus</span><br><span class=\"line\">  failback immediate</span><br><span class=\"line\">  no_path_retry fail</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 在/etc/multipath.conf中可以配置设备scsi id和设备路径形成绑定</span></span><br><span class=\"line\">multipaths &#123;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid  <span class=\"string\">\"36000d3100366e6000000000000000021\"</span></span><br><span class=\"line\">    <span class=\"built_in\">alias</span> k8sapp</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid <span class=\"string\">\"36000d3100366e6000000000000000020\"</span></span><br><span class=\"line\">    <span class=\"built_in\">alias</span> k8slog</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) multipath 操作(重新加载配置文件并合并路径)</span></span><br><span class=\"line\">systemctl restart multipathd &amp;&amp; systemctl status multipathd  <span class=\"comment\"># 重启与查看多路径服务启用状态</span></span><br><span class=\"line\">multipath -F    <span class=\"comment\"># 删除现有链路</span></span><br><span class=\"line\">multipath -v2   <span class=\"comment\"># 打印创建或修改的多路径映射的拓扑即多路径设备相关信息</span></span><br><span class=\"line\">multipath -v3   <span class=\"comment\"># 查看多路径 blacklist、whitelist和设备wwid</span></span><br><span class=\"line\">multipath -ll   <span class=\"comment\"># 查看当前系统的多路径拓扑</span></span><br><span class=\"line\"><span class=\"comment\"># k8slog (36000d3100366e6000000000000000020) dm-1 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=1.0T features='1 queue_if_no_path' hwhandler='1 alua' wp=rw</span></span><br><span class=\"line\"><span class=\"comment\"># `-+- policy='service-time 0' prio=25 status=active</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 4:0:1:2 sde 8:64 active ready running</span></span><br><span class=\"line\"><span class=\"comment\">#   `- 4:0:2:2 sdc 8:32 active ready running</span></span><br><span class=\"line\"><span class=\"comment\"># k8sapp (36000d3100366e6000000000000000021) dm-0 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=1.2T features='1 queue_if_no_path' hwhandler='1 alua' wp=rw</span></span><br><span class=\"line\"><span class=\"comment\"># `-+- policy='service-time 0' prio=25 status=active</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 4:0:1:1 sdd 8:48 active ready running</span></span><br><span class=\"line\"><span class=\"comment\">#   `- 4:0:2:1 sdb 8:16 active ready running</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从上面的信息可以看出multipat获取到了2个路径`实际设备sde/虚拟设备sdc`设备聚合成为一个k8slog磁盘设备名称，k8slog是多路径映射名称，指向dm-1它是block设备。</span></span><br><span class=\"line\"><span class=\"comment\"># 而 /dev/mapper/k8sapp 与 /dev/dm-1实际上指向的同一个设备</span></span><br><span class=\"line\">/usr/lib/udev/scsi_id -g /dev/dm-1</span><br><span class=\"line\">36000d3100366e6000000000000000020</span><br><span class=\"line\">/usr/lib/udev/scsi_id -g /dev/mapper/k8sapp</span><br><span class=\"line\">36000d3100366e6000000000000000021</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (6) 多路径设备磁盘分区与格式</span></span><br><span class=\"line\"><span class=\"comment\"># 此处由于使用的磁盘无需分区着就使用设备的全部控制，但是注意如果磁盘大于2T则需要采用parted命令进行磁盘分区;</span></span><br><span class=\"line\">$ mkfs.xfs /dev/mapper/k8sapp </span><br><span class=\"line\">$ mkfs.xfs /dev/mapper/k8slog</span><br><span class=\"line\">$ fdisk -l</span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/mapper/k8sapp: 1.2 TiB, 1319413953024 bytes, 2576980377 sectors</span></span><br><span class=\"line\"><span class=\"comment\"># Units: sectors of 1 * 512 = 512 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># Sector size (logical/physical): 512 bytes / 4096 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># I/O size (minimum/optimal): 2097152 bytes / 2097152 bytes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/mapper/k8slog: 1 TiB, 1099511627776 bytes, 2147483648 sectors</span></span><br><span class=\"line\"><span class=\"comment\"># Units: sectors of 1 * 512 = 512 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># Sector size (logical/physical): 512 bytes / 4096 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># I/O size (minimum/optimal): 2097152 bytes / 2097152 bytes</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (7) 查看dm-1 、dm-2设备的uuid</span></span><br><span class=\"line\"><span class=\"variable\">$ls</span> -alh /dev/disk/by-uuid/</span><br><span class=\"line\">lrwxrwxrwx 1 root root  10 Sep 12 23:23 40fd2fd5-997f-4266-a0c8-95c0e534a23b -&gt; ../../dm-1</span><br><span class=\"line\">lrwxrwxrwx 1 root root  10 Sep 12 23:23 acccde8a-16b2-4a87-a8da-0ba2c72aa688 -&gt; ../../dm-0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (8) 挂载多路径设备到文件系统中(推荐采用UUID进行挂载)</span></span><br><span class=\"line\"><span class=\"comment\"># k8sapp</span></span><br><span class=\"line\">/dev/disk/by-uuid/acccde8a-16b2-4a87-a8da-0ba2c72aa688 /mnt/nfs/k8sapp xfs defaults 0 0</span><br><span class=\"line\"><span class=\"comment\"># k8slog</span></span><br><span class=\"line\">/dev/disk/by-uuid/40fd2fd5-997f-4266-a0c8-95c0e534a23b /mnt/nfs/k8slog xfs defaults 0 0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (9) 查看挂载的多路径设备</span></span><br><span class=\"line\">$ lsblk</span><br><span class=\"line\">sdb        8:16   0  1.2T  0 disk</span><br><span class=\"line\">└─k8sapp 253:0    0  1.2T  0 mpath /mnt/nfs/k8sapp</span><br><span class=\"line\">sdc        8:32   0    1T  0 disk</span><br><span class=\"line\">└─k8slog 253:1    0    1T  0 mpath /mnt/nfs/k8slog</span><br><span class=\"line\">sdd        8:48   0  1.2T  0 disk</span><br><span class=\"line\">└─k8sapp 253:0    0  1.2T  0 mpath /mnt/nfs/k8sapp</span><br><span class=\"line\">sde        8:64   0    1T  0 disk</span><br><span class=\"line\">└─k8slog 253:1    0    1T  0 mpath /mnt/nfs/k8slog</span><br><span class=\"line\"></span><br><span class=\"line\">$ df -h</span><br><span class=\"line\">/dev/mapper/k8sapp              1.2T  8.6G  1.2T   1% /mnt/nfs/k8sapp</span><br><span class=\"line\">/dev/mapper/k8slog              1.0T  7.2G 1017G   1% /mnt/nfs/k8slog</span><br><span class=\"line\">192.168.1.216:/mnt/nfs/k8sapp  1.2T  8.6G  1.2T   1% /nfs/k8sapp</span><br><span class=\"line\">192.168.1.216:/mnt/nfs/k8slog  1.0T  7.2G 1017G   1% /nfs/k8slog</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>至此通过存储设备分配给主机的存储卷通过<code>SAS SAN线缆</code>连接到主机HBA设备中被正常识别与使用。</p>\n<p><br/></p>\n<ul>\n<li>案例2.FC SAN 存储直链<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.检查用户登录信息 &amp; 同步服务器时间 为了与存储上的时间对应</span></span><br><span class=\"line\"><span class=\"variable\">$id</span> &amp;&amp; ntpdate 10.10.6.101</span><br><span class=\"line\">uid=0(root) gid=0(root) groups=0(root)</span><br><span class=\"line\">23 May 21:55:37 ntpdate[72045]: step time server 10.10.6.101 offset 448.347362 sec</span><br><span class=\"line\">$ hwclock -w</span><br><span class=\"line\">$ date</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.查看存储映射到主机的光纤卡标识(此标识也可以帮助我们在多条FC 光纤接到主机时区分绑定的主机是否对应主机上的HBA卡标识)</span></span><br><span class=\"line\"><span class=\"variable\">$cat</span> /sys/class/fc_host/host15/port_name</span><br><span class=\"line\">0x100000109b341bc8</span><br><span class=\"line\"><span class=\"variable\">$cat</span> /sys/class/fc_host/host16/port_name</span><br><span class=\"line\">0x100000109b341bc4</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.对光纤交换机进行授权实际上是进行scsi设备进行热备添加到主机上而不用重启</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">'- - -'</span> &gt; /sys/class/scsi_host/host16/scan</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">'- - -'</span> &gt; /sys/class/scsi_host/host15/scan</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.查看linux磁盘分区</span></span><br><span class=\"line\">lvmdiskscan</span><br><span class=\"line\">fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.多路径multipathd配置文件生成(手动编译安装)</span></span><br><span class=\"line\">nano /usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf</span><br><span class=\"line\">multipaths &#123;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid 3600a09803830447967244c61626d6e2f</span><br><span class=\"line\">    <span class=\"built_in\">alias</span> o3db</span><br><span class=\"line\">    path_grouping_policy multibus <span class=\"comment\">#failover</span></span><br><span class=\"line\">    <span class=\"comment\">#path_checker readsector0   #决定路径状态的方法 </span></span><br><span class=\"line\">    path_selector <span class=\"string\">\"round-robin 0\"</span></span><br><span class=\"line\">    failback immediate</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid 3600a09803830447967244c61626d6e59</span><br><span class=\"line\">    <span class=\"built_in\">alias</span> o3app</span><br><span class=\"line\">    path_grouping_policy multibus <span class=\"comment\">#failover</span></span><br><span class=\"line\">    <span class=\"comment\">#path_checker readsector0</span></span><br><span class=\"line\">    path_selector <span class=\"string\">\"round-robin 0\"</span></span><br><span class=\"line\">    failback immediate</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid 3600a09803830447967244c61626d6e63</span><br><span class=\"line\">    <span class=\"built_in\">alias</span> fbapp</span><br><span class=\"line\">    path_grouping_policy multibus <span class=\"comment\">#failover</span></span><br><span class=\"line\">    <span class=\"comment\">#path_checker readsector0</span></span><br><span class=\"line\">    path_selector <span class=\"string\">\"round-robin 0\"</span></span><br><span class=\"line\">    failback immediate</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将此文件复制到修改后的文件复制到 /etc</span></span><br><span class=\"line\">cp /usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf /etc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6.初始化DM并检查mathconf服务是否开启 /sbin/mpathconf</span></span><br><span class=\"line\">modprobe dm-multipath</span><br><span class=\"line\">modprobe dm-round-robin</span><br><span class=\"line\">systemctl restart multipathd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7.进到/dev/mapper进行查看映射成功的LUN名称</span></span><br><span class=\"line\">ls -ltr /dev/mapper</span><br><span class=\"line\">crw------- 1 root root 10, 236 Jan 3 14:04 control</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Jan 3 14:04 rhel-var_log_audit -&gt; ../dm-3</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Jan 3 14:04 rhel-var_log -&gt; ../dm-2</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Jan 3 14:04 rhel-var -&gt; ../dm-1</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Jan 3 14:04 rhel-swa p -&gt; ../dm-5</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Jan 3 14:04 rhel-root -&gt; ../dm-6</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Jan 3 14:04 rhel-tmp -&gt; ../dm-0</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 Jan 3 14:04 rhel-home -&gt; ../dm-4</span><br><span class=\"line\">lrwxrwxrwx 1 root root 7 May 23 22:37 vgo3app-lvo3app -&gt; ../dm-7  <span class=\"comment\"># 关键点</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 8.vgo3app-lvo3app</span></span><br><span class=\"line\">vgchange -an vgo3db</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>案例3.多路径ISCSI磁盘的存储池配置<br>测试环境: Ubuntu 14.04<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.安装需要软件: </span></span><br><span class=\"line\">apt-get install multipath-tools tgt open-iscsi</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.创建裸磁盘(RAW): </span></span><br><span class=\"line\">qemu-img -f raw testmul.raw 5G</span><br><span class=\"line\"><span class=\"comment\"># 或者 </span></span><br><span class=\"line\">dd <span class=\"keyword\">if</span>=/dev/zero of=testmul.raw bs=1M count=0 seek=5120</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.挂载RAW磁盘文件 </span></span><br><span class=\"line\">losetup -f --show testmul.raw</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>创建ISISC盘:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.添加tgt配置文件(/etc/tgt/targets.conf) : /dev/loop0 为第三步挂载的loop设备</span></span><br><span class=\"line\">&lt;target iqn.2013-10.cn.openstack:cinder-volume.target&gt;</span><br><span class=\"line\">  backing-store /dev/loop0</span><br><span class=\"line\">&lt;/target&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.重启tgt</span></span><br><span class=\"line\">service tgt restart</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查看ISISC信息 （192.168.1.3本机ip地址；默认端口为3260；iptables开启，可以关闭或者定义允许规则）</span></span><br><span class=\"line\">iscsiadm -m discovery -t st -p 192.168.1.3:3260</span><br><span class=\"line\"><span class=\"comment\"># 输出信息:</span></span><br><span class=\"line\"><span class=\"comment\"># 192.168.1.3:3260,1 iqn.2013-10.cn.openstack:cinder-volume.target</span></span><br></pre></td></tr></table></figure></p>\n<p>配置多路径 (multipath) ：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.路径配置 iface0为路径名，wlan0为网卡 （此处只配置了单路径需要配置多路自行配置。 ）</span></span><br><span class=\"line\">iscsiadm -m iface -I iface0 –op=new</span><br><span class=\"line\">iscsiadm -m iface -I iface0 –op=update -n iface.net_ifacename -v wlan0</span><br><span class=\"line\">iface0 路径具体配置信息： /etc/iscsi/ifaces/iface0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.登陆ISISC磁盘</span></span><br><span class=\"line\">iscsiadm -m node -T iqn.2013-10.cn.openstack:cinder-volume.target -p 192.16.1.3:3260 -I iface0 -l</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.查看新增磁盘</span></span><br><span class=\"line\">fdisl -l <span class=\"comment\">#可以看到增加的磁盘: /dev/sdb </span></span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/sdb: 5368 MB, 5368709120 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># 166 heads, 62 sectors/track, 1018 cylinders, total 10485760 sectors</span></span><br><span class=\"line\"><span class=\"comment\"># Units = 扇区 of 1 * 512 = 512 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># Sector size (logical/physical): 512 bytes / 512 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># I/O size (minimum/optimal): 512 bytes / 512 bytes</span></span><br><span class=\"line\"><span class=\"comment\"># Disk identifier: 0x00000000</span></span><br><span class=\"line\"><span class=\"comment\"># Disk /dev/sdb doesnt contain a valid partition table</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.multipath配置文件 </span></span><br><span class=\"line\"><span class=\"comment\"># a.配置文件修改 （/etc/multipath.conf）,并重启动multipath-tools服务</span></span><br><span class=\"line\">blacklist &#123;</span><br><span class=\"line\">  devnode <span class=\"string\">\"^sda\"</span> </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">defaults &#123;</span><br><span class=\"line\">  user_friendly_names yes</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># b.运行mulpath </span></span><br><span class=\"line\"><span class=\"variable\">$multipath</span> -ll</span><br><span class=\"line\"><span class=\"comment\"># 输出信息：</span></span><br><span class=\"line\">iscsidisk1 (33000000100000001) dm-0 IET     ,VIRTUAL-DISK    </span><br><span class=\"line\">size=5.0G features=<span class=\"string\">'1 queue_if_no_path'</span> hwhandler=<span class=\"string\">'0'</span> wp=rw</span><br><span class=\"line\">`-+- policy=<span class=\"string\">'round-robin 0'</span> prio=1 status=active</span><br><span class=\"line\">  `- 6:0:0:1 sdb 8:16 active ready running</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 备注：如果执行上述命令，没有信息输出执行 multipath -v3 输出如下信息 </span></span><br><span class=\"line\"><span class=\"comment\"># 把 /dev/sdb的uuid 添加到 /etc/multipath/wwids 中，这样multipath就不会过滤掉设备 /dev/sdb 并重启multipath-tools服务。</span></span><br><span class=\"line\">===== paths list =====</span><br><span class=\"line\">uuid              hcil    dev dev_t pri dm_st chk_st vend/prod/rev            </span><br><span class=\"line\">33000000100000001 6:0:0:1 sdb 8:16  1   undef ready  IET     ,VIRTUAL-DISK    </span><br><span class=\"line\">Apr 10 19:59:27 | params = 1 queue_if_no_path 0 1 1 round-robin 0 1 1 8:16 1000 </span><br><span class=\"line\">Apr 10 19:59:27 | status = 2 0 0 0 1 1 A 0 1 0 8:16 A 0 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># c. 添加 multipath 信息/etc/multipath.conf</span></span><br><span class=\"line\">multipaths &#123;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid  <span class=\"string\">\"33000000100000001\"</span></span><br><span class=\"line\">    <span class=\"built_in\">alias</span> iscsidisk1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5.重启multipath-tools服务执行</span></span><br><span class=\"line\">systemctl restart multipath-tools</span><br><span class=\"line\"><span class=\"variable\">$lsblk</span></span><br><span class=\"line\">sdb                   8:16   0     5G  0 disk  </span><br><span class=\"line\">└─iscsidisk1 (dm-0) 252:0    0     5G  0 mpath</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>补充parted磁盘分区与格式化挂载:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.多路径识别的设备用parted工具来做分区格式化</span></span><br><span class=\"line\">parted /dev/sdb  </span><br><span class=\"line\">(parted) mklabel gpt       <span class=\"comment\"># 把硬盘转换成GPT分区</span></span><br><span class=\"line\">(parted) mkpart primary 1  <span class=\"comment\"># 创建主分区注意需要`选择分区的文件系统类型ext4，ext3，xfs`</span></span><br><span class=\"line\">(parted) <span class=\"built_in\">print</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.主分区文件系统XFS格式化</span></span><br><span class=\"line\">mkfs.xfs -f /dev/sdc1 <span class=\"comment\">#格式化成xfs</span></span><br><span class=\"line\">mkfs.xfs -f -i size=512 -l size=128m,lazy-count=1 -d agcount=64 /dev/mapper/mpathbp1 <span class=\"comment\">#&gt;=20T时候  </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.手动挂载</span></span><br><span class=\"line\">mount /dev/sdc1 /home/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.开机自动挂载</span></span><br><span class=\"line\">/dev/sdb1(磁盘)       /home（挂载点）    xfs（文件格式）   defaults 0 0</span><br><span class=\"line\">df -h查看挂载点文件名</span><br><span class=\"line\">/dev/sdb1              16T   33M   16T   1% /home</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>multipath 命令 - 设备映射器目标自动配置</strong><br>描述: 该命令主要作用是设备进行映射器目标自动配置，即用于检测和合并到设备的多条路径，以用于故障转移或性能原因。</p>\n<p>语法参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 帮助说明</span></span><br><span class=\"line\">man multipath</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># SYNOPSIS | 大纲</span></span><br><span class=\"line\">multipath [-v level] [-B|-d|-i|-q|-r] [-b file] [-p policy] [device]</span><br><span class=\"line\">multipath [-v level] [-R retries] -f device</span><br><span class=\"line\">multipath [-v level] [-R retries] -F</span><br><span class=\"line\">multipath [-v level] [-l|-ll] [device]</span><br><span class=\"line\">multipath [-v level] [-a|-w] device</span><br><span class=\"line\">multipath [-v level] -W</span><br><span class=\"line\">multipath [-v level] [-i] [-c|-C] device</span><br><span class=\"line\">multipath [-v level] [-i] [-u|-U]</span><br><span class=\"line\">multipath [-h|-t|-T]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ARGUMENTS | 命令行参数</span></span><br><span class=\"line\"><span class=\"comment\"># 设备参数将multipath的操作限制为与给定表达式匹配的设备,参数可以引用多路径映射或其组件(“路径”)</span></span><br><span class=\"line\">device node  <span class=\"comment\"># 设备节点的文件名，例如/dev/dm-10或/dev/sda.如果节点引用表示多路径映射的现有设备映射器设备，则根据操作模式选择映射或其路径。否则它选择路径设备。</span></span><br><span class=\"line\">device ID    <span class=\"comment\"># 由主设备号指定的内核设备号:副设备号例如lsblk中MAJ:MIN属性值65:16，此格式只能用于路径设备</span></span><br><span class=\"line\">WWID         <span class=\"comment\"># 要列出系统中存在的设备的WWIDs，可以使用命令\"multipath -d -v3 2&gt;/dev/null\"</span></span><br><span class=\"line\"><span class=\"comment\"># device action limited to:</span></span><br><span class=\"line\"><span class=\"comment\">#   . multipath named 'device' (ex: mpath0)</span></span><br><span class=\"line\"><span class=\"comment\">#   . multipath whose wwid is 'device' (ex: 60051...)</span></span><br><span class=\"line\"><span class=\"comment\">#   . multipath including the path named 'device' (ex: /dev/sda or/dev/dm-0)</span></span><br><span class=\"line\"><span class=\"comment\">#   . multipath including the path with maj:min 'device' (ex: 8:0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 运行模式</span></span><br><span class=\"line\"><span class=\"comment\"># 默认的操作模式是从系统中找到的设备中检测并设置多路径映射。使用以下命令行开关选择其他操作模式:</span></span><br><span class=\"line\">-f     <span class=\"comment\">#如果多路径设备未使用，则刷新(删除)指定为参数的多路径设备映射</span></span><br><span class=\"line\">-F     <span class=\"comment\">#刷新(删除)所有未使用的多路径设备映射 </span></span><br><span class=\"line\">-l     <span class=\"comment\">#从系统文件和设备映射器中获取的信息中显示(“列表”)当前的多路径拓扑</span></span><br><span class=\"line\">-ll    <span class=\"comment\">#从所有可用的信息(sysfs，设备映射器，路径检查器…)显示(“列表”)当前的多路径拓扑</span></span><br><span class=\"line\">-a     <span class=\"comment\">#将指定设备的WWID添加到WWIDs文件中</span></span><br><span class=\"line\">-w     <span class=\"comment\">#从WWIDs文件中删除指定设备的WWID</span></span><br><span class=\"line\">-W     <span class=\"comment\">#将WWIDs文件重置为只包含当前的多路径设备</span></span><br><span class=\"line\">-c     <span class=\"comment\">#检查一个块设备是否应该是多路径设备中的一个路径</span></span><br><span class=\"line\">-C     <span class=\"comment\">#检查多路径设备是否有可用的路径。这可以用来测试该设备上的I/O是否可能成功。命令本身不尝试在设备上执行I/O。</span></span><br><span class=\"line\">-u     <span class=\"comment\">#检查程序环境中指定的设备是否应该是多路径设备中的路径</span></span><br><span class=\"line\">-U     <span class=\"comment\">#检查程序环境中指定的设备是否是具有可用路径的多路径设备与-C效果一致</span></span><br><span class=\"line\">-h     <span class=\"comment\">#打印使用文本(帮助)</span></span><br><span class=\"line\">-t     <span class=\"comment\">#显示当前使用的默认多路径配置</span></span><br><span class=\"line\">-T     <span class=\"comment\">#显示当前使用的multipathd配置，将输出限制为系统中实际出现的设备。这可以用作创建multipath.conf的模板。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 选项</span></span><br><span class=\"line\">-v level <span class=\"comment\">#在默认和“列表”操作模式下打印到stdout的冗长信息。默认的级别是- v2。</span></span><br><span class=\"line\">  0    <span class=\"comment\">#Nothing is printed. 没有打印</span></span><br><span class=\"line\">  1    <span class=\"comment\">#在列表模式下，打印所有多路径映射的WWIDs。</span></span><br><span class=\"line\">  2    <span class=\"comment\">#在默认模式下，打印创建或修改的多路径映射的拓扑。(在列表模式下，。)      </span></span><br><span class=\"line\">  3    <span class=\"comment\">#打印所有检测到的路径和所有多路径映射的拓扑。 (包含多路径详情blacklist、whitelist和设备wwid等等信息)     </span></span><br><span class=\"line\">       <span class=\"comment\">#冗余级别还控制打印到stderr的日志和调试消息的级别。默认的级别对应于LOG_NOTICE(在正常运行中不应该错过的重要消息)。</span></span><br><span class=\"line\"></span><br><span class=\"line\">-d     <span class=\"comment\">#预演，不要创建或更新devmap。</span></span><br><span class=\"line\">-i     <span class=\"comment\">#处理设备时忽略WWIDs文件。如果find_multipaths严格或在multipath中设置find_multipaths no。conf, multipath只考虑WWIDs文件中列出的设备。这种选择凌驾于行为之上。对于find_multipaths的其他值，此选项不起作用。</span></span><br><span class=\"line\">-B      <span class=\"comment\">#将绑定文件视为只读。</span></span><br><span class=\"line\">-b file <span class=\"comment\">#设置user_friendly_names绑定文件位置。The default is /etc/multipath/bindings.</span></span><br><span class=\"line\">-q      <span class=\"comment\">#不要为多路径映射取消设置设备映射器 queue_if_no_path 功能。通常如果multipathd不运行multipath会这样做，因为只有运行中的多路径守护进程保证不可用的路径在再次可用时被恢复。</span></span><br><span class=\"line\">-p policy <span class=\"comment\">#强制所有映射到指定的路径分组策略，策略的可能值与multipath.conf(5)中的path_grouping_policy的值相同，可选策略策略；</span></span><br><span class=\"line\">          <span class=\"comment\"># . failover            每个优先级组一个路径</span></span><br><span class=\"line\">          <span class=\"comment\"># . multibus            所有路径在一个优先级组中</span></span><br><span class=\"line\">          <span class=\"comment\"># . group_by_serial     每个串行一个优先级组</span></span><br><span class=\"line\">          <span class=\"comment\"># . group_by_prio       每个优先级lvl有一个优先级组</span></span><br><span class=\"line\">          <span class=\"comment\"># . group_by_node_name  每个目标节点一个优先级组</span></span><br><span class=\"line\"></span><br><span class=\"line\">-r        <span class=\"comment\">#强制重新加载所有现有的多路径映射。如果multipathd守护进程正在运行，则将此命令委托给它</span></span><br><span class=\"line\">-R retries <span class=\"comment\">#重试刷新正在使用的多路径设备的次数。默认值是0。</span></span><br></pre></td></tr></table></figure></p>\n<p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 常用命令</span></span><br><span class=\"line\">multipath -F  <span class=\"comment\"># 刷新(删除)所有未使用的多路径设备映射 </span></span><br><span class=\"line\">multipath -v2 <span class=\"comment\"># 打印创建或修改的多路径映射的拓扑或打印所有多路径映射的拓扑</span></span><br><span class=\"line\">multipath -r  <span class=\"comment\"># 强制重新加载所有现有的多路径映射,即修改multipath.conf配置文件之后采用其可以热加载</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 列举所多路径设备中所有wwids信息、设备id号以及MAJ:MIN属性值信息</span></span><br><span class=\"line\">multipath -v3 2&gt;/dev/null</span><br><span class=\"line\"><span class=\"comment\"># ===== paths list =====</span></span><br><span class=\"line\"><span class=\"comment\"># uuid                              hcil    dev dev_t pri dm_st chk_st vend/prod</span></span><br><span class=\"line\"><span class=\"comment\"># 36000d3100366e6000000000000000021 4:0:1:1 sdd 8:48  50  undef undef  COMPELNT,</span></span><br><span class=\"line\"><span class=\"comment\"># 36000d3100366e6000000000000000020 4:0:1:2 sde 8:64  50  undef undef  COMPELNT,</span></span><br><span class=\"line\"><span class=\"comment\"># 36000d3100366e6000000000000000021 4:0:2:1 sdb 8:16  1   undef undef  COMPELNT,</span></span><br><span class=\"line\"><span class=\"comment\"># 36000d3100366e6000000000000000020 4:0:2:2 sdc 8:32  1   undef undef  COMPELNT,</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 缺省以及当前多路径软件配置信息</span></span><br><span class=\"line\">multipath -t | more</span><br><span class=\"line\">multipath -T</span><br><span class=\"line\">defaults &#123;</span><br><span class=\"line\">  verbosity 2</span><br><span class=\"line\">  polling_interval 5</span><br><span class=\"line\">  max_polling_interval 20</span><br><span class=\"line\">  .....</span><br><span class=\"line\">  marginal_pathgroups <span class=\"string\">\"no\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">blacklist &#123;</span><br><span class=\"line\">  devnode <span class=\"string\">\"^sda\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^hd[a-z]\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^dcssblk[0-9]*\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">blacklist_exceptions &#123;</span><br><span class=\"line\">  property <span class=\"string\">\"(SCSI_IDENT_|ID_WWN)\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">devices &#123;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">    vendor <span class=\"string\">\"NVME\"</span></span><br><span class=\"line\">    product <span class=\"string\">\".*\"</span></span><br><span class=\"line\">    uid_attribute <span class=\"string\">\"ID_WWN\"</span></span><br><span class=\"line\">    path_checker <span class=\"string\">\"none\"</span>   <span class=\"comment\">#决定路径状态的方法 </span></span><br><span class=\"line\">    retain_attached_hw_handler <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h6 id=\"multipath-conf-配置详解\"><a href=\"#multipath-conf-配置详解\" class=\"headerlink\" title=\"multipath.conf - 配置详解\"></a>multipath.conf - 配置详解</h6><p>配置多路径文件 /etc/multipath.conf 参数说明<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$multipath</span> -T</span><br><span class=\"line\">defaults &#123;</span><br><span class=\"line\">  verbosity 2</span><br><span class=\"line\">  polling_interval 5</span><br><span class=\"line\">  max_polling_interval 20</span><br><span class=\"line\">  reassign_maps <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  multipath_dir <span class=\"string\">\"//lib/multipath\"</span></span><br><span class=\"line\">  path_selector <span class=\"string\">\"service-time 0\"</span>  <span class=\"comment\">#选择那一条路径进行下次IO操作</span></span><br><span class=\"line\">  path_grouping_policy <span class=\"string\">\"multibus\"</span> <span class=\"comment\">#路径组策略 </span></span><br><span class=\"line\">  uid_attribute <span class=\"string\">\"ID_SERIAL\"</span></span><br><span class=\"line\">  prio <span class=\"string\">\"const\"</span></span><br><span class=\"line\">  prio_args <span class=\"string\">\"\"</span></span><br><span class=\"line\">  features <span class=\"string\">\"0\"</span></span><br><span class=\"line\">  path_checker <span class=\"string\">\"tur\"</span>  <span class=\"comment\"># 决定路径状态的方法 </span></span><br><span class=\"line\">  alias_prefix <span class=\"string\">\"mpath\"</span></span><br><span class=\"line\">  failback <span class=\"string\">\"immediate\"</span> <span class=\"comment\">#故障恢复的模式 </span></span><br><span class=\"line\">  rr_min_io 1000   <span class=\"comment\"># 在当前的用户组中，在切换到另外一条路径之前的IO请求的数目 </span></span><br><span class=\"line\">  rr_min_io_rq 1</span><br><span class=\"line\">  max_fds <span class=\"string\">\"max\"</span></span><br><span class=\"line\">  rr_weight <span class=\"string\">\"uniform\"</span></span><br><span class=\"line\">  no_path_retry <span class=\"string\">\"fail\"</span> <span class=\"comment\">#默认fail，在disable queue之前系统尝试使用失效路径的次数的数值 </span></span><br><span class=\"line\">  queue_without_daemon <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  flush_on_last_del <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  user_friendly_names <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">  fast_io_fail_tmo 5</span><br><span class=\"line\">  bindings_file <span class=\"string\">\"/etc/multipath/bindings\"</span></span><br><span class=\"line\">  wwids_file <span class=\"string\">\"/etc/multipath/wwids\"</span></span><br><span class=\"line\">  prkeys_file <span class=\"string\">\"/etc/multipath/prkeys\"</span></span><br><span class=\"line\">  log_checker_err always</span><br><span class=\"line\">  all_tg_pt <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  retain_attached_hw_handler <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">  detect_prio <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">  detect_checker <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">  force_sync <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  strict_timing <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  deferred_remove <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  config_dir <span class=\"string\">\"/etc/multipath/conf.d\"</span></span><br><span class=\"line\">  delay_watch_checks <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  delay_wait_checks <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  san_path_err_threshold <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  san_path_err_forget_rate <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  san_path_err_recovery_time <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  marginal_path_err_sample_time <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  marginal_path_err_rate_threshold <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  marginal_path_err_recheck_gap_time <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  marginal_path_double_failed_time <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  find_multipaths <span class=\"string\">\"on\"</span></span><br><span class=\"line\">  uxsock_timeout 4000</span><br><span class=\"line\">  retrigger_tries 0</span><br><span class=\"line\">  retrigger_delay 10</span><br><span class=\"line\">  missing_uev_wait_timeout 30</span><br><span class=\"line\">  skip_kpartx <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  disable_changed_wwids ignored</span><br><span class=\"line\">  remove_retries 0</span><br><span class=\"line\">  ghost_delay <span class=\"string\">\"no\"</span></span><br><span class=\"line\">  find_multipaths_timeout -10</span><br><span class=\"line\">  enable_foreign <span class=\"string\">\"\"</span></span><br><span class=\"line\">  marginal_pathgroups <span class=\"string\">\"no\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 后端设备(不包含以下设备节点)</span></span><br><span class=\"line\">blacklist &#123;</span><br><span class=\"line\">  devnode <span class=\"string\">\"^sda\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^hd[a-z]\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^dcssblk[0-9]*\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^(ram|zram|raw|loop|fd|md|dm-|sr|scd|st|dcssblk)[0-9]\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^(td|hd|vd)[a-z]\"</span></span><br><span class=\"line\">  devnode <span class=\"string\">\"^cciss!c[0-9]d[0-9]*\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">    vendor <span class=\"string\">\"SGI\"</span>  <span class=\"comment\">#厂商名称，可通过multipath –v3获取到 </span></span><br><span class=\"line\">    product <span class=\"string\">\"Universal Xport\"</span>  <span class=\"comment\">#产品型号 </span></span><br><span class=\"line\">    getuid_callout <span class=\"string\">\"/sbin/scsi_id -g -u -s /block/%n\"</span> <span class=\"comment\">#获得唯一设备号使用的默认程序 </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"^DGC\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"LUNZ\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"EMC\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"LUNZ\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"DELL\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"Universal Xport\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"IBM\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"Universal Xport\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"IBM\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"S/390\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"LENOVO\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"Universal Xport\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"(NETAPP|LSI|ENGENIO)\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"Universal Xport\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"STK\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"Universal Xport\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"SUN\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"Universal Xport\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"(Intel|INTEL)\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"VTrak V-LUN\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"Promise\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"VTrak V-LUN\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">          vendor <span class=\"string\">\"Promise\"</span></span><br><span class=\"line\">          product <span class=\"string\">\"Vess V-LUN\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">blacklist_exceptions &#123;</span><br><span class=\"line\">  property <span class=\"string\">\"(SCSI_IDENT_|ID_WWN)\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">devices &#123;</span><br><span class=\"line\">  device &#123;</span><br><span class=\"line\">    vendor <span class=\"string\">\"COMPELNT\"</span></span><br><span class=\"line\">    product <span class=\"string\">\"Compellent Vol\"</span></span><br><span class=\"line\">    path_grouping_policy <span class=\"string\">\"multibus\"</span></span><br><span class=\"line\">    no_path_retry <span class=\"string\">\"queue\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">overrides &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">multipaths &#123;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid <span class=\"string\">\"36000d3100366e6000000000000000021\"</span>   <span class=\"comment\">#磁盘的WWID </span></span><br><span class=\"line\">    <span class=\"built_in\">alias</span> <span class=\"string\">\"k8sapp\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  multipath &#123;</span><br><span class=\"line\">    wwid <span class=\"string\">\"36000d3100366e6000000000000000020\"</span></span><br><span class=\"line\">    <span class=\"built_in\">alias</span> <span class=\"string\">\"k8slog\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h6 id=\"bindings-多路径缺省绑定的别名\"><a href=\"#bindings-多路径缺省绑定的别名\" class=\"headerlink\" title=\"bindings - 多路径缺省绑定的别名\"></a>bindings - 多路径缺省绑定的别名</h6><p>描述:/etc/multipath/bindings文件是在multipath.conf中定义了user_friendly_names属性时候，默认采用以下友好的别名名称;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$cat</span> /etc/multipath/bindings</span><br><span class=\"line\"><span class=\"comment\"># Format:</span></span><br><span class=\"line\"><span class=\"comment\"># alias wwid</span></span><br><span class=\"line\">mpatha 36000d3100366e6000000000000000020</span><br><span class=\"line\">mpathd 36000d3100366e6000000000000000021</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"Windows-MPIO\"><a href=\"#Windows-MPIO\" class=\"headerlink\" title=\"Windows - MPIO\"></a>Windows - MPIO</h5><p>描述: 在Windows下也自带多路径管理软件它叫MPIO，Windows MPIO集成在Windows的系统中，默认情况下不会安装，需要手动安装起来。</p>\n<p>Step 1.打开“Server Manager-服务器管理”，选择“Feature”，选择右键菜单中的“Add Features-添加功能”</p>\n<p>Step 2.添加“MultiPath I/O”在弹出的Features选择框中，选择“MultiPath I/O”<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200912141229.png\" alt=\"WeiyiGeek.MultiPath I/O\" title=\"\" class=\"\">\n                <p>WeiyiGeek.MultiPath I/O</p>\n            </figure></p>\n<p>Step 3.需要对MPIO多路径进行配置才能让其接管存储系统。Windows 2008及后续版本的操作系统提供mpclaim多路径命令可以用于查询磁盘信息;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查询设备VID和PID,此处举例所用，实际配置的时候需要以现场环境的显示为准。</span></span><br><span class=\"line\">VID：Vendor ID，厂商ID。例如HUAWEI等。</span><br><span class=\"line\">PID：Product ID，产品ID。例如S5500T、S5600T。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查询磁盘信息</span></span><br><span class=\"line\">mpclaim -e</span><br></pre></td></tr></table></figure>\n<p>Step 4.运行MPIO管理控制台<code>%windir%\\system32\\mpiocpl.exe</code>也可在管理工具找到它,进行添加待管理存储设备的信息<br>在“MPIO Device”中点击“Add”添加存储设备。</p>\n<ul>\n<li>如果对iSCSI initiator使用MPIO，则要求在“Discover Multi-Paths”菜单中开启“Add Support for iSCSI device”选项。</li>\n<li>大多数型号的设备可以在“Discover MultiPaths”选项下的Others选项中自动识别，此时只需点击 Add将其加入即可。<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200912142049.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n</ul>\n<p>Step 5.重启主机使多路径生效，然后查看MPIO策略。重启主机后将重新扫描磁盘。磁盘数量与映射给主机的LUN的数量一致。右键单击磁盘，选择“Properties”可以看到属性中MPIO选项，一般来说如无特别要求，优先使用默认MPIO策略。<br>不同情况下默认的策略是不同的，常用操作系统的默认策略如表1-1所示。</p>\n<table>\n<thead>\n<tr>\n<th>操作系统</th>\n<th>存储系统</th>\n<th>默认MPIO策略</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Windows Server 2008</td>\n<td>开启ALUA</td>\n<td>Round Robin With Subset</td>\n<td></td>\n</tr>\n<tr>\n<td>关闭ALUA</td>\n<td>Fail over only</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>Windows Server 2008 R2</td>\n<td>开启ALUA</td>\n<td>Round Robin With Subset</td>\n<td></td>\n</tr>\n<tr>\n<td>关闭ALUA</td>\n<td>Round Robin</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>Windows Server 2012 DC</td>\n<td>开启ALUA</td>\n<td>Round Robin With Subset</td>\n<td></td>\n</tr>\n<tr>\n<td>关闭ALUA</td>\n<td>Round Robin</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>Step 6.修改路径状态某些特定场景或需求，需对路径状态重新配置。</p>\n<p>例如：对于“Fail Over Only”策略，只允许一条路径为Activate状态，其余路径必须编辑成Standby状态；对于Windows 2008，需要将连接到归属控制器的路径状态设置为“Active/Optimized”，将连接到其他控制器的路径状态设置为“Active/Unoptimized”。</p>\n<p>Step 7. 保存路径状态配置</p>\n<p>磁盘的所有路径状态修改完成后在界面上并不会立刻更新，需要单击MPIO策略配置界面“OK”按钮保存配置，并重新打开MPIO策略配置界面查看更改是否生效。</p>\n<p><br></p>\n<p><strong>mpclaim 命令</strong></p>\n<p>描述:在cmd下面也可以对MPIO进行管理在使用前</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前安装的features</span></span><br><span class=\"line\">dism /online /get-features</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 激活MPIO</span></span><br><span class=\"line\">dism /online /<span class=\"built_in\">enable</span>-feature:MultipathIo</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 取消激活MPIO</span></span><br><span class=\"line\">dism /online /<span class=\"built_in\">disable</span>-feature:MultipathIo</span><br></pre></td></tr></table></figure>\n<p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看Microsoft DSM 管理的存储设备</span></span><br><span class=\"line\">mpclaim -r</span><br><span class=\"line\"><span class=\"comment\"># 查看系统发现的存储设备</span></span><br><span class=\"line\">mpclaim -e</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用MPIO管理所有存储设备</span></span><br><span class=\"line\">mpclaim.exe -r -i -a <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"comment\"># 去掉MPIO对所有设备的管理</span></span><br><span class=\"line\">mpclaim.exe -r -u -a <span class=\"string\">\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用MPIO管理光纤通道设备</span></span><br><span class=\"line\">mpclaim.exe -r -i -d &lt;_VendorID&gt; &lt;_ProductID&gt;</span><br><span class=\"line\"><span class=\"comment\"># 去除MPIO对光纤通道设备的管理</span></span><br><span class=\"line\">mpclaim.exe -r -u -d &lt;_VendorID&gt; &lt;_ProductID&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用MPIO管理 iSCSI 设备</span></span><br><span class=\"line\">mpclaim -r -i -d <span class=\"string\">\"MSFT2005iSCSIBusType_0x9\"</span></span><br><span class=\"line\"><span class=\"comment\">#去掉MPIO对iSCSI设备的管理</span></span><br><span class=\"line\">mpclaim.exe -r -u -d <span class=\"string\">\"MSFT2005iSCSIBusType_0x9\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改负载平衡策略</span></span><br><span class=\"line\">mpclaim.exe –L –M &lt;_num&gt;</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>注意事项:</strong></p>\n<ul>\n<li><p>Windows MPIO多路径软件支持每个Lun的最大路径数为32个(建议每个Lun的路径数不大于32条)，大于32条路径会导致Windows 主机系统蓝屏。</p>\n</li>\n<li><p>对于不支持ALUA的存储，请按照“关闭ALUA”的方式来配置MPIO策略。</p>\n</li>\n<li><p>VendorID需要为8位字节，ProductID为16位字节，不足的以空格填充。</p>\n</li>\n<li>修改负载平衡策略命令中的num参数代表的意思见表</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Definition</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>Clear the Policy   -  明确的政策</td>\n</tr>\n<tr>\n<td>1</td>\n<td>Failover Only  - 故障转移</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Round Robin  - 循环</td>\n</tr>\n<tr>\n<td>3</td>\n<td>Round Robin with  Subset  - 子集循环</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Least Queue Depth  - 至少队列深度</td>\n</tr>\n<tr>\n<td>5</td>\n<td>Weighted Paths   -加权路径</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Least Blocks  - 至少块</td>\n</tr>\n<tr>\n<td>7</td>\n<td>Vendor Specific - 特定于供应商的</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<h4 id=\"0x02-入坑解决\"><a href=\"#0x02-入坑解决\" class=\"headerlink\" title=\"0x02 入坑解决\"></a>0x02 入坑解决</h4><p>问题1.在未进行多路径设备挂载时候显示ailed ready running<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$multipath</span> -ll</span><br><span class=\"line\"><span class=\"comment\"># k8slog (36000d3100366e6000000000000000020) dm-1 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=1.0T features='1 queue_if_no_path' hwhandler='1 alua' wp=rw</span></span><br><span class=\"line\"><span class=\"comment\"># `-+- policy='service-time 0' prio=25 status=active</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 5:0:0:2 sdc 8:32 failed ready running  # 关键点</span></span><br><span class=\"line\"><span class=\"comment\">#   `- 5:0:1:2 sde 8:64 active ready running</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解决办法</span></span><br><span class=\"line\"><span class=\"variable\">$mount</span> /dev/mapper/k8slog /mnt/nfs/k8slog/  <span class=\"comment\"># 关键点</span></span><br><span class=\"line\"><span class=\"variable\">$multipath</span> -ll</span><br><span class=\"line\"><span class=\"comment\"># k8slog (36000d3100366e6000000000000000020) dm-1 COMPELNT,Compellent Vol</span></span><br><span class=\"line\"><span class=\"comment\"># size=1.0T features='1 queue_if_no_path' hwhandler='1 alua' wp=rw  </span></span><br><span class=\"line\"><span class=\"comment\"># `-+- policy='service-time 0' prio=25 status=active # 关键点</span></span><br><span class=\"line\"><span class=\"comment\">#   |- 5:0:0:2 sdc 8:32 active ready running</span></span><br><span class=\"line\"><span class=\"comment\">#   `- 5:0:1:2 sde 8:64 active ready running</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>问题2.虚拟机安装ubuntu20.04后，查看系统日志，大量的以下错误信息。排查后发现是multipath 的配置问题，需要排除本地的sda磁盘<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 问题信息</span></span><br><span class=\"line\">Jun 13 14:31:12 multipathd[615]: sda: add missing path</span><br><span class=\"line\">Jun 13 14:31:12 multipathd[615]: sda: failed to get udev uid: Invalid argument</span><br><span class=\"line\">Jun 13 14:31:12 multipathd[615]: sda: failed to get sysfs uid: Invalid argument</span><br><span class=\"line\">Jun 13 14:31:12 multipathd[615]: sda: failed to get sgio uid: No such file or directory</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解决流程添加以下内容，sda视本地环境做调整然后重启服务即可。</span></span><br><span class=\"line\">sudo vi /etc/multipath.conf</span><br><span class=\"line\">blacklist &#123;</span><br><span class=\"line\">  devnode <span class=\"string\">\"^sda\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sudo service multipath-tools restart</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x03-参考连接\"><a href=\"#0x03-参考连接\" class=\"headerlink\" title=\"0x03 参考连接\"></a>0x03 参考连接</h4><ul>\n<li><a href=\"http://www.voidcn.com/article/p-dbvqeerl-bmp.html\" target=\"_blank\" rel=\"noopener\">http://www.voidcn.com/article/p-dbvqeerl-bmp.html</a></li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Storage","path":"api/categories/Storage.json"}],"tags":[{"name":"Multipath","path":"api/tags/Multipath.json"}]}