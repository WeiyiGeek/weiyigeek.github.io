<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 1.FastDFS分布式的文件存储系统入门介绍与实践|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>1.FastDFS分布式的文件存储系统入门介绍与实践</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">1.FastDFS分布式的文件存储系统入门介绍与实践</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-05-22T06:34:30.000Z" itemprop="datePublished" class="page-time">
  2020-05-22
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F/Distributed/">Distributed</a></li></ul></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-系统运维/系统架构/分布式/FastDFS/1.FastDFS分布式的文件存储系统入门介绍与实践"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">1.FastDFS分布式的文件存储系统入门介绍与实践</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-05-22 14:34:30" datetime="2020-05-22T06:34:30.000Z"  itemprop="datePublished">2020-05-22</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%88%86%E5%B8%83%E5%BC%8F/Distributed/">Distributed</a></li></ul></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-基础介绍"><a href="#0x00-基础介绍" class="headerlink" title="0x00 基础介绍"></a>0x00 基础介绍</h2><h3 id="0-前言"><a href="#0-前言" class="headerlink" title="0.前言"></a>0.前言</h3><p><strong>Q: 传统的文件系统面临的问题与挑战?</strong><br>描述: 在传统WEB应用中，前端、后端、以及其它API服务部署在同一台服务器，所有文件都作为静态资源访问，随着业务量的不断增长，久而久之，图片和文件等资源占用的空间变得越来越大。</p>
<p>随之带来了各种性能、管理与安全风险等问题，如下所示：</p>
<ul>
<li>若文件直接置于应用服务器中，难以管理；</li>
<li>昂贵的磁盘空间、高性能服务器大大增加了运维成本；</li>
<li>易发生单点故障；</li>
<li>传统FTP上传文件，存在诸多安全隐患（用户名和口令的明文传输等）；</li>
<li>无法保证文件的机密性，某些敏感文件如身份证照片等以明文存储，文件的授权访问不易控制；</li>
<li>安全没有保障，文件上传、下载、删除、查看依赖于各个业务系统的实现，一个上传功能可能出现“修不完的漏洞”；</li>
</ul>
<p><br></p>
<p><strong>Q: 什么是分布式文件系统？</strong><br>描述: 分布式文件系统<code>（Distributed File System, DFS）</code>是一种允许文件通过网络在多台主机上分享的文件系统，可让多机器上的多用户分享文件和存储空间。客户端并非直接访问底层的数据存储区块，而是通过网络以特定的通信协议与服务器通信，借通信协议来限制客户端对于文件系统的访问。分布式文件存储利用多台存储服务器分担存储压力，利用跟踪服务器定位存储信息，不但提高了系统可靠性、可用性以及读写效率，而且方便水平扩展。分布式文件存储可采用多副本备份机制，分布式存储对数据进行了分片，分片后的数据按照一定规则保存在集群节点上。即使单个集群节点机器发生故障也能保证数据不会丢失，最小化对业务的影响。</p>
<p>Tips: 既然传统的文件存储方式存在这么多弊端，那么新的分布式文件系统需要满足哪些需求呢？</p>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211031174558.png" target="_blank" title="WeiyiGeek.应用功能需求与技术需求" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211031174558.png" alt="WeiyiGeek.应用功能需求与技术需求" title="" class=""></a>
                <p>WeiyiGeek.应用功能需求与技术需求</p>
            </figure>
<p><br></p>
<h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><p>描述: FastDFS 是阿里的余庆大佬用 C 语言编写的一款开源的分布式文件系统（个人项目），它对文件进行管理。功能包括：<code>文件存储、文件同步、文件访问（文件上传、文件下载）</code>等，适合中小文件<code>（4KB &lt; file_size &lt;500MB）</code>存储，解决了<code>大容量文件存储</code>和<code>负载均衡</code>的问题。充分考虑了<code>冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标</code>。</p>
<p><strong>应用场景:</strong></p>
<ul>
<li>1.特别适合以文件为载体的在线服务，如相册网站、视频网站等等。</li>
<li>2.​适合用来存储用户图片、视频、文档等文件(小文件 建议范围：<code>4KB &lt; file_size &lt; 500MB</code>)。</li>
</ul>
<p>Tips: 支持Linux、FreeBSD等UNIX系统类 google FS，但不是通用的文件系统;<br>Tips: FastDFS不适用于分布式计算存储的场景、以及数据库文件、VM虚拟机文件的存储;</p>
<p><br/></p>
<h3 id="2-特性"><a href="#2-特性" class="headerlink" title="2.特性"></a>2.特性</h3><p>FastDFS是一种基于文件的key/value pair存储系统，作为一个轻量级分布式文件存储，FastDFS具有以下特性:</p>
<ul>
<li>(1) 支持主从集群配置</li>
<li>(2) 支持在线扩容</li>
<li>(3) 支持备份容错</li>
<li>(4) 支持相同内容文件合并，节约磁盘空间</li>
<li>(5) 支持海量文件的存储和读写分离</li>
<li>(6) 文件不分块存储，上传的文件和 OS 文件系统中的文件一一对应</li>
<li>(7) 下载文件支持 HTTP 协议，可以使用内置 Web Server，也可以和其他 <code>Web Server</code> 配合使用</li>
<li>(8) 支持断点续传，对大文件简直是福音。</li>
</ul>
<p><br/></p>
<p><strong>FastDFS 优点:</strong></p>
<ul>
<li>(1) 结构简单，元数据节点压力低</li>
<li>(2) 扩容简单，扩容后文件自动同步，无需重新平衡，增强了系统的可扩展性</li>
<li>(3) 高性能，文件处理速度快，适合海量小文件存储</li>
<li>(4) 主从架构，增强系统的可用性</li>
<li>(5) 实现软RAID，增强了系统的并发处理能力和数据容错恢复能力</li>
</ul>
<p><br/></p>
<p><strong>FastDFS 缺点:</strong></p>
<ul>
<li>(1) 不能自定义文件key，自己定义会降低灵活性</li>
<li>(2) 大文件冲击问题：大文件没有分片，导致大文件的读写都由单块硬盘承担，对磁盘的冲击很大，由于我们主要以小文件为主，所以影响较小</li>
<li>(3) 缺乏自动化故障恢复机制、运维机制和在线配置能力</li>
<li>(4) 数据恢复效率低：磁盘镜像分布，修复速度取决于磁盘写入速度</li>
<li>(5) 源storage写一份即返回成功，源storage出现故障，就可能导致数据丢失，建立监控告警机制，对storage进行检测，实现出现故障时及时通知处理</li>
<li>(6) 缺乏必要的安全访问控制机制以及文件数据保护措施，通过文件服务网关可以自己实现访问控制与数据保护。</li>
<li>(7) 同步机制不支持文件正确性校验，降低了系统的可用性</li>
<li>(8) 对跨公网的文件同步，存在着比较大的延迟，需要应用做相应的容错策略（）。</li>
</ul>
<p>Tips : ​出于简洁考虑 FastDFS 没有对文件做分块存储，因此不太适合分布式计算场景。</p>
<p><br/></p>
<h3 id="3-架构"><a href="#3-架构" class="headerlink" title="3.架构"></a>3.架构</h3><p>描述: FastDFS 文件系统主要由 <code>Tracker server</code> 和 <code>Storage server</code> 组成。其中 Storage 负责存储文件，Tracker 负责存储文件所在地址，主要作用是负载均衡和资源调度。</p>
<p><br/></p>
<p><strong>原理流程</strong>: 客户端请求 Tracker server 进行文件上传、下载、删除文件， Tracker server 将客户端的请求调度到 Storage server 完成文件的上传和下载。</p>
<p>从框架图中我们可以看到<code>FastDFS服务端</code>有三个角色, <code>跟踪服务器（tracker server）</code>、<code>存储服务器（storage server）</code>和<code>客户端（client）</code>。Tracker、Storage 都可以实现集群部署，Tracker的每个节点地位平等，而Storage可以分为多个组，每个组之间保存的文件是不同的，组内部分为多个成员且地位一致，<code>每个成员保存的内容是一样</code>，没有主从概念。</p>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414214129.png" target="_blank" title="WeiyiGeek.FastDFS架构" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414214129.png" alt="WeiyiGeek.FastDFS架构" title="" class=""></a>
                <p>WeiyiGeek.FastDFS架构</p>
            </figure>
<p>Tips : 使用FastDFS存储文件优点，可以应对互联网的海量文件存储，一旦文件较多，可以随时横向扩展，且集群的实现也使系统不存在单点故障问题，用户不会因为服务器宕机而无法访问文件资源。</p>
<p><br/></p>
<h4 id="Tracker-Server"><a href="#Tracker-Server" class="headerlink" title="Tracker Server"></a>Tracker Server</h4><p>描述: 跟踪服务器作为集群的中心节点，负责对客户端的请求进行<code>负载均衡和调度工作</code>,以及负责<code>管理所有的 storage server 和 group</code>，每个 storage 在启动后会连接 Tracker，告知自己所属 group 等信息，并保持周期性心跳。tracker 根据 storage 的心跳信息，建立 <code>group==&gt;[storage serverlist]</code> 的映射表。</p>
<p>重点: Tracker 管理的元数据信息较少并且会全部存储在内存中，另外 tracker 上的元信息都是<code>由 storage 汇报的信息生成的，本身不需要持久化任何数据</code>，使得 tracker 非常容易扩展，<code>直接增加 tracker 机器即可扩展为 tracker cluster 来服务</code>，cluster 里每个 tracker 之间是完全对等的，所有的 tracker 都接受 stroage 的心跳信息，生成<code>元数据信息</code>来提供读写服务。</p>
<p><br/></p>
<h4 id="Storage-Server"><a href="#Storage-Server" class="headerlink" title="Storage Server"></a>Storage Server</h4><p>描述: 存储服务器(又称：<code>存储节点或数据服务器</code>)主要提供容量和备份服务。</p>
<p>它以 group 为单位<code>每个 group 内</code>可以有多台 <code>storage server</code> 数据互为备份;</p>
<p>它有如下优缺点：</p>
<ul>
<li>优点: 是将不同应用数据存到不同的Group就能隔离应用数据，同时还可根据应用的访问特性来将应用分配到不同的Group来做负载均衡。</li>
<li>缺点: 是Group的容量受单机存储容量的限制，同时当Group内有机器坏掉时，数据恢复只能依赖group内的其他机器，使得恢复时间会很长。</li>
</ul>
<p>以 group 为单位<code>每个 group 内</code>可以有多台 <code>storage server</code> 数据互为备份; 以 group 为单位组织存储能方便的进行<code>应用隔离、负载均衡、副本数定制（group内storage server数量即为该group的副本数）</code>;</p>
<p>Tips : group 组也可称为卷。同组内服务器上的文件是完全相同的,同一组内的storage server之间是对等的， 文件上传、 删除等操作可以在任意一台storage server上进行 。</p>
<p>重点: group内每个storage的存储依赖于本地文件系统，storage可配置多个数据存储目录，比如有10块磁盘分别挂载在<code>/data/disk1-/data/disk10</code>，则可将这10个目录都配置为storage的数据存储目录。storage接受到写文件请求时，会根据配置好的规则选择其中一个存储目录来存储文件。为了避免单个目录下的文件数太多，在storage第一次启动时，会在每个数据存储目录里创建2级子目录，每级256个，总共<code>256^2=65536</code>个文件，新写的文件会以hash的方式被路由到其中某个子目录下，然后将文件数据（<code>文件和文件属性（meta data）键值对(Key Value Pair)方式，如：width=1024,heigth=768</code>）作为本地文件存储到该目录中, 即<code>Storage server</code>直接利用OS的文件系统调用管理文件。</p>
<p><br/></p>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><p>描述: client(客户端) 作为业务请求的发起方，通过专有接口，使用TCP/IP协议与跟踪器服务器或存储节点进行数据交互。FastDFS向使用者提供基本文件访问接口，比如<code>upload、download、append、delete</code>等，以客户端库的方式提供给用户使用。</p>
<p><br/></p>
<h3 id="4-存储策略"><a href="#4-存储策略" class="headerlink" title="4.存储策略"></a>4.存储策略</h3><p>描述: 为了支持大容量存储节点（服务器）采用了<code>分卷（或分组）的组织方式</code>。存储系统由一个或多个卷组成，卷与卷之间的文件是相互独立的，所有卷的文件容量累加就是整个存储系统中的文件容量。一个卷可以由一台或多台存储服务器组成，一个卷下的存储服务器中的文件都是相同的，卷中的多台存储服务器起到了<code>冗余备份</code>和<code>负载均衡</code>的作用。</p>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211031180109.png" target="_blank" title="WeiyiGeek.存储策略方式" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211031180109.png" alt="WeiyiGeek.存储策略方式" title="" class=""></a>
                <p>WeiyiGeek.存储策略方式</p>
            </figure>
<p>Tips : 在卷中增加服务器时，同步已有的文件由系统自动完成，同步完成后，系统自动将新增服务器切换到线上提供服务。</p>
<p>Tips : 当存储空间不足或即将耗尽时，可以动态添加卷, 只需要增加一台或多台服务器，并将它们配置为一个新的卷，这样就扩大了存储系统的容量。</p>
<p><br/></p>
<h3 id="5-过程剖析"><a href="#5-过程剖析" class="headerlink" title="5.过程剖析"></a>5.过程剖析</h3><h4 id="文件上传-Upload"><a href="#文件上传-Upload" class="headerlink" title="文件上传 - Upload"></a>文件上传 - Upload</h4><p>描述: 通过前面架构介绍我们知道向使用者提供基本文件访问接口，比如 <code>upload、download、append、delete</code> 等，以客户端库的方式提供给用户使用。</p>
<p><strong>简单流程:</strong><br>描述: <code>Storage Server</code> 会定期的向 <code>Tracker Server</code> 发送自己的存储信息。当 <code>Tracker Server Cluster</code> 中的 <code>Tracker Server</code> 不止一个时，各个Tracker之间的关系是对等的，所以客户端上传时可以选择任意一个Tracker。 当Tracker收到客户端上传文件的请求时，会为该文件分配一个可用的 group (<code>Storage Server其中的组</code>)来进行存储文件的，当选定了group后就要决定给客户端分配group中的哪一个<code>storage server</code>。当分配好<code>storage server</code>后客户端向storage发送写文件请求，storage将会为文件分配一个数据存储目录，然后为文件分配一个fileid(<code>路径信息和文件名</code>)，最后根据以上的信息生成文件名并存储文件。</p>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414224032.png" target="_blank" title="WeiyiGeek.fdfs文件上传" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414224032.png" alt="WeiyiGeek.fdfs文件上传" title="" class=""></a>
                <p>WeiyiGeek.fdfs文件上传</p>
            </figure>
<p><br></p>
<p><strong>内部机制</strong></p>
<ul>
<li><p>1) <strong>选择 tracker server</strong><br>描述: 当集群中不止一个tracker server时，由于tracker之间是完全对等的关系，客户端在upload文件时可以任意选择一个trakcer。 选择存储 <code>Storage</code> 的 group 当 tracker 接收到<code>upload file</code>的请求时，会为该文件分配一个可以存储该文件的group，支持如下选择group的规则: </p>
<ul>
<li>1、Round robin， 以轮询的方式依次的向各个group存储文件，对应配置值0</li>
<li>2、Specified group，指定某一个确定的group，对应配置值1，此时需要配合配置store_group=group_name来指定</li>
<li>3、Load balance，剩余存储空间多多group优先</li>
</ul>
</li>
<li><p>2) <strong>选择 storage server</strong><br>描述: 当选定group后，tracker会在group内选择一个storage server给客户端，支持如下选择storage的规则：</p>
<ul>
<li>1、Round robin，在group内的所有storage间轮询</li>
<li>2、First server ordered by ip，按ip排序</li>
<li>3、First server ordered by priority，按优先级排序（优先级在storage上配置）</li>
</ul>
</li>
<li><p>3) <strong>选择 storage path</strong><br>描述: 当分配好storage server后，客户端将向storage发送写文件请求，storage将会为文件分配一个数据存储目录，支持如下规则：</p>
<ul>
<li>1、Round robin，多个存储目录间轮询</li>
<li>2、剩余存储空间最多的优先</li>
</ul>
</li>
<li><p>4) <strong>生成 fileid</strong><br>描述: 选定存储目录之后storage会为文件生一个Fileid，由<code>storage server ip、文件创建时间、文件大小、文件crc32和一个随机数拼接而成</code>，然后将这个二进制串进行base64编码，转换为可打印的字符串。选择两级目录当选定存储目录之后，storage会为文件分配一个fileid，每个存储目录下有两级<code>256*256</code>的子目录，storage会按文件fileid进行两次hash（猜测），路由到其中一个子目录，然后将文件以fileid为文件名存储到该子目录下。</p>
</li>
<li><p>5) <strong>生成文件名</strong><br>描述: 当文件存储到某个子目录后，即认为该文件存储成功，接下来会为该文件生成一个文件名(精巧的文件ID-FID)，文件名<code>由group、存储目录、两级子目录、fileid、文件后缀名</code>（由客户端指定，主要用于区分文件类型）拼接而成，是客户端上传文件后存储服务器返回给客户端，用于以后访问该文件的索引信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fdfs_upload_file /etc/fdfs/storage.conf logo.jpg</span></span><br><span class="line">组名/磁盘/一级目录(2*Hex)/二级目录(2*Hex)/文件名称</span><br><span class="line">group1/M00/00/00/wKgMMmB2bmyAP9SWAAA_wvXjApM631.jpg</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414225115.png" target="_blank" title="WeiyiGeek.fdfs文件名称说明" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414225115.png" alt="WeiyiGeek.fdfs文件名称说明" title="" class=""></a>
                <p>WeiyiGeek.fdfs文件名称说明</p>
            </figure>
</li>
</ul>
<p>Tips : 文件索引信息包括：组名，虚拟磁盘路径，数据两级目录，文件名。</p>
<ul>
<li>组名：文件上传后所在的存储组名称，在文件上传成功后有存储服务器返回，需要客户端自行保存。</li>
<li>文件存储虚拟磁盘路径：存储服务器配置的虚拟路径，与磁盘选项store_path*对应(默认常规为M00)。</li>
<li>数据文件两级目录：存储服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据文件。</li>
<li>文件名：与文件上传时不同。是由存储服务器根据特定信息生成，文件名包含：源存储服务器IP地址、文件创建时间戳、文件大小、随机数和文件拓展名等信息。</li>
</ul>
<p><br/></p>
<h4 id="文件下载-Download"><a href="#文件下载-Download" class="headerlink" title="文件下载 - Download"></a>文件下载 - Download</h4><p>描述: 跟<code>upload file</code>一样在<code>download file</code>时客户端可以选择任意 tracker server。tracker发送download请求给某个tracker，必须带上文件名信息，tracke从文件名中解析出文件的<code>group、大小、创建时间</code>等信息，然后为该请求选择一个storage用来服务读请求。由于group内的文件同步时在后台异步进行的，所以有可能出现在读到时候，文件还没有同步到某些 storage server上，为了尽量避免访问到这样的storage，tracker 按照如下规则选择 group 内可读的 storage: </p>
<ul>
<li>1.该文件上传到的源头 storage, 只要源头 storage存活着就肯定包含这个文件，源头的地址被编码在文件名中。</li>
<li>2.文件创建时间戳 == storage 被同步到的时间戳且(当前时间-文件创建时间戳) &gt; 文件同步最大时间（如5分钟) - 文件创建后认为经过最大同步时间后，肯定已经同步到其他storage了。</li>
<li>3.文件创建时间戳 &lt; storage被同步到的时间戳。 - 同步时间戳之前的文件确定已经同步了</li>
<li>4.(当前时间-文件创建时间戳) &gt; 同步延迟阀值（如一天）。 - 经过同步延迟阈值时间，认为文件肯定已经同步了。</li>
</ul>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414230555.png" target="_blank" title="WeiyiGeek.fdfs文件下载" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210414230555.png" alt="WeiyiGeek.fdfs文件下载" title="" class=""></a>
                <p>WeiyiGeek.fdfs文件下载</p>
            </figure>
<p><br/></p>
<h4 id="文件访问-HTTP"><a href="#文件访问-HTTP" class="headerlink" title="文件访问 - HTTP"></a>文件访问 - HTTP</h4><p>描述: FastDFS的tracker和storage都内置了http协议的支持，客户端可以通过http协议来下载文件，tracker在接收到请求时，通过http的redirect机制将请求重定向至文件所在的storage上；我们这里对nginx改造后生成hsiar，通过hsiar可以实现视频http请求后可以边下载边播的功能，从而减低对网络带宽的压力。</p>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211031171221.png" target="_blank" title="WeiyiGeek.图片来自chinaUnix" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211031171221.png" alt="WeiyiGeek.图片来自chinaUnix" title="" class=""></a>
                <p>WeiyiGeek.图片来自chinaUnix</p>
            </figure>
<p>Tips: 采用Nginx作为网关处理请求转发和校验，Nginx的多路复用机制和非阻塞IO非常适合业务简单、耗时短的校验操作。</p>
<p><br></p>
<h4 id="文件同步-Sync"><a href="#文件同步-Sync" class="headerlink" title="文件同步 - Sync"></a>文件同步 - Sync</h4><p>描述: 当写文件时，客户端将文件写至group内一个<code>storage server</code>即认为写文件成功，storage server写完文件后，会由后台线程将文件同步至同group内其他的storage server。</p>
<p>每个storage写文件后，同时会写一份binlog ,该文件里不包含文件数据，只包含文件名等元信息，这份binlog用于后台同步，storage会记录向group内其他storage同步的进度，以便重启后能接上次的进度继续同步；进度以时间戳的方式进行记录，所以最好能保证集群内所有server的时钟保持同步。</p>
<p>storage的同步进度会作为元数据的一部分汇报到tracker上，tracke在选择读storage的时候会以同步进度作为参考。比如一个group内有A、B、C三个storage server，A向C同步到进度为T1 (T1以前写的文件都已经同步到B上了），B向C同步到时间戳为T2（T2 &gt; T1)，tracker接收到这些同步进度信息时，就会进行整理，将最小的那个做为C的同步时间戳，本例中T1即为C的同步时间戳为T1（即所有T1以前写的数据都已经同步到C上了）；同理，根据上述规则，tracker会为A、B生成一个同步时间戳。</p>
<p><br/></p>
<h3 id="6-功能比对"><a href="#6-功能比对" class="headerlink" title="6.功能比对"></a>6.功能比对</h3><p><strong>单机文件系统的对比</strong></p>
<table>
<thead>
<tr>
<th>文件系统</th>
<th>高可用</th>
<th>扩展</th>
<th>部署复杂程度</th>
<th>性能</th>
</tr>
</thead>
<tbody>
<tr>
<td>单机文件系统</td>
<td>低，依赖于单机服务器，只要服务器崩溃，完全不可用。</td>
<td>低，要扩容只能停机增加硬盘。</td>
<td>低</td>
<td>当文件数量多到一定的程度，磁盘IO寻址操作将会成为瓶颈</td>
</tr>
<tr>
<td>分布式文件系统</td>
<td>高，一个group内的服务器崩溃后，group内的其他storage将接管服务。</td>
<td>高，可以不停机增加group机器。</td>
<td>高，部署较复杂</td>
<td>高，通过集群或者分布式的方式分担服务器的压力。</td>
</tr>
</tbody>
</table>
<p><br/></p>
<p><strong>其他文件系统的对比</strong></p>
<table>
<thead>
<tr>
<th>指标</th>
<th style="text-align:center">适合类型</th>
<th style="text-align:right">文件分布</th>
<th>系统性能</th>
<th style="text-align:center">复杂度</th>
<th style="text-align:center">FUSE</th>
<th style="text-align:center">POSIX</th>
<th style="text-align:right">备份机制</th>
<th>通讯协议接口</th>
<th style="text-align:center">社区支持</th>
<th style="text-align:center">开发语言</th>
</tr>
</thead>
<tbody>
<tr>
<td>FastDFS</td>
<td style="text-align:center">4KB~500MB</td>
<td style="text-align:right">小文件合并存储不分片处理</td>
<td>很高</td>
<td style="text-align:center">简单</td>
<td style="text-align:center">不支持</td>
<td style="text-align:center">不支持</td>
<td style="text-align:right">组内冗余备份</td>
<td>Api HTTP</td>
<td style="text-align:center">国内用户群</td>
<td style="text-align:center">C语言</td>
</tr>
<tr>
<td>TFS</td>
<td style="text-align:center">所有文件</td>
<td style="text-align:right">小文件合并，以block组织分片</td>
<td></td>
<td style="text-align:center">复杂</td>
<td style="text-align:center">不支持</td>
<td style="text-align:center"></td>
<td style="text-align:right">Block存储多份,主辅灾备</td>
<td>API http</td>
<td style="text-align:center">少</td>
<td style="text-align:center">C++</td>
</tr>
<tr>
<td>MFS</td>
<td style="text-align:center">大于64K</td>
<td style="text-align:right">分片存储</td>
<td>Master占内存多</td>
<td style="text-align:center"></td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:right">多点备份动态冗余</td>
<td>使用fuse挂在</td>
<td style="text-align:center">较多</td>
<td style="text-align:center">Perl</td>
</tr>
<tr>
<td>HDFS</td>
<td style="text-align:center">大文件</td>
<td style="text-align:right">大文件分片分块存储</td>
<td></td>
<td style="text-align:center">简单</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:right">多副本</td>
<td>原生api</td>
<td style="text-align:center">较多</td>
<td style="text-align:center">Java</td>
</tr>
<tr>
<td>Ceph</td>
<td style="text-align:center">对象文件块</td>
<td style="text-align:right">OSD一主多从</td>
<td></td>
<td style="text-align:center">复杂</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:right">多副本</td>
<td>原生api</td>
<td style="text-align:center">较少</td>
<td style="text-align:center">C++</td>
</tr>
<tr>
<td>MogileFS</td>
<td style="text-align:center">海量小图片</td>
<td style="text-align:right"></td>
<td>高</td>
<td style="text-align:center">复杂</td>
<td style="text-align:center">可以支持</td>
<td style="text-align:center">不支持</td>
<td style="text-align:right">动态冗余</td>
<td>原生api</td>
<td style="text-align:center">文档少</td>
<td style="text-align:center">Perl</td>
</tr>
<tr>
<td>ClusterFS</td>
<td style="text-align:center">大文件</td>
<td style="text-align:right"></td>
<td></td>
<td style="text-align:center">简单</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:right"></td>
<td></td>
<td style="text-align:center">多</td>
<td style="text-align:center">C</td>
</tr>
</tbody>
</table>
<p><br/></p>
<h3 id="7-参考来源"><a href="#7-参考来源" class="headerlink" title="7.参考来源"></a>7.参考来源</h3><p>官方网站：<a href="https://github.com/happyfish100/" target="_blank" rel="noopener">https://github.com/happyfish100/</a><br>配置文档：<a href="https://github.com/happyfish100/fastdfs/wiki/" target="_blank" rel="noopener">https://github.com/happyfish100/fastdfs/wiki/</a><br>参考资料：<a href="https://www.oschina.net/question/tag/fastdfs" target="_blank" rel="noopener">https://www.oschina.net/question/tag/fastdfs</a><br>Java客户端：<a href="https://github.com/happyfish100/fastdfs-client-java" target="_blank" rel="noopener">https://github.com/happyfish100/fastdfs-client-java</a></p>
<hr>
<h2 id="0x01-FastDFS-安装使用"><a href="#0x01-FastDFS-安装使用" class="headerlink" title="0x01 FastDFS 安装使用"></a>0x01 FastDFS 安装使用</h2><p>描述: FastDFS 是一个开源的高性能分布式文件系统 (DFS), 下面我们进行简单的安装配置使用。</p>
<h3 id="1-Linux-安装"><a href="#1-Linux-安装" class="headerlink" title="1.Linux 安装"></a>1.Linux 安装</h3><p>描述: 在Linux我们常用CentOS或者Ubuntu作为服务器进行安装和使用，下面我将分别在CentOS以及Ubuntu中进行安装FastDFS。</p>
<h4 id="1-1-CentOS-单机部署-FastDFS"><a href="#1-1-CentOS-单机部署-FastDFS" class="headerlink" title="1.1) CentOS 单机部署 FastDFS"></a>1.1) CentOS 单机部署 FastDFS</h4><p><strong>环境描述:</strong></p>
<ul>
<li>(1) 软件版本</li>
</ul>
<table>
<thead>
<tr>
<th>软件包</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS</td>
<td>7.6 (1810)</td>
</tr>
<tr>
<td>FastDFS</td>
<td>v5.11 master</td>
</tr>
<tr>
<td>libfastcommon</td>
<td>v1.0.39 master</td>
</tr>
<tr>
<td>fastdfs-nginx-module</td>
<td>v1.20 master</td>
</tr>
<tr>
<td>nginx</td>
<td>v1.15.4 stable</td>
</tr>
</tbody>
</table>
<ul>
<li><p>(2) 磁盘目录准备:  创建数据和日志存储位置<code>mkdir /home/fdfs</code>以及所有安装包下载解压目录<code>/usr/local/src</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /home/fdfs/&#123;tracker,storage&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>(3) 服务器地址及其端口: 10.10.107.232 (22122 、8080 / 23000 / 8888)</p>
</li>
</ul>
<p><br/></p>
<p><strong>安装步骤:</strong></p>
<ul>
<li>Step 1.编译安装libfatscommon、FastDFS、fastdfs-nginx-module三大件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 libfatscommon</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1</span><br><span class="line"><span class="built_in">cd</span> libfastcommon/ &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 FastDFS</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1</span><br><span class="line"><span class="built_in">cd</span> fastdfs/ &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span><br><span class="line"><span class="comment"># FastDFS 配置文件准备</span></span><br><span class="line">cp /etc/fdfs/tracker.conf.sample /etc/fdfs/tracker.conf <span class="comment"># fastdfs tracker 服务配置文件</span></span><br><span class="line">cp /etc/fdfs/storage.conf.sample /etc/fdfs/storage.conf <span class="comment"># fastdfs storage 服务配置文件</span></span><br><span class="line">cp /etc/fdfs/client.conf.sample /etc/fdfs/client.conf   <span class="comment">#客户端文件，测试用</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs/conf/http.conf /etc/fdfs/     <span class="comment">#供nginx访问使用</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs/conf/mime.types /etc/fdfs/    <span class="comment">#供nginx访问使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装下载 fastdfs-nginx-module 并将配置文件复制到 /etc/fdfs/etc/fdfs</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1</span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/mod_fastdfs.conf /etc/fdfs</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : <code>Fastdfs-nginx-module</code> 模块是自定义的nginx模块,FastDFS 通过 Tracker 服务器，将文件放在 Storage 服务器存储，但是同组存储服务器之间需要进行文件复制，有同步延迟的问题。假设 Tracker 服务器将文件上传到了 10.10.107.234，上传成功后文件 ID已经返回给客户端。时 FastDFS 存储集群机制会将这个文件同步到同组存储 10.10.107.235，在文件还没有复制完成的情况下，客户端如果用这个文件 ID 在 10.10.107.234 上取文件,就会出现文件无法访问的错误。而该模块可以重定向文件链接到源服务器取文件，避免客户端由于复制延迟导致的文件无法访问错误。</p>
<p><br/></p>
<ul>
<li>Step 2.编译安装 nginx (原来测试时此处非最新版本1.15.4)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.15.4.tar.gz &amp;&amp; tar -zxvf nginx-1.15.4.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.15.4/</span><br><span class="line"><span class="comment">#添加fastdfs-nginx-module模块</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src</span><br><span class="line"><span class="comment">#编译安装</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 3.FastDFS单机部署流程，对于我的使用场景只是做一个文件服务器，所以无需部署分布式集群，我们将 tracker 服务、storage 服务、 nginx 服务 部署在一台机器上就能完全满足系统的需求。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.tracker配置</span></span><br><span class="line"><span class="variable">$vim</span> /etc/fdfs/tracker.conf</span><br><span class="line"><span class="comment">#启用配置文件</span></span><br><span class="line">disabled=<span class="literal">false</span>   </span><br><span class="line"><span class="comment">#设置tracker的端口号        </span></span><br><span class="line">port=22122</span><br><span class="line"><span class="comment">#设置tracker的数据文件和日志目录（需预先创建）</span></span><br><span class="line">base_path=/home/fdfs/tracker </span><br><span class="line"> <span class="comment">#设置http端口号  </span></span><br><span class="line">http.server_port=8080</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.storage配置</span></span><br><span class="line"><span class="variable">$vim</span> /etc/fdfs/storage.conf</span><br><span class="line"><span class="comment"># storage服务端口</span></span><br><span class="line">port=23000</span><br><span class="line"><span class="comment"># 数据和日志文件存储根目录</span></span><br><span class="line">base_path=/home/dfs/storage</span><br><span class="line"><span class="comment"># 第一个存储目录</span></span><br><span class="line">store_path0=/home/dfs/storage</span><br><span class="line"><span class="comment"># tracker服务器IP和端口</span></span><br><span class="line">tracker_server=10.10.107.232:22122</span><br><span class="line"><span class="comment"># http访问文件的端口,和nginx中保持一致</span></span><br><span class="line">http.server_port=8888</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.client 配置</span></span><br><span class="line"><span class="variable">$vim</span> /etc/fdfs/client.conf</span><br><span class="line"><span class="comment"># 路径要和 storage 服务器相同 </span></span><br><span class="line">base_path=/home/dfs</span><br><span class="line"><span class="comment"># tracker 服务器 IP 和端口</span></span><br><span class="line">tracker_server=10.10.107.232:22122</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.ngx_fastdfs_module模块与Nginx配置</span></span><br><span class="line"><span class="variable">$vim</span> /etc/fdfs/mod_fastdfs.conf</span><br><span class="line"><span class="comment"># tracker服务器IP和端口</span></span><br><span class="line">tracker_server=10.10.107.232:22122</span><br><span class="line"><span class="comment"># URL是否带有group_name组名称</span></span><br><span class="line">url_have_group_name=<span class="literal">true</span></span><br><span class="line"><span class="comment"># storage 数据目录</span></span><br><span class="line">store_path0=/home/fdfs/storage</span><br><span class="line"></span><br><span class="line">$ <span class="comment"># - 配置nginx.config - #</span></span><br><span class="line"><span class="comment"># 添加如下配置</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen       8888;      <span class="comment"># 该端口为storage.conf中的http.server_port相同</span></span><br><span class="line">  server_name  localhost;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 方式1.ngx_fastdfs_module模块加载使用</span></span><br><span class="line">  location ~/group[0-9]/ &#123;</span><br><span class="line">    ngx_fastdfs_module;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 方式2.添加如下行，将 /group1/M00 指定要或者映射到 /home/dfs/storage/data</span></span><br><span class="line">  <span class="comment"># location ~/group([0-9])/M00 &#123;</span></span><br><span class="line">  <span class="comment">#   root  /home/dfs/storage/data;</span></span><br><span class="line">  <span class="comment">#   # alias /home/dfs/storage/data;</span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">  error_page   500 502 503 504  /50x.html;</span><br><span class="line">  location = /50x.html &#123;</span><br><span class="line">    root   html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 4.防火墙规则设置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tracker</span></span><br><span class="line">iptables -I INPUT -p tcp -m state --state NEW -m tcp --dport 22122 -j ACCEP</span><br><span class="line"><span class="comment"># Storage</span></span><br><span class="line">iptables -I INPUT -p tcp -m state --state NEW -m tcp --dport 23000 -j ACCEP</span><br><span class="line"><span class="comment"># Nginx</span></span><br><span class="line">iptables -I INPUT -p tcp -m state --state NEW -m tcp --dport 8888 -j ACCEP</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 5.tracker、storage、nginx 服务启动 （注意启动顺序）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tracker 服务启动</span></span><br><span class="line">/etc/init.d/fdfs_trackerd [start|restart|stop]   <span class="comment"># 启动/重启动/停止tracker服务</span></span><br><span class="line">chkconfig fdfs_trackerd on                       <span class="comment"># 自启动tracker服务</span></span><br><span class="line">service fdfs_trackerd start</span><br><span class="line"></span><br><span class="line"><span class="comment"># storage 服务启动</span></span><br><span class="line">/etc/init.d/fdfs_storaged start|restart|stop  <span class="comment"># 启动/重启动/停止storage服务</span></span><br><span class="line">chkconfig fdfs_storaged on                    <span class="comment">#自启动storage服务</span></span><br><span class="line">service fdfs_storaged start</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx 服务启动</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx           <span class="comment"># 启动nginx</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload <span class="comment"># 重启nginx</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s stop   <span class="comment"># 停止nginx</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>Step 6.启动完上面的服务之后，我们可以进行上传测试。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存后测试,返回ID表示成功 如：group1/M00/00/00/xx.tar.gz</span></span><br><span class="line">fdfs_upload_file /etc/fdfs/client.conf /usr/<span class="built_in">local</span>/src/nginx-1.15.4.tar.gz</span><br><span class="line">group1/M00/00/00/wKgAQ1pysxmAaqhAAA76tz-dVgg.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试下载，用外部浏览器访问刚才已传过的nginx安装包,引用返回的ID</span></span><br><span class="line">http://10.10.107.232:8888/group1/M00/00/00/wKgAQ1pysxmAaqhAAA76tz-dVgg.tar.gz</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<p><strong>附录编译安装Shell脚本: (有fastdfs项目的改变自己需要进行修改)</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># data: 2019-07-23</span></span><br><span class="line"><span class="comment"># for: install FastDFS on CentOS7</span></span><br><span class="line"><span class="comment"># 安装编译依赖</span></span><br><span class="line">yum install git gcc gcc-c++ make automake autoconf libtool pcre pcre-devel zlib zlib-devel openssl-devel wget  -y</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1</span><br><span class="line"><span class="built_in">cd</span> libfastcommon/</span><br><span class="line">./make.sh &amp;&amp; ./make.sh install</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1</span><br><span class="line"><span class="built_in">cd</span> fastdfs/</span><br><span class="line">./make.sh &amp;&amp; ./make.sh install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件准备</span></span><br><span class="line">cp /etc/fdfs/tracker.conf.sample /etc/fdfs/tracker.conf</span><br><span class="line">cp /etc/fdfs/storage.conf.sample /etc/fdfs/storage.conf</span><br><span class="line">cp /etc/fdfs/client.conf.sample /etc/fdfs/client.conf</span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs/conf/http.conf /etc/fdfs/</span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs/conf/mime.types /etc/fdfs/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1</span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/mod_fastdfs.conf /etc/fdfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装 nginx</span></span><br><span class="line"><span class="built_in">cd</span>../</span><br><span class="line">wget http://nginx.org/download/nginx-1.15.4.tar.gz</span><br><span class="line">tar -zxvf nginx-1.15.4.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.15.4/</span><br><span class="line">./configure --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/nginx/sbin/nginx /usr/bin/nginx</span><br></pre></td></tr></table></figure></p>
<p>至此使用Ubuntu安装FastDFS完毕!</p>
<p><br></p>
<h4 id="1-2-Ubuntu-主从部署-FastDFS"><a href="#1-2-Ubuntu-主从部署-FastDFS" class="headerlink" title="1.2) Ubuntu 主从部署 FastDFS"></a>1.2) Ubuntu 主从部署 FastDFS</h4><p>描述: 在CentOS我们是进行的单机部署,此处我们采用两台机器进行FastDFS集群的配置部署，</p>
<p>storage 集群配置两种方式:</p>
<ul>
<li><p>(1) Multiple volume : 如果为单个group配置多个storage的话，指定相同的group_name即可,此时拥有相同的组名的机器将会有一台被选为主，于此同时有几个节点将会有几个副本。</p>
</li>
<li><p>(2) Multiple group : 如果group_name配置不同即为创建不同的组，此处每个group下的storage都是单独的个体，个个都是主。</p>
</li>
</ul>
<p><strong>环境说明:</strong></p>
<ul>
<li>操作系统以及网络地址</li>
</ul>
<table>
<thead>
<tr>
<th>ROLE</th>
<th>IP 地址</th>
<th>CPU、内存</th>
<th>发行版以及内核</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>10.10.107.225</td>
<td>4C/8G</td>
<td>Ubuntu 20.04.2 LTS (5.4.0-88-generic)</td>
<td>Tracker/Storage/Nginx</td>
</tr>
<tr>
<td>slave</td>
<td>10.10.107.225</td>
<td>4C/2G</td>
<td>Ubuntu 20.04.2 LTS (5.4.0-88-generic)</td>
<td>Tracker/Storage</td>
</tr>
</tbody>
</table>
<ul>
<li>软件版本一览<ul>
<li>Fastdfs : 6.07</li>
<li>Nginx : 1.21.1</li>
</ul>
</li>
</ul>
<p><br/></p>
<p><strong>安装部署:</strong></p>
<ul>
<li>Step 1.基础环境准备Fastdfs数据目录以及执行用户创建、和机器别名（两台都要执行）。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.软件仓库更新以及依赖下载</span></span><br><span class="line">sudo apt-get update </span><br><span class="line">sudo apt-get install git wget gcc make automake autoconf libtool libpcre3 libpcre3-dev zlib1g-dev build-essential</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.fastdfs 运行用户创建以及家目录创建。</span></span><br><span class="line"><span class="comment"># 此处巍峨采用普通用户运行fasfdfs以及nginx，为了安全考虑非常建议。</span></span><br><span class="line">groupadd fdfs &amp;&amp; useradd -m -d /home/fdfs -g fdfs fdfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.分别创建服务和数据存储目录</span></span><br><span class="line">mkdir -vp /home/fdfs/&#123;storage,tracker,client&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.机器别名</span></span><br><span class="line">tee -a /etc/hosts &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">10.10.107.225 file1.weiyigeek.top</span><br><span class="line">10.10.107.226 file2.weiyigeek.top</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li>Step 2.从Github上拉取Fastdfs相关项目和依赖到本地、进行编译安装。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.拉取Github代码仓库中Fastdfs ( --depth 1 用于指定克隆深度，为1即表示只克隆最近一次commit的代码，减少下载时间和存储空间)</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1 \</span><br><span class="line">&amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1    \</span><br><span class="line">&amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.编译安装</span></span><br><span class="line"><span class="built_in">cd</span> libfastcommon &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span><br><span class="line"><span class="built_in">cd</span> ../fastdfs &amp;&amp; ./make.sh &amp;&amp; ./make.sh install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.配置文件复制</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs/conf/http.conf  /etc/fdfs/   <span class="comment"># fastdfs-nginx-module模块自配置文件供nginx访问使用</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs/conf/mime.types /etc/fdfs/   <span class="comment"># fastdfs-nginx-module模块自配置文件供nginx访问使用</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/mod_fastdfs.conf /etc/fdfs/  <span class="comment"># mod_fastdfs.conf 模块自配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.备份配置文件</span></span><br><span class="line">cp /etc/fdfs/storage.conf /etc/fdfs/storage.conf-bak   </span><br><span class="line">cp /etc/fdfs/tracker.conf /etc/fdfs/tracker.conf-bak</span><br><span class="line">cp /etc/fdfs/client.conf  /etc/fdfs/client.conf-bak</span><br><span class="line">cp /etc/fdfs/mod_fastdfs.conf  /etc/fdfs/mod_fastdfs.conf-bak</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 3.Nginx 负载均衡服务器编译安装<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx 源码下载</span></span><br><span class="line">wget http://nginx.org/download/nginx-1.20.1.tar.gz -O /usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src &amp;&amp; tar -zxvf nginx-1.20.1.tar.gz -C .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 fastdfs-nginx-module 中的文件</span></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src</span><br><span class="line">common.c  common.h  config  mod_fastdfs.conf  ngx_http_fastdfs_module.c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装 Nginx (此处我们指定了执行用户为fdfs是为了安全采用最小权限执行) , 此处未添加SSL支持如需要请百度，在编译时加入openssl功能。</span></span><br><span class="line"><span class="built_in">cd</span> ../nginx-1.20.1/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx \</span><br><span class="line">--user=fdfs \</span><br><span class="line">--group=fdfs \</span><br><span class="line">--pid-path=/usr/<span class="built_in">local</span>/nginx/logs/nginx.pid \</span><br><span class="line">--add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 4.为Tracker 、Storage 、Nginx 配置systemd管理的服务（6.07 默认生成的services服务文件启动时会卡在systemctl界面，我们需要进行更改其systemd服务文件）。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.命令行替方式 (注意以下配置的路径是与后续在配置中配置路径强关联)</span></span><br><span class="line"><span class="comment"># sed -i 's/Type=forking/&amp;\nUser=fdfs\nGroup=fdfs/' /lib/systemd/system/fdfs_storaged.service</span></span><br><span class="line"><span class="comment"># sed -i 's#/opt/fastcfs/data#/home/fdfs/storage/data#g' /lib/systemd/system/fdfs_storaged.service</span></span><br><span class="line"><span class="comment"># sed -i '/PIDFile/i WorkingDirectory=/home/fdfs/storage' /lib/systemd/system/fdfs_storaged.service</span></span><br><span class="line"><span class="comment"># sed -i '/ExecStop/a ExecReload=/usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart' /lib/systemd/system/fdfs_storaged.service</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.service 替换方式</span></span><br><span class="line"><span class="comment"># /lib/systemd/system/fdfs_trackerd.service</span></span><br><span class="line">cat &gt; /lib/systemd/system/fdfs_trackerd.service &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=FastDFS trackerd service</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment"># User=fdfs</span></span><br><span class="line"><span class="comment"># Group=fdfs</span></span><br><span class="line">WorkingDirectory=/home/fdfs/tracker</span><br><span class="line">PIDFile=/home/fdfs/tracker/data/fdfs_trackerd.pid</span><br><span class="line">ExecStart=/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf start</span><br><span class="line">ExecStop=/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf stop</span><br><span class="line">ExecReload=/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># No artificial start/stop timeout</span></span><br><span class="line">TimeoutSec=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable OOM kill by Linux kernel</span></span><br><span class="line">OOMScoreAdjust=-1000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /lib/systemd/system/fdfs_storaged.service</span></span><br><span class="line">cat &gt; /lib/systemd/system/fdfs_storaged.service &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=FastDFS storaged service</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment"># User=fdfs</span></span><br><span class="line"><span class="comment"># Group=fdfs</span></span><br><span class="line">WorkingDirectory=/home/fdfs/storage</span><br><span class="line">PIDFile=/home/fdfs/storage/data/fdfs_storaged.pid</span><br><span class="line">ExecStart=/usr/bin/fdfs_storaged /etc/fdfs/storage.conf start</span><br><span class="line">ExecStop=/usr/bin/fdfs_storaged /etc/fdfs/storage.conf stop</span><br><span class="line">ExecReload=/usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># No artificial start/stop timeout</span></span><br><span class="line">TimeoutSec=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable OOM kill by Linux kernel</span></span><br><span class="line">OOMScoreAdjust=-1000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">tee /usr/lib/systemd/system/nginx.service&lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Nginx - high performance web server service</span><br><span class="line">Documentation=http://nginx.org/en/docs/ </span><br><span class="line">After=network-online.target remote-fs.target nss-lookup.target </span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/<span class="built_in">local</span>/nginx/logs/nginx.pid</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">ExecStop=/bin/<span class="built_in">kill</span> -s TERM <span class="variable">$MAINPID</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.老规矩重载systemd使编辑的service生效</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.此处我们暂时不启用服务，我们还需进行后续的配置</span></span><br><span class="line">systemctl stop fdfs_storaged.service fdfs_trackerd.service nginx.service</span><br><span class="line">systemctl status fdfs_storaged.service fdfs_trackerd.service nginx.service</span><br></pre></td></tr></table></figure>
<p>Tips : 非常注意 Tracker 、Storage 生成的pid的路径分别为<code>/home/fdfs/tracker/data/fdfs_trackerd.pid</code>和<code>/home/fdfs/storage/data/fdfs_storaged.pid</code></p>
<p><br/></p>
<ul>
<li>Step 5.两台机器的Tracker服务主要配置。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$vim</span> /etc/fdfs/tracker.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Master 端- #</span></span><br><span class="line"><span class="comment"># 是否禁用配置文件 (当然False了)</span></span><br><span class="line">disabled = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 绑定指定监听的网卡地址否则留空则为全部网卡。</span></span><br><span class="line">bind_addr = 10.10.107.225</span><br><span class="line"><span class="comment"># tracker 服务端口</span></span><br><span class="line">port = 22122</span><br><span class="line"><span class="comment"># tracker 服务data和logs存储目录 (可以分开也可以全部设置storage中)</span></span><br><span class="line"><span class="comment"># sed -i "s#/home/yuqing/fastdfs#/home/fdfs/tracker#g" /etc/fdfs/tracker.conf</span></span><br><span class="line">base_path = /home/fdfs/tracker</span><br><span class="line"><span class="comment"># 为系统或其他应用程序保留的存储空间。</span></span><br><span class="line">reserved_storage_space = 10%</span><br><span class="line"><span class="comment"># 指定用户运行 tracker 服务</span></span><br><span class="line">run_by_user = fdfs</span><br><span class="line">run_by_group = fdfs</span><br><span class="line"><span class="comment"># 指定访问白名单默认所有都可访问 (正式环境一定要设置)</span></span><br><span class="line">allow_hosts = *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Slave 端- #</span></span><br><span class="line">disabled = <span class="literal">false</span></span><br><span class="line">bind_addr = 10.10.107.226   <span class="comment"># 不同点</span></span><br><span class="line">port = 22122</span><br><span class="line">base_path = /home/fdfs/tracker</span><br><span class="line">reserved_storage_space = 10%</span><br><span class="line">run_by_user = fdfs</span><br><span class="line">run_by_group = fdfs</span><br><span class="line">allow_hosts = *</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 6.两台机器的Storage服务主要配置。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/fdfs/storage.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># - Master 端- #</span></span><br><span class="line"><span class="comment"># 是否禁用配置文件 (当然False了)</span></span><br><span class="line">disabled = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 此存储服务器所属的组的名称 (多个组可以将此组名进行更改) ，</span></span><br><span class="line">group_name = group1</span><br><span class="line"><span class="comment"># 绑定指定监听的网卡地址否则留空则为全部网卡。</span></span><br><span class="line">bind_addr = 10.10.107.225</span><br><span class="line"><span class="comment"># storage 服务端口</span></span><br><span class="line">port = 23000</span><br><span class="line"><span class="comment"># storage 服务 data和logs 存储目录 </span></span><br><span class="line"><span class="comment"># sed -i "s#/home/yuqing/fastdfs#/home/fdfs/storage#g" /etc/fdfs/storage.conf</span></span><br><span class="line">base_path = /home/fdfs/storage</span><br><span class="line"><span class="comment"># storage 服务数据存储目录 (the base_path should be independent (different) of the store paths)</span></span><br><span class="line">store_path0 = /home/fdfs/storage</span><br><span class="line"><span class="comment"># 指定tracker_server地址和服务端口，如有多台则填多个。如果有外网地址可以在,</span></span><br><span class="line">tracker_server = 10.10.107.225:22122</span><br><span class="line">tracker_server = 10.10.107.226:22122</span><br><span class="line"><span class="comment"># 指定用户和用户组运行storage服务</span></span><br><span class="line">run_by_group = fdfs</span><br><span class="line">run_by_user = fdfs</span><br><span class="line"><span class="comment"># 指定可以访问 storage 的主机 (白名单机制)</span></span><br><span class="line">allow_hosts = *</span><br><span class="line"><span class="comment"># 作为上载文件的源服务器的优先级，此值越低，其上载优先级越高。默认值为10</span></span><br><span class="line">upload_priority = 10</span><br><span class="line"><span class="comment"># 如果域名为空，请使用此存储服务器的ip地址，否则该域名将出现在跟踪服务器重定向的url中</span></span><br><span class="line">http.domain_name = file1.weiyigeek.top</span><br><span class="line"><span class="comment"># 此存储服务器上web服务器的端口 与 Nginx 监听端口是对应的。</span></span><br><span class="line">http.server_port = 8888</span><br><span class="line"></span><br><span class="line"><span class="comment"># - Slave 端- #</span></span><br><span class="line">disabled = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 此处由于master、slave要进行组同步所以此处必须是一致的。</span></span><br><span class="line">group_name = group1</span><br><span class="line">bind_addr = 10.10.107.226            <span class="comment"># 不同点</span></span><br><span class="line">port = 23000</span><br><span class="line">base_path = /home/fdfs/storage</span><br><span class="line">store_path0 = /home/fdfs/storage</span><br><span class="line">tracker_server = 10.10.107.225:22122</span><br><span class="line">tracker_server = 10.10.107.226:22122</span><br><span class="line">run_by_group = fdfs</span><br><span class="line">run_by_user = fdfs</span><br><span class="line">allow_hosts = *</span><br><span class="line">upload_priority = 10</span><br><span class="line">http.domain_name = file2.weiyigeek.top <span class="comment"># 不同点</span></span><br><span class="line">http.server_port = 8888</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Tips : 根据需求进行设置A机房的所有storage配置中的priority为1，设置B机房的所有storage配置中的priority为10进行数据上传；</p>
<p><br/></p>
<ul>
<li>Step 7.两台机器的client.conf主要配置, 可选配置如果Master与Slave的机器只是作为存储而非fastdfs时此处可以省略，此处假设使用Master 端作为fastdfs客户端进行上传文件进行测试。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/fdfs/client.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># - Master 端- #</span></span><br><span class="line"><span class="comment"># clinet 存储日志文件的基本路径</span></span><br><span class="line"><span class="comment"># sed -i "s#/home/yuqing/fastdfs#/home/fdfs/client#g" /etc/fdfs/client.conf</span></span><br><span class="line">base_path = /home/fdfs/client</span><br><span class="line"></span><br><span class="line"><span class="comment"># tracker server 地址以及端口(如果有多个则填写多个tracker_server)</span></span><br><span class="line">tracker_server = 10.10.107.225:22122</span><br><span class="line">tracker_server = 10.10.107.226:22122</span><br><span class="line"></span><br><span class="line"><span class="comment"># tracker HTTP 端口</span></span><br><span class="line">http.tracker_server_port = 8080</span><br></pre></td></tr></table></figure>
<p>Tips : 如果storage使用ids来标识，而不是用ip则storage_ids.conf配置文件需要配置。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) storage_ids.conf</span></span><br><span class="line"><span class="comment"># &lt;id&gt;     &lt;group_name&gt;  &lt;ip_or_hostname&gt;</span></span><br><span class="line">100001   group1  192.168.0.196</span><br><span class="line">100002   group1  192.168.0.116</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) tracker.conf </span></span><br><span class="line">use_storage_id = <span class="literal">false</span></span><br><span class="line">storage_ids_filename = storage_ids.conf</span><br><span class="line">id_type_in_filename = ip</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) storage.conf</span></span><br><span class="line">group_name=group1  <span class="comment"># 需要与上面的组名对应</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) client.conf 中也有两处需要修改：</span></span><br><span class="line">use_storage_id = <span class="literal">false</span></span><br><span class="line">storage_ids_filename = storage_ids.conf</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<ul>
<li>Step 8.两台机器的mod_fastdfs模块主要配置, 可选配置如果Master与Slave的机器只是作为存储而非web服务器时此处可以省略。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/fdfs/mod_fastdfs.conf</span><br><span class="line"><span class="comment"># - Master 端- #</span></span><br><span class="line"><span class="comment"># mod_fastdfs 日志存储目录</span></span><br><span class="line">base_path=/tmp</span><br><span class="line"><span class="comment"># 本地存储服务器组名</span></span><br><span class="line">group_name=group1</span><br><span class="line"><span class="comment"># URL 中是否带组名</span></span><br><span class="line">url_have_group_name = <span class="literal">true</span></span><br><span class="line"><span class="comment"># 本地存储服务器服务端口</span></span><br><span class="line">storage_server_port=23000</span><br><span class="line"><span class="comment"># 本地存储服务器服务数据目录 必须和storage.conf配置一致。</span></span><br><span class="line">store_path0=/home/fdfs/storage</span><br><span class="line"><span class="comment"># FastDFS tracker_server</span></span><br><span class="line">tracker_server=file1.weiyigeek.top:22122</span><br><span class="line">tracker_server=file2.weiyigeek.top:22122</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># - Slave 端- #</span></span><br><span class="line">base_path=/tmp</span><br><span class="line">group_name=group1</span><br><span class="line">url_have_group_name = <span class="literal">true</span></span><br><span class="line">storage_server_port=23000</span><br><span class="line">store_path0=/home/fdfs/data</span><br><span class="line">tracker_server=file1.weiyigeek.top:22122</span><br><span class="line">tracker_server=file2.weiyigeek.top:22122</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li>Step 8.两台机器的nginx.conf配置,可选配置如果Master与Slave的机器只是作为存储而非web服务器时此处可以省略。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master Slave 配置是一致的除了server_name。</span></span><br><span class="line"><span class="variable">$vim</span> /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line">user  fdfs;</span><br><span class="line">worker_processes  1;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line">server &#123;</span><br><span class="line">  listen       8888;</span><br><span class="line">  server_name  file1.weiyigeek.top;</span><br><span class="line">  location ~/group[0-9]/ &#123;</span><br><span class="line">    ngx_fastdfs_module;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">      root   html;</span><br><span class="line">      index  index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">  error_page   500 502 503 504  /50x.html;</span><br><span class="line">  location = /50x.html &#123;</span><br><span class="line">      root   html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 9.设置目录所属权限以及防火墙规则设置。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 相关目录文件所属组赋予,防止权限问题导致不能运行相关服务。</span></span><br><span class="line">chown -R fdfs:fdfs /home/fdfs</span><br><span class="line">chown -R fdfs:fdfs /usr/<span class="built_in">local</span>/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 防火墙设置</span></span><br><span class="line"><span class="comment"># - Master 端- #</span></span><br><span class="line">sudo ufw allow proto tcp from 10.10.107.0/24 to port 10.10.107.225 22122</span><br><span class="line">sudo ufw allow proto tcp from 10.10.107.0/24 to port 10.10.107.225 23000</span><br><span class="line">sudo ufw allow 8888/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># - Slave 端- #</span></span><br><span class="line">sudo ufw allow proto tcp from 10.10.107.0/24 to port 10.10.107.226 22122</span><br><span class="line">sudo ufw allow proto tcp from 10.10.107.0/24 to port 10.10.107.226 23000</span><br><span class="line">sudo ufw allow 8888/tcp</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 10.分别启动两台主机中tracker、storage、nginx三个服务。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.分别启动三个服务（先Master启动后在启动Slave的）</span></span><br><span class="line">systemctl start fdfs_trackerd.service &amp;&amp; systemctl status fdfs_trackerd.service</span><br><span class="line">  <span class="comment"># ● fdfs_trackerd.service - FastDFS trackerd service</span></span><br><span class="line">  <span class="comment">#     Loaded: loaded (/lib/systemd/system/fdfs_trackerd.service; disabled; vendor preset: enabled)</span></span><br><span class="line">  <span class="comment">#     Active: active (running) since Sat 2021-10-30 23:01:56 CST; 7ms ago</span></span><br><span class="line"></span><br><span class="line">systemctl start fdfs_storaged.service &amp;&amp; systemctl status fdfs_storaged.service </span><br><span class="line">  <span class="comment"># ● fdfs_storaged.service - FastDFS storaged service</span></span><br><span class="line">  <span class="comment">#     Loaded: loaded (/lib/systemd/system/fdfs_storaged.service; disabled; vendor preset: enabled)</span></span><br><span class="line">  <span class="comment">#     Active: active (running) since Sat 2021-10-30 23:21:18 CST; 7ms ago</span></span><br><span class="line">  <span class="comment"># Oct 30 23:21:18 elk1 systemd[1]: Starting FastDFS storaged service...</span></span><br><span class="line">  <span class="comment"># Oct 30 23:21:18 elk1 systemd[1]: fdfs_storaged.service: Can't open PID file /home/fdfs/storage/data/fdfs_storaged.pid (yet?) after start: Operation not permitted  # 总说我没得权限感觉是Bug</span></span><br><span class="line">  <span class="comment"># Oct 30 23:21:18 elk1 systemd[1]: Started FastDFS storaged service.</span></span><br><span class="line"></span><br><span class="line">systemctl start nginx.service &amp;&amp;  systemctl status nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.fastdfs相关进程查看</span></span><br><span class="line">$ ps aux | grep <span class="string">"fdfs"</span></span><br><span class="line">fdfs     1304830  0.0  0.3 145704  6140 ?        Sl   22:55   0:00 /usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf start</span><br><span class="line">fdfs     1305056  1.8  0.2 141184  4036 ?        Sl   22:56   0:00 /usr/bin/fdfs_storaged /etc/fdfs/storage.conf start</span><br><span class="line">fdfs     1305106  0.0  0.0   6372   424 ?        Ss   22:57   0:00 nginx: master process /usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line">fdfs     1305107  0.0  0.1   7288  3736 ?        S    22:57   0:00 nginx: worker process</span><br><span class="line">root     1305136  0.0  0.0   6300   664 pts/0    S+   22:57   0:00 grep --color=auto fdfs</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li>Step 11.fastdfs 主从同步状态以及节点监控。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/fdfs_monitor /etc/fdfs/storage.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.未启用anti_steal_token校验</span></span><br><span class="line">[2021-10-30 16:10:01] DEBUG - base_path=/home/fdfs/client, connect_timeout=5, network_timeout=60, tracker_server_count=2, anti_steal_token=0, anti_steal_secret_key length=0, use_connection_pool=0, g_connection_pool_max_idle_time=3600s, use_storage_id=0, storage server id count: 0</span><br><span class="line">server_count=2, server_index=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.tracker 主服务节点相关信息</span></span><br><span class="line">tracker server is 10.10.107.225:22122</span><br><span class="line">group count: 1</span><br><span class="line">Group 1:</span><br><span class="line">group name = group1</span><br><span class="line">disk total space = 98,265 MB</span><br><span class="line">disk free space = 78,322 MB</span><br><span class="line">trunk free space = 0 MB</span><br><span class="line">storage server count = 2</span><br><span class="line">active server count = 2</span><br><span class="line">storage server port = 23000</span><br><span class="line">storage HTTP port = 8888</span><br><span class="line">store path count = 1</span><br><span class="line">subdir count per path = 256</span><br><span class="line">current write server index = 0</span><br><span class="line">current trunk file id = 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.主从节点存储状态信息以及同步状态（下述针对关键的参数进行说明）</span></span><br><span class="line"><span class="comment"># 会显示会有几台服务器 有3台就会 显示 Storage 1-Storage 3的详细信息</span></span><br><span class="line">Storage 1:</span><br><span class="line">  id = 10.10.107.225</span><br><span class="line">  ip_addr = 10.10.107.225  ACTIVE   <span class="comment"># 表示节点在线活动</span></span><br><span class="line">  http domain = file1.weiyigeek.top <span class="comment"># 配置文件中设置域名</span></span><br><span class="line">  version = 6.07                    <span class="comment"># storage 服务版本 </span></span><br><span class="line">  join time = 2021-10-30 12:55:03</span><br><span class="line">  up time = 2021-10-30 16:06:38</span><br><span class="line">  total storage = 98,265 MB         <span class="comment"># 存储总空间大小</span></span><br><span class="line">  free storage = 78,322 MB</span><br><span class="line">  upload priority = 10</span><br><span class="line">  store_path_count = 1</span><br><span class="line">  subdir_count_per_path = 256</span><br><span class="line">  storage_port = 23000          </span><br><span class="line">  storage_http_port = 8888</span><br><span class="line">  current_write_path = 0</span><br><span class="line">  <span class="built_in">source</span> storage id =              <span class="comment"># 来源storage 由于本身是主所以为空。</span></span><br><span class="line">  if_trunk_server = 0</span><br><span class="line">  connection.alloc_count = 256     <span class="comment"># 连接相关配置。</span></span><br><span class="line">  connection.current_count = 1</span><br><span class="line">  connection.max_count = 1</span><br><span class="line">  total_upload_count = 1           <span class="comment"># fastdfs 系列操作统计。</span></span><br><span class="line">  success_upload_count = 1</span><br><span class="line">  total_append_count = 0</span><br><span class="line">  success_append_count = 0</span><br><span class="line">  total_modify_count = 0</span><br><span class="line">  success_modify_count = 0</span><br><span class="line">  total_truncate_count = 0</span><br><span class="line">  success_truncate_count = 0</span><br><span class="line">  total_set_meta_count = 0</span><br><span class="line">  success_set_meta_count = 0</span><br><span class="line">  total_delete_count = 0</span><br><span class="line">  success_delete_count = 0</span><br><span class="line">  total_download_count = 0</span><br><span class="line">  success_download_count = 0</span><br><span class="line">  total_get_meta_count = 0</span><br><span class="line">  success_get_meta_count = 0</span><br><span class="line">  total_create_link_count = 0</span><br><span class="line">  success_create_link_count = 0</span><br><span class="line">  total_delete_link_count = 0</span><br><span class="line">  success_delete_link_count = 0</span><br><span class="line">  total_upload_bytes = 595</span><br><span class="line">  success_upload_bytes = 595</span><br><span class="line">  total_append_bytes = 0</span><br><span class="line">  success_append_bytes = 0</span><br><span class="line">  total_modify_bytes = 0</span><br><span class="line">  success_modify_bytes = 0</span><br><span class="line">  stotal_download_bytes = 0</span><br><span class="line">  success_download_bytes = 0</span><br><span class="line">  total_sync_in_bytes = 0</span><br><span class="line">  success_sync_in_bytes = 0</span><br><span class="line">  total_sync_out_bytes = 0</span><br><span class="line">  success_sync_out_bytes = 0</span><br><span class="line">  total_file_open_count = 1</span><br><span class="line">  success_file_open_count = 1</span><br><span class="line">  total_file_read_count = 0</span><br><span class="line">  success_file_read_count = 0</span><br><span class="line">  total_file_write_count = 1</span><br><span class="line">  success_file_write_count = 1</span><br><span class="line">  last_heart_beat_time = 2021-10-30 16:09:39   <span class="comment"># 最后一次心跳监测时间</span></span><br><span class="line">  last_source_update = 2021-10-30 13:16:23     <span class="comment"># 最后一次异常来源更新</span></span><br><span class="line">  last_sync_update = 1970-01-01 08:00:00     </span><br><span class="line">  last_synced_timestamp = 1970-01-01 08:00:00 </span><br><span class="line">  </span><br><span class="line">Storage 2:</span><br><span class="line">  id = 10.10.107.226</span><br><span class="line">  ip_addr = 10.10.107.226  ACTIVE</span><br><span class="line">  http domain = file2.weiyigeek.top</span><br><span class="line">  version = 6.07</span><br><span class="line">  join time = 2021-10-30 15:37:13</span><br><span class="line">  up time = 2021-10-30 16:07:34</span><br><span class="line">  total storage = 98,265 MB</span><br><span class="line">  free storage = 84,390 MB</span><br><span class="line">  upload priority = 10</span><br><span class="line">  store_path_count = 1</span><br><span class="line">  subdir_count_per_path = 256</span><br><span class="line">  storage_port = 23000</span><br><span class="line">  storage_http_port = 8888</span><br><span class="line">  current_write_path = 0</span><br><span class="line">  <span class="built_in">source</span> storage id = 10.10.107.225   <span class="comment"># 由于本节点是从，所以其源节点为10.10.107.225</span></span><br><span class="line">  if_trunk_server = 0</span><br><span class="line">  connection.alloc_count = 256</span><br><span class="line">  connection.current_count = 1</span><br><span class="line">  connection.max_count = 1</span><br><span class="line">  total_upload_count = 0</span><br><span class="line">  success_upload_count = 0</span><br><span class="line">  total_append_count = 0</span><br><span class="line">  success_append_count = 0</span><br><span class="line">  total_modify_count = 0</span><br><span class="line">  success_modify_count = 0</span><br><span class="line">  total_truncate_count = 0</span><br><span class="line">  success_truncate_count = 0</span><br><span class="line">  total_set_meta_count = 0</span><br><span class="line">  success_set_meta_count = 0</span><br><span class="line">  total_delete_count = 0</span><br><span class="line">  success_delete_count = 0</span><br><span class="line">  total_download_count = 0</span><br><span class="line">  success_download_count = 0</span><br><span class="line">  total_get_meta_count = 0</span><br><span class="line">  success_get_meta_count = 0</span><br><span class="line">  total_create_link_count = 0</span><br><span class="line">  success_create_link_count = 0</span><br><span class="line">  total_delete_link_count = 0</span><br><span class="line">  success_delete_link_count = 0</span><br><span class="line">  total_upload_bytes = 0</span><br><span class="line">  success_upload_bytes = 0</span><br><span class="line">  total_append_bytes = 0</span><br><span class="line">  success_append_bytes = 0</span><br><span class="line">  total_modify_bytes = 0</span><br><span class="line">  success_modify_bytes = 0</span><br><span class="line">  stotal_download_bytes = 0</span><br><span class="line">  success_download_bytes = 0</span><br><span class="line">  total_sync_in_bytes = 595</span><br><span class="line">  success_sync_in_bytes = 595</span><br><span class="line">  total_sync_out_bytes = 0</span><br><span class="line">  success_sync_out_bytes = 0</span><br><span class="line">  total_file_open_count = 1</span><br><span class="line">  success_file_open_count = 1</span><br><span class="line">  total_file_read_count = 0</span><br><span class="line">  success_file_read_count = 0</span><br><span class="line">  total_file_write_count = 1</span><br><span class="line">  success_file_write_count = 1</span><br><span class="line">  last_heart_beat_time = 2021-10-30 16:09:34</span><br><span class="line">  last_source_update = 1970-01-01 08:00:00</span><br><span class="line">  last_sync_update = 2021-10-30 16:07:40    <span class="comment"># 最后一次同步更新时间</span></span><br><span class="line">  last_synced_timestamp = 2021-10-30 13:16:23 (0s delay) <span class="comment"># 上次同步时间戳</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li>Step 12.进行 fastdfs 服务验证我们准备如下文件进行上传测试。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备的上传的文件</span></span><br><span class="line">$ ls /tmp/1021/21500122111685 &amp;&amp; <span class="built_in">cd</span> /tmp/1021/21500122111685</span><br><span class="line">10.jpg  11.jpg  12.jpg  1.jpg  2.jpg  3.jpg  4.jpg  5.jpg  6.jpg  7.jpg  8.jpg  9.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示执行上传所占用的时间信息，并且由fastdfs返回</span></span><br><span class="line">$ time ls  | xargs -n 1 -I &#123;&#125; -P 256 sh -c <span class="string">"/usr/bin/fdfs_upload_file /etc/fdfs/client.conf &#123;&#125;"</span></span><br><span class="line">group1/M00/00/00/Cgpr4WF9Z1qAD-1kAALCR9qk6tY282.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4WF9Z1qAPuRNAAC5TGFpmYc275.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4WF9Z1qAXV3hAAHgDlFbt0w747.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4WF9Z1qAbg4zAAIMU22Vmv0167.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4WF9Z1qAGT_9AAM88j2xb3c943.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4mF9Z1qABz5WAAEZU9S6U0A142.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4mF9Z1qAEKxMAAK1nu1_3i4915.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4WF9Z1qAJcPTAAEti0emwI8838.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4mF9Z1uAfqqfAAJEhY4K8tk859.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4mF9Z1uADQKdAAHpbZKkwZM746.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4mF9Z1uAcHhMAAFdgfModII395.jpg</span><br><span class="line">group1/M00/00/00/Cgpr4mF9Z1uAJlVGAAFIRg4hpEg369.jpg</span><br><span class="line"></span><br><span class="line">real    0m0.014s</span><br><span class="line">user    0m0.020s</span><br><span class="line">sys     0m0.006s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证上传的文件</span></span><br><span class="line">wget -I http://10.10.107.225:8888/group1/M00/00/00/Cgpr4WF9Z1qAD-1kAALCR9qk6tY282.jpg</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li>Step 13.Tracker 与 storage 服务数据存储目录结构说明，当前面两个服务运行时将会自动创建<code>data、logs</code>这个两个目录:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tracker 服务目录</span></span><br><span class="line">/home/fdfs/tracker<span class="comment"># tree</span></span><br><span class="line">├── data</span><br><span class="line">│   ├── fdfs_trackerd.pid        <span class="comment"># systemd 监听的PID文件</span></span><br><span class="line">│   ├── storage_changelog.dat    <span class="comment"># storage 改变记录文件</span></span><br><span class="line">│   ├── storage_groups_new.dat   <span class="comment"># storage 分组信息记录文件</span></span><br><span class="line">│   ├── storage_servers_new.dat  <span class="comment"># storage 服务节点信息记录文件</span></span><br><span class="line">│   └── storage_sync_timestamp.dat <span class="comment"># storage 同步的时间戳</span></span><br><span class="line">└── logs</span><br><span class="line">    └── trackerd.log             <span class="comment"># trackerd 运行日志文件，默认级别 info、</span></span><br><span class="line">2 directories, 6 files</span><br><span class="line"></span><br><span class="line"><span class="comment"># Storage 服务目录 (Master 和 Slave 各自存储一份文件)</span></span><br><span class="line">/home/fdfs/storage<span class="comment"># tree . | more</span></span><br><span class="line">.</span><br><span class="line">├── data</span><br><span class="line">│   ├── 00</span><br><span class="line">│   │   ├── 00  <span class="comment"># 0</span></span><br><span class="line">│   │   │   ├── Cgpr4mF9Z1qABz5WAAEZU9S6U0A142.jpg  </span><br><span class="line">│   │   │   ├── Cgpr4mF9Z1qAEKxMAAK1nu1_3i4915.jpg</span><br><span class="line">│   │   │   ├── Cgpr4mF9Z1uAcHhMAAFdgfModII395.jpg</span><br><span class="line">│   │   │   ├── Cgpr4mF9Z1uADQKdAAHpbZKkwZM746.jpg</span><br><span class="line">│   │   │   ├── Cgpr4mF9Z1uAfqqfAAJEhY4K8tk859.jpg</span><br><span class="line">│   │   │   ├── Cgpr4mF9Z1uAJlVGAAFIRg4hpEg369.jpg</span><br><span class="line">│   │   │   ├── Cgpr4WF9Z1qAbg4zAAIMU22Vmv0167.jpg</span><br><span class="line">│   │   │   ├── Cgpr4WF9Z1qAD-1kAALCR9qk6tY282.jpg</span><br><span class="line">│   │   │   ├── Cgpr4WF9Z1qAGT_9AAM88j2xb3c943.jpg</span><br><span class="line">│   │   │   ├── Cgpr4WF9Z1qAJcPTAAEti0emwI8838.jpg</span><br><span class="line">│   │   │   ├── Cgpr4WF9Z1qAPuRNAAC5TGFpmYc275.jpg</span><br><span class="line">│   │   │   └── Cgpr4WF9Z1qAXV3hAAHgDlFbt0w747.jpg</span><br><span class="line">...................................................</span><br><span class="line">│   ├── storage_stat.dat   <span class="comment"># 当前storage server统计信息   </span></span><br><span class="line">│   └── sync               <span class="comment"># 存放数据同步相关文件</span></span><br><span class="line">│       ├── 10.10.107.226_23000.mark  <span class="comment"># 存放各个节点间同步的完成情况 </span></span><br><span class="line">│       ├── binlog.000                <span class="comment"># 当前的binlog文件索引号(类似于MySQL)</span></span><br><span class="line">│       └── binlog_index.dat          <span class="comment"># 存放更新操作记录(日志)</span></span><br><span class="line">└── logs</span><br><span class="line">    └── storaged.log       <span class="comment"># storaged 运行日志文件，默认级别 info、</span></span><br></pre></td></tr></table></figure>
<p>Tips: 线上环境千万不要使用 kill -9 命令强杀 FastDFS 进程，否则可能会导致 binlog 数据丢失。</p>
<p>Tips: 针对于<code>data/sync/10.10.107.226_23000.mark</code>文件内同步情况进行查看，下面对其参数进行解析:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">binlog_index=0      //binlog索引id</span><br><span class="line">binlog_offset=3173  //当前时间binlog 大小</span><br><span class="line">need_sync_old=0     //是否需要同步老数据</span><br><span class="line">sync_old_done=0     //是否同步完成</span><br><span class="line">until_timestamp=0   //时间戳单元</span><br><span class="line">scan_row_count=97   //扫描记录数</span><br><span class="line">sync_row_count=52   //同步记录数</span><br></pre></td></tr></table></figure></p>
<p>至此已经搭起了一个简单的集群模式，其中上面的配置需要根据实际情况进行调整。</p>
<p><br/></p>
<h3 id="2-Docker-安装"><a href="#2-Docker-安装" class="headerlink" title="2.Docker 安装"></a>2.Docker 安装</h3><h4 id="Hub仓库fastDFS相关镜像"><a href="#Hub仓库fastDFS相关镜像" class="headerlink" title="Hub仓库fastDFS相关镜像"></a>Hub仓库fastDFS相关镜像</h4><p><strong>操作流程:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker 搜索相关镜像</span></span><br><span class="line">docker search fastdfs</span><br><span class="line"><span class="comment"># 拉取delron/fastdfs</span></span><br><span class="line">docker pull delron/fastdfs</span><br><span class="line"><span class="comment"># 查看拉取的镜像镜像</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment">#使用docker镜像构建tracker容器（跟踪服务器，起到调度的作用）</span></span><br><span class="line">docker run -d --network=host --name tracker -v /var/fdfs/tracker:/var/fdfs delron/fastdfs tracker</span><br><span class="line"><span class="comment"># 使用docker镜像构建storage容器（存储服务器，提供容量和备份服务）</span></span><br><span class="line">docker run -d --network=host --name storage -e TRACKER_SERVER=ip:22122 -v /var/fdfs/storage:/var/fdfs -e GROUP_NAME=group1 delron/fastdfs storage</span><br></pre></td></tr></table></figure>
<p>我们再来复习一哈FastDFS原理，此处tracker和storage我们使用docker进行安装部署。</p>
<figure class="image-box">
                <a rel=1.FastDFS分布式的文件存储系统入门介绍与实践 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211109173121.png" target="_blank" title="WeiyiGeek.FastDFS原理图" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/5/20211109173121.png" alt="WeiyiGeek.FastDFS原理图" title="" class=""></a>
                <p>WeiyiGeek.FastDFS原理图</p>
            </figure>
<p><br></p>
<h4 id="自定义FastDFS基础镜像"><a href="#自定义FastDFS基础镜像" class="headerlink" title="自定义FastDFS基础镜像"></a>自定义FastDFS基础镜像</h4><p>描述: 我们可以自定义FastDFS基础镜像并将其运行起来。</p>
<ul>
<li>下面以 FastDFS 的官方 Dockerfile 示例（<a href="https://github.com/happyfish100/fastdfs/blob/52ac538a71fc9753c9dbcd4c75f581e9402f39a5/docker/dockerfile_local/Dockerfile）" target="_blank" rel="noopener">https://github.com/happyfish100/fastdfs/blob/52ac538a71fc9753c9dbcd4c75f581e9402f39a5/docker/dockerfile_local/Dockerfile）</a></li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># centos 7</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="comment"># 添加配置文件</span></span><br><span class="line"><span class="comment"># add profiles</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> conf/client.conf /etc/fdfs/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> conf/http.conf /etc/fdfs/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> conf/mime.types /etc/fdfs/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> conf/storage.conf /etc/fdfs/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> conf/tracker.conf /etc/fdfs/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> fastdfs.sh /home</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> conf/nginx.conf /etc/fdfs/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> conf/mod_fastdfs.conf /etc/fdfs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加源文件</span></span><br><span class="line"><span class="comment"># add source code</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> <span class="built_in">source</span>/libfastcommon.tar.gz /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> <span class="built_in">source</span>/fastdfs.tar.gz /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> <span class="built_in">source</span>/fastdfs-nginx-module.tar.gz /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> <span class="built_in">source</span>/nginx-1.15.4.tar.gz /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install git gcc gcc-c++ make automake autoconf libtool pcre pcre-devel zlib zlib-devel openssl-devel wget vim -y \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  mkdir /home/dfs   \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/  \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  <span class="built_in">cd</span> libfastcommon/   \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  ./make.sh &amp;&amp; ./make.sh install  \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  <span class="built_in">cd</span> ../  \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  <span class="built_in">cd</span> fastdfs/   \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  ./make.sh &amp;&amp; ./make.sh install  \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  <span class="built_in">cd</span> ../  \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  <span class="built_in">cd</span> nginx-1.15.4/  \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  ./configure --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/   \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  make &amp;&amp; make install  \</span></span><br><span class="line"><span class="bash">  &amp;&amp;  chmod +x /home/fastdfs.sh</span></span><br><span class="line"><span class="comment"># export config</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /etc/fdfs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22122</span> <span class="number">23000</span> <span class="number">8888</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/home/fastdfs.sh"</span>]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>经过本人优化后的 <a href="https://github.com/happyfish100/fastdfs/issues/327" target="_blank" rel="noopener">Dockerfile</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:3.10</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">set</span> -x \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/main/"</span> &gt; /etc/apk/repositories \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/community/"</span> &gt;&gt; /etc/apk/repositories \</span><br><span class="line">    &amp;&amp; apk update \</span><br><span class="line">    &amp;&amp; apk add --no-cache --virtual .build-deps gcc libc-dev make perl-dev openssl-dev pcre-dev zlib-dev git \</span><br><span class="line">    &amp;&amp; mkdir -p /usr/<span class="built_in">local</span>/src \</span><br><span class="line">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src \</span><br><span class="line">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1 \</span><br><span class="line">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1    \</span><br><span class="line">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1  \</span><br><span class="line">    &amp;&amp; wget http://nginx.org/download/nginx-1.15.4.tar.gz \</span><br><span class="line">    &amp;&amp; tar -xf nginx-1.15.4.tar.gz \</span><br><span class="line">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/libfastcommon \</span><br><span class="line">    &amp;&amp; ./make.sh \</span><br><span class="line">    &amp;&amp; ./make.sh install \</span><br><span class="line">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/fastdfs/ \</span><br><span class="line">    &amp;&amp; ./make.sh \</span><br><span class="line">    &amp;&amp; ./make.sh install \</span><br><span class="line">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.15.4/ \</span><br><span class="line">    &amp;&amp; ./configure --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ \</span><br><span class="line">    &amp;&amp; make &amp;&amp; make install \</span><br><span class="line">    &amp;&amp; apk del .build-deps \</span><br><span class="line">    &amp;&amp; apk add --no-cache pcre-dev bash \</span><br><span class="line">    &amp;&amp; mkdir -p /home/dfs  \</span><br><span class="line">    &amp;&amp; mv /usr/<span class="built_in">local</span>/src/fastdfs/docker/dockerfile_network/fastdfs.sh /home \</span><br><span class="line">    &amp;&amp; mv /usr/<span class="built_in">local</span>/src/fastdfs/docker/dockerfile_network/conf/* /etc/fdfs \</span><br><span class="line">    &amp;&amp; chmod +x /home/fastdfs.sh </span><br><span class="line">    <span class="comment"># &amp;&amp; rm -rf /usr/local/src*</span></span><br><span class="line">VOLUME /home/dfs</span><br><span class="line">EXPOSE 22122 23000 8888 8080</span><br><span class="line">CMD [<span class="string">"/home/fastdfs.sh"</span>]</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>Tips: 指定版本Alpine版本<code>echo -e &quot;https://mirrors.aliyun.com/alpine/v3.8/main&quot; &gt; /etc/apk/repositories</code>仓库。</p>

        </div>
        
  <hr>
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>

  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注，转个发】(人间五大情)</b>，这将对我的肯定，谢谢！。</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="扫描Visit(浏览)极客全栈修炼小程序"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-03-29T05:39:06.301Z" itemprop="dateUpdated">2022-03-29 13:39:06</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/系统运维/系统架构/分布式/FastDFS/1.FastDFS分布式的文件存储系统入门介绍与实践.md" target="_blank" rel="noopener noreferrer">_posts/系统运维/系统架构/分布式/FastDFS/1.FastDFS分布式的文件存储系统入门介绍与实践.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2020/5-22-547.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/5-22-547.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">👍 钟意作者</a>
</div>
            
        
        <div class="post-footer">
            
            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/5-22-547.html&title=《1.FastDFS分布式的文件存储系统入门介绍与实践》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/5-22-547.html&title=《1.FastDFS分布式的文件存储系统入门介绍与实践》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/5-22-547.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《1.FastDFS分布式的文件存储系统入门介绍与实践》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/5-22-547.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/5-22-547.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/5-22-100.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">NextCloud私有云盘安装部署记录</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/5-17-50.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">2.Redis数据库基础数据类型介绍与使用</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-基础介绍"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 基础介绍</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#0-前言"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">0.前言</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-简介"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">1.简介</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-特性"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">2.特性</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-架构"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">3.架构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Tracker-Server"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">Tracker Server</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Storage-Server"><span class="post-toc-number">1.4.2.</span> <span class="post-toc-text">Storage Server</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Client"><span class="post-toc-number">1.4.3.</span> <span class="post-toc-text">Client</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-存储策略"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">4.存储策略</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-过程剖析"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">5.过程剖析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#文件上传-Upload"><span class="post-toc-number">1.6.1.</span> <span class="post-toc-text">文件上传 - Upload</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#文件下载-Download"><span class="post-toc-number">1.6.2.</span> <span class="post-toc-text">文件下载 - Download</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#文件访问-HTTP"><span class="post-toc-number">1.6.3.</span> <span class="post-toc-text">文件访问 - HTTP</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#文件同步-Sync"><span class="post-toc-number">1.6.4.</span> <span class="post-toc-text">文件同步 - Sync</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-功能比对"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">6.功能比对</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-参考来源"><span class="post-toc-number">1.8.</span> <span class="post-toc-text">7.参考来源</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-FastDFS-安装使用"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 FastDFS 安装使用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Linux-安装"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.Linux 安装</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-1-CentOS-单机部署-FastDFS"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">1.1) CentOS 单机部署 FastDFS</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-2-Ubuntu-主从部署-FastDFS"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">1.2) Ubuntu 主从部署 FastDFS</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-Docker-安装"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.Docker 安装</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Hub仓库fastDFS相关镜像"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">Hub仓库fastDFS相关镜像</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#自定义FastDFS基础镜像"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">自定义FastDFS基础镜像</span></a></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，还请支持一下博主哟, 谢谢各位看友♥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="228" height="228" alt="打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="228" height="228" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- 微信公众号关注/文章版权复制 -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">个人Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">个人Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">个人知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云+云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved. IT唯一极客 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/5-22-547.html&title=《1.FastDFS分布式的文件存储系统入门介绍与实践》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/5-22-547.html&title=《1.FastDFS分布式的文件存储系统入门介绍与实践》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/5-22-547.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《1.FastDFS分布式的文件存储系统入门介绍与实践》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/5-22-547.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/5-22-547.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACIUlEQVR42u3aS27DMAwFwNz/0u62QJvkkbSDWBqtijaxPCpAiJ/HI17Hr5X89fiznn0r3+WEhYGBcVvG8XLlGyTfSkivj+Ppm2BgYGzAyB/9eoPeZyZsDAwMjCQIVgNuckAYGBgY1zGqafCXBlwMDIyvZCRJbLX0Ni/PXZKLY2Bg3JCRV90///Ml/Q0MDIxbMY7i+kzfsPxWGBgYSzPyAJdcFifNziSpfvMEDAyMRRl567G62QRT/g0GBsYGjLMGI5LUNw/Thc9jYGAszcgbmdXxiEnDMm8AYGBg7MboXezObWr2DgIDA2MfRq8lkDc7q2W7E/4DGBgYSzCSwlY1ycyf0Nv3n29hYGBswDhr5KJXROu1KEYzIxgYGLdinDtO0Rv8mt/uMDAw1mZUhyGqLYFJoa3cAMDAwNiAUS2EvXl0qwDXOzIMDIx9GNWGYn7VSxqi1aNp9igwMDCWYEy2TC6FObhwTcTAwFia0XuhJPhOLn/VEQ0MDIx9GOeOgk0ujtXjw8DA2IfRK5D1Amt1XCMq+WFgYGzDqIbIahitpsqFkhwGBsaijKO48sQyedH5MWFgYOzAqIa56gZ5CO5dE8sYDAyM2zLOKpBNuopJMvwmkcbAwNiAkQe+/De9a2I19GNgYGD02gOT0bE8SW72VzEwMLZk5NfEhN3EY2BgbMBIktj8M/PwemG5DQMD44aMyaTGJPmcFOmajUwMDIz7MX4AfLqJhxKa74YAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
