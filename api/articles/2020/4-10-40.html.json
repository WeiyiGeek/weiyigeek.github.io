{"title":"LDAP基础安装与简单入门使用.md","slug":"数据存储/LDAP/LDAP基础安装与简单使用","date":"2020-04-10T15:40:32.000Z","updated":"2022-03-29T05:39:06.312Z","url":"2020/4-10-40.html","path":"api/articles/2020/4-10-40.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200407173206.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200410235913.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200411000524.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414211618.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414165726.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414170336.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408141911.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408143206.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408151039.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408151250.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408151522.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408153208.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408153747.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408154940.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200411003446.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200411121325.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h4><p>由于其公司内部都内部各种运维系统等，当每个新员工入职就需要一个挨一个的登录到每个系统的后台给新员工开通账号，设置密码，然后员工离职还得去到每个系统后台去关闭账号，想想多浪费时间那么能不能维护一套账号，对所有系统生效呢？<br><code>当然有那就是LDAP</code>。</p>\n<p>在深入学习LDAP协议之前我们需要了解什么是目录服务?</p>\n<blockquote>\n<p>1.描述:目录服务是一个特殊的数据库，用来保存描述性的、基于属性的详细信息，支持过滤功能。如：<code>人员组织管理，电话簿，地址簿</code>。<br>2.特点:是动态的，灵活的，易扩展的。<br>3.目录是一个为查询、浏览和搜索而优化的数据库，它成树状结构组织数据，类似文件目录一样。</p>\n</blockquote>\n<p><em>什么是LDAP?</em></p>\n<blockquote>\n<p>答:维基百科:它是一个轻型目录访问协议（英文：<code>Lightweight Directory Access Protocol</code>，缩写：LDAP，/ˈɛldæp/）是一个开放的，中立的，工业标准的应用协议，通过IP协议提供访问控制和维护分布式信息的目录信息。LDAP目录服务是由目录数据库和一套访问协议组成的系统，它是基于X.500标准的轻量级目录访问协议有时被称为<code>X.500-lite</code>。也是IETF下的一项标准，目前最新的RFC为 <a href=\"http://www.rfc-editor.org/rfc/rfc4510.txt\" target=\"_blank\" rel=\"noopener\">RFC4510</a> ;</p>\n</blockquote>\n<p><code>比如 DNS 协议便是一种最被广泛使用的目录服务</code>。</p>\n<p><em>LDAP有什么用?</em></p>\n<blockquote>\n<p>答:构建一个统一的账号管理、身份验证平台，实现SSO单点登录机制,即用户可以在多个应用服务系统中使用同一个密码，通常用于公司内部网站的登录以及域内机器登陆管理；</p>\n</blockquote>\n<p><em>特点:</em></p>\n<ul>\n<li>使用轻量级目录访问协议（LDAP）构建集中的身份验证系统可以减少管理成本，增强安全性，避免数据复制的问题，并提高数据的一致性。</li>\n<li>目录数据库和关系数据库不同，它有<code>优异的读性能，但写性能差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据</code>;</li>\n</ul>\n<p><em>LDAP协议版本:</em></p>\n<ul>\n<li>LDAPv2</li>\n<li>LDAPv3</li>\n</ul>\n<p><br/></p>\n<p><em>为什么要使用LDAP?</em></p>\n<blockquote>\n<p>答:LDAP是开放的Internet标准，支持跨平台的Internet协议，在业界中得到广泛认可的，并且市场上或者开源社区上的大多产品都加入了对LDAP的支持，因此对于这类系统，不需单独定制，只需要通过LDAP做简单的配置就可以与服务器做认证交互;<code>&gt;简单粗暴，可以大大降低重复开发和对接的成本</code></p>\n</blockquote>\n<p><em>LDAP目录与普通数据库有何异同？</em></p>\n<blockquote>\n<p>1.主要不同之处在于数据的组织方式，它是一种有层次的、树形结构。所有条目的属性的定义是<strong>对象类object class</strong>的组成部分，并组成在一起构成<a href=\"http://www.bosimedia.com/w/index.php?title=Schema&amp;action=edit&amp;redlink=1\" target=\"_blank\" rel=\"noopener\">schema</a>；那些在组织内代表个人的schema被命名为<a href=\"http://www.bosimedia.com/w/index.php?title=White_pages_schema&amp;action=edit&amp;redlink=1\" target=\"_blank\" rel=\"noopener\">white pages schema</a>。</p>\n<p>2.数据库内的每个条目都与若干对象类联系，而这些对象类决定了一个属性是否为可选和它保存哪些类型的信息。属性的名字一般是一个易于记忆的字符串，例如用cn为通用名（common name）命名，而”mail”代表e-mail地址。 例如mail属性包含值“<a href=\"mailto:user@example.com\">user@example.com</a>”。 </p>\n</blockquote>\n<h5 id=\"主要产品\"><a href=\"#主要产品\" class=\"headerlink\" title=\"主要产品\"></a>主要产品</h5><p>简单了解下基于 LDAP 协议的产品有一下:</p>\n<table>\n<thead>\n<tr>\n<th>厂商</th>\n<th>产品</th>\n<th>简介</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Opensource</td>\n<td>Opensource</td>\n<td>OpenLDAP 开源的项目，速度很快，但是非主流应用，但是在社区的影响下逐渐成熟。</td>\n</tr>\n<tr>\n<td>Microsoft</td>\n<td>Microsoft Active Directory</td>\n<td>基于win系统用户在域控中使用，对大数据量处理速度一般，但维护容易，生态圈大，管理相对简单。</td>\n</tr>\n<tr>\n<td>IBM</td>\n<td>IBM Directory Server</td>\n<td>基于DB2 的的数据库，速度一般。</td>\n</tr>\n<tr>\n<td>Novell</td>\n<td>Novell Directory Server</td>\n<td>基于文本数据库的存储，速度快, 不常用到。</td>\n</tr>\n<tr>\n<td>Oracle</td>\n<td>Oracle Internet Directory</td>\n<td>简称OID是Oracle 用来集中存储和管理网络服务名称的解决方案，用于查询和修改任何类似目录的实体；</td>\n</tr>\n<tr>\n<td>Apache</td>\n<td>Apache Directory Server</td>\n<td>广泛使用在Apache基金会下面所属软件中比如Apache http，进行目录的索引以及展示;如OpenLDAP Apache HTTP Server使用代理服务器（通过模块mod_proxy）支持LDAP。</td>\n</tr>\n</tbody>\n</table>\n<p><br></p>\n<h5 id=\"基本模型\"><a href=\"#基本模型\" class=\"headerlink\" title=\"基本模型\"></a>基本模型</h5><p>每一个系统、协议都会有属于自己的模型，当然LDAP也不例外；</p>\n<p>在了解LDAP的基本模型之前我们需要先了解几个LDAP的目录树概念：</p>\n<ol>\n<li><p>目录树：在一个目录服务系统中，整个目录信息集可以表示为一个目录信息树，树中的一个节点称之为条目（Entry），条目包含了该节点的属性及属性值。</p>\n</li>\n<li><p>条目：由属性（attribute）的一个聚集组成每个条目就是一条记录，并由一个唯一性的名字引用，即<strong>专有名称</strong>（<code>distinguished name，DN</code>），可描述一个层次结构，这个结构可以反映一个政治、地理或者组织的范畴。</p>\n</li>\n<li><p>对象类：与某个实体类型对应的一组属性，对象类是可以继承的，这样父类的必须属性也会被继承下来。</p>\n</li>\n<li><p>属性：描述条目的某个方面的信息，一个属性由一个属性类型和一个或多个属性值组成，属性有必须属性和非必须属性。补充:属性取值依赖于其类型，并且LDAPv3中一般非二进制值都遵从<a href=\"http://www.bosimedia.com/wiki/UTF-8\" target=\"_blank\" rel=\"noopener\">UTF-8</a>字符串语法。</p>\n</li>\n</ol>\n<p>关键字&amp;术语说明:<br><code>Entry (or object) 条目(或对象)</code>:LDAP中的每个单元都认为是条目。</p>\n<table>\n<thead>\n<tr>\n<th>术语</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Directory</td>\n<td>目录，用于存放信息的单元</td>\n<td></td>\n</tr>\n<tr>\n<td>Entry</td>\n<td>条目，实体LDAP的基本信息单元</td>\n<td></td>\n</tr>\n<tr>\n<td>LDIF</td>\n<td>全称:LDAP Interchange Format , 在RFC2849中定义的标准，用于规范LDAP的配置和目录内容等详细信息的保存，后续的例子中将会较多地使用LDIF进行增删改查的操作。</td>\n</tr>\n</tbody>\n</table>\n<p><br/></p>\n<table>\n<thead>\n<tr>\n<th>关键字</th>\n<th>全称</th>\n<th>简述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DN</td>\n<td>Distinguished Name</td>\n<td>专有名称 , DN值：”uid=admin,ou=people,dc=weiyigeek,dc=top”, 一条记录的位置（全局唯一）</td>\n</tr>\n<tr>\n<td>DC</td>\n<td>Domain Component -</td>\n<td>域名组件 , 域名的部分，其格式是将完整的域名分成几部分，如域名为example.com变成dc=example,dc=com（一条记录的所属位置）</td>\n</tr>\n<tr>\n<td>CN</td>\n<td>Common Name</td>\n<td>公共名称 , 如“Admin（一条记录的名称）”或者人名或对象名称</td>\n</tr>\n<tr>\n<td>OU</td>\n<td>Organization Unit</td>\n<td>组织单位，组织单位可以包含其他各种对象（包括其他组织单元），如“oa组”（一条记录的所属组织）</td>\n</tr>\n<tr>\n<td>UID</td>\n<td>User Id</td>\n<td>用户ID username（一条记录的ID）</td>\n</tr>\n<tr>\n<td>SN</td>\n<td>Surname</td>\n<td>姓，如“文”</td>\n</tr>\n<tr>\n<td>RDN</td>\n<td>Relative dn</td>\n<td>相对辨别名，类似于文件系统中的相对路径，它是与目录树结构无关的部分，如“uid=admin”或“cn=ADMIN”</td>\n</tr>\n</tbody>\n</table>\n<p>参照 YAPI 中的 LDAP 配置</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"attr\">\"ldapLogin\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"enable\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"server\"</span>: <span class=\"string\">\"ldap://l-ldapt1.ops.dev.weiyigeek.top\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"baseDn\"</span>: <span class=\"string\">\"CN=Admin,CN=Users,DC=weiyigeek,DC=top\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"bindPassword\"</span>: <span class=\"string\">\"password123\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"searchDn\"</span>: <span class=\"string\">\"OU=UserContainer,DC=weiyigeek,DC=top\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"searchStandard\"</span>: <span class=\"string\">\"mail\"</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>(1) 信息模型</strong></p>\n<p>描述:在LDAP中的信息以树状方式组织，在树状信息中的基本数据单元是条目，而且每个条目由属性构成，属性中存储由属性值；</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   条目\t\t\t   属性</span><br><span class=\"line\">-------------    --------------</span><br><span class=\"line\">|\t条目1   |    |    类型\t   |</span><br><span class=\"line\">|条目2  条目3|--&gt; | 值1 .... 值n|</span><br><span class=\"line\">-------------    --------------</span><br></pre></td></tr></table></figure>\n<p>(2) 命名模型</p>\n<p>描述：LDAP中的命名模型即LDAP中的条目定位方式，在LDAP中每个条目均有自己的DN 是该条目在整个树中的唯一名称标识;</p>\n<p>LDAP树形结构的构成方式而一般有两种方式:<code>体现到LDIF的详细信息</code></p>\n<ul>\n<li>传统方式:聚焦于国别以及地理信息为上层构成,然后按照地理信息进行继续下行，最后精确到人的姓名以及住址;</li>\n<li>互联网域名方式: 上层构成直接使用域名，能结合DNS相关的技术;</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#传统方式</span></span><br><span class=\"line\">  c=CN</span><br><span class=\"line\">    |</span><br><span class=\"line\">  st=ChongQing</span><br><span class=\"line\">    |</span><br><span class=\"line\">    o = YongChuan (The Organisation)</span><br><span class=\"line\">  /                  \\</span><br><span class=\"line\">ou=YoungChuanGroup1  ou=YoungChuanGroup2 (Oraganisation Unit)</span><br><span class=\"line\">|</span><br><span class=\"line\">cn=WeiyiGeek</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#互联网域名方式</span></span><br><span class=\"line\">         dc=top</span><br><span class=\"line\">            |</span><br><span class=\"line\">      dc=WeiyiGeek</span><br><span class=\"line\">       /          \\</span><br><span class=\"line\"> ou=people     ou=groups</span><br><span class=\"line\">    /</span><br><span class=\"line\">uid=admin</span><br></pre></td></tr></table></figure>\n<p><strong>(3) 功能模型</strong></p>\n<p>描述：在LDAP中共有四类10种操作:</p>\n<ul>\n<li>查询类操作，如搜索、比较；</li>\n<li>更新类操作，如添加条目，删除条目，修改条目以及修改条目名</li>\n<li>认证类操作，如绑定，解绑</li>\n<li>其它操作，如放弃和扩展操作（除了扩展操作，另外9种是LDAO的标准操作，扩展操作是LDAP中为了增加新的功能，而提供的一种标准扩展框架，当前已经成为LDAP标准的扩展操作，有修改密码和startTLS扩展，在新的RFC标准和草案中正在增加一些新的扩展操作，不同的LDAP厂商也均定义了自己的扩展操作）</li>\n</ul>\n<p><strong>(4) 安全模型</strong></p>\n<p>描述:LDAP中的安全模型主要通过身份认证、安全通道和访问控制来进行实现;</p>\n<p><br></p>\n<h5 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h5><p>描述:由于LDAP主要运用于<code>统一身份认证</code>，而其主要是改变原有的认证策略，使需要认证的软件都通过LDAP进行认证，在统一身份认证之后，用户的所有信息都存储在AD Server中。终端用户在需要使用公司内部服务的时候，都需要通过AD服务器的认证。</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200407173206.png\" alt=\"WeiyiGeek.LDAP身份认证\" title=\"\" class=\"\">\n                <p>WeiyiGeek.LDAP身份认证</p>\n            </figure>\n<p>那么程序中是如何访问的呢？</p>\n<ol>\n<li><p>连接到LDAP服务器；</p>\n</li>\n<li><p>绑定到LDAP服务器；</p>\n</li>\n<li><p>在LDAP服务器上执行所需的任何操作；</p>\n</li>\n<li><p>释放LDAP服务器的连接；</p>\n</li>\n</ol>\n<p>我们以PHP脚本作为例子如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ldapconn &#x3D; ldap_connect(&quot;10.10.84.78&quot;)</span><br><span class=\"line\">$ldapbind &#x3D; ldap_bind($ldapconn, &#39;username&#39;, $ldappass);</span><br><span class=\"line\">$searchRows&#x3D; ldap_search($ldapconn, $basedn, &quot;(cn&#x3D;*)&quot;);</span><br><span class=\"line\">$searchResult &#x3D; ldap_get_entries($ldapconn, $searchRows);</span><br><span class=\"line\">ldap_close($ldapconn);</span><br></pre></td></tr></table></figure>\n<hr>\n<h4 id=\"0x01-环境安装\"><a href=\"#0x01-环境安装\" class=\"headerlink\" title=\"0x01 环境安装\"></a>0x01 环境安装</h4><p>描述:在上文中我们对LDAP产品进行列举，在厂商得持续开发迭代下提供LDAP服务的软件有很多商业上获得成功的，其中以<code>MS的AD和Redhat的NDS（Netscape directory server）</code>使用最为广泛，而开源领域则是OpenLdap（全文实验也是基于此版本）;</p>\n<p><em>什么是OpenLDAP?</em><br>OpenLDAP是轻型目录访问协议（Lightweight Directory Access Protocol，LDAP）的自由和开源的实现，在其OpenLDAP许可证下发行，并已经被包含在众多流行的Linux发行版中。<br>官网：<a href=\"http://www.openldap.org\" target=\"_blank\" rel=\"noopener\">http://www.openldap.org</a></p>\n<p>它主要包括下述4个部分：</p>\n<ul>\n<li>slapd - 独立LDAP守护服务</li>\n<li>slurpd - 独立的LDAP更新复制守护服务</li>\n<li>实现LDAP协议的库</li>\n<li>工具软件和示例客户端</li>\n</ul>\n<p>端口说明:</p>\n<table>\n<thead>\n<tr>\n<th>端口号</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td> 389</td>\n<td>未加SSL缺省端口(明文数据传输)</td>\n<td></td>\n</tr>\n<tr>\n<td> 689</td>\n<td>SSL加密端口</td>\n<td></td>\n</tr>\n<tr>\n<td> 636</td>\n<td>加密监听端口(加密数据传输)</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p><br></p>\n<h5 id=\"基于-yum-安装\"><a href=\"#基于-yum-安装\" class=\"headerlink\" title=\"基于 yum 安装\"></a>基于 yum 安装</h5><p>环境准备:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#SeLinux设为disabled</span></span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\">sed -i <span class=\"string\">\"s/SELINUX=enforcing/SELINUX=disabled/g\"</span> /etc/selinux/config </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#同步系统时间</span></span><br><span class=\"line\">ntpdate time.nist.gov</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Firewalld防火墙设置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#镜像源设置</span></span><br><span class=\"line\">mv /etc/yum.repos.d/CentOS-Base.repo&#123;,.bak&#125;</span><br><span class=\"line\">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class=\"line\">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class=\"line\">yum clean all <span class=\"comment\">#清除缓存</span></span><br><span class=\"line\">yum makecache <span class=\"comment\">#创建缓存</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装OpenLDAP的相关(compat-openldap包与主从有很大的关系)</span></span><br><span class=\"line\">yum -y install openldap openldap-clients openldap-servers openldap-servers-sql openldap-devel migrationtools</span><br><span class=\"line\">yum -y install compat-openldap</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#通过查看安装了哪些包</span></span><br><span class=\"line\">rpm -qa |grep openldap</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看OpenLDAP版本</span></span><br><span class=\"line\">slapd -VV</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#初始化OpenLDAP的配置</span></span><br><span class=\"line\">cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG　  <span class=\"comment\"># 数据库文件</span></span><br><span class=\"line\">cp /usr/share/openldap-servers/slapd.conf.obsolete /etc/openldap/slapd.conf <span class=\"comment\"># 创建slapd.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#salpd.conf 配置修改：[修改或添加-如下图所示]</span></span><br><span class=\"line\"><span class=\"comment\">#把配置文件中：dc=my-domain,dc=com  修改成自己的域名； dc=58jb,dc=org ；cn=Manager就是管理员账号；</span></span><br><span class=\"line\">database    bdb</span><br><span class=\"line\">suffix      <span class=\"string\">\"dc=weiyigeek,dc=com,dc=cn\"</span>  <span class=\"comment\">#基础DN</span></span><br><span class=\"line\">checkpoint  1024 15</span><br><span class=\"line\">rootdn      <span class=\"string\">\"cn=admin,dc=weiyigeek,dc=com,dc=cn\"</span> <span class=\"comment\">#管理员admin DN</span></span><br><span class=\"line\">loglevel Stats         <span class=\"comment\">#增加一个日志记录</span></span><br><span class=\"line\">cachesize 1000      <span class=\"comment\">#缓存大小</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置OpenLDAP管理员密码，拷贝这个到/etc/openldap/slapd.conf里，指定rootpw属性必须顶格写，而且与后面的密码文件用Tab键隔开，并修改对应序列。</span></span><br><span class=\"line\">slappasswd -s 123456</span><br><span class=\"line\"><span class=\"comment\"># &#123;SSHA&#125;JTudNsYrtbsksTdjxe4bFSwbrt1cF+LD</span></span><br></pre></td></tr></table></figure><br>注意：其中cn=root中的root表示OpenLDAP管理员的用户名，而olcRootPW表示OpenLDAP管理员的密码。<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200410235913.png\" alt=\"WeiyiGeek.salpd.conf\" title=\"\" class=\"\">\n                <p>WeiyiGeek.salpd.conf</p>\n            </figure></p>\n<p>修改配置文件完成后进行验证配置文件以及权限设置<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#先检测/etc/openldap/slapd.conf是否有错误</span></span><br><span class=\"line\">slaptest -f /etc/openldap/slapd.conf </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#授权数据文件，更改文件的所属</span></span><br><span class=\"line\">chown -R ldap:ldap /var/lib/ldap/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启slapd生成配置文件,接着回到检测/etc/openldap/slapd.conf是否有错误</span></span><br><span class=\"line\">/etc/init.d/slapd restart</span><br><span class=\"line\">slaptest -f /etc/openldap/slapd.conf </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#如果没有问题就重新生成配置文件的配置信息：</span></span><br><span class=\"line\">rm - rf /etc/openldap/slapd.d/*                                     <span class=\"comment\"># 先删除最先的配置文件生成的信息 </span></span><br><span class=\"line\">slaptest -f /etc/openldap/slapd.conf -F /etc/openldap/slapd.d/       <span class=\"comment\"># 重新生成文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看是否生成的是自己修改的配置文件信息，修改文件在/etc/openldap/slapd.d/cn\\=config/olcDatabase\\=\\&#123;1\\&#125;mdb.ldif</span></span><br><span class=\"line\"><span class=\"comment\">#重启到这里为止，OpenLDAP服务端基本上完成了</span></span><br><span class=\"line\">/etc/init.d/slapd restart</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#检查ldap的连接测试，输入密码后返回信息：No such object (32) 表示成功！</span></span><br><span class=\"line\">ldapsearch -LLL -W -x -H ldap://58jb.org -D <span class=\"string\">\"cn=admin,dc=weiyigeek,dc=com,dc=cn\"</span> -b <span class=\"string\">\"dc=weiyigeek,dc=com,dc=cn\"</span> <span class=\"string\">\"(uid=*)\"</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200411000524.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>注意:<code>每次修改了配置文件，所有得重新生成配置文件的信息</code>；</p>\n<p>参考文档:</p>\n<ul>\n<li><a href=\"https://blog.51cto.com/skypegnu1/1939302\" target=\"_blank\" rel=\"noopener\">https://blog.51cto.com/skypegnu1/1939302</a></li>\n<li><a href=\"https://www.cnblogs.com/dmjx/p/9071068.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/dmjx/p/9071068.html</a></li>\n<li><a href=\"https://www.58jb.com/html/120.html\" target=\"_blank\" rel=\"noopener\">https://www.58jb.com/html/120.html</a></li>\n</ul>\n<p><br></p>\n<h5 id=\"基于-Docker-安装\"><a href=\"#基于-Docker-安装\" class=\"headerlink\" title=\"基于 Docker 安装\"></a>基于 Docker 安装</h5><p>描述:由于openldap的osixia的镜像所内置的缺省的dc即LDAP结构采用互联网域名方式;<br>Docker镜像:<a href=\"https://github.com/osixia/docker-openldap\" target=\"_blank\" rel=\"noopener\">https://github.com/osixia/docker-openldap</a></p>\n<p>建立数据持久化目录:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/OpenLDAP/&#123;config,database&#125;</span><br></pre></td></tr></table></figure></p>\n<p>docker-compose.yml (<a href=\"https://github.com/osixia/docker-openldap/releases/tag/v1.3.0\" target=\"_blank\" rel=\"noopener\">v1.3.0</a>)<br>安装OpenLDAP版本:<code>Jul 30 2019 16:24:19</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#OpenLDAP 环境部署</span></span><br><span class=\"line\"><span class=\"comment\">#mkdir -p /opt/OpenLDAP/&#123;config,database&#125;</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3.1'</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  openldap-service:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">osixia/openldap</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">openldap</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      LDAP_DOMAIN:</span> <span class=\"string\">weiyigeek.top</span></span><br><span class=\"line\"><span class=\"attr\">      LDAP_ORGANISATION:</span> <span class=\"string\">weiyigeek</span></span><br><span class=\"line\"><span class=\"attr\">      LDAP_ADMIN_PASSWORD:</span> <span class=\"string\">weiyigeek</span></span><br><span class=\"line\"><span class=\"attr\">      LDAP_TLS:</span> <span class=\"string\">'false'</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"/opt/OpenLDAP/database:/var/lib/ldap\"</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"/opt/OpenLDAP/config:/etc/ldap/slapd.d\"</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">389</span><span class=\"string\">:389</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">689</span><span class=\"string\">:689</span></span><br><span class=\"line\"><span class=\"attr\">    networks:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">opt_default</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  phpldapadmin-service:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">osixia/phpldapadmin</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">phpldapadmin</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      PHPLDAPADMIN_LDAP_HOSTS:</span> <span class=\"string\">openldap-service</span></span><br><span class=\"line\"><span class=\"attr\">      PHPLDAPADMIN_HTTPS:</span> <span class=\"string\">'false'</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">6443</span><span class=\"string\">:443</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">6080</span><span class=\"string\">:80</span></span><br><span class=\"line\"><span class=\"attr\">    networks:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">opt_default</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">openldap-service</span></span><br><span class=\"line\"><span class=\"attr\">    depends_on:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">openldap-service</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\"><span class=\"attr\">  opt_default:</span></span><br><span class=\"line\"><span class=\"attr\">    external:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure></p>\n<p>环境变量说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">默认登录用户名：admin</span><br><span class=\"line\">配置LDAP组织者：--env LDAP_ORGANISATION=<span class=\"string\">\"weiyigeek\"</span></span><br><span class=\"line\">配置LDAP域：--env LDAP_DOMAIN=<span class=\"string\">\"weiyigeek.top\"</span></span><br><span class=\"line\">配置LDAP密码：--env LDAP_ADMIN_PASSWORD=<span class=\"string\">\"weiyigeek\"</span></span><br><span class=\"line\">配置管理LDAP主机地址: --env PHPLDAPADMIN_LDAP_HOSTS=172.17.0.6</span><br><span class=\"line\">配置不开启HTTPS：--env PHPLDAPADMIN_HTTPS=<span class=\"literal\">false</span>（默认是<span class=\"literal\">true</span>）</span><br></pre></td></tr></table></figure></p>\n<p>拉取并运行镜像:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose config  <span class=\"comment\">#验证yaml文件</span></span><br><span class=\"line\">docker-compose up -d   <span class=\"comment\">#拉取和后台运行容器</span></span><br><span class=\"line\"><span class=\"comment\">#如容器间不能正常通信请查看防火墙是否allow；</span></span><br></pre></td></tr></table></figure></p>\n<p>容器内部查询:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Docker安装版本查询，如果您是基于CentOS系列构建得请采用rpm -qa</span></span><br><span class=\"line\">root@4a1a157c5e70:/<span class=\"variable\">$apt</span> list | grep <span class=\"string\">\"slapd\"</span></span><br><span class=\"line\">slapd/now 2.4.48+dfsg-1~bpo10+1 amd64 [installed,<span class=\"built_in\">local</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">root@4a1a157c5e70:/<span class=\"variable\">$slapd</span> -VV</span><br><span class=\"line\">@($) <span class=\"variable\">$OpenLDAP</span>: slapd  (Jul 30 2019 16:24:19) $</span><br><span class=\"line\">        Debian OpenLDAP Maintainers &lt;pkg-openldap-devel@lists.alioth.debian.org&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">root@4a1a157c5e70:/<span class=\"variable\">$ldapsearch</span> -VV</span><br><span class=\"line\">ldapsearch: @(<span class=\"comment\">#) $OpenLDAP: ldapsearch  (Jul 30 2019 16:24:19) $</span></span><br><span class=\"line\">        Debian OpenLDAP Maintainers &lt;pkg-openldap-devel@lists.alioth.debian.org&gt;</span><br><span class=\"line\">        (LDAP library: OpenLDAP 20448)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#使用slapcat来查看相关的用户信息，缺省方式下已经有cn=admin的用户信息(貌似不需要认证直接显示用户密码)</span></span><br><span class=\"line\">root@4a1a157c5e70:/<span class=\"variable\">$slapcat</span> -v</span><br><span class=\"line\"><span class=\"comment\"># id=00000001</span></span><br><span class=\"line\">dn: dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">objectClass: dcObject</span><br><span class=\"line\">objectClass: organization</span><br><span class=\"line\">o: WeiyiGeek</span><br><span class=\"line\">dc: WeiyiGeek</span><br><span class=\"line\">structuralObjectClass: organization</span><br><span class=\"line\">entryUUID: bbbb1564-0d95-103a-95a6-a917d679da5b</span><br><span class=\"line\">creatorsName: cn=admin,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">createTimestamp: 20200408033527Z</span><br><span class=\"line\">entryCSN: 20200408033527.510607Z<span class=\"comment\">#000000#000#000000</span></span><br><span class=\"line\">modifiersName: cn=admin,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">modifyTimestamp: 20200408033527Z</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x02-LDAP配置-amp-命令\"><a href=\"#0x02-LDAP配置-amp-命令\" class=\"headerlink\" title=\"0x02 LDAP配置&amp;命令\"></a>0x02 LDAP配置&amp;命令</h4><p>描述:Yum安装ldap后的配置文件说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#OpenLDAP相关配置文件(主配置文件，管理员dn，密码，日志配置，权限等设置)</span></span><br><span class=\"line\">/etc/openldap/slapd.conf</span><br><span class=\"line\">/etc/openldap/slapd.d/*                                     <span class=\"comment\"># 这下面是slapd.conf配置信息生成的文件，每修改一次配置信息，这里的东西就要重新生成</span></span><br><span class=\"line\">/etc/openldap/schema/*                                      <span class=\"comment\"># OpenLDAP的schema存放的地方</span></span><br><span class=\"line\">/var/lib/ldap/*                                             <span class=\"comment\"># OpenLDAP的数据文件</span></span><br><span class=\"line\">/usr/share/openldap-servers/slapd.conf.obsolete             <span class=\"comment\"># 模板配置文件</span></span><br><span class=\"line\">/usr/share/openldap-servers/DB_CONFIG.example               <span class=\"comment\"># 模板数据库配置文件</span></span><br></pre></td></tr></table></figure></p>\n<p>openLDAP的打开日志信息：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#设置LDAP日志级别为-2记录Info信息</span></span><br><span class=\"line\"><span class=\"variable\">$vim</span> /etc/openldap/slapd.conf </span><br><span class=\"line\">loglevel -2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重新生成配置文件的信息</span></span><br><span class=\"line\">slaptest -f /etc/openldap/slapd.conf -F /etc/openldap/slapd.d/</span><br><span class=\"line\">chown -R ldap.ldap /etc/openldap/slapd.d/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建日志文件目录并修改属组</span></span><br><span class=\"line\">mkdir /var/<span class=\"built_in\">log</span>/slapd</span><br><span class=\"line\">chmod 755 /var/<span class=\"built_in\">log</span>/slapd/</span><br><span class=\"line\">chown ldap.ldap /var/<span class=\"built_in\">log</span>/slapd/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在/etc/rsyslog.conf文件中加入　　</span></span><br><span class=\"line\">local4.*    /var/<span class=\"built_in\">log</span>/slapd/slapd.log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启slapd以及rsyslog服务</span></span><br><span class=\"line\">/etc/init.d/slapd restart</span><br><span class=\"line\">/etc/init.d/rsyslog restart</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看日志信息</span></span><br><span class=\"line\">tailf /var/<span class=\"built_in\">log</span>/slapd/slapd.log</span><br></pre></td></tr></table></figure></p>\n<p>注意事项:</p>\n<ul>\n<li><span style=\"color:red\">从OpenLDAP2.4.23版本开始所有配置数据都保存在 <code>/etc/openldap/slapd.d/</code> 中，建议不再使用slapd.conf作为配置文件。</span></li>\n<li>线上ACL控制配置解析希望能达到的效果是：<code>1.管理员能够有全部权限，包含新建用户，修改用户属性及用户密码等|2.普通用户只能修改自己的密码，别的权限都没有</code>;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># access to attrs=userPassword通过属性找到访问范围密码,</span></span><br><span class=\"line\"><span class=\"comment\"># 超级管理员也就是我们ldap配置文件里写的rootdn：\"cn=admin,dc=weiyigeek,dc=top\"有写(write)权限；</span></span><br><span class=\"line\"><span class=\"comment\"># 由于管理员可能不止一个，我创建了个管理员组\"ou=Admin,dc=weiyigeek,dc=top\"把管理员统一都放到这个组下，管理员组下的所有用户（dn.children）有写权限；</span></span><br><span class=\"line\"><span class=\"comment\"># 匿名用户(anonymous)要通过验证(auth);</span></span><br><span class=\"line\"><span class=\"comment\"># 自己(self)有对自己密码的写（write）权限，其他人(*)都没有权限(none).</span></span><br><span class=\"line\">access to attrs=userPassword,shadowLastChange</span><br><span class=\"line\">        by dn=<span class=\"string\">\"cn=admin,dc=weiyigeek,dc=top\"</span> write</span><br><span class=\"line\">        by dn.children=<span class=\"string\">\"ou=Admin,dc=weiyigeek,dc=top\"</span> write</span><br><span class=\"line\">        by anonymous auth</span><br><span class=\"line\">        by self write</span><br><span class=\"line\">        by * none</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># access to * 所有其他属性，</span></span><br><span class=\"line\"><span class=\"comment\"># 超级管理员rootdn：\"cn=admin,dc=weiyigeek,dc=top\"有写(write)权限；</span></span><br><span class=\"line\"><span class=\"comment\"># 管理员\"ou=Admin,dc=weiyigeek,dc=top\"成员有写(write)权限；</span></span><br><span class=\"line\"><span class=\"comment\"># 其他人(*)只有读(read)权限</span></span><br><span class=\"line\">access to *</span><br><span class=\"line\">        by dn=<span class=\"string\">\"cn=admin,dc=weiyigeek,dc=top\"</span> write</span><br><span class=\"line\">        by dn.children=<span class=\"string\">\"ou=Admin,dc=weiyigeek,dc=top\"</span> write</span><br><span class=\"line\">        by * <span class=\"built_in\">read</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<h5 id=\"slapd-命令\"><a href=\"#slapd-命令\" class=\"headerlink\" title=\"slapd 命令\"></a>slapd 命令</h5><p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#ldap版本信息</span></span><br><span class=\"line\"><span class=\"variable\">$slapd</span> -VV</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#确认配置文件信息是否正确</span></span><br><span class=\"line\"><span class=\"variable\">$slaptest</span></span><br><span class=\"line\"><span class=\"comment\"># config file testing succeeded</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看相关的用户信息(缺省方式 cn=admin)</span></span><br><span class=\"line\"><span class=\"variable\">$slapcat</span> -v</span><br><span class=\"line\"><span class=\"variable\">$slapcat</span> -n 0  <span class=\"comment\">#查看不同的数据库id数据｛0，1｝</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h5 id=\"ldapsearch-命令\"><a href=\"#ldapsearch-命令\" class=\"headerlink\" title=\"ldapsearch 命令\"></a>ldapsearch 命令</h5><p>描述:LDAP一般用于SSO的单点登录，所以其他机器能够连接进行验证是最基础的，客户端安装openldap-client包进行登录LDAP并进行查询使用;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install openldap-clients</span><br></pre></td></tr></table></figure></p>\n<p>基础语法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-x: 采用简单认证</span><br><span class=\"line\">-H: ldap协议://主机:端口不能与-h和-p同时使用</span><br><span class=\"line\">-b: 指定的查询的DN条目对象的属性</span><br><span class=\"line\">-D: 指定的baseDN专有名称</span><br><span class=\"line\">-w: 简单认证方式的密码(credentials)绑定DN的密码，与-W二者选一</span><br><span class=\"line\">-h: LDAP服务器IP或者可解析的hostname，与-p可结合使用，不能与-H同时使用</span><br><span class=\"line\">-p: LDAP服务器端口</span><br><span class=\"line\">-W \t不输入密码，会交互式的提示用户输入密码，与-w二者选一</span><br><span class=\"line\">-f \t指定输入条件，在RFC 4515中有更详细的说明</span><br><span class=\"line\">-c \t出错后忽略当前错误继续执行，缺省情况下遇到错误即终止</span><br><span class=\"line\">-n \t模拟操作但并不实际执行，用于验证，常与-v一同使用进行问题定位</span><br><span class=\"line\">-v \t显示详细信息</span><br><span class=\"line\">-d \t显示debug信息，可设定级别</span><br><span class=\"line\">-s \t指定搜索范围, 可选值：base|one|sub|children</span><br></pre></td></tr></table></figure></p>\n<p>filter 过滤条件符:<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414211618.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br></p>\n<p>基础示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(1)查询得到的实际上是LDIF文件格式中的内容;</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -x -H ldap://localhost:389 -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek</span><br><span class=\"line\"><span class=\"comment\"># extended LDIF</span></span><br><span class=\"line\"><span class=\"comment\"># LDAPv3</span></span><br><span class=\"line\"><span class=\"comment\"># base &lt;dc=WeiyiGeek,dc=com,dc=cn&gt; with scope subtree</span></span><br><span class=\"line\"><span class=\"comment\"># filter: (objectclass=*)</span></span><br><span class=\"line\"><span class=\"comment\"># requesting: ALL</span></span><br><span class=\"line\"><span class=\"comment\"># weiyigeek.top</span></span><br><span class=\"line\">dn: dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">objectClass: dcObject</span><br><span class=\"line\">objectClass: organization</span><br><span class=\"line\">o: WeiyiGeek</span><br><span class=\"line\">dc: WeiyiGeek</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># WeiyiGeek, Development, weiyigeek.top</span></span><br><span class=\"line\">dn: cn=WeiyiGeek,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">sn: WeiyiGeek</span><br><span class=\"line\">cn:: IFdlaXlpR2Vlaw==</span><br><span class=\"line\">uid: weiyigeek</span><br><span class=\"line\">userPassword:: e01ENX00U****StWdUJYOGcrSVBnPT0=</span><br><span class=\"line\">uidNumber: 1000</span><br><span class=\"line\">gidNumber: 500</span><br><span class=\"line\">homeDirectory: /home/users/weiyigeek</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">mail: <span class=\"built_in\">test</span>@weiyigeek.top</span><br><span class=\"line\">displayName:: 5ZSv5LiA5p6B5a6i</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(2)指定DN进行查询(指定过滤条件) -b SearchDN</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -x -H ldap://localhost:389 -b <span class=\"string\">\"ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span> -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek</span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -x -H ldap://localhost:389 -b <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span> -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek</span><br><span class=\"line\"><span class=\"comment\"># extended LDIF</span></span><br><span class=\"line\"><span class=\"comment\"># LDAPv3</span></span><br><span class=\"line\"><span class=\"comment\"># base &lt;cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn&gt; with scope subtree</span></span><br><span class=\"line\"><span class=\"comment\"># filter: (objectclass=*)</span></span><br><span class=\"line\"><span class=\"comment\"># requesting: AL</span></span><br><span class=\"line\"><span class=\"comment\"># Weiyi, Development, weiyigeek.top</span></span><br><span class=\"line\">dn: cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">sn: Weiyi</span><br><span class=\"line\">cn: weiyi</span><br><span class=\"line\">uid: weiyi</span><br><span class=\"line\">uidNumber: 1001</span><br><span class=\"line\">gidNumber: 500</span><br><span class=\"line\">homeDirectory: /home/users/weiyi</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">mail: weiyi@weiyigeek.top</span><br><span class=\"line\">displayName: WeiyiName</span><br><span class=\"line\"><span class=\"comment\"># search result</span></span><br><span class=\"line\">search: 2</span><br><span class=\"line\">result: 0 Success</span><br><span class=\"line\"><span class=\"comment\"># numResponses: 2</span></span><br><span class=\"line\"><span class=\"comment\"># numEntries: 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(3)模糊匹配条目可以采用通配符进行查找，同时可以结合&gt;和&lt;以及～匹配查找等方式实现更加快速和便捷地定位。</span></span><br><span class=\"line\"><span class=\"comment\">#常用的方式还可以使用cn=*或者cn=admin这样进行指定信息进行过滤</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -x -H ldap://localhost:389 -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek <span class=\"string\">\"cn=*\"</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -x -H ldap://localhost:389 -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek <span class=\"string\">\"ou=*\"</span></span><br><span class=\"line\"><span class=\"comment\"># Development, weiyigeek.top</span></span><br><span class=\"line\">dn: ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">ou: Development</span><br><span class=\"line\">objectClass: organizationalUnit</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\"><span class=\"comment\"># People, weiyigeek.top</span></span><br><span class=\"line\">dn: ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">objectClass: organizationalUnit</span><br><span class=\"line\">ou: People</span><br><span class=\"line\"><span class=\"comment\"># search result</span></span><br><span class=\"line\">search: 2</span><br><span class=\"line\">result: 0 Success</span><br><span class=\"line\"><span class=\"comment\"># numResponses: 3</span></span><br><span class=\"line\"><span class=\"comment\"># numEntries: 2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(4) 指定返回信息（类似与在SQL中写Select并且可以采用指定规则排序）</span></span><br><span class=\"line\"><span class=\"comment\">#我们只返回创建的uid的 mail/uid/title/cn/sn</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -x -H ldap://localhost:389 -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek <span class=\"string\">\"cn=Weiyi\"</span> sn cn uid uidNumber mail</span><br><span class=\"line\"><span class=\"comment\"># Weiyi, Development, weiyigeek.top</span></span><br><span class=\"line\">dn: cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">sn: Weiyi</span><br><span class=\"line\">cn: weiyi</span><br><span class=\"line\">uid: weiyi</span><br><span class=\"line\">uidNumber: 1001</span><br><span class=\"line\">mail: weiyi@weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(5) 服务端下查看openldap服务下的dn配置</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config dn</span><br><span class=\"line\">dn: cn=config</span><br><span class=\"line\">dn: cn=module&#123;0&#125;,cn=config</span><br><span class=\"line\">dn: cn=schema,cn=config</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(6) 指定过滤条件查询</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -Q -LLL -Y EXTERNAL -H ldapi:/// -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> <span class=\"string\">\"(ou=*)\"</span>  <span class=\"comment\">#服务端</span></span><br><span class=\"line\"><span class=\"variable\">$ldapsearch</span> -LLL -x -H ldap://127.0.0.1:389/ -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -b <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span> <span class=\"string\">\"(ou=*)\"</span> -w WeiyiGeek <span class=\"comment\">#Client</span></span><br><span class=\"line\">dn: ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">ou: Group</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">objectClass: organizationalUnit</span><br><span class=\"line\"></span><br><span class=\"line\">dn: ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">ou: People</span><br><span class=\"line\">objectClass: organizationalUnit</span><br><span class=\"line\">objectClass: top</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>补充事项:</p>\n<ul>\n<li>1.查询到的是经过Base64编码的字符串，通过解码得到SSHA加密后密匙<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">12:20:25.644 atob(<span class=\"string\">\"e1NTSEF9TE5GaU0rZVZXNGlR43FDdzQ5UzRMNjRlb2xjMjY5OU4=\"</span>)</span><br><span class=\"line\">12:20:25.745 <span class=\"string\">\"&#123;SSHA&#125;LNFiM8eVW4iQGq2w49S4L74eolc2699N\"</span></span><br></pre></td></tr></table></figure></li>\n<li>2.过滤条件实例<ul>\n<li>下列过滤器将搜索包含一个或多个 manager 属性值的条目称为存在搜索： manager=*</li>\n<li>下列过滤器将搜索包含通用名 WeiyiGeek 的条目。这也称为等价搜索：cn=WeiyiGeek</li>\n<li>下列过滤器返回所有不包含通用名 WeiyiGeek 的条目：(!(cn=WeiyiGeek))</li>\n<li>下列过滤器返回的所有条目中都有包含子字符串 X.500 的说明属性：description=<em>X.500</em></li>\n<li>下列过滤器返回所有组织单元为 Marketing 且说明字段中不包含子字符串 X.500 的条目： (&amp;(ou=Marketing)(!(description=<em>X.500</em>)))</li>\n<li>下列过滤器返回所有组织单元为 Marketing 且 manager 为 WeiyiGeek 或 Cindy Zwaska 的条目： (&amp;(ou=Marketing)(|(manager=cn=WeiyiGeek,ou=Marketing,dc=siroe,dc=com)(manager=cn=Cindy Zwaska,ou=Marketing,dc=siroe,dc=com)))</li>\n<li>下列过滤器返回所有不代表人员的条目： (!(objectClass=person))</li>\n<li>下列过滤器返回所有不代表人员且通用名近似于 printer3b 的条目：(&amp;(!(objectClass=person))(cn~=printer3b))</li>\n<li>下列过滤器返回对象类为inetOrgPerson或者为groupOfUniqueNames的条目:<code>(|(objectClass=inetOrgPerson)(objectClass=groupOfUniqueNames))</code></li>\n</ul>\n</li>\n</ul>\n<p><br></p>\n<h5 id=\"ldapadd-命令\"><a href=\"#ldapadd-命令\" class=\"headerlink\" title=\"ldapadd 命令\"></a>ldapadd 命令</h5><h5 id=\"ldapmodify-命令\"><a href=\"#ldapmodify-命令\" class=\"headerlink\" title=\"ldapmodify 命令\"></a>ldapmodify 命令</h5><p>描述:该命令用于进行数据添加，实际上ldapadd只是采用了一个软链接指向ldapmodify，所以此处我们统一进行说明;</p>\n<p>命令参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Option \t说明</span><br><span class=\"line\">-H \tldapuri，格式为ldap://机器名或者IP:端口号，不能与-h和-p同时使用</span><br><span class=\"line\">-h \tLDAP服务器IP或者可解析的hostname，与-p可结合使用，不能与-H同时使用</span><br><span class=\"line\">-p \tLDAP服务器端口号，与-h可结合使用，不能与-H同时使用</span><br><span class=\"line\">-x \t使用简单认证方式</span><br><span class=\"line\">-D \t所绑定的服务器的DN</span><br><span class=\"line\">-w \t绑定DN的密码，与-W二者选一</span><br><span class=\"line\">-W \t不输入密码，会交互式的提示用户输入密码，与-w二者选一</span><br><span class=\"line\">-f \t指定ldif文件作为输入</span><br><span class=\"line\">-a \t添加新的entry，ldapadd缺省使用，ldapmodify 可指定以达到同样作用</span><br><span class=\"line\">-c \t出错后忽略当前错误继续执行，缺省情况下遇到错误即终止</span><br><span class=\"line\">-n \t模拟操作但并不实际执行，用于验证，常与-v一同使用进行问题定位</span><br><span class=\"line\">-v \t显示详细信息</span><br><span class=\"line\">-d \t显示debug信息，可设定级别</span><br><span class=\"line\">-e \t设置客户端证书</span><br><span class=\"line\">-E \t设置客户端私钥</span><br></pre></td></tr></table></figure></p>\n<p>测试添加的LDIF文件内容:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; weiyigeek.ldif &lt;&lt;END</span><br><span class=\"line\"><span class=\"comment\">#添加Organisation Unit</span></span><br><span class=\"line\">dn: ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: add</span><br><span class=\"line\">objectclass: top</span><br><span class=\"line\">objectclass: organizationalUnit</span><br><span class=\"line\">ou: People</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加用户</span></span><br><span class=\"line\">dn: cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: add</span><br><span class=\"line\">sn: Weiyi</span><br><span class=\"line\">cn: weiyi</span><br><span class=\"line\">uid: weiyi</span><br><span class=\"line\">uidNumber: 1001</span><br><span class=\"line\">gidNumber: 500</span><br><span class=\"line\">homeDirectory: /home/users/weiyi</span><br><span class=\"line\">loginShell: /bin/bash</span><br><span class=\"line\">objectClass: inetOrgPerson</span><br><span class=\"line\">objectClass: posixAccount</span><br><span class=\"line\">objectClass: top</span><br><span class=\"line\">mail: weiyi@weiyigeek.top</span><br><span class=\"line\">displayName: WeiyiName</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#ldapmodify ldif文件添加、修改(添加W字段)</span></span><br><span class=\"line\">changetype: add</span><br><span class=\"line\">changetype: modify</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; Demo1.ldif&lt;&lt;END</span><br><span class=\"line\"><span class=\"comment\">#修改字段</span></span><br><span class=\"line\">dn: cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: modify</span><br><span class=\"line\">replace: mail</span><br><span class=\"line\">mail: WeiyiGeek@weiyi.top</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#添加字段</span></span><br><span class=\"line\">dn: cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: modify</span><br><span class=\"line\">add: description</span><br><span class=\"line\">description: Test User</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#删除字段</span></span><br><span class=\"line\">dn: cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: modify</span><br><span class=\"line\">delete: description</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#移动条目&amp;修改UID</span></span><br><span class=\"line\">dn: cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: modrdn</span><br><span class=\"line\">newrdn: uid=WeiyiTest</span><br><span class=\"line\">deleteoldrdn: 0</span><br><span class=\"line\">newsuperior: ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#删除条目(未实现成功)</span></span><br><span class=\"line\">dn: uid=WeiyiTest,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: delete</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; changePasswd.ldif&lt;&lt;END</span><br><span class=\"line\"><span class=\"comment\">#添加密码</span></span><br><span class=\"line\">dn: uid=WeiyiTest,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: modify</span><br><span class=\"line\">add: userPassword</span><br><span class=\"line\">userPassword: 123456</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改密码</span></span><br><span class=\"line\">dn: uid=WeiyiTest,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">changetype: modify</span><br><span class=\"line\">replace: userPassword</span><br><span class=\"line\">userPassword: 123456</span><br><span class=\"line\">END</span><br></pre></td></tr></table></figure></p>\n<p>基础实例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#指定ldif文件进行添加用户（ldapadd）</span></span><br><span class=\"line\"><span class=\"variable\">$ldapadd</span> -H ldap://127.0.0.1:389 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek -f weiyigeek.ldif</span><br><span class=\"line\">adding new entry <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#指定ldif文件进行添加用户 (ldapmodify:方式1，采用-a参数)</span></span><br><span class=\"line\"><span class=\"variable\">$ldapmodify</span> -a -x -H ldap://127.0.0.1:389 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek -f weiyigeek.ldif</span><br><span class=\"line\">adding new entry <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#指定ldif文件进行添加用户、修改 (ldapmodify:方式2需要在ldif文件中加入 changetype: add )</span></span><br><span class=\"line\"><span class=\"variable\">$ldapmodify</span> -x -H ldap://127.0.0.1:389 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek -f weiyigeek.ldif</span><br><span class=\"line\">adding new entry <span class=\"string\">\"ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\">adding new entry <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#指定ldif文件进行修改、增加字段、删除字段、移动条目、删除条目</span></span><br><span class=\"line\"><span class=\"variable\">$ldapmodify</span> -a -x -H ldap://127.0.0.1:389 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek -f Demo1.ldif</span><br><span class=\"line\">modifying entry <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\">modifying entry <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\">modifying entry <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\">modifying rdn of entry <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\">deleting entry <span class=\"string\">\"cn=WeiyiTest,ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br></pre></td></tr></table></figure></p>\n<p><em>Question:中的ldapadd替换称ldapmodify是否能够完全一致的动作？</em><br>Ask:不行，其报错信息:<code>ldapmodify: modify operation type is missing at line 2, entry &quot;cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn&quot;</code>,需要加上-a参数即可;</p>\n<p><em>注意事项:</em></p>\n<ul>\n<li>当部门和人员的信息还未进行关联，当然最简单的方式是先创建部门，然后在人员信息中添加相关内容即可</li>\n<li>添加部门关键信息则为organisationalUnit，添加用户时候关键的objectclass是inetOrgPerson</li>\n</ul>\n<p><br></p>\n<h5 id=\"ldapdelete-命令\"><a href=\"#ldapdelete-命令\" class=\"headerlink\" title=\"ldapdelete 命令\"></a>ldapdelete 命令</h5><p>基础实例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ldapdelete</span> -x -h 127.0.0.1 -p 389 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek <span class=\"string\">\"cn=Weiyi,ou=Development,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h5 id=\"slappasswd-命令\"><a href=\"#slappasswd-命令\" class=\"headerlink\" title=\"slappasswd 命令\"></a>slappasswd 命令</h5><h5 id=\"ldappasswd-命令\"><a href=\"#ldappasswd-命令\" class=\"headerlink\" title=\"ldappasswd 命令\"></a>ldappasswd 命令</h5><p>描述:LDAP有三种方式可以进行修改密码即</p>\n<ul>\n<li>slappasswd命令: 管理员密码修改</li>\n<li>ldappasswd命令: 用户密码修改</li>\n<li>ldapmodify命令结合ldif文件</li>\n</ul>\n<p>ldappasswd 参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-H \tldapuri，格式为ldap://机器名或者IP:端口号，不能与-h和-p同时使用</span><br><span class=\"line\">-h \tLDAP服务器IP或者可解析的hostname，与-p可结合使用，不能与-H同时使用</span><br><span class=\"line\">-p \tLDAP服务器端口号，与-h可结合使用，不能与-H同时使用</span><br><span class=\"line\">-x \t使用简单认证方式</span><br><span class=\"line\">-D \t所绑定的服务器的DN</span><br><span class=\"line\">-w \t绑定DN的密码，与-W二者选一</span><br><span class=\"line\">-W \t不输入密码，会交互式的提示用户输入密码，与-w二者选一</span><br><span class=\"line\">-n \t模拟操作但并不实际执行，用于验证，常与-v一同使用进行问题定位</span><br><span class=\"line\">-v \t显示详细信息</span><br><span class=\"line\">-d \t显示debug信息，可设定级别</span><br><span class=\"line\">-S \t交互式进行密码的提示和输入以及Re-enter，与-s二者选一</span><br><span class=\"line\">-s \t将指定内容设为密码，与-S二者选一</span><br></pre></td></tr></table></figure></p>\n<p>基础实例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#(1)ldappasswd不指定密码的情况下它会自动生成一个密码（实际上是采用admin用户重置其它用户的密码），并添加到userPassword字段之中，之后可以采用前面ldapsearch进行输入此密码进行验证;</span></span><br><span class=\"line\"><span class=\"variable\">$ldappasswd</span> -x -h 127.0.0.1 -p 389 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek <span class=\"string\">\"uid=WeiyiTest,ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\">New password: XJbHKyRF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(2) ldappasswd使用-s指定修改密码,在已知用户密码前提下进行修改现有密码</span></span><br><span class=\"line\"><span class=\"variable\">$ldappasswd</span> -x -h 127.0.0.1 -p 389 -D <span class=\"string\">\"uid=WeiyiTest,ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w XJbHKyRF -s newpass123456</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h4 id=\"0x03-LDAP客户端\"><a href=\"#0x03-LDAP客户端\" class=\"headerlink\" title=\"0x03 LDAP客户端\"></a>0x03 LDAP客户端</h4><h5 id=\"LDAPAccountManager\"><a href=\"#LDAPAccountManager\" class=\"headerlink\" title=\"LDAPAccountManager\"></a>LDAPAccountManager</h5><p>采用 docker 容器部署LDAPAccountManager:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --restart=always --name ldap-account-manager -p 8081:80 \\</span><br><span class=\"line\">--link openldap:ldap-host \\</span><br><span class=\"line\">--env PHPLDAPADMIN_LDAP_HOSTS=ldap-host \\</span><br><span class=\"line\">--env PHPLDAPADMIN_HTTPS=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">--network=opt_default \\</span><br><span class=\"line\">--detach ldapaccountmanager/lam</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#擦拭解释</span></span><br><span class=\"line\">--link这里连接到openldap容器并起了一个别名ldap-host</span><br><span class=\"line\">--env PHPLDAPADMIN_LDAP_HOSTS这里直接通过别名指向openldap容器，这样不需要写死IP地址</span><br><span class=\"line\">--env PHPLDAPADMIN_HTTPS 不使用443协议</span><br><span class=\"line\">--restart=always加入此参数是防止系统重启了容器未启动</span><br><span class=\"line\">--network=已存在的网络 [`docker network ls`可以进行查看，实际与LDAP同一个网络即可]</span><br></pre></td></tr></table></figure></p>\n<p><strong>简单置流程:</strong></p>\n<ul>\n<li>(1) 我们访问<code>http://192.168.107.245:8081/</code>进行LAM基础配置，首次登录点击<code>configuration LAM configuration</code>,然后选择<code>Edit server profiles</code>; </li>\n<li><p>(2) 默认账号密码<code>lam/lam</code>进行认证后才能进行配置<code>Server settings Server settings</code>,<code>Security settings</code> 以及<code>Account Types</code>选项卡中的<code>Users与Groups</code>进行 配置</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414165726.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n<li><p>(3) 返回首页采用安全认证中的配置的DN进行登录LDAP然后进行创建默认的组（Unit），实际你会发现与 <code>PHPLDAPAdmin</code> 操作实际相差不大;</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200414170336.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n</li>\n<li><p>(4) 至此，已经完成docker版的openldap和LDAP Account Manager的安装配置。</p>\n</li>\n</ul>\n<p><br/></p>\n<h5 id=\"PHPLdapAdmin\"><a href=\"#PHPLdapAdmin\" class=\"headerlink\" title=\"PHPLdapAdmin\"></a>PHPLdapAdmin</h5><p>描述:phpLDAPadmin（也称为PLA）是一个基于Web的LDAP客户端。它为LDAP服务器提供简单，随处可访问的多语言管理。phpLDAPadmin是LDAP专业人员和新手的完美LDAP浏览器。其分层树查看器和高级搜索功能使您可以直观地浏览和管理LDAP目录。由于它是一个Web应用程序，因此该LDAP浏览器可在许多平台上运行，使您可以从任何位置轻松管理LDAP服务器。</p>\n<p>官网：<a href=\"http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page\" target=\"_blank\" rel=\"noopener\">http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page</a></p>\n<p>比如采用Docker进行安装:`如果开启HTTPS，需要配置443端口映射：-p 8443:443，并采用https访问<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --privileged -p 10004:80 --name phpldapadmin --env PHPLDAPADMIN_HTTPS=<span class=\"literal\">false</span> --env PHPLDAPADMIN_LDAP_HOSTS=172.17.0.6 --detach osixia/phpldapadmin</span><br></pre></td></tr></table></figure></p>\n<p><strong>基础配置</strong><br>Step1. 访问phpldapAdmin打开浏览器访问：<a href=\"http://192.168.172.245:6080\" target=\"_blank\" rel=\"noopener\">http://192.168.172.245:6080</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">账号：cn&#x3D;admin,dc&#x3D;weiyigeek,dc&#x3D;top</span><br><span class=\"line\">密码：weiyigeek</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408141911.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>Step2.登录phpLdapAdmin添加组以及ldap账号流程步骤如下:</p>\n<ul>\n<li>点击新建实体<code>Create new entry here</code></li>\n<li>Templates选择：<code>Generic: Organisational Unit</code> 建立组织单元，输入组织名称然后提交<br><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408143206.png\" alt=\"WeiyiGeek.OU\"></li>\n<li>回到首页，再次创建条目Templates选择:<code>Generic: Posix Group</code>创建组 ，输入组名称然后提交</li>\n<li>回到首页，点击创建的OU:Development组织，然后点击  <code>Create a child entry</code> 创建创建一个子条目</li>\n<li>Templates选择:<code>Generic: User Account</code> - 根据需求进行输入后进行创建Object，然后点击创建的CN进行查看显示内部属性<code>Show internal attributes</code><br><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408151039.png\" alt=\"WeiyiGeek.CN\"></li>\n<li>提交完成后，点击新增的用户，点击右侧【增加新的属性<code>Add new attribute</code>】,选择属性【Email】添好Email地址点击【Update Object】<br><img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408151250.png\" alt=\"WeiyiGeek.Email\"></li>\n</ul>\n<p>Step3.采用创建的账号进行登陆LDAP;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DN:cn=WeiyiGeek,ou=Development,dc=weiyigeek,dc=com,dc=cn</span><br><span class=\"line\">密码:123456</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408151522.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p><br/></p>\n<h5 id=\"LDAPAdmin\"><a href=\"#LDAPAdmin\" class=\"headerlink\" title=\"LDAPAdmin\"></a>LDAPAdmin</h5><p>描述:Ldap Admin是一个用于LDAP目录管理的免费Windows LDAP客户端和管理工具。此应用程序允许您在LDAP服务器上浏览，搜索，修改，创建和删除对象。它还支持更复杂的操作，例如目录复制和在远程服务器之间移动，并扩展常用编辑功能以支持特定对象类型（例如组和帐户）, 支持多类型系统：Winndows&amp;Linux<br>官网：<a href=\"http://www.ldapadmin.org/\" target=\"_blank\" rel=\"noopener\">http://www.ldapadmin.org/</a></p>\n<p>下载安装LDAP Admin客户端，新增连接如下：</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408153208.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br/></p>\n<h5 id=\"Apache-Directory-Studio\"><a href=\"#Apache-Directory-Studio\" class=\"headerlink\" title=\"Apache Directory Studio\"></a>Apache Directory Studio</h5><p>描述: 设计用来和各种LDAP服务器进行交互操作，提供了一个使用方便的客户端操作平台。除了Apache DS之外，诸如OpenLdap也可以很好地进行交互，对于不习惯不喜欢命令行方式的用户，Apache Directory Studio也是选择之一。</p>\n<p>官方网址：<a href=\"http://directory.apache.org/studio/\" target=\"_blank\" rel=\"noopener\">http://directory.apache.org/studio/</a><br>支持OS：跨平台，支持MacOS/Windows/Linux<br>下载地址：<a href=\"http://directory.apache.org/studio/downloads.html\" target=\"_blank\" rel=\"noopener\">http://directory.apache.org/studio/downloads.html</a></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408153747.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<p><strong>导入与导出</strong></p>\n<ul>\n<li>File-&gt;右键 <code>DN</code> 选择 Export 进行导出格式为LDIF</li>\n<li>File-&gt;右键 <code>DN</code> 选择 Import 进行导入格式为LDIF的备份文件，还能通过直接修改ldif文件进行<code>创建entry或者移动条目</code>;</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200408154940.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br/></p>\n<p><strong>入坑解决:</strong><br><em>(1)import的失败请按照如下顺序进行原因确认：</em></p>\n<ol>\n<li>ldif文件的多个entry的格式，包括全角字符等 </li>\n<li>ldif文件内容是否有缺失，拼写是否有错误 </li>\n<li>ldif文件的内容依赖的部分，这个只能你自己根据系统的情况自行确认，本身ldap就是一个类似目录层级的方式，比如上层目录没有试图添加下层，自然会出错 </li>\n<li>ldap的权限设定与配置 一般来说都是既存的数据和ldif文件中的某个entry写错了导致的问题，请首先排除这个方面的问题</li>\n</ol>\n<p><br/></p>\n<h5 id=\"Migrationtools\"><a href=\"#Migrationtools\" class=\"headerlink\" title=\"Migrationtools\"></a>Migrationtools</h5><p>描述:采用migrationtools工具包，实现导入系统账号的相关信息;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#下载工具包</span></span><br><span class=\"line\">yum -y install migrationtools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改migrationtools的配置文件</span></span><br><span class=\"line\">vim /usr/share/migrationtools/migrate_common.ph </span><br><span class=\"line\">70 <span class=\"comment\"># Default DNS domain</span></span><br><span class=\"line\">71 <span class=\"variable\">$DEFAULT_MAIL_DOMAIN</span> = <span class=\"string\">\"weiyigeek.top\"</span>;</span><br><span class=\"line\">72</span><br><span class=\"line\">73 <span class=\"comment\"># Default base</span></span><br><span class=\"line\">74 <span class=\"variable\">$DEFAULT_BASE</span> = <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成基础的数据文件(可以根据需求把不需要的去掉)</span></span><br><span class=\"line\">/usr/share/migrationtools/migrate_base.pl &gt; base.ldif</span><br><span class=\"line\"><span class=\"variable\">$more</span> base.ldif</span><br><span class=\"line\"><span class=\"comment\"># dn: dc=WeiyiGeek,dc=com,dc=cn</span></span><br><span class=\"line\"><span class=\"comment\"># dc: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: top</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: domain</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># dn: ou=Hosts,dc=WeiyiGeek,dc=com,dc=cn</span></span><br><span class=\"line\"><span class=\"comment\"># ou: Hosts</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: top</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: organizationalUnit</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#把base.ldif导入OpenLDAP的数据文件(-c 强制导入)</span></span><br><span class=\"line\"><span class=\"variable\">$ldapadd</span> -x -c -H ldap://127.0.0.1 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek -f /root/base.ldif</span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Hosts,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Rpc,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Services,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"nisMapName=netgroup.byuser,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Mounts,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Networks,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Group,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Netgroup,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Protocols,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"ou=Aliases,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"nisMapName=netgroup.byhost,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200411003446.png\" alt=\"WeiyiGeek.导入系统账号的相关信息\" title=\"\" class=\"\">\n                <p>WeiyiGeek.导入系统账号的相关信息</p>\n            </figure>\n<ol>\n<li><p>创建两个测试用户及用户组，并修改密码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd ldaptest1</span><br><span class=\"line\">groupadd ldaptest2</span><br><span class=\"line\">useradd -g ldaptest1 ldaptest1</span><br><span class=\"line\">useradd -g ldaptest2 ldaptest2</span><br><span class=\"line\"><span class=\"built_in\">echo</span> 123456 | passwd --stdin ldaptest1</span><br><span class=\"line\"><span class=\"built_in\">echo</span> password | passwd --stdin ldaptest2</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>将刚创建的两个用户导入至openldap数据文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep ldaptest /etc/passwd &gt; users</span><br><span class=\"line\">grep ldaptest /etc/group &gt; groups</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$cat</span> users groups</span><br><span class=\"line\">ldaptest1:x:1001:1001::/home/ldaptest1:/bin/bash</span><br><span class=\"line\">ldaptest2:x:1002:1002::/home/ldaptest2:/bin/bash</span><br><span class=\"line\">ldaptest1:x:1001:</span><br><span class=\"line\">ldaptest2:x:1002:</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用migrationtools将两个临时用户生成ldif文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/share/migrationtools/migrate_passwd.pl users &gt; users.ldif</span><br><span class=\"line\">cat users.ldif</span><br><span class=\"line\"><span class=\"comment\"># dn: uid=ldaptest1,ou=People,dc=WeiyiGeek,dc=com,dc=cn</span></span><br><span class=\"line\"><span class=\"comment\"># uid: ldaptest1</span></span><br><span class=\"line\"><span class=\"comment\"># cn: ldaptest1</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: account</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: posixAccount</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: top</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: shadowAccount</span></span><br><span class=\"line\"><span class=\"comment\"># userPassword: &#123;crypt&#125;$6$Rr.3Z1X8$fmyCvoFFaTw74GVO.G3okx765i3K2CUaEK/Uu0cyNc8/Xn2HHM1DelVM3nmgDNsQWEZGpLCNUtp.faXvspiff1</span></span><br><span class=\"line\"><span class=\"comment\"># shadowLastChange: 18363</span></span><br><span class=\"line\"><span class=\"comment\"># shadowMin: 0</span></span><br><span class=\"line\"><span class=\"comment\"># shadowMax: 99999</span></span><br><span class=\"line\"><span class=\"comment\"># shadowWarning: 7</span></span><br><span class=\"line\"><span class=\"comment\"># loginShell: /bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># uidNumber: 1001</span></span><br><span class=\"line\"><span class=\"comment\"># gidNumber: 1001</span></span><br><span class=\"line\"><span class=\"comment\"># homeDirectory: /home/ldaptest1</span></span><br><span class=\"line\"></span><br><span class=\"line\">/usr/share/migrationtools/migrate_group.pl groups &gt; groups.ldif</span><br><span class=\"line\">cat groups.ldif</span><br><span class=\"line\"><span class=\"comment\"># dn: cn=ldaptest1,ou=Group,dc=WeiyiGeek,dc=com,dc=cn</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: posixGroup</span></span><br><span class=\"line\"><span class=\"comment\"># objectClass: top</span></span><br><span class=\"line\"><span class=\"comment\"># cn: ldaptest1</span></span><br><span class=\"line\"><span class=\"comment\"># userPassword: &#123;crypt&#125;x</span></span><br><span class=\"line\"><span class=\"comment\"># gidNumber: 1001</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>4.把用户导入至openLDAP的数据文件并查询导入的数据<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldapadd -x -H ldap://127.0.0.1 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek -f users.ldif</span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"uid=ldaptest1,ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"uid=ldaptest2,ou=People,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">ldapadd -x -H ldap://127.0.0.1 -D <span class=\"string\">\"cn=admin,dc=WeiyiGeek,dc=com,dc=cn\"</span> -w WeiyiGeek -f groups.ldif</span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"cn=ldaptest1,ou=Group,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br><span class=\"line\"><span class=\"comment\"># adding new entry \"cn=ldaptest2,ou=Group,dc=WeiyiGeek,dc=com,dc=cn\"</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200411121325.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<h5 id=\"JNDI方式\"><a href=\"#JNDI方式\" class=\"headerlink\" title=\"JNDI方式\"></a>JNDI方式</h5><p>描述:我们可以使用Java中使用javax.naming可以对Ldap用户信息进行验证，使用这点可以完成SSO之类功能的集成;</p>\n<p>简单的基础示例:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//登陆与验证LDAP</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> top.weiyigeek.other;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Enumeration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Hashtable;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.Binding;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.Context;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.NameClassPair;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.NamingEnumeration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.Attribute;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.Attributes;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.DirContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.InitialDirContext;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Descr</span> 使用Javax.naming验证LDAP登录</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\"> * javac ldaptest.java</span></span><br><span class=\"line\"><span class=\"comment\"> * java ldaptest</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LDAPDemo</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        String IP = <span class=\"string\">\"10.10.107.245\"</span>;</span><br><span class=\"line\">        String PORT = <span class=\"string\">\"389\"</span>;</span><br><span class=\"line\">        String BASEDN = <span class=\"string\">\"dc=WeiyiGeek,dc=com,dc=cn\"</span>;</span><br><span class=\"line\">        String MANAGER = <span class=\"string\">\"cn=admin\"</span>;</span><br><span class=\"line\">        String PASS = <span class=\"string\">\"WeiyiGeek\"</span>;</span><br><span class=\"line\">        String USERNAME = <span class=\"string\">\"cn=WeiyiGeek,ou=Development\"</span>;</span><br><span class=\"line\">        String LDAP_URL = <span class=\"string\">\"ldap://\"</span>+IP+<span class=\"string\">\":\"</span>+PORT+<span class=\"string\">\"/\"</span>+BASEDN;</span><br><span class=\"line\">        String[] attrIDs = &#123;<span class=\"string\">\"mail\"</span>,<span class=\"string\">\"displayName\"</span>,<span class=\"string\">\"uidNumber\"</span>,<span class=\"string\">\"sn\"</span> &#125;;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//基于哈希表实现的是线程安全的，能用于多线程环境中</span></span><br><span class=\"line\">        Hashtable&lt;String, String&gt; tbl = <span class=\"keyword\">new</span> Hashtable&lt;String, String&gt;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//JNDI </span></span><br><span class=\"line\">        <span class=\"comment\">//为初始化上下文选择服务提供者</span></span><br><span class=\"line\">        tbl.put(Context.INITIAL_CONTEXT_FACTORY,<span class=\"string\">\"com.sun.jndi.ldap.LdapCtxFactory\"</span>);</span><br><span class=\"line\">        <span class=\"comment\">//提供初始化上下文需要的信息</span></span><br><span class=\"line\">        tbl.put(Context.PROVIDER_URL, LDAP_URL);</span><br><span class=\"line\">        tbl.put(Context.SECURITY_AUTHENTICATION, <span class=\"string\">\"simple\"</span>);</span><br><span class=\"line\">        tbl.put(Context.SECURITY_PRINCIPAL, MANAGER+<span class=\"string\">\",\"</span>+BASEDN);</span><br><span class=\"line\">        tbl.put(Context.SECURITY_CREDENTIALS, PASS);</span><br><span class=\"line\">        </span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"--------------Show Env Setting --------------\"</span>);</span><br><span class=\"line\">        Enumeration&lt;String&gt; keys = tbl.keys();</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(keys.hasMoreElements()) &#123;</span><br><span class=\"line\">            System.out.println(tbl.get(keys.nextElement()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"--------------Login Verification LDAP    ---------- \"</span>);</span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//上下文对象</span></span><br><span class=\"line\">        DirContext context = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//创建初始化上下文</span></span><br><span class=\"line\">            context = <span class=\"keyword\">new</span> InitialDirContext(tbl);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"Login Successful! 登录成功\"</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"Login Verification LDAP \\n\"</span>);</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//举上下文有两个方法</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"-------------- 枚举 查询对象 ---------- \"</span>);</span><br><span class=\"line\">            <span class=\"comment\">//方式1:</span></span><br><span class=\"line\"><span class=\"comment\">//            NamingEnumeration list = context.list(\"ou=Development\");  //指定对象</span></span><br><span class=\"line\"><span class=\"comment\">//            while (list.hasMore()) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//                NameClassPair nc = (NameClassPair)list.next();</span></span><br><span class=\"line\"><span class=\"comment\">//                System.out.println(nc);</span></span><br><span class=\"line\"><span class=\"comment\">//            &#125;</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//方式2:</span></span><br><span class=\"line\">            NamingEnumeration&lt;?&gt; bindings = context.listBindings(<span class=\"string\">\"\"</span>); <span class=\"comment\">//不指定对象则显示全部</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (bindings.hasMore()) &#123;</span><br><span class=\"line\">                Binding bd = (Binding)bindings.next();</span><br><span class=\"line\">                System.out.println(bd.getName() + <span class=\"string\">\": \"</span>  + bd.getNameInNamespace() + <span class=\"string\">\": \"</span> + bd.getObject() );</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            bindings.close();</span><br><span class=\"line\">            </span><br><span class=\"line\">          <span class=\"comment\">//对象属性全部读取</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Attributes answer = context.getAttributes(USERNAME);</span><br><span class=\"line\">                System.out.println(<span class=\"string\">\"\\n-----------------获取 \"</span>+ USERNAME + <span class=\"string\">\" 对象属性-----------------\"</span>);</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (NamingEnumeration ae = answer.getAll(); ae.hasMore();) &#123;</span><br><span class=\"line\">                    Attribute attr = (Attribute)ae.next();</span><br><span class=\"line\">                    System.out.print(attr.getID());</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> (NamingEnumeration e = attr.getAll(); e.hasMore(); System.out.println(<span class=\"string\">\" : \"</span> + e.next()));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">               System.out.println(<span class=\"string\">\"Read Fail : \"</span> + USERNAME + <span class=\"string\">\" Object 对象不存在!\"</span>);</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">            </span><br><span class=\"line\">           </span><br><span class=\"line\">          <span class=\"comment\">//指定对象属性读取</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Attributes answer = context.getAttributes(USERNAME, attrIDs);</span><br><span class=\"line\">                System.out.println(<span class=\"string\">\"\\n----------------- 获取对象指定属性 -----------------\"</span>);</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (NamingEnumeration ae = answer.getAll(); ae.hasMore();) &#123;</span><br><span class=\"line\">                    Attribute attr = (Attribute)ae.next();</span><br><span class=\"line\">                    System.out.print(attr.getID());</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> (NamingEnumeration e = attr.getAll(); e.hasMore(); System.out.println(<span class=\"string\">\" : \"</span> + e.next()));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">               System.out.println(<span class=\"string\">\"Read Fail : \"</span> + USERNAME + <span class=\"string\">\" Object 对象不存在!\"</span>);</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"Login failed : \"</span> + e.getMessage());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//销毁context上下文对象</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (context != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    context.close();</span><br><span class=\"line\">                    context = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                tbl.clear();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">\"Exception happened.\"</span> + e.getMessage());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--------------Show Env Setting --------------</span><br><span class=\"line\">ldap://10.10.107.245:389/dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">com.sun.jndi.ldap.LdapCtxFactory</span><br><span class=\"line\">cn=admin,dc=WeiyiGeek,dc=com,dc=cn</span><br><span class=\"line\">simple</span><br><span class=\"line\">WeiyiGeek</span><br><span class=\"line\"></span><br><span class=\"line\">--------------Login Verification LDAP    ---------- </span><br><span class=\"line\">Login Successful! 登录成功</span><br><span class=\"line\">Login Verification LDAP </span><br><span class=\"line\"></span><br><span class=\"line\">-------------- 枚举 查询对象 ---------- </span><br><span class=\"line\">cn=User: cn=User,dc=WeiyiGeek,dc=com,dc=cn: com.sun.jndi.ldap.LdapCtx@5e9f23b4</span><br><span class=\"line\">cn=admin: cn=admin,dc=WeiyiGeek,dc=com,dc=cn: com.sun.jndi.ldap.LdapCtx@4783da3f</span><br><span class=\"line\">ou=Development: ou=Development,dc=WeiyiGeek,dc=com,dc=cn: com.sun.jndi.ldap.LdapCtx@378fd1ac</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------获取 cn=WeiyiGeek,ou=Development 对象属性-----------------</span><br><span class=\"line\">sn : WeiyiGeek</span><br><span class=\"line\">userPassword : [B@49097b5d</span><br><span class=\"line\">loginShell : /bin/bash</span><br><span class=\"line\">uidNumber : 1000</span><br><span class=\"line\">gidNumber : 500</span><br><span class=\"line\">displayName : 唯一极客</span><br><span class=\"line\">mail : <span class=\"built_in\">test</span>@weiyigeek.top</span><br><span class=\"line\">objectClass : inetOrgPerson</span><br><span class=\"line\"> : posixAccount</span><br><span class=\"line\"> : top</span><br><span class=\"line\">uid : weiyigeek</span><br><span class=\"line\">cn :  WeiyiGeek</span><br><span class=\"line\">homeDirectory : /home/users/weiyigeek</span><br><span class=\"line\"></span><br><span class=\"line\">----------------- 获取对象指定属性 -----------------</span><br><span class=\"line\">mail : <span class=\"built_in\">test</span>@weiyigeek.top</span><br><span class=\"line\">displayName : 唯一极客</span><br><span class=\"line\">uidNumber : 1000</span><br><span class=\"line\">sn : WeiyiGeek</span><br></pre></td></tr></table></figure></p>\n<p>其它博主的代码:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.ldap;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Hashtable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Random;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.AuthenticationException;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.Context;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.NamingEnumeration;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.NamingException;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.BasicAttribute;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.BasicAttributes;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.SearchControls;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.directory.SearchResult;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.ldap.Control;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.ldap.InitialLdapContext;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.naming.ldap.LdapContext;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> monkey</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2019-06-28</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@desc</span> ldap demo</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LDAPAuthentication</span> </span>&#123;  </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String URL = <span class=\"string\">\"ldap://10.0.43.206:389/\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String BASEDN = <span class=\"string\">\"ou=people,dc=youedata,dc=com\"</span>;  <span class=\"comment\">// 根据自己情况进行修改</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String FACTORY = <span class=\"string\">\"com.sun.jndi.ldap.LdapCtxFactory\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> LdapContext ctx = <span class=\"keyword\">null</span>;  </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Control[] connCtls = <span class=\"keyword\">null</span>;  </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">LDAP_connect</span><span class=\"params\">()</span> </span>&#123;  </span><br><span class=\"line\">        Hashtable&lt;String, String&gt; env = <span class=\"keyword\">new</span> Hashtable&lt;String, String&gt;();  </span><br><span class=\"line\">        env.put(Context.INITIAL_CONTEXT_FACTORY, FACTORY);  </span><br><span class=\"line\">        env.put(Context.PROVIDER_URL, URL + BASEDN);  </span><br><span class=\"line\">        env.put(Context.SECURITY_AUTHENTICATION, <span class=\"string\">\"simple\"</span>);  </span><br><span class=\"line\">            </span><br><span class=\"line\">        String root = <span class=\"string\">\"cn=admin,dc=youedata,dc=com\"</span>;  <span class=\"comment\">//根据自己情况修改</span></span><br><span class=\"line\">        env.put(Context.SECURITY_PRINCIPAL, root);   <span class=\"comment\">// 管理员  </span></span><br><span class=\"line\">        env.put(Context.SECURITY_CREDENTIALS, <span class=\"string\">\"youedata520\"</span>);  <span class=\"comment\">// 管理员密码</span></span><br><span class=\"line\">           </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            ctx = <span class=\"keyword\">new</span> InitialLdapContext(env, connCtls);  </span><br><span class=\"line\">            System.out.println( <span class=\"string\">\"LDAP_connect连接成功\"</span> );</span><br><span class=\"line\">               </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (javax.naming.AuthenticationException e) &#123;  </span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"连接失败：\"</span>);  </span><br><span class=\"line\">            e.printStackTrace();  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"连接出错：\"</span>);  </span><br><span class=\"line\">            e.printStackTrace();  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">           </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">closeContext</span><span class=\"params\">()</span></span>&#123;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ctx != <span class=\"keyword\">null</span>) &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">        ctx.close();  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">catch</span> (NamingException e) &#123;  </span><br><span class=\"line\">        e.printStackTrace();  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">  &#125;  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> String <span class=\"title\">getUserDN</span><span class=\"params\">(String uid)</span> </span>&#123;  </span><br><span class=\"line\">        String userDN = <span class=\"string\">\"\"</span>;  </span><br><span class=\"line\">        LDAP_connect();  </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            SearchControls constraints = <span class=\"keyword\">new</span> SearchControls();  </span><br><span class=\"line\">            constraints.setSearchScope(SearchControls.SUBTREE_SCOPE);  </span><br><span class=\"line\">              </span><br><span class=\"line\">            NamingEnumeration&lt;SearchResult&gt; en = ctx.search(<span class=\"string\">\"\"</span>, <span class=\"string\">\"uid=\"</span> + uid, constraints);  </span><br><span class=\"line\">              </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (en == <span class=\"keyword\">null</span> || !en.hasMoreElements()) &#123;  </span><br><span class=\"line\">                System.out.println(<span class=\"string\">\"未找到该用户\"</span>);  </span><br><span class=\"line\">            &#125;  </span><br><span class=\"line\">            <span class=\"comment\">// maybe more than one element  </span></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (en != <span class=\"keyword\">null</span> &amp;&amp; en.hasMoreElements()) &#123;  </span><br><span class=\"line\">                Object obj = en.nextElement();  </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (obj <span class=\"keyword\">instanceof</span> SearchResult) &#123;  </span><br><span class=\"line\">                    SearchResult si = (SearchResult) obj;  </span><br><span class=\"line\">                    userDN += si.getName();  </span><br><span class=\"line\">                    userDN += <span class=\"string\">\",\"</span> + BASEDN;  </span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">                    System.out.println(obj);  </span><br><span class=\"line\">                &#125;  </span><br><span class=\"line\">            &#125;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"查找用户时产生异常。\"</span>);  </span><br><span class=\"line\">            e.printStackTrace();  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">return</span> userDN;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">authenricate</span><span class=\"params\">(String UID, String password)</span> </span>&#123;  </span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> valide = <span class=\"keyword\">false</span>;  </span><br><span class=\"line\">        String userDN = getUserDN(UID);  </span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            ctx.addToEnvironment(Context.SECURITY_PRINCIPAL, userDN);  </span><br><span class=\"line\">            ctx.addToEnvironment(Context.SECURITY_CREDENTIALS, password);  </span><br><span class=\"line\">            ctx.reconnect(connCtls);  </span><br><span class=\"line\">            System.out.println(userDN + <span class=\"string\">\" 验证通过\"</span>);  </span><br><span class=\"line\">            valide = <span class=\"keyword\">true</span>;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (AuthenticationException e) &#123;  </span><br><span class=\"line\">            System.out.println(userDN + <span class=\"string\">\" 验证失败\"</span>);  </span><br><span class=\"line\">            System.out.println(e.toString());  </span><br><span class=\"line\">            valide = <span class=\"keyword\">false</span>;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NamingException e) &#123;  </span><br><span class=\"line\">            System.out.println(userDN + <span class=\"string\">\" 验证失败\"</span>);  </span><br><span class=\"line\">            valide = <span class=\"keyword\">false</span>;  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        closeContext();  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> valide;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span>  <span class=\"keyword\">boolean</span> <span class=\"title\">addUser</span><span class=\"params\">(String usr, String pwd)</span> </span>&#123;  </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            LDAP_connect();  </span><br><span class=\"line\">            BasicAttributes attrsbu = <span class=\"keyword\">new</span> BasicAttributes();  </span><br><span class=\"line\">            BasicAttribute objclassSet = <span class=\"keyword\">new</span> BasicAttribute(<span class=\"string\">\"objectclass\"</span>);</span><br><span class=\"line\">            <span class=\"comment\">//可以和数据库关联，做一个自增，比如mysql存起来</span></span><br><span class=\"line\">            String str = <span class=\"keyword\">new</span> Random().nextInt(<span class=\"number\">10000</span>) + <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">            objclassSet.add(<span class=\"string\">\"inetOrgPerson\"</span>);  </span><br><span class=\"line\">            objclassSet.add(<span class=\"string\">\"top\"</span>);</span><br><span class=\"line\">            objclassSet.add(<span class=\"string\">\"posixAccount\"</span>);</span><br><span class=\"line\">            attrsbu.put(objclassSet);</span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"sn\"</span>, usr);  </span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"cn\"</span>, usr);  </span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"uid\"</span>, usr);  </span><br><span class=\"line\">            <span class=\"comment\">//邮箱不能重复，不然账号无法登陆</span></span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"mail\"</span>, <span class=\"string\">\"450416064@qq.com\"</span>);</span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"gidNumber\"</span>, str);</span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"uidNumber\"</span>, str);</span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"homeDirectory\"</span>, <span class=\"string\">\"/home/account\"</span>);</span><br><span class=\"line\"> </span><br><span class=\"line\">            attrsbu.put(<span class=\"string\">\"userPassword\"</span>, pwd);</span><br><span class=\"line\">            ctx.createSubcontext(<span class=\"string\">\"uid=\"</span>+ usr , attrsbu);</span><br><span class=\"line\"> </span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"======================&gt;\"</span> + usr + <span class=\"string\">\"添加成功\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NamingException ex) &#123;  </span><br><span class=\"line\">           ex.printStackTrace();  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        closeContext();  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;  </span><br><span class=\"line\">    &#125;   </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;  </span><br><span class=\"line\">        LDAPAuthentication ldap = <span class=\"keyword\">new</span> LDAPAuthentication();  </span><br><span class=\"line\">          </span><br><span class=\"line\">        ldap.LDAP_connect();  </span><br><span class=\"line\">   </span><br><span class=\"line\">        ldap.addUser(<span class=\"string\">\"qq1111\"</span>,<span class=\"string\">\"123456\"</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(ldap.authenricate(<span class=\"string\">\"qq1111\"</span>, <span class=\"string\">\"123456\"</span>) == <span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\">            System.out.println( <span class=\"string\">\"该用户认证成功\"</span> );</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>Java连接LDAP-JNDI参考:</p>\n<ul>\n<li><a href=\"https://blog.csdn.net/liumm0000/article/details/7932019\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/liumm0000/article/details/7932019</a></li>\n<li><a href=\"https://blog.csdn.net/lj88811498/article/details/94025629\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/lj88811498/article/details/94025629</a></li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Database","path":"api/categories/Database.json"}],"tags":[{"name":"LDAP","path":"api/tags/LDAP.json"}]}