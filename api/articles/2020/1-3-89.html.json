{"title":"MySQL运维常用Shell脚本汇集","slug":"数据存储/Database-运维/MySQL/运维实战/MySQL运维常用Shell脚本汇集","date":"2020-01-03T06:34:30.000Z","updated":"2022-03-29T05:39:06.312Z","url":"2020/1-3-89.html","path":"api/articles/2020/1-3-89.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200103143609.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言说明\"><a href=\"#0x00-前言说明\" class=\"headerlink\" title=\"0x00 前言说明\"></a>0x00 前言说明</h4><p>描述:本文章是为了记录在日常MySQL运维中对数据库进行操作处理的Shell脚本编写，做一个备份说明；</p>\n<h4 id=\"0x01-备份\"><a href=\"#0x01-备份\" class=\"headerlink\" title=\"0x01 备份\"></a>0x01 备份</h4><p><strong>1.Mysql数据库备份自动删除</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#Func:数据库备份并删除10天的备份文件</span></span><br><span class=\"line\"><span class=\"built_in\">read</span> -t 30 -p <span class=\"string\">\"请输入数据库备份得路径:\"</span> dir</span><br><span class=\"line\">filename=<span class=\"string\">\"<span class=\"variable\">$&#123;dir&#125;</span>db_time.<span class=\"variable\">$(date \"+%Y-%m-%d\")</span>.sql\"</span></span><br><span class=\"line\">mysqldump --database db_time -u root -p root &gt; <span class=\"variable\">$filename</span></span><br><span class=\"line\"><span class=\"comment\">#获取日期当前减去10天(也可以使用ls列举出前十天的文件进行全部删除)</span></span><br><span class=\"line\">d=$(date -d <span class=\"string\">\"-10 day\"</span> +%Y-%m-%d)</span><br><span class=\"line\"><span class=\"comment\">#删除10天前的备份文件</span></span><br><span class=\"line\">del_file=<span class=\"string\">\"<span class=\"variable\">$&#123;dir&#125;</span>db_time.<span class=\"variable\">$&#123;d&#125;</span>.sql\"</span></span><br><span class=\"line\">rm -rf <span class=\"variable\">$del_file</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>2.mysql多数据库与表备份</strong><br>描述:分表备份与备份数据库差不多，优缺点：文件多，分布；碎<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#linux</span></span><br><span class=\"line\">mysql -uroot -p123456 -e <span class=\"string\">\"show databases;\"</span> | grep -Evi <span class=\"string\">\"database|info|perfor\"</span> | sed -r <span class=\"string\">'s#^([a-z].*$)'</span><span class=\"comment\">#mysqldump -uroot -p123456 --event -B \\1|gzip &gt; /opt/backup/\\1.sql.gz#g' | bash  //bash是执行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#windwows (git)</span></span><br><span class=\"line\">mysql -uroot -p123456 -e <span class=\"string\">\"show databases;\"</span> | findstr /V /I <span class=\"string\">\"Database information performance\"</span> |sed -r <span class=\"string\">\"s#^([a-z].*$)# mysqldump.exe -uroot -p123456 --events -B \\1|gzip &gt;.\\/backup\\/\\1.sql#g\"</span>|cmd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#分表备份：</span></span><br><span class=\"line\">mysql -uroot -p123456 -e <span class=\"string\">\"use demo;show tables\"</span> | findstr <span class=\"string\">\"u w\"</span></span><br></pre></td></tr></table></figure></p>\n<p>相关脚本:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#shell脚本</span></span><br><span class=\"line\"><span class=\"comment\">#!/bash/bin</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> down <span class=\"keyword\">in</span> `mysql -uroot -p123456 -e <span class=\"string\">\"show databases;\"</span> | grep -Evi <span class=\"string\">\"database|information|performance\"</span>`</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">  mysqldump -uroot -p123456 --events -B <span class=\"variable\">$down</span>|gzip &gt; /opt/back/<span class=\"variable\">$&#123;down&#125;</span>_bak.sql.gz</span><br><span class=\"line\"><span class=\"keyword\">done</span>    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#bat脚本</span></span><br><span class=\"line\">@<span class=\"built_in\">echo</span> off</span><br><span class=\"line\">mysql -uroot -p123456 -e <span class=\"string\">\"show databases;\"</span> |findstr /V /I <span class=\"string\">\"Database information performance\"</span> &gt; data.txt</span><br><span class=\"line\"><span class=\"keyword\">for</span> /f <span class=\"string\">\"\"</span> %%v IN (data.txt) DO @mysqldump.exe -uroot -p123456 --events -B %%v &gt; ./backup/%%v.sql.gz</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"备份完成\"</span></span><br><span class=\"line\">del /s /f /q data.txt</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200103143609.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p><br></p>\n<h4 id=\"0x02-主从相关\"><a href=\"#0x02-主从相关\" class=\"headerlink\" title=\"0x02 主从相关\"></a>0x02 主从相关</h4><p><strong>1.主从库一键自动化主从复制脚本</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#（1）模式主从同步的步骤，获取到全备及全备过程的binlog位置信息或者直接使用--master-data参数解决；</span></span><br><span class=\"line\"><span class=\"comment\">#---- master 主库 ----#</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">MYUSER=<span class=\"string\">\"root\"</span></span><br><span class=\"line\">MYPASS=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">MYSOCK=/data/3306/mysql.sock</span><br><span class=\"line\">MAIN_PATH=/server/backup</span><br><span class=\"line\">LOG_FILE=<span class=\"variable\">$&#123;MAIN_PATH&#125;</span>/logs_`date +%F`.<span class=\"built_in\">log</span></span><br><span class=\"line\">DATA_FILE=<span class=\"variable\">$&#123;MAIN_PATH&#125;</span>/backup_`date +%F`.sql.gz</span><br><span class=\"line\">MYSQL_PATH=/usr/<span class=\"built_in\">local</span>/mysql/bin</span><br><span class=\"line\">MYSQL_CMD=<span class=\"string\">\"<span class=\"variable\">$&#123;MYSQL_PATH&#125;</span>/mysql -u<span class=\"variable\">$MYUSER</span> -p<span class=\"variable\">$MYPASS</span> -S <span class=\"variable\">$MYSOCK</span>\"</span></span><br><span class=\"line\">MYSQL_DUMP=<span class=\"string\">\"<span class=\"variable\">$&#123;MYSQL_PATH&#125;</span>/mysqldump -u<span class=\"variable\">$MYUSER</span> -p<span class=\"variable\">$MYPASS</span> -S <span class=\"variable\">$MYSOCK</span> -A -B --master-data=1 --single-transaction -e\"</span>  <span class=\"comment\">#single-transaction 针对于Innodb备份 （全备）</span></span><br><span class=\"line\"><span class=\"comment\">#值得学习的地方 (注意采用EOF可以输入多行命令)</span></span><br><span class=\"line\">cat | <span class=\"variable\">$MYSQL_CMD</span>&lt;&lt; EOF</span><br><span class=\"line\">flush tables with <span class=\"built_in\">read</span> lock;</span><br><span class=\"line\">system <span class=\"built_in\">echo</span> <span class=\"string\">\"--show master status --\"</span> &gt;&gt;<span class=\"variable\">$LOG_FILE</span>;</span><br><span class=\"line\">system MYSQL_CMD -e <span class=\"string\">\"show master status;\"</span>|tail -l &gt;&gt;<span class=\"variable\">$LOG_FILE</span>;</span><br><span class=\"line\">system <span class=\"variable\">$&#123;MYSQL_DUMP&#125;</span> | gzip &gt;<span class=\"variable\">$DATA_FILE</span>;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"unlock tables;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#---- slave 从库 ----#</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">MYUSER=<span class=\"string\">\"root\"</span></span><br><span class=\"line\">MYPASS=<span class=\"string\">\"123456\"</span></span><br><span class=\"line\">MYSOCK=/data/3306/mysql.sock</span><br><span class=\"line\">MAIN_PATH=/server/backup</span><br><span class=\"line\">LOG_FILE=<span class=\"variable\">$&#123;MAIN_PATH&#125;</span>/logs_`date +%F`.<span class=\"built_in\">log</span></span><br><span class=\"line\">DATA_FILE=<span class=\"variable\">$&#123;MAIN_PATH&#125;</span>/backup_`date +%F`.sql.gz</span><br><span class=\"line\">MYSQL_PATH=/usr/<span class=\"built_in\">local</span>/mysql/bin</span><br><span class=\"line\">MYSQL_CMD=<span class=\"string\">\"<span class=\"variable\">$&#123;MYSQL_PATH&#125;</span>/mysql -u<span class=\"variable\">$MYUSER</span> -p<span class=\"variable\">$MYPASS</span> -S <span class=\"variable\">$MYSOCK</span>\"</span></span><br><span class=\"line\"><span class=\"comment\">#recover</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;MAIN_PATH&#125;</span></span><br><span class=\"line\">gzip -d backup_`date +%F`.sql.gz</span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span>&lt;backup_`date +%F`.sql</span><br><span class=\"line\"><span class=\"comment\">#config slave (由于是全备所以不需要加pos位置)</span></span><br><span class=\"line\">cat |<span class=\"variable\">$MYSQL_CMD</span>&lt;&lt; EOF</span><br><span class=\"line\">CHANGE MASTER TO</span><br><span class=\"line\">MASTER_HOST=<span class=\"string\">'10.0.0.1'</span>,</span><br><span class=\"line\">MASTER_PORT=<span class=\"string\">\"3306\"</span>,</span><br><span class=\"line\">MASTER_USER=<span class=\"string\">'rep'</span>,</span><br><span class=\"line\">MASTER_PASSWORD=<span class=\"string\">'oldboy123'</span>,</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"start slave;\"</span></span><br><span class=\"line\"><span class=\"variable\">$MYSQL_CMD</span> -e <span class=\"string\">\"show slave status\\G\"</span> |egrep <span class=\"string\">\"IO_Runing|SQL_Runing\"</span> &gt;<span class=\"variable\">$LOG_FILE</span></span><br><span class=\"line\">mail -s <span class=\"string\">\"mysql slave result\"</span> xxx@test.com &lt;<span class=\"variable\">$LOG_FILE</span></span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Database","path":"api/categories/Database.json"},{"name":"DBA","path":"api/categories/DBA.json"},{"name":"运维","path":"api/categories/运维.json"}],"tags":[{"name":"MYSQL","path":"api/tags/MYSQL.json"}]}