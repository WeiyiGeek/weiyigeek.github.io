{"title":"企业内部DNS主从服务搭建与安全配置实践","slug":"系统运维/Application/DNS/DNS主从服务之企业内部搭建与安全配置实践","date":"2020-01-20T07:37:27.000Z","updated":"2022-03-29T05:39:06.309Z","url":"2020/1-20-541.html","path":"api/articles/2020/1-20-541.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210324140133.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126224430.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-实践案例\"><a href=\"#0x00-实践案例\" class=\"headerlink\" title=\"0x00 实践案例\"></a>0x00 实践案例</h2><h3 id=\"1-企业内部DNS主从服务搭建配置\"><a href=\"#1-企业内部DNS主从服务搭建配置\" class=\"headerlink\" title=\"1) 企业内部DNS主从服务搭建配置\"></a>1) 企业内部DNS主从服务搭建配置</h3><p><strong>实验目标:</strong> 内部DNS主从搭建以及DNS服务器安全配置;</p>\n<p><strong>环境准备:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 主机</span></span><br><span class=\"line\">master - ns1 - 192.168.12.254 <span class=\"comment\"># 主DNS服务器\t</span></span><br><span class=\"line\">slave - ns2 - 192.168.10.254  <span class=\"comment\"># 备DSN服务器\t</span></span><br><span class=\"line\">slave - ns3 - 192.168.4.254   <span class=\"comment\"># 备DSN服务器\t</span></span><br><span class=\"line\">any <span class=\"comment\"># 客户机器1\t</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># OS 环境</span></span><br><span class=\"line\">Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-67-generic x86_64)</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>实践流程:</strong></p>\n<ul>\n<li>Step 1.基础环境设置<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 防火墙设置(后面没有特殊注明的即为三台主机都要执行)</span></span><br><span class=\"line\">systemctl status ufw</span><br><span class=\"line\"><span class=\"comment\"># ● ufw.service - Uncomplicated firewall</span></span><br><span class=\"line\"><span class=\"comment\">#      Loaded: loaded (/lib/systemd/system/ufw.service; enabled; vendor preset: enabled)</span></span><br><span class=\"line\"><span class=\"comment\">#      Active: active (exited) since Thu 2021-02-04 14:13:09 CST; 1 months 15 days ago</span></span><br><span class=\"line\">sudo ufw allow 53</span><br><span class=\"line\">  <span class=\"comment\"># Rules updated</span></span><br><span class=\"line\">  <span class=\"comment\"># Rules updated (v6)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 安装 Bind9</span></span><br><span class=\"line\">apt install bind9 -y</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"Master-主DNS配置\"><a href=\"#Master-主DNS配置\" class=\"headerlink\" title=\"Master-主DNS配置\"></a>Master-主DNS配置</h4><ul>\n<li>Step 2.Bind之Master节点配置<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (2) Master DNS Server 配置文件在master - ns1机器上执行如下命令</span></span><br><span class=\"line\">mkdir -vp /var/cache/<span class=\"built_in\">bind</span>/master/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Options</span></span><br><span class=\"line\">sudo tee /etc/<span class=\"built_in\">bind</span>/named.conf.options &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\"><span class=\"comment\"># ACL - 访问控制</span></span><br><span class=\"line\">acl <span class=\"string\">\"trusted\"</span> &#123;</span><br><span class=\"line\">  localhost;       <span class=\"comment\"># ns1 - can be set to localhost</span></span><br><span class=\"line\">  192.168.12.254;  <span class=\"comment\"># ns1</span></span><br><span class=\"line\">  192.168.10.254;  <span class=\"comment\"># ns2</span></span><br><span class=\"line\">  192.168.4.254;   <span class=\"comment\"># ns3</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">acl <span class=\"string\">\"innerhost\"</span> &#123;</span><br><span class=\"line\">  10.0.0.0/8;</span><br><span class=\"line\">  172.16.0.0/12;</span><br><span class=\"line\">  192.168.0.0/16;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 选项 - 全局配置</span></span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">    directory <span class=\"string\">\"/var/cache/bind\"</span>;</span><br><span class=\"line\">    listen-on port 53 &#123; any; &#125;;</span><br><span class=\"line\">    <span class=\"comment\"># listen-on-v6 port 53 &#123; any; &#125;;</span></span><br><span class=\"line\">    dnssec-validation no;</span><br><span class=\"line\">    auth-nxdomain no;      <span class=\"comment\"># 是否做为权威服务器回答域不存在 conform to RFC1035</span></span><br><span class=\"line\">    allow-query &#123; any; &#125;;</span><br><span class=\"line\">    allow-query-cache &#123; any; &#125;;</span><br><span class=\"line\">    dump-file       <span class=\"string\">\"/var/cache/bind/cache_dump.db\"</span>;</span><br><span class=\"line\">    statistics-file <span class=\"string\">\"/var/cache/bind/named_stats.txt\"</span>;</span><br><span class=\"line\">    memstatistics-file <span class=\"string\">\"/var/cache/bind/named_mem_stats.txt\"</span>;</span><br><span class=\"line\">    <span class=\"comment\"># recursion yes;   </span></span><br><span class=\"line\">    forwarders &#123;</span><br><span class=\"line\">      223.6.6.6;       <span class=\"comment\"># 阿里云 dns</span></span><br><span class=\"line\">      223.5.5.5;       <span class=\"comment\"># 阿里云 secondary dns</span></span><br><span class=\"line\">      114.114.114.114; <span class=\"comment\"># 百度 dns</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日志 - 查询记录10个文件每个文件20MB</span></span><br><span class=\"line\">logging &#123;</span><br><span class=\"line\">  channel query_log &#123;</span><br><span class=\"line\">    file <span class=\"string\">\"dns-query.log\"</span> versions 10 size 20m;</span><br><span class=\"line\">    severity info;</span><br><span class=\"line\">    <span class=\"built_in\">print</span>-time yes;</span><br><span class=\"line\">    <span class=\"built_in\">print</span>-category yes;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  category queries &#123;</span><br><span class=\"line\">    query_log;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 区域文件</span></span><br><span class=\"line\">sudo tee /etc/<span class=\"built_in\">bind</span>/named.conf.local &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">zone <span class=\"string\">\".\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> hint;</span><br><span class=\"line\">  file <span class=\"string\">\"/usr/share/dns/root.hints\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.cn\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.weiyigeek.cn\"</span>;</span><br><span class=\"line\">    notify yes; </span><br><span class=\"line\">    also-notify &#123; trusted; &#125;;    <span class=\"comment\"># 从 DNS</span></span><br><span class=\"line\">    allow-transfer &#123; trusted; &#125;;    <span class=\"comment\"># ns2 / ns3 private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.top\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.weiyigeek.top\"</span>;</span><br><span class=\"line\">    notify yes; </span><br><span class=\"line\">    allow-transfer &#123; trusted; &#125;;    <span class=\"comment\"># ns2 / ns3  private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">zone <span class=\"string\">\"168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.168.192\"</span>;</span><br><span class=\"line\">    notify yes; </span><br><span class=\"line\">    allow-transfer &#123; trusted; &#125;;    <span class=\"comment\"># ns2 / ns3  private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"12.168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.12.168.192\"</span>;</span><br><span class=\"line\">    notify yes;</span><br><span class=\"line\">    allow-transfer &#123; trusted; &#125;;    <span class=\"comment\"># ns2 / ns3  private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 内部域名正向解析与反向解析</span></span><br><span class=\"line\">tee /var/cache/<span class=\"built_in\">bind</span>/master/db.weiyigeek.top &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">; BIND data file <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> loopback interface</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 86400</span><br><span class=\"line\">@       IN      SOA     ns1.weiyigeek.top. admin.weiyigeek.top. (</span><br><span class=\"line\">                      202103021         ; Serial</span><br><span class=\"line\">                          50400         ; Refresh</span><br><span class=\"line\">                          86400         ; Retry</span><br><span class=\"line\">                         604800         ; Expire</span><br><span class=\"line\">                          86400 )       ; Negative Cache TTL</span><br><span class=\"line\">;</span><br><span class=\"line\"></span><br><span class=\"line\">; name servers - NS records</span><br><span class=\"line\">@ IN NS ns1.weiyigeek.top.</span><br><span class=\"line\">@ IN NS ns2.weiyigeek.top.</span><br><span class=\"line\">@ IN NS ns3.weiyigeek.top.</span><br><span class=\"line\">@ IN A 192.168.12.18</span><br><span class=\"line\"></span><br><span class=\"line\">; name servers - A records</span><br><span class=\"line\">ns1.weiyigeek.top. IN A 192.168.12.254</span><br><span class=\"line\">ns2.weiyigeek.top. IN A 192.168.10.254</span><br><span class=\"line\">ns3.weiyigeek.top. IN A 192.168.4.254</span><br><span class=\"line\"></span><br><span class=\"line\">; 192.168.12.0/24 - A records</span><br><span class=\"line\">; CNAME</span><br><span class=\"line\">mail.weiyigeek.top. IN CNAME exmail.qq.com.</span><br><span class=\"line\"></span><br><span class=\"line\">; Resolve-A</span><br><span class=\"line\">www.weiyigeek.top. IN A 192.168.12.18</span><br><span class=\"line\">vcsa.weiyigeek.top. IN A 192.168.12.251</span><br><span class=\"line\">gitlab.weiyigeek.top. IN A 192.168.12.61</span><br><span class=\"line\">maven.weiyigeek.top. IN A 192.168.12.61</span><br><span class=\"line\">harbor.weiyigeek.top. IN A 192.168.12.108</span><br><span class=\"line\">sonar.weiyigeek.top. IN A 192.168.12.109</span><br><span class=\"line\">wiki.weiyigeek.top. IN A 10.10.107.202</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\">tee /var/cache/<span class=\"built_in\">bind</span>/master/db.12.168.192 &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">; BIND reverse data file <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> loopback interface</span><br><span class=\"line\">;</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 86400</span><br><span class=\"line\">@  IN  SOA  weiyigeek.top. admin.weiyigeek.top. (</span><br><span class=\"line\">                      202103022         ; Serial</span><br><span class=\"line\">                          50400         ; Refresh</span><br><span class=\"line\">                          86400         ; Retry</span><br><span class=\"line\">                         604800         ; Expire</span><br><span class=\"line\">                          86400 )       ; Negative Cache TTL</span><br><span class=\"line\">;</span><br><span class=\"line\"> </span><br><span class=\"line\">; name servers</span><br><span class=\"line\">@ IN  NS ns1.weiyigeek.top.</span><br><span class=\"line\">@ IN  NS ns2.weiyigeek.top.</span><br><span class=\"line\"> </span><br><span class=\"line\">; PTR Records</span><br><span class=\"line\">254 IN PTR ns1.weiyigeek.top.      </span><br><span class=\"line\">18 IN PTR www.weiyigeek.top.</span><br><span class=\"line\">13 IN PTR s.weiyigeek.top.</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">tee /var/cache/<span class=\"built_in\">bind</span>/master/db.weiyigeek.cn &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">; BIND data file <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> loopback interface</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 86400</span><br><span class=\"line\">@       IN      SOA     ns1.weiyigeek.cn. admin.weiyigeek.cn. (</span><br><span class=\"line\">                          3             ; Serial</span><br><span class=\"line\">                          50400         ; Refresh</span><br><span class=\"line\">                          86400         ; Retry</span><br><span class=\"line\">                         604800         ; Expire</span><br><span class=\"line\">                          86400 )       ; Negative Cache TTL</span><br><span class=\"line\">;</span><br><span class=\"line\"></span><br><span class=\"line\">; name servers - NS records</span><br><span class=\"line\">@ IN NS ns1.weiyigeek.cn.</span><br><span class=\"line\">@ IN NS ns2.weiyigeek.cn.</span><br><span class=\"line\">@ IN NS ns3.weiyigeek.cn.</span><br><span class=\"line\">@ IN A 192.168.10.47</span><br><span class=\"line\">view IN NS view</span><br><span class=\"line\"></span><br><span class=\"line\">; name servers - A records</span><br><span class=\"line\">ns1.weiyigeek.cn. IN A 192.168.12.254</span><br><span class=\"line\">ns2.weiyigeek.cn. IN A 192.168.10.254</span><br><span class=\"line\">ns3.weiyigeek.cn. IN A 192.168.4.254</span><br><span class=\"line\"></span><br><span class=\"line\">; 192.168.10.0/24 - A records</span><br><span class=\"line\">; CNAME</span><br><span class=\"line\"></span><br><span class=\"line\">; Resolve-A</span><br><span class=\"line\">www.weiyigeek.cn. IN A 192.168.10.47</span><br><span class=\"line\">mail.weiyigeek.cn. IN A 192.168.10.49</span><br><span class=\"line\">rtx.weiyigeek.cn. IN A 192.168.4.96</span><br><span class=\"line\">pwd.weiyigeek.cn. IN A 192.168.10.55</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">tee /var/cache/<span class=\"built_in\">bind</span>/master/db.168.192 &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">; BIND reverse data file <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> loopback interface</span><br><span class=\"line\">;</span><br><span class=\"line\"><span class=\"variable\">$TTL</span> 86400</span><br><span class=\"line\">@       IN      SOA     weiyigeek.cn. admin.weiyigeek.cn. (</span><br><span class=\"line\">                              4         ; Serial</span><br><span class=\"line\">                          50400         ; Refresh</span><br><span class=\"line\">                          86400         ; Retry</span><br><span class=\"line\">                         604800         ; Expire</span><br><span class=\"line\">                          86400 )       ; Negative Cache TTL</span><br><span class=\"line\">;</span><br><span class=\"line\"> </span><br><span class=\"line\">; name servers</span><br><span class=\"line\">@ IN  NS ns1.weiyigeek.cn.</span><br><span class=\"line\">@ IN  NS ns2.weiyigeek.cn.</span><br><span class=\"line\">@ IN  NS ns3.weiyigeek.cn.</span><br><span class=\"line\"></span><br><span class=\"line\">; PTR Records</span><br><span class=\"line\">254.10 IN PTR ns2.weiyigeek.cn.</span><br><span class=\"line\">254.4 IN PTR ns3.weiyigeek.cn.</span><br><span class=\"line\">47.10 IN PTR www.weiyigeek.cn.</span><br><span class=\"line\">96.4 IN PTR oa.weiyigeek.cn.</span><br><span class=\"line\">96.4 IN PTR rtx.weiyigeek.cn.</span><br><span class=\"line\">END</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"Slave-从DNS配置\"><a href=\"#Slave-从DNS配置\" class=\"headerlink\" title=\"Slave-从DNS配置\"></a>Slave-从DNS配置</h4><p>描述: 此处配置<code>192.168.4.254</code> 以及 <code>192.168.10.254</code>两台北机器上进行操作;</p>\n<ul>\n<li>Step 4.Slave从主机相关Bind配置<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 创建 slave 存放同步的 zone 文件</span></span><br><span class=\"line\">sudo mkdir -vp /var/cache/<span class=\"built_in\">bind</span>/slave/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 删除 include \"/etc/bind/named.conf.default-zones\" 的一行我已经将 zone \".\" 引入到 named.conf.local 文件之中;</span></span><br><span class=\"line\">sudo sed -i <span class=\"string\">'/named.conf.default-zones/d'</span> /etc/<span class=\"built_in\">bind</span>/named.conf</span><br><span class=\"line\">cat /etc/<span class=\"built_in\">bind</span>/named.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) Options 参数配置</span></span><br><span class=\"line\">sudo tee /etc/<span class=\"built_in\">bind</span>/named.conf.options &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\"><span class=\"comment\"># ACL - 访问控制</span></span><br><span class=\"line\">acl <span class=\"string\">\"trusted\"</span> &#123;</span><br><span class=\"line\">  localhost;       <span class=\"comment\"># ns1 - can be set to localhost</span></span><br><span class=\"line\">  192.168.12.254;  <span class=\"comment\"># ns1</span></span><br><span class=\"line\">  192.168.10.254;  <span class=\"comment\"># ns2</span></span><br><span class=\"line\">  192.168.4.254;   <span class=\"comment\"># ns3</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">acl <span class=\"string\">\"innerhost\"</span> &#123;</span><br><span class=\"line\">  10.0.0.0/8;</span><br><span class=\"line\">  172.16.0.0/12;</span><br><span class=\"line\">  192.168.0.0/16;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 选项 - 全局配置</span></span><br><span class=\"line\">options &#123;</span><br><span class=\"line\">    directory <span class=\"string\">\"/var/cache/bind\"</span>;</span><br><span class=\"line\">    listen-on port 53 &#123; any; &#125;;</span><br><span class=\"line\">    <span class=\"comment\"># listen-on-v6 port 53 &#123; any; &#125;;</span></span><br><span class=\"line\">    dnssec-validation no;</span><br><span class=\"line\">    <span class=\"comment\"># 是否做为权威服务器回答域不存在 conform to RFC1035</span></span><br><span class=\"line\">    auth-nxdomain no;  </span><br><span class=\"line\">    allow-query &#123; any; &#125;;</span><br><span class=\"line\">    allow-query-cache &#123; any; &#125;;</span><br><span class=\"line\">    <span class=\"comment\"># recursion yes;   </span></span><br><span class=\"line\">    forwarders &#123;</span><br><span class=\"line\">      223.6.6.6;       <span class=\"comment\"># 阿里云 dns</span></span><br><span class=\"line\">      223.5.5.5;       <span class=\"comment\"># 阿里云 secondary dns</span></span><br><span class=\"line\">      114.114.114.114; <span class=\"comment\"># 百度 dns</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日志 - 查询记录10个文件每个文件20MB</span></span><br><span class=\"line\">logging &#123;</span><br><span class=\"line\">  channel query_log &#123;</span><br><span class=\"line\">    file <span class=\"string\">\"dns-query.log\"</span> versions 10 size 20m;</span><br><span class=\"line\">    severity info;</span><br><span class=\"line\">    <span class=\"built_in\">print</span>-time yes;</span><br><span class=\"line\">    <span class=\"built_in\">print</span>-category yes;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  category queries &#123;</span><br><span class=\"line\">    query_log;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 区域文件：定义与主DNS服务器上的主区域对应的从属区域。 请注意类型是“slave”，文件不包含路径，并且有一个masters指令应该设置为主DNS服务器的专用IP地址</span></span><br><span class=\"line\"></span><br><span class=\"line\">sudo tee /etc/<span class=\"built_in\">bind</span>/named.conf.local &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\">zone <span class=\"string\">\".\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> hint;</span><br><span class=\"line\">  file <span class=\"string\">\"/usr/share/dns/root.hints\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.cn\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> slave;</span><br><span class=\"line\">  file <span class=\"string\">\"slave/db.weiyigeek.cn\"</span>;</span><br><span class=\"line\">  masters &#123; 192.168.12.254; &#125;;    <span class=\"comment\"># Master DNS private IP address </span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.top\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> slave;</span><br><span class=\"line\">  file <span class=\"string\">\"slave/db.weiyigeek.top\"</span>;</span><br><span class=\"line\">  masters&#123;  192.168.12.254; &#125;;    <span class=\"comment\"># Master DNS private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> slave;</span><br><span class=\"line\">  file <span class=\"string\">\"slave/db.168.192\"</span>;</span><br><span class=\"line\">  masters &#123; 192.168.12.254; &#125;;    <span class=\"comment\"># Master DNS private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"12.168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">type</span> slave;</span><br><span class=\"line\">  file <span class=\"string\">\"slave/db.12.168.192\"</span>;</span><br><span class=\"line\">  masters &#123;  192.168.12.254; &#125;;    <span class=\"comment\"># Master DNS private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">END</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"主从配置验证启用\"><a href=\"#主从配置验证启用\" class=\"headerlink\" title=\"主从配置验证启用\"></a>主从配置验证启用</h4><ul>\n<li>Step 4.Master / Slave节点配置验证<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) 区域配置（主、备）</span></span><br><span class=\"line\">$ named-checkconf -p</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2) 内部解析zone配置</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> zone <span class=\"keyword\">in</span> $(ls /var/cache/<span class=\"built_in\">bind</span>/master/);<span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"# <span class=\"variable\">$&#123;zone&#125;</span> ---------------------------\"</span></span><br><span class=\"line\">  named-checkzone <span class=\"variable\">$&#123;zone&#125;</span> /var/cache/<span class=\"built_in\">bind</span>/master/<span class=\"variable\">$&#123;zone&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\n\"</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出结果</span></span><br><span class=\"line\"><span class=\"comment\"># db.12.168.192 ---------------------------</span></span><br><span class=\"line\">zone db.12.168.192/IN: loaded serial 202103022</span><br><span class=\"line\">OK</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># db.168.192 ---------------------------</span></span><br><span class=\"line\">zone db.168.192/IN: loaded serial 4</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<ul>\n<li><p>Step 5.bind相关配置文件所属者与所属组分配</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo chown -R bind:bind &#x2F;var&#x2F;cache&#x2F;bind&#x2F; &#x2F;etc&#x2F;bind&#x2F;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 6.重启named服务以及查看服务的启动状态</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) 启动主dns</span></span><br><span class=\"line\">systemctl restart named &amp;&amp; systemctl status named</span><br><span class=\"line\">  <span class=\"comment\"># ● named.service - BIND Domain Name Server</span></span><br><span class=\"line\">  <span class=\"comment\">#     Loaded: loaded (/lib/systemd/system/named.service; enabled; vendor preset: enabled)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Active: active (running) since Mon 2021-03-22 14:53:55 CST; 24s ago</span></span><br><span class=\"line\">  <span class=\"comment\">#       Docs: man:named(8)</span></span><br><span class=\"line\">  <span class=\"comment\">#   Main PID: 70775 (named)</span></span><br><span class=\"line\">  <span class=\"comment\">#       Tasks: 26 (limit: 9448)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Memory: 50.4M</span></span><br><span class=\"line\">  <span class=\"comment\">#     CGroup: /system.slice/named.service</span></span><br><span class=\"line\">  <span class=\"comment\">#             └─70775 /usr/sbin/named -f -u bind</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone 12.168.192.in-addr.arpa/IN: loaded serial 202103022</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone 168.192.in-addr.arpa/IN: loaded serial 4</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone weiyigeek.top/IN: loaded serial 202103021</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone weiyigeek.cn/IN: loaded serial 3</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: all zones loaded</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: running</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone weiyigeek.top/IN: sending notifies (serial 202103021)</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone weiyigeek.cn/IN: sending notifies (serial 3)</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone 12.168.192.in-addr.arpa/IN: sending notifies (serial 202103022)</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 14:53:55 dns-server named[70775]: zone 168.192.in-addr.arpa/IN: sending notifies (serial 4)</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\"># 2) 启动备dns：此时备dns自动同步主DNS的内容。</span></span><br><span class=\"line\">systemctl restart named &amp;&amp; systemctl status named</span><br><span class=\"line\">  <span class=\"comment\"># named.service - BIND Domain Name Server</span></span><br><span class=\"line\">  <span class=\"comment\">#    Loaded: loaded (/lib/systemd/system/named.service; enabled; vendor preset: enabled)</span></span><br><span class=\"line\">  <span class=\"comment\">#    Active: active (running) since Mon 2021-03-22 18:54:10 CST; 10ms ago</span></span><br><span class=\"line\">  <span class=\"comment\">#      Docs: man:named(8)</span></span><br><span class=\"line\">  <span class=\"comment\">#  Main PID: 46903 (named)</span></span><br><span class=\"line\">  <span class=\"comment\">#     Tasks: 1 (limit: 9448)</span></span><br><span class=\"line\">  <span class=\"comment\">#    Memory: 588.0K</span></span><br><span class=\"line\">  <span class=\"comment\">#    CGroup: /system.slice/named.service</span></span><br><span class=\"line\">  <span class=\"comment\">#            └─46903 /usr/sbin/named -f -u bind</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: command channel listening on ::1#953</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: managed-keys-zone: loaded serial 43</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: all zones loaded</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: running</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: zone weiyigeek.cn/IN: Transfer started.  # 同步传输开始标准</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: transfer of 'weiyigeek.cn/IN' from 192.168.12.254#53: connected using 192.168.4.254#37107</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: zone weiyigeek.cn/IN: transferred serial 3</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: transfer of 'weiyigeek.cn/IN' from 192.168.12.254#53: Transfer status: success   # 同步传输成功标准</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: transfer of 'weiyigeek.cn/IN' from 192.168.12.254#53: Transfer completed: 1 messages, 41 records, 865 bytes, 0.001 secs (865000 bytes/sec)</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 18:54:10 dns-server named[46903]: zone weiyigeek.cn/IN: sending notifies (serial 3)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 并且会自动在定义的工作目录内生成数据文件。</span></span><br><span class=\"line\">/var/cache/<span class=\"built_in\">bind</span>$ ls slave/*</span><br><span class=\"line\">  slave/db.12.168.192  slave/db.168.192  slave/db.weiyigeek.cn  slave/db.weiyigeek.top</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"主从服务工作测试\"><a href=\"#主从服务工作测试\" class=\"headerlink\" title=\"主从服务工作测试\"></a>主从服务工作测试</h4><ul>\n<li>Step 7.验证测试搭建的DNS主从服务器;<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 测试 weiyigeek.cn 与 weiyigeek.top 的 NS 记录</span></span><br><span class=\"line\">C:\\Users\\WeiyiGeek&gt;nslookup -qt=ns weiyigeek.cn 192.168.12.254</span><br><span class=\"line\">服务器:  ns1.weiyigeek.top</span><br><span class=\"line\">Address:  192.168.12.254</span><br><span class=\"line\"></span><br><span class=\"line\">weiyigeek.cn        nameserver = ns1.weiyigeek.cn</span><br><span class=\"line\">weiyigeek.cn        nameserver = ns3.weiyigeek.cn</span><br><span class=\"line\">weiyigeek.cn        nameserver = ns2.weiyigeek.cn</span><br><span class=\"line\">ns1.weiyigeek.cn    internet address = 192.168.12.254</span><br><span class=\"line\">ns2.weiyigeek.cn    internet address = 192.168.10.254</span><br><span class=\"line\">ns3.weiyigeek.cn    internet address = 192.168.4.254</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Users\\WeiyiGeek&gt;nslookup -qt=ns weiyigeek.top 192.168.12.254</span><br><span class=\"line\">服务器:  ns1.weiyigeek.top</span><br><span class=\"line\">Address:  192.168.12.254</span><br><span class=\"line\"></span><br><span class=\"line\">weiyigeek.top     nameserver = ns3.weiyigeek.top</span><br><span class=\"line\">weiyigeek.top     nameserver = ns1.weiyigeek.top</span><br><span class=\"line\">weiyigeek.top     nameserver = ns2.weiyigeek.top</span><br><span class=\"line\">ns1.weiyigeek.top internet address = 192.168.12.254</span><br><span class=\"line\">ns2.weiyigeek.top internet address = 192.168.10.254</span><br><span class=\"line\">ns3.weiyigeek.top internet address = 192.168.4.254</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 正向和反向解析验证</span></span><br><span class=\"line\">~$ dig www.weiyigeek.cn @192.168.12.254 | grep <span class=\"string\">\"www.weiyigeek.cn\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ; DiG 9.16.1-Ubuntu www.weiyigeek.cn @192.168.12.254</span></span><br><span class=\"line\">  <span class=\"comment\">#   ;www.weiyigeek.cn.                  IN      A</span></span><br><span class=\"line\">  <span class=\"comment\">#   www.weiyigeek.cn.           86400   IN      A    192.168.10.47</span></span><br><span class=\"line\"></span><br><span class=\"line\">~$ dig www.weiyigeek.top @192.168.4.254 | grep <span class=\"string\">\"www.weiyigeek.top\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ; DiG 9.16.1-Ubuntu www.weiyigeek.top @192.168.4.254</span></span><br><span class=\"line\">  <span class=\"comment\">#   ;www.weiyigeek.top.               IN      A</span></span><br><span class=\"line\">  <span class=\"comment\">#   www.weiyigeek.top.        86400   IN      A    192.168.12.18</span></span><br><span class=\"line\"></span><br><span class=\"line\">~$ dig -x 192.168.10.47 @192.168.4.254 | grep <span class=\"string\">\"47.10.168.192\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ;47.10.168.192.in-addr.arpa.    IN      PTR</span></span><br><span class=\"line\">  <span class=\"comment\"># 47.10.168.192.in-addr.arpa. 86400 IN    PTR     www.weiyigeek.cn.</span></span><br><span class=\"line\"></span><br><span class=\"line\">dig -x 192.168.12.18 @192.168.4.254 | grep <span class=\"string\">\"18.12.168.192\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ;18.12.168.192.in-addr.arpa.    IN      PTR</span></span><br><span class=\"line\">  <span class=\"comment\"># 18.12.168.192.in-addr.arpa. 86400 IN    PTR     www.weiyigeek.top.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 解析外网地址测试(默认A记录)</span></span><br><span class=\"line\">$ dig baidu.com @192.168.12.254</span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;baidu.com.                     IN      A</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># baidu.com.              67      IN      A       39.156.69.79</span></span><br><span class=\"line\">  <span class=\"comment\"># baidu.com.              67      IN      A       220.181.38.148</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ dig qq.com @192.168.4.254</span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;qq.com.                                IN      A</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># qq.com.                 379     IN      A       61.129.7.47</span></span><br><span class=\"line\">  <span class=\"comment\"># qq.com.                 379     IN      A       183.3.226.35</span></span><br><span class=\"line\">  <span class=\"comment\"># qq.com.                 379     IN      A       123.151.137.18</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 指定记录查询</span></span><br><span class=\"line\">dig -t MX qq.com @192.168.12.254</span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;qq.com.                                IN      MX</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># qq.com.                 3554    IN      MX      10 mx3.qq.com.</span></span><br><span class=\"line\">  <span class=\"comment\"># qq.com.                 3554    IN      MX      30 mx1.qq.com.</span></span><br><span class=\"line\">  <span class=\"comment\"># qq.com.                 3554    IN      MX      20 mx2.qq.com.</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"主从同步记录测试\"><a href=\"#主从同步记录测试\" class=\"headerlink\" title=\"主从同步记录测试\"></a>主从同步记录测试</h4><ul>\n<li>Step 8.在DNS主从服务器中修改增加如下记录;</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) 添加一条正向解析</span></span><br><span class=\"line\">/var/cache/<span class=\"built_in\">bind</span>/master<span class=\"comment\"># cat db.weiyigeek.top</span></span><br><span class=\"line\">202103022         ; Serial   <span class=\"comment\"># 添加修改记录后，序号每次必须修改迭代更新+1</span></span><br><span class=\"line\">sync.weiyigeek.top. IN A 192.168.12.110</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2) 添加一条反向解析</span></span><br><span class=\"line\">/var/cache/<span class=\"built_in\">bind</span>/master<span class=\"comment\"># cat db.12.168.192</span></span><br><span class=\"line\">202103023         ; Serial <span class=\"comment\"># 添加修改记录后，序号每次必须修改迭代更新+1</span></span><br><span class=\"line\">110 IN PTR sync.weiyigeek.top.</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Step 9.进行域名解析修改同步<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 0) 采用名称服务器控件实用程序进行重载</span></span><br><span class=\"line\">/var/cache/<span class=\"built_in\">bind</span>/master<span class=\"comment\"># rndc reload</span></span><br><span class=\"line\">server reload successful</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1) 日志输出（可以看见同步成功）</span></span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: configuring <span class=\"built_in\">command</span> channel from <span class=\"string\">'/etc/bind/rndc.key'</span></span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: configuring <span class=\"built_in\">command</span> channel from <span class=\"string\">'/etc/bind/rndc.key'</span></span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: reloading configuration succeeded  <span class=\"comment\"># 重载配置</span></span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: reloading zones succeeded          <span class=\"comment\"># 重载成功</span></span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: zone 12.168.192.in-addr.arpa/IN: loaded serial 202103023</span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: zone 12.168.192.in-addr.arpa/IN: sending notifies (serial 202103023)</span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: all zones loaded</span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: running</span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: zone weiyigeek.top/IN: loaded serial 202103022</span><br><span class=\"line\">Mar 23 10:03:56 dns-server named[71110]: zone weiyigeek.top/IN: sending notifies (serial 202103022)</span><br><span class=\"line\">Mar 23 10:03:57 dns-server named[71110]: client @0x7f5f08017de0 192.168.4.254<span class=\"comment\">#39951 (weiyigeek.top): transfer of 'weiyigeek.top/IN': AXFR-style IXFR started (serial 202103022)  # 从区域区域同步</span></span><br><span class=\"line\">Mar 23 10:03:57 dns-server named[71110]: client @0x7f5f08017de0 192.168.4.254<span class=\"comment\">#39951 (weiyigeek.top): transfer of 'weiyigeek.top/IN': AXFR-style IXFR ended: 1 messages, 27 records, 614 bytes, 0.001 secs (614000 bytes/sec)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3) 验证从主机解析(可以看见已经成功同步)</span></span><br><span class=\"line\"><span class=\"comment\"># 正向解析</span></span><br><span class=\"line\">~$ dig sync.weiyigeek.top @192.168.4.254</span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;sync.weiyigeek.top.              IN      A</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># sync.weiyigeek.top.       86400   IN      A       192.168.12.110</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 反向解析</span></span><br><span class=\"line\">$ host  192.168.12.110 192.168.4.254</span><br><span class=\"line\">  <span class=\"comment\"># Using domain server:</span></span><br><span class=\"line\">  <span class=\"comment\"># Name: 192.168.4.254</span></span><br><span class=\"line\">  <span class=\"comment\"># Address: 192.168.4.254#53</span></span><br><span class=\"line\">  <span class=\"comment\"># Aliases:</span></span><br><span class=\"line\">  <span class=\"comment\"># 110.12.168.192.in-addr.arpa domain name pointer sync.weiyigeek.top.</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"主从同步日志查看\"><a href=\"#主从同步日志查看\" class=\"headerlink\" title=\"主从同步日志查看\"></a>主从同步日志查看</h4><ul>\n<li>Step 10.主机 Bind 之 Named 服务信息日志查询以及记录文件查询<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) Named 服务信息日志查询</span></span><br><span class=\"line\">$ journalctl /usr/sbin/named -f -n 30</span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 20:31:13 dns-server named[71110]: resolver priming query complete</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 22:02:49 dns-server named[71110]: timed out resolving 'bouncer-bouncer-elb.prod.mozaws.net/A/IN': 114.114.114.114#53</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 22:02:53 dns-server named[71110]: timed out resolving 'dn6m9t4qll5h.cloudfront.net/A/IN': 114.114.114.114#53</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 22 22:02:55 dns-server named[71110]: timed out resolving 'dn6m9t4qll5h.cloudfront.net/AAAA/IN': 114.114.114.114#53</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 23 00:14:02 dns-server named[71110]: timed out resolving 'sh.wagbridge.aliyun.aliyun.com/A/IN': 114.114.114.114#53</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 23 08:38:38 dns-server named[71110]: timed out resolving 'com.baidu.in-addr.arpa/PTR/IN': 114.114.114.114#53</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 客户端查询服务日志</span></span><br><span class=\"line\">~$ tail -f /var/cache/<span class=\"built_in\">bind</span>/dns-query.log</span><br><span class=\"line\">23-Mar-2021 14:05:18.038 queries: client @0x7f5f1401a560 10.20.172.103<span class=\"comment\">#50867 (api2.firefoxchina.cn.wswebpic.com): query: api2.firefoxchina.cn.wswebpic.com IN A + (192.168.12.254)</span></span><br><span class=\"line\">23-Mar-2021 14:05:18.038 queries: client @0x7f5f0c000cd0 10.20.172.103<span class=\"comment\">#59303 (api2.firefoxchina.cn.wswebpic.com): query: api2.firefoxchina.cn.wswebpic.com IN AAAA + (192.168.12.254)</span></span><br><span class=\"line\">23-Mar-2021 14:05:25.162 queries: client @0x7f5f1401a560 10.20.172.103<span class=\"comment\">#58775 (hm.baidu.com): query: hm.baidu.com IN A + (192.168.12.254)</span></span><br><span class=\"line\">23-Mar-2021 14:05:25.206 queries: client @0x7f5f140288a0 10.20.172.103<span class=\"comment\">#58775 (hm.baidu.com): query: hm.baidu.com IN A + (192.168.12.254)</span></span><br><span class=\"line\">23-Mar-2021 14:05:34.522 queries: client @0x7f5f1401a560 192.168.12.107<span class=\"comment\">#48054 (changelogs.ubuntu.com.weiyigeek.top): query: changelogs.ubuntu.com IN A + (192.168.12.254)</span></span><br><span class=\"line\">23-Mar-2021 14:05:34.522 queries: client @0x7f5f140288a0 192.168.12.107<span class=\"comment\">#48054 (changelogs.ubuntu.com.weiyigeek.top): query: changelogs.ubuntu.com IN AAAA + (192.168.12.254)</span></span><br><span class=\"line\">23-Mar-2021 14:05:34.522 queries: client @0x7f5f18036ab0 192.168.12.107<span class=\"comment\">#41833 (changelogs.ubuntu.com.weiyigeek.cn): query: changelogs.ubuntu.com IN A + (192.168.12.254)</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"2-企业内部DNS主从服务安全配置\"><a href=\"#2-企业内部DNS主从服务安全配置\" class=\"headerlink\" title=\"2) 企业内部DNS主从服务安全配置\"></a>2) 企业内部DNS主从服务安全配置</h3><p>描述: 在前一章我们讲解DNS主从的基本配置以及访问限制，但是对于在企业中实际运行我们需要考虑到方方面面的问题，例如伪造MAC地址以及IP地址，此时它就可以通过区域传输获取内部域名的对应服务器地址，为了防止此种安全问题的发生我们可以采用 <code>TSIG (Transaction SIGnatures)</code> 进行事务签名加密zone同步信息或者采用 DNSSEC 扩展对DNS 信息的加密认证。</p>\n<p><br/></p>\n<p><strong>Q: 什么是TSIG (Transaction SIGnatures)?</strong></p>\n<blockquote>\n<p>答: TSIG（交易网格）是一种身份验证DNS消息的机制，最初在RFC 2845中指定<br>作用: 它允许使用共享的秘密加密地签名 DNS 消息。TSIG 可用于任何 DNS 事务，</p>\n</blockquote>\n<p><br/></p>\n<p><strong>Tips : TSIG 的应用场景说明</strong></p>\n<blockquote>\n<p>例如，当基于 IP 的访问控制不足或需要被覆盖时，将某些服务器功能（例如递归查询）的访问限制给授权客户端，或在对服务器完整性至关重要时确保消息的真实性<br>例如，动态 UPDATE 消息或从主服务器传输到次要服务器的区域传输。</p>\n</blockquote>\n<p><br/></p>\n<p><strong>Tips : 补充介绍AXFR与IXFR介绍</strong></p>\n<ul>\n<li>AXFR (全量区域的数据传输)  : <a href=\"https://tools.ietf.org/html/rfc5936.html\" target=\"_blank\" rel=\"noopener\">RFC 5936</a> - E. Lewis and A. Hoenes, Ed. DNS Zone Transfer Protocol (AXFR). June 2010. 该标准指的是域名系统协议内的维护区域的权威名称服务器之间的一致性;</li>\n<li>IXFR (增量区域的数据传输) : <a href=\"https://tools.ietf.org/html/rfc1995.html\" target=\"_blank\" rel=\"noopener\">RFC 1995</a> - E. M. Ohta and RTokyo Institute of Technology August 1996 - 增量区域传输(IXFR)协议是辅助服务器只传输更改的数据的一种方式，而不必传输整个区域</li>\n</ul>\n<p><br/></p>\n<h4 id=\"1-创建-TSIG-密钥的过程\"><a href=\"#1-创建-TSIG-密钥的过程\" class=\"headerlink\" title=\"1.创建 TSIG 密钥的过程\"></a>1.创建 TSIG 密钥的过程</h4><ul>\n<li><p>Step 1.TSIG 密钥生成关键是tsig-key : <code>hmac-md5, hmac-sha1, hmac-sha224, hmac-sha256, hmac-sha384, and hmac-sha512. The default is hmac-sha256</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Tips:任何有效的DNS名称字符串都可以用作密钥名。</span></span><br><span class=\"line\">$ tsig-keygen -a hmac-sha256 dns-server-keygen. &gt; dns-sync-keygen.key</span><br><span class=\"line\">$ chown -R <span class=\"built_in\">bind</span>:<span class=\"built_in\">bind</span> dns-sync-keygen.key</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 2.将下述服务器之间共享的密钥，内容添加到每个服务器的 named.conf 文件中;</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Tips: 查看生成的签名安全文本信息</span></span><br><span class=\"line\">$ more dns-sync-keygen.key</span><br><span class=\"line\">key <span class=\"string\">\"dns-server-keygen.\"</span> &#123;</span><br><span class=\"line\">    algorithm hmac-sha256;</span><br><span class=\"line\">    secret <span class=\"string\">\"04Zy1z+VSu1FlHMMFte8SVJ+RlUbR4qK/GgletRso=\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 例如: 方式1在named.conf中设置在开头之中</span></span><br><span class=\"line\"><span class=\"comment\"># 例如: 方式2在named.conf中使用include指令包含；</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.指示服务器使用密钥和TSIG-Based访问控制(<code>如allow-query, allow-transfer, and allow-update</code>)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.密钥也可以在服务器指令中指定。</span></span><br><span class=\"line\"><span class=\"comment\"># 如果host2的IP地址为10.1.2.3，在host1上添加以下内容，将导致从host1到host2的所有请求，包括正常的DNS查询，都将使用host1-host2签名</span></span><br><span class=\"line\">server 10.1.2.3 &#123;</span><br><span class=\"line\">  keys &#123; host1-host2. ;&#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.TSIG键可以在ACL定义和ACL指令(如allow-query, allow-transfer, and allow-update)中指定。</span></span><br><span class=\"line\"><span class=\"comment\"># 下面是一个使用TSIG键的allow-update指令的例子: 只有当更新请求来自 localnet 中的某个地址，并且使用host1-host2 进行签名时，动态更新才能成功。</span></span><br><span class=\"line\">allow-update &#123; !&#123; !localnets; any; &#125;; key host1-host2. ;&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"2-Master-DNS-机器配置\"><a href=\"#2-Master-DNS-机器配置\" class=\"headerlink\" title=\"2.Master DNS 机器配置\"></a>2.Master DNS 机器配置</h4><ul>\n<li>Step 4.按照前面第一章的配置基础上进行，如下示例<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (0) 将 dns-sync-keygen.key 文件分别上传到两台Slave服务器之中;</span></span><br><span class=\"line\">scp dns-sync-keygen.key root@192.168.4.254:/etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\">scp dns-sync-keygen.key root@192.168.10.254:/etc/<span class=\"built_in\">bind</span>/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (1) 修改 在 (Master /slave) DNS 主机配置 named.conf 引入上面创建的 tsig Keys</span></span><br><span class=\"line\">$ vim named.conf</span><br><span class=\"line\">include <span class=\"string\">\"/etc/bind/dns-sync-keygen.key\"</span>;</span><br><span class=\"line\">include <span class=\"string\">\"/etc/bind/named.conf.options\"</span>;</span><br><span class=\"line\">include <span class=\"string\">\"/etc/bind/named.conf.local\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 在 /etc/bind/named.conf.options 配置中添加从服务器的密钥认证</span></span><br><span class=\"line\">server 192.168.10.254 &#123;</span><br><span class=\"line\">  keys &#123; <span class=\"string\">\"dns-server-keygen.\"</span>; &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">server 192.168.4.254 &#123;</span><br><span class=\"line\">  keys &#123; <span class=\"string\">\"dns-server-keygen.\"</span>; &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) Master DNS 主机 named.conf.local 域传输</span></span><br><span class=\"line\">$ /etc/<span class=\"built_in\">bind</span>/named.conf.local</span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.cn\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.weiyigeek.cn\"</span>;</span><br><span class=\"line\">    notify yes;</span><br><span class=\"line\">    allow-transfer &#123; trusted; key dns-server-keygen. ; &#125;;    <span class=\"comment\"># ns2 / ns3 private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"weiyigeek.top\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.weiyigeek.top\"</span>;</span><br><span class=\"line\">    notify yes;</span><br><span class=\"line\">    allow-transfer &#123; trusted;  key dns-server-keygen. ; &#125;;    <span class=\"comment\"># ns2 / ns3  private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.168.192\"</span>;</span><br><span class=\"line\">    notify yes;</span><br><span class=\"line\">    allow-transfer &#123; trusted;  key dns-server-keygen. ; &#125;;    <span class=\"comment\"># ns2 / ns3  private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">zone <span class=\"string\">\"12.168.192.in-addr.arpa\"</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">type</span> master;</span><br><span class=\"line\">    file <span class=\"string\">\"master/db.12.168.192\"</span>;</span><br><span class=\"line\">    notify yes;</span><br><span class=\"line\">    allow-transfer &#123; trusted;  key dns-server-keygen. ; &#125;;    <span class=\"comment\"># ns2 / ns3  private IP address - secondary</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h4 id=\"3-Slave-DNS-机器配置\"><a href=\"#3-Slave-DNS-机器配置\" class=\"headerlink\" title=\"3.Slave DNS 机器配置\"></a>3.Slave DNS 机器配置</h4><ul>\n<li>Step 5.Slave 从DNS服务基础配置，如果此时slave服务器没有配置key则主从不能正常工作。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (3) 修改两台slave服务器named.conf.conf.options和dns-sync-keygen.key权限以及所属者修改</span></span><br><span class=\"line\">$ vim named.conf.conf.options <span class=\"comment\"># 不建议此种方式</span></span><br><span class=\"line\">....</span><br><span class=\"line\">key <span class=\"string\">\"dns-server-keygen.\"</span> &#123;</span><br><span class=\"line\">  algorithm hmac-sha256;</span><br><span class=\"line\">  secret <span class=\"string\">\"04Zy1z+VSu2X1FlHMMFte8SVJ+RlUbR4qK/GgletRso=\"</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">server 192.168.4.254 &#123;</span><br><span class=\"line\">  keys &#123; <span class=\"string\">\"dns-server-keygen.\"</span>; &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">....</span><br><span class=\"line\">chown -R <span class=\"built_in\">bind</span>:<span class=\"built_in\">bind</span> /etc/<span class=\"built_in\">bind</span>/dns-sync-keygen.key</span><br></pre></td></tr></table></figure>\n<p>Tips : 如果此时 Slave 服务器 没有设置 TSIG 密钥到 named.conf 配置文件中, 则出现以下错误 <code>client @0x7f6008000cd0 192.168.12.254#59492: request has   invalid signature: TSIG dns-server-keygen: tsig verify failure (BADKEY)</code></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2021/1/20210324140133.png\" alt=\"WeiyiGeek.Slave-Noconfig-TSIG\" title=\"\" class=\"\">\n                <p>WeiyiGeek.Slave-Noconfig-TSIG</p>\n            </figure>\n<p><br></p>\n<h4 id=\"4-TSIG密钥工作验证\"><a href=\"#4-TSIG密钥工作验证\" class=\"headerlink\" title=\"4.TSIG密钥工作验证\"></a>4.TSIG密钥工作验证</h4><p><strong>Tips : DNS客户端工具校验TSIG事物签名:</strong></p>\n<ul>\n<li>nsupdate - dynamic DNS update utility supports TSIG via the -k, -l, and -y command-line options, or via the key command when running interactively.</li>\n<li>dig - DNS lookup utility supports TSIG via the -k and -y command-line options.</li>\n</ul>\n<ul>\n<li>Step 5.测试TSIG密钥工作情况<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.使用命令 rndc tsig-list 列出服务器已知的TSIG密钥(主从)。</span></span><br><span class=\"line\">root@dns-server:~$ rndc tsig-list</span><br><span class=\"line\">view <span class=\"string\">\"_default\"</span>; <span class=\"built_in\">type</span> <span class=\"string\">\"static\"</span>; key <span class=\"string\">\"dns-server-keygen\"</span>;</span><br><span class=\"line\">view <span class=\"string\">\"_default\"</span>; <span class=\"built_in\">type</span> <span class=\"string\">\"static\"</span>; key <span class=\"string\">\"local-ddns\"</span>;</span><br><span class=\"line\">view <span class=\"string\">\"_bind\"</span>; <span class=\"built_in\">type</span> <span class=\"string\">\"static\"</span>; key <span class=\"string\">\"dns-server-keygen\"</span>;</span><br><span class=\"line\">view <span class=\"string\">\"_bind\"</span>; <span class=\"built_in\">type</span> <span class=\"string\">\"static\"</span>; key <span class=\"string\">\"local-ddns\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.在Master中修改一条记录并修改Serial序列号;</span></span><br><span class=\"line\">vi /var/cache/<span class=\"built_in\">bind</span>/master/db.weiyigeek.top</span><br><span class=\"line\">202103027         ; Serial</span><br><span class=\"line\">...</span><br><span class=\"line\">sync.weiyigeek.top. IN A 192.168.12.212</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.在Master主机中重新加载zone并同步到从Slave主机之中</span></span><br><span class=\"line\">root@dns-server:/etc/<span class=\"built_in\">bind</span><span class=\"comment\"># rndc reload</span></span><br><span class=\"line\">server reload successful</span><br><span class=\"line\"></span><br><span class=\"line\">root@dns-server：/etc/<span class=\"built_in\">bind</span><span class=\"comment\"># journalctl /usr/sbin/named -f</span></span><br><span class=\"line\">  <span class=\"comment\"># -- Logs begin at Wed 2019-09-04 17:30:00 CST. --</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: configuring command channel from '/etc/bind/rndc.key'</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: configuring command channel from '/etc/bind/rndc.key'</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: reloading configuration succeeded</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: reloading zones succeeded</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: zone weiyigeek.top/IN: loaded serial 202103027</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: zone weiyigeek.top/IN: sending notifies (serial 202103027)</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: all zones loaded</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:41 dns-server named[146141]: running</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:42 dns-server named[146141]: client @0x7fac2804b930 192.168.4.254#35827 (weiyigeek.top): transfer of 'weiyigeek.top/IN': AXFR-style IXFR started (serial 202103027) # 同步开始</span></span><br><span class=\"line\">  <span class=\"comment\"># Mar 24 14:11:42 dns-server named[146141]: client @0x7fac2804b930 192.168.4.254#35827 (weiyigeek.top): transfer of 'weiyigeek.top/IN': AXFR-style IXFR ended: 1 messages, 27 records, 614 bytes, 0.001 secs (614000 bytes/sec)  # 同步记录详细情况</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.从主机的日志查看</span></span><br><span class=\"line\">weiyigeek@dns-slave-ns3:~$ journalctl /usr/sbin/named  -f -n 30</span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: client @0x7fcce8000cd0 192.168.12.254<span class=\"comment\">#33530/key dns-server-keygen: received notify for zone 'weiyigeek.top': TSIG 'dns-server-keygen'  # 可以看见已经使用了前签名</span></span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: zone weiyigeek.top/IN: notify from 192.168.12.254<span class=\"comment\">#33530: serial 202103027</span></span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: zone weiyigeek.top/IN: Transfer started.   <span class=\"comment\"># 传输开始</span></span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: transfer of <span class=\"string\">'weiyigeek.top/IN'</span> from 192.168.12.254<span class=\"comment\">#53: connected using 192.168.4.254#35827</span></span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: zone weiyigeek.top/IN: transferred serial 202103027  </span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: transfer of <span class=\"string\">'weiyigeek.top/IN'</span> from 192.168.12.254<span class=\"comment\">#53: Transfer status: success # 传输成功</span></span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: transfer of <span class=\"string\">'weiyigeek.top/IN'</span> from 192.168.12.254<span class=\"comment\">#53: Transfer completed: 1 messages, 27 records, 614 bytes, 0.001 secs (614000 bytes/sec)  # 记录同步详细</span></span><br><span class=\"line\">  Mar 24 14:11:42 dns-slave-ns3 named[114382]: zone weiyigeek.top/IN: sending notifies (serial 202103027)  <span class=\"comment\"># 发送同步状态</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<ul>\n<li>Step 6.测试Slave主机的解析情况(可以看见已经同步成功)<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\WeiyiGeek&gt;nslookup -qt=a sync.weiyigeek.top 192.168.4.254</span><br><span class=\"line\">服务器:  ns3.weiyigeek.cn</span><br><span class=\"line\">Address:  192.168.4.254</span><br><span class=\"line\"></span><br><span class=\"line\">名称:    sync.weiyigeek.top</span><br><span class=\"line\">Address:  192.168.12.212</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : 当任何服务器发送由 TSIG 签名的 DNS 请求时，它希望使用相同的密钥签署响应。如果未签署回复，或者签名无效，则拒绝回复。</p>\n<p><br/></p>\n<p><strong>Tips : 处理 TSIG 签名的消息可能会导致几个错误</strong></p>\n<ul>\n<li>描述: 在上述所有情况下，服务器返回 NOTAUTH 响应代码（未经过身份验证）。</li>\n<li>如果了解 TSIG 的服务器收到由未知密钥签名的消息，则响应将未签名，TSIG 将扩展错误代码设置为 BADKEY。</li>\n<li>如果了解 TSIG 的服务器收到来自已知密钥但签名无效的消息，则响应将未签名，TSIG 将扩展错误代码设置为 BADSIG。</li>\n<li>如果了解 TSIG 的服务器收到超出允许范围的时间的邮件，则将签署响应，但 TSIG 将错误代码设置为 BADTIME，并将调整时间值，以便成功验证响应。</li>\n</ul>\n<hr>\n<h2 id=\"0x01-章外扩展\"><a href=\"#0x01-章外扩展\" class=\"headerlink\" title=\"0x01 章外扩展\"></a>0x01 章外扩展</h2><h3 id=\"0-OS系统上的DNS解析器\"><a href=\"#0-OS系统上的DNS解析器\" class=\"headerlink\" title=\"0) OS系统上的DNS解析器\"></a>0) OS系统上的DNS解析器</h3><p>描述: 应用程序实际上都是调用的操作系统的 <code>DNS Resolver</code> 进行域名解析的。在 Linux 中 DNS Resolver 由 <code>glibc/musl</code> 提供其配置文件为 <code>/etc/resolv.conf</code>。</p>\n<p>Tips : 比如 Python 的 DNS 解析，就来自于标准库的 socket 包，这个包只是对底层 c 语言库的一个简单封装。</p>\n<p>操作系统解析域名的三种方式:</p>\n<ul>\n<li>1.hosts 文件</li>\n<li>2.HTTPDNS </li>\n<li>3.默认 DNS 服务器</li>\n</ul>\n<p><strong>hosts 文件</strong><br>描述: 操作系统中还有一个特殊文件Linux 中的 <code>/etc/hosts</code> 和 Windows 中的 <code>C:\\Windows\\System32\\drivers\\etc\\hosts</code> 存放着用户自定义的域名(或主机名)与IP地址对于关系。其优先级最高系统中的 DNS resolver 会首先查看这个 hosts 文件中有没有该域名的记录，如果有就直接返回了。没找到才会去查找本地 DNS 缓存、别的 DNS 服务器。</p>\n<p>Tips : 只有部分专门用于网络诊断的应用程序（e.g. dig）不会依赖 OS 的 DNS 解析器，因此这个 hosts 会失效。hosts 对于绝大部分程序都有效。</p>\n<p>Tips : 移动设备上 hosts 可能会失效，部分 app 会绕过系统，使用新兴的 HTTPDNS 协议进行 DNS 解析。</p>\n<p><br></p>\n<p><strong>HTTPDNS</strong><br>描述: 由于传统的 DNS 协议因为使用了明文的 UDP 协议，很容易被劫持。顺应移动互联网的兴起，目前一种新型的 DNS 协议——HTTPDNS 应用越来越广泛，国内的阿里云腾讯云都提供了这项功能。</p>\n<p>Tips : HTTPDNS 通过 HTTP 协议直接向权威 DNS 服务器发起请求，绕过了一堆中间的 DNS 递归解析器。<br>Tips : HTTPDNS 协议需要程序自己引入 SDK，或者直接请求 HTTP API。</p>\n<p>使用HTTPDNS的好处：</p>\n<ul>\n<li>权威 DNS 服务器能直接获取到客户端的真实 IP（而不是某个中间 DNS 递归解析器的 IP），能实现就近调度(有点类似于CDN的感觉)。</li>\n<li>因为是直接与权威 DNS 服务器连接，避免了 DNS 缓存污染的问题。</li>\n</ul>\n<p><br></p>\n<p><strong>默认 DNS 服务器</strong><br>描述: 操作系统的 DNS 解析器通常会允许我们配置<code>1-3个上游 NameServers</code>，DNS 查询会按配置中的顺序选用 DNS 服务器。<br>比如 Linux 就是通过 /etc/resolv.conf 配置 DNS 服务器的。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/resolv.conf </span><br><span class=\"line\">nameserver 8.8.8.8</span><br><span class=\"line\">nameserver 8.8.4.4</span><br><span class=\"line\">search lan  <span class=\"comment\"># DNS 搜索域</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>Q: 什么是DNS搜索域?</strong></p>\n<blockquote>\n<p>答: 讲到 DNS 搜索域需要复习一哈全限定域名（Full Qulified Domain Name, FQDN），即一个域名的完整名称，<code>www.baidu.com</code></p>\n</blockquote>\n<ul>\n<li>1) <code>www.baidu.com.</code>: 末尾的 . 表示根域，说明 <a href=\"http://www.baidu.com\" target=\"_blank\" rel=\"noopener\">www.baidu.com</a> 是一个 FQDN，因此不会使用搜索域！</li>\n<li>2) <code>www.baidu.com</code>: 末尾没 .，但是域名包含不止一个 .。首先当作 FQDN 进行查询没查找再按顺序在各搜索域中查询。<ul>\n<li>/etc/resolv.conf 的 options 参数中，可以指定域名中包含<code>.</code>的临界个数，默认是 1.</li>\n</ul>\n</li>\n<li>3) local: 不包含 .，被当作 host 名称非 FQDN。首先在 /etc/hosts 中查找，没找到的话再按顺序在各搜索域中查找。</li>\n</ul>\n<p>就如上面说例举的，在没有 DNS 搜索域 这个东西的条件下，我们访问任何域名，都必须输入一个全限定域名 FQDN。<br>有了搜索域我们就可以稍微偷点懒，省略掉域名的一部分后缀，让 DNS Resolver 自己去在各搜索域中搜索。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 0) 获取k8s的kube-dns</span></span><br><span class=\"line\">~$ kubectl get svc -n kube-system</span><br><span class=\"line\">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class=\"line\">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   68d</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1) 例如 我们设置 /etc/resolv.conf 如下</span></span><br><span class=\"line\"><span class=\"comment\"># nameserver 192.168.12.254</span></span><br><span class=\"line\"><span class=\"comment\"># search weiyigeek.top weiyigeek.cn</span></span><br><span class=\"line\">nameserver 10.96.0.10</span><br><span class=\"line\">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class=\"line\"><span class=\"comment\"># ndots:5 是指少于 5 个 dots 的域名，都首先当作非 FQDN 看待优先在搜索域里面查找;</span></span><br><span class=\"line\">options ndots:5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2) 输入一个不存在的域名查看尝试过程</span></span><br><span class=\"line\">~$ host -v weiyigeek</span><br><span class=\"line\">  <span class=\"comment\"># Trying \"weiyigeek.default.svc.cluster.local\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Trying \"weiyigeek.svc.cluster.local\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Trying \"weiyigeek.cluster.local\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Trying \"weiyigeek\"</span></span><br><span class=\"line\">  <span class=\"comment\"># Host weiyigeek not found: 3(NXDOMAIN)</span></span><br><span class=\"line\">  <span class=\"comment\"># Received 102 bytes from 10.96.0.10#53 in 47 ms</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3) 输入一个集群中存在域名它将会在搜索域中进行解析请求(A / AAAA / MX)记录</span></span><br><span class=\"line\">~$ kubectl get svc</span><br><span class=\"line\">  <span class=\"comment\"># NAME                             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek                 NodePort    10.107.122.223   &lt;none&gt;        8080:30089/TCP      15d</span></span><br><span class=\"line\"></span><br><span class=\"line\">~$ host -d -v weiyigeek</span><br><span class=\"line\">Trying <span class=\"string\">\"weiyigeek.default.svc.cluster.local\"</span>  <span class=\"comment\"># 描述:一来就找到该FQDN解析的IP地址</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; -&gt;&gt;HEADE opcode: QUERY, status: NOERROR, id: 7138</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:  # 询问</span></span><br><span class=\"line\">  <span class=\"comment\"># ;weiyigeek.default.svc.cluster.local. IN A    # A 记录</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:    # 回答</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.default.svc.cluster.local. 30 IN A 10.107.122.223</span></span><br><span class=\"line\">  <span class=\"comment\"># Received 118 bytes from 10.96.0.10#53 in 3 ms</span></span><br><span class=\"line\"></span><br><span class=\"line\">Trying <span class=\"string\">\"weiyigeek.default.svc.cluster.local\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; -&gt;&gt;HEADER opcode: QUERY, status: NOERROR, id: 32192</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;weiyigeek.default.svc.cluster.local. IN AAAA  # AAAA 记录</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; AUTHORITY SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster.local.          30      IN      SOA     ns.dns.cluster.local. hostmaster.cluster.local. 1616058438 7200 1800 86400 30</span></span><br><span class=\"line\">  <span class=\"comment\"># Received 153 bytes from 10.96.0.10#53 in 0 ms</span></span><br><span class=\"line\"></span><br><span class=\"line\">Trying <span class=\"string\">\"weiyigeek.default.svc.cluster.local\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; -&gt;&gt;HEADER opcode: QUERY, status: NOERROR, id: 11848</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;weiyigeek.default.svc.cluster.local. IN MX  # MX 记录</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; AUTHORITY SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># cluster.local.          30      IN      SOA     ns.dns.cluster.local. hostmaster.cluster.local. 1616058426 7200 1800 86400 30</span></span><br><span class=\"line\">  <span class=\"comment\"># Received 153 bytes from 10.96.0.10#53 in 0 ms</span></span><br></pre></td></tr></table></figure></p>\n<p>Tips : 在靠前的 DNS 服务器没有响应（timeout）时，才会使用后续的 DNS 服务器！所以指定的服务器中的 DNS 记录最好完全一致！！！不要把第一个配内网 DNS，第二个配外网！！！</p>\n<p><br></p>\n<h3 id=\"1-DNS缓存清理\"><a href=\"#1-DNS缓存清理\" class=\"headerlink\" title=\"1) DNS缓存清理\"></a>1) DNS缓存清理</h3><p><strong>Q: 什么是dns缓存?</strong></p>\n<blockquote>\n<p>答: 每当我们尝试访问带有网站时都会执行DNS名称解析查询来解析其IP地址。 操作系统缓存此数据，以避免每次都与名称服务器联系。</p>\n</blockquote>\n<p><strong>Q: 为什么要清除DNS缓存？ (Why to Clear DNS Cache?)</strong></p>\n<blockquote>\n<p>答: 常常会出现以下场景例如网站的IP地址在移至另一台服务器时会更改或者管理员更改了DNS解析记录（<code>受生存时间(TTL)管控</code>）。在这种情况下如果我们点击了缓存的IP地址，则该网站将无法正常运行。<br>DNS条目具有与之关联的”生存时间(TTL)”值，该值告诉操作系统名称解析服务何时使DNS缓存无效。<br>如果您想在TTL过期之前联系到新的IP地址，则唯一的解决方案是<code>刷新DNS缓存</code>。</p>\n</blockquote>\n<p><strong>Q: 如何在Ubuntu/Windows上清除DNS缓存？</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Ubuntu</span></span><br><span class=\"line\"><span class=\"comment\"># Tips: --flush-caches 选项仅仅只是清除DNS缓存</span></span><br><span class=\"line\">sudo systemd-resolve --flush-caches</span><br><span class=\"line\"><span class=\"comment\"># Tips: 重新启动systemd解析的服务可以清除所有DNS缓存统计信息</span></span><br><span class=\"line\"><span class=\"comment\"># sudo systemctl restart systemd-resolved</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Windows</span></span><br><span class=\"line\">ipconfig /flushdns</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h3 id=\"2-DNS服务测试工具\"><a href=\"#2-DNS服务测试工具\" class=\"headerlink\" title=\"2) DNS服务测试工具\"></a>2) DNS服务测试工具</h3><p>描述: 在windows或者Linux常用的DNS服务器解析测试采用以下软件进行；</p>\n<h4 id=\"nslookup-命令\"><a href=\"#nslookup-命令\" class=\"headerlink\" title=\"nslookup 命令\"></a>nslookup 命令</h4><p>描述: 支持多平台、应用广泛, 其优点使用简单、异动;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 使用示例 -t type</span></span><br><span class=\"line\"><span class=\"comment\"># This option specifies the query type. The type argument can be any recognized query type: CNAME, NS, SOA, TXT, DNSKEY, AXFR, etc.</span></span><br><span class=\"line\">nslookup -qt=SOA/A/CNAME/MX/NS/TXT www.weiyigeek.top  <span class=\"comment\"># -qt type指定DNS解析类型</span></span><br><span class=\"line\">C:\\Users\\WeiyiGeek&gt;nslookup -qt=a weiyigeek.top 192.168.12.254</span><br><span class=\"line\">服务器:  ns1.weiyigeek.top</span><br><span class=\"line\">Address:  192.168.12.254</span><br><span class=\"line\"></span><br><span class=\"line\">非权威应答:</span><br><span class=\"line\">名称:    weiyigeek.top</span><br><span class=\"line\">Addresses:  172.67.189.218</span><br><span class=\"line\">          104.21.10.9</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 交互式</span></span><br><span class=\"line\">nslookup  </span><br><span class=\"line\">&gt; server 172.16.102.14 </span><br><span class=\"line\">&gt; <span class=\"built_in\">set</span> q=a                       //设置DNS解析类型</span><br><span class=\"line\">&gt; www.weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">set</span> q=ns</span><br><span class=\"line\">&gt; www.weiyigeek.top</span><br><span class=\"line\">服务器:  UnKnown</span><br><span class=\"line\">Address:  192.168.2.1</span><br><span class=\"line\">weiyigeek.top</span><br><span class=\"line\">  primary name server = ns3.dnsv3.com</span><br><span class=\"line\">  responsible mail addr = enterprise1dnsadmin.dnspod.com</span><br><span class=\"line\">  serial  = 1500274720</span><br><span class=\"line\">  refresh = 3600 (1 hour)</span><br><span class=\"line\">  retry   = 180 (3 mins)</span><br><span class=\"line\">  expire  = 1209600 (14 days)</span><br><span class=\"line\">  default TTL = 180 (3 mins)</span><br></pre></td></tr></table></figure></p>\n<p><strong>Linux 平台</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.A记录查询</span></span><br><span class=\"line\">$  nslookup -query=A service-headless.default.svc.cluster.local.</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"dig-命令\"><a href=\"#dig-命令\" class=\"headerlink\" title=\"dig 命令\"></a>dig 命令</h4><p>描述: 主要运行在Linux平台上, 其优点比较专业;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 默认查询A记录</span></span><br><span class=\"line\">dig www.baidu.com @172.16.102.14</span><br><span class=\"line\">  <span class=\"comment\"># ; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; www.baidu.com @192.168.4.254</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; Got answer:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 20227</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; OPT PSEUDOSECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class=\"line\">  <span class=\"comment\"># ; COOKIE: fdbde72c243a04c60100000060587950b128dc5a23826a27 (good)</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;www.baidu.com.                 IN      A</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># www.baidu.com.          99      IN      CNAME   www.a.shifen.com.</span></span><br><span class=\"line\">  <span class=\"comment\"># www.a.shifen.com.       98      IN      A       14.215.177.39</span></span><br><span class=\"line\">  <span class=\"comment\"># www.a.shifen.com.       98      IN      A       14.215.177.38</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; Query time: 19 msec</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; SERVER: 192.168.4.254#53(192.168.4.254)</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; WHEN: Mon Mar 22 19:02:40 CST 2021</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; MSG SIZE  rcvd: 132</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) -t NS解析类型 </span></span><br><span class=\"line\">dig -t ns www.baidu.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) -x ip反查域名     </span></span><br><span class=\"line\">dig -x 192.168.12.13 @192.168.12.254    </span><br><span class=\"line\">  <span class=\"comment\"># ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 56847</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; OPT PSEUDOSECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class=\"line\">  <span class=\"comment\"># ; COOKIE: a78353f6f0787a7d010000006058799c1af1ea827274eb9f (good)</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;13.12.168.192.in-addr.arpa.    IN      PTR</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># 13.12.168.192.in-addr.arpa. 86400 IN    PTR     s.weiyigeek.top.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 复现正向查询的流程</span></span><br><span class=\"line\">dig +trace baidu.com  </span><br><span class=\"line\"><span class=\"comment\"># 先在根域中查找 </span></span><br><span class=\"line\">.                       503232  IN      NS      g.root-servers.net.</span><br><span class=\"line\">....</span><br><span class=\"line\">.                       503232  IN      NS      i.root-servers.net.</span><br><span class=\"line\">.                       518317  IN      RRSIG   NS 8 0 518400 20210403170000 20210321160000 42351 . ... XoGqZA==</span><br><span class=\"line\">;; Received 1137 bytes from 192.168.12.254<span class=\"comment\">#53(192.168.12.254) in 0 ms</span></span><br><span class=\"line\"><span class=\"comment\"># 其次在顶级域</span></span><br><span class=\"line\">com.                    172800  IN      NS      a.gtld-servers.net.</span><br><span class=\"line\">....</span><br><span class=\"line\">com.                    172800  IN      NS      l.gtld-servers.net.</span><br><span class=\"line\">com.                    86400   IN      DS      30909 8 2 E2D3C916F6DEEAC73294E8268FB5885044A833FC5459588F4A9184CF C41A5766</span><br><span class=\"line\">com.                    86400   IN      RRSIG   DS 8 1 86400 20210403170000 20210321160000 42351 ....</span><br><span class=\"line\">;; Received 1169 bytes from 199.7.83.42<span class=\"comment\">#53(l.root-servers.net) in 27 ms</span></span><br><span class=\"line\"><span class=\"comment\"># 在次级域ns获得百度的A记录</span></span><br><span class=\"line\">baidu.com.              172800  IN      NS      ns2.baidu.com.</span><br><span class=\"line\">baidu.com.              172800  IN      NS      ns3.baidu.com.</span><br><span class=\"line\">baidu.com.              172800  IN      NS      ns4.baidu.com.</span><br><span class=\"line\">baidu.com.              172800  IN      NS      ns1.baidu.com.</span><br><span class=\"line\">baidu.com.              172800  IN      NS      ns7.baidu.com.</span><br><span class=\"line\">CK0POJMG874LJREF7EFN8430QVIT8BSM.com. 86400 IN NSEC3 1 1 0 - CK0Q1GIN43N1ARRC9OSM6QPQR81H5M9A NS SOA RRSIG DNSKEY NSEC3PARAM</span><br><span class=\"line\">CK0POJMG874LJREF7EFN8430QVIT8BSM.com. 86400 IN RRSIG NSEC3 8 2 86400 20210329044039 20210322033039 58540 com.</span><br><span class=\"line\">HPVUSBDNI26UDNIV6R0SV14GC3KGR4JP.com. 86400 IN NSEC3 1 1 0 - HPVVN3Q5E5GOQP2QFE2LEM4SVB9C0SJ6 NS DS RRSIG</span><br><span class=\"line\">HPVUSBDNI26UDNIV6R0SV14GC3KGR4JP.com. 86400 IN RRSIG NSEC3 8 2 86400 20210329061254 20210322050254 58540 </span><br><span class=\"line\">;; Received 757 bytes from 192.54.112.30<span class=\"comment\">#53(h.gtld-servers.net) in 215 ms</span></span><br><span class=\"line\"><span class=\"comment\"># 获得A记录</span></span><br><span class=\"line\">baidu.com.              600     IN      A       220.181.38.148</span><br><span class=\"line\">baidu.com.              600     IN      A       39.156.69.79</span><br><span class=\"line\">baidu.com.              86400   IN      NS      ns7.baidu.com.</span><br><span class=\"line\">baidu.com.              86400   IN      NS      ns2.baidu.com.</span><br><span class=\"line\">baidu.com.              86400   IN      NS      ns4.baidu.com.</span><br><span class=\"line\">baidu.com.              86400   IN      NS      ns3.baidu.com.</span><br><span class=\"line\">baidu.com.              86400   IN      NS      dns.baidu.com.</span><br><span class=\"line\">;; Received 240 bytes from 14.215.178.80<span class=\"comment\">#53(ns4.baidu.com) in 35 ms</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (5) 复现反向查询的流程(此处以百度邮箱为例)</span></span><br><span class=\"line\">ping mx21.baidu.com                      <span class=\"comment\"># 获得地址</span></span><br><span class=\"line\">~$ dig -x 220.181.3.85  @192.168.4.254</span><br><span class=\"line\">~$ dig -t ptr 85.3.181.220.in-addr.arpa.  @192.168.4.254</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;85.3.181.220.in-addr.arpa.     IN      PTR</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># 85.3.181.220.in-addr.arpa. 3600 IN      PTR     mx21.baidu.com.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (6) 直接输出一个域名解析地址</span></span><br><span class=\"line\">dig +short blog.weiyigeek.top</span><br><span class=\"line\">  <span class=\"comment\"># 172.67.189.218</span></span><br><span class=\"line\">dig +short www.weiyigeek.top</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> $(dig +short www.weiyigeek.top);<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> IP:<span class=\"variable\">$&#123;i&#125;</span>;<span class=\"keyword\">done</span></span><br><span class=\"line\">  <span class=\"comment\"># IP:104.21.10.9</span></span><br><span class=\"line\">  <span class=\"comment\"># IP:172.67.189.218</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h4 id=\"host-命令\"><a href=\"#host-命令\" class=\"headerlink\" title=\"host 命令\"></a>host 命令</h4><p>描述: 使用较多, 简单、明了，它基本就是 dig 的弱化版；<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) -t type指定DNS解析类型</span></span><br><span class=\"line\">host -t SOA www.weiyigeek.top  </span><br><span class=\"line\">host -t NS www.weiyigeek.top</span><br><span class=\"line\">host -t CNAME www.weiyigeek.top</span><br><span class=\"line\">host -t A www.weiyigeek.top</span><br><span class=\"line\">host -t MX www.weiyigeek.top</span><br><span class=\"line\">host -t TXT www.weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 不过 host 有个有点就是能打印出它测试过的所有 FQDN (此处也能体现搜索域)</span></span><br><span class=\"line\">host -a weiyigeek.cn</span><br><span class=\"line\">  <span class=\"comment\"># Trying \"weiyigeek.cn\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; - opcode: QUERY, status: NOERROR, id: 25817</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 3</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;weiyigeek.cn.                      IN      ANY</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.cn.               86400   IN      SOA     ns1.weiyigeek.cn. admin.weiyigeek.cn. 3 50400 86400 604800 86400</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.cn.               86400   IN      NS      ns1.weiyigeek.cn.</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.cn.               86400   IN      NS      ns2.weiyigeek.cn.</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.cn.               86400   IN      NS      ns3.weiyigeek.cn.</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.cn.               86400   IN      A       192.168.10.47</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ;; ADDITIONAL SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ns1.weiyigeek.cn.           86400   IN      A       192.168.12.254</span></span><br><span class=\"line\">  <span class=\"comment\"># ns2.weiyigeek.cn.           86400   IN      A       192.168.10.254</span></span><br><span class=\"line\">  <span class=\"comment\"># ns3.weiyigeek.cn.           86400   IN      A       192.168.4.254</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) -v 请求详细流程 (设置搜索域时可以看到 A/AAAA/MX 请求)</span></span><br><span class=\"line\">~$ host -v oa</span><br><span class=\"line\">Trying <span class=\"string\">\"oa.weiyigeek.top\"</span></span><br><span class=\"line\">Trying <span class=\"string\">\"oa.weiyigeek.cn\"</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 64579</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span></span><br><span class=\"line\">  <span class=\"comment\"># .....</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;oa.weiyigeek.cn.                   IN      A</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; ANSWER SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># oa.weiyigeek.cn.            604800  IN      A       192.168.100.96</span></span><br><span class=\"line\">  <span class=\"comment\"># .....</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;oa.weiyigeek.cn.                   IN      AAAA</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; AUTHORITY SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.cn.               604800  IN      SOA     ns1.weiyigeek.cn. admin.weiyigeek.cn. 3 600 86400 2419200 604800</span></span><br><span class=\"line\">  <span class=\"comment\"># .....</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; QUESTION SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># ;oa.weiyigeek.cn.                   IN      MX</span></span><br><span class=\"line\">  <span class=\"comment\"># ;; AUTHORITY SECTION:</span></span><br><span class=\"line\">  <span class=\"comment\"># weiyigeek.cn.               604800  IN      SOA     ns1.weiyigeek.cn. admin.weiyigeek.cn. 3 600 86400 2419200 604800</span></span><br><span class=\"line\">  <span class=\"comment\"># Received 75 bytes from 192.168.12.254#53 in 0 ms</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/2/20201126224430.png\" alt=\"WeiyiGeek.DNS正向解析客户端工具\" title=\"\" class=\"\">\n                <p>WeiyiGeek.DNS正向解析客户端工具</p>\n            </figure>\n<p><br/></p>\n<h4 id=\"whois-命令\"><a href=\"#whois-命令\" class=\"headerlink\" title=\"whois 命令\"></a>whois 命令</h4><p>描述: whois目录服务的客户端<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># SYNOPSIS</span></span><br><span class=\"line\">whois [ &#123; -h | --host &#125; HOST ] [ &#123; -p | --port &#125; PORT ] [ -abBcdGHIKlLmMrRx ] [ -g SOURCE:FIRST-LAST ] [ -i ATTR[,ATTR]... ] [ -s SOURCE[,SOURCE]... ] [ -T TYPE[,TYPE]... ] [ --verbose ] OBJECT</span><br><span class=\"line\">whois -q KEYWORD</span><br><span class=\"line\">whois -t TYPE</span><br><span class=\"line\">whois -v TYPE</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数:</span></span><br><span class=\"line\">-h HOST, --host=HOST  <span class=\"comment\"># Connect to HOST.</span></span><br><span class=\"line\">-p PORT, --port=PORT  <span class=\"comment\"># Connect to PORT.</span></span><br><span class=\"line\">-H  <span class=\"comment\"># Do not display the legal disclaimers that some registries like to show you.</span></span><br><span class=\"line\">-I  <span class=\"comment\"># First query whois.iana.org and then follow its referral to the whois server authoritative for that request. This works for IP addresses, AS numbers and domains.  BEWARE: this implies that the IANA server will re‐ceive your complete query.</span></span><br><span class=\"line\">--verbose Be verbose.</span><br><span class=\"line\"></span><br><span class=\"line\">Other options are flags understood by whois.ripe.net and some other RIPE-like servers:</span><br><span class=\"line\">-a      Also search all the mirrored databases.</span><br><span class=\"line\">-b      Return brief IP address ranges with abuse contact.</span><br><span class=\"line\">-B      Disable objects filtering. (Show the e-mail addresses.)</span><br><span class=\"line\">-c      Return the smallest IP address range with a reference to an irt object.</span><br><span class=\"line\">-d      Return the reverse DNS delegation object too.</span><br><span class=\"line\">-g SOURCE:FIRST-LAST <span class=\"comment\"># Search updates from SOURCE database between FIRST and LAST update serial number. It is useful to obtain Near Real Time Mirroring stream.</span></span><br><span class=\"line\">-G      <span class=\"comment\">#Disable grouping of associated objects.</span></span><br><span class=\"line\">-i ATTR[,ATTR]...    <span class=\"comment\"># Inverse-search objects having associated attributes.  ATTR is the attribute name, while the positional OBJECT argument is the attribute value.</span></span><br><span class=\"line\">-K      Return  primary  key  attributes  only.  An exception is the members attribute of <span class=\"built_in\">set</span> objects, <span class=\"built_in\">which</span> is always returned. Another exception are all attributes of the objects organisation, person and role, that are never returned.</span><br><span class=\"line\">-l      Return the one level less specific object.</span><br><span class=\"line\">-L      Return all levels of less specific objects.</span><br><span class=\"line\">-m      Return all one level more specific objects.</span><br><span class=\"line\">-M      Return all levels of more specific objects.</span><br><span class=\"line\"></span><br><span class=\"line\">--<span class=\"built_in\">help</span>  Display online <span class=\"built_in\">help</span>.</span><br><span class=\"line\">--version Display the program version.</span><br></pre></td></tr></table></figure></p>\n<p>基础实例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1) 域名提供商信息查询(现在基本都是)</span></span><br><span class=\"line\">~$ whois weiyigeek.top</span><br><span class=\"line\">  Domain Name: weiyigeek.top</span><br><span class=\"line\">  Registry Domain ID: D20200225G10001G_34088337-top</span><br><span class=\"line\">  Registrar WHOIS Server: whois.dnspod.cn</span><br><span class=\"line\">  Registrar URL: https://www.dnspod.cn</span><br><span class=\"line\">  Updated Date: 2020-04-25T06:49:26Z</span><br><span class=\"line\">  Creation Date: 2020-02-25T03:50:39Z</span><br><span class=\"line\">  Registry Expiry Date: 2030-02-25T03:50:39Z</span><br><span class=\"line\">  Registrar: DNSPod, Inc.</span><br><span class=\"line\">  Registrar IANA ID: 1697</span><br><span class=\"line\">  Registrar Abuse Contact Email: abuse@dnspod.com</span><br><span class=\"line\">  Registrar Abuse Contact Phone: +86.95716</span><br><span class=\"line\">  Domain Status: clientTransferProhibited https://icann.org/epp<span class=\"comment\">#clientTransferProhibited</span></span><br><span class=\"line\">  Registry Registrant ID: REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant Name: REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant Organization: weiyigeek</span><br><span class=\"line\">  Registrant Street:  REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant City: REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant State/Province: chong qing shi</span><br><span class=\"line\">  Registrant Postal Code: REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant Country: CN</span><br><span class=\"line\">  Registrant Phone: REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant Phone Ext: REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant Fax: REDACTED FOR PRIVACY</span><br><span class=\"line\">  Registrant Fax Ext: REDACTED FOR PRIVACY</span><br></pre></td></tr></table></figure></p>\n<p>Tips : dig 工具未来可能会被 drill 取代。</p>\n<p><br></p>\n<h4 id=\"shell-脚本工具\"><a href=\"#shell-脚本工具\" class=\"headerlink\" title=\"shell 脚本工具\"></a>shell 脚本工具</h4><p><strong>Named 配置测试:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee /tmp/dns-test.sh &lt;&lt;<span class=\"string\">'END'</span></span><br><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># 1) 区域配置（主、备）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$#</span> -eq 0 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"Usage: <span class=\"variable\">$0</span> /var/cache/bind\"</span></span><br><span class=\"line\">  zonedir=<span class=\"string\">\"/var/cache/bind\"</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  zonedir=<span class=\"variable\">$1</span>  <span class=\"comment\"># /var/cache/bind/master</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">named-checkconf -p</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2) 内部解析zone配置</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> zone <span class=\"keyword\">in</span> $(ls <span class=\"variable\">$&#123;zonedir&#125;</span>);<span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"# <span class=\"variable\">$&#123;zone&#125;</span> ---------------------------\"</span></span><br><span class=\"line\">  named-checkzone <span class=\"variable\">$&#123;zone&#125;</span> <span class=\"variable\">$&#123;zonedir&#125;</span>/<span class=\"variable\">$&#123;zone&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\n\"</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">END</span><br><span class=\"line\"></span><br><span class=\"line\">chmod +x /tmp/dns-test.sh </span><br><span class=\"line\">bash /tmp/dns-test.sh /var/cache/<span class=\"built_in\">bind</span>/master</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x02-入坑出坑\"><a href=\"#0x02-入坑出坑\" class=\"headerlink\" title=\"0x02 入坑出坑\"></a>0x02 入坑出坑</h2><h3 id=\"问题1-validating-com-DS-no-valid-signature-found\"><a href=\"#问题1-validating-com-DS-no-valid-signature-found\" class=\"headerlink\" title=\"问题1.validating com/DS: no valid signature found\"></a>问题1.validating com/DS: no valid signature found</h3><p>问题描述: 之前一直用的windows版本的bind9服务器。配置文件稍微改动一下路径直接拿来用。可以运行但是总是提示错误<code>validating com/DS: no valid signature found</code>。</p>\n<p>描述: 通过参考官网的说明发现可以由于时区或者dnssec密钥不正确以及不存在导致导致<code>no valid signature found</code>错误。</p>\n<p>解决办法: 修改bind9的options配置如下即可使用，如果要使用dnssec需要生成Generating Keys(<a href=\"https://bind9.readthedocs.io/en/v9_16_13/advanced.html#dnssec\" target=\"_blank\" rel=\"noopener\">帮助地址</a>)。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F;dnssec-enable yes;</span><br><span class=\"line\">dnssec-validation no;</span><br><span class=\"line\">&#x2F;&#x2F;dnssec-lookaside auto;</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"问题2-client-0x7f418c000cd0-10-20-172-106-54935-xxx-com-query-cache-‘xxx-com-A-IN’-denied\"><a href=\"#问题2-client-0x7f418c000cd0-10-20-172-106-54935-xxx-com-query-cache-‘xxx-com-A-IN’-denied\" class=\"headerlink\" title=\"问题2.client @0x7f418c000cd0 10.20.172.106#54935 (xxx.com): query (cache) ‘xxx.com/A/IN’ denied\"></a>问题2.client @0x7f418c000cd0 10.20.172.106#54935 (xxx.com): query (cache) ‘xxx.com/A/IN’ denied</h3><p>错误信息:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Mar 22 14:54:32 dns-server named[70775]: client @0x7f418c000cd0 10.20.172.106<span class=\"comment\">#54935 (edge.microsoft.com): query (cache) 'edge.microsoft.com/A/IN' denied</span></span><br><span class=\"line\">Mar 22 14:54:32 dns-server named[70775]: client @0x7f418c000cd0 10.20.172.106<span class=\"comment\">#54935 (edge.microsoft.com): query failed (REFUSED) for edge.microsoft.com/IN/A at query.c:5425</span></span><br><span class=\"line\">Mar 22 14:55:09 dns-server named[70775]: client @0x7f4174013dd0 10.20.172.106<span class=\"comment\">#59712 (edge.activity.windows.com): query (cache) 'edge.activity.windows.com/A/IN' denied</span></span><br><span class=\"line\">Mar 22 14:55:09 dns-server named[70775]: client @0x7f4174013dd0 10.20.172.106<span class=\"comment\">#59712 (edge.activity.windows.com): query failed (REFUSED) for edge.activity.windows.com/IN/A at query.c:5425</span></span><br></pre></td></tr></table></figure><br>错误原因: 从字面意思来看就是Client查询无权限<br>解决办法: 在named.conf中添加<code>allow-query { any; };</code>配置。</p>\n<hr>\n<h2 id=\"0x03-参考来源\"><a href=\"#0x03-参考来源\" class=\"headerlink\" title=\"0x03 参考来源\"></a>0x03 参考来源</h2><ul>\n<li><a href=\"https://bind9.readthedocs.io/\" target=\"_blank\" rel=\"noopener\">BIND 9 Administrator Reference Manual</a></li>\n<li><a href=\"https://note.mc256.com/2014/03/bind%E6%8A%A5%E9%94%99named-client-query-cache-ain-denied.html\" target=\"_blank\" rel=\"noopener\">named-client-query-cache-ain-denied</a></li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"DNS","path":"api/categories/DNS.json"},{"name":"域名解析","path":"api/categories/域名解析.json"}],"tags":[{"name":"Bind","path":"api/tags/Bind.json"}]}