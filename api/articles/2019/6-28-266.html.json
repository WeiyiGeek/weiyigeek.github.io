{"title":"Ansible自动化运维学习笔记1","slug":"系统运维/自动化运维/Ansible/Ansible自动化运维学习笔记1","date":"2019-06-28T06:34:30.000Z","updated":"2022-03-29T05:39:06.298Z","url":"2019/6-28-266.html","path":"api/articles/2019/6-28-266.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190626144613.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190724154311.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190724154958.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729094942.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729105928.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729100309.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729111106.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729112518.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729123011.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729124615.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729152819.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-快速入门\"><a href=\"#0x00-快速入门\" class=\"headerlink\" title=\"0x00 快速入门\"></a>0x00 快速入门</h4><p><strong>基础概念</strong><br><em>什么是ansible？</em><br>答：它是一个Linux系统上的”自动化运维工具”，类似一个”配置管理工具”; </p>\n<p><em>ansible能做什么？</em><br>正如其他配置管理工具一样，ansible可以帮助我们完成一些批量任务，或者完成一些需要经常重复的工作。</p>\n<ul>\n<li>比如：同时在100台服务器上安装nginx服务，并在安装后启动它们。</li>\n<li>比如：将某个文件一次性拷贝到100台服务器上。</li>\n<li>比如：每当有新服务器加入工作环境时，你都要为新服务器部署redis服务，也就是说你需要经常重复的完成相同的工作。</li>\n</ul>\n<p><em>ansible优秀的特性</em>:</p>\n<ul>\n<li>“幂等性”:可以保证我们重复的执行同一项操作时得到的结果是一样的。<ul>\n<li>举个例子:你想把一个文件拷贝到目标主机的某个目录上，但是你不确定此目录中是否已经存在此文件，当你使用ansible完成这项任务时，就非常简单了，因为如果目标主机的对应目录中已经存在此文件，那么ansible则不会进行任何操作，如果目标主机的对应目录中并不存在此文件，ansible就会将文件拷贝到对应目录中;</li>\n<li>ansible是”以结果为导向的”，我们指定了一个”目标状态”，ansible会自动判断，”当前状态”是否与”目标状态”一致，如果一致，则不进行任何操作，如果不一致那么就将”当前状态”变成”目标状态”</li>\n</ul>\n</li>\n<li>剧本</li>\n<li>模板</li>\n<li>角色</li>\n</ul>\n<p>其他的一些运维配置管理工具还有puppet或者saltstack而ansible相比较于他们的优点：</p>\n<ul>\n<li>使用puppet管理100台主机，就要在这100台主机上安装puppet对应的agent（客户端代理程序），比较繁琐;</li>\n<li>不同之处在于ansible只需要依赖ssh即可正常工作，不用在受管主机上安装agent，也就是说只要你能通过ssh连接到对应主机，你就可以通过ansible管理对应的主机。</li>\n<li>为了好分辨后面将Ansible主机就是管理主机,受管理的主机叫做受控主机;</li>\n</ul>\n<p>参考文档帮助：<a href=\"https://docs.ansible.com/ansible/latest/index.html\" target=\"_blank\" rel=\"noopener\">https://docs.ansible.com/ansible/latest/index.html</a></p>\n<p><br></p>\n<h5 id=\"1-环境安装与设置\"><a href=\"#1-环境安装与设置\" class=\"headerlink\" title=\"1.环境安装与设置\"></a>1.环境安装与设置</h5><p>环境设置：采用VMWARE-player模拟环境实现;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.10.107.222  Master-Ansible管理端</span><br><span class=\"line\">10.10.107.234  Slave-Ansible 受控端(Ubuntu)</span><br><span class=\"line\">10.20.172.235  Slave-Ansible 受控端(Centos)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>(1) CentOS下Ansible安装：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Step1.我使用yum源的方式安装ansible，因为安装ansible需要epel源，所以我配置了阿里的epel源和centos7系统镜像源，</span></span><br><span class=\"line\">$ <span class=\"built_in\">pwd</span></span><br><span class=\"line\">/etc/yum.repos.d</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># cat aliBase.repo</span></span><br><span class=\"line\">[aliBase]</span><br><span class=\"line\">name=aliBase</span><br><span class=\"line\">baseurl=https://mirrors.aliyun.com/centos/<span class=\"variable\">$releasever</span>/os/<span class=\"variable\">$basearch</span>/</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">gpgkey=https://mirrors.aliyun.com/centos/<span class=\"variable\">$releasever</span>/os/<span class=\"variable\">$basearch</span>/RPM-GPG-KEY-CentOS-<span class=\"variable\">$releasever</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># cat aliEpel.repo</span></span><br><span class=\"line\">[aliEpel]</span><br><span class=\"line\">name=aliEpel</span><br><span class=\"line\">baseurl=https://mirrors.aliyun.com/epel/<span class=\"variable\">$releasever</span>\\Server/<span class=\"variable\">$basearch</span>/</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step2.yum源配置完成后，安装ansible</span></span><br><span class=\"line\">yum install ansible  <span class=\"comment\">#此时yum源中对应的版本为ansible-2.8.1-1.el7.noarch.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step3.验证安装</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span> 127.0.0.1 -m ping  <span class=\"comment\">#使用ansible去ping本机,</span></span><br><span class=\"line\">127.0.0.1 | SUCCESS =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>安装成功后如果想要通过ansible管理某主机，使用ansible管理必须同时满足两个最基本的条件如下</p>\n<ul>\n<li>条件一、ansible所在的主机可以通过ssh连接到受管主机。</li>\n<li>条件二、受管主机的IP地址等信息已经添加到ansible的”管理清单”中，如果清单中没有的主机无法通过ansible进行配置管理;</li>\n</ul>\n<p>ansible提供一个默认的”清单”文件 /etc/ansible/hosts并且采用ini风格里面有默认的配置示例使用提示;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#由于ansible工作方式,需要将受管主机的IP地址、ssh端口号等信息添加到一个被称作为\"清单(Inventory)\"的配置文件中</span></span><br><span class=\"line\"><span class=\"comment\"># ansible_port 用于配置对应主机上的sshd服务端口号默认的22号端口，</span></span><br><span class=\"line\"><span class=\"comment\"># ansible_user 用于配置连接到对应主机时所使用的用户名称。</span></span><br><span class=\"line\"><span class=\"comment\"># ansible_ssh_pass 用于配置对应用户的连接密码。</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"10.10.107.234 ansible_port=22 ansible_user=root ansible_ssh_pass=ubuntu\"</span> &gt;&gt; /etc/ansible/hosts  <span class=\"comment\">#通过ansible主机管理234主机</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#当为主机配置别名时，主机的IP地址必须使用anible_host关键字进行指明，否则ansible将无法正确的识别对应的主机。</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"test ansible_host=10.20.172.104 ansible_port=22 ansible_user=root ansible_ssh_pass=2019\"</span> &gt;&gt; /etc/ansible/hosts  <span class=\"comment\">#设置别名的方式</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#注意：上述配置参数都是ansible2.0版本以后的写法，2.0版本之前，应遵从如下写法</span></span><br><span class=\"line\">ansible_port <span class=\"comment\">#应该写成ansible_ssh_port</span></span><br><span class=\"line\">ansible_user <span class=\"comment\">#应该写成ansible_ssh_user/pass</span></span><br><span class=\"line\">ansible_host <span class=\"comment\">#应该写成ansible_ssh_host</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#验证清单配置(两台机器都是OK的)</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span> 10.10.107.234 -m ping</span><br><span class=\"line\">10.10.107.234 | SUCCESS =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"ansible_facts\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">ansible <span class=\"built_in\">test</span> -m ping</span><br><span class=\"line\"><span class=\"built_in\">test</span> | SUCCESS =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"ansible_facts\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"discovered_interpreter_python\"</span>: <span class=\"string\">\"/usr/bin/python\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"ping\"</span>: <span class=\"string\">\"pong\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p><em>ansible主控端如何采用密匙来登录受控端？</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#首先，生成默认格式的密钥对，私钥与公钥。</span></span><br><span class=\"line\">ssh-keygen</span><br><span class=\"line\"><span class=\"comment\">#然后将生成的公钥加入到10.10.107.234的认证列表</span></span><br><span class=\"line\">ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.10.107.234</span><br><span class=\"line\"><span class=\"comment\">#好了公钥认证的相关操作配置完成，此刻，我们已经可以通过ansible主机免密码连接到主机60中了。</span></span><br></pre></td></tr></table></figure></p>\n<p>因为配置了密钥认证，所以可以实现免密码创建ssh连接，既然已经能够免密码创建ssh连接，那么在配置”主机清单”时，就没有必要再提供对应主机的用户名与密码了，所以在完成了密钥认证的相关配置后，我们可以将清单中的配置精简为如下格式。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.10.107.234 ansible_port=22 <span class=\"comment\">#精简模式（默认也是的22号端口，所以可以忽略）</span></span><br><span class=\"line\"><span class=\"built_in\">test</span> ansible_host=10.10.107.234 ansible_port=22 <span class=\"comment\">#别名模式</span></span><br></pre></td></tr></table></figure></p>\n<p><em>安装总结：</em></p>\n<ul>\n<li>在上面我们使用的是ssh账号密码登录,但是在生产环境中为了提高安全性，我们通常会基于密钥进行ssh认证甚至会禁用密码认证;</li>\n<li>在接入之前需要将受控端的公匙写入ansible的kown_hosts中;</li>\n</ul>\n<p><br></p>\n<p><strong>(2) Ubuntu下Ansible安装：</strong></p>\n<p>安装方式:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.官网安装方式(要有梯子)</span></span><br><span class=\"line\">$ sudo apt update</span><br><span class=\"line\">$ sudo apt install software-properties-common</span><br><span class=\"line\">$ sudo apt-add-repository --yes --update ppa:ansible/ansible</span><br><span class=\"line\">$ sudo apt install ansible</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.我们将使用默认的Ubuntu存储库安装（版本可能非最新）</span></span><br><span class=\"line\">sudo apt update  <span class=\"comment\"># 首先使用以下命令刷新系统的软件包索引完成此更新后您可以使用以下方法</span></span><br><span class=\"line\">sudo apt install ansible <span class=\"comment\"># 安装Ansible软件：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.安装后版本查看</span></span><br><span class=\"line\">ansible --version</span><br><span class=\"line\">ansible 2.9.6</span><br><span class=\"line\">  config file = /etc/ansible/ansible.cfg</span><br><span class=\"line\">  configured module search path = [<span class=\"string\">'/home/weiyigeek/.ansible/plugins/modules'</span>, <span class=\"string\">'/usr/share/ansible/plugins/modules'</span>]</span><br><span class=\"line\">  ansible python module location = /usr/lib/python3/dist-packages/ansible</span><br><span class=\"line\">  executable location = /usr/bin/ansible</span><br><span class=\"line\">  python version = 3.8.5 (default, Jul 28 2020, 12:59:40) [GCC 9.3.0]</span><br></pre></td></tr></table></figure></p>\n<p>至此现在，您的Ansible控制节点具有管理主机所需的所有软件;</p>\n<p><br></p>\n<h5 id=\"2-清单配置详解\"><a href=\"#2-清单配置详解\" class=\"headerlink\" title=\"2.清单配置详解\"></a>2.清单配置详解</h5><p>描述:该清单文件包含有关你会Ansible管理的主机信息</p>\n<ul>\n<li>清单文件中包括从一到数百台服务器的任何位置，并且可以将主机组织为组和子组。</li>\n<li>清单文件通常还用于设置仅对特定主机或组有效的变量，以便在剧本和模板中使用。</li>\n</ul>\n<p>我们可以在ansible提供的清单配置文件中进行配置我们以该文件进行讲解<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\"># This is the default ansible 'hosts' file.</span></span><br><span class=\"line\"><span class=\"comment\"># It should live in /etc/ansible/hosts</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例1.清单支持\"分组\"功能，我们可以将某些主机分为一组，然后通过组名去管理组内的所有主机。</span></span><br><span class=\"line\"><span class=\"comment\"># 比如，主机234和主机235都属于A模块的服务器，主机221属于B模块的服务器，我们则可以在清单中进行如下配置</span></span><br><span class=\"line\">[A]</span><br><span class=\"line\">10.10.107.234</span><br><span class=\"line\">10.10.107.235</span><br><span class=\"line\"></span><br><span class=\"line\">[B]</span><br><span class=\"line\">10.10.107.221</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例2.如果两台主机的IP地址是连续的我们可以使用更简洁的方法，配置A组中的受管主机，示例如下</span></span><br><span class=\"line\">[A]</span><br><span class=\"line\">10.10.107.[234:235]</span><br><span class=\"line\"></span><br><span class=\"line\">[B]</span><br><span class=\"line\">10.10.107.221</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例3. 使用主机名配置受管主机的前提是ansible主机可以正确解析对应的主机名，比如，我们想要通过主机名配置两台主机，示例如下。</span></span><br><span class=\"line\">[A]</span><br><span class=\"line\">db01.weiyigeek.net</span><br><span class=\"line\">db02.weiyigeek.net</span><br><span class=\"line\"></span><br><span class=\"line\">[B]</span><br><span class=\"line\">db0[1:2].weiyigeek.net</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例4.为了更加的灵活的管理受管主机，可能需要在组内嵌套组。</span></span><br><span class=\"line\"><span class=\"comment\">#比如，服务器环境从大类上可以分为\"生产环境\"和\"测试环境\"，把主机分成了两组生产组和测试组，但是生产环境又包含很多业务模块，</span></span><br><span class=\"line\"><span class=\"comment\">#比如，A模块生产组、B模块生产组，同理测试环境中也会有同样的问题，比如A模块测试环境组，B模块测试组，这时我们就需要更加细化的进行分组，示例如下</span></span><br><span class=\"line\">[testA]</span><br><span class=\"line\">10.10.107.1</span><br><span class=\"line\"></span><br><span class=\"line\">[testB]</span><br><span class=\"line\">10.10.107.2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#而master组中包含\"子组\"，没错，\"children\"关键字表示当前组中存在子组就是testA组和testB组</span></span><br><span class=\"line\">[Master:children]</span><br><span class=\"line\"><span class=\"built_in\">test</span>[A:B]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 示例4.分组与子组与组的变量声明</span></span><br><span class=\"line\">[manager]</span><br><span class=\"line\">admin ansible_host=10.10.107.202 ansible_port=20211 ansible_user=WeiyiGeeker ansible_sudo_pass=<span class=\"string\">'123456'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[master]</span><br><span class=\"line\">k8s-master-1 ansible_host=10.10.107.210</span><br><span class=\"line\">k8s-master-2 ansible_host=10.10.107.211</span><br><span class=\"line\">k8s-master-3 ansible_host=10.10.107.212</span><br><span class=\"line\"></span><br><span class=\"line\">[node]</span><br><span class=\"line\">k8s-node-1 ansible_host=10.10.107.213</span><br><span class=\"line\">k8s-node-2 ansible_host=10.20.172.220</span><br><span class=\"line\">k8s-node-3 ansible_host=10.20.172.221</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># k8s 组包含的 子组</span></span><br><span class=\"line\">[k8s:children]</span><br><span class=\"line\">master</span><br><span class=\"line\">node</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># k8s 组内所共享的局部变量设置优先级高(全局设置在`/etc/ansible/ansible.cfg`)</span></span><br><span class=\"line\">[k8s:vars]</span><br><span class=\"line\">ansible_port=20211</span><br><span class=\"line\">ansible_user=WeiyiGeeker</span><br><span class=\"line\">ansible_become=<span class=\"literal\">true</span></span><br><span class=\"line\">ansible_become_method=sudo</span><br><span class=\"line\">ansible_become_pass=<span class=\"string\">'123456'</span></span><br><span class=\"line\"></span><br><span class=\"line\">[all:vars]</span><br><span class=\"line\">ansible_python_interpreter=/usr/bin/python3</span><br></pre></td></tr></table></figure></p>\n<p><em>验证配置结果：</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#验证1.A组中包含主机60与61，B组中包含主机70，经过上述配置后，我们可以通过组名去管理组内的所有主机，示例如下。</span></span><br><span class=\"line\">ansible A -m ping</span><br><span class=\"line\">ansible B -m ping</span><br><span class=\"line\">ansible all -m ping <span class=\"comment\">#将配置文件中所有的主机进行ping操作</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#验证4.如我们需要针对生产环境中的所有主机进行操作时，调用master组即可</span></span><br><span class=\"line\">ansible Master -m ping</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#验证5.通过执行以下命令查看包含清单文件中定义的自己的服务器基础结构</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span>-inventory --list -y</span><br><span class=\"line\">all:</span><br><span class=\"line\">  children:</span><br><span class=\"line\">    k8s:</span><br><span class=\"line\">      children:</span><br><span class=\"line\">        master:</span><br><span class=\"line\">          hosts:</span><br><span class=\"line\">            k8s-master-1:</span><br><span class=\"line\">              ansible_become: <span class=\"string\">'true'</span></span><br><span class=\"line\">              ansible_become_method: sudo</span><br><span class=\"line\">              ansible_become_pass: 123456</span><br><span class=\"line\">              ansible_host: 10.10.107.210</span><br><span class=\"line\">              ansible_port: 20211</span><br><span class=\"line\">              ansible_python_interpreter: /usr/bin/python3</span><br><span class=\"line\">              ansible_user: WeiyiGeeker</span><br><span class=\"line\">            k8s-master-2:</span><br><span class=\"line\">              ansible_become: <span class=\"string\">'true'</span></span><br><span class=\"line\">              ansible_become_method: sudo</span><br><span class=\"line\">              ansible_become_pass: 123456</span><br><span class=\"line\">              ansible_host: 10.10.107.211</span><br><span class=\"line\">              ansible_port: 20211</span><br><span class=\"line\">              ansible_python_interpreter: /usr/bin/python3</span><br><span class=\"line\">              ansible_user: WeiyiGeeker</span><br><span class=\"line\">            k8s-master-3:</span><br><span class=\"line\">              ansible_become: <span class=\"string\">'true'</span></span><br><span class=\"line\">              ansible_become_method: sudo</span><br><span class=\"line\">              ansible_become_pass: 123456</span><br><span class=\"line\">              ansible_host: 10.10.107.212</span><br><span class=\"line\">              ansible_port: 20211</span><br><span class=\"line\">              ansible_python_interpreter: /usr/bin/python3</span><br><span class=\"line\">              ansible_user: WeiyiGeeker</span><br><span class=\"line\">        node:</span><br><span class=\"line\">          hosts:</span><br><span class=\"line\">            k8s-node-1:</span><br><span class=\"line\">              ansible_become: <span class=\"string\">'true'</span></span><br><span class=\"line\">              ansible_become_method: sudo</span><br><span class=\"line\">              ansible_become_pass: 123456</span><br><span class=\"line\">              ansible_host: 10.10.107.213</span><br><span class=\"line\">              ansible_port: 20211</span><br><span class=\"line\">              ansible_python_interpreter: /usr/bin/python3</span><br><span class=\"line\">              ansible_user: WeiyiGeeker</span><br><span class=\"line\">            k8s-node-2:</span><br><span class=\"line\">              ansible_become: <span class=\"string\">'true'</span></span><br><span class=\"line\">              ansible_become_method: sudo</span><br><span class=\"line\">              ansible_become_pass: 123456</span><br><span class=\"line\">              ansible_host: 10.20.172.220</span><br><span class=\"line\">              ansible_port: 20211</span><br><span class=\"line\">              ansible_python_interpreter: /usr/bin/python3</span><br><span class=\"line\">              ansible_user: WeiyiGeeker</span><br><span class=\"line\">            k8s-node-3:</span><br><span class=\"line\">              ansible_become: <span class=\"string\">'true'</span></span><br><span class=\"line\">              ansible_become_method: sudo</span><br><span class=\"line\">              ansible_become_pass: 123456</span><br><span class=\"line\">              ansible_host: 10.20.172.221</span><br><span class=\"line\">              ansible_port: 20211</span><br><span class=\"line\">              ansible_python_interpreter: /usr/bin/python3</span><br><span class=\"line\">              ansible_user: WeiyiGeeker</span><br><span class=\"line\">    manager:</span><br><span class=\"line\">      hosts:</span><br><span class=\"line\">        admin:</span><br><span class=\"line\">          ansible_host: 10.10.107.202</span><br><span class=\"line\">          ansible_port: 20211</span><br><span class=\"line\">          ansible_python_interpreter: /usr/bin/python3</span><br><span class=\"line\">          ansible_sudo_pass: 123456</span><br><span class=\"line\">          ansible_user: WeiyiGeeker</span><br><span class=\"line\">    ungrouped: &#123;&#125;</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190626144613.png\" alt=\"WeiyiGeek.验证1\" title=\"\" class=\"\">\n                <p>WeiyiGeek.验证1</p>\n            </figure>\n<p><br></p>\n<p>其实Ansible的清单文件/etc/ansible/hosts不仅能够识别INI的配置语法还能够识别”YAML”的配置语法。<br>注意，为了使缩进显得更加明显，此处每次缩进使用两个空格<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/ansible/hosts</span><br><span class=\"line\"><span class=\"comment\">#使用YAML语法配置的主机清单非常简单下面就是他的配置示例</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例1.所有受管理组演示</span></span><br><span class=\"line\">all:   <span class=\"comment\">#管理清单中的所有主机的一个组，这里的\"all:\"就是这个含义</span></span><br><span class=\"line\"> hosts:  <span class=\"comment\">#第二行开头使用一个空格作为缩进，使用hosts关键字，表示hosts属于all的下一级，（后面的都是采用两个空格）</span></span><br><span class=\"line\">   10.10.107.1</span><br><span class=\"line\">   10.10.107.2</span><br><span class=\"line\"><span class=\"comment\">#上例相当于如下INI配置</span></span><br><span class=\"line\">10.1.1.60</span><br><span class=\"line\">10.1.1.61</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2.ini风格对比yaml</span></span><br><span class=\"line\"><span class=\"comment\">#先看一个INI风格的配置表示当前清单中有3台受管主机，主机61不属于任何组，主机60属于test1组，主机70属于test2组</span></span><br><span class=\"line\">10.1.1.61</span><br><span class=\"line\"></span><br><span class=\"line\">[test1]</span><br><span class=\"line\">10.1.1.60</span><br><span class=\"line\"></span><br><span class=\"line\">[test2]</span><br><span class=\"line\">10.1.1.70</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#使用YAML语法进行同等效果的配置如下</span></span><br><span class=\"line\"><span class=\"comment\">#当直接在清单中创建组时，需要在all关键字内使用children关键字，而定义每个组时，有必须使用hosts关键字，指明组内的主机</span></span><br><span class=\"line\">all:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">    10.1.1.61:</span><br><span class=\"line\">  children:  <span class=\"comment\">#分组都是children</span></span><br><span class=\"line\">    test1:</span><br><span class=\"line\">      hosts:</span><br><span class=\"line\">        10.1.1.60:</span><br><span class=\"line\">    test2:</span><br><span class=\"line\">      hosts:</span><br><span class=\"line\">        10.1.1.70:</span><br><span class=\"line\"><span class=\"comment\">#从上例可以看出，</span></span><br></pre></td></tr></table></figure></p>\n<p>组中嵌套时候：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#仍然先写出INI风格的示例以作对比，如下</span></span><br><span class=\"line\">[proA]</span><br><span class=\"line\">10.1.1.60</span><br><span class=\"line\"></span><br><span class=\"line\">[proB]</span><br><span class=\"line\">10.1.1.70</span><br><span class=\"line\"></span><br><span class=\"line\">[pro:children]</span><br><span class=\"line\">proA</span><br><span class=\"line\">proB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#对应YAML格式的配置如下pro组有两个子组，分别为proA组和proB组，而这两个组分别有自己组内的主机。</span></span><br><span class=\"line\">all:</span><br><span class=\"line\">  children:</span><br><span class=\"line\">    pro:</span><br><span class=\"line\">      children:</span><br><span class=\"line\">        proA:</span><br><span class=\"line\">          hosts:</span><br><span class=\"line\">            10.1.1.60</span><br><span class=\"line\">        proB:</span><br><span class=\"line\">          hosts:</span><br><span class=\"line\">            10.1.1.70</span><br></pre></td></tr></table></figure><br>当我们使用YAML语法配置清单时，无非是<code>使用hosts、children</code>等关键字与我们的自定义名称进行排列组合罢了。</p>\n<p>认证管理yaml配置：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#ini格式如下：</span></span><br><span class=\"line\">10.1.1.6</span><br><span class=\"line\">test7 ansible_host=10.1.1.7 ansible_port=22</span><br><span class=\"line\">localhost ansible_connection=<span class=\"built_in\">local</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#yaml的配置语法</span></span><br><span class=\"line\">all:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">    10.1.1.6</span><br><span class=\"line\">    test7:</span><br><span class=\"line\">      ansible_host: 10.1.1.7 <span class=\"comment\">#注意冒号后都有空格，注意yaml语法</span></span><br><span class=\"line\">      ansible_port: 22</span><br><span class=\"line\">    localhost:</span><br><span class=\"line\">      ansible_connection: <span class=\"built_in\">local</span></span><br></pre></td></tr></table></figure></p>\n<p>综合示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#以下是如何立即部署到创建的容器的示例</span></span><br><span class=\"line\">- name: create jenkins container</span><br><span class=\"line\">  docker_container:</span><br><span class=\"line\">    docker_host: myserver.net:4243</span><br><span class=\"line\">    name: my_jenkins</span><br><span class=\"line\">    image: jenkins</span><br><span class=\"line\"></span><br><span class=\"line\">- name: add container to inventory</span><br><span class=\"line\">  add_host:</span><br><span class=\"line\">    name: my_jenkins</span><br><span class=\"line\">    ansible_connection: docker</span><br><span class=\"line\">    ansible_docker_extra_args: <span class=\"string\">\"--tlsverify --tlscacert=/path/to/ca.pem --tlscert=/path/to/client-cert.pem --tlskey=/path/to/client-key.pem -H=tcp://myserver.net:4243\"</span>  <span class=\"comment\">#设置守护进程</span></span><br><span class=\"line\">    ansible_user: jenkins</span><br><span class=\"line\">  changed_when: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">- name: create directory <span class=\"keyword\">for</span> ssh keys</span><br><span class=\"line\">  delegate_to: my_jenkins</span><br><span class=\"line\">  file:</span><br><span class=\"line\">    path: <span class=\"string\">\"/var/jenkins_home/.ssh/jupiter\"</span></span><br><span class=\"line\">    state: directory</span><br></pre></td></tr></table></figure><br>参考absible的yaml语法：<a href=\"https://docs.ansible.com/ansible/2.4/intro_inventory.html#id7\" target=\"_blank\" rel=\"noopener\">https://docs.ansible.com/ansible/2.4/intro_inventory.html#id7</a></p>\n<hr>\n\n<h4 id=\"0x01-命令详解\"><a href=\"#0x01-命令详解\" class=\"headerlink\" title=\"0x01 命令详解\"></a>0x01 命令详解</h4><p>描述：主要是描述ansible命令与ansible-doc命令参数</p>\n<p>语法参数:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible [主机] [选项] [主机连与认证]</span><br><span class=\"line\"><span class=\"comment\">#[option]</span></span><br><span class=\"line\">-a <span class=\"comment\">#用于传递模块所需要使用的参数 -a \"src=/etc/fstab dest=/testdir/ansible/\"表示为fetch模块传入了两个参数</span></span><br><span class=\"line\">-m <span class=\"comment\">#选项用于调用指定的模块，-m fetch\"表示调用fetch模块;</span></span><br><span class=\"line\">-e <span class=\"comment\">#指定参数变量以供模块使用</span></span><br></pre></td></tr></table></figure><br><br></p>\n<p>补充命令1：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-doc  <span class=\"comment\">#模板帮助以及模块命令作用查看</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#参数</span></span><br><span class=\"line\">-l,--list 模块简介与全部模块</span><br><span class=\"line\">-s 模块详情</span><br></pre></td></tr></table></figure><br><br></p>\n<p>补充命令2：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-playbook <span class=\"comment\">#运行剧本配置文件脚本</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#参数</span></span><br><span class=\"line\">--syntax-check <span class=\"comment\">#语法验证 </span></span><br><span class=\"line\">--check   <span class=\"comment\">#模拟验证执行 </span></span><br><span class=\"line\">--list-tags <span class=\"comment\">#概览一下playbook中都有哪些标签</span></span><br><span class=\"line\">--tags [tagname]  <span class=\"comment\">#指定执行tagname的任务</span></span><br><span class=\"line\">--skip-tags [tagname]  <span class=\"comment\">#跳过执行tagname的任务而执行其他任务;</span></span><br><span class=\"line\">-e,--extra-vars           <span class=\"comment\">#指定在play中使用的变量传入多/单个变量,还可以通过json字符串形式传入;</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>命令示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#ansible-playbook进行yml配置语法检查</span></span><br><span class=\"line\">ansible-playbook --syntax-check test.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#ansible-playbook进行yml配置模拟执行</span></span><br><span class=\"line\">ansible-playbook --check test.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#只有标签对应的任务会被执行，其他任务都不会被执行</span></span><br><span class=\"line\">ansible-playbook --tags task1 test.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#指定\"不执行的任务\",task1标签的任务将不被执行</span></span><br><span class=\"line\">ansible-playbook --skip-tags task1 test.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#指定在play中使用的变量(传入单个变量 / diphenhydramine变量)</span></span><br><span class=\"line\">ansible-playbook cmdvar.yml --extra-vars <span class=\"string\">\"pass_var=cmdline pass var\"</span></span><br><span class=\"line\">ansible-playbook cmdvar.yml -e <span class=\"string\">'pass_var=\"test\"  pass_var1=\"test1\"'</span></span><br><span class=\"line\">ansible-playbook cmdvar.yml -e <span class=\"string\">'&#123;\"testvar\":\"test\",\"testvar1\":\"test1\"&#125;'</span></span><br><span class=\"line\">ansible-playbook cmdvar.yml -e <span class=\"string\">'&#123;\"countlist\":[\"one\",\"two\",\"three\",\"four\"]&#125;'</span> <span class=\"comment\">#获取值使用如下两种语法引用变量 &#123;&#123;countlist[0]&#125;&#125; 或者 &#123;&#123;countlist.0&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n\n<h4 id=\"0x02-Ansible模块基础使用\"><a href=\"#0x02-Ansible模块基础使用\" class=\"headerlink\" title=\"0x02 Ansible模块基础使用\"></a>0x02 Ansible模块基础使用</h4><p>当我们使用ansible完成实际任务时，需要依靠ansible的各个模块，比如前的ping模块<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#ping模块使用</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span> all -m ping</span><br><span class=\"line\"></span><br><span class=\"line\">ansible-doc -l <span class=\"comment\">#获取到的模块信息比较概括(查看absible当前所有模块)</span></span><br><span class=\"line\">ansible-doc -s ping <span class=\"comment\">#ping模块的详细使用</span></span><br><span class=\"line\">ansible-doc -s fetch <span class=\"comment\">#我们需要将受管主机中的文件拉取到ansible主机时则可以使用此模块</span></span><br></pre></td></tr></table></figure></p>\n<p>比如：查看fetch模块的使用帮助<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ansible-doc -s fetch</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">Fetch</span> <span class=\"string\">files</span> <span class=\"string\">from</span> <span class=\"string\">remote</span> <span class=\"string\">nodes</span></span><br><span class=\"line\"><span class=\"attr\">  fetch:</span></span><br><span class=\"line\"><span class=\"attr\">      dest:</span>  <span class=\"comment\"># (required - 必须参数) 指定存入到ansible主机上文件路径</span></span><br><span class=\"line\"><span class=\"attr\">      src:</span>   <span class=\"comment\"># (required - 必须参数) 指定远程主机文件路径</span></span><br><span class=\"line\"><span class=\"attr\">      validate_checksum:</span> <span class=\"comment\">#Verify checksums</span></span><br><span class=\"line\"><span class=\"attr\">      fail_on_missing:</span> <span class=\"comment\">#默认yes,只有再文件不存在的时候失败</span></span><br><span class=\"line\"><span class=\"attr\">      flat:</span>  <span class=\"comment\">#文件重写覆盖</span></span><br></pre></td></tr></table></figure></p>\n<p>基础示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#主机清单-yaml文件</span></span><br><span class=\"line\">all:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">    <span class=\"built_in\">local</span>:</span><br><span class=\"line\">      ansible_host: 10.10.107.222</span><br><span class=\"line\">      ansible_user: root</span><br><span class=\"line\">      ansible_ssh_pass: root@2019</span><br><span class=\"line\">  children:</span><br><span class=\"line\">    ops:</span><br><span class=\"line\">      children:</span><br><span class=\"line\">        testA:</span><br><span class=\"line\">          hosts:</span><br><span class=\"line\">            10.10.107.221</span><br><span class=\"line\">        testB:</span><br><span class=\"line\">          hosts:</span><br><span class=\"line\">            10.20.172.179</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例：拉取ops组中所有主机的/etc/fstab文件拉取到本地</span></span><br><span class=\"line\">ansible ops -m fetch -a <span class=\"string\">\"src=/etc/fstab dest=/tmp/ansible/\"</span>  <span class=\"comment\">#初次拉取</span></span><br><span class=\"line\"><span class=\"comment\">#黄色提示，并且发生改变</span></span><br><span class=\"line\">10.10.107.221 | CHANGED =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">true</span>,  <span class=\"comment\">#关键点</span></span><br><span class=\"line\">    <span class=\"string\">\"checksum\"</span>: <span class=\"string\">\"2b8323413e9c5a3067f61c27ca5ea21378bae582\"</span>,  <span class=\"comment\">#远程MD5校验</span></span><br><span class=\"line\">    <span class=\"string\">\"dest\"</span>: <span class=\"string\">\"/tmp/ansible/10.10.107.221/etc/fstab\"</span>,  <span class=\"comment\">#(会以主机名称建立文件夹，然后再存入)</span></span><br><span class=\"line\">    <span class=\"string\">\"md5sum\"</span>: <span class=\"string\">\"edf31ba4fd10068f6310f4343855af89\"</span>,  <span class=\"comment\">#本地MD5</span></span><br><span class=\"line\">    <span class=\"string\">\"remote_checksum\"</span>: <span class=\"string\">\"2b8323413e9c5a3067f61c27ca5ea21378bae582\"</span>,  <span class=\"comment\">#远程MD5校验</span></span><br><span class=\"line\">    <span class=\"string\">\"remote_md5sum\"</span>: null</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190724154311.png\" alt=\"WeiyiGeek.fetch\" title=\"\" class=\"\">\n                <p>WeiyiGeek.fetch</p>\n            </figure></p>\n<p><strong>返回提示颜色来看幂等性</strong></p>\n<ul>\n<li>当返回信息为绿色时，”changed”为false，表示ansible没有进行任何操作，没有”改变什么”。</li>\n<li>当返回信息为黄色时，”changed”为true，表示ansible执行了操作，”当前状态”已经被ansible改变成了”目标状态”。</li>\n</ul>\n<p>比如:这时候我把10.10.107.221的fstab进行更改<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\" \"</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#再次进行文件拉取查看效果</span></span><br><span class=\"line\">10.10.107.221 | CHANGED =&gt; &#123;  <span class=\"comment\">#对比点</span></span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">true</span>,  <span class=\"comment\">#对比点 (Yellow)</span></span><br><span class=\"line\">    <span class=\"string\">\"checksum\"</span>: <span class=\"string\">\"e0719b31dd9445c5da3dd5e04f13ed44855aacd0\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"dest\"</span>: <span class=\"string\">\"/tmp/ansible/10.10.107.221/etc/fstab\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"md5sum\"</span>: <span class=\"string\">\"631e37410fac691ead3c90e6938494ef\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"remote_checksum\"</span>: <span class=\"string\">\"e0719b31dd9445c5da3dd5e04f13ed44855aacd0\"</span>,  <span class=\"comment\">#比对点</span></span><br><span class=\"line\">    <span class=\"string\">\"remote_md5sum\"</span>: null</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">10.20.172.179 | SUCCESS =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">\"changed\"</span>: <span class=\"literal\">false</span>, <span class=\"comment\"># 由于终端的问题我是白色的(Green)</span></span><br><span class=\"line\">    <span class=\"string\">\"checksum\"</span>: <span class=\"string\">\"39ffc633a100c2b2d06a3d9d0e625dff1ca7043c\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"dest\"</span>: <span class=\"string\">\"/tmp/ansible/10.20.172.179/etc/fstab\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"file\"</span>: <span class=\"string\">\"/etc/fstab\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"md5sum\"</span>: <span class=\"string\">\"c63b434a7a09baea8b7b59fce8cb807b\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190724154958.png\" alt=\"WeiyiGeek.幂等性差别\" title=\"\" class=\"\">\n                <p>WeiyiGeek.幂等性差别</p>\n            </figure></p>\n<p>_总结_：</p>\n<ul>\n<li>注释中包含 “required” 字样则表示使用模块中的参数必须要设置;</li>\n<li>注意幂等性的区别点,以及yaml配置受管主机清单</li>\n</ul>\n<hr>\n\n<h4 id=\"0x03-PlayBook-剧本\"><a href=\"#0x03-PlayBook-剧本\" class=\"headerlink\" title=\"0x03 PlayBook(剧本)\"></a>0x03 PlayBook(剧本)</h4><p>描述：将我们前面所学到的模块的知识点应用到工作场景,进一步理解与使用ansible</p>\n<h5 id=\"剧本yml语法\"><a href=\"#剧本yml语法\" class=\"headerlink\" title=\"剧本yml语法\"></a>剧本yml语法</h5><p>假设，我们想要在test70主机上安装nginx并启动，我们可以在ansible主机中执行如下3条命令<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#确定YUM源 使用yum模块安装nginx 返回再启动nginx服务</span></span><br><span class=\"line\">ansible test70 -m yum_repository -a <span class=\"string\">'name=aliEpel description=\"alibaba EPEL\" baseurl=https://mirrors.aliyun.com/epel/$releasever\\Server/$basearch/'</span></span><br><span class=\"line\">ansible test70 -m yum -a <span class=\"string\">'name=nginx disable_gpg_check=yes enablerepo=aliEpel'</span></span><br><span class=\"line\">ansible test70 -m service -a <span class=\"string\">\"name=nginx state=started\"</span></span><br></pre></td></tr></table></figure></p>\n<p><em>但是在实际的工作环境中我们可能需要经常在新主机上安装nginx，难道每次有新的服务器加入工作环境，我们都要修改上述3条命令中的主机名并且重新将每一条命令执行一遍吗？</em></p>\n<p>这样似乎有些麻烦，肯定有更好的办法，没错我们可以将上述命令写成脚本，每次修改一些变量然后执行脚本就行了，而ansible天生就<code>提供了这种类似&quot;脚本&quot;的功能</code>，在ansible中类似”脚本”的文件被称作”剧本”，’剧本’的英文名称为’playbook’，我们只需要将要做的事情编写成playbook，把不同的模块按照顺序编排在剧本中，ansible就会按照剧本一步一步的执行，最终达到我们的目的，虽然playbook的功能与脚本类似，但是<code>剧本并不是简单的将ad-hoc命令按照顺序堆砌在一个可执行文件中，编写剧本需要遵循YAML语法</code>;</p>\n<p>一个’playbook’是由一个或多个’play’组成的，这样说可能不太容易理解，那么我们打个比方，<code>一个&#39;剧本&#39;是由一个或多个&#39;桥段&#39;组成的，每个桥段都有不同的场景、人物、故事</code>，所有的桥段组合在一起，组成一个完整的剧本，剧本就是playbook桥段就是play;当然’桥段’只是我自己为了方便理解给’play’起的中文名，官方名称只叫\\”play\\”。</p>\n<p><br></p>\n<p><strong>剧本初识-单个play</strong><br>首先，我们需要创建一个YAML格式的playbook文件,playbook文件以”.yaml”或者”.yml”作为文件名后缀，此处我们创建一个名为”test.yml”的剧本文件。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#比如：对本地主机采用ping模块,然后采用file模块再主机上创建目录;</span></span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m ping</span><br><span class=\"line\">ansible <span class=\"built_in\">local</span> -m file -a <span class=\"string\">\"path=/testdir/test state=directory\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#yaml配置文件写法 test.yml</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: <span class=\"built_in\">local</span>,testA</span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\">  tasks: </span><br><span class=\"line\">  - name: ping The host</span><br><span class=\"line\">    ping: </span><br><span class=\"line\">  - name: make directory <span class=\"built_in\">test</span></span><br><span class=\"line\">    file: </span><br><span class=\"line\">      path: /tmp/ansible-playbook</span><br><span class=\"line\">      state: directory</span><br></pre></td></tr></table></figure></p>\n<p>yml配置文件解析：</p>\n<ul>\n<li>第一行：<code>---</code>表示yml文档的开始</li>\n<li>第二行：<code>-</code> 作为开头表示一个块序列的节点;host关键字指定要操作的主机或者组，多台主机或者组采用<code>,</code>分割</li>\n<li>第三行：remote_user关键字与hosts关键字对齐表示它们是平级的，使用remote_user关键字可以指定在进行远程操作时使用哪个用户进行操作</li>\n<li>第四行：使用tasks关键字指明要进行操作的任务列表之后的行都属于tasks键值对中的值；整个任务列表一共有两个任务组成，每个任务都以\\”- \\”开头，每个任务都有自己的名字，任务名使用name关键字进行指定<ul>\n<li>第一个任务使用ping模块，使用ping模块时没有指定任何参数。</li>\n<li>第二个任务使用file模块，使用file模块时，指定了path参数与state参数的值。</li>\n</ul>\n</li>\n</ul>\n<p>采用<code>&#39;ansible-playbook&#39;命令</code>测试运行剧本(脚本):<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># ansible-playbook test.yml</span></span><br></pre></td></tr></table></figure><br>playbook执行后返回了一些信息，这些信息是这次剧本运行的概况:<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729094942.png\" alt=\"WeiyiGeek.playbook\" title=\"\" class=\"\">\n                <p>WeiyiGeek.playbook</p>\n            </figure></p>\n<ul>\n<li>‘make directory ansible-playbook’任务返回的信息是绿色的，如果对应的目录并不存在</li>\n<li>‘make directory ansible-playbook’任务返回的信息应该是<code>黄色的</code>，这是因为幂等性的缘故,比如这次local主机</li>\n</ul>\n<p><em>我们在playbook中明明只写了两个任务，为什么最后执行时却有三个任务呢？</em><br>答:因为每个play在执行时都会先执行一个默认任务，’Gathering Facts’任务会收集当前play对应的目标主机的相关信息，收集完这些基础信息后才会执行我们指定的任务，</p>\n<p><em>补充说明</em>：</p>\n<ul>\n<li>脚本语法验证</li>\n<li>脚本模拟执行 : 我们并不能完全以’模拟’的反馈结果作为playbook是否能够正常运行的判断依据，只能通过’模拟’大概的’预估’一下而已<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ansible</span>-playbook --syntax-check test.yml <span class=\"comment\">#语法</span></span><br><span class=\"line\"><span class=\"variable\">$ansible</span>-playbook --syntax-check demo.yml <span class=\"comment\">#语法</span></span><br><span class=\"line\">playbook: demo.yml  <span class=\"comment\">#说明没问题</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$ansible</span>-playbook --check test.yml  <span class=\"comment\">#验证</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729105928.png\" alt=\"WeiyiGeek.playbook--check\" title=\"\" class=\"\">\n                <p>WeiyiGeek.playbook--check</p>\n            </figure>\n</li>\n</ul>\n<p><br></p>\n<p><strong>剧本初识-多个play</strong><br>比如我们把上面的主机或者组分别分成两个不同的场景：对于Local主机模块是不变化的，对于主机组B采用file模块以及user模块来创建文件和建立用户<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">demo.yml</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">ping</span> <span class=\"string\">The</span> <span class=\"string\">host</span></span><br><span class=\"line\"><span class=\"attr\">    ping:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">make</span> <span class=\"string\">directory</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> </span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/tmp/ansible-playbook</span></span><br><span class=\"line\"><span class=\"attr\">      state:</span> <span class=\"string\">directory</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">testB</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">touch</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/tmp/file.txt</span></span><br><span class=\"line\"><span class=\"attr\">      state:</span> <span class=\"string\">touch</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">create</span> <span class=\"string\">user</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">demo</span></span><br><span class=\"line\"><span class=\"attr\">      password:</span> <span class=\"string\">\"$6$ygRbo7Fj.mMU2KY0$OEqihCCn5UfOsvMyzPNPBgx3bzAtwrOFyFvacgUmA374XOAEtUCrdjbW5Ip.Zqo491o3kD5I.HaC9nLhh6x741\"</span></span><br><span class=\"line\"><span class=\"attr\">      uid:</span> <span class=\"number\">1024</span></span><br><span class=\"line\"><span class=\"attr\">      mode:</span> <span class=\"number\">0700</span></span><br></pre></td></tr></table></figure><br>脚本(剧本执行):<code>ansible-playbook demo.yml</code>,执行后的结果验证：</p>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729100309.png\" alt=\"WeiyiGeek.playbookdemo.yml\" title=\"\" class=\"\">\n                <p>WeiyiGeek.playbookdemo.yml</p>\n            </figure>\n<p>其他yml配置文件形式说明:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#形式1：使用了\"等号\"，每个参数之间使用空格隔开这种格式也是完全正确的,0.8版本以后的ansible推荐的书写格式</span></span><br><span class=\"line\">tasks:</span><br><span class=\"line\">- name: make testfile</span><br><span class=\"line\">  file: path=/testdir/testfile state=touch mode=0700</span><br><span class=\"line\">- name: make testfile</span><br><span class=\"line\">  file: path=/testdir/testfile  <span class=\"comment\">#即使把多个参数分行写，也需要注意缩进</span></span><br><span class=\"line\">        state=touch mode=0700</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#形式2：</span></span><br><span class=\"line\"><span class=\"comment\">#在0.8版本之前，使用action关键字调用模块，示例如下(2.8.1向下兼容)：</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- hosts: <span class=\"built_in\">local</span></span><br><span class=\"line\">  remote_user: root</span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">  - name: make file</span><br><span class=\"line\">    action: file path=/tmp/test.yml state=touch mode=0700</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729111106.png\" alt=\"WeiyiGeek.2.8.1向下兼容\" title=\"\" class=\"\">\n                <p>WeiyiGeek.2.8.1向下兼容</p>\n            </figure></p>\n<p>在前面示例中我们对每个任务都指定了对应的名称，即每个task都有对应的name，<code>当我们省略name时，默认以当前任务调用的模块的名称作为任务的名称，不过建议不要省略name</code>，因为当任务存在name时可读性比较高。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#写法一：(推荐方式)</span></span><br><span class=\"line\">tasks:</span><br><span class=\"line\">- name: make testfile</span><br><span class=\"line\">  file: path=/testdir/testfile</span><br><span class=\"line\">        state=touch</span><br><span class=\"line\">        mode=0700</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#写法二：</span></span><br><span class=\"line\">tasks:</span><br><span class=\"line\">- file: path=/testdir/testfile</span><br><span class=\"line\">        state=touch</span><br><span class=\"line\">        mode=0700</span><br><span class=\"line\">  name: make testfile</span><br></pre></td></tr></table></figure><br>各属性顺序虽然没有要求，但是仍然需要严格按照缩进进行对齐。</p>\n<p><br></p>\n<h5 id=\"handlers-用法\"><a href=\"#handlers-用法\" class=\"headerlink\" title=\"handlers 用法\"></a>handlers 用法</h5><p>描述：先来描述一个工作场景当我们修改了某些程序的配置文件以后，有可能需要重启应用程序，以便能够使新的配置生效，<em>那么如果使用playbook来实现这个简单的功能该怎样编写playbook呢？</em></p>\n<p>假设我们想要将nginx中的某个server的端口从8080改成8088，并且在修改配置以后重启nginx，那么我们可以编写如下剧本。<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">test70</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Modify</span> <span class=\"string\">the</span> <span class=\"string\">configuration</span></span><br><span class=\"line\"><span class=\"attr\">    lineinfile:</span></span><br><span class=\"line\">      <span class=\"string\">path=/etc/nginx/conf.d/test.conf</span></span><br><span class=\"line\">      <span class=\"string\">regexp=\"listen(.*)</span> <span class=\"number\">8080</span> <span class=\"string\">(.*)\"</span></span><br><span class=\"line\">      <span class=\"string\">line=\"listen\\1</span> <span class=\"number\">8088</span> <span class=\"string\">\\2\"</span></span><br><span class=\"line\">      <span class=\"string\">backrefs=yes</span></span><br><span class=\"line\">      <span class=\"string\">backup=yes</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">restart</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">    service:</span></span><br><span class=\"line\">      <span class=\"string\">name=nginx</span></span><br><span class=\"line\">      <span class=\"string\">state=restarted</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729112518.png\" alt=\"WeiyiGeek.restarnginx\" title=\"\" class=\"\">\n                <p>WeiyiGeek.restarnginx</p>\n            </figure><br><br></p>\n<p><em>那么问题来了</em>？</p>\n<ul>\n<li>第一次执行修改后重新是没有什么问题,但是在第二/n次运行时候会进行行替换匹配而不发生改变(由于幂等性),而是有一次执行了restart来重启了nginx服务;简单的说就是配置未发生任何变化却进行了服务重启;</li>\n</ul>\n<p><em>解决问题的方法：采用 handlers 方法</em></p>\n<ul>\n<li>handlers的概念：你可以把handlers理解成另一种tasks（平级），handlers是另一种’任务列表’，handlers中的任务会被tasks中的任务进行\\”调用\\”，但是被\\”调用\\”并不意味着一定会执行，<code>只有当tasks中的任务&quot;真正执行&quot;以后（真正的进行实际操作，造成了实际的改变）</code>，handlers中被调用的任务才会执行，如果tasks中的任务并没有做出任何实际的操作，那么handlers中的任务即使被’调用’，也并不会执行。</li>\n</ul>\n<p>handlers示例：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">test70</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Modify</span> <span class=\"string\">the</span> <span class=\"string\">configuration</span></span><br><span class=\"line\"><span class=\"attr\">    lineinfile:</span></span><br><span class=\"line\">      <span class=\"string\">path=/etc/nginx/conf.d/test.conf</span></span><br><span class=\"line\">      <span class=\"string\">regexp=\"listen(.*)</span> <span class=\"number\">8080</span><span class=\"string\">(.*)\"</span></span><br><span class=\"line\">      <span class=\"string\">line=\"listen\\1</span> <span class=\"number\">8088</span><span class=\"string\">\\2\"</span></span><br><span class=\"line\">      <span class=\"string\">backrefs=yes</span></span><br><span class=\"line\">      <span class=\"string\">backup=yes</span></span><br><span class=\"line\"><span class=\"attr\">    notify:</span></span><br><span class=\"line\">      <span class=\"string\">restart</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#我们使用notify关键字'调用'handlers中的任务，或者说通过notify关键字'通知'handlers中的任务</span></span><br><span class=\"line\"><span class=\"comment\"># 们使用handlers关键字，指明哪些任务可以被'调用',与tasks是平级的状态</span></span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">restart</span> <span class=\"string\">nginx</span>  <span class=\"comment\">#任务的名称为\"restart nginx\"</span></span><br><span class=\"line\"><span class=\"attr\">    service:</span></span><br><span class=\"line\">      <span class=\"string\">name=nginx</span></span><br><span class=\"line\">      <span class=\"string\">state=restarted</span></span><br></pre></td></tr></table></figure><br>所以综上所述上例中的play表示，如果<code>&quot;Modify the configuration&quot;</code>真正的修改了配置文件（实际的操作），那么则执行<code>&quot;restart nginx&quot;任务</code>，如果<code>&quot;Modify the configuration&quot;</code>并没有进行任何实际的改动，<code>则不执行&quot;restart nginx&quot;</code>通常来说，任务执行后如果做出了实际的操作，任务执行后的状态为changed则会执行对应的handlers，</p>\n<p>handlers是另一种任务列表并且可以有多个任务，被tasks中不同的任务notify，</p>\n<ul>\n<li>默认情况下所有task执行完毕后才会执行各个handler，<code>并不是执行完某个task后，立即执行对应的handler</code></li>\n<li>如果你想要在执行完某些task以后立即执行对应的handler，则需要使用meta模块</li>\n</ul>\n<p>示例如下：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">make</span> <span class=\"string\">testfile1</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/testfile1</span></span><br><span class=\"line\">          <span class=\"string\">state=directory</span></span><br><span class=\"line\"><span class=\"attr\">    notify:</span> <span class=\"string\">ht2</span>  <span class=\"comment\">#调用handlers中的ht2的任务</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">make</span> <span class=\"string\">testfile2</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/testfile2</span></span><br><span class=\"line\">          <span class=\"string\">state=directory</span></span><br><span class=\"line\"><span class=\"attr\">    notify:</span> <span class=\"string\">ht1</span>  <span class=\"comment\">#调用handlers中的ht1的任务</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"attr\">  - meta:</span> <span class=\"string\">flush_handlers</span>  <span class=\"comment\">#设置在执行完前面某些task以后立即执行调用对应的handler</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">task3</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/testfile3</span></span><br><span class=\"line\">          <span class=\"string\">state=directory</span></span><br><span class=\"line\"><span class=\"attr\">    notify:</span> <span class=\"string\">ht3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">ht1</span>  <span class=\"comment\">#设置handlers任务名称(当tasks任务执行时候才出否)</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/testfile1/ht1</span></span><br><span class=\"line\">          <span class=\"string\">state=touch</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">ht2</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/testfile2/ht2</span></span><br><span class=\"line\">          <span class=\"string\">state=touch</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">ht3</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/testfile3/ht3</span></span><br><span class=\"line\">          <span class=\"string\">state=touch</span>     </span><br><span class=\"line\">          </span><br><span class=\"line\"><span class=\"comment\">#执行流程如下：</span></span><br><span class=\"line\"><span class=\"string\">PLAY</span> <span class=\"string\">[local]</span> </span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[Gathering</span> <span class=\"string\">Facts]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[make</span> <span class=\"string\">testfile1]</span> </span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[make</span> <span class=\"string\">testfile2]</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">RUNNING</span> <span class=\"string\">HANDLER</span> <span class=\"string\">[ht1]</span> </span><br><span class=\"line\"><span class=\"string\">RUNNING</span> <span class=\"string\">HANDLER</span> <span class=\"string\">[ht2]</span> </span><br><span class=\"line\"><span class=\"comment\">#由于这里采用meta模块会把上面tasks中notify调用完成后执行，下面的tasks任务</span></span><br><span class=\"line\"><span class=\"string\">TASK</span> <span class=\"string\">[task3]</span> </span><br><span class=\"line\"><span class=\"string\">RUNNING</span> <span class=\"string\">HANDLER</span> <span class=\"string\">[ht3]</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">PLAY</span> <span class=\"string\">RECAP</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729123011.png\" alt=\"WeiyiGeek.meta模块与handler\" title=\"\" class=\"\">\n                <p>WeiyiGeek.meta模块与handler</p>\n            </figure></p>\n<p>在一个task中一次性notify多个handler,<code>当多个handler的name相同时只有一个handler会被执行</code>，所以我们并不能通过这种方式notify多个handler，</p>\n<p>如果想要一次notify多个handler就需要设置组名来进行handlers多任务的调用，则需要<code>借助另一个关键字它就是&#39;listen&#39;理解成&quot;组名&quot;，我们可以把多个handler分成&quot;组&quot;</code>，当我们需要一次性notify多个handler时，只要将多个handler分为”一组”，使用相同的”组名”即可，<code>当notify对应的值&quot;组名&quot;时，&quot;组&quot;内的所有handler都会被notify</code></p>\n<p>一个notify调用多个handler中的任务:<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">test70</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">task1</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/test</span></span><br><span class=\"line\">          <span class=\"string\">state=directory</span></span><br><span class=\"line\"><span class=\"attr\">    notify:</span> <span class=\"string\">handler</span> <span class=\"string\">group1</span>  <span class=\"comment\">#关键点 当task1中notify的值为handler group1时，handler1与handler2都会被notify</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#andler1与handler2的listen的值都是handler group1</span></span><br><span class=\"line\"><span class=\"attr\">  handlers:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">handler1</span></span><br><span class=\"line\"><span class=\"attr\">    listen:</span> <span class=\"string\">handler</span> <span class=\"string\">group1</span>  <span class=\"comment\">#关键点(监听组)</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/test/ht1</span></span><br><span class=\"line\">          <span class=\"string\">state=touch</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">handler2</span></span><br><span class=\"line\"><span class=\"attr\">    listen:</span> <span class=\"string\">handler</span> <span class=\"string\">group1</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/test/ht2</span></span><br><span class=\"line\">          <span class=\"string\">state=touch</span></span><br></pre></td></tr></table></figure><br>监测与执行：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ansible</span>-playbook --syntax-check notify.yml</span><br><span class=\"line\">playbook: notify.yml</span><br><span class=\"line\"></span><br><span class=\"line\">ansible-playbook notify.yml</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729124615.png\" alt=\"WeiyiGeek.notify-nutil-handlers\" title=\"\" class=\"\">\n                <p>WeiyiGeek.notify-nutil-handlers</p>\n            </figure></p>\n<p><br></p>\n<p><em>handler总结</em>：</p>\n<ul>\n<li>handler执行的顺序与handler在playbook中定义的顺序是相同的，与”handler被notify”的顺序无关。</li>\n<li>可以使用meta模块来执行完某些task以后立即执行对应的handler;如果想要每个task在实际操作后都立马执行对应handlers，则可以在每个任务之后都添加一个meta任务并将其值设置为flush_handlers </li>\n<li>采用tasks默认都notify只能调用一个handlers任务,如果想调用多个handlers任务就采用listen关键字来设置监听组</li>\n</ul>\n<p><br></p>\n<h5 id=\"tags-用法\"><a href=\"#tags-用法\" class=\"headerlink\" title=\"tags 用法\"></a>tags 用法</h5><p>描述：<br>在实际使用这个剧本时你可能只是想要执行其中的一部分任务而已，或者你只想要执行其中一类任务而已，而并非想要执行整个剧本中的全部任务</p>\n<p><em>这个时候我们该怎么办呢？</em><br>答：可以借助tags实现这个需求,见名知义<code>tags可以帮助我们对任务进行&#39;打标签&#39;的操作</code>，当任务存在标签以后，我们就可以在执行playbook时，<code>借助标签指定执行哪些任务，或者指定不执行哪些任务了</code>;</p>\n<p>示例：play中有3个task每个task都有对应的tags，我只是简单的把tags的值写成了t1、t2、t3当然您也可以定义成为其他;<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">task1</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/tmp/t1</span></span><br><span class=\"line\"><span class=\"attr\">      state:</span> <span class=\"string\">touch</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">t1</span>   <span class=\"comment\">#标签1 - 执行task1任务</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">task2</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/t2</span></span><br><span class=\"line\">          <span class=\"string\">state=touch</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">t2</span>   <span class=\"comment\">#标签2 - 执行task2任务</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">task3</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span> <span class=\"string\">path=/tmp/t3</span></span><br><span class=\"line\">          <span class=\"string\">state=touch</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">t3</span>   <span class=\"comment\">#标签3 - 执行task3任务</span></span><br></pre></td></tr></table></figure><br>下面利用ansible-playbook中<code>--tags选项</code>以及<code>--skip-tags选项</code>来执行指定的task任务以及跳过任务执行：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例0.在调用标签之前，如果你想要概览一下playbook中都有哪些标签</span></span><br><span class=\"line\">ansible-playbook --list-tags testhttpd.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例1.只执行标签为t2的task2任务,只有标签对应的任务会被执行，其他任务都不会被执行，</span></span><br><span class=\"line\">ansible-playbook --tags=t2 testtag.yml</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2.选项指定\"不执行的任务\"，比如下面的命令task1和task3会执行跳过了task2不会执行，</span></span><br><span class=\"line\">ansible-playbook --skip-tags=<span class=\"string\">'t2'</span> testtag.yml</span><br></pre></td></tr></table></figure></p>\n<p>除了使用上例中的语法指定标签，我们可以为每个任务添加多个标签三种语法添加多个标签的示例：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#语法一：</span></span><br><span class=\"line\">tags:</span><br><span class=\"line\"> - testtag</span><br><span class=\"line\"> - t1</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#语法二：</span></span><br><span class=\"line\">tags: tag1,tag2</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#语法三：</span></span><br><span class=\"line\">tags: [<span class=\"string\">'tagtest'</span>,<span class=\"string\">'t2'</span>]</span><br></pre></td></tr></table></figure><br><br></p>\n<p>将上面所学知识的进行综合演示，实现标签的常规用法,当拥有共同的标签时候将主tags标签提取出来与tasks同级，还可以在tasks里面建立子标签：<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span> <span class=\"string\">command</span>  <span class=\"comment\">#关键点-形式0</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">show</span> <span class=\"string\">ip</span> <span class=\"string\">address</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">['ip']</span>  <span class=\"comment\">#关键点-形式1</span></span><br><span class=\"line\"><span class=\"attr\">    shell:</span> <span class=\"string\">ifconfig</span> <span class=\"string\">&gt; /tmp/ipaddr.txt   #值得注意(shell模块在play中的使用)</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">  - name:</span> <span class=\"string\">mkdir</span> <span class=\"string\">directory</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> </span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">createdir</span>  <span class=\"comment\">#关键点-形式2</span></span><br><span class=\"line\"><span class=\"attr\">    file:</span></span><br><span class=\"line\"><span class=\"attr\">      path:</span> <span class=\"string\">/tmp/createdir</span></span><br><span class=\"line\"><span class=\"attr\">      state:</span> <span class=\"string\">directory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- hosts:</span> <span class=\"string\">testA</span></span><br><span class=\"line\"><span class=\"attr\">  remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"attr\">  tags:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">  tasks:</span> </span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">install</span> <span class=\"string\">nginx</span> <span class=\"string\">package</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">['package']</span></span><br><span class=\"line\"><span class=\"attr\">    yum:</span> <span class=\"string\">name=httpd</span> <span class=\"string\">state=latest</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">start</span> <span class=\"string\">up</span> <span class=\"string\">nginx</span> <span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> </span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">startservices</span></span><br><span class=\"line\"><span class=\"attr\">    service:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">      state:</span> <span class=\"string\">started</span></span><br></pre></td></tr></table></figure><br>当tags写在play中而非task中时，play中的所有task会继承当前play中的tags，而上例中<code>两个任务都会继承httpd标签，同时还有拥有自己的标签</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#示例1.概览一下playbook的yml脚本中都有哪些标签</span></span><br><span class=\"line\">ansible-playbook --list-tags tag.yml</span><br><span class=\"line\">playbook: tag.yml</span><br><span class=\"line\">  play <span class=\"comment\">#1 (local): local        TAGS: [command]</span></span><br><span class=\"line\">      TASK TAGS: [<span class=\"built_in\">command</span>, createdir, ip]</span><br><span class=\"line\"></span><br><span class=\"line\">  play <span class=\"comment\">#2 (testA): testA        TAGS: [nginx]</span></span><br><span class=\"line\">      TASK TAGS: [nginx, package, startservices]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#示例2.在调用标签时，也可以一次性指定多个标签来调用多个标签需要用逗号隔开</span></span><br><span class=\"line\"><span class=\"comment\">#play执行顺序默认是从下到下执行</span></span><br><span class=\"line\">ansible-playbook --tags package,startservices testhttpd.yml</span><br><span class=\"line\">ansible-playbook --tags <span class=\"built_in\">command</span>,nginx tag.yml</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20190729152819.png\" alt=\"WeiyiGeek.tags-demo\" title=\"\" class=\"\">\n                <p>WeiyiGeek.tags-demo</p>\n            </figure>\n<p><br></p>\n<p>ansible特殊预置5个tag：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#标签示例</span></span><br><span class=\"line\">tags: t3,always,nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#--------------------分割线--------------------</span></span><br><span class=\"line\">* always ： 把任务的tags的值指定为always时任务就总是会被执行，除非你使用<span class=\"string\">'--skip-tags'</span>选项明确指定不执行对应的任务</span><br><span class=\"line\">ansible-playbook --skip-tags always testtag.yml <span class=\"comment\">#只有这样才能跳过执行,如果play中有多个任务都有always标签将都不会被执行;</span></span><br><span class=\"line\"></span><br><span class=\"line\">ansible-playbook --skip-tags t3 testtag.yml <span class=\"comment\">#另外一种情况;只跳过task3其他带有always标签的任务不会跳过，前提是task3有除了always以外的自定义标签比如这里的t3。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#--------------------分割线--------------------</span></span><br><span class=\"line\">* never(2.5版本中新加入的特殊tag): 从字面上理解never的作用应该与always正好相反</span><br><span class=\"line\">ansible-playbook --tags never testtag.yml   <span class=\"comment\">#指定才会被执行</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#--------------------分割线--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#剩下的三个特殊标签并非像always一样always作为标签值存在，而这三个特殊标签则是在调用标签时使用</span></span><br><span class=\"line\">* tagged</span><br><span class=\"line\">ansible-playbook --tags tagged testtag.yml  <span class=\"comment\">#只执行有标签的任务，没有任何标签的任务不会被执行</span></span><br><span class=\"line\">ansible-playbook --skip-tags tagged testtag.yml <span class=\"comment\">#表示跳过包含标签的任务，即使对应的任务包含always标签，也会被跳过。</span></span><br><span class=\"line\"></span><br><span class=\"line\">* untagged</span><br><span class=\"line\">ansible-playbook --tags untagged testtag.yml  <span class=\"comment\">#只执行没有标签的任务，但是如果某些任务包含always标签，那么这些任务也会被执行。</span></span><br><span class=\"line\">ansible-playbook --skip-tags untagged testtag.yml <span class=\"comment\">#表示跳过没有标签的任务。</span></span><br><span class=\"line\"></span><br><span class=\"line\">* all: 表示所有任务会被执行，不用指定，默认情况下就是使用这个标签。</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"自动化运维","path":"api/categories/自动化运维.json"},{"name":"运维基础","path":"api/categories/运维基础.json"}],"tags":[{"name":"Ansible","path":"api/tags/Ansible.json"}]}