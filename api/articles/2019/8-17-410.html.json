{"title":"PhpStudy之PHP调试环境集成包漏洞集","slug":"网安大类/Vulnerable/Appllication/开发工具/PhpStudy之PHP调试环境集成包漏洞集","date":"2019-08-17T05:36:30.000Z","updated":"2023-01-31T02:29:10.673Z","url":"2019/8-17-410.html","path":"api/articles/2019/8-17-410.html.json","covers":["https://img.weiyigeek.top/2020/1/20200903163434.png","https://img.weiyigeek.top/2020/1/20200903174914.png"],"content":"<p><b style=\"color:red\">注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。</b></p>\n<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h4><p>描述:Phpstudy软件是国内的一款免费的PHP调试环境的程序集成包，通过集成Apache、PHP、MySQL、phpMyAdmin、ZendOptimizer多款软件一次性安装，无需配置即可直接安装使用，具有PHP环境调试和PHP开发功能，在国内有着近百万PHP语言学习者、开发者用户。</p>\n<h4 id=\"0x01-BackDoor\"><a href=\"#0x01-BackDoor\" class=\"headerlink\" title=\"0x01 BackDoor\"></a>0x01 BackDoor</h4><h5 id=\"20190920\"><a href=\"#20190920\" class=\"headerlink\" title=\"20190920\"></a>20190920</h5><p>影响版本:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">phpstudy 2016 版 = PHP5.4</span><br><span class=\"line\">phpstudy 2018 版 = php-5.2.17 / php-5.4.45</span><br></pre></td></tr></table></figure></p>\n<p>漏洞分析:<br>通过使用IDA Pro x86分析后门代码存在于<code>\\ext\\php_xmlrpc.dll</code>模块,用记事本打开此文件查找<code>@eval文件</code>存在<code>@eval(%s(&#39;%s&#39;))</code>证明漏洞存在<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># phpStudy 2016 路径</span></span><br><span class=\"line\">php\\php-5.2.17\\ext\\php_xmlrpc.dll</span><br><span class=\"line\">php\\php-5.4.45\\ext\\php_xmlrpc.dll</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># phpStudy 2018 路径</span></span><br><span class=\"line\">PHPTutorial\\php\\php-5.2.17\\ext\\php_xmlrpc.dll</span><br><span class=\"line\">PHPTutorial\\php\\php-5.4.45\\ext\\php_xmlrpc.dll</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 附后门文件MD5值</span></span><br><span class=\"line\">MD5: 0F7AD38E7A9857523DFBCE4BCE43A9E9</span><br><span class=\"line\">MD5: C339482FD2B233FB0A555B629C0EA5D5</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200903163434.png\" alt=\"WeiyiGeek.漏洞\" title=\"\" class=\"\">\n                <p>WeiyiGeek.漏洞</p>\n            </figure>\n<p>漏洞复现:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.通过php.ini配置文件进行取消注释</span></span><br><span class=\"line\">extension=php_xmlrpc.dll</span><br><span class=\"line\">extension_dir=<span class=\"string\">\"c:\\phpstudy\\php\\php-5.4.45\\ext\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.字符串中存在@eval字样拼接了一个 @eval(gzuncompress('%s'));的代码,明显是调用gzuncompress方法解密执行某些代码;</span></span><br><span class=\"line\"><span class=\"comment\"># zend_eval_string处执行v42处执行的代码，我们把数据提取出来，并进行处理，并且经过php的gzuncompress解码得到以下:</span></span><br><span class=\"line\">@ini_set(<span class=\"string\">\"display_errors\"</span>,<span class=\"string\">\"0\"</span>);</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\"><span class=\"variable\">$h</span> = <span class=\"variable\">$_SERVER</span>[<span class=\"string\">'HTTP_HOST'</span>];</span><br><span class=\"line\"><span class=\"variable\">$p</span> = <span class=\"variable\">$_SERVER</span>[<span class=\"string\">'SERVER_PORT'</span>];</span><br><span class=\"line\"><span class=\"variable\">$fp</span> = fsockopen(<span class=\"variable\">$h</span>, <span class=\"variable\">$p</span>, <span class=\"variable\">$errno</span>, <span class=\"variable\">$errstr</span>, 5);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"variable\">$fp</span>) &#123;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"variable\">$out</span> = <span class=\"string\">\"GET &#123;<span class=\"variable\">$_SERVER</span>['SCRIPT_NAME']&#125; HTTP/1.1\\r\\n\"</span>;</span><br><span class=\"line\">    <span class=\"variable\">$out</span> .= <span class=\"string\">\"Host: &#123;<span class=\"variable\">$h</span>&#125;\\r\\n\"</span>;</span><br><span class=\"line\">    <span class=\"variable\">$out</span> .= <span class=\"string\">\"Accept-Encoding: compress,gzip\\r\\n\"</span>;</span><br><span class=\"line\">    <span class=\"variable\">$out</span> .= <span class=\"string\">\"Connection: Close\\r\\n\\r\\n\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    fwrite(<span class=\"variable\">$fp</span>, <span class=\"variable\">$out</span>);</span><br><span class=\"line\">    fclose(<span class=\"variable\">$fp</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 3.burp抓包，构造payload</span></span><br><span class=\"line\"><span class=\"comment\">#注: Accept-Encoding要把gzip, deflate 里逗号后面的空格去掉不然命令执行不成功;</span></span><br><span class=\"line\"><span class=\"comment\">#Accept-Charset 的值就是执行的命令需要进行 base64 编码;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2020/1/20200903174914.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure>\n<p>检测方式:</p>\n<ul>\n<li>Linux<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># check.sh 文件:运行后可以递归检测当前目录下所有dll文件中是否包含木马文件的特征值</span></span><br><span class=\"line\"><span class=\"meta\">#! /bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># author: pcat@chamd5.org</span></span><br><span class=\"line\"><span class=\"comment\"># http://pcat.cc</span></span><br><span class=\"line\"></span><br><span class=\"line\">trojan=@<span class=\"built_in\">eval</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">check_dir</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> file <span class=\"keyword\">in</span> `ls <span class=\"variable\">$1</span>`</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">      f2=<span class=\"variable\">$1</span><span class=\"string\">\"/\"</span><span class=\"variable\">$file</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> [ -d <span class=\"variable\">$f2</span> ];<span class=\"keyword\">then</span></span><br><span class=\"line\">        check_dir <span class=\"variable\">$f2</span></span><br><span class=\"line\">      <span class=\"comment\"># just check dll file</span></span><br><span class=\"line\">      <span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$&#123;file##*.&#125;</span>\"</span>x = <span class=\"string\">\"dll\"</span>x ];<span class=\"keyword\">then</span></span><br><span class=\"line\">          strings <span class=\"variable\">$f2</span> |grep -q <span class=\"variable\">$trojan</span></span><br><span class=\"line\">          <span class=\"keyword\">if</span> [ $? == 0 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">\"===\"</span> <span class=\"variable\">$f2</span> <span class=\"string\">\"====\"</span></span><br><span class=\"line\">            strings <span class=\"variable\">$f2</span> |grep <span class=\"variable\">$trojan</span></span><br><span class=\"line\">          <span class=\"keyword\">fi</span></span><br><span class=\"line\">      <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">done</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># . stand for current directory</span></span><br><span class=\"line\">check_dir .</span><br></pre></td></tr></table></figure></li>\n<li>Windows:<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pcheck.py文件，代码模拟了strings和grep命令</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding:utf8 -*-</span></span><br><span class=\"line\">__author__=<span class=\"string\">'pcat@chamd5.org'</span></span><br><span class=\"line\">__blog__=<span class=\"string\">'http://pcat.cc'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">strings</span><span class=\"params\">(file)</span> :</span></span><br><span class=\"line\">    chars = string.printable[:<span class=\"number\">94</span>]</span><br><span class=\"line\">    shortestReturnChar = <span class=\"number\">4</span></span><br><span class=\"line\">    regExp = <span class=\"string\">'[%s]&#123;%d,&#125;'</span> % (chars, shortestReturnChar)</span><br><span class=\"line\">    pattern = re.compile(regExp)</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(file, <span class=\"string\">'rb'</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pattern.findall(f.read())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">grep</span><span class=\"params\">(lines,pattern)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> lines:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> pattern <span class=\"keyword\">in</span> line:</span><br><span class=\"line\">            <span class=\"keyword\">yield</span> line</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">pcheck</span><span class=\"params\">(filename)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># trojan feature</span></span><br><span class=\"line\">    trojan=<span class=\"string\">'@eval'</span></span><br><span class=\"line\">    <span class=\"comment\"># just check dll file</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> filename.endswith(<span class=\"string\">'.dll'</span>):        </span><br><span class=\"line\">        lines=strings(filename)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            grep(lines,trojan).next()</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\">        <span class=\"keyword\">print</span> <span class=\"string\">'=== &#123;0&#125; ==='</span>.format(filename)</span><br><span class=\"line\">        <span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> grep(lines,trojan):</span><br><span class=\"line\">            <span class=\"keyword\">print</span> line</span><br><span class=\"line\">    <span class=\"keyword\">pass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">foo</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># . stand for current directory</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> path, dirs, files <span class=\"keyword\">in</span> os.walk(<span class=\"string\">\".\"</span>, topdown=<span class=\"literal\">False</span>):</span><br><span class=\"line\">        <span class=\"keyword\">for</span> name <span class=\"keyword\">in</span> files:</span><br><span class=\"line\">            pcheck(os.path.join(path, name))</span><br><span class=\"line\">        <span class=\"keyword\">for</span> name <span class=\"keyword\">in</span> dirs:</span><br><span class=\"line\">            pcheck(os.path.join(path, name))</span><br><span class=\"line\">    <span class=\"keyword\">pass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    foo()</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>修复方法:<br>1) 可以从PHP官网下载原始php-5.4.45版本或php-5.2.17版本，替换其中的php_xmlrpc.dll</p>\n<ul>\n<li><a href=\"https://windows.php.net/downloads/releases/archives/php-5.2.17-Win32-VC6-x86.zip\" target=\"_blank\" rel=\"noopener\">https://windows.php.net/downloads/releases/archives/php-5.2.17-Win32-VC6-x86.zip</a></li>\n<li><a href=\"https://windows.php.net/downloads/releases/archives/php-5.4.45-Win32-VC9-x86.zip\" target=\"_blank\" rel=\"noopener\">https://windows.php.net/downloads/releases/archives/php-5.4.45-Win32-VC9-x86.zip</a><br>2) 目前phpstudy官网上的版本不存在后门，可在phpsudy官网下载安装包进行更新</li>\n</ul>\n","comments":true,"excerpt":"注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。[TOC]","categories":[{"name":"漏洞分析","path":"api/categories/漏洞分析.json"}],"tags":[{"name":"PhpStudy","path":"api/tags/PhpStudy.json"}]}