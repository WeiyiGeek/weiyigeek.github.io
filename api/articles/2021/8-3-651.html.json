{"title":"ElasticStack日志采集监控搭建实践案例","slug":"网安防御/安全建设/日志审计/ElasticStack/ElasticStack日志采集监控搭建实践案例","date":"2021-08-03T01:34:30.000Z","updated":"2022-04-13T02:41:03.690Z","url":"2021/8-3-651.html","path":"api/articles/2021/8-3-651.html.json","covers":["https://www.elastic.co/guide/en/beats/filebeat/current/images/filebeat.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"Beats-收集、解析和发送组件\"><a href=\"#Beats-收集、解析和发送组件\" class=\"headerlink\" title=\"Beats 收集、解析和发送组件\"></a>Beats 收集、解析和发送组件</h2><h3 id=\"winlogbeat-简述与使用\"><a href=\"#winlogbeat-简述与使用\" class=\"headerlink\" title=\"winlogbeat - 简述与使用\"></a>winlogbeat - 简述与使用</h3><p>描述: 我们可以利用 Winlogbeat 来进行 Windows 日志监视，大致流程是在要监视的每个系统上安装Winlogbeat指定日志文件的位置将日志数据解析为字段并发送到Elasticsearch可视化Kibana中的日志数据。</p>\n<p>下载地址: <a href=\"https://www.elastic.co/downloads/beats/winlogbeat\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/downloads/beats/winlogbeat</a><br>帮助文档: <a href=\"https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html</a></p>\n<p>Tips: 你需要进行提前准备Elasticsearch来存储和搜索你的数据和Kibana来可视化和管理它。</p>\n<p><br></p>\n<p><strong>安装流程:</strong></p>\n<ul>\n<li><p>Step 1.从下载页面下载Winlogbeat zip文件,并解压至任意目录此处我解压到<code>d:\\logs\\</code>目录之中然后再重命名<code>winlogbeat-&lt;version&gt;</code>目录为<code>Winlogbeat</code>.</p>\n</li>\n<li><p>Step 2.以管理员身份打开PowerShell提示（右键单击PowerShell图标并选择以管理员身份运行）. 切换路径并运行以下命令安装服务。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS C:\\Users\\Administrator&gt; <span class=\"built_in\">cd</span> <span class=\"string\">'d:\\logs\\Winlogbeat'</span></span><br><span class=\"line\">PS d:\\logs\\Winlogbeat&gt; .\\install-service-winlogbeat.ps1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 如果系统上禁用了脚本执行，则需要为当前会话设置执行策略以允许脚本运行。</span></span><br><span class=\"line\">PowerShell.exe -ExecutionPolicy UnRestricted -File .\\install-service-winlogbeat.ps1.</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 3.在winlogbeat.yml中设置elasticsearch、kibana连接信息</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 需要连接到Elasticsearch和Kibana才能设置Winlogbeat</span></span><br><span class=\"line\"><span class=\"comment\"># - elasticsearch</span></span><br><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\">  hosts: [<span class=\"string\">\"myEShost:9200\"</span>]</span><br><span class=\"line\">  username: <span class=\"string\">\"winlogbeat_internal\"</span></span><br><span class=\"line\">  password: <span class=\"string\">\"YOUR_PASSWORD\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - kibana</span></span><br><span class=\"line\">setup.kibana:</span><br><span class=\"line\">  host: <span class=\"string\">\"mykibanahost:5601\"</span> </span><br><span class=\"line\">  username: <span class=\"string\">\"my_kibana_user\"</span>  </span><br><span class=\"line\">  password: <span class=\"string\">\"&#123;pwd&#125;\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips : 我们可以将敏感值存储在secrets密钥库中<a href=\"https://www.elastic.co/guide/en/beats/winlogbeat/7.13/keystore.html\" target=\"_blank\" rel=\"noopener\">参考地址</a>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Create a keystore</span></span><br><span class=\"line\">winlogbeat keystore create</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Add keys (When prompted enter a value for the key.)</span></span><br><span class=\"line\">winlogbeat keystore add ES_PWD   </span><br><span class=\"line\">winlogbeat keystore add ES_PWD --force  <span class=\"comment\"># To overwrite an existing key’s value</span></span><br><span class=\"line\">cat /file/containing/setting/value | winlogbeat keystore add ES_PWD --stdin --force</span><br><span class=\"line\">  <span class=\"comment\"># Successfully updated the keystore</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># List keysedit</span></span><br><span class=\"line\">winlogbeat keystore list</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Remove keysedit</span></span><br><span class=\"line\">winlogbeat keystore remove ES_PWD</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 例如，假设keystore包含一个名为ES_PWD的密钥，其值为 yourelasticsearchpassword</span></span><br><span class=\"line\">In the configuration file, use output.elasticsearch.password: <span class=\"string\">\"<span class=\"variable\">$&#123;ES_PWD&#125;</span>\"</span></span><br><span class=\"line\">On the <span class=\"built_in\">command</span> line, use: -E <span class=\"string\">\"output.elasticsearch.password=\\$&#123;ES_PWD&#125;\"</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li>Step 4.配置Winlogbeatedit在winlogbeat.yml中配置要监视的事件日志。<br>描述: 在 winlogbeat.event_log下指定要监视的事件日志列表, 默认情况下 Winlogbeat 监视应用程序、安全性和系统日志。<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 1.在winlogbeat.event_log下指定要监视的事件日志列表，默认监控 application, security, and system logs 我们可以根据需要进行添加相应事件</span></span><br><span class=\"line\">winlogbeat.event_logs:</span><br><span class=\"line\">  - name: Application</span><br><span class=\"line\">  - name: Security</span><br><span class=\"line\">  - name: System</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># - 2.(可选)设置日志选项以将Winlogbeat日志写入文件：</span></span><br><span class=\"line\">logging.to_files: <span class=\"literal\">true</span></span><br><span class=\"line\">logging.files:</span><br><span class=\"line\">  path: C:\\ProgramData\\winlogbeat\\Logs</span><br><span class=\"line\">logging.level: info</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Tips: 我们还可获取可用事件日志的列表 <code>Get-EventLog *</code> 命令<br><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Get-EventLog</span> * | <span class=\"built_in\">Select-Object</span> Log,LogDisplayName</span><br><span class=\"line\">  <span class=\"comment\"># Log                    LogDisplayName</span></span><br><span class=\"line\">  <span class=\"comment\"># ---                    --------------</span></span><br><span class=\"line\">  <span class=\"comment\"># Application            应用程序</span></span><br><span class=\"line\">  <span class=\"comment\"># HardwareEvents         硬件事件</span></span><br><span class=\"line\">  <span class=\"comment\"># Internet Explorer      Internet Explorer</span></span><br><span class=\"line\">  <span class=\"comment\"># Key Management Service 密钥管理服务</span></span><br><span class=\"line\">  <span class=\"comment\"># OAlerts                Microsoft Office Alerts</span></span><br><span class=\"line\">  <span class=\"comment\"># Security</span></span><br><span class=\"line\">  <span class=\"comment\"># System                 系统</span></span><br><span class=\"line\">  <span class=\"comment\"># Windows PowerShell     Windows PowerShell</span></span><br></pre></td></tr></table></figure></p>\n<ul>\n<li><p>Step 5.保存配置文件后，使用以下命令对其进行测试,并Winlogbeat加载附带用于解析、索引和可视化数据的预定义资产。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解析验证配置文件</span></span><br><span class=\"line\">PS d:\\logs\\Winlogbeat&gt; .\\winlogbeat.exe <span class=\"built_in\">test</span> config -c .\\winlogbeat.yml -e</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加载推荐的索引模板以写入Elasticsearch，并部署示例仪表板以可视化Kibana中的数据。</span></span><br><span class=\"line\">PS &gt; .\\winlogbeat.exe setup -e</span><br><span class=\"line\">  <span class=\"comment\"># Overwriting ILM policy is disabled. Set `setup.ilm.overwrite: true` for enabling.</span></span><br><span class=\"line\">  <span class=\"comment\"># Index setup finished.</span></span><br><span class=\"line\">  <span class=\"comment\"># Loading dashboards (Kibana must be running and reachable)</span></span><br><span class=\"line\">  <span class=\"comment\"># Loaded dashboards</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Step 6.启动服务或者停止服务，然后观察Kibana中主机数据的变化。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Start-Service winlogbeat</span><br><span class=\"line\">Stop-Service winlogbeat</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>winlogbeat 常用命令</strong><br>描述: 除了上述的相关命令外，winlogbeat语法参数如下:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># - 索引模板加载</span></span><br><span class=\"line\">PS D:\\Pro&gt; Expand-Archive -Path .\\winlogbeat-7.14.1-windows-x86_64.zip -DestinationPath .</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p><strong>winlogbeat.yml 语法</strong><br>参考地址: <a href=\"https://www.elastic.co/guide/en/beats/winlogbeat/current/configuration-winlogbeat-options.html#configuration-winlogbeat-options-event_logs-name\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/winlogbeat/current/configuration-winlogbeat-options.html#configuration-winlogbeat-options-event_logs-name</a></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ==== Winlogbeat specific option ====</span></span><br><span class=\"line\"><span class=\"comment\"># - 存储重新启动后用于恢复监视的信息的文件名，作为windows服务运行时建议您将该值设置为c:/ProgramData/winlogbeat/.winlogbeat.yml</span></span><br><span class=\"line\"><span class=\"string\">winlogbeat.registry_file:</span> <span class=\"attr\">C:/ProgramData/winlogbeat/.winlogbeat.yml</span></span><br><span class=\"line\"><span class=\"comment\"># - 关闭时等待所有事件发布的时间量 (默认情况下没有关闭超时)</span></span><br><span class=\"line\"><span class=\"string\">winlogbeat.shutdown_timeout:</span> <span class=\"number\">30</span><span class=\"string\">s</span></span><br><span class=\"line\"><span class=\"comment\"># - 条目列表（称为词典指定要监视的事件日志)。</span></span><br><span class=\"line\"><span class=\"string\">winlogbeat.event_logs:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Application</span>   <span class=\"comment\"># - 要监视的事件日志的名称</span></span><br><span class=\"line\"><span class=\"attr\">    ignore_older:</span> <span class=\"number\">72</span><span class=\"string\">h</span>   <span class=\"comment\"># - 如果指定了此选项将筛选早于指定时间量的事件，当您开始监视包含要忽略的旧记录的事件日志时此选项非常有用。</span></span><br><span class=\"line\"><span class=\"attr\">    provider:</span>           <span class=\"comment\"># - 要包含的提供程序（源名称）的列表（即日志来源）</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">Application</span> <span class=\"string\">Error</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">Application</span> <span class=\"string\">Hang</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">Windows</span> <span class=\"string\">Error</span> <span class=\"string\">Reporting</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">EMET</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">System</span></span><br><span class=\"line\"><span class=\"attr\">    batch_read_size:</span> <span class=\"number\">1000</span>  <span class=\"comment\"># - 在单个批处理中从Windows API读取的最大事件日志记录数, 默认100一定要小于1024否则保存</span></span><br><span class=\"line\"><span class=\"attr\">    event_id:</span> <span class=\"number\">6005</span><span class=\"string\">,6006,7001,7002</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Security</span></span><br><span class=\"line\"><span class=\"attr\">    processors:</span>                     <span class=\"comment\"># - 要应用于事件日志生成的数据的处理器列表（主要解决windows系统限制超过22个）。</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">drop_event.when.not.or:</span>     <span class=\"comment\"># - 使用drop_event(不存在则丢弃)处理器进行筛选解决此Windows限制问题。</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">equals.winlog.event_id:</span> <span class=\"number\">903</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">equals.winlog.event_id:</span> <span class=\"number\">1024</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">equals.winlog.event_id:</span> <span class=\"number\">4624</span></span><br><span class=\"line\"><span class=\"attr\">    level:</span> <span class=\"string\">critical,</span> <span class=\"string\">error,</span> <span class=\"string\">warning,</span> <span class=\"string\">info</span> <span class=\"string\">,verbose</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">ForwardedEvents</span>       <span class=\"comment\"># - 指示日志仅包含使用Windows事件收集器从远程主机收集的事件。</span></span><br><span class=\"line\"><span class=\"attr\">    api:</span> <span class=\"string\">wineventlog-experimental</span> <span class=\"comment\"># - 将选择用于从Windows API读取事件的事件日志读取器实现。（只应在测试实验功能时设置此选项）</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">[forwarded]</span>           <span class=\"comment\"># - 标记使得在Kibana中选择特定事件或Logstash中的applyconditional过滤变得容易标记将被附加到常规配置中指定的标签列表中。 </span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Windows</span> <span class=\"string\">PowerShell</span>       <span class=\"comment\"># - 必须在配置文件中指定通道的全名。</span></span><br><span class=\"line\"><span class=\"attr\">    event_id:</span> <span class=\"number\">400</span><span class=\"string\">,</span> <span class=\"number\">403</span><span class=\"string\">,</span> <span class=\"number\">600</span><span class=\"string\">,</span> <span class=\"bullet\">-800</span><span class=\"string\">,</span> <span class=\"comment\"># - 包含和排除（阻止）事件ID的列表, 排除事件ID为800的事件</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Microsoft-Windows-PowerShell/Operational</span></span><br><span class=\"line\"><span class=\"attr\">    event_id:</span> <span class=\"number\">4103</span><span class=\"string\">,</span> <span class=\"number\">4104</span><span class=\"string\">,</span> <span class=\"number\">4105</span><span class=\"string\">,</span> <span class=\"number\">4106</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">Microsoft-Windows-Windows</span> <span class=\"string\">Defender/Operational</span></span><br><span class=\"line\"><span class=\"attr\">    include_xml:</span> <span class=\"literal\">true</span>              <span class=\"comment\"># - 用于控制事件的原始XML表示是否包含在由Winlogbeat发送的数据中。默认值为false</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">CustomLog</span></span><br><span class=\"line\"><span class=\"attr\">    tags:</span> <span class=\"string\">[\"web\"]</span></span><br><span class=\"line\"><span class=\"attr\">    fields:</span>         <span class=\"comment\"># - 您可以指定用于向输出添加附加信息的可选字段</span></span><br><span class=\"line\"><span class=\"attr\">      customer_id:</span> <span class=\"number\">51415432</span> </span><br><span class=\"line\"><span class=\"attr\">    fields_under_root:</span> <span class=\"literal\">true</span> <span class=\"comment\"># - 如果此选项设置为true，则自定义领域存储为输出文档中的顶级字段，而不是分组到fields小词典。</span></span><br><span class=\"line\"><span class=\"attr\">    index:</span> <span class=\"string\">\"<span class=\"template-variable\">%&#123;[agent.name]&#125;</span>-myindex-<span class=\"template-variable\">%&#123;+yyyy.MM.dd&#125;</span>\"</span>  <span class=\"comment\"># 可能会扩展到 “winlogbeat-myindex-2019.12.13”</span></span><br><span class=\"line\">    <span class=\"comment\"># 如果存在，此格式化字符串将覆盖此事件日志中事件的索引（对于elasticsearch输出），或设置raw_index事件的元数据字段（用于其他输出）</span></span><br><span class=\"line\"><span class=\"attr\">    keep_null:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 如果此选项设置为true，则字段null值将在输出文档中发布。默认情况下，保持空值设置为false no_more_events  # 当事件日志读取器从Windows接收到没有其他事件可读取的信号时应执行的操作。也可以wait为了编写更多的事件（默认行为），或者停止. 当所有单个事件日志读取器都停止时，overallWinlogbeat进程将停止。</span></span><br></pre></td></tr></table></figure>\n<p>Tips : 如果指定的事件ID超过22个要包含或排除的事件ID超过22个，Windows将阻止Winlogbeat读取事件日志，因为它限制了事件日志查询中可以使用的条件数。<br>解决办法:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">winlogbeat.event_logs:</span><br><span class=\"line\">  - name: Security</span><br><span class=\"line\">    processors:</span><br><span class=\"line\">      - drop_event.when.not.or:</span><br><span class=\"line\">        - equals.winlog.event_id: 903</span><br><span class=\"line\">        - equals.winlog.event_id: 1024</span><br><span class=\"line\">        - equals.winlog.event_id: 4624</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"Filebeat-简述与使用\"><a href=\"#Filebeat-简述与使用\" class=\"headerlink\" title=\"Filebeat - 简述与使用\"></a>Filebeat - 简述与使用</h3><p>描述: Filebeat 是一个轻量级的传送器，用于转发和集中日志数据, 该模块收集并解析常见 Unix/Linux 分发的系统日志服务创建的日志。</p>\n<p>参考地址: <a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/index.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/filebeat/current/index.html</a></p>\n<p><strong>Filebeat 工作原理:</strong></p>\n<ul>\n<li>(1) 当您启动 Filebeat 时，它会查看您指定的日志数据位置。</li>\n<li>(2) Filebeat 定位到的每个日志，Filebeat 都会启动一个采集进程。</li>\n<li>(3) 每个 Harvester 读取新内容的单个日志并将新日志数据发送到Fliebeat Spooler(后台服务),并将将聚合数据发送到输出你为 Filebeat 配置的es中。</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://www.elastic.co/guide/en/beats/filebeat/current/images/filebeat.png\" alt=\"Filebeat-工作流程\" title=\"\" class=\"\">\n                <p>Filebeat-工作流程</p>\n            </figure>\n<p>Tips: Filebeat is an Elastic Beat. It’s based on the libbeat framework.</p>\n<p><br></p>\n<p><strong>Filebeat 安装:</strong><br>描述: 此处以Linux平台为例进行安装 Filebeat, 如您是其它平台或者采用其它方式(<code>APT/YUM/Docker</code>)则参考以下地址。<br>参考地址: <a href=\"https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html\" target=\"_blank\" rel=\"noopener\">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html</a></p>\n<p><a href=\"http://openjdk.java.net/\" target=\"_blank\" rel=\"noopener\">http://openjdk.java.net/</a></p>\n<p>for i in {78..83};do<br> ssh -p 20211 10.4.4.${i} ‘wget <a href=\"http://10.4.4.21:8000/filebeatInstall.sh\" target=\"_blank\" rel=\"noopener\">http://10.4.4.21:8000/filebeatInstall.sh</a> -O /tmp/filebeatInstall.sh &amp;&amp; chmod +x /tmp/filebeatInstall.sh &amp;&amp; cd /tmp/ &amp;&amp; bash -c /tmp/filebeatInstall.sh’<br>done<br>for i in {16..20};do<br> ssh -p 20211 10.41.40.${i} ‘systemctl restart filebeat.service’<br>done</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># Filebeat 快速下载安装部署</span></span><br><span class=\"line\">SRCNAME=<span class=\"string\">\"filebeat-7.14.1\"</span></span><br><span class=\"line\">SRCDIR=<span class=\"string\">\"/usr/local/<span class=\"variable\">$&#123;SRCNAME&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> SRCDIR</span><br><span class=\"line\"><span class=\"comment\"># 第 1 步：filebeat 下载&amp;安装</span></span><br><span class=\"line\"><span class=\"comment\"># curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.14.1-linux-x86_64.tar.gz</span></span><br><span class=\"line\">curl -L -O http://192.168.12.31/<span class=\"variable\">$&#123;SRCNAME&#125;</span>-linux-x86_64.tar.gz</span><br><span class=\"line\">tar xzf <span class=\"variable\">$&#123;SRCNAME&#125;</span>-linux-x86_64.tar.gz -C /usr/<span class=\"built_in\">local</span></span><br><span class=\"line\">mv /usr/<span class=\"built_in\">local</span>/<span class=\"variable\">$&#123;SRCNAME&#125;</span>-linux-x86_64 <span class=\"variable\">$&#123;SRCDIR&#125;</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$&#123;SRCDIR&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 第 2 步：filebeat 安全配置</span></span><br><span class=\"line\"><span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat keystore create</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"weiyigeek-2021.1\"</span> | <span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat keystore add AUTH --stdin --force</span><br><span class=\"line\"><span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat keystore list</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 第 3 步：filebeat 配置&amp;验证</span></span><br><span class=\"line\">sed -i -e <span class=\"string\">'s|#host: \"localhost:5601\"|host: \"log.weiyigeek.top:5601\"|g'</span> \\</span><br><span class=\"line\">-e <span class=\"string\">'s|localhost:9200|log.weiyigeek.top:9200|g'</span> \\</span><br><span class=\"line\">-e <span class=\"string\">'s|#username: \"elastic\"|username: \"elastic\"|g'</span> \\</span><br><span class=\"line\">-e <span class=\"string\">'s|#password: \"changeme\"|password: \"$&#123;AUTH&#125;\"|g'</span> \\</span><br><span class=\"line\"><span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat.yml</span><br><span class=\"line\"><span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat <span class=\"built_in\">test</span> config -e <span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 第 4 步：设置采集的资产</span></span><br><span class=\"line\"><span class=\"comment\"># Filebeat 带有预定义的资产，用于解析、索引和 可视化您的数据。 </span></span><br><span class=\"line\"><span class=\"comment\"># 查看可用模块：$&#123;SRCDIR&#125;/filebeat modules list</span></span><br><span class=\"line\">sudo <span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat modules <span class=\"built_in\">enable</span> system</span><br><span class=\"line\">sudo chown root <span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat.yml </span><br><span class=\"line\">sudo chown root <span class=\"variable\">$&#123;SRCDIR&#125;</span>/modules.d/system.yml </span><br><span class=\"line\">sudo <span class=\"variable\">$&#123;SRCDIR&#125;</span>/filebeat setup</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 第 5 步：设置自启与启动 Filebeat</span></span><br><span class=\"line\">sudo tee /usr/lib/systemd/system/filebeat.service &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Elastic kibana Filebeat Service</span><br><span class=\"line\">Documentation=https://elastic.co</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">StandardError=journal</span><br><span class=\"line\">ExecStart=SRCDIR/filebeat -c SRCDIR/filebeat.yml</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=3s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sed -i <span class=\"string\">\"s#SRCDIR#<span class=\"variable\">$&#123;SRCDIR&#125;</span>#g\"</span> /usr/lib/systemd/system/filebeat.service </span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start filebeat.service</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 第 6 步：在 Kibana 查看您的数据</span></span><br><span class=\"line\"><span class=\"comment\"># Filebeat 带有预构建的 Kibana 仪表板和用于可视化日志的 UI 数据。</span></span><br><span class=\"line\">systemctl status filebeat.service</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\e[32m* 请启动 Kibana 并打开仪表板 -&gt; 发现 -&gt; 要查看 Filebeat 数据，请执行 确保预定义 filebeat-* 索引模式被选中\\e[0m\"</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"入坑出坑\"><a href=\"#入坑出坑\" class=\"headerlink\" title=\"入坑出坑\"></a>入坑出坑</h3><p><strong>问题1.Kibana无法登陆且在登陆时显示<code>糟糕！错误请重试</code>,后台日志报<code>index ... blocked by: [TOO_MANY_REQUESTS/12/disk usage exceeded flood-stage watermark, index has read-only-allow-delete block]</code></strong></p>\n<ul>\n<li>错误日志: <code>TOO_MANY_REQUESTS/12/disk usage exceeded flood-stage watermark, index has read-only-allow-delete block</code><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;<span class=\"string\">\"type\"</span>:<span class=\"string\">\"log\"</span>,<span class=\"string\">\"@timestamp\"</span>:<span class=\"string\">\"2021-10-09T08:01:04+00:00\"</span>,<span class=\"string\">\"tags\"</span>:[<span class=\"string\">\"error\"</span>,<span class=\"string\">\"plugins\"</span>,<span class=\"string\">\"security\"</span>,<span class=\"string\">\"session\"</span>,<span class=\"string\">\"index\"</span>],<span class=\"string\">\"pid\"</span>:1213,<span class=\"string\">\"message\"</span>:<span class=\"string\">\"Failed to create s</span></span><br><span class=\"line\"><span class=\"string\">ession value: cluster_block_exception: [cluster_block_exception] Reason: index [.kibana_security_session_1] blocked by: [TOO_MANY_REQUESTS/12/disk usag</span></span><br><span class=\"line\"><span class=\"string\">e exceeded flood-stage watermark, index has read-only-allow-delete block];\"</span>&#125;</span><br></pre></td></tr></table></figure></li>\n<li>错误原因: 由于ES存储的data磁盘空间使用率已达到95%则将索引设置成为只读模式。</li>\n<li>解决办法: <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.增加磁盘空间大小(操作前注意数据迁移备份)或者删除无用的日志文件</span></span><br><span class=\"line\">root@elk:~<span class=\"comment\"># ls /app/</span></span><br><span class=\"line\"> elastic   kibana  <span class=\"string\">'#recycle'</span></span><br><span class=\"line\">root@elk:~<span class=\"comment\"># df -Th /app/</span></span><br><span class=\"line\">Filesystem                  Type  Size  Used Avail Use% Mounted on</span><br><span class=\"line\">192.168.2.1:/volume1/share nfs    19T  3.1T   16T  16% /app</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.临时在在elasticsearch.yml文件末尾添加以下内容,等等开了进去Kibana后删除无用索引。</span></span><br><span class=\"line\"><span class=\"comment\"># 控制洪水阶段水印最大百分比</span></span><br><span class=\"line\">cluster.routing.allocation.disk.watermark.flood_stage: 98%</span><br><span class=\"line\"><span class=\"comment\"># 根据磁盘使用情况来决定是否继续分配shard</span></span><br><span class=\"line\">cluster.routing.allocation.disk.threshold_enabled: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">curl -H <span class=\"string\">\"Content-Type:application/json\"</span> \\</span><br><span class=\"line\">    -XPUT -u elastic:weiyigeek <span class=\"string\">'http://log.weiyigeek.top:9200/_cluster/_settings'</span> \\ </span><br><span class=\"line\">    -d <span class=\"string\">'&#123;\"transient\": &#123;\"cluster.routing.allocation.disk.watermark.flood_stage\": \"99%\"&#125;&#125;'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.临时解锁指定Kibana的索引的读写权限(其它索引被锁类似)</span></span><br><span class=\"line\">curl -H <span class=\"string\">\"Content-Type:application/json\"</span> -XPUT -u elastic:weiyigeek <span class=\"string\">'http://log.weiyigeek.top:9200/.kibana_7.14.1_001/_settings'</span> -d <span class=\"string\">'&#123; \"index.blocks.read_only_allow_delete\" : null &#125;'</span></span><br><span class=\"line\">curl -H <span class=\"string\">\"Content-Type:application/json\"</span> -XPUT -u elastic:weiyigeek <span class=\"string\">'http://log.weiyigeek.top:9200/.kibana_security_session_1/_settings'</span> -d <span class=\"string\">'&#123; \"index.blocks.read_only_allow_delete\" : null &#125;'</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"日志审计","path":"api/categories/日志审计.json"},{"name":"安全建设","path":"api/categories/安全建设.json"}],"tags":[{"name":"Elastic","path":"api/tags/Elastic.json"}]}