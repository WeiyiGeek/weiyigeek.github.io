{"title":"PhantomJS之网站自动化运维测试监控利器","slug":"系统运维/自动化测试/Phantomjs/PhantomJS之网站自动化运维测试监控利器","date":"2020-06-29T06:34:30.000Z","updated":"2023-01-12T07:07:45.368Z","url":"2020/6-29-264.html","path":"api/articles/2020/6-29-264.html.json","covers":["https://img.weiyigeek.top/2022/10/20230110150041.png","https://img.weiyigeek.top/2022/10/20230110180300.png","https://img.weiyigeek.top/2022/10/20230111095803.png","https://img.weiyigeek.top/2022/10/20230111101451.png","https://img.weiyigeek.top/2022/10/20230111120117.png","https://img.weiyigeek.top/2022/10/20230111172323.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言初识\"><a href=\"#0x00-前言初识\" class=\"headerlink\" title=\"0x00 前言初识\"></a>0x00 前言初识</h2><h3 id=\"1-PhantomJS-介绍\"><a href=\"#1-PhantomJS-介绍\" class=\"headerlink\" title=\"1.PhantomJS 介绍\"></a>1.PhantomJS 介绍</h3><p><strong>什么是PhantomJS?</strong></p>\n<blockquote>\n<p>Phantomjs(<code>/ˈfæntəm/js</code>) 是一个基于WebKit库的无头（没有显示界面）的JavaScript API，即像在web浏览器上运行一样，所以标准的DOM脚本和CSS选择器工作正常，用于自动化Web浏览器操作，是一个免费开源的轻量级服务器解决方案。<br>它可以在Windows、macOS、Linux和FreeBSD上运行, 并且使用QtWebKit作为后端，它为各种web标准提供了快速的本地支持：DOM处理、CSS选择器、JSON、画布和SVG。</p>\n</blockquote>\n<p><strong>PhantomJS有什么用?</strong></p>\n<blockquote>\n<p>它可以用来测试动态内容, 比如 AJAX内容、截屏，以及转换为PDF和原型图，它也可以执行跨浏览器的JavaScript测试，可以模拟网络延迟、网页截屏、页面访问自动化以及捕获网络脚本的错误和警告等。<br>它不仅是个隐形的浏览器, 还提供了诸如CSS选择器、支持Web标准、DOM操作、JSON、HTML5、Canvas、SVG等，同时也提供了处理文件I/O的操作，从而使你可以向操作系统读写文件等。<br>简单的说, PhantomJS 适合执行各种页面自动化监控、测试任务等。</p>\n</blockquote>\n<h3 id=\"2-参考来源\"><a href=\"#2-参考来源\" class=\"headerlink\" title=\"2.参考来源\"></a>2.参考来源</h3><ul>\n<li>官方地址: <a href=\"http://phantomjs.org/\" target=\"_blank\" rel=\"noopener\">http://phantomjs.org/</a></li>\n<li>PhantomJS GitHub：<a href=\"https://github.com/ariya/phantomjs/\" target=\"_blank\" rel=\"noopener\">https://github.com/ariya/phantomjs/</a></li>\n<li>PhantomJS官方API：<a href=\"http://phantomjs.org/api/\" target=\"_blank\" rel=\"noopener\">http://phantomjs.org/api/</a></li>\n<li>PhantomJS官方示例：<a href=\"http://phantomjs.org/examples/\" target=\"_blank\" rel=\"noopener\">http://phantomjs.org/examples/</a></li>\n</ul>\n<hr>\n<h2 id=\"0x01-PhantomJS-安装\"><a href=\"#0x01-PhantomJS-安装\" class=\"headerlink\" title=\"0x01 PhantomJS 安装\"></a>0x01 PhantomJS 安装</h2><p>描述: 我们知道 <code>PhantomJS</code> 它可以在 <code>Windows、macOS、Linux和FreeBSD</code>上运行，你可以参考官网中安装说明进行快速安装 (PS: 软件下载地址 <a href=\"https://phantomjs.org/download.html\" target=\"_blank\" rel=\"noopener\">https://phantomjs.org/download.html</a> )。</p>\n<p>下面会根据使用场景，从最常用的Windows 以及 Linux 系统发行版本里安装PhantomJS流程进行简单说明:</p>\n<h3 id=\"1-Windows\"><a href=\"#1-Windows\" class=\"headerlink\" title=\"1.Windows\"></a>1.Windows</h3><p>描述:首先我们需要下载 Windows 版本的 PhantomJS 压缩包 , 选择 Windows 运行的版本进行下载然后放在一个指定目录中，例如此处的<code>F:\\WeiyiGeek\\Tools</code>（建议加上环境变量）；</p>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># PowerShell 下载 Phantomjs-2.1.1-windows.zip 并解压</span></span><br><span class=\"line\"><span class=\"variable\">$InstallPath</span>=<span class=\"string\">\"F:\\WeiyiGeek\\Tools\"</span></span><br><span class=\"line\">mkdir <span class=\"variable\">$InstallPath</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$InstallUrl</span>=<span class=\"string\">\"https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-windows.zip\"</span></span><br><span class=\"line\"><span class=\"variable\">$down</span>=<span class=\"built_in\">New-Object</span> <span class=\"string\">\"System.Net.WebClient\"</span></span><br><span class=\"line\"><span class=\"variable\">$down</span>.DownloadFile(<span class=\"variable\">$InstallUrl</span>,<span class=\"string\">\"$&#123;InstallPath&#125;\\phantomjs-2.1.1-windows.zip\"</span>)</span><br><span class=\"line\">Expand-Archive -Path <span class=\"string\">\"$&#123;InstallPath&#125;/phantomjs-2.1.1-windows.zip\"</span> -DestinationPath <span class=\"variable\">$InstallPath</span> -Force</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># PowerShell 设置 Phantomjs 的环境变量</span></span><br><span class=\"line\"><span class=\"variable\">$systempath</span> = [System.Environment]::GetEnvironmentVariable(<span class=\"string\">\"PATH\"</span>,<span class=\"string\">\"Machine\"</span>)</span><br><span class=\"line\"><span class=\"variable\">$systempath</span> = <span class=\"variable\">$systempath</span> + <span class=\"string\">\";\"</span> + <span class=\"variable\">$InstallPath</span> + <span class=\"string\">\"\\phantomjs-2.1.1-windows\\bin\"</span></span><br><span class=\"line\">[System.Environment]::setEnvironmentVariable(<span class=\"string\">\"PATH\"</span>,<span class=\"variable\">$systempath</span>,<span class=\"string\">\"Machine\"</span>)</span><br></pre></td></tr></table></figure>\n<p>验证安装:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 方式1.命令行</span></span><br><span class=\"line\">phantomjs-2.1.1-windows\\bin&gt;phantomjs.exe -v</span><br><span class=\"line\">2.1.1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 方式2.交互式</span></span><br><span class=\"line\">phantomjs</span><br><span class=\"line\">phantomjs&gt; phantom.version</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   <span class=\"string\">\"major\"</span>: 2,</span><br><span class=\"line\">   <span class=\"string\">\"minor\"</span>: 1,</span><br><span class=\"line\">   <span class=\"string\">\"patch\"</span>: 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">phantomjs&gt; var system = require(<span class=\"string\">'system'</span>)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"2-Linux\"><a href=\"#2-Linux\" class=\"headerlink\" title=\"2.Linux\"></a>2.Linux</h3><p>此处演示在 CentOS7/Ubuntu x64位 (Linux 64-bit)系统中安装 phantomjs 流程，若是其他发行版也可参照安装。</p>\n<p>温馨提示: It however still relies on Fontconfig (the package fontconfig or libfontconfig, depending on the distribution). The system must have GLIBCXX_3.4.9 and GLIBC_2.7.</p>\n<p>安装脚本:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基础依赖软件安装</span></span><br><span class=\"line\">apt install jq bzip2 || yum install jq bzip2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 由于其它仍然依赖 Fontconfig 我们还需安装如下依赖（包Fontconfig或libfontconfig，取决于发行版）</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ -f /etc/redhat-release ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"comment\"># 安装字体相关的依赖包并刷新字体缓存</span></span><br><span class=\"line\">  yum install fontconfig freetype2 -y</span><br><span class=\"line\">  yum install bitmap-fonts bitmap-fonts-cjk -y</span><br><span class=\"line\">  yum groupinstall <span class=\"string\">\"fonts\"</span> -y</span><br><span class=\"line\">  <span class=\"built_in\">fc</span>-cache </span><br><span class=\"line\"><span class=\"keyword\">else</span> </span><br><span class=\"line\">  <span class=\"comment\"># 安装系统字体相关工具</span></span><br><span class=\"line\">  sudo apt update</span><br><span class=\"line\">  sudo apt install -y fontconfig libfreetype6 libfreetype6-dev mkfontscale</span><br><span class=\"line\">  sudo apt-get install build-essential chrpath libssl-dev libxft-dev</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 拷贝windows字体(C:\\Windows\\Fonts)至/usr/share/fonts/Windows-Fonts, </span></span><br><span class=\"line\">  mkdir /usr/share/fonts/Windows-Fonts</span><br><span class=\"line\">  chmod -R 644 /usr/share/fonts/Windows-Fonts &amp;&amp; <span class=\"built_in\">cd</span> /usr/share/fonts/Windows-Fonts</span><br><span class=\"line\">  mkfontscale;mkfontdir;<span class=\"built_in\">fc</span>-cache</span><br><span class=\"line\">  ln -s /usr/share/fonts/Windows-Fonts /usr/lib/x86_64-linux-gnu/fonts</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装解压</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /tmp</span><br><span class=\"line\">wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class=\"line\">tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class=\"line\">mv phantomjs-2.1.1-linux-x86_64/ /usr/<span class=\"built_in\">local</span>/src/phantomjs</span><br><span class=\"line\">ln -sf /usr/<span class=\"built_in\">local</span>/src/phantomjs/bin/phantomjs /usr/<span class=\"built_in\">local</span>/bin/phantomjs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装测试</span></span><br><span class=\"line\">phantomjs -v </span><br><span class=\"line\">phantomjs /usr/<span class=\"built_in\">local</span>/src/phantomjs/examples/hello.js</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"0x02-快速使用\"><a href=\"#0x02-快速使用\" class=\"headerlink\" title=\"0x02 快速使用\"></a>0x02 快速使用</h2><h3 id=\"1-牛刀小试\"><a href=\"#1-牛刀小试\" class=\"headerlink\" title=\"1.牛刀小试\"></a>1.牛刀小试</h3><p>下面来看一个简单示例, 它是参考整合 PhantomJS 官网 的演示代码，实现终端输出、命令行参数获取、请求指定url获取站点Dom相关信息以及站点任何控制台消息，与输出站点首页截图并保存为域名.png图片。</p>\n<p>温馨提示: 下述演示代码都能在 <a href=\"https://github.com/WeiyiGeek/SecOpsDev/tree/master/AutomatedTesting/Web/phantomjs\" target=\"_blank\" rel=\"noopener\">https://github.com/WeiyiGeek/SecOpsDev/tree/master/AutomatedTesting/Web/phantomjs</a> 找到</p>\n<p><strong>示例代码:</strong><br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// hello-PhantomJS.js.js</span></span><br><span class=\"line\"><span class=\"comment\">// 参考地址: https://phantomjs.org/quick-start.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出文字字符到终端</span></span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'Hello, world! PhantomJS Demo!'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 可以通过创建网页对象来加载、分析和呈现网页。</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> page = <span class=\"built_in\">require</span>(<span class=\"string\">'webpage'</span>).create(),</span><br><span class=\"line\">system = <span class=\"built_in\">require</span>(<span class=\"string\">'system'</span>),</span><br><span class=\"line\">t, url;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 传入命令行参数数量检测</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (system.args.length === <span class=\"number\">1</span> ) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'Usage: hello-PhantomJS.js [some URL]'</span>);</span><br><span class=\"line\">  <span class=\"comment\">// 终止执行</span></span><br><span class=\"line\">  phantom.exit();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取当前时间</span></span><br><span class=\"line\">t = <span class=\"built_in\">Date</span>.now();</span><br><span class=\"line\"><span class=\"comment\">// 获取命令行传入的参数</span></span><br><span class=\"line\">url = system.args[<span class=\"number\">1</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 使用onConsoleMessage回调显示来自网页的任何控制台消息，即站点console输出的信息。</span></span><br><span class=\"line\">page.onConsoleMessage = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">msg</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'Console output : '</span> + msg);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 请求访问站点</span></span><br><span class=\"line\">page.open(url, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">status</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (status !== <span class=\"string\">'success'</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'FAIL to load the address : '</span> + url);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    t = <span class=\"built_in\">Date</span>.now() - t;</span><br><span class=\"line\">    <span class=\"comment\">// 使用evaluate获取JS后Dom文档对象</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> title = page.evaluate(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"built_in\">document</span>.title;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"----------------------------------------------\"</span>)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"Status: \"</span> + status);  </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'Loading '</span> + url + <span class=\"string\">', Title '</span> + title );</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'Loading time '</span> + t + <span class=\"string\">' msec'</span>);</span><br><span class=\"line\">    page.render(url.split(<span class=\"string\">\"//\"</span>)[<span class=\"number\">1</span>]+<span class=\"string\">'.png'</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 终止执行</span></span><br><span class=\"line\">  phantom.exit();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure></p>\n<p>执行结果:<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">phantomjs<span class=\"number\">-2.1</span><span class=\"number\">.1</span>-windows\\bin&gt; CHCP <span class=\"number\">65001</span> <span class=\"comment\">// 将当前cmd窗口的当前代码页设置为utf-8</span></span><br><span class=\"line\">phantomjs<span class=\"number\">-2.1</span><span class=\"number\">.1</span>-windows\\bin&gt; .\\phantomjs.exe .\\hello-PhantomJS.js https:<span class=\"comment\">//weiyigeek.top</span></span><br><span class=\"line\">Hello, world! PhantomJS Demo!</span><br><span class=\"line\">Console output : 电脑</span><br><span class=\"line\">Console output : Welcome to WeiyiGeek<span class=\"string\">'Index Site - [https://www.weiyigeek.top].</span></span><br><span class=\"line\"><span class=\"string\">花开堪折直须折，莫待无花空折枝!</span></span><br><span class=\"line\"><span class=\"string\">Console output : %c希望与各位志同道合的朋友一起学习交流，如文章有误请留下您宝贵的知识建议，或者通过邮箱【master#weiyigeek.top】联系我哟！ color:white</span></span><br><span class=\"line\"><span class=\"string\">Console output : %c专栏书写不易,如果您觉得这个专栏还不错的,请给这篇专栏 【点个赞、投个币、收个藏、关个注，转个发】(人间五大情),这将对我的肯定,谢谢支持！(๑′ᴗ‵๑) ❤！ color:red</span></span><br><span class=\"line\"><span class=\"string\">----------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">Status: success</span></span><br><span class=\"line\"><span class=\"string\">Loading https://weiyigeek.top, Title 🌐 WeiyiGeek|唯一极客-Geek-IT网络安全技术知识分享-主页站点</span></span><br><span class=\"line\"><span class=\"string\">Loading time 684 msec</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/10/20230110150041.png\" alt=\"WeiyiGeek.phantomjs-牛刀小试图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.phantomjs-牛刀小试图</p>\n            </figure>\n<p><br/></p>\n<p><strong>扩展了解</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 网页实例方法与事件</span></span><br><span class=\"line\"><span class=\"comment\"># Suppose you have an instance of the webpage:</span></span><br><span class=\"line\">var page = require(<span class=\"string\">'webpage'</span>).create();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Functions</span></span><br><span class=\"line\">  page.childFramesCount</span><br><span class=\"line\">  page.childFramesName</span><br><span class=\"line\">  page.close</span><br><span class=\"line\">  page.currentFrameName</span><br><span class=\"line\">  page.deleteLater</span><br><span class=\"line\">  page.destroyed</span><br><span class=\"line\">  page.evaluate</span><br><span class=\"line\">  page.initialized</span><br><span class=\"line\">  page.injectJs</span><br><span class=\"line\">  page.javaScriptAlertSent</span><br><span class=\"line\">  page.javaScriptConsoleMessageSent</span><br><span class=\"line\">  page.loadFinished</span><br><span class=\"line\">  page.loadStarted</span><br><span class=\"line\">  page.openUrl</span><br><span class=\"line\">  page.release</span><br><span class=\"line\">  page.render</span><br><span class=\"line\">  page.resourceError</span><br><span class=\"line\">  page.resourceReceived</span><br><span class=\"line\">  page.resourceRequested</span><br><span class=\"line\">  page.uploadFile</span><br><span class=\"line\">  page.sendEvent</span><br><span class=\"line\">  page.setContent</span><br><span class=\"line\">  page.switchToChildFrame</span><br><span class=\"line\">  page.switchToMainFrame</span><br><span class=\"line\">  page.switchToParentFrame</span><br><span class=\"line\">  page.addCookie</span><br><span class=\"line\">  page.deleteCookie</span><br><span class=\"line\">  page.clearCookies</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Handlers/Callbacks</span></span><br><span class=\"line\"><span class=\"comment\"># List of all the page events:</span></span><br><span class=\"line\">  onInitialized</span><br><span class=\"line\">  onLoadStarted</span><br><span class=\"line\">  onLoadFinished</span><br><span class=\"line\">  onUrlChanged</span><br><span class=\"line\">  onNavigationRequested</span><br><span class=\"line\">  onRepaintRequested</span><br><span class=\"line\">  onResourceRequested</span><br><span class=\"line\">  onResourceReceived</span><br><span class=\"line\">  onResourceError</span><br><span class=\"line\">  onResourceTimeout</span><br><span class=\"line\">  onAlert</span><br><span class=\"line\">  onConsoleMessage</span><br><span class=\"line\">  onClosing</span><br></pre></td></tr></table></figure></p>\n<p>参考地址: <a href=\"https://phantomjs.org/api/webpage/\" target=\"_blank\" rel=\"noopener\">https://phantomjs.org/api/webpage/</a></p>\n<p><strong>温馨提示:</strong> 更多的PhantomJS示例尽在 <code>phantomjs-2.1.1-windows\\examples</code> 目录之中，文件说明可参考官方文档 （<a href=\"https://phantomjs.org/examples\" target=\"_blank\" rel=\"noopener\">https://phantomjs.org/examples</a> ），大家可以在开发时多多参考。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Basic examples</span></span><br><span class=\"line\">  arguments.js shows the arguments passed to the script</span><br><span class=\"line\">  countdown.js prints a 10 second countdown</span><br><span class=\"line\">  echoToFile.js writes the <span class=\"built_in\">command</span> line arguments to a file</span><br><span class=\"line\">  fibo.js lists the first few numbers <span class=\"keyword\">in</span> the Fibonacci sequence</span><br><span class=\"line\">  hello.js displays the famous message</span><br><span class=\"line\">  module.js and universe.js demonstrate the use of module system</span><br><span class=\"line\">  outputEncoding.js displays a string <span class=\"keyword\">in</span> various encodings</span><br><span class=\"line\">  printenv.js displays the system’s environment variables</span><br><span class=\"line\">  scandir.js lists all files <span class=\"keyword\">in</span> a directory and its subdirectories</span><br><span class=\"line\">  sleepsort.js sorts integers and delays display depending on their values</span><br><span class=\"line\">  version.js prints out PhantomJS version number</span><br><span class=\"line\">  page_events.js prints out page events firing: useful to better grasp page.on* callbacks</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Rendering/rasterization</span></span><br><span class=\"line\">  colorwheel.js creates a color wheel using HTML5 canvas</span><br><span class=\"line\">  rasterize.js rasterizes a web page to image or PDF</span><br><span class=\"line\">  render_multi_url.js renders multiple web pages to images</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Page automation</span></span><br><span class=\"line\">  injectme.js injects itself into a web page context</span><br><span class=\"line\">  phantomwebintro.js uses jQuery to <span class=\"built_in\">read</span> .version element text from phantomjs.org</span><br><span class=\"line\">  unrandomize.js modifies a global object at page initialization</span><br><span class=\"line\">  waitfor.js waits until a <span class=\"built_in\">test</span> condition is <span class=\"literal\">true</span> or a timeout occurs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Network</span></span><br><span class=\"line\">  detectsniff.js detects <span class=\"keyword\">if</span> a web page sniffs the user agent</span><br><span class=\"line\">  loadspeed.js computes the loading speed of a web site</span><br><span class=\"line\">  netlog.js dumps all network requests and responses</span><br><span class=\"line\">  netsniff.js captures network traffic <span class=\"keyword\">in</span> HAR format</span><br><span class=\"line\">  post.js sends an HTTP POST request to a <span class=\"built_in\">test</span> server</span><br><span class=\"line\">  postserver.js starts a web server and sends an HTTP POST request to it</span><br><span class=\"line\">  server.js starts a web server and sends an HTTP GET request to it</span><br><span class=\"line\">  serverkeepalive.js starts a web server <span class=\"built_in\">which</span> answers <span class=\"keyword\">in</span> plain text</span><br><span class=\"line\">  simpleserver.js starts a web server <span class=\"built_in\">which</span> answers <span class=\"keyword\">in</span> HTML</span><br><span class=\"line\"></span><br><span class=\"line\">Testing</span><br><span class=\"line\">  run-jasmine.js runs Jasmine based tests</span><br><span class=\"line\">  run-qunit.js runs QUnit based tests</span><br><span class=\"line\"></span><br><span class=\"line\">Browser</span><br><span class=\"line\">  features.js detects browser features using modernizr.js</span><br><span class=\"line\">  useragent.js changes the browser’s user agent property</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"2-DOM-操作并获取元素属性\"><a href=\"#2-DOM-操作并获取元素属性\" class=\"headerlink\" title=\"2.DOM 操作并获取元素属性\"></a>2.DOM 操作并获取元素属性</h3><p>描述: 使用标准DOM API或jQuery等常用库访问网页并提取信息。</p>\n<p><strong>示例代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// hello-page-automation.js</span></span><br><span class=\"line\"><span class=\"comment\">// DOM 操作,示例演示如何读取跳转后class为post-card-title的元素的textContent属性</span></span><br><span class=\"line\"><span class=\"comment\">// 可以通过创建网页对象来加载、分析和呈现网页。</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> page = <span class=\"built_in\">require</span>(<span class=\"string\">'webpage'</span>).create(),</span><br><span class=\"line\">system = <span class=\"built_in\">require</span>(<span class=\"string\">'system'</span>),</span><br><span class=\"line\">url,textContent;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 检查传入命令行参数数量</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (system.args.length === <span class=\"number\">1</span> ) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'Usage: hello-PhantomJS.js [some URL]'</span>);</span><br><span class=\"line\">  phantom.exit();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 获取命令行传入的参数</span></span><br><span class=\"line\">  url = system.args[<span class=\"number\">1</span>];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 设置 请求的UserAgent</span></span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'The default user agent is '</span> + page.settings.userAgent);</span><br><span class=\"line\">page.settings.userAgent = <span class=\"string\">'WeiyiGeekAgent'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 请求访问站点</span></span><br><span class=\"line\">page.open(url, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">status</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">\"----------------- 分隔线 -------------------------\"</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">\"Status: \"</span> + status);  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (status !== <span class=\"string\">'success'</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'Unable to access site : '</span> + url);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">  <span class=\"comment\">// 渲染延迟200ms时间进行截图，等待网站渲染完成</span></span><br><span class=\"line\">  setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 使用evaluate获取JS后Dom文档对象</span></span><br><span class=\"line\">    textContent = page.evaluate(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"built_in\">document</span>.getElementsByClassName(<span class=\"string\">\"post-card-title\"</span>)[<span class=\"number\">0</span>].textContent ;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'textContent ：'</span> + textContent );</span><br><span class=\"line\">    <span class=\"comment\">// console.log('page plainText : ' + page.plainText);</span></span><br><span class=\"line\">    page.render(url.split(<span class=\"string\">\"//\"</span>)[<span class=\"number\">1</span>]+<span class=\"string\">'.png'</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 终止执行</span></span><br><span class=\"line\">    phantom.exit();</span><br><span class=\"line\">  &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'page Title : '</span> + page.title);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'page Url : '</span> + page.url);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'page Cookies :'</span> + page.cookies[<span class=\"number\">1</span>].name + <span class=\"string\">\" : \"</span> + page.cookies[<span class=\"number\">1</span>].value);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'page ZoomFactor : '</span> + page.zoomFactor);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'page OfflineStoragePath : '</span> + page.offlineStoragePath);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'page LibraryPath : '</span> + page.libraryPath);</span><br><span class=\"line\">    </span><br><span class=\"line\">  <span class=\"comment\">// 从1.6版开始，您还可以使用page.includeJs将jQuery包含到页面中，如下所示：</span></span><br><span class=\"line\">  page.includeJs(<span class=\"string\">\"https://blog.weiyigeek.top/js/jquery/2.1.0-jquery.min.js?v=1.6.6\"</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> Title =  page.evaluate(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">       <span class=\"comment\">// 模拟点击请求</span></span><br><span class=\"line\">      $(<span class=\"string\">\"a\"</span>)[<span class=\"number\">10</span>].click();</span><br><span class=\"line\">      <span class=\"comment\">// document.getElementsByTagName('a')[10].click()</span></span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"built_in\">document</span>.title;</span><br><span class=\"line\">     &#125;);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"Blog Title : \"</span> + Title);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>执行结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">phantomjs-2.1.1-windows\\bin&gt;phantomjs.exe 1.page-automation.js https://weiyigeek.top</span><br><span class=\"line\">The default user agent is Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1</span><br><span class=\"line\">----------------- 分隔线 -------------------------</span><br><span class=\"line\">Status: success</span><br><span class=\"line\">page Title : 🌐 WeiyiGeek|唯一极客-Geek-IT网络安全技术知识分享-主页站点</span><br><span class=\"line\">page Url : https://weiyigeek.top/</span><br><span class=\"line\">page Cookies :Hm_lvt_8bb888f4c802ff4cd2fdbc10d8ab7069 : 1673344341,1673344489,1673344525,1673344554</span><br><span class=\"line\">page ZoomFactor : 1</span><br><span class=\"line\">page OfflineStoragePath : C:/Users/WeiyiGeek/AppData/Local/Ofi Labs/PhantomJS</span><br><span class=\"line\">page LibraryPath : L:/DevOps/自动化测试/模拟浏览器访问/PhantomJS/phantomjs-2.1.1-windows/bin</span><br><span class=\"line\">Blog Title : 🌐 WeiyiGeek|唯一极客-Geek-IT网络安全技术知识分享-主页站点</span><br><span class=\"line\">textContent ：唯一极客的学习之路汇总</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过nginx请求日志可以看到 userAgent 也发生变化了</span></span><br><span class=\"line\">IP - - [10/Jan/2023:17:56:16 +0800] <span class=\"string\">\"GET /2018/1-1-1.html HTTP/1.1\"</span> 200 16602 <span class=\"string\">\"https://weiyigeek.top/\"</span> <span class=\"string\">\"WeiyiGeekAgent\"</span> <span class=\"string\">\"-\"</span> rt=0.000 urt=-</span><br><span class=\"line\">IP - - [10/Jan/2023:17:56:17 +0800] <span class=\"string\">\"GET /search.xml HTTP/1.1\"</span> 200 30200 <span class=\"string\">\"https://blog.weiyigeek.top/2018/1-1-1.html\"</span> <span class=\"string\">\"WeiyiGeekAgent\"</span> <span class=\"string\">\"-\"</span> rt=0.000 urt=-</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/10/20230110180300.png\" alt=\"WeiyiGeek.使用进行 phantomjs DOM 操作并获取元素属性图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.使用进行 phantomjs DOM 操作并获取元素属性图</p>\n            </figure>\n<p><br></p>\n<h3 id=\"3-网页屏幕截图\"><a href=\"#3-网页屏幕截图\" class=\"headerlink\" title=\"3.网页屏幕截图\"></a>3.网页屏幕截图</h3><p>描述: 由于PhantomJS使用的是WebKit，这是一个真正的布局和渲染引擎，它可以将网页捕获为屏幕截图, 因为PhantomJS可以在网页上呈现任何内容，所以它可以用来转换CSS样式的HTML内容，也可以转换SVG、图像和Canvas元素。</p>\n<p>实际上在前面的案例中, 我们已经使用 PhantomJS 屏幕截图这一功能, 此处在深入讲解一下导出为pdf格式。</p>\n<p>在 examples 子目录，还有一个脚本 <code>rasterize.js</code> 这表明更加完整呈现 PhantomJS 特征, 下述也罗列作者在使用中所遇到过的问题。</p>\n<p>如何延迟截图，页面请求的资源，如图片、异步cgi、js等，返回的时间以及执行的长短都是不确定的，如果截图过早，可能很多空白区域，因此需要定时截图，在打开页面后，使用setTimeout来延迟截图<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 片段示例</span></span><br><span class=\"line\"><span class=\"built_in\">window</span>.setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;  </span><br><span class=\"line\">  page.render(<span class=\"string\">\"weiyigeek.top.png\"</span>);  </span><br><span class=\"line\">  phantom.exit();  </span><br><span class=\"line\">&#125;, <span class=\"number\">1000</span>);</span><br></pre></td></tr></table></figure></p>\n<p>如何保证网页站点完整截图。<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 设置 viewPortSize 属性设置布局过程的视口大小。</span></span><br><span class=\"line\"><span class=\"comment\">// 在加载页面之前设置首选的初始大小非常有用，例如在“横向”和“纵向”之间进行选择。</span></span><br><span class=\"line\">page.viewportSize = &#123;<span class=\"attr\">width</span>: <span class=\"number\">1024</span>,<span class=\"attr\">height</span>: <span class=\"number\">720</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 设置 clipRect 定义要光栅化的网页的矩形区域，若未设置剪切矩形 page.render 将截取处理整个网页。</span></span><br><span class=\"line\">page.clipRect = &#123;</span><br><span class=\"line\">  top: <span class=\"number\">14</span>,</span><br><span class=\"line\">  left: <span class=\"number\">3</span>,</span><br><span class=\"line\">  width: <span class=\"number\">400</span>,</span><br><span class=\"line\">  height: <span class=\"number\">300</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 设置 paperSize  属性定义呈现为PDF时网页的大小。</span></span><br><span class=\"line\"><span class=\"comment\">// Supported dimension units are: 'mm', 'cm', 'in', 'px'. No unit means 'px'.</span></span><br><span class=\"line\">page.paperSize = &#123;</span><br><span class=\"line\">  width: <span class=\"string\">'5in'</span>,</span><br><span class=\"line\">  height: <span class=\"string\">'7in'</span>,</span><br><span class=\"line\">  margin: &#123;</span><br><span class=\"line\">    top: <span class=\"string\">'50px'</span>,</span><br><span class=\"line\">    left: <span class=\"string\">'20px'</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// JS 原生方法获取当前页面尺寸</span></span><br><span class=\"line\"><span class=\"comment\">// 通过BOM方法操作滚动条</span></span><br><span class=\"line\"><span class=\"built_in\">window</span>.scrollTo(<span class=\"number\">0</span>,<span class=\"number\">10000</span>);</span><br><span class=\"line\"><span class=\"comment\">// 适应的高度</span></span><br><span class=\"line\"><span class=\"built_in\">window</span>.document.body.scrollTop = <span class=\"built_in\">document</span>.body.scrollHeight;</span><br></pre></td></tr></table></figure></p>\n<p>简单示例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 站点导出为PDF文件</span></span><br><span class=\"line\">phantomjs.exe ..\\examples\\rasterize.js https://blog.weiyigeek.top blog.weiyigeek.pdf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 多站点导出为png图片</span></span><br><span class=\"line\">phantomjs.exe ..\\examples\\render_multi_url.js https://weiyigeek.top https://blog.weiyigeek.top</span><br><span class=\"line\">Rendered <span class=\"string\">'https://weiyigeek.top'</span> at <span class=\"string\">'rendermulti-1.png'</span></span><br><span class=\"line\">Rendered <span class=\"string\">'https://blog.weiyigeek.top'</span> at <span class=\"string\">'rendermulti-2.png'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 站点多尺寸导出为png图片</span></span><br><span class=\"line\">phantomjs.exe ..\\examples\\responsive-screenshot.js https://blog.weiyigeek.top</span><br><span class=\"line\">Saving blog.weiyigeek.top/2023-1-11_09-39-25-297_320.png</span><br><span class=\"line\">Saving blog.weiyigeek.top/2023-1-11_09-39-26-934_480.png</span><br><span class=\"line\">Saving blog.weiyigeek.top/2023-1-11_09-39-27-816_768.png</span><br><span class=\"line\">Saving blog.weiyigeek.top/2023-1-11_09-39-28-852_1024.png</span><br><span class=\"line\">Saving blog.weiyigeek.top/2023-1-11_09-39-33-267_1200.png</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<h3 id=\"4-网页站点请求\"><a href=\"#4-网页站点请求\" class=\"headerlink\" title=\"4.网页站点请求\"></a>4.网页站点请求</h3><p>由于PhantomJS允许检查网络流量，因此它适合于对网络行为和性能进行各种分析，可以使用onResourceRequested和onResourceReceived嗅探所有资源请求和响应。脚本netlog.js中说明了记录每个请求和响应的一个非常简单的示例：<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 示例</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> page = <span class=\"built_in\">require</span>(<span class=\"string\">'webpage'</span>).create();</span><br><span class=\"line\">page.onResourceRequested = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">request</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'Request '</span> + <span class=\"built_in\">JSON</span>.stringify(request, <span class=\"literal\">undefined</span>, <span class=\"number\">4</span>));</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">page.onResourceReceived = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">response</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'Receive '</span> + <span class=\"built_in\">JSON</span>.stringify(response, <span class=\"literal\">undefined</span>, <span class=\"number\">4</span>));</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">page.open(url);</span><br></pre></td></tr></table></figure></p>\n<p><strong>简单示例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 以HAR格式捕获网络流量，并且可以导入到 har views 进行可视化查看</span></span><br><span class=\"line\">phantomjs.exe ..\\examples\\netsniff.js https://www.weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出站点请求等待、传输的时间</span></span><br><span class=\"line\">timings: &#123;</span><br><span class=\"line\">  blocked: 0,</span><br><span class=\"line\">  dns: -1,</span><br><span class=\"line\">  connect: -1,</span><br><span class=\"line\">  send: 0,</span><br><span class=\"line\">  <span class=\"built_in\">wait</span>: startReply.time - request.time,</span><br><span class=\"line\">  receive: endReply.time - startReply.time,</span><br><span class=\"line\">  ssl: -1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 转储所有网络请求和响应</span></span><br><span class=\"line\">phantomjs.exe ..\\examples\\netlog.js https://weiyigeek.top | more</span><br><span class=\"line\">requested: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"headers\"</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"name\"</span>: <span class=\"string\">\"Accept\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"value\"</span>: <span class=\"string\">\"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"name\"</span>: <span class=\"string\">\"User-Agent\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"value\"</span>: <span class=\"string\">\"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"id\"</span>: 1,</span><br><span class=\"line\">    <span class=\"string\">\"method\"</span>: <span class=\"string\">\"GET\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"time\"</span>: <span class=\"string\">\"2023-01-11T01:46:10.579Z\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"url\"</span>: <span class=\"string\">\"https://weiyigeek.top/\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">received: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"body\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"bodySize\"</span>: 14489,</span><br><span class=\"line\">    <span class=\"string\">\"contentType\"</span>: <span class=\"string\">\"text/html; charset=utf-8\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"headers\"</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"string\">\"name\"</span>: <span class=\"string\">\"Server\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"value\"</span>: <span class=\"string\">\"nginx\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">....</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>导入.示例1生成的HAR到可视化viewer显示（<a href=\"http://www.softwareishard.com/har/viewer/\" target=\"_blank\" rel=\"noopener\">http://www.softwareishard.com/har/viewer/</a> ）: </p>\n<p><img src=\"https://img.weiyigeek.top/2022/10/20230111095803.png\" alt=\"WeiyiGeek.HAR可视化viewer显示图\"></p>\n<p><br/></p>\n<h3 id=\"5-简单的Web服务\"><a href=\"#5-简单的Web服务\" class=\"headerlink\" title=\"5.简单的Web服务\"></a>5.简单的Web服务</h3><p>使用 PhantomJS 我们很容易实现一个 Web Server, 下面我们来实践看看。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">\"use strict\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">var</span> port, server, service,</span><br><span class=\"line\">    system = <span class=\"built_in\">require</span>(<span class=\"string\">'system'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (system.args.length !== <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'Usage: simpleserver.js &lt;portnumber&gt;'</span>);</span><br><span class=\"line\">    phantom.exit(<span class=\"number\">1</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    port = system.args[<span class=\"number\">1</span>];</span><br><span class=\"line\">    <span class=\"comment\">// 注意,此处使用依赖 webserver API ，其使用方法请参考官网 API</span></span><br><span class=\"line\">    server = <span class=\"built_in\">require</span>(<span class=\"string\">'webserver'</span>).create();</span><br><span class=\"line\"></span><br><span class=\"line\">    service = server.listen(port, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">request, response</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'Request at '</span> + <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>());</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"built_in\">JSON</span>.stringify(request, <span class=\"literal\">null</span>, <span class=\"number\">4</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        response.statusCode = <span class=\"number\">200</span>;</span><br><span class=\"line\">        response.headers = &#123;</span><br><span class=\"line\">            <span class=\"string\">'Cache'</span>: <span class=\"string\">'no-cache'</span>,</span><br><span class=\"line\">            <span class=\"string\">'Content-Type'</span>: <span class=\"string\">'text/html'</span></span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;html&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;head&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;title&gt;Hello, world!&lt;/title&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;/head&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;body&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;p&gt;This is from PhantomJS web server.&lt;/p&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;p&gt;Request data:&lt;/p&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;pre&gt;'</span> + <span class=\"built_in\">JSON</span>.stringify(request, <span class=\"literal\">null</span>, <span class=\"number\">4</span>)+<span class=\"string\">'&lt;/pre&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;p&gt;response data:&lt;/p&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;pre&gt;'</span> + <span class=\"built_in\">JSON</span>.stringify(response, <span class=\"literal\">null</span>, <span class=\"number\">4</span>)+<span class=\"string\">'&lt;/pre&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;/body&gt;'</span>);</span><br><span class=\"line\">        response.write(<span class=\"string\">'&lt;/html&gt;'</span>);</span><br><span class=\"line\">        response.close();</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (service) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'Web server running on port '</span> + port);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'Error: Could not create web server listening on port '</span> + port);</span><br><span class=\"line\">        phantom.exit();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 自己请求自己</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> url = <span class=\"string\">\"http://localhost:\"</span> + port + <span class=\"string\">\"/foo/bar.php?asdf=true\"</span>;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"SENDING REQUEST TO:\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(url);</span><br><span class=\"line\">    page.open(url, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">status</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (status !== <span class=\"string\">'success'</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">'FAIL to load the address'</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"GOT REPLY FROM SERVER:\"</span>);</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(page.content);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       phantom.exit();</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/10/20230111101451.png\" alt=\"WeiyiGeek.simpleserver图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.simpleserver图</p>\n            </figure>\n<hr>\n<h2 id=\"0x03-项目实践\"><a href=\"#0x03-项目实践\" class=\"headerlink\" title=\"0x03 项目实践\"></a>0x03 项目实践</h2><h3 id=\"1-使用Java-phantomjs实现站点截图捕获并将a标签链接标红。\"><a href=\"#1-使用Java-phantomjs实现站点截图捕获并将a标签链接标红。\" class=\"headerlink\" title=\"1.使用Java+phantomjs实现站点截图捕获并将a标签链接标红。\"></a>1.使用Java+phantomjs实现站点截图捕获并将a标签链接标红。</h3><p>此处，在Windows平台下实践，当然Linux下执行也是没有问题的，你可以需要安装相应的java环境而已。</p>\n<p><strong>2.screen-capture.js 示例文件:</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// # @Filename: 2.screen-capture.js</span></span><br><span class=\"line\"><span class=\"comment\">// # @Author: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\">// # @Description: 指定网页站点截取并生成pdf与png两种格式</span></span><br><span class=\"line\"><span class=\"comment\">// # @Create Time: 2023年1月11日 12:39:06</span></span><br><span class=\"line\"><span class=\"comment\">// # @Last Modified time: 2023年1月11日 12:39:09</span></span><br><span class=\"line\"><span class=\"comment\">// # @E-mail: master@weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\">// # @Blog: https://www.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\">// # @wechat: WeiyiGeeker</span></span><br><span class=\"line\"><span class=\"comment\">// # @Github: https://github.com/WeiyiGeek/SecOpsDev/AutomatedTesting/Web/phantomjs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> page = <span class=\"built_in\">require</span>(<span class=\"string\">'webpage'</span>).create(),</span><br><span class=\"line\">system = <span class=\"built_in\">require</span>(<span class=\"string\">'system'</span>),</span><br><span class=\"line\">url,outputType,size,nowTime;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>( system.args.length == <span class=\"number\">1</span> )&#123;  </span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">\"Usage: screen-capture.js url [png|pdf] [paperwidth*paperheight|paperformat] [zoom]\"</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'  paper (pdf output) examples: \"5in*7.5in\", \"10cm*20cm\", \"A4\", \"Letter\"'</span>);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'  image (png/jpg output) examples: \"1920px\" entire page, window width 1920px'</span>);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'                                   \"800px*600px\" window, clipped to 800x600'</span>);</span><br><span class=\"line\">  phantom.exit();  </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;  </span><br><span class=\"line\">  url = system.args[<span class=\"number\">1</span>];</span><br><span class=\"line\">  outputType = system.args[<span class=\"number\">2</span>];</span><br><span class=\"line\"> </span><br><span class=\"line\">  nowTime = <span class=\"built_in\">Date</span>.now();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 默认宽度与高度</span></span><br><span class=\"line\">  pageWidth = <span class=\"number\">1024</span>;</span><br><span class=\"line\">  pageHeight = <span class=\"number\">720</span>;</span><br><span class=\"line\">  page.viewportSize = &#123; <span class=\"attr\">width</span>: pageWidth, <span class=\"attr\">height</span>: pageHeight &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (system.args.length &gt; <span class=\"number\">3</span> &amp;&amp; outputType === <span class=\"string\">\"pdf\"</span>) &#123;</span><br><span class=\"line\">    size = system.args[<span class=\"number\">3</span>].split(<span class=\"string\">'*'</span>);</span><br><span class=\"line\">    page.paperSize = size.length === <span class=\"number\">2</span> ? &#123; <span class=\"attr\">width</span>: size[<span class=\"number\">0</span>], <span class=\"attr\">height</span>: size[<span class=\"number\">1</span>], <span class=\"attr\">margin</span>: <span class=\"string\">'0px'</span> &#125;</span><br><span class=\"line\">                                       : &#123; <span class=\"attr\">format</span>: <span class=\"string\">'A4'</span>, <span class=\"attr\">orientation</span>: <span class=\"string\">'portrait'</span>, <span class=\"attr\">margin</span>: <span class=\"string\">'1cm'</span> &#125;;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (system.args.length &gt; <span class=\"number\">3</span> &amp;&amp; system.args[<span class=\"number\">3</span>].substr(<span class=\"number\">-2</span>) === <span class=\"string\">\"px\"</span>) &#123;</span><br><span class=\"line\">    size = system.args[<span class=\"number\">3</span>].split(<span class=\"string\">'*'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (size.length === <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">      pageWidth = <span class=\"built_in\">parseInt</span>(size[<span class=\"number\">0</span>], <span class=\"number\">10</span>);</span><br><span class=\"line\">      pageHeight = <span class=\"built_in\">parseInt</span>(size[<span class=\"number\">1</span>], <span class=\"number\">10</span>);</span><br><span class=\"line\">      page.viewportSize = &#123; <span class=\"attr\">width</span>: pageWidth, <span class=\"attr\">height</span>: pageHeight &#125;;</span><br><span class=\"line\">      <span class=\"comment\">// page.clipRect = &#123; top: 0, left: 0, width: pageWidth, height: pageHeight &#125;;</span></span><br><span class=\"line\">      page.clipRect = &#123; <span class=\"attr\">top</span>: <span class=\"number\">0</span>, <span class=\"attr\">left</span>: <span class=\"number\">0</span>, <span class=\"attr\">width</span>: pageWidth &#125;;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">\"size:\"</span>, system.args[<span class=\"number\">3</span>]);</span><br><span class=\"line\">      pageWidth = <span class=\"built_in\">parseInt</span>(system.args[<span class=\"number\">3</span>], <span class=\"number\">10</span>);</span><br><span class=\"line\">      pageHeight = <span class=\"built_in\">parseInt</span>(pageWidth * <span class=\"number\">3</span>/<span class=\"number\">4</span>, <span class=\"number\">10</span>); <span class=\"comment\">// it's as good an assumption as any</span></span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log (<span class=\"string\">\"pageHeight:\"</span>,pageHeight);</span><br><span class=\"line\">      page.viewportSize = &#123; <span class=\"attr\">width</span>: pageWidth, <span class=\"attr\">height</span>: pageHeight &#125;;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (system.args.length &gt; <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">    page.zoomFactor = system.args[<span class=\"number\">4</span>];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 请求指定站点函数</span></span><br><span class=\"line\">  page.open(url, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">status</span>)</span>&#123;  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (status != <span class=\"string\">\"success\"</span>)&#123;  </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'FAIL to load the address'</span>);  </span><br><span class=\"line\">    phantom.exit();  </span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 请求站点目标页面上下文环境</span></span><br><span class=\"line\">    page.evaluate(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123; </span><br><span class=\"line\">      <span class=\"comment\">//滚动到底部  </span></span><br><span class=\"line\">      <span class=\"built_in\">window</span>.scrollTo(<span class=\"number\">0</span>,<span class=\"built_in\">document</span>.body.scrollHeight);</span><br><span class=\"line\">    </span><br><span class=\"line\">      <span class=\"comment\">// DOM 操作给所有A标签加上一个边框</span></span><br><span class=\"line\">      <span class=\"built_in\">window</span>.setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;  </span><br><span class=\"line\">        <span class=\"keyword\">var</span> plist = <span class=\"built_in\">document</span>.querySelectorAll(<span class=\"string\">\"a\"</span>);  </span><br><span class=\"line\">        <span class=\"keyword\">var</span> len = plist.length;  </span><br><span class=\"line\">        <span class=\"keyword\">while</span>(len)  </span><br><span class=\"line\">        &#123;  </span><br><span class=\"line\">            len--;  </span><br><span class=\"line\">            <span class=\"keyword\">var</span> el = plist[len];  </span><br><span class=\"line\">            el.style.border = <span class=\"string\">\"1px solid red\"</span>;  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">      &#125;, <span class=\"number\">2000</span>);  </span><br><span class=\"line\">  &#125;);  </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"built_in\">window</span>.setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>)</span>&#123;  </span><br><span class=\"line\">      <span class=\"comment\">// 在本地生成截图以及PDF</span></span><br><span class=\"line\">      filename = url.split(<span class=\"string\">\"//\"</span>)[<span class=\"number\">1</span>]+<span class=\"string\">\"_\"</span>+nowTime+<span class=\"string\">\".\"</span>+outputType;</span><br><span class=\"line\">      page.render(filename);</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(<span class=\"string\">\"Output : \"</span> + filename);</span><br><span class=\"line\">      <span class=\"comment\">// 打印html内容</span></span><br><span class=\"line\">      <span class=\"comment\">// console.log(page.content); </span></span><br><span class=\"line\">      phantom.exit();  </span><br><span class=\"line\">    &#125;, <span class=\"number\">3000</span>);      </span><br><span class=\"line\">    &#125;;  </span><br><span class=\"line\">  &#125;); </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>命令行执行:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; phantomjs.exe 2.screen-capture.js</span><br><span class=\"line\">Usage: screen-capture.js url [png|pdf|jpeg|bmp|ppm|gif] [paperwidth*paperheight|paperformat] [zoom]</span><br><span class=\"line\">  paper (pdf output) examples: <span class=\"string\">\"5in*7.5in\"</span>, <span class=\"string\">\"10cm*20cm\"</span>, <span class=\"string\">\"A4\"</span>, <span class=\"string\">\"Letter\"</span></span><br><span class=\"line\">  image (png/jpg output) examples: <span class=\"string\">\"1920px\"</span> entire page, window width 1920px</span><br><span class=\"line\">                                   <span class=\"string\">\"800px*600px\"</span> window, clipped to 800x600</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; phantomjs.exe 2.screen-capture.js https://blog.weiyigeek.top/2018/1-1-1.html png 1024px*720px</span><br><span class=\"line\">Output : blog.weiyigeek.top/2018/1-1-1.html_1673407992804.png</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; phantomjs.exe 2.screen-capture.js https://blog.weiyigeek.top/2018/1-1-1.html pdf 1024px*720px</span><br><span class=\"line\">Output : blog.weiyigeek.top/2018/1-1-1.html_1673408871418.pdf</span><br></pre></td></tr></table></figure></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/10/20230111120117.png\" alt=\"WeiyiGeek.生成PDF与PNG图片\" title=\"\" class=\"\">\n                <p>WeiyiGeek.生成PDF与PNG图片</p>\n            </figure>\n<p><br/></p>\n<p>此处使用java操作phantomjs的代码示例:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> top.weiyigeek.weixin;  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.BufferedReader;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStream;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStreamReader;  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\"> * 类名： DownLoad </span></span><br><span class=\"line\"><span class=\"comment\"> * 包名： top.weiyigeek.weixin </span></span><br><span class=\"line\"><span class=\"comment\"> * 作者：  </span></span><br><span class=\"line\"><span class=\"comment\"> * 时间：</span></span><br><span class=\"line\"><span class=\"comment\"> * 描述： TODO(这里用一句话描述这个类的作用)  </span></span><br><span class=\"line\"><span class=\"comment\"> */</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicDownLoad</span> </span>&#123;  </span><br><span class=\"line\">    <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">     * 方法名：getSrcContent </span></span><br><span class=\"line\"><span class=\"comment\">     * 作者：</span></span><br><span class=\"line\"><span class=\"comment\">     * 创建时间：</span></span><br><span class=\"line\"><span class=\"comment\">     * 描述：根据传入的url，调用phantomjs进行下载，并返回源码信息 </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> url </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> </span></span><br><span class=\"line\"><span class=\"comment\">     */</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">getSrcContent</span><span class=\"params\">(String url, String type)</span></span>&#123;  </span><br><span class=\"line\">      <span class=\"comment\">//windows下phantomjs位置  </span></span><br><span class=\"line\">      String path = <span class=\"string\">\"L:/DevOps/自动化测试/模拟浏览器访问/PhantomJS/phantomjs-2.1.1-windows/bin\"</span>;  </span><br><span class=\"line\">      Runtime rt = Runtime.getRuntime();  </span><br><span class=\"line\">      Process process = <span class=\"keyword\">null</span>;  </span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">        process = rt.exec(path + <span class=\"string\">\"phantomjs.exe L:/example/2.screen-capture.js\"</span> + url.trim() + <span class=\"string\">\" \"</span> + type.trim());  </span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;  </span><br><span class=\"line\">        <span class=\"comment\">// TODO 这里写异常处理的代码  </span></span><br><span class=\"line\">        e.printStackTrace();  </span><br><span class=\"line\">      &#125;  </span><br><span class=\"line\">      InputStream is = process.getInputStream();  </span><br><span class=\"line\">      BufferedReader br = <span class=\"keyword\">new</span> BufferedReader(<span class=\"keyword\">new</span> InputStreamReader(is));  </span><br><span class=\"line\">      StringBuffer sbf = <span class=\"keyword\">new</span> StringBuffer();  </span><br><span class=\"line\">      String tmp = <span class=\"string\">\"\"</span>;  </span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">while</span>((tmp = br.readLine())!=<span class=\"keyword\">null</span>)&#123;    </span><br><span class=\"line\">          sbf.append(tmp);    </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;  </span><br><span class=\"line\">        <span class=\"comment\">// TODO 这里写异常处理的代码  </span></span><br><span class=\"line\">        e.printStackTrace();  </span><br><span class=\"line\">      &#125;  </span><br><span class=\"line\">      <span class=\"keyword\">return</span> sbf.toString();  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">      </span><br><span class=\"line\">    <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">     * 方法名：main </span></span><br><span class=\"line\"><span class=\"comment\">     * 作者：</span></span><br><span class=\"line\"><span class=\"comment\">     * 创建时间：</span></span><br><span class=\"line\"><span class=\"comment\">     * 描述：TODO (这里用一句话描述这个方法的作用) </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> args </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> IOException  </span></span><br><span class=\"line\"><span class=\"comment\">     */</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span></span>&#123;  </span><br><span class=\"line\">      <span class=\"comment\">// TODO Auto-generated method stub  </span></span><br><span class=\"line\">      String src = DynamicDownLoad.getSrcContent(<span class=\"string\">\"https://weiyigeek.top\"</span>,<span class=\"string\">\"pdf\"</span>,<span class=\"string\">\"1024px*720px\"</span>);  </span><br><span class=\"line\">      System.out.println(src);</span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>补充：对于延迟截图，还是有个问题，就是无法监听ajax或者资源是否完整加载导致页面不全；解决方案 viewport设置一个比截图高度的矮，通过比较生产图片的高度来判断截取图片的结果</p>\n<h3 id=\"2-监控网站主页变化并截图到企业微信预警\"><a href=\"#2-监控网站主页变化并截图到企业微信预警\" class=\"headerlink\" title=\"2.监控网站主页变化并截图到企业微信预警\"></a>2.监控网站主页变化并截图到企业微信预警</h3><p>好，下面来到了我们项目实践了，主要实现的功能是利用Shell脚本以及crontab定时任务以及 PhantomJS 来监控网站首页的变化，并以截图的方式通知给企业微信对应运维群，及时了解网站运行安全，防止网站主页被黑、被劫持的风险。</p>\n<p>此处我是在CentOS7中实现的，安装方法请参考前面章节。</p>\n<p>项目地址: <a href=\"https://github.com/WeiyiGeek/SecOpsDev/tree/master/AutomatedTesting/Web/phantomjs/Project/Shell\" target=\"_blank\" rel=\"noopener\">https://github.com/WeiyiGeek/SecOpsDev/tree/master/AutomatedTesting/Web/phantomjs/Project/Shell</a></p>\n<p>(PS: 文章中示例代码可能随着时间推移会有更新，建议小伙伴通过上面👆Github地址获取哟!)</p>\n<p><strong>项目脚本与PhantomJS脚本文件</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/GitProject/SecOpsDev1/AutomatedTesting/Web/phantomjs/Project/Shell </span><br><span class=\"line\">1.WebScreenCapture.sh  screen-capture.js</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir /usr/<span class=\"built_in\">local</span>/src/phantomjs/custom</span><br><span class=\"line\">cp screen-capture.js /usr/<span class=\"built_in\">local</span>/src/phantomjs/custom</span><br><span class=\"line\"><span class=\"comment\"># 注意，此处建议将 screen-capture.js 放在 /usr/local/src/phantomjs/custom 目录中</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p><strong>Shell 脚本 WebMonitorScreenCapture.sh</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">## @Title: 使用phantomjs针对网站首页监控预与监控检测并进行企业微信预警</span></span><br><span class=\"line\"><span class=\"comment\">## @Author: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\">## @CreateTime: 2023年1月11日 15点34分</span></span><br><span class=\"line\"><span class=\"comment\">## @微信: WeiyiGeeker</span></span><br><span class=\"line\"><span class=\"comment\">## @Blog: https://blog.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\">## @Version: 1.3</span></span><br><span class=\"line\"><span class=\"comment\"># set -e</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 监控目标站点配置文件</span></span><br><span class=\"line\">MONITORSITE=/tmp/target.txt</span><br><span class=\"line\">cat &gt; <span class=\"variable\">$&#123;MONITORSITE&#125;</span> &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">https://www.weiyigeek.top</span><br><span class=\"line\">https://blog.weiyigeek.top</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全局变量</span></span><br><span class=\"line\"><span class=\"comment\"># 请将此处修改为你企业微信机器人webhook地址</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> WXMSGURL=<span class=\"string\">\"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=51648169-7638-43a4-97d6-dfd39b48ea23\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> NETTYPE=<span class=\"string\">\"外网访问\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HCMSG=<span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> XKMSG=<span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> ZHCXMSG=<span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"comment\"># 安装使用phantomjs时报 ` libproviders.so: cannot open shared object file:` 错误时需要取消如下注释。</span></span><br><span class=\"line\"><span class=\"comment\"># export OPENSSL_CONF=/dev/null</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: DependencyCheck</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 脚本运行依赖检测</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">DependencyCheck</span></span>()&#123;</span><br><span class=\"line\">  phantomjs -v &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"$?\"</span> != <span class=\"string\">\"0\"</span> ]];<span class=\"keyword\">then</span> <span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\e[31m[Error] Phantomjs NotFound,Please Install this! \\e[0m\"</span>;<span class=\"built_in\">exit</span> 0;<span class=\"keyword\">fi</span></span><br><span class=\"line\">  jq --version &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"$?\"</span> != <span class=\"string\">\"0\"</span> ]];<span class=\"keyword\">then</span> <span class=\"built_in\">echo</span> -e <span class=\"string\">\"\\e[31m[Error] Phantomjs jq,Please Install jq! \\n$ yum install jq \\e[0m\"</span>;<span class=\"built_in\">exit</span> 0;<span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: SendWXMsg</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 企业微信消息机器人消息发送</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">SendWXMsg</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"text\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"comment\">#text 格式</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"variable\">$2</span> <span class=\"keyword\">in</span> </span><br><span class=\"line\">    <span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">'&#123;\"msgtype\":\"text\",\"text\":&#123;\"mentioned_list\":[\"@all\"],\"content\":\"访问类型:'</span><span class=\"variable\">$&#123;NETTYPE&#125;</span><span class=\"string\">'\\n报警类型:'</span><span class=\"variable\">$3</span><span class=\"string\">'\\n监控地址:'</span><span class=\"variable\">$&#123;TARGETURL&#125;</span><span class=\"string\">'\\n报警信息:'</span><span class=\"variable\">$4</span><span class=\"string\">'\"&#125;&#125;'</span> &gt; text.json</span><br><span class=\"line\">       ;;</span><br><span class=\"line\">    <span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">'&#123;\"msgtype\":\"text\",\"text\":&#123;\"mentioned_list\":[\"@all\"],\"content\":\"访问类型:'</span><span class=\"variable\">$&#123;NETTYPE&#125;</span><span class=\"string\">'\\n报警类型:'</span><span class=\"variable\">$3</span><span class=\"string\">'\\n监控地址:'</span><span class=\"variable\">$&#123;TARGETURL&#125;</span><span class=\"string\">'\\n报警信息:'</span><span class=\"variable\">$4</span><span class=\"string\">'异常标识校验值:'</span><span class=\"variable\">$5</span><span class=\"string\">'\\n备注:网站预览图生成上传中.\"&#125;&#125;'</span> &gt; text.json</span><br><span class=\"line\">      ;;</span><br><span class=\"line\">    *)</span><br><span class=\"line\">        sleep 1</span><br><span class=\"line\">      ;;</span><br><span class=\"line\">    <span class=\"keyword\">esac</span></span><br><span class=\"line\">    sed -i <span class=\"string\">'s#_#\\\\n#g'</span> text.json</span><br><span class=\"line\">    curl <span class=\"variable\">$&#123;WXMSGURL&#125;</span> -X POST -H <span class=\"string\">\"Content-Type:application/json\"</span> -d@text.json</span><br><span class=\"line\">  <span class=\"keyword\">elif</span> [[ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"image\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"comment\">#image 格式</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">'&#123;\"msgtype\":\"image\",\"image\":&#123;\"base64\":\"'</span><span class=\"variable\">$2</span><span class=\"string\">'\",\"md5\":\"'</span><span class=\"variable\">$3</span><span class=\"string\">'\"&#125;&#125;'</span> &gt; data.json</span><br><span class=\"line\">    curl <span class=\"variable\">$&#123;WXMSGURL&#125;</span> -X POST -H <span class=\"string\">\"Content-Type:application/json\"</span> -d@data.json</span><br><span class=\"line\">  <span class=\"keyword\">elif</span> [[ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"markdown\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"comment\">#markdown 格式</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$2</span>\"</span> == <span class=\"string\">\"1\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">'&#123;\"msgtype\":\"markdown\",\"markdown\":&#123;\"content\":\"**'</span><span class=\"variable\">$3</span><span class=\"string\">'**\\n&gt; 访问类型:'</span><span class=\"variable\">$&#123;NETTYPE&#125;</span><span class=\"string\">'访问\\n&gt; 应用状态信息:&lt;font color=\\\"info\\\"&gt;\\n'</span><span class=\"variable\">$4</span><span class=\"string\">'&lt;/font&gt;\"&#125;&#125;'</span> &gt; markdown.json</span><br><span class=\"line\">      sed -i <span class=\"string\">'s#_#\\\\n#g'</span> markdown.json</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">     curl <span class=\"variable\">$&#123;WXMSGURL&#125;</span> -X POST -H <span class=\"string\">\"Content-Type:application/json\"</span> -d@markdown.json</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    sleep</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: TargetMD5</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 目标站点首页的MD5值生成</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">TargetMD5</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"comment\"># 判断文件是否存在</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ ! -d <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETDIR&#125;</span>\"</span> ]];<span class=\"keyword\">then</span> <span class=\"built_in\">echo</span> <span class=\"string\">\"Create directory <span class=\"variable\">$&#123;TARGETDIR&#125;</span>.....\"</span>;mkdir -p <span class=\"variable\">$TARGETDIR</span>; <span class=\"keyword\">fi</span> </span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ ! -f <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETFILE&#125;</span>\"</span> ]]; <span class=\"keyword\">then</span> curl -m 15 <span class=\"variable\">$&#123;TARGETURL&#125;</span> -o <span class=\"variable\">$&#123;TARGETFILE&#125;</span>; <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> TARGETFILEMD5=$(md5sum <span class=\"variable\">$&#123;TARGETFILE&#125;</span> | awk -F <span class=\"string\">' '</span> <span class=\"string\">'&#123;print $1&#125;'</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: Record</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 网站首页指纹(md5值)比对以及网页截图</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">Record</span></span>()&#123; </span><br><span class=\"line\">   curl -m 20 <span class=\"variable\">$&#123;TARGETURL&#125;</span> -o <span class=\"variable\">$&#123;RECORDFILE&#125;</span></span><br><span class=\"line\">   <span class=\"built_in\">export</span> RECORDFILEMD5=<span class=\"string\">\"<span class=\"variable\">$(md5sum $_ | awk -F '  ' '&#123;print $1&#125;')</span>\"</span>  </span><br><span class=\"line\">   <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETFILEMD5&#125;</span>MD5\"</span> != <span class=\"string\">\"<span class=\"variable\">$&#123;RECORDFILEMD5&#125;</span>MD5\"</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"comment\"># 异常信息记录</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;RECORDFILE&#125;</span>-<span class=\"variable\">$&#123;RECORDFILEMD5&#125;</span>\"</span> &gt;&gt; <span class=\"variable\">$&#123;TARGETDIR&#125;</span>exception.log</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 差异比对</span></span><br><span class=\"line\">      DIFFTEXT=$(diff --normal <span class=\"variable\">$&#123;TARGETFILE&#125;</span> <span class=\"variable\">$&#123;RECORDFILE&#125;</span> | egrep <span class=\"string\">\"^[0-9]\"</span> | tr <span class=\"string\">'\\n'</span> <span class=\"string\">'__'</span> )</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 使用 phantomjs 生成截图</span></span><br><span class=\"line\">      /usr/<span class=\"built_in\">local</span>/bin/phantomjs /usr/<span class=\"built_in\">local</span>/src/phantomjs/custom/screen-capture.js <span class=\"variable\">$&#123;TARGETURL&#125;</span> <span class=\"variable\">$&#123;RECORDFILE&#125;</span>.png</span><br><span class=\"line\">      IMGMD5=<span class=\"string\">\"<span class=\"variable\">$(md5sum $&#123;RECORDFILE&#125;.png| awk -F '  ' '&#123;print $1&#125;')</span>\"</span></span><br><span class=\"line\">      IMGBASE64=<span class=\"string\">\"<span class=\"variable\">$(base64 -w 0 &lt; $&#123;RECORDFILE&#125;.png)</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 信息发送</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"text\"</span> <span class=\"string\">\"2\"</span> <span class=\"string\">\"网站修改提醒\"</span> <span class=\"string\">\"被修改的行数:\\n<span class=\"variable\">$&#123;DIFFTEXT&#125;</span>\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;RECORDFILEMD5&#125;</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">      sleep 1</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 网页截图发送 (外网发送)</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"image\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;IMGBASE64&#125;</span>\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;IMGMD5&#125;</span>\"</span> </span><br><span class=\"line\">      cp -f <span class=\"variable\">$&#123;RECORDFILE&#125;</span> <span class=\"variable\">$&#123;TARGETFILE&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 发送警告次数</span></span><br><span class=\"line\">      RCOUNT=RCOUNT<span class=\"variable\">$&#123;FLAG&#125;</span></span><br><span class=\"line\">      <span class=\"built_in\">let</span> <span class=\"variable\">$&#123;RCOUNT&#125;</span>+=1</span><br><span class=\"line\">      <span class=\"built_in\">export</span> <span class=\"variable\">$&#123;RCOUNT&#125;</span>=<span class=\"variable\">$&#123;!RCOUNT&#125;</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;!RCOUNT&#125;</span> -eq 1 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">        cp -f <span class=\"variable\">$&#123;RECORDFILE&#125;</span> <span class=\"variable\">$&#123;TARGETFILE&#125;</span></span><br><span class=\"line\">        <span class=\"built_in\">export</span> <span class=\"variable\">$&#123;RCOUNT&#125;</span>=0</span><br><span class=\"line\">      <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span> </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: SiteMonitorCheck</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 网站访问异常检测</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">SiteMonitorCheck</span></span> ()&#123;</span><br><span class=\"line\">    STATUS=$(curl -I -m 10 -s -o /dev/null -w <span class=\"string\">\"%&#123;http_code&#125;\"</span> <span class=\"variable\">$&#123;TARGETURL&#125;</span> )</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ $? -ne 0 ]];<span class=\"keyword\">then</span> STATUS=<span class=\"string\">\"CLOSE\"</span>;<span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"comment\"># 当系统故障关闭后只推送三次，然后恢复正常时候又重新计数</span></span><br><span class=\"line\">    COUNT=COUNT<span class=\"variable\">$&#123;FLAG&#125;</span></span><br><span class=\"line\">    <span class=\"built_in\">let</span> <span class=\"variable\">$&#123;COUNT&#125;</span>+=1</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$STATUS</span>\"</span> == <span class=\"string\">\"200\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      Record</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [[ <span class=\"string\">\"<span class=\"variable\">$STATUS</span>\"</span> == <span class=\"string\">\"200\"</span> &amp;&amp; <span class=\"variable\">$&#123;!COUNT&#125;</span> -gt 2 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">export</span> <span class=\"variable\">$&#123;COUNT&#125;</span>=0</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [[ <span class=\"string\">\"<span class=\"variable\">$STATUS</span>\"</span> == <span class=\"string\">\"302\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">local</span> LOCATION=$(curl -I -m 10 -s  <span class=\"variable\">$&#123;TARGETURL&#125;</span> | egrep <span class=\"string\">\"^Location\"</span> | tr -d <span class=\"string\">'\\r'</span> | cut -d <span class=\"string\">\"/\"</span> -f 3)</span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"text\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"请求跳转异常地址\"</span> <span class=\"string\">\"_HTTP响应码:<span class=\"variable\">$&#123;STATUS&#125;</span>_跳转地址:<span class=\"variable\">$&#123;LOCATION&#125;</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">elif</span> [[ <span class=\"string\">\"<span class=\"variable\">$STATUS</span>\"</span> == <span class=\"string\">\"CLOSE\"</span> &amp;&amp; <span class=\"variable\">$&#123;mcount&#125;</span> -le 2 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"text\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"访问异常\"</span> <span class=\"string\">\"外网无法访问该网站\"</span> </span><br><span class=\"line\">      <span class=\"built_in\">export</span> <span class=\"variable\">$&#123;COUNT&#125;</span>=<span class=\"variable\">$&#123;!COUNT&#125;</span></span><br><span class=\"line\">      <span class=\"built_in\">continue</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;STATUS&#125;</span>\"</span> == <span class=\"string\">\"403\"</span> &amp;&amp; <span class=\"string\">\"<span class=\"variable\">$(echo $&#123;TARGETURL&#125; | egrep -c \"40081|30081\")</span> == '1'\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">       Record</span><br><span class=\"line\">       <span class=\"built_in\">continue</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        SendWXMsg <span class=\"string\">\"text\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"请求返回响应码异常\"</span> <span class=\"string\">\"HTTP响应码[<span class=\"variable\">$&#123;STATUS&#125;</span>]\"</span></span><br><span class=\"line\">      <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: HealthCheck</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 网页站点外网访问检测</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">HealthCheck</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$NETTYPE</span>\"</span> == <span class=\"string\">\"外网\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">local</span> CHECK=$(curl -m 15 -o /dev/null -s -w <span class=\"string\">\"DNS解析耗时: \"</span>%&#123;time_namelookup&#125;<span class=\"string\">\"s_重定向耗时: \"</span>%&#123;time_redirect&#125;<span class=\"string\">\"s_TCP连接耗时: \"</span>%&#123;time_connect&#125;<span class=\"string\">\"s_请求准备耗时: \"</span>%&#123;time_pretransfer&#125;<span class=\"string\">\"s_应用连接耗时: \"</span>%&#123;time_appconnect&#125;<span class=\"string\">\"s_传输耗时: \"</span>%&#123;time_starttransfer&#125;<span class=\"string\">\"s_下载速度: \"</span>%&#123;speed_download&#125;<span class=\"string\">\"byte/s_整体请求响应耗时: \"</span>%&#123;time_total&#125;<span class=\"string\">\"s\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETURL&#125;</span>\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ $? -eq 0 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"markdown\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;NETTYPE&#125;</span>-检查网站连接状态\"</span> <span class=\"string\">\"__&gt; <span class=\"variable\">$&#123;CHECK&#125;</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"markdown\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;NETTYPE&#125;</span>-检查网站连接状态\"</span> <span class=\"string\">\"巡检地址: <span class=\"variable\">$&#123;TARGETURL&#125;</span>__&gt; 巡检信息: 访问异常\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">local</span> CHECK=$(curl -m 10 -o /dev/null -s -w <span class=\"string\">\"%&#123;http_code&#125;\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETURL&#125;</span>\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ $? -ne 0 || <span class=\"string\">\"<span class=\"variable\">$CHECK</span>\"</span> != <span class=\"string\">\"200\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">export</span> HCMSG=<span class=\"string\">\"<span class=\"variable\">$&#123;HCMSG&#125;</span>__&gt; 巡检地址: <span class=\"variable\">$&#123;TARGETURL&#125;</span>_巡检信息: 异常\"</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"comment\"># export HCMSG=\"$&#123;HCMSG&#125;__&gt; 巡检地址: $&#123;TARGETURL&#125;_巡检信息: 正常\"</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> .</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: XKservice</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 指定应用监控埋点</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">XKservice</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$NETTYPE</span>\"</span> == <span class=\"string\">\"外网\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">local</span> CHECK=$(<span class=\"built_in\">echo</span> <span class=\"variable\">$TARGETURL</span> | egrep -c <span class=\"string\">\"xk\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[  <span class=\"string\">\"<span class=\"variable\">$CHECK</span>\"</span> == <span class=\"string\">\"1\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      curl -m 15 -s <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETURL&#125;</span>/app/version\"</span> -o xk.json</span><br><span class=\"line\">      <span class=\"built_in\">local</span> STATUS=$(jq <span class=\"string\">'\"应用状态:\"+(.code|tostring)+\"_应用信息:\"+(.msg|tostring)+\"_当前应用版本:\"+(.data.version)'</span> xk.json  | tr -d <span class=\"string\">'\"'</span>)</span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"markdown\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"应用埋点监控\"</span> <span class=\"string\">\"__&gt; <span class=\"variable\">$&#123;STATUS&#125;</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">local</span> CHECK=$(<span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETURL&#125;</span>\"</span> | egrep -c <span class=\"string\">\"8010|9010\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$CHECK</span>\"</span> == <span class=\"string\">\"1\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      curl -m 15 -s <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETURL&#125;</span>/app/version\"</span> -o xk.json</span><br><span class=\"line\">      <span class=\"built_in\">local</span> STATUS=$(jq -M <span class=\"string\">'\"_Status:\"+(.code|tostring)+\"_Msg:\"+(.msg|tostring)+\"_Version:\"+(.data.version)'</span> xk.json  | tr -d <span class=\"string\">'\"'</span>)</span><br><span class=\"line\">      <span class=\"built_in\">export</span> XKMSG=<span class=\"string\">\"<span class=\"variable\">$&#123;XKMSG&#125;</span>__&gt; 应用地址:<span class=\"variable\">$&#123;TARGETURL&#125;</span>_<span class=\"variable\">$&#123;STATUS&#125;</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: InnerAppServices</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 内部应用服务监控埋点</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">InnerAppServices</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$(echo $TARGETURL| egrep -c '40081|30081')</span>\"</span> == <span class=\"string\">\"1\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    curl -m 15 -s <span class=\"string\">\"<span class=\"variable\">$&#123;TARGETURL&#125;</span>/user/getVersion.htmls\"</span> -o innerApp.json</span><br><span class=\"line\">    STATUS=$(jq -M <span class=\"string\">'\"_Status:\"+(.db|tostring)+\"_Version:\"+(.version|tostring)'</span> innerApp.json | tr -d <span class=\"string\">'\"'</span>)</span><br><span class=\"line\">    <span class=\"built_in\">export</span> ZHCXMSG=<span class=\"string\">\"<span class=\"variable\">$&#123;ZHCXMSG&#125;</span>__&gt; 应用地址:<span class=\"variable\">$&#123;TARGETURL&#125;</span>_<span class=\"variable\">$&#123;STATUS&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"comment\"># 名称: main</span></span><br><span class=\"line\"><span class=\"comment\"># 说明: 脚本主执行入口</span></span><br><span class=\"line\"><span class=\"comment\"># 参数: 无</span></span><br><span class=\"line\"><span class=\"comment\"># 返回值: 无</span></span><br><span class=\"line\"><span class=\"comment\">################################</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">main</span></span>()&#123;</span><br><span class=\"line\">  <span class=\"comment\"># 依赖检测</span></span><br><span class=\"line\">  DependencyCheck</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 目标监控</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> $(cat <span class=\"variable\">$&#123;MONITORSITE&#125;</span>);<span class=\"keyword\">do</span></span><br><span class=\"line\">    CHECK=$(<span class=\"built_in\">echo</span> <span class=\"variable\">$i</span> | egrep -c <span class=\"string\">\"^#\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$CHECK</span>\"</span> == <span class=\"string\">\"1\"</span> ]];<span class=\"keyword\">then</span> <span class=\"built_in\">continue</span>;<span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> TARGETURL=<span class=\"variable\">$i</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> URL=$(<span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>|cut -f 3 -d <span class=\"string\">'/'</span>)</span><br><span class=\"line\">    <span class=\"built_in\">export</span> TARGETDIR=<span class=\"string\">\"/var/log/WebScreenCapture/<span class=\"variable\">$&#123;URL&#125;</span>/\"</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> TARGETFILE=<span class=\"string\">\"<span class=\"variable\">$&#123;TARGETDIR&#125;</span>index.html\"</span></span><br><span class=\"line\">    <span class=\"built_in\">export</span> RECORDFILE=<span class=\"string\">\"<span class=\"variable\">$&#123;TARGETDIR&#125;</span><span class=\"variable\">$(date +%Y%m%d%H%M%S)</span>-index.html\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 目标MD5值</span></span><br><span class=\"line\">    TargetMD5</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span> == <span class=\"string\">\"H\"</span>  ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      HealthCheck</span><br><span class=\"line\">      XKservice</span><br><span class=\"line\">      InnerAppServices</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"built_in\">let</span> FLAG+=1</span><br><span class=\"line\">      <span class=\"built_in\">export</span> FLAG=<span class=\"variable\">$&#123;FLAG&#125;</span></span><br><span class=\"line\">      SiteMonitorCheck</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 指定应用执行完毕后</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$1</span>\"</span>  == <span class=\"string\">\"H\"</span> &amp;&amp; <span class=\"string\">\"<span class=\"variable\">$NETTYPE</span>\"</span> == <span class=\"string\">\"内网\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;#HCMSG&#125;</span>\"</span> != <span class=\"string\">\"0\"</span> ]];<span class=\"keyword\">then</span> </span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"markdown\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;NETTYPE&#125;</span>-业务应用运行情况巡查\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;HCMSG&#125;</span>_检测时间:<span class=\"variable\">$(date +%Y-%m-%d~%H:%M:%S)</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"markdown\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;NETTYPE&#125;</span>-业务应用运行情况巡查\"</span> <span class=\"string\">\"所有被监控业务正常_检测时间:<span class=\"variable\">$(date +%Y-%m-%d~%H:%M:%S)</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;#XKMSG&#125;</span>\"</span> != <span class=\"string\">\"0\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"markdown\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;NETTYPE&#125;</span>-xk应用系统监控\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;XKMSG&#125;</span>_检测时间:<span class=\"variable\">$(date +%Y-%m-%d~%H:%M:%S)</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [[ <span class=\"string\">\"<span class=\"variable\">$&#123;#ZHCXMSG&#125;</span>\"</span> != <span class=\"string\">\"0\"</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"variable\">$&#123;ZHCXKMSG&#125;</span></span><br><span class=\"line\">      SendWXMsg <span class=\"string\">\"markdown\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;NETTYPE&#125;</span>-zhcx应用系统监控\"</span> <span class=\"string\">\"<span class=\"variable\">$&#123;ZHCXMSG&#125;</span>_检测时间:<span class=\"variable\">$(date +%Y-%m-%d~%H:%M:%S)</span>\"</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main <span class=\"variable\">$1</span></span><br><span class=\"line\"><span class=\"comment\"># export HCMSG=\"\"</span></span><br><span class=\"line\"><span class=\"comment\"># export XKMSG=\"\"</span></span><br><span class=\"line\"><span class=\"comment\"># export ZHCXMSG=\"\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> FLAG=0</span><br></pre></td></tr></table></figure></p>\n<p>脚本执行及其结果:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 代码执行</span></span><br><span class=\"line\">chmod +x /1.WebScreenCapture.sh</span><br><span class=\"line\">./1.WebScreenCapture.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /var/<span class=\"built_in\">log</span>/WebScreenCapture/www.baidu.com</span><br><span class=\"line\">ls /var/<span class=\"built_in\">log</span>/WebScreenCapture/www.com</span><br><span class=\"line\">20230111172153-index.html  20230111172153-index.html.png  20230111173604-index.html  data.json  exception.log  index.html  text.json</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/10/20230111172323.png\" alt=\"WeiyiGeek.PhantomJS网站监控预警图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.PhantomJS网站监控预警图</p>\n            </figure></p>\n<p><strong>补充扩展</strong>: 我们可以将该脚本加入到cron中定时每一分钟或3分钟执行一次监控。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ crontab -e</span><br><span class=\"line\"><span class=\"comment\"># m h  dom mon dow   command</span></span><br><span class=\"line\">*/1 * * * * bash -c /tmp/1.WebScreenCapture.sh</span><br></pre></td></tr></table></figure>\n<p>温馨提示: 当然你也可以将脚本进行修改，支持钉钉机器人以及自己编写的webhook实现QQ或者微信预警。</p>\n<p>至此完毕，完毕更多运维奇技淫巧，请关注 【WeiyiGeek】哟。</p>\n<p><br/></p>\n<h2 id=\"0x0n-入坑出坑\"><a href=\"#0x0n-入坑出坑\" class=\"headerlink\" title=\"0x0n 入坑出坑\"></a>0x0n 入坑出坑</h2><h3 id=\"问题1-在Ubuntu-22-04中安装phantomjs时报-libproviders-so-cannot-open-shared-object-file-错误。\"><a href=\"#问题1-在Ubuntu-22-04中安装phantomjs时报-libproviders-so-cannot-open-shared-object-file-错误。\" class=\"headerlink\" title=\"问题1.在Ubuntu 22.04中安装phantomjs时报 libproviders.so: cannot open shared object file: 错误。\"></a>问题1.在Ubuntu 22.04中安装phantomjs时报 <code>libproviders.so: cannot open shared object file:</code> 错误。</h3><ul>\n<li>错误信息:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ phantomjs -v</span><br><span class=\"line\">Auto configuration failed</span><br><span class=\"line\">139744413173696:error:25066067:DSO support routines:DLFCN_LOAD:could not load the shared library:dso_dlfcn.c:185:filename(libproviders.so): libproviders.so: cannot open shared object file: No such file or directory</span><br><span class=\"line\">139744413173696:error:25070067:DSO support routines:DSO_load:could not load the shared library:dso_lib.c:244:</span><br><span class=\"line\">139744413173696:error:0E07506E:configuration file routines:MODULE_LOAD_DSO:error loading dso:conf_mod.c:285:module=providers, path=providers</span><br><span class=\"line\">139744413173696:error:0E076071:configuration file routines:MODULE_RUN:unknown module name:conf_mod.c:222:module=providers</span><br></pre></td></tr></table></figure></li>\n<li>问题原因: 因为Ubuntu 22.04 使用新的 OpenSSL 版本 3.0.2 而不是旧的 OpenSSL 版本 1.1.1 ,这些 OpenSSL 版本不完全向后兼容，所以这就是为什么您在 PhantomJS 尝试自动配置 SSL/TLS 设置时看到此错误的原因。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl version</span><br><span class=\"line\">OpenSSL 3.0.2 15 Mar 2022 (Library: OpenSSL 3.0.2 15 Mar 2022)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>解决办法: <code>export OPENSSL_CONF=/dev/null</code></li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"自动化测试","path":"api/categories/自动化测试.json"},{"name":"运维工具","path":"api/categories/运维工具.json"}],"tags":[{"name":"PhantomJS","path":"api/tags/PhantomJS.json"}]}