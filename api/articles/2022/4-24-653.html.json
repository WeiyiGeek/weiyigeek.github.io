{"title":"Redis内存数据库环境快速搭建部署","slug":"系统运维/快速部署/Redis","date":"2022-04-24T02:30:30.000Z","updated":"2022-10-09T11:25:16.572Z","url":"2022/4-24-653.html","path":"api/articles/2022/4-24-653.html.json","covers":["https://img.weiyigeek.top/2022/5/20221009184109.png","https://img.weiyigeek.top/2022/5/20221009181636.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"前言简述\"><a href=\"#前言简述\" class=\"headerlink\" title=\"前言简述\"></a>前言简述</h2><p>本章作者实践在 Docker 以及 kubernetes 环境中，快速部署生产环境中所使用的 Redis 内存数据库，帮助 devops工作者 以及 dev 开发者节省部署和开发时间。</p>\n<p>如果你还不了解 Redis 数据库的朋友，可以参考我的【<code>Redis学习之路</code>】系列笔记帮助你快速入门Redis数据库, 关注 WeiyiGeek 公众号回复【<code>Redis学习之路汇总</code>】即可获得学习资料, 或访问如下链接<br><a href=\"https://www.weiyigeek.top/wechat.html?key=Redis学习之路汇总\" target=\"_blank\" rel=\"noopener\">https://www.weiyigeek.top/wechat.html?key=Redis学习之路汇总</a></p>\n<h2 id=\"Docker-快速部署单实例-redis-数据库\"><a href=\"#Docker-快速部署单实例-redis-数据库\" class=\"headerlink\" title=\"Docker 快速部署单实例 redis 数据库\"></a>Docker 快速部署单实例 redis 数据库</h2><p>温馨提示：此处实践环境是使用Docker,若你没有安装Docker环境或者不了解的Docker容器的朋友，可以参考博主学习【<code>Docker的系列笔记</code>】汇总, 关注 WeiyiGeek 公众号回复【<code>Docker容器学习之路汇总</code>】即可获得学习资料:<br><a href=\"https://www.weiyigeek.top/wechat.html?key=Docker容器学习之路汇总\" target=\"_blank\" rel=\"noopener\">https://www.weiyigeek.top/wechat.html?key=Docker容器学习之路汇总</a></p>\n<p><strong>Shell 命令示例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -vp /app/redis/data</span><br><span class=\"line\">tee /app/redis/redis.conf &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># Author: WeiyiGeek</span></span><br><span class=\"line\"><span class=\"comment\"># blog: https://blog.weiyigeek.top</span></span><br><span class=\"line\"><span class=\"comment\"># 绑定任意接口、服务端口、后台运行。</span></span><br><span class=\"line\"><span class=\"built_in\">bind</span> 0.0.0.0</span><br><span class=\"line\">port 6379</span><br><span class=\"line\"><span class=\"comment\"># 容器里必须设置为no</span></span><br><span class=\"line\">daemonize no</span><br><span class=\"line\">supervised auto</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># redis服务pid进程文件名</span></span><br><span class=\"line\">pidfile <span class=\"string\">\"/var/run/redis.pid\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭保护模式，并配置使用密码访问</span></span><br><span class=\"line\">protected-mode no</span><br><span class=\"line\">requirepass <span class=\"string\">\"123456\"</span></span><br><span class=\"line\"><span class=\"comment\"># echo -e \"weiyigeek\"|sha256sum </span></span><br><span class=\"line\"><span class=\"comment\"># requirepass 097575a79efcd7ea7b1efa2bcda78a4fc7cbd0820736b2f2708e72c3d21f8b61</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 数据文件保存路径，rdb/AOF文件也保存在这里</span></span><br><span class=\"line\">dir <span class=\"string\">\"/data\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日志文件记录文件(notice / verbose)</span></span><br><span class=\"line\"><span class=\"comment\"># logfile \"/logs/redis.log\"</span></span><br><span class=\"line\"><span class=\"comment\"># loglevel verbose  </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 最大客户端连接数</span></span><br><span class=\"line\">maxclients 10000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 客户端连接空闲多久后断开连接，单位秒，0表示禁用</span></span><br><span class=\"line\">timeout 60</span><br><span class=\"line\">tcp-keepalive 60 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Redis 数据持久化(rdb/aof)配置</span></span><br><span class=\"line\"><span class=\"comment\"># RDB 文件名</span></span><br><span class=\"line\">dbfilename <span class=\"string\">\"dump.rdb\"</span></span><br><span class=\"line\"><span class=\"comment\"># 数据自动保存脚本条件例如300s中有10key发生变化</span></span><br><span class=\"line\">save 300 10</span><br><span class=\"line\">save 60 10000</span><br><span class=\"line\"><span class=\"comment\"># 对RDB文件进行压缩，建议以（磁盘）空间换（CPU）时间。</span></span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\"><span class=\"comment\"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span></span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\"><span class=\"comment\"># RDB自动触发策略是否启用，默认为yes</span></span><br><span class=\"line\">rdb-save-incremental-fsync yes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># AOF开启</span></span><br><span class=\"line\">appendonly yes</span><br><span class=\"line\"><span class=\"comment\"># AOF文件名</span></span><br><span class=\"line\">appendfilename <span class=\"string\">\"appendonly.aof\"</span></span><br><span class=\"line\"><span class=\"comment\"># 可选值 always， everysec，no，建议设置为everysec</span></span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Redis风险命令重命名</span></span><br><span class=\"line\"><span class=\"comment\"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class=\"line\">rename-command FLUSHDB b840fc02d524045429941cc15f59e41cb7be6c53</span><br><span class=\"line\">rename-command FLUSHALL b840fc02d524045429941cc15f59e41cb7be6c54</span><br><span class=\"line\">rename-command EVAL b840fc02d524045429941cc15f59e41cb7be6c55</span><br><span class=\"line\">rename-command DEBUG b840fc02d524045429941cc15f59e41cb7be6c56</span><br><span class=\"line\"><span class=\"comment\"># rename-command SHUTDOWN SHUTDOWN</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># docker 环境</span></span><br><span class=\"line\">$ docker run -d -p 6379:6379 \\</span><br><span class=\"line\"> -v /app/redis/redis.conf:/etc/redis/redis.conf \\</span><br><span class=\"line\"> -v /app/redis/data:/data \\</span><br><span class=\"line\">  --name redis-server redis:6.2.6-alpine3.15 redis-server /etc/redis/redis.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># nerdctl + containerd 环境</span></span><br><span class=\"line\">$ nerdctl run -d -p 6379:6379 \\</span><br><span class=\"line\"> -v /app/redis/redis.conf:/etc/redis/redis.conf \\</span><br><span class=\"line\"> -v /app/redis/data:/data \\</span><br><span class=\"line\"> --name redis-server redis:6.2.6-alpine3.15 redis-server /etc/redis/redis.conf</span><br><span class=\"line\">5e854a58087ae1bba5a661b2941474560cbecc37f54c7f4e7a28afbaed6aebf0</span><br></pre></td></tr></table></figure></p>\n<p><strong>执行结果:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看容器是否运行</span></span><br><span class=\"line\">$ docker ps</span><br><span class=\"line\">CONTAINER ID   IMAGE                          COMMAND                  CREATED          STATUS          PORTS                    NAMES</span><br><span class=\"line\">2919b8a9478a   redis:6.2.6-alpine3.15         <span class=\"string\">\"docker-entrypoint.s…\"</span>   20 seconds ago   Up 19 seconds   0.0.0.0:6379-&gt;6379/tcp   redis-server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 连接redis数据库是否正常</span></span><br><span class=\"line\">$ docker <span class=\"built_in\">exec</span> -it redis-server redis-cli -a 123456 ping</span><br><span class=\"line\">Warning: Using a password with <span class=\"string\">'-a'</span> or <span class=\"string\">'-u'</span> option on the <span class=\"built_in\">command</span> line interface may not be safe.</span><br><span class=\"line\">PONG</span><br></pre></td></tr></table></figure></p>\n<hr>\n<h2 id=\"Kubernetes-快速部署单实例-redis-数据库\"><a href=\"#Kubernetes-快速部署单实例-redis-数据库\" class=\"headerlink\" title=\"Kubernetes 快速部署单实例 redis 数据库\"></a>Kubernetes 快速部署单实例 redis 数据库</h2><p>温馨提示：此处实践环境是使用Kubernetes集群,若你没有安装Kubernetes集群环境或者不了解的Kubernetes容器的朋友，可以参考博主学习【<code>Kubernetes的系列笔记</code>】汇总, 关注 WeiyiGeek 公众号回复【<code>Kubernetes学习之路汇总</code>】即可获得学习资料<br><a href=\"https://www.weiyigeek.top/wechat.html?key=Kubernetes学习之路汇总\" target=\"_blank\" rel=\"noopener\">https://www.weiyigeek.top/wechat.html?key=Kubernetes学习之路汇总</a></p>\n<p>温馨提示：集群中基于nfs的provisioner的动态持卷环境部署可参考此篇文章(  <a href=\"https://blog.weiyigeek.top/2022/6-7-664.html\">https://blog.weiyigeek.top/2022/6-7-664.html</a> )</p>\n<p><br/></p>\n<p>步骤01.创建configMap 资源清单配置Redis.conf (此处还是采用上述 /app/redis/redis.conf 配置文件)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap -n database redis-single-conf --from-file=/app/redis/redis.conf</span><br><span class=\"line\">kubectl get configmap -n database redis-single-conf</span><br><span class=\"line\"><span class=\"comment\"># NAME                DATA   AGE</span></span><br><span class=\"line\"><span class=\"comment\"># redis-single-conf   1      30s</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤02.StatefulSet 与 SVC 资源清单:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee redis-single-server.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: StatefulSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: __APPNAME__</span><br><span class=\"line\">  namespace: __APPNAMESPACE__</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    description: redis-single</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  serviceName: __APPNAME__</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: __APPNAME__</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: __APPNAME__</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      <span class=\"comment\"># 容器优化</span></span><br><span class=\"line\">      initContainers:</span><br><span class=\"line\">      - name: sysctl</span><br><span class=\"line\">        image: alpine:3.15.4</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        <span class=\"built_in\">command</span>:</span><br><span class=\"line\">        - sh</span><br><span class=\"line\">        - -c</span><br><span class=\"line\">        - |</span><br><span class=\"line\">          mount -o remount rw /proc/sys</span><br><span class=\"line\">          sysctl -w net.core.somaxconn=10000</span><br><span class=\"line\">          sysctl -w net.ipv4.tcp_tw_reuse=1</span><br><span class=\"line\">          sysctl -w net.ipv4.ip_local_port_range=<span class=\"string\">\"1024 65535\"</span></span><br><span class=\"line\">          sysctl -w fs.file-max=1048576</span><br><span class=\"line\">          sysctl -w fs.inotify.max_user_instances=16384</span><br><span class=\"line\">          sysctl -w fs.inotify.max_user_watches=524288</span><br><span class=\"line\">          sysctl -w fs.inotify.max_queued_events=16384</span><br><span class=\"line\">          <span class=\"built_in\">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          privileged: <span class=\"literal\">true</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: redis</span><br><span class=\"line\">        image: redis:6.2.6-alpine3.15</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 6379</span><br><span class=\"line\">          name: server</span><br><span class=\"line\">        <span class=\"built_in\">command</span>: [ <span class=\"string\">\"redis-server\"</span>, <span class=\"string\">\"/conf/redis.conf\"</span>]</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        <span class=\"comment\"># 从configmap获取的配置文件，挂载到指定文件中【https://blog.weiyigeek.top】.</span></span><br><span class=\"line\">        - name: conf</span><br><span class=\"line\">          mountPath: /conf/redis.conf</span><br><span class=\"line\">          subPath: redis.conf</span><br><span class=\"line\">        - name: data</span><br><span class=\"line\">          mountPath: /data</span><br><span class=\"line\">        <span class=\"comment\"># - name: logs</span></span><br><span class=\"line\">        <span class=\"comment\">#   mountPath: /logs</span></span><br><span class=\"line\">        <span class=\"comment\"># 时区设置</span></span><br><span class=\"line\">        - name: timezone</span><br><span class=\"line\">          mountPath: /etc/localtime              </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: conf</span><br><span class=\"line\">        <span class=\"comment\"># 配置文件采用configMap</span></span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: redis-single-conf</span><br><span class=\"line\">          defaultMode: 0755</span><br><span class=\"line\">        <span class=\"comment\"># 日志采用hostPath卷</span></span><br><span class=\"line\">      - name: logs</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          <span class=\"built_in\">type</span>: DirectoryOrCreate </span><br><span class=\"line\">          path: /app/redis/logs</span><br><span class=\"line\">        <span class=\"comment\"># 时区定义</span></span><br><span class=\"line\">      - name: timezone                             </span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /usr/share/zoneinfo/Asia/Shanghai</span><br><span class=\"line\">  volumeClaimTemplates:</span><br><span class=\"line\">  - metadata:</span><br><span class=\"line\">      name: data</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      accessModes: [ <span class=\"string\">\"ReadWriteOnce\"</span> ]</span><br><span class=\"line\">      storageClassName: <span class=\"string\">\"__STORAGECLASSNAME__\"</span></span><br><span class=\"line\">      resources:</span><br><span class=\"line\">        requests:</span><br><span class=\"line\">          storage: 2Gi</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: __APPNAME__</span><br><span class=\"line\">  namespace: __APPNAMESPACE__</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 6379</span><br><span class=\"line\">    targetPort: 6379</span><br><span class=\"line\">    name: tcp</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: __APPNAME__</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意 替换 storageClassName</span></span><br><span class=\"line\">sed -i -e <span class=\"string\">'s/__APPNAME__/redis-single/g'</span> -e <span class=\"string\">'s/__APPNAMESPACE__/database/g'</span> -e <span class=\"string\">'s/__STORAGECLASSNAME__/managed-nfs-storage/'</span> redis-single-server.yaml</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 03.部署资源清单到Kubernetes集群<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f redis-single-server.yaml</span><br><span class=\"line\"><span class=\"comment\"># statefulset.apps/redis-single created</span></span><br><span class=\"line\"><span class=\"comment\"># service/redis-single created</span></span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 04.验证部署应用资源<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n database -l app=redis-single</span><br><span class=\"line\">  <span class=\"comment\"># NAME             READY   STATUS    RESTARTS   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-single-0   1/1     Running   0          16m</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get svc -n database redis-single</span><br><span class=\"line\">  <span class=\"comment\"># NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># redis-single   ClusterIP   11.19.196.169   &lt;none&gt;        6379/TCP   15m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 连接到redis数据库</span></span><br><span class=\"line\">$ telnet 11.19.196.169 6379</span><br><span class=\"line\">  <span class=\"comment\"># Trying 11.19.196.169...</span></span><br><span class=\"line\">  <span class=\"comment\"># Connected to 11.19.196.169.</span></span><br><span class=\"line\">  <span class=\"comment\"># Escape character is '^]'.</span></span><br><span class=\"line\">  <span class=\"comment\"># auth 123456</span></span><br><span class=\"line\">  <span class=\"comment\"># +OK</span></span><br><span class=\"line\">  <span class=\"comment\"># ping</span></span><br><span class=\"line\">  <span class=\"comment\"># +PONG</span></span><br><span class=\"line\">  <span class=\"comment\"># info</span></span><br><span class=\"line\">  <span class=\"comment\"># $4241</span></span><br><span class=\"line\">  <span class=\"comment\"># # Server</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_version:6.2.6</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_git_sha1:00000000</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_git_dirty:0</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_build_id:63421500bb103677</span></span><br><span class=\"line\">  <span class=\"comment\"># redis_mode:standalone</span></span><br><span class=\"line\">  <span class=\"comment\"># os:Linux 4.20.13-1.el7.elrepo.x86_64 x86_64</span></span><br><span class=\"line\">  <span class=\"comment\"># arch_bits:64</span></span><br><span class=\"line\">  <span class=\"comment\"># multiplexing_api:epoll</span></span><br><span class=\"line\">  <span class=\"comment\"># atomicvar_api:atomic-builtin</span></span><br><span class=\"line\">  <span class=\"comment\"># gcc_version:10.3.1</span></span><br><span class=\"line\">  <span class=\"comment\"># process_id:1</span></span><br><span class=\"line\">  <span class=\"comment\"># process_supervised:no</span></span><br><span class=\"line\">  <span class=\"comment\"># run_id:677b6d0188b564670f26ce47154b70c8aa6c3f04</span></span><br><span class=\"line\">  <span class=\"comment\"># tcp_port:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># server_time_usec:1650962303340701</span></span><br></pre></td></tr></table></figure></p>\n<p>温馨提示: 集群中的其它应用，我们可以通过svc的地址或者集群dns域名(<code>redis-single.database</code>-推荐)来访问该pod。</p>\n<p><br></p>\n<h2 id=\"Kubernetes-快速利用资源清单部署-redis-数据库集群\"><a href=\"#Kubernetes-快速利用资源清单部署-redis-数据库集群\" class=\"headerlink\" title=\"Kubernetes 快速利用资源清单部署 redis 数据库集群\"></a>Kubernetes 快速利用资源清单部署 redis 数据库集群</h2><p>步骤 01.创建 redis 配置文件使用 configmap 方式进行挂载。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">redis-cluster-configmap.yaml</span> <span class=\"string\">&lt;&lt;</span> <span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"string\">update-node.sh:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    #!/bin/sh</span></span><br><span class=\"line\"><span class=\"string\">    CLUSTER_CONFIG=\"/data/nodes.conf\"</span></span><br><span class=\"line\"><span class=\"string\">    if [ -f $&#123;CLUSTER_CONFIG&#125; ]; then</span></span><br><span class=\"line\"><span class=\"string\">      if [ -z \"$&#123;POD_IP&#125;\" ]; then</span></span><br><span class=\"line\"><span class=\"string\">        echo \"Unable to determine Pod IP address!\"</span></span><br><span class=\"line\"><span class=\"string\">        exit 1</span></span><br><span class=\"line\"><span class=\"string\">      fi</span></span><br><span class=\"line\"><span class=\"string\">      echo \"Updating my IP to $&#123;POD_IP&#125; in $&#123;CLUSTER_CONFIG&#125;\"</span></span><br><span class=\"line\"><span class=\"string\">      sed -i.bak -e '/myself/ s/[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;/'$&#123;POD_IP&#125;'/' $&#123;CLUSTER_CONFIG&#125;</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">    exec \"$@\"</span></span><br><span class=\"line\"><span class=\"string\">  redis.conf: |+</span></span><br><span class=\"line\"><span class=\"string\">    port 6379</span></span><br><span class=\"line\"><span class=\"string\">    protected-mode no</span></span><br><span class=\"line\"><span class=\"string\">    maxclients 32768</span></span><br><span class=\"line\"><span class=\"string\">    masterauth weiyigeek.top</span></span><br><span class=\"line\"><span class=\"string\">    requirepass weiyigeek.top</span></span><br><span class=\"line\"><span class=\"string\">    # 数据目录</span></span><br><span class=\"line\"><span class=\"string\">    dir /data</span></span><br><span class=\"line\"><span class=\"string\">    # 开启 RDB 持久化&amp;触发策略</span></span><br><span class=\"line\"><span class=\"string\">    dbfilename dump.rdb</span></span><br><span class=\"line\"><span class=\"string\">    rdb-save-incremental-fsync yes</span></span><br><span class=\"line\"><span class=\"string\">    # 开启AOF持久化以及每秒钟同步一次折中的方案</span></span><br><span class=\"line\"><span class=\"string\">    appendonly yes </span></span><br><span class=\"line\"><span class=\"string\">    appendfilename appendonly.aof </span></span><br><span class=\"line\"><span class=\"string\">    appendfsync everysec</span></span><br><span class=\"line\"><span class=\"string\">    no-appendfsync-on-rewrite no</span></span><br><span class=\"line\"><span class=\"string\">    auto-aof-rewrite-percentage 100</span></span><br><span class=\"line\"><span class=\"string\">    auto-aof-rewrite-min-size 128mb</span></span><br><span class=\"line\"><span class=\"string\">    aof-load-truncated yes</span></span><br><span class=\"line\"><span class=\"string\">    aof-use-rdb-preamble yes</span></span><br><span class=\"line\"><span class=\"string\">    aof-rewrite-incremental-fsync yes</span></span><br><span class=\"line\"><span class=\"string\">    # 集群模式打开</span></span><br><span class=\"line\"><span class=\"string\">    cluster-enabled yes </span></span><br><span class=\"line\"><span class=\"string\">    cluster-config-file /data/nodes.conf</span></span><br><span class=\"line\"><span class=\"string\">    cluster-node-timeout 5000</span></span><br><span class=\"line\"><span class=\"string\">    # 当负责一个插槽的主库下线且没有相应的从库进行故障恢复时集群仍然可用</span></span><br><span class=\"line\"><span class=\"string\">    cluster-require-full-coverage no</span></span><br><span class=\"line\"><span class=\"string\">    # 只有当一个主节点至少拥有其他给定数量个处于正常工作中的从节点的时候，才会分配从节点给集群中孤立的主节点</span></span><br><span class=\"line\"><span class=\"string\">    cluster-migration-barrier 1</span></span><br><span class=\"line\"><span class=\"string\">    # 副本服务陈旧数据</span></span><br><span class=\"line\"><span class=\"string\">    replica-serve-stale-data yes</span></span><br><span class=\"line\"><span class=\"string\">    replica-read-only no</span></span><br><span class=\"line\"><span class=\"string\">    replica-priority 100</span></span><br><span class=\"line\"><span class=\"string\">    # 复制同步策略</span></span><br><span class=\"line\"><span class=\"string\">    repl-diskless-sync no</span></span><br><span class=\"line\"><span class=\"string\">    repl-diskless-sync-delay 5</span></span><br><span class=\"line\"><span class=\"string\">    repl-disable-tcp-nodelay no</span></span><br><span class=\"line\"><span class=\"string\">    # 慢查询日志</span></span><br><span class=\"line\"><span class=\"string\">    slowlog-log-slower-than 10000</span></span><br><span class=\"line\"><span class=\"string\">    slowlog-max-len 128</span></span><br><span class=\"line\"><span class=\"string\">    # 内存策略</span></span><br><span class=\"line\"><span class=\"string\">    maxmemory-policy allkeys-lru</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p>温馨提示：masterauth 与 requirepass 认证密码需要根据实际情况进行更改，此外我设置为了我的主页地址。</p>\n<p><br/></p>\n<p>步骤 02.Redis 集群 SVC 以及 STS 资源清单。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">redis-cluster-deploy.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - port:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">  - port:</span> <span class=\"number\">16379</span></span><br><span class=\"line\"><span class=\"attr\">    targetPort:</span> <span class=\"number\">16379</span></span><br><span class=\"line\"><span class=\"attr\">    name:</span> <span class=\"string\">gossip</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">database</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  serviceName:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">6</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      affinity:</span></span><br><span class=\"line\"><span class=\"attr\">        nodeAffinity:</span>                                      <span class=\"comment\"># node亲和性</span></span><br><span class=\"line\"><span class=\"attr\">          requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class=\"comment\"># 硬策略,调度在指定标签的节点中</span></span><br><span class=\"line\"><span class=\"attr\">            nodeSelectorTerms:</span></span><br><span class=\"line\"><span class=\"attr\">            - matchExpressions:</span></span><br><span class=\"line\"><span class=\"attr\">              - key:</span> <span class=\"string\">node</span></span><br><span class=\"line\"><span class=\"attr\">                operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\"><span class=\"attr\">                values:</span></span><br><span class=\"line\"><span class=\"bullet\">                  -</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">        podAntiAffinity:</span>                                    <span class=\"comment\"># Pod反亲和性</span></span><br><span class=\"line\"><span class=\"attr\">          preferredDuringSchedulingIgnoredDuringExecution:</span>  <span class=\"comment\"># 软策略,使Pod分布在不同的节点上</span></span><br><span class=\"line\"><span class=\"attr\">          - weight:</span> <span class=\"number\">1</span>                                       <span class=\"comment\"># 权重,有多个策略通过权重控制调度</span></span><br><span class=\"line\"><span class=\"attr\">            podAffinityTerm:</span></span><br><span class=\"line\"><span class=\"attr\">              topologyKey:</span> <span class=\"string\">app.kubernetes.io/name</span>           <span class=\"comment\"># 通过app.kubernetes.io/name作为域调度  </span></span><br><span class=\"line\"><span class=\"attr\">              labelSelector:</span></span><br><span class=\"line\"><span class=\"attr\">                matchExpressions:</span></span><br><span class=\"line\"><span class=\"attr\">                - key:</span> <span class=\"string\">node</span></span><br><span class=\"line\"><span class=\"attr\">                  operator:</span> <span class=\"string\">In</span></span><br><span class=\"line\"><span class=\"attr\">                  values:</span></span><br><span class=\"line\"><span class=\"bullet\">                  -</span> <span class=\"string\">app</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">        image:</span> <span class=\"attr\">redis:6.2.7-alpine</span></span><br><span class=\"line\"><span class=\"attr\">        ports:</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">        - containerPort:</span> <span class=\"number\">16379</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">gossip</span></span><br><span class=\"line\"><span class=\"attr\">        command:</span> <span class=\"string\">[\"/etc/redis/update-node.sh\",</span> <span class=\"string\">\"redis-server\"</span><span class=\"string\">,</span> <span class=\"string\">\"/etc/redis/redis.conf\"</span><span class=\"string\">]</span></span><br><span class=\"line\"><span class=\"attr\">        env:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\"><span class=\"attr\">          valueFrom:</span></span><br><span class=\"line\"><span class=\"attr\">            fieldRef:</span></span><br><span class=\"line\"><span class=\"attr\">              fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\"><span class=\"attr\">        volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/redis/</span></span><br><span class=\"line\"><span class=\"attr\">          readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\"><span class=\"attr\">          readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\"><span class=\"attr\">          mountPath:</span> <span class=\"string\">/etc/localtime</span>                           <span class=\"comment\"># 在Pod中时区设置(挂载主机的时区)</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\"><span class=\"attr\">        configMap:</span></span><br><span class=\"line\"><span class=\"attr\">          name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">          defaultMode:</span> <span class=\"number\">0755</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">timezone</span> </span><br><span class=\"line\"><span class=\"attr\">        hostPath:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">  volumeClaimTemplates:</span></span><br><span class=\"line\"><span class=\"attr\">  - metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      storageClassName:</span> <span class=\"string\">nfs-dev</span></span><br><span class=\"line\"><span class=\"attr\">      accessModes:</span></span><br><span class=\"line\"><span class=\"bullet\">        -</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\"><span class=\"attr\">      resources:</span></span><br><span class=\"line\"><span class=\"attr\">        requests:</span></span><br><span class=\"line\"><span class=\"attr\">          storage:</span> <span class=\"number\">5</span><span class=\"string\">Gi</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 03.使用 kubectl apply 部署资源清单，并查看部署结果以及Pod IP，为集群初始化做准备。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 名称空间创建</span></span><br><span class=\"line\">$ kubectl create namespace database</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 按照资源清单StatefulSet控制器创建Pod</span></span><br><span class=\"line\">$ ls</span><br><span class=\"line\">redis-cluster-configmap.yaml  redis-cluster-deploy.yaml</span><br><span class=\"line\">$ kubectl create -f redis-cluster-configmap.yaml </span><br><span class=\"line\">$ kubectl create -f redis-cluster-deploy.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 查看应用的 statefulsets,pod,svc 等信息</span></span><br><span class=\"line\">$  kubectl get statefulsets,pod,svc -n database</span><br><span class=\"line\">NAME                               READY   AGE</span><br><span class=\"line\">statefulset.apps/redis-cluster     6/6     13m</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod/redis-cluster-0     1/1     Running   0          13m</span><br><span class=\"line\">pod/redis-cluster-1     1/1     Running   0          12m</span><br><span class=\"line\">pod/redis-cluster-2     1/1     Running   0          12m</span><br><span class=\"line\">pod/redis-cluster-3     1/1     Running   0          10m</span><br><span class=\"line\">pod/redis-cluster-4     1/1     Running   0          9m19s</span><br><span class=\"line\">pod/redis-cluster-5     1/1     Running   0          9m16s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)              AGE</span><br><span class=\"line\">service/redis-cluster              ClusterIP   None             &lt;none&gt;        6379/TCP,16379/TCP   13m</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (4) 获取 Redis 集群 6 个节点 Pod 的 ip 地址</span></span><br><span class=\"line\">kubectl get pod -n database -l app=redis-cluster -o jsonpath=<span class=\"string\">'&#123; range.items [*]&#125;&#123;.status.podIP&#125;:6379 '</span>| sed <span class=\"string\">\"s# :6379 ##g\"</span></span><br><span class=\"line\"><span class=\"comment\"># 10.66.35.66:6379 10.66.237.142:6379 10.66.55.76:6379 10.66.53.96:6379 10.66.35.92:6379 10.66.55.77:6379</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 04.进入到第一个Pod 终端中进行初始化 Redis 集群操作，验证Redis Cluster集群</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># (1) 进入redis-cluster-0 pod中的shell</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -n database -it redis-cluster-0 sh </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (2) 进行集群初始化，运行以下命令并输入'yes'接受配置。我们将看到前三个节点将被选择为主节点，后三个节点将被选择为从节点。</span></span><br><span class=\"line\">/data $ redis-cli -a weiyigeek.top --cluster create --cluster-replicas 1 10.66.35.66:6379 10.66.237.142:6379 10.66.55.76:6379 10.66.53.96:6379 10.66.35.92:6379 10.66.55.77:6379</span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span></span><br><span class=\"line\">  <span class=\"comment\"># Master[0] -&gt; Slots 0 - 5460</span></span><br><span class=\"line\">  <span class=\"comment\"># Master[1] -&gt; Slots 5461 - 10922</span></span><br><span class=\"line\">  <span class=\"comment\"># Master[2] -&gt; Slots 10923 - 16383</span></span><br><span class=\"line\">  <span class=\"comment\"># Adding replica 10.66.35.92:6379 to 10.66.35.66:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># Adding replica 10.66.55.77:6379 to 10.66.237.142:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># Adding replica 10.66.53.96:6379 to 10.66.55.76:6379</span></span><br><span class=\"line\">  <span class=\"comment\"># M: b13a58f799e058dd9afba221f25a8bd53ae05969 10.66.35.66:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[0-5460] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\"># M: 729af3b961a978ad15263ef96439177207be7821 10.66.237.142:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\"># M: 50c3d31e7277ce339752a980f14c03d180e2f98a 10.66.55.76:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\"># S: ce02a1eb7efbd4de37383f46c300bb883dcd16b4 10.66.53.96:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates 50c3d31e7277ce339752a980f14c03d180e2f98a</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 298d5e8528c38f687c9894b9974eb5368555c652 10.66.35.92:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates b13a58f799e058dd9afba221f25a8bd53ae05969</span></span><br><span class=\"line\">  <span class=\"comment\"># S: f7ecf69d99129fba7737f8ae9a8f172af19a7b72 10.66.55.77:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates 729af3b961a978ad15263ef96439177207be7821</span></span><br><span class=\"line\">  <span class=\"comment\"># Can I set the above configuration? (type 'yes' to accept): yes  # 此处输入 yes 进行上述卡槽设置。</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Nodes configuration updated</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Assign a different config epoch to each node</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class=\"line\">  <span class=\"comment\"># Waiting for the cluster to join</span></span><br><span class=\"line\">  <span class=\"comment\"># .</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Performing Cluster Check (using node 10.66.35.66:6379)</span></span><br><span class=\"line\">  <span class=\"comment\"># M: b13a58f799e058dd9afba221f25a8bd53ae05969 10.66.35.66:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[0-5460] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\">#    1 additional replica(s)</span></span><br><span class=\"line\">  <span class=\"comment\"># S: f7ecf69d99129fba7737f8ae9a8f172af19a7b72 10.66.55.77:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots: (0 slots) slave</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates 729af3b961a978ad15263ef96439177207be7821</span></span><br><span class=\"line\">  <span class=\"comment\"># M: 50c3d31e7277ce339752a980f14c03d180e2f98a 10.66.55.76:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[10923-16383] (5461 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\">#    1 additional replica(s)</span></span><br><span class=\"line\">  <span class=\"comment\"># S: ce02a1eb7efbd4de37383f46c300bb883dcd16b4 10.66.53.96:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots: (0 slots) slave</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates 50c3d31e7277ce339752a980f14c03d180e2f98a</span></span><br><span class=\"line\">  <span class=\"comment\"># M: 729af3b961a978ad15263ef96439177207be7821 10.66.237.142:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots:[5461-10922] (5462 slots) master</span></span><br><span class=\"line\">  <span class=\"comment\">#    1 additional replica(s)</span></span><br><span class=\"line\">  <span class=\"comment\"># S: 298d5e8528c38f687c9894b9974eb5368555c652 10.66.35.92:6379</span></span><br><span class=\"line\">  <span class=\"comment\">#    slots: (0 slots) slave</span></span><br><span class=\"line\">  <span class=\"comment\">#    replicates b13a58f799e058dd9afba221f25a8bd53ae05969</span></span><br><span class=\"line\">  <span class=\"comment\"># [OK] All nodes agree about slots configuration.</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Check for open slots...</span></span><br><span class=\"line\">  <span class=\"comment\"># &gt;&gt;&gt; Check slots coverage...</span></span><br><span class=\"line\">  <span class=\"comment\"># [OK] All 16384 slots covered.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (3) 集群验证 </span></span><br><span class=\"line\"><span class=\"comment\"># 此处我使用集群svc服务名称进行访问 redis-cluster.database.svc.cluster.test。</span></span><br><span class=\"line\">/data $ redis-cli -c -h redis-cluster.database.svc.cluster.test -a weiyigeek.top</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看集群信息</span></span><br><span class=\"line\">redis-cluster.database.svc.cluster.test:6379&gt; CLUSTER INFO</span><br><span class=\"line\">  cluster_state:ok</span><br><span class=\"line\">  cluster_slots_assigned:16384</span><br><span class=\"line\">  cluster_slots_ok:16384</span><br><span class=\"line\">  cluster_slots_pfail:0</span><br><span class=\"line\">  cluster_slots_fail:0</span><br><span class=\"line\">  cluster_known_nodes:6</span><br><span class=\"line\">  cluster_size:3</span><br><span class=\"line\">  ....</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看集群节点</span></span><br><span class=\"line\">redis-cluster.database.svc.cluster.test:6379&gt; CLUSTER NODES</span><br><span class=\"line\">  f7ecf69d99129fba7737f8ae9a8f172af19a7b72 10.66.55.77:6379@16379 slave 729af3b961a978ad15263ef96439177207be7821 0 1665234666115 2 connected</span><br><span class=\"line\">  b13a58f799e058dd9afba221f25a8bd53ae05969 10.66.35.66:6379@16379 master - 0 1665234667119 1 connected 0-5460</span><br><span class=\"line\">  50c3d31e7277ce339752a980f14c03d180e2f98a 10.66.55.76:6379@16379 master - 0 1665234667119 3 connected 10923-16383</span><br><span class=\"line\">  298d5e8528c38f687c9894b9974eb5368555c652 10.66.35.92:6379@16379 slave b13a58f799e058dd9afba221f25a8bd53ae05969 0 1665234665513 1 connected</span><br><span class=\"line\">  729af3b961a978ad15263ef96439177207be7821 10.66.237.142:6379@16379 myself,master - 0 1665234665000 2 connected 5461-10922</span><br><span class=\"line\">  ce02a1eb7efbd4de37383f46c300bb883dcd16b4 10.66.53.96:6379@16379 slave 50c3d31e7277ce339752a980f14c03d180e2f98a 0 1665234665110 3 connected</span><br></pre></td></tr></table></figure>\n<p>温馨提示：在初始化 redis 集群时必须使用 ip 地址，如果使用域名会报如下错误。<br>温馨提示：当应用连接 redis 集群时使用 pod 的域名, 格式为 <code>svc名字.ns名字.svc.cluster.local</code><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ nslookup redis-cluster.database.svc.cluster.test</span><br><span class=\"line\">Server:         10.96.0.10</span><br><span class=\"line\">Address:        10.96.0.10:53</span><br><span class=\"line\"></span><br><span class=\"line\">Name:   redis-cluster.database.svc.cluster.test</span><br><span class=\"line\">Address: 10.66.35.66</span><br><span class=\"line\">Name:   redis-cluster.database.svc.cluster.test</span><br><span class=\"line\">Address: 10.66.35.92</span><br><span class=\"line\">Name:   redis-cluster.database.svc.cluster.test</span><br><span class=\"line\">Address: 10.66.55.76</span><br><span class=\"line\">Name:   redis-cluster.database.svc.cluster.test</span><br><span class=\"line\">Address: 10.66.53.96</span><br><span class=\"line\">Name:   redis-cluster.database.svc.cluster.test</span><br><span class=\"line\">Address: 10.66.237.142</span><br><span class=\"line\">Name:   redis-cluster.database.svc.cluster.test</span><br><span class=\"line\">Address: 10.66.55.77</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 05.使用redis cluster进行KV数据插入并查看数据。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-cluster.database.svc.cluster.test:6379&gt; <span class=\"built_in\">set</span> domain weiyigeek.top EX 10</span><br><span class=\"line\">-&gt; Redirected to slot [5449] located at 10.66.35.66:6379</span><br><span class=\"line\">OK</span><br><span class=\"line\">10.66.35.66:6379&gt; get domain</span><br><span class=\"line\"><span class=\"string\">\"weiyigeek.top\"</span></span><br><span class=\"line\">10.66.35.66:6379&gt; get domain</span><br><span class=\"line\"><span class=\"string\">\"weiyigeek.top\"</span></span><br><span class=\"line\">10.66.35.66:6379&gt; get domain   <span class=\"comment\"># 10秒后到期,则key被销毁</span></span><br><span class=\"line\">(nil)</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<p>温馨提示：如果整个 redis 集群的 pod 全部都挂掉了，pod自动拉起后集群不可用，需要重建集群，此时有两种重建集群方法。</p>\n<ul>\n<li><p>方式1.重新开始（不到万不得已不建议这样做）</p>\n<blockquote>\n<p>1.删除 redis 集群所有的资源，然后重新创建 redis 集群<br>2.删除 redis 集群中所有的 pvc(pv)<br>3.删除 redis 集群中 pod 对应的 nfs 持久化存储目录<br>4.重新创建 redis 集群资源并进行初始化</p>\n</blockquote>\n</li>\n<li><p>方式2.在原有 redis 集群的基础上进行修复。</p>\n<blockquote>\n<p>1.将 redis 集群中资源控制器的副本数设置为 0<br>2.找到 redis 集群中 pod 对应的 nfs 持久化存储目录后删除 nodes.conf </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/storage/dev/pvc/<span class=\"built_in\">local</span><span class=\"comment\"># find . -name nodes.conf</span></span><br><span class=\"line\">./database-data-redis-cluster-1-pvc-febdd490-6dbf-4084-860f-1d81602f4ca0/nodes.conf</span><br><span class=\"line\">./database-data-redis-cluster-3-pvc-08d6d4b4-5290-4710-b31e-efb5e8d8481e/nodes.conf</span><br><span class=\"line\">./database-data-redis-cluster-5-pvc-96db8931-2106-4ac1-9c41-ec8888e99024/nodes.conf</span><br><span class=\"line\">./database-data-redis-cluster-4-pvc-c67c4649-ff0f-4767-ae75-3875653886c5/nodes.conf</span><br><span class=\"line\">./database-data-redis-cluster-0-pvc-e6b1f1bd-75b0-4777-ab93-993a2e6e5927/nodes.conf</span><br><span class=\"line\">./database-data-redis-cluster-2-pvc-d078a7d3-cf0c-4b1e-acbe-59086089fb0d/nodes.conf</span><br></pre></td></tr></table></figure>\n<p>3.重新创建 redis 集群资源 <code>kubectl apply -f redis-cluster-deploy.yaml</code> 导出数据后，然后重新初始化集群。</p>\n</blockquote>\n</li>\n</ul>\n<p><br/></p>\n<h2 id=\"Kubernetes-中使用-Helm-快速部署-redis-多主多从集群\"><a href=\"#Kubernetes-中使用-Helm-快速部署-redis-多主多从集群\" class=\"headerlink\" title=\"Kubernetes 中使用 Helm 快速部署 redis 多主多从集群\"></a>Kubernetes 中使用 Helm 快速部署 redis 多主多从集群</h2><p>描述：我们可以使用 Bitnami helm chart 在 K8S 中一键部署 Redis cluster 多主多从。<br>项目地址：<a href=\"https://github.com/bitnami/charts/tree/master/bitnami/redis-cluster\" target=\"_blank\" rel=\"noopener\">https://github.com/bitnami/charts/tree/master/bitnami/redis-cluster</a></p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20221009184109.png\" alt=\"WeiyiGeek.redis单主与redis多主集群\" title=\"\" class=\"\">\n                <p>WeiyiGeek.redis单主与redis多主集群</p>\n            </figure>\n<p>环境依赖：</p>\n<ul>\n<li>Kubernetes 1.19+</li>\n<li>Helm 3.2.0+</li>\n<li>PV provisioner support in the underlying infrastructure</li>\n</ul>\n<p>温馨提示：1.集群中基于nfs的provisioner的动态持卷环境部署可参考此篇文章( <a href=\"https://blog.weiyigeek.top/2022/6-7-664.html\">https://blog.weiyigeek.top/2022/6-7-664.html</a> )</p>\n<p><br/></p>\n<p>步骤 01.添加 Bitnami chart 仓库，查看可用 redis-cluster 的 chart 及其对应版本，拉取部署所需的 yaml 文件到本地。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class=\"line\">$ helm3 search repo bitnami/redis-cluster -l</span><br><span class=\"line\">$ helm3 pull bitnami/redis-cluster --version 8.2.4 --untar</span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 02.修改 redis-cluster 图表的 values.yaml 文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim redis-cluster/values.yaml</span><br><span class=\"line\"><span class=\"comment\"># 1.修改 clusterDomain Kubernetes Cluster Domain 此处由于我们的集群名称非 cluster.local 所以修改如下</span></span><br><span class=\"line\">clusterDomain: cluster.test</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 2.集群所需redis镜像，此处我已经上传内部harbor中，则需要根据实际请个改变</span></span><br><span class=\"line\">image:</span><br><span class=\"line\">  registry: harbor.weiyigeek.top</span><br><span class=\"line\">  repository: library/redis-cluster</span><br><span class=\"line\">  tag: 7.0.5-debian-11-r0</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 3.设置 Pod 安全上下文</span></span><br><span class=\"line\">podSecurityContext:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  fsGroup: 1001</span><br><span class=\"line\">  runAsUser: 1001</span><br><span class=\"line\">  sysctls: []</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 4.此处svc采用ClusterIP如果采用NodePort需要更改暴露端口 30000 - 32000</span></span><br><span class=\"line\">service:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    redis: 6379</span><br><span class=\"line\">  nodePorts:</span><br><span class=\"line\">    redis: 31379</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 5.数据 persistence 持久化配置，此处我采用了NFS动态逻辑卷。</span></span><br><span class=\"line\">persistence:</span><br><span class=\"line\">  path: /bitnami/redis/data</span><br><span class=\"line\">  storageClass: <span class=\"string\">\"nfs-local\"</span></span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  size: 8Gi</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 6.设置 Redis statefulset parameters 资源限额</span></span><br><span class=\"line\">redis:</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    limits: </span><br><span class=\"line\">      cpu: 1000m</span><br><span class=\"line\">      memory: 4Gi</span><br><span class=\"line\">    requests: &#123;&#125;</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 7.Redis Cluster 设置，此处我设置3主3从，一共6个节点</span></span><br><span class=\"line\"><span class=\"comment\"># 如果 nodes 为 6 replicas 为 1 表示每个master节点有一个副本</span></span><br><span class=\"line\"><span class=\"comment\"># nodes = numberOfMasterNodes + numberOfMasterNodes * replicas</span></span><br><span class=\"line\">cluster:</span><br><span class=\"line\"> init: <span class=\"literal\">true</span></span><br><span class=\"line\">  nodes: 6</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 8.启用 Redis Prometheus Exporter Metrics</span></span><br><span class=\"line\">metrics:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  image:</span><br><span class=\"line\">    registry: harbor.weiyigeek.top</span><br><span class=\"line\">    repository: library/redis-exporter</span><br><span class=\"line\">    tag: 1.44.0-debian-11-r8</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"comment\"># 9.启用并使用sysctlImage配置值设置特权initContainer</span></span><br><span class=\"line\">sysctlImage:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  registry: harbor.weiyigeek.top</span><br><span class=\"line\">  repository: library/bitnami-shell</span><br><span class=\"line\">  tag: 11-debian-11-r37</span><br><span class=\"line\">  <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - /bin/sh</span><br><span class=\"line\">    - -c</span><br><span class=\"line\">    - |-</span><br><span class=\"line\">      sysctl -w net.core.somaxconn=10000</span><br><span class=\"line\">      <span class=\"built_in\">echo</span> never &gt; /host-sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\">  mountHostSys: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 03.为了加快拉取速度我将docker hub上的指定所需镜像拉取到本地Harbor仓库中。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># redis-cluster:7.0.5-debian-11-r0 </span></span><br><span class=\"line\">docker pull bitnami/redis-cluster:7.0.5-debian-11-r0 </span><br><span class=\"line\">docker tag bitnami/redis-cluster:7.0.5-debian-11-r0 harbor.weiyigeek.top/library/redis-cluster:7.0.5-debian-11-r0</span><br><span class=\"line\">docker push harbor.weiyigeek.top/library/redis-cluster:7.0.5-debian-11-r0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># redis-exporter &amp; bitnami-shell</span></span><br><span class=\"line\">docker pull bitnami/redis-exporter:1.44.0-debian-11-r8; docker pull bitnami/bitnami-shell:11-debian-11-r37</span><br><span class=\"line\">docker tag bitnami/redis-exporter:1.44.0-debian-11-r8 harbor.weiyigeek.top/library/redis-exporter:1.44.0-debian-11-r8</span><br><span class=\"line\">docker tag bitnami/bitnami-shell:11-debian-11-r37  harbor.weiyigeek.top/library/bitnami-shell:11-debian-11-r37</span><br><span class=\"line\">docker push harbor.weiyigeek.top/library/redis-exporter:1.44.0-debian-11-r8</span><br><span class=\"line\">docker push harbor.weiyigeek.top/library/bitnami-shell:11-debian-11-r37</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>步骤 04.开始安装修改后的 redis-cluster 图表到 database 名称空间中，并查看资源部署情况。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm3 install redis ./redis-cluster --<span class=\"built_in\">set</span> password=weiyigeek.top  --namespace database --create-namespace --debug</span><br><span class=\"line\"></span><br><span class=\"line\">helm3 list -n database</span><br><span class=\"line\">  <span class=\"comment\"># NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION</span></span><br><span class=\"line\">  <span class=\"comment\"># redis   database        1               2022-10-09 17:35:18.530202622 +0800 CST deployed        redis-cluster-8.2.4     7.0.5</span></span><br><span class=\"line\">  </span><br><span class=\"line\">kubectl get sts,pod,svc -n database -l app.kubernetes.io/name=redis-cluster</span><br><span class=\"line\">  <span class=\"comment\"># NAME                                   READY   AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># statefulset.apps/redis-redis-cluster   6/6     4m4s</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\"># NAME                        READY   STATUS    RESTARTS        AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-redis-cluster-0   2/2     Running   1 (3m3s ago)    4m4s</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-redis-cluster-1   2/2     Running   1 (3m3s ago)    4m4s</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-redis-cluster-2   2/2     Running   2 (3m45s ago)   4m4s</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-redis-cluster-3   2/2     Running   1 (3m ago)      4m4s</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-redis-cluster-4   2/2     Running   1 (3m3s ago)    4m4s</span></span><br><span class=\"line\">  <span class=\"comment\"># pod/redis-redis-cluster-5   2/2     Running   1 (3m ago)      4m4s</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\"># NAME                                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)              AGE</span></span><br><span class=\"line\">  <span class=\"comment\"># service/redis-redis-cluster            ClusterIP   10.105.252.15   &lt;none&gt;        6379/TCP             4m4s</span></span><br><span class=\"line\">  <span class=\"comment\"># service/redis-redis-cluster-headless   ClusterIP   None            &lt;none&gt;        6379/TCP,16379/TCP   4m5s</span></span><br><span class=\"line\">  <span class=\"comment\"># service/redis-redis-cluster-metrics    ClusterIP   10.96.154.84    &lt;none&gt;        9121/TCP             4m4s</span></span><br></pre></td></tr></table></figure>\n<p><br/></p>\n<p>步骤 05.验证使用helm部署的Redis集群</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.查询设置或者机生成的 Redis 密码</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> REDIS_PASSWORD=$(kubectl get secret --namespace <span class=\"string\">\"database\"</span> redis-redis-cluster -o jsonpath=<span class=\"string\">\"&#123;.data.redis-password&#125;\"</span> | base64 -d)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.创建运行Redis客户端的pod：</span></span><br><span class=\"line\">kubectl run --namespace database redis-redis-cluster-client --rm --tty -i --restart=<span class=\"string\">'Never'</span> \\</span><br><span class=\"line\"> --env REDIS_PASSWORD=<span class=\"variable\">$REDIS_PASSWORD</span> \\</span><br><span class=\"line\">--image bitnami/redis-cluster:7.0.5-debian-11-r0 -- bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.在Pod中使用shell连接到集群</span></span><br><span class=\"line\">redis-cli -c -h redis-redis-cluster -a <span class=\"variable\">$REDIS_PASSWORD</span></span><br><span class=\"line\"><span class=\"comment\"># 集群信息</span></span><br><span class=\"line\">redis-redis-cluster:6379&gt; CLUSTER INFO</span><br><span class=\"line\">  <span class=\"comment\"># cluster_state:ok</span></span><br><span class=\"line\"><span class=\"comment\"># 节点信息</span></span><br><span class=\"line\">redis-redis-cluster:6379&gt; CLUSTER NODES</span><br><span class=\"line\"><span class=\"comment\"># 数据插入测试</span></span><br><span class=\"line\">redis-redis-cluster:6379&gt; <span class=\"built_in\">set</span> name weiyigeek</span><br><span class=\"line\">OK</span><br><span class=\"line\">10.66.237.149:6379&gt; <span class=\"built_in\">set</span> domain weiyigeek.top</span><br><span class=\"line\">OK</span><br><span class=\"line\">10.66.35.100:6379&gt; <span class=\"built_in\">set</span> blog blog.weiyigeek.top</span><br><span class=\"line\">OK</span><br><span class=\"line\">10.66.237.149:6379&gt; keys *</span><br><span class=\"line\">1) <span class=\"string\">\"name\"</span></span><br><span class=\"line\">2) <span class=\"string\">\"blog\"</span></span><br><span class=\"line\">10.66.237.149:6379&gt; get name</span><br><span class=\"line\"><span class=\"string\">\"weiyigeek\"</span></span><br></pre></td></tr></table></figure>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2022/5/20221009181636.png\" alt=\"WeiyiGeek.执行结果\" title=\"\" class=\"\">\n                <p>WeiyiGeek.执行结果</p>\n            </figure>\n<p>至此，快速使用helm安装多主多从redis集群完毕！</p>\n<p><br/></p>\n<h2 id=\"Kubernetes-快速部署-RedisInsight-工具连接Redis集群\"><a href=\"#Kubernetes-快速部署-RedisInsight-工具连接Redis集群\" class=\"headerlink\" title=\"Kubernetes 快速部署 RedisInsight 工具连接Redis集群\"></a>Kubernetes 快速部署 RedisInsight 工具连接Redis集群</h2><p>描述：RedisInsight 是 Redis 官方推荐的可视化工具，其功能强大，支持Redis集群连接。</p>\n<p>参考地址：<a href=\"https://docs.redis.com/latest/ri/installing/install-k8s/\" target=\"_blank\" rel=\"noopener\">https://docs.redis.com/latest/ri/installing/install-k8s/</a><br>参考文章: 【9.使用RedisInsight工具对Redis集群CURD操作及数据可视化和性能监控】- <a href=\"https://blog.weiyigeek.top/2022/9-20-686.html\">https://blog.weiyigeek.top/2022/9-20-686.html</a></p>\n<p><br/></p>\n<p>步骤 01.集群中快速 redisinsight 部署资源清单。<br><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">tee</span> <span class=\"string\">redisinsight-1.13.0.yaml</span> <span class=\"string\">&lt;&lt;'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># RedisInsight service with name 'redisinsight-service'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redisinsight-service</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">    - port:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"attr\">      targetPort:</span> <span class=\"number\">8001</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redisinsight</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># RedisInsight deployment with name 'redisinsight'</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">redisinsight</span>   <span class=\"comment\"># deployment name</span></span><br><span class=\"line\"><span class=\"attr\">  namespace:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">redisinsight</span>  <span class=\"comment\"># deployment label</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  replicas:</span> <span class=\"number\">1</span>          <span class=\"comment\"># a single replica pod</span></span><br><span class=\"line\"><span class=\"attr\">  strategy:</span></span><br><span class=\"line\"><span class=\"attr\">    type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">redisinsight</span> <span class=\"comment\"># which pods is the deployment managing, as defined by the pod template</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span>             <span class=\"comment\"># pod template</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">redisinsight</span> <span class=\"comment\"># label for pod/s</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      volumes:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">          emptyDir:</span> <span class=\"string\">&#123;&#125;</span>    <span class=\"comment\"># node-ephemeral volume https://kubernetes.io/docs/concepts/storage/volumes/#emptydir</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span>  <span class=\"string\">redisinsight</span>                  <span class=\"comment\"># Container name (DNS_LABEL, unique)</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">redislabs/redisinsight:1.13.0</span> <span class=\"comment\"># Hub Image</span></span><br><span class=\"line\"><span class=\"attr\">          imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span>        <span class=\"comment\"># Pull Policy</span></span><br><span class=\"line\"><span class=\"attr\">          env:</span> </span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">RIHOST</span></span><br><span class=\"line\"><span class=\"attr\">            value:</span> <span class=\"string\">\"0.0.0.0\"</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">RIPORT</span></span><br><span class=\"line\"><span class=\"attr\">            value:</span> <span class=\"string\">\"8001\"</span></span><br><span class=\"line\"><span class=\"attr\">          volumeMounts:</span></span><br><span class=\"line\"><span class=\"attr\">          - name:</span> <span class=\"string\">db</span> </span><br><span class=\"line\"><span class=\"attr\">            mountPath:</span> <span class=\"string\">/db</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">          - containerPort:</span> <span class=\"number\">8001</span>        <span class=\"comment\"># exposed container port and protocol</span></span><br><span class=\"line\"><span class=\"attr\">            protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\"><span class=\"attr\">          livenessProbe:</span></span><br><span class=\"line\"><span class=\"attr\">           httpGet:</span></span><br><span class=\"line\">              <span class=\"string\">path</span> <span class=\"string\">:</span> <span class=\"string\">/healthcheck/</span>     <span class=\"comment\"># exposed RI endpoint for healthcheck</span></span><br><span class=\"line\"><span class=\"attr\">              port:</span> <span class=\"number\">8001</span>               <span class=\"comment\"># exposed container port</span></span><br><span class=\"line\"><span class=\"attr\">           initialDelaySeconds:</span> <span class=\"number\">5</span>      <span class=\"comment\"># number of seconds to wait after the container starts to perform liveness probe</span></span><br><span class=\"line\"><span class=\"attr\">           periodSeconds:</span> <span class=\"number\">5</span>            <span class=\"comment\"># period in seconds after which liveness probe is performed</span></span><br><span class=\"line\"><span class=\"attr\">           failureThreshold:</span> <span class=\"number\">1</span>         <span class=\"comment\"># number of liveness probe failures after which container restarts</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure></p>\n<p>步骤 02.部署命令<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create ns dev</span><br><span class=\"line\">kubectl apply -f redisinsight-1.13.0.yaml</span><br></pre></td></tr></table></figure></p>\n<p>步骤 03.验证服务(你可按照需求使用nodeport或者ingress进行暴露端口)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pod -n dev</span><br><span class=\"line\">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">redisinsight-5c4f954694-jc5cd   1/1     Running   0          95s</span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl -n dev port-forward deployment/redisinsight --address 0.0.0.0 30081:8001</span><br><span class=\"line\">Forwarding from 0.0.0.0:30081 -&gt; 8001</span><br><span class=\"line\">Handling connection <span class=\"keyword\">for</span> 30081</span><br><span class=\"line\">Handling connection <span class=\"keyword\">for</span> 30081</span><br><span class=\"line\">Handling connection <span class=\"keyword\">for</span> 30081</span><br></pre></td></tr></table></figure></p>\n<p>步骤 04.浏览器访问 节点IP:30081 即可访问 redisinsight  UI 界面。</p>\n<p>至此完毕。</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"部署运维","path":"api/categories/部署运维.json"},{"name":"环境快速搭建","path":"api/categories/环境快速搭建.json"}],"tags":[{"name":"Redis","path":"api/tags/Redis.json"}]}