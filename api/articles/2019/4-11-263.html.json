{"title":"磁盘高可用解决方案(DBA).md","slug":"系统运维/系统架构/高可用/磁盘高可用解决方案","date":"2019-04-11T06:34:30.000Z","updated":"2022-03-29T05:39:06.301Z","url":"2019/4-11-263.html","path":"api/articles/2019/4-11-263.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411123732.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411150931.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411151016.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411153955.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411231249.png"],"content":"<h4 id=\"文章目录\"><a href=\"#文章目录\" class=\"headerlink\" title=\"文章目录\"></a>文章目录</h4><p>[TOC]</p>\n<p>(1) drbd 高可用解决方案</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-Drbd高可用\"><a href=\"#0x00-Drbd高可用\" class=\"headerlink\" title=\"0x00 Drbd高可用\"></a>0x00 Drbd高可用</h4><h5 id=\"1-drbd-介绍\"><a href=\"#1-drbd-介绍\" class=\"headerlink\" title=\"(1) drbd 介绍\"></a>(1) drbd 介绍</h5><p>官方网站：<br><em>Q:什么是Drbd？</em><br>答:分布式复制块设备(Drbd,Dirtributed Replicated Block Device)是基于软件的，无共享，复制的存储解决方案以及在块设备在不同高可用服务器对之间同步和镜像数据软件,解决磁盘单点故障(般情况下只支持2个节点),通过它可用实现在网络中两台服务器之间进行块设备级别的实时或异步镜像或者同步复制,类似rsync+inotify架构项目软件：</p>\n<p><em>他们之间的对比：</em></p>\n<ul>\n<li>inotify -&gt;  rsync：在文件系统之上的实际物理文件同步(磁盘IO效率低下);</li>\n<li>drbd：基于文件系统底层,block层级同步(效率更高),一个用软件实现的、无共享的、服务器之间镜像块设备内容的存储复制解决方案</li>\n</ul>\n<p>DRBD需构建在底层设备之上，然后构建出块设备。对用户来说DRBD设备就像是物理磁盘，可在其内创建文件系统；<br>Drbd支持的底层设备块设备分类：</p>\n<ul>\n<li>磁盘分区,整块磁盘</li>\n<li>LVM 逻辑卷</li>\n<li>soft raid设备</li>\n<li>EVMS（Enterprise Volume Management System，企业卷管理系统）的卷。</li>\n</ul>\n<p>数据镜像：实时、透明、同步（所有服务器都成功后返回）、异步（本地服务器成功后返回）。<br><br></p>\n<p><strong>1.Drbd工作原理</strong><br>drbd软件工作在文件系统层级以下,比文件系统更加靠近操作系统内核及IO栈,所以drbd是工作在系统内核之中的;但它不能神奇地添加上层的功能比如检测到EXT3文件系统的崩溃;<br>原理：基于DRBD的高可用(HA)两台服务器主机中,当我们将数据写入(主)磁盘中时候数据还将被发送到网络上的另外一台主机中(备);以相同的形式记录在磁盘之中,使得本地(Master)与远程主机(slave)的数据实时同步;drbd服务作用类似于磁盘阵列里的RAID1功能,就相当于把网络中两台服务器做成了类似于磁盘阵列里的RAID1一样;</p>\n<p>在高可用方案(HA)使用DRBD功能代替了共享盘阵(保存两份-冗余是50%),当Master出现故障时候,远程主机还会保留有一份和主节点相同的数据备份可以继续切换使用(直接接管提供服务,降低岩机修复时间),而不会发与故障前数据不一致的问题;</p>\n<p>工作原理图:<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411123732.png\" alt=\"WeiyiGeek.drbd工作原理图\" title=\"\" class=\"\">\n                <p>WeiyiGeek.drbd工作原理图</p>\n            </figure></p>\n<p><em>一般情况下文件写入磁盘的步骤是:</em><br>写操作 –&gt; 文件系统 –&gt; 内存缓存中 –&gt; 磁盘调度器 –&gt; 磁盘驱动器 –&gt; 写入磁盘 ; 而DRBD的工作机制如上图所示数据经过buffer cache后有内核中的DRBD模块(复制写入磁盘的数据)通过tcp/ip协议栈经过网卡和对方服务器DRBD服务建立数据同步。</p>\n<p><br></p>\n<p><strong>2.Drbd工作模式与协议</strong><br>当某一进程对某一文件执行了写操作时，写操作在上图执行到那个过程时就认为文件已经同步完成。</p>\n<p><em>Drbd的三种同步复制协议:</em><br>协议的选择将影响流量,从而影响网络延时;</p>\n<ul>\n<li>协议A：异步 asynchronous 复制协议(本地写入成功后立即返回,data放在发送的buffer中,可能会丢失)<br>  如上图文件写操作执行到A点是就认为写入磁盘成功(性能好/但是数据可靠性差)</li>\n<li>协议B：内存同步(半同步 Semi sync )复制协议(本地写入成功并将数据发送到对方后立即返回,如果双机掉电数据丢失)<br> 如上图文件写操作执行到B点是就认为写入磁盘成功。性能好，数据可靠性介于A和C之间。</li>\n<li>协议C：同步复制协议(sync),本地和对端服务器磁盘都写入成功确认后返回成功(如果单机电和单机磁盘损坏则数据不会丢失),drbd默认使用的复制协议;<br>  如上图文件写操作执行到C点是就认为写入磁盘成功。性能差，数据可靠性高。</li>\n</ul>\n<p><em>Drbd支持的两种模式：</em></p>\n<ol>\n<li>实时同步模式<br>当数据写入到本地磁盘和远端所有服务器磁盘都成功后才会返回成功写入;防止本地与远端的数据丢失不一致,生产环境中常用(DRBD服务协议C级别即该种同步模式)</li>\n<li>异步同步模式<br>当数据写入到本地服务器成功后就返回成功写入,不管远端服务死否写入成功;还可能是数据写入到本地服务器或远端的Buffer成功后返回;(DRBD服务协议a/b级别)</li>\n</ol>\n<p>提示：nfs网络系统文件也有类似的参数(sync/async)与功能;实时同步与异步同步;</p>\n<p><em>DRBD的工作模式:</em></p>\n<ol>\n<li>主从模型 master/slave（primary/secondary） | 单主模式<br>在某一时刻只允许有一个主节点,主节点的作用是可以挂在使用与写入数据等；从节点知识作为主节点的镜像是主节点的备份。</li>\n</ol>\n<ul>\n<li>优点：有效的避免磁盘出现单点故障,文件系统不会错乱</li>\n<li>缺点： 主节点读取/使用,而备节点只做备份使用(不能同上进行读取/写入)导致资源的浪费</li>\n</ul>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411150931.png\" alt=\"WeiyiGeek.主备模式\" title=\"\" class=\"\">\n                <p>WeiyiGeek.主备模式</p>\n            </figure>\n<ol start=\"2\">\n<li>双主模型 dula primary(primary/primary)[DRBD8.0之后的新特性]<br>所谓双主模型是2个节点都可以当做主节点来挂载使用;需要采用共享的cluster文件系统,如GFS和OCFS2用于需要从2个节点并发访问数据的场合,需要特别配置;</li>\n</ol>\n<figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411151016.png\" alt=\"WeiyiGeek.主主模式\" title=\"\" class=\"\">\n                <p>WeiyiGeek.主主模式</p>\n            </figure>\n<p><em>那么思考当第一个主节点对某一文件正在执行写操作，此时另一个节点也正在对同一文件也要执行写操作，结果会如何呢？</em><br>答：一般这种情况会造成文件系统的错乱，导致数据不能正常使用。<br>原因是：对文件的加速机制是由操作系统内核所管理的，一个节点对文件加速之后，另一个节点并不知道对方的锁信息。<br>解决办法是：使用集群文件系统,集群文件系统使用分布式文件锁管理器，当一个节点对文件加锁之后会通过某种机制来通知其他节点锁信息，从而实现文件锁共享。</p>\n<p><em>补充知识点:</em><br>Oracle的dg服务模式分为两种</p>\n<ul>\n<li>一种是逻辑上如SQL语句执行方法,8i~10g 备节点不提供服务</li>\n<li>另一种就是物理的如block块级模式,Oracle 11g 支持主库写从库读的方式</li>\n</ul>\n<hr>\n\n<h5 id=\"2-drbd-应用场景\"><a href=\"#2-drbd-应用场景\" class=\"headerlink\" title=\"(2) drbd 应用场景\"></a>(2) drbd 应用场景</h5><p>生产环境中Drbd常用于高可用服务器之间的数据同步解决方案;<br>如Heartbeat + drbd  + nfs/mfs/gfs ; heartbeat + drbd + mysql/Oracle等等,实际上可以结合任意需要数据同步的所有服务的应用场景;</p>\n<p><em>相关数据同步工具介绍:</em><br>(1) rsync [实时同步工具,但效率不高]<br>(2) scp [实时同步工具,但效率不高]<br>(3) nc / nfs (网络文件系统)<br>(4) union 双机同步<br>(5) csync2 多机同步<br>(6) 软自身同步机制 (<code>mysql,oracle,mongdb,ttserver,redis</code>) 文件放到数据库,同步到从库再把文件拿出来;<br>(7) drbd 高可用</p>\n<hr>\n\n<h5 id=\"3-drbd的安装\"><a href=\"#3-drbd的安装\" class=\"headerlink\" title=\"(3) drbd的安装\"></a>(3) drbd的安装</h5><p>Drbd软件分类：</p>\n<ul>\n<li>Centos5.x 适合drbd 8.3 YUM</li>\n<li>Centos6.x 适合drbd 8.4 </li>\n<li>Centos7.x 适合源码编译安装</li>\n</ul>\n<p>配置目标：两台服务器分别配置号drbd服务,实现Master-data1机器上/dev/sdb/分区上写入数据,数据会实时同步到Master-data2j机器上;一旦服务器出现异常,瞬间接替损坏数据或宕机的机器,实现数据异机实时同步,达到数据高可用无业务影响的目的;</p>\n<p><em>配置提示：</em></p>\n<ul>\n<li>配置的是drbd主备模式,及应用时只在主的一端写入数据,备的一端仅处于数据热备状态;</li>\n<li>备节点drbd的分区是不可见的,也是处于非活动状态,不能人为写入数据; </li>\n<li>多drbd分区主主双向同步模式,在实际生产环境中配置成为主主模式即如上面图所示：</li>\n</ul>\n<p>drbd 服务网卡以及资源配置:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##机器1 Master-data1 </span></span><br><span class=\"line\">管理IP ：               ETH1:192.168.1.100/24</span><br><span class=\"line\">DRBD管理名称与挂载目录:  data /data</span><br><span class=\"line\">DRBD逻辑设备:           /dev/drbd0             <span class=\"comment\">#关键点</span></span><br><span class=\"line\">心跳连接以及数据同步：   ETH2:192.168.2.100/24  <span class=\"comment\">#不要配网关/也不要与局域网内其他机器起冲突</span></span><br><span class=\"line\">DRBD 存储设备：         /dev/sdb1</span><br><span class=\"line\">DRBD Meta设备：         /dev/sdb2[0]</span><br><span class=\"line\">虚拟IP(VIP) ：          ETH1:192.168.1.10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##机器2 Master-data2 </span></span><br><span class=\"line\">管理IP ：               ETH1:192.168.1.101/24</span><br><span class=\"line\">DRBD管理名称与挂载目录:  data /data</span><br><span class=\"line\">DRBD逻辑设备:           /dev/drbd0             <span class=\"comment\">#关键点 通过 逻辑设备写到磁盘里面</span></span><br><span class=\"line\">心跳连接以及数据同步：   ETH2:192.168.2.101/24  <span class=\"comment\">#不要配网关/也不要与局域网内其他机器起冲突</span></span><br><span class=\"line\">DRBD 存储设备：         /dev/sdb1</span><br><span class=\"line\">DRBD Meta设备：         /dev/sdb2[0]</span><br><span class=\"line\">虚拟IP(VIP) ：          ETH1:192.168.1.11</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#推荐操作【把心跳地址写入/etc/hosts文件中】</span></span><br><span class=\"line\">192.168.2.100 Master-data1</span><br><span class=\"line\">192.168.2.101 Master-data2</span><br></pre></td></tr></table></figure></p>\n<p>安装环境：CentOS release 6.10 (Final) - 基础环境操作参看<a href=\"./2019/04/09/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-dba-md.html\">高可用服务解决方案(DBA)</a></p>\n<p>DRBD 配置步骤：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 安装drbd以及磁盘分区,加载modproed内核</span><br><span class=\"line\">2. 配置资源文件（定义资料名称，磁盘，节点信息，同步限制等）</span><br><span class=\"line\">3. 将drbd加入到系统服务chkconfig --add drbd </span><br><span class=\"line\">4. 初始化资源组 drbdadm create-md resource_name</span><br><span class=\"line\">5. 启动服务 service drbd start</span><br><span class=\"line\">6. 设置primary主机并同步数据</span><br><span class=\"line\">7. 分区、格式化&#x2F;dev&#x2F;drbd*</span><br><span class=\"line\">8. 一个节点进行挂载</span><br><span class=\"line\">9. 查看状态cat &#x2F;proc&#x2F;drbd</span><br></pre></td></tr></table></figure></p>\n<p>DRBD 安装流程：(跳过上面配置IP与hosts文件,添加主机路由)<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">###### Step 1. 公共安装#########</span></span><br><span class=\"line\">service iptables stop                       //关闭iptables</span><br><span class=\"line\">setenforcing 0                                 //暂时关闭selinux</span><br><span class=\"line\">sed -i <span class=\"string\">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/sysconfig/selinux      //永久关闭selinux</span><br><span class=\"line\">ntpdate -u asia.pool.ntp.org <span class=\"comment\"># 时间同步</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">###### Step 2. drbd服务安装 (编译安装/yum安装)########</span></span><br><span class=\"line\"><span class=\"comment\">#drbd共有两部分组成：内核模块和用户空间的管理工具。</span></span><br><span class=\"line\"><span class=\"comment\">#其中drbd内核模块代码已经整合进Linux内核2.6.33以后的版本中，因此如果内核版本高于此版本的话，只需要安装管理工具即可；否则您需要同时安装内核模块和管理工具两个软件包，并且此两者的版本号一定要保持对应。</span></span><br><span class=\"line\"><span class=\"comment\">#yum 安装需要找到相应的源 </span></span><br><span class=\"line\">[root@Master-data1/2 drbd]$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class=\"line\">[root@Master-data1/2 drbd]$ yum install https://www.elrepo.org/elrepo-release-6-8.el6.elrepo.noarch.rpm</span><br><span class=\"line\"><span class=\"comment\">#yum install https://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm (external link)</span></span><br><span class=\"line\"><span class=\"comment\">#keepcache = 1 yum配置文件就会保存下载的rpm</span></span><br><span class=\"line\">$ yum makecache</span><br><span class=\"line\">$ yum install kernel-devel kernel-header flex drbd84-utils kmod-drbd84  parted -y</span><br><span class=\"line\">Installed:</span><br><span class=\"line\">  drbd84-utils.i686 0:9.5.0-1.el6.elrepo              flex.i686 0:2.5.35-9.el6</span><br><span class=\"line\">  kernel-devel.i686 0:2.6.32-754.12.1.el6             kmod-drbd84.i686 0:8.4.11-1.el6_10.elrepo</span><br><span class=\"line\">Complete!  <span class=\"comment\">#表示安装成功</span></span><br><span class=\"line\"><span class=\"comment\">### 忽略以下内容</span></span><br><span class=\"line\"><span class=\"comment\"># 对应的内核模块的名字分别为 drbd-kmod</span></span><br><span class=\"line\"><span class=\"comment\"># 注意：drbd和drbd-kmdl的版本要对应；另一个是drbd-kmdl的版本要与当前系统的内核版本(uname -r)相对应。</span></span><br><span class=\"line\"><span class=\"comment\">#下载地址： http://www.rpmfind.net/linux/atrpms/el6-x86_64/atrpms/stable/</span></span><br><span class=\"line\"><span class=\"comment\">#          https://www.linbit.com/en/drbd-community/drbd-download/</span></span><br><span class=\"line\"><span class=\"comment\"># [root@Master-data2 drbd]# wget https://www.linbit.com/downloads/drbd/utils/drbd-utils-9.6.0.tar.gz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">############ Step3. 加载模块到内核 ###########</span></span><br><span class=\"line\">[root@Master-data1/2 ]$ modprobe drbd &amp;&amp; lsmod | grep drbd  <span class=\"comment\">#临时生效,重启由需要添加 可用加入到 /etc/rc.local</span></span><br><span class=\"line\">drbd                  485533  0</span><br><span class=\"line\">libcrc32c                841  1 drbd</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"modprobe drbd\"</span> &gt;&gt; /etc/rc.d/rc.local  <span class=\"comment\">#加载drbd到内核</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"modprode drbd &gt; /dev/null 2&gt;&amp;1\"</span> &gt; /etc/sysconfig/modules/drbd.modules</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">####### Step4. 建立一个磁盘分区  #######</span></span><br><span class=\"line\"><span class=\"comment\">#【重要】需要VirtualBox为虚拟机添加一块磁盘 选择磁盘格式为 SCSI 分配 0.5 GB</span></span><br><span class=\"line\">主节点：512MB </span><br><span class=\"line\">备节点：1024MB</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data1/data2 ~]$ fdisk -l</span><br><span class=\"line\">Disk /dev/sda: 536 MB, 536870912 bytes</span><br><span class=\"line\">Disk /dev/sda: 1073 MB, 1073741824 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># drbd服务 需要创建两个分区</span></span><br><span class=\"line\">/dev/sdb1  /data           存储数据目录           256MB / 768MB (数)</span><br><span class=\"line\">/dev/sdb2  mete data分区   存储drbd同步信息    总大小减去上面的大小</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#注意：</span></span><br><span class=\"line\">1.这里的meta data 分区一定不能个数建立文件系统</span><br><span class=\"line\">2.分浩的分区现在不能进行挂载(mount)</span><br><span class=\"line\">3.生产环境中DRBD meta data 分区一般设置为1~2G</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#【注意】 分区步骤 （注意如果 raid 磁盘阵列 超过2T 该命令不能使用 请是使用 parted）</span></span><br><span class=\"line\">[root@Master-data1 ~]<span class=\"comment\"># fdisk /dev/sda</span></span><br><span class=\"line\">Command (m <span class=\"keyword\">for</span> <span class=\"built_in\">help</span>): p</span><br><span class=\"line\">Disk /dev/sda: 536 MB, 536870912 bytes</span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">Command (m <span class=\"keyword\">for</span> <span class=\"built_in\">help</span>): n</span><br><span class=\"line\">Command action</span><br><span class=\"line\">   e   extended</span><br><span class=\"line\">   p   primary partition (1-4)</span><br><span class=\"line\">p</span><br><span class=\"line\">Partition number (1-4): 1 <span class=\"comment\">#注意分区编号1</span></span><br><span class=\"line\">First cylinder (1-512, default 1): 1</span><br><span class=\"line\">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-512, default 512): +256M</span><br><span class=\"line\"></span><br><span class=\"line\">Command (m <span class=\"keyword\">for</span> <span class=\"built_in\">help</span>): n</span><br><span class=\"line\">Command action</span><br><span class=\"line\">   e   extended</span><br><span class=\"line\">   p   primary partition (1-4)</span><br><span class=\"line\">p</span><br><span class=\"line\">Partition number (1-4): 2  <span class=\"comment\">#注意这里是2</span></span><br><span class=\"line\">First cylinder (386-512, default 386): <span class=\"comment\">#默认回车即可</span></span><br><span class=\"line\">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (386-512, default 512):</span><br><span class=\"line\"></span><br><span class=\"line\">Command (m <span class=\"keyword\">for</span> <span class=\"built_in\">help</span>): p  <span class=\"comment\">#显示分区信息</span></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/sdb1               1         385      394224   83  Linux   <span class=\"comment\">#存储数据 256</span></span><br><span class=\"line\">/dev/sdb2             386         512      130048   83  Linux   <span class=\"comment\">#drbd状态信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">w <span class=\"comment\">#分区写入</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ~]$ fdisk /dev/sda  <span class=\"comment\">#同上</span></span><br><span class=\"line\">Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/sdb1               1          99      795186   83  Linux  <span class=\"comment\">#768M</span></span><br><span class=\"line\">/dev/sdb2             100         130      249007+  83  Linux  <span class=\"comment\">#缺省就行(回车)</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ partprobe <span class=\"comment\">#执行写入分区表刷新磁盘</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">####### Step5.[分区完成后可能需要重启] 下面不需要操作 ##########</span></span><br><span class=\"line\"><span class=\"comment\"># 在两端主机内创建分区： 出现5月 14 14:57:19 Mzabbix drbd[4097]: adjust disk: data:failed(apply-al:1)错误时候方法</span></span><br><span class=\"line\"><span class=\"comment\"># 数据区：     parted /dev/sda mklabel gpt &amp;&amp; parted /dev/sdb mkpart logical ext4 700M 300M</span></span><br><span class=\"line\"><span class=\"comment\">#重读分区：  partprobe &amp;&amp; cat /proc/partions</span></span><br><span class=\"line\"><span class=\"comment\">#数据盘/dev/sdb1进行格式化  #meta盘/dev/sdb2不用进行格式化直接挂载</span></span><br><span class=\"line\">[root@Master-data1/2 ~]$ mkfs.ext4 /dev/sda1   <span class=\"comment\">#执行的时候注意自己的磁盘名称(巨坑)</span></span><br><span class=\"line\"><span class=\"comment\"># tune2fs -c -1 /dev/sdb1  #让磁盘被被检测</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411153955.png\" alt=\"WeiyiGeek.建立一个磁盘分区\" title=\"\" class=\"\">\n                <p>WeiyiGeek.建立一个磁盘分区</p>\n            </figure></p>\n<p><br><br><strong>补充：drbd磁盘采用parted分区[master/slave都执行]</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#BACKUP 机器上,分区大小不同是有目的的，为后面的扩容做准备;</span></span><br><span class=\"line\">[root@data2 ~]$ fdisk -l <span class=\"comment\">#查看本地磁盘</span></span><br><span class=\"line\">[root@data2 ~]$ parted /dev/sdb mkpart primary 0 600</span><br><span class=\"line\">[root@data2 ~]$ parted /dev/sdb mkpart primary 600 1073</span><br><span class=\"line\">[root@data2 ~]$ parted /dev/sdb p</span><br><span class=\"line\">Number  Start   End     Size   File system  Name     Flags</span><br><span class=\"line\"> 1      17.4kB  600MB   600MB               primary</span><br><span class=\"line\"> 2      600MB   1073MB  473MB               primary</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#对于新添加的磁盘快速分区方法</span></span><br><span class=\"line\"><span class=\"comment\"># echo -e \"n\\np\\nl\\n\\n+600M\\nn\\np\\n2\\n\\n+400M\\nw\" | fdisk /dev/sdb</span></span><br><span class=\"line\">partprobe <span class=\"comment\">#执行写入分区表刷新磁盘 #[重点]不重启系统添加磁盘并让kernel读取分区信息 yum -y install parted</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"4-drbd的配置文件\"><a href=\"#4-drbd的配置文件\" class=\"headerlink\" title=\"(4) drbd的配置文件\"></a>(4) drbd的配置文件</h5><p>修改配置文件流程：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">########## Step 5. 默认配置文件与目录 ###############</span></span><br><span class=\"line\">global &#123;</span><br><span class=\"line\">    usage-count no;  <span class=\"comment\">#是否参加DRBD使用者统计，默认是参加</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">common &#123;</span><br><span class=\"line\">    protocol C;    </span><br><span class=\"line\">    startup &#123;</span><br><span class=\"line\">        degr-wfc-timeout 240;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    disk &#123;</span><br><span class=\"line\">        on-io-error detach;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    net &#123; </span><br><span class=\"line\">        cram-hmac-alg md5; <span class=\"comment\">#DRBD同步时使用的验证方式和密码</span></span><br><span class=\"line\">        shared-secret <span class=\"string\">\"testdrbd\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    syncer &#123;</span><br><span class=\"line\">        rate 100M;      <span class=\"comment\">#主节点和备用节点同步时最大的网络速率 工作中是100M~1000M</span></span><br><span class=\"line\">        verify-alg crc32c; <span class=\"comment\">#验证算法</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">#资源设置</span></span><br><span class=\"line\">resource data&#123;</span><br><span class=\"line\">    disk &#123;</span><br><span class=\"line\">        on-io-error detach;  <span class=\"comment\">#磁盘出现IO错误处理</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">#两台主备节点配置 (关键点)</span></span><br><span class=\"line\">    on Mzabbix &#123;</span><br><span class=\"line\">        device /dev/drbd0;  <span class=\"comment\">#drbd写设备有自己对应的分区</span></span><br><span class=\"line\">        disk /dev/sdb1;        <span class=\"comment\">#本地数据分区1</span></span><br><span class=\"line\">        address  192.168.56.103:7788;  <span class=\"comment\">#心跳/数据传输接口 (建议把这个地址设置到hosts中改成心跳线的网卡)</span></span><br><span class=\"line\">        meta-disk /dev/sdb2[0];  <span class=\"comment\">#meta data数据分区2</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    on data2 &#123;</span><br><span class=\"line\">        device /dev/drbd0;</span><br><span class=\"line\">        disk /dev/sdb1;</span><br><span class=\"line\">        address  192.168.56.102:7788;</span><br><span class=\"line\">        meta-disk /dev/sdb2[0];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>然后将上面的配置复制到 Master-data2 上的 /etc/drbd.conf 中即可;</p>\n<h5 id=\"5-drbd的启动运行\"><a href=\"#5-drbd的启动运行\" class=\"headerlink\" title=\"(5) drbd的启动运行\"></a>(5) drbd的启动运行</h5><p>Drbd高可用运行案例:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">####### Step 6. 然后在两台机器都启动服务 ##########</span></span><br><span class=\"line\"><span class=\"comment\">#step0.建议先执行防止create-md失败</span></span><br><span class=\"line\">dd <span class=\"keyword\">if</span>=/dev/zero of=/dev/sdb&#123;1..2&#125; bs=1M count=100;sync</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step1.初始化DRBD的metadat(Create Device metadata)</span></span><br><span class=\"line\"><span class=\"comment\">#创建提供DRBD记录的信息的metadata分区</span></span><br><span class=\"line\">$ drbdadm create-md data</span><br><span class=\"line\">New drbd meta data block successfully created. drbd</span><br><span class=\"line\"><span class=\"comment\">#也可单独创建resource资源名称直接用;drbdadm create-md all,其中all表示我们在drbd.conf里定义所有的资源名称;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step2.启动DRBD</span></span><br><span class=\"line\">/etc/init.d/drbd start</span><br><span class=\"line\">$ drbdadm up data</span><br><span class=\"line\"><span class=\"comment\">#或者采用$ drbdadm up all</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step3.查看drbd状态</span></span><br><span class=\"line\">$ drbdadm status</span><br><span class=\"line\">    data role:Secondary</span><br><span class=\"line\">    disk:Inconsistent</span><br><span class=\"line\">    peer connection:Connecting</span><br><span class=\"line\"></span><br><span class=\"line\">$ cat /proc/drbd</span><br><span class=\"line\">version: 8.4.11-1 (api:1/proto:86-101)</span><br><span class=\"line\">GIT-hash: 66145a308421e9c124ec391a7848ac20203bb03c build by mockbuild@Build64R6, 2018-09-28 19:36:27</span><br><span class=\"line\"><span class=\"comment\">#看到drbd状态已经变化,此时状态是正确的 ro：Secondary/Secondary表示两端都是从,处于无主primary状态</span></span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190411231249.png\" alt=\"WeiyiGeek.drbd状态\" title=\"\" class=\"\">\n                <p>WeiyiGeek.drbd状态</p>\n            </figure></p>\n<p>同步drbd数据到对端Server使数据保持一致,指定一个要同步的资源同步数据到对端：<br>(1) 如果为空磁盘可以随意执行操作不需要考虑数据<br>(2) 如果两边数据不一样(注意同步数据的方向否则可能会丢失数据)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Step4.配置主从同步</span></span><br><span class=\"line\"><span class=\"comment\">#一个资源自能在一端执行同步数据到对端命令 ;将 Master-data1 服务同步到 Master-data2 分区中;</span></span><br><span class=\"line\">$ drbdsetup /dev/drbd0 primary --force  <span class=\"comment\">#设置主节点</span></span><br><span class=\"line\"><span class=\"comment\">#$ drbdadm  -- --overwrite-data-of-peer primary data</span></span><br><span class=\"line\"><span class=\"comment\"># 只是在Master-data1执行,如果从端为空数据直接执行</span></span><br><span class=\"line\">$ drbdadm primary data   <span class=\"comment\">#会自动开始同步数据 [主节点执行]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step5.同步模式查看</span></span><br><span class=\"line\">[root@Master-data1/2  ~]$ cat /proc/drbd</span><br><span class=\"line\">version: 8.4.11-1 (api:1/proto:86-101)</span><br><span class=\"line\"> 0: (连接状态)cs:Connected (角色)ro:Secondary/Primary ds(数据状态):UpToDate/UpToDate(同步状态) C r-----</span><br><span class=\"line\">    ns(网络发送):0 nr(网络接收):292952 dw(磁盘写):292952 dr(磁盘读):0 al(活动日志):16 bm():0 lo():0 pe():0 ua:0 ap:0 ep:1 wo:f oos:0  <span class=\"comment\">#正常情况下是一致的</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data1 ~]$ drbdadm status</span><br><span class=\"line\">data role:Primary</span><br><span class=\"line\">  disk:UpToDate</span><br><span class=\"line\">  peer role:Secondary  <span class=\"comment\">#对端角色name</span></span><br><span class=\"line\">    replication:Established peer-disk:UpToDate</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step6.创建同步文件夹及挂载drbd分区</span></span><br><span class=\"line\"><span class=\"comment\">#drbd实例利用主备模式进行实时同步数据到从服务器上面(Master-data2):</span></span><br><span class=\"line\">[root@Master-data1 ~]$ mkfs -t ext4 -b 4096 /dev/drbd0 <span class=\"comment\">#挂载前格式</span></span><br><span class=\"line\">[root@Master-data1 ~]$ mkdir /drbddata</span><br><span class=\"line\">[root@Master-data1 ~]$ mount /dev/drbd0 /drbddata/  <span class=\"comment\">#注意这里是drbd逻辑分区</span></span><br><span class=\"line\">[root@Master-data1 ~]$ df -h</span><br><span class=\"line\">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class=\"line\">/dev/drbd0            256M  792K  709M   1% /drbddata  <span class=\"comment\">#挂载成功</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Step7. 测试是否能进行文件同步</span></span><br><span class=\"line\">[root@Master-data1  ]$ touch `seq 0 10`  <span class=\"comment\">#在主中进行建立文件测试</span></span><br><span class=\"line\">[root@Master-data2 ~]$ drbdadm down data <span class=\"comment\">#由于是主备模式,必须down才能让您挂载物理分区</span></span><br><span class=\"line\">[root@Master-data2 ~]$ mount /dev/sdb1 /mnt/  <span class=\"comment\">#注意从服务器上是挂载的sdb1</span></span><br><span class=\"line\">[root@Master-data2 ~]$ ls /mnt/</span><br><span class=\"line\">0  1  10  11  12  13  14  15  16  17  18  19  2  20  3  4  5  6  7  8  9  lost+found</span><br><span class=\"line\">[root@Master-data2 ~]$ umount /mnt/  <span class=\"comment\">#退出挂载</span></span><br><span class=\"line\">[root@Master-data2 ~]$ drbdadm up data  <span class=\"comment\">#启动资源池</span></span><br><span class=\"line\">[root@Master-data2 ~]$ df -h  <span class=\"comment\">#注意这里存在一个坑 明明有768但是只显示有256M可用（备节点-课后坐月）</span></span><br><span class=\"line\">/dev/sdb1             256M  792K  709M   1% /mnt</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<p><strong>补充：CentOS7实例：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## MASTER 机器上</span></span><br><span class=\"line\">[root@data1 ~]<span class=\"variable\">$parted</span> /dev/sdb mkpart primary 0 300  <span class=\"comment\">#300MB</span></span><br><span class=\"line\">Warning: The resulting partition is not properly aligned <span class=\"keyword\">for</span> best performance.</span><br><span class=\"line\">Ignore/Cancel? ignore</span><br><span class=\"line\">Information: You may need to update /etc/fstab.</span><br><span class=\"line\"></span><br><span class=\"line\">[root@data1 ~]<span class=\"variable\">$parted</span> /dev/sdb mkpart primary 300 536  <span class=\"comment\">#236MB</span></span><br><span class=\"line\">Warning: The resulting partition is not properly aligned <span class=\"keyword\">for</span> best performance.</span><br><span class=\"line\">Ignore/Cancel? ignore</span><br><span class=\"line\">Information: You may need to update /etc/fstab.</span><br><span class=\"line\"></span><br><span class=\"line\">[root@data1 ~]<span class=\"variable\">$parted</span> /dev/sdb p</span><br><span class=\"line\">Model: ATA VBOX HARDDISK (scsi)</span><br><span class=\"line\">Disk /dev/sdb: 537MB</span><br><span class=\"line\">Sector size (logical/physical): 512B/512B</span><br><span class=\"line\">Partition Table: gpt</span><br><span class=\"line\">Disk Flags:</span><br><span class=\"line\"></span><br><span class=\"line\">Number  Start   End    Size   File system  Name     Flags</span><br><span class=\"line\"> 1      17.4kB  300MB  300MB               primary</span><br><span class=\"line\"> 2      300MB   536MB  236MB               primary</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#(1) 建立数据存储m目录</span></span><br><span class=\"line\"><span class=\"comment\">##--overwrite-data-of-peer 覆盖对端的数据</span></span><br><span class=\"line\">drbdadm  -- --overwrite-data-of-peer primary data  <span class=\"comment\">#设置data1为主</span></span><br><span class=\"line\"><span class=\"comment\">#drbd配置完成并启动后的效果 （data1 == 主 primary/ data2 = 从 Secondary）</span></span><br><span class=\"line\">$ cat /proc/drbd</span><br><span class=\"line\">0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class=\"line\">[root@data1/2 ~]$ mkdir /data -p <span class=\"comment\">#在启用drbd时候</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#使用/dev/drbd0分区必须格式化她drbd</span></span><br><span class=\"line\"><span class=\"comment\">#[root@data1 ~]$ mkfs -t ext4 -b 4096 /dev/drbd0</span></span><br><span class=\"line\"><span class=\"comment\">#[root@data1 ~]$ mount /dev/drbd0 /data  #挂载</span></span><br><span class=\"line\">mkfs.ext4 /dev/drbd0 &amp;&amp; mount /dev/drbd0/data       <span class=\"comment\">#只需将数据写入/dData，drbd即把其同步到backupNode的/dev/sda2（仅需挂载逻辑设备，不挂载其下层的分区而由DRBD后台挂载用）</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#(2) 从库查看同步的数据 （这时重启格式化/dev/drbd0就没有数据注意备份）</span></span><br><span class=\"line\">[root@data2 ~]$ drbdadm down data      <span class=\"comment\">#【备节点必须执行down数据名称】</span></span><br><span class=\"line\">[root@data2 ~]$ mount /dev/sdb1 /mnt   <span class=\"comment\">#【备节点挂载 sdb1 到/mnt中国】</span></span><br><span class=\"line\">[root@data2 ~]$ ls  <span class=\"comment\">#查看数据 （注意不能写入数据）</span></span><br><span class=\"line\">[root@data2 ~]$ umount /mnt  <span class=\"comment\">#取消挂载</span></span><br><span class=\"line\">[root@data2 ~]$ drbdadm up data        <span class=\"comment\">#启动drbd备节点(重新进行同步)</span></span><br><span class=\"line\"><span class=\"comment\"># 补充：drbd可以自启动而heartbeat不用进行自启动</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#（3）主备切换 （做HA高可用的时候）</span></span><br><span class=\"line\">[root@Master-data1 ~]umount /mnt <span class=\"comment\">#先将主上面的磁盘卸载掉并降级</span></span><br><span class=\"line\">[root@Master-data1 ~]drbdadm secondary data</span><br><span class=\"line\"></span><br><span class=\"line\">[root@Master-data2 ~]drbdadm primary data  <span class=\"comment\">#在备机上升级为主机</span></span><br><span class=\"line\">[root@Master-data2 ~]mount /dev/drbd0 /mnt <span class=\"comment\"># 挂载磁盘</span></span><br></pre></td></tr></table></figure></p>\n<h5 id=\"7-附录补充\"><a href=\"#7-附录补充\" class=\"headerlink\" title=\"(7) 附录补充\"></a>(7) 附录补充</h5><p>DRBD配置工具：</p>\n<ul>\n<li>drbdadm：  高级管理工具，管理/etc/drbd.conf，向drbdsetup和drbdmeta发送指令</li>\n<li>drbdsetup： 配置装载进kernel的DRBD模块，平时很少用</li>\n<li>drbdmeta： 管理META数据结构，平时很少用</li>\n</ul>\n<p><strong>6.1 drbd命令解析</strong><br><em>（1）drbdadm 命令:</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ drbdadm up all  <span class=\"comment\">#相当于如下三个命令组合 all 代表所有的资源池</span></span><br><span class=\"line\">drbdadm attach all</span><br><span class=\"line\">drbdadm syncer all</span><br><span class=\"line\">drbdadm connnect all</span><br><span class=\"line\"></span><br><span class=\"line\">$ drbdadm down all  <span class=\"comment\">#down掉所有的资源同步</span></span><br><span class=\"line\">$ drbdadm disconnect data  <span class=\"comment\">#断开data资源池的同步</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ drbdadm status  <span class=\"comment\">#查看drbd状态</span></span><br><span class=\"line\">$ drbdadm role 资源名   <span class=\"comment\">#查看节点的角色：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##--overwrite-data-of-peer 覆盖对端的数据</span></span><br><span class=\"line\">$ drbdadm  -- --overwrite-data-of-peer primary data <span class=\"comment\">#配置主从同步模式(主执行) </span></span><br><span class=\"line\">$ drbdadm primary data <span class=\"comment\">#会自动开始同步数据(主节点运行)</span></span><br><span class=\"line\">$ drbdadm secondary data <span class=\"comment\">#会自动开始同步数据(从节点运行)</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ drbdadm -- --discard-my-data connect data  <span class=\"comment\">#重新连接资源池</span></span><br><span class=\"line\">$ drbd-overview   <span class=\"comment\">#查看同步状态</span></span><br></pre></td></tr></table></figure><br><br></p>\n<p><em>drbdsetup 命令:</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drbdsetup /dev/drbd0 primary --force <span class=\"comment\">#将drbd1主机配置为主节点：(node1)</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br><strong>6.2 drbd状态的意义</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">输出文件上面最开始是drbd的版本信息，然后就是数据同步的一些状态信息：</span><br><span class=\"line\">cs — connection state</span><br><span class=\"line\">st — node state (<span class=\"built_in\">local</span>/remote)</span><br><span class=\"line\">ld — <span class=\"built_in\">local</span> data consistency</span><br><span class=\"line\">ds — data consistency</span><br><span class=\"line\">ns — network send</span><br><span class=\"line\">nr — network receive</span><br><span class=\"line\">dw — disk wr</span><br><span class=\"line\">ite</span><br><span class=\"line\">dr — disk <span class=\"built_in\">read</span></span><br><span class=\"line\">pe — pending (waiting <span class=\"keyword\">for</span> ack)</span><br><span class=\"line\">ua — unack’d (still need to send ack)</span><br><span class=\"line\">al — access <span class=\"built_in\">log</span> write count</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#资源的连接状态；一个资源可能有以下连接状态中的一种</span></span><br><span class=\"line\">StandAlone 独立的：网络配置不可用；资源还没有被连接或是被管理断开（使用 drbdadm disconnect 命令），或是由于出现认证失败或是脑裂的情况</span><br><span class=\"line\">Disconnecting 断开：断开只是临时状态，下一个状态是StandAlone独立的</span><br><span class=\"line\">Unconnected 悬空：是尝试连接前的临时状态，可能下一个状态为WFconnection和WFReportParams</span><br><span class=\"line\">Timeout 超时：与对等节点连接超时，也是临时状态，下一个状态为Unconected悬空</span><br><span class=\"line\">BrokerPipe：与对等节点连接丢失，也是临时状态，下一个状态为Unconected悬空</span><br><span class=\"line\">NetworkFailure：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空</span><br><span class=\"line\">ProtocolError：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空</span><br><span class=\"line\">TearDown 拆解：临时状态，对等节点关闭，下一个状态为Unconected悬空</span><br><span class=\"line\">WFConnection：等待和对等节点建立网络连接</span><br><span class=\"line\">WFReportParams：已经建立TCP连接，本节点等待从对等节点传来的第一个网络包</span><br><span class=\"line\">Connected 连接：DRBD已经建立连接，数据镜像现在可用，节点处于正常状态</span><br><span class=\"line\">StartingSyncS：完全同步，有管理员发起的刚刚开始同步，未来可能的状态为SyncSource或PausedSyncS</span><br><span class=\"line\">StartingSyncT：完全同步，有管理员发起的刚刚开始同步，下一状态为WFSyncUUID</span><br><span class=\"line\">WFBitMapS：部分同步刚刚开始，下一步可能的状态为SyncSource或PausedSyncS</span><br><span class=\"line\">WFBitMapT：部分同步刚刚开始，下一步可能的状态为WFSyncUUID</span><br><span class=\"line\">WFSyncUUID：同步即将开始，下一步可能的状态为SyncTarget或PausedSyncT</span><br><span class=\"line\">SyncSource：以本节点为同步源的同步正在进行</span><br><span class=\"line\">SyncTarget：以本节点为同步目标的同步正在进行</span><br><span class=\"line\">PausedSyncS：以本地节点是一个持续同步的源，但是目前同步已经暂停，可能是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步</span><br><span class=\"line\">PausedSyncT：以本地节点为持续同步的目标，但是目前同步已经暂停，这可以是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步</span><br><span class=\"line\">VerifyS：以本地节点为验证源的线上设备验证正在执行</span><br><span class=\"line\">VerifyT：以本地节点为验证目标的线上设备验证正在执行</span><br></pre></td></tr></table></figure><br><br></p>\n<p><strong>6.3 drbd配置文件</strong><br>DRBD配置文件：DRBD的主配置文件为/etc/drbd.conf<br>为了管理的便捷性通常会将些配置文件分多个部分，但都保存至/etc/drbd.d目录。主配置文件中仅使用”include”指令将这些配置文件片断整合。<br>通常/etc/drbd.d中的文件为global_common.conf和所有以.res结尾的文件。其中：</p>\n<ul>\n<li>global_common.conf中主要定义global段和common段</li>\n<li>每个.res文件用于定义一个资源</li>\n</ul>\n<p>一个DRBD设备(即/dev/drbdX),叫做一个”资源”。里面包含DRBD设备的主备节点的ip信息，底层存储设备名称及设备大小，meta信息存放方式,drbd对外提供的设备名等:<br>DRBD资源：</p>\n<ul>\n<li>Resource name：  除空白字符的任意的ACSII码字符</li>\n<li>DRBD device：  在双方节点上，此DRBD设备的设备文件；一般为/dev/drbdN，其主设备号147</li>\n<li>Disk configuration：  在双方节点上各自提供的存储设备</li>\n<li>Nerwork configuration：  双方数据同步时所使用的网络属性</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$vim</span> /etc/drbd.d/global_common.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在配置文件中global段仅出现一次，且若所有配置信息都保存至同一个配置文件中而不分开为多个文件的话则global段必须位于配置文件最开始处</span></span><br><span class=\"line\">    目前global段中可以定义的参数仅有minor-count, dialog-refresh, <span class=\"built_in\">disable</span>-ip-verification和usage-count。</span><br><span class=\"line\">global &#123;</span><br><span class=\"line\">    usage-count no;  <span class=\"comment\">#是否参加DRBD使用者统计，默认是参加</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#用于定义被每一个资源默认继承的参数，可在资源定义中使用的参数都可在common定义。实际应用中common段并非必须但建议将多个资源共享的参数定义在common段以降低配置复杂度</span></span><br><span class=\"line\">common &#123;</span><br><span class=\"line\">  protocol C; <span class=\"comment\">#使用DRBD的第三种同步协议，表示收到远程主机的写入确认后认为写入完成 (重点)</span></span><br><span class=\"line\">  handlers &#123;　　　</span><br><span class=\"line\">    pri-on-incon-degr <span class=\"string\">\"/usr/lib/drbd/notify-pri-on-incon-degr.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f\"</span>;</span><br><span class=\"line\">    pri-lost-after-sb <span class=\"string\">\"/usr/lib/drbd/notify-pri-lost-after-sb.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f\"</span>;</span><br><span class=\"line\">    <span class=\"built_in\">local</span>-io-error <span class=\"string\">\"/usr/lib/drbd/notify-io-error.sh; /usr/lib/drbd/notify-emergency-shutdown.sh; echo o &gt; /proc/sysrq-trigger ; halt -f\"</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  startup &#123;</span><br><span class=\"line\">    wfc-timeout          60;</span><br><span class=\"line\">    degr-wfc-timeout     60; <span class=\"comment\">#启动时连接资源的超时时间</span></span><br><span class=\"line\">    outdated-wfc-timeout 06;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  disk &#123;</span><br><span class=\"line\">    on-io-error detach; <span class=\"comment\">#磁盘出现IO错误处理</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  net &#123; </span><br><span class=\"line\">    cram-hmac-alg sha1;    <span class=\"comment\">#DRBD网络同步时使用的验证方式和密码</span></span><br><span class=\"line\">    shared-secret <span class=\"string\">\"testdrbd\"</span>;</span><br><span class=\"line\">    max-buffers 2048;</span><br><span class=\"line\">    max-epoch-size 2048; </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">#同步时的速率限制及数据的验证算法   </span></span><br><span class=\"line\">  syncer &#123;</span><br><span class=\"line\">    rate 30M;      <span class=\"comment\">#主节点和备用节点同步时最大的网络速率 工作中是100M~1000M</span></span><br><span class=\"line\">    verify-alg crc32c; <span class=\"comment\">#验证算法</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#资源设置|主从模式 一个资源 / 还能添加资源就是 data2 / data3</span></span><br><span class=\"line\"><span class=\"comment\">#资源在定义时必须为其命名每个资源段的定义中至少要包含两个host子段，以定义此资源关联至的节点，其它参数均可以从common段或drbd的默认中进行继承而无须定义</span></span><br><span class=\"line\">resource data&#123;</span><br><span class=\"line\">    meta-disk internal; <span class=\"comment\">#meta-data和数据存放在同一个底层</span></span><br><span class=\"line\">    <span class=\"comment\">#两台主备节点配置 (关键点)</span></span><br><span class=\"line\">    on data1 &#123;</span><br><span class=\"line\">        device /dev/drbd0;  <span class=\"comment\">#drbd写设备有自己对应的分区</span></span><br><span class=\"line\">        disk /dev/sdb1;        <span class=\"comment\">#本地数据分区1</span></span><br><span class=\"line\">        address  192.168.2.100:7788;  <span class=\"comment\">#心跳/数据传输接口 (建议把这个地址设置到hosts中改成心跳线的网卡)</span></span><br><span class=\"line\">        meta-disk /dev/sdb2[0];  <span class=\"comment\">#meta data数据分区2</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    on data2 &#123;</span><br><span class=\"line\">        device /dev/drbd0;  <span class=\"comment\">#drbd写设备有自己对应的分区</span></span><br><span class=\"line\">        disk /dev/sdb1;        <span class=\"comment\">#数据</span></span><br><span class=\"line\">        address  192.168.2.101:7788;  <span class=\"comment\">#心跳/数据传输接口</span></span><br><span class=\"line\">        meta-disk /dev/sdb2[0];  <span class=\"comment\">#meta data数据分区</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用于定义drbd资源，每个资源通常定义在一个单独的位于/etc/drbd.d目录中的以.res结尾的文件中。</span></span><br><span class=\"line\">cat /etc/drbd.d/nfsdrbd.res</span><br><span class=\"line\">resource nfsdrbd &#123;</span><br><span class=\"line\">       on pz142 &#123;</span><br><span class=\"line\">              device /dev/drbd0;</span><br><span class=\"line\">              disk   /dev/vg1/lv1;</span><br><span class=\"line\">              address 192.168.1.142:7789;</span><br><span class=\"line\">              meta-disk internal;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       on pz144 &#123;</span><br><span class=\"line\">              device /dev/drbd0;</span><br><span class=\"line\">              disk   /dev/vg1/lv1;</span><br><span class=\"line\">              address 192.168.1.144:7789;</span><br><span class=\"line\">              meta-disk internal;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>6.4 drbd入坑计</strong><br><em>Q:问题 drbdadm create-md data失败?</em><br>问题：/etc/drbd.conf:6: Parse error: ‘a syncer option keyword’ expected,but got ‘rate’<br>解决方法：yum install gcc gcc-c++ make glibc flex kernel kernel-devel kernel-headers</p>\n<p><br><br><em>Q:问题 drbdadm up all 失败?</em><br>问题:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: Failure: (119) No valid meta-data signature found.</span><br><span class=\"line\">        ==&gt; Use <span class=\"string\">'drbdadm create-md res'</span> to initialize meta-data area. &lt;==</span><br><span class=\"line\">Command <span class=\"string\">'drbdsetup-84 attach 0 /dev/sdb1 /dev/sdb2 0 --on-io-error=detach --resync-rate=30M'</span> terminated with <span class=\"built_in\">exit</span> code 10</span><br></pre></td></tr></table></figure><br>解决办法：查看分区是否错误,分区后重启系统再启动; dd if=/dev/zero bs=1M count=1 of=/dev/sdb{1..2};sync<br>dd if=/dev/zero bs=1M count=1 of=/dev/sda{1..2};sync<br><br></p>\n<p><em>Q:同步状态出现异常？</em><br>问题：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: cs:WFConnection ro:Secondary(本端角色)/Unknown ds:Inconsistent/DUnknown(问题点) C r----s</span><br><span class=\"line\">    ns:0 nr:0 dw:0 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:795188</span><br></pre></td></tr></table></figure><br>解决办法：</p>\n<ul>\n<li>检测两台drbd服务器物理网络链接或者IP及主机路由是否正确</li>\n<li>停止iptables防火墙或者放行drbd(指定IP形式)</li>\n<li>Secondary/Unkonwn 可能是发生裂脑导致的结果<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#在从节点执行：</span><br><span class=\"line\">modprobe drbd</span><br><span class=\"line\">drbdadm secondary data</span><br><span class=\"line\">drbdadm up data</span><br><span class=\"line\">drbdadm disconnect data</span><br><span class=\"line\">drbdadm -- --discard-my-data connect data</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p><em>Q：如何解决drbd裂脑问题？</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##备用节点：</span></span><br><span class=\"line\"><span class=\"comment\">#b.主节点查看drbd状态如果 cs:WFConnection 不是该状态需要手动进行链接</span></span><br><span class=\"line\">[root@ pz142 ~]<span class=\"comment\"># drbdadm secondary r0</span></span><br><span class=\"line\">[root@ pz142 ~]<span class=\"comment\"># drbdadm disconnect all</span></span><br><span class=\"line\">[root@ pz142 ~]<span class=\"comment\"># drbdadm -- --discard-my-data connect r0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##主节点：</span></span><br><span class=\"line\">[root@ pz144 ~]<span class=\"comment\"># drbdadm disconnect al</span></span><br><span class=\"line\">[root@ pz144 ~]<span class=\"comment\"># drbdadm connect r0</span></span><br><span class=\"line\">[root@ pz144 ~]<span class=\"comment\"># drbdsetup /dev/drbd0 primary</span></span><br><span class=\"line\">[root@ pz144 ~]<span class=\"comment\"># mount /dev/drbd0 /data/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#c.cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C</span></span><br><span class=\"line\">drbdadm -- --overwrite-data-of-peer primary drbd   <span class=\"comment\">#</span></span><br></pre></td></tr></table></figure></p>\n<p><br><br><em>Q:drbd主节点无法进行挂载mount</em><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#原因由于/dev/drbd0 未进行初始</span></span><br><span class=\"line\">[root@data1 <span class=\"built_in\">log</span>]<span class=\"comment\"># mount /dev/drbd0 /data</span></span><br><span class=\"line\">mount: /dev/drbd0 is write-protected, mounting <span class=\"built_in\">read</span>-only</span><br><span class=\"line\">mount: unknown filesystem <span class=\"built_in\">type</span> <span class=\"string\">'(null)'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解决方法</span></span><br><span class=\"line\">mkfs -t ext4 -b 4096 /dev/drbd0</span><br></pre></td></tr></table></figure></p>\n","comments":true,"excerpt":"文章目录[TOC](1) drbd 高可用解决方案","categories":[{"name":"系统架构","path":"api/categories/系统架构.json"},{"name":"运维基础","path":"api/categories/运维基础.json"}],"tags":[{"name":"高可用服务","path":"api/tags/高可用服务.json"}]}