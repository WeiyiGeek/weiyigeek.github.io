<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 Keepalived高可用服务解决方案|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="高可用服务">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>Keepalived高可用服务解决方案</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">Keepalived高可用服务解决方案</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-06-09T06:34:30.000Z" itemprop="datePublished" class="page-time">
  2019-06-09
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E8%BF%90%E7%BB%B4%E5%9F%BA%E7%A1%80/">运维基础</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-系统运维/系统架构/高可用/Keepalived高可用服务解决方案"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">Keepalived高可用服务解决方案</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-06-09 14:34:30" datetime="2019-06-09T06:34:30.000Z"  itemprop="datePublished">2019-06-09</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E8%BF%90%E7%BB%B4%E5%9F%BA%E7%A1%80/">运维基础</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<h4 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h4><p>(1) Keepalive 高可用解决方案</p>
<a id="more"></a>
<h4 id="0x00-快速入门"><a href="#0x00-快速入门" class="headerlink" title="0x00 快速入门"></a>0x00 快速入门</h4><p><em>Q:什么是高可用集群(Cluster)？</em><br>答：高可用集群（High Availability Cluster，简称HA Cluster），是指以减少服务中断时间为目的的服务器集群技术。它通过保护用户的业务程序对外不间断提供的服务，把因软件、硬件、人为造成的故障对业务的影响降低到最小程度。(简单说就是：保证服务不间断地运行)</p>
<p>系统故障分类：</p>
<ul>
<li>硬件故障：设计缺陷、wearout（损耗）、自然灾害、不可抗力等等</li>
<li>软件故障：设计缺陷</li>
</ul>
<p>集群类型：</p>
<ul>
<li>LB : LVS / NGINX (http/upstream,stream / upstrem)</li>
<li>HA 高可用性 SPoF : SinglePointofFailure,高可用的是“服务”并且资源组成一个高可用服务的“组件”(vip/nginx process shared storage)</li>
<li>HPC 高性能计算（High Performance Computing）</li>
</ul>
<p><strong>1）高可用集群的衡量标准</strong><br>要保证集群服务100%时间永远完全可用，几乎可以说是一件不可能完成的任务,通常用平均无故障时间(MTTF)来度量系统的可靠性,用平均故障维修时间（MTTR）来度量系统的可维护性。MTBF代表着平均故障间隔时间（Mean Time Between Failures）它也与MTTR有相关关系;</p>
<ul>
<li>可用性被定义为：HA = MTTF/(MTTF+MTTR)*100%。</li>
<li>系统可用性的公式：HA = MTBF/(MTBF+MTTR)(0,1), 95%几个9（指标）:99%,…,99.999%，99.9999%</li>
</ul>
<p>具体HA衡量标准:<br><figure class="image-box">
                <a rel=Keepalived高可用服务解决方案 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190610093636.png" target="_blank" title="WeiyiGeek.衡量标准" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190610093636.png" alt="WeiyiGeek.衡量标准" title="" class=""></a>
                <p>WeiyiGeek.衡量标准</p>
            </figure></p>
<p>补充：提升系统高用性的解决方案之降低MTTR手段就是冗余redundant</p>
<p><br></p>
<p><strong>2）高可用集群实现原理</strong><br>高可用集群主要实现自动侦测(Auto-Detect)故障、自动切换/故障转移(FailOver)和自动恢复(FailBack)。<br>简单来说就是用高可用集群软件实现故障检查和故障转移（故障/备份主机切换）的自动化，当然像负载均衡、DNS分发也可提供高可性。</p>
<ol>
<li>自动侦测(Auto-Detect)/ 故障检查<br>自动侦测阶段由主机上的软件通过冗余侦测线，经由复杂的监听程序逻辑判断，来相互侦测对方运行的情况。<br>常用的方法是：集群各节点间通过心跳信息判断节点是否出现故障。</li>
</ol>
<ol start="2">
<li>自动切换/故障转移（FailOver）<br>自动切换阶段某一主机如果确认对方故障，则正常主机除继续进行原来的任务，还将依据各种容错备援模式接管预先设定的备援作业程序，并进行后续的程序及服务。<br>通俗地说，即当A无法为客户服务时，系统能够自动地切换，使B能够及时地顶上继续为客户提供服务，且客户感觉不到这个为他提供服务的对象已经更换。</li>
</ol>
<ol start="3">
<li>自动恢复/故障回转(FailBack)<br>自动恢复阶段在正常主机代替故障主机工作后，故障主机可离线进行修复工作。在故障主机修复后，透过冗余通讯线与原正常主机连线，自动切换回修复完成的主机上。</li>
</ol>
<ol start="4">
<li>其他关注点<br><em>Q：如果节点不再成为集群节点成员时（不合法），如何处理运行于当前节点的资源？</em><br>答：如果集群没有对其进行Fecning/Stonith隔离前，可以进行相关配置（without_quorum_policy），有如下配置选项：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、stop：直接停止服务；</span><br><span class="line">2、ignore：忽略，以前运行什么服务现在还运行什么（双节点集群需要配置该选项）；</span><br><span class="line">3、Freeze：冻结，保持事先建立的连接，但不再接收新的请求；</span><br><span class="line">4、suicide：<span class="built_in">kill</span>掉服务。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><em>（重要知识点）集群脑裂（Split-Brain）和资源隔离（Fencing）</em><br>脑裂：是因为集群分裂导致的，集群中有节点因为处理器忙或者其他原因暂时停止响应时，与其他节点间的心跳出现故障，但这些节点还处于active状态，其他节点可能误认为该节点”已死”，从而争夺共享资源（如共享存储）的访问权，分裂为两部分独立节点。</p>
<ul>
<li>脑裂后果：这时两个节点开始争抢共享资源，结果会导致系统混乱，数据损坏。</li>
<li>脑裂解决：上面3-1-1、3-1-2的方法也能一定程度上解决脑裂的问题，但完全解决还需要资源隔离（Fencing）。</li>
</ul>
<p>资源隔离（Fencing）：当不能确定某个节点的状态时，通过fencing把对方干掉，确保共享资源被完全释放，前提是必须要有可靠的fence设备。<br>节点级别：STONITH（shoot the other node in the head，爆头硬件方式），直接控制故障节点的电源，绝对彻底。<br>资源级别：例如：FC SAN switch（软件方式）可以实现在存储资源级别拒绝某节点的访问<br><br></p>
<p><strong>3) 高可用集群工作模型</strong></p>
<ul>
<li>Active/Passive：主备模型; 一个活动主节点，另一个不活动作为备用节点，当主节点故障，转移到备节点，这时备节点就成为了主节点。备节点完全冗余，造成一定浪费</li>
<li>Active/Active：双主模型; 两个节点都是活动的，两个节点运行两个不同的服务，也互为备用节点。也可以提供同一个服务，比如ipvs，前端基于DNS轮询。这种模型可以使用比较均衡的主机配置，不会造成浪费。</li>
<li>N+1:  N个活动主节点N个服务，一个备用节点,需要额外的备用节点必须能够代替任何主节点，当任何主节点故障时，备节点能够负责它的角色对外提供相应的服务</li>
<li>N+M : N个活动主节点，M个备用节点。像上面的N+1模型，一个备用节点可能无法提供足够的备用冗余能力，备用节点的数量M是成本和可靠性要求之间的折衷。（其他说法N-M: N个节点M个服务， N&gt;M， 活动节点为N， 备用节点为N-M。）</li>
<li>N-to-1 ： 与N+1一样,也是N个活动主节点，一个备用节点；不同是的备用节点成为主节点只是暂时的，当原来故障的节点修复后，必须回转才能正常工作</li>
<li>N-to-N : N个主节点N个备用节点。这是A/A双主和N + M模型的组合，N节点都有服务，如果一个坏了，剩下的每个节点都可以作为替代提供服务<br><br></li>
</ul>
<p><strong>4）高可用集群架构层次</strong><br>这一层主要是正在运行在物理主机上的服务，高可用集群相关的软件运行在各主机上，集群资源也是在各主机上。</p>
<ul>
<li>Messaging(消息) and Membership Layer(成员关系)<ul>
<li>信息传递层，传递集群信息的一种机制，通过监听UDP 694号端口，可通过单播、组播、广播的方式，实时快速传递信息，传递的内容为高可用集群的集群事务，例如：心跳信息，资源事务信息等等，只负责传递信息，不负责信息的计算和比较。</li>
<li>成员关系（Membership）层，这层最重要的作用是主节点（DC）通过Cluster Consensus Menbership Service（CCM或者CCS）这种服务由Messaging层提供的信息，来产生一个完整的成员关系。这层主要实现承上启下的作用，承上将下层产生的信息生产成员关系图传递给上层以通知各个节点的工作状态；启下将上层对于隔离某一设备予以具体实施。  </li>
<li>Messaging Layer 集群信息层软件： heartbeat (v1, v2) 、heartbeat V3 (可以拆分为：heartbeat, pacemaker, cluster-glue) ,<br>corosync 从OpenAIS分离的项目、cman 、keepalived (一般用于两个节点的集群)、ultramokey</li>
</ul>
</li>
</ul>
<ul>
<li><p>CRM（Cluster Resource Manager）</p>
<ul>
<li>群资源管理器层，它主要是用来提供那些不具有高可用的服务提供高可用性的。它需要借助Messaging Layer来实现工作，因此工作在Messaging Layer上层。</li>
<li>资源管理器的主要工作是收集messaging Layer传递的节点信息，并负责信息的计算和比较，并做出相应的动作，如服务的启动、停止和资源转移、资源的定义和资源分配;在每一个节点上都包含一个CRM，且每个CRM都维护这一个CIB（Cluster Information Base，集群信息库），只有在主节点上的CIB是可以修改的，其他节点上的CIB都是从主节点那里复制而来的。</li>
<li>CRM会推选出一个用于计算和比较的节点，叫DC（Designated coordinator）指定协调节点，计算由PE（Policy Engine）策略引擎实现，计算出结果后的动作控制由TE（Transition Engine）事务引擎实现;在每个节点上都有一个LRM（local resource manager）本地资源管理器，是CRM的一个子功能，接收TE传递过来的事务，在节点上采取相应动作，如运行RA脚本等。</li>
<li>CRM集群资源管理器软件:Haresource (文本配置接口被heartbeat v1 v2包含) 、heartbeat v2包含可以使用crmsh或者heartbeat-gui来进行配置、pacemaker(heartbeat v3分离出来的项目，配置接口：CLI：crm、pcs和GUI：hawk(WEB-GUI)、LCMC、pacemaker-mgmt、pcs)、rgmanager(Cman包含，使用rgmanager(resource group manager)实现管理, 具有Failover Domain故障转移域这一特性，也可以使用RHCS（Redhat Cluster Suite）套件来进行管理：Conga的全生命周期接口，Conga（luci/ricci）先安装后，可用其安装高可用软件，再进行配置。)</li>
</ul>
</li>
<li><p>RA（Resource Rgent）</p>
<ul>
<li>资源代理层，简单的说就是能够集群资源进行管理的脚本，如启动start，停止stop、重启restart和查询状态信息status等操作的脚本。LRM本地资源管理器负责运行。</li>
<li>资源代理分为：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、Legacy heartbeat（heatbeat v1版本的资源管理）；</span><br><span class="line">2、LSB（Linux Standard Base），主要是/etc/init.d/*目录下的脚,start/stop/restart/status；</span><br><span class="line">3、OCF（Open Cluster Famework），比LSB更专业，更加通用,除了上面的四种操作，还包含monitor、validate-all等集群操作OCF 的规范在http://www.opencf.org/cgi-bin/viewcvs.cgi/specs/ra/resource-agent-api.txt?rev=HEAD。</span><br><span class="line">4、STONITH：实现节点隔离</span><br></pre></td></tr></table></figure>
<br></li>
</ul>
</li>
</ul>
<p><strong>4）高可用集群架共享存储</strong><br>高可用集群多节点都需要访问数据，如果各节点访问同一个数据文件都是在同一个存储空间内的，就是说数据共享的就一份，而这个存储空间就共享存储。如Web或Mysql高可用集群，他们的数据一般需要放在共享存储中，主节点能访问，从节点也能访问(如前面高可用文章中提到的rsync和DRBD来同步分别存储在主/从节点上的块数据)</p>
<p>共享存储的类型：</p>
<ul>
<li><p>DAS（Direct attached storage，直接附加存储）：存储设备直接连接到主机总线上的，距离有限，而且还要重新挂载，之间有数据传输有延时；常用的存储设备：RAID 阵列、SCSI 阵列。</p>
<ul>
<li>这是设备块级别驱动上实现的共享，持有锁是在节点主机本地上的，无法通知其他节点，所以如果多节点活动模型的集群同时写入数据，会发生严重的数据崩溃错误问题，主备双节点模型的集群在分裂的时候了会出现问题；</li>
</ul>
</li>
<li><p>NAS（network attached storage，网络附加存储）:文件级别交互的共享，各存储设备通过文件系统向集群各节点提供共享存储服务，是用C/S框架协议来实现通信的应用层服务。</p>
<ul>
<li>常用的文件系统：NFS、FTP、CIFS等，如使用NFS实现的共享存储，各节点是通过NFS协议来向共享存储请求文件的。</li>
</ul>
</li>
<li><p>SAN（storage area network、存储区域网络)</p>
<ul>
<li>块级别的将通信传输网络模拟成SCSI（Small Computer System Interface）总线来使用，节点主机（initiator）和SAN主机（target）都需要SCSI驱动，并借助网络隧道来传输SAN报文，所以接入到SAN主机的存储设备不一定需要是SCSI类型的。</li>
<li>常用的SAN：FC光网络（交换机的光接口超贵，代价太高）、IPSAN（iscsi、存取快，块级别，廉价）。</li>
</ul>
</li>
</ul>
<p><em>集群高可用常常使用的组合：</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># heartbeat v2+haresource(或crm) (说明：一般常用于CentOS 5.X)</span></span><br><span class="line"><span class="comment"># heartbeat v3+pacemaker (说明：一般常用于CentOS 6.X)</span></span><br><span class="line"><span class="comment"># corosync+pacemaker (说明：现在最常用的组合)</span></span><br><span class="line"><span class="comment"># cman + rgmanager (说明：红帽集群套件中的组件，还包括gfs2,clvm)</span></span><br><span class="line"><span class="comment"># keepalived+lvs (说明：常用于lvs的高可用)</span></span><br></pre></td></tr></table></figure></p>
<hr/>

<h4 id="0x02-Keepalived-介绍与组成"><a href="#0x02-Keepalived-介绍与组成" class="headerlink" title="0x02 Keepalived 介绍与组成"></a>0x02 Keepalived 介绍与组成</h4><p>Keepalived是Linux下一个轻量级别的高可用解决方案;</p>
<p>高可用(High Avalilability,HA)，其实两种不同的含义：</p>
<ul>
<li>广义来讲, 是指整个系统的高可用行</li>
<li>狭义的来, 讲就是之主机的冗余和接管</li>
</ul>
<p><em>Keepalived是什么？</em><br>答：Keepalived起初是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据TCP/IP参考模型的第三、第四层、第五层交换机制检测每个服务节点的状态，如果某个服务器节点出现异常，或者工作出现故障，Keepalived将检测到，并将出现的故障的服务器节点从集群系统中剔除，这些工作全部是自动完成的，不需要人工干涉，需要人工完成的只是修复出现故障的服务节点。并且通过虚拟路由器冗余协议 Virtual Router Redundancy Protocol 简称vrrp协议基础之上来实现的,它目的是解决静态路由出现的单点故障问题,通过VRRP可以实现网络不间断稳定运行;</p>
<p><em>Keepalived功能作用：</em></p>
<ul>
<li>一方面具有服务器状态检测和故障隔离功能</li>
<li>另一方面也有 HA cluster功能</li>
<li>Keepalived 安全认证有简单字符认证,预共享密钥MD5;</li>
</ul>
<p>术语解释：</p>
<ul>
<li>虚拟路由器：Virtual Router 由一个Master路由器和多个Backup路由器组成。通俗讲就是一个路由器集群。</li>
<li>虚拟路由器标识：VRID(0-255)，唯一标识虚拟路由器物理路由器,如果多个路由器有相同的VRID，那么这些路由器就组成了一个虚拟路由器。</li>
<li>master：主设备，虚拟路由器中真正承担报文转发的节点。</li>
<li>backup：备用设备,虚拟路由器中某一时刻除Master路由器的其他都有节点。</li>
<li>priority：优先级,VRRP根据每个节点的优先级确定节点在虚拟路由器中的地位。如果优先级相同则根据节点的IP地址大小进行比较。</li>
<li>VIP：Virtual IPV:虚拟路由器的IP，VIP是用于客户接入的IP地址。</li>
<li>MAC：Virutal MAC:虚拟路由器拥有的MAC地址(00-00-5e-00-01-VRID)</li>
<li>抢占方式和非抢占方式：<ul>
<li>抢占方式中只要优先级最高才会成为Master路由器</li>
<li>非抢占方式中只要Master路由器没有出现故障，则Baskup路由器的优先级再高也不会成为Master路由器。</li>
</ul>
</li>
</ul>
<p><em>它与HeartBeat相比较？</em><br>答：Keepalived主要是通过虚拟路由冗余(VRRP)来实现高可用功能，虽然它没有HeartBeat功能强大，但是Keepalived部署和使用非常的简单，所有配置只需要一个配置文件即可以完成，</p>
<p>安全认证：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">简单字符认证、HMAC机制，只对信息做认证</span><br><span class="line">MD5（leepalived不支持）</span><br></pre></td></tr></table></figure></p>
<p><strong>1) VRRP协议</strong><br>在现实的网络环境中主机之间的通信都是通过配置静态路由或者(默认网关)来完成的，而主机之间的路由器一旦发生故障，通信就会失效，因此这种通信模式当中，路由器就成了一个单点瓶颈，为了解决这个问题引入了VRRP协议。<br>它是一种主备模式的协议，通过VRRP可以在网络发生故障时透明的进行设备切换而不影响主机之间的数据通信;</p>
<p>其中涉及到两个概念：</p>
<ul>
<li>物理路由器</li>
<li>虚拟路由器</li>
</ul>
<p>VRRP虚拟路由冗余,可以将两台或者多台物理路由器设备虚拟成一个虚拟路由,并且每个虚拟路由器都有一个唯一的标识号称为VRID，一个VRID与一组IP地址构成一个虚拟路由器;这个虚拟路由器通过虚拟IP（一个或者多个)对外提供服务，而在虚拟路由器内部十多个物理路由器协同工作，同一时间只有一台物理路由器对外提供服务;</p>
<p>物理路由设备成为：主路由器（Master角色)，一般情况下Master是由选举算法产生，它拥有对外服务的虚拟IP，提供各种网络功能，如：ARP请求，ICMP 数据转发等;<br>而且其它的物理路由器不拥有对外的虚拟IP，也不提供对外网络功能，仅仅接收MASTER的VRRP状态通告信息，这些路由器被统称为“BACKUP的角色”，当主路由器失败时，处于BACKUP角色的备份路由器将重新进行选举，产生一个新的主路由器进入MASTER角色，继续提供对外服务，整个切换对用户来说是完全透明的。</p>
<p>在VRRP协议中所有的报文都是通过IP多播方式发送的，而在一个虚拟路由器中，只有处于Master角色的路由器会一直发送VRRP数据包，处于BACKUP角色的路由器只会接受Master角色发送过来的报文信息，用来监控Master运行状态，一般不会发生BACKUP抢占的情况，除非它的优先级更高，而当MASTER不可用时，BACKUP也就无法收到Master发过来的信息，于是就认定Master出现故障，接着多台BAKCUP就会进行选举，优先级最高的BACKUP将称为新的MASTER，这种选举角色切换非常之快，因而保证了服务的持续可用性。</p>
<p><br></p>
<p><strong>2) 工作原理</strong><br>Keepalived作为一个高性能集群软件，它还能实现对集群中服务器运行状态的监控以及故障隔离,工作方式有抢占式和非抢占;<br>Keepalived工作在TCP/IP 参考模型的 三层、四层、五层分别为：网络层，传输层和应用层，根据TCP、IP参数模型隔层所能实现的功能:</p>
<ul>
<li>网络层：运行4个重要协议,互联网络IP协议，互联网络可控制报文协议ICMP、地址转换协议ARP、反向地址转换协议RARP;</li>
<li>传输层：提供两个主要的协议,传输控制协议TCP和用户数据协议UDP，传输控制协议TCP可以提供可靠的数据输出服务、IP地址和端口，代表TCP的一个连接端，要获得TCP服务，需要在发送机的一个端口和接收机的一个端口上建立连接，而Keepalived在传输层里利用了TCP协议的端口连接和扫描技术来判断集群节点的端口是否正常，比如对于常见的WEB服务器80端口。<ul>
<li>Keepalived一旦在传输层探测到这些端口号没有数据响应和数据返回，就认为这些端口发生异常，然后强制将这些端口所对应的节点从服务器集群中剔除掉。</li>
</ul>
</li>
<li>在应用层：可以运行FTP，TELNET，SMTP，DNS等各种不同类型的高层协议，Keepalived的运行方式也更加全面化和复杂化，用户可以通过自定义Keepalived工作方式，例如：可以通过编写程序或者脚本来运行Keepalived，而Keepalived将根据用户的设定参数检测各种程序或者服务是否允许正常，如果Keepalived的检测结果和用户设定的不一致时，Keepalived将把对应的服务器从服务器集群中剔除;</li>
</ul>
<p>工作模式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">主/备：单虚拟路径器；</span><br><span class="line">主/主：主/备（虚拟路径器），备/主（虚拟路径器）</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><strong>3) 结构体系</strong><br>Keepalived起初是为LVS设计的高可用ipvs服务，由于Keeplalived可以实现对集群节点的状态检测，而IPVS可以实现负载均衡功能，因此,Keepalived借助于第三方模块IPVS就可以很方便地搭建一套负载均衡系统，在这里有个误区，=由于Keepalived可以和IPVS一起很好的工作，很多学员都以为Keepalived就是一个负载均衡软件这种理解是错误，</p>
<p>从下面的图可以看出用户空间层，是建立在内核空间层之上：</p>
<ol>
<li>用户空间层主要有4个部分：</li>
</ol>
<ul>
<li>Scheduler I/O Multiplexer 是一个I/O复用分发调度器，它负载安排Keepalived所有内部的任务请求，</li>
<li>Memory Mngt 是一个内存管理机制，这个框架提供了访问内存的一些通用方法       </li>
<li>Control Plane  是keepalived的控制版面，可以实现对配置文件编译和解析</li>
<li>Core componets  这部分主要保护呢了5个部分<ul>
<li>WatchDog:负载监控checkers和VRRP进程的状况</li>
<li>VRRP Stack:负载负载均衡器之间的失败切换FailOver,如果只用一个负载均稀器,则VRRP不是必须的。</li>
<li>Checkers:负责真实服务器的健康检查healthchecking,是keepalived最主要的功能。换言之,可以没有</li>
<li>VRRP Stack,但健康检查healthchecking是一定要有的。</li>
<li>IPVS wrapper:用户发送设定的规则到内核ipvs代码</li>
<li>Netlink Reflector:用来设定vrrp的vip地址等。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>内核空间,主要有两个部分:</li>
</ol>
<ul>
<li>IPVS 实现复制均衡 </li>
<li>NetLINK 模块主要用于实现一些高级路由框架和一些相关参数的网络功能，完成用户空间层Netlink Reflector模块发来的各种网络请求。</li>
</ul>
<figure class="image-box">
                <a rel=Keepalived高可用服务解决方案 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190610154540.png" target="_blank" title="WeiyiGeek.结构体系" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190610154540.png" alt="WeiyiGeek.结构体系" title="" class=""></a>
                <p>WeiyiGeek.结构体系</p>
            </figure>
<p>keepalived启动后会有三个进程<br>父进程：内存管理，子进程管理等等<br>子进程：VRRP子进程<br>子进程：healthchecker子进程<br>有图可知，两个子进程都被系统WatchDog看管，两个子进程各自复杂自己的事，healthchecker子进程复杂检查各自服务器的健康程度，例如HTTP，LVS等等，如果healthchecker子进程检查到MASTER上服务不可用了，就会通知本机上的兄弟VRRP子进程，让他删除通告，并且去掉虚拟IP，转换为BACKUP状态</p>
<hr/>

<h4 id="0x03-Keepalived-环境与实例"><a href="#0x03-Keepalived-环境与实例" class="headerlink" title="0x03 Keepalived 环境与实例"></a>0x03 Keepalived 环境与实例</h4><p>项目需求：利用Keepalived实现httpd的高可用（主/备模式）</p>
<p>KeppAlive项目高可用流程：</p>
<ul>
<li>项目需求分析,IP及VIP资源分配</li>
<li>开启keepAlived服务与httpd服务;</li>
<li>vrrp协议单播检测完成地址流动,vip地址所在的节点生成ipvs规则(在配置文件中预先定义,这里是默认)并且为ipvs集群的各RS做健康状态检测;</li>
<li>启动keepalived后VIP漂移到主节点上,备节点热备(随时准备切换),这里默认是可以抢占即(Master恢复后VIP将漂移回来)</li>
<li>基于脚本调用接口通过执行脚本完成脚本中定义的功能,通过VIP访问httpd服务;</li>
</ul>
<p>模拟环境：CentOS Linux release 7.6.1810 (Core) / Keepalived v1.3.5 (03/19,2017)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#环境设置：</span></span><br><span class="line"><span class="comment">#关闭防火墙与selinux设置为disabled</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl stop iptables</span><br><span class="line"></span><br><span class="line"><span class="comment">#同步两台机器时间</span></span><br><span class="line">yum install -y ntpdate &amp;&amp; ntpdate us.pool.ntp.org  <span class="comment">#注：没有安装ntpdate的可以yum一下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置hostsIP地址别名</span></span><br><span class="line">10.10.107.222 master</span><br><span class="line">10.10.107.221 slave</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>IP</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.10.107.222</td>
<td>Master / httpd</td>
</tr>
<tr>
<td>10.10.107.221</td>
<td>Slave / httpd</td>
</tr>
<tr>
<td>10.10.107.236</td>
<td>VIP 漂移</td>
</tr>
</tbody>
</table>
<p><strong>实例流程：</strong><br>Step1.两台http服务器的安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#两台机均安装httpd</span></span><br><span class="line">$ sudo yum install -y httpd</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加首页 </span></span><br><span class="line"><span class="comment">#http服务器1设置</span></span><br><span class="line"><span class="built_in">echo</span> “10.10.107.222” &gt;/var/www/html/index.html</span><br><span class="line"><span class="comment">#http服务器2设置</span></span><br><span class="line"><span class="built_in">echo</span> “10.10.107.221” &gt;/var/www/html/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动并设置开机启动httpd</span></span><br><span class="line">$ sudo systemctl start httpd</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> httpd</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Keepalived高可用服务解决方案 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190612171134.png" target="_blank" title="WeiyiGeek.httpd安装成功验证" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190612171134.png" alt="WeiyiGeek.httpd安装成功验证" title="" class=""></a>
                <p>WeiyiGeek.httpd安装成功验证</p>
            </figure></p>
<p>Step2.两台keepalived主机的设置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#两台机均安装keepalived</span></span><br><span class="line"><span class="comment">#安装依赖文件与keepalive</span></span><br><span class="line">$ sudo yum install -y openssl openssl-devel keepalived</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Keepalived高可用服务解决方案 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190612171416.png" target="_blank" title="WeiyiGeek.keepalived" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190612171416.png" alt="WeiyiGeek.keepalived" title="" class=""></a>
                <p>WeiyiGeek.keepalived</p>
            </figure></p>
<p>Step3.keepalived配置文件修改：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#主节点（我将我修改的罗列出来）</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id master       <span class="comment">#路由id,不能重复（采用机器名即可）</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER   <span class="comment">## 初始化设置为MASTER节点</span></span><br><span class="line">    interface ens192  <span class="comment">#网卡不对的要进行修改</span></span><br><span class="line">    virtual_router_id 51  <span class="comment">#  # 同一个VRRP实例中每个节点的虚拟路由ID必须相同</span></span><br><span class="line">    priority 100    <span class="comment"># MASTER节点的优先级必须高于BACKUP节点</span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.10.107.236/24 dev ens192 <span class="comment"># 主备节点的VIP一定要相同</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#备 节点</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id slave      <span class="comment">#路由id,不能重复</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP   <span class="comment">## 初始化设置为BACKUP 节点（重要的点）</span></span><br><span class="line">    interface ens192  <span class="comment">#网卡不对的要进行修改</span></span><br><span class="line">    virtual_router_id 51  <span class="comment">#  # 同一个VRRP实例中每个节点的虚拟路由ID必须相同</span></span><br><span class="line">    priority 90    <span class="comment"># BACKUP 节点的优先级必须低于于MASTER节点 （重要的点）</span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.10.107.236/24 dev ens192 <span class="comment"># 主备节点的VIP一定要相同</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#主备都相同 虚拟IP服务</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   <span class="comment">#vrrp_strict 为了能更好的测试建议把该项注释(为什么要注释看末尾)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virtual_server 10.10.107.236 80  &#123;</span><br><span class="line">    delay_loop 6  <span class="comment">#设定检查间隔</span></span><br><span class="line">    lb_algo rr  <span class="comment">#   #指定LVS算法</span></span><br><span class="line">    lb_kind NAT  <span class="comment">#   #指定LVS模式</span></span><br><span class="line">    nat_mask 255.255.255.0</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    <span class="comment">#后端监控的主机</span></span><br><span class="line">    real_server 10.10.107.222 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 10.10.107.221 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>解释说明：/etc/keepalived/keepalived.conf为keepalived的主配置文件。</p>
<ul>
<li>以上配置state表示主节点为10.10.107.222，副节点为10.10.107.221。虚拟为IP10.10.107.236。</li>
<li>后端的真实服务器为10.10.107.222和10.10.107.221，当通过10.10.107.236访问web服务器时，自动转到后端真实服务器，后端节点的权重相同，类似轮询的模式。</li>
</ul>
<p>Step4.keepalived的启动与测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start httpd keepalived   <span class="comment">#启动服务</span></span><br><span class="line">systemctl status keepalived httpd  <span class="comment">#查看运行状态</span></span><br><span class="line"></span><br><span class="line">$ ip addr show ens192  <span class="comment">#查看VIP漂移状态</span></span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Keepalived高可用服务解决方案 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190613091204.png" target="_blank" title="WeiyiGeek.VIP" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190613091204.png" alt="WeiyiGeek.VIP" title="" class=""></a>
                <p>WeiyiGeek.VIP</p>
            </figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在我们windows机器进行测试漂移</span></span><br><span class="line">http://10.10.107.236/</span><br><span class="line">10.10.107.222 Master</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭主Master的keepalive服务(关闭计算机进行测试)</span></span><br><span class="line">[root@master ~]<span class="comment"># service stop keepalived</span></span><br><span class="line">[root@slave sec]<span class="comment"># ip addr show ens192</span></span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:b3:6d:fd brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.10.107.221/24 brd 10.10.107.255 scope global noprefixroute ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.10.107.236/24 scope global secondary ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::25f6:1911:3d05:2922/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment">#在我们windows机器进行测试漂移(此时漂移到从机上面）</span></span><br><span class="line">http://10.10.107.236/</span><br><span class="line">10.10.107.221 Slave</span><br><span class="line"></span><br><span class="line"><span class="comment">#当主Master机器恢复正常的时候,便会接管回资源</span></span><br><span class="line">[root@master ~]<span class="comment"># service keepalived start</span></span><br><span class="line">http://10.10.107.236/</span><br><span class="line">10.10.107.222 Master</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Keepalived高可用服务解决方案 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190613101322.png" target="_blank" title="WeiyiGeek.漂移案例" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190613101322.png" alt="WeiyiGeek.漂移案例" title="" class=""></a>
                <p>WeiyiGeek.漂移案例</p>
            </figure>
<hr>

<h4 id="0x04-命令详解"><a href="#0x04-命令详解" class="headerlink" title="0x04 命令详解"></a>0x04 命令详解</h4><p>参考：<a href="https://www.keepalived.org/doc/programs_synopsis.html" target="_blank" rel="noopener">https://www.keepalived.org/doc/programs_synopsis.html</a><br>keepalived命令:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-f，-use-file = FILE</span><br><span class="line">    使用指定的配置文件。默认配置文件是“/etc/keepalived/keepalived.conf”。</span><br><span class="line">-P，-vrrp</span><br><span class="line">    只运行VRRP子系统。这对于不使用IPVS负载平衡器的配置非常有用。</span><br><span class="line">-C， - 检查</span><br><span class="line">    只运行健康检查子系统。这对于使用IPVS负载均衡器和单个导向器而不进行故障切换的配置非常有用。</span><br><span class="line">-l，-<span class="built_in">log</span>-console</span><br><span class="line">    将消息记录到本地控制台。默认行为是将消息记录到系统日志。</span><br><span class="line">-D，-<span class="built_in">log</span>-detail</span><br><span class="line">    详细的日志消息。</span><br><span class="line">-S，-<span class="built_in">log</span>-facility = [0-7]</span><br><span class="line">    将syslog工具设置为LOG_LOCAL [0-7]。默认的系统日志工具是LOG_DAEMON。</span><br><span class="line">-V，-dont-release-vrrp</span><br><span class="line">    不要在守护进程中删除VRRP VIP和VROUTE。默认行为是在keepalived退出时删除所有VIP和VROUTE</span><br><span class="line">-I，-dont-release-ipvs</span><br><span class="line">    不要在守护进程停止时移除IPVS拓扑。它在keepalived退出时从IPVS虚拟服务器表中删除所有条目的默认行为。</span><br><span class="line">-R，不要重生</span><br><span class="line">    不要重新生成子进程。默认行为是在任何进程退出时重新启动VRRP和检查器进程。</span><br><span class="line">-n，-dont-fork</span><br><span class="line">    不要分解守护进程。该选项将导致keepalived在前台运行。</span><br><span class="line">-d，-dump-conf</span><br><span class="line">    转储配置数据。</span><br><span class="line">-p，-pid = FILE</span><br><span class="line">    父指定的进程使用指定的pidfile。 keepalived的默认pid文件是“/var/run/keepalived.pid”。</span><br><span class="line">-r，-vrrp_pid = FILE</span><br><span class="line">    为VRRP子进程使用指定的pidfile。 VRRP子进程的默认pid文件是“/var/run/keepalived_vrrp.pid”。</span><br><span class="line">-c，-checkers_pid = FILE</span><br><span class="line">    针对检查者子进程使用指定的pidfile。检查器子进程的默认pid文件是“/var/run/keepalived_checkers.pid”。</span><br><span class="line">-x，-snmp</span><br><span class="line">    启用S​​NMP子系统。</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>genhash实用程序：二进制文件用于生成摘要字符串。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-use-ssl，-S</span><br><span class="line">    使用SSL连接到服务器。</span><br><span class="line">-server &lt;host&gt;，-s</span><br><span class="line">    指定要连接的IP地址。</span><br><span class="line">-port &lt;port&gt;，-p</span><br><span class="line">    指定要连接的端口。</span><br><span class="line">-url &lt;url&gt;，-u</span><br><span class="line">    指定要生成散列的文件的路径。</span><br><span class="line">-use-virtualhost &lt;host&gt;，-V</span><br><span class="line">    指定要与HTTP标头一起发送的虚拟主机。</span><br><span class="line">-<span class="built_in">hash</span> &lt;alg&gt;，-H  <span class="comment">#即生成的是SHA1密文，还是MD5密文</span></span><br><span class="line">    指定散列算法以制作目标页面的摘要。请查看帮助屏幕中的可用列表，并标记默认标记。</span><br><span class="line">-verbose，-v</span><br><span class="line">    请输出详细信息。</span><br><span class="line">-<span class="built_in">help</span>，-h</span><br><span class="line">    显示程序帮助屏幕并退出。</span><br><span class="line">-release, -r</span><br><span class="line">    显示版本号（版本）并退出。</span><br></pre></td></tr></table></figure></p>
<hr>

<h4 id="0x05-配置文件"><a href="#0x05-配置文件" class="headerlink" title="0x05 配置文件"></a>0x05 配置文件</h4><p>配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主配置文件：/etc/keepalived/keepalived.conf</span><br><span class="line">主程序文件：/usr/sbin/keepalived</span><br><span class="line">提供校验码：/usr/bin/genhash</span><br><span class="line">Unit File：/usr/lib/systemd/system/keepalived.service </span><br><span class="line">Unit File的环境配置文件：/etc/sysconfig/keepalived</span><br><span class="line">keepalived的日志默认在：tailf /var/<span class="built_in">log</span>/messages</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><em>配置文件的结构层次：</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#keepalived的配置文件分为三个部分，分别是：</span></span><br><span class="line">Global Configuration：全局配置部分</span><br><span class="line">  Global definition</span><br><span class="line">  static routes/address</span><br><span class="line"></span><br><span class="line">VRRPD Configuration：VRRPD配置部分</span><br><span class="line">    1. vrrp_script ： 添加一个周期性执行的脚本。脚本的退出状态码会被调用它的所有的VRRP Instance记录</span><br><span class="line">    2. vrrp_sync_group ： VRRP synchronization group:VRRP同步组</span><br><span class="line">    3. garp_group : 当检测到组里面任意服务发生变化时候，将进行主从切换</span><br><span class="line">    4. vrrp_instance ： VRRP instance:VRRP实例配置</span><br><span class="line"></span><br><span class="line">LVS Configuration：LVS配置部分</span><br><span class="line">  Virtual server: ipvs的RS和VS</span><br></pre></td></tr></table></figure></p>
<p><em>实际配置文件说明：</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局定义模块</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     sysadmin@firewall.net   <span class="comment">#邮件报警收件人</span></span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from sender@firewall.net  <span class="comment">#右键报警发信人</span></span><br><span class="line">   smtp_server 192.168.200.1  <span class="comment">#连接smtp服务于超时时间</span></span><br><span class="line">   <span class="comment">#smtp_helo_name &lt;HOST_NAME&gt;：指定在HELO消息中所使用的名称。默认为本地主机名。</span></span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line"></span><br><span class="line">   router_id LVS_DEVEL  <span class="comment">#此处注意router_id为负载均衡标识，在局域网内应该是唯一的建议使用机器名（不能重复）</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">#### 组播方式-add ####</span></span><br><span class="line">   vrrp_mcast_group4 224.1.101.33 <span class="comment">#设置组播地址，其他主机也一样</span></span><br><span class="line">   vrrp_mcast_group6 ff02::12     <span class="comment">#指定发送VRRP组播消息所使用的IPV6组播地址。默认是ff02::12</span></span><br><span class="line">   <span class="comment">#default_interface eth0：设置静态地址默认绑定的端口。默认是eth0。</span></span><br><span class="line">   <span class="comment">##### end</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">##### LVS -add ###</span></span><br><span class="line">   lvs_sync_daemon &lt;INTERFACE&gt; &lt;VRRP_INSTANCE&gt; [id &lt;SYNC_ID&gt;] [maxlen &lt;LEN&gt;] [port &lt;PORT&gt;] [ttl &lt;TTL&gt;] [group &lt;IP ADDR&gt;]</span><br><span class="line">    设置LVS同步服务的相关内容。可以同步LVS的状态信息。 </span><br><span class="line">    INTERFACE：指定同步服务绑定的接口。</span><br><span class="line">    VRRP_INSTANCE：指定同步服务绑定的VRRP实例。 </span><br><span class="line">    id &lt;SYNC_ID&gt;：指定同步服务所使用的SYNCID，只有相同的SYNCID才会同步。范围是0-255. </span><br><span class="line">    maxlen：指定数据包的最大长度。范围是1-65507 </span><br><span class="line">    port：指定同步所使用的UDP端口。 </span><br><span class="line">    group：指定组播IP地址。</span><br><span class="line"></span><br><span class="line">   lvs_flush：在keepalived启动时，刷新所有已经存在的LVS配置。</span><br><span class="line">   <span class="comment">##### end</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">###start</span></span><br><span class="line">   vrrp_version 2|3：  <span class="comment">#设置默认的VRRP版本。默认是2.</span></span><br><span class="line">   vrrp_check_unicast_src：在单播模式中，开启对VRRP数据包的源地址做检查，源地址必须是单播邻居之一。</span><br><span class="line">   <span class="comment">###end</span></span><br><span class="line"></span><br><span class="line">   vrrp_skip_check_adv_addr  <span class="comment">#默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，</span></span><br><span class="line">   <span class="comment">#设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)。</span></span><br><span class="line"></span><br><span class="line">   vrrp_strict   <span class="comment">#vrrp通信严格模式（不能ping通） 严格遵守VRRP协议。下</span></span><br><span class="line">   <span class="comment">#列情况将会阻止启动Keepalived：1. 没有VIP地址。2. 单播邻居。3. 在VRRP版本2中有IPv6地址。</span></span><br><span class="line"></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">#静态地址和路由配置范例 （在复杂的环境下可能需要配置，一般不会用这个来配置）</span></span><br><span class="line">    <span class="comment"># static_ipaddress&#123;</span></span><br><span class="line">    <span class="comment">#   192.168.1.1/24 brd + dev eth0 scope global #相当于: ip addr add 192.168.1.1/24 brd + dev eth0 scope global</span></span><br><span class="line">    <span class="comment">#   192.168.1.2/24 brd + dev eth1 scope global #就是给eth1配置IP地址</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">    <span class="comment"># static_routes&#123;</span></span><br><span class="line">    <span class="comment">#   src $SRC_IP to $DST_IP dev $SRC_DEVICE #路由和ip同理，一般这个区域不需要配置</span></span><br><span class="line">    <span class="comment">#   src $SRC_IP to $DST_IP via $GW dev $SRC_DEVICE</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#杂项</span></span><br><span class="line">    vrrp_iptables  <span class="comment">#不添加任何iptables规则。默认是添加iptables规则的。</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    vrrp_priority &lt;-20 -- 19&gt; <span class="comment">#：设置VRRP进程的优先级。</span></span><br><span class="line">    checker_priority &lt;-20 -- 19&gt;  <span class="comment">#：设置checker进程的优先级。</span></span><br><span class="line">    vrrp_no_swap  <span class="comment">#：vrrp进程不能够被交换。</span></span><br><span class="line">    checker_no_swap <span class="comment">#：checker进程不能够被交换。</span></span><br><span class="line">    </span><br><span class="line">    script_user &lt;username&gt; [groupname]  <span class="comment">#设置运行脚本默认用户和组，默认用户为keepalived_script(需要该用户存在)，否则为root用户。默认groupname同username。 </span></span><br><span class="line">    enable_script_security  <span class="comment">#如果脚本路径的任一部分对于非root用户来说，都具有可写权限，则不会以root身份运行脚本。 </span></span><br><span class="line">    nopreempt <span class="comment">#默认是抢占模式 要是用非抢占式的就加上nopreempt</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#VRRP同步组(synchroization group)配置范例</span></span><br><span class="line">vrrp_sync_group VG_1 &#123;</span><br><span class="line">    group &#123;</span><br><span class="line">    http <span class="comment">#实例名</span></span><br><span class="line">    mysql <span class="comment">#实例名</span></span><br><span class="line">    &#125;</span><br><span class="line">    notify_master /path/to/to_master.sh <span class="comment">#表示当切换到master状态时，要执行的脚本</span></span><br><span class="line">    notify_backup /path_to/to_backup.sh <span class="comment">#表示当切换到backup状态时，要执行的脚本</span></span><br><span class="line">    notify_fault <span class="string">"/path/fault.sh VG_1"</span></span><br><span class="line">    notify /path/to/notify.sh</span><br><span class="line">    smtp_alert   <span class="comment">#表示切换时给global defs中定义的邮件地址发送右键通知 (当状态发生改变时，发送邮件)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># VRRP脚本定义块 （主主、主备配置）</span></span><br><span class="line"><span class="comment">#首先在vrrp_script区域定义脚本名字和脚本执行的间隔和脚本执行的优先级变更</span></span><br><span class="line"><span class="comment">#然后在实例(vrrp_instance)里面引用，有点类似脚本里面的函数引用一样：先定义，后引用函数名</span></span><br><span class="line">vrrp_script check_running &#123;</span><br><span class="line">    script <span class="string">"/usr/local/bin/check_running"</span>  <span class="comment">#指定要执行的脚本的路径。</span></span><br><span class="line">    interval 10     <span class="comment">#脚本执行间隔</span></span><br><span class="line">    weight 10      <span class="comment">#脚本结果导致的优先级变更：10表示优先级+10；-10则表示优先级-10 #调整优先级。默认为2.</span></span><br><span class="line">    rise &lt;INTEGER&gt;  <span class="comment">#：执行成功多少次才认为是成功。</span></span><br><span class="line">    fall &lt;INTEGER&gt; <span class="comment">#：执行失败多少次才认为失败。</span></span><br><span class="line">    user &lt;USERNAME&gt; [GROUPNAME] <span class="comment">#：运行脚本的用户和组。</span></span><br><span class="line">    init_fail <span class="comment">#：假设脚本初始状态是失败状态。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#VRRP实例定义块 （主主配置） 定义vrrp实例名</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER 　<span class="comment">#状态只有MASTER和BACKUP两种，并且要大写，MASTER为工作状态，BACKUP是备用状态。</span></span><br><span class="line">    interface ens192  <span class="comment">#指定网卡接口</span></span><br><span class="line">    use_vmac [&lt;VMAC_INTERFACE&gt;] <span class="comment">#在指定的接口产生一个子接口，如vrrp.51，该接口的MAC地址为组播地址，通过该接口向外发送和接收VRRP包。 </span></span><br><span class="line">    vmac_xmit_base <span class="comment">#通过基本接口向外发送和接收VRRP数据包，而不是通过VMAC接口。 </span></span><br><span class="line">    native_ipv6  <span class="comment">#强制VRRP实例使用IPV6.(当同时配置了IPV4和IPV6的时候)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#dont_track_primary  忽略VRRP的interface错误</span></span><br><span class="line">    <span class="comment"># track_interface &#123;</span></span><br><span class="line">    <span class="comment">#     eth0</span></span><br><span class="line">    <span class="comment">#     eth1</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#踪接口，设置额外的监控，里面任意一块网卡出现问题，都会进入故障(FAULT)状态，例如，用nginx做均衡器的时候，内网必须正常工作，如果内网出问题了，这个均衡器也就无法运作了，所以必须对内外网同时做健康检查</span></span><br><span class="line">    <span class="comment">#mcast_src_ip &lt;IPADDR&gt;  #设置多播地址224.0.0.17(这个非常重要，一定要选择稳定的网卡端口来发送，这里相当于heartbeat的心跳端口)，</span></span><br><span class="line">    <span class="comment">#指定发送组播数据包的源IP地址。默认是绑定VRRP实例的接口的主IP地址。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#unicast_src_ip &lt;IPADDR&gt;：指定发送单薄数据包的源IP地址。默认是绑定VRRP实例的接口的主IP地址。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#garp_master_delay 10 #在切换到master状态后，延迟进行免费的ARP(gratuitous ARP)请求</span></span><br><span class="line">    lvs_sync_daemon_inteface eth1  <span class="comment">#默认没有相当于心跳线接口，DR模式用的和上面的接口一样，也可以用机器上的其他网卡eth1，用来防止脑裂。</span></span><br><span class="line">    virtual_router_id 51  <span class="comment"># #同一组的vrrp成员,该id需要一致</span></span><br><span class="line">    priority 100     <span class="comment">#优先级,范围(0-255) 且 主 &gt; 备</span></span><br><span class="line">    advert_int 1     <span class="comment">#发送hello的时间间隔（检查间隔，）</span></span><br><span class="line">    <span class="comment">#通过密码身份验证</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS     <span class="comment">#PASS简单密码认证(推荐),AH:IPSEC认证(不推荐)。</span></span><br><span class="line">        auth_pass 11111111  <span class="comment">#密码为8位,不能用默认的密码</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="comment">#定义虚拟IP(VIP),但ip默认32位子网掩码</span></span><br><span class="line">        <span class="comment">#&lt;IPADDR&gt;/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPT&gt; label &lt;LABEL&gt;</span></span><br><span class="line">        10.10.107.236/24 dev ens192 label eth192</span><br><span class="line">        10.10.107.237</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_routes &#123;</span><br><span class="line">        <span class="comment"># src &lt;IPADDR&gt; [to] &lt;IPADDR&gt;/&lt;MASK&gt; via|gw &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; tab</span></span><br><span class="line">        src 192.168.100.1 to 192.168.109.0/24 via 192.168.200.254 dev eth1</span><br><span class="line">        192.168.110.0/24 via 192.168.200.254 dev eth1</span><br><span class="line">        192.168.111.0/24 dev eth2</span><br><span class="line">        192.168.112.0/24 via 192.168.100.254</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#不抢占(只针对BACKUP机器生效)</span></span><br><span class="line">    nopreempt  <span class="comment">#设置为不抢占。默认是抢占的，当高优先级的机器恢复后，会抢占低优先级的机器成为MASTER，</span></span><br><span class="line">    <span class="comment">#而不抢占，则允许低优先级的机器继续成为MASTER，即使高优先级的机器已经上线。</span></span><br><span class="line"></span><br><span class="line">    preemtp_delay 300  <span class="comment">#抢占延迟</span></span><br><span class="line">    debug  <span class="comment">#debug级别</span></span><br><span class="line">    notify master  <span class="comment">#和sync group这里设置的含义一样，可以单独设置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#调用vrrp_script中的脚本执行</span></span><br><span class="line">    track_script &#123;</span><br><span class="line">        &lt;SCRIPT_NAME&gt; weight &lt;-254-254&gt;</span><br><span class="line">        check_running weight 20</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2&#123; <span class="comment">#定义一个虚拟路由器，第二个</span></span><br><span class="line">    state BACKUP  <span class="comment">#当前状态，从的</span></span><br><span class="line">    interface ens193  <span class="comment">#当前的vrp应用，绑定到那个网卡设备上</span></span><br><span class="line">    virtual_router_id 34  <span class="comment">#这个虚拟ip，与其他主机要保持一至</span></span><br><span class="line">    priority 96 <span class="comment">#优先级，低于master主机</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS  <span class="comment">#密码认证</span></span><br><span class="line">        auth_pass a6b7c8d9   <span class="comment">#密码为8位,不能用默认的密码，这里修改一下</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;<span class="comment">#虚拟ip地址</span></span><br><span class="line">        172.16.15.99/16 dev eth0 </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LVS 配置：</span></span><br><span class="line"><span class="comment">#这里LVS配置并不是指真的安装LVS然后用ipvsadm来配置他，而是用keepalived的配置文件来代替ipvsadm来配置LVS</span></span><br><span class="line"><span class="comment"># virtual server可以以下面三种的任意一种来配置</span></span><br><span class="line">    1. virtual server IP port</span><br><span class="line">    2. virtual server fwmark int</span><br><span class="line">    3. virtual server group string</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例1.</span></span><br><span class="line">virtual_server 10.10.107.236 80 &#123;  <span class="comment">#设置一个virtual server: VIP:Vport</span></span><br><span class="line">    delay_loop 6   <span class="comment">## service polling的delay时间，即服务轮询的时间间隔</span></span><br><span class="line">    lb_algo rr|wrr|lc|wlc|lblc|sh|dh     <span class="comment">#LVS调度算法</span></span><br><span class="line">    lb_kind NAT|DR|TUN   <span class="comment">#集群模式       </span></span><br><span class="line">    persistence_timeout 50 <span class="comment"># #会话保持时间（秒为单位），即以用户在50秒内被分配到同一个后端realserver</span></span><br><span class="line">    <span class="comment">#persistence_granularity &lt;NETMASK&gt;       #LVS会话保持粒度，ipvsadm中的-M参数，默认是0xffffffff，即每个客户端都做会话保持</span></span><br><span class="line">    protocol TCP|UDP|SCTP  <span class="comment">#健康检查用的是TCP还是UDP，4层协议。</span></span><br><span class="line">    <span class="comment"># virtualhost &lt;string&gt;         #HTTP_GET做健康检查时，检查的web服务器的虚拟主机（即host：头）</span></span><br><span class="line">    <span class="comment"># sorry_server &lt;IPADDR&gt; &lt;PORT&gt;                 #备用机，就是当所有后端realserver节点都不可用时，就用这里设置的，也就是临时把所有的请求都发送到这里啦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#后端真实节点主机的权重等设置，主要后端有几台这里就要设置几个</span></span><br><span class="line">    real_server 10.10.107.221 80 &#123;</span><br><span class="line">        weight 1    <span class="comment">#默认为2</span></span><br><span class="line">        inhibit_on_failure                    <span class="comment">#表示在节点失败后，把他权重设置成0，而不是冲IPVS中删除</span></span><br><span class="line">        notify_up &lt;STRING&gt; | &lt;QUOTED-STRING&gt;  <span class="comment">#检查服务器正常(UP)后，要执行的脚本</span></span><br><span class="line">        notify_down &lt;STRING&gt; | &lt;QUOTED-STRING&gt; <span class="comment">#检查服务器失败(down)后，要执行的脚本</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#下面是常用的健康检查方式，健康检查方式一共有【HTTP_GET|SSL_GET】|TCP_CHECK|SMTP_CHECK|MISC_CHECK这些</span></span><br><span class="line">        HTTP_GET|SSL_GET &#123;  <span class="comment">#  #健康检查方式</span></span><br><span class="line">            url &#123; <span class="comment"># #要坚持的URL，可以有多个</span></span><br><span class="line">                path /testurl/test.jsp</span><br><span class="line">                digest 640205b7b0fc66c1ea91c463fac6334d  <span class="comment"># 摘要。计算方式 genhash -s 10.10.107.221 -p 80 -u /index.html</span></span><br><span class="line">                <span class="comment"># MD5SUM = 09174a47a3944b5604699f5cb48e4e3e</span></span><br><span class="line">                status_code 200                                            <span class="comment">#返回状态码</span></span><br><span class="line">            &#125;</span><br><span class="line">            connect_ip &lt;IP ADDRESS&gt;  <span class="comment">#：连接的IP地址。默认是real server的ip地址。</span></span><br><span class="line">            connect_port &lt;PORT&gt;   <span class="comment">#：连接的端口。默认是real server的端口。</span></span><br><span class="line">            bindto &lt;IP ADDRESS&gt;  <span class="comment">#：发起连接的接口的地址。</span></span><br><span class="line">            bind_port &lt;PORT&gt;  <span class="comment">#：发起连接的源端口。</span></span><br><span class="line">            connect_timeout   3            <span class="comment">#连接超时时间</span></span><br><span class="line">            nb_get_retry 3                  <span class="comment">#重连次数</span></span><br><span class="line">            delay_before_retry 2           <span class="comment">#重连间隔</span></span><br><span class="line">            fwmark &lt;INTEGER&gt; <span class="comment">#使用fwmark对所有出去的检查数据包进行标记。</span></span><br><span class="line">            warmup &lt;INT&gt;  <span class="comment">#指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#检测mysql端口是否可以连接</span></span><br><span class="line">    real_server 10.10.107.33 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            <span class="comment"># connect_port 3306</span></span><br><span class="line">            <span class="comment"># bindto 10.10.107.33  #本地服务地址（即连接到数据库机器）</span></span><br><span class="line">            connect_timeout 3    <span class="comment">#连接超时</span></span><br><span class="line">            nb_get_retry 3       <span class="comment">#重试次数</span></span><br><span class="line">            delay_before_retry 3 <span class="comment">#重试间隔时间</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTP方式，这个可以用来给邮件服务器做集群</span></span><br><span class="line">    SMTP_CHECK</span><br><span class="line">    host &#123;</span><br><span class="line">        connect_ip &lt;IP ADDRESS&gt;</span><br><span class="line">        connect_port &lt;PORT&gt;                                     <span class="comment">#默认检查25端口</span></span><br><span class="line">        14 KEEPALIVED</span><br><span class="line">        bindto &lt;IP ADDRESS&gt;</span><br><span class="line">    &#125;</span><br><span class="line">        connect_timeout &lt;INTEGER&gt;</span><br><span class="line">        retry &lt;INTEGER&gt;</span><br><span class="line">        delay_before_retry &lt;INTEGER&gt;</span><br><span class="line">        <span class="comment"># "smtp HELO"?|·-?ê§?à"</span></span><br><span class="line">        helo_name &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br><span class="line">    &#125; <span class="comment">#SMTP_CHECK</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#MISC方式，这个可以用来检查很多服务器只需要自己会些脚本即可</span></span><br><span class="line">    MISC_CHECK</span><br><span class="line">    &#123;</span><br><span class="line">        misc_path &lt;STRING&gt;|&lt;QUOTED-STRING&gt; <span class="comment">#外部程序或脚本</span></span><br><span class="line">        misc_timeout &lt;INT&gt;       <span class="comment">#脚本或程序执行超时时间</span></span><br><span class="line">        misc_dynamic             <span class="comment">#这个就很好用了，可以非常精确的来调整权重，是后端每天服务器的压力都能均衡调配，这个主要是通过执行的程序或脚本返回的状态代码来动态调整weight值，使权重根据真实的后端压力来适当调整，不过这需要有过硬的脚本功夫才行哦</span></span><br><span class="line">        <span class="comment">#返回0：健康检查没问题，不修改权重</span></span><br><span class="line">        <span class="comment">#返回1：健康检查失败，权重设置为0</span></span><br><span class="line">        <span class="comment">#返回2-255：健康检查没问题，但是权重却要根据返回代码修改为返回码-2，例如如果程序或脚本执行后返回的代码为200，#那么权重这回被修改为 200-2</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">#DNS检测</span></span><br><span class="line">    DNS_CHECK &#123; </span><br><span class="line">        connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。 </span><br><span class="line">        connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。 默认是25端口 </span><br><span class="line">        bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。 </span><br><span class="line">        bind_port &lt;PORT&gt;：发起连接的源端口。 </span><br><span class="line">        connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。 </span><br><span class="line">        fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。 </span><br><span class="line">        warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。 </span><br><span class="line">        retry &lt;INT&gt;：重试次数。默认是3次。 </span><br><span class="line">        <span class="built_in">type</span> &lt;STRING&gt;：DNS query <span class="built_in">type</span>。A/NS/CNAME/SOA/MX/TXT/AAAA </span><br><span class="line">        name &lt;STRING&gt;：DNS查询的域名。默认是(.) </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结：</p>
<ul>
<li>VRRP脚本(vrrp_script)和VRRP实例(vrrp_instance)属于同一个级别</li>
<li>VRRP脚本中的weight权重:<ul>
<li>如果脚本执行成功(退出状态码为0)，weight大于0，则priority增加。</li>
<li>如果脚本执行失败(退出状态码为非0)，weight小于0，则priority减少。</li>
<li>其他情况下，priority不变。</li>
</ul>
</li>
<li>脚本文件要加上x权限同时指令最好写绝对路径。</li>
</ul>
<p><br></p>
<h4 id="0x06-入坑记"><a href="#0x06-入坑记" class="headerlink" title="0x06 入坑记"></a>0x06 入坑记</h4><p><em>问题1：keepalived漂移的VIP无法ping通？</em><br>原因：防火墙/keepalived配置文件中启动了vrrp_strict<br>解决办法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙</span><br><span class="line">注释：keepalived.conf配置中 <span class="comment">#vrrp_strict 参数</span></span><br><span class="line"></span><br><span class="line">[root@slave sec]<span class="comment"># ping 10.10.107.236</span></span><br><span class="line">PING 10.10.107.236 (10.10.107.236) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.10.107.236: icmp_seq=1 ttl=64 time=0.056 ms</span><br></pre></td></tr></table></figure></p>
<p><em>问题2：查看vrrp通信信息</em><br>我们可以通过tcpdump来抓取vrrp通信包进行查看;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i ens192 vrrp -vv -c 2</span><br><span class="line">tcpdump: listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">11:21:31.013073 IP (tos 0xc0, ttl 255, id 64656, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.10.107.254 &gt; vrrp.mcast.net: vrrp 10.10.107.254 &gt; vrrp.mcast.net: VRRPv2, Advertisement, vrid 5, prio 120, authtype none, intvl 1s, length 20, addrs: gateway</span><br><span class="line">11:21:31.357117 IP (tos 0xc0, ttl 255, id 223, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    master &gt; vrrp.mcast.net: vrrp master &gt; vrrp.mcast.net: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20, addrs: master auth <span class="string">"11111111"</span></span><br></pre></td></tr></table></figure></p>
<p><em>问题3：arp缓存问题?</em><br>先清理master的arp，将vip切回至master,ping vip正常再清理slave的arp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#组合命令清楚所有arp缓存：</span></span><br><span class="line">arp -n | awk <span class="string">'/^[1-9]/&#123;system("arp -d "$1)&#125;'</span></span><br></pre></td></tr></table></figure></p>
<p><em>问题4：在备用节点上抓包测试(在启用多播的情况下)：</em><br>答：tcpdump -i eth0 -nn host 224.1.101.33 #对多播地址抓包</p>
<h4 id="haproxy的故障转移"><a href="#haproxy的故障转移" class="headerlink" title="haproxy的故障转移"></a>haproxy的故障转移</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line"></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">     router_id teacher</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">     script <span class="string">"lsof -i:80 | grep haproxy || exit 1"</span></span><br><span class="line">     interval 2</span><br><span class="line">     fail 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance lvs_inst &#123;</span><br><span class="line">   state MASTER</span><br><span class="line">   interface ens33</span><br><span class="line">       virtual_router_id 51</span><br><span class="line">       priority 250</span><br><span class="line">       nopreempt</span><br><span class="line">       advert_int 1</span><br><span class="line">authentication &#123;</span><br><span class="line">             auth_type PASS</span><br><span class="line">             auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">           chk_haproxy</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">           10.18.42.124</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主从节点都必须有的检测haproxy服务状态的文件（注：该文件必须有可执行权限！！！）：<br>vim /opt/check_haproxy.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; <span class="keyword">then</span><span class="comment">###判断haproxy是否已经启动</span></span><br><span class="line"></span><br><span class="line">     systemctl start haproxy<span class="comment">###如果没有启动，则启动haproxy程序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sleep 2<span class="comment">###睡眠两秒钟，等待haproxy完全启动</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; <span class="keyword">then</span><span class="comment">###判断haproxy是否已经启动</span></span><br><span class="line"></span><br><span class="line">      systemctl stop keepalived<span class="comment">###如果haproxy没有启动起来，则将keepalived停掉，则VIP</span></span><br><span class="line">        自动漂移到另外一台haproxy机器,实现了对haproxy的高可用</span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<h4 id="mysql-与-keepalived"><a href="#mysql-与-keepalived" class="headerlink" title="mysql 与 keepalived"></a>mysql 与 keepalived</h4><p><a href="https://blog.51cto.com/gaowenlong/1888036" target="_blank" rel="noopener">https://blog.51cto.com/gaowenlong/1888036</a><br>实现MySQL的故障转移</p>
<p>1)、实现master与slave1两台主机的复制(AA复制)<br>2)、利用keepalived 的健康检查功能,检测本机的3306端口是否存活,如果端口失效,则自动执行自定义脚本<br>3)、自定义脚本的内容为:kill 本机的keepalived进程,并删除本机VIP;当本机keepalived进程被kill掉之后,另一台主机的keepalived进程即可获得虚拟IP,实现的故障转移<br>4)、测试:客户端连接keepalived提供的虚拟IP(mysql需要事先授权grant连接)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line"></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">           router_id teacher</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance lvs_inst &#123;</span><br><span class="line">          state MASTER</span><br><span class="line">          interface ens33</span><br><span class="line">          virtual_router_id 51</span><br><span class="line">          priority 250</span><br><span class="line">          nopreempt</span><br><span class="line">          advert_int 1</span><br><span class="line">          authentication &#123;</span><br><span class="line">                  auth_type PASS</span><br><span class="line">                  auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">           virtual_ipaddress &#123;</span><br><span class="line">                       10.18.42.123</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 10.18.42.123 3306 &#123;</span><br><span class="line">             delay_loop 6</span><br><span class="line">             lb_algo rr</span><br><span class="line">             lb_kind DR</span><br><span class="line">             <span class="comment">#persistence_timeout 50</span></span><br><span class="line">             protocol TCP</span><br><span class="line"></span><br><span class="line">real_server 10.18.42.251 3306 &#123;</span><br><span class="line">         weight 1</span><br><span class="line">         notify_down /etc/keepalived/kill.sh   <span class="comment">#检测失败执行的脚本</span></span><br><span class="line">         TCP_CHECK &#123;</span><br><span class="line">                   connect_port 3306</span><br><span class="line">                   connect_timeout 3</span><br><span class="line">                   nb_get_retry 3</span><br><span class="line">                   delay_before_retry 3</span><br><span class="line">                   &#125;</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /etc/keepalived/kill.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">pkill keepalived</span><br><span class="line"><span class="comment">#systemctl stop keepalived #尽量使用此方式关闭keepalived</span></span><br><span class="line">ip addr del dev ens33 10.18.42.123/32</span><br></pre></td></tr></table></figure></p>

        </div>
        
  <hr>
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>

  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注，转个发】(人间五大情)</b>，这将对我的肯定，谢谢！。</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="扫描Visit(浏览)极客全栈修炼小程序"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-03-29T05:39:06.301Z" itemprop="dateUpdated">2022-03-29 13:39:06</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/系统运维/系统架构/高可用/Keepalived高可用服务解决方案.md" target="_blank" rel="noopener noreferrer">_posts/系统运维/系统架构/高可用/Keepalived高可用服务解决方案.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2019/6-9-262.html" target="_blank" rel="external">https://blog.weiyigeek.top/2019/6-9-262.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">👍 钟意作者</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1/" rel="tag">高可用服务</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/6-9-262.html&title=《Keepalived高可用服务解决方案》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/6-9-262.html&title=《Keepalived高可用服务解决方案》 — WeiyiGeek Blog&source=[TOC]
文章目录(1) Keepalive 高可用解决方案" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/6-9-262.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Keepalived高可用服务解决方案》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/6-9-262.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/6-9-262.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2019/6-11-180.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Shell脚本管道符与重定向</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/6-7-407.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">BurpSuite常用插件介绍一览（待收集）</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#文章目录"><span class="post-toc-number">1.</span> <span class="post-toc-text">文章目录</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x00-快速入门"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x00 快速入门</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-Keepalived-介绍与组成"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 Keepalived 介绍与组成</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x03-Keepalived-环境与实例"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 Keepalived 环境与实例</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x04-命令详解"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 命令详解</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x05-配置文件"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x05 配置文件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x06-入坑记"><span class="post-toc-number">7.</span> <span class="post-toc-text">0x06 入坑记</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#haproxy的故障转移"><span class="post-toc-number">8.</span> <span class="post-toc-text">haproxy的故障转移</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#mysql-与-keepalived"><span class="post-toc-number">9.</span> <span class="post-toc-text">mysql 与 keepalived</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，还请支持一下博主哟, 谢谢各位看友♥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="228" height="228" alt="打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="228" height="228" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- 微信公众号关注/文章版权复制 -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">个人Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">个人Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">个人知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云+云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved. IT唯一极客 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/6-9-262.html&title=《Keepalived高可用服务解决方案》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/6-9-262.html&title=《Keepalived高可用服务解决方案》 — WeiyiGeek Blog&source=[TOC]
文章目录(1) Keepalive 高可用解决方案" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/6-9-262.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Keepalived高可用服务解决方案》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/6-9-262.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/6-9-262.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJUlEQVR42u3aS27DMAwFwN7/0um2RWv7kXQCWBqtAqMWNF6w4ufrK16vH2vy/O/fVN8aLQwMjMcyXqcrOW5y0KM9k9/nZ8PAwNiHkRxicqB8n/MdDp9jYGBgtA59FDSTOx4GBgbGhDEJl9W3MDAwMKpJbF7pqgbTj+biGBgYD2TkVffP/35LfwMDA+NRjFdxJQGxGsp7J/m1DwYGxtKMPMCdJ5/3XiJ758HAwFiV0XQXm5G94bDCEwwMjC0Z+XXw3lZB70qKgYGxNqPaqkxK9pOC/m1jYRgYGAsxqqNaSfKZXxl718p/kBgYGEszqq8lyW01Ge4lzOUvjYGB8VjGvEw2SUEnH+Xi/wYGBsZCjKT4Xi2u9ca88iGMCzYGBsaijF6RK+fl746upBgYGIsy5mX6vMXYa3lGIRsDA2MbRq9WNym3TULw4cwIBgbGNow8dZzwChl2XnXDwMBYjtFLWSfDpvOW50UnFgMDY2lGtTHQK9/nY69JuxQDA2NPxjws3tUKzS+XGBgY+zB6l8JqO7MX3AvDFhgYGFsyetli/jkm5bmLXBwDA2MJxqu4kpS1V2Lr7Y+BgbEDo9ofrAbK6mBZ0li9oWeLgYHxQEavJVkdnpi3GZpVQwwMjIUY1aGxPBnOy3mTIQwMDAyM+U2zGsTzoh4GBgZGnqz2imV5g/MCg4GBsQGjOk7xvjGvt5fbMDAwHsjIU8dqG7KXuPaCNQYGxqKMb0tsA/E4alwtAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
