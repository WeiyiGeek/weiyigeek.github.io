{"title":"Flask学习实践使用案例","slug":"编程世界/Python/Web开发/Flask/Flask学习实践使用案例","date":"2019-07-16T07:36:30.000Z","updated":"2022-08-10T03:14:50.203Z","url":"2019/7-16-493.html","path":"api/articles/2019/7-16-493.html.json","covers":null,"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x01-Flask-实践之编写简单-API-接口进行文件目录的同步\"><a href=\"#0x01-Flask-实践之编写简单-API-接口进行文件目录的同步\" class=\"headerlink\" title=\"0x01 Flask 实践之编写简单 API 接口进行文件目录的同步\"></a>0x01 Flask 实践之编写简单 API 接口进行文件目录的同步</h2><p>描述: 使用Flask我们可以非常方便的写出一个API请求接口或者网页, 此处我将利用该接口执行存在的shell脚本，利用rsync命令同步文件夹与文件,同时将结果回显到模板文件中。</p>\n<ul>\n<li><p>Flask 主文件: setup.py</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> subprocess</span><br><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> Flask</span><br><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> request,render_template</span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__external_cmd</span><span class=\"params\">(cmd, code=<span class=\"string\">\"utf-8\"</span>)</span>:</span></span><br><span class=\"line\">  result = []</span><br><span class=\"line\">  process = subprocess.Popen(cmd, shell=<span class=\"literal\">True</span>, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)</span><br><span class=\"line\">  <span class=\"keyword\">while</span> process.poll() <span class=\"keyword\">is</span> <span class=\"literal\">None</span>:</span><br><span class=\"line\">    line = process.stdout.readline()</span><br><span class=\"line\">    line = line.strip()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> line:</span><br><span class=\"line\">      result.append(line.decode(code, <span class=\"string\">'ignore'</span>))</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># def sh(command, print_msg=True):</span></span><br><span class=\"line\"><span class=\"comment\">#   p = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)</span></span><br><span class=\"line\"><span class=\"comment\">#   lines = []</span></span><br><span class=\"line\"><span class=\"comment\">#   for line in iter(p.stdout.readline, b''):</span></span><br><span class=\"line\"><span class=\"comment\">#       line = line.rstrip().decode('gbk', 'ignore')</span></span><br><span class=\"line\"><span class=\"comment\">#       if print_msg:</span></span><br><span class=\"line\"><span class=\"comment\">#           print(\"&gt;&gt;&gt;\", line)</span></span><br><span class=\"line\"><span class=\"comment\">#       lines.append(line)</span></span><br><span class=\"line\"><span class=\"comment\">#   return lines</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/')</span></span><br><span class=\"line\"><span class=\"meta\">@app.route('/index')</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"string\">\"&lt;h4 style='text-algin:center'&gt;https://blog.weiyigeek.top&lt;/h4&gt;&lt;script&gt;window.location.href='https://blog.weiyigeek.top'&lt;/script&gt;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/web/rsync',methods=[\"GET\"])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">sync</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">  rsyncFlag = request.args.get(<span class=\"string\">\"action\"</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (rsyncFlag <span class=\"keyword\">and</span> rsyncFlag == <span class=\"string\">\"ok\"</span>):</span><br><span class=\"line\">    res = __external_cmd(<span class=\"string\">\"/usr/bin/rsync -auv --delete /work/web/ /work/OfficialWebsite/\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> render_template(<span class=\"string\">'index.html'</span>,command=res)</span><br><span class=\"line\">  <span class=\"keyword\">else</span>:</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">\"&lt;script&gt;var r=confirm('是否进行上线同步?');if(r==true)&#123;window.location.href='/web/rsync?action=ok';&#125;else&#123;window.location.href='https://blog.weiyigeek.top';&#125;;&lt;/script&gt;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">  app.run(host=<span class=\"string\">'0.0.0.0'</span>,port=<span class=\"number\">8000</span>)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>同步脚本: rsync.sh</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">rsync -auv --delete /app/weiyigeekweb/weiyigeek.com.cn/ /app/weiyigeekweb/web/</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>模板文件: templates\\index.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">\"en\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"UTF-8\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">\"X-UA-Compatible\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"IE=edge\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">\"viewport\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"width=device-width, initial-scale=1.0\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>网站同步状态回显<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"css\">  <span class=\"selector-class\">.textarea</span>&#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    width: 50%;</span></span><br><span class=\"line\"><span class=\"undefined\">    min-height: 20px;</span></span><br><span class=\"line\"><span class=\"undefined\">    margin-left: auto;</span></span><br><span class=\"line\"><span class=\"undefined\">    margin-right: auto;</span></span><br><span class=\"line\"><span class=\"undefined\">    padding: 3px;</span></span><br><span class=\"line\"><span class=\"undefined\">    outline: 0;</span></span><br><span class=\"line\"><span class=\"css\">    <span class=\"selector-tag\">border</span>: 1<span class=\"selector-tag\">px</span> <span class=\"selector-tag\">solid</span> <span class=\"selector-id\">#a0b3d6</span>;</span></span><br><span class=\"line\"><span class=\"undefined\">    font-size: 12px;</span></span><br><span class=\"line\"><span class=\"undefined\">    line-height: 24px;</span></span><br><span class=\"line\"><span class=\"undefined\">    padding: 2px;</span></span><br><span class=\"line\"><span class=\"undefined\">    word-wrap: break-word;</span></span><br><span class=\"line\"><span class=\"undefined\">    overflow-x: hidden;</span></span><br><span class=\"line\"><span class=\"undefined\">    overflow-y: auto;</span></span><br><span class=\"line\"><span class=\"css\">    <span class=\"selector-tag\">border-color</span>: <span class=\"selector-tag\">rgba</span>(82, 168, 236, 0<span class=\"selector-class\">.8</span>);</span></span><br><span class=\"line\"><span class=\"css\">    <span class=\"selector-tag\">box-shadow</span>: <span class=\"selector-tag\">inset</span> 0 1<span class=\"selector-tag\">px</span> 3<span class=\"selector-tag\">px</span> <span class=\"selector-tag\">rgba</span>(0, 0, 0, 0<span class=\"selector-class\">.1</span>), 0 0 8<span class=\"selector-tag\">px</span> <span class=\"selector-tag\">rgba</span>(82, 168, 236, 0<span class=\"selector-class\">.6</span>);</span></span><br><span class=\"line\"><span class=\"undefined\">    background-color: black;</span></span><br><span class=\"line\"><span class=\"undefined\">    color: white;</span></span><br><span class=\"line\"><span class=\"undefined\">  &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">style</span>=<span class=\"string\">\"text-align: center;\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">h3</span>&gt;</span>网站同步状态回显<span class=\"tag\">&lt;/<span class=\"name\">h3</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"https://www.weiyigeek.top\"</span> <span class=\"attr\">target</span>=<span class=\"string\">\"_blank\"</span>&gt;</span>https://www.weiyigeek.top<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">br</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">br</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"textarea\"</span> <span class=\"attr\">contenteditable</span>=<span class=\"string\">\"true\"</span>&gt;</span> </span><br><span class=\"line\">    &#123;% for comment in command %&#125;</span><br><span class=\"line\">    &#123;&#123; comment &#125;&#125; <span class=\"tag\">&lt;<span class=\"name\">br</span>&gt;</span></span><br><span class=\"line\">    &#123;% endfor %&#125; </span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>温馨提示: 构建出Flask运行环境的镜像<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls</span><br><span class=\"line\">Dockerfile requirements.txt</span><br><span class=\"line\"></span><br><span class=\"line\">$ cat requirements.txt</span><br><span class=\"line\">Flask</span><br><span class=\"line\"></span><br><span class=\"line\">$ cat Dockerfile</span><br><span class=\"line\">FROM python:slim-buster</span><br><span class=\"line\">LABEL maintainer=<span class=\"string\">\"WeiyiGeek\"</span> \\</span><br><span class=\"line\">      description=<span class=\"string\">\"Flask Website Rsync\"</span> \\</span><br><span class=\"line\">      version=<span class=\"string\">\"v1.2\"</span></span><br><span class=\"line\">WORKDIR /app</span><br><span class=\"line\">COPY requirements.txt ./</span><br><span class=\"line\">RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple \\</span><br><span class=\"line\">   &amp;&amp; sed -i -e <span class=\"string\">'s#http://deb.debian.org#https://mirrors.huaweicloud.com#g'</span> -e <span class=\"string\">'s|deb http:|#deb http:|g'</span> /etc/apt/sources.list \\</span><br><span class=\"line\">   &amp;&amp; apt update \\</span><br><span class=\"line\">   &amp;&amp; apt install -y rsync \\</span><br><span class=\"line\">   &amp;&amp; apt clean &amp;&amp; apt-get autoclean &amp;&amp; apt-get -y autoremove</span><br><span class=\"line\">EXPOSE 8000</span><br><span class=\"line\">CMD [<span class=\"string\">\"sleep\"</span>,<span class=\"string\">\"600\"</span>]</span><br></pre></td></tr></table></figure></p>\n<p><strong>执行与运行效果</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ python setup.py</span><br><span class=\"line\">$ curl http://127.0.0.1:8000/web/rsync</span><br></pre></td></tr></table></figure></p>\n<p><br/></p>\n<p>s</p>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"Python3","path":"api/categories/Python3.json"},{"name":"实践案例","path":"api/categories/实践案例.json"}],"tags":[{"name":"Flask","path":"api/tags/Flask.json"}]}