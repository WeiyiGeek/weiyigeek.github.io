<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 18-Kubernetes进阶之应用与持久化数据卷备份迁移实践|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="k8s">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                学习之路
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="/img/video-account.jpg" target="_blank" >
                <i class="icon icon-lg icon-video-camera"></i>
                视频号
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>18-Kubernetes进阶之应用与持久化数据卷备份迁移实践</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">18-Kubernetes进阶之应用与持久化数据卷备份迁移实践</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-07-27T02:37:47.000Z" itemprop="datePublished" class="page-time">
  2021-07-27
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap" style="display: none;">
  <article id="post-虚拟云容/云容器/Kubernetes/18-Kubernetes进阶之应用与持久化数据卷备份迁移实践"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">18-Kubernetes进阶之应用与持久化数据卷备份迁移实践</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-07-27 10:37:47" datetime="2021-07-27T02:37:47.000Z"  itemprop="datePublished">2021-07-27</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <span class="post-href" style="display: none;">|</span> 
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-前言简述"><a href="#0x00-前言简述" class="headerlink" title="0x00 前言简述"></a>0x00 前言简述</h2><p><strong>引言</strong></p>
<blockquote>
<p>在运维安全管理中容灾备份是非常重要的一环, 那在Kubernetes集群中如何进行备份和迁移 Kubernetes 资源和持久卷数据。<br>常常采用手动进行容灾备份, 如备份资源清单、或者helm模板，但是针对Kubernetes 资源和持久卷(<code>PV/PVC</code>)中得数据无法进行备份迁移，所以在这样得场景下我们就需要 Velero 是一个开源工具。</p>
</blockquote>
<p><br/></p>
<h3 id="1-Velero-基础概述"><a href="#1-Velero-基础概述" class="headerlink" title="1.Velero 基础概述"></a>1.Velero 基础概述</h3><p><strong>What: 什么是 Velero?</strong></p>
<blockquote>
<p>答: Velero （以前称为 <code>Heptio Ark</code>）是一个开源工具，用于安全备份和恢复、执行灾难恢复以及迁移 Kubernetes 集群资源和持久卷。</p>
</blockquote>
<p><br/></p>
<p><strong>Why: 为啥要使用 Velero?</strong></p>
<blockquote>
<p>答: Velero 可以让您<code>备份您的集群并在丢失时恢复</code>、<code>将集群资源迁移到其他集群</code>、<code>将您的生产集群复制到开发和测试集群</code>, 详细解析说明:</p>
<ul>
<li>1.灾难恢复 : 在基础设施丢失、数据损坏和/或服务中断的情况下减少恢复时间。</li>
<li>2.数据迁移 : 通过轻松地将 Kubernetes 资源从一个集群迁移到另一个集群，实现集群可移植性。</li>
<li>3.数据保护 : 提供关键数据保护功能，例如计划备份、保留计划以及用于自定义操作的备份前或备份后挂钩。</li>
</ul>
</blockquote>
<p>Velero 特点: 您可以备份或恢复集群中的所有对象，也可以按类型、命名空间和/或标签过滤对象。</p>
<ul>
<li>1.备份集群 : 使用命名空间或标签选择器为整个集群或集群的一部分备​​份 Kubernetes 资源和卷。</li>
<li>2.计划备份 : 设置计划以定期自动启动备份。</li>
<li>3.备份挂钩 : 配置备份前和备份后挂钩，以在 Velero 备份之前和之后执行自定义操作。</li>
</ul>
<p><br/></p>
<p><strong>How: 你如何使用 Velero?</strong></p>
<blockquote>
<p>答: 您可以通过云提供商或本地运行 Velero, 其组件包括<code>在集群上运行的服务器</code>和<code>本地运行的命令行客户端</code>。<br>使用<code>Minio</code>服务进行管理存储备份在ETCD的数据、使用<code>velero</code>客户端进行备份和还原操作。</p>
</blockquote>
<p><br/></p>
<h3 id="2-Velero-工作原理"><a href="#2-Velero-工作原理" class="headerlink" title="2.Velero 工作原理"></a>2.Velero 工作原理</h3><p>描述: 一般得使用Velero主要是从以下三个方面入手。</p>
<ul>
<li>1.按需备份: 将复制的 Kubernetes 对象的 tarball 上传到云对象存储中，调用云提供商 API 以制作持久卷的磁盘快照（如果指定）。</li>
<li>2.计划备份: 由 Cron 表达式指定在循环间隔备份您的数据,计划备份以名称保存<code>&lt;SCHEDULE NAME&gt;-&lt;TIMESTAMP&gt;</code>，其中<code>&lt;TIMESTAMP&gt;</code>格式为<code>YYYYMMDDhhmmss</code>。</li>
<li>3.容灾恢复: 该恢复操作可以恢复所有对象和持久卷从先前创建的备份,还原的默认名称为<code>&lt;BACKUP NAME&gt;-&lt;TIMESTAMP&gt;</code>, 恢复的对象还包括一个带有 key <code>velero.io/restore-name</code> 和 value的标签<code>&lt;RESTORE NAME&gt;</code></li>
<li>4.备份过期: 可以通过添加标志来指定<code>--ttl &lt;DURATION&gt;</code>参数来设置备份得生存时间(默认30天)。到期后则会删除<code>备份资源、来自云对象存储的备份文件、所有 PersistentVolume 快照、所有关联的恢复</code>。</li>
<li>5.对象存储同步: 它会不断检查以确保始终存在正确的备份资源。如果存储桶中有格式正确的备份文件，但 Kubernetes API 中没有相应的备份资源，Velero 会将信息从对象存储同步到 Kubernetes。</li>
</ul>
<p><br></p>
<p><strong>备份工作流程:</strong><br>描述: 当你运行<code>velero backup create test-backup</code>命令。</p>
<blockquote>
<p>1.Velero 客户端调用 Kubernetes API 服务器来创建一个Backup对象。</p>
</blockquote>
<blockquote>
<p>2.该 BackupController 注意到新的 Backup 对象并进行验证。</p>
</blockquote>
<blockquote>
<p>3.在 BackupController 开始备份过程。它通过向 API 服务器查询资源来收集要备份的数据。</p>
</blockquote>
<blockquote>
<p>4.将 BackupController 使得对象存储服务的调用-例如，AWS S3 -上传备份文件。</p>
</blockquote>
<p>默认情况下 <code>velero backup create</code> 为任何持久卷制作磁盘快照, 可以通过指定附加标志来调整快照<code>--snapshot-volumes=false</code>(使用选项禁用快照)。</p>
<figure class="image-box">
                <a rel=18-Kubernetes进阶之应用与持久化数据卷备份迁移实践 href="https://img.weiyigeek.top/2021/5/20210807100119.png" target="_blank" title="WeiyiGeek.backup-process" data-fancybox="images"><img src="https://img.weiyigeek.top/2021/5/20210807100119.png" alt="WeiyiGeek.backup-process" title="" class=""></a>
                <p>WeiyiGeek.backup-process</p>
            </figure>
<p>Tips : 实际上 <code>Velero</code> 在 <code>Kubernetes</code> 集群中创建了很多 CRD 以及相关的控制器，进行备份恢复等操作实质上是对相关 CRD 的操作。</p>
<p>Tips : Velero 使用 Kubernetes API 服务器的首选版本为每个组/资源备份资源。恢复资源时，目标集群中必须存在<code>相同的 API 组/版本</code>才能成功恢复。</p>
<p><br></p>
<h3 id="3-Provider-插件供应商"><a href="#3-Provider-插件供应商" class="headerlink" title="3.Provider 插件供应商"></a>3.Provider 插件供应商</h3><p>描述: Velero 有一个插件系统支持各种存储提供程序，用于不同的备份和快照操作。它允许任何人在不修改 Velero 代码库的情况下为其他备份和卷存储平台添加兼容性。</p>
<p><strong>Velero 支持的备份存储Provider</strong></p>
<table>
<thead>
<tr>
<th>提供者</th>
<th>对象存储</th>
<th>卷快照程序</th>
<th>插件提供程序存储库</th>
<th>安装说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://aws.amazon.com/" target="_blank" rel="noopener">亚马逊网络服务 (AWS)</a></td>
<td>AWS S3</td>
<td>AWS EBS</td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-aws" target="_blank" rel="noopener">适用于 AWS 的 Velero 插件</a></td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-aws#setup" target="_blank" rel="noopener">AWS 插件设置</a> (以及s3兼容的存储比如minio)</td>
</tr>
<tr>
<td><a href="https://cloud.google.com/" target="_blank" rel="noopener">谷歌云平台 (GCP)</a></td>
<td>谷歌云存储</td>
<td>谷歌计算引擎磁盘</td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-gcp" target="_blank" rel="noopener">GCP 的 Velero 插件</a></td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-gcp#setup" target="_blank" rel="noopener">GCP 插件设置</a></td>
</tr>
<tr>
<td><a href="https://azure.com/" target="_blank" rel="noopener">微软 Azure</a></td>
<td>Azure Blob 存储</td>
<td>Azure 托管磁盘</td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure" target="_blank" rel="noopener">适用于 Microsoft Azure 的 Velero 插件</a></td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure#setup" target="_blank" rel="noopener">Azure 插件设置</a></td>
</tr>
<tr>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-vsphere" target="_blank" rel="noopener">VMware vSphere</a></td>
<td>🚫</td>
<td>vSphere 卷</td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-vsphere" target="_blank" rel="noopener">VMware vSphere</a></td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-vsphere#velero-plugin-for-vsphere-installation-and-configuration-details" target="_blank" rel="noopener">vSphere 插件设置</a></td>
</tr>
<tr>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-csi/" target="_blank" rel="noopener">容器存储接口 (CSI)</a></td>
<td>🚫</td>
<td>CSI 卷</td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-csi/" target="_blank" rel="noopener">CSI 的 Velero 插件</a></td>
<td><a href="https://github.com/vmware-tanzu/velero-plugin-for-csi#kinds-of-plugins-included" target="_blank" rel="noopener">CSI 插件设置</a></td>
</tr>
</tbody>
</table>
<p><br/></p>
<p><strong>Velero 社区支持的Provider</strong></p>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Object Store</th>
<th>Volume Snapshotter</th>
<th>Plugin Documentation</th>
<th>Contact</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.alibabacloud.com/" target="_blank" rel="noopener">AlibabaCloud</a></td>
<td>Alibaba Cloud OSS</td>
<td>Alibaba Cloud</td>
<td><a href="https://github.com/AliyunContainerService/velero-plugin" target="_blank" rel="noopener">AlibabaCloud</a></td>
<td><a href="https://github.com/AliyunContainerService/velero-plugin/issues" target="_blank" rel="noopener">GitHub Issue</a></td>
</tr>
<tr>
<td><a href="https://www.digitalocean.com/" target="_blank" rel="noopener">DigitalOcean</a></td>
<td>DigitalOcean Object Storage</td>
<td>DigitalOcean Volumes Block Storage</td>
<td><a href="https://github.com/StackPointCloud/ark-plugin-digitalocean" target="_blank" rel="noopener">StackPointCloud</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://www.hpe.com/us/en/storage.html" target="_blank" rel="noopener">Hewlett Packard</a></td>
<td>🚫</td>
<td>HPE Storage</td>
<td><a href="https://github.com/hpe-storage/velero-plugin" target="_blank" rel="noopener">Hewlett Packard</a></td>
<td><a href="https://slack.hpedev.io/" target="_blank" rel="noopener">Slack</a>, <a href="https://github.com/hpe-storage/velero-plugin/issues" target="_blank" rel="noopener">GitHub Issue</a></td>
</tr>
<tr>
<td><a href="https://openebs.io/" target="_blank" rel="noopener">OpenEBS</a></td>
<td>🚫</td>
<td>OpenEBS CStor Volume</td>
<td><a href="https://github.com/openebs/velero-plugin" target="_blank" rel="noopener">OpenEBS</a></td>
<td><a href="https://openebs-community.slack.com/" target="_blank" rel="noopener">Slack</a>, <a href="https://github.com/openebs/velero-plugin/issues" target="_blank" rel="noopener">GitHub Issue</a></td>
</tr>
<tr>
<td><a href="https://www.openstack.org/" target="_blank" rel="noopener">OpenStack</a></td>
<td>Swift</td>
<td>Cinder</td>
<td><a href="https://github.com/Lirt/velero-plugin-for-openstack" target="_blank" rel="noopener">OpenStack</a></td>
<td><a href="https://github.com/Lirt/velero-plugin-for-openstack/issues" target="_blank" rel="noopener">GitHub Issue</a></td>
</tr>
<tr>
<td><a href="https://portworx.com/" target="_blank" rel="noopener">Portworx</a></td>
<td>🚫</td>
<td>Portworx Volume</td>
<td><a href="https://docs.portworx.com/scheduler/kubernetes/ark.html" target="_blank" rel="noopener">Portworx</a></td>
<td><a href="https://portworx.slack.com/messages/px-k8s" target="_blank" rel="noopener">Slack</a>, <a href="https://github.com/portworx/ark-plugin/issues" target="_blank" rel="noopener">GitHub Issue</a></td>
</tr>
<tr>
<td><a href="https://storj.io/" target="_blank" rel="noopener">Storj</a></td>
<td>Storj Object Storage</td>
<td>🚫</td>
<td><a href="https://github.com/storj-thirdparty/velero-plugin" target="_blank" rel="noopener">Storj</a></td>
<td><a href="https://github.com/storj-thirdparty/velero-plugin/issues" target="_blank" rel="noopener">GitHub Issue</a></td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="4-补充说明"><a href="#4-补充说明" class="headerlink" title="4.补充说明"></a>4.补充说明</h3><p><strong>参考来源:</strong></p>
<ul>
<li>velero 官网: <a href="https://velero.io/" target="_blank" rel="noopener">https://velero.io/</a></li>
<li>velero 手册: <a href="https://velero.io/docs/v1.6/" target="_blank" rel="noopener">https://velero.io/docs/v1.6/</a></li>
<li>velero 供应商: <a href="https://velero.io/docs/v1.6/supported-providers/" target="_blank" rel="noopener">https://velero.io/docs/v1.6/supported-providers/</a></li>
</ul>
<hr>
<h2 id="0x01-环境部署"><a href="#0x01-环境部署" class="headerlink" title="0x01 环境部署"></a>0x01 环境部署</h2><h3 id="1-先决条件"><a href="#1-先决条件" class="headerlink" title="1.先决条件"></a>1.先决条件</h3><ul>
<li>Kubernetes 集群 API Version &gt;= 1.7</li>
<li>Kubernetes 集群已部署 DNS 服务器 (例如: CoreDNS)。</li>
<li>在 Minio 中存储备份可用磁盘空间少于 1GB，Minio 将无法运行。</li>
</ul>
<p><br></p>
<h3 id="2-下载部署-Velero"><a href="#2-下载部署-Velero" class="headerlink" title="2.下载部署 Velero"></a>2.下载部署 Velero</h3><ul>
<li>1.下载 <a href="https://github.com/vmware-tanzu/velero/releases" target="_blank" rel="noopener">最新的官方版本的</a>tarball，<em>每个版本的 tarball 都包含<code>velero</code>命令行客户端</em>,，并将<code>elero</code>二进制文件从 Velero 目录移动到 PATH 中的某个位置。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fSL https:<span class="comment">//github.com/vmware-tanzu/velero/releases/download/v1.6.2/velero-v1.6.2-linux-amd64.tar.gz </span></span><br><span class="line">tar -zxvf velero-v1<span class="number">.6</span><span class="number">.2</span>-linux-amd64.tar.gz -C /usr/local/</span><br><span class="line">ln -s /usr/local/velero-v1<span class="number">.6</span><span class="number">.2</span>-linux-amd64/velero /usr/bin/velero</span><br></pre></td></tr></table></figure>
<ul>
<li>2.验证 Velero Client<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">velero version</span><br><span class="line">Client:</span><br><span class="line">        Version: v1<span class="number">.6</span><span class="number">.2</span></span><br><span class="line">        Git commit: <span class="number">8</span>c9cdb9603446760452979dc77f93b17054ea1cc</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-设置Minio服务器"><a href="#3-设置Minio服务器" class="headerlink" title="3.设置Minio服务器"></a>3.设置Minio服务器</h3><p>描述: 这些指令启动 Velero 服务器和一个只能从集群内部访问的 Minio 实例，我们可以配置集群以从外部访问 Minio 的信息，访问日志和运行<code>velero describe</code>命令需要外部访问。</p>
<ul>
<li>1.在本地目录中创建 Velero 特定的凭据文件。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tee /tmp/credentials-velero &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">[<span class="keyword">default</span>]</span><br><span class="line">aws_access_key_id = minio</span><br><span class="line">aws_secret_access_key = minio123</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li>2.修改启动服务器和本地存储服务。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 Velero 目录中解压目录中 修改 examples/minio/00-minio-deployment.yaml , 内容如下</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">velero</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">velero</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    component:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      component:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        component:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">storage</span></span><br><span class="line"><span class="attr">        emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">        emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">minio/minio:latest</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="comment"># 设置静态得Console监控端口(推荐)</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">server</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/storage</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--config-dir=/config</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--console-address</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">":31234"</span></span><br><span class="line">        <span class="comment"># 注意事项: 主要修改点是以下环境变量名称`MINIO_ROOT_USER|MINIO_ROOT_PASSWORD`否则。</span></span><br><span class="line">        <span class="comment"># WARNING: MINIO_ACCESS_KEY and MINIO_SECRET_KEY are deprecated.</span></span><br><span class="line"> 		<span class="comment"># Please use MINIO_ROOT_USER and MINIO_ROOT_PASSWORD</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MINIO_ROOT_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"minio"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MINIO_ROOT_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"minio123"</span></span><br><span class="line">        <span class="comment"># Pod 暴露 minio 服务和 console web 服务端口以供SVC使用</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">console</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">31234</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">storage</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">"/storage"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">"/config"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">velero</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    component:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># ClusterIP is recommended for production environments.</span></span><br><span class="line">  <span class="comment"># Change to NodePort if needed per documentation,</span></span><br><span class="line">  <span class="comment"># but only if you run Minio in a test/trial environment, for example with Minikube.</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30090</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">console</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">31234</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">31234</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">31234</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    component:</span> <span class="string">minio</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">velero</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">minio-setup</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    component:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">minio-setup</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">        emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">mc</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">minio/mc:latest</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="comment"># Minio状态检测</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"mc --config-dir=/config config host add velero http://minio:9000 minio minio123 &amp;&amp; mc --config-dir=/config mb -p velero/velero"</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">"/config"</span></span><br></pre></td></tr></table></figure>
<p>Tips: 注意 Velero 1.6.2 版本中minio得yaml配置文件我们需要相应进行改变。</p>
<p>Tips: 注意 提供的 Minio yaml 示例使用”空目录”,您的节点需要有足够的可用空间来存储要备份的数据以及 1GB 的可用空间。如果节点没有足够的空间，您可以修改示例 yaml 以使用 <code>Persistent Volume</code> 而不是<code>empty dir</code>。</p>
<p>Tips : 注意 使用 Service 在集群外公开 Minio 时需要Pod暴露两个应用端口即<code>Service 9000</code>和<code>Console 默认随机</code>，此时你可以将将 Minio 服务类型从更改ClusterIP为NodePort，具体配置查看上述资源清单。</p>
<p><br></p>
<ul>
<li>2.部署minio资源清单以及服务查看</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用本地集群minio作为备份存储</span></span><br><span class="line">kubectl apply -f examples/minio/00-minio-deployment.yaml</span><br><span class="line">  <span class="comment"># namespace/velero created</span></span><br><span class="line">  <span class="comment"># deployment.apps/minio created</span></span><br><span class="line">  <span class="comment"># service/minio created</span></span><br><span class="line">  <span class="comment"># job.batch/minio-setup created</span></span><br><span class="line"></span><br><span class="line">kubectl get svc -n velero</span><br><span class="line">  <span class="comment"># NAME            TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span></span><br><span class="line">  <span class="comment"># service/minio   NodePort   10.100.123.198   &lt;none&gt;        9000:30090/TCP,31234:31234/TCP   7m25s</span></span><br></pre></td></tr></table></figure>
<p>此时访问<code>http://192.168.12.107:30090</code> 可以看到 Minio 服务端, 此时它会访问跳转 <code>http://192.168.12.107:31234/login</code>, 登录得账号密码: <code>minio / minio123</code> 。</p>
<figure class="image-box">
                <a rel=18-Kubernetes进阶之应用与持久化数据卷备份迁移实践 href="https://img.weiyigeek.top/2021/5/20210807111458.png" target="_blank" title="WeiyiGeek.minio资源服务查看" data-fancybox="images"><img src="https://img.weiyigeek.top/2021/5/20210807111458.png" alt="WeiyiGeek.minio资源服务查看" title="" class=""></a>
                <p>WeiyiGeek.minio资源服务查看</p>
            </figure>
<p><br></p>
<ul>
<li>3.在客户端中安装 velero 客户端。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取指定 minio 服务地址和服务端口</span></span><br><span class="line">minio_service_ip=<span class="string">"192.168.12.107"</span></span><br><span class="line">minio_service_port=$(kubectl -n velero get svc/minio -o jsonpath=<span class="string">'&#123;.spec.ports[0].nodePort&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes Master 节点上安装 velero 或者在其他集群上安装执行</span></span><br><span class="line">velero install \</span><br><span class="line">  --image velero/velero:v1.6.2 \</span><br><span class="line">  --provider aws \</span><br><span class="line">  --bucket velero \</span><br><span class="line">  --namespace velero \</span><br><span class="line">  --plugins velero/velero-plugin-for-aws:v1.2.0 \</span><br><span class="line">  --secret-file /tmp/credentials-velero \</span><br><span class="line">  --velero-pod-cpu-request 200m \</span><br><span class="line">  --velero-pod-mem-request 200Mi \</span><br><span class="line">  --velero-pod-cpu-limit 1000m \</span><br><span class="line">  --velero-pod-mem-limit 1000Mi \</span><br><span class="line">  --use-volume-snapshots=<span class="literal">false</span> \</span><br><span class="line">  --use-restic \</span><br><span class="line">  --restic-pod-cpu-request 200m \</span><br><span class="line">  --restic-pod-mem-request 200Mi \</span><br><span class="line">  --restic-pod-cpu-limit 1000m \</span><br><span class="line">  --restic-pod-mem-limit 1000Mi \</span><br><span class="line">  --backup-location-config region=minio,s3ForcePathStyle=<span class="string">"true"</span>,s3Url=http://<span class="variable">$&#123;minio_service_ip&#125;</span>:<span class="variable">$&#123;minio_service_port&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 出现下述表示安装成功, 并且此时可以看到相关服务已经正常运行，Job 任务正常完成退出，大量 CRD 被创建。</span></span><br><span class="line"><span class="comment"># Velero is installed! ⛵ Use 'kubectl logs deployment/velero -n velero' to view the status.</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li>4.在<code>kubernetes</code>主节点中验证查看<code>velero</code>部署得所有服务。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all -n velero</span><br><span class="line">  <span class="comment"># NAME                         READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># pod/minio-b46c8d7d5-4qt4x    1/1     Running   0          4m50s</span></span><br><span class="line">  <span class="comment"># pod/restic-568nx             1/1     Running   0          98s</span></span><br><span class="line">  <span class="comment"># .......</span></span><br><span class="line">  <span class="comment"># pod/restic-vs5s9             1/1     Running   0          98s</span></span><br><span class="line">  <span class="comment"># pod/velero-7b8b8fc8f-rcwb2   1/1     Running   0          98s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME            TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE</span></span><br><span class="line">  <span class="comment"># service/minio   NodePort   10.100.123.198   &lt;none&gt;        9000:30090/TCP,31234:31234/TCP   9m10s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span></span><br><span class="line">  <span class="comment"># daemonset.apps/restic   4         4         4       4            4           &lt;none&gt;          98s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                     READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line">  <span class="comment"># deployment.apps/minio    1/1     1            1           10m</span></span><br><span class="line">  <span class="comment"># deployment.apps/velero   1/1     1            1           98s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                               DESIRED   CURRENT   READY   AGE</span></span><br><span class="line">  <span class="comment"># replicaset.apps/minio-57c7d49f8c   0         0         0       6m</span></span><br><span class="line">  <span class="comment"># replicaset.apps/minio-6489c45fb5   0         0         0       10m</span></span><br><span class="line">  <span class="comment"># replicaset.apps/minio-b46c8d7d5    1         1         1       4m50s</span></span><br><span class="line">  <span class="comment"># replicaset.apps/velero-7b8b8fc8f   1         1         1       98s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                    COMPLETIONS   DURATION   AGE</span></span><br><span class="line">  <span class="comment"># job.batch/minio-setup   0/1           9m10s      9m10s</span></span><br><span class="line"></span><br><span class="line">$ kubectl logs -n velero pod/minio-b46c8d7d5-4qt4x</span><br><span class="line">  <span class="comment"># API: http://172.16.100.91:9000  http://127.0.0.1:9000</span></span><br><span class="line">  <span class="comment"># Console: http://172.16.100.91:31234 http://127.0.0.1:31234</span></span><br><span class="line">  <span class="comment"># Documentation: https://docs.min.io</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>5.至此安装<code>velero</code>服务已经成功。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ velero version</span><br><span class="line">Client:</span><br><span class="line">  Version: v1.6.2</span><br><span class="line">  Git commit: 8c9cdb9603446760452979dc77f93b17054ea1cc</span><br><span class="line">Server:</span><br><span class="line">  Version: v1.6.2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="0x02-备份迁移实践"><a href="#0x02-备份迁移实践" class="headerlink" title="0x02 备份迁移实践"></a>0x02 备份迁移实践</h2><h3 id="1-官方示例"><a href="#1-官方示例" class="headerlink" title="1.官方示例"></a>1.官方示例</h3><ul>
<li>Step 1.部署在<code>velero</code>解压目录中得<code>examples/nginx-app/base.yaml</code>文件, 部署示例 nginx 应用程序。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f examples/nginx-app/base.yaml</span><br><span class="line">  <span class="comment"># namespace/nginx-example created</span></span><br><span class="line">  <span class="comment"># deployment.apps/nginx-deployment created</span></span><br><span class="line">  <span class="comment"># service/my-nginx created</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li>Step 2.检查是否成功创建了部署 Velero 给出的 nginx-app 示例 。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments -l component=velero --namespace=velero</span><br><span class="line">kubectl get deployments --namespace=nginx-example</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 3.为与<code>app=nginx</code>标签选择器匹配的任何对象创建备份。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ velero backup create nginx-backup --selector app=nginx</span><br><span class="line"></span><br><span class="line">$ velero backup describe nginx-backup --details</span><br><span class="line">  <span class="comment"># Name:         nginx-backup</span></span><br><span class="line">  <span class="comment"># Namespace:    velero</span></span><br><span class="line">  <span class="comment"># Labels:       velero.io/storage-location=default</span></span><br><span class="line">  <span class="comment"># Annotations:  velero.io/source-cluster-k8s-gitversion=v1.19.6</span></span><br><span class="line">  <span class="comment">#               velero.io/source-cluster-k8s-major-version=1</span></span><br><span class="line">  <span class="comment">#               velero.io/source-cluster-k8s-minor-version=19</span></span><br><span class="line">  <span class="comment"># .......</span></span><br><span class="line">  <span class="comment"># Phase:  Completed</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Resource List:</span></span><br><span class="line">  <span class="comment">#   apps/v1/ReplicaSet:</span></span><br><span class="line">  <span class="comment">#     - nginx-example/nginx-deployment-57d5dcb68</span></span><br><span class="line">  <span class="comment">#   v1/Endpoints:</span></span><br><span class="line">  <span class="comment">#     - nginx-example/my-nginx</span></span><br><span class="line">  <span class="comment">#   v1/Namespace:</span></span><br><span class="line">  <span class="comment">#     - nginx-example</span></span><br><span class="line">  <span class="comment">#   v1/Pod:</span></span><br><span class="line">  <span class="comment">#     - nginx-example/nginx-deployment-57d5dcb68-78x8z</span></span><br><span class="line">  <span class="comment">#     - nginx-example/nginx-deployment-57d5dcb68-hcptr</span></span><br><span class="line">  <span class="comment">#   v1/Service:</span></span><br><span class="line">  <span class="comment">#     - nginx-example/my-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者如果要备份除与标签匹配的对象之外的所有对象 backup=ignore：</span></span><br><span class="line">$ velero backup create nginx-backup --selector <span class="string">'backup notin (ignore)'</span></span><br><span class="line"><span class="comment"># 使用app=nginx标签选择器根据 cron 表达式创建定期计划备份：</span></span><br><span class="line">$ velero schedule create nginx-daily --schedule=<span class="string">"0 1 * * *"</span> --selector app=nginx</span><br><span class="line"><span class="comment"># 或者，您可以使用一些非标准速记 cron 表达式：</span></span><br><span class="line">$ velero schedule create nginx-daily --schedule=<span class="string">"@daily"</span> --selector app=nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 velero 已备份的kubernetes应用数据</span></span><br><span class="line">$ velero backup get</span><br><span class="line">  <span class="comment"># NAME           STATUS      ERRORS   WARNINGS   CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR</span></span><br><span class="line">  <span class="comment"># nginx-backup   Completed   0        0          2021-08-06 19:04:21 +0800 CST   29d       default            app=nginx</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 4.容灾恢复实战流程示例</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.模拟灾难删除名称空间将会删除其下控制器。</span></span><br><span class="line">kubectl delete namespace nginx-example</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.要检查 nginx 部署和服务是否消失请运行。</span></span><br><span class="line">kubectl get deployments --namespace=nginx-example</span><br><span class="line">kubectl get services --namespace=nginx-example</span><br><span class="line">kubectl get namespace/nginx-example</span><br><span class="line">  <span class="comment"># Tips : 注意您可能需要等待几分钟才能完全清理命名空间。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.利用 velero 中得备份进行恢复刚才删除名称空间以及下面得各种控制器</span></span><br><span class="line">velero restore create --from-backup nginx-backup</span><br><span class="line">  <span class="comment"># Restore request "nginx-backup-20210806191516" submitted successfully.</span></span><br><span class="line">  <span class="comment"># Run `velero restore describe nginx-backup-20210806191516` or `velero restore logs nginx-backup-20210806191516` for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.备份还原 nginx-backup 状态查看, 成功恢复后该STATUS列Completed, 并WARNINGS和ERRORS为0的所有对象nginx-example的命名空间应该只是因为他们是你删除了他们面前。</span></span><br><span class="line">velero restore get</span><br><span class="line">  <span class="comment"># NAME                          BACKUP         STATUS      STARTED                         COMPLETED                       ERRORS   WARNINGS   CREATED                         SELECTOR</span></span><br><span class="line">  <span class="comment"># nginx-backup-20210806191516   nginx-backup   Completed   2021-08-06 19:15:16 +0800 CST   2021-08-06 19:15:16 +0800 CST   0        0          2021-08-06 19:15:16 +0800 CST   &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.如果有错误或警告可以详细查看,例如上述的 nginx-backup-20210806191516 还原记录。</span></span><br><span class="line">velero restore describe nginx-backup-20210806191516</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.查看还原的Nginx服务是否已经正常。</span></span><br><span class="line">kubectl get pod -l app=nginx</span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li>Step 5.删除您创建的任何备份，包括对象存储和持久卷快照中的数据你可以进行如下操作。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - 1.删除指定名称的备份</span></span><br><span class="line">$ velero backup delete nginx-backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># - 2.删除所有备份</span></span><br><span class="line">$ velero backup delete --all</span><br><span class="line">  <span class="comment"># Are you sure you want to continue (Y/N)? y</span></span><br><span class="line">  <span class="comment"># Request to delete backup "nginx-backup" submitted successfully.</span></span><br><span class="line">  <span class="comment"># The backup will be fully deleted after all associated data (disk snapshots, backup files, restores) are removed.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 3.完全删除后，运行时备份将不再可见：</span></span><br><span class="line">velero backup get nginx-backup</span><br></pre></td></tr></table></figure>
<p><br/></p>
<ul>
<li>Step 6.要从 Kubernetes 集群中完全卸载 Velero、minio 和 nginx 示例应用程序：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete namespace/velero clusterrolebinding/velero</span><br><span class="line">kubectl delete crds -l component=velero</span><br><span class="line">kubectl delete -f examples/nginx-app/base.yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<p>Tips : 在 Docker (KinD) 中使用 Kubernetes 在集群外公开 Minio<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.您可以使用端口转发来访问 Minio 存储桶。</span></span><br><span class="line">MINIO_POD=$(kubectl get pods -n velero -l component=minio -o jsonpath=<span class="string">'&#123;.items[0].metadata.name&#125;'</span>)</span><br><span class="line">kubectl port-forward <span class="variable">$MINIO_POD</span> -n velero 9000:9000 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.然后在另一个终端中执行如下命令, 并且将`publicUrl: http://localhost:9000`在该spec.config部分下添加。</span></span><br><span class="line">kubectl edit backupstoragelocation default -n velero</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="2-实战容灾恢复"><a href="#2-实战容灾恢复" class="headerlink" title="2.实战容灾恢复"></a>2.实战容灾恢复</h3><p><strong>环境说明:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- 自定义镜像: harbor.weiyigeek.top/devops/tomee:8.0.6-webprofile</span><br><span class="line">- 应用war包: HelloWorld-v1.43.war</span><br><span class="line">- 部署资源清单: HelloWorld.yaml </span><br><span class="line"> </span><br><span class="line">$ ls </span><br><span class="line">HelloWorld-v1.43.war  HelloWorld.yaml</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<ul>
<li>Step 1.部署资源清单一览（该应用演示包含动态持久化的<code>PVC/PV</code>卷 ）<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">deploy-maven-svc</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">java-maven</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span>         <span class="comment"># Service 类型</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">java-maven</span>       <span class="comment"># 【注意】与deployment资源控制器创建的Pod标签进行绑定;</span></span><br><span class="line"><span class="attr">    release:</span> <span class="string">stabel</span>       <span class="comment"># Service 服务发现不能缺少Pod标签，有了Pod标签才能与之SVC对应</span></span><br><span class="line"><span class="attr">  ports:</span>                  <span class="comment"># 映射端口</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span>              <span class="comment"># cluster 访问端口</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">8080</span>        <span class="comment"># Pod 容器内的服务端口</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30089</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">deploy-java-maven</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">java-maven</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">"deploy-maven-svc"</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span>                <span class="comment"># 副本数</span></span><br><span class="line"><span class="attr">  selector:</span>                  <span class="comment"># 选择器</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">java-maven</span>   <span class="comment"># 匹配的Pod标签非常重要</span></span><br><span class="line"><span class="attr">      release:</span> <span class="string">stabel</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">java-maven</span>      <span class="comment"># 模板标签</span></span><br><span class="line"><span class="attr">        release:</span> <span class="string">stabel</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      volumes:</span>                <span class="comment"># 关键点</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">webapps</span>         <span class="comment"># 卷名称</span></span><br><span class="line"><span class="attr">        hostPath:</span>             <span class="comment"># 采用hostPath卷</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">DirectoryOrCreate</span>   <span class="comment"># 卷类型DirectoryOrCreate: 如果子节点上没有该目录便会进行创建</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/nfsdisk-31/test/</span>  <span class="comment"># 各主机节点上已存在的目录此处是NFS共享</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">timezone</span>     <span class="comment"># 容器时区设置</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">java-maven</span></span><br><span class="line">        <span class="comment">#image: harbor.weiyigeek.top/devops/tomcat:8.5.61-jdk8-corretto  # 拉取的镜像</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">harbor.weiyigeek.top/devops/tomee:8.0.6-webprofile</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["bash","-c","rm</span> <span class="bullet">-rf</span> <span class="string">/usr/local/tomee/webapps/*</span> <span class="string">&amp;&amp;</span> <span class="string">cp</span> <span class="string">/tmp/$&#123;APPNAME&#125;</span> <span class="string">/usr/local/tomee/webapps/ROOT.war</span> <span class="string">&amp;&amp;</span> <span class="string">catalina.sh</span> <span class="string">run"]</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">APPNAME</span></span><br><span class="line"><span class="attr">            value:</span> <span class="string">HelloWorld-v1.43.war</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">http</span>         <span class="comment"># 此端口在服务中的名称</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">8080</span>  <span class="comment"># 容器暴露的端口</span></span><br><span class="line"><span class="attr">        volumeMounts:</span>        <span class="comment"># 挂载指定卷目录</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">webapps</span>      <span class="comment"># Tomcat 应用目录</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/tmp/</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">logs</span>         <span class="comment"># Tomcat 日志目录利用持久卷来进行存储。</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/local/tomee/logs</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">timezone</span>     <span class="comment"># 镜像时区设置</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span>      <span class="comment"># 卷的体积要求模板此处采用StorageClass存储类主要针对于应用日志的存储;</span></span><br><span class="line"><span class="attr">  - metadata:</span>                <span class="comment"># 根据模板自动创建PV与PVC并且进行一一对应绑定;</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">logs</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">managed-nfs-storage</span> <span class="comment"># StorageClass存储类</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<ul>
<li>Step 2.部署的<code>java-maven</code>应用信息查看</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 查看 k8s 部署的 java-maven 应用</span></span><br><span class="line">kubectl get pod,sts,svc -o wide -l app=java-maven</span><br><span class="line">  <span class="comment"># NAME                      READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># pod/deploy-java-maven-0   1/1     Running   0          2d8h</span></span><br><span class="line">  <span class="comment"># pod/deploy-java-maven-1   1/1     Running   0          2d8h</span></span><br><span class="line">  <span class="comment"># pod/deploy-java-maven-2   1/1     Running   0          2d8h</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                READY   AGE    CONTAINERS   IMAGES</span></span><br><span class="line">  <span class="comment"># deploy-java-maven   3/3     2d9h   java-maven   harbor.weiyigeek.top/devops/tomee:8.0.6-webprofile</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                       TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span></span><br><span class="line">  <span class="comment"># service/deploy-maven-svc   NodePort   10.106.80.8   &lt;none&gt;        8080:30089/TCP   2d9h</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 验证查看部署的服务</span></span><br><span class="line">$ curl 192.168.12.107:30089</span><br><span class="line">  <span class="comment"># &lt;p&gt; Server : Apache Tomcat (TomEE)/9.0.41 (8.0.6)  | 172.16.183.115 &lt;/p&gt;</span></span><br><span class="line">  <span class="comment"># &lt;p&gt; Client : 172.16.0.192 | 172.16.0.192&lt;/p&gt;</span></span><br><span class="line">  <span class="comment"># &lt;p&gt; Document_Root : /usr/local/tomee/webapps/ROOT/  &lt;br/&gt;&lt;br/&gt; URL : 10.106.80.8/index.jsp  &lt;/p&gt;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li>Step 3.利用velero备份集群中 java-maven 应用。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 指定备份带有 app=java-maven 标签的资源</span></span><br><span class="line">velero backup create java-maven --selector app=java-maven</span><br><span class="line">  <span class="comment"># Backup request "java-maven" submitted successfully.</span></span><br><span class="line">  <span class="comment"># Run `velero backup describe java-maven` or `velero backup logs java-maven` for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 查看备份的 java-maven 资源</span></span><br><span class="line">velero backup get</span><br><span class="line">  <span class="comment"># NAME         STATUS      ERRORS   WARNINGS   CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR</span></span><br><span class="line">  <span class="comment"># java-maven   Completed   0        0          2021-08-06 19:47:57 +0800 CST   29d       default            app=java-maven</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 备份的资源详细信息</span></span><br><span class="line">velero backup describe java-maven --details</span><br><span class="line">  <span class="comment"># Name:         java-maven</span></span><br><span class="line">  <span class="comment"># Namespace:    velero</span></span><br><span class="line">  <span class="comment"># Labels:       velero.io/storage-location=default</span></span><br><span class="line">  <span class="comment"># Annotations:  velero.io/source-cluster-k8s-gitversion=v1.19.6</span></span><br><span class="line">  <span class="comment">#               velero.io/source-cluster-k8s-major-version=1</span></span><br><span class="line">  <span class="comment">#               velero.io/source-cluster-k8s-minor-version=19</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Phase:  Completed</span></span><br><span class="line">  <span class="comment"># Errors:    0</span></span><br><span class="line">  <span class="comment"># Warnings:  0</span></span><br><span class="line">  <span class="comment"># Namespaces:</span></span><br><span class="line">  <span class="comment">#   Included:  *</span></span><br><span class="line">  <span class="comment">#   Excluded:  &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># Resources:</span></span><br><span class="line">  <span class="comment">#   Included:        *</span></span><br><span class="line">  <span class="comment">#   Excluded:        &lt;none&gt;</span></span><br><span class="line">  <span class="comment">#   Cluster-scoped:  auto</span></span><br><span class="line">  <span class="comment"># Label selector:  app=java-maven</span></span><br><span class="line">  <span class="comment"># Storage Location:  default</span></span><br><span class="line">  <span class="comment"># Velero-Native Snapshot PVs:  auto</span></span><br><span class="line">  <span class="comment"># TTL:  720h0m0s</span></span><br><span class="line">  <span class="comment"># Hooks:  &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># Backup Format Version:  1.1.0</span></span><br><span class="line">  <span class="comment"># Started:    2021-08-06 19:47:57 +0800 CST</span></span><br><span class="line">  <span class="comment"># Completed:  2021-08-06 19:47:59 +0800 CST</span></span><br><span class="line">  <span class="comment"># Expiration:  2021-09-05 19:47:57 +0800 CST</span></span><br><span class="line">  <span class="comment"># Total items to be backed up:  13</span></span><br><span class="line">  <span class="comment"># Items backed up:              13</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Resource List:</span></span><br><span class="line">  <span class="comment">#   apps/v1/ControllerRevision:</span></span><br><span class="line">  <span class="comment">#     - default/deploy-java-maven-7664b769</span></span><br><span class="line">  <span class="comment">#   apps/v1/StatefulSet:</span></span><br><span class="line">  <span class="comment">#     - default/deploy-java-maven</span></span><br><span class="line">  <span class="comment">#   v1/Endpoints:</span></span><br><span class="line">  <span class="comment">#     - default/deploy-maven-svc</span></span><br><span class="line">  <span class="comment">#   v1/PersistentVolume:  # 可以看见备份的 PV 相关信息</span></span><br><span class="line">  <span class="comment">#     - pvc-0a2c5013-db49-43f7-9e5f-5b29730b7938</span></span><br><span class="line">  <span class="comment">#     - pvc-0c77d4da-f703-4a58-bee2-0ce25d3e8630 </span></span><br><span class="line">  <span class="comment">#     - pvc-563bcd3c-d994-4e46-8d4e-50694706366e</span></span><br><span class="line">  <span class="comment">#   v1/PersistentVolumeClaim:</span></span><br><span class="line">  <span class="comment">#     - default/logs-deploy-java-maven-0</span></span><br><span class="line">  <span class="comment">#     - default/logs-deploy-java-maven-1</span></span><br><span class="line">  <span class="comment">#     - default/logs-deploy-java-maven-2</span></span><br><span class="line">  <span class="comment">#   v1/Pod:</span></span><br><span class="line">  <span class="comment">#     - default/deploy-java-maven-0</span></span><br><span class="line">  <span class="comment">#     - default/deploy-java-maven-1</span></span><br><span class="line">  <span class="comment">#     - default/deploy-java-maven-2</span></span><br><span class="line">  <span class="comment">#   v1/Service:</span></span><br><span class="line">  <span class="comment">#     - default/deploy-maven-svc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Velero-Native Snapshots: &lt;none included&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=18-Kubernetes进阶之应用与持久化数据卷备份迁移实践 href="https://img.weiyigeek.top/2021/5/20210806195828.png" target="_blank" title="WeiyiGeek.在Minio查看java-maven备份情况" data-fancybox="images"><img src="https://img.weiyigeek.top/2021/5/20210806195828.png" alt="WeiyiGeek.在Minio查看java-maven备份情况" title="" class=""></a>
                <p>WeiyiGeek.在Minio查看java-maven备份情况</p>
            </figure>
<ul>
<li>Step 4.此时我们模拟当不小心删除我们的<code>Java-maven</code>应用<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1</span></span><br><span class="line">kubectl delete sts deploy-java-maven</span><br><span class="line">  statefulset.apps <span class="string">"deploy-java-maven"</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2</span></span><br><span class="line">kubectl delete -f HelloWorld.yaml</span><br><span class="line">  service <span class="string">"deploy-maven-svc"</span> deleted</span><br><span class="line">  statefulset.apps <span class="string">"deploy-java-maven"</span> deleted</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<ul>
<li><p>Step 5.利用velero来恢复我们的<code>Java-maven</code>应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">velero restore create --from-backup java-maven</span><br><span class="line">  <span class="comment"># Restore request "java-maven-20210806204045" submitted successfully.</span></span><br><span class="line">  <span class="comment"># Run `velero restore describe java-maven-20210806204045` or `velero restore logs java-maven-20210806204045` for more details.</span></span><br><span class="line"></span><br><span class="line">velero restore get</span><br><span class="line">  <span class="comment"># java-maven-20210806204045   java-maven   Completed   2021-08-06 20:40:45 +0800 CST   2021-08-06 20:40:46 +0800 CST   0        0          2021-08-06 20:40:45 +0800 CST   &lt;none&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Step 6.恢复后验证我们的<code>Java-maven</code>应用是否正常。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -l app=java-maven</span><br><span class="line">  <span class="comment"># NAME                      READY   STATUS    RESTARTS   AGE</span></span><br><span class="line">  <span class="comment"># pod/deploy-java-maven-0   1/1     Running   0          64s</span></span><br><span class="line">  <span class="comment"># pod/deploy-java-maven-1   1/1     Running   0          64s</span></span><br><span class="line">  <span class="comment"># pod/deploy-java-maven-2   1/1     Running   0          64s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                       TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span></span><br><span class="line">  <span class="comment"># service/deploy-maven-svc   NodePort   10.111.226.31   &lt;none&gt;        8080:30089/TCP   64s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># NAME                                 READY   AGE</span></span><br><span class="line">  <span class="comment"># statefulset.apps/deploy-java-maven   3/3     64s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># kubectl get pv,pvc -l app=java-maven</span></span><br><span class="line">  <span class="comment"># NAME                                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span></span><br><span class="line">  <span class="comment"># persistentvolumeclaim/logs-deploy-java-maven-0   Bound    pvc-0a2c5013-db49-43f7-9e5f-5b29730b7938   1Gi        RWO            managed-nfs-storage   73s</span></span><br><span class="line">  <span class="comment"># persistentvolumeclaim/logs-deploy-java-maven-1   Bound    pvc-0c77d4da-f703-4a58-bee2-0ce25d3e8630   1Gi        RWO            managed-nfs-storage   73s</span></span><br><span class="line">  <span class="comment"># persistentvolumeclaim/logs-deploy-java-maven-2   Bound    pvc-563bcd3c-d994-4e46-8d4e-50694706366e   1Gi        RWO            managed-nfs-storage   73s</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="image-box">
                <a rel=18-Kubernetes进阶之应用与持久化数据卷备份迁移实践 href="https://img.weiyigeek.top/2021/5/20210807204059.png" target="_blank" title="WeiyiGeek.Java-maven应用状态" data-fancybox="images"><img src="https://img.weiyigeek.top/2021/5/20210807204059.png" alt="WeiyiGeek.Java-maven应用状态" title="" class=""></a>
                <p>WeiyiGeek.Java-maven应用状态</p>
            </figure>
<hr>
<h2 id="0x0n-入坑出坑"><a href="#0x0n-入坑出坑" class="headerlink" title="0x0n 入坑出坑"></a>0x0n 入坑出坑</h2><h3 id="1-采用Velero-1-6-2-提供得官方资源清单部署后从无法访问-MINIO-Web-UI-管理界面"><a href="#1-采用Velero-1-6-2-提供得官方资源清单部署后从无法访问-MINIO-Web-UI-管理界面" class="headerlink" title="1.采用Velero 1.6.2 提供得官方资源清单部署后从无法访问 MINIO Web-UI 管理界面"></a>1.采用Velero 1.6.2 提供得官方资源清单部署后从无法访问 <code>MINIO Web-UI</code> 管理界面</h3><ul>
<li>问题信息: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -n velero pod&#x2F;minio-5b84955bdd-ptfs7</span><br><span class="line">WARNING: MINIO_ACCESS_KEY and MINIO_SECRET_KEY are deprecated.</span><br><span class="line">         Please use MINIO_ROOT_USER and MINIO_ROOT_PASSWORD</span><br><span class="line">API: http:&#x2F;&#x2F;192.168.109.99:9000  http:&#x2F;&#x2F;127.0.0.1:9000</span><br><span class="line"></span><br><span class="line">Console: http:&#x2F;&#x2F;192.168.109.99:35735 http:&#x2F;&#x2F;127.0.0.1:35735</span><br><span class="line"></span><br><span class="line">Documentation: https:&#x2F;&#x2F;docs.min.io</span><br><span class="line"></span><br><span class="line">WARNING: Console endpoint is listening on a dynamic port (35735), please use --console-address &quot;:PORT&quot; to choose a static port.</span><br></pre></td></tr></table></figure></li>
<li>问题原因:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原因1.由上述得警告可知传递得minio账号密码得变量已变成如下，主要如不设置则默认credentials为'minioadmin:minioadmin'</span></span><br><span class="line">MINIO_ROOT_USER and MINIO_ROOT_PASSWORD</span><br><span class="line"></span><br><span class="line">docker run -p 30090:9000 \</span><br><span class="line">  -e <span class="string">"MINIO_ROOT_USER=admin"</span> \</span><br><span class="line">  -e <span class="string">"MINIO_ROOT_PASSWORD=password"</span> \</span><br><span class="line">  minio/minio server /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原因2.Console 端口默认是动态随机端口需要采用如下参数进行指定。</span></span><br><span class="line">--console-address <span class="string">":PORT"</span></span><br></pre></td></tr></table></figure></li>
<li>解决办法:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">- name: minio</span><br><span class="line">  image: minio/minio:latest</span><br><span class="line">  imagePullPolicy: IfNotPresent</span><br><span class="line">  args:</span><br><span class="line">  - server</span><br><span class="line">  - /storage</span><br><span class="line">  - --console-address </span><br><span class="line">  - <span class="string">":31234"</span></span><br><span class="line">  - --config-dir=/config</span><br><span class="line">  <span class="comment"># 关键点1</span></span><br><span class="line">  env:</span><br><span class="line">  - name: MINIO_ROOT_USER</span><br><span class="line">    value: <span class="string">"minio"</span></span><br><span class="line">  - name: MINIO_ROOT_PASSWORD</span><br><span class="line">    value: <span class="string">"minio123"</span></span><br><span class="line">  <span class="comment"># 关键点2</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    containerPort: 9000</span><br><span class="line">  - name: console</span><br><span class="line">    containerPort: 31234</span><br><span class="line">  volumeMounts:</span><br><span class="line">  - name: storage</span><br><span class="line">    mountPath: <span class="string">"/storage"</span></span><br><span class="line">  - name: config</span><br><span class="line">    mountPath: <span class="string">"/config"</span></span><br></pre></td></tr></table></figure></li>
</ul>

        </div>
        
        <!-- 微信公众号关注/文章版权复制 -->
        
        <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好看友,欢迎关注博主微信公众号哟! ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】即可关闭继续浏览文章.<br>  <b style="color:red;"> 温馨提示: 未解锁的用户不能粘贴复制文章内容哟!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
           

        <!-- Google 广告 -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2023-01-31T02:29:10.472Z" itemprop="dateUpdated">2023-01-31 10:29:10</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/虚拟云容/云容器/Kubernetes/18-Kubernetes进阶之应用与持久化数据卷备份迁移实践.md" target="_blank" rel="noopener noreferrer">_posts/虚拟云容/云容器/Kubernetes/18-Kubernetes进阶之应用与持久化数据卷备份迁移实践.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2021/7-27-575.html" target="_blank" rel="external">https://blog.weiyigeek.top/2021/7-27-575.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/7-27-575.html&title=《18-Kubernetes进阶之应用与持久化数据卷备份迁移实践》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/7-27-575.html&title=《18-Kubernetes进阶之应用与持久化数据卷备份迁移实践》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/7-27-575.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《18-Kubernetes进阶之应用与持久化数据卷备份迁移实践》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/7-27-575.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/7-27-575.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/7-30-623.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">4.最新实践基于Containerd安装部署高可用Kubernetes集群</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/7-22-646.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">SaltStack自动化运维工具实践指南</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-前言简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 前言简述</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-Velero-基础概述"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.Velero 基础概述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-Velero-工作原理"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2.Velero 工作原理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-Provider-插件供应商"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">3.Provider 插件供应商</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-补充说明"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">4.补充说明</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-环境部署"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 环境部署</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-先决条件"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.先决条件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-下载部署-Velero"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.下载部署 Velero</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-设置Minio服务器"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3.设置Minio服务器</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-备份迁移实践"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 备份迁移实践</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-官方示例"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.官方示例</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-实战容灾恢复"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.实战容灾恢复</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x0n-入坑出坑"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x0n 入坑出坑</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-采用Velero-1-6-2-提供得官方资源清单部署后从无法访问-MINIO-Web-UI-管理界面"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">1.采用Velero 1.6.2 提供得官方资源清单部署后从无法访问 MINIO Web-UI 管理界面</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
    <!-- 
  <div class="post-wechat" style="position:fixed;top: 360px;bottom: 500px;right: 3%;width: 190px;text-align: center;">
    <p><b>关注【全栈工程师修炼指南】</b></p>
    <img src="/img/wechat-gzh.jpg" class="img-responsive" alt="weiyigeek">
    <p><b>欢迎添加【作者】微信</b></p>
    <img src="/img/wehat.jpg" class="img-responsive" alt="weiyigeek">
  </div>
 -->

    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="/img/share-wechat.jpg" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">博主Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">博主Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">墨天轮</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">西瓜视频</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2023 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/7-27-575.html&title=《18-Kubernetes进阶之应用与持久化数据卷备份迁移实践》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/7-27-575.html&title=《18-Kubernetes进阶之应用与持久化数据卷备份迁移实践》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/7-27-575.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《18-Kubernetes进阶之应用与持久化数据卷备份迁移实践》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/7-27-575.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/7-27-575.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLUlEQVR42u3awW6EMAxF0fn/n6bbShVwnw0dxblZVUwJOVlEju3PB4/j1yC/Hn/G2Vv8Kw8MGTJkLMs4Lgf/AHmLkK6343QlMmTI2IDBp77eArJB119J2TJkyJDBw7jOk9r2yZAhQ8Z1uIamBhfUrx24MmTIWJBBLrHkYzzRRt565S4uQ4aMBRk86/7/f79S35AhQ8ZSjCMc6Wy1okK8KhkyZIxm8AOuFsx1Wjfi5g8ZMmRsxuCFydpCeQKOP5EhQ8ZsRpomSxeaJulq/y9DhozZjE4SPy0MdBovgqSbDBkyBjH40nko+Wy0hprGZMiQMZpBjrk0KUYO0E7D2c31VYYMGeMYPH7sN2zVigHoLRkyZGzA6LRZ9JNo/PnpPDJkyBjN4AviUxNwJ9F2s7kyZMgYx+gcpiRN9lRZ9CaElSFDxmgGOQr5RP0EXG3LZMiQMZuRtkSQRQQXzlodgwe9MmTIGMHoFCmfIpHgEh39MmTIGM1Ip+sUL9NWjDQVKEOGjKmMWhjHL6WdMmdQTpAhQ8Y2jKcaJtLr6DUSlTllyJCxDeOpUC/9tZ9VkyFDxlTGEY4atXbIko2QIUPGDoz0mKuVCtLMHw8Ti2VOGTJkLMioJchSRlqkTI9sGTJk7MBIm7R4i0a8IHz0y5AhQ0b/0lgrcPJg9JPuqwwZMjZjBB9oXHSD0oUMGTI2YNSaVkkqv3O8vpJukyFDxoKMTqdG5/JZuwa3AlYZMmSsx/gBFpa8Kn7C44EAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  





<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// 站点运行时间
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "天" + RunHours + "时" + RunMinutes + "分" + RunSeconds + "秒";
  document.getElementById(id).innerHTML = "网站已在风雨中勉勉强强运行了【" + RunTime + "】";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
    
  <div class="post-wechat" style="position:fixed;top: 360px;bottom: 500px;right: 3%;width: 190px;text-align: center;">
    <p><b>关注【全栈工程师修炼指南】</b></p>
    <img src="/img/wechat-gzh.jpg" class="img-responsive" alt="weiyigeek">
    <p><b>欢迎添加【作者】微信</b></p>
    <img src="/img/wehat.jpg" class="img-responsive" alt="weiyigeek">
  </div>

</body>
</html>