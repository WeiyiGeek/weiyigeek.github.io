<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Etcd">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/2018/1-1-1.html"  >
                <i class="icon icon-lg icon-mortar-board"></i>
                å­¦ä¹ ä¹‹è·¯
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-04-23T02:37:47.000Z" itemprop="datePublished" class="page-time">
  2020-04-23
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/æ•°æ®åº“ç»„ä»¶/EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-04-23 10:37:47" datetime="2020-04-23T02:37:47.000Z"  itemprop="datePublished">2020-04-23</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h4 id="0x00-Etcd-ç®€è¿°"><a href="#0x00-Etcd-ç®€è¿°" class="headerlink" title="0x00 Etcd ç®€è¿°"></a>0x00 Etcd ç®€è¿°</h4><p><strong>Etcdåº”ç”¨èƒŒæ™¯è¯´æ˜:</strong><br>åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæœ‰å¾ˆå¤šåº”ç”¨åœ¨åŒä¸€æ—¶åˆ»åªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹ï¼Œä¾‹å¦‚æ›´æ–°æ•°æ®åº“çš„æ“ä½œï¼Œå¤šä¸ªå®ä¾‹åŒæ—¶æ›´æ–°ä¸ä»…ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ï¼Œè¿˜å¯èƒ½å¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚ä½†æ˜¯å•ç‚¹éƒ¨ç½²ä¹Ÿä½¿å¾—ç³»ç»Ÿçš„å®¹ç¾æ€§å‡å¼±ï¼Œæ¯”å¦‚è¿›ç¨‹å¼‚å¸¸é€€å‡º<br>ç›®å‰è¿›ç¨‹ä¿æ´»ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ–¹æ¡ˆå¦‚<code>supervisorå’Œsystemd</code>ã€‚ä½†æ˜¯å¦‚æœå®¿ä¸»æœºdownæ‰å‘¢ï¼Ÿ<br>æ‰€æœ‰çš„è¿›ç¨‹ä¿æ´»æ–¹æ³•éƒ½ä¼šæ— æµäºäº‹ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥<code>é‡‡ç”¨åŸºäºetcdè‡ªå¸¦çš„leaderé€‰ä¸¾æœºåˆ¶</code>ï¼Œè½»æ¾çš„ä½¿æœåŠ¡å…·å¤‡äº†é«˜å¯ç”¨æ€§ã€‚</p>
<h5 id="1-åŸºç¡€"><a href="#1-åŸºç¡€" class="headerlink" title="1.åŸºç¡€"></a>1.åŸºç¡€</h5><p><em>Q:ä»€ä¹ˆæ˜¯Etcd?æœ‰ä½•ä½œç”¨?</em><br>ç­”:Etcd<code>(å‘éŸ³æ˜¯â€œet-cee-deeâ€)</code>ä½œ<code>ä¸ºå¼€æºã€åˆ†å¸ƒå¼ã€é«˜å¯ç”¨ã€å¼ºä¸€è‡´æ€§</code>çš„<code>key-valueå­˜å‚¨ç³»ç»Ÿ</code>(<code>é‡‡ç”¨Goå¼€å‘åˆ™è·¨å¹³å°</code>), å®ƒç”±CoreOSå›¢é˜Ÿå¼€å‘ï¼Œç°åœ¨ç”±Cloud Native Computing Foundationè´Ÿè´£ç®¡ç†ï¼Œæä¾›äº†é…ç½®å…±äº«å’ŒæœåŠ¡å‘ç°ç­‰ä¼—å¤šåŠŸèƒ½ã€‚å®ƒæ˜¯è®¸å¤šåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸»å¹²ï¼Œä¸ºè·¨æœåŠ¡å™¨é›†ç¾¤å­˜å‚¨æ•°æ®æä¾›å¯é çš„æ–¹å¼ã€‚</p>
<p>é€šè¿‡<code>raftç®—æ³•ç»´æŠ¤é›†ç¾¤</code>ä¸­å„ä¸ªèŠ‚ç‚¹çš„é€šä¿¡å’Œæ•°æ®ä¸€è‡´æ€§ï¼ŒèŠ‚ç‚¹ä¹‹é—´æ˜¯å¯¹ç­‰çš„å…³ç³»ï¼Œå³ä½¿leaderèŠ‚ç‚¹æ•…éšœä¼šå¾ˆå¿«é€‰ä¸¾å‡ºæ–°çš„leaderæ¥ä¿è¯ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œ;<br>ç›®å‰å·²å¹¿æ³›åº”ç”¨åœ¨<code>kubernetesã€ROOKã€CoreDNSã€M3ä»¥åŠopenstack</code>ç­‰é¢†åŸŸ</p>
<p>å®˜æ–¹åœ°å€&amp;æ–‡æ¡£: <a href="https://etcd.io/docs/" target="_blank" rel="noopener">https://etcd.io/docs/</a></p>
<p>è¡¥å……:<code>2020å¹´4æœˆ23æ—¥</code></p>
<ul>
<li>(1)Etcdå¯ç”¨ç‰ˆæœ¬ä¸€è§ˆè¯´æ˜<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* v3.4.x</span><br><span class="line">* v3.3.x</span><br><span class="line">* v3.2.x</span><br><span class="line">* v3.1.x</span><br><span class="line">* v2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<h5 id="2-ç‰¹æ€§"><a href="#2-ç‰¹æ€§" class="headerlink" title="2.ç‰¹æ€§"></a>2.ç‰¹æ€§</h5><ul>
<li>å®Œå…¨å¤åˆ¶ï¼šé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥ä½¿ç”¨å®Œæ•´çš„å­˜æ¡£</li>
<li>é«˜å¯ç”¨æ€§ï¼šEtcdå¯ç”¨äºé¿å…ç¡¬ä»¶çš„å•ç‚¹æ•…éšœæˆ–ç½‘ç»œé—®é¢˜</li>
<li>ä¸€è‡´æ€§ï¼šæ¯æ¬¡è¯»å–éƒ½ä¼šè¿”å›è·¨å¤šä¸»æœºçš„æœ€æ–°å†™å…¥åŸºç¡€(Raftç®—æ³•)</li>
<li>ç®€å•ï¼šåŒ…æ‹¬ä¸€ä¸ªå®šä¹‰è‰¯å¥½ã€é¢å‘ç”¨æˆ·çš„APIï¼ˆgRPCï¼‰</li>
<li>å®‰å…¨ï¼šå®ç°äº†å¸¦æœ‰å¯é€‰çš„å®¢æˆ·ç«¯è¯ä¹¦èº«ä»½éªŒè¯çš„è‡ªåŠ¨åŒ–TLS</li>
<li>å¿«é€Ÿï¼šæ¯ç§’10000æ¬¡å†™å…¥çš„åŸºå‡†é€Ÿåº¦</li>
<li>å¯é ï¼šä½¿ç”¨Raftç®—æ³•å®ç°äº†å­˜å‚¨çš„åˆç†åˆ†å¸ƒ</li>
</ul>
<p><strong>etcdæ¦‚å¿µè¯æ±‡è¡¨:</strong></p>
<ul>
<li>Raftï¼šetcdæ‰€é‡‡ç”¨çš„ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿå¼ºä¸€è‡´æ€§çš„ç®—æ³•ã€‚</li>
<li>Nodeï¼šä¸€ä¸ªRaftçŠ¶æ€æœºå®ä¾‹ã€‚</li>
<li>Memberï¼š ä¸€ä¸ªetcdå®ä¾‹ã€‚å®ƒç®¡ç†ç€ä¸€ä¸ªNodeï¼Œå¹¶ä¸”å¯ä»¥ä¸ºå®¢æˆ·ç«¯è¯·æ±‚æä¾›æœåŠ¡ã€‚</li>
<li>Clusterï¼šç”±å¤šä¸ªMemberæ„æˆå¯ä»¥ååŒå·¥ä½œçš„etcdé›†ç¾¤ã€‚</li>
<li>Peerï¼šå¯¹åŒä¸€ä¸ªetcdé›†ç¾¤ä¸­å¦å¤–ä¸€ä¸ªMemberçš„ç§°å‘¼ã€‚</li>
<li>Clientï¼š å‘etcdé›†ç¾¤å‘é€HTTPè¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚</li>
<li>WALï¼šé¢„å†™å¼æ—¥å¿—ï¼Œetcdç”¨äºæŒä¹…åŒ–å­˜å‚¨çš„æ—¥å¿—æ ¼å¼ã€‚</li>
<li>snapshotï¼šetcdé˜²æ­¢WALæ–‡ä»¶è¿‡å¤šè€Œè®¾ç½®çš„å¿«ç…§ï¼Œå­˜å‚¨etcdæ•°æ®çŠ¶æ€ã€‚</li>
<li>Proxyï¼šetcdçš„ä¸€ç§æ¨¡å¼ï¼Œä¸ºetcdé›†ç¾¤æä¾›åå‘ä»£ç†æœåŠ¡ã€‚</li>
<li>Leaderï¼šRaftç®—æ³•ä¸­é€šè¿‡ç«é€‰è€Œäº§ç”Ÿçš„å¤„ç†æ‰€æœ‰æ•°æ®æäº¤çš„èŠ‚ç‚¹ã€‚</li>
<li>Followerï¼šç«é€‰å¤±è´¥çš„èŠ‚ç‚¹ä½œä¸ºRaftä¸­çš„ä»å±èŠ‚ç‚¹ï¼Œä¸ºç®—æ³•æä¾›å¼ºä¸€è‡´æ€§ä¿è¯ã€‚</li>
<li>Candidateï¼šå½“Followerè¶…è¿‡ä¸€å®šæ—¶é—´æ¥æ”¶ä¸åˆ°Leaderçš„å¿ƒè·³æ—¶è½¬å˜ä¸ºCandidateå¼€å§‹ç«é€‰ã€‚</li>
<li>Termï¼šæŸä¸ªèŠ‚ç‚¹æˆä¸ºLeaderåˆ°ä¸‹ä¸€æ¬¡ç«é€‰æ—¶é—´ï¼Œç§°ä¸ºä¸€ä¸ªTermã€‚</li>
<li>Indexï¼šæ•°æ®é¡¹ç¼–å·ã€‚Raftä¸­é€šè¿‡Termå’ŒIndexæ¥å®šä½æ•°æ®ã€‚</li>
</ul>
<p><br/></p>
<h5 id="3-æ¶æ„"><a href="#3-æ¶æ„" class="headerlink" title="3.æ¶æ„"></a>3.æ¶æ„</h5><p>Etcdçš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åˆ†ä¸ºå››éƒ¨åˆ† <code>HTTP serverã€Storeã€Raftå’ŒWAL</code>ç»„æˆ:</p>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423103313.png" target="_blank" title="WeiyiGeek.Etcdçš„æ¶æ„" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423103313.png" alt="WeiyiGeek.Etcdçš„æ¶æ„" title="" class=""></a>
                <p>WeiyiGeek.Etcdçš„æ¶æ„</p>
            </figure>
<p>ç»„æˆéƒ¨åˆ†è¯´æ˜:</p>
<ul>
<li>HTTP server: ä¸ºç”¨æˆ·æä¾›çš„Apiè¯·æ±‚ã€‚</li>
<li>Store: ç”¨äºå¤„ç† etcd æ”¯æŒçš„å„ç±»åŠŸèƒ½çš„äº‹åŠ¡ï¼ŒåŒ…æ‹¬<code>æ•°æ®ç´¢å¼•ã€èŠ‚ç‚¹çŠ¶æ€å˜æ›´ã€ç›‘æ§ä¸åé¦ˆã€äº‹ä»¶å¤„ç†ä¸æ‰§è¡Œ</code>ç­‰ç­‰ã€‚</li>
<li>Raft: åˆ©ç”¨raftç®—æ³•<code>ä¿è¯èŠ‚ç‚¹ä¹‹é—´æ•°æ®çš„å¼ºä¸€è‡´æ€§</code>ã€‚</li>
<li>WAL: æ•°æ®å­˜å‚¨æ–¹å¼é€šè¿‡ WAL è¿›è¡Œæ•°æ®æŒä¹…åŒ–å­˜å‚¨<ul>
<li>Snapshot å­˜å‚¨æ•°æ®çš„çŠ¶æ€å¿«ç…§ï¼›</li>
<li>Entry è¡¨ç¤ºå­˜å‚¨çš„å…·ä½“æ—¥å¿—å†…å®¹ã€‚</li>
</ul>
</li>
</ul>
<p><br/></p>
<h5 id="4-å·¥ä½œåŸç†"><a href="#4-å·¥ä½œåŸç†" class="headerlink" title="4.å·¥ä½œåŸç†"></a>4.å·¥ä½œåŸç†</h5><p>ETCDé›†ç¾¤æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œ<code>æ¯ä¸ªETCDèŠ‚ç‚¹éƒ½ç»´æŠ¤äº†ä¸€ä¸ªçŠ¶æ€æœº</code>ï¼Œå¹¶ä¸”å­˜å‚¨äº†å®Œæ•´çš„æ•°æ®ï¼Œä»»æ„æ—¶åˆ»è‡³å¤šå­˜åœ¨ä¸€ä¸ªæœ‰æ•ˆçš„ä¸»èŠ‚ç‚¹ï¼Œè€Œä¸»èŠ‚ç‚¹å¤„ç†æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¯»å†™æ“ä½œã€‚<br><figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423103737.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423103737.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure></p>
<p>ä¸ºäº†æ›´å¥½çš„äº†è§£Etcdå·¥ä½œæœºåˆ¶æˆ‘ä»¬éœ€è¦äº†è§£ä¸‰ä¸ªæ¦‚å¿µï¼ˆä¹Ÿå°±æ˜¯ä¸‹å›¾æ‰€æƒ³è¡¨è¾¾ï¼‰</p>
<ul>
<li>leaders(æŒ‡æŒ¥): å¤„ç†æ‰€æœ‰éœ€è¦é›†ç¾¤ä¸€è‡´åå•†çš„å®¢æˆ·ç«¯è¯·æ±‚,å¹¶è´Ÿè´£æ¥å—æ–°çš„æ›´æ”¹ï¼Œå°†ä¿¡æ¯å¤åˆ¶åˆ°followerèŠ‚ç‚¹å¹¶åœ¨followeréªŒè¯æ¥å—åæäº¤æ›´æ”¹ï¼›<ul>
<li>æ³¨æ„:<code>æ¯ä¸ªé›†ç¾¤åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªleader</code></li>
</ul>
</li>
<li>elections(é€‰ä¸¾): æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªéšæœºçš„electionè®¡æ—¶å™¨ï¼Œè¯¥è®¡æ—¶å™¨è¡¨ç¤ºèŠ‚ç‚¹åœ¨è°ƒç”¨æ–°çš„electionä»¥åŠé€‰æ‹©è‡ªå·±ä½œä¸ºå€™é€‰ä¹‹å‰éœ€è¦ç­‰å¾…çš„æ—¶é—´ã€‚</li>
<li>Term(æœŸé™): å¦‚æœleaderæŒ‚äº†æˆ–è€…ä¸å†å“åº”äº†ï¼Œé‚£ä¹ˆå…¶ä»–èŠ‚ç‚¹å°†åœ¨é¢„å®šçš„æ—¶é—´è¶…æ—¶ä¹‹åå¼€å¯ä¸€ä¸ªæ–°çš„termæ¥åˆ›å»ºæ–°electionã€‚</li>
</ul>
<p>è¡¥å……æƒ…å†µè¯´æ˜:</p>
<ul>
<li>å¦‚æœèŠ‚ç‚¹åœ¨è¶…æ—¶å‘ç”Ÿä¹‹å‰æ²¡æœ‰æ”¶åˆ°leaderçš„æ¶ˆæ¯ï¼Œåˆ™è¯¥<code>èŠ‚ç‚¹å°†é€šè¿‡å¯åŠ¨æ–°çš„termå°†è‡ªå·±æ ‡è®°ä¸ºå€™é€‰</code>ï¼Œå¹¶è¦æ±‚å…¶ä»–èŠ‚ç‚¹æŠ•ç¥¨æ¥å¼€å§‹æ–°çš„election(æ¯ä¸ªèŠ‚ç‚¹æŠ•ç¥¨ç»™è¯·æ±‚å…¶æŠ•ç¥¨çš„ç¬¬ä¸€ä¸ªå€™é€‰)ã€‚</li>
<li>å¦‚æœå€™é€‰ä»é›†ç¾¤ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹å¤„è·å¾—äº†é€‰ç¥¨ï¼Œé‚£ä¹ˆå®ƒå°±æˆä¸ºäº†æ–°çš„leaderã€‚</li>
<li>å¦‚æœå­˜åœ¨å¤šä¸ªå€™é€‰ä¸”è·å¾—äº†ç›¸åŒæ•°é‡çš„é€‰ç¥¨ï¼Œé‚£ä¹ˆç°æœ‰çš„election termå°†åœ¨æ²¡æœ‰leaderçš„æƒ…å†µä¸‹ç»“æŸï¼Œè€Œæ–°çš„termå°†ä»¥æ–°çš„éšæœºé€‰ä¸¾è®¡æ—¶å™¨å¼€å§‹ã€‚</li>
</ul>
<p><em>Q:ä¸Šé¢æ‰€è¯‰å®é™…å°±æ˜¯é€‰æ‹©ä¸»æœºåˆ¶ï¼Œé‚£ä»€ä¹ˆæ˜¯é€‰ä¸»æœºåˆ¶å‘¢</em><br>ç­”:ä¸¾ä¸ªä¾‹å­åœ¨å†›äº‹æ¼”ä¹ ä¸­ï¼Œæˆ‘ä»¬æ€»ä¼šå‘ç°æŸæ¶é¢„è­¦æœºå‘¨å›´åˆ†å¸ƒç€å¤šæ¶æˆ˜æ–—æœºå’Œæ­¼å‡»æœºï¼Œä»–ä»¬ç»Ÿä¸€å¬ä»é¢„è­¦æœºçš„è°ƒåº¦ï¼Œæœ‰åºçš„å®Œæˆæ¶ˆç­æ•Œå†›çš„ä»»åŠ¡ã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªé›†ç¾¤ä¸­ï¼Œé¢„è­¦æœºå°±ç±»ä¼¼äºæˆ‘ä»¬é€‰ä¸»ä¸­çš„masterï¼ŒæŸä¸ªé›†ç¾¤æœ‰ä¸”åªæœ‰ä¸€ä¸ªmasterï¼Œå®Œæˆä»»åŠ¡çš„åˆ†å‘ç­‰å·¥ä½œï¼Œå…¶ä»–èŠ‚ç‚¹é…åˆè¡ŒåŠ¨ï¼Œå½“è¿™ä¸ªmasterèŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼Œè¦èƒ½å¤Ÿç«‹åˆ»é€‰å‡ºæ–°çš„èŠ‚ç‚¹ä½œä¸ºmasterã€‚</p>
<p><br/></p>
<p>å¦‚ä¸Šæ‰€è¿°: <code>ä¸€ä¸ªåŸºäºRaftçš„ç³»ç»Ÿä¸­ï¼Œé›†ç¾¤ä½¿ç”¨electionsä¸ºç»™å®šçš„termé€‰æ‹©leaderã€‚</code></p>
<ul>
<li>ä»»ä½•æ›´æ”¹éƒ½å¿…é¡»è¿æ¥åˆ°leaderèŠ‚ç‚¹ã€‚</li>
<li>Etcdæ²¡æœ‰ç«‹å³æ¥å—å’Œæäº¤æ›´æ”¹ï¼Œè€Œæ˜¯ä½¿ç”¨Raftç®—æ³•ç¡®ä¿å¤§å¤šæ•°èŠ‚ç‚¹éƒ½åŒæ„æ›´æ”¹ã€‚</li>
<li>Leaderå°†æè®®çš„æ–°å€¼å‘é€åˆ°é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹,ç„¶åèŠ‚ç‚¹å‘é€ä¸€æ¡æ¶ˆæ¯ç¡®è®¤æ”¶åˆ°äº†æ–°å€¼ã€‚</li>
<li>å¦‚æœå¤§å¤šæ•°èŠ‚ç‚¹ç¡®è®¤æ¥æ”¶ï¼Œé‚£ä¹ˆleaderæäº¤æ–°å€¼ï¼Œå¹¶å‘æ¯ä¸ªèŠ‚ç‚¹å‘é€å°†è¯¥å€¼æäº¤åˆ°æ—¥å¿—çš„æ¶ˆæ¯(<code>æ„å‘³ç€æ¯æ¬¡æ›´æ”¹éƒ½éœ€è¦å¾—åˆ°é›†ç¾¤èŠ‚ç‚¹çš„ä»²è£æ‰èƒ½æäº¤</code>)</li>
</ul>
<p>é€šè¿‡ä¸Šé¢åŸºæœ¬äº†è§£æˆ‘ä»¬å†æ¥çœ‹<code>Replicate State Machine</code>çŠ¶æ€è½¬æ¢è§„åˆ™ï¼š<code>ETCDä¸­æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€é›†åˆä¸ºï¼ˆFollowerã€Candidateã€Leaderï¼‰</code></p>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423105732.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423105732.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p>æµç¨‹å£°æ˜:</p>
<ul>
<li>(1) é›†ç¾¤åˆå§‹åŒ–æ—¶å€™æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯Followerè§’è‰²ï¼Œå½“Followeråœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ¥è‡ªä¸»èŠ‚ç‚¹çš„å¿ƒè·³ï¼Œä¼šå°†è‡ªå·±è§’è‰²æ”¹å˜ä¸ºCandidateï¼Œå¹¶å‘èµ·ä¸€æ¬¡é€‰ä¸»æŠ•ç¥¨ï¼›</li>
<li>(2) å½“æ”¶åˆ°åŒ…æ‹¬è‡ªå·±åœ¨å†…è¶…è¿‡åŠæ•°èŠ‚ç‚¹èµæˆå<code>ï¼ˆé€‰ä¸¾æˆåŠŸï¼‰</code>ï¼›å½“æ”¶åˆ°ç¥¨æ•°ä¸è¶³åŠæ•°<code>é€‰ä¸¾å¤±è´¥æˆ–è€…é€‰ä¸¾è¶…æ—¶</code>,æ³¨æ„è‹¥æœ¬è½®æœªé€‰å‡ºä¸»èŠ‚ç‚¹å°†è¿›è¡Œä¸‹ä¸€è½®é€‰ä¸¾ã€‚</li>
<li>(3) å½“æŸä¸ªCandidateèŠ‚ç‚¹æˆä¸ºLeaderåï¼ŒLeaderèŠ‚ç‚¹ä¼šé€šè¿‡å¿ƒè·³ä¸å…¶ä»–èŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼ŒåŒæ—¶å‚ä¸ç«é€‰çš„CandidateèŠ‚ç‚¹è¿›å…¥Followerè§’è‰²ã€‚</li>
</ul>
<hr>
<h4 id="0x01-å®‰è£…éƒ¨ç½²"><a href="#0x01-å®‰è£…éƒ¨ç½²" class="headerlink" title="0x01 å®‰è£…éƒ¨ç½²"></a>0x01 å®‰è£…éƒ¨ç½²</h4><p><strong>(1)ç¡¬ä»¶å»ºè®®</strong></p>
<ul>
<li>å®˜æ–¹etcdæ€§èƒ½åŸºå‡†æµ‹è¯•:åœ¨8ä¸ª<code>vCPUã€16GB RAMã€50GB SSD GCE</code>å®ä¾‹ä¸Šè¿è¡Œetcd(<code>ç”Ÿäº§ç¯å¢ƒä¸­æ¨èæŒ‰ç…§å®˜æ–¹é…ç½®è¿›è¡Œè‡ªå®šä¹‰èµ„æºé…ç½®</code>)</li>
<li>ä½†æ˜¯å¯¹äºæµ‹è¯•æ¥è¯´ä»»ä½•å…·æœ‰ä½å»¶è¿Ÿå­˜å‚¨å’Œå‡ gbå†…å­˜çš„ç›¸å¯¹ç°ä»£çš„æœºå™¨éƒ½åº”è¯¥è¶³å¤Ÿäº†ï¼Œæ³¨æ„æ‹¥æœ‰å¤§å‹v2æ•°æ®å­˜å‚¨çš„åº”ç”¨ç¨‹åºå°†éœ€è¦æ¯”å¤§å‹v3æ•°æ®å­˜å‚¨æ›´å¤šçš„å†…å­˜ï¼Œ<code>å› ä¸ºæ•°æ®ä¿å­˜åœ¨åŒ¿åå†…å­˜ä¸­è€Œä¸æ˜¯ä»æ–‡ä»¶æ˜ å°„å†…å­˜</code>;</li>
</ul>
<p>æ³¨æ„äº‹é¡¹:</p>
<ul>
<li>Etcdä¼šå°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œå› æ­¤å¼ºçƒˆ<code>æ¨èä½¿ç”¨SSD</code></li>
<li>å§‹ç»ˆä½¿ç”¨<code>å¥‡æ•°ä¸ªé›†ç¾¤æ•°é‡</code>ï¼Œå› ä¸ºéœ€è¦é€šè¿‡ä»²è£æ¥æ›´æ–°é›†ç¾¤çš„çŠ¶æ€</li>
<li>å‡ºäºæ€§èƒ½è€ƒè™‘é›†ç¾¤é€šå¸¸<code>ä¸è¶…è¿‡7ä¸ªèŠ‚ç‚¹</code></li>
</ul>
<p>å•æœºå®ä¾‹å®‰è£…æ–¹å¼:</p>
<ul>
<li>é¢„æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶:<a href="https://github.com/etcd-io/etcd/releases/" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases/</a></li>
<li>æ„å»ºæœ€æ–°ç‰ˆæœ¬: <a href="https://github.com/etcd-io/etcd.git" target="_blank" rel="noopener">https://github.com/etcd-io/etcd.git</a> </li>
<li>é‡‡ç”¨goç¬¬ä¸‰æ–¹åŒ…æ„å»º</li>
</ul>
<p>æ­¤å¤„æˆ‘ä»¬é‡‡ç”¨Buildçš„æ–¹å¼è¿›è¡Œå®‰è£…Etcdï¼Œå…·ä½“çš„å®ç°æµç¨‹å¦‚ä¸‹;</p>
<p><strong>(2)å®‰è£…æµç¨‹</strong><br>Step1.Goç¯å¢ƒå®‰è£…é‡‡ç”¨äºŒè¿›åˆ¶åŒ…ç›´æ¥è§£å‹å®‰è£…<code>https://golang.org/dl/</code>(è‡ªå¸¦æ¢¯å­)ï¼Œä¸”ç‰ˆæœ¬å¿…é¡»åœ¨1.13ä»¥ä¸Š;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">wget https://studygolang.com/dl/golang/go1.14.2.linux-amd64.tar.gz -O /opt/go1.14.2.linux-amd64.tar.gz</span><br><span class="line">tar -zxf /opt/go1.14.2.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="comment">#åœ¨/root/.profileè¿›è¡Œæ·»åŠ </span></span><br><span class="line">cat &gt;&gt; /etc/profile&lt;&lt;END</span><br><span class="line"><span class="comment">#Goç¯å¢ƒé…ç½®</span></span><br><span class="line"><span class="built_in">export</span> GOROOT=/usr/<span class="built_in">local</span>/go</span><br><span class="line"><span class="comment">#ç¬¬ä¸‰æ–¹åŒ…çš„å®‰è£…åŒ…è·¯å¾„</span></span><br><span class="line"><span class="built_in">export</span> GOBIN=\<span class="variable">$GOROOT</span>/bin</span><br><span class="line"><span class="built_in">export</span> GOPATH=\<span class="variable">$GOROOT</span>/path</span><br><span class="line"><span class="built_in">export</span> PATH=\<span class="variable">$PATH</span>:\<span class="variable">$GOBIN</span>:\<span class="variable">$GOPATH</span></span><br><span class="line">END</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line">mkdir -vp /usr/<span class="built_in">local</span>/go/path</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/go/bin/* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">go version</span><br></pre></td></tr></table></figure></p>
<p>Step2.å¦‚æœä½¿ç”¨å®˜æ–¹æ„å»ºè„šæœ¬ä»ä¸»åˆ†æ”¯æ„å»ºetcdæˆ‘ä»¬å…ˆè¿›è¡ŒCloneç„¶åbuildå³å¯(<code>å¦‚ä½•é‡‡ç”¨æ­¤ç§æ–¹å¼å®‰è£…å°±ä¸éœ€è¦ç¬¬ä¸‰æ­¥äº†</code>)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy <span class="string">'socks5://10.20.172.135:2083'</span></span><br><span class="line"><span class="built_in">cd</span> etcd</span><br><span class="line">./build</span><br></pre></td></tr></table></figure></p>
<p>Step3.å¦‚æœé€šè¿‡go getä»ä¸»åˆ†æ”¯æ„å»ºä¸€ä¸ªvendored etcd(<code>ä¸€é”®è·å–ä»£ç ã€ç¼–è¯‘å¹¶å®‰è£…</code>), æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³<code>/usr/local/go/path</code>Goç¬¬ä¸‰æ–¹åŒ…å®‰è£…ç›®å½•ä¸­çœ‹è§ä¸‹è½½æ–‡ä»¶;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="variable">$GOPATH</span>  <span class="comment"># /usr/local/go/path</span></span><br><span class="line">go get -v go.etcd.io/etcd</span><br><span class="line">go get -v go.etcd.io/etcd/etcdctl</span><br></pre></td></tr></table></figure></p>
<p>Step4.æµ‹è¯•å®‰è£…é€šè¿‡å¯åŠ¨etcdå¹¶è®¾ç½®å¯†é’¥ï¼Œæ£€æŸ¥etcdäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦æ­£ç¡®æ„å»ºã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./usr/<span class="built_in">local</span>/go/path/bin/etcd</span><br><span class="line">&#123;<span class="string">"level"</span>:<span class="string">"warn"</span>,<span class="string">"ts"</span>:<span class="string">"2020-04-23T15:12:17.368+0800"</span>,<span class="string">"caller"</span>:<span class="string">"etcdmain/etcd.go:89"</span>,<span class="string">"msg"</span>:<span class="string">"'data-dir' was empty; using default"</span>,<span class="string">"data-dir"</span>:<span class="string">"default.etcd"</span>&#125;</span><br><span class="line">&#123;<span class="string">"level"</span>:<span class="string">"info"</span>,<span class="string">"ts"</span>:<span class="string">"2020-04-23T15:12:17.368+0800"</span>,<span class="string">"caller"</span>:<span class="string">"embed/etcd.go:113"</span>,<span class="string">"msg"</span>:<span class="string">"configuring peer listeners"</span>,<span class="string">"listen-peer-urls"</span>:[<span class="string">"http://localhost:2380"</span>]&#125;</span><br><span class="line">&#123;<span class="string">"level"</span>:<span class="string">"info"</span>,<span class="string">"ts"</span>:<span class="string">"2020-04-23T15:12:17.990+0800"</span>,<span class="string">"caller"</span>:<span class="string">"membership/cluster.go:524"</span>,<span class="string">"msg"</span>:<span class="string">"set initial cluster version"</span>,<span class="string">"cluster-id"</span>:<span class="string">"cdf818194e3a8c32"</span>,<span class="string">"local-member-id"</span>:<span class="string">"8e9e05c52164694d"</span>,<span class="string">"cluster-version"</span>:<span class="string">"3.5"</span>&#125;</span><br><span class="line">&#123;<span class="string">"level"</span>:<span class="string">"info"</span>,<span class="string">"ts"</span>:<span class="string">"2020-04-23T15:12:17.990+0800"</span>,<span class="string">"caller"</span>:<span class="string">"etcdserver/server.go:1850"</span>,<span class="string">"msg"</span>:<span class="string">"published local member to cluster through raft"</span>,<span class="string">"local-member-id"</span>:<span class="string">"8e9e05c52164694d"</span>,<span class="string">"local-member-attributes"</span>:<span class="string">"&#123;Name:default ClientURLs:[http://localhost:2379]&#125;"</span>,<span class="string">"request-path"</span>:<span class="string">"/0/members/8e9e05c52164694d/attributes"</span>,<span class="string">"cluster-id"</span>:<span class="string">"cdf818194e3a8c32"</span>,<span class="string">"publish-timeout"</span>:<span class="string">"7s"</span>&#125;</span><br><span class="line">&#123;<span class="string">"level"</span>:<span class="string">"info"</span>,<span class="string">"ts"</span>:<span class="string">"2020-04-23T15:12:17.991+0800"</span>,<span class="string">"caller"</span>:<span class="string">"embed/serve.go:139"</span>,<span class="string">"msg"</span>:<span class="string">"serving client traffic insecurely; this is strongly discouraged!"</span>,<span class="string">"address"</span>:<span class="string">"127.0.0.1:2379"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step5.putä¸€ä¸ªå…³é”®key-valueè¿›è¡Œæµ‹è¯•<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¦‚æœOKè¢«æ‰“å°ï¼Œé‚£ä¹ˆetcdæ­£åœ¨å·¥ä½œ</span></span><br><span class="line">[root@initiator bin]<span class="comment"># /usr/local/go/bin/etcdctl put name WeiyiGeek</span></span><br><span class="line">OK</span><br><span class="line">[root@initiator bin]<span class="comment"># /usr/local/go/bin/etcdctl get name</span></span><br><span class="line">name</span><br><span class="line">WeiyiGeek</span><br><span class="line">[root@node3 ~]<span class="comment"># etcdctl --endpoints=$ENDPOINTS --write-out="json" get  name</span></span><br><span class="line">&#123;<span class="string">"header"</span>:&#123;<span class="string">"cluster_id"</span>:2819294416482393232,<span class="string">"member_id"</span>:17704130064291257467,<span class="string">"revision"</span>:7300,<span class="string">"raft_term"</span>:301&#125;,<span class="string">"kvs"</span>:[&#123;<span class="string">"key"</span>:<span class="string">"bmFtZQ=="</span>,<span class="string">"create_revision"</span>:7300,<span class="string">"mod_revision"</span>:7300,<span class="string">"version"</span>:1,<span class="string">"value"</span>:<span class="string">"V2VpeWlHZWVr"</span>&#125;],<span class="string">"count"</span>:1&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step6.è‡³æ­¤ç®€å•å®ä¾‹çš„etcdå®‰è£…å®Œæˆ;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¡¥å……etcdæœåŠ¡å¯åŠ¨çš„æ—¶å€™å¼€æ”¾äº†ä¸¤ä¸ªç«¯å£ï¼ˆé»˜è®¤åªèƒ½æœ¬æœºè®¿é—®ï¼‰</span></span><br><span class="line">tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      108333/./etcd  <span class="comment">#å®¢æˆ·ç«¯ä½¿ç”¨</span></span><br><span class="line">tcp        0      0 127.0.0.1:2380          0.0.0.0:*               LISTEN      108333/./etcd  <span class="comment">#å¯¹ç­‰etcd peerä½¿ç”¨ï¼ˆé›†ç¾¤ä½¿ç”¨ï¼‰</span></span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒ:</p>
<ul>
<li><a href="https://etcd.io/docs/v3.4.0/dl-build/" target="_blank" rel="noopener">https://etcd.io/docs/v3.4.0/dl-build/</a></li>
<li>Docker|macOS (Darwin) : <a href="https://github.com/etcd-io/etcd/releases/" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases/</a> </li>
</ul>
<p><br></p>
<h5 id="å…¶å®ƒæ“ä½œetcd"><a href="#å…¶å®ƒæ“ä½œetcd" class="headerlink" title="å…¶å®ƒæ“ä½œetcd"></a>å…¶å®ƒæ“ä½œetcd</h5><p>é™¤äº†é‡‡ç”¨etcdctlå‘½ä»¤è¿›è¡Œæ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨CURLå‘½ä»¤é‡‡ç”¨GET/PUTæ–¹å¼æ“ä½œetcdä¸­çš„æ•°æ®ï¼Œä½†æ˜¯<code>æ³¨æ„V2/V3ç‰ˆæœ¬çš„äº›è®¸ä¸åŒ</code>;<br>è¡¥å……çŸ¥è¯†:<code>[2020å¹´4æœˆ26æ—¥ 10:20:57]</code><br>åŸå­CASæ“ä½œ<code>ï¼ˆCompare And Swapï¼‰</code>: åŸºæœ¬ç”¨é€”å°±æ˜¯åˆ›å»ºåˆ†å¸ƒå¼çš„é”æœåŠ¡ï¼Œå³é€‰ä¸»ä»…å½“å®¢æˆ·ç«¯æä¾›çš„æ¡ä»¶ç­‰äºå½“å‰etcdçš„æ¡ä»¶æ—¶ï¼Œæ‰ä¼šä¿®æ”¹ä¸€ä¸ªkeyçš„å€¼ã€‚<br>å½“å‰æä¾›çš„å¯ä»¥æ¯”è¾ƒçš„æ¡ä»¶æœ‰ï¼š</p>
<ul>
<li>prevExistï¼šæ£€æŸ¥keyæ˜¯å¦å­˜åœ¨ã€‚å¦‚æœprevExistä¸ºtrueæ›´æ–°è¯·æ±‚ï¼Œå¦‚æœprevExistçš„å€¼æ˜¯falseåˆ›å»ºè¯·æ±‚</li>
<li>prevValueï¼šæ£€æŸ¥keyä¹‹å‰çš„value</li>
<li>prevIndexï¼šæ£€æŸ¥keyä»¥å‰çš„modifiedIndex</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## [é€šç”¨æ–¹å¼]</span></span><br><span class="line"><span class="comment">#ç‰ˆæœ¬æŸ¥çœ‹</span></span><br><span class="line">curl -X GET http://192.168.10.243:2379/version</span><br><span class="line"><span class="comment">#å¥åº·çŠ¶æ€</span></span><br><span class="line">curl -L http://192.168.10.243:2379/health</span><br><span class="line"><span class="comment">#åº¦é‡æŸ¥çœ‹</span></span><br><span class="line">curl -sL http://localhost:22379/metrics</span><br></pre></td></tr></table></figure>
<p>[version 2]<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹æ‰€æœ‰é”®å¹¶ä»¥jsonæ ¼å¼æ˜¾ç¤º</span></span><br><span class="line">curl -LsS http://192.168.10.243:2379/v2/keys | python -mjson.tool</span><br><span class="line"><span class="comment"># put:æ–°å»ºkeyå€¼ä¸ºkeyname valueä¸ºâ€œWeiyiGeekdâ€</span></span><br><span class="line">curl -X PUT -L http://192.168.10.243:2379/v2/keys/keyname -d value=<span class="string">"WeiyiGeek"</span></span><br><span class="line"><span class="comment"># get:æŸ¥çœ‹key</span></span><br><span class="line">curl -X GET -L http://192.168.10.243:2379/v2/keys/keyname</span><br><span class="line"><span class="comment"># delete:åˆ é™¤key</span></span><br><span class="line">curl -X DELETE -L http://127.0.0.1:2379/v2/keys/keyname</span><br><span class="line"><span class="comment"># æ–°å»ºTTLçš„key</span></span><br><span class="line">curl -X PUT http://127.0.0.1:2379/v2/keys/message -d value=<span class="string">"Hello world"</span> -d ttl=30</span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/message</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"get"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/message"</span>,<span class="string">"value"</span>:<span class="string">"Hello world"</span>,<span class="string">"expiration"</span>:<span class="string">"2019-09-29T08:08:10.674930705Z"</span>,<span class="string">"ttl"</span>:2,<span class="string">"modifiedIndex"</span>:20,<span class="string">"createdIndex"</span>:20&#125;&#125;</span><br><span class="line"><span class="comment"># å–æ¶ˆkeyçš„TTL</span></span><br><span class="line">curl -X PUT http://127.0.0.1:2379/v2/keys/message -d value=<span class="string">"Hello world"</span> -d ttl= -d prevExist=<span class="literal">true</span></span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"update"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/message"</span>,<span class="string">"value"</span>:<span class="string">"Hello world"</span>,<span class="string">"modifiedIndex"</span>:23,<span class="string">"createdIndex"</span>:22&#125;,<span class="string">"prevNode"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/message"</span>,<span class="string">"value"</span>:<span class="string">"Hello world"</span>,<span class="string">"expiration"</span>:<span class="string">"2019-09-29T08:10:23.220573683Z"</span>,<span class="string">"ttl"</span>:16,<span class="string">"modifiedIndex"</span>:22,<span class="string">"createdIndex"</span>:22&#125;&#125;</span><br><span class="line"><span class="comment"># é‡ç½®keyçš„TTL</span></span><br><span class="line">curl -X PUT http://127.0.0.1:2379/v2/keys/message -d ttl=30 -d refresh=<span class="literal">true</span> -d prevExist=<span class="literal">true</span></span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"update"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/message"</span>,<span class="string">"value"</span>:<span class="string">"Hello world"</span>,<span class="string">"expiration"</span>:<span class="string">"2019-09-29T08:15:29.569276199Z"</span>,<span class="string">"ttl"</span>:30,<span class="string">"modifiedIndex"</span>:26,<span class="string">"createdIndex"</span>:25&#125;,<span class="string">"prevNode"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/message"</span>,<span class="string">"value"</span>:<span class="string">"Hello world"</span>,<span class="string">"expiration"</span>:<span class="string">"2019-09-29T08:15:01.34698273Z"</span>,<span class="string">"ttl"</span>:2,<span class="string">"modifiedIndex"</span>:25,<span class="string">"createdIndex"</span>:25&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å»ºå¸¦æœ‰TTLçš„ç›®å½•</span></span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/dir -d ttl=30 -d dir=<span class="literal">true</span></span><br><span class="line"><span class="comment"># åœ¨TTLåˆ°æœŸå‰æ›´æ–°è¯¥ç›®å½•çš„TTL</span></span><br><span class="line">curl -X PUT http://127.0.0.1:2379/v2/keys/dir -d ttl=60 -d dir=<span class="literal">true</span> -d prevExist=<span class="literal">true</span></span><br><span class="line"><span class="comment"># å‘è¯¥ç›®å½•æ’å…¥æ•°æ®</span></span><br><span class="line">curl -X PUT http://127.0.0.1:2379/v2/keys/dir/message -d value=<span class="string">"Hello world"</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¯¥ç›®å½•ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯è¯¥ç›®å½•åˆ°æœŸåæ•°æ®ä¼šè¢«è‡ªåŠ¨åˆ é™¤</span></span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/dir/message</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"get"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/dir/message"</span>,<span class="string">"value"</span>:<span class="string">"Hello world"</span>,<span class="string">"modifiedIndex"</span>:51,<span class="string">"createdIndex"</span>:51&#125;&#125;</span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/dir/message</span><br><span class="line">&#123;<span class="string">"errorCode"</span>:100,<span class="string">"message"</span>:<span class="string">"Key not found"</span>,<span class="string">"cause"</span>:<span class="string">"/dir"</span>,<span class="string">"index"</span>:52&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨åˆ›å»ºæœ‰åºçš„key</span></span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/queue -XPOST -d value=Job1</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000042"</span>,<span class="string">"value"</span>:<span class="string">"Job1"</span>,<span class="string">"modifiedIndex"</span>:42,<span class="string">"createdIndex"</span>:42&#125;&#125;</span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/queue -XPOST -d value=Job2</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000043"</span>,<span class="string">"value"</span>:<span class="string">"Job2"</span>,<span class="string">"modifiedIndex"</span>:43,<span class="string">"createdIndex"</span>:43&#125;&#125;</span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/queue -XPOST -d value=Job3</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000044"</span>,<span class="string">"value"</span>:<span class="string">"Job3"</span>,<span class="string">"modifiedIndex"</span>:44,<span class="string">"createdIndex"</span>:44&#125;&#125;</span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/queue -XPOST -d value=Job4</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000045"</span>,<span class="string">"value"</span>:<span class="string">"Job4"</span>,<span class="string">"modifiedIndex"</span>:45,<span class="string">"createdIndex"</span>:45&#125;&#125;</span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/queue -XPOST -d value=Job5</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000046"</span>,<span class="string">"value"</span>:<span class="string">"Job5"</span>,<span class="string">"modifiedIndex"</span>:46,<span class="string">"createdIndex"</span>:46&#125;&#125; </span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/queue -XPOST -d value=Job6</span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000047"</span>,<span class="string">"value"</span>:<span class="string">"Job6"</span>,<span class="string">"modifiedIndex"</span>:47,<span class="string">"createdIndex"</span>:47&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åˆ›å»ºæœ‰åºçš„key</span></span><br><span class="line">curl <span class="string">'http://127.0.0.1:2379/v2/keys/queue?recursive=true&amp;sorted=true'</span></span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"get"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/queue"</span>,<span class="string">"dir"</span>:<span class="literal">true</span>,<span class="string">"nodes"</span>:[&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000042"</span>,<span class="string">"value"</span>:<span class="string">"Job1"</span>,<span class="string">"modifiedIndex"</span>:42,<span class="string">"createdIndex"</span>:42&#125;,&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000043"</span>,<span class="string">"value"</span>:<span class="string">"Job2"</span>,<span class="string">"modifiedIndex"</span>:43,<span class="string">"createdIndex"</span>:43&#125;,&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000044"</span>,<span class="string">"value"</span>:<span class="string">"Job3"</span>,<span class="string">"modifiedIndex"</span>:44,<span class="string">"createdIndex"</span>:44&#125;,&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000045"</span>,<span class="string">"value"</span>:<span class="string">"Job4"</span>,<span class="string">"modifiedIndex"</span>:45,<span class="string">"createdIndex"</span>:45&#125;,&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000046"</span>,<span class="string">"value"</span>:<span class="string">"Job5"</span>,<span class="string">"modifiedIndex"</span>:46,<span class="string">"createdIndex"</span>:46&#125;,&#123;<span class="string">"key"</span>:<span class="string">"/queue/00000000000000000047"</span>,<span class="string">"value"</span>:<span class="string">"Job6"</span>,<span class="string">"modifiedIndex"</span>:47,<span class="string">"createdIndex"</span>:47&#125;],<span class="string">"modifiedIndex"</span>:42,<span class="string">"createdIndex"</span>:42&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸå­æ“ä½œ</span></span><br><span class="line"><span class="comment"># æ’å…¥ä¸€ä¸ªå·²å­˜åœ¨çš„keyå¹¶æ·»åŠ å‚æ•°prevExist=falseï¼Œå› ä¸ºå·²ç»æœ‰å­˜åœ¨çš„key</span></span><br><span class="line">curl -XPUT http://127.0.0.1:2379/v2/keys/foo?prevExist=<span class="literal">false</span> -d value=two</span><br><span class="line">&#123;<span class="string">"errorCode"</span>:105,<span class="string">"message"</span>:<span class="string">"Key already exists"</span>,<span class="string">"cause"</span>:<span class="string">"/foo"</span>,<span class="string">"index"</span>:56&#125;</span><br><span class="line"><span class="comment"># å°†æ’å…¥æ¡ä»¶æ¢æˆprevValueï¼Œå³æ£€æŸ¥keyçš„valueå€¼ï¼Œæ¡ä»¶ç›¸ç­‰å°±æ›¿æ¢ï¼Œå¦åˆ™å°±æç¤ºæ¡ä»¶ä¸åŒ¹é…</span></span><br><span class="line">curl -XPUT  http://127.0.0.1:2379/v2/keys/foo?prevValue=three -d value=two </span><br><span class="line">&#123;<span class="string">"errorCode"</span>:101,<span class="string">"message"</span>:<span class="string">"Compare failed"</span>,<span class="string">"cause"</span>:<span class="string">"[three != one]"</span>,<span class="string">"index"</span>:56&#125;  <span class="comment">#å€¼ä¸åŒ¹é…</span></span><br><span class="line"> curl http://127.0.0.1:2379/v2/keys/foo?prevValue=one -XPUT -d value=two   <span class="comment">#å€¼åŒ¹é…æ›¿æ¢</span></span><br><span class="line">&#123;<span class="string">"action"</span>:<span class="string">"compareAndSwap"</span>,<span class="string">"node"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/foo"</span>,<span class="string">"value"</span>:<span class="string">"two"</span>,<span class="string">"modifiedIndex"</span>:57,<span class="string">"createdIndex"</span>:56&#125;,<span class="string">"prevNode"</span>:&#123;<span class="string">"key"</span>:<span class="string">"/foo"</span>,<span class="string">"value"</span>:<span class="string">"one"</span>,<span class="string">"modifiedIndex"</span>:56,<span class="string">"createdIndex"</span>:56&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒç»­watch</span></span><br><span class="line">curl http://127.0.0.1:2379/v2/keys/message?<span class="built_in">wait</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>[version 3]<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#PS 3.x ç‰ˆæœ¬ä¸­éœ€è¦å¯¹k/vè¿›è¡Œbase64ç¼–ç ï¼Œæ³¨æ„æ˜¯POSTè¯·æ±‚è€Œä¸å†æ˜¯PUT</span></span><br><span class="line"><span class="comment"># https://www.base64encode.org/</span></span><br><span class="line"><span class="comment"># WeiyiGeek  is 'V2VpeWlHZWVr' in Base64</span></span><br><span class="line"><span class="comment"># etcddemo is 'ZXRjZGRlbW8='</span></span><br><span class="line"><span class="comment"># btoa("Weiyi")</span></span><br><span class="line"><span class="comment"># "V2VpeWk="</span></span><br><span class="line"><span class="comment"># btoa("123456")</span></span><br><span class="line"><span class="comment"># "MTIzNDU2"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [Put and get keys ] : /v3/kv/range and /v3/kv/put</span></span><br><span class="line">[root@node3 ~]<span class="comment"># curl -L http://localhost:2379/v3/kv/put -X POST -d '&#123;"key": "V2VpeWlHZWVr", "value": "ZXRjZGRlbW8="&#125;'</span></span><br><span class="line">[root@node3 ~]<span class="comment"># etcdctl get WeiyiGeek</span></span><br><span class="line">WeiyiGeek</span><br><span class="line">etcddemo</span><br><span class="line">[root@node3 ~]<span class="comment"># curl -L http://localhost:2379/v3/kv/range -X POST -d '&#123;"key": "V2VpeWlHZWVr"&#125;'</span></span><br><span class="line">&#123;<span class="string">"header"</span>:&#123;<span class="string">"cluster_id"</span>:<span class="string">"2819294416482393232"</span>,<span class="string">"member_id"</span>:<span class="string">"17704130064291257467"</span>,<span class="string">"revision"</span>:<span class="string">"7303"</span>,<span class="string">"raft_term"</span>:<span class="string">"301"</span>&#125;,<span class="string">"kvs"</span>:[&#123;<span class="string">"key"</span>:<span class="string">"V2VpeWlHZWVr"</span>,<span class="string">"create_revision"</span>:<span class="string">"7303"</span>,<span class="string">"mod_revision"</span>:<span class="string">"7303"</span>,<span class="string">"version"</span>:<span class="string">"1"</span>,<span class="string">"value"</span>:<span class="string">"ZXRjZGRlbW8="</span>&#125;],<span class="string">"count"</span>:<span class="string">"1"</span>&#125;</span><br><span class="line"><span class="comment">#get all keys prefixed with "foo" | æŠŠæ‰€æœ‰çš„é”®éƒ½åŠ ä¸Šå‰ç¼€"foo"</span></span><br><span class="line"><span class="comment">#curl -L http://localhost:2379/v3/kv/range  -X POST -d '&#123;"key": "Zm9v", "range_end": "Zm9w"&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [Watch keys]: /v3/watch</span></span><br><span class="line">curl -N http://localhost:2379/v3/watch -X POST -d <span class="string">'&#123;"create_request": &#123;"key":"Zm9v"&#125; &#125;'</span> </span><br><span class="line"><span class="comment"># &#123;"result":&#123;"header":&#123;"cluster_id":"2819294416482393232","member_id":"17704130064291257467","revision":"7303","raft_term":"301"&#125;,"created":true&#125;&#125;</span></span><br><span class="line"><span class="comment"># &#123;"result":&#123;"header":&#123;"cluster_id":"2819294416482393232","member_id":"17704130064291257467","revision":"7304","raft_term":"314"&#125;,"events":[&#123;"kv":&#123;"key":"Zm9v","create_revision":"7301","mod_revision":"7304","version":"2","value":"YmFy"&#125;&#125;]&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [Transactions] : /v3/kv/txnäº‹åŠ¡å¤„ç†</span></span><br><span class="line"><span class="comment">#åˆ›å»ºç›®æ ‡</span></span><br><span class="line">curl -L http://localhost:2379/v3/kv/txn \</span><br><span class="line">  -X POST \</span><br><span class="line">  -d <span class="string">'&#123;"compare":[&#123;"target":"CREATE","key":"Zm9v","createRevision":"2"&#125;],"success":[&#123;"requestPut":&#123;"key":"Zm9v","value":"YmFy"&#125;&#125;]&#125;'</span></span><br><span class="line"><span class="comment"># &#123;"header":&#123;"cluster_id":"12585971608760269493","member_id":"13847567121247652255","revision":"3","raft_term":"2"&#125;,"succeeded":true,"responses":[&#123;"response_put":&#123;"header":&#123;"revision":"3"&#125;&#125;&#125;]&#125;</span></span><br><span class="line"><span class="comment">#ç›®æ ‡ç‰ˆæœ¬</span></span><br><span class="line">curl -L http://localhost:2379/v3/kv/txn \</span><br><span class="line">  -X POST \</span><br><span class="line">  -d <span class="string">'&#123;"compare":[&#123;"version":"4","result":"EQUAL","target":"VERSION","key":"Zm9v"&#125;],"success":[&#123;"requestRange":&#123;"key":"Zm9v"&#125;&#125;]&#125;'</span></span><br><span class="line"><span class="comment"># &#123;"header":&#123;"cluster_id":"14841639068965178418","member_id":"10276657743932975437","revision":"6","raft_term":"3"&#125;,"succeeded":true,"responses":[&#123;"response_range":&#123;"header":&#123;"revision":"6"&#125;,"kvs":[&#123;"key":"Zm9v","create_revision":"2","mod_revision":"6","version":"4","value":"YmF6"&#125;],"count":"1"&#125;&#125;]&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [Authentication] : /v3/auth</span></span><br><span class="line"><span class="comment"># create root user</span></span><br><span class="line">curl -L http://127.0.0.1:2379/v3/auth/user/add -X POST -d <span class="string">'&#123;"name": "root", "password": "pass"&#125;'</span></span><br><span class="line"><span class="comment"># create root role</span></span><br><span class="line">curl -L http://localhost:2379/v3/auth/role/add \</span><br><span class="line">  -X POST -d <span class="string">'&#123;"name": "root"&#125;'</span></span><br><span class="line"><span class="comment"># grant root role</span></span><br><span class="line">curl -L http://localhost:2379/v3/auth/user/grant \</span><br><span class="line">  -X POST -d <span class="string">'&#123;"user": "root", "role": "root"&#125;'</span></span><br><span class="line"><span class="comment"># enable auth</span></span><br><span class="line">curl -L http://localhost:2379/v3/auth/<span class="built_in">enable</span> -X POST -d <span class="string">'&#123;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä½¿ç”¨etcdå¯¹ä½¿ç”¨/v3/auth/ Authenticateçš„èº«ä»½éªŒè¯ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯</span></span><br><span class="line"><span class="comment">#è·å–æ ¹ç”¨æˆ·çš„è®¤è¯ä»¤ç‰Œ</span></span><br><span class="line">curl -L http://localhost:2379/v3/auth/authenticate -X POST -d <span class="string">'&#123;"name": "root", "password": "pass"&#125;'</span></span><br><span class="line"><span class="comment"># &#123;"header":&#123;"cluster_id":"14841639068965178418","member_id":"10276657743932975437","revision":"1","raft_term":"2"&#125;,"token":"sssvIpwfnLAcWAQH.9"&#125;</span></span><br><span class="line"><span class="comment"># ç„¶ååœ¨è¯·æ±‚çš„Headerå¤´ä¸­Authorizationå­—æ®µåŠ å…¥ä¸Šé¢çš„tokenå³å¯è®¤è¯ç„¶åä¾¿å¯ä»¥è¿›è¡Œæ“ä½œ</span></span><br><span class="line">curl -L http://localhost:2379/v3/kv/range \</span><br><span class="line">  -H <span class="string">'Authorization: ExmKVoSbXOhIonIj.7329'</span> \</span><br><span class="line">  -X POST -d <span class="string">'&#123;"key": "V2VpeWlHZWVr"&#125;'</span></span><br><span class="line">&#123;<span class="string">"header"</span>:&#123;<span class="string">"cluster_id"</span>:<span class="string">"2819294416482393232"</span>,<span class="string">"member_id"</span>:<span class="string">"17704130064291257467"</span>,<span class="string">"revision"</span>:<span class="string">"7307"</span>,<span class="string">"raft_term"</span>:<span class="string">"314"</span>&#125;,<span class="string">"kvs"</span>:[&#123;<span class="string">"key"</span>:<span class="string">"V2VpeWlHZWVr"</span>,<span class="string">"create_revision"</span>:<span class="string">"7303"</span>,<span class="string">"mod_revision"</span>:<span class="string">"7303"</span>,<span class="string">"version"</span>:<span class="string">"1"</span>,<span class="string">"value"</span>:<span class="string">"ZXRjZGRlbW8="</span>&#125;],<span class="string">"count"</span>:<span class="string">"1"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># disenable auth</span></span><br><span class="line">curl -L http://localhost:2379/v3/auth/<span class="built_in">disable</span> -X POST -d <span class="string">'&#123;&#125;'</span> -H <span class="string">'Authorization: ExmKVoSbXOhIonIj.7329'</span></span><br><span class="line">&#123;<span class="string">"header"</span>:&#123;<span class="string">"cluster_id"</span>:<span class="string">"2819294416482393232"</span>,<span class="string">"member_id"</span>:<span class="string">"17704130064291257467"</span>,<span class="string">"revision"</span>:<span class="string">"7307"</span>,<span class="string">"raft_term"</span>:<span class="string">"314"</span>&#125;&#125;[</span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒåœ°å€:</p>
<ul>
<li><a href="https://etcd.io/docs/v3.4.0/dev-guide/api_grpc_gateway/" target="_blank" rel="noopener">https://etcd.io/docs/v3.4.0/dev-guide/api_grpc_gateway/</a></li>
</ul>
<hr>
<h4 id="0x02-é›†ç¾¤åº”ç”¨"><a href="#0x02-é›†ç¾¤åº”ç”¨" class="headerlink" title="0x02 é›†ç¾¤åº”ç”¨"></a>0x02 é›†ç¾¤åº”ç”¨</h4><p>æè¿°:æ­¤æ—¶åªæ˜¯ä¸€ä¸ªç®€å•çš„é›†ç¾¤å®ä¾‹ï¼Œæ²¡æœ‰åŠ å…¥è¯ä¹¦è®¤è¯ä»¥åŠå®‰å…¨æ•ˆéªŒï¼Œæ­£å¼çš„ç”Ÿäº§ç¯å¢ƒä¸­ä¸€å®šéœ€è¦åšè¿™ä¸¤æ ·;</p>
<p>ç¯å¢ƒè¯´æ˜:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.107.241 node1.weiyigeek.top <span class="comment">#CentOS8</span></span><br><span class="line">192.168.107.242 node2.weiyigeek.top <span class="comment">#CentOS7.7</span></span><br><span class="line">192.168.107.243 node3.weiyigeek.top <span class="comment">#CentOS7.7</span></span><br></pre></td></tr></table></figure></p>
<p>Step1.å®‰è£…etcéƒ¨ç½²å®‰è£…ï¼ˆ<code>æ­¤å¤„ä»¥node1ä¸ºä¾‹å³ä¸Šé¢çš„ä¸€å°ä¸»æœº</code>ï¼‰,å…¶å®ƒä¸»æœºå®‰è£…ç±»ä¼¼ä¸åŒä¹‹å¤„åœ¨äºETCD_NAMEçš„é…ç½®(å¤šå°æœºå™¨åç§°éœ€è¦ä¸åŒ)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">## Desc: Etcdä¸€é”®éƒ¨ç½²</span></span><br><span class="line">ETCD_VER=v3.4.7</span><br><span class="line"></span><br><span class="line"><span class="comment">#é€‰æ‹©ä¸‹è½½çš„åœ°å€</span></span><br><span class="line">GOOGLE_URL=https://storage.googleapis.com/etcd</span><br><span class="line">GITHUB_URL=https://github.com/etcd-io/etcd/releases/download</span><br><span class="line">DOWNLOAD_URL=<span class="variable">$&#123;GITHUB_URL&#125;</span></span><br><span class="line">rm -rf /tmp/etcd &amp;&amp; mkdir -p /tmp/etcd</span><br><span class="line">curl -L <span class="variable">$&#123;DOWNLOAD_URL&#125;</span>/<span class="variable">$&#123;ETCD_VER&#125;</span>/etcd-<span class="variable">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz -o /tmp/etcd-<span class="variable">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz</span><br><span class="line">tar xzvf /tmp/etcd-<span class="variable">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz -C /tmp/etcd --strip-components=1</span><br><span class="line">ln -s /tmp/etcd/etcd /usr/bin</span><br><span class="line">ln -s /tmp/etcd/etcdctl /usr/bin</span><br><span class="line">etcd --version &amp;&amp; etcdctl version</span><br></pre></td></tr></table></figure></p>
<p>Step2.åœ¨è¯¥å°æœºå™¨ä¸Šè®¾ç½®<code>Etcdå’ŒSystemd</code>å¯åŠ¨è®¾ç½®;<br><strong>etcdé…ç½®</strong><br>åˆ›å»ºetcdé…ç½®æ–‡ä»¶/etc/etcd/etcd.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/etcd/etcd.conf</span><br><span class="line">[member]</span><br><span class="line"><span class="comment">#memberåç§°</span></span><br><span class="line">ETCD_NAME=instance1</span><br><span class="line"><span class="comment">#å­˜å‚¨æ•°æ®çš„ç›®å½•(æ³¨æ„éœ€è¦å»ºç«‹)</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/data"</span></span><br><span class="line"><span class="comment">#ç”¨äºç›‘å¬å®¢æˆ·ç«¯etcdctlæˆ–è€…curlè¿æ¥</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"http://192.168.107.241:2379,http://127.0.0.1:2379"</span></span><br><span class="line"><span class="comment">#ç”¨äºç›‘å¬é›†ç¾¤ä¸­å…¶å®ƒmemberçš„è¿æ¥</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"http:/192.168.107.241:2380"</span></span><br><span class="line"></span><br><span class="line">[cluster]</span><br><span class="line"><span class="comment">#æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ­¤IPsä¸é›†ç¾¤é€šä¿¡;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"http://192.168.107.241:2379"</span></span><br><span class="line"><span class="comment">#æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥é›†ç¾¤memberä¸memberé€šä¿¡ï¼›</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"http://192.168.107.241:2380"</span></span><br><span class="line"><span class="comment">#æè¿°é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæœ¬memberæ ¹æ®æ­¤ä¿¡æ¯å»è”ç³»å…¶ä»–memberï¼›</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"instance01=http://192.168.107.241:2380,instance02=http://192.168.107.242:2380,instance03=http://192.168.107.243:2380"</span></span><br><span class="line"><span class="comment">#é›†ç¾¤çŠ¶æ€æ–°å»ºé›†ç¾¤æ—¶å€™è®¾ç½®ä¸ºnew,è‹¥æ˜¯æƒ³åŠ å…¥æŸä¸ªå·²ç»å­˜åœ¨çš„é›†ç¾¤è®¾ç½®ä¸ºexisting</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br></pre></td></tr></table></figure></p>
<p><strong>systemdç®¡ç†é…ç½®</strong><br>æè¿°:åˆ›å»ºetcdçš„systemdé…ç½®æ–‡ä»¶ /usr/lib/systemd/system/etcd.service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Etcd Server</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;var&#x2F;lib&#x2F;etcd&#x2F;</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;etcd&#x2F;etcd.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;etcd</span><br><span class="line">KillMode&#x3D;process</span><br><span class="line">Restart&#x3D;always</span><br><span class="line">RestartSec&#x3D;5</span><br><span class="line">LimitNOFILE&#x3D;655350</span><br><span class="line">LimitNPROC&#x3D;655350</span><br><span class="line">PrivateTmp&#x3D;false</span><br><span class="line">SuccessExitStatus&#x3D;143</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>Step3.å¯åŠ¨etcdæœåŠ¡å¹¶æŸ¥çœ‹é›†ç¾¤çŠ¶æ€<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æœåŠ¡å¯åŠ¨</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd.service</span><br><span class="line">systemctl start etcd.service</span><br></pre></td></tr></table></figure></p>
<p>Step4.è¯»å†™ä»¥åŠåˆ é™¤æ“ä½œ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">HOST_1=192.168.10.241</span><br><span class="line">HOST_2=192.168.10.242</span><br><span class="line">HOST_3=192.168.10.243</span><br><span class="line">ENDPOINTS=<span class="variable">$HOST_1</span>:2379,<span class="variable">$HOST_2</span>:2379,<span class="variable">$HOST_3</span>:2379</span><br><span class="line"></span><br><span class="line"><span class="comment">#å†™å…¥|æ›¿æ¢Key</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> put name <span class="string">"WeiyiGeek"</span></span><br><span class="line"><span class="comment">#è¯»å–Key</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> get name</span><br><span class="line"><span class="comment">#åˆ é™¤Key</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> del name</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug æŸ¥çœ‹</span></span><br><span class="line"><span class="variable">$etcdctl</span> --endpoints=<span class="variable">$ENDPOINTS</span> --debug get --from-key <span class="string">'\0'</span></span><br><span class="line">ETCDCTL_CACERT=</span><br><span class="line">ETCDCTL_CERT=</span><br><span class="line">ETCDCTL_COMMAND_TIMEOUT=5s</span><br><span class="line">ETCDCTL_DEBUG=<span class="literal">true</span></span><br><span class="line">ETCDCTL_DIAL_TIMEOUT=2s</span><br><span class="line">ETCDCTL_DISCOVERY_SRV=</span><br><span class="line">ETCDCTL_DISCOVERY_SRV_NAME=</span><br><span class="line">ETCDCTL_ENDPOINTS=[192.168.10.241:2379,192.168.10.242:2379,192.168.10.243:2379]</span><br><span class="line">ETCDCTL_HEX=<span class="literal">false</span></span><br><span class="line">ETCDCTL_INSECURE_DISCOVERY=<span class="literal">true</span></span><br><span class="line">ETCDCTL_INSECURE_SKIP_TLS_VERIFY=<span class="literal">false</span></span><br><span class="line">ETCDCTL_INSECURE_TRANSPORT=<span class="literal">true</span></span><br><span class="line">ETCDCTL_KEEPALIVE_TIME=2s</span><br><span class="line">ETCDCTL_KEEPALIVE_TIMEOUT=6s</span><br><span class="line">ETCDCTL_KEY=</span><br><span class="line">ETCDCTL_PASSWORD=</span><br><span class="line">ETCDCTL_USER=</span><br><span class="line">ETCDCTL_WRITE_OUT=simple</span><br><span class="line">WARNING: 2020/04/26 00:18:51 Adjusting keepalive ping interval to minimum period of 10s</span><br><span class="line">WARNING: 2020/04/26 00:18:51 Adjusting keepalive ping interval to minimum period of 10s</span><br><span class="line">INFO: 2020/04/26 00:18:51 parsed scheme: <span class="string">"endpoint"</span></span><br><span class="line">INFO: 2020/04/26 00:18:51 ccResolverWrapper: sending new addresses to cc: [&#123;192.168.10.241:2379 0  &lt;nil&gt;&#125; &#123;192.168.10.242:2379 0  &lt;nil&gt;&#125; &#123;192.168.10.243:2379 0  &lt;nil&gt;&#125;]</span><br></pre></td></tr></table></figure></p>
<p>Step5.Watchè¿›è¡Œç›‘å¬æˆ‘ä»¬åœ¨etcdé›†ç¾¤ä¸­çš„æ“ä½œ<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å†™å…¥ v</span></span><br><span class="line"><span class="comment">#è¯»å– x</span></span><br><span class="line"><span class="comment">#åˆ é™¤ v</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> watch [key]</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200424143440.png" target="_blank" title="WeiyiGeek.æ‰§è¡Œæ•ˆæœ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200424143440.png" alt="WeiyiGeek.æ‰§è¡Œæ•ˆæœ" title="" class=""></a>
                <p>WeiyiGeek.æ‰§è¡Œæ•ˆæœ</p>
            </figure></p>
<p>Step6.é›†ç¾¤çŠ¶æ€æŸ¥çœ‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> --write-out=table member list</span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> --write-out=table endpoint status</span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> --write-out=table endpoint health</span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span>  -w table endpoint status <span class="comment">#--write-outç®€å†™-w</span></span><br><span class="line">+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| 192.168.10.241:2379 | ef8199869f22c2b7 |   3.4.7 |   20 kB |      <span class="literal">true</span> |      <span class="literal">false</span> |       301 |          8 |                  8 |        |</span><br><span class="line">| 192.168.10.242:2379 | cbd80ba26fce8c16 |   3.4.7 |   20 kB |     <span class="literal">false</span> |      <span class="literal">false</span> |       301 |          8 |                  8 |        |</span><br><span class="line">| 192.168.10.243:2379 | f5b1b47e3364dc7b |   3.4.7 |   20 kB |     <span class="literal">false</span> |      <span class="literal">false</span> |       301 |          9 |                  9 |        |</span><br><span class="line">+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br></pre></td></tr></table></figure></p>
<p>Step7.æƒé™ä¸è®¤è¯è®¾ç½®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"><span class="comment">#æƒé™èµ‹äºˆ</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> role add root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> role grant-permission root readwrite foo</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> role get root</span><br><span class="line"></span><br><span class="line"><span class="comment">#è§’è‰²èµ‹äºˆ</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> user add root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> user grant-role root root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> user get root</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> auth <span class="built_in">enable</span></span><br><span class="line"><span class="comment"># now all client requests go through aute|ç°åœ¨æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚éƒ½ç»è¿‡éªŒè¯</span></span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> --user=root:123 put foo bar</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> get foo</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> --user=root:123 get foo</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h5 id="TLSå¯†é’¥å’Œè¯ä¹¦"><a href="#TLSå¯†é’¥å’Œè¯ä¹¦" class="headerlink" title="TLSå¯†é’¥å’Œè¯ä¹¦"></a>TLSå¯†é’¥å’Œè¯ä¹¦</h5><p>æè¿°:ä¸ºäº†ä¿è¯é€šä¿¡å®‰å…¨å®¢æˆ·ç«¯<code>(å¦‚etcdctl)ä¸etcd é›†ç¾¤ã€etcd é›†ç¾¤ä¹‹é—´çš„é€šä¿¡</code>éœ€è¦ä½¿ç”¨TLS åŠ å¯†ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ CloudFlareâ€™s PKI å·¥å…· <a href="https://github.com/cloudflare/cfssl" target="_blank" rel="noopener">cfssl</a> æ¥é…ç½® PKI Infrastructureï¼Œç„¶åä½¿ç”¨å®ƒå»åˆ›å»º Certificate Authorityï¼ˆCAï¼‰ï¼Œ å¹¶ä¸º etcdåˆ›å»º TLS è¯ä¹¦ã€‚</p>
<p>Step0.è¯ä¹¦ç”Ÿæˆå·¥å…·å®‰è£…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /k8s/kubernetes/ssl/ &amp;&amp; <span class="built_in">cd</span> <span class="variable">$_</span></span><br><span class="line"><span class="comment"># cfssl æœ€æ–°ä¸‹è½½åœ°å€: https://github.com/cloudflare/cfssl/releases</span></span><br><span class="line"><span class="comment"># cfssl ç›¸å…³å·¥å…·æ‹‰å– (å¦‚æœæ‹‰å–è¾ƒæ…¢ï¼Œå»ºè®®ä½¿ç”¨æŸé›·ä¸‹è½½ï¼Œç„¶åä¸Šä¼ åˆ°æœåŠ¡å™¨é‡Œ)</span></span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64 -o /usr/<span class="built_in">local</span>/bin/cfssl</span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64 -o /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64 -o /usr/<span class="built_in">local</span>/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/cfssl /usr/<span class="built_in">local</span>/bin/cfssl-certinfo /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line"></span><br><span class="line"><span class="comment">#éªŒè¯ cfssl çš„ç‰ˆæœ¬ä¸º 1.6.0 æˆ–æ˜¯æ›´é«˜</span></span><br><span class="line">cfssl version</span><br></pre></td></tr></table></figure></p>
<p>Step1.åˆ›å»º etcd CA åŠ è¯ä¹¦ç­¾åè¯·æ±‚<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">//# etcd caé…ç½®</span><br><span class="line"># cat ca-config.json</span><br><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"signing"</span>: &#123;</span><br><span class="line">    <span class="attr">"default"</span>: &#123;</span><br><span class="line">      <span class="attr">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"profiles"</span>: &#123;</span><br><span class="line">      <span class="attr">"www"</span>: &#123;</span><br><span class="line">         <span class="attr">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">         <span class="attr">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//# cat ca-csr.json caè¯ä¹¦</span><br><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"CN"</span>: <span class="string">"etcd CA"</span>,</span><br><span class="line">    <span class="attr">"key"</span>: &#123;</span><br><span class="line">        <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="attr">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="attr">"ST"</span>: <span class="string">"Beijing"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//# cat etcd-csr.json</span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="attr">"hosts"</span>: [</span><br><span class="line">    <span class="string">"192.168.10.241"</span>,</span><br><span class="line">    <span class="string">"192.168.10.242"</span>,</span><br><span class="line">    <span class="string">"192.168.10.243"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"key"</span>: &#123;</span><br><span class="line">    <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>Step2.ç”Ÿæˆetcdè¯ä¹¦å’Œç§é’¥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CA å‡­è¯å’Œç§é’¥ç”Ÿæˆ:</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯ä¹¦ç”Ÿæˆ</span></span><br><span class="line">cfssl gencert -ca=/k8s/kubernetes/ssl/ca.pem -ca-key=/k8s/kubernetes/ssl/ca-key.pem  -config=/k8s/kubernetes/ssl/ca-config.json  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls etcd*</span></span><br><span class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem <span class="comment"># è¯ä¹¦ç­¾åè¯·æ±‚æ­£åœ¨ +  è¯ä¹¦å…¬é’¥ä¸å¯†é’¥</span></span><br></pre></td></tr></table></figure></p>
<p>Step3.åœ¨Etcdå¯åŠ¨è„šæœ¬ä¸­åŠ å…¥ä»¥ä¸‹å‚æ•°<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--cert-file=/k8s/etcd/ssl/etcd.pem \</span><br><span class="line">--key-file=/k8s/etcd/ssl/etcd-key.pem \</span><br><span class="line">--peer-cert-file=/k8s/etcd/ssl/etcd.pem \</span><br><span class="line">--peer-key-file=/k8s/etcd/ssl/etcd-key.pem \</span><br><span class="line">--trusted-ca-file=/k8s/kubernetes/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/k8s/kubernetes/ssl/ca.pe\</span><br><span class="line"><span class="built_in">set</span> /flannel/network/config <span class="string">'&#123;"Network":"10.244.0.0/16", "SubnetMin": "10.244.1.0", "SubnetMax": "10.244.254.0", "SubnetLen": 24, "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span> <span class="comment">#æ³¨æ„å¿…é¡»åœ¨å‚æ•°ä¸­åŠ å…¥â€“enable-v2</span></span><br></pre></td></tr></table></figure></p>
<p>Step4.é‡‡ç”¨è¯ä¹¦è¿›è¡Œé€šè®¯è®¤è¯é“¾æ¥äº¤æ¢å³èŠ‚ç‚¹çŠ¶æ€æŸ¥çœ‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ENDPOINTS=192.168.10.241:2379,192.168.10.242:2379,192.168.10.243:2379</span><br><span class="line">etcdctl --cacert=/k8s/kubernetes/ssl/ca.pem --cert=/k8s/etcd/ssl/etcd.pem --key=/k8s/etcd/ssl/etcd-key.pem --endpoints=<span class="variable">$ENDPOINTS</span> endpoint health</span><br><span class="line"><span class="comment"># 192.168.10.243:2379 is healthy: successfully committed proposal: took = 6.152483ms</span></span><br><span class="line"><span class="comment"># 192.168.10.241:2379 is healthy: successfully committed proposal: took = 6.461149ms</span></span><br><span class="line"><span class="comment"># 192.168.10.242:2379 is healthy: successfully committed proposal: took = 5.701604ms</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="0x03-åº”ç”¨ä»‹ç»ä¸å®è·µ"><a href="#0x03-åº”ç”¨ä»‹ç»ä¸å®è·µ" class="headerlink" title="0x03 åº”ç”¨ä»‹ç»ä¸å®è·µ"></a>0x03 åº”ç”¨ä»‹ç»ä¸å®è·µ</h4><h5 id="1-åº”ç”¨åœºæ™¯"><a href="#1-åº”ç”¨åœºæ™¯" class="headerlink" title="1.åº”ç”¨åœºæ™¯"></a>1.åº”ç”¨åœºæ™¯</h5><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®åˆ†ä¸º<code>æ§åˆ¶æ•°æ®å’Œåº”ç”¨æ•°æ®</code>ã€‚ä½¿ç”¨etcdçš„åœºæ™¯é»˜è®¤å¤„ç†çš„æ•°æ®éƒ½æ˜¯æ§åˆ¶æ•°æ®ï¼Œå¯¹äºåº”ç”¨æ•°æ®åªæ¨èæ•°æ®é‡å¾ˆå°ï¼Œä½†æ˜¯æ›´æ–°è®¿é—®é¢‘ç¹çš„æƒ…å†µã€‚å¹¶ä¸”Etcdå¸¸å¸¸ä¸å¾®æœåŠ¡æ¶æ„ä¸€èµ·ä½¿ç”¨æ¯”å¦‚ä¸‹é¢çš„ä¸€äº›åœºæ™¯ä¹‹ä¸­;</p>
<p><strong>åœºæ™¯ä¸€ï¼šæœåŠ¡å‘ç°ï¼ˆService Discoveryï¼‰</strong><br>Qï¼šä»€ä¹ˆæ˜¯Service Discovery?<br>ç­”:å³åœ¨åŒä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤ä¸­çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œè¦å¦‚ä½•æ‰èƒ½æ‰¾åˆ°å¯¹æ–¹å¹¶å»ºç«‹è¿æ¥,ç®€å•çš„è¯´æœåŠ¡å‘ç°å°±æ˜¯æƒ³è¦<code>äº†è§£é›†ç¾¤ä¸­æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç›‘å¬udpæˆ–tcpç«¯å£</code>ï¼Œå¹¶ä¸”é€šè¿‡åå­—å°±å¯ä»¥æŸ¥æ‰¾å’Œè¿æ¥;</p>
<ul>
<li>ä¸€ä¸ªå¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½• == åŸºäºRaftç®—æ³•</li>
<li>ä¸€ç§æ³¨å†ŒæœåŠ¡å’Œç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€çš„æœºåˆ¶ == åœ¨etcdä¸­æ³¨å†ŒæœåŠ¡å¹¶ä¸”å¯¹æ³¨å†Œçš„æœåŠ¡è®¾ç½®key TTL</li>
<li>ä¸€ç§æŸ¥æ‰¾å’Œè¿æ¥æœåŠ¡çš„æœºåˆ¶ == åœ¨æ¯ä¸ªæœåŠ¡æœºå™¨ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ªProxyæ¨¡å¼çš„etcdï¼Œç¡®ä¿èƒ½è®¿é—®etcdé›†ç¾¤çš„æœåŠ¡éƒ½èƒ½äº’ç›¸è¿æ¥ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425211000.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425211000.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p>æœåŠ¡å‘ç°å¯¹åº”çš„å…·ä½“åœºæ™¯:</p>
<ul>
<li>1) å¾®æœåŠ¡ååŒå·¥ä½œæ¶æ„ä¸­ï¼ŒæœåŠ¡åŠ¨æ€æ·»åŠ ; é€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶åœ¨etcdä¸­æ³¨å†ŒæŸä¸ªæœåŠ¡åå­—çš„ç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹å­˜å‚¨å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹çš„IPã€‚åœ¨ä½¿ç”¨æœåŠ¡çš„è¿‡ç¨‹ä¸­åªè¦ä»æœåŠ¡ç›®å½•ä¸‹æŸ¥æ‰¾å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹å»ä½¿ç”¨å³å¯ã€‚</li>
<li>2) PaaSå¹³å°ä¸­åº”ç”¨å¤šå®ä¾‹ä¸å®ä¾‹æ•…éšœé‡å¯é€æ˜åŒ–ã€‚éœ€è¦åŠ¨æ€çš„é…ç½®åŸŸåè§£æï¼ˆè·¯ç”±ï¼‰ä¸­çš„ä¿¡æ¯è€ŒEtcdå¾ˆå¥½çš„æ”¯æŒäº†è¿™ä¸€ç‚¹;</li>
</ul>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425211435.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425211435.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><br/></p>
<p><strong>åœºæ™¯äºŒï¼šæ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…</strong><br>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç»„ä»¶é—´é€šä¿¡æ–¹å¼å°±æ˜¯æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…,å³æ„å»ºä¸€ä¸ªé…ç½®å…±äº«ä¸­å¿ƒï¼Œæ•°æ®æä¾›è€…åœ¨è¿™ä¸ªé…ç½®ä¸­å¿ƒå‘å¸ƒæ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯ä½¿ç”¨è€…åˆ™è®¢é˜…ä»–ä»¬å…³å¿ƒçš„ä¸»é¢˜ï¼Œä¸€æ—¦ä¸»é¢˜æœ‰æ¶ˆæ¯å‘å¸ƒå°±ä¼šå®æ—¶é€šçŸ¥è®¢é˜…è€…ï¼Œetcdå®ç°äº†åˆ†å¸ƒå¼ç³»ç»Ÿé…ç½®çš„é›†ä¸­å¼ç®¡ç†ä¸åŠ¨æ€æ›´æ–°ã€‚</p>
<ul>
<li>åº”ç”¨ä¸­ç”¨åˆ°çš„ä¸€äº›é…ç½®ä¿¡æ¯æ”¾åˆ°etcdä¸Šè¿›è¡Œé›†ä¸­ç®¡ç† == åœ¨etcdèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ªWatcherå¹¶ç­‰å¾…ï¼Œå½“é…ç½®æœ‰æ›´æ–°çš„æ—¶å€™ä¼šé…ç½®æœ‰æ›´æ–°çš„æ—¶å€™ï¼›</li>
<li>ç´¢å¼•çš„å…ƒä¿¡æ¯å’ŒæœåŠ¡å™¨é›†ç¾¤æœºå™¨çš„èŠ‚ç‚¹çŠ¶æ€å­˜æ”¾åœ¨etcdä¸­ == ä½¿ç”¨etcdçš„key TTLåŠŸèƒ½å¯ä»¥ç¡®ä¿æœºå™¨çŠ¶æ€æ˜¯å®æ—¶æ›´æ–°çš„ï¼›</li>
<li>åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿ == åœ¨etcdä¸Šåˆ›å»ºä¸€ä¸ªä»¥åº”ç”¨ï¼ˆä¸»é¢˜ï¼‰å‘½åçš„ç›®å½•Pï¼Œå¹¶å°†è¿™ä¸ªåº”ç”¨ï¼ˆä¸»é¢˜ç›¸å…³ï¼‰çš„æ‰€æœ‰æœºå™¨ipï¼Œä»¥å­ç›®å½•çš„å½¢å¼å­˜å‚¨åˆ°ç›®å½•Pä¸Šï¼Œç„¶åè®¾ç½®ä¸€ä¸ªetcdé€’å½’çš„Watcherï¼Œé€’å½’å¼çš„ç›‘æ§åº”ç”¨ï¼ˆä¸»é¢˜ï¼‰ç›®å½•ä¸‹æ‰€æœ‰ä¿¡æ¯çš„å˜åŠ¨</li>
<li>ç³»ç»Ÿä¸­ä¿¡æ¯éœ€è¦åŠ¨æ€è‡ªåŠ¨è·å–ä¸äººå·¥å¹²é¢„ä¿®æ”¹ä¿¡æ¯è¯·æ±‚å†…å®¹çš„æƒ…å†µ == å¼•å…¥etcdåªè¦å°†ä¿¡æ¯å­˜æ”¾åˆ°æŒ‡å®šçš„etcdç›®å½•ä¸­å³å¯ï¼Œç„¶åé€šè¿‡HTTPçš„æ¥å£åœ¨å¤–éƒ¨è®¿é—®ã€‚</li>
</ul>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425212200.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425212200.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><br/></p>
<p><strong>åœºæ™¯ä¸‰ï¼šè´Ÿè½½å‡è¡¡</strong><br>æ­¤å¤„æŒ‡çš„æ˜¯è½¯è´Ÿè½½å‡è¡¡ï¼Œä¸ºäº†ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ä»¥åŠæ•°æ®çš„ä¸€è‡´æ€§ï¼Œé€šå¸¸éƒ½ä¼šæŠŠæ•°æ®å’ŒæœåŠ¡éƒ¨ç½²å¤šä»½ï¼Œä»¥æ­¤è¾¾åˆ°å¯¹ç­‰æœåŠ¡å³ä½¿å…¶ä¸­çš„æŸä¸€ä¸ªæœåŠ¡å¤±æ•ˆäº†ä¹Ÿä¸å½±å“ä½¿ç”¨ï¼›ç”±æ­¤å¸¦æ¥çš„<code>åå¤„æ˜¯æ•°æ®å†™å…¥æ€§èƒ½ä¸‹é™</code>ï¼Œè€Œ<code>å¥½å¤„åˆ™æ˜¯æ•°æ®è®¿é—®æ—¶çš„è´Ÿè½½å‡è¡¡</code>;</p>
<ul>
<li>etcdæœ¬èº«åˆ†å¸ƒå¼æ¶æ„å­˜å‚¨çš„ä¿¡æ¯è®¿é—®æ”¯æŒè´Ÿè½½å‡è¡¡ == etcdé›†ç¾¤åŒ–ä»¥åæ¯ä¸ªetcdçš„æ ¸å¿ƒèŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†ç”¨æˆ·çš„è¯·æ±‚(æ¨èæ•°æ®é‡å°ä½†æ˜¯è®¿é—®é¢‘ç¹çš„æ¶ˆæ¯)</li>
<li>åˆ©ç”¨etcdç»´æŠ¤ä¸€ä¸ªè´Ÿè½½å‡è¡¡èŠ‚ç‚¹è¡¨ == ç±»ä¼¼KafkaMQï¼Œé€šè¿‡ZooKeeperæ¥ç»´æŠ¤ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥é‡‡ç”¨etcd</li>
</ul>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425212621.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425212621.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><br/></p>
<p><strong>åœºæ™¯å››ï¼šåˆ†å¸ƒå¼é€šçŸ¥ä¸åè°ƒ</strong><br>åˆ†å¸ƒå¼é€šçŸ¥ä¸åè°ƒä¸æ¶ˆæ¯å‘å¸ƒå’Œè®¢é˜…æœ‰äº›ç›¸ä¼¼,å¯ä»¥ä½¿ç”¨etcdä¸­çš„Watcheræœºåˆ¶ï¼Œé€šè¿‡æ³¨å†Œä¸å¼‚æ­¥é€šçŸ¥æœºåˆ¶ï¼Œå®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸åŒç³»ç»Ÿä¹‹é—´çš„é€šçŸ¥ä¸åè°ƒï¼Œä»è€Œå¯¹æ•°æ®å˜æ›´åšåˆ°å®æ—¶å¤„ç†ã€‚<br>å®ç°æ–¹å¼é€šå¸¸æ˜¯è¿™æ ·ï¼šä¸åŒç³»ç»Ÿéƒ½åœ¨etcdä¸Šå¯¹åŒä¸€ä¸ªç›®å½•è¿›è¡Œæ³¨å†Œï¼ŒåŒæ—¶è®¾ç½®Watcherè§‚æµ‹è¯¥ç›®å½•çš„å˜åŒ–ï¼ˆå¦‚æœå¯¹å­ç›®å½•çš„å˜åŒ–ä¹Ÿæœ‰éœ€è¦ï¼Œå¯ä»¥è®¾ç½®é€’å½’æ¨¡å¼ï¼‰ï¼Œå½“æŸä¸ªç³»ç»Ÿæ›´æ–°äº†etcdçš„ç›®å½•ï¼Œé‚£ä¹ˆè®¾ç½®äº†Watcherçš„ç³»ç»Ÿå°±ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¹¶ä½œå‡ºç›¸åº”å¤„ç†ã€‚</p>
<ul>
<li>é€šè¿‡etcdè¿›è¡Œä½è€¦åˆçš„å¿ƒè·³æ£€æµ‹</li>
<li>é€šè¿‡etcdå®Œæˆç³»ç»Ÿè°ƒåº¦</li>
<li>é€šè¿‡etcdå®Œæˆå·¥ä½œæ±‡æŠ¥<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425212909.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425212909.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
</li>
</ul>
<p><br/></p>
<p><strong>åœºæ™¯äº”ï¼šåˆ†å¸ƒå¼é”</strong><br>å› ä¸ºetcdä½¿ç”¨Raftç®—æ³•ä¿æŒäº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼ŒæŸæ¬¡æ“ä½œå­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å€¼å¿…ç„¶æ˜¯å…¨å±€ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å®ç°åˆ†å¸ƒå¼é”ã€‚<br>é”æœåŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼:<code>ä¸€æ˜¯ä¿æŒç‹¬å ï¼ŒäºŒæ˜¯æ§åˆ¶æ—¶åº</code>ã€‚</p>
<ul>
<li>ä¿æŒç‹¬å å³æ‰€æœ‰è·å–é”çš„ç”¨æˆ·æœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥å¾—åˆ° == etcdä¸ºæ­¤æä¾›äº†ä¸€å¥—å®ç°åˆ†å¸ƒå¼é”åŸå­æ“ä½œCASï¼ˆCompareAndSwapï¼‰çš„APIã€‚</li>
<li>æ§åˆ¶æ—¶åºå³æ‰€æœ‰æƒ³è¦è·å¾—é”çš„ç”¨æˆ·éƒ½ä¼šè¢«å®‰æ’æ‰§è¡Œï¼Œä½†æ˜¯è·å¾—é”çš„é¡ºåºä¹Ÿæ˜¯å…¨å±€å”¯ä¸€çš„ï¼ŒåŒæ—¶å†³å®šäº†æ‰§è¡Œé¡ºåº == æ§åˆ¶æ—¶åºï¼Œå³æ‰€æœ‰æƒ³è¦è·å¾—é”çš„ç”¨æˆ·éƒ½ä¼šè¢«å®‰æ’æ‰§è¡Œï¼Œä½†æ˜¯è·å¾—é”çš„é¡ºåºä¹Ÿæ˜¯å…¨å±€å”¯ä¸€çš„ï¼ŒåŒæ—¶å†³å®šäº†æ‰§è¡Œé¡ºåºã€‚etcdä¸ºæ­¤ä¹Ÿæä¾›äº†ä¸€å¥—APIï¼ˆè‡ªåŠ¨åˆ›å»ºæœ‰åºé”®ï¼‰ï¼Œå¯¹ä¸€ä¸ªç›®å½•å»ºå€¼æ—¶æŒ‡å®šä¸ºPOSTåŠ¨ä½œï¼Œè¿™æ ·etcdä¼šè‡ªåŠ¨åœ¨ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå½“å‰æœ€å¤§çš„å€¼ä¸ºé”®ï¼Œå­˜å‚¨è¿™ä¸ªæ–°çš„å€¼ï¼ˆå®¢æˆ·ç«¯ç¼–å·ï¼‰</li>
</ul>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425213236.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425213236.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><br/></p>
<p><strong>åœºæ™¯å…­ï¼šåˆ†å¸ƒå¼é˜Ÿåˆ—</strong><br>åˆ†å¸ƒå¼é˜Ÿåˆ—çš„å¸¸è§„ç”¨æ³•ä¸åœºæ™¯äº”ä¸­æ‰€æè¿°çš„åˆ†å¸ƒå¼é”çš„æ§åˆ¶æ—¶åºç”¨æ³•ç±»ä¼¼ï¼Œå³<code>åˆ›å»ºä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ä¿è¯é¡ºåº</code>ã€‚å¦ä¸€ç§æ¯”è¾ƒæœ‰æ„æ€çš„å®ç°æ˜¯åœ¨ä¿è¯é˜Ÿåˆ—è¾¾åˆ°æŸä¸ªæ¡ä»¶æ—¶å†ç»Ÿä¸€æŒ‰é¡ºåºæ‰§è¡Œ,è¿™ç§æ–¹æ³•çš„å®ç°å¯ä»¥åœ¨/queueè¿™ä¸ªç›®å½•ä¸­å¦å¤–å»ºç«‹ä¸€ä¸ª/queue/conditionèŠ‚ç‚¹ã€‚;</p>
<ul>
<li>conditionå¯ä»¥è¡¨ç¤ºé˜Ÿåˆ—å¤§å°</li>
<li>conditionå¯ä»¥è¡¨ç¤ºæŸä¸ªä»»åŠ¡åœ¨ä¸åœ¨é˜Ÿåˆ—</li>
<li>conditionè¿˜å¯ä»¥è¡¨ç¤ºå…¶å®ƒçš„ä¸€ç±»å¼€å§‹æ‰§è¡Œä»»åŠ¡çš„é€šçŸ¥</li>
</ul>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425213432.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425213432.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p><br/></p>
<p><strong>åœºæ™¯ä¸ƒï¼šé›†ç¾¤ç›‘æ§ä¸Leaderç«é€‰</strong><br>é€šè¿‡etcdæ¥è¿›è¡Œç›‘æ§å®ç°èµ·æ¥éå¸¸ç®€å•å¹¶ä¸”å®æ—¶æ€§å¼ºã€‚ æ¯”å¦‚é€šè¿‡Watcheræœºåˆ¶ï¼Œå½“æŸä¸ªèŠ‚ç‚¹æ¶ˆå¤±æˆ–æœ‰å˜åŠ¨æ—¶ï¼ŒWatcherä¼šç¬¬ä¸€æ—¶é—´å‘ç°å¹¶å‘ŠçŸ¥ç”¨æˆ·ï¼ŒåŒæ—¶èŠ‚ç‚¹å¯ä»¥è®¾ç½®TTL keyï¼Œè¿›è¡ŒèŠ‚ç‚¹å­˜æ´»å¥åº·çŠ¶æ€çš„æ£€æµ‹ï¼Œä»¥å®Œæˆé›†ç¾¤çš„ç›‘æ§è¦æ±‚;</p>
<p>å¦å¤–ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œå¯ä»¥å®ŒæˆLeaderç«é€‰,é€šå¸¸æ˜¯ä¸€äº›é•¿æ—¶é—´CPUè®¡ç®—æˆ–è€…ä½¿ç”¨IOæ“ä½œçš„æœºå™¨ï¼Œåªéœ€è¦ç«é€‰å‡ºçš„Leaderè®¡ç®—æˆ–å¤„ç†ä¸€æ¬¡ï¼Œå°±å¯ä»¥æŠŠç»“æœå¤åˆ¶ç»™å…¶ä»–çš„Follower,ä»è€Œé¿å…é‡å¤åŠ³åŠ¨èŠ‚çœè®¡ç®—èµ„æºã€‚</p>
<p>è¯¥ç»å…¸åœºæ™¯æ˜¯æœç´¢ç³»ç»Ÿä¸­å»ºç«‹å…¨é‡ç´¢å¼•ï¼Œé€šè¿‡åœ¨etcdçš„CASæœºåˆ¶åŒæ—¶åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œ<code>åˆ›å»ºæˆåŠŸçš„æœºå™¨ä½œä¸ºLeaderè¿›è¡Œç´¢å¼•è®¡ç®—</code>ï¼Œç„¶åæŠŠè®¡ç®—ç»“æœåˆ†å‘åˆ°å…¶å®ƒèŠ‚ç‚¹ã€‚</p>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425220406.png" target="_blank" title="WeiyiGeek." data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200425220406.png" alt="WeiyiGeek." title="" class=""></a>
                <p>WeiyiGeek.</p>
            </figure>
<p>Q:ä¸ºä»€ä¹ˆç”¨etcdè€Œä¸ç”¨ZooKeeperï¼Ÿ<br>ç›¸è¾ƒä¹‹ä¸‹ZooKeeperæœ‰å¦‚ä¸‹ç¼ºç‚¹ï¼š</p>
<ul>
<li>ZooKeeperçš„éƒ¨ç½²ç»´æŠ¤å¤æ‚ï¼Œç®¡ç†å‘˜éœ€è¦æŒæ¡ä¸€ç³»åˆ—çš„çŸ¥è¯†å’ŒæŠ€èƒ½;è€ŒPaxoså¼ºä¸€è‡´æ€§ç®—æ³•ä¹Ÿæ˜¯ç´ æ¥ä»¥å¤æ‚éš¾æ‡‚è€Œé—»åäºä¸–</li>
<li>Javaç¼–å†™æœ¬èº«å°±åå‘äºé‡å‹åº”ç”¨ï¼Œå®ƒä¼šå¼•å…¥å¤§é‡çš„ä¾èµ–ã€‚è€Œè¿ç»´äººå‘˜åˆ™æ™®éå¸Œæœ›ä¿æŒå¼ºä¸€è‡´ã€é«˜å¯ç”¨çš„æœºå™¨é›†ç¾¤å°½å¯èƒ½ç®€å•ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿä¸æ˜“å‡ºé”™ã€‚</li>
<li>å‘å±•ç¼“æ…¢,ApacheåŸºé‡‘ä¼šé¡¹ç›®ç‰¹æœ‰çš„â€œApache Wayâ€åœ¨å¼€æºç•Œé¥±å—äº‰è®®,ç”±äºåŸºé‡‘ä¼šåºå¤§çš„ç»“æ„ä»¥åŠæ¾æ•£çš„ç®¡ç†å¯¼è‡´é¡¹ç›®å‘å±•ç¼“æ…¢ã€‚</li>
</ul>
<p>è€Œetcdä½œä¸ºä¸€ä¸ªåèµ·ä¹‹ç§€å…¶ä¼˜ç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ã€‚</p>
<ul>
<li>Goè¯­è¨€ç¼–å†™éƒ¨ç½²ç®€å•ï¼›ä½¿ç”¨HTTPä½œä¸ºæ¥å£ä½¿ç”¨ç®€å•ï¼›ä½¿ç”¨Raftç®—æ³•ä¿è¯å¼ºä¸€è‡´æ€§è®©ç”¨æˆ·æ˜“äºç†è§£ã€‚</li>
<li>æ•°æ®æŒä¹…åŒ–ï¼Œetcdé»˜è®¤æ•°æ®ä¸€æ›´æ–°å°±è¿›è¡ŒæŒä¹…åŒ–ã€‚</li>
<li>å®‰å…¨ï¼Œetcdæ”¯æŒSSLå®¢æˆ·ç«¯å®‰å…¨è®¤è¯ã€‚</li>
</ul>
<p><br></p>
<h5 id="2-Etcdé€‰ä¸»åœ¨Goä¸­çš„å®è·µ"><a href="#2-Etcdé€‰ä¸»åœ¨Goä¸­çš„å®è·µ" class="headerlink" title="2.Etcdé€‰ä¸»åœ¨Goä¸­çš„å®è·µ"></a>2.Etcdé€‰ä¸»åœ¨Goä¸­çš„å®è·µ</h5><p>é¡¹ç›®ä¸­å¦‚ä½•åˆ©ç”¨etcdçš„é€‰ä¸»æœºåˆ¶æ¥å®ç°åº”ç”¨çš„é«˜å¯ç”¨?<br>ç­”:æ­¤æ—¶æ‚¨éœ€è¦å¾€ä¸‹çœ‹ï¼Œæ‚¨å°±èƒ½æ‰¾åˆ°æ‚¨çš„ç­”æ¡ˆï¼›</p>
<p>ç¯å¢ƒè¯´æ˜:å‡å¦‚æ‚¨æ­¤æ—¶å·²ç»æŒ‰ç…§å‰é¢å®‰è£…Goç¯å¢ƒè¿›è¡Œäº†å®‰è£…;</p>
<p>Step1.é‡‡ç”¨goå®‰è£…Clientv3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get <span class="string">"github.com/coreos/etcd/clientv3"</span></span><br></pre></td></tr></table></figure></p>
<p>Step2.æ·»åŠ å¸¸é‡<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> prefix = <span class="string">"/nanoPing"</span></span><br><span class="line"><span class="keyword">const</span> prop = <span class="string">"local"</span></span><br><span class="line"><span class="keyword">var</span> leaderFlag <span class="keyword">bool</span></span><br></pre></td></tr></table></figure></p>
<p>Step3.ç¼–å†™clientèŠ‚ç‚¹ç«é€‰å‡½æ•°campaign<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">campaign</span><span class="params">(c *clientv3.Client, election <span class="keyword">string</span>, prop <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="comment">//gets the leased session for a client(è·å–å®¢æˆ·ç«¯ç§Ÿç”¨çš„ä¼šè¯)</span></span><br><span class="line">      s, err := concurrency.NewSession(c, concurrency.WithTTL(<span class="number">15</span>))</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         log.Println(err)</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//returns a new election on a given key prefix(è¿”å›å¯¹ç»™å®šé”®å‰ç¼€çš„æ–°é€‰æ‹©)</span></span><br><span class="line">      e := concurrency.NewElection(s, election)</span><br><span class="line">      ctx := context.TODO()</span><br><span class="line"></span><br><span class="line">      <span class="comment">//Campaign puts a value as eligible for the election on the prefix key.</span></span><br><span class="line">      <span class="comment">//Multiple sessions can participate in the election for the same prefix, |å¤šå±Šä¼šè®®å¯å‚åŠ åŒä¸€å‰ç¼€çš„é€‰ä¸¾ï¼Œ</span></span><br><span class="line">      <span class="comment">//but only one can be the leader at a time ä½†æ˜¯ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªé¢†å¯¼è€…</span></span><br><span class="line">      <span class="keyword">if</span> err = e.Campaign(ctx, prop); err != <span class="literal">nil</span> &#123;</span><br><span class="line">         log.Println(err)</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      log.Println(<span class="string">"elect: success"</span>)</span><br><span class="line"></span><br><span class="line">      leaderFlag = <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> &lt;-s.Done():</span><br><span class="line">         leaderFlag = <span class="literal">false</span></span><br><span class="line">         log.Println(<span class="string">"elect: expired"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step4.æ·»åŠ ç«é€‰æˆåŠŸåæ‰§è¡Œçš„åŠ¨ä½œrun<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">  log.Println(<span class="string">"[info] Service master"</span>)</span><br><span class="line">  log.Println(<span class="string">"[info] Task start."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step5.ç¼–å†™å…¥å£å‡½æ•°ï¼Œåˆ›å»ºclientèŠ‚ç‚¹ï¼Œå‚ä¸ç«é€‰masterï¼Œç«é€‰æˆåŠŸæ‰§è¡Œä»»åŠ¡ã€‚<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line">   donec := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">//create a client åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">   cli, err := clientv3.New(clientv3.Config&#123;Endpoints: g.Config().Etcd.Addr,Username:g.Config().Etcd.User,Password:g.Config().Etcd.Password&#125;)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Fatal(err)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">go</span> campaign(cli, prefix, prop)</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      ticker := time.NewTicker(time.Duration(<span class="number">10</span>) * time.Second)</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">         <span class="keyword">select</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="keyword">if</span> leaderFlag == <span class="literal">true</span> &#123;</span><br><span class="line">                run()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.Println(<span class="string">"[info] Service is not master"</span>)</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;()</span><br><span class="line">   &lt;-donec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œç»“æœ:<br><figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423162334.png" target="_blank" title="WeiyiGeek.é€‰ä¸»" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200423162334.png" alt="WeiyiGeek.é€‰ä¸»" title="" class=""></a>
                <p>WeiyiGeek.é€‰ä¸»</p>
            </figure></p>
<p><em>æ€»ç»“:</em><br>é€šè¿‡etcdä¸­çš„é€‰ä¸»æœºåˆ¶æˆ‘ä»¬å®ç°äº†æœåŠ¡çš„é«˜å¯ç”¨ã€‚åŒæ—¶åˆ©ç”¨systemdå¯¹etcdæœ¬èº«è¿›è¡Œäº†ä¿æ´»ï¼Œåªè¦etcdæœåŠ¡æ‰€åœ¨çš„æœºå™¨æ²¡æœ‰å®•æœºï¼Œè¿›ç¨‹å°±å…·å¤‡äº†å®¹ç¾æ€§ã€‚å½“ç„¶ä¸€ä¸ªetcdé›†ç¾¤ä¸ä»…ä»…å¯ä»¥å¯¹ä¸€ä¸ªæœåŠ¡æä¾›é«˜å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤šä¸ªæœåŠ¡æ³¨å†Œåœ¨ä¸€ä¸ªetcdé›†ç¾¤ä¸­ï¼ŒåŒæ—¶åˆ©ç”¨etcdæ‰€æä¾›çš„å…±äº«é…ç½®å’ŒæœåŠ¡å‘ç°ï¼Œæ­¤å¤–etcdè¿˜æœ‰å¾ˆå¤šå€¼å¾—æ·±å…¥ç ”ç©¶çš„æŠ€æœ¯ï¼Œæ¯”å¦‚raftä¸€è‡´æ€§ç®—æ³•ç­‰ç­‰;</p>
<hr>
<h4 id="0x04-å‘½ä»¤-amp-è„šæœ¬"><a href="#0x04-å‘½ä»¤-amp-è„šæœ¬" class="headerlink" title="0x04 å‘½ä»¤&amp;è„šæœ¬"></a>0x04 å‘½ä»¤&amp;è„šæœ¬</h4><h5 id="etcd-å‘½ä»¤"><a href="#etcd-å‘½ä»¤" class="headerlink" title="etcd å‘½ä»¤"></a>etcd å‘½ä»¤</h5><p>é…ç½®æ–‡ä»¶è¯´å˜›<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">#### [Memberflags]</span><br><span class="line"># memberæˆå‘˜åç§°</span><br><span class="line">â€“name </span><br><span class="line"># æ•°æ®å­˜å‚¨è·¯å¾„</span><br><span class="line">â€“data-dir</span><br><span class="line">â€“wal-dir</span><br><span class="line">â€“snapshot-count</span><br><span class="line">â€“heartbeat-interval</span><br><span class="line">â€“election-timeout</span><br><span class="line">â€“listen-peer-urls</span><br><span class="line">â€“listen-client-urls</span><br><span class="line">â€“max-snapshots</span><br><span class="line">â€“max-wals</span><br><span class="line">â€“cors</span><br><span class="line">â€“quota-backend-bytes</span><br><span class="line">â€“backend-batch-limit</span><br><span class="line">â€“backend-bbolt-freelist-type</span><br><span class="line">â€“backend-batch-interval</span><br><span class="line">â€“max-txn-ops</span><br><span class="line">â€“max-request-bytes</span><br><span class="line">â€“grpc-keepalive-min-time</span><br><span class="line">â€“grpc-keepalive-interval</span><br><span class="line">â€“grpc-keepalive-timeout</span><br><span class="line"></span><br><span class="line">#### [Clustering flags]</span><br><span class="line">â€“initial-advertise-peer-urls</span><br><span class="line">â€“initial-cluster</span><br><span class="line">â€“initial-cluster-state</span><br><span class="line">â€“initial-cluster-token: å‚æ•°ä¸ºæ¯ä¸ªé›†ç¾¤å•ç‹¬é…ç½®ä¸€ä¸ªtokenè®¤è¯,ç¡®ä¿æ¯ä¸ªé›†ç¾¤å’Œé›†ç¾¤çš„æˆå‘˜éƒ½æ‹¥æœ‰ç‹¬ç‰¹çš„IDã€‚</span><br><span class="line">â€“advertise-client-urls</span><br><span class="line">â€“discovery</span><br><span class="line">â€“discovery-srv</span><br><span class="line">â€“discovery-srv-name</span><br><span class="line">â€“discovery-fallback</span><br><span class="line">â€“discovery-proxy</span><br><span class="line">â€“strict-reconfig-check</span><br><span class="line">â€“auto-compaction-retention</span><br><span class="line">â€“auto-compaction-mode</span><br><span class="line">â€“enable-v2  #Flannelæ“ä½œetcdä½¿ç”¨çš„æ˜¯v2çš„APIï¼Œè€Œkubernetesæ“ä½œetcdä½¿ç”¨çš„v3çš„APIï¼Œä¸ºäº†å…¼å®¹Flannelç½‘ç»œ</span><br><span class="line">Proxy flags</span><br><span class="line">â€“proxy</span><br><span class="line">â€“proxy-failure-wait</span><br><span class="line">â€“proxy-refresh-interval</span><br><span class="line">â€“proxy-dial-timeout</span><br><span class="line">â€“proxy-write-timeout</span><br><span class="line">â€“proxy-read-timeout</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## [Security flags]</span><br><span class="line">â€“ca-file   #SSL CAæ ¹è¯ä¹¦æ–‡ä»¶</span><br><span class="line">â€“cert-file #SSL è¯ä¹¦æ–‡ä»¶</span><br><span class="line">â€“key-file  #SSL è¯ä¹¦å¯†é’¥æ–‡ä»¶</span><br><span class="line">â€“client-cert-auth</span><br><span class="line">â€“client-crl-file</span><br><span class="line">â€“client-cert-allowed-hostname</span><br><span class="line">â€“trusted-ca-file #ä¿¡ä»»çš„ SSL CAæ ¹è¯ä¹¦æ–‡ä»¶</span><br><span class="line">â€“auto-tls</span><br><span class="line">â€“peer-ca-file   #é›†ç¾¤æˆå‘˜ç«¯ç‚¹SSL CAæ ¹è¯ä¹¦æ–‡ä»¶</span><br><span class="line">â€“peer-cert-file  #é›†ç¾¤æˆå‘˜ç«¯ç‚¹SSL è¯ä¹¦æ–‡ä»¶</span><br><span class="line">â€“peer-key-file   #é›†ç¾¤æˆå‘˜ç«¯ç‚¹SSL è¯ä¹¦å¯†é’¥æ–‡ä»¶</span><br><span class="line">â€“peer-client-cert-auth</span><br><span class="line">â€“peer-crl-file</span><br><span class="line">â€“peer-trusted-ca-file #é›†ç¾¤æˆå‘˜ç«¯ç‚¹ ä¿¡ä»»çš„ SSL CAæ ¹è¯ä¹¦æ–‡ä»¶</span><br><span class="line">â€“peer-auto-tls</span><br><span class="line">â€“peer-cert-allowed-cn</span><br><span class="line">â€“peer-cert-allowed-hostname</span><br><span class="line">â€“cipher-suites</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## [Logging flags]</span><br><span class="line">â€“logger</span><br><span class="line">â€“log-outputs</span><br><span class="line">â€“log-level</span><br><span class="line">â€“debug</span><br><span class="line">â€“log-package-levels</span><br><span class="line"></span><br><span class="line">## [Unsafe flags]</span><br><span class="line">â€“force-new-cluster</span><br><span class="line"></span><br><span class="line">## [Miscellaneous flags]</span><br><span class="line">â€“version</span><br><span class="line">â€“config-file</span><br><span class="line"></span><br><span class="line">## [Profiling flags]</span><br><span class="line">â€“enable-pprof</span><br><span class="line">â€“metrics</span><br><span class="line">â€“listen-metrics-urls</span><br><span class="line"></span><br><span class="line">## [Auth flags]</span><br><span class="line">â€“auth-token</span><br><span class="line">â€“bcrypt-cost</span><br><span class="line"></span><br><span class="line">## [Experimental flags]</span><br><span class="line">â€“experimental-corrupt-check-time</span><br><span class="line">â€“experimental-compaction-batch-limit</span><br><span class="line">â€“experimental-peer-skip-client-san-verification</span><br></pre></td></tr></table></figure></p>
<h5 id="etcdctl-å‘½ä»¤"><a href="#etcdctl-å‘½ä»¤" class="headerlink" title="etcdctl å‘½ä»¤"></a>etcdctl å‘½ä»¤</h5><p>å¸¸ç”¨å‘½ä»¤:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¢åˆ æ”¹æŸ¥</span></span><br><span class="line">etcdctl put [key] [value]</span><br><span class="line">etcdctl get [key]</span><br><span class="line">etcdctl del [key]</span><br></pre></td></tr></table></figure></p>
<p>åŸºç¡€å®ä¾‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#(1)æ ¡éªŒæˆå‘˜çŠ¶æ€ä»¥åŠæ“ä½œ</span></span><br><span class="line"><span class="variable">$etcdctl</span> member list </span><br><span class="line">   member add     <span class="comment">#Adds a member into the cluster</span></span><br><span class="line">   member list    <span class="comment">#Lists all members in the cluster</span></span><br><span class="line">   member promote <span class="comment">#Promotes a non-voting member in the cluster</span></span><br><span class="line">   member remove  <span class="comment">#Removes a member from the cluster</span></span><br><span class="line">   member update  <span class="comment">#Updates a member in the cluster</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#(2)æ£€æŸ¥etcdé›†ç¾¤çš„çŠ¶æ€æ€§èƒ½   </span></span><br><span class="line"><span class="variable">$etcdctl</span> --endpoints=<span class="variable">$ENDPOINTS</span> check perf</span><br><span class="line"><span class="comment">#60 / 60 Booooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo! 100.00% 1m0s</span></span><br><span class="line">   etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> endpoint health</span><br><span class="line">   etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> endpoint status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#(3)è®¤è¯ç›¸å…³</span></span><br><span class="line">   auth <span class="built_in">disable</span>   <span class="comment"># Disables authentication</span></span><br><span class="line">   auth <span class="built_in">enable</span>    <span class="comment"># Enables authentication</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#(4)ç”¨æˆ·ç›¸å…³</span></span><br><span class="line">   user add                <span class="comment">#Adds a new user</span></span><br><span class="line">   user delete             <span class="comment">#Deletes a user</span></span><br><span class="line">   user get                <span class="comment">#Gets detailed information of a user</span></span><br><span class="line">   user grant-role         <span class="comment">#Grants a role to a user</span></span><br><span class="line">   user list               <span class="comment">#Lists all users</span></span><br><span class="line">   user passwd             <span class="comment">#Changes password of user</span></span><br><span class="line">   user revoke-role        <span class="comment">#Revokes a role from a user</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#(5)è§’è‰²æƒé™ç›¸å…³</span></span><br><span class="line">   role add                <span class="comment">#Adds a new role</span></span><br><span class="line">   role delete             <span class="comment">#Deletes a role</span></span><br><span class="line">   role get                <span class="comment">#Gets detailed information of a role</span></span><br><span class="line">   role grant-permission   <span class="comment">#Grants a key to a role</span></span><br><span class="line">   role list               <span class="comment">#Lists all roles</span></span><br><span class="line">   role revoke-permission  <span class="comment">#Revokes a key from a role</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h5 id="ä¸€é”®å®‰è£…é›†ç¾¤è„šæœ¬"><a href="#ä¸€é”®å®‰è£…é›†ç¾¤è„šæœ¬" class="headerlink" title="ä¸€é”®å®‰è£…é›†ç¾¤è„šæœ¬"></a>ä¸€é”®å®‰è£…é›†ç¾¤è„šæœ¬</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Desc: Etcdé›†ç¾¤ä¸€ä»¶å®‰è£…</span></span><br><span class="line"><span class="comment"># Author: WeiyiGeek</span></span><br><span class="line"><span class="comment"># Create: 2020å¹´4æœˆ24æ—¥ 09:48:48</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[å…¨å±€å˜é‡]</span></span><br><span class="line"><span class="built_in">export</span> ETCD_VER=v3.4.7</span><br><span class="line"><span class="built_in">export</span> ETCD_SRCNAME=etcd-<span class="variable">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">export</span> ETCD_URL=https://github.com/etcd-io/etcd/releases/download/<span class="variable">$&#123;ETCD_VER&#125;</span>/<span class="variable">$&#123;ETCD_SRCNAME&#125;</span></span><br><span class="line"><span class="built_in">export</span> ETCD_DIR=/usr/<span class="built_in">local</span>/etcd</span><br><span class="line"><span class="built_in">export</span> ETCD_CONF=/etc/etcd</span><br><span class="line"><span class="built_in">export</span> ETCD_DATA=/apps/etcd/data</span><br><span class="line"><span class="built_in">export</span> ETCD_NODE1=192.168.10.241</span><br><span class="line"><span class="built_in">export</span> ETCD_NODE2=192.168.10.242</span><br><span class="line"><span class="built_in">export</span> ETCD_NODE3=192.168.10.243</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Usage</span></span>()&#123;</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\e[33m#Usage:<span class="variable">$0</span> node[1~3].weiyigeek.top\n#Example: NODENAME = node[1~3] \n\n\e[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Usage</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -xue</span><br><span class="line"><span class="built_in">export</span> CURRENT_NODE=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">export</span> NODE_NAME=<span class="variable">$&#123;CURRENT_NODE%%.*&#125;</span></span><br><span class="line"><span class="built_in">export</span> NODE_DOMAIN=<span class="variable">$&#123;CURRENT_NODE#*.&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[ä½¿ç”¨å¸®åŠ©]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">BeforeSetting</span></span>()&#123;</span><br><span class="line">  <span class="comment">#1.å½“å‰æœºå™¨hostnameè®¾ç½®</span></span><br><span class="line">  hostnamectl <span class="built_in">set</span>-hostname <span class="variable">$&#123;NODE_NAME&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#2.é…ç½®/etc/hosts</span></span><br><span class="line">rm -rf /etc/hosts</span><br><span class="line">cat &lt;&lt;END &gt;/etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="variable">$ETCD_NODE1</span> node1.<span class="variable">$&#123;NODE_DOMAIN&#125;</span></span><br><span class="line"><span class="variable">$ETCD_NODE2</span> node2.<span class="variable">$&#123;NODE_DOMAIN&#125;</span></span><br><span class="line"><span class="variable">$ETCD_NODE3</span> node3.<span class="variable">$&#123;NODE_DOMAIN&#125;</span></span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">  <span class="comment">#3.é˜²ç«å¢™é…ç½®</span></span><br><span class="line">  firewall-cmd --permanent --zone=public --add-port=2379-2380/tcp </span><br><span class="line">  firewall-cmd --reload</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#[æš‚æ—¶æ²¡ç”¨]</span></span><br><span class="line"><span class="comment"># function ChangeDownUrl()&#123;</span></span><br><span class="line"><span class="comment">#   ETCD_URL=$(echo $1 | sed 's/raw.githubusercontent.com/cdn.jsdelivr.net\/gh/' \</span></span><br><span class="line"><span class="comment">#                | sed 's/github.com/cdn.jsdelivr.net\/gh/' \</span></span><br><span class="line"><span class="comment">#                | sed 's/\/master//' | sed 's/\/blob//' )</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Download</span></span>()&#123;</span><br><span class="line">  <span class="keyword">if</span> [[ ! -f ./<span class="variable">$&#123;ETCD_SRCNAME&#125;</span> ]];<span class="keyword">then</span></span><br><span class="line">    curl -L <span class="variable">$&#123;DOWNLOAD_URL&#125;</span>/<span class="variable">$&#123;ETCD_VER&#125;</span>/etcd-<span class="variable">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz -o etcd-<span class="variable">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"#<span class="variable">$&#123;ETCD_SRCNAME&#125;</span> Already Exsit!"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Install</span></span>()&#123;</span><br><span class="line">  <span class="comment">#å®‰è£…éªŒè¯</span></span><br><span class="line">  <span class="keyword">if</span> [[ ! -d <span class="variable">$&#123;ETCD_DIR&#125;</span> ]];<span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;ETCD_DIR&#125;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    rm -rf <span class="variable">$&#123;ETCD_DIR&#125;</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;ETCD_DIR&#125;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#æ•°æ®å­˜å‚¨</span></span><br><span class="line">  mkdir -vp  <span class="variable">$&#123;ETCD_DATA&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#è§£å‹</span></span><br><span class="line">  tar xzvf <span class="variable">$&#123;ETCD_SRCNAME&#125;</span> -C <span class="variable">$&#123;ETCD_DIR&#125;</span> --strip-components=1</span><br><span class="line"></span><br><span class="line">  <span class="comment">#åˆ¤æ–­è½¯ä»¶é“¾æ¥</span></span><br><span class="line">  <span class="keyword">if</span> [[ ! -f /usr/bin/etcd ]];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"#links File Not Exsit!"</span></span><br><span class="line">    ln -s <span class="variable">$&#123;ETCD_DIR&#125;</span>/etcd /usr/bin</span><br><span class="line">    ln -s <span class="variable">$&#123;ETCD_DIR&#125;</span>/etcdctl /usr/bin</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸå¦åˆ™åœæ­¢å®‰è£…</span></span><br><span class="line">  /usr/bin/etcd --version</span><br><span class="line">  /usr/bin/etcdctl version</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [[ $? -ne 0 ]];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\e[31m#Install Error!\e[0m"</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">AfterSetting</span></span>()&#123;</span><br><span class="line">  <span class="comment">#Etcdé…ç½®</span></span><br><span class="line">  rm -rf <span class="variable">$&#123;ETCD_CONF&#125;</span>/etcd.conf</span><br><span class="line">  mkdir -vp <span class="variable">$&#123;ETCD_CONF&#125;</span> /var/lib/etcd/</span><br><span class="line">  <span class="built_in">export</span> CURRENT_HOST=$(cat /etc/hosts | grep <span class="variable">$&#123;NODE_NAME&#125;</span> | awk -F <span class="string">" "</span> <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">cat &gt; <span class="variable">$&#123;ETCD_CONF&#125;</span>/etcd.conf &lt;&lt;END</span><br><span class="line">[member]</span><br><span class="line">ETCD_NAME=<span class="variable">$&#123;NODE_NAME&#125;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="variable">$&#123;ETCD_DATA&#125;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"http://<span class="variable">$&#123;CURRENT_HOST&#125;</span>:2379,http://127.0.0.1:2379"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"http://<span class="variable">$&#123;CURRENT_HOST&#125;</span>:2380"</span></span><br><span class="line"></span><br><span class="line">[cluster]</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"http://<span class="variable">$&#123;CURRENT_NODE&#125;</span>:2379"</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"http://<span class="variable">$&#123;CURRENT_NODE&#125;</span>:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"node1=http://node1.<span class="variable">$&#123;NODE_DOMAIN&#125;</span>:2380,node2=http://node2.<span class="variable">$&#123;NODE_DOMAIN&#125;</span>:2380,node3=http://node3.<span class="variable">$&#123;NODE_DOMAIN&#125;</span>:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br><span class="line"></span><br><span class="line"><span class="comment"># [version]</span></span><br><span class="line"><span class="comment"># ETCD_ENABLE_V2=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Security]</span></span><br><span class="line"><span class="comment"># ETCD_CERT_FILE="/opt/etcd/ssl/server.pem"</span></span><br><span class="line"><span class="comment"># ETCD_KEY_FILE="/opt/etcd/ssl/server-key.pem"</span></span><br><span class="line"><span class="comment"># ETCD_TRUSTED_CA_FILE="/opt/etcd/ssl/ca.pem"</span></span><br><span class="line"><span class="comment"># ETCD_CLIENT_CERT_AUTH="true"</span></span><br><span class="line"><span class="comment"># ETCD_PEER_CERT_FILE="/opt/etcd/ssl/server.pem"</span></span><br><span class="line"><span class="comment"># ETCD_PEER_KEY_FILE="/opt/etcd/ssl/server-key.pem"</span></span><br><span class="line"><span class="comment"># ETCD_PEER_TRUSTED_CA_FILE="/opt/etcd/ssl/ca.pem"</span></span><br><span class="line"><span class="comment"># ETCD_PEER_CLIENT_CERT_AUTH="true"</span></span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"> <span class="comment">#systemdé…ç½®</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt;END</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">Documentation=https://github.com/etcd-io/etcd</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">ExecStart=/usr/bin/etcd</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=3</span><br><span class="line">LimitNOFILE=655350</span><br><span class="line">LimitNPROC=655350</span><br><span class="line">PrivateTmp=<span class="literal">false</span></span><br><span class="line">SuccessExitStatus=143</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"> <span class="comment">#Reload systemd manager configuration</span></span><br><span class="line"> systemctl daemon-reload</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ServiceRun</span></span>()&#123;</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"#æ­£åœ¨å¯åŠ¨EtcdæœåŠ¡"</span></span><br><span class="line">  systemctl restart etcd.service</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"#å½“æ‰€æœ‰èŠ‚ç‚¹å¯åŠ¨åè¿è¡Œä»¥ä¸‹è„šæœ¬æˆ–è€… cat etcd.txt æŸ¥çœ‹"</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"ENDPOINTS=<span class="variable">$ETCD_NODE1</span>:2379,<span class="variable">$ETCD_NODE2</span>:2379,<span class="variable">$ETCD_NODE3</span>:2379 \netcdctl -w table --endpoints=\$ENDPOINTS endpoint status"</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"ENDPOINTS=<span class="variable">$ETCD_NODE1</span>:2379,<span class="variable">$ETCD_NODE2</span>:2379,<span class="variable">$ETCD_NODE3</span>:2379 \netcdctl -w table --endpoints=\$ENDPOINTS endpoint status"</span> &gt; etcd.txt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BeforeSetting</span><br><span class="line">Download</span><br><span class="line">Install</span><br><span class="line">AfterSetting</span><br><span class="line">ServiceRun</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç† href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200424142339.png" target="_blank" title="WeiyiGeek.è„šæœ¬æ•ˆæœ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2020/1/20200424142339.png" alt="WeiyiGeek.è„šæœ¬æ•ˆæœ" title="" class=""></a>
                <p>WeiyiGeek.è„šæœ¬æ•ˆæœ</p>
            </figure>
<hr>
<h4 id="0x05-å…¥å‘è§£å†³"><a href="#0x05-å…¥å‘è§£å†³" class="headerlink" title="0x05 å…¥å‘è§£å†³"></a>0x05 å…¥å‘è§£å†³</h4><p><strong>é—®é¢˜1.Goä¸‹è½½etcdæ—¶å€™æŠ¥é”™<code>unrecognized import path - install error</code></strong><br>é”™è¯¯ä¿¡æ¯:import path does not begin with hostname<br>è§£å†³åŠæ³•:è®¾ç½®GOROOTç¯å¢ƒå˜é‡æˆ–è€…åˆ é™¤æ‰§è¡Œ<code>unset GOROOT</code></p>
<p><br/></p>
<p><strong>é—®é¢˜2.é‡‡ç”¨systemctlç®¡ç†etcdä¼šè§¦å‘ä»¥ä¸‹ç±»ä¼¼æŠ¥é”™â€œetcd: conflicting environment variable â€œETCD_NAMEâ€ is shadowed by corresponding command-line flag (either unset environment variable or disable flag)â€</strong><br>åŸå› :ETCD3.4ç‰ˆæœ¬ä¼šè‡ªåŠ¨è¯»å–ç¯å¢ƒå˜é‡çš„å‚æ•°ï¼Œæ‰€ä»¥EnvironmentFileæ–‡ä»¶ä¸­æœ‰çš„å‚æ•°ï¼Œä¸éœ€è¦å†æ¬¡åœ¨ExecStartå¯åŠ¨å‚æ•°ä¸­æ·»åŠ äºŒé€‰ä¸€å³å¯è§£å†³(ä½†æ˜¯éœ€è¦æ³¨æ„å®˜ç½‘å¯åŠ¨å‚æ•°æ˜¯å¦æœ‰æ—§å‚æ•°è¢«æ›¿ä»£)</p>
<p><br/></p>
<p><strong>é—®é¢˜3.å‡ºç°ç±»ä¼¼æç¤ºæ— æ³•è·å–æŸä¸ªèŠ‚ç‚¹å¥åº·çŠ¶æ€çš„æç¤º</strong><br>é—®é¢˜æè¿°:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$/opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=<span class="variable">$ENDPOINTS</span> cluster-health</span><br><span class="line">member 11babd38de9e1f0f is healthy: got healthy result from https://10.0.52.13:2379</span><br><span class="line">failed to check the health of member 22436a037c5adb3b on https://10.0.52.14:2379: Get https://10.0.52.14:2379/health: dial tcp 10.0.52.14:2379: i/o timeout</span><br><span class="line">member 22436a037c5adb3b is unreachable: [https://10.0.52.14:2379] are all unreachable</span><br><span class="line">member a5e80429e983b681 is healthy: got healthy result from https://10.0.52.6:2379</span><br></pre></td></tr></table></figure><br>è§£å†³æ–¹å¼:å„ä¸ªä¸»æœºåº”è¯¥å…³é—­firewalldæœåŠ¡;</p>
<p><br/></p>
<p><strong>é—®é¢˜4.request cluster ID mismatch (got 4fb7ed98f0f6d1a7 want 4c0b05dc1b530742)</strong><br>é—®é¢˜æè¿°:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$journalctl</span> -u etcd -f</span><br><span class="line">-- Logs begin at Thu 2019-05-23 14:29:05 CST. --</span><br><span class="line">May 23 15:59:09 k8s.master etcd[13366]: request sent was ignored (cluster ID mismatch: peer[102b996c4aa7e55a]=4fb7ed98f0f6d1a7, <span class="built_in">local</span>=4c0b05dc1b530742)</span><br><span class="line">May 23 15:59:09 k8s.master etcd[13366]: request cluster ID mismatch (got 4fb7ed98f0f6d1a7 want 4c0b05dc1b530742)</span><br><span class="line">May 23 15:59:09 k8s.master etcd[13366]: request sent was ignored (cluster ID mismatch: peer[102b996c4aa7e55a]=4fb7ed98f0f6d1a7, <span class="built_in">local</span>=4c0b05dc1b530742)</span><br><span class="line">May 23 15:59:09 k8s.master etcd[13366]: request cluster ID mismatch (got 4fb7ed98f0f6d1a7 want 4c0b05dc1b530742)</span><br><span class="line">May 23 15:59:09 k8s.master etcd[13366]: request cluster ID mismatch (got 4fb7ed98f0f6d1a7 want 4c0b05dc1b530742)</span><br><span class="line">May 23 15:59:09 k8s.master etcd[13366]: request cluster ID mismatch (got 4fb7ed98f0f6d1a7 want 4c0b05dc1b530742)</span><br></pre></td></tr></table></figure><br>è§£å†³åŠæ³•: åˆ é™¤ç¼“å­˜å¹¶é‡å¯etcd<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/lib/etcd/default.etcd</span><br><span class="line">systemctl restart etcd</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>é—®é¢˜6.æ­å»ºéƒ¨ç½²etcdé›†ç¾¤å¹¶é…ç½®httpsè®¿é—®æ—¶æŠ¥<code>remote error: tls: bad certificate</code>é”™è¯¯</strong></p>
<ul>
<li>é”™è¯¯ä¿¡æ¯: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apr 27 18:39:27 master-225 etcd[3747038]: &#123;<span class="string">"level"</span>:<span class="string">"warn"</span>,<span class="string">"ts"</span>:<span class="string">"2022-04-27T18:39:27.998+0800"</span>,<span class="string">"caller"</span>:<span class="string">"embed/mbed/config_logging.go:169"</span>,<span class="string">"msg"</span>:<span class="string">"rejected connection"</span>,<span class="string">"remote-addr"</span>:<span class="string">"10.10.107.224:47920"</span>,<span class="string">"server-name"</span>:<span class="string">""</span>,<span class="string">"error"</span>:<span class="string">"remote error: tls: bad certificate"</span>&#125;</span><br></pre></td></tr></table></figure></li>
<li>é—®é¢˜åŸå› : ç”±äºä½ è¯ä¹¦ä¸­hostsä¸åŒ…å«ä½ å½“å‰çš„åç§°æˆ–è€…åœ°å€, æ­¤å¤„æˆ‘çš„é—®é¢˜æ˜¯è¯ä¹¦ä¸­ä¸åŒ…æ‹¬SANåœ°å€æˆ–è€…åŸŸåã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> etcd.pem -text -noout | grep  <span class="string">"X509v3 Subject Alternative Name"</span> -A 1</span><br><span class="line">  <span class="comment"># X509v3 Subject Alternative Name:</span></span><br><span class="line">  <span class="comment">#   DNS:etcd1, DNS:etcd2, DNS:etcd3, IP Address:127.0.0.1, IP Address:10.10.107.223, IP Address:10.10.107.224, IP Address:10.10.107.225</span></span><br></pre></td></tr></table></figure></li>
<li>è§£å†³åŠæ³•: é‡æ–°ç­¾å‘è¯ä¹¦<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># etcd è¯ä¹¦è¯·æ±‚æ–‡ä»¶</span></span><br><span class="line">tee etcd-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"10.10.107.223"</span>,</span><br><span class="line">    <span class="string">"10.10.107.224"</span>,</span><br><span class="line">    <span class="string">"10.10.107.225"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨caè¯ä¹¦ç­¾å‘ç”Ÿæˆetcdè¯ä¹¦</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<p><strong>é—®é¢˜6.ä½¿ç”¨<code>etcdctl</code>å‘½ä»¤æŸ¥çœ‹etcdé›†ç¾¤æˆå‘˜æ—¶æŠ¥<code>authentication handshake failed: x509: certificate signed by unknown authority</code>é”™è¯¯ã€‚</strong></p>
<ul>
<li>é”™è¯¯ä¿¡æ¯:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl --endpoints=https://10.10.107.225:2379,https://10.10.107.224:2379,https://10.10.107.223:2379 --write-out=table member list</span><br><span class="line">&#123;<span class="string">"level"</span>:<span class="string">"warn"</span>,<span class="string">"ts"</span>:<span class="string">"2022-04-27T19:38:10.489+0800"</span>,<span class="string">"logger"</span>:<span class="string">"etcd-client"</span>,<span class="string">"caller"</span>:<span class="string">"v3/retry_interceptor.go:62"</span>,<span class="string">"msg"</span>:<span class="string">"retrying of unary invoker failed"</span>,<span class="string">"target"</span>:<span class="string">"etcd-endpoints://0xc0004a68c0/10.10.107.225:2379"</span>,<span class="string">"attempt"</span>:0,<span class="string">"error"</span>:<span class="string">"rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection error: desc = \"transport: authentication handshake failed: x509: certificate signed by unknown authority\""</span>&#125;</span><br><span class="line">Error: context deadline exceeded</span><br></pre></td></tr></table></figure></li>
<li>è§£å†³æ–¹æ³•: ç”±äºé›†ç¾¤é‡‡ç”¨è¯ä¹¦è®¤è¯,æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŒ‡å®šCAä»¥åŠå…¶ç­¾å‘çš„è¯ä¹¦ä¸keyã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints=https://10.10.107.225:2379,https://10.10.107.224:2379,https://10.10.107.223:2379 \</span><br><span class="line">--cacert=<span class="string">"/etc/etcd/pki/ca.pem"</span> --cert=<span class="string">"/etc/etcd/pki/etcd.pem"</span> --key=<span class="string">"/etc/etcd/pki/etcd-key.pem"</span> \</span><br><span class="line">--write-out=table member list</span><br></pre></td></tr></table></figure>
</li>
</ul>

        </div>
        <!-- Google å¹¿å‘Š -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>
  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·ä¸Visit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº" >
    <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ã€è½¬ä¸ªå‘ã€èµä¸ªåŠ©ã€‘</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°†æŒç»­æ•´ç†å‘å¸ƒæ›´å¤šä¼˜è´¨åŸåˆ›æ–‡ç« ï¼ã€‚</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-05-20T05:48:32.234Z" itemprop="dateUpdated">2022-05-20 13:48:32</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/æ•°æ®åº“ç»„ä»¶/EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Kubernetes/æ•°æ®åº“ç»„ä»¶/EtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2020/4-23-476.html" target="_blank" rel="external">https://blog.weiyigeek.top/2020/4-23-476.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">â˜•ï¸ è¯·ä½œè€…å–æ¯å’–å•¡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Etcd/" rel="tag">Etcd</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/4-23-476.html&title=ã€ŠEtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/4-23-476.html&title=ã€ŠEtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/4-23-476.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠEtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/4-23-476.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/4-23-476.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/4-23-603.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">2.Goè¯­è¨€ä¹‹æ ‡å‡†åº“å­¦ä¹ è®°å½•(2)</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/4-22-272.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">æŒç»­é›†æˆgitlab-ci.ymlé…ç½®æ–‡æ¡£åŸºç¡€</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x00-Etcd-ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 Etcd ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x01-å®‰è£…éƒ¨ç½²"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 å®‰è£…éƒ¨ç½²</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-é›†ç¾¤åº”ç”¨"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 é›†ç¾¤åº”ç”¨</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x03-åº”ç”¨ä»‹ç»ä¸å®è·µ"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 åº”ç”¨ä»‹ç»ä¸å®è·µ</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x04-å‘½ä»¤-amp-è„šæœ¬"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 å‘½ä»¤&amp;è„šæœ¬</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x05-å…¥å‘è§£å†³"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x05 å…¥å‘è§£å†³</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- æ”¯ä»˜å®å¾®ä¿¡æ–‡ç« èµèµ -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå°±è¯·ä½œè€…å–æ¯ Coffee â˜•ï¸â˜•ï¸!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½çœ‹å‹,æ¬¢è¿å…³æ³¨åšä¸»å¾®ä¿¡å…¬ä¼—å·å“Ÿ! â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘å³å¯å…³é—­ç»§ç»­æµè§ˆæ–‡ç« .<br>  <b style="color:red;"> æ¸©é¦¨æç¤º: æœªè§£é”çš„ç”¨æˆ·ä¸èƒ½ç²˜è´´å¤åˆ¶æ–‡ç« å†…å®¹å“Ÿ!</b> <br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">åšä¸»Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">åšä¸»Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">çŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">å¢¨å¤©è½®</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">å¿«æ‰‹ä¸»é¡µ</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">è¥¿ç“œè§†é¢‘</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.å”¯ä¸€æå®¢ITçŸ¥è¯†åˆ†äº« ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/><a id="SiteRunTime"></a>
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener">
            <img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto">
          </a>
        </div>
      </p>
    </div>
</footer>



    <div class="mask" id="mask"></div>

<div id="go" class="waves-effect waves-light">
  <a href="javascript:;" id="goqrcode"> <span class="icon icon-lg icon-qrcode"></span> </a>
  <a href="javascript:;" id="gotop"> <span class="icon icon-lg icon-chevron-up"></span></a>
</div>





<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2020/4-23-476.html&title=ã€ŠEtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2020/4-23-476.html&title=ã€ŠEtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2020/4-23-476.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠEtcdåŸºç¡€å­¦ä¹ ä¹‹æ¶æ„åŠå·¥ä½œåŸç†ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2020/4-23-476.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2020/4-23-476.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKElEQVR42u3aS27DMAwFwN7/0u62RWr3kXRaWBqtgvin0YIQSX18xOP4MpKrx8s4eyr/yg0DAwPjsYzjclxPNMecPfX6//VynFIxMDA2YOSvvv5A754JGwMDA2MeXnuBGwMDA2PCSEJnngb/W8DFwMB4ICNJYpOP5YW25Km35OIYGBgPZORV97///Zb+BgYGxqMYR3Hc1Tecz+TbOzEwMJZm5AEu2Q72Jh0lqMkbMDAwNmPkjcneRKtlu6i0h4GBsSijWsbq3V8t0pXvx8DAWJrRa1jmbch5wzJvLWBgYKzNyFPQXuKal+16C4GBgbEPY3J4IvpMsWyXvxMDA2NtRn6sYX5ga9IM+OUpDAyMDRjJ5Hol+/zgRfJ/VDXEwMBYjlFNU6utx7ypcEO9EAMDY1FG9TBEHnCrW8bJAmFgYOzDyANiNeHMC3C9RikGBsbajEnQPIJR2JMW7yysHwYGxtKM3rGJapksD/pRJxYDA2NpRl5cy0Ntb/NXPaKBgYGxG6Ma5ibbyvky/ZDEYmBgLM2YvLTanpy0Tk8XEQMDY0tGnmrmyzEvq0W5OAYGxkKMXgC9a6LzZcLAwNiBUQ1zeSpbDcG9bWIZg4GB8VjGXQWySTGu2ijFwMDYk5EHvl44zreJeejHwMDAmITUSYMzT5Kb+1MMDIxtGL1jGQk7v+eGgIuBgfEoRpLE5lfn4fWN5TYMDIwHMiYnNSbJ56RI12xkYmBgPI/xCZhFiYe7gCl8AAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
<script type="text/javascript">
// ç«™ç‚¹è¿è¡Œæ—¶é—´
var BootDate = new Date("2018/01/01 00:00:00");
function ShowRunTime(id) {
  var NowDate = new Date();
  var RunDateM = parseInt(NowDate - BootDate);
  var RunDays = Math.floor(RunDateM/(24*3600*1000));
  var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
  var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
  var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
  var RunTime = RunDays + "å¤©" + RunHours + "æ—¶" + RunMinutes + "åˆ†" + RunSeconds + "ç§’";
  document.getElementById(id).innerHTML = "ç½‘ç«™å·²åœ¨é£é›¨ä¸­å‹‰å‹‰å¼ºå¼ºè¿è¡Œäº†ã€" + RunTime + "ã€‘";
}
setInterval("ShowRunTime('SiteRunTime')", 1000);
</script>
</body>
</html>