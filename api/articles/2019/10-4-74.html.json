{"title":"FTP远程文件传输服务安装与配置","slug":"系统运维/Application/Connect/FTP远程文件传输服务安装与配置","date":"2019-10-04T02:30:30.000Z","updated":"2023-03-07T10:50:25.022Z","url":"2019/10-4-74.html","path":"api/articles/2019/10-4-74.html.json","covers":["https://img.weiyigeek.top/2021/5/20210718141957.png","https://img.weiyigeek.top/2021/5/20210718142754.png"],"content":"<p>[TOC]</p>\n<a id=\"more\"></a>\n<h2 id=\"0x00-前言简述\"><a href=\"#0x00-前言简述\" class=\"headerlink\" title=\"0x00 前言简述\"></a>0x00 前言简述</h2><p>描述: FTP只通过TCP连接,没有用于FTP的UDP组件.FTP不同于其他服务的是它使用了两个端口, 一个数据端口和一个命令端口(或称为控制端口)。通常21端口是命令端口，20端口是数据端口。当混入<code>主动(Active)/被动模式(Passive)</code>的概念时，数据端口就有可能不是20了。</p>\n<p><br></p>\n<h3 id=\"1-FTP主动模式（Active）\"><a href=\"#1-FTP主动模式（Active）\" class=\"headerlink\" title=\"1.FTP主动模式（Active）\"></a>1.FTP主动模式（Active）</h3><p>描述: 该模式下FTP客户端从任意的<code>非特殊的端口（N &gt; 1023）</code> -&gt; 连接到<code>FTP服务器的命令21端口</code>, 然后客户端在 <code>N+1（N+1 &gt;= 1024）</code>端口监听，并且通过N+1（N+1 &gt;= 1024）端口发送命令给FTP服务器 -&gt; 然后 FTP 服务器会返回并通过20端口进行传输数据。</p>\n<p><strong>示例:</strong> 以服务器端防火墙为立足点，要支持主动模式FTP需要打开如下交互中使用到的端口：</p>\n<ul>\n<li>1.FTP服务器命令（21）端口接受客户端任意端口（客户端初始连接）</li>\n<li>2.FTP服务器命令（21）端口到客户端端口（&gt;1023）（服务器响应客户端命令）</li>\n<li>3.FTP服务器数据（20）端口到客户端端口（&gt;1023）（服务器初始化数据连接到客户端数据端口）</li>\n<li>4.FTP服务器数据（20）端口接受客户端端口（&gt;1023）（客户端发送ACK包到服务器的数据端口）</li>\n</ul>\n<p>说明: 在第1步中客户端的命令端口与FTP服务器的命令端口建立连接，并发送命令“PORT 1027”。然后在第2步中，FTP服务器给客户端的命令端口返回一个”ACK”。在第3步中，FTP服务器发起一个从它自己的数据端口（20）到客户端先前指定的数据端口（1027）的连接，最后客户端在第4步中给服务器端返回一个”ACK”。<br><figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210718141957.png\" alt=\"WeiyiGeek.主动模式\" title=\"\" class=\"\">\n                <p>WeiyiGeek.主动模式</p>\n            </figure></p>\n<p>Tips : 在连接FTP服务器时如果没有指定模式它默认使用的是主动模式。</p>\n<p>Tips : 主动方式FTP的主要问题实际上在于客户端。FTP的客户端并没有实际建立一个到服务器数据端口的连接，它只是简单的告诉服务器自己监听的端口号，服务器再回来连接客户端这个指定的端口。对于客户端的防火墙来说，这是从外部系统建立到内部客户端的连接，这是通常会被阻塞的。</p>\n<p><br></p>\n<h3 id=\"2-FTP被动模式-Passive\"><a href=\"#2-FTP被动模式-Passive\" class=\"headerlink\" title=\"2.FTP被动模式 (Passive)\"></a>2.FTP被动模式 (Passive)</h3><p>描述: 在被动方式FTP中命令连接和数据连接都由客户端控制，该模式是解决了服务器发起到客户的连接的问题, 即被动方式或者叫做PASV，当客户端通知服务器它处于被动模式时才启用。</p>\n<p>当开启一个FTP连接时，客户端打开两个任意的非特权本地端口（N &gt; 1024和 N+1），第一个端口连接服务器的21端口，但与主动方式的FTP不同，客户端不会提交PORT命令并允许服务器来回连它的数据端口而是提交PASV命令。这样做的结果是服务器会开启一个任意的非特权端口（P &gt; 1024）并发送PORT命令给客户端, 然后客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。</p>\n<p><strong>示例:</strong> 对于服务器端的防火墙来说，必须允许下面的通讯才能支持被动方式的FTP:</p>\n<ul>\n<li>1.FTP服务器命令（21）端口接受客户端任意端口（客户端初始连接 PASV） 例如 1026</li>\n<li>2.FTP服务器命令（21）端口到客户端端口（&gt;1023）（服务器响应客户端命令）</li>\n<li>3.FTP服务器数据端口（&gt;1023）接受客户端端口（&gt;1023）（客户端初始化数据连接到服务器指定的任意端口）例如 1027 -&gt; 2024</li>\n<li>4.FTP服务器数据端口（&gt;1023）到客户端端口（&gt;1023）（服务器发送ACK响应和数据到客户端的数据端口） 例如 2024 -&gt; 1027</li>\n</ul>\n<p>说明: 在第1步中，客户端的命令端口与服务器的命令端口建立连接，并发送命令“PASV”。然后在第2步中，服务器返回命令”PORT 2024”，告诉客户端（服务器）用哪个端口侦听数据连接。在第3步中，客户端初始化一个从自己的数据端口到服务器端指定的数据端口的数据连接。最后服务器在第4 步中给客户端的数据端口返回一个”ACK”响应。</p>\n<figure class=\"image-box\">\n                <img src=\"https://img.weiyigeek.top/2021/5/20210718142754.png\" alt=\"WeiyiGeek.被动模式\" title=\"\" class=\"\">\n                <p>WeiyiGeek.被动模式</p>\n            </figure>\n<p>Tips : 该模式解决了客户端的许多问题但同时给服务器端带来了更多的问题，例如需要允许从任意远程终端到服务器高位端口的连接。幸运的是许多FTP守护程序，包括流行的WU-FTPD允许管理员指定FTP服务器使用的端口范围。其次是客户端有的支持被动模式，有的不支持被动模式。</p>\n<p><br></p>\n<p><strong>总结:</strong></p>\n<p>Tips ：有读者指出当<code>NAT(Network Address Translation)</code>设备以主动模式访问FTP服务器时，由于NAT设备不会聪明的变更FTP包中的IP地址，从而导致无法访问服务器。</p>\n<p><br></p>\n<p>简单FTP工作连接方式:</p>\n<ul>\n<li>主动FTP：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">命令连接：客户端 &gt;1023端口 -&gt; 服务器 21端口</span><br><span class=\"line\">数据连接：客户端 &gt;1024端口 &lt;- 服务器 20端口</span><br></pre></td></tr></table></figure></li>\n<li>被动FTP：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">命令连接：客户端 &gt;1023端口 -&gt; 服务器 21端口</span><br><span class=\"line\">数据连接：客户端 &gt;1024端口 -&gt; 服务器 &gt; nnnn 端口</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<p>主动与被动FTP优缺点的简要总结：</p>\n<ul>\n<li><ol>\n<li>主动FTP对FTP服务器的管理有利，但对客户端的管理不利。因为FTP服务器企图与客户端的高位随机端口建立连接，而这个端口很有可能被客户端的防火墙阻塞掉。</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>被动FTP对FTP客户端的管理有利，但对服务器端的管理不利。因为客户端要与服务器端建立两个连接，其中一个连到一个高位随机端口，而这个端口很有可能被服务器端的防火墙阻塞掉。</li>\n</ol>\n</li>\n</ul>\n<p>折中方式: 既然FTP服务器的管理员需要他们的服务器有最多的客户连接，那么必须得支持被动FTP。我们可以通过为FTP服务器指定一个有限的端口范围来减小服务器高位端口的暴露, 这样不在这个范围的任何端口会被服务器的防火墙阻塞，虽然这没有消除所有针对服务器的危险，但它大大减少了危险。</p>\n<hr>\n<h2 id=\"0x01-vsftpd-服务\"><a href=\"#0x01-vsftpd-服务\" class=\"headerlink\" title=\"0x01 vsftpd 服务\"></a>0x01 vsftpd 服务</h2><h3 id=\"1-安装说明\"><a href=\"#1-安装说明\" class=\"headerlink\" title=\"1.安装说明\"></a>1.安装说明</h3><p><strong>安装环境:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* CentOS7</span><br><span class=\"line\">* Vsftpd</span><br></pre></td></tr></table></figure><br><br></p>\n<h4 id=\"Centos7部署vsftpd\"><a href=\"#Centos7部署vsftpd\" class=\"headerlink\" title=\"Centos7部署vsftpd\"></a>Centos7部署vsftpd</h4><ol>\n<li>配置防火墙开启FTP服务器需要的端口CentOS 7.0默认使用的是firewall作为防火墙这里改为iptables防火墙(也可以不改)。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1) 关闭firewall：</span><br><span class=\"line\">systemctl stop firewalld.service <span class=\"comment\">#停止firewall</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> firewalld.service <span class=\"comment\">#禁止firewall开机启动</span></span><br><span class=\"line\"></span><br><span class=\"line\">2) 安装iptables防火墙</span><br><span class=\"line\">yum install iptables-services <span class=\"comment\">#安装</span></span><br><span class=\"line\">vi /etc/sysconfig/iptables <span class=\"comment\">#编辑防火墙配置文件</span></span><br><span class=\"line\"><span class=\"comment\"># Firewall configuration written by system-config-firewall</span></span><br><span class=\"line\"><span class=\"comment\"># Manual customization of this file is not recommended.</span></span><br><span class=\"line\">*filter</span><br><span class=\"line\">:INPUT ACCEPT [0:0]</span><br><span class=\"line\">:FORWARD ACCEPT [0:0]</span><br><span class=\"line\">:OUTPUT ACCEPT [0:0]</span><br><span class=\"line\">-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class=\"line\">-A INPUT -p icmp -j ACCEPT</span><br><span class=\"line\">-A INPUT -i lo -j ACCEPT</span><br><span class=\"line\">-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT</span><br><span class=\"line\">-A INPUT -m state --state NEW -m tcp -p tcp --dport 21 -j ACCEPT</span><br><span class=\"line\">-A INPUT -m state --state NEW -m tcp -p tcp --dport 10060:10090 -j ACCEPT</span><br><span class=\"line\">-A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class=\"line\">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class=\"line\">COMMIT</span><br><span class=\"line\">:wq! <span class=\"comment\">#保存退出</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># firewalld-cmd简单明了</span></span><br><span class=\"line\"><span class=\"comment\"># [root@192 ROOT]# firewall-cmd --add-service=ftp --permanent</span></span><br><span class=\"line\"><span class=\"comment\"># success</span></span><br><span class=\"line\"><span class=\"comment\"># [root@192 ROOT]# firewall-cmd --reload</span></span><br><span class=\"line\"><span class=\"comment\"># success</span></span><br><span class=\"line\"></span><br><span class=\"line\">3) 启动iptables服务和自启</span><br><span class=\"line\">systemctl restart iptables.service <span class=\"comment\">#最后重启防火墙使配置生效</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> iptables.service <span class=\"comment\">#设置防火墙开机启动</span></span><br></pre></td></tr></table></figure>\n<p>说明：21端口是ftp服务端口；10060到10090是Vsftpd被动模式需要的端口，可自定义一段大于1024的tcp端口。</p>\n<ol start=\"2\">\n<li>关闭SELINUX<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/selinux/config</span><br><span class=\"line\"><span class=\"comment\">#SELINUX=enforcing #注释掉</span></span><br><span class=\"line\"><span class=\"comment\">#SELINUXTYPE=targeted #注释掉</span></span><br><span class=\"line\">SELINUX=disabled <span class=\"comment\">#增加</span></span><br><span class=\"line\"></span><br><span class=\"line\">:wq! <span class=\"comment\">#保存退出</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#或者</span></span><br><span class=\"line\">setenforce 0 <span class=\"comment\">#使配置立即生效（临时）</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<ol start=\"3\">\n<li><p>安装vsftpd</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y vsftpd <span class=\"comment\">#安装vsftpd</span></span><br><span class=\"line\">yum install -y psmisc net-tools systemd-devel libdb-devel perl-DBI  <span class=\"comment\">#安装vsftpd虚拟用户配置依赖包</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动和自启</span></span><br><span class=\"line\">systemctl start vsftpd.service <span class=\"comment\">#启动</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> vsftpd.service <span class=\"comment\">#设置vsftpd开机启动</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置vsftp服务器</p>\n<blockquote>\n<p>cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf-bak #备份默认配置文件</p>\n</blockquote>\n</li>\n</ol>\n<p>执行以下命令进行设置:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i <span class=\"string\">\"s/anonymous_enable=YES/anonymous_enable=NO/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s/#anon_upload_enable=YES/anon_upload_enable=NO/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s/#anon_mkdir_write_enable=YES/anon_mkdir_write_enable=NO/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s/#chown_uploads=YES/chown_uploads=NO/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s/#async_abor_enable=YES/async_abor_enable=YES/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s/#ascii_upload_enable=YES/ascii_upload_enable=YES/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s/#ascii_download_enable=YES/ascii_download_enable=YES/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\">sed -i <span class=\"string\">\"s/#ftpd_banner=Welcome to blah FTP service./ftpd_banner=Welcome to FTP service.Thanks/g\"</span> <span class=\"string\">'/etc/vsftpd/vsftpd.conf'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#下面是关键点guest_username</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">\"use_localtime=YES\\nlisten_port=21\\nchroot_local_user=YES\\nidle_session_timeout=300</span></span><br><span class=\"line\"><span class=\"string\">\\ndata_connection_timeout=1\\nguest_enable=YES\\nguest_username=vsftpd</span></span><br><span class=\"line\"><span class=\"string\">\\nuser_config_dir=/etc/vsftpd/vconf\\nvirtual_use_local_privs=YES</span></span><br><span class=\"line\"><span class=\"string\">\\npasv_min_port=10000\\npasv_max_port=10100</span></span><br><span class=\"line\"><span class=\"string\">\\naccept_timeout=5\\nconnect_timeout=1\"</span> &gt;&gt; /etc/vsftpd/vsftpd.conf</span><br></pre></td></tr></table></figure></p>\n<ol start=\"5\">\n<li>建立虚拟用户名单文件</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch /etc/vsftpd/virtusers</span><br><span class=\"line\"><span class=\"comment\">#编辑虚拟用户名单文件：（第一行账号，第二行密码，注意：不能使用root做用户名，系统保留）</span></span><br><span class=\"line\">vi /etc/vsftpd/virtusers</span><br><span class=\"line\">web1</span><br><span class=\"line\">123456</span><br><span class=\"line\">web2</span><br><span class=\"line\">123456</span><br><span class=\"line\">web3</span><br><span class=\"line\">123456</span><br><span class=\"line\">:wq! <span class=\"comment\">#保存退出</span></span><br><span class=\"line\"><span class=\"comment\">#或者</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> web &gt; /etc/vsftpd/virtusers</span><br><span class=\"line\"><span class=\"built_in\">echo</span> 123456 &gt; /etc/vsftpd/virtusers</span><br></pre></td></tr></table></figure>\n<ol start=\"6\">\n<li><p>生成虚拟用户数据文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">db_load -T -t <span class=\"built_in\">hash</span> -f /etc/vsftpd/virtusers /etc/vsftpd/virtusers.db</span><br><span class=\"line\">chmod 600 /etc/vsftpd/virtusers.db <span class=\"comment\">#设定PAM验证文件，并指定对虚拟用户数据库文件进行读取</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在/etc/pam.d/vsftpd的文件头部加入以下信息（<code>在后面加入无效</code>）<br>修改前先备份 cp /etc/pam.d/vsftpd /etc/pam.d/vsftpdbak</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/pam.d/vsftpd</span><br><span class=\"line\">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/virtusers</span><br><span class=\"line\">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/virtusers</span><br></pre></td></tr></table></figure>\n<p>注意：如果系统为32位，上面改为lib，否则配置失败</p>\n</li>\n<li><p>新建系统用户vsftpd，用户目录为/home/wwwroot, 用户登录终端设为/bin/false(即使之不能登录系统)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd vsftpd -d /home/wwwroot -s /bin/<span class=\"literal\">false</span></span><br><span class=\"line\">chown vsftpd:vsftpd /home/wwwroot -R</span><br><span class=\"line\">chown vsftpd:nginx /home/wwwroot -R <span class=\"comment\">#如果虚拟用户的宿主用户为www，需要这样设置。（Nginx服务）</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>建立虚拟用户个人Vsftp的配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /etc/vsftpd/vconf &amp;&amp; <span class=\"built_in\">cd</span> /etc/vsftpd/vconf</span><br><span class=\"line\">touch web1 web2 web3 <span class=\"comment\">#这里创建三个虚拟用户配置文件</span></span><br><span class=\"line\">mkdir -p /home/wwwroot/web1/http/</span><br><span class=\"line\"></span><br><span class=\"line\">vi web1 <span class=\"comment\">#编辑用户web1配置文件，其他的跟这个配置文件类似</span></span><br><span class=\"line\">local_root=/home/wwwroot/web1/http/</span><br><span class=\"line\">write_enable=YES</span><br><span class=\"line\">anon_world_readable_only=NO</span><br><span class=\"line\">anon_upload_enable=YES</span><br><span class=\"line\">anon_mkdir_write_enable=YES</span><br><span class=\"line\">anon_other_write_enable=YES</span><br><span class=\"line\">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>最后重启vsftpd服务器</p>\n<blockquote>\n<p>systemctl restart vsftpd.service</p>\n</blockquote>\n</li>\n</ol>\n<p><strong>备注：</strong></p>\n<ul>\n<li>guest_username=vsftpd #指定虚拟用户的宿主用户（就是我们前面新建的用户）</li>\n<li>guest_username=www #如果ftp目录是指向网站根目录，用来上传网站程序，可以指定虚拟用户的宿主用户为nginx运行账户www，可以避免很多权限设置问题</li>\n<li>至此，CentOS 7.0安装配置Vsftp服务器配置完成。</li>\n</ul>\n<p><br></p>\n<h4 id=\"Ubuntu部署vsftpd\"><a href=\"#Ubuntu部署vsftpd\" class=\"headerlink\" title=\"Ubuntu部署vsftpd\"></a>Ubuntu部署vsftpd</h4><p>本文在Ubuntu Server 14.04 amd64系统测试</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装ftp</span></span><br><span class=\"line\">sudo apt-get install vsftpd</span><br><span class=\"line\"><span class=\"comment\">#配置vsftpd.conf</span></span><br><span class=\"line\">sudo vi /etc/vsftpd.conf</span><br><span class=\"line\">sudo gedit /etc/vsftpd.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#禁止匿名访问</span></span><br><span class=\"line\">anonymous_enable=NO</span><br><span class=\"line\"><span class=\"comment\">#接受本地用户</span></span><br><span class=\"line\">local_enable=YES</span><br><span class=\"line\"><span class=\"comment\">#允许上传</span></span><br><span class=\"line\">write_enable=YES</span><br><span class=\"line\"><span class=\"comment\">#用户只能访问限制的目录</span></span><br><span class=\"line\">chroot_local_user=YES</span><br><span class=\"line\"><span class=\"comment\">#设置固定目录，在结尾添加。如果不添加这一行，各用户对应自己的目录，当然这个文件夹自己建</span></span><br><span class=\"line\">local_root=/home/ftp</span><br></pre></td></tr></table></figure>\n<p>注意：pam_service_name=vsftpd,主要是进行认证的</p>\n<p>添加ftp登录用户<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo useradd -d /home/ftp -M ftpuser</span><br><span class=\"line\">sudo passwd ftpuser</span><br><span class=\"line\"><span class=\"comment\">#调整文件夹权限，这个是避免“500 OOPS: vsftpd: refusing to run with writable root inside chroot()”</span></span><br><span class=\"line\">sudo chmod a-w /home/ftp   <span class=\"comment\">#所有用户取消写入权限（安全）</span></span><br><span class=\"line\">sudo mkdir /home/ftp/data</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#这时候直接用useradd的帐号登录ftp会530 login incorrect</span></span><br><span class=\"line\">sudo nano /etc/pam.d/vsftpd</span><br><span class=\"line\"><span class=\"comment\">#auth    required pam_shells.so #注释掉，貌似不是必须的</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启vsftpd</span></span><br><span class=\"line\">sudo service vsftpd restart</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h4 id=\"容器部署-vsftpd\"><a href=\"#容器部署-vsftpd\" class=\"headerlink\" title=\"容器部署 vsftpd\"></a>容器部署 vsftpd</h4><p>使用K8S快速搭建vsftpd服务，一键部署测试环境，此处使用的是[fauria/vsftpd][<a href=\"https://hub.docker.com/r/fauria/vsftpd]镜像基于Centos\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/fauria/vsftpd]镜像基于Centos</a> 7的vsftpd Docker镜像，支持被动模式和虚拟用户。</p>\n<p>k8s 快速部署资源清单:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tee deploy-vsftpd.yaml &lt;&lt;<span class=\"string\">'EOF'</span></span><br><span class=\"line\"><span class=\"comment\"># ftp-pvc.yaml</span></span><br><span class=\"line\"><span class=\"comment\"># storageClassName 存储按自己环境修改，此次使用 nfs-local，你可以通过如下命令查看</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl get storageclasses.storage.k8s.io </span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: vsftpd-pvc</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  storageClassName: nfs-local</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteMany</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 10Gi</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: vsftpd</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: vsftpd</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: vsftpd</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      <span class=\"comment\"># 将创建的的PVC绑定到ftp-pv-storage</span></span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: ftp-pv-storage</span><br><span class=\"line\">        persistentVolumeClaim:</span><br><span class=\"line\">          claimName: vsftpd-pvc</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: ftp-container</span><br><span class=\"line\">        image: fauria/vsftpd</span><br><span class=\"line\">        <span class=\"comment\"># 除21端口外 此处的端口要与下方设置的被动模式最大端口和最小端口匹配，例如设置随机端口范围为 31110-31115。因为此处容器内的随机端口要与映射后的一致，所以设置为30000以上，在k8s设置端口范围内</span></span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 31110</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 31111</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 31112</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 31113</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 31114</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 31115</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 21</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: <span class=\"string\">\"/home/vsftpd\"</span></span><br><span class=\"line\">          name: ftp-pv-storage</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: FTP_USER</span><br><span class=\"line\">          value: <span class=\"string\">\"weiyigeek\"</span></span><br><span class=\"line\">        - name: FTP_PASS</span><br><span class=\"line\">          value: <span class=\"string\">\"password\"</span></span><br><span class=\"line\">          <span class=\"comment\"># 随机最大端口与最小端口，要与上面设置的匹配</span></span><br><span class=\"line\">        - name: PASV_MIN_PORT</span><br><span class=\"line\">          value: <span class=\"string\">\"31110\"</span></span><br><span class=\"line\">        - name: PASV_MAX_PORT</span><br><span class=\"line\">          value: <span class=\"string\">\"31115\"</span></span><br><span class=\"line\">        - name: PASV_ENABLE</span><br><span class=\"line\">          value: <span class=\"string\">\"yes\"</span></span><br><span class=\"line\">          <span class=\"comment\"># 服务器传回的IP地址，一般为对外公网地址，即客户端连接ftp所用的地址。</span></span><br><span class=\"line\">        - name: PASV_ADDRESS</span><br><span class=\"line\">          value: <span class=\"string\">\"10.20.176.215\"</span></span><br><span class=\"line\">        <span class=\"comment\">#- name: PASV_ADDRESS</span></span><br><span class=\"line\">        <span class=\"comment\">#  valueFrom:</span></span><br><span class=\"line\">        <span class=\"comment\">#    fieldRef:</span></span><br><span class=\"line\">        <span class=\"comment\">#      fieldPath: status.hostIP</span></span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># ftp-service.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: vsftpd-service</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: vsftpd-service</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\">  <span class=\"comment\"># 除21端口映射外，其他端口需保持一致</span></span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: ftp-21</span><br><span class=\"line\">      nodePort: 30021</span><br><span class=\"line\">      port: 21</span><br><span class=\"line\">    - name: ftp-31110</span><br><span class=\"line\">      nodePort: 31110</span><br><span class=\"line\">      port: 31110</span><br><span class=\"line\">    - name: ftp-31111</span><br><span class=\"line\">      nodePort: 31111</span><br><span class=\"line\">      port: 31111</span><br><span class=\"line\">    - name: ftp-31112</span><br><span class=\"line\">      nodePort: 31112</span><br><span class=\"line\">      port: 31112</span><br><span class=\"line\">    - name: ftp-31113</span><br><span class=\"line\">      nodePort: 31113</span><br><span class=\"line\">      port: 31113</span><br><span class=\"line\">    - name: ftp-31114</span><br><span class=\"line\">      nodePort: 31114</span><br><span class=\"line\">      port: 31114</span><br><span class=\"line\">    - name: ftp-31115</span><br><span class=\"line\">      nodePort: 31115</span><br><span class=\"line\">      port: 31115</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: vsftpd</span><br><span class=\"line\">EOF</span><br><span class=\"line\">kubectl apply -f deploy-vsftpd.yaml</span><br><span class=\"line\">kubectl get deploy,svc,pod,pvc</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"2-配置文件\"><a href=\"#2-配置文件\" class=\"headerlink\" title=\"2.配置文件\"></a>2.配置文件</h3><ol>\n<li>vsftpd的配置文件说明：</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* vsftpd.ftpusers：位于/etc目录下。它指定了哪些用户账户不能访问FTP服务器，例如root等。</span><br><span class=\"line\">* vsftpd.user_list：位于/etc目录下。该文件里的用户账户在默认情况下也不能访问FTP服务器，仅当vsftpd.conf配置文件里启用userlist_enable=NO选项时才允许访问。 </span><br><span class=\"line\">* vsftpd.conf：位于/etc/vsftpd目录下。来自定义用户登录控制、用户权限控制、超时设置、服务器功能选项、服务器性能选项、服务器响应消息等FTP服务器的配置。</span><br></pre></td></tr></table></figure>\n<ul>\n<li>(1)用户登录控制 <ul>\n<li>anonymous_enable=YES，允许匿名用户登录。 </li>\n<li>no_anon_password=YES，匿名用户登录时不需要输入密码。 </li>\n<li>local_enable=YES，允许本地用户登录。 </li>\n<li>deny_email_enable=YES，可以创建一个文件保存某些匿名电子邮件的黑名单，以防止这些人使用Dos攻击。 </li>\n<li>banned_email_file=/etc/vsftpd.banned_emails，当启用deny_email_enable功能时，所需的电子邮件黑名单保存路径(默认为/etc/vsftpd.banned_emails)。 </li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>(2)用户权限控制 <ul>\n<li>write_enable=YES，开启全局上传权限。 </li>\n<li>local_umask=022，本地用户的上传文件的umask设为022(系统默认是077，一般都可以改为022)。anon_upload_enable=YES，允许匿名用户具有上传权限，很明显必须启用write_enable=YES，才可以使用此项。同时我们还必须建立一个允许ftp用户可以读写的目录(前面说过，ftp是匿名用户的映射用户账号)。 </li>\n<li>anon_mkdir_write_enable=YES，允许匿名用户有创建目录的权利。 </li>\n<li>chown_uploads=YES，启用此项，匿名上传文件的属主用户将改为别的用户账户，注意，这里建议不要指定root账号为匿名上传文件的属主用户！ </li>\n<li>chown_username=whoever，当启用chown_uploads=YES时，所指定的属主用户账号，此处的whoever自然要用合适的用户账号来代替。 </li>\n<li>chroot_list_enable=YES，可以用一个列表限定哪些本地用户只能在自己目录下活动，如果chroot_local_user=YES，那么这个列表里指定的用户是不受限制的。 </li>\n<li>chroot_list_file=/etc/vsftpd.chroot_list，如果chroot_local_user=YES，则指定该列表(chroot_local_user)的保存路径(默认是/etc/vsftpd.chroot_list)。 </li>\n<li>nopriv_user=ftpsecure，指定一个安全用户账号，让FTP服务器用作完全隔离和没有特权的独立用户。这是vsftpd系统推荐选项。 </li>\n<li>async_abor_enable=YES，强烈建议不要启用该选项，否则将可能导致出错！ </li>\n<li>ascii_upload_enable=YES；</li>\n<li>ascii_download_enable=YES，默认情况下服务器会假装接受ASCⅡ模式请求但实际上是忽略这样的请求，启用上述的两个选项可以让服务器真正实现ASCⅡ模式的传输。 </li>\n</ul>\n</li>\n</ul>\n<p>注意：启用ascii_download_enable选项会让恶意远程用户们在ASCⅡ模式下用“SIZE/big/file”这样的指令大量消耗FTP服务器的I/O资源。<br>这些ASCⅡ模式的设置选项分成上传和下载两个，这样我们就可以允许ASCⅡ模式的上传(可以防止上传脚本等恶意文件而导致崩溃)，而不会遭受拒绝服务攻击的危险。 </p>\n<ul>\n<li><p>(3)用户连接和超时选项 </p>\n<ul>\n<li>idle_session_timeout=600，可以设定默认的空闲超时时间，用户超过这段时间不动作将被服务器踢出。 </li>\n<li>data_connection_timeout=120，设定默认的数据连接超时时间。 </li>\n</ul>\n</li>\n<li><p>(4)服务器日志和欢迎信息</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dirmessage_enable=YES，允许为目录配置显示信息，显示每个目录下面的message_file文件ftpd_banner=Welcome to blah FTP service，可以自定义FTP用户登录到服务器所看到的欢迎信息。 </span><br><span class=\"line\">xferlog_enable=YES，启用记录上传/下载活动日志功能。 </span><br><span class=\"line\">xferlog_file=/var/<span class=\"built_in\">log</span>/vsftpd.log，可以自定义日志文件的保存路径和文件名，默认是/var/<span class=\"built_in\">log</span>/vsftpd.log。 </span><br><span class=\"line\">anonymous_enable=YES 允许匿名登录</span><br><span class=\"line\">local_enable=YES 允许本地用户登录 </span><br><span class=\"line\">write_enable=YES 开放本地用户写权限 </span><br><span class=\"line\">local_umask=022 设置本地用户生成文件的掩码为022 </span><br><span class=\"line\"><span class=\"comment\">#anon_upload_enable=YES 此项设置允许匿名用户上传文件 </span></span><br><span class=\"line\"><span class=\"comment\">#anon_mkdir_write_enable=YES 开启匿名用户的写和创建目录的权限 </span></span><br><span class=\"line\">dirmessage_enable=YES 当切换到目录时，显示该目录下的.message隐藏文件的内容 </span><br><span class=\"line\">xferlog_enable=YES 激活上传和下载日志 </span><br><span class=\"line\">connect_from_port_20=YES 启用FTP数据端口的连接请求 </span><br><span class=\"line\"><span class=\"comment\">#chown_uploads=YES 是否具有上传权限. 用户由chown_username参数指定。 </span></span><br><span class=\"line\"><span class=\"comment\">#chown_username=whoever 指定拥有上传文件权限的用户。此参数与chown_uploads联用。 </span></span><br><span class=\"line\"><span class=\"comment\">#xferlog_file=/var/log/vsftpd.log </span></span><br><span class=\"line\">xferlog_std_format=YES 使用标准的ftpd xferlog日志格式 </span><br><span class=\"line\"><span class=\"comment\">#idle_session_timeout=600 此设置将在用户会话空闲10分钟后被中断 </span></span><br><span class=\"line\"><span class=\"comment\">#data_connection_timeout=120 将在数据连接空闲2分钟后被中断 </span></span><br><span class=\"line\"><span class=\"comment\">#ascii_upload_enable=YES 启用上传的ASCII传输方式 </span></span><br><span class=\"line\"><span class=\"comment\">#ascii_download_enable=YES 启用下载的ASCII传输方式 </span></span><br><span class=\"line\"><span class=\"comment\">#ftpd_banner=Welcome to blah FTP service 设置用户连接服务器后显示消息 </span></span><br><span class=\"line\"><span class=\"comment\">#deny_email_enable=NO 此参数默认值为NO。当值为YES时，拒绝使用banned_email_file参数指定文件中所列出的e-mail地址用户登录。 </span></span><br><span class=\"line\"><span class=\"comment\">#banned_email_file=/etc/vd.banned_emails 指定包含拒绝的e-mail地址的文件. </span></span><br><span class=\"line\"><span class=\"comment\">#chroot_list_enable=YES 设置本地用户登录后不能切换到自家目录以外的别的目录 </span></span><br><span class=\"line\"><span class=\"comment\">#chroot_list_file=/etc/vsftpd.chroot_list </span></span><br><span class=\"line\"><span class=\"comment\">#ls_recurse_enable=YES </span></span><br><span class=\"line\">pam_service_name=vsftpd 设置PAM认证服务的配置文件名称，该文件存放在/etc/pam.d/ </span><br><span class=\"line\">userlist_enable=YES 此项配置/etc/vsftpd.user_list中指定的用户也不能访问服务器，若添加userlist_deny=No,则仅仅/etc/vsftpd.user_list文件中的用户可以访问，其他用户都不可以访问服务器。如过userlist_enable=NO,userlist_deny=YES,则指定使文件/etc/vsftpd.user_list中指定的用户不可以访问服务器，其他本地用户可以访问服务器。 </span><br><span class=\"line\">listen=YES 指明VSFTPD以独立运行方式启动 </span><br><span class=\"line\">tcp_wrappers=YES 在VSFTPD中使用TCP_Wrappers远程访问控制机制，默认值为YES</span><br></pre></td></tr></table></figure>\n<p><br></p>\n<h3 id=\"3-安全配置\"><a href=\"#3-安全配置\" class=\"headerlink\" title=\"3.安全配置\"></a>3.安全配置</h3><ul>\n<li>vsftpd配置文件:/etc/vsftpd/vsftpd.conf</li>\n<li>vsftpd默认匿名用户上传目录:/var/ftp/pub<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ftp的密码为空，anonymous的密码为空或者guest</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>安全配置必须选项:<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#不允许匿名访问登录的以及权限的管控(匿名用户的文件夹必须是777权限)))</span></span><br><span class=\"line\">anonymous_enable=NO</span><br><span class=\"line\">anon_world_readable_only=NO</span><br><span class=\"line\">anon_upload_enable=NO</span><br><span class=\"line\">anon_mkdir_write_enable=NO</span><br><span class=\"line\">anon_other_write_enable=NO</span><br></pre></td></tr></table></figure></p>\n<p>本地用户登陆ftp<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#接受本地用户</span><br><span class=\"line\">local_enable&#x3D;YES</span><br><span class=\"line\">#允许上传</span><br><span class=\"line\">write_enable&#x3D;YES</span><br><span class=\"line\">#用户只能访问限制的目录</span><br><span class=\"line\">chroot_local_user&#x3D;YES</span><br><span class=\"line\">#设置固定目录在结尾添加。如果不添加这一行各用户对应自己的目录，当然这个文件夹自己建</span><br><span class=\"line\">local_root&#x3D;&#x2F;home&#x2F;ftp</span><br></pre></td></tr></table></figure></p>\n<p>由于本地用户登陆ftp会出现信息泄露的问题，本地用户不止可以访问ftp站点的内容，还可以访问ftp服务器上的其他目录，解决办法就是用虚拟用户、<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#创建FTP根目录及虚拟用户映射的系统用户</span></span><br><span class=\"line\">useradd -d /home/vftpuser -s /sbin/nologin vftpuser</span><br><span class=\"line\"><span class=\"comment\">#为保证其他用户可以访问，给予rwxr-xr-x权限：</span></span><br><span class=\"line\">chmod 755 /home/vftpuser</span><br><span class=\"line\"><span class=\"comment\">#建立虚拟FTP用户数据库文件。</span></span><br><span class=\"line\">db_load -T -t <span class=\"built_in\">hash</span> -f vuser_login.txt vuser_login.db</span><br><span class=\"line\"><span class=\"comment\">#找到认证文件的路径</span></span><br><span class=\"line\">Find / -name pam_userdb.so</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#以下这些是关于vsftpd虚拟用户支持的重要配置项，</span></span><br><span class=\"line\"><span class=\"comment\">#默认vsftpd.conf中不包含这些设定项目，需要自己手动添加</span></span><br><span class=\"line\">guest_enable=YES   <span class=\"comment\">#设定启用虚拟用户功能</span></span><br><span class=\"line\">guest_username=vsftpd <span class=\"comment\">#指定虚拟用户的宿主用户</span></span><br><span class=\"line\">user_config_dir=/etc/vsftpd/vuser_conf <span class=\"comment\">#设定虚拟用户个人vsftp的CentOS FTP服务文件存放路径</span></span><br><span class=\"line\"><span class=\"comment\">#为虚拟用户设置不同的权限</span></span><br><span class=\"line\"><span class=\"comment\">#指定用户独立的权限配置文件存放的目录：vim /etc/vsftpd/vsftpd.conf </span></span><br><span class=\"line\">user_config_dir=/etc/vsftpd/vsftpd_user_conf</span><br><span class=\"line\"><span class=\"comment\">#切换进入到该目录中：cd  /etc/vsftpd/vsftpd_user_conf</span></span><br><span class=\"line\"><span class=\"comment\">#比如设置web默认是可读权限</span></span><br><span class=\"line\">anon_mkdir_write_enable=YES   <span class=\"comment\">#允许用户创建文件</span></span><br><span class=\"line\">anon_world_readable_only=YES       <span class=\"comment\">#只读</span></span><br><span class=\"line\">anon_upload_enable=YES   <span class=\"comment\">#允许wang用户上传文件</span></span><br><span class=\"line\">anon_other_write_enable=YES <span class=\"comment\">#用户就具有修改和删除文件的权限了</span></span><br></pre></td></tr></table></figure></p>\n<hr>\n<h3 id=\"4-入坑-amp-出坑\"><a href=\"#4-入坑-amp-出坑\" class=\"headerlink\" title=\"4.入坑&amp;出坑\"></a>4.入坑&amp;出坑</h3><ol>\n<li>FTP登录时报错500 OOPS: chroot<br>解决方法：关闭SElinux<blockquote>\n<p>setenforce 0 #临时</p>\n</blockquote>\n</li>\n</ol>\n<p><br></p>\n<ol start=\"2\">\n<li>500 OOPS: vsftpd: refusing to run with writable root inside chroot()<br>解决方法：修改配置文件/etc/vsftpd/vsftpd.conf或者个人配置文件添加参数：<blockquote>\n<p>allow_writeable_chroot=YES</p>\n</blockquote>\n</li>\n</ol>\n<p>从2.3.5之后，vsftpd增强了安全检查，如果用户被限定在了其主目录下，则该用户的主目录不能再具有写权限了！如果检查发现还有写权限，就会报该错误。<br>要修复这个错误，可以用命令<code>chmod a-w /home/user去除用户主目录的写权限，注意把目录替换成你自己的</code>。或者你可以在vsftpd的配置文件中增加下列项：<code>allow_writeable_chroot=YES</code></p>\n<p><br></p>\n<h2 id=\"0x02-命令解析-amp-状态码\"><a href=\"#0x02-命令解析-amp-状态码\" class=\"headerlink\" title=\"0x02 命令解析&amp;状态码\"></a>0x02 命令解析&amp;状态码</h2><h3 id=\"1-ftp-命令\"><a href=\"#1-ftp-命令\" class=\"headerlink\" title=\"1.ftp 命令\"></a>1.ftp 命令</h3><p>描述：ftp 服务主要用于文件传输到服务器默认服务端口21进行命令传递, FTP命令是Internet用户使用最频繁的命令之一，熟悉并灵活应用FTP的内部命令，可以大大方便使用者并收到事半功倍之效。</p>\n<p><strong>基础语法:</strong><br>描述: 将文件传送到运行 FTP 服务器服务(经常称为后台程序)的计算机以及将文件从该计算机传出。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法</span></span><br><span class=\"line\">FTP [-v] [-d] [-i] [-n] [-g] [-s:filename] [-a] [-A] [-x:sendbuffer] [-r:recvbuffer] [-b:asyncbuffers] [-w:windowsize] [host]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 参数</span></span><br><span class=\"line\">-v              显示远程服务器的全部响应，并提供数据传输的统计信息，即在程序运行时显示详细的处理信息。</span><br><span class=\"line\">-n              禁止在初始连接时自动登录。否则ftp 命令会搜索 <span class=\"variable\">$HOME</span>/.netrc 登录项，该登录项描述了远程主机的登录和初始化过程。</span><br><span class=\"line\">-i              关闭多文件传输过程中的交互式提示。</span><br><span class=\"line\">-d              启用调试(但必须编辑 /etc/syslog.conf 文件并添加以下中的一项：user.info FileName 或 user.debug FileName)。</span><br><span class=\"line\">-g              禁用文件名通配(禁用文件名中的元字符拓展，即取消全局文件名)。</span><br><span class=\"line\">-s:filename     指定包含 FTP 命令的文本文件；命令在 FTP 启动后自动运行。</span><br><span class=\"line\">-a              在绑字数据连接时使用所有本地接口。</span><br><span class=\"line\">-A              匿名登录。</span><br><span class=\"line\">-x:send sockbuf 覆盖默认的 SO_SNDBUF 大小 8192。</span><br><span class=\"line\">-r:recv sockbuf 覆盖默认的 SO_RCVBUF 大小 8192。</span><br><span class=\"line\">-b:async count  覆盖默认的异步计数 3</span><br><span class=\"line\">-w:windowsize   覆盖默认的传输缓冲区大小 65535。</span><br><span class=\"line\">host            指定主机名称或要连接到的远程主机的 IP 地址。</span><br></pre></td></tr></table></figure></p>\n<p>Tips: 使用 Ctrl-C 中止命令。</p>\n<p><br></p>\n<p><strong>FTP使用的内部命令如下(中括号表示可选项):</strong></p>\n<ul>\n<li>0.?[cmd]：同help.</li>\n<li>23.help[cmd]：显示ftp内部命令cmd的帮助信息，如：help get。</li>\n<li>1.![cmd[args]]：在本地机中执行交互shell，exit回到ftp环境<code>!ls *.zip</code></li>\n<li>2.$macro-ame[args]： 执行宏定义macro-name。</li>\n<li>3.account[password]： 提供登录远程系统成功后访问系统资源所需的补充口令。</li>\n<li>4.append local-file[remote-file]：将本地文件追加到远程系统主机，若未指定远程系统文件名，则使用本地文件名。</li>\n<li>5.ascii：使用ascii类型传输方式。</li>\n<li>7.binary：使用二进制文件传输方式。<ul>\n<li>【如果选择binary来传输数据，发送方与接送方不能改变文件的内容】</li>\n<li>【如果选择asciiL来传输数据，发送方将文本从字符集转换成标准的Ascii码后发送数据，而接收方将接受到的Ascii码转换成本方的计算机的字符集】</li>\n</ul>\n</li>\n<li>6.bell：每个命令执行完毕后计算机响铃一次。</li>\n<li>8.bye：退出ftp会话过程。</li>\n<li>9.case：在使用mget时，将远程主机文件名中的大写转为小写字母。</li>\n<li>10.cd remote-dir：进入远程主机目录。</li>\n<li>11.cdup：进入远程主机目录的父目录。</li>\n<li>12.chmod mode file-name：将远程主机文件file-name的存取方式设置为mode，如：<code>chmod 777 a.out</code>。</li>\n<li>13.close：中断与远程服务器的ftp会话(与open对应)。</li>\n<li>14.cr：使用asscii方式传输文件时，将回车换行转换为回行。</li>\n<li>15.delete remote-file：删除远程主机文件。</li>\n<li>16.debug[debug-value]：设置调试方式， 显示发送至远程主机的每条命令，如：<code>deb up 3</code>，若设为0，表示取消debug。</li>\n<li>17.dir[remote-dir][local-file]：显示远程主机目录，并将结果存入本地文件。</li>\n<li>18.disconnection：同close。</li>\n<li>19.form format：将文件传输方式设置为format，缺省为file方式。</li>\n<li>20.get remote-file[local-file]： 将远程主机的文件remote-file传至本地硬盘的local-file。</li>\n<li>21.glob：设置mdelete，mget，mput的文件名扩展，缺省时不扩展文件名，同命令行的-g参数。</li>\n<li>22.hash：每传输1024字节，显示一个hash符号(#)。</li>\n<li>24.idle[seconds]：将远程服务器的休眠计时器设为[seconds]秒。</li>\n<li>25.image：设置二进制传输方式(同binary)。</li>\n<li>26.lcd[dir]：将本地工作目录切换至dir。</li>\n<li>27.ls[remote-dir][local-file]：显示远程目录remote-dir， 并存入本地文件local-file。</li>\n<li>28.macdef macro-name：定义一个宏，遇到macdef下的空行时，宏定义结束。</li>\n<li>29.mdelete[remote-file]：删除远程主机文件。</li>\n<li>30.mdir remote-files local-file：与dir类似，但可指定多个远程文件，如 ：mdir <em>.o.</em>.zipoutfile 。</li>\n<li>31.mget remote-files：传输多个远程文件(获取远端所在文件夹下所有文件)。</li>\n<li>32.mkdir dir-name：在远程主机中建一目录。</li>\n<li>33.mls remote-file local-file：同nlist，但可指定多个文件名。</li>\n<li>34.mode[modename]：将文件传输方式设置为modename， 缺省为stream方式。</li>\n<li>35.modtime file-name：显示远程主机文件的最后修改时间。</li>\n<li>36.mput local-file：将多个文件传输至远程主机(将所在文件夹下所有文件上传到FTP上)。</li>\n<li>37.newer file-name： 如果远程机中file-name的修改时间比本地硬盘同名文件的时间更近，则重传该文件。</li>\n<li>38.nlist[remote-dir][local-file]：显示远程主机目录的文件清单，并存入本地硬盘的local-file。</li>\n<li>40.ntrans[inchars[outchars]]：设置文件名字符的翻译机制，如ntrans1R，则文件名LLL将变为RRR。</li>\n<li>41.open host[port]：建立指定ftp服务器连接，可指定连接端口(常用)。</li>\n<li>42.passive：进入被动传输方式。</li>\n<li>43.prompt：设置多个文件传输时的交互提示。</li>\n<li>44.proxy ftp-cmd：在次要控制连接中，执行一条ftp命令， 该命令允许连接两个ftp服务器，以在两个服务器间传输文件。第一条ftp命令必须为open，以首先建立两个服务器间的连接。</li>\n<li>45.put local-file[remote-file]：将本地文件local-file传送至远程主机。</li>\n<li>46.pwd：显示远程主机的当前工作目录。</li>\n<li>47.quit：同bye，退出ftp会话。</li>\n<li>48.quote arg1，arg2…：将参数逐字发至远程ftp服务器，如：quote syst.</li>\n<li>49.recv remote-file[local-file]：同get。</li>\n<li>50.reget remote-file[local-file]：类似于get， 但若local-file存在，则从上次传输中断处续传。</li>\n<li>51.rhelp[cmd-name]：请求获得远程主机的帮助。</li>\n<li>52.rstatus[file-name]：若未指定文件名，则显示远程主机的状态， 否则显示文件状态。</li>\n<li>53.rename[from][to]：更改远程主机文件名。</li>\n<li>54.reset：清除回答队列。</li>\n<li>55.restart marker：从指定的标志marker处，重新开始get或put，如：restart 130。</li>\n<li>56.rmdir dir-name：删除远程主机目录。</li>\n<li>57.runique：设置文件名只一性存储，若文件存在，则在原文件后加后缀.1， .2等。</li>\n<li>58.send local-file[remote-file]：同put。</li>\n<li>59.sendport：设置PORT命令的使用。</li>\n<li>60.site arg1，arg2…：将参数作为SITE命令逐字发送至远程ftp主机。</li>\n<li>61.size file-name：显示远程主机文件大小，如：site idle 7200。</li>\n<li>62.status：显示当前ftp状态。</li>\n<li>63.struct[struct-name]：将文件传输结构设置为struct-name， 缺省时使用stream结构。</li>\n<li>64.sunique：将远程主机文件名存储设置为只一(与runique对应)。</li>\n<li>65.system：显示远程主机的操作系统类型。</li>\n<li>66.tenex：将文件传输类型设置为TENEX机的所需的类型。</li>\n<li>67.tick：设置传输时的字节计数器。</li>\n<li>68.trace：设置包跟踪。</li>\n<li>69.type[type-name]：设置文件传输类型为type-name，缺省为ascii，如:type binary，设置二进制传输方式。</li>\n<li>70.umask[newmask]：将远程服务器的缺省umask设置为newmask，如：umask 3</li>\n<li>71.user user-name[password][account]：向远程主机表明自己的身份，需要口令时，必须输入口令，如：user anonymous my@email。</li>\n<li>72.verbose：同命令行的-v参数，即设置详尽报告方式，ftp 服务器的所有响 应都将显示给用户，缺省为on.</li>\n</ul>\n<p><br/></p>\n<p><strong>实际案例：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.利用Explorer资源管理器进行登录FTP以及文件下载</span></span><br><span class=\"line\">ftp://username:password@ip/path/file</span><br><span class=\"line\">ftp://weiyigeektemp:@192.168.12.31/application-prod.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.交互式命令登录</span></span><br><span class=\"line\">ftp </span><br><span class=\"line\">&gt; open ip 端口  <span class=\"comment\"># 默认为ASCII格式传送(文本文件时)</span></span><br><span class=\"line\">&gt; 输入账号密码</span><br><span class=\"line\">&gt; bin        <span class=\"comment\"># bin指用二进制方式传送（可执行文件进）</span></span><br><span class=\"line\">&gt; get pull.txt</span><br><span class=\"line\">&gt; put push.txt</span><br><span class=\"line\">&gt; <span class=\"built_in\">bye</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.采用-s选项进行执行交换中的命令</span></span><br><span class=\"line\"><span class=\"comment\"># 格式</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"ftp ip port\"</span> &gt;&gt;download.bat</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"user\"</span> &gt;&gt;download.bat</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"password\"</span> &gt;&gt;download.bat</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"bin\"</span> &gt;&gt;download.bat</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"get back.exe\"</span> &gt;&gt;download.bat</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"bye\"</span> &gt;&gt;download.bat</span><br><span class=\"line\">ftp -s:download.bat</span><br><span class=\"line\"><span class=\"comment\"># 实例</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> open 192.168.1.31 21212 &gt; ftp.tmp</span><br><span class=\"line\"><span class=\"built_in\">echo</span> weiyigeek &gt;&gt; ftp.tmp</span><br><span class=\"line\"><span class=\"built_in\">echo</span> password &gt;&gt; ftp.tmp</span><br><span class=\"line\"><span class=\"built_in\">echo</span> bin &gt;&gt; ftp.tmp</span><br><span class=\"line\"><span class=\"built_in\">echo</span> mkdir %currentday% &gt;&gt; ftp.tmp</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"built_in\">cd</span> %currentday% &gt;&gt; ftp.tmp</span><br><span class=\"line\"><span class=\"built_in\">echo</span> put %Backupfile% &gt;&gt; ftp.tmp</span><br><span class=\"line\"><span class=\"built_in\">echo</span> quit &gt;&gt; ftp.tmp</span><br><span class=\"line\">ftp -i -s:ftp.tmp</span><br></pre></td></tr></table></figure></p>\n<p>Tips ： FTP文件传输类型有：<code>ascii、binary、ebcdic、image、local M 和 tenex</code>。<br>– ascii：将文件传输类型设置为网络 ASCII。此类型为缺省值，即默认使用ascii方式进行传输。<br>– binary：将文件传输类型设置为二进制映像。需要使用binary方式传输的文件类型有ISO文件、可执行文件、压缩文件、图片等。此类型可能比 ASCII 传送更有效。<br>– ebcdic：将文件传输类型设为 EBCDIC。<br>– image：将文件传输类型设置为二进制映像。此类型可能比 ASCII 传送更有效。<br>– local M：将文件传输类型设置为本地。M 参数定义每计算机字位的十进制数。此参数没有缺省值。<br>– tenex：将文件传输类型设为 TENEX 机器需要的类型。</p>\n<p>Tips : &lt;&lt; 是使用即时文件重定向输入, EOF是即时文件的标志它必须成对出现，以标识即时文件的开始和结尾。值得注意的是EOF只是一个分界符标志，完全可以用abc, ! 等替换也一样的功能，只是大家都习惯用EOF来表示。<br>Tips : &lt;&lt; 用法当shell看到&lt;&lt;的时候，它就会知道下一个词是一个分界符。在该分界符以后的内容都被当作输入，直到shell又看到该分界符(位于单独的一行)。因此分界符可以是定义的任何字符串。</p>\n<p><br></p>\n<h3 id=\"2-tftp-命令\"><a href=\"#2-tftp-命令\" class=\"headerlink\" title=\"2.tftp 命令\"></a>2.tftp 命令</h3><p><strong>基础语法:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-i 指以二进制模式传送，如传送exe文件时用，如不加-i 则以ASCII模式（传送文本文件模式）进行传送</span><br></pre></td></tr></table></figure></p>\n<p><strong>基础实例:</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.登陆后将“IP”服务器中server.exe下载到目标主机c:server.exe </span></span><br><span class=\"line\">tftp -i 服务器IP get server.exe c:server.exe </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.登陆后上传本地c:server.exe文件至IP服务器</span></span><br><span class=\"line\">tftp -i 服务器IP put c:server.exe</span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h3 id=\"3-状态码\"><a href=\"#3-状态码\" class=\"headerlink\" title=\"3.状态码\"></a>3.状态码</h3><ul>\n<li><p><strong>1xx - 肯定的初步答复</strong> : 这些状态代码指示一项操作已经成功开始，但客户端希望在继续操作新命令前得到另一个答复。<br>• 110 重新启动标记答复。<br>• 120 服务已就绪，在 nnn 分钟后开始。<br>• 125 数据连接已打开，正在开始传输。<br>• 150 文件状态正常，准备打开数据连接。</p>\n</li>\n<li><p><strong>2xx - 肯定的完成答复</strong>: 一项操作已经成功完成。客户端可以执行新命令。<br>• 200 命令确定。<br>• 202 未执行命令，站点上的命令过多。<br>• 211 系统状态，或系统帮助答复。<br>• 212 目录状态。<br>• 213 文件状态。<br>• 214 帮助消息。<br>• 215 NAME 系统类型，其中，NAME 是 Assigned Numbers 文档中所列的正式系统名称。<br>• 220 服务就绪，可以执行新用户的请求。<br>• 221 服务关闭控制连接。如果适当，请注销。<br>• 225 数据连接打开，没有进行中的传输。<br>• 226 关闭数据连接。请求的文件操作已成功（例如，传输文件或放弃文件）。<br>• 227 进入被动模式 (h1,h2,h3,h4,p1,p2)。<br>• 230 用户已登录，继续进行。<br>• 250 请求的文件操作正确，已完成。<br>• 257 已创建“PATHNAME”。</p>\n</li>\n<li><p><strong>3xx - 肯定的中间答复</strong>: 该命令已成功但服务器需要更多来自客户端的信息以完成对请求的处理。<br>• 331 用户名正确，需要密码。<br>• 332 需要登录帐户。<br>• 350 请求的文件操作正在等待进一步的信息。</p>\n</li>\n<li><p><strong>4xx - 瞬态否定的完成答复</strong>: 该命令不成功，但错误是暂时的。如果客户端重试命令，可能会执行成功。<br>• 421 服务不可用，正在关闭控制连接。如果服务确定它必须关闭，将向任何命令发送这一应答。<br>• 425 无法打开数据连接。<br>• 426 Connection closed; transferaborted.<br>• 450 未执行请求的文件操作。文件不可用（例如，文件繁忙）。<br>• 451 请求的操作异常终止：正在处理本地错误。<br>• 452 未执行请求的操作。系统存储空间不够。</p>\n</li>\n<li><p><strong>5xx - 永久性否定的完成答复</strong>: 该命令不成功，错误是永久性的。如果客户端重试命令，将再次出现同样的错误。<br>• 500 语法错误，命令无法识别。这可能包括诸如命令行太长之类的错误。<br>• 501 在参数中有语法错误。<br>• 502 未执行命令。<br>• 503 错误的命令序列。<br>• 504 未执行该参数的命令。<br>• 530 未登录。<br>• 532 存储文件需要帐户。<br>• 550 未执行请求的操作。文件不可用（例如，未找到文件，没有访问权限）。<br>• 551 请求的操作异常终止：未知的页面类型。<br>• 552 请求的文件操作异常终止：超出存储分配（对于当前目录或数据集）。<br>• 553 未执行请求的操作。不允许的文件名。</p>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>Q: 常见的 FTP 状态代码及其原因?</strong><br>• 150 - FTP 使用两个端口：<code>21 用于发送命令，20 用于发送数</code>据。状态代码 150 表示服务器准备在端口 20 上打开新连接发送一些数据。<br>• 226 - 命令在端口 20 上打开数据连接以执行操作，如传输文件。该操作成功完成，数据连接已关闭。<br>• 230 - 客户端发送正确的密码后，显示该状态代码。它表示用户已成功登录。<br>• 331 - 客户端发送用户名后，显示该状态代码。无论所提供的用户名是否为系统中的有效帐户，都将显示该状态代码。<br>• 426 - 命令打开数据连接以执行操作，但该操作已被取消，数据连接已关闭。<br>• 530 - 该状态代码表示用户无法登录，因为用户名和密码组合无效。如果使用某个用户帐户登录，可能键入错误的用户名或密码，也可能选择只允许匿名访问。如果使用匿名帐户登录，IIS 的配置可能拒绝匿名访问。<br>• 550 - 命令未被执行，因为指定的文件不可用。例如要 GET 的文件并不存在或试图将文件 PUT 到您没有写入权限的目录。</p>\n<hr>\n<h2 id=\"0x03-常用脚本\"><a href=\"#0x03-常用脚本\" class=\"headerlink\" title=\"0x03 常用脚本\"></a>0x03 常用脚本</h2><h3 id=\"1-实现FTP上传下载文件\"><a href=\"#1-实现FTP上传下载文件\" class=\"headerlink\" title=\"1) 实现FTP上传下载文件\"></a>1) 实现FTP上传下载文件</h3><p>描述: 在Linux中我们可以采用FTP进行文件得批量得上传和下载。</p>\n<p><strong>示例1.从FTP上单独或者批量下载文件到本地</strong><br>环境说明:</p>\n<ul>\n<li>FTP服务器：192.168.0.199</li>\n<li>FTP路径：/ftphome/data</li>\n<li>本地路径：/local/data<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\">ftp -v -n 192.168.0.199&lt;&lt;EOF</span><br><span class=\"line\">user ftpuser ftppwd</span><br><span class=\"line\">binary</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /ftphome/downloadData</span><br><span class=\"line\">lcd /<span class=\"built_in\">local</span>/getDownloadData</span><br><span class=\"line\">prompt</span><br><span class=\"line\">get test.txt </span><br><span class=\"line\">mget *</span><br><span class=\"line\"><span class=\"built_in\">bye</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"download from ftp successfully\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>示例2.从FTP上单独或者批量上传本地文件到服务器</strong><br>环境说明:</p>\n<ul>\n<li>FTP服务器：192.168.0.199</li>\n<li>FTP路径：/ftphome/uploadData</li>\n<li>本地路径：/local/getUploadData<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\">PUTFILE = test.txt  <span class=\"comment\"># 此处规定要上传得文件</span></span><br><span class=\"line\">ftp -v -n 192.168.0.199&lt;&lt;EOF</span><br><span class=\"line\">user ftpuser ftppwd</span><br><span class=\"line\">binary</span><br><span class=\"line\"><span class=\"built_in\">hash</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /ftphome/uploadData</span><br><span class=\"line\">lcd /ftphome/getUploadData</span><br><span class=\"line\">prompt</span><br><span class=\"line\">put <span class=\"variable\">$PUTFILE</span></span><br><span class=\"line\">mput *</span><br><span class=\"line\"><span class=\"built_in\">bye</span></span><br><span class=\"line\"><span class=\"comment\">#here document</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"commit to ftp successfully\"</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br/></p>\n<p><strong>示例3.sftp脚本自定登陆上传以及变量调用</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\">FLAG=1</span><br><span class=\"line\"><span class=\"built_in\">export</span> backfile=<span class=\"string\">\"text.json\"</span></span><br><span class=\"line\"><span class=\"comment\"># $(ls --time=atime /home/weiyigeek-gitlab/logs/gitlab-backup/ | head -n 1)</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;FLAG&#125;</span> -eq 1 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">lftp -u <span class=\"string\">\"gitlab\"</span>,<span class=\"string\">\"weiyigeekgitlab\"</span> sftp://192.168.12.31&lt;&lt;EOF</span><br><span class=\"line\">lcd /home/weiyigeek-gitlab/logs/gitlab-backup/</span><br><span class=\"line\">put <span class=\"variable\">$&#123;backfile&#125;</span></span><br><span class=\"line\">quit</span><br><span class=\"line\"><span class=\"built_in\">bye</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure></p>\n<p><br></p>\n<h2 id=\"0x04-入坑出坑\"><a href=\"#0x04-入坑出坑\" class=\"headerlink\" title=\"0x04 入坑出坑\"></a>0x04 入坑出坑</h2><h3 id=\"问题1-使用FTP报ftp-bind-Address-already-in-use错误。\"><a href=\"#问题1-使用FTP报ftp-bind-Address-already-in-use错误。\" class=\"headerlink\" title=\"问题1.使用FTP报ftp: bind: Address already in use错误。\"></a>问题1.使用FTP报<code>ftp: bind: Address already in use</code>错误。</h3><ul>\n<li>问题描述: 使用ftp命令上传文件时出现如下错误<code>Server cannot accept argument.ftp: bind: Address already in use</code></li>\n<li>问题原因：ftp使用了主动模式，导致防火墙将服务器到客户端的连接阻塞。（主动模式下，ftp服务器数据端口20要去连接客户端指定的数据端口。而，一般来讲外部系统到内部的端口连接会被防火墙阻塞）</li>\n<li>问题解决：使用ftp被动模式即可（被动模式下，服务器会启动一个监听数据的端口。让客户端的数据端口，去连接服务器监听数据的端口。）<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 开启被动模式 </span></span><br><span class=\"line\">ftp -p -n ipadress port</span><br><span class=\"line\"><span class=\"comment\"># -p enable passive mode (default for pftp)</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"问题2-使用FTPftp-500-Illegal-PORT-command\"><a href=\"#问题2-使用FTPftp-500-Illegal-PORT-command\" class=\"headerlink\" title=\"问题2.使用FTPftp:500 Illegal PORT command.\"></a>问题2.使用FTPftp:500 Illegal PORT command.</h3><ul>\n<li>问题描述：ftp登录后使用ls命令出现如下提示<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ftp:500 Illegal PORT <span class=\"built_in\">command</span>.</span><br><span class=\"line\">ftp: <span class=\"built_in\">bind</span>: Address already <span class=\"keyword\">in</span> use</span><br></pre></td></tr></table></figure></li>\n<li>问题原因: 造成这个原因主要是是由于iptables防火墙不支持<code>ip_nat_ftp/ip_conntrack_ftp</code>模块。</li>\n<li>解决方式:<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.在linux的ftp服务器上执行下列命令即可解决</span></span><br><span class=\"line\">modprobe ip_nat_ftp</span><br><span class=\"line\">modprobe ip_conntrack_ftp</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p><br></p>\n<h3 id=\"问题3-在windows上使用FTP客户端登录后执行passive命令问题\"><a href=\"#问题3-在windows上使用FTP客户端登录后执行passive命令问题\" class=\"headerlink\" title=\"问题3.在windows上使用FTP客户端登录后执行passive命令问题\"></a>问题3.在windows上使用FTP客户端登录后执行passive命令问题</h3><ul>\n<li>问题描述：ftp登录后使用passive命令表示命令无效。</li>\n<li>问题原因: 由于Windows自带的ftp工具不支持ftp被动模式。</li>\n<li>解决办法: 安装其他ftp工具或在linux系统下使用ftp上传操作文件。</li>\n</ul>\n","comments":true,"excerpt":"[TOC]","categories":[{"name":"OperationTools","path":"api/categories/OperationTools.json"}],"tags":[{"name":"connect","path":"api/tags/connect.json"}]}