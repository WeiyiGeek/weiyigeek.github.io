<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>🌐 Iptables防火墙基础讲解|WeiyiGeek Blog|唯一极客Geek-IT网络安全运维开发技术知识分享-博客站点</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="Linux防火墙,iptables防火墙">
    <meta name="Description" content="WeiyiGeek-唯一极客博客站点,关注于网络安全运维,Web安全开发,IOT物联网安全开发,应用开发,分享技术学习知识与入坑解决,提升网络安全技术与自身技术能力,立志维护大众网络安全为己任,做一个对国家有用的人,为实现中华民族伟大复兴的中国梦不懈奋斗">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9134434519967436" crossorigin="anonymous"></script>    
    <script type="text/javascript">
        // Data Center
        var DC = {
          reward:	true,
          lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
          v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-头像">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                文章标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章归档
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                学习书籍
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于作者
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                站点导航
              </a>
            </li>
        
            <li class="">
              <a href="/img/share-wechat.jpg" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                公众账号
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                哔哩哔哩
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>Iptables防火墙基础讲解</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="文章头部背景">
    <div class="container fade-scale">
        <h1 class="title">Iptables防火墙基础讲解</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-06-12T12:35:30.000Z" itemprop="datePublished" class="page-time">
  2019-06-12
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Linux%E5%91%BD%E4%BB%A4/">Linux命令</a></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
  <article id="post-系统运维/Linux/常用命令/防火墙类命令/Iptables防火墙基础讲解"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">Iptables防火墙基础讲解</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-06-12 20:35:30" datetime="2019-06-12T12:35:30.000Z"  itemprop="datePublished">2019-06-12</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Linux%E5%91%BD%E4%BB%A4/">Linux命令</a></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h4 id="0x00-快速入门"><a href="#0x00-快速入门" class="headerlink" title="0x00 快速入门"></a>0x00 快速入门</h4><p>描述：iptables是常见于linux系统下的应用层防火墙也就是我们所说的软防火墙,从逻辑上隔离开来有效的避免了恶意攻击,还能进行访问过滤;所以使用防火墙正是强有力的防护措施之一。</p>
<p><strong>1) Linux防火墙基础知识：</strong><br>作为隔离内外网、过滤非法数据的有力屏障，防火墙通常按实现环境的不同分为硬件防火墙和软件防火墙。</p>
<ul>
<li>硬件防火墙是功能专一的硬件设备，具有比较全面的功能，其工作效率较高，但是加个昂贵，通常只应用于非常重要的主干网络节点</li>
<li>软件防火墙的功能是由操作系统或软件程序实现的，可以在Linux或者Windows等系统平台构建软件防火墙。软件防火墙的价格优势比较明显，配置也相对灵活，如果设置得当，同样可以实现硬件防火墙具有的功能和效率。</li>
</ul>
<p>Linux的防火墙体系:</p>
<ul>
<li>1.主要工作在网络层，针对TCP/IP数据包实施过滤和限制，属于典型的包过滤(filter)防火墙（或称网络层防火墙）</li>
<li>2.基于内核编码实现，因此具有非常稳定的性能和高效率，也因此被更加广泛采纳和应用</li>
</ul>
<p><br></p>
<p><strong>2) Linux防火墙发展历史</strong><br>linux内核从很早的时候就实现了网络防火墙的功能，并为用户提供了管理防火墙规则的命令工具。</p>
<ul>
<li>在2.0版本的内核中，包过滤机制是ipfw，管理防火墙规则的命令工具是ipfwadm。</li>
<li>在2.2版本的内核中，包过滤机制是ipchain，管理防火墙规则的命令工具是ipchains（英 [tʃeɪn]，n.链子，链条; 连锁，连续; 拘束; 连锁店或旅馆系列的事物;）</li>
<li>在2.4版本的内核开始，包过滤机制是netfiter，管理防火墙的命令工具是iptables。</li>
</ul>
<p><br></p>
<p><strong>3）netfiter与iptables 主要区别如下</strong><br>在许多关于防火墙的资料中，netfiter和iptables通常都可以用来指Linux防火墙，往往容易引起混淆。</p>
<ul>
<li>netfiter：指的是Linux操作系统核心层中实现包过滤(filter)防火墙的内部结构，不以程序或文件的形式存在，<code>属于“内核态”（Kernel Space，又称内核空间）</code>的防火墙功能体系</li>
<li>iptables: 指的是管理防火墙的命令工具，程序通常位于/sbin/iptables，<code>属于“用户态”（User Space，又称用户空间）</code>的防火墙管理体系</li>
</ul>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614144748.png" target="_blank" title="WeiyiGeek.netfilter与iptables体系图" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614144748.png" alt="WeiyiGeek.netfilter与iptables体系图" title="" class=""></a>
                <p>WeiyiGeek.netfilter与iptables体系图</p>
            </figure>
<p><em>什么是Hook point?</em><br>答：数据包在Netfilter中的挂在点，有下面几个挂载点(也就是我们后所说的5条链)：PRE_ROUTING( 预分类;) 、INPUT、OUTPUT、FORWARD、POST_ROUTING (路由之后))</p>
<hr/>

<h4 id="0x01-四张表五条链"><a href="#0x01-四张表五条链" class="headerlink" title="0x01 四张表五条链"></a>0x01 四张表五条链</h4><p>IPtables的作用在于为包过滤的实现提供规则(或称策略),通过各种不同的规则告诉netfiter对来自有些源、前往某些目的地或具有某些协议特征的数据包应该如何处理；</p>
<p>为了更方便地组织和管理防火墙策略 iptables <code>采用了“表”和“链”的分层结构</code>；</p>
<ul>
<li>每个规则“表”相当于内核空间的一个容器,根据处理数据包的时机不同,表容器内包括不同的规则“链”,针对特定数据包的各种防火墙规则,按顺序依次放入对应的规则“链”中,</li>
</ul>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614150209.png" target="_blank" title="WeiyiGeek.表容器与链规则" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614150209.png" alt="WeiyiGeek.表容器与链规则" title="" class=""></a>
                <p>WeiyiGeek.表容器与链规则</p>
            </figure>
<p>组成部分(简单的说)：四张表＋五条链(hook point)＋规则 == iptables防火墙规则</p>
<p><br></p>
<h5 id="1-四张表"><a href="#1-四张表" class="headerlink" title="1. 四张表"></a>1. 四张表</h5><p>下面就是四张表的详细：</p>
<ul>
<li>raw表：对数据包的数据状态的跟踪和分析</li>
<li>mangle表：修改数据包、改变包头中内容(TTL,TOS,MARK)</li>
<li>nat表：地址转发(Address Forward)</li>
<li>filter表：访问控制(Access Control)、规则匹配(Regular mate)</li>
</ul>
<p><br></p>
<h5 id="2-五条链"><a href="#2-五条链" class="headerlink" title="2. 五条链"></a>2. 五条链</h5><p>描述：规则链在处理各种数据包时,根据防火墙规则的不同介入时机,iptables供涉及5种默认规则链,其应用时间点分别对应如下：</p>
<ul>
<li>PREROUTING 链：在对数据包作路由选择之前,应用次链中的规则.</li>
<li>FORWARD 链：当接收到需要通过防火墙发送给其他地址的数据包(转发)时,应用次链中的规则.</li>
<li>INPUT 链：当接收到防火墙本机地址的数据包(入站)时,应用此链中的规则.</li>
<li>OUTPUT 链：当防火墙本机向外发送数据包(出站)时,应用次链中的规则.</li>
<li>POSTROUTING 链：在对数据包作路由选择之后,应用次链中的规则.</li>
</ul>
<p><em>总结：</em></p>
<ul>
<li>INPUT、OUTPUT链更多的应用在“主机防火墙”中,即主要针对<code>服务器本机进出数据的安全控制</code></li>
<li>FORWARD、PREROUTING、POSTROUTING链更多的应用在“网络防火墙”中,<code>特别是防火墙服务器作为网关使用时的情况</code>.</li>
</ul>
<h5 id="3-规则"><a href="#3-规则" class="headerlink" title="3. 规则"></a>3. 规则</h5><p>上面介绍了iptables管理的4个默认表和5种规则链,按照防火墙策略的不同用途iptables管理着四个不同的规则表,其功能分别由独立的内核模块实现.</p>
<p><em>那4张表与5条规则链究竟有什么关系</em>?<br>答：使用iptables -t raw|mangle|nat|filter -L –line-numbers 进行查看默认链</p>
<ol>
<li><p>raw表: 包含两条规则链：PREROUTING 、OUTPUT</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">raw表是自1.2.9以后版本的iptables新增的表,主要用于决定数据包是否被状态跟踪机制处理;在匹配数据包时raw表的规则要优先于其他表.</span><br><span class="line">raw表对应的内核模块为：iptable_raw</span><br></pre></td></tr></table></figure>
</li>
<li><p>mangle表:包含五个规则链：PREROUTING,INPUT,OUTPUT,FORWARD,POSTROUTING</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mangle表主要用于修改数据包的TOS（Type Of Service,服务类型）、TTL（Time To Live,生存周期）指以及为数据包设置Mark标记,以实现Qos(Quality Of Service,服务质量)调整以及策略路由等应用,由于需要相应的路由设备支持,因此应用并不广泛.</span><br><span class="line">mangle 表对应的内核模块为：iptable_mangle</span><br></pre></td></tr></table></figure>
</li>
<li><p>nat表：包含三个规则链：PREROUTING,INPUT,OUTPUT,POSTROUTING</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nat (Network Address Translation,网络地址转换)表主要用于修改数据包的IP地址、端口号等信息.</span><br><span class="line">nat表中的两个典型应用：SNAT和DNAT策略(分别用于实现企业局域网共享上网、在Internet中发布内网的应用服务器)。</span><br><span class="line">nat 表对应的内核模块为:iptable_nat</span><br></pre></td></tr></table></figure>
</li>
<li><p>filter表：包含三个规则链：INPUT,FORWARD,OUTPUT</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filter 表主要用于对数据包进行过滤,根据具体的规则决定是否放行该数据包;</span><br><span class="line">filter 表对应的内核模块为 : iptable_filter</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614155546.png" target="_blank" title="WeiyiGeek.默认表和链结构总结" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614155546.png" alt="WeiyiGeek.默认表和链结构总结" title="" class=""></a>
                <p>WeiyiGeek.默认表和链结构总结</p>
            </figure>
<p>(重点)数据包在规则表、链匹配流程,下面从不同的角度依次介绍数据包过滤的匹配流程:</p>
<ul>
<li>PREROUTING：预定义</li>
<li>POSTROUTING：路由之后</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ⅰ&gt;&gt;&gt;规则表之间的优先顺序</span><br><span class="line">当数据包抵达防火墙时，将依次应用raw &gt; mangle &gt; nat &gt; filter表中对应链内的规则(如果有的话)就像上图；</span><br><span class="line"></span><br><span class="line">ⅱ&gt;&gt;&gt;规则链之间的优先顺序</span><br><span class="line">由于默认规则链是根据规则介入时机进行分类的，因此优先顺序直接取决于数据包的具体流程；</span><br><span class="line"></span><br><span class="line">1&gt;&gt;&gt;入站数据流向：</span><br><span class="line">来自外界的数据包到达防火墙后，首先被PREROUTING规则链处理(是否修改数据包地址等)，之后会进行路由选择(判断该数据包应该发往何处)，如果数据包的目标地址是防火墙本机(如Internet用户访问防火墙主机中的Web服务的数据包)，那么内核将其传递给INPUT链进行处理(决定是否允许通过等)，通过以后再交给系统上层的应用程序(如httpd服务器)进行响应</span><br><span class="line"></span><br><span class="line">2&gt;&gt;&gt;转发数据流向：</span><br><span class="line">来自外界的数据包到达防火墙后，首先被PREROUTING规则处理，之后会进行路由选择，如果数据包的目标地址是其他外部地址(如局域网用户通过网关访问QQ站点的数据包)，则内核将其传递给FORWARD链进行处理(是否转发或拦截)，然后再传给POSTROUTING规则链(是否修改数据包的地址等)进行处理。</span><br><span class="line"></span><br><span class="line">3&gt;&gt;&gt;出站数据流向：</span><br><span class="line">防火墙本机向外部地址发送的数据包(如在防火墙主机中测试公网DNS服务时)，首先被OUTPUT规则链处理之后进行路由选择，然后传递给POSTROUTING规则链(是否修改数据包的地址等)进行处理。</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614153330.png" target="_blank" title="WeiyiGeek.数据包在规则表链的匹配流程" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614153330.png" alt="WeiyiGeek.数据包在规则表链的匹配流程" title="" class=""></a>
                <p>WeiyiGeek.数据包在规则表链的匹配流程</p>
            </figure>
<p><em>总结注意：</em></p>
<ul>
<li>在POSTROUTING链中不存在于RAW规则表!!!!</li>
<li>在iptables的四个规则表中mangle表和raw的表应用相对较少主要是使用filter表和nat表的防火墙应用;</li>
<li>IPtables 链中的规则是从前1到后n条进行检测的;</li>
</ul>
<hr>

<h4 id="0x02-iptables-命令规则"><a href="#0x02-iptables-命令规则" class="headerlink" title="0x02 iptables 命令规则"></a>0x02 iptables 命令规则</h4><p>在Centos6及以前是采用netfiter内核防火墙的管理工具，iptables作为主要命令工具是非常值得我们学习（在Centos7中被默认firewalld替换）<br>防火墙重要的配置文件：/etc/sysconfig/iptables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Centos 7.0 默认使用 Firewall-cmd，将其停止卸载并安装：</span></span><br><span class="line">yum install iptables-services <span class="comment">#其他发行版本上没有的直接下载</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开启iptables服务并自启动：</span></span><br><span class="line"><span class="variable">$systemctl</span> start iptables.service    <span class="comment">#启动服务</span></span><br><span class="line"><span class="variable">$systemctl</span> <span class="built_in">enable</span> iptables.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行验证安装</span></span><br><span class="line">$ iptables --version</span><br><span class="line">iptables v1.4.21</span><br><span class="line"></span><br><span class="line"><span class="variable">$cat</span> /etc/sysconfig/iptables</span><br><span class="line">*filter  <span class="comment">#filter表</span></span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -p icmp -j ACCEPT</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure>
<p>基础语法与参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#IPtables规则(Syntax)设置表:</span></span><br><span class="line">iptables [ -t 表名] 命令选项 [链名] [条件匹配] [-j 目标动作或跳转]</span><br><span class="line"></span><br><span class="line"><span class="comment">#参数解释：</span></span><br><span class="line">- 其中表名、链名用于指定iptables命令所操作的表和链</span><br><span class="line">- 若未指定表名将默认使用filter表</span><br><span class="line">- 命令选项用于指定管理iptables规则的方式，如插入、增加、删除以及查看等</span><br><span class="line">- 条件匹配用于指定对符合什么样条件的数据包进行处理</span><br><span class="line">- 目标动作或跳转用于知道数据包的处理方式，如允许通过、拒绝、丢弃或跳转（jump）给其他链进行处理等</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614160903.png" target="_blank" title="WeiyiGeek.组成部分" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614160903.png" alt="WeiyiGeek.组成部分" title="" class=""></a>
                <p>WeiyiGeek.组成部分</p>
            </figure>
<p>命令参数一览：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Tables：-t raw|mangle|nat(常用)|filter(常用)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Command：-命令 iptables 命令的管理控制选项</span></span><br><span class="line"><span class="comment">#选项名	功能及特点</span></span><br><span class="line">-A	在指定链的末尾添加（--append）一条新的规则</span><br><span class="line">-D	删除（--delete）指定链中的某一条规则，按规则序号或内容确定要删除的规则</span><br><span class="line">-I	在指定链中插入（--insert）一条新的规则，若未指定插入位置，则默认在链的开头插入</span><br><span class="line">-R	修改、替换（--replace）指定链中的某一条规则，按规则序号或内容确定要替换的规则</span><br><span class="line">-L 	列出（--list）指定链中的所有的规则进行查看，若未指定链名，则列出表中所有链的内容</span><br><span class="line">-F	清空（--flush）指定链中的所有规则，若未指定链名，则清空表中所有链的内容</span><br><span class="line">-N	新建（--new-chain）一条用户自己定义的规则链</span><br><span class="line">-X 	删除指定表中用户自定义的规则链（--delete-chain）</span><br><span class="line">-P	设置指定链的默认策略（--policy）</span><br><span class="line">-n 	使用数字形式（--numeric）显示输出结果，若显示主机的IP地址而不是主机名</span><br><span class="line">--line-number	查看规则列表时，同时显示规则在链中的顺序号</span><br><span class="line">-v	查看规则列表时显示详细（--verbose）的信息</span><br><span class="line">-V 	查看iptables命令工具的版本（--Version）信息</span><br><span class="line">-h	查看命令帮助信息（--<span class="built_in">help</span>）</span><br><span class="line"></span><br><span class="line"><span class="comment">#Chain：链</span></span><br><span class="line">PREROUTING[预定义] -&gt; [指向远程地址: FORWARD]       --&gt;&gt; POSTROUTING[路由之后]  </span><br><span class="line">                  |_&gt; INPUT[入站] -&gt; OUTPUT[出站]  --&gt;&gt; POSTROUTING[路由之后]</span><br></pre></td></tr></table></figure></p>
<p><strong>Parameters-Xmath：参数-条件匹配</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>-p [协议]</td>
<td>–protocal：tcp/udp/icmp和all</td>
<td>协议匹配</td>
</tr>
<tr>
<td>-s [源地址]</td>
<td>源（–source）地址</td>
<td>源地址匹配</td>
</tr>
<tr>
<td>-d [目标地址]</td>
<td>目标（–destination）地址</td>
<td>目标地址匹配</td>
</tr>
<tr>
<td>–sport [源端口号]</td>
<td>源端口(–source-port),–sport 80:89，不连续时常于 -m multiport 连用</td>
<td>源端口匹配</td>
</tr>
<tr>
<td>–dport [目标端口]</td>
<td>目标端口（–destination-port）, –dport 80:89，不连续时常于 -m multiport 连用</td>
<td>目标端口匹配</td>
</tr>
<tr>
<td>–d/sports [端口段]</td>
<td>目标端口与源端口列表,–d/sports 100-2000，不连续时常于-m multiport 连用</td>
<td>端口段匹配</td>
</tr>
<tr>
<td>–src-range [IP地址范围]</td>
<td>源地址-ip段：–src-range 192.168.1.20-192.168.1.99，常于 -m iprange 连用</td>
<td>检查数据包的源地址时，用于匹配一段范围内的IP地址 </td>
</tr>
<tr>
<td>–dst-range [IP地址范围]</td>
<td>目标地址-IP段：–dst-range 192.168.1.20-192.168.1.99，常于 -m iprange 连用</td>
<td>检查数据包的目标地址时，用于匹配一段范围内的IP地址</td>
</tr>
<tr>
<td>-i [网路接口名]</td>
<td>eth0-name</td>
<td>接收数据包（–in-interface）的网卡</td>
</tr>
<tr>
<td>-o [网络接口名]</td>
<td>eth0-name</td>
<td>发送数据包（–out-interface）的网卡</td>
</tr>
<tr>
<td>–tcp-flags [TCP标记位]</td>
<td>SYN,RST,ACK SYN,以使用-p tcp为前提</td>
<td>TCP标记匹配</td>
</tr>
<tr>
<td>–icmp-type [ICMP类型]</td>
<td>Echo-Request/Echo-Reply/Destination-Unreachable(分别对应请求、回显、目标不可达数据)，以使用-p icmp为前提</td>
<td>ICMP类型匹配</td>
</tr>
<tr>
<td></td>
<td>-</td>
<td>-</td>
<td></td>
</tr>
<tr>
<td>-m [模块关键字]</td>
<td>执行 lsmod</td>
<td>grep xt_ 命令查看到扩展防火墙功能的相关内核模块，如：xt_mac，xt_state，xt_multiport</td>
<td>由额外的内核模块提供,下列详细说明</td>
</tr>
<tr>
<td>-m mac</td>
<td>–mac-source 3C-97-0E-77-7F-67</td>
<td>MAC地址匹配</td>
</tr>
<tr>
<td>-m state</td>
<td>–state ESTABLISHED(响应请求或者已建立连接的),RELATED(与已有连接有相关性的，如FTP数据连接) NEW(与任何连接无关的)，INVALID(无效的连接)，UNTRACKED(追踪的连接)</td>
<td>多状态匹配,基于iptables的状态跟踪机制，检查数据包的链接状态.</td>
</tr>
<tr>
<td>-m iprange</td>
<td>–src-range 192.168.1.20-192.168.1.99</td>
<td>多IP地址匹配</td>
</tr>
<tr>
<td>-m multiport</td>
<td>–dport 20,21,25,110,1250:1280 (端口不连续)</td>
<td>多端口匹配</td>
</tr>
<tr>
<td>-m limit</td>
<td>–limit 3/minute (平均三次/分钟),–limit-burst 8(峰值为八次)</td>
<td>对于频率进行限制</td>
</tr>
<tr>
<td>–probability</td>
<td>–probability 0.500000000</td>
<td>设置进入到指定链的概率此处是50% </td>
</tr>
</tbody>
</table>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Target： -j  #iptables对满足”条件匹配“指定条件的数据包，最常采用的处理方式如下:</span></span><br><span class="line"><span class="comment">#数据包访问控制：</span></span><br><span class="line">ACCEPT(允许接受通过) </span><br><span class="line">DROP(将数据包进行丢弃不会返回信息) </span><br><span class="line">REJECT(对数据包进行拒绝但会返回信息)  </span><br><span class="line">JUMP(自定义,跳转)</span><br><span class="line"></span><br><span class="line"><span class="comment">#数据包改写(在NAT表中)：</span></span><br><span class="line">SNAT(Source Network Address Translation,源地址转换)修改数据包的源IP地址</span><br><span class="line">DNAT(Destination Network Address Translation,目标地址转换)修改数据包的目标IP地址</span><br><span class="line"></span><br><span class="line"><span class="comment">#信息记录：</span></span><br><span class="line">LOG（访问记录的情况下）,  在/var/<span class="built_in">log</span>/messages 文件中记录日志信息，然后将数据包传递给下一条规则</span><br><span class="line">通过情况下，只要在规则链中找到一条相匹配的规则，则不再继续检查该链内后面的规则；但使用LOG处理方式的规则是一个特例，因为LOG只是一个辅助动作，并没有真正的处理数据包</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>实际案例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例0.模块帮助,获得iptables相关选项用法的帮助信息#</span></span><br><span class="line"><span class="comment">#查看iptables命令中关于icmp协议的帮助信息（在输出内容的最后部分列出）</span></span><br><span class="line">iptables -p icmp -h</span><br><span class="line">iptables -m state -h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例1.对于尝试通过SSH方式登录防火墙主机的访问数据，记录日志信息并禁止其访问（时时生效）添加comment模块#</span></span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m comment --comment <span class="string">"SSH服务"</span> -j DROP</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m comment --comment <span class="string">"SSH服务"</span> -j LOG</span><br><span class="line"></span><br><span class="line"><span class="variable">$tail</span> -f /var/<span class="built_in">log</span>/messages <span class="comment">#查看本机log发现登录过被阻止记录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例2.为了避免日志记录过于频繁，通过结合LIMIT显式匹配（-m limit）对日志写入频繁进行限制#</span></span><br><span class="line"><span class="comment">#例如以下规则，用于替换INPUT中第一条,并将记录日志的频率限制为平均三次/分钟，允许的峰值为八次。</span></span><br><span class="line">iptables -R INPUT 1 -p tcp --dport 22 -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/minute --<span class="built_in">limit</span>-burst 8 -j LOG</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例3.添加及插入以及替换规则#</span></span><br><span class="line"><span class="comment">#在filter表的INPUT链的末尾添加一条防火墙规则</span></span><br><span class="line">iptables -t filter -A INPUT -p tcp -j ACCEPT </span><br><span class="line"></span><br><span class="line"><span class="comment">#在filter表的INPUT链中插入一条防火墙规则（此处省略了“-t filter”选项，按默认处理filter表）</span></span><br><span class="line">iptables -I INPUT -p udp -j ACCEPT  </span><br><span class="line"></span><br><span class="line"><span class="comment">#在filter表的INPUT链中插入一条防火墙规则（作为链中的第二条规则）</span></span><br><span class="line">iptables -I INPUT 1 -p icmp -j DROP  <span class="comment">#禁ping会显示请求超时。</span></span><br><span class="line"></span><br><span class="line">sudo iptables -I INPUT -p tcp -m state --state NEW -m tcp --dport 80 -m comment --comment=<span class="string">"bootstack"</span> -j ACCEPT</span><br><span class="line">sudo iptables -I INPUT -p tcp -m state --state NEW -m tcp --dport 3366 -m comment --comment=<span class="string">"bootstack_db"</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例4.查看规则列表#</span></span><br><span class="line"><span class="comment">#查看filter表INPUT链中的所有规则，同时显示各条规则的顺序号</span></span><br><span class="line"><span class="variable">$iptables</span> -L INPUT --line-numbers   <span class="comment">#默认是filter表</span></span><br><span class="line"><span class="variable">$iptables</span> -L -v --line-number  <span class="comment">#获取filter表中规则序号</span></span><br><span class="line"><span class="variable">$iptables</span> -t filter -L INPUT --line-numbers   <span class="comment">#指定表查看</span></span><br><span class="line"><span class="comment"># Chain INPUT (policy ACCEPT)</span></span><br><span class="line"><span class="comment"># num  target     prot opt source               destination</span></span><br><span class="line"><span class="comment"># 1    DROP       icmp --  anywhere             anywhere</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614163551.png" target="_blank" title="WeiyiGeek.链规则查看" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614163551.png" alt="WeiyiGeek.链规则查看" title="" class=""></a>
                <p>WeiyiGeek.链规则查看</p>
            </figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例5.删除、清空指定编号规则#</span></span><br><span class="line"><span class="comment">#删除filter表INPUT链中的第2条规则</span></span><br><span class="line">iptables -D INPUT 2</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空filter表、nat表、mangle表各链中的所有规则</span></span><br><span class="line">iptables -F             <span class="comment">#不指定表名时默认(Default)清空filter表</span></span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables -t mangle -F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例6.设置规则链的默认策略 最基本的两种策略为ACCEPT（允许）、DROP（丢弃）#</span></span><br><span class="line"><span class="comment">#将filter表中FORWARD规则链的默认策略设为DROP</span></span><br><span class="line">iptables -t filter -P FORWARD DROP</span><br><span class="line"><span class="comment"># Chain FORWARD (policy DROP)</span></span><br><span class="line"><span class="comment"># target     prot opt source               destination</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例7.新增、删除自定义规则链</span></span><br><span class="line"><span class="comment">#在raw表中新增一条自定义的规则链，链名为TCP_PACKETS.</span></span><br><span class="line">iptables -t raw -N TCP_PACKETS</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除raw表中的用户自定义的所有规则链（只清除用户用户自定义的规则）</span></span><br><span class="line">iptables -t raw -X</span><br></pre></td></tr></table></figure>
<p>在iptables的规则表中，允许用户自定义新的链但是需要在默认的链中添加相应的跳转策略（如“iptables -I INPUT -j 自定义链名”），否则在处理数据包时将不会使用自定义链中的规则后面会给个例子；<br><figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614191037.png" target="_blank" title="WeiyiGeek.add规则链" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614191037.png" alt="WeiyiGeek.add规则链" title="" class=""></a>
                <p>WeiyiGeek.add规则链</p>
            </figure></p>
<p><br></p>
<p><strong>条件匹配 （重点）</strong><br>对于Linux防火墙来说，应该对什么样的数据包进行过滤，对什么样的数据包做地址转换，对于一条有效的防火墙策略来说，条件匹配的设置起着决定性的作用;<br>Linux防火墙需要非常清楚的知道针对符合什么条件的数据包进行什么样的处理,区分数据包的条件匹配方式可以分为<code>通用匹配、隐含匹配和显式匹配</code>各种匹配条件可以结合在一起使用.</p>
<p><em>A、通过（general）条件匹配</em><br>这种匹配操作一般可以直接使用，而不依赖于其他的条件匹配及其扩展常见的通用匹配方式包括以下集中;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例8:协议匹配用于检查数据包的网络协议（--protocol），允许使用的协议名包含在/etc/protocols文件中，常见的为tcp、udp、icmp和all（针对所有IP数据包）在iptables命令中使用“-p 协议名”的形式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#拒绝进入防火墙的所有icmp协议数据包</span></span><br><span class="line">iptables -I INPUT -p icmp -j REJECT</span><br><span class="line">iptables -R INPUT 1 -p icmp -j REJECT  <span class="comment">#替换filter表种的INPUT链的第一条规则;</span></span><br><span class="line"><span class="comment"># 正在 Ping 10.10.107.222 具有 32 字节的数据:</span></span><br><span class="line"><span class="comment"># 来自 10.10.107.222 的回复: 无法连到端口。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#允许防火墙转发除icmp协议以外的所有数据包（使用惊叹号"!"可以将除条件取反）</span></span><br><span class="line">iptables -A FORWARD ! -p icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例9:地址匹配用于检查数据包的IP地址、网络地址在iptables命令中使用“-s 源地址”和“-d 目标地址”的形式，分别对应于源（--source）地址和目标（--destination）地址</span></span><br><span class="line"><span class="comment">#拒绝转发来自192.168.1.11主机的数据，允许转发来自192.168.0.0/24网段的数据</span></span><br><span class="line">iptables -I FORWARD -s 192.168.1.11 -j REJECT</span><br><span class="line">iptables -I FORWARD -s 192.168.0.1/24 -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例10. 网络接口匹配用于检查数据包从防火墙的哪一个接口进入或离开在iptables命令中使用“-i 网络接口名”和“-o 网络接口名”的形式，分别对应于接收数据包（--in-interface）的网卡和发送数据包（--out-interface）的网卡</span></span><br><span class="line"><span class="comment">#丢弃从外网接口（eth1）进入防火墙本机的源地址为私网地址的数据包</span></span><br><span class="line">iptables -A INPUT -i eth1 -s 192.168.0.0/16 -j DROP</span><br><span class="line">iptables -A INPUT -i eth1 -s 172.16.0.0/12 -j DROP</span><br><span class="line">iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例11.管理员在网关服务器上检测到来自某个IP网段（如 10.20.30.0/24）的频繁扫描，希望设置iptables规则封堵该IP地址段，两小时后解封</span></span><br><span class="line">iptables -I INPUT -s 10.20.30.0/24 -j DROP</span><br><span class="line">iptables -I FORWARD -s 10.20.30.0/24 -j DROP</span><br><span class="line"><span class="variable">$at</span> now +2hours   <span class="comment">#值得学习</span></span><br><span class="line">at&gt; iptables -D INPUT 1</span><br><span class="line">at&gt; iptables -D FORWARD 1</span><br><span class="line">at&gt;                             //此处按Ctrl+D组合键</span><br><span class="line">job 4at 2013-06-1122:47</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p><em>B、隐含（Implicit）条件匹配</em><br>这种匹配通常需要以指定的协议匹配为前提，其对应的功能由iptables自动（隐含）的装载入内核，一般不需要用户收到加载模块常见的隐含匹配方式包括以下几种</p>
<ul>
<li>端口匹配用于检查数据包的TCP或UDP端口号，需要以“-p tcp”或“-p udp”匹配为前提在iptables命令中使用“–sport 源端口号”、“–dport 目标端口”的形式，分别对应于源端口（–source-port）、目标端口（–destination-port）端口可以表示为单个端口号或者用冒号“：”分割的端口范围.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例12：仅允许系统管理员从202.13.0.0/16 网段使用SSH方式远程登录防火墙主机(生效得顺序从上1到下1x0，还要注意-I与-A不同,删除中间得规则得时候，后面的规则向上补齐序号)</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -s 202.13.0.0/16 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#允许本机开放从TCP端口20-1024提供的应用服务</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 20:1024 -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p tcp --sport 20:1024 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#作为网关使用时，允许转发来自192.168.0.0/24局域网段的DNS解析请求数据包</span></span><br><span class="line">iptables -A FORWARD -s 192.168.0.0/24 -p udp --dport 53 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -d 192.168.0.0/24 -p udp --sport 53 -j ACCEPT</span><br></pre></td></tr></table></figure>
<ul>
<li>TCP标记匹配用于检查数据包的TCP标记位（–tcp-flags），需要以“-p tcp”匹配为前提在iptables命令中使用“–tcp-flags检查范围被设置的标记”的形式，两个参数“检查范围”和“被设置的标记”均为TCP标记的列表，各标记之间用逗号分割“检查范围”告诉iptables需要检查数据包的哪几个标记，“被设置的标记”则明确匹配对应值为1的标记</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例13.拒绝从接口（eth0）直接访问防火墙本机的数据包，但是允许响应防火墙TCP请求的数据包进入</span></span><br><span class="line">iptables -P INPUT DROP     <span class="comment">#设置指定链的默认策略（--policy），此命令执行小心，不提前设置通过ssh的话，你的远程直接就断开了</span></span><br><span class="line">iptables -I INPUT -i eth0 -p tcp --tcp-flags SYN,RST,ACK -j ACCEPT</span><br></pre></td></tr></table></figure>
<ul>
<li>ICMP类型匹配用于检查ICMP数据包的类型（–icmp-type）,有选择的过滤数据包，需要以“-p icmp”匹配为前提在iptables命令中使用“–icmp-type ICMP类型”的形式ICMP类型可以使用字符串或数字代码，例如“Echo-Request”(数字代码为8)、“Echo-Reply”(数字代码为0)、“Destination-Unreachable”(数字代码为3)，分别对应ICMP协议的请求、回显、目标不可达数据<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例14.禁止其他主机ping防火墙主机，但是允许从防火墙上ping其他主机（允许接受ICMP回应数据）</span></span><br><span class="line">iptables -A INPUT -p icmp --icmp-type Echo-Request -j DROP</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type Echo-Reply -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type destination-Unreachable -j ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614192657.png" target="_blank" title="WeiyiGeek.icmp数据包类型" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614192657.png" alt="WeiyiGeek.icmp数据包类型" title="" class=""></a>
                <p>WeiyiGeek.icmp数据包类型</p>
            </figure>
</li>
</ul>
<p><br></p>
<p><em>C、显式（Explicit）条件匹配</em></p>
<p>这种匹配的功能需要由额外的内核模块提供，因此需要手工指定匹配方式在iptables命令中使用“-m 模块关键字”的形式调用显式匹配，当然，还的指定对应的匹配内容在使用过显式匹配以后，<code>可以执行“lsmod |grep xt_”命令查看到扩展防火墙功能的相关内核模块（如：xt_mac，xt_state，xt_multiport，xt_limit等）</code>常见的显式匹配包括以下几种</p>
<ul>
<li>MAC地址匹配主要用于检查数据包的源MAC地址在iptables命令中使用“–mac-source MAC地址”的形式</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例15.禁止转发来自MAC地址为3C-97-0E-77-7F-67（这是我本机的mac）的主机的数据包 </span></span><br><span class="line">iptables -A FORWARD -m mac --mac-source 3C-97-0E-77-7F-67 -j DROP</span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614193027.png" target="_blank" title="WeiyiGeek.xt_mac" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614193027.png" alt="WeiyiGeek.xt_mac" title="" class=""></a>
                <p>WeiyiGeek.xt_mac</p>
            </figure>
<ul>
<li>多端口匹配检查数据包的源端口、目标端口时，用于匹配多个不连续的端口号在iptables命令中主要使用”–dports 端口列表“或者”–sports 端口列表“的形式，分别对应源端口地址列表、目标端口地址列表</li>
<li>多IP地址匹配检查数据包的源地址、目标地址时，使用模块-m iprange，用于匹配一段范围内的IP地址在iptables命令中主要使用”–src-range IP地址范围“或者”–dst-range IP地址范围“的形式，分别对应源IP地址范围、目标ip地址范围</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例16.允许防火墙本机对外开放TCP端口20、21、25、110以及被动模式FTP端口1250-1280</span></span><br><span class="line">iptables -A INPUT -p tcp -m multiport --dport 20,21,25,110,1250:1280 -j ACCEPT</span><br><span class="line"><span class="variable">$lsmod</span> |grep xt_</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例17.禁止转发源IP地址为192.168.1.20~192.168.1.99 的TCP数据包</span></span><br><span class="line">iptables -A FORWARD -p tcp -m iprange --src-range 192.168.1.20-192.168.1.99-j DROP</span><br><span class="line"><span class="comment">#xt_iprange</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614193918.png" target="_blank" title="WeiyiGeek.iprange" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614193918.png" alt="WeiyiGeek.iprange" title="" class=""></a>
                <p>WeiyiGeek.iprange</p>
            </figure>
<ul>
<li>状态匹配基于iptables的状态跟踪机制，检查数据包的链接状态（State）常见的数据包状况主要包括NEW(与任何连接无关的，新建得连接数据包)<ul>
<li>NEW(新建立的连接)</li>
<li>ESTABLISHED(响应请求或者已建立连接的)</li>
<li>RELATED(与已有连接有相关性的，如FTP数据连接)</li>
<li>INVALID(无效的连接)</li>
<li>UNTRACKED(追踪的连接)</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例18.禁止转发与正常TCP连接无关的非--syn新的请求数据包（如网络中可能存在的一些非法攻击数据包）</span></span><br><span class="line">iptables -A FORWARD -m state --state NEW -p tcp ! --syn -j DROP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例19.拒绝访问防火墙的新数据包，但允许响应连接或与已有连接相关的数据包</span></span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -j DROP</span><br><span class="line">iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例20.在服务器上设置防火墙策略，只开放本机的Web服务（80端口）、FTP服务（21、20端口、20450~20480），放行外部主机发往服务器其他端口的应答数据包，将其他入站数据包均予以丢弃处理</span></span><br><span class="line">iptables -I INPUT -p tcp -m multiport --dport 20,21,80 -j ACCEPT</span><br><span class="line">iptables -I INPUT -p tcp --dport 20450:20480 -j ACCEPT</span><br><span class="line"><span class="comment">#等同于 iptables -I INPUT -p tcp -m multiport --dport 20,21,80,20450:20480 -j ACCEPT</span></span><br><span class="line">iptables -I INPUT -p tcp -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -P INPUT DROP  <span class="comment">#设置关系链得默认策略 （最后一条）</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用户自定义链 将数据包传递给用户自定义的链（内的规则）进行处理<br>eg：自定义一个新的链MY1，转发自/至192.168.1.0/24网段的数据包均交给该链中的规则处理<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -N MY1</span><br><span class="line">iptables -A FORWARD -s 192.168.1.0/24 -j MY1  <span class="comment">#转发请求 动作是交给自定义链中 源</span></span><br><span class="line">iptables -A FORWARD -d 192.168.1.0/24 -j MY1   <span class="comment">#</span></span><br><span class="line">iptables -A MY1 -p icmp -j DROP  <span class="comment">#该链中icmp协议通信包将会被丢弃</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><em>注意事项：</em></p>
<ul>
<li>命令中的链与动作必须是大写的;</li>
</ul>
<hr/>

<h4 id="0x03-iptables-保存和恢复"><a href="#0x03-iptables-保存和恢复" class="headerlink" title="0x03 iptables 保存和恢复"></a>0x03 iptables 保存和恢复</h4><p>iptables软件包提供了两个命令:iptables-save、iptables-restore,分别用于保存（save）和恢复（restore）防火墙规则,使用这两个命令可以很方便的导出和导入规则.</p>
<h5 id="iptables-save命令"><a href="#iptables-save命令" class="headerlink" title="iptables-save命令"></a>iptables-save命令</h5><p>描述：直接执行iptables-save命令时,将会把当前设置的防火墙规则信息输出到终端.<br>通常情况下,可以使用重定向将信息保存为指定的配置文件,结合系统默认提供的iptables服务脚本,可以自动加载位于/etc/sysconfig/iptables文件中的规则设置.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例1.将当前调试好的iptables规则保存到配置文件,并通过iptables服务脚本自动加载.</span></span><br><span class="line"><span class="variable">$iptables</span>-save &gt;/etc/sysconfig/iptables</span><br><span class="line"><span class="variable">$service</span> iptables restart</span><br><span class="line"><span class="comment"># iptables：清除防火墙规则：                                 [确定]</span></span><br><span class="line"><span class="comment"># iptables：将链设置为政策 ACCEPT：raw mangle nat filter     [确定]</span></span><br><span class="line"><span class="comment"># iptables：正在卸载模块：                                   [确定]</span></span><br><span class="line"><span class="comment"># iptables：应用防火墙规则：                                 [确定]</span></span><br><span class="line"><span class="variable">$chkconfig</span> --level 35 iptables on</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h5 id="iptables-restore命令"><a href="#iptables-restore命令" class="headerlink" title="iptables-restore命令"></a>iptables-restore命令</h5><p>使用iptables-restore命令,可以从已保存的配置文件中导入iptables规则（该文件必须是使用iptables-save命令导出的配置数据）.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables-save &gt;/etc/sysconfig/iptablesbak   <span class="comment">#备份</span></span><br><span class="line">iptables-restore &lt;/etc/sysconfig/iptablesbak <span class="comment">#恢复</span></span><br></pre></td></tr></table></figure>
<hr/>

<h4 id="0x04-NAT转发应用场景"><a href="#0x04-NAT转发应用场景" class="headerlink" title="0x04 NAT转发应用场景"></a>0x04 NAT转发应用场景</h4><p>那么，当Linux防火墙同时作为企业的网关服务器使用的时候，怎样使局域网用户也能够访问互联网呢？又怎样才能使互联网中的用户能够访问到局域网内部的网络服务器？iptables真的能做到这些吗？<br>答案是：Yes的</p>
<p><em>主要介绍nat表中的两个典型应用：</em><br>SNAT和DNAT策略（分别用于实现企业局域网共享上网、在Internet中发布内网的应用服务器），相同点都必须开启网关服务器的路由转发功能(net.ipv4.ip_forward=1)，不同点一个源地址而一个是目标地址。</p>
<p><strong>1）SNAT 策略及应用</strong><br>SNAT策略概述:随着Internet网络在全世界范围内的快速发展,IPv4协议支持的可用IP地址资源逐渐变得山穷水尽,资源匮乏使得很多企业难以申请更多的公网IP地址,或者只能承受一个或者少数几个公网IP地址的费用而与此同时,大部分企业都面临着将局域网的主机接入Internet的需求，使用iptables的SNAT策略,可以基本化解这个难题。</p>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614221351.png" target="_blank" title="WeiyiGeek.SNAT案例" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614221351.png" alt="WeiyiGeek.SNAT案例" title="" class=""></a>
                <p>WeiyiGeek.SNAT案例</p>
            </figure>
<p>当Linux网关服务器正常开启路由转发（未使用SNAT）时,局域网访问Internet的数据包,<code>经网关转发后其源IP地址保持不变（仍为192.168.1.100）</code>,而Internet中主机收到这样的请求数据包后,将无法为其返回应答数据包（因为该地址是私有IP地址,无法为其正确路由）,从而导致访问失败；</p>
<p>如果在Linux网关服务器中有针对性的应用SNAT策略,数据包转发情况就不一样了,<code>当局域网访问Internet的数据包到达网关服务器时,网关进行路由选择,若发现该数据包需要从外网接口（如eth0）向外转发</code>,则将该数据包的源IP地址（如：192.168.1.100）修改为网关的外网接口地址（如：218.29.30.31）,然后才提交到Internet中,最后发送到目标主机（<a href="http://www.google.com）.相当于以网关服务器的公网身份提交数据访问请求,自然就可以收到正常的响应数据包;`然后网关服务器再根据之前建立的SNAT映射`,将响应数据包返回给局域网中的源主机,只要连接到第一个包被SNAT处理了,那么这个连接及对应数据流的其他包通常也会自动的被进行SNAT处理。" target="_blank" rel="noopener">www.google.com）.相当于以网关服务器的公网身份提交数据访问请求,自然就可以收到正常的响应数据包;`然后网关服务器再根据之前建立的SNAT映射`,将响应数据包返回给局域网中的源主机,只要连接到第一个包被SNAT处理了,那么这个连接及对应数据流的其他包通常也会自动的被进行SNAT处理。</a></p>
<p><em>SNAT策略应用:</em><br>（解决上述问题）从前面的需求中大致了解到,SNAT典型应用于局域网共享上网的接入,而处理数据包的切入时机,主要选择在路由选择之后（POSTROUTING）进行,<code>SNAT的关键在于将局域网外发数据包的源IP地址（私有地址）修改为网关的外网接口IP地址（公有地址）</code>。</p>
<p>SNAT只能用于nat表的POSTROUTING链,使用iptables命令设置SNAT策略时,需要结合“–to-source 出口IP地址”选项指定修改后的IP地址,例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-j SNAT --to-source 218.29.30.31</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>实例配置来说明SNAT策略的用法,案例环境及需求描述如下（拓扑图如上）<br>I、公司的网关服务器使用了Linux操作系统。<br>II、网关上有两块网卡：其中eth0连接Internet,使用固定IP地址 218.29.30.31/30；eth1连接局域网,使用固定IP地址192.168.1.1/24。<br>III、局域网内各主机的默认网关设置为192.168.1.1,且已经设置了正确的DNS服务器。<br>IIII、现需要在Linux网关主机中进行正确配置,以使192.168.1.0/24网段的局域网用户能够共享方式访问Internet。</p>
<p>根据上述环境,在Linux网关中推荐的操作步骤如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(1)、确认开启网关服务器的路由转发功能</span><br><span class="line"><span class="variable">$vim</span> /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="variable">$sysctl</span> -p</span><br><span class="line"></span><br><span class="line">(2)、为局域网访问Internet的数据包采用SNAT策略,将源地址更改为服务器的公网IP地址</span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j SNAT --to-source 218.29.30.31</span><br><span class="line">使用局域网内的客户机访问Internet中的网站（如：www.baidu.com）进行测试,测试成功以后将上述SNAT策略添加到防火墙脚本文件中,并设置未开机后自动运行。</span><br></pre></td></tr></table></figure></p>
<p>PS:以上介绍的应用是网关服务器具有固定的静态公网IP地址的情况,而在某些时候,企业很可能使用非固定的动态公网地址,例如使用ADSL宽带接入时可能获得是动态IP地址。那么在这种网络环境下,又应该如何设置SNAT策略呢？</p>
<ul>
<li>iptables提供了一个名为MASQUERADE(伪装masquerade)的数据包处理方式,MASQUERADE相当于SNAT的特例,同样也完成修改（伪装）数据包源IP地址的工作,只不过它会自动获取外网接口的IP地址,而无需使用“–to-source”的形式。</li>
<li>使用iptables命令设置MASQUERADE策略时,只需要去掉SNAT策略中的“–to-source IP地址”,改用“-j MASQUERADE”指定数据包处理方式即可.ADSL通常使用PPPOE技术,在Linux系统中,对应的连接名称为ppp0、ppp1等,如果无法确定连接的编号,还可以使用ppp+代替。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例1.当外网地址事动态变化的就采用MASQUERADE策略</span></span><br><span class="line"><span class="comment">#eg:设置MASQUERADE策略,使用192.168.1.0/24网段能够通过网关的ppp0连接共享上网.</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o ppp0 -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment">#当然,即使网关服务器有静态的IP地址,也同样可以使用MASQUERADE而不用SNAT只不过,MASQUERADE会比SNAT多一些额外的开销,因此如果有固定的IP地址,最好还是使用SNAT策略.</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>2) DNAT策略及应用</strong><br>DNAT策略概述：DNAT策略与SNAT非常相似,只不过应用方向反过来了.SNAT用于修改源IP地址,而DNAT用于修改目标IP地址；</p>
<ul>
<li>SNAT只能在nat表的POSTROUTING链中</li>
<li>DNAT只能用在nat表的PREROUTING链和OUTPUT链（或被其调用的链）中.</li>
</ul>
<p>例如：考虑到应用服务的安全和稳定性,公司将对外的Web服务器架设在一个内部网络中,而公司仍然只有一个公网IP地址,又需要使Internet中的客户机能够访问公司的网站,这时候,使用DNAT策略可以有效保证位于内网中的网站服务器于Internet中的客户机的相互通讯.</p>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614230033.png" target="_blank" title="WeiyiGeek.DNAT" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614230033.png" alt="WeiyiGeek.DNAT" title="" class=""></a>
                <p>WeiyiGeek.DNAT</p>
            </figure>
<p>由于企业申请的Internet域名要解析到一个合法的公网IP地址（如：218.29.30.31）,当Internet中的客户机提交的http请求到达企业的网关主机时,网关首先判断该数据包的目标地址和目标端口,若发现该数据包需要访问本机的80端口,则将该数据包的目标IP地址（如：218.29.30.31）修改为内网中真正的网站服务器的IP地址（如：192.168.1.6）,然后才进行路由选择,最后发送到内部的网站服务器（192.168.1.6）.然后网关服务器再根据之前建立的DNAT映射,修改返回的HTTP应答数据包的源IP地址,最后返回给Internet中的客户机.</p>
<p>在上述的DNAT转换地址的过程,Internet中的客户机无需指定企业网站服务器的真实局域网地址,中间的转换完全由网关主机完成.通过DNAT策略,位于企业内部的应用服务器就可以对Internet提供服务了.</p>
<p>DNAT策略的应用：使用iptables命令设置DNAT策略时,需要结合”–to-destination IP地址”的选项指定企业内网服务器的实际IP地址，如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-j DNAT --to-destination 218.29.30.31</span><br></pre></td></tr></table></figure></p>
<p><em>解决上面拓扑图问题的DNAT策略的用法:</em><br>I、公司在ISP注册了域名 <a href="http://www.lansgg.com,并对应于Linux网关的外网的接口（eth0）地址：218.20.30.31">www.lansgg.com,并对应于Linux网关的外网的接口（eth0）地址：218.20.30.31</a><br>II 、公司的网站服务器位于局域网内,IP地址为192.168.1.6<br>III 、Internet用户可以通过访问<a href="http://www.lansgg.com来查看公司的网站内容" target="_blank" rel="noopener">www.lansgg.com来查看公司的网站内容</a>.</p>
<p>根据上述环境,在Linux网关中推荐的操作步骤如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">（1）确认开启网关服务器的路由转发功能</span><br><span class="line">$vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line">$sysctl -p</span><br><span class="line"></span><br><span class="line">（2）在网关上添加DNAT映射,对于访问网关80端口的数据包,将目标地址更改为网站服务器的内网IP地址</span><br><span class="line">iptables -t nat -A PREROUTING -i eth0 -d 218.29.30.31 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.6</span><br><span class="line">使用Internet中客户机访问，http:&#x2F;&#x2F;www.lansgg.com进行测试,测试成功以后将上述DNAT策略添加到网关的防火墙脚本文件中,并设置为开机后自动运行.</span><br></pre></td></tr></table></figure></p>
<p>Ps: <code>如果没有设置SNAT共享上网策略,内网的客户机可能将无法使用公网地址（如：218.29.30.31）的形式访问公司内部的网站服务器.若确实有这种需求,可以有针对性的添加一条SNAT规则</code>,如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -I POSTROUTING -s 192.168.1.0&#x2F;24 -d 218.29.30.31 -p tcp --dport 80 -j SNAT --to-source 192.168.1.1</span><br><span class="line"></span><br><span class="line">#假设所需要包1.2.3.4端口号为8080的TCP数据包重定向到目的地址是192.168.1.1端口号是80：</span><br><span class="line">iptables -A PREROUTING -t nat -p tcp -d 1.2.3.4 --dport 8080 -j DNAT --to 192.168.1.1:80</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>例2：若需要做DNAT的内部服务与网关主机本身的服务发送冲突,则需要对数据访问进行区分.例如,Linux网关本身运行了SSH服务,内部网络中的数据库服务器也运行了SSH服务,两台主机都希望能从Internet中进行远程管理.由于可用的公网IP地址只有一个,因此就有必要在网关上根据访问端口进行区分.SSH服务器默认使用的端口号为22。<br><figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614230945.png" target="_blank" title="WeiyiGeek.案例2" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614230945.png" alt="WeiyiGeek.案例2" title="" class=""></a>
                <p>WeiyiGeek.案例2</p>
            </figure></p>
<p>I、公司的Linux网关服务器的外网IP地址eth0:218.29.30.31；位于局域网的数据库服务器IP地址：192.168.1.5；<br>II、根据公司安排,管理员要能够随时从家里的主机远程管理数据库服务器,登录的目标地址为218.29.30.31：2222<br>III、管理员家里主机的IP地址可能在63.34.45.0/24网段范围中随机变动.</p>
<p>根据上述环境,应用DNAT策略的思路如下.</p>
<ul>
<li>1.访问218.29.30.31:22的数据仍保持默认（不做处理）,对应网关主机本身的SSH服务.</li>
<li>2.两台主机的SSH服务都使用默认的22端口不变.</li>
<li>3.在网关主机上,将访问本机2222端口的数据包进行DNAT处理,对应到内部网络中的数据库服务器（需要同时指定目标端口）</li>
</ul>
<p>推荐操作步骤如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">（1）、在数据库服务器上开启ssh服务,（注意设置好路由或默认网关记录）</span><br><span class="line">service sshd start</span><br><span class="line">route add -net 63.34.45.0/24 gw 192.168.1.1</span><br><span class="line"></span><br><span class="line">（2）、确认开启网关服务器的路由转发功能.</span><br><span class="line"><span class="variable">$vim</span> /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="variable">$sysctl</span> -p</span><br><span class="line"></span><br><span class="line">（3）、在网关上添加DNAT映射,对于访问网关2222端口的数据包,将目标地址更改为数据库服务器主机的内网IP地址</span><br><span class="line">iptables -t nat -A PREROUTING -i eth0 -s 63.34.45.0/24 -d 218.29.30.31 -p tcp --dport 2222 -j DNAT --to-destination 192.168.1.5:22</span><br><span class="line"></span><br><span class="line"><span class="comment">#经测试成功以后,将上述DNAT策略添加到防火墙脚本文件中,并设置为开机后自动运行.</span></span><br></pre></td></tr></table></figure></p>
<p>下面是防火墙脚本方面的东西，前面已经学会了iptables命令的语法和简单的规则设置.在添加防火墙规则时,必须充分理解数据包匹配的流程,尤其是规则链内的匹配流程。这样才能更好的优化规则顺序,提高包过滤机制的效率和准确性.</p>
<hr/>

<h4 id="0x05-iptables实用场景配置"><a href="#0x05-iptables实用场景配置" class="headerlink" title="0x05 iptables实用场景配置"></a>0x05 iptables实用场景配置</h4><p>示例1.Linuxiptables配置场景一</p>
<ul>
<li>规则1、对所有的地址开放本机的tcp(80,22,10-21)端口访问</li>
<li>规则2、允许对所有的地址开放本机的基于ICMP协议的数据包访问</li>
<li>规则3、其他未被允许的端口则禁止访问<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;iptables -v  <span class="comment">#显示版本</span></span><br><span class="line">&gt;iptables -nL <span class="comment">#显示设置的规则列表,不显示主机名</span></span><br><span class="line">&gt;iptables -F  <span class="comment">#把之前设置的规则清除掉</span></span><br><span class="line"></span><br><span class="line">&gt;iptables -I INPUT -p tcp --dport 80,22 -j ACCEPT <span class="comment">#I插入 通道INPUT p协议 端口80 可以接受</span></span><br><span class="line">&gt;iptables -I INPUT -p tcp --dport 10:21 -j ACCEPT <span class="comment">#端口范围</span></span><br><span class="line">&gt;iptables -I INPUT -p icmp -j ACCEPT</span><br><span class="line">&gt;iptables -A INPUT -j REJECT    <span class="comment">#A after在之后 , -I 插入在前 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#存在的问题,本机无法访问本级,本机无法访问其他主机</span></span><br><span class="line">&gt;iptables -I INPUT -i lo -j ACCEPT   <span class="comment">#指定网卡lo</span></span><br><span class="line">&gt;iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT <span class="comment">#state状态的允许</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在场景一的基础上，修改只允许10.103.188.233访问本级的httpd服务</span></span><br><span class="line">&gt;iptables -D INPUT -p tcp --dport 80 -j ACCEPT <span class="comment">#D删除INPUT链中允许所有的地址访问80端口</span></span><br><span class="line">&gt;iptables -I INPUT -p tcp -s 10.10.188.233 --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br/></p>
<p>示例2.Linuxiptables配置场景二<br>1、ftp主动模式下iptables的规则配置（客户端开启随机端口，服务端开始21与22）<br>2、iptables对于FTP主动模式(iptables需要开启21，20端口的访问权限),ftp连接的默认模式为被动模式<br>3、vsftp服务支持主动模式需要注意配置选项<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$vim</span> /etc/vsftpd/vsftpd.conf</span><br><span class="line">port_enables=yes</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"></span><br><span class="line">$/etc/init.d/vsftpd restart</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614232038.png" target="_blank" title="WeiyiGeek.FTP主动模式" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614232038.png" alt="WeiyiGeek.FTP主动模式" title="" class=""></a>
                <p>WeiyiGeek.FTP主动模式</p>
            </figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例2</span></span><br><span class="line">iptables -nL</span><br><span class="line">iptables -I INPUT -p tcp --dport 21,22 -j ACCEPT</span><br><span class="line">iptables -I INPUT -p icmp -j ACCEPT</span><br><span class="line">iptables -I INPUT -m <span class="built_in">stat</span> --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -j REJECT</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>示例3.Linuxiptables配置场景三<br>1、ftp被动模式下iptables的规则配置（服务端开启21与随机端口，客户端被动连接到服务端）<br>ftp&gt;passive #开启被动模式，在执行一次passive off后就是采用主动模式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改ftp被动模式随机端口的范围：</span></span><br><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">&gt;pasv_min_port=50000</span><br><span class="line">&gt;pasv_max_port=60000</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614232352.png" target="_blank" title="WeiyiGeek.ftp被动模式" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614232352.png" alt="WeiyiGeek.ftp被动模式" title="" class=""></a>
                <p>WeiyiGeek.ftp被动模式</p>
            </figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例3.</span></span><br><span class="line">iptables -I INPUT -p tcp --dport 21 -j ACCEPT</span><br><span class="line">iptables -I INPUT -p tcp --dport 50000:60000 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用连接Socket(套字节)模块</span></span><br><span class="line">&gt; vim /etc/sysconfig/iptables_config</span><br><span class="line">IPTABLES_MODULES=<span class="string">"nf_conntrack_ftp"</span></span><br><span class="line">modprobe nf_conntrack_ftp  <span class="comment">#临时加入 内核(kernel)</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614232521.png" target="_blank" title="WeiyiGeek.iptable_config" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614232521.png" alt="WeiyiGeek.iptable_config" title="" class=""></a>
                <p>WeiyiGeek.iptable_config</p>
            </figure>
<p><br></p>
<p>示例4.Linuxiptables配置场景四<br>SNAT（转发）与DNAT （映射）:</p>
<ul>
<li>SNAT : 源地址转换 ：作用链(出口POSTROUTING)</li>
<li>DNAT : 目标地址转换 ：作用链(进口POSTROUTING,OUTPUT)</li>
</ul>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614233000.png" target="_blank" title="WeiyiGeek.示例4" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190614233000.png" alt="WeiyiGeek.示例4" title="" class=""></a>
                <p>WeiyiGeek.示例4</p>
            </figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 示例1.SNAT 使用 ###</span></span><br><span class="line">&gt;netstat -rn</span><br><span class="line"></span><br><span class="line"><span class="comment"># Client 加入默认网关</span></span><br><span class="line">&gt;cat /etc/sysconfig/network  <span class="comment">#增加默认网关</span></span><br><span class="line">GATEWAY=10.10.177.232</span><br><span class="line">&gt;route add 10.10.177.233 gw 10.10.177.232</span><br><span class="line"></span><br><span class="line"><span class="comment">#Mat Server 执行</span></span><br><span class="line">&gt;vim /etc/sysctl.conf   <span class="comment">#修改 net.ipv4.ip_forward=1</span></span><br><span class="line">&gt;sysctl -p</span><br><span class="line">&gt;sysctl -a|grep ip_forward</span><br><span class="line"></span><br><span class="line">&gt;iptables -t nat -A POSTROUTING -s 10.10.177.0/24 -j SNAT --to-source 10.10.188.232</span><br><span class="line">&gt;iptables -t nat -L</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 示例2.DNAT 使用 ### 同样也要修改、然后Clinet就能访问HTTP SERVER</span></span><br><span class="line">iptables -t nat -F  <span class="comment">#清除表规则</span></span><br><span class="line">iptables -t nat -A PREROUTING -d 10.10.188.232  -p tcp --dport 80 -j DNAT --to-destination 10.10.177.233:80</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>示例5.Linux IPtables配置场景五</p>
<ul>
<li>要求一：员工在公司内部(10.10.155.0/24，10.10.188.0/24)能访问服务器上的任何服务</li>
<li>要求二：当员工出差到外地，通过VPN连接到公司外网</li>
<li>要求三：公司有一个门户网站需要允许公网访问<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">常见允许外网访问的服务</span><br><span class="line">网站 www http         80/tcp</span><br><span class="line">         https       443/tcp</span><br><span class="line">邮件mail  smtp       25/tcp</span><br><span class="line">          smtps     465/tcp</span><br><span class="line">          pop3       110/tcp</span><br><span class="line">          pop3s     995/tcp</span><br><span class="line">          imap       143/tcp</span><br><span class="line"></span><br><span class="line">一些常见不允许外网访问的服务</span><br><span class="line">文件服务器：NFS        123/udp</span><br><span class="line">          SAMBA 137,138,139/tcp 445/tcp</span><br><span class="line">          FTP         20/tcp,21/tcp</span><br><span class="line">远程管理：SSH      22/tcp</span><br><span class="line">数据库：  MYSQL    3306/tcp</span><br><span class="line">          ORACLE 1521/tcp</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>配置规则的基本思路:</p>
<ul>
<li>ACCEPT规则:允许本地访问/允许已监听状态数据包通过/允许规则中的数据包通过</li>
<li>DENY规则：拒绝未被允许的数据包</li>
</ul>
<p>实际配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;iptables -F</span><br><span class="line">&gt;iptables -I INPUT -i lo -j ACCEPT</span><br><span class="line">&gt;iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">&gt;iptables -A INPUT -s 10.10.155.0/24 -j ACCEPT</span><br><span class="line">&gt;iptables -A INPUT -s 10.10.188.0/24 -j ACCEPT</span><br><span class="line">&gt;iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">&gt;iptables -A INPUT -p tcp --ddport 1723 -j ACCEPT</span><br><span class="line"><span class="comment">#DENY OTHERS #记得把本机也加入iptables</span></span><br><span class="line">&gt;iptables -A INPUT -j REJECT</span><br><span class="line">&gt;iptables -nL</span><br></pre></td></tr></table></figure></p>
<p><br><br>示例6.Linuxiptables配置场景六<br>描述：利用iptables防CC攻击,攻击者借助代理服务器生成指向受害主机的合法请求实现DDOS和伪装就叫：CC(Challenge Collapsar)</p>
<p>利用iptables防CC攻击的模块主要有两个：</p>
<ul>
<li>connlimit模块 ： 用于限制每一个客户端ip的并发连结数,<code>参数：-connlimit-above n #限制并发个数</code></li>
<li>limit模块: 限速，控制流量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例6.</span></span><br><span class="line">&gt;iptables -I INPUT -p tcp -syn -dport 80 -m connlimit -connlimit-above 100 -j REJECT</span><br><span class="line"></span><br><span class="line">&gt;iptables -A INPUT -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/hour</span><br><span class="line">&gt;iptables -A INPUT -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --<span class="built_in">limit</span> -burst 10 -j ACCEPT   <span class="comment"># 缓冲区一样10条 --limit -burst默认值为5</span></span><br></pre></td></tr></table></figure>
<p><br><br>示例7.VPN配置场景设置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 1723 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p gre -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#对 10.10.10.0.0/24 网段控制VPN</span></span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -A FORWARD -p tcp -s 10.10.0.0/24 -m mutilport --dports 80,110,21,25,1723 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p udp -s 10.10.0.0/24 --dports 53 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p gre -s 10.10.0.0/24 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p icmp -s 10.10.0.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p><br><br>示例8.模块对于关键字模块与时间模块，日期模块得引用.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-m string --string <span class="string">"关键字"</span></span><br><span class="line">-m time --timestart 10:00 --timestop 12:00</span><br><span class="line">-m time --timestart 10:00 --timestop 12:00 --day Mon,Tue,Wed,Thu,Fri,Sat,Sun</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190619091437.png" target="_blank" title="WeiyiGeek.模块使用" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190619091437.png" alt="WeiyiGeek.模块使用" title="" class=""></a>
                <p>WeiyiGeek.模块使用</p>
            </figure>
<p><br></p>
<p>示例9.SNAT、DNAT配置场景设置<br>SNAT：修改包的源地址(改变连接的源IP地址)<br>DNAT: 修改包的目标地址(改变连接的目的IP)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要将接受到源IP地址为192.168.1.12的数据包进行SNAT为202.110.123.100转换</span></span><br><span class="line">iptables -A POSTROUTING -o eth0 -s 192.168.1.12 -j SNAT --to 202.110.123.100</span><br><span class="line"></span><br><span class="line"><span class="comment">#源地址转换为1.2.3.4则iptables的配置如下：(注意作用链不同)</span></span><br><span class="line">iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to 1.2.3.4</span><br><span class="line">iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to 1.2.3.4-1.2.3.6  <span class="comment">#转成成1.2.3.4/5/6</span></span><br><span class="line">iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to 1.2.3.4:1-1023 <span class="comment">#转成成1.2.3.4端口号为1-1023</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#目的地址转换为1.2.3.4则iptables的配置如下：(注意作用链不同与接口 -i  / -o)</span></span><br><span class="line">iptables -t nat -A PREROUTING -i eth0 -j DNAT --to 1.2.3.4</span><br><span class="line">iptables -t nat -A RREROUTING -i eth0 -j DNAT --to 1.2.3.4-1.2.3.6  <span class="comment">#转成成1.2.3.4/5/6</span></span><br><span class="line">iptables -t nat -A PREROUTING -i eth0 -j DNAT --to 1.2.3.4:1-1023 <span class="comment">#转成成1.2.3.4端口号为1-1023</span></span><br><span class="line"><span class="comment">#将web数据包的目的地址转换成为5.6.7.8端口号是8080,则iptables的配置如下</span></span><br><span class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -i eth0 -j DNAT -to 5.6.7.8：:8080</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>示例10.网络安全保护配置场景设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#网络攻击源阻断</span></span><br><span class="line">iptables -A INPUT -s 20.200.200.1 -j DROP</span><br><span class="line">iptables -A INPUT -i ppp0 -p tcp --sync -j DROP <span class="comment">#禁止用外部访问内部网配置</span></span><br><span class="line"><span class="comment">#补充：--syn 相当于 --tcp-flags SYN、RST、ACK、SYN的简写</span></span><br><span class="line">iptables -A INPUT -i ppp0 -p tcp --destination-port telnet -j DROP <span class="comment">#禁止用外部访问内部服务</span></span><br><span class="line">iptables -A INPUT -s 200.200.200.1 -p tcp --destination-port telnet -j DROP <span class="comment">#禁止使用服务</span></span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --syn --destination-port !80 -j DROP <span class="comment">#指定服务才能被访问</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#防止同步风暴SYN Flood 攻击</span></span><br><span class="line">iptables -A FORWARD -p tcp --syn -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s -j ACCEPT </span><br><span class="line"><span class="comment">#端口扫描防护</span></span><br><span class="line">iptables -A FORWARD -p tcp --tcp-flags SYN,ACK,FIN,RST -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s -j ACCEPT </span><br><span class="line"><span class="comment">#ping of death 防护</span></span><br><span class="line">iptables -A FORWARD -p icmp --icmp-type <span class="built_in">echo</span>-request -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s -j ACCEPT</span><br></pre></td></tr></table></figure>
<p><br><br>示例11.iptables综合实例<br>假设test企业网段地址是198.168.80.0/24内部网中存在以下服务器;</p>
<ul>
<li>WWW: <a href="http://www.test.com" target="_blank" rel="noopener">www.test.com</a> / 198.168.80.11</li>
<li>FTP：ftp.test.com / 198.168.80.12</li>
<li>Email: mail.test.com / 198.168.80.13<figure class="image-box">
                <a rel=Iptables防火墙基础讲解 href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190619100836.png" target="_blank" title="WeiyiGeek.环境示例图" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2019/20190619100836.png" alt="WeiyiGeek.环境示例图" title="" class=""></a>
                <p>WeiyiGeek.环境示例图</p>
            </figure>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#刷新防火墙规则链</span></span><br><span class="line">/sbin/iptables -F</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line"><span class="comment">#www服务</span></span><br><span class="line">iptables -A FORWARD -p tcp -d 198.168.80.11 --dport 80 -i eth0 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#ftp服务（被动模式）</span></span><br><span class="line">iptables -A FORWARD -p tcp -d 198.168.80.12 --dport 21 -i eth0 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#Email服务</span></span><br><span class="line">iptables -A FORWARD -p tcp -d 198.168.80.13 --dport 25 -i eth0 -j ACCRPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#针对于internet攻击（但不能防止来自intranet 内部网络攻击）</span></span><br><span class="line">iptables -A FORWARD -p tcp -s 0/0 --sport 21 -d 192.168.80.0/24 -i eth0 -j ACCEPT </span><br><span class="line">iptables -A FORWARD -p tcp -d 192.168.80.0/24 ! --syn -i eth0 -j ACCEPT </span><br><span class="line">iptables -A FORWARD -p udp -d 192.168.80.0/24 -i eth0 -j ACCEPT </span><br><span class="line"></span><br><span class="line"><span class="comment">#内部网络intranet的数据包过滤</span></span><br><span class="line">iptables -A FORWARD -s 192.168.80.0/24 -i eth1 </span><br><span class="line"></span><br><span class="line"><span class="comment">#IP碎片攻击配置(每秒100个碎片)</span></span><br><span class="line">iptables -A FORWARD -f -m <span class="built_in">limit</span>- --<span class="built_in">limit</span> 100/s --<span class="built_in">limit</span>-burst 100 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置ICMP包过滤</span></span><br><span class="line">iptables -A FORWARD -p icmp -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s --<span class="built_in">limit</span>-burst 10 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>示例12.利用IPtables的<code>net.ipv4.ip_forward</code>NAT转发使得内网不能上网的主机通过转发上网;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) 基础配置网关服务器外网IP </span></span><br><span class="line">eth0: 10.0.0.1</span><br><span class="line">eth1: 192.168.12.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) 在网关服务器开启转发功能</span></span><br><span class="line">sysctl -p</span><br><span class="line">grep <span class="string">"net.ipv4.ip_forward = 0"</span> /etc/sysctl.conf &amp;&amp; sed -i <span class="string">'s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/g'</span> /etc/sysctl.conf </span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) 设置网关服务器iptables的 nat 转换</span></span><br><span class="line">/etc/init.d/iptables stop</span><br><span class="line">/sbin/iptables -t nat -A POSTROUTING -o eth0  -s 192.168.12.0/24 -j MASQUERADE </span><br><span class="line">/etc/init.d/iptables start</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) 后端局域网服务器需要上网的，内网IP需要设置为192.168.1.0/24网段IP。同时设置网关IP为网关服务器连接内网的接口IP也就是 192.168.1.1</span></span><br><span class="line">ifconfig eth0 192.168.12.1/24 up      <span class="comment"># 接口有变化需根据实际情况更改</span></span><br><span class="line">route add default gw 192.168.12.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) 后端局域网服务器实战</span></span><br><span class="line">$ route</span><br><span class="line">  <span class="comment"># Kernel IP routing table</span></span><br><span class="line">  <span class="comment"># Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span></span><br><span class="line">  <span class="comment"># default         _gateway        0.0.0.0         UG    0      0        0 eno1</span></span><br><span class="line">  <span class="comment"># default         _gateway        0.0.0.0         UG    0      0        0 eno1</span></span><br><span class="line">  <span class="comment"># 192.168.12.0    0.0.0.0         255.255.255.0   U     0      0        0 eno1</span></span><br><span class="line"></span><br><span class="line">$ ping 14.215.177.39  <span class="comment"># 成功访问外网</span></span><br><span class="line">  <span class="comment"># PING 14.215.177.39 (14.215.177.39) 56(84) bytes of data.</span></span><br><span class="line">  <span class="comment"># 64 bytes from 14.215.177.39: icmp_seq=2 ttl=52 time=29.8 ms</span></span><br><span class="line">  <span class="comment"># 64 bytes from 14.215.177.39: icmp_seq=4 ttl=52 time=29.6 ms</span></span><br><span class="line"></span><br><span class="line">$ traceroute 192.168.12.123  <span class="comment"># 内部LAN是直接访问</span></span><br><span class="line">  <span class="comment"># traceroute to 192.168.12.123 (192.168.12.123), 30 hops max, 60 byte packets</span></span><br><span class="line">  <span class="comment">#  1  192.168.12.123 (192.168.12.123)  0.208 ms  0.188 ms  0.173 ms</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="0x06-reference"><a href="#0x06-reference" class="headerlink" title="0x06 reference"></a>0x06 reference</h3><p><a href="https://www.cnblogs.com/syavingcs/articles/12017494.html" target="_blank" rel="noopener">https://www.cnblogs.com/syavingcs/articles/12017494.html</a></p>

        </div>
        <!-- Google 广告 -->
        
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9134434519967436" data-ad-slot="7905848205"></ins>
  

        
<hr/>
<div style="text-align: center;font-weight: bold;">
  <p> 欢迎各位志同道合的朋友一起学习交流，如文章有误请在下方留下您宝贵的经验知识，个人邮箱地址<b style="color:#ff654e"><code>【master#weiyigeek.top】</code></b>或者个人公众号<b style="color:#ff654e"><code>【WeiyiGeek】</code></b>联系我。 </p>
  <p> 更多文章来源于<b style="color:#03a9f4">【WeiyiGeek Blog - 为了能到远方，脚下的每一步都不能少】</b>, 个人首页地址( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>
<!-- 

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"【点个赞】，动动你那粗壮的拇指或者芊芊玉手，亲！"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"【投个币】，万水千山总是情，投个硬币行不行，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("【收个藏】，阅后即焚不吃灰，亲！")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("【转个发】，让更多的志同道合的朋友一起学习交流，亲！")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("【关个注】，后续浏览查看不迷路哟，亲！")</span></p>
    </li>
  </ul> -->
  <div>
    <img src="/img/share-wechat.jpg" class="img-responsive" alt="扫描Follow(关注)WeiyiGeek公众号与Visit(浏览)极客全栈修炼小程序" >
    <p>专栏书写不易，如果您觉得这个专栏还不错的，请给这篇专栏 <b style="color: red;">【点个赞、投个币、收个藏、关个注、转个发、赞个助】</b>，这将对我的肯定，我将持续整理发布更多优质原创文章！。</p>
    <img src="/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>
</div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    最后更新时间：<time datetime="2022-04-13T02:20:04.809Z" itemprop="dateUpdated">2022-04-13 10:20:04</time>
</span><br>


        <span>文章原始路径：<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/系统运维/Linux/常用命令/防火墙类命令/Iptables防火墙基础讲解.md" target="_blank" rel="noopener noreferrer">_posts/系统运维/Linux/常用命令/防火墙类命令/Iptables防火墙基础讲解.md</a></span><br>
         <span class="copy-copyright">转载注明出处，原文地址：<a href="/2019/6-12-184.html" target="_blank" rel="external">https://blog.weiyigeek.top/2019/6-12-184.html</a></span><br>本站文章内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">☕️ 请作者喝杯咖啡!</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux%E9%98%B2%E7%81%AB%E5%A2%99/" rel="tag">Linux防火墙</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iptables%E9%98%B2%E7%81%AB%E5%A2%99/" rel="tag">iptables防火墙</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/6-12-184.html&title=《Iptables防火墙基础讲解》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/6-12-184.html&title=《Iptables防火墙基础讲解》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/6-12-184.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Iptables防火墙基础讲解》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/6-12-184.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/6-12-184.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- 评论组件 -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2019/6-12-154.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">系统软件服务类设置命令</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/6-12-169.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">系统配置性能优化测试</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x00-快速入门"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 快速入门</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x01-四张表五条链"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 四张表五条链</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-iptables-命令规则"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 iptables 命令规则</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x03-iptables-保存和恢复"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 iptables 保存和恢复</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x04-NAT转发应用场景"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 NAT转发应用场景</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x05-iptables实用场景配置"><span class="post-toc-number">6.</span> <span class="post-toc-text">0x05 iptables实用场景配置</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#0x06-reference"><span class="post-toc-number"></span> <span class="post-toc-text">0x06 reference</span></a>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    


    <!-- 支付宝微信文章赞赏 -->
    
      <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        如果此篇文章对您有帮助，就请作者喝杯 Coffee ☕️☕️!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="250" height="250" alt="微信打赏二维码">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="250" height="250" alt="支付宝打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

      

    <!-- 微信公众号关注/文章版权复制 -->
    
      <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">你好朋友,可以关个注吗? ❤ <br> 这将是我持续更新文章的动力源泉，谢谢支持！(๑′ᴗ‵๑) </b> <br> 如不想关注请点击右上角的【X】<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【My Twitter】</a></strong>. There is an article verification code in the homepage.
<br>方式2.请访问本博主的B站<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">【WeiyiGeek】</a></strong>首页关注UP主,<br>将自动随机获取解锁验证码。
<br>方式3.扫一扫下方二维码，关注本站<strong>官方公众号</strong><br>
回复：<strong style="color: rgb(240, 65, 52);">验证码</strong>
将获取<strong style="color: rgb(240, 65, 52);">解锁(有效期7天)</strong>本站所有技术文章哟!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="请输入验证码|Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">提
    交</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - 为了能到远方，脚下的每一步都不能少</p>
</div>
        
</article>
</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/search-wechat.jpg" target="_blank">公众账号</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">哔哩哔哩专栏</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">博主Github</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">博主Gitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">知乎</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">博客园</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">今日头条</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">简书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">腾讯云社区</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">百度文库</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">IT极客知识分享</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTO博客</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">掘金</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">微博文章</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">小红书</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.modb.pro/u/506690" target="_blank">墨天轮</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">抖音主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.kuaishou.com/profile/3xfbrsrhd2i69x9" target="_blank">快手主页</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.ixigua.com/home/3984243135350727" target="_blank">西瓜视频</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved.唯一极客IT知识分享 版权所有 </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>访问统计
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-站点地图">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-百度站点地图">站点地图</a> </span>
        <!-- 
  -->
        <br/>ICP备案号<span><a href="https://beian.miit.gov.cn" target="_blank">渝ICP备2022003447号</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSL安全认证" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2019/6-12-184.html&title=《Iptables防火墙基础讲解》 — WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2019/6-12-184.html&title=《Iptables防火墙基础讲解》 — WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2019/6-12-184.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Iptables防火墙基础讲解》 — WeiyiGeek Blog&url=https://blog.weiyigeek.top/2019/6-12-184.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2019/6-12-184.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACPUlEQVR42u3aS07EMBBF0ex/02GMkN33VSWA7ZsRooPjE6Tq+vi68HUPrp+fju4frTl6yvXGJUOGjGUZ9/Sab4tjRlsfrcP3JkOGjHMYtaXngZI8vs+WIUOGDBIE04A736gMGTJkvBFw5+vwv/rj7w0ZMmT8ewYpYsn9vNGWBvHHanEZMmQsyOBd99//+ZX5hgwZMpZi1EInGT2SVLKzk29rypAhY2sGD3CdFhsvaGv7kSFDxt4MHkZ52dnHxL+RIUPG1ox+tCYbTdNHXugGUw4ZMmQsy+hsnR8FS2F8tPDAf0CGDBmLMPoNej6w5Ac7+IuQIUPG3oy0Nc/L3c4IgQ9QixMGGTJkLMjgm6h1tzrDgGKCKEOGjI0YxfQLt974gJMnl8N2mwwZMrZm1LZFhpTpQLQYgmXIkHEMIy1Qa8VwOuYM6m8ZMmRszeDNL34MgieatRD8IcOVIUPGRgwyPqwdM0Un0UrDTvTtIUOGjO0Y/IgDHx7M7yfgB9JEGTJkbMRIF+o0yNJBAm8FypAh4wRGbUhQSy7Js+JXKUOGjAMYade902IjeV3ayJMhQ8Y5jNrBrH6QrTUHr/TNyZAhY0HGHV5pIkhCOVnzw+uWIUPG1ozOZLD2YB7cnxqLypAhYw9GGmR50kZGoXxcGnQNZciQsSmjU9zyrccVNiinZciQIaOzXR5w09VkyJAhIy0geeJIhp1FvAwZMg5g1BpqtSYdTx9fabfJkCFjQUbrpAa+kw84eQNOhgwZBzC+AKE9slBpl6JTAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<script> (adsbygoogle = window.adsbygoogle || []).push({});</script>    


<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 


  


<script>
  var _hmt = _hmt || [];
  (function() {
    // 百度统计
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-关注于网络安全_物联网安全开发_网络安全运维-学习心得分享';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 

     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>