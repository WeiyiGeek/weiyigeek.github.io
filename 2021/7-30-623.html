<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-language" content="zh-CN"/>
    <meta name="author" content="WeiyiGeek" />
    <meta name="msvalidate.01" content="5C552FB1D885E0E11D2957EC958C8018" />
    <meta name="shenma-site-verification" content="4c655e91c76be0a93c1b6954c666c9d6_1649049085"/>
    <meta name="bytedance-verification-code" content="lKs4FqwCHSJ3A/c5tT7X" />
    <meta name="sogou_site_verification" content="OC65iET6Bk" />
    
    <title>ğŸŒ 4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤|WeiyiGeek Blog|å”¯ä¸€æå®¢Geek-ITç½‘ç»œå®‰å…¨è¿ç»´å¼€å‘æŠ€æœ¯çŸ¥è¯†åˆ†äº«-åšå®¢ç«™ç‚¹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
    <meta name="keywords" content="kubernetes,Containerd">
    <meta name="Description" content="WeiyiGeek-å”¯ä¸€æå®¢åšå®¢ç«™ç‚¹,å…³æ³¨äºç½‘ç»œå®‰å…¨è¿ç»´,Webå®‰å…¨å¼€å‘,IOTç‰©è”ç½‘å®‰å…¨å¼€å‘,åº”ç”¨å¼€å‘,åˆ†äº«æŠ€æœ¯å­¦ä¹ çŸ¥è¯†ä¸å…¥å‘è§£å†³,æå‡ç½‘ç»œå®‰å…¨æŠ€æœ¯ä¸è‡ªèº«æŠ€æœ¯èƒ½åŠ›,ç«‹å¿—ç»´æŠ¤å¤§ä¼—ç½‘ç»œå®‰å…¨ä¸ºå·±ä»»,åšä¸€ä¸ªå¯¹å›½å®¶æœ‰ç”¨çš„äºº,ä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/jquery/3.5.2-jquery.fancybox.min.css?v=1.6.6" />
    <link rel="stylesheet" href="/css/style.css?v=1.6.6">
    <!--  -->
     <script type="text/javascript" src="/js/custom/articlecost.js?v=1.6.6"></script> 
    <link rel="stylesheet" href="/css/third-party/gitalk.css?v=1.6.6"> 
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}')
        };
    </script>
    <script type="text/javascript">window.lazyScripts=[];</script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="WeiyiGeek Blog" type="application/atom+xml">
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg" alt="WeiyiGeek-backgroud">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg" alt="WeiyiGeek-å¤´åƒ">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">WeiyiGeek</h5>
          <a href="mailto:master@weiyigeek.top" title="master@weiyigeek.top" class="mail">
            <span>m</span><span>a</span><span>s</span><span>t</span><span>e</span><span>r</span><span>@</span><span>w</span><span>e</span><span>i</span><span>y</span><span>i</span><span>g</span><span>e</span><span>e</span><span>k</span><span>.</span><span>t</span><span>o</span><span>p</span>
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">
                  <i class="icon icon-lg icon-wechat"></i>
                </a>
              </li>
            
              <li>
                <a href="https://github.com/weiyigeek" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://t.me/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-telegram"></i>
                </a>
              </li>
            
              <li>
                <a href="https://twitter.com/WeiyiGeek" target="_blank">
                  <i class="icon icon-lg icon-twitter"></i>
                </a>
              </li>
            
              <li>
                <a href="https://weibo.com/615643678" target="_blank">
                  <i class="icon icon-lg icon-weibo"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                é¦–é¡µ
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                æ–‡ç« åˆ†ç±»
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                æ–‡ç« æ ‡ç­¾
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                æ–‡ç« å½’æ¡£
              </a>
            </li>
        
            <li class="">
              <a href="/books"  >
                <i class="icon icon-lg icon-book"></i>
                å­¦ä¹ ä¹¦ç±
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                å…³äºä½œè€…
              </a>
            </li>
        
            <li class="">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                ç«™ç‚¹å¯¼èˆª
              </a>
            </li>
        
            <li class="">
              <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank" >
                <i class="icon icon-lg icon-wechat"></i>
                å…¬ä¼—è´¦å·
              </a>
            </li>
        
            <li class="">
              <a href="https://space.bilibili.com/385802642" target="_blank" >
                <i class="icon icon-lg icon-youtube-play"></i>
                å“”å“©å“”å“©
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/weiyigeek" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="">
              <a href="https://twitter.com/WeiyiGeek" target="_blank" >
                <i class="icon icon-lg icon-twitter"></i>
                Twitter
              </a>
            </li>
        
            <li class="">
              <a href="https://weibo.com/615643678" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤</span>
            
        </div>

        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        

        
            <a href="/atom.xml" class="header-icon pull-right waves-effect waves-circle waves-light">
                <i class="icon icon-lg icon-rss"></i>
            </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg" alt="æ–‡ç« å¤´éƒ¨èƒŒæ™¯">
    <div class="container fade-scale">
        <h1 class="title">4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-07-30T06:36:30.000Z" itemprop="datePublished" class="page-time">
  2021-07-30
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Containerd/4.åŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤æœ€æ–°å®è·µ"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-07-30 14:36:30" datetime="2021-07-30T06:36:30.000Z"  itemprop="datePublished">2021-07-30</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/">Containers</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Containers/OperationTools/">OperationTools</a></li></ul></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>[TOC]</p>
<a id="more"></a>
<h2 id="0x00-å‰è¨€ç®€è¿°"><a href="#0x00-å‰è¨€ç®€è¿°" class="headerlink" title="0x00 å‰è¨€ç®€è¿°"></a>0x00 å‰è¨€ç®€è¿°</h2><p>æè¿°: åœ¨æˆ‘åšå®¢ä»¥åŠå‰é¢çš„æ–‡ç« ä¹‹ä¸­è®²è§£Kubernetesç›¸å…³é›†ç¾¤ç¯å¢ƒçš„æ­å»º, éšç€K8SåŠå…¶ç›¸å…³ç»„ä»¶çš„è¿­ä»£, ä¸è¯»è€…å½“å‰æ¥è§¦çš„ç‰ˆæœ¬æœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥åœ¨å½“å‰ã€2022å¹´4æœˆ26æ—¥ 10:08:29ã€‘æ—¶é—´èŠ‚ç‚¹ï¼Œåšä¸»ä½¿ç”¨ubuntu 20.04 ã€haproxyã€keepaliveã€containerdã€etcdã€kubeadmã€kubectl ç­‰ç›¸å…³å·¥å…·æ’ä»¶ã€æœ€æ–°æˆ–è€…ç¨³å®šçš„ç‰ˆæœ¬ã€‘è¿›è¡Œå®è·µé«˜å¯ç”¨çš„kubernetesé›†ç¾¤çš„æ­å»ºï¼Œè¿™é‡Œä¸å†å¯¹k8sç­‰ç›¸å…³åŸºç¡€çŸ¥è¯†åšä»‹ç»ï¼Œå¦‚æœ‰æ–°å…¥é—¨çš„ç«¥é‹ï¼Œè¯·è®¿é—®å¦‚ä¸‹ã€åšå®¢æ–‡ç« ã€‘(<a href="https://blog.weiyigeek.top/tags/k8s/">https://blog.weiyigeek.top/tags/k8s/</a>) æˆ–è€…ã€Bç«™ä¸“æ ã€‘(<a href="https://www.bilibili.com/read/readlist/rl520875?spm_id_from=333.999.0.0" target="_blank" rel="noopener">https://www.bilibili.com/read/readlist/rl520875?spm_id_from=333.999.0.0</a>) æŒ‰ç…§é¡ºåºå­¦ä¹ ã€‚</p>
<p><strong>ç®€è¿°</strong><br>Kubernetes(åç»­ç®€ç§°k8s)æ˜¯ Google(2014å¹´6æœˆ) å¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’å¼•æ“ï¼Œä½¿ç”¨Goè¯­è¨€å¼€å‘ï¼Œå®ƒæ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²ã€å¤§è§„æ¨¡å¯ä¼¸ç¼©ã€ä»¥åŠäº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œç®¡ç†ã€‚å…¶ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨æ›´åŠ ç®€å•å¹¶ä¸”é«˜æ•ˆï¼Œæä¾›äº†èµ„æºè°ƒåº¦ã€éƒ¨ç½²ç®¡ç†ã€æœåŠ¡å‘ç°ã€æ‰©å®¹ç¼©å®¹ã€çŠ¶æ€ ç›‘æ§ã€ç»´æŠ¤ç­‰ä¸€æ•´å¥—åŠŸèƒ½, åŠªåŠ›æˆä¸ºè·¨ä¸»æœºé›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è‡ªåŠ¨åŒ–æ‰©å±•ä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºå®¹å™¨çš„å¹³å°ï¼Œå®ƒæ”¯æŒä¸€äº›åˆ—CNCFæ¯•ä¸šé¡¹ç›®ï¼ŒåŒ…æ‹¬ Containerdã€calico ç­‰ ã€‚</p>
<hr>
<h2 id="0x01-ç¯å¢ƒå‡†å¤‡"><a href="#0x01-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="0x01 ç¯å¢ƒå‡†å¤‡"></a>0x01 ç¯å¢ƒå‡†å¤‡</h2><h3 id="ä¸»æœºè§„åˆ’"><a href="#ä¸»æœºè§„åˆ’" class="headerlink" title="ä¸»æœºè§„åˆ’"></a>ä¸»æœºè§„åˆ’</h3><table>
<thead>
<tr>
<th style="text-align:center">ä¸»æœºåœ°å€</th>
<th style="text-align:center">ä¸»æœºåç§°</th>
<th style="text-align:center">ä¸»æœºé…ç½®</th>
<th style="text-align:center">ä¸»æœºè§’è‰²</th>
<th style="text-align:left">è½¯ä»¶ç»„ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">10.10.107.223</td>
<td style="text-align:center">master-223</td>
<td style="text-align:center">4C/4G/</td>
<td style="text-align:center">æ§åˆ¶èŠ‚ç‚¹</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">10.10.107.224</td>
<td style="text-align:center">master-224</td>
<td style="text-align:center">4C/4G</td>
<td style="text-align:center">æ§åˆ¶èŠ‚ç‚¹</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">10.10.107.225</td>
<td style="text-align:center">master-225</td>
<td style="text-align:center">4C/8G</td>
<td style="text-align:center">æ§åˆ¶èŠ‚ç‚¹</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">10.10.107.226</td>
<td style="text-align:center">node-1</td>
<td style="text-align:center">4C/2G</td>
<td style="text-align:center">å·¥ä½œèŠ‚ç‚¹</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">10.10.107.227</td>
<td style="text-align:center">node-2</td>
<td style="text-align:center">4C/2G</td>
<td style="text-align:center">å·¥ä½œèŠ‚ç‚¹</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">10.10.107.222</td>
<td style="text-align:center">weiyigeek.cluster.k8s</td>
<td style="text-align:center">-</td>
<td style="text-align:center">è™šæ‹ŸVIP</td>
<td style="text-align:left">è™šæ‹Ÿç½‘å¡åœ°å€</td>
</tr>
</tbody>
</table>
<p>æ¸©é¦¨æç¤º: æ­¤å¤„ä½¿ç”¨çš„æ˜¯ Ubuntu 20.04 æ“ä½œç³»ç»Ÿ, è¯¥ç³»ç»Ÿå·²åšå®‰å…¨åŠ å›ºå’Œå†…æ ¸ä¼˜åŒ–ç¬¦åˆç­‰ä¿2.0è¦æ±‚ã€SecOpsDev/Ubuntu-InitializeSecurity.sh at master Â· WeiyiGeek/SecOpsDev (github.com)ã€‘, å¦‚ä½ çš„Linuxæœªè¿›è¡Œç›¸åº”é…ç½®ç¯å¢ƒå¯èƒ½ä¸è¯»è€…æœ‰äº›è®¸å·®å¼‚, å¦‚éœ€è¦è¿›è¡Œ(windows server ã€Ubuntuã€CentOS)å®‰å…¨åŠ å›ºè¯·å‚ç…§å¦‚ä¸‹åŠ å›ºè„šæœ¬è¿›è¡ŒåŠ å›º, è¯·å¤§å®¶ç–¯ç‹‚çš„ star ã€‚</p>
<p>åŠ å›ºè„šæœ¬åœ°å€:ã€ <a href="https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh" target="_blank" rel="noopener">https://github.com/WeiyiGeek/SecOpsDev/blob/master/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux/Ubuntu/Ubuntu-InitializeSecurity.sh</a> ã€‘</p>
<p><br/></p>
<h3 id="è½¯ä»¶ç‰ˆæœ¬"><a href="#è½¯ä»¶ç‰ˆæœ¬" class="headerlink" title="è½¯ä»¶ç‰ˆæœ¬"></a>è½¯ä»¶ç‰ˆæœ¬</h3><p><strong>æ“ä½œç³»ç»Ÿ</strong></p>
<ul>
<li>Ubuntu 20.04 LTS - 5.4.0-107-generic</li>
</ul>
<p><strong>TLSè¯ä¹¦ç­¾å‘</strong></p>
<ul>
<li>cfssl - v1.6.1</li>
<li>cfssl-certinfo - v1.6.1</li>
<li>cfssljson - v1.6.1</li>
</ul>
<p><strong>é«˜å¯ç”¨è½¯ä»¶</strong></p>
<ul>
<li>ipvsadm - 1:1.31-1</li>
<li>haproxy - 2.0.13-2</li>
<li>keepalived - 1:2.0.19-2</li>
</ul>
<p><strong>ETCDæ•°æ®åº“</strong></p>
<ul>
<li>etcd - v3.5.4</li>
</ul>
<p><strong>å®¹å™¨è¿è¡Œæ—¶</strong></p>
<ul>
<li>containerd.io - 1.6.4</li>
</ul>
<p><strong>Kubernetes</strong></p>
<ul>
<li>kubeadm - v1.23.6</li>
<li>kube-apiserver - v1.23.6</li>
<li>kube-controller-manager - v1.23.6</li>
<li>kubectl - v1.23.6</li>
<li>kubelet - v1.23.6</li>
<li>kube-proxy - v1.23.6</li>
<li>kube-scheduler - v1.23.6</li>
</ul>
<p><strong>ç½‘ç»œæ’ä»¶&amp;è¾…åŠ©è½¯ä»¶</strong><br>calico - v3.22<br>coredns - v1.9.1<br>kubernetes-dashboard - v2.5.1<br>k9s - v0.25.18</p>
<p><br/></p>
<h3 id="ç½‘ç»œè§„åˆ’"><a href="#ç½‘ç»œè§„åˆ’" class="headerlink" title="ç½‘ç»œè§„åˆ’"></a>ç½‘ç»œè§„åˆ’</h3><table>
<thead>
<tr>
<th>å­ç½‘ Subnet</th>
<th>ç½‘æ®µ</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td> nodeSubnet</td>
<td>10.10.107.0/24</td>
<td>C1</td>
</tr>
<tr>
<td> ServiceSubnet</td>
<td>10.96.0.0/16</td>
<td>C2</td>
</tr>
<tr>
<td> PodSubnet</td>
<td>10.128.0.0/16</td>
<td>C3</td>
</tr>
</tbody>
</table>
<p><br/></p>
<p><span style="color:red">æ¸©é¦¨æç¤º: ä¸Šè¿°ç¯å¢ƒæ‰€ä½¿ç”¨çš„åˆ°ç›¸å…³è½¯ä»¶åŠæ’ä»¶æˆ‘å·²æ‰“åŒ…, æ–¹ä¾¿å¤§å®¶è¿›è¡Œä¸‹è½½ï¼Œå¯è®¿é—®å¦‚ä¸‹é“¾æ¥ï¼ˆè®¿é—®å¯†ç è¯·è®¿é—® WeiyiGeek å…¬ä¼—å·å›å¤ã€k8säºŒè¿›åˆ¶ã€‘è·å–ï¼‰ã€‚</span></p>
<p>ä¸‹è½½åœ°å€: <a href="http://share.weiyigeek.top/f/36158960-578443238-a1a5fa" target="_blank" rel="noopener">http://share.weiyigeek.top/f/36158960-578443238-a1a5fa</a> ï¼ˆè®¿é—®å¯†ç ï¼š<a href="https://www.weiyigeek.top/wechat.html?key=k8säºŒè¿›åˆ¶" target="_blank" rel="noopener">ç‚¹å‡»è®¿é—® WeiyiGeek å…¬ä¼—å·å›å¤ã€k8säºŒè¿›åˆ¶ã€‘</a>ï¼‰</p>
<p><a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://blog.weiyigeek.top/img/wechat-search.png" title="WeiyiGeek" data-fancybox="images"><img src="https://blog.weiyigeek.top/img/wechat-search.png" alt="WeiyiGeek"/></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/kubernetes-cluster-binary-install<span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â  â””â”€â”€ calico-v3.22.yaml</span><br><span class="line">â”œâ”€â”€ certificate</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ admin-csr.json</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ apiserver-csr.json</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ca-config.json</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ca-csr.json</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cfssl</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cfssl-certinfo</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cfssljson</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ controller-manager-csr.json</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etcd-csr.json</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kube-scheduler-csr.json</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ proxy-csr.json</span><br><span class="line">â”‚Â Â  â””â”€â”€ scheduler-csr.json</span><br><span class="line">â”œâ”€â”€ containerd.io</span><br><span class="line">â”‚Â Â  â””â”€â”€ config.toml</span><br><span class="line">â”œâ”€â”€ coredns</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coredns.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coredns.yaml.sed</span><br><span class="line">â”‚Â Â  â””â”€â”€ deploy.sh</span><br><span class="line">â”œâ”€â”€ cri-containerd-cni-1.6.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ etcd-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ k9s</span><br><span class="line">â”œâ”€â”€ kubernetes-dashboard</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-dashboard.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ rbac-dashboard-admin.yaml</span><br><span class="line">â”œâ”€â”€ kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">â””â”€â”€ nginx.yaml</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="0x02-å®‰è£…éƒ¨ç½²"><a href="#0x02-å®‰è£…éƒ¨ç½²" class="headerlink" title="0x02 å®‰è£…éƒ¨ç½²"></a>0x02 å®‰è£…éƒ¨ç½²</h2><h3 id="1-åŸºç¡€ä¸»æœºç¯å¢ƒå‡†å¤‡é…ç½®"><a href="#1-åŸºç¡€ä¸»æœºç¯å¢ƒå‡†å¤‡é…ç½®" class="headerlink" title="1.åŸºç¡€ä¸»æœºç¯å¢ƒå‡†å¤‡é…ç½®"></a>1.åŸºç¡€ä¸»æœºç¯å¢ƒå‡†å¤‡é…ç½®</h3><p>æ­¥éª¤ 01.ã€æ‰€æœ‰ä¸»æœºã€‘ä¸»æœºåè®¾ç½®æŒ‰ç…§ä¸Šè¿°ä¸»æœºè§„åˆ’è¿›è¡Œè®¾ç½®ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾‹å¦‚, åœ¨10.10.107.223ä¸»æœºä¸­è¿è¡Œã€‚</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname master-223</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚, åœ¨10.10.107.227ä¸»æœºä¸­è¿è¡Œã€‚</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname node-2</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 02.ã€æ‰€æœ‰ä¸»æœºã€‘å°†è§„åˆ’ä¸­çš„ä¸»æœºåç§°ä¸IPåœ°å€è¿›è¡Œç¡¬è§£æã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo tee -a /etc/hosts &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">10.10.107.223 master-223</span><br><span class="line">10.10.107.224 master-224</span><br><span class="line">10.10.107.225 master-225</span><br><span class="line">10.10.107.226 node-1</span><br><span class="line">10.10.107.227 node-2</span><br><span class="line">10.10.107.222 weiyigeek.cluster.k8s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 03.éªŒè¯æ¯ä¸ªèŠ‚ç‚¹ä¸ŠIPã€MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§,ä¿è¯å…¶èƒ½ç›¸äº’æ­£å¸¸é€šä¿¡<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨å‘½ä»¤ ip link æˆ– ifconfig -a æ¥è·å–ç½‘ç»œæ¥å£çš„ MAC åœ°å€</span></span><br><span class="line">ifconfig -a</span><br><span class="line"><span class="comment"># ä½¿ç”¨å‘½ä»¤ æŸ¥çœ‹ product_uuid æ ¡éªŒ</span></span><br><span class="line">sudo cat /sys/class/dmi/id/product_uuid</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 04.ã€æ‰€æœ‰ä¸»æœºã€‘ç³»ç»Ÿæ—¶é—´åŒæ­¥ä¸æ—¶åŒºè®¾ç½®<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">date -R</span><br><span class="line">sudo ntpdate ntp.aliyun.com</span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line"><span class="comment"># sudo dpkg-reconfigure tzdata</span></span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-local-rtc 0</span><br><span class="line">timedatectl</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 05.ã€æ‰€æœ‰ä¸»æœºã€‘ç¦ç”¨ç³»ç»Ÿäº¤æ¢åˆ†åŒº<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sed -i <span class="string">'s|^/swap.img|#/swap.ing|g'</span> /etc/fstab</span><br><span class="line"><span class="comment"># éªŒè¯äº¤æ¢åˆ†åŒºæ˜¯å¦è¢«ç¦ç”¨</span></span><br><span class="line">free | grep <span class="string">"Swap:"</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 07.ã€æ‰€æœ‰ä¸»æœºã€‘ç³»ç»Ÿå†…æ ¸å‚æ•°è°ƒæ•´<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¦ç”¨ swap åˆ†åŒº</span></span><br><span class="line">egrep -q <span class="string">"^(#)?vm.swappiness.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?vm.swappiness.*|vm.swappiness = 0|g"</span>  /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"vm.swappiness = 0"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="comment"># å…è®¸è½¬å‘</span></span><br><span class="line">egrep -q <span class="string">"^(#)?net.ipv4.ip_forward.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?net.ipv4.ip_forward.*|net.ipv4.ip_forward = 1|g"</span>  /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"net.ipv4.ip_forward = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># - å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡</span></span><br><span class="line">egrep -q <span class="string">"^(#)?net.bridge.bridge-nf-call-iptables.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?net.bridge.bridge-nf-call-iptables.*|net.bridge.bridge-nf-call-iptables = 1|g"</span> /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-iptables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">egrep -q <span class="string">"^(#)?net.bridge.bridge-nf-call-ip6tables.*"</span> /etc/sysctl.conf &amp;&amp; sed -ri <span class="string">"s|^(#)?net.bridge.bridge-nf-call-ip6tables.*|net.bridge.bridge-nf-call-ip6tables = 1|g"</span> /etc/sysctl.conf || <span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-ip6tables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 07.ã€æ‰€æœ‰ä¸»æœºã€‘ç¦ç”¨ç³»ç»Ÿé˜²ç«å¢™<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw <span class="built_in">disable</span> &amp;&amp; systemctl <span class="built_in">disable</span> ufw &amp;&amp; systemctl stop ufw</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 08.ã€master-225 ä¸»æœºã€‘ä½¿ç”¨ master-225 ä¸»æœºçš„å…¬é’¥å…è´¦å·å¯†ç ç™»é™†å…¶å®ƒä¸»æœºï¼ˆå¯é€‰ï¼‰æ–¹ä¾¿æ–‡ä»¶åœ¨å„ä¸»æœºä¸Šä¼ ä¸‹è½½ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆed25519æ ¼å¼çš„å…¬å¯†é’¥</span></span><br><span class="line">sh-keygen -t ed25519</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚,åœ¨master-225 ä¸»æœºä¸Šä½¿ç”¨å¯†é’¥ç™»å½•åˆ° master-223 è®¾ç½® (å…¶å®ƒä¸»æœºåŒæ ·)</span></span><br><span class="line">ssh-copy-id -p 20211 weiyigeek@10.10.107.223</span><br><span class="line">  <span class="comment"># /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_ed25519.pub"</span></span><br><span class="line">  <span class="comment"># Are you sure you want to continue connecting (yes/no/[fingerprint])? yes # è¾“å…¥yes</span></span><br><span class="line">  <span class="comment"># weiyigeek@10.10.107.223s password: # è¾“å…¥ä¸»æœºå¯†ç </span></span><br><span class="line">  <span class="comment"># Number of key(s) added: 1</span></span><br><span class="line">  <span class="comment"># Now try logging into the machine, with:   "ssh -p '20211' 'weiyigeek@10.10.107.223'"</span></span><br><span class="line">  <span class="comment"># and check to make sure that only the key(s) you wanted were added.</span></span><br><span class="line">ssh-copy-id -p 20211 weiyigeek@10.10.107.224</span><br><span class="line">ssh-copy-id -p 20211 weiyigeek@10.10.107.226</span><br><span class="line">ssh-copy-id -p 20211 weiyigeek@10.10.107.227</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h3 id="2-è´Ÿè½½å‡è¡¡ç®¡ç†å·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½"><a href="#2-è´Ÿè½½å‡è¡¡ç®¡ç†å·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½" class="headerlink" title="2.è´Ÿè½½å‡è¡¡ç®¡ç†å·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½"></a>2.è´Ÿè½½å‡è¡¡ç®¡ç†å·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½</h3><p>æ­¥éª¤ 01.å®‰è£…ipvsæ¨¡å—ä»¥åŠè´Ÿè½½å‡è¡¡ç›¸å…³ä¾èµ–ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison ipvsadm</span><br><span class="line">  <span class="comment"># ipvsadm |   1:1.31-1 | http://mirrors.aliyun.com/ubuntu focal/main amd64 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo apt -y install ipvsadm ipset sysstat conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬ </span></span><br><span class="line">apt-mark hold ipvsadm</span><br><span class="line">  <span class="comment"># ipvsadm set on hold.</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.å°†æ¨¡å—åŠ è½½åˆ°å†…æ ¸ä¸­(å¼€æœºè‡ªåŠ¨è®¾ç½®-éœ€è¦é‡å¯æœºå™¨ç”Ÿæ•ˆ)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/modules-load.d/k8s.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># netfilter</span></span><br><span class="line">br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># containerd</span></span><br><span class="line">overlay</span><br><span class="line"></span><br><span class="line"><span class="comment"># nf_conntrack</span></span><br><span class="line">nf_conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment"># ipvs</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">xt_set</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.æ‰‹åŠ¨åŠ è½½æ¨¡å—åˆ°å†…æ ¸ä¸­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /etc/modules.d/</span><br><span class="line">tee /etc/modules.d/k8s.modules &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># netfilter æ¨¡å— å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡</span></span><br><span class="line">modprobe -- br_netfilter</span><br><span class="line"><span class="comment"># containerd</span></span><br><span class="line">modprobe -- overlay</span><br><span class="line"><span class="comment"># nf_conntrack</span></span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line"><span class="comment"># ipvs</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_lc</span><br><span class="line">modprobe -- ip_vs_lblc</span><br><span class="line">modprobe -- ip_vs_lblcr</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- ip_vs_dh</span><br><span class="line">modprobe -- ip_vs_fo</span><br><span class="line">modprobe -- ip_vs_nq</span><br><span class="line">modprobe -- ip_vs_sed</span><br><span class="line">modprobe -- ip_vs_ftp</span><br><span class="line">modprobe -- ip_tables</span><br><span class="line">modprobe -- ip_set</span><br><span class="line">modprobe -- ipt_set</span><br><span class="line">modprobe -- ipt_rpfilter</span><br><span class="line">modprobe -- ipt_REJECT</span><br><span class="line">modprobe -- ipip</span><br><span class="line">modprobe -- xt_set</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/modules.d/k8s.modules &amp;&amp; bash /etc/modules.d/k8s.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">  <span class="comment"># ip_vs_sh               16384  0</span></span><br><span class="line">  <span class="comment"># ip_vs_wrr              16384  0</span></span><br><span class="line">  <span class="comment"># ip_vs_rr               16384  0</span></span><br><span class="line">  <span class="comment"># ip_vs                 155648  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span></span><br><span class="line">  <span class="comment"># nf_conntrack          139264  1 ip_vs</span></span><br><span class="line">  <span class="comment"># nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span></span><br><span class="line">  <span class="comment"># nf_defrag_ipv4         16384  1 nf_conntrack</span></span><br><span class="line">  <span class="comment"># libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span></span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: åœ¨ kernel 4.19 ç‰ˆæœ¬åŠä»¥ä¸Šå°†ä½¿ç”¨ nf_conntrack æ¨¡å—, åˆ™åœ¨ 4.18 ç‰ˆæœ¬ä»¥ä¸‹åˆ™éœ€ä½¿ç”¨nf_conntrack_ipv4 æ¨¡å—ã€‚</p>
<p><br></p>
<h3 id="3-é«˜å¯ç”¨HAproxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®"><a href="#3-é«˜å¯ç”¨HAproxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®" class="headerlink" title="3.é«˜å¯ç”¨HAproxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®"></a>3.é«˜å¯ç”¨HAproxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®</h3><p>æè¿°: ç”±äºæ˜¯æµ‹è¯•å­¦ä¹ ç¯å¢ƒ, æ­¤å¤„æˆ‘æœªä¸“é—¨å‡†å¤‡ä¸¤å°HAæœåŠ¡å™¨, è€Œæ˜¯ç›´æ¥é‡‡ç”¨masterèŠ‚ç‚¹æœºå™¨ï¼Œå¦‚æœæ˜¯æ­£å¼ç¯å¢ƒå»ºè®®ç‹¬ç«‹å‡ºæ¥ã€‚</p>
<p>æ­¥éª¤ 01.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘å®‰è£…ä¸‹è½½ haproxy (HAä»£ç†å¥åº·æ£€æµ‹) ä¸ keepalived (è™šæ‹Ÿè·¯ç”±åè®®-ä¸»ä»)ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison haproxy keepalived</span><br><span class="line">  <span class="comment">#  haproxy | 2.0.13-2ubuntu0.5 | http://mirrors.aliyun.com/ubuntu focal-security/main amd64 Packages</span></span><br><span class="line">  <span class="comment"># keepalived | 1:2.0.19-2ubuntu0.2 | http://mirrors.aliyun.com/ubuntu focal-updates/main amd64 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo apt -y install haproxy keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬ </span></span><br><span class="line">apt-mark hold haproxy keepalived</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 02.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘è¿›è¡Œ HAProxy é…ç½®ï¼Œå…¶é…ç½®ç›®å½•ä¸º <code>/etc/haproxy/</code>ï¼Œæ‰€æœ‰èŠ‚ç‚¹é…ç½®æ˜¯ä¸€è‡´çš„ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/haproxy/haproxy.cfg&#123;,.bak&#125;</span><br><span class="line">tee /etc/haproxy/haproxy.cfg&lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">global</span><br><span class="line">  user haproxy</span><br><span class="line">  group haproxy</span><br><span class="line">  maxconn 2000</span><br><span class="line">  daemon</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span> local0</span><br><span class="line">  <span class="built_in">log</span> /dev/<span class="built_in">log</span> local1 err</span><br><span class="line">  chroot /var/lib/haproxy</span><br><span class="line">  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br><span class="line">  stats timeout 30s</span><br><span class="line">  <span class="comment"># Default SSL material locations</span></span><br><span class="line">  ca-base /etc/ssl/certs</span><br><span class="line">  crt-base /etc/ssl/private</span><br><span class="line">  <span class="comment"># See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.0.3&amp;config=intermediate</span></span><br><span class="line">  ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><br><span class="line">  ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256</span><br><span class="line">  ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  <span class="built_in">log</span>     global</span><br><span class="line">  mode    http</span><br><span class="line">  option  httplog</span><br><span class="line">  option  dontlognull</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  timeout http-request 15s</span><br><span class="line">  timeout http-keep-alive 15s</span><br><span class="line">  <span class="comment"># errorfile 400 /etc/haproxy/errors/400.http</span></span><br><span class="line">  <span class="comment"># errorfile 403 /etc/haproxy/errors/403.http</span></span><br><span class="line">  <span class="comment"># errorfile 408 /etc/haproxy/errors/408.http</span></span><br><span class="line">  <span class="comment"># errorfile 500 /etc/haproxy/errors/500.http</span></span><br><span class="line">  <span class="comment"># errorfile 502 /etc/haproxy/errors/502.http</span></span><br><span class="line">  <span class="comment"># errorfile 503 /etc/haproxy/errors/503.http</span></span><br><span class="line">  <span class="comment"># errorfile 504 /etc/haproxy/errors/504.http</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: ç®¡ç†HAproxy (å¯é€‰)</span></span><br><span class="line"><span class="comment"># frontend monitor-in</span></span><br><span class="line"><span class="comment">#   bind *:33305</span></span><br><span class="line"><span class="comment">#   mode http</span></span><br><span class="line"><span class="comment">#   option httplog</span></span><br><span class="line"><span class="comment">#   monitor-uri /monitor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: åŸºäºå››å±‚ä»£ç†, 1644 3ä¸ºVIPçš„ ApiServer æ§åˆ¶å¹³é¢ç«¯å£, ç”±äºæ˜¯ä¸masterèŠ‚ç‚¹åœ¨ä¸€èµ·æ‰€ä»¥ä¸èƒ½ä½¿ç”¨6443ç«¯å£.</span></span><br><span class="line">frontend k8s-master</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:16443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:16443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„: Master èŠ‚ç‚¹çš„é»˜è®¤ Apiserver æ˜¯6443ç«¯å£</span></span><br><span class="line">backend k8s-master</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server master-223 10.10.107.223:6443 check</span><br><span class="line">  server master-224 10.10.107.224:6443 check</span><br><span class="line">  server master-225 10.10.107.225:6443 check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘è¿›è¡Œ ç½®KeepAlived é…ç½® ï¼Œå…¶é…ç½®ç›®å½•ä¸º <code>/etc/haproxy/</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºé…ç½®ç›®å½•ï¼Œåˆ†åˆ«åœ¨å„ä¸ªmasterèŠ‚ç‚¹æ‰§è¡Œã€‚</span></span><br><span class="line">mkdir -vp /etc/keepalived</span><br><span class="line"><span class="comment"># __ROLE__ è§’è‰²: MASTER æˆ–è€… BACKUP</span></span><br><span class="line"><span class="comment"># __NETINTERFACE__ å®¿ä¸»æœºç‰©ç†ç½‘å¡åç§° ä¾‹å¦‚æˆ‘çš„ens32</span></span><br><span class="line"><span class="comment"># __IP__ å®¿ä¸»æœºç‰©ç†IPåœ°å€</span></span><br><span class="line"><span class="comment"># __VIP__ è™šæ‹ŸVIPåœ°å€</span></span><br><span class="line">sudo tee /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">script_user root</span><br><span class="line">  enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">  script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">  interval 5</span><br><span class="line">  weight -5</span><br><span class="line">  fall 2  </span><br><span class="line">  rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">  state __ROLE__</span><br><span class="line">  interface __NETINTERFACE__</span><br><span class="line">  mcast_src_ip __IP__</span><br><span class="line">  virtual_router_id 51</span><br><span class="line">  priority 101</span><br><span class="line">  advert_int 2</span><br><span class="line">  authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass K8SHA_KA_AUTH</span><br><span class="line">  &#125;</span><br><span class="line">  virtual_ipaddress &#123;</span><br><span class="line">    __VIP__</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># HA å¥åº·æ£€æŸ¥</span></span><br><span class="line">  <span class="comment"># track_script &#123;</span></span><br><span class="line">  <span class="comment">#   chk_apiserver</span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤å¤„ master-225 æ€§èƒ½è¾ƒå¥½æ‰€ä»¥é…ç½®ä¸ºMaster (master-225 ä¸»æœºä¸Šæ‰§è¡Œ)</span></span><br><span class="line"><span class="comment"># master-225 10.10.107.225 =&gt; MASTER</span></span><br><span class="line">sed -i -e <span class="string">'s#__ROLE__#MASTER#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__NETINTERFACE__#ens32#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__IP__#10.10.107.225#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__VIP__#10.10.107.222#g'</span> /etc/keepalived/keepalived.conf </span><br><span class="line"></span><br><span class="line"><span class="comment"># master-224 10.10.107.224 =&gt; BACKUP  (master-224 ä¸»æœºä¸Šæ‰§è¡Œ)</span></span><br><span class="line">sed -i -e <span class="string">'s#__ROLE__#BACKUP#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__NETINTERFACE__#ens32#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__IP__#10.10.107.224#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__VIP__#10.10.107.222#g'</span> /etc/keepalived/keepalived.conf </span><br><span class="line"></span><br><span class="line"><span class="comment"># master-223 10.10.107.223 =&gt; BACKUP  (master-223 ä¸»æœºä¸Šæ‰§è¡Œ)</span></span><br><span class="line">sed -i -e <span class="string">'s#__ROLE__#BACKUP#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__NETINTERFACE__#ens32#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__IP__#10.10.107.223#g'</span> \</span><br><span class="line">  -e <span class="string">'s#__VIP__#10.10.107.222#g'</span> /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: æ³¨æ„ä¸Šè¿°çš„å¥åº·æ£€æŸ¥æ˜¯å…³é—­æ³¨é‡Šäº†çš„ï¼Œä½ éœ€è¦å°†K8Sé›†ç¾¤å»ºç«‹å®Œæˆåå†å¼€å¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">track_script &#123;</span><br><span class="line">  chk_apiserver</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 04.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘è¿›è¡Œé…ç½® KeepAlived å¥åº·æ£€æŸ¥æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sudo tee /etc/keepalived/check_apiserver.sh &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(seq 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  check_code=$(pgrep haproxy)</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line">    err=$(expr <span class="variable">$err</span> + 1)</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    err=0</span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">"0"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"systemctl stop keepalived"</span></span><br><span class="line">  /usr/bin/systemctl stop keepalived</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line">sudo chmod +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 05.ã€MasterèŠ‚ç‚¹æœºå™¨ã€‘å¯åŠ¨ haproxy ã€keepalived ç›¸å…³æœåŠ¡åŠæµ‹è¯•VIPæ¼‚ç§»ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡è½½ Systemd è®¾ç½® haproxy ã€keepalived å¼€æœºè‡ªå¯ä»¥åŠç«‹å³å¯åŠ¨</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now haproxy &amp;&amp; sudo systemctl <span class="built_in">enable</span> --now keepalived</span><br><span class="line"><span class="comment"># Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.</span></span><br><span class="line"><span class="comment"># Executing: /lib/systemd/systemd-sysv-install enable haproxy</span></span><br><span class="line"><span class="comment"># Synchronizing state of keepalived.service with SysV service script with /lib/systemd/systemd-sysv-install.</span></span><br><span class="line"><span class="comment"># Executing: /lib/systemd/systemd-sysv-install enable keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ master-223 ä¸»æœºä¸­å‘ç°vipåœ°å€åœ¨å…¶ä¸»æœºä¸Šã€‚</span></span><br><span class="line">root@master-223:~$ ip addr</span><br><span class="line">  <span class="comment"># 2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/ether 00:0c:29:00:0f:8f brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 10.10.107.223/24 brd 10.10.107.255 scope global ens32</span></span><br><span class="line">  <span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet 10.10.107.222/32 scope global ens32</span></span><br><span class="line">  <span class="comment">#        valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="comment"># å…¶å®ƒä¸¤å°ä¸»æœºä¸Šé€šä¿¡éªŒè¯ã€‚</span></span><br><span class="line">root@master-224:~$ ping 10.10.107.222</span><br><span class="line">root@master-224:~$ ping 10.10.107.222</span><br></pre></td></tr></table></figure><br><figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220427150914.png" target="_blank" title="WeiyiGeek.master-223-vip" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220427150914.png" alt="WeiyiGeek.master-223-vip" title="" class=""></a>
                <p>WeiyiGeek.master-223-vip</p>
            </figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰‹åŠ¨éªŒè¯VIPæ¼‚ç§»,æˆ‘ä»¬å°†è¯¥æœåŠ¡å™¨ä¸Škeepalivedåœæ­¢æ‰ã€‚</span></span><br><span class="line">root@master-223:~$ pgrep haproxy</span><br><span class="line">  <span class="comment"># 6320</span></span><br><span class="line">  <span class="comment"># 6321</span></span><br><span class="line">root@master-223:~$ /usr/bin/systemctl stop keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶,å‘ç°VIPå·²ç»é£˜åˆ°master-225ä¸»æœºä¸­</span></span><br><span class="line">root@master-225:~$ ip addr show ens32</span><br><span class="line">  <span class="comment"># 2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/ether 00:0c:29:93:28:61 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 10.10.107.225/24 brd 10.10.107.255 scope global ens32</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br><span class="line">  <span class="comment">#     inet 10.10.107.222/32 scope global ens32</span></span><br><span class="line">  <span class="comment">#       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼ŒHAProxy ä¸ Keepalived é…ç½®å°±å‘Šä¸€æ®µè½äº†,ä¸‹é¢å°†å­¦ä¹  ETCD é›†ç¾¤é…ç½®ä¸è¯ä¹¦ç­¾å‘ã€‚</p>
<p><br></p>
<h3 id="4-é…ç½®éƒ¨ç½²etcdé›†ç¾¤ä¸etcdè¯ä¹¦ç­¾å‘"><a href="#4-é…ç½®éƒ¨ç½²etcdé›†ç¾¤ä¸etcdè¯ä¹¦ç­¾å‘" class="headerlink" title="4.é…ç½®éƒ¨ç½²etcdé›†ç¾¤ä¸etcdè¯ä¹¦ç­¾å‘"></a>4.é…ç½®éƒ¨ç½²etcdé›†ç¾¤ä¸etcdè¯ä¹¦ç­¾å‘</h3><p>æè¿°: åˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„ETCDé›†ç¾¤ï¼Œæ­¤å¤„æˆ‘ä»¬åœ¨ã€master-225ã€‘æœºå™¨ä¸­æ“ä½œã€‚</p>
<p>æ­¥éª¤ 01.ã€master-225ã€‘åˆ›å»ºä¸€ä¸ªé…ç½®ä¸ç›¸å…³æ–‡ä»¶å­˜æ”¾çš„ç›®å½•, ä»¥åŠä¸‹è½½è·å–cfsslå·¥å…·è¿›è¡ŒCAè¯ä¹¦åˆ¶ä½œä¸ç­¾å‘(cfsslå·¥å…·å¾€æœŸæ–‡ç« å‚è€ƒåœ°å€: <a href="https://blog.weiyigeek.top/2019/10-21-12.html#3-CFSSL-ç”Ÿæˆ">https://blog.weiyigeek.top/2019/10-21-12.html#3-CFSSL-ç”Ÿæˆ</a> )ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å·¥ä½œç›®å½•åˆ›å»º</span></span><br><span class="line">mkdir -vp /app/k8s-init-work &amp;&amp; <span class="built_in">cd</span> /app/k8s-init-work</span><br><span class="line"></span><br><span class="line"><span class="comment"># cfssl æœ€æ–°ä¸‹è½½åœ°å€: https://github.com/cloudflare/cfssl/releases</span></span><br><span class="line"><span class="comment"># cfssl ç›¸å…³å·¥å…·æ‹‰å– (å¦‚æœæ‹‰å–è¾ƒæ…¢ï¼Œå»ºè®®ä½¿ç”¨æŸé›·ä¸‹è½½ï¼Œç„¶åä¸Šä¼ åˆ°æœåŠ¡å™¨é‡Œ)</span></span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64 -o /usr/<span class="built_in">local</span>/bin/cfssl</span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64 -o /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64 -o /usr/<span class="built_in">local</span>/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># èµ‹äºˆæ‰§è¡Œæƒé™</span></span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/cfssl*</span><br><span class="line"></span><br><span class="line">/app<span class="comment"># cfssl version</span></span><br><span class="line"><span class="comment"># Version: 1.2.0</span></span><br><span class="line"><span class="comment"># Revision: dev</span></span><br><span class="line"><span class="comment"># Runtime: go1.6</span></span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: </p>
<ul>
<li>cfssl : CFSSL å‘½ä»¤è¡Œå·¥å…·</li>
<li>cfssljson : ç”¨äºä»cfsslç¨‹åºä¸­è·å–JSONè¾“å‡ºå¹¶å°†è¯ä¹¦ã€å¯†é’¥ã€è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶CSRå’ŒBundleå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œ</li>
</ul>
<p><br></p>
<p>æ­¥éª¤ 02.åˆ©ç”¨ä¸Šè¿° cfssl å·¥å…·åˆ›å»º CA è¯ä¹¦ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># - CA è¯ä¹¦ç­¾åè¯·æ±‚é…ç½®æ–‡ä»¶</span></span><br><span class="line">fssl <span class="built_in">print</span>-defaults csr &gt; ca-csr.json</span><br><span class="line">tee ca-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">    <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®å‚æ•°è§£æ:</span></span><br><span class="line">CN: Common Nameï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼Œä¸€èˆ¬å†™çš„æ˜¯åŸŸåï¼Œéå¸¸é‡è¦ã€‚æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•</span><br><span class="line">keyï¼šç”Ÿæˆè¯ä¹¦çš„ç®—æ³•</span><br><span class="line">hostsï¼šè¡¨ç¤ºå“ªäº›ä¸»æœºå(åŸŸå)æˆ–è€…IPå¯ä»¥ä½¿ç”¨æ­¤csrç”³è¯·çš„è¯ä¹¦ï¼Œä¸ºç©ºæˆ–è€…<span class="string">""</span>è¡¨ç¤ºæ‰€æœ‰çš„éƒ½å¯ä»¥ä½¿ç”¨(æœ¬ä¾‹ä¸­æ²¡æœ‰`<span class="string">"hosts"</span>: [<span class="string">""</span>]`å­—æ®µ)</span><br><span class="line">namesï¼šå¸¸è§å±æ€§è®¾ç½®</span><br><span class="line">  * C: Countryï¼Œ å›½å®¶</span><br><span class="line">  * ST: Stateï¼Œå·æˆ–è€…æ˜¯çœä»½</span><br><span class="line">  * L: Locality Nameï¼Œåœ°åŒºï¼ŒåŸå¸‚</span><br><span class="line">  * O: Organization Nameï¼Œç»„ç»‡åç§°ï¼Œå…¬å¸åç§°(åœ¨k8sä¸­å¸¸ç”¨äºæŒ‡å®šGroupï¼Œè¿›è¡ŒRBACç»‘å®š)</span><br><span class="line">  * OU: Organization Unit Nameï¼Œç»„ç»‡å•ä½åç§°ï¼Œå…¬å¸éƒ¨é—¨</span><br><span class="line"></span><br><span class="line"><span class="comment"># - CA è¯ä¹¦ç­–ç•¥é…ç½®æ–‡ä»¶</span></span><br><span class="line">cfssl <span class="built_in">print</span>-defaults config &gt; ca-config.json</span><br><span class="line">tee ca-config.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"etcd"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®å‚æ•°è§£æ:</span></span><br><span class="line">default é»˜è®¤ç­–ç•¥ï¼ŒæŒ‡å®šäº†è¯ä¹¦çš„é»˜è®¤æœ‰æ•ˆæœŸæ˜¯10å¹´(87600h)</span><br><span class="line">profile è‡ªå®šä¹‰ç­–ç•¥é…ç½®</span><br><span class="line">  * kubernetesï¼šè¡¨ç¤ºè¯¥é…ç½®(profile)çš„ç”¨é€”æ˜¯ä¸ºkubernetesç”Ÿæˆè¯ä¹¦åŠç›¸å…³çš„æ ¡éªŒå·¥ä½œ</span><br><span class="line">  * signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼›ç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUE</span><br><span class="line">  * server authï¼šè¡¨ç¤ºå¯ä»¥è¯¥CA å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯</span><br><span class="line">  * client authï¼šè¡¨ç¤ºå¯ä»¥ç”¨è¯¥ CA å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯</span><br><span class="line">  * expiryï¼šä¹Ÿè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå¦‚æœä¸å†™ä»¥defaultä¸­çš„ä¸ºå‡†</span><br><span class="line"></span><br><span class="line"><span class="comment"># - æ‰§è¡Œcfssl gencert å‘½ä»¤ç”ŸæˆCAè¯ä¹¦</span></span><br><span class="line"><span class="comment"># åˆ©ç”¨CAè¯ä¹¦ç­¾åè¯·æ±‚é…ç½®æ–‡ä»¶ ca-csr.json ç”ŸæˆCAè¯ä¹¦å’ŒCAç§é’¥å’ŒCSR(è¯ä¹¦ç­¾åè¯·æ±‚):</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">  <span class="comment"># 2022/04/27 16:49:37 [INFO] generating a new CA key and certificate from CSR</span></span><br><span class="line">  <span class="comment"># 2022/04/27 16:49:37 [INFO] generate received request</span></span><br><span class="line">  <span class="comment"># 2022/04/27 16:49:37 [INFO] received CSR</span></span><br><span class="line">  <span class="comment"># 2022/04/27 16:49:37 [INFO] generating key: rsa-2048</span></span><br><span class="line">  <span class="comment"># 2022/04/27 16:49:37 [INFO] encoded CSR</span></span><br><span class="line">  <span class="comment"># 2022/04/27 16:49:37 [INFO] signed certificate with serial number 245643466964695827922023924375276493244980966303</span></span><br><span class="line">$ ls</span><br><span class="line">  <span class="comment"># ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span></span><br><span class="line">$ openssl x509 -<span class="keyword">in</span> ca.pem -text -noout | grep <span class="string">"Not"</span></span><br><span class="line">  <span class="comment"># Not Before: Apr 27 08:45:00 2022 GMT</span></span><br><span class="line">  <span class="comment"># Not After : Apr 24 08:45:00 2032 GMT</span></span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: å¦‚æœå°† expiry è®¾ç½®ä¸º87600h è¡¨ç¤ºè¯ä¹¦è¿‡æœŸæ—¶é—´ä¸ºåå¹´ã€‚</p>
<p><br></p>
<p>æ­¥éª¤ 03.é…ç½®ETCDè¯ä¹¦ç›¸å…³æ–‡ä»¶ä»¥åŠç”Ÿæˆå…¶è¯ä¹¦,<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># etcd è¯ä¹¦è¯·æ±‚æ–‡ä»¶</span></span><br><span class="line">tee etcd-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"10.10.107.223"</span>,</span><br><span class="line">    <span class="string">"10.10.107.224"</span>,</span><br><span class="line">    <span class="string">"10.10.107.225"</span>,</span><br><span class="line">    <span class="string">"etcd1"</span>,</span><br><span class="line">    <span class="string">"etcd2"</span>,</span><br><span class="line">    <span class="string">"etcd3"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨caè¯ä¹¦ç­¾å‘ç”Ÿæˆetcdè¯ä¹¦</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line">$ ls etcd*</span><br><span class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem</span><br><span class="line">$ openssl x509 -<span class="keyword">in</span> etcd.pem -text -noout | grep  <span class="string">"X509v3 Subject Alternative Name"</span> -A 1</span><br><span class="line">  <span class="comment"># X509v3 Subject Alternative Name:</span></span><br><span class="line">  <span class="comment">#   DNS:etcd1, DNS:etcd2, DNS:etcd3, IP Address:127.0.0.1, IP Address:10.10.107.223, IP Address:10.10.107.224, IP Address:10.10.107.225</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 04.ã€æ‰€æœ‰MasterèŠ‚ç‚¹ä¸»æœºã€‘ä¸‹è½½éƒ¨ç½²ETCDé›†ç¾¤, é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸‹è½½etcdè½¯ä»¶åŒ…, å¯ä»¥ Github release æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬çš„etcdä¸‹è½½è·¯å¾„(<a href="https://github.com/etcd-io/etcd/releases/)ã€‚" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases/)ã€‚</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">wget -L https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf etcd-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">cp -a etcd* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç‰ˆæœ¬ </span></span><br><span class="line">etcd --version</span><br><span class="line">  <span class="comment"># etcd Version: 3.5.4</span></span><br><span class="line">  <span class="comment"># Git SHA: 08407ff76</span></span><br><span class="line">  <span class="comment"># Go Version: go1.16.15</span></span><br><span class="line">  <span class="comment"># Go OS/Arch: linux/amd64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åˆ°å…¶å®ƒmasterä¸»æœºä¸Š</span></span><br><span class="line">scp -P 20211 ./etcd-v3.5.4-linux-amd64.tar.gz weiyigeek@master-223:~</span><br><span class="line">scp -P 20211 ./etcd-v3.5.4-linux-amd64.tar.gz weiyigeek@master-224:~</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†åˆ«åœ¨master-223ä¸master-224æ‰§è¡Œ, è§£å‹åˆ° /usr/local/ ç›®å½•åŒæ ·å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ° /usr/local/bin/</span></span><br><span class="line">tar -zxvf /home/weiyigeek/etcd-v3.5.4-linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">cp -a /usr/<span class="built_in">local</span>/etcd-v3.5.4-linux-amd64/etcd* /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: etcd å®˜ç½‘åœ°å€ ( <a href="https://etcd.io/" target="_blank" rel="noopener">https://etcd.io/</a>)</p>
<p><br></p>
<p>æ­¥éª¤ 05.åˆ›å»ºetcdé›†ç¾¤æ‰€éœ€çš„é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯ä¹¦å‡†å¤‡</span></span><br><span class="line">mkdir -vp /etc/etcd/pki/</span><br><span class="line">cp *.pem /etc/etcd/pki/</span><br><span class="line">ls /etc/etcd/pki/</span><br><span class="line">  <span class="comment"># ca-key.pem  ca.pem  etcd-key.pem  etcd.pem</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šä¼ åˆ°~å®¶ç›®å½•,å¹¶éœ€è¦å°†å…¶å¤åˆ¶åˆ° /etc/etcd/pki/ ç›®å½•ä¸­</span></span><br><span class="line">scp -P 20211 *.pem weiyigeek@master-224:~</span><br><span class="line">scp -P 20211 *.pem weiyigeek@master-223:~</span><br><span class="line">  <span class="comment"># ****************** [ å®‰å…¨ç™»é™† (Security Login) ] *****************</span></span><br><span class="line">  <span class="comment"># Authorized only. All activity will be monitored and reported.By Security Center.</span></span><br><span class="line">  <span class="comment"># ca-key.pem             100% 1675     3.5MB/s   00:00</span></span><br><span class="line">  <span class="comment"># ca.pem                 100% 1375     5.2MB/s   00:00</span></span><br><span class="line">  <span class="comment"># etcd-key.pem           100% 1679     7.0MB/s   00:00</span></span><br><span class="line">  <span class="comment"># etcd.pem               100% 1399     5.8MB/s   00:00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># master-225 æ‰§è¡Œ</span></span><br><span class="line">tee /etc/etcd/etcd.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># [æˆå‘˜é…ç½®]</span></span><br><span class="line"><span class="comment"># member åç§°</span></span><br><span class="line">ETCD_NAME=etcd1</span><br><span class="line"><span class="comment"># å­˜å‚¨æ•°æ®çš„ç›®å½•(æ³¨æ„éœ€è¦å»ºç«‹)</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/data"</span></span><br><span class="line"><span class="comment"># ç”¨äºç›‘å¬å®¢æˆ·ç«¯etcdctlæˆ–è€…curlè¿æ¥</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://10.10.107.225:2379,https://127.0.0.1:2379"</span></span><br><span class="line"><span class="comment"># ç”¨äºç›‘å¬é›†ç¾¤ä¸­å…¶å®ƒmemberçš„è¿æ¥</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://10.10.107.225:2380"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [è¯ä¹¦é…ç½®]</span></span><br><span class="line"><span class="comment"># ETCD_CERT_FILE=/etc/etcd/pki/etcd.pem</span></span><br><span class="line"><span class="comment"># ETCD_KEY_FILE=/etc/etcd/pki/etcd-key.pem</span></span><br><span class="line"><span class="comment"># ETCD_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.pem</span></span><br><span class="line"><span class="comment"># ETCD_CLIENT_CERT_AUTH=true</span></span><br><span class="line"><span class="comment"># ETCD_PEER_CLIENT_CERT_AUTH=true</span></span><br><span class="line"><span class="comment"># ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd.pem</span></span><br><span class="line"><span class="comment"># ETCD_PEER_KEY_FILE=/etc/etcd/pki/etcd-key.pem</span></span><br><span class="line"><span class="comment"># ETCD_PEER_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.pem</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [é›†ç¾¤é…ç½®]</span></span><br><span class="line"><span class="comment"># æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ­¤IPsä¸é›†ç¾¤é€šä¿¡;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://10.10.107.225:2379"</span></span><br><span class="line"><span class="comment"># æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥é›†ç¾¤memberä¸memberé€šä¿¡</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://10.10.107.225:2380"</span></span><br><span class="line"><span class="comment"># æè¿°é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæœ¬memberæ ¹æ®æ­¤ä¿¡æ¯å»è”ç³»å…¶ä»–member</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://10.10.107.225:2380,etcd2=https://10.10.107.224:2380,etcd3=https://10.10.107.223:2380"</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çŠ¶æ€æ–°å»ºé›†ç¾¤æ—¶å€™è®¾ç½®ä¸ºnew,è‹¥æ˜¯æƒ³åŠ å…¥æŸä¸ªå·²ç»å­˜åœ¨çš„é›†ç¾¤è®¾ç½®ä¸ºexisting</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># master-224 æ‰§è¡Œ</span></span><br><span class="line">tee /etc/etcd/etcd.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># [æˆå‘˜é…ç½®]</span></span><br><span class="line"><span class="comment"># member åç§°</span></span><br><span class="line">ETCD_NAME=etcd2</span><br><span class="line"><span class="comment"># å­˜å‚¨æ•°æ®çš„ç›®å½•(æ³¨æ„éœ€è¦å»ºç«‹)</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/data"</span></span><br><span class="line"><span class="comment"># ç”¨äºç›‘å¬å®¢æˆ·ç«¯etcdctlæˆ–è€…curlè¿æ¥</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://10.10.107.224:2379,https://127.0.0.1:2379"</span></span><br><span class="line"><span class="comment"># ç”¨äºç›‘å¬é›†ç¾¤ä¸­å…¶å®ƒmemberçš„è¿æ¥</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://10.10.107.224:2380"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [é›†ç¾¤é…ç½®]</span></span><br><span class="line"><span class="comment"># æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ­¤IPsä¸é›†ç¾¤é€šä¿¡;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://10.10.107.224:2379"</span></span><br><span class="line"><span class="comment"># æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥é›†ç¾¤memberä¸memberé€šä¿¡</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://10.10.107.224:2380"</span></span><br><span class="line"><span class="comment"># æè¿°é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæœ¬memberæ ¹æ®æ­¤ä¿¡æ¯å»è”ç³»å…¶ä»–member</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://10.10.107.225:2380,etcd2=https://10.10.107.224:2380,etcd3=https://10.10.107.223:2380"</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çŠ¶æ€æ–°å»ºé›†ç¾¤æ—¶å€™è®¾ç½®ä¸ºnew,è‹¥æ˜¯æƒ³åŠ å…¥æŸä¸ªå·²ç»å­˜åœ¨çš„é›†ç¾¤è®¾ç½®ä¸ºexisting</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># master-223 æ‰§è¡Œ</span></span><br><span class="line">tee /etc/etcd/etcd.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># [æˆå‘˜é…ç½®]</span></span><br><span class="line"><span class="comment"># member åç§°</span></span><br><span class="line">ETCD_NAME=etcd3</span><br><span class="line"><span class="comment"># å­˜å‚¨æ•°æ®çš„ç›®å½•(æ³¨æ„éœ€è¦å»ºç«‹)</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/data"</span></span><br><span class="line"><span class="comment"># ç”¨äºç›‘å¬å®¢æˆ·ç«¯etcdctlæˆ–è€…curlè¿æ¥</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://10.10.107.223:2379,https://127.0.0.1:2379"</span></span><br><span class="line"><span class="comment"># ç”¨äºç›‘å¬é›†ç¾¤ä¸­å…¶å®ƒmemberçš„è¿æ¥</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://10.10.107.223:2380"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [é›†ç¾¤é…ç½®]</span></span><br><span class="line"><span class="comment"># æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ­¤IPsä¸é›†ç¾¤é€šä¿¡;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://10.10.107.223:2379"</span></span><br><span class="line"><span class="comment"># æœ¬æœºåœ°å€ç”¨äºé€šçŸ¥é›†ç¾¤memberä¸memberé€šä¿¡</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://10.10.107.223:2380"</span></span><br><span class="line"><span class="comment"># æè¿°é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæœ¬memberæ ¹æ®æ­¤ä¿¡æ¯å»è”ç³»å…¶ä»–member</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd1=https://10.10.107.225:2380,etcd2=https://10.10.107.224:2380,etcd3=https://10.10.107.223:2380"</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çŠ¶æ€æ–°å»ºé›†ç¾¤æ—¶å€™è®¾ç½®ä¸ºnew,è‹¥æ˜¯æƒ³åŠ å…¥æŸä¸ªå·²ç»å­˜åœ¨çš„é›†ç¾¤è®¾ç½®ä¸ºexisting</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=new</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 06.ã€æ‰€æœ‰MasterèŠ‚ç‚¹ä¸»æœºã€‘åˆ›å»ºé…ç½® etcd çš„ systemd ç®¡ç†é…ç½®æ–‡ä»¶ï¼Œå¹¶å¯åŠ¨å…¶æœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /var/lib/etcd/</span><br><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">Documentation=https://github.com/etcd-io/etcd</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/etcd \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file /etc/etcd/pki/ca.pem \</span><br><span class="line">  --cert-file /etc/etcd/pki/etcd.pem \</span><br><span class="line">  --key-file /etc/etcd/pki/etcd-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file /etc/etcd/pki/ca.pem \</span><br><span class="line">  --peer-cert-file /etc/etcd/pki/etcd.pem \</span><br><span class="line">  --peer-key-file /etc/etcd/pki/etcd-key.pem</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">LimitNPROC=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡è½½ systemd &amp;&amp; å¼€æœºå¯åŠ¨ä¸æ‰‹åŠ¨å¯ç”¨etcdæœåŠ¡</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now etcd.service</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 07.ã€æ‰€æœ‰MasterèŠ‚ç‚¹ä¸»æœºã€‘æŸ¥çœ‹å„ä¸ªmasterèŠ‚ç‚¹çš„etcdé›†ç¾¤æœåŠ¡æ˜¯å¦æ­£å¸¸åŠå…¶å¥åº·çŠ¶æ€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡æŸ¥çœ‹</span></span><br><span class="line">systemctl status etcd.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨ etcdctl å·¥å…·æŸ¥çœ‹é›†ç¾¤æˆå‘˜ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints=https://10.10.107.225:2379,https://10.10.107.224:2379,https://10.10.107.223:2379 \</span><br><span class="line">--cacert=<span class="string">"/etc/etcd/pki/ca.pem"</span> --cert=<span class="string">"/etc/etcd/pki/etcd.pem"</span> --key=<span class="string">"/etc/etcd/pki/etcd-key.pem"</span> \</span><br><span class="line">--write-out=table member list</span><br><span class="line">  <span class="comment"># +------------------+---------+-------+----------------------------+----------------------------+------------+</span></span><br><span class="line">  <span class="comment"># |        ID        | STATUS  | NAME  |         PEER ADDRS         |        CLIENT ADDRS        | IS LEARNER |</span></span><br><span class="line">  <span class="comment"># +------------------+---------+-------+----------------------------+----------------------------+------------+</span></span><br><span class="line">  <span class="comment"># | 144934d02ad45ec7 | started | etcd3 | https://10.10.107.223:2380 | https://10.10.107.223:2379 |      false |</span></span><br><span class="line">  <span class="comment"># | 2480d95a2df867a4 | started | etcd2 | https://10.10.107.224:2380 | https://10.10.107.224:2379 |      false |</span></span><br><span class="line">  <span class="comment"># | 2e8fddd3366a3d88 | started | etcd1 | https://10.10.107.225:2380 | https://10.10.107.225:2379 |      false |</span></span><br><span class="line">  <span class="comment"># +------------------+---------+-------+----------------------------+----------------------------+------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class="line">etcdctl --endpoints=https://10.10.107.225:2379,https://10.10.107.224:2379,https://10.10.107.223:2379 \</span><br><span class="line">--cacert=<span class="string">"/etc/etcd/pki/ca.pem"</span> --cert=<span class="string">"/etc/etcd/pki/etcd.pem"</span> --key=<span class="string">"/etc/etcd/pki/etcd-key.pem"</span>  \</span><br><span class="line">--write-out=table endpoint status</span><br><span class="line">  <span class="comment"># +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span></span><br><span class="line">  <span class="comment"># |          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span></span><br><span class="line">  <span class="comment"># +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span></span><br><span class="line">  <span class="comment"># | https://10.10.107.225:2379 | 2e8fddd3366a3d88 |   3.5.4 |   20 kB |     false |      false |         3 |         12 |                 12 |        |</span></span><br><span class="line">  <span class="comment"># | https://10.10.107.224:2379 | 2480d95a2df867a4 |   3.5.4 |   20 kB |      true |      false |         3 |         12 |                 12 |        |</span></span><br><span class="line">  <span class="comment"># | https://10.10.107.223:2379 | 144934d02ad45ec7 |   3.5.4 |   20 kB |     false |      false |         3 |         12 |                 12 |        |</span></span><br><span class="line">  <span class="comment"># +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹å¥åº·çŠ¶æ€</span></span><br><span class="line">etcdctl --endpoints=https://10.10.107.225:2379,https://10.10.107.224:2379,https://10.10.107.223:2379 \</span><br><span class="line">--cacert=<span class="string">"/etc/etcd/pki/ca.pem"</span> --cert=<span class="string">"/etc/etcd/pki/etcd.pem"</span> --key=<span class="string">"/etc/etcd/pki/etcd-key.pem"</span>  \</span><br><span class="line">--write-out=table endpoint health</span><br><span class="line">  <span class="comment"># +----------------------------+--------+-------------+-------+</span></span><br><span class="line">  <span class="comment"># |          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span></span><br><span class="line">  <span class="comment"># +----------------------------+--------+-------------+-------+</span></span><br><span class="line">  <span class="comment"># | https://10.10.107.225:2379 |   true |  9.151813ms |       |</span></span><br><span class="line">  <span class="comment"># | https://10.10.107.224:2379 |   true | 10.965914ms |       |</span></span><br><span class="line">  <span class="comment"># | https://10.10.107.223:2379 |   true | 11.165228ms |       |</span></span><br><span class="line">  <span class="comment"># +----------------------------+--------+-------------+-------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹æ€§èƒ½æµ‹è¯•</span></span><br><span class="line">etcdctl --endpoints=https://10.10.107.225:2379,https://10.10.107.224:2379,https://10.10.107.223:2379 \</span><br><span class="line">--cacert=<span class="string">"/etc/etcd/pki/ca.pem"</span> --cert=<span class="string">"/etc/etcd/pki/etcd.pem"</span> --key=<span class="string">"/etc/etcd/pki/etcd-key.pem"</span>  \</span><br><span class="line">--write-out=tableendpoint check perf</span><br><span class="line"><span class="comment"># 59 / 60 Boooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooom   !  98.33%PASS: Throughput is 148 writes/s</span></span><br><span class="line"><span class="comment"># Slowest request took too long: 1.344053s</span></span><br><span class="line"><span class="comment"># Stddev too high: 0.143059s</span></span><br><span class="line"><span class="comment"># FAIL</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<h3 id="5-Containerd-è¿è¡Œæ—¶å®‰è£…éƒ¨ç½²"><a href="#5-Containerd-è¿è¡Œæ—¶å®‰è£…éƒ¨ç½²" class="headerlink" title="5.Containerd è¿è¡Œæ—¶å®‰è£…éƒ¨ç½²"></a>5.Containerd è¿è¡Œæ—¶å®‰è£…éƒ¨ç½²</h3><p>æ­¥éª¤ 01.ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘åœ¨å„ä¸»æœºä¸­å®‰è£…äºŒè¿›åˆ¶ç‰ˆæœ¬çš„ containerd.io è¿è¡Œæ—¶æœåŠ¡ï¼ŒKubernertes é€šè¿‡ CRI æ’ä»¶æ¥è¿æ¥ containerd æœåŠ¡ä¸­, æ§åˆ¶å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä» Github ä¸­ä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬çš„ cri-containerd-cni </span></span><br><span class="line">wget -L https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹åˆ°å½“å‰cri-containerd-cniç›®å½•ä¸­ã€‚</span></span><br><span class="line">mkdir -vp cri-containerd-cni</span><br><span class="line">tar -zxvf cri-containerd-cni-1.6.4-linux-amd64.tar.gz -C cri-containerd-cni</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 02.æŸ¥çœ‹å…¶æ–‡ä»¶ä»¥åŠé…ç½®æ–‡ä»¶è·¯å¾„ä¿¡æ¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ tree ./cri-containerd-cni/</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cni</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ net.d</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ 10-containerd-net.conflist</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ crictl.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ systemd</span><br><span class="line">â”‚Â Â      â””â”€â”€ system</span><br><span class="line">â”‚Â Â          â””â”€â”€ containerd.service</span><br><span class="line">â”œâ”€â”€ opt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cni</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ bin</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ bandwidth</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ bridge</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ dhcp</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ firewall</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ host-device</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ host-local</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ ipvlan</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ loopback</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ macvlan</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ portmap</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ ptp</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ sbr</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ static</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ tuning</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ vlan</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ vrf</span><br><span class="line">â”‚Â Â  â””â”€â”€ containerd</span><br><span class="line">â”‚Â Â      â””â”€â”€ cluster</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ gce</span><br><span class="line">â”‚Â Â          â”‚Â Â  â”œâ”€â”€ cloud-init</span><br><span class="line">â”‚Â Â          â”‚Â Â  â”‚Â Â  â”œâ”€â”€ master.yaml</span><br><span class="line">â”‚Â Â          â”‚Â Â  â”‚Â Â  â””â”€â”€ node.yaml</span><br><span class="line">â”‚Â Â          â”‚Â Â  â”œâ”€â”€ cni.template</span><br><span class="line">â”‚Â Â          â”‚Â Â  â”œâ”€â”€ configure.sh</span><br><span class="line">â”‚Â Â          â”‚Â Â  â””â”€â”€ env</span><br><span class="line">â”‚Â Â          â””â”€â”€ version</span><br><span class="line">â””â”€â”€ usr</span><br><span class="line">    â””â”€â”€ <span class="built_in">local</span></span><br><span class="line">        â”œâ”€â”€ bin</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ containerd-shim</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ containerd-shim-runc-v1</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ containerd-shim-runc-v2</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ containerd-stress</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ crictl</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ critest</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ ctd-decoder</span><br><span class="line">        â”‚Â Â  â””â”€â”€ ctr</span><br><span class="line">        â””â”€â”€ sbin</span><br><span class="line">            â””â”€â”€ runc</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç„¶ååœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå¤åˆ¶åˆ°ä¸Šè¿°æ–‡ä»¶å¤¹åˆ°å¯¹åº”ç›®å½•ä¸­</span></span><br><span class="line"><span class="built_in">cd</span> ./cri-containerd-cni/</span><br><span class="line">cp -r etc/ /</span><br><span class="line">cp -r opt/ /</span><br><span class="line">cp -r usr/ /</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘è¿›è¡Œcontainerd é…ç½®åˆ›å»ºå¹¶ä¿®æ”¹ config.toml .<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /etc/containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤é…ç½®ç”Ÿæˆ</span></span><br><span class="line">containerd config default &gt;/etc/containerd/config.toml</span><br><span class="line">ls /etc/containerd/config.toml</span><br><span class="line">  <span class="comment"># /etc/containerd/config.toml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause é•œåƒæº</span></span><br><span class="line">sed -i <span class="string">"s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g"</span>  /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ SystemdCgroup</span></span><br><span class="line">sed -i <span class="string">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."docker.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://xlx9erfu.mirror.aliyuncs.com","https://docker.mirrors.ustc.edu.cn"]'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># gcr.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."gcr.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."gcr.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://gcr.mirrors.ustc.edu.cn"]'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s.gcr.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."k8s.gcr.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://gcr.mirrors.ustc.edu.cn/google-containers/","https://registry.cn-hangzhou.aliyuncs.com/google_containers/"]'</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># quay.io mirror</span></span><br><span class="line">sed -i <span class="string">'/registry.mirrors]/a\ \ \ \ \ \ \ \ [plugins."io.containerd.grpc.v1.cri".registry.mirrors."quay.io"]'</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">'/registry.mirrors."quay.io"]/a\ \ \ \ \ \ \ \ \ \ endpoint = ["https://quay.mirrors.ustc.edu.cn"]'</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 04.å®¢æˆ·ç«¯å·¥å…· runtime ä¸ é•œåƒ ç«¯ç‚¹é…ç½®:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰‹åŠ¨è®¾ç½®ä¸´æ—¶ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="comment"># crictl config runtime-endpoint /run/containerd/containerd.sock</span></span><br><span class="line"><span class="comment"># /run/containerd/containerd.sock </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶è®¾ç½®æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/crictl.yaml</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 05.é‡è½½ systemdè‡ªå¯å’Œå¯åŠ¨containerd.ioæœåŠ¡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now containerd.service</span><br><span class="line">systemctl status containerd.service</span><br><span class="line">ctr version</span><br><span class="line">  <span class="comment"># Client:</span></span><br><span class="line">  <span class="comment">#   Version:  1.5.11</span></span><br><span class="line">  <span class="comment">#   Revision: 3df54a852345ae127d1fa3092b95168e4a88e2f8</span></span><br><span class="line">  <span class="comment">#   Go version: go1.17.8</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Server:</span></span><br><span class="line">  <span class="comment">#   Version:  1.5.11</span></span><br><span class="line">  <span class="comment">#   Revision: 3df54a852345ae127d1fa3092b95168e4a88e2f8</span></span><br><span class="line">  <span class="comment">#   UUID: 71a28bbb-6ed6-408d-a873-e394d48b35d8</span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>æ­¥éª¤ 06.ç”¨äºæ ¹æ®OCIè§„èŒƒç”Ÿæˆå’Œè¿è¡Œå®¹å™¨çš„CLIå·¥å…· runc ç‰ˆæœ¬æŸ¥çœ‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">runc -v</span><br><span class="line">  <span class="comment"># runc version 1.1.1</span></span><br><span class="line">  <span class="comment"># commit: v1.1.1-0-g52de29d7</span></span><br><span class="line">  <span class="comment"># spec: 1.0.2-dev</span></span><br><span class="line">  <span class="comment"># go: go1.17.9</span></span><br><span class="line">  <span class="comment"># libseccomp: 2.5.1</span></span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: å½“é»˜è®¤ runc æ‰§è¡Œæç¤º <code>runc: symbol lookup error: runc: undefined symbol: seccomp_notify_respond</code> æ—¶ï¼Œç”±äºä¸Šè¿°è½¯ä»¶åŒ…ä¸­åŒ…å«çš„runcå¯¹ç³»ç»Ÿä¾èµ–è¿‡å¤šï¼Œæ‰€ä»¥å»ºè®®å•ç‹¬ä¸‹è½½å®‰è£… runc äºŒè¿›åˆ¶é¡¹ç›®(<a href="https://github.com/opencontainers/runc/" target="_blank" rel="noopener">https://github.com/opencontainers/runc/</a>)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/opencontainers/runc/releases/download/v1.1.1/runc.amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œæƒé™èµ‹äºˆ</span></span><br><span class="line">chmod +x runc.amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢æ‰ /usr/local/sbin/ è·¯å¾„åŸè½¯ä»¶åŒ…ä¸­çš„ runc</span></span><br><span class="line">mv runc.amd64 /usr/<span class="built_in">local</span>/sbin/runc</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="6-Kubernetes-é›†ç¾¤å®‰è£…éƒ¨ç½²"><a href="#6-Kubernetes-é›†ç¾¤å®‰è£…éƒ¨ç½²" class="headerlink" title="6.Kubernetes é›†ç¾¤å®‰è£…éƒ¨ç½²"></a>6.Kubernetes é›†ç¾¤å®‰è£…éƒ¨ç½²</h3><h4 id="1-äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸‹è½½å®‰è£…-ï¼ˆæ‰‹åŠ¨-æ­¤å¤„ä»¥è¯¥å®è·µä¸ºä¾‹ï¼‰"><a href="#1-äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸‹è½½å®‰è£…-ï¼ˆæ‰‹åŠ¨-æ­¤å¤„ä»¥è¯¥å®è·µä¸ºä¾‹ï¼‰" class="headerlink" title="1) äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸‹è½½å®‰è£… ï¼ˆæ‰‹åŠ¨-æ­¤å¤„ä»¥è¯¥å®è·µä¸ºä¾‹ï¼‰"></a>1) äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸‹è½½å®‰è£… ï¼ˆæ‰‹åŠ¨-æ­¤å¤„ä»¥è¯¥å®è·µä¸ºä¾‹ï¼‰</h4><p>æ­¥éª¤ 01.ã€master-225ã€‘æ‰‹åŠ¨ä»k8s.ioä¸‹è½½Kubernetesè½¯ä»¶åŒ…å¹¶è§£å‹å®‰è£…, å½“å‰æœ€æ–°ç‰ˆæœ¬ä¸º v1.23.6 ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœä¸‹è½½è¾ƒæ…¢è¯·ä½¿ç”¨æŸé›·</span></span><br><span class="line">wget -L</span><br><span class="line">https://dl.k8s.io/v1.23.6/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹</span></span><br><span class="line">/app/k8s-init-work/tools<span class="comment"># tar -zxf kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶åˆ° /usr/local/bin</span></span><br><span class="line">/app/k8s-init-work/tools/kubernetes/server/bin<span class="comment"># ls</span></span><br><span class="line">  <span class="comment"># apiextensions-apiserver  kube-apiserver.docker_tag           kube-controller-manager.tar  kube-log-runner        kube-scheduler</span></span><br><span class="line">  <span class="comment"># kubeadm                  kube-apiserver.tar                  kubectl                      kube-proxy             kube-scheduler.docker_tag</span></span><br><span class="line">  <span class="comment"># kube-aggregator          kube-controller-manager             kubectl-convert              kube-proxy.docker_tag  kube-scheduler.tar</span></span><br><span class="line">  <span class="comment"># kube-apiserver           kube-controller-manager.docker_tag  kubelet                      kube-proxy.tar         mounter</span></span><br><span class="line"></span><br><span class="line">cp kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet kubeadm  kubectl /usr/<span class="built_in">local</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯å®‰è£…</span></span><br><span class="line">kubectl version</span><br><span class="line">  <span class="comment"># Client Version: version.Info&#123;Major:"1", Minor:"23", GitVersion:"v1.23.6", GitCommit:"ad3338546da947756e8a88aa6822e9c11e7eac22", GitTreeState:"clean", BuildDate:"2022-04-14T08:49:13Z", GoVersion:"go1.17.9", Compiler:"gc", Platform:"linux/amd64"&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.ã€master-225ã€‘åˆ©ç”¨scpå°†kubernetesç›¸å…³è½¯ä»¶åŒ…åˆ†å‘åˆ°å…¶å®ƒæœºå™¨ä¸­ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scp -P 20211 kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet kubeadm kubectl weiyigeek@master-223:/tmp</span><br><span class="line">scp -P 20211 kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet kubeadm kubectl weiyigeek@master-224:/tmp</span><br><span class="line">scp -P 20211 kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet kubeadm kubectl weiyigeek@node-1:/tmp</span><br><span class="line">scp -P 20211 kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet kubeadm kubectl weiyigeek@node-2:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶å¦‚ä¸‹åˆ°æŒ‡å®šbinç›®å½•ä¸­(æ³¨æ„nodeèŠ‚ç‚¹åªéœ€è¦  kube-proxy kubelet ã€kubeadm åœ¨æ­¤å¤„å¯é€‰)</span></span><br><span class="line">cp kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet kubeadm kubectl /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘åœ¨é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ä¸Šåˆ›å»ºå‡†å¤‡å¦‚ä¸‹ç›®å½•<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /etc/kubernetes/&#123;manifests,pki,ssl,cfg&#125; /var/<span class="built_in">log</span>/kubernetes /var/lib/kubelet</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<h4 id="2-éƒ¨ç½²é…ç½®-kube-apiserver"><a href="#2-éƒ¨ç½²é…ç½®-kube-apiserver" class="headerlink" title="2) éƒ¨ç½²é…ç½® kube-apiserver"></a>2) éƒ¨ç½²é…ç½® kube-apiserver</h4><p>æè¿°: å®ƒæ˜¯é›†ç¾¤æ‰€æœ‰æœåŠ¡è¯·æ±‚è®¿é—®çš„å…¥å£ç‚¹, é€šè¿‡ API æ¥å£æ“ä½œé›†ç¾¤ä¸­çš„èµ„æºã€‚</p>
<p>æ­¥éª¤ 01.ã€master-225ã€‘åˆ›å»ºapiserverè¯ä¹¦è¯·æ±‚æ–‡ä»¶å¹¶ä½¿ç”¨ä¸Šä¸€ç« ç”Ÿæˆçš„CAç­¾å‘è¯ä¹¦ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œæ³¨æ„ä¸‹è¿°æ–‡ä»¶hostså­—æ®µä¸­IPä¸ºæ‰€æœ‰Master/LB/VIP IP,ä¸ºäº†æ–¹ä¾¿åæœŸæ‰©å®¹å¯ä»¥å¤šå†™å‡ ä¸ªé¢„ç•™çš„IPã€‚</span></span><br><span class="line"><span class="comment"># åŒæ—¶è¿˜éœ€è¦å¡«å†™ service ç½‘ç»œçš„é¦–ä¸ªIP(ä¸€èˆ¬æ˜¯ kube-apiserver æŒ‡å®šçš„ service-cluster-ip-range ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.96.0.1)ã€‚</span></span><br><span class="line">tee apiserver-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"10.10.107.223"</span>,</span><br><span class="line">    <span class="string">"10.10.107.224"</span>,</span><br><span class="line">    <span class="string">"10.10.107.225"</span>,</span><br><span class="line">    <span class="string">"10.10.107.222"</span>,</span><br><span class="line">    <span class="string">"10.96.0.1"</span>,</span><br><span class="line">    <span class="string">"weiyigeek.cluster.k8s"</span>,</span><br><span class="line">    <span class="string">"master-223"</span>,</span><br><span class="line">    <span class="string">"master-224"</span>,</span><br><span class="line">    <span class="string">"master-225"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨è‡ªç­¾CAç­¾å‘ kube-apiserver HTTPSè¯ä¹¦</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes apiserver-csr.json | cfssljson -bare apiserver</span><br><span class="line"></span><br><span class="line">$ ls apiserver*</span><br><span class="line">apiserver.csr  apiserver-csr.json  apiserver-key.pem  apiserver.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åˆ°è‡ªå®šä¹‰ç›®å½•</span></span><br><span class="line">cp *.pem /etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.ã€master-225ã€‘åˆ›å»ºTLSæœºåˆ¶æ‰€éœ€TOKEN<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/bootstrap-token.csv &lt;&lt; EOF</span><br><span class="line">$(head -c 16 /dev/urandom | od -An -t x | tr -d <span class="string">' '</span>),kubelet-bootstrap,10001,<span class="string">"system:bootstrappers"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: å¯ç”¨ TLS Bootstrapping æœºåˆ¶NodeèŠ‚ç‚¹kubeletå’Œkube-proxyè¦ä¸kube-apiserverè¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»ä½¿ç”¨CAç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰å¯ä»¥ï¼Œå½“NodeèŠ‚ç‚¹å¾ˆå¤šæ—¶ï¼Œè¿™ç§å®¢æˆ·ç«¯è¯ä¹¦é¢å‘éœ€è¦å¤§é‡å·¥ä½œï¼ŒåŒæ ·ä¹Ÿä¼šå¢åŠ é›†ç¾¤æ‰©å±•å¤æ‚åº¦ã€‚<br>ä¸ºäº†ç®€åŒ–æµç¨‹ï¼ŒKuberneteså¼•å…¥äº†TLS bootstrapingæœºåˆ¶æ¥è‡ªåŠ¨é¢å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œkubeletä¼šä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·è‡ªåŠ¨å‘apiserverç”³è¯·è¯ä¹¦ï¼Œkubeletçš„è¯ä¹¦ç”±apiserveråŠ¨æ€ç­¾ç½²ã€‚æ‰€ä»¥å¼ºçƒˆå»ºè®®åœ¨Nodeä¸Šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç›®å‰ä¸»è¦ç”¨äºkubeletï¼Œkube-proxyè¿˜æ˜¯ç”±æˆ‘ä»¬ç»Ÿä¸€é¢å‘ä¸€ä¸ªè¯ä¹¦ã€‚</p>
<p><br/></p>
<p>æ­¥éª¤ 03.ã€master-225ã€‘åˆ›å»º kube-apiserver é…ç½®æ–‡ä»¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/cfg/kube-apiserver.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--apiserver-count=3 \</span></span><br><span class="line"><span class="string">--advertise-address=10.10.107.225 \</span></span><br><span class="line"><span class="string">--allow-privileged=true \</span></span><br><span class="line"><span class="string">--authorization-mode=RBAC,Node \</span></span><br><span class="line"><span class="string">--bind-address=0.0.0.0 \</span></span><br><span class="line"><span class="string">--enable-aggregator-routing=true \</span></span><br><span class="line"><span class="string">--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span></span><br><span class="line"><span class="string">--enable-bootstrap-token-auth=true \</span></span><br><span class="line"><span class="string">--token-auth-file=/etc/kubernetes/bootstrap-token.csv \</span></span><br><span class="line"><span class="string">--secure-port=6443 \</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-32767 \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">--client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--tls-cert-file=/etc/kubernetes/ssl/apiserver.pem  \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/etc/kubernetes/ssl/apiserver-key.pem \</span></span><br><span class="line"><span class="string">--kubelet-client-certificate=/etc/kubernetes/ssl/apiserver.pem \</span></span><br><span class="line"><span class="string">--kubelet-client-key=/etc/kubernetes/ssl/apiserver-key.pem \</span></span><br><span class="line"><span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span></span><br><span class="line"><span class="string">--etcd-cafile=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--etcd-certfile=/etc/kubernetes/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">--etcd-keyfile=/etc/kubernetes/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">--etcd-servers=https://10.10.107.225:2379,https://10.10.107.224:2379,https://10.10.107.223:2379 \</span></span><br><span class="line"><span class="string">--service-account-issuer=https://kubernetes.default.svc.cluster.local \</span></span><br><span class="line"><span class="string">--service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">--service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">--proxy-client-cert-file=/etc/kubernetes/ssl/apiserver.pem \</span></span><br><span class="line"><span class="string">--proxy-client-key-file=/etc/kubernetes/ssl/apiserver-key.pem \</span></span><br><span class="line"><span class="string">--requestheader-allowed-names=kubernetes \</span></span><br><span class="line"><span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span></span><br><span class="line"><span class="string">--requestheader-group-headers=X-Remote-Group \</span></span><br><span class="line"><span class="string">--requestheader-username-headers=X-Remote-User \</span></span><br><span class="line"><span class="string">--requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--v=2 \</span></span><br><span class="line"><span class="string">--event-ttl=1h \</span></span><br><span class="line"><span class="string">--feature-gates=TTLAfterFinished=true \</span></span><br><span class="line"><span class="string">--logtostderr=false \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¡è®¡æ—¥å¿—å¯é€‰</span></span><br><span class="line"><span class="comment"># --audit-log-maxage=30</span></span><br><span class="line"><span class="comment"># --audit-log-maxbackup=3</span></span><br><span class="line"><span class="comment"># --audit-log-maxsize=100</span></span><br><span class="line"><span class="comment"># --audit-log-path=/var/log/kubernetes/kube-apiserver.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># â€“logtostderrï¼šå¯ç”¨æ—¥å¿—</span></span><br><span class="line"><span class="comment"># â€”vï¼šæ—¥å¿—ç­‰çº§</span></span><br><span class="line"><span class="comment"># â€“log-dirï¼šæ—¥å¿—ç›®å½•</span></span><br><span class="line"><span class="comment"># â€“etcd-serversï¼šetcdé›†ç¾¤åœ°å€</span></span><br><span class="line"><span class="comment"># â€“bind-addressï¼šç›‘å¬åœ°å€</span></span><br><span class="line"><span class="comment"># â€“secure-portï¼šhttpså®‰å…¨ç«¯å£</span></span><br><span class="line"><span class="comment"># â€“advertise-addressï¼šé›†ç¾¤é€šå‘Šåœ°å€</span></span><br><span class="line"><span class="comment"># â€“allow-privilegedï¼šå¯ç”¨æˆæƒ</span></span><br><span class="line"><span class="comment"># â€“service-cluster-ip-rangeï¼šServiceè™šæ‹ŸIPåœ°å€æ®µ</span></span><br><span class="line"><span class="comment"># â€“enable-admission-pluginsï¼šå‡†å…¥æ§åˆ¶æ¨¡å—</span></span><br><span class="line"><span class="comment"># â€“authorization-modeï¼šè®¤è¯æˆæƒï¼Œå¯ç”¨RBACæˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç†</span></span><br><span class="line"><span class="comment"># â€“enable-bootstrap-token-authï¼šå¯ç”¨TLS bootstrapæœºåˆ¶</span></span><br><span class="line"><span class="comment"># â€“token-auth-fileï¼šbootstrap tokenæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># â€“service-node-port-rangeï¼šService nodeportç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´</span></span><br><span class="line"><span class="comment"># â€“kubelet-client-xxxï¼šapiserverè®¿é—®kubeletå®¢æˆ·ç«¯è¯ä¹¦</span></span><br><span class="line"><span class="comment"># â€“tls-xxx-fileï¼šapiserver httpsè¯ä¹¦</span></span><br><span class="line"><span class="comment"># â€“etcd-xxxfileï¼šè¿æ¥Etcdé›†ç¾¤è¯ä¹¦</span></span><br><span class="line"><span class="comment"># â€“audit-log-xxxï¼šå®¡è®¡æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸©é¦¨æç¤º: åœ¨ 1.23.* ç‰ˆæœ¬ä¹‹åè¯·å‹¿ä½¿ç”¨å¦‚ä¸‹å‚æ•°ã€‚</span></span><br><span class="line">Flag --<span class="built_in">enable</span>-swagger-ui has been deprecated,</span><br><span class="line">Flag --insecure-port has been deprecated,</span><br><span class="line">Flag --alsologtostderr has been deprecated,</span><br><span class="line">Flag --logtostderr has been deprecated, will be removed <span class="keyword">in</span> a future release,</span><br><span class="line">Flag --<span class="built_in">log</span>-dir has been deprecated, will be removed <span class="keyword">in</span> a future release,</span><br><span class="line">Flag -- TTLAfterFinished=<span class="literal">true</span>. It will be removed <span class="keyword">in</span> a future release. (è¿˜å¯ä½¿ç”¨)</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 04.ã€master-225ã€‘åˆ›å»ºkube-apiserveræœåŠ¡ç®¡ç†é…ç½®æ–‡ä»¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /lib/systemd/system/kube-apiserver.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=etcd.service</span><br><span class="line">Wants=etcd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver <span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">LimitNPROC=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 05.å°†ä¸Šè¿°åˆ›å»ºç”Ÿæˆçš„æ–‡ä»¶ç›®å½•åŒæ­¥åˆ°é›†ç¾¤çš„å…¶å®ƒmasterèŠ‚ç‚¹ä¸Š.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master - 225  /etc/kubernetes/ ç›®å½•ç»“æ„</span></span><br><span class="line">tree /etc/kubernetes/</span><br><span class="line">/etc/kubernetes/</span><br><span class="line">â”œâ”€â”€ bootstrap-token.csv</span><br><span class="line">â”œâ”€â”€ cfg</span><br><span class="line">â”‚Â Â  â””â”€â”€ kube-apiserver.conf</span><br><span class="line">â”œâ”€â”€ manifests</span><br><span class="line">â”œâ”€â”€ pki</span><br><span class="line">â””â”€â”€ ssl</span><br><span class="line">    â”œâ”€â”€ apiserver-key.pem</span><br><span class="line">    â”œâ”€â”€ apiserver.pem</span><br><span class="line">    â”œâ”€â”€ ca-key.pem</span><br><span class="line">    â”œâ”€â”€ ca.pem</span><br><span class="line">    â”œâ”€â”€ etcd-key.pem</span><br><span class="line">    â””â”€â”€ etcd.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯ä¹¦åŠkube-apiserver.confé…ç½®æ–‡ä»¶</span></span><br><span class="line">scp -P 20211 -R /etc/kubernetes/ weiyigeek@master-223:/tmp</span><br><span class="line">scp -P 20211 -R /etc/kubernetes/ weiyigeek@master-224:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-apiserver æœåŠ¡ç®¡ç†é…ç½®æ–‡ä»¶</span></span><br><span class="line">scp -P 20211 /lib/systemd/system/kube-apiserver.service weiyigeek@master-223:/tmp</span><br><span class="line">scp -P 20211 /lib/systemd/system/kube-apiserver.service weiyigeek@master-224:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€master-223ã€‘ ã€master-224ã€‘ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°†ä¸Šä¼ åˆ°/tmpç›¸å…³æ–‡ä»¶æ”¾å…¥æŒ‡å®šç›®å½•ä¸­</span></span><br><span class="line"><span class="built_in">cd</span> /tmp/ &amp;&amp; cp -r /tmp/kubernetes/ /etc/</span><br><span class="line">mv kube-apiserver.service /lib/systemd/system/kube-apiserver.service</span><br><span class="line">mv kube-apiserver kubectl  kube-proxy  kube-scheduler kubeadm  kube-controller-manager  kubelet /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 06.åˆ†åˆ«ä¿®æ”¹ /etc/kubernetes/cfg/kube-apiserver.conf æ–‡ä»¶ä¸­ <code>--advertise-address=10.10.107.225</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ã€master-223ã€‘</span></span><br><span class="line">sed -i <span class="string">'s#--advertise-address=10.10.107.225#--advertise-address=10.10.107.223#g'</span> /etc/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line"><span class="comment"># ã€master-224ã€‘</span></span><br><span class="line">sed -i <span class="string">'s#--advertise-address=10.10.107.225#--advertise-address=10.10.107.224#g'</span> /etc/kubernetes/cfg/kube-apiserver.conf</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220428132432.png" target="_blank" title="WeiyiGeek.kube-apiserver.conf" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220428132432.png" alt="WeiyiGeek.kube-apiserver.conf" title="" class=""></a>
                <p>WeiyiGeek.kube-apiserver.conf</p>
            </figure>
<p><br/></p>
<p>æ­¥éª¤ 07.ã€masterèŠ‚ç‚¹ã€‘å®Œæˆä¸Šè¿°æ“ä½œååˆ†åˆ«åœ¨ä¸‰å°masterèŠ‚ç‚¹ä¸Šå¯åŠ¨apiserveræœåŠ¡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡è½½systemdä¸è‡ªå¯è®¾ç½®</span></span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl <span class="built_in">enable</span> --now kube-apiserver</span><br><span class="line">systemctl status kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•api-server</span></span><br><span class="line">curl --insecure https://10.10.107.222:16443/</span><br><span class="line">curl --insecure https://10.10.107.223:6443/</span><br><span class="line">curl --insecure https://10.10.107.224:6443/</span><br><span class="line">curl --insecure https://10.10.107.225:6443/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"Status"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="string">"metadata"</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">"status"</span>: <span class="string">"Failure"</span>,</span><br><span class="line">  <span class="string">"message"</span>: <span class="string">"forbidden: User \"system:anonymous\" cannot get path \"/\""</span>,</span><br><span class="line">  <span class="string">"reason"</span>: <span class="string">"Forbidden"</span>,</span><br><span class="line">  <span class="string">"details"</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">"code"</span>: 403</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220428134018.png" target="_blank" title="WeiyiGeek.ä¸‰å°masterèŠ‚ç‚¹apiserveræœåŠ¡çŠ¶æ€" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/2/20220428134018.png" alt="WeiyiGeek.ä¸‰å°masterèŠ‚ç‚¹apiserveræœåŠ¡çŠ¶æ€" title="" class=""></a>
                <p>WeiyiGeek.ä¸‰å°masterèŠ‚ç‚¹apiserveræœåŠ¡çŠ¶æ€</p>
            </figure>
<p>è‡³æ­¤å®Œæ¯•!</p>
<p><br/></p>
<h4 id="3-éƒ¨ç½²é…ç½®-kubectl"><a href="#3-éƒ¨ç½²é…ç½®-kubectl" class="headerlink" title="3) éƒ¨ç½²é…ç½® kubectl"></a>3) éƒ¨ç½²é…ç½® kubectl</h4><p>æè¿°: å®ƒæ˜¯é›†ç¾¤ç®¡ç†å®¢æˆ·ç«¯å·¥å…·,ä¸ API-Server æœåŠ¡è¯·æ±‚äº¤äº’, å®ç°èµ„æºçš„æŸ¥çœ‹ä¸ç®¡ç†ã€‚</p>
<p>æ­¥éª¤ 01.ã€master-225ã€‘åˆ›å»ºkubectlè¯ä¹¦è¯·æ±‚æ–‡ä»¶CSRå¹¶ç”Ÿæˆè¯ä¹¦<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">tee admin-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯ä¹¦æ–‡ä»¶ç”Ÿæˆ</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶è¯ä¹¦ç›¸å…³æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•</span></span><br><span class="line">ls admin*</span><br><span class="line">  <span class="comment"># admin.csr  admin-csr.json  admin-key.pem  admin.pem</span></span><br><span class="line">cp admin*.pem /etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.ã€master-225ã€‘ç”Ÿæˆkubeconfigé…ç½®æ–‡ä»¶ admin.conf ä¸º kubectl çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«è®¿é—® apiserver çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚ apiserver åœ°å€ã€CA è¯ä¹¦å’Œè‡ªèº«ä½¿ç”¨çš„è¯ä¹¦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes </span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®é›†ç¾¤ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># æ­¤å¤„ä¹Ÿå¯ä»¥é‡‡ç”¨åŸŸåçš„å½¢å¼ (https://weiyigeek.cluster.k8s:16443 )</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=<span class="literal">true</span> --server=https://10.10.107.222:16443 --kubeconfig=admin.conf</span><br><span class="line">  <span class="comment"># Cluster "kubernetes" set.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®é›†ç¾¤è®¤è¯ç”¨æˆ·</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials admin --client-certificate=/etc/kubernetes/ssl/admin.pem --client-key=/etc/kubernetes/ssl/admin-key.pem --embed-certs=<span class="literal">true</span> --kubeconfig=admin.conf</span><br><span class="line">  <span class="comment"># User "admin" set.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes --cluster=kubernetes --user=admin --kubeconfig=admin.conf</span><br><span class="line">  <span class="comment"># Context "kubernetes" created.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=admin.conf</span><br><span class="line">  <span class="comment"># Context "kubernetes" created.</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 03.ã€master-225ã€‘å‡†å¤‡kubectlé…ç½®æ–‡ä»¶å¹¶è¿›è¡Œè§’è‰²ç»‘å®šã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/.kube &amp;&amp; cp /etc/kubernetes/admin.conf ~/.kube/config</span><br><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes --kubeconfig=/root/.kube/config</span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/kube-apiserver:kubelet-apis created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯¥ config çš„å†…å®¹</span></span><br><span class="line">$ cat /root/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: base64(CAè¯ä¹¦)</span><br><span class="line">    server: https://10.10.107.222:16443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: admin</span><br><span class="line">  name: kubernetes</span><br><span class="line">current-context: kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: base64(ç”¨æˆ·è¯ä¹¦)</span><br><span class="line">    client-key-data: base64(ç”¨æˆ·è¯ä¹¦KEY)</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 04.ã€master-225ã€‘æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=<span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯</span></span><br><span class="line">kubectl cluster-info</span><br><span class="line">  <span class="comment"># Kubernetes control plane is running at https://10.10.107.222:16443</span></span><br><span class="line">  <span class="comment"># To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é›†ç¾¤ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">kubectl get componentstatuses</span><br><span class="line">  <span class="comment"># NAME                 STATUS      MESSAGE                                                                                        ERROR</span></span><br><span class="line">  <span class="comment"># controller-manager   Unhealthy   Get "https://127.0.0.1:10257/healthz": dial tcp 127.0.0.1:10257: connect: connection refused</span></span><br><span class="line">  <span class="comment"># scheduler            Unhealthy   Get "https://127.0.0.1:10259/healthz": dial tcp 127.0.0.1:10259: connect: connection refused</span></span><br><span class="line">  <span class="comment"># etcd-0               Healthy     &#123;"health":"true","reason":""&#125;</span></span><br><span class="line">  <span class="comment"># etcd-1               Healthy     &#123;"health":"true","reason":""&#125;</span></span><br><span class="line">  <span class="comment"># etcd-2               Healthy     &#123;"health":"true","reason":""&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å‘½åç©ºé—´ä»¥åŠæ‰€æœ‰åç§°ä¸­èµ„æºå¯¹è±¡</span></span><br><span class="line">kubectl get all --all-namespaces</span><br><span class="line">  <span class="comment"># NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span></span><br><span class="line">  <span class="comment"># default     service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   8h</span></span><br><span class="line">kubectl get ns</span><br><span class="line">  <span class="comment"># NAME              STATUS   AGE</span></span><br><span class="line">  <span class="comment"># default           Active   8h</span></span><br><span class="line">  <span class="comment"># kube-node-lease   Active   8h</span></span><br><span class="line">  <span class="comment"># kube-public       Active   8h</span></span><br><span class="line">  <span class="comment"># kube-system       Active   8h</span></span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: ç”±äºæˆ‘ä»¬è¿˜æœªè¿›è¡Œ controller-manager ä¸ scheduler éƒ¨ç½²æ‰€ä»¥æ­¤æ—¶å…¶çŠ¶æ€ä¸º Unhealthyã€‚</p>
<p><br/></p>
<p>æ­¥éª¤ 05.ã€master-225ã€‘åŒæ­¥kubectlé…ç½®æ–‡ä»¶åˆ°é›†ç¾¤å…¶å®ƒmasterèŠ‚ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 20211 weiyigeek@master-223 <span class="string">'mkdir ~/.kube/'</span></span><br><span class="line">ssh -p 20211 weiyigeek@master-224 <span class="string">'mkdir ~/.kube/'</span></span><br><span class="line"></span><br><span class="line">scp -P 20211 <span class="variable">$HOME</span>/.kube/config weiyigeek@master-223:~/.kube/</span><br><span class="line">scp -P 20211 <span class="variable">$HOME</span>/.kube/config weiyigeek@master-224:~/.kube/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€master-223ã€‘</span></span><br><span class="line">weiyigeek@master-223:~$ kubectl get services</span><br><span class="line">  <span class="comment"># NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span></span><br><span class="line">  <span class="comment"># kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   8h</span></span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 06.é…ç½® kubectl å‘½ä»¤è¡¥å…¨ (å»ºè®®æ–°æ‰‹å‹¿ç”¨ï¼Œç­‰å¾…åæœŸç†Ÿæ‚‰ç›¸å…³å‘½ä»¤åä½¿ç”¨)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…è¡¥å…¨å·¥å…·</span></span><br><span class="line">apt install -y bash-completion</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼1</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2</span></span><br><span class="line">kubectl completion bash &gt; ~/.kube/completion.bash.inc</span><br><span class="line"><span class="built_in">source</span> ~/.kube/completion.bash.inc</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨</span></span><br><span class="line">tee <span class="variable">$HOME</span>/.bash_profile &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># source &lt;(kubectl completion bash)</span></span><br><span class="line"><span class="built_in">source</span> ~/.kube/completion.bash.inc</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ kubectl é›†ç¾¤å®¢æˆ·ç«¯é…ç½® å®Œæ¯•.</p>
<p><br/></p>
<h4 id="4-éƒ¨ç½²é…ç½®-kube-controller-manager"><a href="#4-éƒ¨ç½²é…ç½®-kube-controller-manager" class="headerlink" title="4) éƒ¨ç½²é…ç½® kube-controller-manager"></a>4) éƒ¨ç½²é…ç½® kube-controller-manager</h4><p>æè¿°: å®ƒæ˜¯é›†ç¾¤ä¸­çš„æ§åˆ¶å™¨ç»„ä»¶ï¼Œå…¶å†…éƒ¨åŒ…å«å¤šä¸ªæ§åˆ¶å™¨èµ„æº, å®ç°å¯¹è±¡çš„è‡ªåŠ¨åŒ–æ§åˆ¶ä¸­å¿ƒã€‚</p>
<p>æ­¥éª¤ 01.ã€master-225ã€‘åˆ›å»º kube-controller-manager è¯ä¹¦è¯·æ±‚æ–‡ä»¶CSRå¹¶ç”Ÿæˆè¯ä¹¦<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">tee controller-manager-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"10.10.107.223"</span>,</span><br><span class="line">    <span class="string">"10.10.107.224"</span>,</span><br><span class="line">    <span class="string">"10.10.107.225"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line">* hosts åˆ—è¡¨åŒ…å«æ‰€æœ‰ kube-controller-manager èŠ‚ç‚¹ IPï¼›</span><br><span class="line">* CN ä¸º system:kube-controller-manager;</span><br><span class="line">* O ä¸º system:kube-controller-managerï¼Œkubernetes å†…ç½®çš„ ClusterRoleBindings system:kube-controller-manager èµ‹äºˆ kube-controller-manager å·¥ä½œæ‰€éœ€çš„æƒé™</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨ CA é¢å‘ kube-controller-manager è¯ä¹¦æ–‡ä»¶</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes controller-manager-csr.json | cfssljson -bare controller-manager</span><br><span class="line"></span><br><span class="line">$ ls controller*</span><br><span class="line">controller-manager.csr  controller-manager-csr.json  controller-manager-key.pem  controller-manager.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶è¯ä¹¦</span></span><br><span class="line">cp controller* /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.åˆ›å»º kube-controller-manager çš„ controller-manager.conf é…ç½®æ–‡ä»¶.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤ ä¹Ÿå¯é‡‡ç”¨ (https://weiyigeek.cluster.k8s:16443 ) åŸŸåå½¢å¼ã€‚</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=<span class="literal">true</span> --server=https://10.10.107.222:16443 --kubeconfig=controller-manager.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è®¤è¯</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials system:kube-controller-manager --client-certificate=/etc/kubernetes/ssl/controller-manager.pem --client-key=/etc/kubernetes/ssl/controller-manager-key.pem --embed-certs=<span class="literal">true</span> --kubeconfig=controller-manager.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=controller-manager.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸”æ¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context system:kube-controller-manager --kubeconfig=controller-manager.conf</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 03.å‡†å¤‡åˆ›å»º kube-controller-manager é…ç½®æ–‡ä»¶ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">"--allocate-node-cidrs=true \</span></span><br><span class="line"><span class="string">--bind-address=127.0.0.1 \</span></span><br><span class="line"><span class="string">--secure-port=10257 \</span></span><br><span class="line"><span class="string">--authentication-kubeconfig=/etc/kubernetes/controller-manager.conf \</span></span><br><span class="line"><span class="string">--authorization-kubeconfig=/etc/kubernetes/controller-manager.conf \</span></span><br><span class="line"><span class="string">--cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">--client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">--controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">--cluster-cidr=10.128.0.0/16 \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.96.0.0/16 \</span></span><br><span class="line"><span class="string">--use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">--root-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">--tls-cert-file=/etc/kubernetes/ssl/controller-manager.pem \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/etc/kubernetes/ssl/controller-manager-key.pem \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--cluster-signing-duration=87600h \</span></span><br><span class="line"><span class="string">--v=2 \</span></span><br><span class="line"><span class="string">--logtostderr=false \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--kubeconfig=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># æ¸©é¦¨æç¤º:</span></span><br><span class="line"><span class="string">Flag --logtostderr has been deprecated, will be removed in a future release,</span></span><br><span class="line"><span class="string">Flag --log-dir has been deprecated, will be removed in a future release</span></span><br><span class="line"><span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 04.åˆ›å»º kube-controller-manager æœåŠ¡å¯åŠ¨æ–‡ä»¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-controller-manager <span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 05.ã€master-225ã€‘åŒæ ·åˆ†å‘ä¸Šè¿°æ–‡ä»¶åˆ°å…¶å®ƒmasterèŠ‚ç‚¹ä¸­ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># controller-manager è¯ä¹¦ åŠ kube-controller-manager.conf é…ç½®æ–‡ä»¶ã€kube-controller-manager.service æœåŠ¡ç®¡ç†é…ç½®æ–‡ä»¶</span></span><br><span class="line">scp -P 20211 /etc/kubernetes/ssl/controller-manager.pem /etc/kubernetes/ssl/controller-manager-key.pem /etc/kubernetes/controller-manager.conf /etc/kubernetes/cfg/kube-controller-manager.conf /lib/systemd/system/kube-controller-manager.service weiyigeek@master-223:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/ssl/controller-manager.pem /etc/kubernetes/ssl/controller-manager-key.pem /etc/kubernetes/controller-manager.conf /etc/kubernetes/cfg/kube-controller-manager.conf /lib/systemd/system/kube-controller-manager.service weiyigeek@master-224:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€master-223ã€‘ ã€master-224ã€‘ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°†ä¸Šä¼ åˆ°/tmpç›¸å…³æ–‡ä»¶æ”¾å…¥æŒ‡å®šç›®å½•ä¸­</span></span><br><span class="line">mv controller-manager*.pem /etc/kubernetes/ssl/</span><br><span class="line">mv controller-manager.conf /etc/kubernetes/controller-manager.conf</span><br><span class="line">mv kube-controller-manager.conf /etc/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">mv kube-controller-manager.service /lib/systemd/system/kube-controller-manager.service</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 06.é‡è½½ systemd ä»¥åŠè‡ªåŠ¨å¯ç”¨ kube-controller-manager æœåŠ¡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl <span class="built_in">enable</span> --now kube-controller-manager</span><br><span class="line">systemctl status kube-controller-manager</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 07.å¯åŠ¨è¿è¡Œ kube-controller-manager æœåŠ¡åæŸ¥çœ‹é›†ç¾¤ç»„ä»¶çŠ¶æ€, å‘ç°åŸæœ¬ controller-manager æ˜¯ Unhealthy çš„çŠ¶æ€å·²ç»å˜æˆäº† Healthy çŠ¶æ€ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get componentstatu</span><br><span class="line">  <span class="comment"># NAME                 STATUS      MESSAGE                                                                                        ERROR</span></span><br><span class="line">  <span class="comment"># scheduler            Unhealthy   Get "https://127.0.0.1:10259/healthz": dial tcp 127.0.0.1:10259: connect: connection refused</span></span><br><span class="line">  <span class="comment"># controller-manager   Healthy     ok</span></span><br><span class="line">  <span class="comment"># etcd-2               Healthy     &#123;"health":"true","reason":""&#125;</span></span><br><span class="line">  <span class="comment"># etcd-0               Healthy     &#123;"health":"true","reason":""&#125;</span></span><br><span class="line">  <span class="comment"># etcd-1               Healthy     &#123;"health":"true","reason":""&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>è‡³æ­¤  kube-controller-manager æœåŠ¡çš„å®‰è£…ã€é…ç½®å®Œæ¯•ï¼</p>
<p><br/></p>
<h4 id="5-éƒ¨ç½²é…ç½®-kube-scheduler"><a href="#5-éƒ¨ç½²é…ç½®-kube-scheduler" class="headerlink" title="5) éƒ¨ç½²é…ç½® kube-scheduler"></a>5) éƒ¨ç½²é…ç½® kube-scheduler</h4><p>æè¿°: åœ¨é›†ç¾¤ä¸­kube-schedulerè°ƒåº¦å™¨ç»„ä»¶, è´Ÿè´£ä»»åŠ¡è°ƒåº¦é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹è¿›è¡Œåˆ†é…ä»»åŠ¡.</p>
<p>æ­¥éª¤ 01.ã€master-225ã€‘åˆ›å»º kube-scheduler è¯ä¹¦è¯·æ±‚æ–‡ä»¶CSRå¹¶ç”Ÿæˆè¯ä¹¦<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">tee scheduler-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"10.10.107.223"</span>,</span><br><span class="line">    <span class="string">"10.10.107.224"</span>,</span><br><span class="line">    <span class="string">"10.10.107.225"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨ CA é¢å‘ kube-scheduler è¯ä¹¦æ–‡ä»¶</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes scheduler-csr.json | cfssljson -bare scheduler</span><br><span class="line"></span><br><span class="line">$ ls scheduler*</span><br><span class="line">scheduler-csr.json scheduler.csr  scheduler-key.pem  scheduler.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶è¯ä¹¦</span></span><br><span class="line">cp scheduler*.pem /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.å®Œæˆåæˆ‘ä»¬éœ€è¦åˆ›å»º kube-scheduler çš„ kubeconfig é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤ ä¹Ÿå¯é‡‡ç”¨ (https://weiyigeek.cluster.k8s:16443 ) åŸŸåå½¢å¼ã€‚</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=<span class="literal">true</span> --server=https://10.10.107.222:16443 --kubeconfig=scheduler.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è®¤è¯</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials system:kube-scheduler --client-certificate=/etc/kubernetes/ssl/scheduler.pem --client-key=/etc/kubernetes/ssl/scheduler-key.pem --embed-certs=<span class="literal">true</span> --kubeconfig=scheduler.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=scheduler.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸”æ¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context system:kube-scheduler --kubeconfig=scheduler.conf</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 03.åˆ›å»º kube-scheduler æœåŠ¡é…ç½®æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/cfg/kube-scheduler.conf &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">"--address=127.0.0.1 \</span></span><br><span class="line"><span class="string">--secure-port=10259 \</span></span><br><span class="line"><span class="string">--kubeconfig=/etc/kubernetes/scheduler.conf \</span></span><br><span class="line"><span class="string">--authentication-kubeconfig=/etc/kubernetes/scheduler.conf \</span></span><br><span class="line"><span class="string">--authorization-kubeconfig=/etc/kubernetes/scheduler.conf \</span></span><br><span class="line"><span class="string">--client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">--tls-cert-file=/etc/kubernetes/ssl/scheduler.pem \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/etc/kubernetes/ssl/scheduler-key.pem \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--alsologtostderr=true \</span></span><br><span class="line"><span class="string">--logtostderr=false \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--v=2"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 04.åˆ›å»º kube-scheduler æœåŠ¡å¯åŠ¨é…ç½®æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /lib/systemd/system/kube-scheduler.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-scheduler <span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 05.ã€master-225ã€‘åŒæ ·åˆ†å‘ä¸Šè¿°æ–‡ä»¶åˆ°å…¶å®ƒmasterèŠ‚ç‚¹ä¸­ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># scheduler è¯ä¹¦ åŠ kube-scheduler.conf é…ç½®æ–‡ä»¶ã€kube-scheduler.service æœåŠ¡ç®¡ç†é…ç½®æ–‡ä»¶</span></span><br><span class="line">scp -P 20211 /etc/kubernetes/ssl/scheduler.pem /etc/kubernetes/ssl/scheduler-key.pem /etc/kubernetes/scheduler.conf /etc/kubernetes/cfg/kube-scheduler.conf /lib/systemd/system/kube-scheduler.service weiyigeek@master-223:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/ssl/scheduler.pem /etc/kubernetes/ssl/scheduler-key.pem /etc/kubernetes/scheduler.conf /etc/kubernetes/cfg/kube-scheduler.conf /lib/systemd/system/kube-scheduler.service weiyigeek@master-224:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€master-223ã€‘ ã€master-224ã€‘ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å°†ä¸Šä¼ åˆ°/tmpç›¸å…³æ–‡ä»¶æ”¾å…¥æŒ‡å®šç›®å½•ä¸­</span></span><br><span class="line">mv scheduler*.pem /etc/kubernetes/ssl/</span><br><span class="line">mv scheduler.conf /etc/kubernetes/scheduler.conf</span><br><span class="line">mv kube-scheduler.conf /etc/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">mv kube-scheduler.service /lib/systemd/system/kube-scheduler.service</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 06.ã€æ‰€æœ‰masterèŠ‚ç‚¹ã€‘é‡è½½ systemd ä»¥åŠè‡ªåŠ¨å¯ç”¨ kube-scheduler æœåŠ¡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl <span class="built_in">enable</span> --now kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 07.ã€æ‰€æœ‰masterèŠ‚ç‚¹ã€‘éªŒè¯æ‰€æœ‰masterèŠ‚ç‚¹å„ä¸ªç»„ä»¶çŠ¶æ€, æ­£å¸¸çŠ¶æ€ä¸‹å¦‚ä¸‹, å¦‚æœ‰é”™è¯¯è¯·æ’æŸ¥é€šè¿‡ååœ¨è¿›è¡Œåé¢æ“ä½œã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get componentstatuses</span><br><span class="line">  <span class="comment"># Warning: v1 ComponentStatus is deprecated in v1.19+</span></span><br><span class="line">  <span class="comment"># NAME                 STATUS    MESSAGE                         ERROR</span></span><br><span class="line">  <span class="comment"># controller-manager   Healthy   ok</span></span><br><span class="line">  <span class="comment"># scheduler            Healthy   ok</span></span><br><span class="line">  <span class="comment"># etcd-0               Healthy   &#123;"health":"true","reason":""&#125;</span></span><br><span class="line">  <span class="comment"># etcd-1               Healthy   &#123;"health":"true","reason":""&#125;</span></span><br><span class="line">  <span class="comment"># etcd-2               Healthy   &#123;"health":"true","reason":""&#125;</span></span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220429170504.png" target="_blank" title="WeiyiGeek.æ‰€æœ‰masterèŠ‚ç‚¹ç»„ä»¶çŠ¶æ€" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220429170504.png" alt="WeiyiGeek.æ‰€æœ‰masterèŠ‚ç‚¹ç»„ä»¶çŠ¶æ€" title="" class=""></a>
                <p>WeiyiGeek.æ‰€æœ‰masterèŠ‚ç‚¹ç»„ä»¶çŠ¶æ€</p>
            </figure>
<p><br></p>
<h4 id="6-éƒ¨ç½²é…ç½®-kubelet"><a href="#6-éƒ¨ç½²é…ç½®-kubelet" class="headerlink" title="6) éƒ¨ç½²é…ç½® kubelet"></a>6) éƒ¨ç½²é…ç½® kubelet</h4><p>æ­¥éª¤ 01.ã€master-225ã€‘è¯»å–BOOTSTRAP_TOKE å¹¶ åˆ›å»º kubelet çš„ kubeconfig é…ç½®æ–‡ä»¶ kubelet.confã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å– bootstrap-token å€¼</span></span><br><span class="line">BOOTSTRAP_TOKEN=$(awk -F <span class="string">","</span> <span class="string">'&#123;print $1&#125;'</span> /etc/kubernetes/bootstrap-token.csv)</span><br><span class="line"></span><br><span class="line"><span class="comment"># BOOTSTRAP_TOKEN="123456.httpweiyigeektop"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤ ä¹Ÿå¯é‡‡ç”¨ (https://weiyigeek.cluster.k8s:16443 ) åŸŸåå½¢å¼ã€‚</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=<span class="literal">true</span> --server=https://weiyigeek.cluster.k8s:16443 --kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è®¤è¯</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> --kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸”æ¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context default  --kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 02.å®Œæˆåæˆ‘ä»¬éœ€è¦è¿›è¡Œé›†ç¾¤è§’è‰²ç»‘å®šã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è§’è‰²æˆæƒ</span></span><br><span class="line">kubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=kubelet-bootstrap</span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap  --kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆæƒ kubelet åˆ›å»º CSR </span></span><br><span class="line">kubectl create clusterrolebinding create-csrs-for-bootstrapping --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹ CSR è¿›è¡Œæ‰¹å¤</span></span><br><span class="line"><span class="comment"># å…è®¸ kubelet è¯·æ±‚å¹¶æ¥æ”¶æ–°çš„è¯ä¹¦</span></span><br><span class="line">kubectl create clusterrolebinding auto-approve-csrs-for-group --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --group=system:bootstrappers</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸ kubelet å¯¹å…¶å®¢æˆ·ç«¯è¯ä¹¦æ‰§è¡Œç»­æœŸæ“ä½œ</span></span><br><span class="line">kubectl create clusterrolebinding auto-approve-renewals-for-nodes --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group=system:bootstrappers</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 03.åˆ›å»º kubelet é…ç½®æ–‡ä»¶ï¼Œé…ç½®å‚è€ƒåœ°å€ï¼ˆ<a href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/ï¼‰" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/ï¼‰</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yaml æ ¼å¼</span></span><br><span class="line"><span class="comment"># æ­¤å¤„ä¸ºäº†é€šç”¨æ€§æ¨èä½¿ç”¨å¦‚ä¸‹æ ¼å¼</span></span><br><span class="line">cat &gt; /etc/kubernetes/cfg/kubelet-config.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/ssl/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: AlwaysAllow</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: <span class="literal">true</span></span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: <span class="literal">true</span></span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: <span class="literal">true</span></span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># [master-225] ä¸»æœºæ‰§è¡Œåˆ™æ›¿æ¢ä¸ºå…¶ä¸»æœºåœ°å€, å…¶å®ƒèŠ‚ç‚¹ä¹Ÿæ˜¯å¯¹åº”çš„IPåœ°å€, æˆ–è€…ç›´æ¥ 0.0.0.0 å…¨åœ°å€ç›‘å¬è¿™æ ·ä¹Ÿå°±ä¸ç”¨ä¿®æ”¹äº†ã€‚</span></span><br><span class="line"><span class="comment"># sed -i 's#__IP__#10.10.107.225#g' /etc/kubernetes/cfg/kubelet-config.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># json æ ¼å¼ ï¼ˆä¸æ¨èäº†è§£å°±å¥½ï¼‰</span></span><br><span class="line">cat &gt; /etc/kubernetes/cfg/kubelet.json &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"kind"</span>: <span class="string">"KubeletConfiguration"</span>,</span><br><span class="line">  <span class="string">"apiVersion"</span>: <span class="string">"kubelet.config.k8s.io/v1beta1"</span>,</span><br><span class="line">  <span class="string">"authentication"</span>: &#123;</span><br><span class="line">    <span class="string">"x509"</span>: &#123;</span><br><span class="line">      <span class="string">"clientCAFile"</span>: <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"cacheTTL"</span>: <span class="string">"2m0s"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"anonymous"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"authorization"</span>: &#123;</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"Webhook"</span>,</span><br><span class="line">    <span class="string">"webhook"</span>: &#123;</span><br><span class="line">      <span class="string">"cacheAuthorizedTTL"</span>: <span class="string">"5m0s"</span>,</span><br><span class="line">      <span class="string">"cacheUnauthorizedTTL"</span>: <span class="string">"30s"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"address"</span>: <span class="string">"__IP__"</span>,</span><br><span class="line">  <span class="string">"port"</span>: 10250,</span><br><span class="line">  <span class="string">"readOnlyPort"</span>: 10255,</span><br><span class="line">  <span class="string">"cgroupDriver"</span>: <span class="string">"systemd"</span>,                    </span><br><span class="line">  <span class="string">"hairpinMode"</span>: <span class="string">"promiscuous-bridge"</span>,</span><br><span class="line">  <span class="string">"serializeImagePulls"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"clusterDomain"</span>: <span class="string">"cluster.local."</span>,</span><br><span class="line">  <span class="string">"clusterDNS"</span>: [<span class="string">"10.96.0.10"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: ä¸Šè¿° kubelet.json ä¸­ address éœ€è¦ä¿®æ”¹ä¸ºå½“å‰ä¸»æœºIPåœ°å€, ä¾‹å¦‚åœ¨master-225ä¸»æœºä¸­åº”è¯¥æ›´æ”¹ä¸º 10.10.107.225 , æ­¤å¤„æˆ‘è®¾ç½®ä¸ºäº† 0.0.0.0 è¡¨ç¤ºç›‘å¬æ‰€æœ‰ç½‘å¡ï¼Œè‹¥æœ‰æŒ‡å®šç½‘å¡çš„éœ€æ±‚è¯·æŒ‡å®šå…¶IPåœ°å€ã€‚</p>
<p><br/></p>
<p>æ­¥éª¤ 04.ã€master-225ã€‘åˆ›å»º kubelet æœåŠ¡å¯åŠ¨ç®¡ç†æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å·¥ä½œç›®å½•åˆ›å»º</span></span><br><span class="line">mkdir -vp /var/lib/kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º kubelet.service æœåŠ¡</span></span><br><span class="line">cat &gt; /lib/systemd/system/kubelet.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=kubelet: The Kubernetes Node Agent</span><br><span class="line">Documentation=https://kubernetes.io/docs/home/</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kubelet \</span><br><span class="line">--bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">--config=/etc/kubernetes/cfg/kubelet-config.yaml \</span><br><span class="line">--cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">--kubeconfig=/etc/kubernetes/kubelet.conf \</span><br><span class="line">--network-plugin=cni \</span><br><span class="line">--root-dir=/etc/cni/net.d \</span><br><span class="line">--cni-bin-dir=/opt/cni/bin \</span><br><span class="line">--cni-conf-dir=/etc/cni/net.d \</span><br><span class="line">--container-runtime=remote \</span><br><span class="line">--container-runtime-endpoint=unix:///run/containerd/containerd.sock \</span><br><span class="line">--rotate-certificates \</span><br><span class="line">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6 \</span><br><span class="line">--image-pull-progress-deadline=15m \</span><br><span class="line">--alsologtostderr=<span class="literal">true</span> \</span><br><span class="line">--logtostderr=<span class="literal">false</span> \</span><br><span class="line">--<span class="built_in">log</span>-dir=/var/<span class="built_in">log</span>/kubernetes \</span><br><span class="line">--v=2 \</span><br><span class="line">--node-labels=node.kubernetes.io/node=<span class="string">''</span></span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 05.å°†master-255èŠ‚ç‚¹ä¸Šçš„kubeletç›¸å…³æ–‡ä»¶å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¹‹ä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å…¶å®ƒèŠ‚ç‚¹ /tmp ç›®å½•</span></span><br><span class="line">scp -P 20211 /etc/kubernetes/kubelet-bootstrap.kubeconfig /etc/kubernetes/cfg/kubelet-config.yaml /lib/systemd/system/kubelet.service weiyigeek@master-223:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/kubelet-bootstrap.kubeconfig /etc/kubernetes/cfg/kubelet-config.yaml /lib/systemd/system/kubelet.service weiyigeek@master-224:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/kubelet-bootstrap.kubeconfig /etc/kubernetes/cfg/kubelet-config.yaml /lib/systemd/system/kubelet.service weiyigeek@node-1:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/kubelet-bootstrap.kubeconfig /etc/kubernetes/cfg/kubelet-config.yaml /lib/systemd/system/kubelet.service weiyigeek@node-2:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†åˆ«å°† /tmp ç›®å½•ä¸­çš„kubeleté…ç½®æ–‡ä»¶å¤åˆ¶åˆ°å¯¹åº”ç›®å½•</span></span><br><span class="line">sudo mkdir -vp /var/lib/kubelet /etc/kubernetes/cfg/</span><br><span class="line">cp /tmp/kubelet-bootstrap.kubeconfig /etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line">cp /tmp/kubelet-config.yaml /etc/kubernetes/cfg/kubelet-config.yaml</span><br><span class="line">cp /tmp/kubelet.service /lib/systemd/system/kubelet.service</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 06.ã€æ‰€æœ‰èŠ‚ç‚¹ã€‘é‡è½½ systemd ä»¥åŠè‡ªåŠ¨å¯ç”¨ kube-scheduler æœåŠ¡ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet.service</span><br><span class="line">systemctl status -l kubelet.service</span><br><span class="line"><span class="comment"># systemctl restart kubelet.service</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 07.åˆ©ç”¨kubectlå·¥å…·æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node -o wide</span><br><span class="line">NAME         STATUS     ROLES    AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME</span><br><span class="line">master-223   NotReady   &lt;none&gt;   17h     v1.23.6   10.10.107.223   &lt;none&gt;        Ubuntu 20.04.3 LTS   5.4.0-92-generic    containerd://1.6.4</span><br><span class="line">master-224   NotReady   &lt;none&gt;   19s     v1.23.6   10.10.107.224   &lt;none&gt;        Ubuntu 20.04.3 LTS   5.4.0-92-generic    containerd://1.6.4</span><br><span class="line">master-225   NotReady   &lt;none&gt;   3d22h   v1.23.6   10.10.107.225   &lt;none&gt;        Ubuntu 20.04.3 LTS   5.4.0-109-generic   containerd://1.6.4</span><br><span class="line">node-1       NotReady   &lt;none&gt;   17h     v1.23.6   10.10.107.226   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-96-generic    containerd://1.6.4</span><br><span class="line">node-2       NotReady   &lt;none&gt;   17h     v1.23.6   10.10.107.227   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-96-generic    containerd://1.6.4</span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: ç”±ä¸Šè¿°ç»“æœå¯çŸ¥å„ä¸ªèŠ‚ç‚¹ STATUS å¤„äº NotReady , è¿™æ˜¯ç”±äºèŠ‚ç‚¹ä¹‹é—´çš„PODæ— æ³•é€šä¿¡è¿˜ç¼ºå°‘ç½‘ç»œæ’ä»¶ï¼Œå½“æˆ‘ä»¬å®‰è£…å¥½ kube-proxy ä¸ calico å°±å¯ä»¥å˜æˆ Ready çŠ¶æ€äº†ã€‚</p>
<p><br/></p>
<p>æ­¥éª¤ 08.ç¡®è®¤kubeletæœåŠ¡å¯åŠ¨æˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹<code>kubelet-bootstrap</code>ç”³è¯·é¢å‘çš„è¯ä¹¦, å¦‚æœCONDITIONä¸ä¸ºApproved,Issuedåˆ™éœ€è¦è¿›è¡Œæ’æŸ¥æ˜¯å¦æœ‰é”™è¯¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get csr</span><br><span class="line">NAME        AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">csr-b949p   7m55s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-c9hs4   3m34s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-r8vhp   5m50s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-zb4sr   3m40s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="7-éƒ¨ç½²é…ç½®-kube-proxy"><a href="#7-éƒ¨ç½²é…ç½®-kube-proxy" class="headerlink" title="7) éƒ¨ç½²é…ç½® kube-proxy"></a>7) éƒ¨ç½²é…ç½® kube-proxy</h4><p>æè¿°: åœ¨é›†ç¾¤ä¸­kube-proxyç»„ä»¶, å…¶è´Ÿè´£èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œè§„åˆ™ä½¿å¾—æ‚¨å¯ä»¥åœ¨é›†ç¾¤å†…ã€é›†ç¾¤å¤–æ­£ç¡®åœ°ä¸ Pod è¿›è¡Œç½‘ç»œé€šä¿¡, åŒæ—¶å®ƒä¹Ÿæ˜¯è´Ÿè½½å‡è¡¡ä¸­æœ€é‡è¦çš„ç‚¹ï¼Œè¿›è¡Œæµé‡è½¬å‘</p>
<p>æ­¥éª¤ 01.ã€master-225ã€‘åˆ›å»º kube-proxy è¯ä¹¦è¯·æ±‚æ–‡ä»¶CSRå¹¶ç”Ÿæˆè¯ä¹¦<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">tee proxy-csr.json &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ChongQing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨ CA é¢å‘ kube-scheduler è¯ä¹¦æ–‡ä»¶</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes proxy-csr.json | cfssljson -bare proxy</span><br><span class="line"></span><br><span class="line">$ ls proxy*</span><br><span class="line">proxy.csr  proxy-csr.json  proxy-key.pem  proxy.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶è¯ä¹¦</span></span><br><span class="line">cp proxy*.pem /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.å®Œæˆåæˆ‘ä»¬éœ€è¦åˆ›å»º kube-scheduler çš„ kubeconfig é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é›†ç¾¤ ä¹Ÿå¯é‡‡ç”¨ (https://weiyigeek.cluster.k8s:16443 ) åŸŸåå½¢å¼ã€‚</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem --embed-certs=<span class="literal">true</span> --server=https://10.10.107.222:16443 --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è®¤è¯</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy --client-certificate=/etc/kubernetes/ssl/proxy.pem --client-key=/etc/kubernetes/ssl/proxy-key.pem --embed-certs=<span class="literal">true</span> --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸”æ¢ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 03.åˆ›å»º kube-proxy æœåŠ¡é…ç½®æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/cfg/kube-proxy.yaml &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">hostnameOverride: __HOSTNAME__</span><br><span class="line">clusterCIDR: 10.128.0.0/16</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">mode: ipvs</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs:</span><br><span class="line">  - 10.128.0.1/32</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>æ¸©é¦¨æç¤º: ProxyMode è¡¨ç¤ºçš„æ˜¯ Kubernetes ä»£ç†æœåŠ¡å™¨æ‰€ä½¿ç”¨çš„æ¨¡å¼.</p>
<ul>
<li>ç›®å‰åœ¨ Linux å¹³å°ä¸Šæœ‰ä¸‰ç§å¯ç”¨çš„ä»£ç†æ¨¡å¼ï¼š<code>&#39;userspace&#39;ï¼ˆç›¸å¯¹è¾ƒè€ï¼Œå³å°†è¢«æ·˜æ±°ï¼‰ã€ &#39;iptables&#39;ï¼ˆç›¸å¯¹è¾ƒæ–°ï¼Œé€Ÿåº¦è¾ƒå¿«ï¼‰ã€&#39;ipvs&#39;ï¼ˆæœ€æ–°ï¼Œåœ¨æ€§èƒ½å’Œå¯æ‰©ç¼©æ€§ä¸Šè¡¨ç°å¥½ï¼‰</code>ã€‚</li>
<li>ç›®å‰åœ¨ Windows å¹³å°ä¸Šæœ‰ä¸¤ç§å¯ç”¨çš„ä»£ç†æ¨¡å¼ï¼š<code>&#39;userspace&#39;ï¼ˆç›¸å¯¹è¾ƒè€ï¼Œä½†ç¨³å®šï¼‰å’Œ &#39;kernelspace&#39;ï¼ˆç›¸å¯¹è¾ƒæ–°ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰</code>ã€‚</li>
</ul>
<p><br/></p>
<p>æ­¥éª¤ 04.åˆ›å»º kube-proxy.service æœåŠ¡å¯åŠ¨ç®¡ç†æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mkdir -vp /var/lib/kube-proxy</span><br><span class="line">cat &gt; /lib/systemd/system/kube-proxy.service &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-proxy Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kube-proxy</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/cfg/kube-proxy.yaml \</span><br><span class="line">  --alsologtostderr=<span class="literal">true</span> \</span><br><span class="line">  --logtostderr=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">log</span>-dir=/var/<span class="built_in">log</span>/kubernetes \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 05.åŒæ­¥ã€master-225ã€‘èŠ‚ç‚¹ä¸­å¦‚ä¸‹æ–‡ä»¶åˆ°å…¶å®ƒèŠ‚ç‚¹å¯¹åº”ç›®å½•ä¹‹ä¸Šã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">scp -P 20211 /etc/kubernetes/kube-proxy.kubeconfig  /etc/kubernetes/ssl/proxy.pem /etc/kubernetes/ssl/proxy-key.pem /etc/kubernetes/cfg/kube-proxy.yaml /lib/systemd/system/kube-proxy.service weiyigeek@master-223:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/kube-proxy.kubeconfig  /etc/kubernetes/ssl/proxy.pem /etc/kubernetes/ssl/proxy-key.pem /etc/kubernetes/cfg/kube-proxy.yaml /lib/systemd/system/kube-proxy.service weiyigeek@master-224:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/kube-proxy.kubeconfig  /etc/kubernetes/ssl/proxy.pem /etc/kubernetes/ssl/proxy-key.pem /etc/kubernetes/cfg/kube-proxy.yaml /lib/systemd/system/kube-proxy.service weiyigeek@node-1:/tmp</span><br><span class="line">scp -P 20211 /etc/kubernetes/kube-proxy.kubeconfig  /etc/kubernetes/ssl/proxy.pem /etc/kubernetes/ssl/proxy-key.pem /etc/kubernetes/cfg/kube-proxy.yaml /lib/systemd/system/kube-proxy.service weiyigeek@node-2:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åˆ°å¯¹åº”èŠ‚ç‚¹ä¸Šå¹¶åˆ›å»ºå¯¹åº”ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">cp kube-proxy.kubeconfig /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">cp proxy*.pem /etc/kubernetes/ssl/</span><br><span class="line">cp kube-proxy.yaml /etc/kubernetes/cfg/kube-proxy.yaml </span><br><span class="line">cp kube-proxy.service /lib/systemd/system/kube-proxy.service</span><br><span class="line">mkdir -vp /var/lib/kube-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸©é¦¨æç¤º: éå¸¸æ³¨æ„å„èŠ‚ç‚¹ä¸»æœºåç§°ï¼Œè¯·ä¿®æ”¹ kube-proxy.yaml ä¸­hostnameOverrideä¸ºå½“å‰æ‰§è¡Œä¸»æœºåç§°.</span></span><br><span class="line">sed -i <span class="string">"s#__HOSTNAME__#<span class="variable">$(hostname)</span>#g"</span> /etc/kubernetes/cfg/kube-proxy.yaml</span><br></pre></td></tr></table></figure>
<p><br/></p>
<p>æ­¥éª¤ 06.åŒæ ·é‡è½½systemdæœåŠ¡ä¸è®¾ç½®kube-proxyæœåŠ¡è‡ªå¯ï¼Œå¯åŠ¨åæŸ¥çœ‹å…¶æœåŠ¡çŠ¶æ€<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now kube-proxy</span><br><span class="line"><span class="comment"># systemctl restart kube-proxy</span></span><br><span class="line">systemctl status kube-proxy</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220505224012.png" target="_blank" title="WeiyiGeek.kube-proxyæœåŠ¡çŠ¶æ€æŸ¥çœ‹" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220505224012.png" alt="WeiyiGeek.kube-proxyæœåŠ¡çŠ¶æ€æŸ¥çœ‹" title="" class=""></a>
                <p>WeiyiGeek.kube-proxyæœåŠ¡çŠ¶æ€æŸ¥çœ‹</p>
            </figure>
<hr>
<h4 id="8-éƒ¨ç½²é…ç½®-Calico-æ’ä»¶"><a href="#8-éƒ¨ç½²é…ç½®-Calico-æ’ä»¶" class="headerlink" title="8) éƒ¨ç½²é…ç½® Calico æ’ä»¶"></a>8) éƒ¨ç½²é…ç½® Calico æ’ä»¶</h4><p>æè¿°: å‰é¢åœ¨èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ—¶,ä½ ä¼šå‘ç°å…¶èŠ‚ç‚¹çŠ¶æ€ä¸º NotReady , æˆ‘ä»¬è¯´è¿‡éƒ¨ç½²calicoæ’ä»¶å¯ä»¥è®©Podä¸é›†ç¾¤æ­£å¸¸é€šä¿¡ã€‚</p>
<p>æ­¥éª¤ 01.åœ¨ã€master-225ã€‘èŠ‚ç‚¹ä¸Šæ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„ calico å½“å‰æœ€æ–°ç‰ˆæœ¬ä¸º v3.22, å®˜æ–¹é¡¹ç›®åœ°å€ (<a href="https://github.com/projectcalico/calico" target="_blank" rel="noopener">https://github.com/projectcalico/calico</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å– calico éƒ¨ç½²æ¸…å•</span></span><br><span class="line">wget https://docs.projectcalico.org/v3.22/manifests/calico.yaml</span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ 02.ä¿®æ”¹ calico.yaml æ–‡ä»¶çš„ä¸­å¦‚ä¸‹ K/V, å³ Pod è·å–IPåœ°å€çš„åœ°å€æ± , ä»ç½‘ç»œè§„åˆ’ä¸­æˆ‘ä»¬è®¾ç½®ä¸º <code>10.128.0.0/16</code>, æ³¨æ„é»˜è®¤æƒ…å†µä¸‹å¦‚ä¸‹å­—æ®µæ˜¯æ³¨é‡Šçš„ä¸”é»˜è®¤åœ°å€æ± ä¸º<code>192.168.0.0/16</code>ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim calico.yaml</span><br><span class="line"><span class="comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span></span><br><span class="line"><span class="comment"># chosen from this range. Changing this value after installation will have</span></span><br><span class="line"><span class="comment"># no effect. This should fall within `--cluster-cidr`.</span></span><br><span class="line">- name: CALICO_IPV4POOL_CIDR</span><br><span class="line">  value: <span class="string">"10.128.0.0/16"</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 03.éƒ¨ç½² calico åˆ°é›†ç¾¤ä¹‹ä¸­ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br><span class="line">  <span class="comment"># configmap/calico-config created</span></span><br><span class="line">  <span class="comment"># ....</span></span><br><span class="line">  <span class="comment"># poddisruptionbudget.policy/calico-kube-controllers created</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 04.æŸ¥çœ‹calicoç½‘ç»œæ’ä»¶åœ¨å„èŠ‚ç‚¹ä¸Šéƒ¨ç½²ç»“æœ,çŠ¶æ€ä¸ºRunningè¡¨ç¤ºéƒ¨ç½²æˆåŠŸã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -A -o wide</span><br><span class="line">  <span class="comment"># NAMESPACE     NAME                                       READY   STATUS              RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</span></span><br><span class="line">  <span class="comment"># kube-system   calico-kube-controllers-6f7b5668f7-m55gf   1/1     Running             0          56m   &lt;none&gt;          master-224   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># kube-system   calico-node-6cmgl                          1/1     Running             0          48m   10.10.107.226   node-1       &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># kube-system   calico-node-bx59c                          1/1     Running             0          50m   10.10.107.227   node-2       &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># kube-system   calico-node-ft29c                          1/1     Running             0          50m   10.10.107.225   master-225   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># kube-system   calico-node-gkz76                          1/1     Running             0          49m   10.10.107.223   master-223   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line">  <span class="comment"># kube-system   calico-node-nbnwx                          1/1     Running             0          47m   10.10.107.224   master-224   &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 05.æŸ¥çœ‹é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯å¦Ready,çŠ¶æ€ä¸ºRunningè¡¨ç¤ºèŠ‚ç‚¹æ­£å¸¸ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">  <span class="comment"># NAME         STATUS   ROLES    AGE     VERSION</span></span><br><span class="line">  <span class="comment"># master-223   Ready    &lt;none&gt;   3d      v1.23.6</span></span><br><span class="line">  <span class="comment"># master-224   Ready    &lt;none&gt;   2d6h    v1.23.6</span></span><br><span class="line">  <span class="comment"># master-225   Ready    &lt;none&gt;   6d5h    v1.23.6</span></span><br><span class="line">  <span class="comment"># node-1       Ready    &lt;none&gt;   2d23h   v1.23.6</span></span><br><span class="line">  <span class="comment"># node-2       Ready    &lt;none&gt;   2d23h   v1.23.6</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 06.æ­¤å¤„æˆ‘ä»¬æ‰©å±•ä¸€å“ˆï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°åœ¨äºŒè¿›åˆ¶å®‰è£…Kubernetesé›†ç¾¤æ—¶masterèŠ‚ç‚¹ROLESä¸º<code>&lt;none&gt;</code>,è€Œä¸æ˜¯æˆ‘ä»¬å¸¸è§çš„masteråç§°, å¹¶ä¸”ç”±äº K8s 1.24ç‰ˆæœ¬ä»¥åkubeadmå®‰è£…Kubernetesé›†ç¾¤æ—¶ï¼Œä¸å†ç»™è¿è¡Œæ§åˆ¶é¢ç»„ä»¶çš„èŠ‚ç‚¹æ ‡è®°ä¸ºâ€œmasterâ€ï¼Œåªæ˜¯å› ä¸ºè¿™ä¸ªè¯è¢«è®¤ä¸ºæ˜¯â€œå…·æœ‰æ”»å‡»æ€§çš„ã€æ— ç¤¼çš„ï¼ˆoffensiveï¼‰â€ã€‚è¿‘å‡ å¹´ä¸€äº›ç”¨master-slaveæ¥è¡¨ç¤ºä¸»-ä»èŠ‚ç‚¹çš„è®¡ç®—æœºç³»ç»Ÿçº·çº·æ”¹æ‰æœ¯è¯­ï¼Œslaveå‰ä¸¤å¹´å°±å·²ç»é”€å£°åŒ¿è¿¹äº†ï¼Œç°åœ¨çœ‹æ¥masterä¹Ÿä¸èƒ½ç”¨, ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡Œè‡ªå®šä¹‰è®¾ç½®èŠ‚ç‚¹è§’è‰²åç§°ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ†åˆ«å°†ä¸»èŠ‚ç‚¹è®¾ç½®ä¸ºcontrol-plane,å·¥ä½œèŠ‚ç‚¹è§’è‰²è®¾ç½®ä¸ºworkã€</span></span><br><span class="line"><span class="comment"># node-role.kubernetes.io/èŠ‚ç‚¹è§’è‰²åç§°=</span></span><br><span class="line">kubectl label nodes master-223 node-role.kubernetes.io/control-plane=</span><br><span class="line">kubectl label nodes master-224 node-role.kubernetes.io/control-plane=</span><br><span class="line">kubectl label nodes master-225 node-role.kubernetes.io/control-plane=</span><br><span class="line">kubectl label nodes node-1 node-role.kubernetes.io/work=</span><br><span class="line">kubectl label nodes node-2 node-role.kubernetes.io/work=</span><br><span class="line">node/node-2 labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶å†æ¬¡æ‰§è¡ŒæŸ¥çœ‹</span></span><br><span class="line">$ kubectl get node</span><br><span class="line">NAME         STATUS   ROLES           AGE    VERSION</span><br><span class="line">master-223   Ready    control-plane   3d     v1.23.6</span><br><span class="line">master-224   Ready    control-plane   2d6h   v1.23.6</span><br><span class="line">master-225   Ready    control-plane   6d5h   v1.23.6</span><br><span class="line">node-1       Ready    work            3d     v1.23.6</span><br><span class="line">node-2       Ready    work            3d     v1.23.6</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="9-éƒ¨ç½²é…ç½®-CoreDNS-æ’ä»¶"><a href="#9-éƒ¨ç½²é…ç½®-CoreDNS-æ’ä»¶" class="headerlink" title="9) éƒ¨ç½²é…ç½® CoreDNS æ’ä»¶"></a>9) éƒ¨ç½²é…ç½® CoreDNS æ’ä»¶</h4><p>æè¿°: é€šè¿‡è¯¥CoreDNSæ’ä»¶ä»åç§°å¯ä»¥çœ‹å‡ºå…¶ç”¨äº DNSå’ŒæœåŠ¡å‘ç°, ä½¿å¾—é›†ç¾¤ä¸­å¯ä»¥ä½¿ç”¨æœåŠ¡åç§°è¿›è¡Œè®¿é—®ç›¸åº”çš„åç«¯Pod,ä¸ç®¡åç«¯Podåœ°å€å¦‚ä½•æ”¹å˜å…¶æ€»æ˜¯ç¬¬ä¸€æ—¶é—´ä¼šæ›´æ–°ç»‘å®šåˆ°å¯¹åº”æœåŠ¡åŸŸå, è¯¥é¡¹ç›®ä¹Ÿæ˜¯æ¯•ä¸šäºCNCFã€‚</p>
<p>å®˜ç½‘åœ°å€: <a href="https://coredns.io/" target="_blank" rel="noopener">https://coredns.io/</a><br>é¡¹ç›®åœ°å€: <a href="https://github.com/coredns/coredns" target="_blank" rel="noopener">https://github.com/coredns/coredns</a></p>
<p>æ­¥éª¤ 01.é€šè¿‡å‚è€ƒGithub(<a href="https://github.com/coredns/deployment/tree/master/kubernetes)ä¸­corednsé¡¹ç›®åœ¨K8Séƒ¨ç½²è¯´æ˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½" target="_blank" rel="noopener">https://github.com/coredns/deployment/tree/master/kubernetes)ä¸­corednsé¡¹ç›®åœ¨K8Séƒ¨ç½²è¯´æ˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½</a>  deploy.sh ä¸  coredns.yaml.sed ä¸¤ä¸ªæ–‡ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -L https://github.com/coredns/deployment/raw/master/kubernetes/deploy.sh</span><br><span class="line">wget -L https://github.com/coredns/deployment/raw/master/kubernetes/coredns.yaml.sed</span><br><span class="line">chmox +x deploy.sh</span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ 02.ç”Ÿæˆcorednséƒ¨ç½²æ¸…å•yamlæ–‡ä»¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -i DNS-IP å‚æ•°æŒ‡å®š é›†ç¾¤ dns IP åœ°å€, æ³¨æ„éœ€è¦ä¸å‰é¢ kubelet-config.yaml ä¸­çš„ clusterDNS å­—æ®µå€¼ä¿æŒä¸€è‡´</span></span><br><span class="line"><span class="comment"># -d CLUSTER-DOMAIN å‚æ•°æŒ‡å®š é›†ç¾¤åŸŸååç§°, æ³¨æ„éœ€è¦ä¸å‰é¢ kubelet-config.yaml ä¸­çš„ clusterDomain å­—æ®µå€¼ä¿æŒä¸€è‡´</span></span><br><span class="line">./deploy.sh -i 10.96.0.10 &gt;&gt; coredns.yaml</span><br></pre></td></tr></table></figure></p>
<p>æ¸©é¦¨æç¤º: å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ›¿æ¢ coredns.yaml.sed å†…å®¹ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER_DNS_IP=10.96.0.10</span><br><span class="line">CLUSTER_DOMAIN=cluster.local</span><br><span class="line">REVERSE_CIDRS=<span class="keyword">in</span>-addr.arpa ip6.arpa</span><br><span class="line">STUBDOMAINS=<span class="string">""</span></span><br><span class="line">UPSTREAMNAMESERVER=UPSTREAMNAMESERVER</span><br><span class="line">YAML_TEMPLATE=coredns.yaml.sed</span><br><span class="line"></span><br><span class="line">sed -e <span class="string">"s/CLUSTER_DNS_IP/<span class="variable">$CLUSTER_DNS_IP</span>/g"</span> \</span><br><span class="line">    -e <span class="string">"s/CLUSTER_DOMAIN/<span class="variable">$CLUSTER_DOMAIN</span>/g"</span> \</span><br><span class="line">    -e <span class="string">"s?REVERSE_CIDRS?<span class="variable">$REVERSE_CIDRS</span>?g"</span> \</span><br><span class="line">    -e <span class="string">"s@STUBDOMAINS@<span class="variable">$&#123;STUBDOMAINS//$orig/$replace&#125;</span>@g"</span> \</span><br><span class="line">    -e <span class="string">"s/UPSTREAMNAMESERVER/<span class="variable">$UPSTREAM</span>/g"</span> \</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;YAML_TEMPLATE&#125;</span>"</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 03.æŸ¥çœ‹ç”Ÿæˆçš„corednséƒ¨ç½²æ¸…å•yamlæ–‡ä»¶ï¼ˆcoredns.ymlï¼‰<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">services</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">discovery.k8s.io</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">endpointslices</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors</span></span><br><span class="line"><span class="string">        health &#123;</span></span><br><span class="line"><span class="string">          lameduck 5s</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ready</span></span><br><span class="line"><span class="string">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span></span><br><span class="line"><span class="string">          fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        prometheus :9153</span></span><br><span class="line"><span class="string">        forward . /etc/resolv.conf &#123;</span></span><br><span class="line"><span class="string">          max_concurrent 1000</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        loop</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">"CoreDNS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># replicas: not specified here:</span></span><br><span class="line">  <span class="comment"># 1. Default is 1.</span></span><br><span class="line">  <span class="comment"># 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">         podAntiAffinity:</span></span><br><span class="line"><span class="attr">           requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">           - labelSelector:</span></span><br><span class="line"><span class="attr">               matchExpressions:</span></span><br><span class="line"><span class="attr">               - key:</span> <span class="string">k8s-app</span></span><br><span class="line"><span class="attr">                 operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                 values:</span> <span class="string">["kube-dns"]</span></span><br><span class="line"><span class="attr">             topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">coredns/coredns:1.9.1</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">170</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">70</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">[</span> <span class="string">"-conf"</span><span class="string">,</span> <span class="string">"/etc/coredns/Corefile"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/coredns</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">dns</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">UDP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">dns-tcp</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9153</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">          capabilities:</span></span><br><span class="line"><span class="attr">            add:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line"><span class="attr">            drop:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">all</span></span><br><span class="line"><span class="attr">          readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/ready</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8181</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">Default</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">          configMap:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">            items:</span></span><br><span class="line"><span class="attr">            - key:</span> <span class="string">Corefile</span></span><br><span class="line"><span class="attr">              path:</span> <span class="string">Corefile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">prometheus.io/port:</span> <span class="string">"9153"</span></span><br><span class="line">    <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">"CoreDNS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">dns</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">UDP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">dns-tcp</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">9153</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 04.åœ¨é›†ç¾¤ä¸­éƒ¨ç½²coredns,å¹¶æŸ¥çœ‹å…¶éƒ¨ç½²çŠ¶æ€ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f coredns.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/coredns created</span></span><br><span class="line">  <span class="comment"># clusterrole.rbac.authorization.k8s.io/system:coredns created</span></span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span></span><br><span class="line">  <span class="comment"># configmap/coredns created</span></span><br><span class="line">  <span class="comment"># deployment.apps/coredns created</span></span><br><span class="line">  <span class="comment"># service/kube-dns created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸©é¦¨æç¤º: ä¸ºäº†åŠ å¿«éƒ¨ç½²å¯ä»¥å…ˆæ‹‰å–corednsé•œåƒåˆ°masterèŠ‚ç‚¹ </span></span><br><span class="line">ctr -n k8s.io i pull docker.io/coredns/coredns:1.9.1</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="0x03-åº”ç”¨éƒ¨ç½²æµ‹è¯•"><a href="#0x03-åº”ç”¨éƒ¨ç½²æµ‹è¯•" class="headerlink" title="0x03 åº”ç”¨éƒ¨ç½²æµ‹è¯•"></a>0x03 åº”ç”¨éƒ¨ç½²æµ‹è¯•</h2><h3 id="1-éƒ¨ç½²Nginx-WebæœåŠ¡"><a href="#1-éƒ¨ç½²Nginx-WebæœåŠ¡" class="headerlink" title="1.éƒ¨ç½²Nginx WebæœåŠ¡"></a>1.éƒ¨ç½²Nginx WebæœåŠ¡</h3><p><strong>æ–¹å¼1.åˆ©ç”¨createå¿«é€Ÿéƒ¨ç½²ç”±deploymentç®¡ç†çš„nginxåº”ç”¨</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨é»˜è®¤çš„åç§°ç©ºé—´ä¸­åˆ›å»ºç”± deployment èµ„æºæ§åˆ¶å™¨ç®¡ç†çš„NginxæœåŠ¡</span></span><br><span class="line">$ kubectl create deployment --image=nginx:latest --port=5701 --replicas 1 hello-nginx</span><br><span class="line">deployment.apps/hello-nginx created</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºçš„POD</span></span><br><span class="line">$ kubectl get pod -o wide --show-labels</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES   LABELS</span><br><span class="line">hello-nginx-7f4ff84cb-mjw79   1/1     Running   0          65s   10.128.17.203   master-225   &lt;none&gt;           &lt;none&gt;            app=hello-nginx,pod-template-hash=7f4ff84cb</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºhello-nginxéƒ¨ç½²åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œè¯¥éƒ¨ç½²æœåŠ¡äºç«¯å£80ï¼Œå¹¶è¿æ¥åˆ°ç«¯å£80ä¸Šçš„Podå®¹å™¨</span></span><br><span class="line">$ kubectl expose deployment hello-nginx --port=80 --target-port=80</span><br><span class="line">service/hello-nginx exposed</span><br><span class="line"></span><br><span class="line">$ kubectl get svc hello-nginx</span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">hello-nginx   ClusterIP   10.96.122.135   &lt;none&gt;        80/TCP    23s</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡éªŒè¯</span></span><br><span class="line">$ curl -I 10.96.122.135</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.5</span><br><span class="line">Date: Sun, 08 May 2022 09:58:27 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 28 Dec 2021 15:28:38 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">"61cb2d26-267"</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p><strong>æ–¹å¼2.å½“æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨èµ„æºæ¸…å•åˆ›å»ºnginxæœåŠ¡ç”¨äºéƒ¨ç½²æˆ‘çš„ä¸ªäººä¸»é¡µ</strong><br>æ­¥éª¤ 01.å‡†å¤‡StatefulSetæ§åˆ¶å™¨ç®¡ç†çš„èµ„æºæ¸…å•<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">tee nginx.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion:  apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-web</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  serviceName: <span class="string">"nginx-service"</span> </span><br><span class="line"></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: workdir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">          containerPort: 80</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: workdir</span><br><span class="line">          mountPath: <span class="string">"/usr/share/nginx/html"</span></span><br><span class="line">      initContainers:</span><br><span class="line">      - name: init-html</span><br><span class="line">        image: bitnami/git:2.36.1</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">'sh'</span>, <span class="string">'-c'</span>, <span class="string">"git clone --depth=1 https://github.com/WeiyiGeek/WeiyiGeek.git /app/html"</span>]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: workdir</span><br><span class="line">          mountPath: <span class="string">"/app/html"</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-service</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      nodePort: 30001</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 02.éƒ¨ç½²èµ„æºä»¥åŠPodä¿¡æ¯æŸ¥çœ‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f nginx.yaml</span><br><span class="line">statefulset.apps/nginx-web created</span><br><span class="line">service/nginx-service created</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–Podå®¹å™¨</span></span><br><span class="line">$ kubectl get pod nginx-web-0</span><br><span class="line">NAME                          READY   STATUS     RESTARTS   AGE</span><br><span class="line">nginx-web-0                   0/1     Init:0/1   0          3m19s</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">$ kubectl get pod nginx-web-0 -o wide</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-web-0   1/1     Running   0          12m   10.128.251.72   master-224   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-service æœåŠ¡åç«¯æŸ¥çœ‹</span></span><br><span class="line">$ kubectl describe svc nginx-service</span><br><span class="line">Name:                     nginx-service</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   &lt;none&gt;</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 app=nginx</span><br><span class="line">Type:                     NodePort  <span class="comment"># æ­¤å¤„ä¸º NodePort æš´éœ²æœåŠ¡</span></span><br><span class="line">IP Family Policy:         SingleStack</span><br><span class="line">IP Families:              IPv4</span><br><span class="line">IP:                       10.96.14.218</span><br><span class="line">IPs:                      10.96.14.218</span><br><span class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30001/TCP  <span class="comment"># æš´éœ²çš„å¤–éƒ¨ç«¯å£</span></span><br><span class="line">Endpoints:                10.128.251.72:80</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 03.é€šè¿‡å®¢æˆ·ç«¯æµè§ˆå™¨è®¿é—®<code>10.10.107.225:30001</code>å³å¯è®¿é—®æˆ‘ä»¬éƒ¨ç½²çš„nginxåº”ç”¨ï¼ŒåŒæ—¶é€šè¿‡<code>kubectl logs -f nginx-web-0</code>æŸ¥çœ‹podæ—¥å¿—.</p>
<figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220508183943.png" target="_blank" title="WeiyiGeek.éƒ¨ç½²çš„ä¸ªäººä¸»é¡µ" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220508183943.png" alt="WeiyiGeek.éƒ¨ç½²çš„ä¸ªäººä¸»é¡µ" title="" class=""></a>
                <p>WeiyiGeek.éƒ¨ç½²çš„ä¸ªäººä¸»é¡µ</p>
            </figure>
<p><br></p>
<h3 id="2-éƒ¨ç½²K8såŸç”ŸDashboard-UI"><a href="#2-éƒ¨ç½²K8såŸç”ŸDashboard-UI" class="headerlink" title="2.éƒ¨ç½²K8såŸç”ŸDashboard UI"></a>2.éƒ¨ç½²K8såŸç”ŸDashboard UI</h3><p>æè¿°:Kubernetes Dashboardæ˜¯Kubernetesé›†ç¾¤çš„é€šç”¨ã€åŸºäºwebçš„UIã€‚å®ƒå…è®¸ç”¨æˆ·ç®¡ç†é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå¹¶å¯¹å…¶è¿›è¡Œæ•…éšœæ’é™¤ï¼Œä»¥åŠç®¡ç†é›†ç¾¤æœ¬èº«ã€‚</p>
<p>é¡¹ç›®åœ°å€: <a href="https://github.com/kubernetes/dashboard/" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/</a></p>
<p>æ­¥éª¤ 01.ä»Githubä¸­æ‹‰å–dashboardéƒ¨ç½²èµ„æºæ¸…å•ï¼Œå½“å‰æœ€æ–°ç‰ˆæœ¬v2.5.1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½éƒ¨ç½²</span></span><br><span class="line">wget -L https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml </span><br><span class="line"><span class="comment"># wget -L https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml -O dashboard.yaml</span></span><br><span class="line">kubectl apply -f recommended.yaml</span><br><span class="line">grep <span class="string">"image:"</span> recommended.yaml</span><br><span class="line">  <span class="comment"># image: kubernetesui/dashboard:v2.5.1</span></span><br><span class="line">  <span class="comment"># image: kubernetesui/metrics-scraper:v1.0.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä¸€æ¡å‘½ä»¤æå®šéƒ¨ç½²</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/kubernetes-dashboard created</span></span><br><span class="line">  <span class="comment"># service/kubernetes-dashboard created</span></span><br><span class="line">  <span class="comment"># secret/kubernetes-dashboard-certs created</span></span><br><span class="line">  <span class="comment"># secret/kubernetes-dashboard-csrf created</span></span><br><span class="line">  <span class="comment"># secret/kubernetes-dashboard-key-holder created</span></span><br><span class="line">  <span class="comment"># configmap/kubernetes-dashboard-settings created</span></span><br><span class="line">  <span class="comment"># role.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span><br><span class="line">  <span class="comment"># clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span><br><span class="line">  <span class="comment"># rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span></span><br><span class="line">  <span class="comment"># deployment.apps/kubernetes-dashboard created</span></span><br><span class="line">  <span class="comment"># service/dashboard-metrics-scraper created</span></span><br><span class="line">  <span class="comment"># deployment.apps/dashboard-metrics-scraper created</span></span><br></pre></td></tr></table></figure></p>
<p><br/></p>
<p>æ­¥éª¤ 02.æŸ¥çœ‹éƒ¨ç½²çš„dashboardç›¸å…³èµ„æºæ˜¯å¦æ­£å¸¸ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deploy,svc -n kubernetes-dashboard  -o wide</span><br><span class="line">NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS                  IMAGES                                SELECTOR</span><br><span class="line">deployment.apps/dashboard-metrics-scraper   1/1     1            1           7m45s   dashboard-metrics-scraper   kubernetesui/metrics-scraper:v1.0.7   k8s-app=dashboard-metrics-scraper</span><br><span class="line">deployment.apps/kubernetes-dashboard        1/1     1            1           7m45s   kubernetes-dashboard        kubernetesui/dashboard:v2.5.1         k8s-app=kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE     SELECTOR</span><br><span class="line">service/dashboard-metrics-scraper   ClusterIP   10.96.37.134   &lt;none&gt;        8000/TCP   7m45s   k8s-app=dashboard-metrics-scraper</span><br><span class="line">service/kubernetes-dashboard        ClusterIP   10.96.26.57    &lt;none&gt;        443/TCP    7m45s   k8s-app=kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘ service/kubernetes-dashboard æœåŠ¡å°†ç«¯å£é€šè¿‡nodePortæ–¹å¼è¿›è¡Œæš´éœ²ä¸º30443ã€‚</span></span><br><span class="line">$ kubectl edit svc -n kubernetes-dashboard kubernetes-dashboard</span><br><span class="line"><span class="comment"># service/kubernetes-dashboard edited</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">.....</span><br><span class="line">spec:</span><br><span class="line">.....</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8443</span><br><span class="line">    nodePort: 30443  <span class="comment"># æ–°å¢</span></span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort     <span class="comment"># ä¿®æ”¹</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>æ­¥éª¤ 03.é»˜è®¤ä»ªè¡¨æ¿éƒ¨ç½²åŒ…å«è¿è¡Œæ‰€éœ€çš„æœ€å°RBACæƒé™é›†ï¼Œè€Œè¦æƒ³ä½¿ç”¨dashboardæ“ä½œé›†ç¾¤ä¸­çš„èµ„æºï¼Œé€šå¸¸æˆ‘ä»¬è¿˜éœ€è¦è‡ªå®šä¹‰åˆ›å»ºkubernetes-dashboardç®¡ç†å‘˜è§’è‰²ã€‚<br>æƒé™æ§åˆ¶å‚è€ƒåœ°å€: <a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåæœ€å°æƒé™çš„Token(åªèƒ½æ“ä½œkubernetes-dashboardåç§°ç©ºé—´ä¸‹çš„èµ„æº)</span></span><br><span class="line">kubectl get sa -n kubernetes-dashboard kubernetes-dashboard</span><br><span class="line">kubectl describe secrets -n kubernetes-dashboard kubernetes-dashboard-token-jhdpb | grep <span class="string">'^token:'</span>|awk <span class="string">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220509082236.png" target="_blank" title="WeiyiGeek.Dashboardé»˜è®¤ä¸¤ç§è®¤è¯æ–¹å¼" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220509082236.png" alt="WeiyiGeek.Dashboardé»˜è®¤ä¸¤ç§è®¤è¯æ–¹å¼" title="" class=""></a>
                <p>WeiyiGeek.Dashboardé»˜è®¤ä¸¤ç§è®¤è¯æ–¹å¼</p>
            </figure>
<p>Kubernetes Dashboard æ”¯æŒå‡ ç§ä¸åŒçš„ç”¨æˆ·èº«ä»½éªŒè¯æ–¹å¼ï¼š</p>
<ul>
<li>Authorization header</li>
<li>Bearer Token (é»˜è®¤)</li>
<li>Username/password</li>
<li>Kubeconfig file  (é»˜è®¤)</li>
</ul>
<p>æ¸©é¦¨æç¤º: æ­¤å¤„ä½¿ç”¨Bearer Tokenæ–¹å¼, ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºæˆ‘ä»¬å‘ Dashboard çš„æœåŠ¡å¸æˆ·æˆäºˆç®¡ç†å‘˜æƒé™ (Admin privileges), è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ä¸å»ºè®®å¦‚æ­¤æ“ä½œ, è€Œæ˜¯æŒ‡å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªåç§°ç©ºé—´ä¸‹çš„èµ„æºè¿›è¡Œæ“ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">tee rbac-dashboard-admin.yaml &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-admin</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-admin</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: dashboard-admin</span><br><span class="line">    namespace: kubernetes-dashboard</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f rbac-dashboard-admin.yaml</span><br><span class="line">  <span class="comment"># serviceaccount/dashboard-admin created</span></span><br><span class="line">  <span class="comment"># clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created</span></span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ 04.è·å– sa åˆ›å»ºçš„ dashboard-admin ç”¨æˆ·çš„ secrets åç§°å¹¶è·å–è®¤è¯ token ï¼Œç”¨äºä¸Šè¿°æ­å»ºçš„dashboard è®¤è¯ä½¿ç”¨ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sa -n kubernetes-dashboard dashboard-admin -o yaml | grep <span class="string">"\- name"</span> | awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line">  <span class="comment"># dashboard-admin-token-crh7v</span></span><br><span class="line">kubectl describe secrets -n kubernetes-dashboard dashboard-admin-token-crh7v | grep <span class="string">"^token:"</span> | awk <span class="string">'&#123;print $2&#125;'</span></span><br><span class="line">  <span class="comment">#  è·å–åˆ°è®¤è¯Token</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IkJXdm1YSGNSQ3VFSEU3V0FTRlJKcU10bWxzUDZPY3lfU0lJOGJjNGgzRXMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tY3JoN3YiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNDY3ODEwMDMtM2MzNi00NWE1LTliYTQtNDY3MTQ0OWE2N2E0Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.X10AzWBxaHObYGoOqjfw3IYkhn8L5E7najdGSeLavb94LX5BY8_rCGizkWgNgNyvUe39NRP8r8YBU5sy9F2K-kN9_5cxUX125cj1drLDmgPJ-L-1m9-fs-luKnkDLRE5ENS_dgv7xsFfhtN7s9prgdqLw8dIrhshHVwflM_VOXW5D26QR6izy2AgPNGz9cRh6x2znrD-dpUNHO1enzvGzlWj7YhaOUFl310V93hh6EEc57gAwmDQM4nWP44KiaAiaW1cnC38Xs9CbWYxjsfxd3lObWShOd3knFk5PUVSBHo0opEv3HQ_-gwu6NGV6pLMY52p_JO1ECPSDnblVbVtPQ</span><br></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 05.åˆ©ç”¨ä¸Šè¿° Token è¿›è¡Œç™»é™†Kubernetes-dashboardçš„UIã€‚<br><figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220509090433.png" target="_blank" title="WeiyiGeek.æ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„dashboard" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220509090433.png" alt="WeiyiGeek.æ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„dashboard" title="" class=""></a>
                <p>WeiyiGeek.æ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„dashboard</p>
            </figure></p>
<p><br></p>
<h3 id="3-éƒ¨ç½²K9så·¥å…·è¿›è¡Œç®¡ç†é›†ç¾¤"><a href="#3-éƒ¨ç½²K9så·¥å…·è¿›è¡Œç®¡ç†é›†ç¾¤" class="headerlink" title="3.éƒ¨ç½²K9så·¥å…·è¿›è¡Œç®¡ç†é›†ç¾¤"></a>3.éƒ¨ç½²K9så·¥å…·è¿›è¡Œç®¡ç†é›†ç¾¤</h3><p>æè¿°: k9s æ˜¯ç”¨äºç®¡ç† Kubernetes é›†ç¾¤çš„ CLI, K9s æä¾›äº†ä¸€ä¸ªç»ˆç«¯ UI æ¥ä¸æ‚¨çš„ Kubernetes é›†ç¾¤è¿›è¡Œäº¤äº’ã€‚é€šè¿‡å°è£… kubectl åŠŸèƒ½ k9s æŒç»­ç›‘è§† Kubernetes çš„å˜åŒ–å¹¶æä¾›åç»­å‘½ä»¤æ¥ä¸æ‚¨è§‚å¯Ÿåˆ°çš„èµ„æºè¿›è¡Œäº¤äº’ï¼Œç›´ç™½çš„è¯´å°±æ˜¯k9så¯ä»¥è®©å¼€å‘è€…å¿«é€ŸæŸ¥çœ‹å¹¶è§£å†³è¿è¡Œ Kubernetes æ—¶çš„æ—¥å¸¸é—®é¢˜ã€‚<br>å®˜ç½‘åœ°å€: <a href="https://k9scli.io/" target="_blank" rel="noopener">https://k9scli.io/</a><br>å‚è€ƒåœ°å€: <a href="https://github.com/derailed/k9s" target="_blank" rel="noopener">https://github.com/derailed/k9s</a></p>
<p>æ­¤å¤„,ä»¥å®‰è£…äºŒè¿›åˆ¶åŒ…ä¸ºä¾‹è¿›è¡Œå®è·µã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åˆ©ç”¨ wget å‘½ä»¤ -c çŸ­ç‚¹ç»­ä¼ å’Œ -b åå°ä¸‹è½½</span></span><br><span class="line">wget -b -c https://github.com/derailed/k9s/releases/download/v0.25.18/k9s_Linux_x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.è§£å‹å¹¶åˆ é™¤å¤šä½™æ–‡ä»¶</span></span><br><span class="line">tar -zxf k9s_linux_x86_64.tar.gz</span><br><span class="line">rm  k9s_linux_x86_64.tar.gz  LICENSE  README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æ‹·è´ kubernetes æ§åˆ¶é…ç½®æ–‡ä»¶åˆ°åŠ ç›®å½•ä¸­</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.ç›´æ¥è¿è¡Œå³å¯ï¼Œå¦‚æœä½ å¯¹vimæ“ä½œæ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆæ­å–œä½ äº†ä½ å¾ˆå¿«èƒ½ä¸Šæ‰‹k9s.</span></span><br><span class="line">/nfsdisk-31/newK8s-Backup/tools<span class="comment"># ./k9s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.é€€å‡ºk9sæŒ‡ä»¤</span></span><br><span class="line">:quit</span><br></pre></td></tr></table></figure></p>
<figure class="image-box">
                <a rel=4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ href="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220509192129.png" target="_blank" title="WeiyiGeek.ä½¿ç”¨K9så·¥å…·ç®¡ç†é›†ç¾¤" data-fancybox="images"><img src="https://cdn.jsdelivr.net/gh/WeiyiGeek/blogimage/2022/5/20220509192129.png" alt="WeiyiGeek.ä½¿ç”¨K9så·¥å…·ç®¡ç†é›†ç¾¤" title="" class=""></a>
                <p>WeiyiGeek.ä½¿ç”¨K9så·¥å…·ç®¡ç†é›†ç¾¤</p>
            </figure>
<p>æ›´å¤šä½¿ç”¨æŠ€å·§è¯·å‚è€ƒ: [K9sä¹‹K8sé›†ç¾¤ç®¡ç†å·¥å…·å®è·µå°è¯•] (<a href="https://blog.weiyigeek.top/2022/1-1-582.html">https://blog.weiyigeek.top/2022/1-1-582.html</a>)</p>
<hr>
<h2 id="0x04-å…¥å‘å‡ºå‘"><a href="#0x04-å…¥å‘å‡ºå‘" class="headerlink" title="0x04 å…¥å‘å‡ºå‘"></a>0x04 å…¥å‘å‡ºå‘</h2><h3 id="äºŒè¿›åˆ¶æ­å»ºK8Sé›†ç¾¤éƒ¨ç½²calicoç½‘ç»œæ’ä»¶å§‹ç»ˆæœ‰ä¸€ä¸ªcalico-node-xxxçŠ¶æ€ä¸ºRunningä½†æ˜¯READYä¸º0-1è§£å†³æ–¹æ³•"><a href="#äºŒè¿›åˆ¶æ­å»ºK8Sé›†ç¾¤éƒ¨ç½²calicoç½‘ç»œæ’ä»¶å§‹ç»ˆæœ‰ä¸€ä¸ªcalico-node-xxxçŠ¶æ€ä¸ºRunningä½†æ˜¯READYä¸º0-1è§£å†³æ–¹æ³•" class="headerlink" title="äºŒè¿›åˆ¶æ­å»ºK8Sé›†ç¾¤éƒ¨ç½²calicoç½‘ç»œæ’ä»¶å§‹ç»ˆæœ‰ä¸€ä¸ªcalico-node-xxxçŠ¶æ€ä¸ºRunningä½†æ˜¯READYä¸º0/1è§£å†³æ–¹æ³•"></a>äºŒè¿›åˆ¶æ­å»ºK8Sé›†ç¾¤éƒ¨ç½²calicoç½‘ç»œæ’ä»¶å§‹ç»ˆæœ‰ä¸€ä¸ªcalico-node-xxxçŠ¶æ€ä¸ºRunningä½†æ˜¯READYä¸º0/1è§£å†³æ–¹æ³•</h3><ul>
<li><p>é”™è¯¯ä¿¡æ¯:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -A</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS              RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6f7b5668f7-52247   1/1     Running   0          13m</span><br><span class="line">kube-system   calico-node-kb27z                          0/1     Running             0          13m</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod -n kube-system calico-node-kb27z</span><br><span class="line">Warning  Unhealthy 14m  kubelet Readiness probe failed: 2022-05-07 13:15:12.460 [INFO][204] confd/health.go 180: Number of node(s) with BGP peering established = 0</span><br><span class="line">calico/node is not ready: BIRD is not ready: BGP not established with 10.10.107.223,10.10.107.224,10.10.107.225,10.10.107.226  <span class="comment"># å…³é”®ç‚¹</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é”™è¯¯åŸå› : calico-node daemonset é»˜è®¤çš„ç­–ç•¥æ˜¯è·å–ç¬¬ä¸€ä¸ªå–åˆ°çš„ç½‘å¡çš„ ip ä½œä¸º calico node çš„ip, ç”±äºé›†ç¾¤ä¸­ç½‘å¡åç§°ä¸ç»Ÿä¸€æ‰€ä»¥å¯èƒ½å¯¼è‡´calicoè·å–çš„ç½‘å¡IPä¸å¯¹, æ‰€ä»¥å‡ºç°æ­¤ç§æƒ…å†µä¸‹å°±åªèƒ½ IP_AUTODETECTION_METHOD å­—æ®µæŒ‡å®šé€šé…ç¬¦ç½‘å¡åç§°æˆ–è€…IPåœ°å€ã€‚</p>
</li>
<li><p>è§£å†³åŠæ³•:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šä¿¡ç½‘å¡åç§°æŸ¥çœ‹(ä¸ºens32)</span></span><br><span class="line">ip addr</span><br><span class="line">  <span class="comment"># 2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span></span><br><span class="line">  <span class="comment">#     link/ether 00:0c:29:a5:66:de brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line">  <span class="comment">#     inet 10.10.107.227/24 brd 10.10.107.255 scope global ens32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘ calico èµ„æºï¼Œæ·»åŠ  IP_AUTODETECTION_METHOD é”®ä¸å€¼, å…¶ä¸­interface æ˜¯æ­£åˆ™è¡¨è¾¾å¼ä¸ºäº†æˆåŠŸåŒ¹é…æ­¤å¤„è®¾ç½®ä¸ºen.* </span></span><br><span class="line">kubectl edit daemonsets.apps -n kube-system calico-node</span><br><span class="line">- name: IP</span><br><span class="line">  value: autodetect</span><br><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: interface=en.*</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ‰©å±•è¡¥å……: calico å®˜æ–¹æ–‡æ¡£ <a href="https://docs.projectcalico.org/reference/node/configuration#ip-autodetection-methods" target="_blank" rel="noopener">https://docs.projectcalico.org/reference/node/configuration#ip-autodetection-methods</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># IP_AUTODETECTION_METHOD	</span></span><br><span class="line"><span class="comment"># The method to use to autodetect the IPv4 address for this host. This is only used when the IPv4 address is being autodetected. See IP Autodetection methods for details of the valid methods. [Default: first-found]</span></span><br><span class="line"></span><br><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">value: can-reach=114.114.114.114</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="äºŒè¿›åˆ¶éƒ¨ç½²-containerd-1-6-3-å°†ç”¨äºç¯å›çš„-CNI-é…ç½®ç‰ˆæœ¬æé«˜åˆ°-1-0-0-å¯¼è‡´-CNI-loopback-æ— æ³•å¯ç”¨"><a href="#äºŒè¿›åˆ¶éƒ¨ç½²-containerd-1-6-3-å°†ç”¨äºç¯å›çš„-CNI-é…ç½®ç‰ˆæœ¬æé«˜åˆ°-1-0-0-å¯¼è‡´-CNI-loopback-æ— æ³•å¯ç”¨" class="headerlink" title="äºŒè¿›åˆ¶éƒ¨ç½² containerd 1.6.3 å°†ç”¨äºç¯å›çš„ CNI é…ç½®ç‰ˆæœ¬æé«˜åˆ° 1.0.0 å¯¼è‡´ CNI loopback æ— æ³•å¯ç”¨"></a>äºŒè¿›åˆ¶éƒ¨ç½² containerd 1.6.3 å°†ç”¨äºç¯å›çš„ CNI é…ç½®ç‰ˆæœ¬æé«˜åˆ° 1.0.0 å¯¼è‡´ CNI loopback æ— æ³•å¯ç”¨</h3><ul>
<li><p>é”™è¯¯ä¿¡æ¯: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning  FailedCreatePodSandBox  4m19s (x1293 over 34m)  kubelet            (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network <span class="keyword">for</span> sandbox <span class="string">"ae7a5d4c6906fac5114679c4b375ecc02e0cebcf4406962f01b40220064a8c1c"</span>: plugin <span class="built_in">type</span>=<span class="string">"loopback"</span> failed (add): incompatible CNI versions; config is <span class="string">"1.0.0"</span>, plugin supports [<span class="string">"0.1.0"</span> <span class="string">"0.2.0"</span> <span class="string">"0.3.0"</span> <span class="string">"0.3.1"</span> <span class="string">"0.4.0"</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>é—®é¢˜åŸå› : ç‰ˆæœ¬containerd 1.6.3 çš„ Bug</p>
</li>
<li><p>è§£å†³åŠæ³•: é‡æ–°å®‰è£…éƒ¨ç½²<a href="https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz" target="_blank" rel="noopener">cri-containerd-cni-1.6.4-linux-amd64</a></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">containerd -version</span><br><span class="line">containerd github.com/containerd/containerd v1.6.4 212e8b6fa2f44b9c21b2798135fc6fb7c53efc16</span><br></pre></td></tr></table></figure>
<ul>
<li>æ‰©å±•è¡¥å……: containerd issues æå‡ºå¹¶å·²æ‰¾åˆ°è§£å†³åŠæ³• (<a href="https://github.com/containerd/containerd/issues/6876" target="_blank" rel="noopener">https://github.com/containerd/containerd/issues/6876</a>)</li>
</ul>
<p><br></p>
<h3 id="åœ¨é›†ç¾¤ä¸­éƒ¨ç½²corednsæ—¶æ˜¾ç¤º-CrashLoopBackOff-å¹¶ä¸”æŠ¥-Readiness-probe-failed-8181-ç«¯å£-connection-refused"><a href="#åœ¨é›†ç¾¤ä¸­éƒ¨ç½²corednsæ—¶æ˜¾ç¤º-CrashLoopBackOff-å¹¶ä¸”æŠ¥-Readiness-probe-failed-8181-ç«¯å£-connection-refused" class="headerlink" title="åœ¨é›†ç¾¤ä¸­éƒ¨ç½²corednsæ—¶æ˜¾ç¤º CrashLoopBackOff å¹¶ä¸”æŠ¥ Readiness probe failed 8181 ç«¯å£ connection refused"></a>åœ¨é›†ç¾¤ä¸­éƒ¨ç½²corednsæ—¶æ˜¾ç¤º CrashLoopBackOff å¹¶ä¸”æŠ¥ Readiness probe failed 8181 ç«¯å£ connection refused</h3><ul>
<li><p>é”™è¯¯ä¿¡æ¯:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system -o wide</span><br><span class="line">    <span class="comment"># coredns-659648f898-kvgrl                  0/1     CrashLoopBackOff   5 (73s ago)   4m14s   10.128.17.198   master-225   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">kubectl describe pod -n kube-system coredns-659648f898-crttw </span><br><span class="line">  <span class="comment"># Warning  Unhealthy  2m34s                 kubelet            Readiness probe failed: HTTP probe failed with statuscode: 503</span></span><br><span class="line">  <span class="comment"># Warning  Unhealthy  95s                   kubelet            Readiness probe failed: Get "http://10.128.251.66:8181/ready": dial tcp 10.128.251.66:8181: connect: connection refused</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é—®é¢˜åŸå› : ç”±äº coredns æ˜¯æ˜ å°„å®¿ä¸»æœºä¸­çš„ /etc/resolv.conf åˆ°å®¹å™¨ä¸­åœ¨åŠ è½½è¯¥é…ç½®æ˜¯å¹¶ä¸èƒ½è®¿é—® nameserver 127.0.0.53 è¿™ä¸ªdnsåœ°å€å¯¼è‡´corednså®¹å™¨podæ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œå¹¶ä¸”åœ¨æˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹è¯¥ <code>/etc/resolv.conf</code> åsystemd-resolved.serviceä¼šå®šæ—¶åˆ·æ–°è¦†ç›–æˆ‘ä»¬çš„ä¿®æ”¹ï¼Œæ‰€ä»¥åœ¨ç™¾åº¦ä¸Šçš„ä¸€äº›æ–¹æ³•åªèƒ½ä¸´æ—¶è§£å†³ï¼Œåœ¨Podå®¹å™¨ä¸‹ä¸€æ¬¡é‡å¯åå°†ä¼šåˆå¤„äºè¯¥å¼‚å¸¸çŠ¶æ€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ls -alh /etc/resolv.conf</span><br><span class="line">  <span class="comment"># lrwxrwxrwx 1 root root 39 Feb  2  2021 /etc/resolv.conf -&gt; ../run/systemd/resolve/stub-resolv.conf</span></span><br><span class="line"></span><br><span class="line">$ cat /etc/resolv.conf</span><br><span class="line">  <span class="comment"># nameserver 127.0.0.53</span></span><br><span class="line">  <span class="comment"># options edns0 trust-ad</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>è§£å†³åŠæ³•: æ¨èæ–¹å¼å°†<code>/etc/resolv.conf</code>å»ºç«‹è½¯è¿æ¥åˆ° <code>/run/systemd/resolve/resolv.conf</code>æˆ–è€…ä¸ä½¿ç”¨è½¯è¿æ¥ç›´æ¥åˆ é™¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemd-resolve æœåŠ¡DNSè®¾å®šåç»­ä¾¿å¯ä»¥é˜²æ­¢/etc/resolv.confè¢«è¯¯ä¿®æ”¹ã€‚</span></span><br><span class="line">tee -a /etc/systemd/resolved.conf &lt;&lt;<span class="string">'EOF'</span></span><br><span class="line">DNS=223.6.6.6</span><br><span class="line">DNS=10.96.0.10</span><br><span class="line">EOF</span><br><span class="line">systemctl restart systemd-resolved.service</span><br><span class="line">systemd-resolve --status</span><br><span class="line"></span><br><span class="line"><span class="comment"># Delete the symbolic link</span></span><br><span class="line">sudo rm -f /etc/resolv.conf </span><br><span class="line">ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤é”™è¯¯ coredns POD æ­¤å¤„åˆ©ç”¨podæ ‡ç­¾</span></span><br><span class="line">kubectl delete pod -n kube-system -l k8s-app=kube-dns</span><br><span class="line"></span><br><span class="line"><span class="comment"># coredns å‰¯æœ¬æ‰©å±•ä¸º3ä¸ªæŸ¥çœ‹æ˜¯å¦æ­£å¸¸äº†ã€‚</span></span><br><span class="line">kubectl scale deployment -n kube-system coredns --replicas 3</span><br><span class="line"><span class="comment"># deployment.apps/coredns scaled</span></span><br><span class="line"></span><br><span class="line">$ cat /etc/resolv.conf</span><br><span class="line">nameserver 223.6.6.6</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">nameserver 192.168.10.254</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="åœ¨è¿›è¡Œæˆäºˆç®¡ç†å‘˜æƒé™æ—¶åˆ©ç”¨-Token-ç™»é™†-kubernetes-dashboard-è®¤è¯æ—¶å§‹ç»ˆæŠ¥-Unauthorized-401-Invalid-credentials-provided"><a href="#åœ¨è¿›è¡Œæˆäºˆç®¡ç†å‘˜æƒé™æ—¶åˆ©ç”¨-Token-ç™»é™†-kubernetes-dashboard-è®¤è¯æ—¶å§‹ç»ˆæŠ¥-Unauthorized-401-Invalid-credentials-provided" class="headerlink" title="åœ¨è¿›è¡Œæˆäºˆç®¡ç†å‘˜æƒé™æ—¶åˆ©ç”¨ Token ç™»é™† kubernetes-dashboard è®¤è¯æ—¶å§‹ç»ˆæŠ¥ Unauthorized (401): Invalid credentials provided"></a>åœ¨è¿›è¡Œæˆäºˆç®¡ç†å‘˜æƒé™æ—¶åˆ©ç”¨ Token ç™»é™† kubernetes-dashboard è®¤è¯æ—¶å§‹ç»ˆæŠ¥ Unauthorized (401): Invalid credentials provided</h3><ul>
<li>é”™è¯¯ä¿¡æ¯: Unauthorized (401): Invalid credentials provided<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f --tail 50 -n kubernetes-dashboard kubernetes-dashboard-fb8648fd9-8pl5c</span><br><span class="line">2022/05/09 00:48:50 [2022-05-09T00:48:50Z] Incoming HTTP/2.0 POST /api/v1/login request from 10.128.17.194:54676: &#123; contents hidden &#125;</span><br><span class="line">2022/05/09 00:48:50 Non-critical error occurred during resource retrieval: the server has asked <span class="keyword">for</span> the client to provide credentials</span><br></pre></td></tr></table></figure></li>
<li>é—®é¢˜åŸå› : åˆ›é”®çš„rbacæœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜,åªæ˜¯æˆ‘ä»¬é‡‡ç”¨ kubectl get secrets è·å–çš„æ˜¯ç»è¿‡base64ç¼–ç åçš„ï¼Œæˆ‘ä»¬åº”è¯¥æ‰§è¡Œ kubectl describe secrets è¿›è¡Œè·å–ã€‚</li>
<li>è§£å†³åŠæ³•:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sa -n kubernetes-dashboard dashboard-admin -o yaml | grep <span class="string">"\- name"</span> | awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line">  <span class="comment"># dashboard-admin-token-crh7v</span></span><br><span class="line">kubectl describe secrets -n kubernetes-dashboard dashboard-admin-token-crh7v | grep <span class="string">"^token:"</span> | awk <span class="string">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure></li>
</ul>

        </div>
        
  <hr>
  <p> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€<b style="color:#ff654e"><code>ã€master#weiyigeek.topã€‘</code></b>æˆ–è€…ä¸ªäººå…¬ä¼—å·<b style="color:#ff654e"><code>ã€WeiyiGeekã€‘</code></b>è”ç³»æˆ‘ã€‚ </p>

  <p> æ›´å¤šæ–‡ç« æ¥æºäº<b style="color:#03a9f4">ã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘</b>, ä¸ªäººé¦–é¡µåœ°å€( <a style="color: #03a9f4;" href="https://weiyigeek.top" target="_blank"> https://weiyigeek.top </a> )</p>

  <p>ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ  <b style="color: red;">ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ï¼Œè½¬ä¸ªå‘ã€‘(äººé—´äº”å¤§æƒ…)</b>ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œè°¢è°¢ï¼ã€‚</p>

  <div>
    <img src="https://www.weiyigeek.top/img/weiyigeek.jpg" class="img-responsive" alt="WeiyiGeek-banner">
  </div>

  <ul style="font-weight: bolder;">
    <li>
      <p><span style="color: #03a9f4">echo&nbsp;&nbsp;"ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"</span></p>
    </li>
    <li>
      <p><span style="color: #ff9201">printf("%s",&nbsp;"ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #02a2ff">fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")&nbsp;&nbsp;</span></p>
    </li>
    <li>
      <p><span style="color:red">console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")</span></p>
    </li>
    <li>
      <p><span style="color: #ff654e">System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")</span></p>
    </li>
  </ul>

  <div>
    <img src="/img/wechat-search.png" class="img-responsive" alt="æ‰«æFollow(å…³æ³¨)WeiyiGeekå…¬ä¼—å·"  width="380" height="170">
    <img src="/img/wechat-app.png" class="img-responsive" alt="æ‰«æVisit(æµè§ˆ)æå®¢å…¨æ ˆä¿®ç‚¼å°ç¨‹åº"  width="385" height="170">
  </div>
  <hr>
  

  <blockquote class="post-copyright">
    <div class="content">
      
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-06-21T02:32:58.371Z" itemprop="dateUpdated">2022-06-21 10:32:58</time>
</span><br>


        <span>æ–‡ç« åŸå§‹è·¯å¾„ï¼š<a href="https://github.com/WeiyiGeek/blog/edit/master/source/_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Containerd/4.åŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤æœ€æ–°å®è·µ.md" target="_blank" rel="noopener noreferrer">_posts/è™šæ‹Ÿäº‘å®¹/äº‘å®¹å™¨/Containerd/4.åŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤æœ€æ–°å®è·µ.md</a></span><br>
         <span class="copy-copyright">è½¬è½½æ³¨æ˜å‡ºå¤„ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="/2021/7-30-623.html" target="_blank" rel="external">https://blog.weiyigeek.top/2021/7-30-623.html</a></span><br>æœ¬ç«™æ–‡ç« å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a> 
    </div>
    <footer>
      <a href="https://blog.weiyigeek.top">
        <img src="/img/avatar.jpg" alt="WeiyiGeek">
        WeiyiGeek
      </a>
    </footer>
  </blockquote>


        
            <div class="page-reward">
  <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-rectangle waves-light">ğŸ‘ é’Ÿæ„ä½œè€…</a>
</div>
            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Containerd/" rel="tag">Containerd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/7-30-623.html&title=ã€Š4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/7-30-623.html&title=ã€Š4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/7-30-623.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/7-30-623.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/7-30-623.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
          <!-- è¯„è®ºç»„ä»¶ -->


<div id="gitalk-container"></div>
<script type="text/javascript" src="/js/plugins/gitalk.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/custom/gitalk.init.js?v=1.6.6"></script>
        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2021/8-2-613.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">2.ElasticStackåˆ†å¸ƒå¼æ•°æ®é‡‡é›†æœç´¢å¼•æ“é›†ç¾¤æ­å»ºé…ç½®</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2021/7-27-575.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">18-Kubernetesè¿›é˜¶ä¹‹åº”ç”¨ä¸æŒä¹…åŒ–æ•°æ®å·å¤‡ä»½è¿ç§»å®è·µ</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>ç›®å½•</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-å‰è¨€ç®€è¿°"><span class="post-toc-number">1.</span> <span class="post-toc-text">0x00 å‰è¨€ç®€è¿°</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-ç¯å¢ƒå‡†å¤‡"><span class="post-toc-number">2.</span> <span class="post-toc-text">0x01 ç¯å¢ƒå‡†å¤‡</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ä¸»æœºè§„åˆ’"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">ä¸»æœºè§„åˆ’</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#è½¯ä»¶ç‰ˆæœ¬"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">è½¯ä»¶ç‰ˆæœ¬</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç½‘ç»œè§„åˆ’"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">ç½‘ç»œè§„åˆ’</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-å®‰è£…éƒ¨ç½²"><span class="post-toc-number">3.</span> <span class="post-toc-text">0x02 å®‰è£…éƒ¨ç½²</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-åŸºç¡€ä¸»æœºç¯å¢ƒå‡†å¤‡é…ç½®"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">1.åŸºç¡€ä¸»æœºç¯å¢ƒå‡†å¤‡é…ç½®</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-è´Ÿè½½å‡è¡¡ç®¡ç†å·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.è´Ÿè½½å‡è¡¡ç®¡ç†å·¥å…·å®‰è£…ä¸å†…æ ¸åŠ è½½</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-é«˜å¯ç”¨HAproxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">3.é«˜å¯ç”¨HAproxyä¸Keepalivedè½¯ä»¶å®‰è£…é…ç½®</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-é…ç½®éƒ¨ç½²etcdé›†ç¾¤ä¸etcdè¯ä¹¦ç­¾å‘"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">4.é…ç½®éƒ¨ç½²etcdé›†ç¾¤ä¸etcdè¯ä¹¦ç­¾å‘</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-Containerd-è¿è¡Œæ—¶å®‰è£…éƒ¨ç½²"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">5.Containerd è¿è¡Œæ—¶å®‰è£…éƒ¨ç½²</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-Kubernetes-é›†ç¾¤å®‰è£…éƒ¨ç½²"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">6.Kubernetes é›†ç¾¤å®‰è£…éƒ¨ç½²</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸‹è½½å®‰è£…-ï¼ˆæ‰‹åŠ¨-æ­¤å¤„ä»¥è¯¥å®è·µä¸ºä¾‹ï¼‰"><span class="post-toc-number">3.6.1.</span> <span class="post-toc-text">1) äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸‹è½½å®‰è£… ï¼ˆæ‰‹åŠ¨-æ­¤å¤„ä»¥è¯¥å®è·µä¸ºä¾‹ï¼‰</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-éƒ¨ç½²é…ç½®-kube-apiserver"><span class="post-toc-number">3.6.2.</span> <span class="post-toc-text">2) éƒ¨ç½²é…ç½® kube-apiserver</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-éƒ¨ç½²é…ç½®-kubectl"><span class="post-toc-number">3.6.3.</span> <span class="post-toc-text">3) éƒ¨ç½²é…ç½® kubectl</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-éƒ¨ç½²é…ç½®-kube-controller-manager"><span class="post-toc-number">3.6.4.</span> <span class="post-toc-text">4) éƒ¨ç½²é…ç½® kube-controller-manager</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-éƒ¨ç½²é…ç½®-kube-scheduler"><span class="post-toc-number">3.6.5.</span> <span class="post-toc-text">5) éƒ¨ç½²é…ç½® kube-scheduler</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#6-éƒ¨ç½²é…ç½®-kubelet"><span class="post-toc-number">3.6.6.</span> <span class="post-toc-text">6) éƒ¨ç½²é…ç½® kubelet</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#7-éƒ¨ç½²é…ç½®-kube-proxy"><span class="post-toc-number">3.6.7.</span> <span class="post-toc-text">7) éƒ¨ç½²é…ç½® kube-proxy</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#8-éƒ¨ç½²é…ç½®-Calico-æ’ä»¶"><span class="post-toc-number">3.6.8.</span> <span class="post-toc-text">8) éƒ¨ç½²é…ç½® Calico æ’ä»¶</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#9-éƒ¨ç½²é…ç½®-CoreDNS-æ’ä»¶"><span class="post-toc-number">3.6.9.</span> <span class="post-toc-text">9) éƒ¨ç½²é…ç½® CoreDNS æ’ä»¶</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-åº”ç”¨éƒ¨ç½²æµ‹è¯•"><span class="post-toc-number">4.</span> <span class="post-toc-text">0x03 åº”ç”¨éƒ¨ç½²æµ‹è¯•</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-éƒ¨ç½²Nginx-WebæœåŠ¡"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">1.éƒ¨ç½²Nginx WebæœåŠ¡</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-éƒ¨ç½²K8såŸç”ŸDashboard-UI"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">2.éƒ¨ç½²K8såŸç”ŸDashboard UI</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-éƒ¨ç½²K9så·¥å…·è¿›è¡Œç®¡ç†é›†ç¾¤"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">3.éƒ¨ç½²K9så·¥å…·è¿›è¡Œç®¡ç†é›†ç¾¤</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x04-å…¥å‘å‡ºå‘"><span class="post-toc-number">5.</span> <span class="post-toc-text">0x04 å…¥å‘å‡ºå‘</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#äºŒè¿›åˆ¶æ­å»ºK8Sé›†ç¾¤éƒ¨ç½²calicoç½‘ç»œæ’ä»¶å§‹ç»ˆæœ‰ä¸€ä¸ªcalico-node-xxxçŠ¶æ€ä¸ºRunningä½†æ˜¯READYä¸º0-1è§£å†³æ–¹æ³•"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">äºŒè¿›åˆ¶æ­å»ºK8Sé›†ç¾¤éƒ¨ç½²calicoç½‘ç»œæ’ä»¶å§‹ç»ˆæœ‰ä¸€ä¸ªcalico-node-xxxçŠ¶æ€ä¸ºRunningä½†æ˜¯READYä¸º0&#x2F;1è§£å†³æ–¹æ³•</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#äºŒè¿›åˆ¶éƒ¨ç½²-containerd-1-6-3-å°†ç”¨äºç¯å›çš„-CNI-é…ç½®ç‰ˆæœ¬æé«˜åˆ°-1-0-0-å¯¼è‡´-CNI-loopback-æ— æ³•å¯ç”¨"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">äºŒè¿›åˆ¶éƒ¨ç½² containerd 1.6.3 å°†ç”¨äºç¯å›çš„ CNI é…ç½®ç‰ˆæœ¬æé«˜åˆ° 1.0.0 å¯¼è‡´ CNI loopback æ— æ³•å¯ç”¨</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#åœ¨é›†ç¾¤ä¸­éƒ¨ç½²corednsæ—¶æ˜¾ç¤º-CrashLoopBackOff-å¹¶ä¸”æŠ¥-Readiness-probe-failed-8181-ç«¯å£-connection-refused"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">åœ¨é›†ç¾¤ä¸­éƒ¨ç½²corednsæ—¶æ˜¾ç¤º CrashLoopBackOff å¹¶ä¸”æŠ¥ Readiness probe failed 8181 ç«¯å£ connection refused</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#åœ¨è¿›è¡Œæˆäºˆç®¡ç†å‘˜æƒé™æ—¶åˆ©ç”¨-Token-ç™»é™†-kubernetes-dashboard-è®¤è¯æ—¶å§‹ç»ˆæŠ¥-Unauthorized-401-Invalid-credentials-provided"><span class="post-toc-number">5.4.</span> <span class="post-toc-text">åœ¨è¿›è¡Œæˆäºˆç®¡ç†å‘˜æƒé™æ—¶åˆ©ç”¨ Token ç™»é™† kubernetes-dashboard è®¤è¯æ—¶å§‹ç»ˆæŠ¥ Unauthorized (401): Invalid credentials provided</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

  <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        å¦‚æœæ­¤ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¿˜è¯·æ”¯æŒä¸€ä¸‹åšä¸»å“Ÿ, è°¢è°¢å„ä½çœ‹å‹â™¥!
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardwechat" src="/img/reward-wechat.jpg" height="228" height="228" alt="æ‰“èµäºŒç»´ç ">
            <img id="rewardalipay" src="/img/reward-alipay.png" height="228" height="228" alt="æ‰“èµäºŒç»´ç ">
        </div>
        
        <label class="reward-toggle">
            <!-- <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.png"> -->
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">å¾®ä¿¡</span>
                <span class="reward-toggle-item alipay">æ”¯ä»˜å®</span>
            </div>
        </label>
        
    </div>
</div>

  
 <!-- å¾®ä¿¡å…¬ä¼—å·å…³æ³¨/æ–‡ç« ç‰ˆæƒå¤åˆ¶ -->

  <div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0); display:none"></div>
<div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 360px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;display:none">
<span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 1.8; font-size: 15px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">X</span>
<p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px; ">
<b style="color:#6190e8;">ä½ å¥½æœ‹å‹,å¯ä»¥å…³ä¸ªæ³¨å—? â¤ <br> è¿™å°†æ˜¯æˆ‘æŒç»­æ›´æ–°æ–‡ç« çš„åŠ¨åŠ›æºæ³‰ï¼Œè°¢è°¢æ”¯æŒï¼(à¹‘â€²á´—â€µà¹‘) </b> <br> å¦‚ä¸æƒ³å…³æ³¨è¯·ç‚¹å‡»å³ä¸Šè§’çš„ã€Xã€‘<br>
<br>Method 1.Please visit <strong><a href="https://twitter.com/WeiyiGeek" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€My Twitterã€‘</a></strong>. There is an article verification code in the homepage.
<br>æ–¹å¼2.è¯·è®¿é—®æœ¬åšä¸»çš„Bç«™<strong><a href="https://space.bilibili.com/385802642" target="_blank" rel="noopener" style="color: rgb(240, 65, 52);text-decoration:underline;">ã€WeiyiGeekã€‘</a></strong>é¦–é¡µå…³æ³¨UPä¸»,<br>å°†è‡ªåŠ¨éšæœºè·å–è§£é”éªŒè¯ç ã€‚
<br>æ–¹å¼3.æ‰«ä¸€æ‰«ä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æœ¬ç«™<strong>å®˜æ–¹å…¬ä¼—å·</strong><br>
å›å¤ï¼š<strong style="color: rgb(240, 65, 52);">éªŒè¯ç </strong>
å°†è·å–<strong style="color: rgb(240, 65, 52);">è§£é”(æœ‰æ•ˆæœŸ7å¤©)</strong>æœ¬ç«™æ‰€æœ‰æŠ€æœ¯æ–‡ç« å“Ÿ!</p>
<img src="/img/wechat-search.png" style="width: 300px; margin-top: 10px;">
<div id="btw-modal-input-code" style="margin-top: 20px; background: rgb(255, 255, 255);">
  <input id="btw-modal-input" type="number" minlength="4" maxlength="4" placeholder="è¯·è¾“å…¥éªŒè¯ç |Verification Code"
    style="width: 165px; height: 32px; line-height: 32px; padding: 0px 10px; margin: 0px 10px; font-size: 13px; text-rendering: auto; text-transform: none; cursor: text; outline: none; box-sizing: border-box; border: 1px solid rgb(221, 221, 221); -webkit-appearance: textfield; background-color: white; -webkit-rtl-ordering: logical;"/>
  <button id="btw-submit-btn" onclick="yzm_vertify()"
    style="padding: 0px 20px; height: 32px; font-size: 14px; outline: none; border: none; color: rgb(255, 255, 255); background: rgb(222, 104, 109); cursor: pointer;">æ
    äº¤</button> </div>
<p id="btw-footer" style="margin: 40px 0px 20px; color: rgb(153, 153, 153);">@WeiyiGeek - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘</p>
</div>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Linksï¼š</span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top" target="_blank">https://weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.weiyigeek.top" target="_blank">https://blog.weiyigeek.top</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weiyigeek.top/img/wechat-search.png" target="_blank">å…¬ä¼—è´¦å·</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://space.bilibili.com/385802642/article" target="_blank">å“”å“©å“”å“©ä¸“æ </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/weiyigeek" target="_blank">ä¸ªäººGithub</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://gitee.com/WeiyiGeek" target="_blank">ä¸ªäººGitee</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.zhihu.com/people/weiyiSec" target="_blank">ä¸ªäººçŸ¥ä¹</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.cnblogs.com/WeiyiGeek" target="_blank">åšå®¢å›­</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://my.oschina.net/weiyigeek" target="_blank">OSCHINA</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAqcPSoMqfctaEqJpGSF775eeCjWkrop4AOyLITdMx-L78F5iXzfQcSRM5sY4dq3wR" target="_blank">ä»Šæ—¥å¤´æ¡</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.csdn.net/u013072756?type=lately" target="_blank">CSDN</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.jianshu.com/u/5199a1104739" target="_blank">ç®€ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cloud.tencent.com/developer/user/1389665/articles" target="_blank">è…¾è®¯äº‘+äº‘ç¤¾åŒº</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://cuttlefish.baidu.com/shop/75c5dbd8d15abe23482f4d40" target="_blank">ç™¾åº¦æ–‡åº“</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://author.baidu.com/home?from=blog&app_id=1726736601523415" target="_blank">ITæå®¢çŸ¥è¯†åˆ†äº«</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://blog.51cto.com/weiyigeek" target="_blank">51CTOåšå®¢</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://juejin.cn/user/122767337595934" target="_blank">æ˜é‡‘</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://weibo.com/a/hot/7622022703618049_1.html" target="_blank">å¾®åšæ–‡ç« </a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.xiaohongshu.com/user/profile/627c98bb000000001000e7ba" target="_blank">å°çº¢ä¹¦</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://segmentfault.com/u/weiyigeek" target="_blank">Segmentfault</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://www.douyin.com/user/MS4wLjABAAAAMSBdMja6XLsdmzafb0RNbFeBemIOk38K1PaOClZeI1Q" target="_blank">æŠ–éŸ³ä¸»é¡µ</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
      <p>
        <span>WeiyiGeek &copy; 2018 - 2022 <a href="https://weiyigeek.top" target="_blank" rel="noopener">weiyigeek.top</a> All rights reserved. ITå”¯ä¸€æå®¢ ç‰ˆæƒæ‰€æœ‰ </span>
        
        <span>
          Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/weiyigeek" target="_blank">mellow</a>
        </span>
        
        <br/>è®¿é—®ç»Ÿè®¡
        <span><a href="/sitemap.xml" target="_blank" rel="Sitemaps-ç«™ç‚¹åœ°å›¾">Sitemaps</a> </span>
        <span><a href="/baidusitemap.xml" target="_blank" rel="baidusitemaps-ç™¾åº¦ç«™ç‚¹åœ°å›¾">ç«™ç‚¹åœ°å›¾</a> </span>
        <!-- 
  -->
        <br/>ICPå¤‡æ¡ˆå·<span><a href="https://beian.miit.gov.cn" target="_blank">æ¸ICPå¤‡2022003447å·</a></span>
        <br/>
        <div id="cc-myssl-id">
          <a href="https://myssl.com/blog.weiyigeek.top?from=mysslid" target="_blank" rel="noopener"><img src="https://static.myssl.com/res/images/myssl-id1.png" alt="MySSLå®‰å…¨è®¤è¯" style="max-height:50px;display:block;margin:0 auto"></a>
        </div>
      </p>
    </div>
</footer>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.weiyigeek.top/2021/7-30-623.html&title=ã€Š4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&pic=https://blog.weiyigeek.top/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.weiyigeek.top/2021/7-30-623.html&title=ã€Š4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&source=[TOC]" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.weiyigeek.top/2021/7-30-623.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Š4.æœ€æ–°å®è·µåŸºäºContainerdå®‰è£…éƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‹ â€” WeiyiGeek Blog&url=https://blog.weiyigeek.top/2021/7-30-623.html&via=https://blog.weiyigeek.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.weiyigeek.top/2021/7-30-623.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJUlEQVR42u3aQXLDIAwF0N7/0u62M6mTL4E7BZ5XnSTYPC9UIenrK76uH1fy7fVy3a3KnzLhwsDAWJZxvb2q27pbdbf118/fP/d2DxgYGAcwnrh1/psRNgYGBkbymyRM5xvFwMDAmBVwq4fPf/p/AwMDYylGEjqrpbfx8twjZ3EMDIwFGXnV/e//fqS/gYGBsRTjKl7V+/QSx/KuMDAwtmbkAa6XzI2MbpSHPzAwMI5kjDxsVgEu/wQDA2NvRrW5WE0Zk/tPK/lhYGAcwMgPpfnaKmxC6Q0DA2M7Rr4s32Kvqdl7ERgYGCcw8gfn5bYkucy3NRSCMTAwFmf0gmb+ydxmwO0qDAyMAxgjYxa9ElsSiAuNUgwMjK0ZeRJWTQqTdDMv4VWboxgYGDsxqsMQ+RhEHrjzcBy9ewwMjK0Z1aJ/NUSOsz9kuBgYGFszqsMTvYGJ5DDcK7phYGCcwOidd/Px03zwqxp2MTAwTmD0SvnVRkK1xFYd0cDAwDiH0QxzcQMgCbLVFsIv7QEMDIytGSOpW7U9OdI6vX25GBgYRzKqR9ze65hVW8PAwNiVMRJAe9Q8yE7IbTEwMLZg9JqdvYJanjLmaWIZg4GBsSzjiQJZdQgsf2UfDrEYGBhbM3qBb2T4bFbjAQMDAyN5THKHPLjnBbvyJjAwMA5jVBuWvXZCkoxiYGCcw6g2A8ZX9ZAYGBhnMkYmNUYOnyMJZbORiYGBsR7jG+lV+ginP16NAAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="/js/jquery/2.1.0-jquery.min.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/jquery/3.5.2-jquery.fancybox.min.js?v=1.6.6"></script>
<!--  //cdn.bootcss.com/node-waves/0.7.4/waves.min.js -->
<script type="text/javascript" src="/js/node-waves/0.7.4-waves.min.js?v=1.6.6"></script> 

<script type="text/javascript" src="/js/method.js?v=1.6.6"></script>
<script type="text/javascript" src="/js/blog.js?v=1.6.6"></script>

<!-- third-party -->
<script type="text/javascript" src="/js/plugins/local_search.js?v=1.6.6"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) { search_path = "search.xml";}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script> 

<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> --> 



  


<script>
  var _hmt = _hmt || [];
  (function() {
    // ç™¾åº¦ç»Ÿè®¡
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?53923c4b5560739bc0ed61e183be6acf";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>
 


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.staticfile.org/mathjax/2.7.9/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
 
<script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = 'WeiyiGeek Blog-å…³æ³¨äºç½‘ç»œå®‰å…¨_ç‰©è”ç½‘å®‰å…¨å¼€å‘_ç½‘ç»œå®‰å…¨è¿ç»´-å­¦ä¹ å¿ƒå¾—åˆ†äº«';
                clearTimeout(titleTime);
            } else {
                document.title = '(ã¤ã‚§âŠ‚)å’¦!åˆå¥½äº†!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>
 
     <script type="text/javascript" src="/js/custom/copytips.js?v=1.6.6"></script> 
</body>
</html>
